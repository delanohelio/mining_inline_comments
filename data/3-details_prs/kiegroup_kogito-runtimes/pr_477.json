{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4NjM5NTA5", "number": 477, "title": " [KOGITO-1551] - Process Instance persistence in Mongo DB", "bodyText": "Signed-off-by: Swati Kale swkale@redhat.com\nMany thanks for submitting your Pull Request \u2764\ufe0f!\nPlease make sure that your PR meets the following requirements:\n\n You have read the contributors guide\n Pull Request title is properly formatted: [KOGITO-XYZ] Subject\n Pull Request title contains the target branch if not targeting master: [0.9.x] [KOGITO-XYZ] Subject\n Pull Request contains link to the JIRA issue\n Pull Request contains link to any dependent or related Pull Request\n Pull Request contains description of the issue\n Pull Request does not include fixes for issues other than the main ticket", "createdAt": "2020-04-24T16:09:08Z", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477", "merged": true, "mergeCommit": {"oid": "b2150b59debfe64b2b98866fb50f4794d214a670"}, "closed": true, "closedAt": "2020-08-21T08:08:08Z", "author": {"login": "swati-kale"}, "timelineItems": {"totalCount": 51, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca27vDABqjMyNzA4MDUwNzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdA9qWTABqjM2NzgwNDg3NjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce38076c9e7b1dd1d693340bdf4cc9e0915284e9", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ce38076c9e7b1dd1d693340bdf4cc9e0915284e9", "committedDate": "2020-04-24T18:55:17Z", "message": "added dependencies in bom\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "b2dc9e79169d580c38c06cb9d9973570ccf62152", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b2dc9e79169d580c38c06cb9d9973570ccf62152", "committedDate": "2020-04-24T19:47:22Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ee5f86552926e7d4ff694aa36ee8803ed353af9d", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ee5f86552926e7d4ff694aa36ee8803ed353af9d", "committedDate": "2020-04-24T20:22:24Z", "message": "remove log files\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "2813b44ac269548b5fbe4080d6e7f25e7c967c2a", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/2813b44ac269548b5fbe4080d6e7f25e7c967c2a", "committedDate": "2020-04-24T20:24:27Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d713bf229ffb8151962e507c3c3bc288754aaa6", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7d713bf229ffb8151962e507c3c3bc288754aaa6", "committedDate": "2020-04-24T20:33:58Z", "message": "removed test folder\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/6b5c6fd495e938c4228049955ec43bded81c6c5b", "committedDate": "2020-04-24T20:36:08Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwMzc0Nzg5", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-400374789", "createdAt": "2020-04-25T09:04:01Z", "commit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwOTowNDowMVrOGLyx9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwOTowOTozMFrOGLy1fQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxOTUwOA==", "bodyText": "This should depend on mongo client snd not quarkus as it should be free of any framework used as runtime. So the  same addon can be properly used in both quarkus and springboot", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r415019508", "createdAt": "2020-04-25T09:04:01Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,93 @@\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>io.quarkus</groupId>\n+\t\t\t<artifactId>quarkus-mongodb-client</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxOTc3Mw==", "bodyText": "Isn\u2019t this just oversimplification? I mean usind mongodb as key value store? I\u2019d suggest to make use of mongo as different storage so yiu could marshal process instance as document and thus take advantage of mongodb as document db", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r415019773", "createdAt": "2020-04-25T09:05:58Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistProcessInstances.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.bson.Document;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.kie.kogito.process.impl.marshalling.ProcessInstanceMarshaller;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.mongodb.client.FindIterable;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.MongoDatabase;\n+import com.mongodb.client.model.Filters;\n+import com.mongodb.client.model.Updates;\n+\n+@SuppressWarnings({ \"rawtypes\" })\n+public class PersistProcessInstances implements MutableProcessInstances {\n+\tprivate static final Logger LOGGER = LoggerFactory.getLogger(PersistProcessInstances.class);\n+\tprivate org.kie.kogito.process.Process<?> process;\n+\tprivate MongoDatabase mongoDatabase;\n+\tprivate final MongoCollection<Document> collection;\n+\tprivate ProcessInstanceMarshaller marshaller;\n+\tprivate static final String KOGITO_STORE = \"Kogito_store\";\n+\n+\tpublic PersistProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process) {\n+\n+\t\tthis.process = process;\n+\t\tthis.mongoDatabase = mongoClient.getDatabase(KOGITO_STORE);\n+\t\tthis.collection = this.mongoDatabase.getCollection(process.id() + \"_store\");\n+\t\tthis.marshaller = new ProcessInstanceMarshaller();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAyMDA4Nw==", "bodyText": "In addition, this will not work in native mode in my opinion because the variables will be serlialized using java serialization which is not supported (or was when last checked) on substratevm", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r415020087", "createdAt": "2020-04-25T09:07:32Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistProcessInstances.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import org.bson.Document;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.kie.kogito.process.impl.marshalling.ProcessInstanceMarshaller;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import com.mongodb.client.FindIterable;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.MongoDatabase;\n+import com.mongodb.client.model.Filters;\n+import com.mongodb.client.model.Updates;\n+\n+@SuppressWarnings({ \"rawtypes\" })\n+public class PersistProcessInstances implements MutableProcessInstances {\n+\tprivate static final Logger LOGGER = LoggerFactory.getLogger(PersistProcessInstances.class);\n+\tprivate org.kie.kogito.process.Process<?> process;\n+\tprivate MongoDatabase mongoDatabase;\n+\tprivate final MongoCollection<Document> collection;\n+\tprivate ProcessInstanceMarshaller marshaller;\n+\tprivate static final String KOGITO_STORE = \"Kogito_store\";\n+\n+\tpublic PersistProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process) {\n+\n+\t\tthis.process = process;\n+\t\tthis.mongoDatabase = mongoClient.getDatabase(KOGITO_STORE);\n+\t\tthis.collection = this.mongoDatabase.getCollection(process.id() + \"_store\");\n+\t\tthis.marshaller = new ProcessInstanceMarshaller();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAxOTc3Mw=="}, "originalCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTAyMDQxMw==", "bodyText": "Are you planning to use protobuf for variables and thus use this methods?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r415020413", "createdAt": "2020-04-25T09:09:30Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/persistence/KogitoProcessInstancesFactory.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.persistence;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+import org.kie.kogito.mongodb.PersistProcessInstances;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstancesFactory;\n+\n+import com.mongodb.client.MongoClient;\n+\n+/**\n+ * This class must always have exact FQCN as\n+ * <code>org.kie.kogito.persistence.KogitoProcessInstancesFactory</code>\n+ *\n+ */\n+public abstract class KogitoProcessInstancesFactory implements ProcessInstancesFactory {\n+\n+\tprotected MongoClient mongoClient;\n+\n+\tpublic KogitoProcessInstancesFactory(MongoClient mongoClient) {\n+\n+\t\tthis.mongoClient = mongoClient;\n+\t}\n+\n+\tpublic PersistProcessInstances createProcessInstances(Process<?> process) {\n+\t\treturn new PersistProcessInstances(this.mongoClient, process);\n+\t}\n+\n+\tpublic String proto() {\n+\t\treturn null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjYzNTk3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-405263597", "createdAt": "2020-05-04T19:01:44Z", "commit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6b5c6fd495e938c4228049955ec43bded81c6c5b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/6b5c6fd495e938c4228049955ec43bded81c6c5b", "committedDate": "2020-04-24T20:36:08Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "4e07516dddecfc79d81a9fdfe40d94ec1b12143b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/4e07516dddecfc79d81a9fdfe40d94ec1b12143b", "committedDate": "2020-06-09T00:12:31Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4e07516dddecfc79d81a9fdfe40d94ec1b12143b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/4e07516dddecfc79d81a9fdfe40d94ec1b12143b", "committedDate": "2020-06-09T00:12:31Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "ea44a9cdd1b67e861d133c9545372a925ed8a62f", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ea44a9cdd1b67e861d133c9545372a925ed8a62f", "committedDate": "2020-06-09T01:46:56Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ea44a9cdd1b67e861d133c9545372a925ed8a62f", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ea44a9cdd1b67e861d133c9545372a925ed8a62f", "committedDate": "2020-06-09T01:46:56Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "c1dc737097e0341d8c5472eae009f0b7ab6acd52", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c1dc737097e0341d8c5472eae009f0b7ab6acd52", "committedDate": "2020-06-09T03:17:32Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c1dc737097e0341d8c5472eae009f0b7ab6acd52", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c1dc737097e0341d8c5472eae009f0b7ab6acd52", "committedDate": "2020-06-09T03:17:32Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/55059ecc25510599a92a8f7100b6490c2017dd42", "committedDate": "2020-06-09T22:14:16Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDQ4OTg4", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-432048988", "createdAt": "2020-06-17T04:25:09Z", "commit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNDoyNToxMFrOGk1JQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNDo1NjoxNlrOGk1mkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3MjY0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t<name>Kogito - MongoDB persistence</name>\n          \n          \n            \n            \t<name>Kogito :: Add-Ons :: Persistence :: MongoDB</name>", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441272642", "createdAt": "2020-06-17T04:25:10Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3Mzc1NA==", "bodyText": "please review code format style in this file", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441273754", "createdAt": "2020-06-17T04:30:02Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3NzUxOA==", "bodyText": "Perhaps use https://www.testcontainers.org/modules/databases/mongodb/", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441277518", "createdAt": "2020-06-17T04:45:42Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.Collections;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+\n+class PersistableProcessInstanceTest {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstanceTest.class);\n+    private static final String MONGODB_VERSION = System.getProperty(\"mongodb.version\");\n+    private SecurityPolicy securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"john\"));\n+    private static final int MONGO_DEFAULT_PORT = 27017;\n+\n+    @Container\n+    public GenericContainer mongoDb = new FixedHostPortGenericContainer(\"mongo:\" + MONGODB_VERSION)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3NzgyMQ==", "bodyText": "If you add @testcontainers you then don't need to manually manage the container, see https://www.testcontainers.org/test_framework_integration/junit_5/", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441277821", "createdAt": "2020-06-17T04:46:47Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.Collections;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODQzNA==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278434", "createdAt": "2020-06-17T04:49:22Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODQ0OA==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278448", "createdAt": "2020-06-17T04:49:26Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODQ2Nw==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278467", "createdAt": "2020-06-17T04:49:33Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core-dynamic</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODUwOQ==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278509", "createdAt": "2020-06-17T04:49:40Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core-dynamic</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow-builder</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODUyMw==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278523", "createdAt": "2020-06-17T04:49:44Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core-dynamic</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow-builder</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mvel</groupId>\n+\t\t\t<artifactId>mvel2</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3ODU3OQ==", "bodyText": "dependency not needed?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441278579", "createdAt": "2020-06-17T04:49:55Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito - MongoDB persistence</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>4.0</version.org.mongodb.image>\n+\t</properties>\n+\t<dependencies>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mongodb</groupId>\n+\t\t\t<artifactId>mongodb-driver-sync</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>kogito-api</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow</artifactId>\n+\t\t</dependency>\n+\t\t<!-- test dependencies -->\n+\t\t<dependency>\n+\t\t\t<groupId>org.junit.jupiter</groupId>\n+\t\t\t<artifactId>junit-jupiter-engine</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.assertj</groupId>\n+\t\t\t<artifactId>assertj-core</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-compiler</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core</artifactId>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>drools-core-dynamic</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-flow-builder</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mvel</groupId>\n+\t\t\t<artifactId>mvel2</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.kie.kogito</groupId>\n+\t\t\t<artifactId>jbpm-bpmn2</artifactId>\n+\t\t\t<scope>test</scope>\n+\t\t</dependency>\n+\t\t<dependency>\n+\t\t\t<groupId>org.mockito</groupId>\n+\t\t\t<artifactId>mockito-core</artifactId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI4MDE0Ng==", "bodyText": "could you please expand the test so it includes variables of commonly used types including:\n\nString\nInteger\nLong\nComplex types ( Such as Address pojo )\nDouble\nBoolean\netc", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441280146", "createdAt": "2020-06-17T04:56:16Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.Collections;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+\n+class PersistableProcessInstanceTest {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstanceTest.class);\n+    private static final String MONGODB_VERSION = System.getProperty(\"mongodb.version\");\n+    private SecurityPolicy securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"john\"));\n+    private static final int MONGO_DEFAULT_PORT = 27017;\n+\n+    @Container\n+    public GenericContainer mongoDb = new FixedHostPortGenericContainer(\"mongo:\" + MONGODB_VERSION)\n+                                                                                                   .withFixedExposedPort(MONGO_DEFAULT_PORT, MONGO_DEFAULT_PORT)\n+                                                                                                   .withLogConsumer(new Slf4jLogConsumer(LOGGER))\n+                                                                                                   .waitingFor(Wait.forLogMessage(\".*build index done.*\", 1));\n+\n+    @Test\n+    void test() {\n+        if (MONGODB_VERSION == null) {\n+            throw new RuntimeException(\"Please define a valid MongoDB image version in system property mongodb.version\");\n+        }\n+        LOGGER.info(\"Using MongoDB image version: {}\", MONGODB_VERSION);\n+        MongoClient mongoClient = MongoClients.create();\n+        BpmnProcess process = BpmnProcess.from(new ClassPathResource(\"BPMN2-UserTask.bpmn2\"))\n+                                         .get(0);\n+        process.setProcessInstancesFactory(new PersistProcessInstancesFactory(mongoClient));\n+        process.configure();\n+        ProcessInstance<BpmnVariables> processInstance = process\n+                                                                .createInstance(BpmnVariables.create(Collections.singletonMap(\"test\", \"test\")));\n+\n+        processInstance.start();\n+        assertThat(processInstance.status()).isEqualTo(STATE_ACTIVE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTY3NDMx", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-432167431", "createdAt": "2020-06-17T08:19:57Z", "commit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODoxOTo1N1rOGk688Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwODo0MToxN1rOGk7wLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM2Nzc5Mw==", "bodyText": "This feels that it should be implemented as a new Strategy in the mongodb addon not in the API level. Similarly to how it is done for Infinispan with ProtoStreamObjectMarshallingStrategy", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441367793", "createdAt": "2020-06-17T08:19:57Z", "author": {"login": "cristianonicolai"}, "path": "api/kogito-api/src/main/java/org/kie/api/marshalling/ObjectMarshallingStrategy.java", "diffHunk": "@@ -20,8 +20,13 @@\n import java.io.ObjectInputStream;\n import java.io.ObjectOutputStream;\n \n-public interface ObjectMarshallingStrategy {\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n \n+public interface ObjectMarshallingStrategy {\n+     \n+    ObjectMapper MAPPER = new ObjectMapper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3NjMyMg==", "bodyText": "Please rename test to PersistableProcessInstanceIT and run it as part of the maven-failsafe-plugin as this is an integration test", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441376322", "createdAt": "2020-06-17T08:34:01Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceTest.java", "diffHunk": "@@ -0,0 +1,109 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.Collections;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.AfterEach;\n+import org.junit.jupiter.api.BeforeEach;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.FixedHostPortGenericContainer;\n+import org.testcontainers.containers.GenericContainer;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Container;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+\n+class PersistableProcessInstanceTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM3ODIxNw==", "bodyText": "please make the database name configurable. It's fine to use kogito as default.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441378217", "createdAt": "2020-06-17T08:37:05Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/CommonUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.stream.Collectors;\n+\n+import com.mongodb.MongoClientSettings;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.bson.codecs.configuration.CodecRegistry;\n+import org.bson.codecs.pojo.PojoCodecProvider;\n+import org.jbpm.marshalling.impl.ProcessInstanceData;\n+import org.kie.kogito.mongodb.codec.ProcessInstanceDocumentCodecProvider;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.model.Strategy;\n+\n+import static org.bson.codecs.configuration.CodecRegistries.fromProviders;\n+import static org.bson.codecs.configuration.CodecRegistries.fromRegistries;\n+\n+public class CommonUtils {\n+\n+    private static final String KOGITO_STORE = \"Kogito_store\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTM4MDkwOA==", "bodyText": "I would suggest creating mapper function classes for these two convert methods.\nEx:\n ProcessInstanceDocumentMapper implements Function<ProcessInstanceData, ProcessInstanceDocument> {\nThat should allow to be easily tested independently", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441380908", "createdAt": "2020-06-17T08:41:17Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/CommonUtils.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.stream.Collectors;\n+\n+import com.mongodb.MongoClientSettings;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.bson.codecs.configuration.CodecRegistry;\n+import org.bson.codecs.pojo.PojoCodecProvider;\n+import org.jbpm.marshalling.impl.ProcessInstanceData;\n+import org.kie.kogito.mongodb.codec.ProcessInstanceDocumentCodecProvider;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.model.Strategy;\n+\n+import static org.bson.codecs.configuration.CodecRegistries.fromProviders;\n+import static org.bson.codecs.configuration.CodecRegistries.fromRegistries;\n+\n+public class CommonUtils {\n+\n+    private static final String KOGITO_STORE = \"Kogito_store\";\n+\n+    private CommonUtils() {}\n+\n+    public static MongoCollection<ProcessInstanceDocument> getCollection(MongoClient mongoClient, String processId) {\n+        CodecRegistry registry = fromRegistries(MongoClientSettings.getDefaultCodecRegistry(), fromProviders(PojoCodecProvider.builder().automatic(true).build(), new ProcessInstanceDocumentCodecProvider()));\n+        MongoDatabase mongoDatabase = mongoClient.getDatabase(KOGITO_STORE).withCodecRegistry(registry);\n+        return mongoDatabase.getCollection(processId, ProcessInstanceDocument.class).withCodecRegistry(registry);\n+    }\n+\n+    public static ProcessInstanceDocument convertToProcessInstanceDoument(ProcessInstanceData data) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMzM2NzE1", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-432336715", "createdAt": "2020-06-17T12:12:07Z", "commit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjoxMjowN1rOGlC3Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjoxMjowN1rOGlC3Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NzM1MA==", "bodyText": "why are these dependencies in kogito-api?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r441497350", "createdAt": "2020-06-17T12:12:07Z", "author": {"login": "evacchi"}, "path": "api/kogito-api/pom.xml", "diffHunk": "@@ -45,7 +45,14 @@\n         </exclusion>\n       </exclusions>\n     </dependency>\n-\n+    <dependency>\n+      <groupId>com.fasterxml.jackson.core</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 6}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/55059ecc25510599a92a8f7100b6490c2017dd42", "committedDate": "2020-06-09T22:14:16Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "5b0747730a00a089acec5b5d64015972ff57a3d2", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/5b0747730a00a089acec5b5d64015972ff57a3d2", "committedDate": "2020-06-19T21:33:48Z", "message": "rebase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0NDMyNDI2", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-434432426", "createdAt": "2020-06-20T14:36:05Z", "commit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDozNjowNVrOGmm2XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMFQxNDo0NTo0MFrOGmm5Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTU4MQ==", "bodyText": "Why do you need these extra methods and not reuse marshall/unmarshall? Introducing this json would require (or kind of confuse) users to always implement json approach", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r443135581", "createdAt": "2020-06-20T14:36:05Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/DocumentMarshallingStrategy.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.io.IOException;\n+import java.io.ObjectInputStream;\n+import java.io.ObjectOutputStream;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import org.kie.api.marshalling.MarshallingException;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.marshalling.UnmarshallingException;\n+\n+public class DocumentMarshallingStrategy implements ObjectMarshallingStrategy {\n+\n+    public static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    @Override\n+    public boolean accept(Object object) {\n+        return object != null;\n+    }\n+\n+    @Override\n+    public Context createContext() {\n+        return null;\n+    }\n+\n+    @Override\n+    public void write(ObjectOutputStream os, Object object) throws IOException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public Object read(ObjectInputStream os) throws IOException, ClassNotFoundException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public byte[] marshal(Context context, ObjectOutputStream os, Object object) throws IOException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public Object unmarshal(String dataType,\n+                            Context context,\n+                            ObjectInputStream is,\n+                            byte[] object,\n+                            ClassLoader classloader) throws IOException, ClassNotFoundException {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public String marshalToJson(Object object) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTcyOQ==", "bodyText": "I find it quite weird to mix two ways of serializing process instance\n\nprotobuf for process instance\njson/string for variables\n\nWhy nit to use document for everything?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r443135729", "createdAt": "2020-06-20T14:38:05Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,131 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.jbpm.marshalling.impl.ProcessInstanceData;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.CommonUtils;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMapper;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.kie.kogito.process.impl.marshalling.ProcessInstanceMarshaller;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstances.class);\n+    private org.kie.kogito.process.Process<?> process;\n+    private final MongoCollection<ProcessInstanceDocument> collection;\n+    private ProcessInstanceMarshaller marshaller;\n+    private static final String PROCESS_INSTANCE_ID = \"processInstance.id\";\n+\n+    public PersistableProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process, String dbName) {\n+        this.process = process;\n+        collection = CommonUtils.getCollection(mongoClient, process.id(), dbName);\n+        marshaller = new ProcessInstanceMarshaller(new DocumentMarshallingStrategy());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNTkyNg==", "bodyText": "Small typo i think, getlegacy... should be getLegacy", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r443135926", "createdAt": "2020-06-20T14:40:40Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/ProcessInstanceMapper.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+import org.bson.Document;\n+import org.jbpm.marshalling.impl.ProcessInstanceData;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.model.Strategy;\n+\n+public class ProcessInstanceMapper {\n+\n+    private ProcessInstanceMapper() {}\n+\n+    public static class ProcessInstanceDocumentMapper implements Function<ProcessInstanceData, ProcessInstanceDocument> {\n+\n+        @Override\n+        public ProcessInstanceDocument apply(ProcessInstanceData data) {\n+            return new ProcessInstanceDocument(Document.parse(data.getlegacyProcessInstance()), data.getStrategies().entrySet().stream().map(e -> new Strategy(e.getValue(), e.getKey())).collect(Collectors.toList()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNjAyMw==", "bodyText": "This should fail instead as storing process instance without id should never happen", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r443136023", "createdAt": "2020-06-20T14:41:52Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/codec/ProcessInstanceDocumentCodec.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.codec;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.UUID;\n+\n+import com.mongodb.MongoClientSettings;\n+import org.bson.BsonReader;\n+import org.bson.BsonString;\n+import org.bson.BsonValue;\n+import org.bson.BsonWriter;\n+import org.bson.Document;\n+import org.bson.codecs.Codec;\n+import org.bson.codecs.CollectibleCodec;\n+import org.bson.codecs.DecoderContext;\n+import org.bson.codecs.EncoderContext;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.model.Strategy;\n+\n+public class ProcessInstanceDocumentCodec implements CollectibleCodec<ProcessInstanceDocument> {\n+\n+    private final Codec<Document> documentCodec;\n+\n+    public ProcessInstanceDocumentCodec() {\n+        documentCodec = MongoClientSettings.getDefaultCodecRegistry().get(Document.class);\n+    }\n+\n+    @Override\n+    public void encode(BsonWriter writer, ProcessInstanceDocument piDoc, EncoderContext encoderContext) {\n+        Document doc = new Document();\n+        doc.put(\"processInstance\", piDoc.getProcessInstance());\n+        List<Document> strategies = new ArrayList<>();\n+        for (Strategy s : piDoc.getStrategies()) {\n+            Document d = new Document();\n+            d.put(\"strategyId\", s.getStrategyId());\n+            d.put(\"strategyName\", s.getStrategyName());\n+            strategies.add(d);\n+        }\n+\n+        doc.put(\"strategies\", strategies);\n+        documentCodec.encode(writer, doc, encoderContext);\n+    }\n+\n+    @Override\n+    public Class<ProcessInstanceDocument> getEncoderClass() {\n+        return ProcessInstanceDocument.class;\n+    }\n+\n+    @Override\n+    public ProcessInstanceDocument generateIdIfAbsentFromDocument(ProcessInstanceDocument document) {\n+        if (!documentHasId(document)) {\n+            document.setId(UUID.randomUUID().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzEzNjI5OA==", "bodyText": "If this would just use normal methods this if is not needed", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r443136298", "createdAt": "2020-06-20T14:45:40Z", "author": {"login": "mswiderski"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/marshalling/impl/ProtobufProcessMarshaller.java", "diffHunk": "@@ -186,11 +187,17 @@ public static Variable marshallVariable(MarshallerWriteContext context,\n         if(value != null){\n             ObjectMarshallingStrategy strategy = context.objectMarshallingStrategyStore.getStrategyObject( value );\n             Integer index = context.getStrategyIndex( strategy );\n-            builder.setStrategyIndex( index )\n-                   .setDataType(strategy.getType(value.getClass()))\n-                   .setValue( ByteString.copyFrom( strategy.marshal( context.strategyContext.get( strategy ),\n-                                                                     context,\n-                                                                     value ) ) );\n+            if (strategy.getName().contains(DOCUMENT_MARSHALLING_STRATEGY)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "65206a8d759a249033fb9c3843b40a8626cd2e33", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/65206a8d759a249033fb9c3843b40a8626cd2e33", "committedDate": "2020-06-20T00:12:07Z", "message": "test"}, "afterCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/f37e5c016b4315b2311819204d7a970463cddb25", "committedDate": "2020-06-26T05:27:22Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODkwNjE3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-439890617", "createdAt": "2020-06-30T10:39:25Z", "commit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxMDozOToyNlrOGq2fvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxNTowMTowN1rOGrAtUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4NjIzNw==", "bodyText": "@swati-kale can you try to merge/reuse the constructors?\n  this(processes, etc...", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447586237", "createdAt": "2020-06-30T10:39:26Z", "author": {"login": "cristianonicolai"}, "path": "drools/drools-core/src/main/java/org/drools/core/marshalling/impl/MarshallerReaderContext.java", "diffHunk": "@@ -162,6 +162,46 @@ public MarshallerReaderContext(InputStream stream,\n             this.kBase.getProcesses().forEach( p -> this.processes.put(p.getId(), p));\n         }\n     }\n+    \n+    public MarshallerReaderContext(Map<String, Process> processes,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4NzE4Ng==", "bodyText": "same here regarding constructor.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447587186", "createdAt": "2020-06-30T10:41:13Z", "author": {"login": "cristianonicolai"}, "path": "drools/drools-core/src/main/java/org/drools/core/marshalling/impl/MarshallerWriteContext.java", "diffHunk": "@@ -121,6 +121,36 @@ public MarshallerWriteContext(OutputStream stream,\n         this.env = env;\n \n     }\n+    \n+    public MarshallerWriteContext(InternalKnowledgeBase kBase,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4NzY3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    \t}else if (persistenceType.equals(MONGODB_PERSISTENCE_TYPE)) {\n          \n          \n            \n                    \t} else if (persistenceType.equals(MONGODB_PERSISTENCE_TYPE)) {", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447587678", "createdAt": "2020-06-30T10:42:12Z", "author": {"login": "cristianonicolai"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/persistence/PersistenceGenerator.java", "diffHunk": "@@ -121,7 +126,9 @@ public ApplicationSection section() {\n         \t\tinifinispanBasedPersistence(generatedFiles);\n         \t} else if (persistenceType.equals(FILESYSTEM_PERSISTENCE_TYPE)) {\n         \t\tfileSystemBasedPersistence(generatedFiles);\n-        \t}\n+        \t}else if (persistenceType.equals(MONGODB_PERSISTENCE_TYPE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4OTQ5OQ==", "bodyText": "@swati-kale I believe the dbname should be something that can be tweaked at runtime, as a configuration. For instance, when running a quarkus app, take it from https://quarkus.io/guides/mongodb#quarkus-mongodb_quarkus.mongodb.database", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447589499", "createdAt": "2020-06-30T10:45:32Z", "author": {"login": "cristianonicolai"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/persistence/PersistenceGenerator.java", "diffHunk": "@@ -324,13 +312,61 @@ protected void fileSystemBasedPersistence(List<GeneratedFile> generatedFiles) {\n             persistenceProviderClazz.addMember(pathMethod);\n         }\n         \n-        String packageName = compilationUnit.getPackageDeclaration().map(pd -> pd.getName().toString()).orElse(\"\");\n-        String clazzName = packageName + \".\" + persistenceProviderClazz.findFirst(ClassOrInterfaceDeclaration.class).map(c -> c.getName().toString()).get();\n-     \n-        generatedFiles.add(new GeneratedFile(GeneratedFile.Type.CLASS,\n-                                             clazzName.replace('.', '/') + \".java\",\n-                                             compilationUnit.toString().getBytes(StandardCharsets.UTF_8))); \n-        \n+        generatePersistenceProviderClazz(generatedFiles, persistenceProviderClazz, compilationUnit);\n+    }\n+    \n+    private void mongodbBasedPersistence(List<GeneratedFile> generatedFiles) {\n+        String dbName = context.getApplicationProperty(\"kogito.persistence.dbName\").orElse(\"kogito\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU5MTg0OQ==", "bodyText": "still needs review.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447591849", "createdAt": "2020-06-30T10:49:49Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,119 @@\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTI3Mzc1NA=="}, "originalCommit": {"oid": "55059ecc25510599a92a8f7100b6490c2017dd42"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzYxMzIwMw==", "bodyText": "@swati-kale how about using https://www.testcontainers.org/modules/databases/mariadb/ instead?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447613203", "createdAt": "2020-06-30T11:32:29Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/pom.xml", "diffHunk": "@@ -0,0 +1,116 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+\n+<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\n+\txmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\n+\txsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd\">\n+\t<parent>\n+\t\t<groupId>org.kie.kogito</groupId>\n+\t\t<artifactId>persistence</artifactId>\n+\t\t<version>8.0.0-SNAPSHOT</version>\n+\t</parent>\n+\t<modelVersion>4.0.0</modelVersion>\n+\t<artifactId>mongodb-persistence-addon</artifactId>\n+\t<name>Kogito :: Add-Ons :: Persistence :: MongoDB</name>\n+\t<description>MongoDB based persistence for Kogito</description>\n+\t<properties>\n+\t\t<version.org.mongodb.image>mongo:4.0</version.org.mongodb.image>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcxODA4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            Optional<? extends ProcessInstance<T>> opt = Optional.of(marshaller.unmarshallProcessInstance(cursor.next(), process));\n          \n          \n            \n                            list.add(opt.get());\n          \n          \n            \n                            list.add(marshaller.unmarshallProcessInstance(cursor.next(), process));", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447718081", "createdAt": "2020-06-30T14:16:27Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.bson.BsonString;\n+import org.bson.Document;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentProcessInstanceMarshaller;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.DOCUMENT_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getCollection;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstances.class);\n+    private org.kie.kogito.process.Process<?> process;\n+    private DocumentProcessInstanceMarshaller marshaller;\n+    private final MongoCollection<Document> collection;\n+\n+    public PersistableProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process, String dbName) {\n+        this.process = process;\n+        collection = getCollection(mongoClient, process.id(), dbName);\n+        marshaller = new DocumentProcessInstanceMarshaller(new DocumentMarshallingStrategy());\n+    }\n+\n+    @Override\n+    public Optional<? extends ProcessInstance<T>> findById(String id) {\n+        Document piDoc = collection.find(Filters.eq(DOCUMENT_ID, resolveId(id))).first();\n+        if (piDoc == null) {\n+            return Optional.empty();\n+        }\n+\n+        return Optional.of(marshaller.unmarshallProcessInstance(piDoc, process));\n+    }\n+\n+    @Override\n+    public Collection<? extends ProcessInstance<T>> values() {\n+        List<ProcessInstance<T>> list = new ArrayList<>();\n+        MongoCursor<Document> cursor = collection.find().iterator();\n+        try {\n+            while (cursor.hasNext()) {\n+                Optional<? extends ProcessInstance<T>> opt = Optional.of(marshaller.unmarshallProcessInstance(cursor.next(), process));\n+                list.add(opt.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyMjU5NQ==", "bodyText": "As suggested, if you use the testcontainer provided mongodb, this should not be needed.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447722595", "createdAt": "2020-06-30T14:22:16Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/MongoDbContainer.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import org.testcontainers.containers.GenericContainer;\n+\n+public class MongoDbContainer extends GenericContainer<MongoDbContainer> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzcyNTgyMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final String STRATEGIES = \"stategies\";\n          \n          \n            \n                public static final String STRATEGIES = \"strategies\";", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447725821", "createdAt": "2020-06-30T14:26:20Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/DocumentUtils.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+import org.kie.kogito.mongodb.marshalling.DocumentUnmarshallingException;\n+\n+public class DocumentUtils {\n+\n+    private DocumentUtils() {}\n+\n+    public static MongoCollection<Document> getCollection(MongoClient mongoClient, String processId, String dbName) {\n+        MongoDatabase mongoDatabase = mongoClient.getDatabase(dbName);\n+        return mongoDatabase.getCollection(processId);\n+    }\n+\n+    public static final String VARIABLE = \"variable\";\n+    public static final String VALUE = \"value\";\n+    public static final String DOCUMENT_ID = \"_id\";\n+    public static final String PROCESS_INSTANCE_ID = \"id\";\n+    public static final String STRATEGIES = \"stategies\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc0NzAyNQ==", "bodyText": "you should be able to provide this via application.properties in the test/resources.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447747025", "createdAt": "2020-06-30T14:53:03Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceIT.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.testcontainers.containers.output.Slf4jLogConsumer;\n+import org.testcontainers.containers.wait.strategy.Wait;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+\n+@Testcontainers\n+class PersistableProcessInstanceIT {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstanceIT.class);\n+    private SecurityPolicy securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"john\"));\n+\n+    private static MongoDbContainer mongoDbContainer;\n+\n+    @BeforeAll\n+    public static void startContainerAndPublicPortIsAvailable() {\n+        mongoDbContainer = new MongoDbContainer();\n+        mongoDbContainer.withLogConsumer(new Slf4jLogConsumer(LOGGER))\n+                        .waitingFor(Wait.forLogMessage(\".*build index done.*\", 1));\n+        mongoDbContainer.start();\n+    }\n+\n+    @Test\n+    void test() {\n+        MongoClient mongoClient = MongoClients.create();\n+        BpmnProcess process = BpmnProcess.from(new ClassPathResource(\"BPMN2-UserTask.bpmn2\"))\n+                                         .get(0);\n+        process.setProcessInstancesFactory(new PersistProcessInstancesFactory(mongoClient));\n+        process.configure();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"test\", \"test\");\n+        parameters.put(\"integerVar\", 10);\n+        parameters.put(\"booleanVar\", true);\n+        parameters.put(\"doubleVar\", 10.11);\n+        parameters.put(\"floatVar\", 3.5f);\n+        parameters.put(\"address\", new Address(\"main street\", \"Boston\", \"10005\", \"US\"));\n+        ProcessInstance<BpmnVariables> processInstance = process.createInstance(BpmnVariables.create(parameters));\n+\n+        processInstance.start();\n+        assertThat(processInstance.status()).isEqualTo(STATE_ACTIVE);\n+        assertThat(processInstance.description()).isEqualTo(\"User Task\");\n+\n+        Collection<? extends ProcessInstance<BpmnVariables>> values = process.instances().values();\n+        assertThat(values).hasSize(1);\n+\n+        String testVar = (String) processInstance.variables().get(\"test\");\n+        assertThat(testVar).isEqualTo(\"test\");\n+        Object addr = processInstance.variables().get(\"address\");\n+        assertThat(addr.getClass().getName()).isEqualTo(\"org.kie.kogito.mongodb.Address\");\n+        Object flt = processInstance.variables().get(\"floatVar\");\n+        assertThat(flt.getClass().getName()).isEqualTo(\"java.lang.Float\");\n+        assertThat(processInstance.description()).isEqualTo(\"User Task\");\n+\n+        WorkItem workItem = processInstance.workItems(securityPolicy).get(0);\n+        assertThat(workItem).isNotNull();\n+        assertThat(workItem.getParameters().get(\"ActorId\")).isEqualTo(\"john\");\n+        processInstance.completeWorkItem(workItem.getId(), null, securityPolicy);\n+        assertThat(processInstance.status()).isEqualTo(STATE_COMPLETED);\n+\n+    }\n+\n+    private class PersistProcessInstancesFactory extends KogitoProcessInstancesFactory {\n+\n+        public PersistProcessInstancesFactory(MongoClient mongoClient) {\n+            super(mongoClient);\n+\n+        }\n+\n+        @Override\n+        public String dbName() {\n+            return \"test_db\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 108}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzc1MzU1Mw==", "bodyText": "@swati-kale I wonder if would simplify things if you take this approach: https://quarkus.io/guides/mongodb#simplifying-mongodb-client-usage-using-bson-codec\nThat way the marshall/unmarshall wouldnt need to be done manually. wdyt?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r447753553", "createdAt": "2020-06-30T15:01:07Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/ProcessInstanceDocumentMapper.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.base.Function;\n+import org.bson.Document;\n+import org.drools.core.marshalling.impl.ProcessMarshallerWriteContext;\n+import org.drools.core.util.Drools;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.NAME;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.PROCESS_INSTANCE_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.STRATEGIES;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VALUE;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VARIABLE;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VERSION;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VERSION_MAJOR;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VERSION_MINOR;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.VERSION_REVISION;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getObjectMapper;\n+\n+public class ProcessInstanceDocumentMapper implements Function<ProcessMarshallerWriteContext, Document> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNTI3MTQz", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-442527143", "createdAt": "2020-07-03T18:12:50Z", "commit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxODoxMjo1MVrOGs1_DA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QxODoxODozNVrOGs2DQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY3NTAyMA==", "bodyText": "Will this work with list of objects?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r449675020", "createdAt": "2020-07-03T18:12:51Z", "author": {"login": "mswiderski"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/DocumentUtils.java", "diffHunk": "@@ -0,0 +1,72 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.Document;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+import org.kie.kogito.mongodb.marshalling.DocumentUnmarshallingException;\n+\n+public class DocumentUtils {\n+\n+    private DocumentUtils() {}\n+\n+    public static MongoCollection<Document> getCollection(MongoClient mongoClient, String processId, String dbName) {\n+        MongoDatabase mongoDatabase = mongoClient.getDatabase(dbName);\n+        return mongoDatabase.getCollection(processId);\n+    }\n+\n+    public static final String VARIABLE = \"variable\";\n+    public static final String VALUE = \"value\";\n+    public static final String DOCUMENT_ID = \"_id\";\n+    public static final String PROCESS_INSTANCE_ID = \"id\";\n+    public static final String STRATEGIES = \"stategies\";\n+    public static final String NAME = \"name\";\n+    public static final String VERSION = \"version\";\n+    public static final String VERSION_MAJOR = \"versionMajor\";\n+    public static final String VERSION_MINOR = \"versionMinor\";\n+    public static final String VERSION_REVISION = \"versionRevision\";\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+    public static final String DOCUMENT_MARSHALLING_ERROR_MSG = \"Error while marshalling process instance with id as document : \";\n+    public static final String DOCUMENT_UNMARSHALLING_ERROR_MSG = \"Error while unmarshalling document for process instance with id : \";\n+\n+    public static ObjectMapper getObjectMapper() {\n+        return MAPPER;\n+    }\n+\n+    public static byte[] toByteArray(Object object) {\n+        String json = null;\n+        try {\n+            json = MAPPER.writeValueAsString(object);\n+        } catch (JsonProcessingException e) {\n+            throw new DocumentMarshallingException(e);\n+        }\n+        return json.getBytes();\n+    }\n+\n+    public static Object fromByteArray(String dataType, byte[] object) {\n+        try {\n+            Class<?> loadClass = Thread.currentThread().getContextClassLoader().loadClass(dataType);\n+            return MAPPER.readValue(new String(object), loadClass);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTY3NjA5OQ==", "bodyText": "It coul be prblematic if mongo is used for other logic as well. So I\u2019d stick to kogito scoped property, just to add mongodb in the property name to be consistent with other properties", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r449676099", "createdAt": "2020-07-03T18:18:35Z", "author": {"login": "mswiderski"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/persistence/PersistenceGenerator.java", "diffHunk": "@@ -324,13 +312,61 @@ protected void fileSystemBasedPersistence(List<GeneratedFile> generatedFiles) {\n             persistenceProviderClazz.addMember(pathMethod);\n         }\n         \n-        String packageName = compilationUnit.getPackageDeclaration().map(pd -> pd.getName().toString()).orElse(\"\");\n-        String clazzName = packageName + \".\" + persistenceProviderClazz.findFirst(ClassOrInterfaceDeclaration.class).map(c -> c.getName().toString()).get();\n-     \n-        generatedFiles.add(new GeneratedFile(GeneratedFile.Type.CLASS,\n-                                             clazzName.replace('.', '/') + \".java\",\n-                                             compilationUnit.toString().getBytes(StandardCharsets.UTF_8))); \n-        \n+        generatePersistenceProviderClazz(generatedFiles, persistenceProviderClazz, compilationUnit);\n+    }\n+    \n+    private void mongodbBasedPersistence(List<GeneratedFile> generatedFiles) {\n+        String dbName = context.getApplicationProperty(\"kogito.persistence.dbName\").orElse(\"kogito\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU4OTQ5OQ=="}, "originalCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25"}, "originalPosition": 110}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f37e5c016b4315b2311819204d7a970463cddb25", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/f37e5c016b4315b2311819204d7a970463cddb25", "committedDate": "2020-06-26T05:27:22Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "361d88ec0a295e8e4e4d9ea4bd71eee7af124579", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/361d88ec0a295e8e4e4d9ea4bd71eee7af124579", "committedDate": "2020-07-24T01:59:25Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "361d88ec0a295e8e4e4d9ea4bd71eee7af124579", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/361d88ec0a295e8e4e4d9ea4bd71eee7af124579", "committedDate": "2020-07-24T01:59:25Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "ca979371029c055e778e05129a331e53ca479313", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ca979371029c055e778e05129a331e53ca479313", "committedDate": "2020-07-24T07:09:00Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ca979371029c055e778e05129a331e53ca479313", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/ca979371029c055e778e05129a331e53ca479313", "committedDate": "2020-07-24T07:09:00Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/df60b507ffc8e2e606f2a2da8c16e5f006338293", "committedDate": "2020-07-24T22:20:10Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MDA3Nzk5", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-459007799", "createdAt": "2020-07-31T08:36:52Z", "commit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODozNjo1MlrOG6AmFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMDoyODo0OVrOG6D0ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4MDM0MQ==", "bodyText": "is the process instance created twice in here?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r463480341", "createdAt": "2020-07-31T08:36:52Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/marshalling/DocumentProcessInstanceMarshaller.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.marshalling;\n+\n+import java.util.Collections;\n+\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.impl.EnvironmentImpl;\n+import org.drools.core.marshalling.impl.ClassObjectMarshallingStrategyAcceptor;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.drools.core.marshalling.impl.ProcessMarshallerWriteContext;\n+import org.drools.core.marshalling.impl.SerializablePlaceholderResolverStrategy;\n+import org.jbpm.marshalling.impl.AbstractProtobufProcessInstanceMarshaller;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.runtime.Environment;\n+import org.kie.api.runtime.EnvironmentName;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceDocumentMapper;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMessageMapper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_MARSHALLING_ERROR_MSG;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_UNMARSHALLING_ERROR_MSG;\n+\n+public class DocumentProcessInstanceMarshaller extends AbstractProtobufProcessInstanceMarshaller {\n+\n+    private Environment env = new EnvironmentImpl();\n+\n+    public DocumentProcessInstanceMarshaller(ObjectMarshallingStrategy... strategies) {\n+        ObjectMarshallingStrategy[] strats = null;\n+        if (strategies == null) {\n+            strats = new ObjectMarshallingStrategy[]{new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT)};\n+        } else {\n+            strats = new ObjectMarshallingStrategy[strategies.length + 1];\n+            int i = 0;\n+            for (ObjectMarshallingStrategy strategy : strategies) {\n+                strats[i] = strategy;\n+                i++;\n+            }\n+            strats[i] = new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT);\n+        }\n+        env.set(EnvironmentName.OBJECT_MARSHALLING_STRATEGIES, strats);\n+    }\n+\n+    @Override\n+    protected WorkflowProcessInstanceImpl createProcessInstance() {\n+        return new RuleFlowProcessInstance();\n+    }\n+\n+    public ProcessInstanceDocument marshalProcessInstance(ProcessInstance<?> processInstance) {\n+        try {\n+            WorkflowProcessInstance pi = ((AbstractProcessInstance<?>) processInstance).internalGetProcessInstance();\n+            ProcessMarshallerWriteContext context = new ProcessMarshallerWriteContext(null, null, null, null, env);\n+            context.parameterObject = JsonFormat.printer().print(super.writeProcessInstance(context, pi));\n+            ProcessInstanceDocument document = new ProcessInstanceDocumentMapper().apply(context);\n+            ((WorkflowProcessInstanceImpl) pi).disconnect();\n+            return document;\n+        } catch (Exception e) {\n+            throw new DocumentMarshallingException(processInstance.id(), e, DOCUMENT_MARSHALLING_ERROR_MSG);\n+        }\n+    }\n+\n+    public WorkflowProcessInstance unmarshallWorkflowProcessInstance(ProcessInstanceDocument doc, Process<?> process) {\n+        try {\n+            MarshallerReaderContext context = new MarshallerReaderContext(Collections.singletonMap(process.id(), ((AbstractProcess<?>) process).process()), null, null, null, env, null);\n+            context.parameterObject = doc;\n+            JBPMMessages.ProcessInstance instance = new ProcessInstanceMessageMapper().apply(context);\n+            context.parameterObject = instance;\n+            return (WorkflowProcessInstance) super.readProcessInstance(context);\n+        } catch (Exception e) {\n+            throw new DocumentUnmarshallingException(process.id(), e, DOCUMENT_UNMARSHALLING_ERROR_MSG);\n+        }\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public <T> ProcessInstance<T> unmarshallProcessInstance(ProcessInstanceDocument doc, Process<?> process) {\n+        AbstractProcess<?> ap = (AbstractProcess<?>) process;\n+        ap.createInstance(unmarshallWorkflowProcessInstance(doc, process));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ4MTUzNQ==", "bodyText": "maybe make ProcessInstanceMessageMapper a BiFunction instead so you can pass the dec as second argument instead of reusing the context for that.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r463481535", "createdAt": "2020-07-31T08:39:26Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/marshalling/DocumentProcessInstanceMarshaller.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.marshalling;\n+\n+import java.util.Collections;\n+\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.impl.EnvironmentImpl;\n+import org.drools.core.marshalling.impl.ClassObjectMarshallingStrategyAcceptor;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.drools.core.marshalling.impl.ProcessMarshallerWriteContext;\n+import org.drools.core.marshalling.impl.SerializablePlaceholderResolverStrategy;\n+import org.jbpm.marshalling.impl.AbstractProtobufProcessInstanceMarshaller;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.runtime.Environment;\n+import org.kie.api.runtime.EnvironmentName;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceDocumentMapper;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMessageMapper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_MARSHALLING_ERROR_MSG;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_UNMARSHALLING_ERROR_MSG;\n+\n+public class DocumentProcessInstanceMarshaller extends AbstractProtobufProcessInstanceMarshaller {\n+\n+    private Environment env = new EnvironmentImpl();\n+\n+    public DocumentProcessInstanceMarshaller(ObjectMarshallingStrategy... strategies) {\n+        ObjectMarshallingStrategy[] strats = null;\n+        if (strategies == null) {\n+            strats = new ObjectMarshallingStrategy[]{new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT)};\n+        } else {\n+            strats = new ObjectMarshallingStrategy[strategies.length + 1];\n+            int i = 0;\n+            for (ObjectMarshallingStrategy strategy : strategies) {\n+                strats[i] = strategy;\n+                i++;\n+            }\n+            strats[i] = new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT);\n+        }\n+        env.set(EnvironmentName.OBJECT_MARSHALLING_STRATEGIES, strats);\n+    }\n+\n+    @Override\n+    protected WorkflowProcessInstanceImpl createProcessInstance() {\n+        return new RuleFlowProcessInstance();\n+    }\n+\n+    public ProcessInstanceDocument marshalProcessInstance(ProcessInstance<?> processInstance) {\n+        try {\n+            WorkflowProcessInstance pi = ((AbstractProcessInstance<?>) processInstance).internalGetProcessInstance();\n+            ProcessMarshallerWriteContext context = new ProcessMarshallerWriteContext(null, null, null, null, env);\n+            context.parameterObject = JsonFormat.printer().print(super.writeProcessInstance(context, pi));\n+            ProcessInstanceDocument document = new ProcessInstanceDocumentMapper().apply(context);\n+            ((WorkflowProcessInstanceImpl) pi).disconnect();\n+            return document;\n+        } catch (Exception e) {\n+            throw new DocumentMarshallingException(processInstance.id(), e, DOCUMENT_MARSHALLING_ERROR_MSG);\n+        }\n+    }\n+\n+    public WorkflowProcessInstance unmarshallWorkflowProcessInstance(ProcessInstanceDocument doc, Process<?> process) {\n+        try {\n+            MarshallerReaderContext context = new MarshallerReaderContext(Collections.singletonMap(process.id(), ((AbstractProcess<?>) process).process()), null, null, null, env, null);\n+            context.parameterObject = doc;\n+            JBPMMessages.ProcessInstance instance = new ProcessInstanceMessageMapper().apply(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ5MDc0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    BpmnProcess process = BpmnProcess.from(new ClassPathResource(\"BPMN2-UserTask.bpmn2\"))\n          \n          \n            \n                                                     .get(0);\n          \n          \n            \n                    BpmnProcess process = BpmnProcess.from(new ClassPathResource(\"BPMN2-UserTask.bpmn2\")).get(0);", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r463490748", "createdAt": "2020-07-31T08:57:47Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/PersistableProcessInstanceIT.java", "diffHunk": "@@ -0,0 +1,124 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoClients;\n+import org.drools.core.io.impl.ClassPathResource;\n+import org.junit.jupiter.api.BeforeAll;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.persistence.KogitoProcessInstancesFactory;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.bpmn2.BpmnProcess;\n+import org.kie.kogito.process.bpmn2.BpmnVariables;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+import org.testcontainers.containers.MongoDBContainer;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_ACTIVE;\n+import static org.kie.api.runtime.process.ProcessInstance.STATE_COMPLETED;\n+\n+@Testcontainers\n+class PersistableProcessInstanceIT {\n+\n+    private SecurityPolicy securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"john\"));\n+    final static MongoDBContainer mongoDBContainer = new MongoDBContainer();\n+    final static String DB_NAME = \"testdb\";\n+\n+    @BeforeAll\n+    public static void startContainerAndPublicPortIsAvailable() {\n+        mongoDBContainer.start();\n+    }\n+\n+    @Test\n+    void test() {\n+        MongoClient mongoClient = MongoClients.create();\n+        BpmnProcess process = BpmnProcess.from(new ClassPathResource(\"BPMN2-UserTask.bpmn2\"))\n+                                         .get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzUzMzIxNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        ((WorkflowProcessInstanceImpl) pi).disconnect();\n          \n          \n            \n                       pi.disconnect();", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r463533214", "createdAt": "2020-07-31T10:28:49Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/marshalling/DocumentProcessInstanceMarshaller.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.marshalling;\n+\n+import java.util.Collections;\n+\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.impl.EnvironmentImpl;\n+import org.drools.core.marshalling.impl.ClassObjectMarshallingStrategyAcceptor;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.drools.core.marshalling.impl.ProcessMarshallerWriteContext;\n+import org.drools.core.marshalling.impl.SerializablePlaceholderResolverStrategy;\n+import org.jbpm.marshalling.impl.AbstractProtobufProcessInstanceMarshaller;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.runtime.Environment;\n+import org.kie.api.runtime.EnvironmentName;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceDocumentMapper;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMessageMapper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_MARSHALLING_ERROR_MSG;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_UNMARSHALLING_ERROR_MSG;\n+\n+public class DocumentProcessInstanceMarshaller extends AbstractProtobufProcessInstanceMarshaller {\n+\n+    private Environment env = new EnvironmentImpl();\n+\n+    public DocumentProcessInstanceMarshaller(ObjectMarshallingStrategy... strategies) {\n+        ObjectMarshallingStrategy[] strats = null;\n+        if (strategies == null) {\n+            strats = new ObjectMarshallingStrategy[]{new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT)};\n+        } else {\n+            strats = new ObjectMarshallingStrategy[strategies.length + 1];\n+            int i = 0;\n+            for (ObjectMarshallingStrategy strategy : strategies) {\n+                strats[i] = strategy;\n+                i++;\n+            }\n+            strats[i] = new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT);\n+        }\n+        env.set(EnvironmentName.OBJECT_MARSHALLING_STRATEGIES, strats);\n+    }\n+\n+    @Override\n+    protected WorkflowProcessInstanceImpl createProcessInstance() {\n+        return new RuleFlowProcessInstance();\n+    }\n+\n+    public ProcessInstanceDocument marshalProcessInstance(ProcessInstance<?> processInstance) {\n+        try {\n+            WorkflowProcessInstance pi = ((AbstractProcessInstance<?>) processInstance).internalGetProcessInstance();\n+            ProcessMarshallerWriteContext context = new ProcessMarshallerWriteContext(null, null, null, null, env);\n+            context.parameterObject = JsonFormat.printer().print(super.writeProcessInstance(context, pi));\n+            ProcessInstanceDocument document = new ProcessInstanceDocumentMapper().apply(context);\n+            ((WorkflowProcessInstanceImpl) pi).disconnect();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293"}, "originalPosition": 76}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "df60b507ffc8e2e606f2a2da8c16e5f006338293", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/df60b507ffc8e2e606f2a2da8c16e5f006338293", "committedDate": "2020-07-24T22:20:10Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7b1ca92c8957fb74b7a629fad440b17b89a6a5e8", "committedDate": "2020-07-31T14:57:54Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTY5NzM3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-460169737", "createdAt": "2020-08-03T16:30:31Z", "commit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNjozMDozMlrOG7AV0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNzo1MjoyNFrOG7DJ9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDUyNDc1Mg==", "bodyText": "you can use the this.exists(String id)  method here to avoid duplicating code.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r464524752", "createdAt": "2020-08-03T16:30:32Z", "author": {"login": "tiagodolphine"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentProcessInstanceMarshaller;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getCollection;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstances.class);\n+    private org.kie.kogito.process.Process<?> process;\n+    private DocumentProcessInstanceMarshaller marshaller;\n+    private final MongoCollection<ProcessInstanceDocument> collection;\n+\n+    public PersistableProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process, String dbName) {\n+        this.process = process;\n+        collection = getCollection(mongoClient, process.id(), dbName);\n+        marshaller = new DocumentProcessInstanceMarshaller(new DocumentMarshallingStrategy());\n+    }\n+\n+    @Override\n+    public Optional<ProcessInstance<T>> findById(String id) {\n+        ProcessInstanceDocument piDoc = collection.find(Filters.eq(DOCUMENT_ID, resolveId(id))).first();\n+        if (piDoc == null) {\n+            return Optional.empty();\n+        }\n+        return Optional.of(marshaller.unmarshallProcessInstance(piDoc, process));\n+    }\n+\n+    @Override\n+    public Collection<? extends ProcessInstance<T>> values() {\n+\n+        MongoCursor<ProcessInstanceDocument> cursor = collection.find().iterator();\n+        List<ProcessInstance<T>> list = new ArrayList<>();\n+        try {\n+            while (cursor.hasNext()) {\n+                list.add(marshaller.unmarshallProcessInstance(cursor.next(), process));\n+            }\n+        } finally {\n+            cursor.close();\n+        }\n+        return list;\n+    }\n+\n+    @Override\n+    public void create(String id, ProcessInstance<T> instance) {\n+        updateStorage(id, instance, true);\n+    }\n+\n+    @Override\n+    public void update(String id, ProcessInstance<T> instance) {\n+        updateStorage(id, instance, false);\n+    }\n+\n+    protected void updateStorage(String id, ProcessInstance<T> instance, boolean checkDuplicates) {\n+\n+        String resolvedId = resolveId(id);\n+        if (isActive(instance)) {\n+            ProcessInstanceDocument doc = marshaller.marshalProcessInstance(instance);\n+            if (checkDuplicates) {\n+                ProcessInstanceDocument existing = collection.find(Filters.eq(DOCUMENT_ID, resolvedId)).first();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU2NDc4OQ==", "bodyText": "It seems this method is the same as the one on ProcessInstanceDocumentMapper, does it worth to centralize the implementation to avoid duplication?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r464564789", "createdAt": "2020-08-03T17:41:30Z", "author": {"login": "tiagodolphine"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/ProcessInstanceMessageMapper.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.Map;\n+import java.util.function.BiFunction;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.marshalling.impl.JBPMMessages.ProcessInstance;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentUnmarshallingException;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VALUE;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VARIABLE;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getObjectMapper;\n+\n+public class ProcessInstanceMessageMapper implements BiFunction<MarshallerReaderContext, ProcessInstanceDocument, JBPMMessages.ProcessInstance> {\n+\n+    @Override\n+    public ProcessInstance apply(MarshallerReaderContext context, ProcessInstanceDocument doc) {\n+        JBPMMessages.ProcessInstance.Builder builder = JBPMMessages.ProcessInstance.newBuilder();\n+        JsonFormat.Parser parser = JsonFormat.parser();\n+        try {\n+            JsonNode rootNode = getObjectMapper().readTree(doc.getProcessInstance().toJson());\n+            applyVariables(rootNode, VARIABLE);\n+            String json = getObjectMapper().writeValueAsString(rootNode);\n+            parser.merge(json, builder);\n+            for (Map.Entry<String, Integer> entry : doc.getStrategies().entrySet()) {\n+                ObjectMarshallingStrategy strategyObject = context.resolverStrategyFactory.getStrategyObject(entry.getKey());\n+                if (strategyObject != null) {\n+                    context.usedStrategies.put(entry.getValue(), strategyObject);\n+                }\n+            }\n+\n+        } catch (Exception e) {\n+            throw new DocumentUnmarshallingException(e);\n+        }\n+        return builder.build();\n+    }\n+\n+    private void applyVariables(JsonNode parent, String variable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU2NTgzOA==", "bodyText": "make sense to make the method abstract to force the implementations to override it?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r464565838", "createdAt": "2020-08-03T17:42:46Z", "author": {"login": "tiagodolphine"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/persistence/KogitoProcessInstancesFactory.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.persistence;\n+\n+import com.mongodb.client.MongoClient;\n+import org.kie.kogito.mongodb.PersistableProcessInstances;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstancesFactory;\n+\n+/**\n+ * This class must always have exact FQCN as\n+ * <code>org.kie.kogito.persistence.KogitoProcessInstancesFactory</code>\n+ *\n+ */\n+public abstract class KogitoProcessInstancesFactory implements ProcessInstancesFactory {\n+\n+    protected MongoClient mongoClient;\n+\n+    public KogitoProcessInstancesFactory(MongoClient mongoClient) {\n+        this.mongoClient = mongoClient;\n+    }\n+\n+    public String dbName() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDU3MDg2OA==", "bodyText": "the collection.find(Filters.eq(DOCUMENT_ID, resolvedId)).first() is used in many places, why not extracting into a method to be reused?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r464570868", "createdAt": "2020-08-03T17:52:24Z", "author": {"login": "tiagodolphine"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentProcessInstanceMarshaller;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getCollection;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstances.class);\n+    private org.kie.kogito.process.Process<?> process;\n+    private DocumentProcessInstanceMarshaller marshaller;\n+    private final MongoCollection<ProcessInstanceDocument> collection;\n+\n+    public PersistableProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process, String dbName) {\n+        this.process = process;\n+        collection = getCollection(mongoClient, process.id(), dbName);\n+        marshaller = new DocumentProcessInstanceMarshaller(new DocumentMarshallingStrategy());\n+    }\n+\n+    @Override\n+    public Optional<ProcessInstance<T>> findById(String id) {\n+        ProcessInstanceDocument piDoc = collection.find(Filters.eq(DOCUMENT_ID, resolveId(id))).first();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b1ca92c8957fb74b7a629fad440b17b89a6a5e8", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7b1ca92c8957fb74b7a629fad440b17b89a6a5e8", "committedDate": "2020-07-31T14:57:54Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "b73f23ca8da37415015df9ca52764bd2da4a98ab", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b73f23ca8da37415015df9ca52764bd2da4a98ab", "committedDate": "2020-08-04T18:09:00Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b73f23ca8da37415015df9ca52764bd2da4a98ab", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b73f23ca8da37415015df9ca52764bd2da4a98ab", "committedDate": "2020-08-04T18:09:00Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "10ef05a8681a723f74471f11537578800d52c63b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/10ef05a8681a723f74471f11537578800d52c63b", "committedDate": "2020-08-06T20:18:54Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "10ef05a8681a723f74471f11537578800d52c63b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/10ef05a8681a723f74471f11537578800d52c63b", "committedDate": "2020-08-06T20:18:54Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "18aaf70c95a2fabd6c683a70a42c44277239dbad", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/18aaf70c95a2fabd6c683a70a42c44277239dbad", "committedDate": "2020-08-06T20:54:55Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18aaf70c95a2fabd6c683a70a42c44277239dbad", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/18aaf70c95a2fabd6c683a70a42c44277239dbad", "committedDate": "2020-08-06T20:54:55Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "fb2b8827ea3fc329d33c3533921a152eca0d4b3b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/fb2b8827ea3fc329d33c3533921a152eca0d4b3b", "committedDate": "2020-08-07T04:56:40Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb2b8827ea3fc329d33c3533921a152eca0d4b3b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/fb2b8827ea3fc329d33c3533921a152eca0d4b3b", "committedDate": "2020-08-07T04:56:40Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/3f8b28100fd74d216c5bee049d85d58f7b700bd8", "committedDate": "2020-08-09T22:15:12Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/3f8b28100fd74d216c5bee049d85d58f7b700bd8", "committedDate": "2020-08-09T22:15:12Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/27f314550a7bdcde1521bcf3acad029a298d7cd4", "committedDate": "2020-08-10T14:41:53Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MTc3NzIy", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-464177722", "createdAt": "2020-08-10T12:19:25Z", "commit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxMjoxOToyNlrOG-MK1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjoyNzoyMVrOG-WNhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg2NDI3OQ==", "bodyText": "What about using try-with-resources here for MongoCursor?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467864279", "createdAt": "2020-08-10T12:19:26Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentProcessInstanceMarshaller;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.ProcessInstanceReadMode;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getCollection;\n+import static org.kie.kogito.process.ProcessInstanceReadMode.MUTABLE;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {\n+\n+    private static final Logger LOGGER = LoggerFactory.getLogger(PersistableProcessInstances.class);\n+    private org.kie.kogito.process.Process<?> process;\n+    private DocumentProcessInstanceMarshaller marshaller;\n+    private final MongoCollection<ProcessInstanceDocument> collection;\n+\n+    public PersistableProcessInstances(MongoClient mongoClient, org.kie.kogito.process.Process<?> process, String dbName) {\n+        this.process = process;\n+        collection = getCollection(mongoClient, process.id(), dbName);\n+        marshaller = new DocumentProcessInstanceMarshaller(new DocumentMarshallingStrategy());\n+    }\n+\n+    @Override\n+    public Optional<ProcessInstance<T>> findById(String id, ProcessInstanceReadMode mode) {\n+        ProcessInstanceDocument piDoc = find(resolveId(id));\n+        if (piDoc == null) {\n+            return Optional.empty();\n+        }\n+        return Optional.of(mode == MUTABLE ? marshaller.unmarshallProcessInstance(piDoc, process) : marshaller.unmarshallReadOnlyProcessInstance(piDoc, process));\n+    }\n+\n+    @Override\n+    public Collection<ProcessInstance<T>> values(ProcessInstanceReadMode mode) {\n+\n+        MongoCursor<ProcessInstanceDocument> cursor = collection.find().iterator();\n+        List<ProcessInstance<T>> list = new ArrayList<>();\n+        try {\n+            while (cursor.hasNext()) {\n+                list.add(mode == MUTABLE ? marshaller.unmarshallProcessInstance(cursor.next(), process) : marshaller.unmarshallReadOnlyProcessInstance(cursor.next(), process));\n+            }\n+        } finally {\n+            cursor.close();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzg2Njg4NA==", "bodyText": "Why not to name it MongoDBProcessInstances? So far we have:\n\nMapProcessInstances (storage in a map)\nFileSystemProcessInstances (storage in files)\nCacheProcessInstances (storage in an Infinispan cache)\n\nAll of them persist instances in a different way and they have this way as a part of their name.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467866884", "createdAt": "2020-08-10T12:24:38Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/PersistableProcessInstances.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/*\n+* Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+*\n+* Licensed under the Apache License, Version 2.0 (the \"License\");\n+* you may not use this file except in compliance with the License.\n+*\n+*      http://www.apache.org/licenses/LICENSE-2.0\n+*\n+* Unless required by applicable law or agreed to in writing, software\n+* distributed under the License is distributed on an \"AS IS\" BASIS,\n+* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+* See the License for the specific language governing permissions and\n+* limitations under the License.\n+*/\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Optional;\n+\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoCursor;\n+import com.mongodb.client.model.Filters;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingStrategy;\n+import org.kie.kogito.mongodb.marshalling.DocumentProcessInstanceMarshaller;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.process.MutableProcessInstances;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.ProcessInstanceDuplicatedException;\n+import org.kie.kogito.process.ProcessInstanceReadMode;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getCollection;\n+import static org.kie.kogito.process.ProcessInstanceReadMode.MUTABLE;\n+\n+public class PersistableProcessInstances<T extends Model> implements MutableProcessInstances<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkwOTg1Mw==", "bodyText": "Can we have the ProcessInstanceDocumentMapper and the ProcessInstanceMessageMapper symmetric? The thing is that the ProcessInstanceDocumentMapper maps only from JSON to ProcessInstanceDocument while ProcessInstanceMessageMapper maps from ProcessInstanceDocument straight to JBPMMessages.ProcessInstance. I think it would make sense to have this unified.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467909853", "createdAt": "2020-08-10T13:39:14Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/marshalling/DocumentProcessInstanceMarshaller.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.marshalling;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.util.Collections;\n+\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.impl.EnvironmentImpl;\n+import org.drools.core.marshalling.impl.ClassObjectMarshallingStrategyAcceptor;\n+import org.drools.core.marshalling.impl.KogitoMarshallerReaderContext;\n+import org.drools.core.marshalling.impl.KogitoProcessMarshallerWriteContext;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.drools.core.marshalling.impl.SerializablePlaceholderResolverStrategy;\n+import org.jbpm.marshalling.impl.AbstractProtobufProcessInstanceMarshaller;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.runtime.Environment;\n+import org.kie.api.runtime.EnvironmentName;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceDocumentMapper;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMessageMapper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_MARSHALLING_ERROR_MSG;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_UNMARSHALLING_ERROR_MSG;\n+\n+public class DocumentProcessInstanceMarshaller extends AbstractProtobufProcessInstanceMarshaller {\n+\n+    private Environment env = new EnvironmentImpl();\n+\n+    public DocumentProcessInstanceMarshaller(ObjectMarshallingStrategy... strategies) {\n+        ObjectMarshallingStrategy[] strats = null;\n+        if (strategies == null) {\n+            strats = new ObjectMarshallingStrategy[]{new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT)};\n+        } else {\n+            strats = new ObjectMarshallingStrategy[strategies.length + 1];\n+            int i = 0;\n+            for (ObjectMarshallingStrategy strategy : strategies) {\n+                strats[i] = strategy;\n+                i++;\n+            }\n+            strats[i] = new SerializablePlaceholderResolverStrategy(ClassObjectMarshallingStrategyAcceptor.DEFAULT);\n+        }\n+        env.set(EnvironmentName.OBJECT_MARSHALLING_STRATEGIES, strats);\n+    }\n+\n+    @Override\n+    protected WorkflowProcessInstanceImpl createProcessInstance() {\n+        return new RuleFlowProcessInstance();\n+    }\n+\n+    public ProcessInstanceDocument marshalProcessInstance(ProcessInstance<?> processInstance) {\n+        try {\n+            WorkflowProcessInstance pi = ((AbstractProcessInstance<?>) processInstance).internalGetProcessInstance();\n+            try (ByteArrayOutputStream baos = new ByteArrayOutputStream()) {\n+                KogitoProcessMarshallerWriteContext context = new KogitoProcessMarshallerWriteContext(baos, null, null, null, null, env);\n+                context.parameterObject = JsonFormat.printer().print(super.writeProcessInstance(context, pi));\n+                ProcessInstanceDocument document = new ProcessInstanceDocumentMapper().apply(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzkxMzExNQ==", "bodyText": "This constructor is not used. Do we want to keep it?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467913115", "createdAt": "2020-08-10T13:44:02Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/model/ProcessInstanceDocument.java", "diffHunk": "@@ -0,0 +1,74 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.model;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import org.bson.Document;\n+\n+public class ProcessInstanceDocument {\n+\n+    private String id;\n+\n+    private Document processInstance;\n+\n+    private Map<String, Integer> strategies = new HashMap<>();\n+\n+    private Map<String, Integer> versions = new HashMap<>();\n+\n+    public ProcessInstanceDocument() {}\n+\n+    public ProcessInstanceDocument(String id, Document processInstance, Map<String, Integer> strategies, Map<String, Integer> versions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f8b28100fd74d216c5bee049d85d58f7b700bd8"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk1NDc3OQ==", "bodyText": "enableDefaultTyping() is deprecated since 2.10. We should use something like:\nMAPPER.activateDefaultTyping(LaissezFaireSubTypeValidator.instance);\nwhich basically does the same but via a non-deprecated method. LaissezFaireSubTypeValidator allows default typing for everything.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467954779", "createdAt": "2020-08-10T14:45:21Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/DocumentUtils.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import com.fasterxml.jackson.core.JsonProcessingException;\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.mongodb.MongoClientSettings;\n+import com.mongodb.client.MongoClient;\n+import com.mongodb.client.MongoCollection;\n+import com.mongodb.client.MongoDatabase;\n+import org.bson.codecs.configuration.CodecRegistries;\n+import org.bson.codecs.configuration.CodecRegistry;\n+import org.kie.kogito.mongodb.codec.ProcessInstanceDocumentCodecProvider;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+import org.kie.kogito.mongodb.marshalling.DocumentUnmarshallingException;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+\n+import static org.bson.codecs.configuration.CodecRegistries.fromProviders;\n+\n+public class DocumentUtils {\n+\n+    private DocumentUtils() {}\n+\n+    private static final ObjectMapper MAPPER = new ObjectMapper();\n+\n+    public static ObjectMapper getObjectMapper() {\n+\n+        return MAPPER;\n+    }\n+\n+    public static MongoCollection<ProcessInstanceDocument> getCollection(MongoClient mongoClient, String processId, String dbName) {\n+        CodecRegistry registry = CodecRegistries.fromRegistries(MongoClientSettings.getDefaultCodecRegistry(), fromProviders(new ProcessInstanceDocumentCodecProvider()));\n+        MongoDatabase mongoDatabase = mongoClient.getDatabase(dbName).withCodecRegistry(registry);\n+        return mongoDatabase.getCollection(processId, ProcessInstanceDocument.class).withCodecRegistry(registry);\n+    }\n+\n+    public static byte[] toByteArray(Object object) {\n+        String json = null;\n+        try {\n+            MAPPER.enableDefaultTyping();\n+            json = MAPPER.writeValueAsString(object);\n+        } catch (JsonProcessingException e) {\n+            throw new DocumentMarshallingException(e);\n+        }\n+        return json.getBytes();\n+    }\n+\n+    public static Object fromByteArray(String dataType, byte[] object) {\n+        try {\n+            Class<?> loadClass = Thread.currentThread().getContextClassLoader().loadClass(dataType);\n+            MAPPER.enableDefaultTyping();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk2MTMwNA==", "bodyText": "Not sure we want that as after the unfork the version of drools is completely different than in Kogito.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467961304", "createdAt": "2020-08-10T14:54:20Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/ProcessInstanceDocumentMapper.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.base.Function;\n+import org.bson.Document;\n+import org.drools.core.marshalling.impl.KogitoProcessMarshallerWriteContext;\n+import org.drools.core.util.Drools;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.PROCESS_INSTANCE_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VALUE;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VARIABLE;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_MAJOR;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_MINOR;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_REVISION;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getObjectMapper;\n+\n+public class ProcessInstanceDocumentMapper implements Function<KogitoProcessMarshallerWriteContext, ProcessInstanceDocument> {\n+\n+    @Override\n+    public ProcessInstanceDocument apply(KogitoProcessMarshallerWriteContext context) {\n+        String instance = (String) context.parameterObject;\n+        ProcessInstanceDocument doc = new ProcessInstanceDocument();\n+        try {\n+            JsonNode instanceNode = getObjectMapper().readTree(instance);\n+            doc.setId(instanceNode.get(PROCESS_INSTANCE_ID).asText());\n+            applyVariables(instanceNode, VARIABLE);\n+            doc.setProcessInstance(Optional.ofNullable(instanceNode).map(json -> Document.parse(json.toString())).orElse(null));\n+            doc.setStrategies(context.usedStrategies.entrySet().stream().collect(Collectors.toMap(e -> e.getKey().getName(), Map.Entry::getValue)));\n+            doc.getVersions().put(VERSION_MAJOR, Drools.getMajorVersion());\n+            doc.getVersions().put(VERSION_MINOR, Drools.getMinorVersion());\n+            doc.getVersions().put(VERSION_REVISION, Drools.getRevisionVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Nzk3MjM5Mw==", "bodyText": "Why do we need to marshall used strategies? To keep the order? I think it is not used anywhere...", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r467972393", "createdAt": "2020-08-10T15:09:51Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/utils/ProcessInstanceDocumentMapper.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.utils;\n+\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import com.fasterxml.jackson.databind.JsonNode;\n+import com.fasterxml.jackson.databind.node.ObjectNode;\n+import com.google.common.base.Function;\n+import org.bson.Document;\n+import org.drools.core.marshalling.impl.KogitoProcessMarshallerWriteContext;\n+import org.drools.core.util.Drools;\n+import org.kie.kogito.mongodb.marshalling.DocumentMarshallingException;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.PROCESS_INSTANCE_ID;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VALUE;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VARIABLE;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_MAJOR;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_MINOR;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.VERSION_REVISION;\n+import static org.kie.kogito.mongodb.utils.DocumentUtils.getObjectMapper;\n+\n+public class ProcessInstanceDocumentMapper implements Function<KogitoProcessMarshallerWriteContext, ProcessInstanceDocument> {\n+\n+    @Override\n+    public ProcessInstanceDocument apply(KogitoProcessMarshallerWriteContext context) {\n+        String instance = (String) context.parameterObject;\n+        ProcessInstanceDocument doc = new ProcessInstanceDocument();\n+        try {\n+            JsonNode instanceNode = getObjectMapper().readTree(instance);\n+            doc.setId(instanceNode.get(PROCESS_INSTANCE_ID).asText());\n+            applyVariables(instanceNode, VARIABLE);\n+            doc.setProcessInstance(Optional.ofNullable(instanceNode).map(json -> Document.parse(json.toString())).orElse(null));\n+            doc.setStrategies(context.usedStrategies.entrySet().stream().collect(Collectors.toMap(e -> e.getKey().getName(), Map.Entry::getValue)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAwNDk1OQ==", "bodyText": "Formatting.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r468004959", "createdAt": "2020-08-10T15:48:46Z", "author": {"login": "MarianMacik"}, "path": "kogito-codegen/src/main/java/org/kie/kogito/codegen/process/persistence/PersistenceGenerator.java", "diffHunk": "@@ -121,7 +131,9 @@ public ApplicationSection section() {\n         \t\tinifinispanBasedPersistence(generatedFiles);\n         \t} else if (persistenceType.equals(FILESYSTEM_PERSISTENCE_TYPE)) {\n         \t\tfileSystemBasedPersistence(generatedFiles);\n-        \t}\n+        \t} else if (persistenceType.equals(MONGODB_PERSISTENCE_TYPE)) {\n+                mongodbBasedPersistence(generatedFiles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAyMzM0OQ==", "bodyText": "Formatting is a bit off.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r468023349", "createdAt": "2020-08-10T16:18:15Z", "author": {"login": "MarianMacik"}, "path": "pom.xml", "diffHunk": "@@ -791,6 +796,13 @@\n         <groupId>io.rest-assured</groupId>\n         <artifactId>json-schema-validator</artifactId>\n         <version>${version.io.restassured}</version>\n+    </dependency>\n+      \n+      <!-- mongoDB related -->\n+      <dependency>\n+        <groupId>org.mongodb</groupId>\n+        <artifactId>mongodb-driver-sync</artifactId>\n+        <version>${version.org.mongo}</version>\n       </dependency>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAyODgwNg==", "bodyText": "Can we make this composition instead of inheritance? This would be more in sync with ProcessInstanceMarshaller, which obtains instance of AbstractProtobufProcessInstanceMarshaller using:\n\n  \n    \n      kogito-runtimes/jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/marshalling/ProcessInstanceMarshaller.java\n    \n    \n         Line 82\n      in\n      923d55e\n    \n    \n    \n    \n\n        \n          \n           org.jbpm.marshalling.impl.ProcessInstanceMarshaller marshaller = ProcessMarshallerRegistry.INSTANCE.getMarshaller(processType); \n        \n    \n  \n\n\nAlso right now we are mixing the org.kie.kogito.mongodb.marshalling package with the org.jbpm.marshalling.impl package which are two different things.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r468028806", "createdAt": "2020-08-10T16:27:21Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/main/java/org/kie/kogito/mongodb/marshalling/DocumentProcessInstanceMarshaller.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb.marshalling;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.ByteArrayOutputStream;\n+import java.io.IOException;\n+import java.io.ObjectOutputStream;\n+import java.util.Collections;\n+\n+import com.google.protobuf.util.JsonFormat;\n+import org.drools.core.impl.EnvironmentImpl;\n+import org.drools.core.marshalling.impl.ClassObjectMarshallingStrategyAcceptor;\n+import org.drools.core.marshalling.impl.KogitoMarshallerReaderContext;\n+import org.drools.core.marshalling.impl.KogitoProcessMarshallerWriteContext;\n+import org.drools.core.marshalling.impl.MarshallerReaderContext;\n+import org.drools.core.marshalling.impl.SerializablePlaceholderResolverStrategy;\n+import org.jbpm.marshalling.impl.AbstractProtobufProcessInstanceMarshaller;\n+import org.jbpm.marshalling.impl.JBPMMessages;\n+import org.jbpm.ruleflow.instance.RuleFlowProcessInstance;\n+import org.jbpm.workflow.instance.WorkflowProcessInstance;\n+import org.jbpm.workflow.instance.impl.WorkflowProcessInstanceImpl;\n+import org.kie.api.marshalling.ObjectMarshallingStrategy;\n+import org.kie.api.runtime.Environment;\n+import org.kie.api.runtime.EnvironmentName;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceDocumentMapper;\n+import org.kie.kogito.mongodb.utils.ProcessInstanceMessageMapper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+import org.kie.kogito.process.impl.AbstractProcessInstance;\n+\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_MARSHALLING_ERROR_MSG;\n+import static org.kie.kogito.mongodb.utils.DocumentConstants.DOCUMENT_UNMARSHALLING_ERROR_MSG;\n+\n+public class DocumentProcessInstanceMarshaller extends AbstractProtobufProcessInstanceMarshaller {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4"}, "originalPosition": 50}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27f314550a7bdcde1521bcf3acad029a298d7cd4", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/27f314550a7bdcde1521bcf3acad029a298d7cd4", "committedDate": "2020-08-10T14:41:53Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "eb29d4a26b2f42022a45988e7aaeb523eb05c670", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/eb29d4a26b2f42022a45988e7aaeb523eb05c670", "committedDate": "2020-08-11T00:12:40Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eb29d4a26b2f42022a45988e7aaeb523eb05c670", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/eb29d4a26b2f42022a45988e7aaeb523eb05c670", "committedDate": "2020-08-11T00:12:40Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "a9c2113790e5f830445985c591bc70fd177860b1", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/a9c2113790e5f830445985c591bc70fd177860b1", "committedDate": "2020-08-11T04:20:14Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mzc0MDU2", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-465374056", "createdAt": "2020-08-11T19:42:28Z", "commit": {"oid": "a9c2113790e5f830445985c591bc70fd177860b1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9c2113790e5f830445985c591bc70fd177860b1", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/a9c2113790e5f830445985c591bc70fd177860b1", "committedDate": "2020-08-11T04:20:14Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1", "committedDate": "2020-08-12T02:34:18Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NTk1NzI4", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-465595728", "createdAt": "2020-08-12T05:13:31Z", "commit": {"oid": "45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NjQxOTA3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-465641907", "createdAt": "2020-08-12T07:05:03Z", "commit": {"oid": "45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/45d6d38776f10f35600f2b7ad5d0cc32c03d7fd1", "committedDate": "2020-08-12T02:34:18Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "db1b3c96d2c0cb3e2acf9655df04b92574dc126b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/db1b3c96d2c0cb3e2acf9655df04b92574dc126b", "committedDate": "2020-08-13T05:08:03Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db1b3c96d2c0cb3e2acf9655df04b92574dc126b", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/db1b3c96d2c0cb3e2acf9655df04b92574dc126b", "committedDate": "2020-08-13T05:08:03Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "866c4670fbb07f00dce0abec560b79321e43a9ea", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/866c4670fbb07f00dce0abec560b79321e43a9ea", "committedDate": "2020-08-13T09:32:30Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjIzMjEx", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-466623211", "createdAt": "2020-08-13T10:07:42Z", "commit": {"oid": "866c4670fbb07f00dce0abec560b79321e43a9ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDowNzo0MlrOHAE9-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMDowNzo0MlrOHAE9-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg0MzQ0OQ==", "bodyText": "This is a bug reported by SonarCloud. codec.getDocumentId(doc) always returns primitive true or false, so this assertion always passes. The best would be to remove this assertion.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r469843449", "createdAt": "2020-08-13T10:07:42Z", "author": {"login": "MarianMacik"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/mongodb/ProcessInstanceDocumentCodecProviderTest.java", "diffHunk": "@@ -0,0 +1,77 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.mongodb;\n+\n+import java.io.IOException;\n+import java.net.URISyntaxException;\n+import java.nio.ByteBuffer;\n+\n+import com.mongodb.MongoClientSettings;\n+import org.bson.BsonBinaryReader;\n+import org.bson.BsonBinaryWriter;\n+import org.bson.BsonWriter;\n+import org.bson.codecs.Codec;\n+import org.bson.codecs.DecoderContext;\n+import org.bson.codecs.EncoderContext;\n+import org.bson.codecs.configuration.CodecProvider;\n+import org.bson.codecs.configuration.CodecRegistries;\n+import org.bson.codecs.configuration.CodecRegistry;\n+import org.bson.io.BasicOutputBuffer;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.mongodb.codec.ProcessInstanceDocumentCodec;\n+import org.kie.kogito.mongodb.codec.ProcessInstanceDocumentCodecProvider;\n+import org.kie.kogito.mongodb.model.ProcessInstanceDocument;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.bson.codecs.configuration.CodecRegistries.fromProviders;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+import static org.junit.jupiter.api.Assertions.assertNull;\n+\n+class ProcessInstanceDocumentCodecProviderTest {\n+\n+    @Test\n+    void providerTest() {\n+        CodecRegistry codecRegistry = CodecRegistries.fromRegistries(MongoClientSettings.getDefaultCodecRegistry(), fromProviders(new ProcessInstanceDocumentCodecProvider()));\n+        CodecProvider provider = codecRegistry;\n+        Codec<ProcessInstanceDocument> codec = provider.get(ProcessInstanceDocument.class, codecRegistry);\n+        assertNotNull(codec, \"Codec cannot be null\");\n+        assertThat(codec.getEncoderClass().getSimpleName()).isEqualTo(ProcessInstanceDocument.class.getSimpleName());\n+        assertThat(codec.getClass().getCanonicalName()).isEqualTo(ProcessInstanceDocumentCodec.class.getCanonicalName());\n+    }\n+\n+    @Test\n+    void codecTest() throws URISyntaxException, IOException {\n+        ProcessInstanceDocumentCodec codec = new ProcessInstanceDocumentCodec();\n+        assertThat(codec.getEncoderClass()).isEqualTo(ProcessInstanceDocument.class);\n+        ProcessInstanceDocument doc = new ProcessInstanceDocument();\n+        doc.setProcessInstance((org.bson.Document) TestHelper.getProcessInstanceDocument().get(\"processInstance\"));\n+        assertNull(doc.getId(), \"ProcessInstanceDocument is null\");\n+        codec.generateIdIfAbsentFromDocument(doc);\n+        assertThat(codec.documentHasId(doc)).isTrue();\n+        assertNotNull(codec.getDocumentId(doc), \"ProcessInstanceDocument has document id and not null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "866c4670fbb07f00dce0abec560b79321e43a9ea"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "866c4670fbb07f00dce0abec560b79321e43a9ea", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/866c4670fbb07f00dce0abec560b79321e43a9ea", "committedDate": "2020-08-13T09:32:30Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "2b1ed6c338e44bf397be5ade53c02f1a77fb60c9", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/2b1ed6c338e44bf397be5ade53c02f1a77fb60c9", "committedDate": "2020-08-13T19:19:45Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b1ed6c338e44bf397be5ade53c02f1a77fb60c9", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/2b1ed6c338e44bf397be5ade53c02f1a77fb60c9", "committedDate": "2020-08-13T19:19:45Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "e698fbbdcb4fb55339d77328cfdf56033066adc0", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/e698fbbdcb4fb55339d77328cfdf56033066adc0", "committedDate": "2020-08-18T03:52:55Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MjMyNjcx", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-469232671", "createdAt": "2020-08-18T11:12:42Z", "commit": {"oid": "e698fbbdcb4fb55339d77328cfdf56033066adc0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e698fbbdcb4fb55339d77328cfdf56033066adc0", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/e698fbbdcb4fb55339d77328cfdf56033066adc0", "committedDate": "2020-08-18T03:52:55Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "9806892cfcb7ad50561beb69f64adcc8dfd88d98", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/9806892cfcb7ad50561beb69f64adcc8dfd88d98", "committedDate": "2020-08-19T04:28:27Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9806892cfcb7ad50561beb69f64adcc8dfd88d98", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/9806892cfcb7ad50561beb69f64adcc8dfd88d98", "committedDate": "2020-08-19T04:28:27Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "788bf3eb4f402a199b98246cd23b0edf51c37673", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/788bf3eb4f402a199b98246cd23b0edf51c37673", "committedDate": "2020-08-19T12:58:17Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "788bf3eb4f402a199b98246cd23b0edf51c37673", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/788bf3eb4f402a199b98246cd23b0edf51c37673", "committedDate": "2020-08-19T12:58:17Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/12f3b671c1ff4606e673123c841cebb567fbba2e", "committedDate": "2020-08-19T18:24:35Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDg1Njcx", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-471085671", "createdAt": "2020-08-20T02:29:24Z", "commit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjoyOToyNFrOHDnL_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjoyOToyNFrOHDnL_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU0OTgyMg==", "bodyText": "perhaps use mock(Process.class) ?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r473549822", "createdAt": "2020-08-20T02:29:24Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/java/org/kie/kogito/persistence/KogitoProcessInstancesFactoryTest.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.persistence;\n+\n+import org.jbpm.workflow.core.impl.WorkflowProcessImpl;\n+import org.junit.jupiter.api.Test;\n+import org.kie.api.runtime.process.WorkflowProcessInstance;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.mongodb.MongoDBProcessInstances;\n+import org.kie.kogito.mongodb.TestHelper;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.impl.AbstractProcess;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertNotNull;\n+\n+class KogitoProcessInstancesFactoryTest extends TestHelper {\n+\n+    @Test\n+    void test() {\n+        KogitoProcessInstancesFactory factory = new KogitoProcessInstancesFactory(getMongoClient()) {\n+\n+            @Override\n+            public String dbName() {\n+                return DB_NAME;\n+            }\n+        };\n+        assertNotNull(factory);\n+        assertThat(factory.dbName()).isEqualTo(DB_NAME);\n+        assertNotNull(factory.mongoClient);\n+        Process<?> process = new TestProcessImpl();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMDg4MzQ0", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#pullrequestreview-471088344", "createdAt": "2020-08-20T02:38:38Z", "commit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjozODozOFrOHDnaUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwMjozODozOFrOHDnaUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzU1MzQ4OQ==", "bodyText": "perhaps variables ?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/477#discussion_r473553489", "createdAt": "2020-08-20T02:38:38Z", "author": {"login": "cristianonicolai"}, "path": "addons/persistence/mongodb-persistence-addon/src/test/resources/process_instance_document.json", "diffHunk": "@@ -0,0 +1,136 @@\n+{\n+   \"_id\":\"1edfa86a-ad23-4837-bb96-3c478dc40b2a\",\n+   \"processInstance\":{\n+      \"processType\":\"RuleFlow\",\n+      \"id\":\"1edfa86a-ad23-4837-bb96-3c478dc40b2a\",\n+      \"processId\":\"dealreviews\",\n+      \"state\":1,\n+      \"nodeInstance\":[\n+         {\n+            \"id\":\"a2c62652-b80a-4c16-9dea-a2d89271f3fc\",\n+            \"nodeId\":\"2\",\n+            \"content\":{\n+               \"type\":\"HUMAN_TASK_NODE\",\n+               \"humanTask\":{\n+                  \"workItemId\":\"f2647a48-6cae-475c-a38b-e6a2a204d3fa\",\n+                  \"workitem\":{\n+                     \"id\":\"f2647a48-6cae-475c-a38b-e6a2a204d3fa\",\n+                     \"processInstancesId\":\"1edfa86a-ad23-4837-bb96-3c478dc40b2a\",\n+                     \"name\":\"Human Task\",\n+                     \"state\":0,\n+                     \"variable\":[\n+                        {\n+                           \"name\":\"Skippable\",\n+                           \"strategyIndex\":0,\n+                           \"value\":\"true\",\n+                           \"dataType\":\"java.lang.String\"\n+                        },\n+                        {\n+                           \"name\":\"deal\",\n+                           \"strategyIndex\":0,\n+                           \"value\":\"my fancy deal\",\n+                           \"dataType\":\"java.lang.String\"\n+                        },\n+                        {\n+                           \"name\":\"ActorId\",\n+                           \"strategyIndex\":0,\n+                           \"value\":\"john\",\n+                           \"dataType\":\"java.lang.String\"\n+                        },\n+                        {\n+                           \"name\":\"TaskName\",\n+                           \"strategyIndex\":0,\n+                           \"value\":\"review\",\n+                           \"dataType\":\"java.lang.String\"\n+                        },\n+                        {\n+                           \"name\":\"NodeName\",\n+                           \"strategyIndex\":0,\n+                           \"value\":\"Review the deal\",\n+                           \"dataType\":\"java.lang.String\"\n+                        },\n+                        {\n+                           \"name\":\"traveller\",\n+                           \"strategyIndex\":0,\n+                           \"value\":{\n+                              \"firstName\":\"John\",\n+                              \"lastName\":\"Doe\",\n+                              \"email\":\"jon.doe@example.com\",\n+                              \"nationality\":\"American\",\n+                              \"address\":{\n+                                 \"street\":\"main street\",\n+                                 \"city\":\"Boston\",\n+                                 \"zipCode\":\"10005\",\n+                                 \"country\":\"US\"\n+                              }\n+                           },\n+                           \"dataType\":\"org.acme.deals.Traveller\"\n+                        }\n+                     ],\n+                     \"nodeInstanceId\":\"a2c62652-b80a-4c16-9dea-a2d89271f3fc\",\n+                     \"nodeId\":\"2\",\n+                     \"phaseId\":\"active\",\n+                     \"phaseStatus\":\"Ready\",\n+                     \"startDate\":\"1597104562089\",\n+                     \"taskName\":\"review\",\n+                     \"potUsers\":[\n+                        \"john\"\n+                     ],\n+                     \"taskReferenceName\":\"Review the deal\"\n+                  }\n+               }\n+            },\n+            \"level\":1,\n+            \"slaCompliance\":0,\n+            \"triggerDate\":\"1597104562089\"\n+         }\n+      ],\n+      \"variable\":[", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e"}, "originalPosition": 88}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12f3b671c1ff4606e673123c841cebb567fbba2e", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/12f3b671c1ff4606e673123c841cebb567fbba2e", "committedDate": "2020-08-19T18:24:35Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "c3eae9a109b140248edd85014fa912b5cf8e6e3d", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c3eae9a109b140248edd85014fa912b5cf8e6e3d", "committedDate": "2020-08-20T04:22:04Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3eae9a109b140248edd85014fa912b5cf8e6e3d", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/c3eae9a109b140248edd85014fa912b5cf8e6e3d", "committedDate": "2020-08-20T04:22:04Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "4c703c19a869daea96bcfdb86aa1d48f66189503", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/4c703c19a869daea96bcfdb86aa1d48f66189503", "committedDate": "2020-08-21T02:25:58Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24038f392579cf3708bb177449805ff53c08b0f3", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/24038f392579cf3708bb177449805ff53c08b0f3", "committedDate": "2020-08-21T05:06:35Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c703c19a869daea96bcfdb86aa1d48f66189503", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/4c703c19a869daea96bcfdb86aa1d48f66189503", "committedDate": "2020-08-21T02:25:58Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}, "afterCommit": {"oid": "24038f392579cf3708bb177449805ff53c08b0f3", "author": {"user": {"login": "swati-kale", "name": "Swati Kale"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/24038f392579cf3708bb177449805ff53c08b0f3", "committedDate": "2020-08-21T05:06:35Z", "message": "[KOGITO-1551] - Process Instance persistence in Mongo DB\n\nSigned-off-by: Swati Kale <swkale@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3435, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}