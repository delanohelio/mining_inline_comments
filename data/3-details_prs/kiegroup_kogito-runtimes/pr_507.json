{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MDc0MDQ0", "number": 507, "title": "[KOGITO-1968] Implement missing features for DynamicNodes", "bodyText": "ActionNodes will only declare the variables that are mentioned in the script\nCompositeContextNodeVisitor will take the parent context when it is empty or null. Before it was done only when null\nAdded stages method that returns a collection of the existing stages in the process along with the adhoc fragments\nAdded condition to Milestone\nMissing setAutocomplete to visitor\nSmall refactoring for WorkItemHandlerNotFoundException and some redundant casts have been also removed\nGenerate only used variables in actionNodes\nPropagate scope when empty in CompositeContextNodes", "createdAt": "2020-05-14T15:31:02Z", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507", "merged": true, "mergeCommit": {"oid": "7644a85686e270494da2252edfbf91d381da61fe"}, "closed": true, "closedAt": "2020-06-02T14:25:06Z", "author": {"login": "ruromero"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchPVqMgBqjMzMzcyMDk3MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnOUYuABqjMzOTU5NjY5MDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "711294261eeec6391e52387a12346b46ee686454", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/711294261eeec6391e52387a12346b46ee686454", "committedDate": "2020-05-14T15:26:28Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "bcc30be0532d76b2e03e615e4dcea4ed25756b3f", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/bcc30be0532d76b2e03e615e4dcea4ed25756b3f", "committedDate": "2020-05-14T15:37:32Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bcc30be0532d76b2e03e615e4dcea4ed25756b3f", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/bcc30be0532d76b2e03e615e4dcea4ed25756b3f", "committedDate": "2020-05-14T15:37:32Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "60cb156ffa60ca812066d898e57609a628e073da", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/60cb156ffa60ca812066d898e57609a628e073da", "committedDate": "2020-05-18T07:10:13Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60cb156ffa60ca812066d898e57609a628e073da", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/60cb156ffa60ca812066d898e57609a628e073da", "committedDate": "2020-05-18T07:10:13Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "562cfec1b565f075e3514620cf010e8bcb8dd92a", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/562cfec1b565f075e3514620cf010e8bcb8dd92a", "committedDate": "2020-05-18T09:02:28Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "562cfec1b565f075e3514620cf010e8bcb8dd92a", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/562cfec1b565f075e3514620cf010e8bcb8dd92a", "committedDate": "2020-05-18T09:02:28Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "b0aa13d65186a71bb2cbff3457f9d522ec74a69b", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b0aa13d65186a71bb2cbff3457f9d522ec74a69b", "committedDate": "2020-05-19T15:29:06Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b0aa13d65186a71bb2cbff3457f9d522ec74a69b", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/b0aa13d65186a71bb2cbff3457f9d522ec74a69b", "committedDate": "2020-05-19T15:29:06Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "213d4f4af1daa69829e9fd95278a5307f76dd841", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/213d4f4af1daa69829e9fd95278a5307f76dd841", "committedDate": "2020-05-19T15:31:53Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "213d4f4af1daa69829e9fd95278a5307f76dd841", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/213d4f4af1daa69829e9fd95278a5307f76dd841", "committedDate": "2020-05-19T15:31:53Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "34a6de6467423279cf8144816642ccb7fceb26fb", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/34a6de6467423279cf8144816642ccb7fceb26fb", "committedDate": "2020-05-19T15:34:43Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34a6de6467423279cf8144816642ccb7fceb26fb", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/34a6de6467423279cf8144816642ccb7fceb26fb", "committedDate": "2020-05-19T15:34:43Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "7346de77f1678c8caba364570a59afacec28e492", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7346de77f1678c8caba364570a59afacec28e492", "committedDate": "2020-05-19T16:18:39Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7346de77f1678c8caba364570a59afacec28e492", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/7346de77f1678c8caba364570a59afacec28e492", "committedDate": "2020-05-19T16:18:39Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "311b3f8292b0935f5d64b4a102040addd5c01a86", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/311b3f8292b0935f5d64b4a102040addd5c01a86", "committedDate": "2020-05-20T06:58:50Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "311b3f8292b0935f5d64b4a102040addd5c01a86", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/311b3f8292b0935f5d64b4a102040addd5c01a86", "committedDate": "2020-05-20T06:58:50Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "9a113bb1c7fa71c7a4c9ada1c9c5a018090a81b5", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/9a113bb1c7fa71c7a4c9ada1c9c5a018090a81b5", "committedDate": "2020-05-20T12:32:28Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a113bb1c7fa71c7a4c9ada1c9c5a018090a81b5", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/9a113bb1c7fa71c7a4c9ada1c9c5a018090a81b5", "committedDate": "2020-05-20T12:32:28Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "24a9af98cf054a2174bdedb66f4ddbc5e88e01f0", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/24a9af98cf054a2174bdedb66f4ddbc5e88e01f0", "committedDate": "2020-05-22T14:26:57Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24a9af98cf054a2174bdedb66f4ddbc5e88e01f0", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/24a9af98cf054a2174bdedb66f4ddbc5e88e01f0", "committedDate": "2020-05-22T14:26:57Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "aaa97faaadece5593af637ad4defc1385eb02708", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/aaa97faaadece5593af637ad4defc1385eb02708", "committedDate": "2020-05-25T17:16:49Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aaa97faaadece5593af637ad4defc1385eb02708", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/aaa97faaadece5593af637ad4defc1385eb02708", "committedDate": "2020-05-25T17:16:49Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "511715d448c97a2b1fb987965f4521b1238d93cc", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/511715d448c97a2b1fb987965f4521b1238d93cc", "committedDate": "2020-05-25T18:45:54Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3ODU3MTI2", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-417857126", "createdAt": "2020-05-25T19:44:59Z", "commit": {"oid": "511715d448c97a2b1fb987965f4521b1238d93cc"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQxOTo0NDo1OVrOGaIp3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMzoyMzoxNlrOGaeBTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1Nzk1MA==", "bodyText": "I'm wondering whether the .toString() it the best option to check, can't any attribute be checked instead?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r430057950", "createdAt": "2020-05-25T19:44:59Z", "author": {"login": "tiagodolphine"}, "path": "jbpm/jbpm-flow-builder/src/main/java/org/jbpm/compiler/canonical/ActionNodeVisitor.java", "diffHunk": "@@ -48,22 +51,31 @@ public void visitNode(String factoryField, ActionNode node, BlockStmt body, Vari\n             body.addStatement(getFactoryMethod(getNodeId(node), METHOD_ACTION, lambda));\n         } else {\n             if (node.getAction().toString() == null || node.getAction().toString().trim().isEmpty()) {\n-                throw new IllegalStateException(\"Action node \" + node.getId() + \" name \" + node.getName() + \" has not action defined\");\n+                throw new IllegalStateException(\"Action node \" + node.getId() + \" name \" + node.getName() + \" has no action defined\");\n             }\n             BlockStmt actionBody = new BlockStmt();\n+            List<Variable> variables = variableScope.getVariables();\n+            variables.stream()\n+                    .filter(v -> isVarPresent(v, node.getAction()))\n+                    .map(ActionNodeVisitor::makeAssignment)\n+                    .forEach(actionBody::addStatement);\n+\n+            actionBody.addStatement(new NameExpr(node.getAction().toString()));\n+\n             LambdaExpr lambda = new LambdaExpr(\n                     new Parameter(new UnknownType(), KCONTEXT_VAR), // (kcontext) ->\n                     actionBody\n             );\n-\n-            for (Variable v : variableScope.getVariables()) {\n-                actionBody.addStatement(makeAssignment(v));\n-            }\n-            actionBody.addStatement(new NameExpr(node.getAction().toString()));\n-\n             body.addStatement(getFactoryMethod(getNodeId(node), METHOD_ACTION, lambda));\n         }\n         visitMetaData(node.getMetaData(), body, getNodeId(node));\n         body.addStatement(getDoneMethod(getNodeId(node)));\n     }\n+\n+    private boolean isVarPresent(Variable v, DroolsAction action) {\n+        if(action == null) {\n+            return false;\n+        }\n+        return action.toString().contains(v.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511715d448c97a2b1fb987965f4521b1238d93cc"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDA1OTk1Ng==", "bodyText": "the getProcessInstance().getKnowledgeRuntime().getAgenda() != null condition is used in more places, it could be extracted to a method.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r430059956", "createdAt": "2020-05-25T19:54:00Z", "author": {"login": "tiagodolphine"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/workflow/instance/node/DynamicNodeInstance.java", "diffHunk": "@@ -63,43 +64,43 @@ public String getNodeName() {\n     @Override\n     public void internalTrigger(NodeInstance from, String type) {\n         triggerTime = new Date();\n-        triggerEvent(ExtendedNodeImpl.EVENT_NODE_ENTER);\n+        triggerEvent(EVENT_NODE_ENTER);\n \n     \t// if node instance was cancelled, abort\n \t\tif (getNodeInstanceContainer().getNodeInstance(getId()) == null) {\n \t\t\treturn;\n \t\t}\n-    \tInternalAgenda agenda =  (InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda();\n-    \tString ruleFlowGroup = getRuleFlowGroupName();\n-    \tif (ruleFlowGroup != null && !agenda.getRuleFlowGroup(ruleFlowGroup).isActive()) {\n-        \tagenda.getRuleFlowGroup(ruleFlowGroup).setAutoDeactivate(false);\n-        \tagenda.activateRuleFlowGroup(ruleFlowGroup, getProcessInstance().getId(), getUniqueId());\n-    \t}\n-//    \tif (getDynamicNode().isAutoComplete() && getNodeInstances(false).isEmpty()) {\n-//    \t\ttriggerCompleted(NodeImpl.CONNECTION_DEFAULT_TYPE);\n-//    \t}\n-\n-        \n-        String rule = \"RuleFlow-AdHocComplete-\" + getProcessInstance().getProcessId() + \"-\" + getDynamicNode().getUniqueId();\n-        boolean isActive = ((InternalAgenda) getProcessInstance().getKnowledgeRuntime().getAgenda())\n-            .isRuleActiveInRuleFlowGroup(getRuleFlowGroupName(), rule, getProcessInstance().getId());\n+        boolean isActive = false;\n+        // KOGITO-2168 Conditions not supported\n+        if(getProcessInstance().getKnowledgeRuntime().getAgenda() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511715d448c97a2b1fb987965f4521b1238d93cc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQwODAxMw==", "bodyText": "What about moving the StageBuilder from test to src and use here as well?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r430408013", "createdAt": "2020-05-26T13:23:16Z", "author": {"login": "tiagodolphine"}, "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -381,13 +387,33 @@ public void transitionWorkItem(String id, Transition<?> transition) {\n     @Override\n     public Collection<Milestone> milestones() {\n         return getNodes(MilestoneNode.class)\n+                .map(MilestoneNode.class::cast)\n                 .map(n -> {\n                     String uid = (String) n.getMetaData().get(UNIQUE_ID);\n-                    return new Milestone(uid, n.getName(), getStatus(uid));\n+                    return new Milestone(uid, n.getName(), getStatus(uid), n.getConstraint());\n                 })\n                 .collect(Collectors.toList());\n     }\n \n+    @Override\n+    public Collection<Stage> stages() {\n+        return getNodes(DynamicNode.class)\n+                .map(DynamicNode.class::cast)\n+                .map(n -> {\n+                    String uid = (String) n.getMetaData().get(UNIQUE_ID);\n+                    return new Stage(uid, n.getName(), getStatus(uid), n.getActivationExpression(), n.getCompletionExpression(), n.isAutoComplete(), collectAdHocFragments(n));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "511715d448c97a2b1fb987965f4521b1238d93cc"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjcwMjI4", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-419270228", "createdAt": "2020-05-27T14:28:10Z", "commit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDoyODoxMFrOGbM4WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNToxNDo0MlrOGbPl0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE3NTc2OA==", "bodyText": "@ruromero Im not sure whats the actual need for this change", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431175768", "createdAt": "2020-05-27T14:28:10Z", "author": {"login": "cristianonicolai"}, "path": "drools/drools-core/src/main/java/org/drools/core/process/instance/impl/DefaultWorkItemManager.java", "diffHunk": "@@ -73,8 +76,7 @@ public void internalExecuteWorkItem(WorkItem workItem) {\n         WorkItemHandler handler = this.workItemHandlers.get(workItem.getName());\n         if (handler != null) {\n             handler.executeWorkItem(workItem, this);\n-        } else throw new WorkItemHandlerNotFoundException( \"Could not find work item handler for \" + workItem.getName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE3ODQwNw==", "bodyText": "I think it actualy makes more sense to keep the Impl class as Serializable. not the interface.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431178407", "createdAt": "2020-05-27T14:30:21Z", "author": {"login": "cristianonicolai"}, "path": "drools/drools-core/src/main/java/org/drools/core/process/instance/impl/WorkItemImpl.java", "diffHunk": "@@ -26,15 +25,15 @@\n import org.kie.api.runtime.process.NodeInstance;\n import org.kie.api.runtime.process.ProcessInstance;\n \n-public class WorkItemImpl implements WorkItem, Serializable {\n+public class WorkItemImpl implements WorkItem {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4MzU3Ng==", "bodyText": "Formatting is really strange is this class, if you can review that in the PR I think would be a nice improvement.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431183576", "createdAt": "2020-05-27T14:33:57Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/VariableScope.java", "diffHunk": "@@ -20,13 +20,10 @@\n import java.util.Collections;\n import java.util.List;\n \n-import org.jbpm.process.core.datatype.impl.type.ObjectDataType;\n import org.jbpm.process.core.Context;\n import org.jbpm.process.core.context.AbstractContext;\n+import org.jbpm.process.core.datatype.impl.type.ObjectDataType;\n \n-/**\n- * \n- */\n public class VariableScope extends AbstractContext {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4NzcyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final String[] result = new String[this.variables.size()];\n          \n          \n            \n                    return variables.stream().map(v -> v.getName()).toArray(String[]::new);", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431187723", "createdAt": "2020-05-27T14:37:46Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/VariableScope.java", "diffHunk": "@@ -60,10 +57,8 @@ public void setVariables(final List<Variable> variables) {\n \n     public String[] getVariableNames() {\n         final String[] result = new String[this.variables.size()];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4ODkyMQ==", "bodyText": "isnt the opposite logic? if does not contains a . ?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431188921", "createdAt": "2020-05-27T14:39:11Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/VariableScope.java", "diffHunk": "@@ -74,7 +69,7 @@ public Variable findVariable(String variableName) {\n                 return variable;\n             }\n         }\n-        if (variableName.startsWith(CASE_FILE_PREFIX) && variableName.indexOf(\".\") == -1) {\n+        if (variableName.startsWith(CASE_FILE_PREFIX) && variableName.contains(\".\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE4OTQ0Mg==", "bodyText": "again, not sure an interface is a right place for Serializable", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431189442", "createdAt": "2020-05-27T14:39:52Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/instance/ContextInstance.java", "diffHunk": "@@ -16,21 +16,20 @@\n \n package org.jbpm.process.instance;\n \n+import java.io.Serializable;\n+\n import org.jbpm.process.core.Context;\n \n-/**\n- * \n- */\n-public interface ContextInstance {\n-    \n+public interface ContextInstance extends Serializable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE5MjQzMg==", "bodyText": "any specific need to change these inner classes into static?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431192432", "createdAt": "2020-05-27T14:43:54Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/instance/LightWorkItemManager.java", "diffHunk": "@@ -253,7 +251,7 @@ public void retryWorkItem( String workItemID, Map<String, Object> params ) {\n         \n     }\n     \n-    private class TransitionToActive implements Transition<Void> {\n+    private static class TransitionToActive implements Transition<Void> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxMjMwNw==", "bodyText": "if you change the getNodes method to return a types version, then this map is unnecessay:\nprivate <T extends Node> Stream<T> getNodes(Class<T> nodeClass) {\n        if (!(legacyProcessInstance instanceof RuleFlowProcessInstance)) {\n            return Stream.empty();\n        }\n        RuleFlowProcessInstance processInstance = ((RuleFlowProcessInstance) legacyProcessInstance);\n        return Arrays.stream(processInstance.getNodeContainer().getNodes()).filter(nodeClass::isInstance).map(n -> (T)n);\n    }", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431212307", "createdAt": "2020-05-27T15:04:13Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -381,13 +385,37 @@ public void transitionWorkItem(String id, Transition<?> transition) {\n     @Override\n     public Collection<Milestone> milestones() {\n         return getNodes(MilestoneNode.class)\n+                .map(MilestoneNode.class::cast)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxNDA2Mg==", "bodyText": "how about adhoc nodes that are not inside of stages, should we also expose it here?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431214062", "createdAt": "2020-05-27T15:06:34Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/kie/kogito/process/impl/AbstractProcessInstance.java", "diffHunk": "@@ -381,13 +385,37 @@ public void transitionWorkItem(String id, Transition<?> transition) {\n     @Override\n     public Collection<Milestone> milestones() {\n         return getNodes(MilestoneNode.class)\n+                .map(MilestoneNode.class::cast)\n                 .map(n -> {\n                     String uid = (String) n.getMetaData().get(UNIQUE_ID);\n-                    return new Milestone(uid, n.getName(), getStatus(uid));\n+                    return new Milestone(uid, n.getName(), getStatus(uid), n.getConstraint());\n                 })\n                 .collect(Collectors.toList());\n     }\n \n+    @Override\n+    public Collection<Stage> stages() {\n+        return getNodes(DynamicNode.class)\n+                .map(DynamicNode.class::cast)\n+                .map(n -> {\n+                    String uid = (String) n.getMetaData().get(UNIQUE_ID);\n+                    Stage.Builder builder = new Stage.Builder(uid)\n+                            .withName(n.getName())\n+                            .withStatus(getStatus(uid))\n+                            .withActivationExpression(n.getActivationExpression())\n+                    .withCompletionExpression(n.getCompletionExpression()).withAutoComplete(n.isAutoComplete());\n+                    getAdHocNodes(n).forEach(builder::withFragment);\n+                    return builder.build();\n+                })\n+                .collect(Collectors.toList());\n+    }\n+\n+    private Stream<Node> getAdHocNodes(DynamicNode node) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxNDc0Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    ProcessInstance<?> processInstance = p.createInstance(m);\n          \n          \n            \n                    ProcessInstance<?> processInstance = p.createInstance(p.createModel());", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431214746", "createdAt": "2020-05-27T15:07:28Z", "author": {"login": "cristianonicolai"}, "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/StageTest.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.jbpm.workflow.core.node.ActionNode;\n+import org.jbpm.workflow.core.node.HumanTaskNode;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.casemgmt.AdHocFragment;\n+import org.kie.kogito.process.casemgmt.Stage;\n+import org.kie.kogito.process.workitem.Policy;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.AVAILABLE;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.COMPLETED;\n+import static org.kie.kogito.process.impl.ProcessTestUtils.assertState;\n+\n+class StageTest extends AbstractCodegenTest {\n+\n+    private Policy<?> securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"role\"));\n+\n+    @Test\n+    void testSimpleAdHoc() throws Exception {\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleAdHoc.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleAdHoc\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+\n+        ProcessInstance<?> processInstance = p.createInstance(m);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIxODYyNA==", "bodyText": "can we avoid hard coding the node id, I guess that will need update as soon as the file is changed in the editor, it is probably not relevant for the test anyway.", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431218624", "createdAt": "2020-05-27T15:12:47Z", "author": {"login": "cristianonicolai"}, "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/StageTest.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.jbpm.workflow.core.node.ActionNode;\n+import org.jbpm.workflow.core.node.HumanTaskNode;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.casemgmt.AdHocFragment;\n+import org.kie.kogito.process.casemgmt.Stage;\n+import org.kie.kogito.process.workitem.Policy;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.AVAILABLE;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.COMPLETED;\n+import static org.kie.kogito.process.impl.ProcessTestUtils.assertState;\n+\n+class StageTest extends AbstractCodegenTest {\n+\n+    private Policy<?> securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"role\"));\n+\n+    @Test\n+    void testSimpleAdHoc() throws Exception {\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleAdHoc.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleAdHoc\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+\n+        HumanTaskNode task = new HumanTaskNode();\n+        task.setName(\"Update driver name\");\n+        Stage expected = new Stage.Builder(\"_866F4F98-8810-42FE-8398-6E7E272523D9\")\n+                .withName(\"Sub-process\")\n+                .withStatus(AVAILABLE)\n+                .withAutoComplete(true)\n+                .withFragment(new HumanTaskNode(), \"Update driver name\")\n+                .build();\n+        Collection<Stage> stages = processInstance.stages();\n+        assertThat(stages.size()).isEqualTo(1);\n+        assertContainsStage(expected, stages);\n+\n+        processInstance.start();\n+        assertState(processInstance, ProcessInstance.STATE_ACTIVE);\n+        assertThat(processInstance.workItems().size()).isEqualTo(1);\n+        WorkItem workItem = processInstance.workItems(securityPolicy).get(0);\n+\n+        Map<String, Object> variables = new HashMap<>();\n+        variables.put(\"updatedName\", \"Paul\");\n+        processInstance.completeWorkItem(workItem.getId(), variables, securityPolicy);\n+\n+        assertThat(((Model) processInstance.variables()).toMap().get(\"driver\")).isEqualTo(\"Paul\");\n+        assertThat(processInstance.workItems().size()).isEqualTo(0);\n+        assertState(processInstance, ProcessInstance.STATE_COMPLETED);\n+        expected = new Stage.Builder(expected).withStatus(COMPLETED).build();\n+        assertContainsStage(expected, processInstance.stages());\n+    }\n+\n+    @Test\n+    void testMultipleAdHoc() throws Exception {\n+        Application app = generateCodeProcessesOnly(\"cases/MultipleAdHoc.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.MultipleAdHoc\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"caseFile_currentStage\", 0);\n+        m.fromMap(parameters);\n+\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        Collection<Stage> stages = processInstance.stages();\n+        assertThat(stages.size()).isEqualTo(3);\n+        ActionNode task = new ActionNode();\n+        task.setName(\"Task1\");\n+        Collection<Stage> expected = buildExpectedMultipleAdHoc();\n+        expected.forEach(eStage -> assertContainsStage(eStage, processInstance.stages()));\n+        processInstance.start();\n+\n+        assertThat(((Model) processInstance.variables()).toMap().get(\"caseFile_currentStage\")).isEqualTo(3);\n+        assertThat(processInstance.workItems().size()).isEqualTo(0);\n+        assertState(processInstance, ProcessInstance.STATE_COMPLETED);\n+        expected = expected.stream().map(s -> new Stage.Builder(s).withStatus(COMPLETED).build()).collect(Collectors.toList());\n+        expected.forEach(eStage -> assertContainsStage(eStage, processInstance.stages()));\n+    }\n+\n+    private Collection<Stage> buildExpectedMultipleAdHoc() {\n+        Collection<Stage> expected = new ArrayList<>();\n+        expected.add(new Stage.Builder(\"_4A154E74-F085-4ECA-93F1-DE452E624FB1\").withName(\"Stage 1\").withStatus(AVAILABLE).withAutoComplete(true).withFragment(new ActionNode(), \"Task1\").build());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTIyMDE3Nw==", "bodyText": "based on what we discussed, shouldnt this handling of case file be avoided, so we can look into that shared scope approach?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431220177", "createdAt": "2020-05-27T15:14:42Z", "author": {"login": "cristianonicolai"}, "path": "kogito-codegen/src/test/java/org/kie/kogito/process/impl/StageTest.java", "diffHunk": "@@ -0,0 +1,269 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ *\n+ *      http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.impl;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import org.jbpm.workflow.core.node.ActionNode;\n+import org.jbpm.workflow.core.node.HumanTaskNode;\n+import org.junit.jupiter.api.Test;\n+import org.kie.kogito.Application;\n+import org.kie.kogito.Model;\n+import org.kie.kogito.auth.SecurityPolicy;\n+import org.kie.kogito.codegen.AbstractCodegenTest;\n+import org.kie.kogito.process.Process;\n+import org.kie.kogito.process.ProcessInstance;\n+import org.kie.kogito.process.WorkItem;\n+import org.kie.kogito.process.casemgmt.AdHocFragment;\n+import org.kie.kogito.process.casemgmt.Stage;\n+import org.kie.kogito.process.workitem.Policy;\n+import org.kie.kogito.services.identity.StaticIdentityProvider;\n+\n+import static org.assertj.core.api.Assertions.assertThat;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+import static org.junit.jupiter.api.Assertions.fail;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.AVAILABLE;\n+import static org.kie.kogito.process.casemgmt.ItemDescription.Status.COMPLETED;\n+import static org.kie.kogito.process.impl.ProcessTestUtils.assertState;\n+\n+class StageTest extends AbstractCodegenTest {\n+\n+    private Policy<?> securityPolicy = SecurityPolicy.of(new StaticIdentityProvider(\"role\"));\n+\n+    @Test\n+    void testSimpleAdHoc() throws Exception {\n+        Application app = generateCodeProcessesOnly(\"cases/SimpleAdHoc.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.SimpleAdHoc\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        m.fromMap(parameters);\n+\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+\n+        HumanTaskNode task = new HumanTaskNode();\n+        task.setName(\"Update driver name\");\n+        Stage expected = new Stage.Builder(\"_866F4F98-8810-42FE-8398-6E7E272523D9\")\n+                .withName(\"Sub-process\")\n+                .withStatus(AVAILABLE)\n+                .withAutoComplete(true)\n+                .withFragment(new HumanTaskNode(), \"Update driver name\")\n+                .build();\n+        Collection<Stage> stages = processInstance.stages();\n+        assertThat(stages.size()).isEqualTo(1);\n+        assertContainsStage(expected, stages);\n+\n+        processInstance.start();\n+        assertState(processInstance, ProcessInstance.STATE_ACTIVE);\n+        assertThat(processInstance.workItems().size()).isEqualTo(1);\n+        WorkItem workItem = processInstance.workItems(securityPolicy).get(0);\n+\n+        Map<String, Object> variables = new HashMap<>();\n+        variables.put(\"updatedName\", \"Paul\");\n+        processInstance.completeWorkItem(workItem.getId(), variables, securityPolicy);\n+\n+        assertThat(((Model) processInstance.variables()).toMap().get(\"driver\")).isEqualTo(\"Paul\");\n+        assertThat(processInstance.workItems().size()).isEqualTo(0);\n+        assertState(processInstance, ProcessInstance.STATE_COMPLETED);\n+        expected = new Stage.Builder(expected).withStatus(COMPLETED).build();\n+        assertContainsStage(expected, processInstance.stages());\n+    }\n+\n+    @Test\n+    void testMultipleAdHoc() throws Exception {\n+        Application app = generateCodeProcessesOnly(\"cases/MultipleAdHoc.bpmn\");\n+        assertThat(app).isNotNull();\n+\n+        Process<? extends Model> p = app.processes().processById(\"TestCase.MultipleAdHoc\");\n+\n+        Model m = p.createModel();\n+        Map<String, Object> parameters = new HashMap<>();\n+        parameters.put(\"caseFile_currentStage\", 0);\n+        m.fromMap(parameters);\n+\n+        ProcessInstance<?> processInstance = p.createInstance(m);\n+        Collection<Stage> stages = processInstance.stages();\n+        assertThat(stages.size()).isEqualTo(3);\n+        ActionNode task = new ActionNode();\n+        task.setName(\"Task1\");\n+        Collection<Stage> expected = buildExpectedMultipleAdHoc();\n+        expected.forEach(eStage -> assertContainsStage(eStage, processInstance.stages()));\n+        processInstance.start();\n+\n+        assertThat(((Model) processInstance.variables()).toMap().get(\"caseFile_currentStage\")).isEqualTo(3);\n+        assertThat(processInstance.workItems().size()).isEqualTo(0);\n+        assertState(processInstance, ProcessInstance.STATE_COMPLETED);\n+        expected = expected.stream().map(s -> new Stage.Builder(s).withStatus(COMPLETED).build()).collect(Collectors.toList());\n+        expected.forEach(eStage -> assertContainsStage(eStage, processInstance.stages()));\n+    }\n+\n+    private Collection<Stage> buildExpectedMultipleAdHoc() {\n+        Collection<Stage> expected = new ArrayList<>();\n+        expected.add(new Stage.Builder(\"_4A154E74-F085-4ECA-93F1-DE452E624FB1\").withName(\"Stage 1\").withStatus(AVAILABLE).withAutoComplete(true).withFragment(new ActionNode(), \"Task1\").build());\n+        expected.add(new Stage.Builder(\"_168F4098-8ACA-4E81-9F97-5EAAC0782574\").withName(\"Stage 2\").withStatus(AVAILABLE).withAutoComplete(true).withFragment(new ActionNode(), \"Task2\").build());\n+        expected.add(new Stage.Builder(\"_E2F977AC-205A-4314-A406-00CEA619CDF9\").withName(\"Stage 3\").withStatus(AVAILABLE).withAutoComplete(true).withFragment(new ActionNode(), \"Task3\").build());\n+        return expected;\n+    }\n+\n+    @Test\n+    void testCaseFile() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 130}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MzkzNTA0", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-419393504", "createdAt": "2020-05-27T16:18:43Z", "commit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxODo0M1rOGbSu2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNjoxODo0M1rOGbSu2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTI3MTY0Mw==", "bodyText": "wouldn't it make more sense to either\n\nuse new sub class for case related methods\nuse more process related names instead\n\nmixing these two concepts can become really confusing...", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r431271643", "createdAt": "2020-05-27T16:18:43Z", "author": {"login": "mswiderski"}, "path": "api/kogito-api/src/main/java/org/kie/kogito/process/ProcessInstance.java", "diffHunk": "@@ -172,4 +173,10 @@\n      * @return All the process milestones with their current status\n      */\n     Collection<Milestone> milestones();\n+\n+    /**\n+     * Returns the process stages\n+     * @return All the process stages with their current status\n+     */\n+    Collection<Stage> stages();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6d6a7e6914f10b39cb04f07df2051633ef2126"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf498a4eeac06ed3005e7cb9dfd39661a3e15b11", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/bf498a4eeac06ed3005e7cb9dfd39661a3e15b11", "committedDate": "2020-05-29T07:21:15Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "68b1e38913a46746e5f4240979e51aa202080a3c", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/68b1e38913a46746e5f4240979e51aa202080a3c", "committedDate": "2020-05-29T07:30:16Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68b1e38913a46746e5f4240979e51aa202080a3c", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/68b1e38913a46746e5f4240979e51aa202080a3c", "committedDate": "2020-05-29T07:30:16Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "1a0eac9071565a443dd9fff0fe2c3ed1c5e3f46c", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/1a0eac9071565a443dd9fff0fe2c3ed1c5e3f46c", "committedDate": "2020-05-29T09:37:01Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a0eac9071565a443dd9fff0fe2c3ed1c5e3f46c", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/1a0eac9071565a443dd9fff0fe2c3ed1c5e3f46c", "committedDate": "2020-05-29T09:37:01Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "aac316c38f44d3e003ed05ed1ef2d90bbab3dbd8", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/aac316c38f44d3e003ed05ed1ef2d90bbab3dbd8", "committedDate": "2020-05-29T09:55:23Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aac316c38f44d3e003ed05ed1ef2d90bbab3dbd8", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/aac316c38f44d3e003ed05ed1ef2d90bbab3dbd8", "committedDate": "2020-05-29T09:55:23Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/599ed8478376f8b49d545708045bacbd4d6371d5", "committedDate": "2020-05-29T10:46:41Z", "message": "[KOGITO-1968] Generalize to subProcesses\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwODcyNjM3", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-420872637", "createdAt": "2020-05-29T11:35:03Z", "commit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTozNTowM1rOGcZJlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxMTo0MjowM1rOGcZVRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNTM2NA==", "bodyText": "Does it return only Adhoc subprocesses or any subprocesses?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r432425364", "createdAt": "2020-05-29T11:35:03Z", "author": {"login": "tiagodolphine"}, "path": "api/kogito-api/src/main/java/org/kie/kogito/process/ProcessInstance.java", "diffHunk": "@@ -169,7 +187,22 @@\n \n     /**\n      * Returns the process milestones\n+     *\n      * @return All the process milestones with their current status\n      */\n     Collection<Milestone> milestones();\n+\n+    /**\n+     * Returns the AdHocSubProcesses in the proces", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyNjkwNg==", "bodyText": "Should we name it Subprocess or AdhocSubprocess?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r432426906", "createdAt": "2020-05-29T11:38:31Z", "author": {"login": "tiagodolphine"}, "path": "api/kogito-api/src/main/java/org/kie/kogito/process/casemgmt/SubProcess.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright 2020 Red Hat, Inc. and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.kie.kogito.process.casemgmt;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+\n+public class SubProcess extends ItemDescription {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyODM1OA==", "bodyText": "why not just setting the system property on the tests?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r432428358", "createdAt": "2020-05-29T11:42:03Z", "author": {"login": "tiagodolphine"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/VariableScope.java", "diffHunk": "@@ -89,36 +72,36 @@ public Context resolveContext(Object param) {\n             return findVariable((String) param) == null ? null : this;\n         }\n         throw new IllegalArgumentException(\n-            \"VariableScopes can only resolve variable names: \" + param);\n+                \"VariableScopes can only resolve variable names: \" + param);\n+    }\n+\n+    public void validateVariable(String processName, String name, Object value) {\n+        if (!variableStrictEnabled) {\n+            return;\n+        }\n+        Variable var = findVariable(name);\n+        if (var == null) {\n+            throw new IllegalArgumentException(\"Variable '\" + name + \"' is not defined in process \" + processName);\n+        }\n+        if (var.getType() != null && value != null) {\n+            boolean isValidType = var.getType().verifyDataType(value);\n+            if (!isValidType) {\n+                throw new IllegalArgumentException(\"Variable '\" + name + \"' has incorrect data type expected:\"\n+                        + var.getType().getStringType() + \" actual:\" + value.getClass().getName());\n+            }\n+        }\n+    }\n+\n+    /*\n+     * mainly for test coverage to easily switch between settings\n+     */\n+    public static void setVariableStrictOption(boolean turnedOn) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTYwNDE2", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-421560416", "createdAt": "2020-06-01T02:11:26Z", "commit": {"oid": "2e4882e8a48e719e77fe67594df51b94a2cbef3a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwMjoxMToyNlrOGc9Itw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQwMjoxNTo1MVrOGc9LQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxNDk2Nw==", "bodyText": "I think to align with the other methods naming we would call this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Collection<AdHocFragment> getAdHocFragments();\n          \n          \n            \n                Collection<AdHocFragment> adHocFragments();", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r433014967", "createdAt": "2020-06-01T02:11:26Z", "author": {"login": "cristianonicolai"}, "path": "api/kogito-api/src/main/java/org/kie/kogito/process/ProcessInstance.java", "diffHunk": "@@ -169,7 +187,22 @@\n \n     /**\n      * Returns the process milestones\n+     *\n      * @return All the process milestones with their current status\n      */\n     Collection<Milestone> milestones();\n+\n+    /**\n+     * Returns the SubProcesses in the process\n+     *\n+     * @return All the process {@link SubProcess} with their current status\n+     */\n+    Collection<SubProcess> subProcesses();\n+\n+    /**\n+     * Returns the process adHocFragments\n+     *\n+     * @return All the {@link AdHocFragment} in the process\n+     */\n+    Collection<AdHocFragment> getAdHocFragments();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e4882e8a48e719e77fe67594df51b94a2cbef3a"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzAxNTYxOQ==", "bodyText": "@ruromero why not simply use the system property instead?", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#discussion_r433015619", "createdAt": "2020-06-01T02:15:51Z", "author": {"login": "cristianonicolai"}, "path": "jbpm/jbpm-flow/src/main/java/org/jbpm/process/core/context/variable/VariableScope.java", "diffHunk": "@@ -89,36 +72,36 @@ public Context resolveContext(Object param) {\n             return findVariable((String) param) == null ? null : this;\n         }\n         throw new IllegalArgumentException(\n-            \"VariableScopes can only resolve variable names: \" + param);\n+                \"VariableScopes can only resolve variable names: \" + param);\n+    }\n+\n+    public void validateVariable(String processName, String name, Object value) {\n+        if (!variableStrictEnabled) {\n+            return;\n+        }\n+        Variable var = findVariable(name);\n+        if (var == null) {\n+            throw new IllegalArgumentException(\"Variable '\" + name + \"' is not defined in process \" + processName);\n+        }\n+        if (var.getType() != null && value != null) {\n+            boolean isValidType = var.getType().verifyDataType(value);\n+            if (!isValidType) {\n+                throw new IllegalArgumentException(\"Variable '\" + name + \"' has incorrect data type expected:\"\n+                        + var.getType().getStringType() + \" actual:\" + value.getClass().getName());\n+            }\n+        }\n+    }\n+\n+    /*\n+     * mainly for test coverage to easily switch between settings\n+     */\n+    public static void setVariableStrictOption(boolean turnedOn) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjQyODM1OA=="}, "originalCommit": {"oid": "599ed8478376f8b49d545708045bacbd4d6371d5"}, "originalPosition": 109}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDEwMTA1", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-422010105", "createdAt": "2020-06-01T16:47:45Z", "commit": {"oid": "cd7eec0efeff5c02d989f86ad981a2c62a83feb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMzM1NjM2", "url": "https://github.com/kiegroup/kogito-runtimes/pull/507#pullrequestreview-422335636", "createdAt": "2020-06-02T04:34:52Z", "commit": {"oid": "cd7eec0efeff5c02d989f86ad981a2c62a83feb0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "571d23b2d328e74df13514764fc852f10241b991", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/571d23b2d328e74df13514764fc852f10241b991", "committedDate": "2020-06-02T05:49:52Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cd7eec0efeff5c02d989f86ad981a2c62a83feb0", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/cd7eec0efeff5c02d989f86ad981a2c62a83feb0", "committedDate": "2020-06-01T15:14:18Z", "message": "[KOGITO-1968] Remove subProcess from the ProcessInstance API\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}, "afterCommit": {"oid": "571d23b2d328e74df13514764fc852f10241b991", "author": {"user": {"login": "ruromero", "name": "Ruben Romero Montes"}}, "url": "https://github.com/kiegroup/kogito-runtimes/commit/571d23b2d328e74df13514764fc852f10241b991", "committedDate": "2020-06-02T05:49:52Z", "message": "[KOGITO-1968] Implement missing features for DynamicNodes\n\nSigned-off-by: ruromero <rromerom@redhat.com>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3491, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}