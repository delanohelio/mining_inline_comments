{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2NTE4OTQz", "number": 2893, "title": "[GEOT-6557] Add support for GEOMETRY_GENERALIZATION in MBTiles store [GEOT-6558] Make MBTilesStore to remove features in mbtiles file buffer when a rendering transformation is issued", "bodyText": "Checklist\n\nReviewing is a process done by project maintainers, mostly on a volunteer basis. We try to keep the overhead as small as possible and appreciate if you help us to do so by completing the following items. Feel free to ask in a comment if you have troubles with any of them.\n\nFor all pull requests:\n\n Confirm you have read the contribution guidelines\n You have sent a Contribution Licence Agreement (CLA) as necessary (not required for small changes, e.g., fixing typos in documentation)\n Make sure the first PR targets the master branch, eventual backports will be managed later. This can be ignored if the PR is fixing an issue that only happens in a specific branch, but not in newer ones.\n The changes are not breaking the build in downstream projects using SNAPSHOT dependencies, GeoWebCache and GeoServer.\n\nThe following are required only for core and extension modules (they are welcomed, but not required, for unsupported modules):\n\n There is an issue in Jira describing the bug/task/new feature (a notable exemptions is, changes not visible to end users). The ticket is for the GeoTools project, if the issue was found elsewhere it's a good practice to link to the origin ticket/issue.\n The pull request contains changes related to a single objective. If multiple focuses cannot be avoided, each one is in its own commit and has a separate ticket describing it.\n PR for bug fixes and small new features are presented as a single commit\n Commit message must be in the form \"[GEOT-XYZW] Title of the Jira ticket\"\n New unit tests have been added covering the changes\n This PR passes all existing unit tests (test results will be reported by travis-ci after opening this PR)\n This PR passes the QA checks (QA checks results will be reported by travis-ci after opening this PR)\n Documentation has been updated accordingly.\n\nSubmitting the PR does not require you to check all items, but by the time it gets merged, they should be either satisfied or inapplicable.", "createdAt": "2020-04-21T08:24:43Z", "url": "https://github.com/geotools/geotools/pull/2893", "merged": true, "mergeCommit": {"oid": "d2bd5396776b7138df5ae54595408f74feaf2557"}, "closed": true, "closedAt": "2020-05-07T10:07:38Z", "author": {"login": "taba90"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZvSh7AH2gAyNDA2NTE4OTQzOjAxNzEyMTJhODNjNDFjNzAyNjg4M2RlZmI1OTRmMTY5YzRmZjI4NzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABce6ak8AFqTQwNzMzMDIxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0171212a83c41c7026883defb594f169c4ff2876", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/0171212a83c41c7026883defb594f169c4ff2876", "committedDate": "2020-04-21T08:19:58Z", "message": "[GEOT-6557] Add support for GEOMETRY_GENERALIZATION in MBTiles store"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3e5f9f60bd5f78c6628ad96db7316b6d0e327760", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/3e5f9f60bd5f78c6628ad96db7316b6d0e327760", "committedDate": "2020-04-21T09:20:16Z", "message": "fix fmt check on Java 11"}, "afterCommit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/1fcc7b16f553df77154299b19ccc7fc9c295923b", "committedDate": "2020-04-21T13:40:34Z", "message": "fix fmt check on Java 11"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzIzMDIw", "url": "https://github.com/geotools/geotools/pull/2893#pullrequestreview-402723020", "createdAt": "2020-04-29T14:27:51Z", "commit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDoyNzo1MVrOGOBkGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNDoyOTo0NVrOGOBqUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1ODg3NQ==", "bodyText": "The name is unclear, there is no just a single \"pixel\", and in the future, things can be more complicated, like having a buffer in meters.\nThe implementation is also asymmetric, StreamingRenderer uses the clip from the feature metadata for tile rendering already, but here a new hint has been added to delegate to the store instead. Can we wrap the collection and clip just before passing the data to the rendering transformation instead? No need for new hints in this case.\nIf the rework is considered too big, at least let's call this \"REMOVE_TILE_BUFFER\" instead.", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417358875", "createdAt": "2020-04-29T14:27:51Z", "author": {"login": "aaime"}, "path": "modules/library/metadata/src/main/java/org/geotools/util/factory/Hints.java", "diffHunk": "@@ -688,6 +688,11 @@\n      */\n     public static final ClassKey GEOMETRY_CLIP = new ClassKey(\"org.locationtech.jts.geom.Geometry\");\n \n+    /**\n+     * Used when a rendering transformation is applied to a vector tile geometries, to lead the\n+     * store using the clip mask to remove geometries outside tiles.\n+     */\n+    public static final Key REMOVE_BUFFER_PIXEL = new Key(Boolean.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM1OTgwOQ==", "bodyText": "This could be easily turned into a DecoratingFeatureIterator instead, which a ClippingFeatureCollection would use.", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417359809", "createdAt": "2020-04-29T14:28:58Z", "author": {"login": "aaime"}, "path": "modules/unsupported/mbtiles/src/main/java/org/geotools/mbtiles/ClippingFeatureReader.java", "diffHunk": "@@ -0,0 +1,87 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.mbtiles;\n+\n+import java.io.IOException;\n+import java.util.NoSuchElementException;\n+import org.geotools.data.simple.SimpleFeatureReader;\n+import org.geotools.util.factory.Hints;\n+import org.locationtech.jts.geom.Geometry;\n+import org.locationtech.jts.geom.Polygon;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+import org.opengis.feature.type.GeometryDescriptor;\n+\n+/**\n+ * The class takes care to return features that intersects the geometry passed with a\n+ * Hints.GEOMETRY_CLIP, in order to avoid that features' buffer in mbtiles data gets deployed when a\n+ * rendering transformation is issued.\n+ */\n+class ClippingFeatureReader implements SimpleFeatureReader {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM2MDQ2NQ==", "bodyText": "Here one could advertise the existing Hints.GEOMETRY_CLIP, so that the StreamingRenderer instantiates the clipping collection only when needed.", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r417360465", "createdAt": "2020-04-29T14:29:45Z", "author": {"login": "aaime"}, "path": "modules/unsupported/mbtiles/src/main/java/org/geotools/mbtiles/MBTilesFeatureSource.java", "diffHunk": "@@ -68,7 +61,10 @@ public MBTilesFeatureSource(\n \n     @Override\n     protected void addHints(Set<Hints.Key> hints) {\n+\n         hints.add(Hints.GEOMETRY_SIMPLIFICATION);\n+        hints.add(Hints.GEOMETRY_GENERALIZATION);\n+        hints.add(Hints.REMOVE_BUFFER_PIXEL);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c301d0eef1b4280ceb5b43392897d13a9469f7bd", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/c301d0eef1b4280ceb5b43392897d13a9469f7bd", "committedDate": "2020-04-29T20:36:58Z", "message": "[GEOT-6558] Make MBTilesStore to remove features in mbtiles file buffer when a rendering transformation is issued"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1fcc7b16f553df77154299b19ccc7fc9c295923b", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/1fcc7b16f553df77154299b19ccc7fc9c295923b", "committedDate": "2020-04-21T13:40:34Z", "message": "fix fmt check on Java 11"}, "afterCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/67418d5f80de3539ae8ba7f40801afd274a6cac4", "committedDate": "2020-04-30T11:43:31Z", "message": "reviewer's feedback applied"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2NTUyMTg0", "url": "https://github.com/geotools/geotools/pull/2893#pullrequestreview-406552184", "createdAt": "2020-05-06T12:15:08Z", "commit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjoxNTowOVrOGRQICg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxMjoxNjowMFrOGRQJ7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzE3OA==", "bodyText": "Thanks for making this a general functionality.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            public class DecoratingClippingFeatureCollection extends DecoratingSimpleFeatureCollection {\n          \n          \n            \n            public class ClippingFeatureCollection extends DecoratingSimpleFeatureCollection {\n          \n      \n    \n    \n  \n\nNone of the existing decorators reminds you that it's a decorator in the name:", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743178", "createdAt": "2020-05-06T12:15:09Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/main/java/org/geotools/feature/collection/DecoratingClippingFeatureCollection.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import org.geotools.data.simple.SimpleFeatureCollection;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+\n+/**\n+ * The class decorates a SimpleFeatureCollection with one that returns features that intersect the\n+ * geometry passed with a Hints.GEOMETRY_CLIP\n+ */\n+public class DecoratingClippingFeatureCollection extends DecoratingSimpleFeatureCollection {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzMzNw==", "bodyText": "Same as above.", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743337", "createdAt": "2020-05-06T12:15:25Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/main/java/org/geotools/feature/collection/DecoratingClippingFeatureIterator.java", "diffHunk": "@@ -0,0 +1,86 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import java.util.NoSuchElementException;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.FeatureIterator;\n+import org.geotools.util.factory.Hints;\n+import org.locationtech.jts.geom.Geometry;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.type.GeometryDescriptor;\n+\n+/**\n+ * Decorates a SimpleFeatureIterator with one that return features if intersect the Geometry passed\n+ * with the Hint.GEOMETRY_CLIP\n+ */\n+public class DecoratingClippingFeatureIterator extends DecoratingSimpleFeatureIterator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzUxNg==", "bodyText": "Align test name while renaming main class.", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743516", "createdAt": "2020-05-06T12:15:46Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/test/java/org/geotools/feature/collection/DecoratingClippingFeatureCollectionTest.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ *    GeoTools - The Open Source Java GIS Toolkit\n+ *    http://geotools.org\n+ *\n+ *    (C) 2020, Open Source Geospatial Foundation (OSGeo)\n+ *\n+ *    This library is free software; you can redistribute it and/or\n+ *    modify it under the terms of the GNU Lesser General Public\n+ *    License as published by the Free Software Foundation;\n+ *    version 2.1 of the License.\n+ *\n+ *    This library is distributed in the hope that it will be useful,\n+ *    but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ *    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU\n+ *    Lesser General Public License for more details.\n+ */\n+package org.geotools.feature.collection;\n+\n+import junit.framework.TestCase;\n+import org.geotools.data.simple.SimpleFeatureIterator;\n+import org.geotools.feature.DefaultFeatureCollection;\n+import org.geotools.feature.simple.SimpleFeatureBuilder;\n+import org.geotools.feature.simple.SimpleFeatureTypeBuilder;\n+import org.geotools.util.factory.Hints;\n+import org.junit.Test;\n+import org.locationtech.jts.geom.Coordinate;\n+import org.locationtech.jts.geom.GeometryFactory;\n+import org.locationtech.jts.geom.Point;\n+import org.opengis.feature.simple.SimpleFeature;\n+import org.opengis.feature.simple.SimpleFeatureType;\n+\n+public class DecoratingClippingFeatureCollectionTest extends TestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDc0MzY2Mg==", "bodyText": "Nice", "url": "https://github.com/geotools/geotools/pull/2893#discussion_r420743662", "createdAt": "2020-05-06T12:16:00Z", "author": {"login": "aaime"}, "path": "modules/library/render/src/main/java/org/geotools/renderer/lite/RenderingTransformationHelper.java", "diffHunk": "@@ -276,6 +279,12 @@ public Object applyRenderingTransformation(\n             // grab the original features\n             Query mixedQuery = DataUtilities.mixQueries(layerQuery, optimizedQuery, null);\n             originalFeatures = featureSource.getFeatures(mixedQuery);\n+            if (featureSource.getSupportedHints().contains(Hints.GEOMETRY_CLIP)\n+                    && originalFeatures instanceof SimpleFeatureCollection) {\n+                originalFeatures =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "317fea2ad2cfe37139c24d87d9fd1dffda66c866", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/317fea2ad2cfe37139c24d87d9fd1dffda66c866", "committedDate": "2020-05-07T05:54:20Z", "message": "reviewer's feedback applied"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67418d5f80de3539ae8ba7f40801afd274a6cac4", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/67418d5f80de3539ae8ba7f40801afd274a6cac4", "committedDate": "2020-04-30T11:43:31Z", "message": "reviewer's feedback applied"}, "afterCommit": {"oid": "317fea2ad2cfe37139c24d87d9fd1dffda66c866", "author": {"user": {"login": "taba90", "name": null}}, "url": "https://github.com/geotools/geotools/commit/317fea2ad2cfe37139c24d87d9fd1dffda66c866", "committedDate": "2020-05-07T05:54:20Z", "message": "reviewer's feedback applied"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3MzMwMjE3", "url": "https://github.com/geotools/geotools/pull/2893#pullrequestreview-407330217", "createdAt": "2020-05-07T10:07:20Z", "commit": {"oid": "317fea2ad2cfe37139c24d87d9fd1dffda66c866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2835, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}