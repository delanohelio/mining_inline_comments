{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMjgxNjA5", "number": 3078, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDowMDo1NlrOEQMsIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjo1ODowN1rOERb9gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NDIwNTc5OnYy", "diffSide": "RIGHT", "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxNDowMDo1NlrOG0OOgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwOToyOTowMFrOG0v0lg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxMjIyNQ==", "bodyText": "Should not be public. Besides that, this large block of code (this method and the ones below) seem like it could be shared with EqualIntervalFunction, or not? Guess you can do the same as with AbstractQuantityClassificationFunction and roll a common superclass.", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r457412225", "createdAt": "2020-07-20T14:00:56Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +110,65 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    public double[] getPercentages(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d81413f76b0857a3089b347c907c900ffb9a30d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQyNDIwOA==", "bodyText": "Thanks for your review @aaime. I've put it as private. Anyway this is not the same block of code. The EqualIntervalFunction use a GroupByVisitor to query the data and compute percentages. In this case it is creating filters mapping the breaks to query the data. Also both are different from the computePercentages method in the AbstractQuantityClassificationFunction", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r457424208", "createdAt": "2020-07-20T14:13:35Z", "author": {"login": "taba90"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +110,65 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    public double[] getPercentages(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxMjIyNQ=="}, "originalCommit": {"oid": "4d81413f76b0857a3089b347c907c900ffb9a30d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQyNjI2Nw==", "bodyText": "A group by visitor seems indeed more efficient, the current one seems to be loading the entire data set from the database to run the counts? If so, that's quite inefficient.", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r457426267", "createdAt": "2020-07-20T14:16:04Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +110,65 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    public double[] getPercentages(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxMjIyNQ=="}, "originalCommit": {"oid": "4d81413f76b0857a3089b347c907c900ffb9a30d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzk2MjY0Ng==", "bodyText": "thanks for your point @aaime . Code has been modified so that GroupBy is used also for StandardDeviation percentages.", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r457962646", "createdAt": "2020-07-21T09:29:00Z", "author": {"login": "taba90"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +110,65 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    public double[] getPercentages(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzQxMjIyNQ=="}, "originalCommit": {"oid": "4d81413f76b0857a3089b347c907c900ffb9a30d"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NzE5MzYyOnYy", "diffSide": "RIGHT", "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMjo1ODowN1rOG2JRvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQwNzozMzoyNVrOG2lwsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyODI4NQ==", "bodyText": "Isn't the last interval also open to infinity? However, once you have the first, and the middle ones, you can compute the last percentage by difference. I see there is logic elsewhere to handle it, but it does not seem correct.... I was expecting something of the sort:\n\nCompute the count of the first class, and the total count (you have this)\nCompute the groupby on the middle classes, e.g., besides the first and the last, that are both open (here it seems you're assuming the last class is closed instead? the computePercentage method receives always a count from the resultset of groupby, that cannot be)\nCompute the percentage of the last class by difference\n\nThe tests only validate the sum is 100, but do not check the actual value. Can you use an online tool or a spreadsheet to compute the actual values, and then compare the results with the ones of the function, one by one?", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r459428285", "createdAt": "2020-07-23T12:58:07Z", "author": {"login": "aaime"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +111,41 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    private double[] getPercentages(\n+            FeatureCollection features,\n+            RangedClassifier classifier,\n+            Expression attr,\n+            double standardDeviation)\n+            throws IOException {\n+        int classSize = classifier.getSize();\n+        Object firstMax = classifier.getMax(0);\n+        Filter less = FF.less(attr, FF.literal(firstMax));\n+        int sizeFirstClass = features.subCollection(less).size();\n+        int totalSize = features.size();\n+        double[] percentages = new double[classSize];\n+        // we don't know the min value in the collection because the\n+        // the first interval is open to infinity to the left.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f48abee65e07eaaece3c5bf8fa3dd58ff9a83843"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTg5NDk2MQ==", "bodyText": "Thanks @aaime I've added a check on percentages one by one. The openess to infinity of the last class is handled here 9678b09#diff-2319f1367ac925907808cd3d8f0fa864R283 where the index returned from the query is checked on the percentages length and in case  the resulting percentage is merged on the one of the last class. I've added also a test to check this behaviour.", "url": "https://github.com/geotools/geotools/pull/3078#discussion_r459894961", "createdAt": "2020-07-24T07:33:25Z", "author": {"login": "taba90"}, "path": "modules/library/main/src/main/java/org/geotools/filter/function/StandardDeviationFunction.java", "diffHunk": "@@ -96,4 +111,41 @@ private Double getMax(int index, int numClasses, double average, double standard\n         if (index < 0 || index >= numClasses - 1) return null;\n         return Double.valueOf(average - (((numClasses / 2.0) - 1 - index) * standardDeviation));\n     }\n+\n+    private double[] getPercentages(\n+            FeatureCollection features,\n+            RangedClassifier classifier,\n+            Expression attr,\n+            double standardDeviation)\n+            throws IOException {\n+        int classSize = classifier.getSize();\n+        Object firstMax = classifier.getMax(0);\n+        Filter less = FF.less(attr, FF.literal(firstMax));\n+        int sizeFirstClass = features.subCollection(less).size();\n+        int totalSize = features.size();\n+        double[] percentages = new double[classSize];\n+        // we don't know the min value in the collection because the\n+        // the first interval is open to infinity to the left.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTQyODI4NQ=="}, "originalCommit": {"oid": "f48abee65e07eaaece3c5bf8fa3dd58ff9a83843"}, "originalPosition": 65}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3789, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}