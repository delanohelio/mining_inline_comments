{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2ODMwOTgx", "number": 3063, "title": "[GEOT-6657] Fix data URL protocol validation", "bodyText": "This PR adds 'data:' schema validation for data protocol handling code on GeoTools URL converter.\nJIRA issue:\nhttps://osgeo-org.atlassian.net/browse/GEOT-6657\nChecklist\n\nReviewing is a process done by project maintainers, mostly on a volunteer basis. We try to keep the overhead as small as possible and appreciate if you help us to do so by completing the following items. Feel free to ask in a comment if you have troubles with any of them.\n\nFor all pull requests:\n\n Confirm you have read the contribution guidelines\n You have sent a Contribution Licence Agreement (CLA) as necessary (not required for small changes, e.g., fixing typos in documentation)\n Make sure the first PR targets the master branch, eventual backports will be managed later. This can be ignored if the PR is fixing an issue that only happens in a specific branch, but not in newer ones.\n The changes are not breaking the build in downstream projects using SNAPSHOT dependencies, GeoWebCache and GeoServer.\n\nThe following are required only for core and extension modules (they are welcomed, but not required, for unsupported modules):\n\n There is an issue in Jira describing the bug/task/new feature (a notable exemptions is, changes not visible to end users). The ticket is for the GeoTools project, if the issue was found elsewhere it's a good practice to link to the origin ticket/issue.\n The pull request contains changes related to a single objective. If multiple focuses cannot be avoided, each one is in its own commit and has a separate ticket describing it.\n PR for bug fixes and small new features are presented as a single commit\n Commit message must be in the form \"[GEOT-XYZW] Title of the Jira ticket\"\n New unit tests have been added covering the changes\n This PR passes all existing unit tests (test results will be reported by travis-ci after opening this PR)\n This PR passes the QA checks (QA checks results will be reported by travis-ci after opening this PR)\n Documentation has been updated accordingly.\n\nSubmitting the PR does not require you to check all items, but by the time it gets merged, they should be either satisfied or inapplicable.", "createdAt": "2020-07-09T12:33:30Z", "url": "https://github.com/geotools/geotools/pull/3063", "merged": true, "mergeCommit": {"oid": "ae0b4f58f7f4dcf1cd3f508a221acd89ca969bf6"}, "closed": true, "closedAt": "2020-07-09T22:31:08Z", "author": {"login": "fernandor777"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczQKYBABqjM1MzAwNjAwOTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczWtWeAFqTQ0NjAwODQzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1482b362786f2ce630e1acf35175f8e5ab1eb200", "author": {"user": {"login": "fernandor777", "name": "Fernando Mi\u00f1o"}}, "url": "https://github.com/geotools/geotools/commit/1482b362786f2ce630e1acf35175f8e5ab1eb200", "committedDate": "2020-07-09T12:13:26Z", "message": "Fix data URL protocol handling"}, "afterCommit": {"oid": "c86a031d2a1ea4a8652ae43fa6f11e925976ca09", "author": {"user": {"login": "fernandor777", "name": "Fernando Mi\u00f1o"}}, "url": "https://github.com/geotools/geotools/commit/c86a031d2a1ea4a8652ae43fa6f11e925976ca09", "committedDate": "2020-07-09T14:41:15Z", "message": "Fix data URL protocol handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f315c5cdaa9fc911430e190b7852caaad8e978f", "author": {"user": {"login": "fernandor777", "name": "Fernando Mi\u00f1o"}}, "url": "https://github.com/geotools/geotools/commit/8f315c5cdaa9fc911430e190b7852caaad8e978f", "committedDate": "2020-07-09T21:51:39Z", "message": "[GEOT-6657] Fix data URL protocol handling"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c86a031d2a1ea4a8652ae43fa6f11e925976ca09", "author": {"user": {"login": "fernandor777", "name": "Fernando Mi\u00f1o"}}, "url": "https://github.com/geotools/geotools/commit/c86a031d2a1ea4a8652ae43fa6f11e925976ca09", "committedDate": "2020-07-09T14:41:15Z", "message": "Fix data URL protocol handling"}, "afterCommit": {"oid": "8f315c5cdaa9fc911430e190b7852caaad8e978f", "author": {"user": {"login": "fernandor777", "name": "Fernando Mi\u00f1o"}}, "url": "https://github.com/geotools/geotools/commit/8f315c5cdaa9fc911430e190b7852caaad8e978f", "committedDate": "2020-07-09T21:51:39Z", "message": "[GEOT-6657] Fix data URL protocol handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MDA4NDM4", "url": "https://github.com/geotools/geotools/pull/3063#pullrequestreview-446008438", "createdAt": "2020-07-09T22:22:57Z", "commit": {"oid": "c86a031d2a1ea4a8652ae43fa6f11e925976ca09"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMjoyMzoxOFrOGvjzDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQyMjoyMzoxOFrOGvjzDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjUyMjc2Nw==", "bodyText": "I think this needs a bit more of context, after chatting with @fernando over this issue I understood that the original problem that we are fixing here is a performance issue with WMS, in some environments we had maps where the rendering times performance went from ~600 ms to ~5 second, sometimes restarting the server fixed the issue.\nLong story short, when the support for the :data protocol this line was added, it basically uses a constructor that skips the URL validation, this allows URL using data: protocol to pass thought, but unfortunately it will also allow any invalid URL to pass.\nThe RenderableSVGCache is using the converter, where the line above was added, to validate that it got a valid URL and should try to fetch an SVG, since the converter will not validate anything, all URL's are consider valid, and the SVG factory will try to fetch all of them, causing the performance issue. Depending on which factory is loaded first on a certain environment, this issue may or not happen, for example if we are using something like this <WellKnownName>wkt://COMPOUNDCURVE((0 0, 0.25 0), CIRCULARSTRING(0.25 0, 0.5 0.5, 0.75 0), (0.75 0, 1 0))</WellKnownName> and the factory capable of handling WKT marks is loaded first then no performance problem.\nOne way of fixing this would be to register the data: protocol using the Java official way, but unfortunately the URL URLStreamHandlerFactory can be registered only once, and seems like we can have another registration for it overlapping its usage. This makes the entire first line converters registering fails and making the URL converter not being found. Reading a bit seems like since Java 9 we have an extension point for the URL handlers, but we are not there yet.\nHence the proposed solution on the PR, which basically explicit only allow the :data protocol to be validated blindly.", "url": "https://github.com/geotools/geotools/pull/3063#discussion_r452522767", "createdAt": "2020-07-09T22:23:18Z", "author": {"login": "nmco"}, "path": "modules/library/main/src/main/java/org/geotools/data/util/CommonsConverterFactory.java", "diffHunk": "@@ -257,12 +257,22 @@\n                 URL parsed = new URL(string);\n                 return target.cast(parsed);\n             } catch (Exception e) {\n+                // try to fetch a data protocol URL, or return null\n+                return tryGetDataURL(string, target);\n+            }\n+        }\n+\n+        private <T> T tryGetDataURL(String string, Class<T> target) {\n+            // check if it's a data protocol URL\n+            if (string.startsWith(DataUrlConnection.DATA_PREFIX)) {\n                 try {\n                     URL parsed = new URL(null, string, new DataUrlHandler());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8f315c5cdaa9fc911430e190b7852caaad8e978f"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3093, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}