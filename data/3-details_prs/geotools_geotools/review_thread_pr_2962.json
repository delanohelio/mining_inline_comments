{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3OTY4NzE1", "number": 2962, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowOToxOFrOEC29rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowOToxOFrOEC29rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNDMzMTMzOnYy", "diffSide": "RIGHT", "path": "modules/plugin/imagemosaic/src/test/java/org/geotools/gce/imagemosaic/ImageMosaicFootprintsTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODowOToxOFrOGfkl9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwODozNjozNFrOGfle2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1ODU4MQ==", "bodyText": "Why eat the exception? A normal execution should not throw it, I would let it throw it instead of silently catchig it.", "url": "https://github.com/geotools/geotools/pull/2962#discussion_r435758581", "createdAt": "2020-06-05T08:09:18Z", "author": {"login": "aaime"}, "path": "modules/plugin/imagemosaic/src/test/java/org/geotools/gce/imagemosaic/ImageMosaicFootprintsTest.java", "diffHunk": "@@ -1622,4 +1625,67 @@ private void assertFootprintsCleanup(\n         assertThat(existingFilesPastCleanup, Matchers.emptyArray());\n         assertEquals(otherFilesCount, directory.listFiles(notFileFilter).length);\n     }\n+\n+    @Test\n+    public void testConcurrentWKBFootprintsLoading() throws Exception {\n+        WKBLoaderSPI loaderSPI = new WKBLoaderSPI();\n+        FootprintLoader loader = loaderSPI.createLoader();\n+        File newFolder = folder.newFolder();\n+\n+        // Get a sample WKB file and its footprint geometry\n+        File footprintFile = TestData.file(this, \"footprint_wkbs/r1c1.wkb\");\n+        String footprintPath = footprintFile.getAbsolutePath();\n+        String fileName = FilenameUtils.getName(footprintPath);\n+        footprintPath = footprintPath.substring(0, footprintPath.length() - 4);\n+        Geometry footprint = loader.loadFootprint(footprintPath);\n+\n+        int numberOfSamples = 60;\n+        String[] testFiles = new String[numberOfSamples];\n+\n+        // Let's copy the sample WKB to N different files\n+        for (int i = 0; i < numberOfSamples; i++) {\n+            String newName = fileName.replace(\"c1\", String.format(\"c%03d\", i));\n+            File ithFile = new File(newFolder, newName);\n+            FileUtils.copyFile(footprintFile, ithFile);\n+            File ithFootprintFile = new File(newFolder, FilenameUtils.getBaseName(newName));\n+            testFiles[i] = ithFootprintFile.getAbsolutePath();\n+        }\n+\n+        // Concurrently load the footprints of these sample WKB files\n+        // and add the results to a Geometries list, also counting\n+        // any error occurred during footprint parsing\n+        ExecutorService service = Executors.newFixedThreadPool(numberOfSamples / 2);\n+        CountDownLatch latch = new CountDownLatch(numberOfSamples);\n+        List<Geometry> geometries = new ArrayList<>(numberOfSamples);\n+        AtomicInteger errors = new AtomicInteger();\n+        try {\n+            for (int i = 0; i < numberOfSamples; i++) {\n+                int finalI = i;\n+                service.submit(\n+                        () -> {\n+                            try {\n+                                geometries.add(loader.loadFootprint(testFiles[finalI]));\n+                            } catch (InterruptedException e) {\n+                                // Handle exception\n+                            } catch (Exception e) {\n+                                errors.getAndIncrement();\n+                            }\n+                            latch.countDown();\n+                        });\n+            }\n+            latch.await();\n+        } catch (InterruptedException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d8c33b1c698aff3df02641f52ad023c8903db34"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc3MzE0NQ==", "bodyText": "@aaime\nFixed.", "url": "https://github.com/geotools/geotools/pull/2962#discussion_r435773145", "createdAt": "2020-06-05T08:36:34Z", "author": {"login": "dromagnoli"}, "path": "modules/plugin/imagemosaic/src/test/java/org/geotools/gce/imagemosaic/ImageMosaicFootprintsTest.java", "diffHunk": "@@ -1622,4 +1625,67 @@ private void assertFootprintsCleanup(\n         assertThat(existingFilesPastCleanup, Matchers.emptyArray());\n         assertEquals(otherFilesCount, directory.listFiles(notFileFilter).length);\n     }\n+\n+    @Test\n+    public void testConcurrentWKBFootprintsLoading() throws Exception {\n+        WKBLoaderSPI loaderSPI = new WKBLoaderSPI();\n+        FootprintLoader loader = loaderSPI.createLoader();\n+        File newFolder = folder.newFolder();\n+\n+        // Get a sample WKB file and its footprint geometry\n+        File footprintFile = TestData.file(this, \"footprint_wkbs/r1c1.wkb\");\n+        String footprintPath = footprintFile.getAbsolutePath();\n+        String fileName = FilenameUtils.getName(footprintPath);\n+        footprintPath = footprintPath.substring(0, footprintPath.length() - 4);\n+        Geometry footprint = loader.loadFootprint(footprintPath);\n+\n+        int numberOfSamples = 60;\n+        String[] testFiles = new String[numberOfSamples];\n+\n+        // Let's copy the sample WKB to N different files\n+        for (int i = 0; i < numberOfSamples; i++) {\n+            String newName = fileName.replace(\"c1\", String.format(\"c%03d\", i));\n+            File ithFile = new File(newFolder, newName);\n+            FileUtils.copyFile(footprintFile, ithFile);\n+            File ithFootprintFile = new File(newFolder, FilenameUtils.getBaseName(newName));\n+            testFiles[i] = ithFootprintFile.getAbsolutePath();\n+        }\n+\n+        // Concurrently load the footprints of these sample WKB files\n+        // and add the results to a Geometries list, also counting\n+        // any error occurred during footprint parsing\n+        ExecutorService service = Executors.newFixedThreadPool(numberOfSamples / 2);\n+        CountDownLatch latch = new CountDownLatch(numberOfSamples);\n+        List<Geometry> geometries = new ArrayList<>(numberOfSamples);\n+        AtomicInteger errors = new AtomicInteger();\n+        try {\n+            for (int i = 0; i < numberOfSamples; i++) {\n+                int finalI = i;\n+                service.submit(\n+                        () -> {\n+                            try {\n+                                geometries.add(loader.loadFootprint(testFiles[finalI]));\n+                            } catch (InterruptedException e) {\n+                                // Handle exception\n+                            } catch (Exception e) {\n+                                errors.getAndIncrement();\n+                            }\n+                            latch.countDown();\n+                        });\n+            }\n+            latch.await();\n+        } catch (InterruptedException e) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1ODU4MQ=="}, "originalCommit": {"oid": "1d8c33b1c698aff3df02641f52ad023c8903db34"}, "originalPosition": 89}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3534, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}