{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MzEyOTc5", "number": 268, "title": "#231 - Added MetricsLogPublisher", "bodyText": "Part of #231\nAdded MetricsLogPublisher class for periodic printing of collected metrics to log.", "createdAt": "2020-07-07T10:17:24Z", "url": "https://github.com/artipie/artipie/pull/268", "merged": true, "mergeCommit": {"oid": "f8232b260fbb25c3e8be5379ad01c78c18853eec"}, "closed": true, "closedAt": "2020-07-08T14:58:16Z", "author": {"login": "olegmoz"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyjILFAH2gAyNDQ1MzEyOTc5OmQxOThmNGU4YTQ4MjhlZmY4MDk0NmYzM2JiODFiOTgzNDg3ODNkMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy7qbLAH2gAyNDQ1MzEyOTc5OmY4NzRjMTcwMjhhODliMjMzOGM5MGYxNDY0MGY5MDI4ZDA0MmU2YTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/d198f4e8a4828eff80946f33bb81b98348783d00", "committedDate": "2020-07-07T10:17:54Z", "message": "#231 - Added MetricsLogPublisher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzY3Njcx", "url": "https://github.com/artipie/artipie/pull/268#pullrequestreview-443767671", "createdAt": "2020-07-07T10:35:28Z", "commit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMDozNToyOVrOGt4vtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxMDo0MTo0N1rOGt48CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc2ODgyMA==", "bodyText": "@olegmoz why not use Metrics interface instead of concrete class?", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450768820", "createdAt": "2020-07-07T10:35:29Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MDExMg==", "bodyText": "@olegmoz I think we should consider injecting logger to be able to test this class", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450770112", "createdAt": "2020-07-07T10:38:03Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;\n+\n+    /**\n+     * Period.\n+     */\n+    private final Duration period;\n+\n+    /**\n+     * Ctor.\n+     *\n+     * @param metrics Metrics for publishing.\n+     * @param period Period.\n+     */\n+    public MetricsLogPublisher(final InMemoryMetrics metrics, final Duration period) {\n+        this.metrics = metrics;\n+        this.period = period;\n+    }\n+\n+    /**\n+     * Start periodic publishing.\n+     */\n+    public void start() {\n+        final long millis = this.period.toMillis();\n+        Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n+            this::publish,\n+            millis,\n+            millis,\n+            TimeUnit.MILLISECONDS\n+        );\n+    }\n+\n+    /**\n+     * Publish metrics to log.\n+     */\n+    private void publish() {\n+        final Map<String, InMemoryCounter> counters = new TreeMap<>(this.metrics.counters());\n+        final StringBuilder message = new StringBuilder(\"Counters:\");\n+        for (final Map.Entry<String, InMemoryCounter> entry : counters.entrySet()) {\n+            message.append('\\n')\n+                .append(entry.getKey())\n+                .append(\": \")\n+                .append(entry.getValue().value());\n+        }\n+        Logger.info(this.metrics, message.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTgyNw==", "bodyText": "@olegmoz I think we shouldn't rely on toString method which will be called in Logger.info(this.metrics...). We should add some convenient log description in the first argument of Logger.info", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450771827", "createdAt": "2020-07-07T10:41:30Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.\n+ *  `InMemoryMetrics` contain gauges along counters.\n+ *  Gauges should be published the same way as counters.\n+ *  Should be done after https://github.com/artipie/artipie/issues/267\n+ */\n+public class MetricsLogPublisher {\n+\n+    /**\n+     * Metrics for publishing.\n+     */\n+    private final InMemoryMetrics metrics;\n+\n+    /**\n+     * Period.\n+     */\n+    private final Duration period;\n+\n+    /**\n+     * Ctor.\n+     *\n+     * @param metrics Metrics for publishing.\n+     * @param period Period.\n+     */\n+    public MetricsLogPublisher(final InMemoryMetrics metrics, final Duration period) {\n+        this.metrics = metrics;\n+        this.period = period;\n+    }\n+\n+    /**\n+     * Start periodic publishing.\n+     */\n+    public void start() {\n+        final long millis = this.period.toMillis();\n+        Executors.newSingleThreadScheduledExecutor().scheduleAtFixedRate(\n+            this::publish,\n+            millis,\n+            millis,\n+            TimeUnit.MILLISECONDS\n+        );\n+    }\n+\n+    /**\n+     * Publish metrics to log.\n+     */\n+    private void publish() {\n+        final Map<String, InMemoryCounter> counters = new TreeMap<>(this.metrics.counters());\n+        final StringBuilder message = new StringBuilder(\"Counters:\");\n+        for (final Map.Entry<String, InMemoryCounter> entry : counters.entrySet()) {\n+            message.append('\\n')\n+                .append(entry.getKey())\n+                .append(\": \")\n+                .append(entry.getValue().value());\n+        }\n+        Logger.info(this.metrics, message.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDc3MTk3Nw==", "bodyText": "@olegmoz add puzzle for testing this class", "url": "https://github.com/artipie/artipie/pull/268#discussion_r450771977", "createdAt": "2020-07-07T10:41:47Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/metrics/memory/MetricsLogPublisher.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * The MIT License (MIT)\n+ *\n+ * Copyright (c) 2020 artipie.com\n+ *\n+ * Permission is hereby granted, free of charge, to any person obtaining a copy\n+ * of this software and associated documentation files (the \"Software\"), to deal\n+ * in the Software without restriction, including without limitation the rights\n+ * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n+ * copies of the Software, and to permit persons to whom the Software is\n+ * furnished to do so, subject to the following conditions:\n+ *\n+ * The above copyright notice and this permission notice shall be included\n+ * in all copies or substantial portions of the Software.\n+ *\n+ * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n+ * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n+ * FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE\n+ * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n+ * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n+ * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n+ * SOFTWARE.\n+ */\n+package com.artipie.metrics.memory;\n+\n+import com.jcabi.log.Logger;\n+import java.time.Duration;\n+import java.util.Map;\n+import java.util.TreeMap;\n+import java.util.concurrent.Executors;\n+import java.util.concurrent.TimeUnit;\n+\n+/**\n+ * Periodic publisher of {@link InMemoryMetrics} to log.\n+ *\n+ * @since 0.9\n+ * @todo #231:30min Support gauge publishing in `MetricsLogPublisher`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d198f4e8a4828eff80946f33bb81b98348783d00"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4061a60f4977a1a5dd28cae5fd8218ee93976cb", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/f4061a60f4977a1a5dd28cae5fd8218ee93976cb", "committedDate": "2020-07-07T11:06:48Z", "message": "#231 - Changes by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a499051dc987674cc752eb5e503df852e9ecc9d3", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/a499051dc987674cc752eb5e503df852e9ecc9d3", "committedDate": "2020-07-07T11:07:13Z", "message": "Merge branch 'master' into 231-metrics-log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "79fc7fa60ac707e9d9bfaab407b51e4e289a249a", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/79fc7fa60ac707e9d9bfaab407b51e4e289a249a", "committedDate": "2020-07-07T16:23:08Z", "message": "#231 - Changes by review"}, "afterCommit": {"oid": "a499051dc987674cc752eb5e503df852e9ecc9d3", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/a499051dc987674cc752eb5e503df852e9ecc9d3", "committedDate": "2020-07-07T11:07:13Z", "message": "Merge branch 'master' into 231-metrics-log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MTA2OTgw", "url": "https://github.com/artipie/artipie/pull/268#pullrequestreview-444106980", "createdAt": "2020-07-07T17:31:53Z", "commit": {"oid": "a499051dc987674cc752eb5e503df852e9ecc9d3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed9bcbfd340aa77365e90d8880c6d3cf95834a4", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/1ed9bcbfd340aa77365e90d8880c6d3cf95834a4", "committedDate": "2020-07-08T07:37:56Z", "message": "Merge branch 'master' into 231-metrics-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01a2e6b3ad4f8456ca9739c833eea0c0ab47e62", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/f01a2e6b3ad4f8456ca9739c833eea0c0ab47e62", "committedDate": "2020-07-08T11:07:03Z", "message": "Merge branch 'master' into 231-metrics-log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9e02d65c03cb30aeb3e495ba6871c9e9624813b", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/artipie/commit/e9e02d65c03cb30aeb3e495ba6871c9e9624813b", "committedDate": "2020-07-08T11:36:36Z", "message": "Merge branch 'master' into 231-metrics-log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjU4MTY3", "url": "https://github.com/artipie/artipie/pull/268#pullrequestreview-444658167", "createdAt": "2020-07-08T11:36:59Z", "commit": {"oid": "f01a2e6b3ad4f8456ca9739c833eea0c0ab47e62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f874c17028a89b2338c90f14640f9028d042e6a6", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/artipie/commit/f874c17028a89b2338c90f14640f9028d042e6a6", "committedDate": "2020-07-08T14:53:02Z", "message": "Merge branch 'master' into 231-metrics-log"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3007, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}