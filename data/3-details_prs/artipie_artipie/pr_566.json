{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzOTMxNTA3", "number": 566, "title": "#565 - Artifactory API corrections", "bodyText": "Closes #565\nFixed DeletePermissionSlice and GetPermissionSlice to return 404 if repository does not exist.", "createdAt": "2020-09-10T14:30:51Z", "url": "https://github.com/artipie/artipie/pull/566", "merged": true, "mergeCommit": {"oid": "809862da3870e6e98d0e9de6812dc705fb0ba21e"}, "closed": true, "closedAt": "2020-09-11T11:59:57Z", "author": {"login": "olenagerasimova"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHhrugAH2gAyNDgzOTMxNTA3OjVhOTczMjhkMDkzZmQ3ODQzM2Y2ODMzOGMyMzI0NWZhNDljMDAxOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHxUmKgFqTQ4NjYwNzQ0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a97328d093fd78433f68338c23245fa49c0018d", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/5a97328d093fd78433f68338c23245fa49c0018d", "committedDate": "2020-09-10T14:29:20Z", "message": "#565 - Artifactory API corrections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NTUzMjE1", "url": "https://github.com/artipie/artipie/pull/566#pullrequestreview-486553215", "createdAt": "2020-09-11T07:52:09Z", "commit": {"oid": "5a97328d093fd78433f68338c23245fa49c0018d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzo1MjowOVrOHQSQQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQwNzo1NDo1OVrOHQSWmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzODMzNg==", "bodyText": "@olenagerasimova this variable is useless, we may just put into string", "url": "https://github.com/artipie/artipie/pull/566#discussion_r486838336", "createdAt": "2020-09-11T07:52:09Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/api/artifactory/GetPermissionSliceTest.java", "diffHunk": "@@ -72,6 +72,18 @@ void returnsBadRequestOnInvalidRequest() {\n         );\n     }\n \n+    @Test\n+    void returnsNotFoundIfRepoDoesNotExists() {\n+        final String repo = \"pypi\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a97328d093fd78433f68338c23245fa49c0018d"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjgzOTk2Mw==", "bodyText": "@olenagerasimova we may wrap only the code in opt.map(...) with AsyncResponse and also return RsWithStatus without wrapping it into CompletableFuture in .orElse(...). This will simplify code a little bit", "url": "https://github.com/artipie/artipie/pull/566#discussion_r486839963", "createdAt": "2020-09-11T07:54:59Z", "author": {"login": "olegmoz"}, "path": "src/main/java/com/artipie/api/artifactory/GetPermissionSlice.java", "diffHunk": "@@ -65,12 +70,27 @@ public GetPermissionSlice(final Settings settings) {\n     public Response response(final String line, final Iterable<Map.Entry<String, String>> headers,\n         final Publisher<ByteBuffer> body) {\n         final Optional<String> opt = new FromRqLine(line, FromRqLine.RqPattern.REPO).get();\n-        return opt.<Response>map(\n-            repo -> new AsyncResponse(\n-                new RepoPermissions.FromSettings(this.settings).permissions(repo)\n-                    .thenApply(map -> new RsJson(GetPermissionSlice.response(map, repo)))\n-            )\n-        ).orElse(new RsWithStatus(RsStatus.BAD_REQUEST));\n+        return new AsyncResponse(\n+            opt.map(\n+                repo -> new Unchecked<>(this.settings::storage).value()\n+                    .exists(new Key.From(String.format(\"%s.yaml\", repo))).thenCompose(\n+                        exists -> {\n+                            final CompletionStage<Response> res;\n+                            if (exists) {\n+                                res = new RepoPermissions.FromSettings(this.settings)\n+                                    .permissions(repo).thenApply(\n+                                        perms -> new RsJson(\n+                                            GetPermissionSlice.response(perms, repo)\n+                                        )\n+                                    );\n+                            } else {\n+                                res = CompletableFuture.completedStage(StandardRs.NOT_FOUND);\n+                            }\n+                            return res;\n+                        }\n+                    )\n+            ).orElse(CompletableFuture.completedFuture(new RsWithStatus(RsStatus.BAD_REQUEST)))\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a97328d093fd78433f68338c23245fa49c0018d"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e84c23f62f074d72b3d9ab9ea705e4a6dca07955", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/e84c23f62f074d72b3d9ab9ea705e4a6dca07955", "committedDate": "2020-09-11T08:40:19Z", "message": "#565 - CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NjA3NDQ1", "url": "https://github.com/artipie/artipie/pull/566#pullrequestreview-486607445", "createdAt": "2020-09-11T08:42:33Z", "commit": {"oid": "e84c23f62f074d72b3d9ab9ea705e4a6dca07955"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3550, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}