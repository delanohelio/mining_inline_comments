{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczMDk2MjE5", "number": 501, "title": "#495 - implemented RepoPermissions.FromSettings.permissions() method", "bodyText": "Part of #495\nImplemented RepoPermissions.FromSettings.permissions() method to return repository users and permissions", "createdAt": "2020-08-25T10:14:03Z", "url": "https://github.com/artipie/artipie/pull/501", "merged": true, "mergeCommit": {"oid": "23c9538851c7c68993365793a1f23ec9278a3084"}, "closed": true, "closedAt": "2020-08-25T11:46:08Z", "author": {"login": "olenagerasimova"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCUbGRgH2gAyNDczMDk2MjE5OmNmZjE0NzdjNTdhZGE0MGJkNmZjNWQ3ODJiZWZhZWI4N2Y4NzIxYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCVwSbAFqTQ3NDM5OTc0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cff1477c57ada40bd6fc5d782befaeb87f8721a7", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/cff1477c57ada40bd6fc5d782befaeb87f8721a7", "committedDate": "2020-08-25T10:12:47Z", "message": "#495 - implemented RepoPermissions.FromSettings.permissions() method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MzQ4NDUy", "url": "https://github.com/artipie/artipie/pull/501#pullrequestreview-474348452", "createdAt": "2020-08-25T10:31:58Z", "commit": {"oid": "cff1477c57ada40bd6fc5d782befaeb87f8721a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDozMTo1OFrOHGR7Kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNVQxMDozNToxOVrOHGSB7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0NzE3OQ==", "bodyText": "@olenagerasimova I'd suggest to remove dynamic casting and change return type to <? extends YamlMapping> or specify type param for to method as <YamlMapping>", "url": "https://github.com/artipie/artipie/pull/501#discussion_r476347179", "createdAt": "2020-08-25T10:31:58Z", "author": {"login": "olegmoz"}, "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -110,8 +118,37 @@ public FromSettings(final Settings settings) {\n         }\n \n         @Override\n-        public CompletionStage<Map<String, List<String>>> get(final String repo) {\n-            throw new UnsupportedOperationException(\"To implemented later\");\n+        public CompletionStage<Map<String, List<String>>> permissions(final String repo) {\n+            return this.yaml(new Key.From(String.format(\"%s.yaml\", repo))).thenApply(\n+                yaml -> Optional.ofNullable(yaml.yamlMapping(\"repo\").yamlMapping(\"permissions\"))\n+                .map(\n+                    perms -> {\n+                        final Map<String, List<String>> res = new HashMap<>();\n+                        perms.keys().forEach(\n+                            node -> res.put(\n+                                node.asScalar().value(),\n+                                perms.yamlSequence(node.asScalar().value()).values().stream()\n+                                .map(item -> Scalar.class.cast(item).value())\n+                                    .collect(Collectors.toList())\n+                            )\n+                        );\n+                        return res;\n+                    }\n+                ).orElse(Collections.emptyMap())\n+            );\n+        }\n+\n+        /**\n+         * Credentials as yaml.\n+         * @param key Repo settings key\n+         * @return Completion action with yaml\n+         */\n+        private CompletionStage<YamlMapping> yaml(final Key key) {\n+            return new RxStorageWrapper(this.storage())\n+                .value(key)\n+                .to(ContentAs.YAML)\n+                .to(SingleInterop.get())\n+                .thenApply(yaml -> (YamlMapping) yaml);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cff1477c57ada40bd6fc5d782befaeb87f8721a7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NjM0ODkwOQ==", "bodyText": "@olenagerasimova dynamic casting via Scalar.class.cast(item) could be avoided by using item.asScalar() method", "url": "https://github.com/artipie/artipie/pull/501#discussion_r476348909", "createdAt": "2020-08-25T10:35:19Z", "author": {"login": "olegmoz"}, "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -110,8 +118,37 @@ public FromSettings(final Settings settings) {\n         }\n \n         @Override\n-        public CompletionStage<Map<String, List<String>>> get(final String repo) {\n-            throw new UnsupportedOperationException(\"To implemented later\");\n+        public CompletionStage<Map<String, List<String>>> permissions(final String repo) {\n+            return this.yaml(new Key.From(String.format(\"%s.yaml\", repo))).thenApply(\n+                yaml -> Optional.ofNullable(yaml.yamlMapping(\"repo\").yamlMapping(\"permissions\"))\n+                .map(\n+                    perms -> {\n+                        final Map<String, List<String>> res = new HashMap<>();\n+                        perms.keys().forEach(\n+                            node -> res.put(\n+                                node.asScalar().value(),\n+                                perms.yamlSequence(node.asScalar().value()).values().stream()\n+                                .map(item -> Scalar.class.cast(item).value())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cff1477c57ada40bd6fc5d782befaeb87f8721a7"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8464adda649ac7fc7124fb5f165d93d467f82009", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/8464adda649ac7fc7124fb5f165d93d467f82009", "committedDate": "2020-08-25T11:15:21Z", "message": "#495 - CR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80fd4ce24bd25d799706a6babff3838d3e150552", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/80fd4ce24bd25d799706a6babff3838d3e150552", "committedDate": "2020-08-25T11:18:46Z", "message": "#495 - unused import removed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0faee2d71d68a6f131b3c2b7b1148d9bfd9a4755", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/0faee2d71d68a6f131b3c2b7b1148d9bfd9a4755", "committedDate": "2020-08-25T11:27:41Z", "message": "#495 - CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0Mzk5NzQ5", "url": "https://github.com/artipie/artipie/pull/501#pullrequestreview-474399749", "createdAt": "2020-08-25T11:45:50Z", "commit": {"oid": "0faee2d71d68a6f131b3c2b7b1148d9bfd9a4755"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3503, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}