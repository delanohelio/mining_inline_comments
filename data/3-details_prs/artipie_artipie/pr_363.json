{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMjg3Mjky", "number": 363, "title": "#333 - Multi remote docker proxy support", "bodyText": "Closes #333\nAdded support for multiple remotes for docker proxy repository", "createdAt": "2020-07-20T10:11:22Z", "url": "https://github.com/artipie/artipie/pull/363", "merged": true, "mergeCommit": {"oid": "a1a55f2a16ac707363221ffacaf6f4bfb38a0874"}, "closed": true, "closedAt": "2020-07-21T17:36:32Z", "author": {"login": "olegmoz"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2vAtFABqjM1NjUwODI5MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3JyqcAFqTQ1MjY4MzYwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0292f357b98e0cbdbc4d875acd940e1d2082891f", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/0292f357b98e0cbdbc4d875acd940e1d2082891f", "committedDate": "2020-07-20T10:13:54Z", "message": "#333 - Multi remote docker proxy support"}, "afterCommit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/4c8c65af847a3e88d2f559772645fa712917021f", "committedDate": "2020-07-20T10:27:27Z", "message": "#333 - Multi remote docker proxy support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/4c8c65af847a3e88d2f559772645fa712917021f", "committedDate": "2020-07-20T10:27:27Z", "message": "#333 - Multi remote docker proxy support"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNTg0NDEz", "url": "https://github.com/artipie/artipie/pull/363#pullrequestreview-451584413", "createdAt": "2020-07-20T13:03:48Z", "commit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowMzo0OVrOG0LN7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowNzozN1rOG0LY1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2MjkyNg==", "bodyText": "@olegmoz How about using Optional here?", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457362926", "createdAt": "2020-07-20T13:03:49Z", "author": {"login": "paulodamaso"}, "path": "src/main/java/com/artipie/docker/DockerProxy.java", "diffHunk": "@@ -88,15 +93,51 @@ public Response response(\n      * @return Docker proxy slice.\n      */\n     private Slice delegate() {\n-        final YamlMapping settings = this.cfg.settings()\n-            .orElseThrow(() -> new IllegalStateException(\"Settings not found for Docker proxy\"));\n-        final String host = settings.string(\"host\");\n-        if (host == null) {\n-            throw new IllegalStateException(\"`host` is not specified in settings for Docker proxy\");\n+        final YamlSequence remotes = Optional.ofNullable(\n+            this.cfg.repoConfig().yamlSequence(\"remotes\")\n+        ).orElseThrow(() -> new IllegalStateException(\"`remotes` not found for Docker proxy\"));\n+        final ClientSlices slices = new ClientSlices(this.client);\n+        final Docker proxies = new MultiReadDocker(\n+            StreamSupport.stream(remotes.spliterator(), false).map(\n+                remote -> {\n+                    if (!(remote instanceof YamlMapping)) {\n+                        throw new IllegalStateException(\n+                            \"`remotes` element is not mapping in Docker proxy\"\n+                        );\n+                    }\n+                    final YamlMapping mapping = (YamlMapping) remote;\n+                    return this.proxy(slices, mapping);\n+                }\n+            ).collect(Collectors.toList())\n+        );\n+        final Docker docker = this.cfg.storageOpt()\n+            .<Docker>map(\n+                storage -> {\n+                    final AstoDocker local = new AstoDocker(storage);\n+                    return new ReadWriteDocker(new MultiReadDocker(local, proxies), local);\n+                }\n+            )\n+            .orElse(proxies);\n+        return new DockerSlice(docker);\n+    }\n+\n+    /**\n+     * Create proxy from YAML config.\n+     *\n+     * @param slices HTTP client slices.\n+     * @param mapping YAML config.\n+     * @return Docker proxy.\n+     */\n+    private Docker proxy(final ClientSlices slices, final YamlMapping mapping) {\n+        final String url = mapping.string(\"url\");\n+        if (url == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2NTcxNw==", "bodyText": "@olegmoz I see that this method was just made public, but I think that it would be a good idea to change its message to something like yaml repo config is null or absent; I think that it represents better the error, and it is important now that we have this method public which can be called by anyone since it is public. WDYT?", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457365717", "createdAt": "2020-07-20T13:07:37Z", "author": {"login": "paulodamaso"}, "path": "src/main/java/com/artipie/RepoConfig.java", "diffHunk": "@@ -191,6 +211,15 @@ public Permissions permissions() {\n             .thenApply(yaml -> new RepoConfig(storages, prefix, yaml));\n     }\n \n+    /**\n+     * Repo part of YAML.\n+     *\n+     * @return Async YAML mapping\n+     */\n+    public YamlMapping repoConfig() {\n+        return Objects.requireNonNull(this.yaml.yamlMapping(\"repo\"), \"yaml repo is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f"}, "originalPosition": 48}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "09550edb18c4f303f346ba346e3462537ee6a5aa", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/09550edb18c4f303f346ba346e3462537ee6a5aa", "committedDate": "2020-07-20T16:38:22Z", "message": "#333 - Changes by review"}, "afterCommit": {"oid": "b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "committedDate": "2020-07-20T16:44:14Z", "message": "#333 - Changes by review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5", "committedDate": "2020-07-20T16:44:14Z", "message": "#333 - Changes by review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUxNzkzMDI3", "url": "https://github.com/artipie/artipie/pull/363#pullrequestreview-451793027", "createdAt": "2020-07-20T17:00:09Z", "commit": {"oid": "b293074b4baf1bce55aad2a03a9eaa0bfb63f9a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e8e6226d7aba6bbaae0af08a9cdd72629d8d82e", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/5e8e6226d7aba6bbaae0af08a9cdd72629d8d82e", "committedDate": "2020-07-21T07:58:18Z", "message": "Merge branch 'master' into 333-multi-remote-docker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e574f98871937d126d6cf48f929e8d2c901467eb", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/e574f98871937d126d6cf48f929e8d2c901467eb", "committedDate": "2020-07-21T15:58:25Z", "message": "Merge branch 'master' into 333-multi-remote-docker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNjgzNjAw", "url": "https://github.com/artipie/artipie/pull/363#pullrequestreview-452683600", "createdAt": "2020-07-21T17:36:24Z", "commit": {"oid": "e574f98871937d126d6cf48f929e8d2c901467eb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3069, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}