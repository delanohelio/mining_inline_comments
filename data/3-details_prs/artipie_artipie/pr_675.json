{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5ODk3NDU0", "number": 675, "title": "#602 - Verify install nugetIT", "bodyText": "Part of #602\nVerify that installing pushed package with enable authentication is working.", "createdAt": "2020-10-08T12:48:08Z", "url": "https://github.com/artipie/artipie/pull/675", "merged": true, "mergeCommit": {"oid": "fa7957a6f55fd53de2136c349707fcb8c895491c"}, "closed": true, "closedAt": "2020-10-09T07:54:32Z", "author": {"login": "genryxy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQgpIrgH2gAyNDk5ODk3NDU0OjcyMzI3ZmY3YmE0MmYwOWJjZGRlYzdkOGJlYjIyZWY4NjU1MWNlZTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQxAvjgFqTUwNTQyMzA1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72327ff7ba42f09bcddec7d8beb22ef86551cee8", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/72327ff7ba42f09bcddec7d8beb22ef86551cee8", "committedDate": "2020-10-08T12:21:55Z", "message": "#602 - Verify install for nugetIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8eaee8b781f6ff224616b8be0104320e6df503", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/9a8eaee8b781f6ff224616b8be0104320e6df503", "committedDate": "2020-10-08T12:40:36Z", "message": "#602 - Disable nuget.org"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/ad71f9c92466c1962ba4bf8b5692869c983d46b2", "committedDate": "2020-10-08T12:52:16Z", "message": "#602 - Remove apikey"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NzY5ODgy", "url": "https://github.com/artipie/artipie/pull/675#pullrequestreview-504769882", "createdAt": "2020-10-08T13:16:18Z", "commit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzoxNjoxOFrOHeeBTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzoyOTowMFrOHeemaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMTE4Mg==", "bodyText": "@genryxy this.url field is initialized only after this.config() method call. But it is used inside config() method. Not sure how this test works.", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501711182", "createdAt": "2020-10-08T13:16:18Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -69,16 +71,22 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * Artipie server port.\n+     * URL 'http://host:port/my-nuget'.\n      */\n-    private int port;\n+    private String url;\n+\n+    /**\n+     * Package name in the temporary directory.\n+     */\n+    private String pckg;\n \n     @BeforeEach\n     void init() throws Exception {\n         final String name = \"my-nuget\";\n         this.server = new ArtipieServer(this.tmp, name, this.config());\n-        this.port = this.server.start();\n-        Testcontainers.exposeHostPorts(this.port);\n+        final int port = this.server.start();\n+        this.url = String.format(\"http://host.testcontainers.internal:%d/my-nuget\", port);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxMjg2OA==", "bodyText": "@genryxy value for this field is always \"newtonsoft.json\", so this field should not be mutable. Please replace it with constant", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501712868", "createdAt": "2020-10-08T13:18:26Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -69,16 +71,22 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * Artipie server port.\n+     * URL 'http://host:port/my-nuget'.\n      */\n-    private int port;\n+    private String url;\n+\n+    /**\n+     * Package name in the temporary directory.\n+     */\n+    private String pckg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxNDA1OQ==", "bodyText": "@genryxy I think we may move this warning to class level, as both test methods in this class have @Timeout annotations", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501714059", "createdAt": "2020-10-08T13:19:59Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -106,10 +114,28 @@ void shouldPushPackage() throws Exception {\n         );\n     }\n \n-    private void createNugetConfig() throws Exception {\n-        final String url = String.format(\n-            \"http://host.testcontainers.internal:%d/my-nuget\", this.port\n+    // @checkstyle MagicNumberCheck (2 lines)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcxNjY5Mw==", "bodyText": "@genryxy here we specify URL for \"artipie-nuget-test\" alias. But I am not sure we are actually using it anywhere, can't we just remove this <packageSources> section?", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501716693", "createdAt": "2020-10-08T13:23:32Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -118,8 +144,14 @@ private void createNugetConfig() throws Exception {\n                 \"<?xml version=\\\"1.0\\\" encoding=\\\"utf-8\\\"?>\\n\",\n                 \"<configuration>\",\n                 \"<packageSources>\",\n-                String.format(\"<add key=\\\"%s\\\" value=\\\"%s\\\"/>\", source, url),\n+                String.format(\n+                    \"<add key=\\\"%s\\\" value=\\\"%s\\\"/>\",\n+                    source, String.format(\"%s/index.json\", this.url)\n+                ),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcyMDY4Mw==", "bodyText": "@genryxy file name you pass to nuget push command does not matter. NuGet repository extracts package name from it's content. So I'd suggest to keep using UUID.randomUUID().toString() for filename same as it was", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501720683", "createdAt": "2020-10-08T13:29:00Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -139,15 +169,14 @@ private String exec(final String... command) throws Exception {\n     }\n \n     private String pushPackage() throws Exception {\n-        final String uri = \"http://host.testcontainers.internal:%d/my-nuget/index.json\";\n-        final String pckg = UUID.randomUUID().toString();\n+        this.pckg = \"newtonsoft.json\";\n         Files.write(\n-            this.tmp.resolve(pckg),\n+            this.tmp.resolve(this.pckg),\n             new NewtonJsonResource(\"newtonsoft.json.12.0.3.nupkg\").bytes()\n         );\n         return this.exec(\n-            \"dotnet\", \"nuget\", \"push\", pckg, \"--api-key\", \"this.source\",\n-            \"-s\", String.format(uri, this.port)\n+            \"dotnet\", \"nuget\", \"push\", this.pckg,\n+            \"-s\", String.format(\"%s/index.json\", this.url)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad71f9c92466c1962ba4bf8b5692869c983d46b2"}, "originalPosition": 122}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad42bc9c2352e4856150982c4d216cc90e9d9663", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/ad42bc9c2352e4856150982c4d216cc90e9d9663", "committedDate": "2020-10-08T13:52:55Z", "message": "#602 - CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODU1MTAy", "url": "https://github.com/artipie/artipie/pull/675#pullrequestreview-504855102", "createdAt": "2020-10-08T14:38:48Z", "commit": {"oid": "ad42bc9c2352e4856150982c4d216cc90e9d9663"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e483efe645b999efbee02b7ad3a5e0b40975ca9", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/8e483efe645b999efbee02b7ad3a5e0b40975ca9", "committedDate": "2020-10-08T14:51:04Z", "message": "#602 - Get free local port"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0OTAwODU0", "url": "https://github.com/artipie/artipie/pull/675#pullrequestreview-504900854", "createdAt": "2020-10-08T15:23:11Z", "commit": {"oid": "8e483efe645b999efbee02b7ad3a5e0b40975ca9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNToyMzoxMVrOHej93w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNToyMzoxMVrOHej93w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTgwODYwNw==", "bodyText": "@genryxy here you are using found free port to put it into config. What I meant is to get the port and start ArtipieServer on it. This way you will have correct port in config from the start and will not need to overwrite config later", "url": "https://github.com/artipie/artipie/pull/675#discussion_r501808607", "createdAt": "2020-10-08T15:23:11Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/nuget/NugetITCase.java", "diffHunk": "@@ -73,17 +79,19 @@\n     private GenericContainer<?> cntn;\n \n     /**\n-     * URL 'http://host:port/my-nuget'.\n+     * Server port.\n      */\n-    private String url;\n+    private int port;\n \n     @BeforeEach\n     void init() throws Exception {\n         final String name = \"my-nuget\";\n-        this.server = new ArtipieServer(this.tmp, name, this.config());\n-        final int port = this.server.start();\n-        this.url = String.format(\"http://host.testcontainers.internal:%d/my-nuget\", port);\n-        Testcontainers.exposeHostPorts(port);\n+        try (ServerSocket socket = new ServerSocket(0)) {\n+            this.port = socket.getLocalPort();\n+            this.server = new ArtipieServer(this.tmp, name, this.config());\n+        }\n+        this.port = this.server.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e483efe645b999efbee02b7ad3a5e0b40975ca9"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dfa27784a3eed5a3e7511d8d9062c5068060d2c", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/9dfa27784a3eed5a3e7511d8d9062c5068060d2c", "committedDate": "2020-10-09T05:58:48Z", "message": "#602 - Add todo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be71084733f53e0f06e28d1dc0c567508062cf9", "author": {"user": {"login": "genryxy", "name": "Alexander"}}, "url": "https://github.com/artipie/artipie/commit/2be71084733f53e0f06e28d1dc0c567508062cf9", "committedDate": "2020-10-09T06:01:11Z", "message": "Merge remote-tracking branch 'upstream/master' into 602-installNugetIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDIzMDUw", "url": "https://github.com/artipie/artipie/pull/675#pullrequestreview-505423050", "createdAt": "2020-10-09T07:26:11Z", "commit": {"oid": "2be71084733f53e0f06e28d1dc0c567508062cf9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3414, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}