{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzMjg3Mjky", "number": 363, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowMzo0OFrOEQKo7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowNzozN1rOEQKwgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mzg2OTkxOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/docker/DockerProxy.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowMzo0OVrOG0LN7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowMzo0OVrOG0LN7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2MjkyNg==", "bodyText": "@olegmoz How about using Optional here?", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457362926", "createdAt": "2020-07-20T13:03:49Z", "author": {"login": "paulodamaso"}, "path": "src/main/java/com/artipie/docker/DockerProxy.java", "diffHunk": "@@ -88,15 +93,51 @@ public Response response(\n      * @return Docker proxy slice.\n      */\n     private Slice delegate() {\n-        final YamlMapping settings = this.cfg.settings()\n-            .orElseThrow(() -> new IllegalStateException(\"Settings not found for Docker proxy\"));\n-        final String host = settings.string(\"host\");\n-        if (host == null) {\n-            throw new IllegalStateException(\"`host` is not specified in settings for Docker proxy\");\n+        final YamlSequence remotes = Optional.ofNullable(\n+            this.cfg.repoConfig().yamlSequence(\"remotes\")\n+        ).orElseThrow(() -> new IllegalStateException(\"`remotes` not found for Docker proxy\"));\n+        final ClientSlices slices = new ClientSlices(this.client);\n+        final Docker proxies = new MultiReadDocker(\n+            StreamSupport.stream(remotes.spliterator(), false).map(\n+                remote -> {\n+                    if (!(remote instanceof YamlMapping)) {\n+                        throw new IllegalStateException(\n+                            \"`remotes` element is not mapping in Docker proxy\"\n+                        );\n+                    }\n+                    final YamlMapping mapping = (YamlMapping) remote;\n+                    return this.proxy(slices, mapping);\n+                }\n+            ).collect(Collectors.toList())\n+        );\n+        final Docker docker = this.cfg.storageOpt()\n+            .<Docker>map(\n+                storage -> {\n+                    final AstoDocker local = new AstoDocker(storage);\n+                    return new ReadWriteDocker(new MultiReadDocker(local, proxies), local);\n+                }\n+            )\n+            .orElse(proxies);\n+        return new DockerSlice(docker);\n+    }\n+\n+    /**\n+     * Create proxy from YAML config.\n+     *\n+     * @param slices HTTP client slices.\n+     * @param mapping YAML config.\n+     * @return Docker proxy.\n+     */\n+    private Docker proxy(final ClientSlices slices, final YamlMapping mapping) {\n+        final String url = mapping.string(\"url\");\n+        if (url == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mzg4OTMwOnYy", "diffSide": "RIGHT", "path": "src/main/java/com/artipie/RepoConfig.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowNzozN1rOG0LY1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowNzozN1rOG0LY1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2NTcxNw==", "bodyText": "@olegmoz I see that this method was just made public, but I think that it would be a good idea to change its message to something like yaml repo config is null or absent; I think that it represents better the error, and it is important now that we have this method public which can be called by anyone since it is public. WDYT?", "url": "https://github.com/artipie/artipie/pull/363#discussion_r457365717", "createdAt": "2020-07-20T13:07:37Z", "author": {"login": "paulodamaso"}, "path": "src/main/java/com/artipie/RepoConfig.java", "diffHunk": "@@ -191,6 +211,15 @@ public Permissions permissions() {\n             .thenApply(yaml -> new RepoConfig(storages, prefix, yaml));\n     }\n \n+    /**\n+     * Repo part of YAML.\n+     *\n+     * @return Async YAML mapping\n+     */\n+    public YamlMapping repoConfig() {\n+        return Objects.requireNonNull(this.yaml.yamlMapping(\"repo\"), \"yaml repo is null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c8c65af847a3e88d2f559772645fa712917021f"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2279, "cost": 1, "resetAt": "2021-11-12T09:44:50Z"}}}