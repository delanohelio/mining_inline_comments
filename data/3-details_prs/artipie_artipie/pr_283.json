{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDU4NDc3", "number": 283, "title": "#231 - Reporting unauthorized responses in ResponseMetricsSlice", "bodyText": "Part of #231\nCollecting metrics for unauthorized responses in ResponseMetricsSlice", "createdAt": "2020-07-08T07:43:52Z", "url": "https://github.com/artipie/artipie/pull/283", "merged": true, "mergeCommit": {"oid": "3635471e98a4cd15df06e14b2eddceb83f43ea57"}, "closed": true, "closedAt": "2020-07-08T15:05:41Z", "author": {"login": "olegmoz"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy4cyCgBqjM1MjQ2ODI5MjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy5wnRgH2gAyNDQ2MDU4NDc3OjlhMjIwZjAzMTRiYjE0NjRiYjM3NzgzZjc4MGYwYzA1NTRkYjNkYzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e46431a625fddf882c6b7cc77e689260fb42ace4", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/e46431a625fddf882c6b7cc77e689260fb42ace4", "committedDate": "2020-07-07T17:31:11Z", "message": "#231 - Reporting unauthorized responses in ResponseMetricsSlice"}, "afterCommit": {"oid": "148f6b43917218232530037b721ccc0333ca94a6", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/148f6b43917218232530037b721ccc0333ca94a6", "committedDate": "2020-07-08T11:11:10Z", "message": "#231 - Reporting unauthorized responses in ResponseMetricsSlice"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "148f6b43917218232530037b721ccc0333ca94a6", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/148f6b43917218232530037b721ccc0333ca94a6", "committedDate": "2020-07-08T11:11:10Z", "message": "#231 - Reporting unauthorized responses in ResponseMetricsSlice"}, "afterCommit": {"oid": "0a3c609c8dbb91a846bd055988224d80d1825f52", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/0a3c609c8dbb91a846bd055988224d80d1825f52", "committedDate": "2020-07-08T12:07:40Z", "message": "#231 - Reporting unauthorized responses in ResponseMetricsSlice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a3c609c8dbb91a846bd055988224d80d1825f52", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/0a3c609c8dbb91a846bd055988224d80d1825f52", "committedDate": "2020-07-08T12:07:40Z", "message": "#231 - Reporting unauthorized responses in ResponseMetricsSlice"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzA1Njc4", "url": "https://github.com/artipie/artipie/pull/283#pullrequestreview-444705678", "createdAt": "2020-07-08T12:16:50Z", "commit": {"oid": "0a3c609c8dbb91a846bd055988224d80d1825f52"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMjoxNjo1MVrOGulTNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMjoyMDo0OFrOGule-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ5ODgwNg==", "bodyText": "@olegmoz what do you think that we extract this check to a new method RsStatus.isError() or to some wrapper class to avoid code duplication through the codebase.", "url": "https://github.com/artipie/artipie/pull/283#discussion_r451498806", "createdAt": "2020-07-08T12:16:51Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/ResponseMetricsSlice.java", "diffHunk": "@@ -87,16 +89,41 @@ public Response response(\n      * Report response to metrics.\n      *\n      * @param rqline Request line.\n+     * @param rqheaders Request headers.\n      * @param rsstatus Response status.\n      */\n-    private void report(final String rqline, final RsStatus rsstatus) {\n+    private void report(\n+        final String rqline,\n+        final Iterable<Map.Entry<String, String>> rqheaders,\n+        final RsStatus rsstatus\n+    ) {\n         if (rsstatus.code().matches(\"^[45].+$\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a3c609c8dbb91a846bd055988224d80d1825f52"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUwMTgxNw==", "bodyText": "@olegmoz how about creating new RqHeaders(rqheaders).contains(header) ? This would be more readable", "url": "https://github.com/artipie/artipie/pull/283#discussion_r451501817", "createdAt": "2020-07-08T12:20:48Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/ResponseMetricsSlice.java", "diffHunk": "@@ -87,16 +89,41 @@ public Response response(\n      * Report response to metrics.\n      *\n      * @param rqline Request line.\n+     * @param rqheaders Request headers.\n      * @param rsstatus Response status.\n      */\n-    private void report(final String rqline, final RsStatus rsstatus) {\n+    private void report(\n+        final String rqline,\n+        final Iterable<Map.Entry<String, String>> rqheaders,\n+        final RsStatus rsstatus\n+    ) {\n         if (rsstatus.code().matches(\"^[45].+$\")) {\n             this.report(rqline, \"error\");\n+            if (rsstatus.equals(RsStatus.UNAUTHORIZED)) {\n+                this.reportUnauthorized(rqline, rqheaders);\n+            }\n         } else {\n             this.report(rqline, \"success\");\n         }\n     }\n \n+    /**\n+     * Report unauthorized response to metrics.\n+     *\n+     * @param rqline Request line.\n+     * @param rqheaders Request headers.\n+     */\n+    private void reportUnauthorized(\n+        final String rqline,\n+        final Iterable<Map.Entry<String, String>> rqheaders\n+    ) {\n+        if (new RqHeaders(rqheaders, Authorization.NAME).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a3c609c8dbb91a846bd055988224d80d1825f52"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a220f0314bb1464bb37783f780f0c0554db3dc0", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/9a220f0314bb1464bb37783f780f0c0554db3dc0", "committedDate": "2020-07-08T12:39:59Z", "message": "#231 - Changes by review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3028, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}