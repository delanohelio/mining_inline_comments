{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxNDczNTY2", "number": 165, "title": "Implemented AuthFromYaml for #146", "bodyText": "For #146 implemented AuthFromYaml and added todo to continue.", "createdAt": "2020-05-21T17:12:38Z", "url": "https://github.com/artipie/artipie/pull/165", "merged": true, "mergeCommit": {"oid": "6db40e12891a5b35e55d26f0779466beffc03b42"}, "closed": true, "closedAt": "2020-05-22T12:56:02Z", "author": {"login": "olenagerasimova"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjg4HMgH2gAyNDIxNDczNTY2OmMzYTY3OWVlZjNiMmE0NDRiM2E3NzVkZmE4OWE5NjgxN2VlZGU3Mjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjx0S5AFqTQxNjg4NzY5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/c3a679eef3b2a444b3a775dfa89a96817eede729", "committedDate": "2020-05-21T17:11:41Z", "message": "Implemented AuthFromYaml for #146"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NzEyOTY0", "url": "https://github.com/artipie/artipie/pull/165#pullrequestreview-416712964", "createdAt": "2020-05-22T07:46:47Z", "commit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNzo0Njo0N1rOGZN18w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwODo0MDoyOVrOGZPWgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5NDM4Nw==", "bodyText": "@olenagerasimova most probably we will need to parse data from Publisher to read authentication config, if so, we have to return CompletionStage<List<>> here instead of List<>", "url": "https://github.com/artipie/artipie/pull/165#discussion_r429094387", "createdAt": "2020-05-22T07:46:47Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/Settings.java", "diffHunk": "@@ -39,4 +41,12 @@\n      * @throws IOException In case of problems with reading settings.\n      */\n     Storage storage() throws IOException;\n+\n+    /**\n+     * Provides authorization.\n+     *\n+     * @return Authentication instance\n+     * @throws IOException In case of problems with reading settings.\n+     */\n+    List<Authentication> auth() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA5NTQyOA==", "bodyText": "@olenagerasimova I'd also make credentials.type to be required and either be env or file, so AuthFromEnv will be enabled only when type == env", "url": "https://github.com/artipie/artipie/pull/165#discussion_r429095428", "createdAt": "2020-05-22T07:48:53Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/YamlSettings.java", "diffHunk": "@@ -65,4 +68,20 @@ public Storage storage() throws IOException {\n                 this.vertx\n         ).storage();\n     }\n+\n+    @Override\n+    public List<Authentication> auth() throws IOException {\n+        //@checkstyle MethodBodyCommentsCheck (11 lines)\n+        // @todo #146:30min Implement this method to obtain authentications: for now\n+        //  we have AuthFromEnv, which is always available and should be active by default, and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExODcxMQ==", "bodyText": "@olenagerasimova I think this name doesn't describe this method correctly according to javadocs", "url": "https://github.com/artipie/artipie/pull/165#discussion_r429118711", "createdAt": "2020-05-22T08:39:41Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/auth/AuthFromYaml.java", "diffHunk": "@@ -52,12 +56,38 @@\n      * Ctor.\n      * @param cred Credentials settings\n      */\n-    public YamlAuth(final YamlMapping cred) {\n+    public AuthFromYaml(final YamlMapping cred) {\n         this.cred = cred;\n     }\n \n     @Override\n     public Optional<String> user(final String user, final String pass) {\n-        throw new NotImplementedException(\"Not yet implemented\");\n+        final YamlMapping users = this.cred.yamlMapping(\"credentials\");\n+        Optional<String> res = Optional.empty();\n+        if (users != null && users.yamlMapping(user) != null) {\n+            final String stored = users.yamlMapping(user).string(\"pass\");\n+            if (stored != null && check(stored, pass)) {\n+                res = Optional.of(user);\n+            }\n+        }\n+        return res;\n+    }\n+\n+    /**\n+     * Obtains password from settings by username.\n+     * @param stored Password from settings\n+     * @param given Password to check\n+     * @return Password if present and properly formatted\n+     */\n+    private static boolean check(final String stored, final String given) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTExOTEwNQ==", "bodyText": "@olenagerasimova why find instead of match? match checks the whole string, but find only first match", "url": "https://github.com/artipie/artipie/pull/165#discussion_r429119105", "createdAt": "2020-05-22T08:40:29Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/auth/AuthFromYaml.java", "diffHunk": "@@ -52,12 +56,38 @@\n      * Ctor.\n      * @param cred Credentials settings\n      */\n-    public YamlAuth(final YamlMapping cred) {\n+    public AuthFromYaml(final YamlMapping cred) {\n         this.cred = cred;\n     }\n \n     @Override\n     public Optional<String> user(final String user, final String pass) {\n-        throw new NotImplementedException(\"Not yet implemented\");\n+        final YamlMapping users = this.cred.yamlMapping(\"credentials\");\n+        Optional<String> res = Optional.empty();\n+        if (users != null && users.yamlMapping(user) != null) {\n+            final String stored = users.yamlMapping(user).string(\"pass\");\n+            if (stored != null && check(stored, pass)) {\n+                res = Optional.of(user);\n+            }\n+        }\n+        return res;\n+    }\n+\n+    /**\n+     * Obtains password from settings by username.\n+     * @param stored Password from settings\n+     * @param given Password to check\n+     * @return Password if present and properly formatted\n+     */\n+    private static boolean check(final String stored, final String given) {\n+        boolean res = false;\n+        final Matcher matcher = AuthFromYaml.PSWD.matcher(stored);\n+        if (matcher.find()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a679eef3b2a444b3a775dfa89a96817eede729"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22c1f2a2af011f92b9cf655a34dbed88e198bdf2", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/22c1f2a2af011f92b9cf655a34dbed88e198bdf2", "committedDate": "2020-05-22T09:38:26Z", "message": "CR #146"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9fdb4562656eb506df68db51cf4098098188804", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/a9fdb4562656eb506df68db51cf4098098188804", "committedDate": "2020-05-22T09:40:39Z", "message": "Merge branch 'master' of https://github.com/artipie/artipie into 146-auth-from-yaml-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc0391e7485ce1654e6535e64f85edc765e5ca7", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/fdc0391e7485ce1654e6535e64f85edc765e5ca7", "committedDate": "2020-05-22T12:45:20Z", "message": "Merge branch 'master' of https://github.com/artipie/artipie into 146-auth-from-yaml-impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "001ae2940d7d2e373659b4062df5ff5c025d40e8", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/001ae2940d7d2e373659b4062df5ff5c025d40e8", "committedDate": "2020-05-22T12:45:45Z", "message": "puzzle formatting corrected #146"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2ODg3Njkw", "url": "https://github.com/artipie/artipie/pull/165#pullrequestreview-416887690", "createdAt": "2020-05-22T12:55:54Z", "commit": {"oid": "001ae2940d7d2e373659b4062df5ff5c025d40e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3191, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}