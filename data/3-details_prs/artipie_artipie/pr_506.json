{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczNjc4NDU0", "number": 506, "title": "#494 - RepoPermissions.FromSettings fully implemented", "bodyText": "Part of #494 and #497\nArtifactory method PUT /api/security/permissions/{target} request body json contains users and permissions in the following format\n...\n\"users\" : {\n  \"bob\": [\"read\",\"write\",\"manage\"],\n  \"alice\" : [\"write\",\"annotate\", \"read\"]\n}\n...\n\nSo, I've\n\nintroduced UserPermission class and changed RepoPermissions#addUpdate and RepoPermissions#permissions signature\nimplemented and tested RepoPermissions#addUpdate\nimplemented RepoPermissions#remove as it's part of RepoPermissions#addUpdate", "createdAt": "2020-08-26T06:22:44Z", "url": "https://github.com/artipie/artipie/pull/506", "merged": true, "mergeCommit": {"oid": "f6c5fd42b74b30596a2f066b0c152d24b2bf590d"}, "closed": true, "closedAt": "2020-08-26T09:23:56Z", "author": {"login": "olenagerasimova"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCloboAH2gAyNDczNjc4NDU0OjBlMjVjNGEwMWJkZjJkOGVkYTdlMmMwN2Y2MmQzZDY4MmFkNzk4NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCoUNxAFqTQ3NTMxMDY1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849", "committedDate": "2020-08-26T06:15:44Z", "message": "#494 - RepoPermissions.FromSettings fully implemented"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MjY1MDYz", "url": "https://github.com/artipie/artipie/pull/506#pullrequestreview-475265063", "createdAt": "2020-08-26T08:27:07Z", "commit": {"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwODoyNzowN1rOHHBcWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQwODozODo1MFrOHHB5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEyNTcyMg==", "bodyText": "@olenagerasimova I am concerned about List<UserPermission>. It makes one think that users are ordered and order does matter. I do not think that this is the case and would suggest to change it to Collection. Same goes for permissions method return value", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477125722", "createdAt": "2020-08-26T08:27:07Z", "author": {"login": "olegmoz"}, "path": "src/main/java/com/artipie/RepoPermissions.java", "diffHunk": "@@ -61,25 +67,34 @@\n     /**\n      * Adds or updates repository permission.\n      * @param repo Repository name\n-     * @param username Username\n-     * @param permission Permission name\n+     * @param permissions Permissions list\n      * @return Completion action\n      */\n-    CompletionStage<Void> addUpdate(String repo, String username, String permission);\n+    CompletionStage<Void> addUpdate(String repo, List<UserPermission> permissions);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEzMjA0NQ==", "bodyText": "@olenagerasimova I think we miss the case when user has some permissions and we update the user by adding more permissions or removing some permissions", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477132045", "createdAt": "2020-08-26T08:37:04Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/RepoPermissionsFromSettingsTest.java", "diffHunk": "@@ -103,6 +110,88 @@ void returnsEmptyMapWhenPermissionsAreNotSet() {\n         );\n     }\n \n+    @Test\n+    void updatesUserPermissions() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzEzMzExMg==", "bodyText": "@olenagerasimova this test will pass if remove method just clears all repositories. May we check that other repos stay intact after removing a repo?", "url": "https://github.com/artipie/artipie/pull/506#discussion_r477133112", "createdAt": "2020-08-26T08:38:50Z", "author": {"login": "olegmoz"}, "path": "src/test/java/com/artipie/RepoPermissionsFromSettingsTest.java", "diffHunk": "@@ -103,6 +110,88 @@ void returnsEmptyMapWhenPermissionsAreNotSet() {\n         );\n     }\n \n+    @Test\n+    void updatesUserPermissions() throws IOException {\n+        final String repo = \"rpm\";\n+        this.addSettings(\n+            repo,\n+            new MapOf<String, List<String>>(\n+                new MapEntry<>(\"david\", new ListOf<String>(\"add\", \"update\"))\n+            )\n+        );\n+        final String olga = \"olga\";\n+        final String victor = \"victor\";\n+        final String download = \"download\";\n+        final String deploy = \"deploy\";\n+        new RepoPermissions.FromSettings(new Settings.Fake(this.storage))\n+            .addUpdate(\n+                repo,\n+                new ListOf<>(\n+                    new RepoPermissions.UserPermission(olga, new ListOf<>(download, deploy)),\n+                    new RepoPermissions.UserPermission(victor, new ListOf<>(deploy))\n+                )\n+            ).toCompletableFuture().join();\n+        MatcherAssert.assertThat(\n+            \"Added permissions for olga\",\n+            this.permissionsForUser(repo, olga),\n+            Matchers.contains(download, deploy)\n+        );\n+        MatcherAssert.assertThat(\n+            \"Added permissions for victor\",\n+            this.permissionsForUser(repo, victor),\n+            Matchers.contains(deploy)\n+        );\n+    }\n+\n+    @Test\n+    void addsUserPermissionWhenOriginalPermissionsAreNotSet() throws IOException {\n+        final String repo = \"go\";\n+        this.addEmpty(repo);\n+        final String ann = \"ann\";\n+        final String download = \"download\";\n+        new RepoPermissions.FromSettings(new Settings.Fake(this.storage))\n+            .addUpdate(\n+                repo,\n+                new ListOf<>(new RepoPermissions.UserPermission(ann, new ListOf<>(download)))\n+            )\n+            .toCompletableFuture().join();\n+        MatcherAssert.assertThat(\n+            this.permissionsForUser(repo, ann),\n+            Matchers.contains(download)\n+        );\n+    }\n+\n+    @Test\n+    void deletesPermissionSection() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e25c4a01bdf2d8eda7e2c07f62d3d682ad79849"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6942b6a5b040eeb1f319bbc6d0110ddc8cb32518", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/6942b6a5b040eeb1f319bbc6d0110ddc8cb32518", "committedDate": "2020-08-26T09:13:52Z", "message": "#494 - CR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e23f129e15651ba00bc62bc0783464e7105b2d7c", "author": {"user": {"login": "olenagerasimova", "name": "Alena"}}, "url": "https://github.com/artipie/artipie/commit/e23f129e15651ba00bc62bc0783464e7105b2d7c", "committedDate": "2020-08-26T09:17:41Z", "message": "Merge branch 'master' of https://github.com/artipie/artipie into 494-repo-permissions-impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1MzEwNjU2", "url": "https://github.com/artipie/artipie/pull/506#pullrequestreview-475310656", "createdAt": "2020-08-26T09:23:22Z", "commit": {"oid": "e23f129e15651ba00bc62bc0783464e7105b2d7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3510, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}