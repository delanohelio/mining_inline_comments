{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MDU1NDA3", "number": 281, "title": "#250 - Support for caching Docker proxy", "bodyText": "Closes #250\nAdded support for caching to docker-proxy repo type", "createdAt": "2020-07-08T07:37:23Z", "url": "https://github.com/artipie/artipie/pull/281", "merged": true, "mergeCommit": {"oid": "99eb408bf25206b99d16a2429e2c2714116ed702"}, "closed": true, "closedAt": "2020-07-08T15:05:24Z", "author": {"login": "olegmoz"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcy1e-lABqjM1MjM4OTEzNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy7vrHAH2gAyNDQ2MDU1NDA3OmE5MDYyZTVlNGQ2NjA5ZmRkNGFhYzc3NDM5Zjc3OThiNzdlYzA2YjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7e5e93dbb1974cded6c1c4706a2077d3f4dbffb", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/a7e5e93dbb1974cded6c1c4706a2077d3f4dbffb", "committedDate": "2020-07-08T07:39:25Z", "message": "#250 - Support for caching Docker proxy"}, "afterCommit": {"oid": "16a7519addea5275728ff1a2356c997c510b937f", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/16a7519addea5275728ff1a2356c997c510b937f", "committedDate": "2020-07-08T07:43:43Z", "message": "#250 - Support for caching Docker proxy"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16a7519addea5275728ff1a2356c997c510b937f", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/16a7519addea5275728ff1a2356c997c510b937f", "committedDate": "2020-07-08T07:43:43Z", "message": "#250 - Support for caching Docker proxy"}, "afterCommit": {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/686a97a7741920bdf392830642ffb9a016d1fa2d", "committedDate": "2020-07-08T07:56:13Z", "message": "#250 - Support for caching Docker proxy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/686a97a7741920bdf392830642ffb9a016d1fa2d", "committedDate": "2020-07-08T07:56:13Z", "message": "#250 - Support for caching Docker proxy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTUxMDMw", "url": "https://github.com/artipie/artipie/pull/281#pullrequestreview-444551030", "createdAt": "2020-07-08T09:03:53Z", "commit": {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwOTowMzo1M1rOGue7Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwOTowMzo1M1rOGue7Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5NDMwNg==", "bodyText": "@olegmoz can we add a test for this?", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451394306", "createdAt": "2020-07-08T09:03:53Z", "author": {"login": "Vatavuk"}, "path": "src/main/java/com/artipie/SliceFromConfig.java", "diffHunk": "@@ -243,10 +245,11 @@ static Slice build(final Settings settings, final Authentication auth,\n                 final String host = cfg.settings()\n                     .orElseThrow(() -> new IllegalStateException(\"Repo settings not found\"))\n                     .string(\"host\");\n-                slice = new DockerSlice(\n-                    cfg.path(),\n-                    new ProxyDocker(new ClientSlice(SliceFromConfig.HTTP, host))\n-                );\n+                final Docker proxy = new ProxyDocker(new ClientSlice(SliceFromConfig.HTTP, host));\n+                final Docker docker = cfg.storageOpt()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NzAxMjEy", "url": "https://github.com/artipie/artipie/pull/281#pullrequestreview-444701212", "createdAt": "2020-07-08T12:10:44Z", "commit": {"oid": "686a97a7741920bdf392830642ffb9a016d1fa2d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b", "author": {"user": {"login": "olegmoz", "name": "Oleg Mozzhechkov"}}, "url": "https://github.com/artipie/artipie/commit/79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b", "committedDate": "2020-07-08T12:11:26Z", "message": "Merge branch 'master' into 250-docker-proxy-cache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0ODAxMTUz", "url": "https://github.com/artipie/artipie/pull/281#pullrequestreview-444801153", "createdAt": "2020-07-08T14:06:33Z", "commit": {"oid": "79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDowNjozM1rOGupyCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNDowNjozM1rOGupyCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTU3MjIzNQ==", "bodyText": "@olegmoz I think we can replace storage() with this implementation and just call storage().orElseThrow() to get storage where it's required", "url": "https://github.com/artipie/artipie/pull/281#discussion_r451572235", "createdAt": "2020-07-08T14:06:33Z", "author": {"login": "g4s8"}, "path": "src/main/java/com/artipie/RepoConfig.java", "diffHunk": "@@ -128,17 +128,32 @@ public URL url() {\n      * @return Async storage for repo\n      */\n     public Storage storage() {\n-        final YamlMapping repo = this.repoConfig();\n-        final Storage storage;\n-        final YamlNode node = repo.value(\"storage\");\n-        if (node instanceof Scalar) {\n-            storage = this.storages.storage(((Scalar) node).value());\n-        } else if (node instanceof YamlMapping) {\n-            storage = new YamlStorage((YamlMapping) node).storage();\n-        } else {\n-            throw new IllegalStateException(String.format(\"Invalid storage config: %s\", node));\n-        }\n-        return new SubStorage(this.prefix, new LoggingStorage(Level.INFO, storage));\n+        return this.storageOpt().orElseThrow(\n+            () -> new IllegalStateException(\"Storage is not configured\")\n+        );\n+    }\n+\n+    /**\n+     * Create storage if configured.\n+     *\n+     * @return Async storage for repo\n+     */\n+    public Optional<Storage> storageOpt() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79c4f9f60269f5fdd5372be7276ff0c9a3c5b82b"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a4c370926ab17c1ac3ab5c809c0c30aa09f458b", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/artipie/commit/8a4c370926ab17c1ac3ab5c809c0c30aa09f458b", "committedDate": "2020-07-08T14:52:03Z", "message": "Merge branch 'master' into 250-docker-proxy-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c1b1aa639a88f3acf85a192743f80393af3c032", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/artipie/commit/8c1b1aa639a88f3acf85a192743f80393af3c032", "committedDate": "2020-07-08T14:52:47Z", "message": "Merge branch 'master' into 250-docker-proxy-cache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9062e5e4d6609fdd4aac77439f7798b77ec06b5", "author": {"user": {"login": "g4s8", "name": "Kirill"}}, "url": "https://github.com/artipie/artipie/commit/a9062e5e4d6609fdd4aac77439f7798b77ec06b5", "committedDate": "2020-07-08T14:58:46Z", "message": "Merge branch 'master' into 250-docker-proxy-cache"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3025, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}