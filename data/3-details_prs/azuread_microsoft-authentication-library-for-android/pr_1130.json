{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4MTY0MDE3", "number": 1130, "title": "Better messaging on broker redirect uri mismatch.", "bodyText": "", "createdAt": "2020-08-14T20:10:39Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130", "merged": true, "mergeCommit": {"oid": "79daa98f62357b2f74d686b0b035d846af5fd528"}, "closed": true, "closedAt": "2020-08-18T19:00:42Z", "author": {"login": "AdamBJohnsonx"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-6YENAH2gAyNDY4MTY0MDE3OjcxN2IzY2VhNjQzNmVmNzRiZTFiMmE2NTVkYjdiY2ZjZmZhNmIyNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAKvLYgFqTQ2OTY4ODc3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "717b3cea6436ef74be1b2a655db7bcfcffa6b24d", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/717b3cea6436ef74be1b2a655db7bcfcffa6b24d", "committedDate": "2020-08-14T20:10:10Z", "message": "Better messaging on redirect uri mismatch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f909a0bac8886614f4720a249b72916253f104a", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/3f909a0bac8886614f4720a249b72916253f104a", "committedDate": "2020-08-15T00:33:27Z", "message": "Fix PMD error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752b57b4b9fc2e6b56ce15d20913734a077f7b7b", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/752b57b4b9fc2e6b56ce15d20913734a077f7b7b", "committedDate": "2020-08-15T00:48:45Z", "message": "Fix typo."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjgwMTQy", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468680142", "createdAt": "2020-08-17T17:32:21Z", "commit": {"oid": "752b57b4b9fc2e6b56ce15d20913734a077f7b7b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzozMjoyMVrOHBzOGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNzozMjoyMVrOHBzOGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTY0OTgxOQ==", "bodyText": "Optionally return the entire expression?\nreturn matcher.matches() && ObjectUtils.equals(mAppContext.getPackageName(), matcher.group(1));", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r471649819", "createdAt": "2020-08-17T17:32:21Z", "author": {"login": "iambmelt"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -480,10 +483,11 @@ private void nullConfigurationCheck(String configKey, String configValue) {\n     }\n \n     private boolean isBrokerRedirectUri() {\n-        final String BROKER_REDIRECT_URI_REGEX = \"msauth://\" + mAppContext.getPackageName() + \"/.*\";\n-        final Pattern pairRegex = Pattern.compile(BROKER_REDIRECT_URI_REGEX);\n-        final Matcher matcher = pairRegex.matcher(mRedirectUri);\n-        return matcher.matches();\n+        final Matcher matcher = BROKER_REDIRECT_URI_REGEX.matcher(mRedirectUri);\n+        if (matcher.matches() && ObjectUtils.equals(mAppContext.getPackageName(), matcher.group(1))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "752b57b4b9fc2e6b56ce15d20913734a077f7b7b"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NjgwMTgy", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468680182", "createdAt": "2020-08-17T17:32:24Z", "commit": {"oid": "752b57b4b9fc2e6b56ce15d20913734a077f7b7b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9af396dc3791a8f5a8ee3a32effeb1c078ae1419", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/9af396dc3791a8f5a8ee3a32effeb1c078ae1419", "committedDate": "2020-08-17T23:30:15Z", "message": "Take code review comments, add a unit test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1", "committedDate": "2020-08-18T00:10:31Z", "message": "Ass assertions to tests, correct regular expression."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTE3ODgy", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468917882", "createdAt": "2020-08-18T00:38:26Z", "commit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDozODoyN1rOHB_VvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDozODoyN1rOHB_VvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0ODM4MA==", "bodyText": "See that this was an info message previously.  We may want to warn here instead.", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r471848380", "createdAt": "2020-08-18T00:38:27Z", "author": {"login": "shoatman"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -551,10 +555,12 @@ public void checkIntentFilterAddedToAppManifestForBrokerFlow() throws MsalClient\n             return;\n         }\n \n-        if (!isBrokerRedirectUri()) {\n+        if (!isBrokerRedirectUri(mRedirectUri, mAppContext.getPackageName())) {\n             // This means that the app is still using the legacy local-only MSAL Redirect uri (already removed from the new portal).\n             // If this is the case, we can assume that the user doesn't need Broker support.\n-            Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\");\n+            Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTE4MDE3", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468918017", "createdAt": "2020-08-18T00:38:51Z", "commit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTE4MjM4", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468918238", "createdAt": "2020-08-18T00:39:36Z", "commit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDozOTozNlrOHB_W_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDozOTozNlrOHB_W_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg0ODcwMA==", "bodyText": "Agreed.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"\n          \n          \n            \n                        Logger.warn(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r471848700", "createdAt": "2020-08-18T00:39:36Z", "author": {"login": "AdamBJohnsonx"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -551,10 +555,12 @@ public void checkIntentFilterAddedToAppManifestForBrokerFlow() throws MsalClient\n             return;\n         }\n \n-        if (!isBrokerRedirectUri()) {\n+        if (!isBrokerRedirectUri(mRedirectUri, mAppContext.getPackageName())) {\n             // This means that the app is still using the legacy local-only MSAL Redirect uri (already removed from the new portal).\n             // If this is the case, we can assume that the user doesn't need Broker support.\n-            Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\");\n+            Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8434d2fb9717c0d00ff9e1e0b49c5b2ab7c4c0b1"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "610a2637c7dda42fac06555ac1230fd781b635d9", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/610a2637c7dda42fac06555ac1230fd781b635d9", "committedDate": "2020-08-18T00:39:41Z", "message": "Update msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4OTIxODUz", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-468921853", "createdAt": "2020-08-18T00:52:26Z", "commit": {"oid": "610a2637c7dda42fac06555ac1230fd781b635d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDo1MjoyNlrOHB_keg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwMDo1MjoyNlrOHB_keg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTg1MjE1NA==", "bodyText": "Is this meant to be used outside of the context of an Android app? Because this regex seems to accept invalid android application package names", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r471852154", "createdAt": "2020-08-18T00:52:26Z", "author": {"login": "shahzaibj"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -78,6 +81,8 @@\n public class PublicClientApplicationConfiguration {\n     private static final String TAG = PublicClientApplicationConfiguration.class.getSimpleName();\n \n+    private static final Pattern BROKER_REDIRECT_URI_REGEX = Pattern.compile(\"msauth://([^/]*)/.*\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "610a2637c7dda42fac06555ac1230fd781b635d9"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe076dc1dde4c9359ac0d0b8cece829f6a6a5e2", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/dfe076dc1dde4c9359ac0d0b8cece829f6a6a5e2", "committedDate": "2020-08-18T17:32:34Z", "message": "Change away from needless regular expression."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NjgzODUy", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-469683852", "createdAt": "2020-08-18T17:41:05Z", "commit": {"oid": "dfe076dc1dde4c9359ac0d0b8cece829f6a6a5e2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0MTowNVrOHCfO7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0MTowNVrOHCfO7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3MDkyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Logger.warn(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"\n          \n          \n            \n                            + \"  For brokered auth, the redirect URI is expected to conform to 'msauth://<authority>/.*' where the authority in \"\n          \n          \n            \n                            + \"that uri is the package name.\");\n          \n          \n            \n                        Logger.warn(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"\n          \n          \n            \n                            + \"  For brokered auth, the redirect URI is expected to conform to 'msauth://<authority>/.*' where the authority in \"\n          \n          \n            \n                            + \"that uri is the package name of the app. This package name is listed as 'applicationId' in the build.gradle file.\");", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r472370927", "createdAt": "2020-08-18T17:41:05Z", "author": {"login": "shahzaibj"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -551,10 +555,12 @@ public void checkIntentFilterAddedToAppManifestForBrokerFlow() throws MsalClient\n             return;\n         }\n \n-        if (!isBrokerRedirectUri()) {\n+        if (!isBrokerRedirectUri(mRedirectUri, mAppContext.getPackageName())) {\n             // This means that the app is still using the legacy local-only MSAL Redirect uri (already removed from the new portal).\n             // If this is the case, we can assume that the user doesn't need Broker support.\n-            Logger.info(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\");\n+            Logger.warn(TAG, \"The app is still using legacy MSAL redirect uri. Switch to MSAL local auth.\"\n+                + \"  For brokered auth, the redirect URI is expected to conform to 'msauth://<authority>/.*' where the authority in \"\n+                + \"that uri is the package name.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe076dc1dde4c9359ac0d0b8cece829f6a6a5e2"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3219f413599785373b79e45f90719ba2bc70f924", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/3219f413599785373b79e45f90719ba2bc70f924", "committedDate": "2020-08-18T17:41:38Z", "message": "Update msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java\n\nCo-authored-by: Shahzaib <37125644+shahzaibj@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Njg1MTY2", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-469685166", "createdAt": "2020-08-18T17:42:54Z", "commit": {"oid": "3219f413599785373b79e45f90719ba2bc70f924"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0Mjo1NVrOHCfTJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQxNzo0Mjo1NVrOHCfTJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjM3MjAwNg==", "bodyText": "Does the package name have to be nullable?", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#discussion_r472372006", "createdAt": "2020-08-18T17:42:55Z", "author": {"login": "shahzaibj"}, "path": "msal/src/main/java/com/microsoft/identity/client/PublicClientApplicationConfiguration.java", "diffHunk": "@@ -479,11 +484,10 @@ private void nullConfigurationCheck(String configKey, String configValue) {\n         }\n     }\n \n-    private boolean isBrokerRedirectUri() {\n-        final String BROKER_REDIRECT_URI_REGEX = \"msauth://\" + mAppContext.getPackageName() + \"/.*\";\n-        final Pattern pairRegex = Pattern.compile(BROKER_REDIRECT_URI_REGEX);\n-        final Matcher matcher = pairRegex.matcher(mRedirectUri);\n-        return matcher.matches();\n+    @VisibleForTesting\n+    public static boolean isBrokerRedirectUri(final @NonNull String redirectUri, final @Nullable String packageName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3219f413599785373b79e45f90719ba2bc70f924"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2bc14daefb33709abda77ce041243f97d44e079", "author": {"user": {"login": "AdamBJohnsonx", "name": null}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/b2bc14daefb33709abda77ce041243f97d44e079", "committedDate": "2020-08-18T17:46:14Z", "message": "Change nullability annotation."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5Njg4Nzc4", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/1130#pullrequestreview-469688778", "createdAt": "2020-08-18T17:47:49Z", "commit": {"oid": "b2bc14daefb33709abda77ce041243f97d44e079"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1244, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}