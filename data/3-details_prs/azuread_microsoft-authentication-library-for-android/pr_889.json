{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjkzMDgy", "number": 889, "title": "Fix null pointer exception in BrokerMsalStrategies", "bodyText": "Related PR: AzureAD/microsoft-authentication-library-common-for-android#772\nThis fixes AzureAD/microsoft-authentication-library-common-for-android#770\nRoot cause:\n\nverifyHelloFromResultBundle returned boolean.\nIn BrokerMsalController, since it returned boolean, exception is never thrown for that strategy.\nif hello failed twice - for BindService and AccountManager, then we'll end up with result = null.\n\nFix:\n\n\nverifyHelloFromResultBundle() now throw an exception, if it gets an unexpected result bundle (i.e. Broker doesn't support hello in the calling strategy, which could be BindService or AccountManager).\n\n\nAlso introduce BrokerCommunicationException, which is thrown when\n\n\n\nWe ran into bind service errors in BrokerAuthServiceStrategy\nWe ran into AccountManager error in BrokerAccountManagerStrategy\n\n\nIn BrokerMsalController\n\n\nWhen we loop through strategies, if BrokerCommunicationException is thrown, we continue, otherwise we throw an exception right away.\nAfter the loop is done, if result = null, it means we got BrokerCommunicationException for EVERY strategies we iterated through. In this case, we throw BrokerCommunicationException.", "createdAt": "2020-01-08T22:58:10Z", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/889", "merged": true, "mergeCommit": {"oid": "28ac9b1baca1a67b15a053f12d5b962389ac56a5"}, "closed": true, "closedAt": "2020-01-10T18:25:27Z", "author": {"login": "rpdome"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4dYXegH2gAyMzYwNjkzMDgyOmRhMjY3N2Q4NTZjZmFhNjhmOTc1OTY3MjA5ZWFmMjMzOWMwMjBiNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb5CjYUAH2gAyMzYwNjkzMDgyOjA1Y2Y0NzQwYWZkNjRjNTk3ZDdlZDMzMWMyMTJiNDA3YWJjYzQ5Yjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da2677d856cfaa68f975967209eaf2339c020b62", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/da2677d856cfaa68f975967209eaf2339c020b62", "committedDate": "2020-01-08T22:48:33Z", "message": "Fix null pointer exception in BrokerMsalStrategies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMjA2MTA4", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/889#pullrequestreview-340206108", "createdAt": "2020-01-08T23:14:38Z", "commit": {"oid": "da2677d856cfaa68f975967209eaf2339c020b62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27ee1d9e37e4a6746949677c7d77de47e5f90ae0", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/27ee1d9e37e4a6746949677c7d77de47e5f90ae0", "committedDate": "2020-01-10T17:34:23Z", "message": "Update common"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "570d9ff18ebf96bdce087a05b70ad4775257718d", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/570d9ff18ebf96bdce087a05b70ad4775257718d", "committedDate": "2020-01-10T17:40:55Z", "message": "Merge branch 'dev' into rapong/fixMsalStrategies"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzI0MzMy", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/889#pullrequestreview-341324332", "createdAt": "2020-01-10T17:51:44Z", "commit": {"oid": "570d9ff18ebf96bdce087a05b70ad4775257718d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNzo1MTo0NFrOFcbgoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNzo1MTo0NFrOFcbgoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTM1NTE2OA==", "bodyText": "is telemetry api name the same as api id?", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/889#discussion_r365355168", "createdAt": "2020-01-10T17:51:44Z", "author": {"login": "shahzaibj"}, "path": "msal/src/main/java/com/microsoft/identity/client/internal/controllers/BrokerMsalController.java", "diffHunk": "@@ -188,33 +186,42 @@ public AcquireTokenResult acquireToken(AcquireTokenOperationParameters parameter\n         for (int ii = 0; ii < strategies.size(); ii++) {\n             final BrokerBaseStrategy strategy = strategies.get(ii);\n             try {\n-                if (!strategy.hello(parameters)) {\n-                    continue;\n-                }\n-\n-                com.microsoft.identity.common.internal.logging.Logger.verbose(\n+                com.microsoft.identity.common.internal.logging.Logger.info(\n                         TAG + strategyTask.getMethodName(),\n                         \"Executing with strategy: \"\n                                 + strategy.getClass().getSimpleName()\n                 );\n \n+                strategy.hello(parameters);\n                 result = strategyTask.perform(strategy, parameters);\n                 if (result != null) {\n                     break;\n                 }\n-            } catch (final Exception exception) {\n-                if (ii == (strategies.size() - 1)) {\n-                    //throw the exception for the last trying of strategies.\n-                    if (strategyTask.getTelemetryApiName() != null) {\n-                        Telemetry.emit(\n-                                new ApiEndEvent()\n-                                        .putException(exception)\n-                                        .putApiId(strategyTask.getTelemetryApiName())\n-                        );\n-                    }\n-                    throw exception;\n+            } catch (final BrokerCommunicationException exception){\n+                // continue\n+            } catch (final Exception exception){\n+                if (strategyTask.getTelemetryApiName() != null) {\n+                    Telemetry.emit(\n+                            new ApiEndEvent()\n+                                    .putException(exception)\n+                                    .putApiId(strategyTask.getTelemetryApiName())\n+                    );\n                 }\n+                throw exception;\n+            }\n+        }\n+\n+        // This means that we've tried every strategies...\n+        if (result == null) {\n+            final BrokerCommunicationException exception = new BrokerCommunicationException(\"MSAL failed to communicate to Broker.\");\n+            if (strategyTask.getTelemetryApiName() != null) {\n+                Telemetry.emit(\n+                        new ApiEndEvent()\n+                                .putException(exception)\n+                                .putApiId(strategyTask.getTelemetryApiName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "570d9ff18ebf96bdce087a05b70ad4775257718d"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMzI0NTQz", "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/pull/889#pullrequestreview-341324543", "createdAt": "2020-01-10T17:52:10Z", "commit": {"oid": "570d9ff18ebf96bdce087a05b70ad4775257718d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90eb32d24b746608011da8cc224f50602da34c4e", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/90eb32d24b746608011da8cc224f50602da34c4e", "committedDate": "2020-01-10T18:00:09Z", "message": "Address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05cf4740afd64c597d7ed331c212b407abcc49b7", "author": {"user": {"login": "rpdome", "name": "Dome Pongmongkol"}}, "url": "https://github.com/AzureAD/microsoft-authentication-library-for-android/commit/05cf4740afd64c597d7ed331c212b407abcc49b7", "committedDate": "2020-01-10T18:07:04Z", "message": "Update comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1354, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}