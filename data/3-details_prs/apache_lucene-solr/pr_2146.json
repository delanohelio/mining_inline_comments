{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTMwNTU0", "number": 2146, "title": "SOLR-15049: Add TopLevelJoinQuery optimization for 'self-joins'", "bodyText": "Description\nTopLevelJoinQuery currently converts ordinals of the \"from\" field into ordinals of the \"to\" field, even when the \"from\" and \"to\" field are the same and have the same ordinals.  By handling this special case we can greatly improve search performance for this subset of joins.\nSolution\nThis commit adds a new subclass \"TopLevelJoinQuery.SelfJoin\", which skips the ordinal-conversion step in typical \"top-level\" joins.\nTests\nManual testing, along with beasting of TestJoin.java.\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ./gradlew check.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-12-15T02:31:02Z", "url": "https://github.com/apache/lucene-solr/pull/2146", "merged": true, "mergeCommit": {"oid": "8b272a0960b619664ae9abe4ea2812330f0b2d5d"}, "closed": true, "closedAt": "2020-12-22T13:32:53Z", "author": {"login": "gerlowskija"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmQ4yeAH2gAyNTM5OTMwNTU0OjljZTEwMTg2NGJmYTkzODI5YmQ4NGRjYTI0NDVlZDQ5YjE3M2IwODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoqPRbAH2gAyNTM5OTMwNTU0OmYzYWJhZjZkZTFkOTBlMWJjM2FiY2Q4OWQwMGRlMmQ5NzQzMWEwNWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/9ce101864bfa93829bd84dca2445ed49b173b086", "committedDate": "2020-12-15T02:26:52Z", "message": "SOLR-15049: Add TopLevelJoinQuery optimization for 'self-joins'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzE5Mzcx", "url": "https://github.com/apache/lucene-solr/pull/2146#pullrequestreview-552319371", "createdAt": "2020-12-15T10:40:34Z", "commit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDozNFrOIGEVEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1MlrOIGEV4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzI5Ng==", "bodyText": "Suggested change", "url": "https://github.com/apache/lucene-solr/pull/2146#discussion_r543233296", "createdAt": "2020-12-15T10:40:34Z", "author": {"login": "jbampton"}, "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "diffHunk": "@@ -218,4 +218,28 @@ public BitsetBounds(long lower, long upper) {\n       this.upper = upper;\n     }\n   }\n+\n+  /**\n+   * A {@link TopLevelJoinQuery} implementation optimized for when 'from' and 'to' cores and fields match and no ordinal-\n+   * conversion is necessary.\n+   */\n+  static class SelfJoin extends TopLevelJoinQuery {\n+    public SelfJoin(String joinField, Query subQuery) {\n+      super(joinField, joinField, null, subQuery);\n+    }\n+\n+    protected BitsetBounds convertFromOrdinalsIntoToField(LongBitSet fromOrdBitSet, SortedSetDocValues fromDocValues,\n+                                                          LongBitSet toOrdBitSet, SortedSetDocValues toDocValues) throws IOException {\n+\n+      // 'from' and 'to' ordinals are identical for self-joins.\n+      toOrdBitSet.or(fromOrdBitSet);\n+\n+      // Calculate boundary ords used for other optimizations\n+      final long firstToOrd = toOrdBitSet.nextSetBit(0);\n+      final long lastToOrd = toOrdBitSet.prevSetBit(toOrdBitSet.length() - 1);\n+      return new BitsetBounds(firstToOrd, lastToOrd);\n+    }\n+  }\n }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzUwNw==", "bodyText": "Suggested change", "url": "https://github.com/apache/lucene-solr/pull/2146#discussion_r543233507", "createdAt": "2020-12-15T10:40:52Z", "author": {"login": "jbampton"}, "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "diffHunk": "@@ -218,4 +218,28 @@ public BitsetBounds(long lower, long upper) {\n       this.upper = upper;\n     }\n   }\n+\n+  /**\n+   * A {@link TopLevelJoinQuery} implementation optimized for when 'from' and 'to' cores and fields match and no ordinal-\n+   * conversion is necessary.\n+   */\n+  static class SelfJoin extends TopLevelJoinQuery {\n+    public SelfJoin(String joinField, Query subQuery) {\n+      super(joinField, joinField, null, subQuery);\n+    }\n+\n+    protected BitsetBounds convertFromOrdinalsIntoToField(LongBitSet fromOrdBitSet, SortedSetDocValues fromDocValues,\n+                                                          LongBitSet toOrdBitSet, SortedSetDocValues toDocValues) throws IOException {\n+\n+      // 'from' and 'to' ordinals are identical for self-joins.\n+      toOrdBitSet.or(fromOrdBitSet);\n+\n+      // Calculate boundary ords used for other optimizations\n+      final long firstToOrd = toOrdBitSet.nextSetBit(0);\n+      final long lastToOrd = toOrdBitSet.prevSetBit(toOrdBitSet.length() - 1);\n+      return new BitsetBounds(firstToOrd, lastToOrd);\n+    }\n+  }\n }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NjAyMDU1", "url": "https://github.com/apache/lucene-solr/pull/2146#pullrequestreview-555602055", "createdAt": "2020-12-18T15:46:36Z", "commit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b76a7f778fa2c8bf2134e3450544812506e0a44f", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/b76a7f778fa2c8bf2134e3450544812506e0a44f", "committedDate": "2020-12-22T13:04:26Z", "message": "Merge branch 'master' into SOLR_15049_self_join_optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3abaf6de1d90e1bc3abcd89d00de2d97431a05a", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/f3abaf6de1d90e1bc3abcd89d00de2d97431a05a", "committedDate": "2020-12-22T13:06:54Z", "message": "SOLR-15049: Add CHANGES.txt entry"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2454, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}