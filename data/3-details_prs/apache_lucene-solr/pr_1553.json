{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MTM0NTc4", "number": 1553, "title": "LUCENE-9393: FunctionScoreQuery turns TOP_DOCS to COMPLETE in inner weights", "bodyText": "FunctionScoreQuery can't really use WAND algorithm even if TOP_DOCS score mode is requested. This commit makes the inner weight created use COMPLETE in this case.", "createdAt": "2020-06-04T23:07:54Z", "url": "https://github.com/apache/lucene-solr/pull/1553", "merged": true, "mergeCommit": {"oid": "e1a97a0f1ea6535677e1b792237964bbc3481ea2"}, "closed": true, "closedAt": "2020-06-05T18:04:14Z", "author": {"login": "tflobbe"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoGZhzAH2gAyNDI4MTM0NTc4OmQ3YWQzZGUxODJhMDQ3NTE1MWY0N2FmNjYzMjkxNzNkZTU5ZTJiMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoWSUBAH2gAyNDI4MTM0NTc4OmE0M2NiNDUyNDZiOTFjMTljMWRkNGZhMmY3ZjA2YzRlMzE4OWYxMjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18", "author": {"user": {"login": "tflobbe", "name": "Tomas Fernandez Lobbe"}}, "url": "https://github.com/apache/lucene-solr/commit/d7ad3de182a0475151f47af66329173de59e2b18", "committedDate": "2020-06-04T23:10:22Z", "message": "LUCENE-9393: FunctionScoreQuery turns TOP_DOCS to COMPLETE in inner weights\n\nFunctionScoreQuery can't really use WAND algorithm even if TOP_DOCS score mode is requested. This commit makes the inner weight created use COMPLETE"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf1d897f97444700eee99275b3bb684b3081e193", "author": {"user": {"login": "tflobbe", "name": "Tomas Fernandez Lobbe"}}, "url": "https://github.com/apache/lucene-solr/commit/cf1d897f97444700eee99275b3bb684b3081e193", "committedDate": "2020-06-04T23:03:37Z", "message": "LUCENE-9393: FunctionScoreQuery turns TOP_DOCS to COMPLETE in inner weights\n\nFunctionScoreQuery can't really use WAND algorithm even if TOP_DOCS score mode is requested. This commit makes the inner weight created use COMPLETE"}, "afterCommit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18", "author": {"user": {"login": "tflobbe", "name": "Tomas Fernandez Lobbe"}}, "url": "https://github.com/apache/lucene-solr/commit/d7ad3de182a0475151f47af66329173de59e2b18", "committedDate": "2020-06-04T23:10:22Z", "message": "LUCENE-9393: FunctionScoreQuery turns TOP_DOCS to COMPLETE in inner weights\n\nFunctionScoreQuery can't really use WAND algorithm even if TOP_DOCS score mode is requested. This commit makes the inner weight created use COMPLETE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODk4OTY5", "url": "https://github.com/apache/lucene-solr/pull/1553#pullrequestreview-424898969", "createdAt": "2020-06-04T23:21:40Z", "commit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMzoyMTo0MFrOGfbMBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMzoyMTo0MFrOGfbMBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwNDQ4Nw==", "bodyText": "While this test makes the current code pass, I'm trying to understand why it is correct. Why do we pass a COMPLETE_NO_SCORES to the underlying weight when the function's ValueSource doesn't need scores?", "url": "https://github.com/apache/lucene-solr/pull/1553#discussion_r435604487", "createdAt": "2020-06-04T23:21:40Z", "author": {"login": "tflobbe"}, "path": "lucene/queries/src/test/org/apache/lucene/queries/function/TestFunctionScoreQuery.java", "diffHunk": "@@ -244,4 +247,33 @@ public void testAccessToValueSource() throws Exception {\n \n   }\n \n+  public void testScoreMode() throws Exception {\n+    // Value Source doesn't need scores\n+    assertInnerScoreMode(ScoreMode.COMPLETE_NO_SCORES, ScoreMode.COMPLETE, DoubleValuesSource.fromDoubleField(\"foo\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDQxNTcw", "url": "https://github.com/apache/lucene-solr/pull/1553#pullrequestreview-425041570", "createdAt": "2020-06-05T07:00:05Z", "commit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzowMDowNVrOGfimMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzowMTo0NFrOGfiooA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcyNTg3Mw==", "bodyText": "I think we can simplify the above to\nif (scoreMode.needsScores() && source.needsScores()) {\n  sm = ScoreMode.COMPLETE;\n} else {\n  sm = ScoreMode.COMPLETE_NO_SCORES;\n}", "url": "https://github.com/apache/lucene-solr/pull/1553#discussion_r435725873", "createdAt": "2020-06-05T07:00:05Z", "author": {"login": "jpountz"}, "path": "lucene/queries/src/java/org/apache/lucene/queries/function/FunctionScoreQuery.java", "diffHunk": "@@ -105,7 +105,13 @@ public static FunctionScoreQuery boostByQuery(Query in, Query boostMatch, float\n \n   @Override\n   public Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n-    Weight inner = in.createWeight(searcher, scoreMode.needsScores() && source.needsScores() ? scoreMode : ScoreMode.COMPLETE_NO_SCORES, 1f);\n+    ScoreMode sm = scoreMode;\n+    if (scoreMode.needsScores() && source.needsScores() && scoreMode == ScoreMode.TOP_SCORES) {\n+      sm = ScoreMode.COMPLETE;\n+    } else if (!scoreMode.needsScores() || !source.needsScores()) {\n+      sm = ScoreMode.COMPLETE_NO_SCORES;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTcyNjQ5Ng==", "bodyText": "If the function's values source doesn't need scores, then Scorer#score() will never be called on the inner scorers, so we can treat them as filters, which is what COMPLETE_NO_SCORES does.", "url": "https://github.com/apache/lucene-solr/pull/1553#discussion_r435726496", "createdAt": "2020-06-05T07:01:44Z", "author": {"login": "jpountz"}, "path": "lucene/queries/src/test/org/apache/lucene/queries/function/TestFunctionScoreQuery.java", "diffHunk": "@@ -244,4 +247,33 @@ public void testAccessToValueSource() throws Exception {\n \n   }\n \n+  public void testScoreMode() throws Exception {\n+    // Value Source doesn't need scores\n+    assertInnerScoreMode(ScoreMode.COMPLETE_NO_SCORES, ScoreMode.COMPLETE, DoubleValuesSource.fromDoubleField(\"foo\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTYwNDQ4Nw=="}, "originalCommit": {"oid": "d7ad3de182a0475151f47af66329173de59e2b18"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08dbf5592f28b160fc39036ee7e00d1a389ee1b3", "author": {"user": {"login": "tflobbe", "name": "Tomas Fernandez Lobbe"}}, "url": "https://github.com/apache/lucene-solr/commit/08dbf5592f28b160fc39036ee7e00d1a389ee1b3", "committedDate": "2020-06-05T17:33:12Z", "message": "Addressed PR comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a43cb45246b91c19c1dd4fa2f7f06c4e3189f124", "author": {"user": {"login": "tflobbe", "name": "Tomas Fernandez Lobbe"}}, "url": "https://github.com/apache/lucene-solr/commit/a43cb45246b91c19c1dd4fa2f7f06c4e3189f124", "committedDate": "2020-06-05T17:40:58Z", "message": "Add CHANGES entry"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2580, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}