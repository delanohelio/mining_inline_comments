{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNjI3MDA4", "number": 1839, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyMDowOVrOEhPW-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyNzoyM1rOEhPuHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjkwMTA1OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyMDowOVrOHOcgCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo1ODo0MlrOHOj6JQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTA2NA==", "bodyText": "Whoa, this was a latent (over-counting) bug?  Maybe grep for other places we are possibly incorrectly using Integer.SIZE!\nThough, I think this array is typically tiny (usually 0 length), since it holds docs that hit non-aborting exception during indexing?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909064", "createdAt": "2020-09-08T13:20:09Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -351,7 +354,7 @@ FlushedSegment flush(DocumentsWriter.FlushNotifications flushNotifications) thro\n         flushState.liveDocs.clear(deleteDocIDs[i]);\n       }\n       flushState.delCountOnFlush = numDeletedDocIds;\n-      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.SIZE));\n+      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.BYTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMDQzNw==", "bodyText": "yeah I checked all instanced in our codebase after I found this.", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485030437", "createdAt": "2020-09-08T15:58:42Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -351,7 +354,7 @@ FlushedSegment flush(DocumentsWriter.FlushNotifications flushNotifications) thro\n         flushState.liveDocs.clear(deleteDocIDs[i]);\n       }\n       flushState.delCountOnFlush = numDeletedDocIds;\n-      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.SIZE));\n+      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.BYTES));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTA2NA=="}, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjkwMzIwOnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyMDoyMlrOHOchHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo1ODo1NVrOHOj6vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTM0MQ==", "bodyText": "Also a latent over-counting bug?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909341", "createdAt": "2020-09-08T13:20:22Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -292,7 +295,7 @@ private void deleteLastDocs(int docCount) {\n     for (int docId = from; docId < to; docId++) {\n       deleteDocIDs[numDeletedDocIds++] = docId;\n     }\n-    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.SIZE);\n+    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMDU5MQ==", "bodyText": "yeah same thing", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485030591", "createdAt": "2020-09-08T15:58:55Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -292,7 +295,7 @@ private void deleteLastDocs(int docCount) {\n     for (int docId = from; docId < to; docId++) {\n       deleteDocIDs[numDeletedDocIds++] = docId;\n     }\n-    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.SIZE);\n+    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.BYTES);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTM0MQ=="}, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMjk2MDI5OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyNzoyNFrOHOdBgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNTo1OTozMVrOHOj8aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkxNzYzMw==", "bodyText": "So we are breaking out a separate Counter for DefaultIndexingChain, from DWPT, when previously they shared the same counter?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484917633", "createdAt": "2020-09-08T13:27:24Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -52,7 +52,7 @@\n /** Default general purpose indexing chain, which handles\n  *  indexing all types of fields. */\n final class DefaultIndexingChain extends DocConsumer {\n-  final Counter bytesUsed;\n+  final Counter bytesUsed = Counter.newCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTAzMTAxNw==", "bodyText": "exactly that's the main change here otherwise we need to do back and forth accounting inside the StoredFieldsWriter", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r485031017", "createdAt": "2020-09-08T15:59:31Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -52,7 +52,7 @@\n /** Default general purpose indexing chain, which handles\n  *  indexing all types of fields. */\n final class DefaultIndexingChain extends DocConsumer {\n-  final Counter bytesUsed;\n+  final Counter bytesUsed = Counter.newCounter();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkxNzYzMw=="}, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1191, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}