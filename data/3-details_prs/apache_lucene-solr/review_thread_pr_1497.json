{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODY5MTc5", "number": 1497, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTozODo0NVrOD7knYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1ODozMlrOD9Uzmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNzkyNDgyOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTozODo0NVrOGT-hnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTozODo0NVrOGT-hnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMDU0Mw==", "bodyText": "I like the first 4 lines (this is rare for me to see a clear stream). But the last 2 lines are less clear, it took me some time to understand why it's needed.", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r423600543", "createdAt": "2020-05-12T09:38:45Z", "author": {"login": "bruno-roustant"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {\n+            return ((Accountable) leafReader).ramBytesUsed();\n+          } else {\n+            return -1L; // unsupported\n+          }\n+        })\n+        .mapToLong(Long::longValue)\n+        .reduce(0, (left, right) -> left == -1 || right == -1 ? -1 : left + right);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af4742ad2fff5a950ce096e1582519fd13720d77"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NjMwNjE4OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1ODozMlrOGWwFig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxODo1NDoyNlrOGXDoZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg==", "bodyText": "can we filter here instead?", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426509706", "createdAt": "2020-05-18T09:58:32Z", "author": {"login": "juanka588"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUxMDMyMw==", "bodyText": "or map into accountable returning -1L", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426510323", "createdAt": "2020-05-18T09:59:36Z", "author": {"login": "juanka588"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg=="}, "originalCommit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgyOTkyNA==", "bodyText": "Feel free to suggest a code snippet; I'm not sure I get it.\nOne small improvement I see I could make was change the last \"map\" call to be a \"mapToLong\" instead, and then I can remove the last mapToLong.", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426829924", "createdAt": "2020-05-18T18:54:26Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg=="}, "originalCommit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1521, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}