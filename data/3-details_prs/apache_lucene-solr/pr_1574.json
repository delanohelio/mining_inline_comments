{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzNzg0MzIx", "number": 1574, "title": "SOLR-14566: Add request-ID to all distrib-search requests", "bodyText": "Description\nWhen reading through logs, associating the log message from the coordinator node with the messages for per-shard requests downstream can be difficult.  Nothing unique (or semi-uniquely) identifies shard requests as being part of an upstream request.\nSolution\nThis PR moves some logic out of DebugComponent that generates a guarantee-ably unique request ID.  On coordinator nodes this value is logged out as a special field in the request log message.  On downstream shard requests it appears as \"rid\" in the parameter list.\nTests\nManual testing to ensure the log field is added in appropriate situations.  Some changes to DebugComponent to account for its new role as a consumer of \"rid\" only.  Looked to update SearchHandlerTest but couldn't think of a non-hacky way to test this.  Anyone has any ideas please lmk.\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ant precommit and the appropriate test suite.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-06-12T16:41:13Z", "url": "https://github.com/apache/lucene-solr/pull/1574", "merged": true, "mergeCommit": {"oid": "80f8ab717c01a124af176026ff36e5021fb1d8b2"}, "closed": true, "closedAt": "2020-07-08T12:38:24Z", "author": {"login": "gerlowskija"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcqli1LAH2gAyNDMzNzg0MzIxOjQ2MGNkNzI3ZGI4MTk0NTI0MDQxZGQ3YjAwMmMyNGE0MjBhMjhlZWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyajqlgH2gAyNDMzNzg0MzIxOjZiZDhhZmQxYTU0OTQ5ZGQ3YzU1OGViODg2ODhmYWZiNDY3YThjY2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "460cd727db8194524041dd7b002c24a420a28eef", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/460cd727db8194524041dd7b002c24a420a28eef", "committedDate": "2020-06-12T16:35:26Z", "message": "SOLR-14566: Log NOW value on coordinator node for dist search requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99f3c81906c8377c154462430a1a79d4ce6561ec", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/99f3c81906c8377c154462430a1a79d4ce6561ec", "committedDate": "2020-06-18T15:01:42Z", "message": "Revert \"SOLR-14566: Log NOW value on coordinator node for dist search requests\"\n\nThis reverts commit 460cd727db8194524041dd7b002c24a420a28eef."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/3eec81431a77d47b0c08e1841462f6ae90cccd48", "committedDate": "2020-06-18T16:45:20Z", "message": "SOLR-14566: Add rid to all distributed search requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzNzY1NjU0", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-433765654", "createdAt": "2020-06-19T02:36:11Z", "commit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjozNjoxMVrOGmGJ1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQwMjozNjoxMVrOGmGJ1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjU5OTg5NQ==", "bodyText": "Do we now want it also in the cordinator node?", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r442599895", "createdAt": "2020-06-19T02:36:11Z", "author": {"login": "tflobbe"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -500,6 +509,29 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n     }\n   }\n \n+  private void tagRequestWithRequestId(ResponseBuilder rb) {\n+    String rid = getRequestId(rb.req);\n+    if (StringUtils.isBlank(rb.req.getParams().get(CommonParams.REQUEST_ID))) {\n+      ModifiableSolrParams params = new ModifiableSolrParams(rb.req.getParams());\n+      params.add(CommonParams.REQUEST_ID, rid);//add rid to the request so that shards see it\n+      rb.req.setParams(params);\n+    }\n+    if (rb.isDistrib) {\n+      rb.rsp.addToLog(CommonParams.REQUEST_ID, rid); //to see it in the logs of the landing core", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjU1MzE0", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-434255314", "createdAt": "2020-06-19T17:59:17Z", "commit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzo1OToxN1rOGmdIjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxNzo1OToxN1rOGmdIjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3NjM5OQ==", "bodyText": "Wow, this could be a long string, and it'll show up as a parameter and is thus kinda in-your-face when looking at logs.  And this, you propose, is by default. Isn't that a concern, albeit not huge?", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r442976399", "createdAt": "2020-06-19T17:59:17Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -500,6 +509,29 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n     }\n   }\n \n+  private void tagRequestWithRequestId(ResponseBuilder rb) {\n+    String rid = getRequestId(rb.req);\n+    if (StringUtils.isBlank(rb.req.getParams().get(CommonParams.REQUEST_ID))) {\n+      ModifiableSolrParams params = new ModifiableSolrParams(rb.req.getParams());\n+      params.add(CommonParams.REQUEST_ID, rid);//add rid to the request so that shards see it\n+      rb.req.setParams(params);\n+    }\n+    if (rb.isDistrib) {\n+      rb.rsp.addToLog(CommonParams.REQUEST_ID, rid); //to see it in the logs of the landing core\n+    }\n+  }\n+\n+  public static String getRequestId(SolrQueryRequest req) {\n+    String rid = req.getParams().get(CommonParams.REQUEST_ID);\n+    return StringUtils.isNotBlank(rid) ? rid : generateRid(req);\n+  }\n+\n+  @SuppressForbidden(reason = \"Need currentTimeMillis, only used for naming\")\n+  private static String generateRid(SolrQueryRequest req) {\n+    String hostName = req.getCore().getCoreContainer().getHostName();\n+    return hostName + \"-\" + req.getCore().getName() + \"-\" + System.currentTimeMillis() + \"-\" + ridCounter.getAndIncrement();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0MjU1ODM4", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-434255838", "createdAt": "2020-06-19T18:00:15Z", "commit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODowMDoxNVrOGmdKGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxODowMDoxNVrOGmdKGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Mjk3Njc5Mw==", "bodyText": "LongAdder is probably a better choice", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r442976793", "createdAt": "2020-06-19T18:00:15Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -70,6 +73,11 @@\n \n   private static final Logger log = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n \n+  /**\n+   * A counter to ensure that no RID is equal, even if they fall in the same millisecond\n+   */\n+  private static final AtomicLong ridCounter = new AtomicLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3eec81431a77d47b0c08e1841462f6ae90cccd48"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "679bcef3adbcd5f22c454e25005ed53535a6dd1d", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/679bcef3adbcd5f22c454e25005ed53535a6dd1d", "committedDate": "2020-07-01T18:50:30Z", "message": "Trim down request ID; add feature flag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMTMwMDE4", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-441130018", "createdAt": "2020-07-01T19:10:11Z", "commit": {"oid": "679bcef3adbcd5f22c454e25005ed53535a6dd1d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxMDoxMVrOGryJkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxOToxMDoxMVrOGryJkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODU2MzYwMw==", "bodyText": "I don't think this flag should be a request parameter; I think it should be a \"Cluster Property\".\nSecondly, if you do need to get this from a SolrParams, see getBool method, accepting a default.", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r448563603", "createdAt": "2020-07-01T19:10:11Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -510,14 +510,18 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n   }\n \n   private void tagRequestWithRequestId(ResponseBuilder rb) {\n-    String rid = getRequestId(rb.req);\n-    if (StringUtils.isBlank(rb.req.getParams().get(CommonParams.REQUEST_ID))) {\n-      ModifiableSolrParams params = new ModifiableSolrParams(rb.req.getParams());\n-      params.add(CommonParams.REQUEST_ID, rid);//add rid to the request so that shards see it\n-      rb.req.setParams(params);\n-    }\n-    if (rb.isDistrib) {\n-      rb.rsp.addToLog(CommonParams.REQUEST_ID, rid); //to see it in the logs of the landing core\n+    final String disableFlag = rb.req.getParams().get(CommonParams.DISABLE_REQUEST_ID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "679bcef3adbcd5f22c454e25005ed53535a6dd1d"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "877e25accb1be916127df2dbfc753619964632fe", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/877e25accb1be916127df2dbfc753619964632fe", "committedDate": "2020-07-01T19:21:42Z", "message": "Merge branch 'master' into SOLR_14566_add_now_to_coordinator_logging2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "984afaba2933778318a617381605fafc5dc33c9e", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/984afaba2933778318a617381605fafc5dc33c9e", "committedDate": "2020-07-01T21:58:08Z", "message": "SOLR-14566: Address review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf52282418c61dfe86c7d6e051d24a86089856c", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/5bf52282418c61dfe86c7d6e051d24a86089856c", "committedDate": "2020-07-02T00:37:03Z", "message": "remove unused imports to fix precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39351bddfdf3090158654003a2646c37699133c4", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/39351bddfdf3090158654003a2646c37699133c4", "committedDate": "2020-07-02T00:45:44Z", "message": "More imports to remove"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMjk1ODUx", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-441295851", "createdAt": "2020-07-02T01:42:36Z", "commit": {"oid": "39351bddfdf3090158654003a2646c37699133c4"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMTo0MjozNlrOGr6nQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwMTo0OTo1OFrOGr6udw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcwMjI3Mw==", "bodyText": "The fact that this method could generate a RID each time it's called on the same request seems problematic.  Instead, either don't have it do any such generation (I think my preference), or have it both generate one and save it into the the params so that the same request ID is returned given the same request.\nAlso; let's document our public methods on an important class like SearchHandler.", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r448702273", "createdAt": "2020-07-02T01:42:36Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -500,6 +508,31 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n     }\n   }\n \n+  private void tagRequestWithRequestId(ResponseBuilder rb) {\n+    final boolean ridTaggingDisabled = rb.req.getParams().getBool(CommonParams.DISABLE_REQUEST_ID, false);\n+    if (! ridTaggingDisabled) {\n+      String rid = getRequestId(rb.req);\n+      if (StringUtils.isBlank(rb.req.getParams().get(CommonParams.REQUEST_ID))) {\n+        ModifiableSolrParams params = new ModifiableSolrParams(rb.req.getParams());\n+        params.add(CommonParams.REQUEST_ID, rid);//add rid to the request so that shards see it\n+        rb.req.setParams(params);\n+      }\n+      if (rb.isDistrib) {\n+        rb.rsp.addToLog(CommonParams.REQUEST_ID, rid); //to see it in the logs of the landing core\n+      }\n+    }\n+  }\n+\n+  public static String getRequestId(SolrQueryRequest req) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39351bddfdf3090158654003a2646c37699133c4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcwMzAyMQ==", "bodyText": "Maybe we don't need a flag parameter to decide what to do with rid.  What if Solr sees rid=* (or true?) then it knows to generate a rid, and if it sees a blank/empty string (or false?) then it does nothing.  If it's something else than it is the rid (either from the client or generated).  One parameter to look at for this feature seems nicer than two.  Also, relating to my concern about wholesale disabling, it could be set in the solrconfig as a param default.", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r448703021", "createdAt": "2020-07-02T01:45:32Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -500,6 +508,31 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n     }\n   }\n \n+  private void tagRequestWithRequestId(ResponseBuilder rb) {\n+    final boolean ridTaggingDisabled = rb.req.getParams().getBool(CommonParams.DISABLE_REQUEST_ID, false);\n+    if (! ridTaggingDisabled) {\n+      String rid = getRequestId(rb.req);\n+      if (StringUtils.isBlank(rb.req.getParams().get(CommonParams.REQUEST_ID))) {\n+        ModifiableSolrParams params = new ModifiableSolrParams(rb.req.getParams());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39351bddfdf3090158654003a2646c37699133c4"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODcwNDExOQ==", "bodyText": "super minor but please add a blank line after this because it's not related to timer.", "url": "https://github.com/apache/lucene-solr/pull/1574#discussion_r448704119", "createdAt": "2020-07-02T01:49:58Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/component/SearchHandler.java", "diffHunk": "@@ -298,7 +305,8 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n     final RTimerTree timer = rb.isDebug() ? req.getRequestTimer() : null;\n \n     final ShardHandler shardHandler1 = getAndPrepShardHandler(req, rb); // creates a ShardHandler object only if it's needed\n-    \n+\n+    tagRequestWithRequestId(rb);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39351bddfdf3090158654003a2646c37699133c4"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "470eb57565db590f02aaaa4828a8529782c4cc5e", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/470eb57565db590f02aaaa4828a8529782c4cc5e", "committedDate": "2020-07-06T13:10:43Z", "message": "Address review feedback, rd #3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edd828bf30bc0d3bb11c92c697f6325099e9328c", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/edd828bf30bc0d3bb11c92c697f6325099e9328c", "committedDate": "2020-07-06T13:51:26Z", "message": "Correct param javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDMxOTQw", "url": "https://github.com/apache/lucene-solr/pull/1574#pullrequestreview-443431940", "createdAt": "2020-07-06T21:54:46Z", "commit": {"oid": "edd828bf30bc0d3bb11c92c697f6325099e9328c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bd8afd1a54949dd7c558eb88688fafb467a8cce", "author": {"user": {"login": "gerlowskija", "name": "Jason Gerlowski"}}, "url": "https://github.com/apache/lucene-solr/commit/6bd8afd1a54949dd7c558eb88688fafb467a8cce", "committedDate": "2020-07-07T00:18:47Z", "message": "Merge branch 'master' into SOLR_14566_add_now_to_coordinator_logging2"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2618, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}