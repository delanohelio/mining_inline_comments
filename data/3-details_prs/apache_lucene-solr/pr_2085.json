{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzMTMxOTU2", "number": 2085, "title": "LUCENE-9508: Fix DocumentsWriter to block threads until unstalled", "bodyText": "DWStallControl expects the caller to loop on top of the wait call to make\nprogress with flushing if the DW is stalled. This logic wasn't applied such that\nDW only stalled for one second and then released the indexing thread. This can cause\nOOM if for instance during a full flush one DWPT gets stuck and other threads keep on\nindexing.", "createdAt": "2020-11-18T11:55:48Z", "url": "https://github.com/apache/lucene-solr/pull/2085", "merged": true, "mergeCommit": {"oid": "c71f119e9ac0a179b0f2d1741306bb0046e12dac"}, "closed": true, "closedAt": "2020-11-24T12:05:21Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddsv2yAH2gAyNTIzMTMxOTU2OjI1YTEzZDJlZWY2OGMwNDdhZTRjZTVkMTdjNWI4MzBjZjZhNTIwYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfnh9ugH2gAyNTIzMTMxOTU2OmE4Yjc0OTIzNjI5NzcyZDRhNDA1MDdhOTMwNThiY2EwYzUzZWIxZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/25a13d2eef68c047ae4ce5d17c5b830cf6a520b7", "committedDate": "2020-11-18T11:49:08Z", "message": "LUCENE-9508: Fix DocumentsWriter to block threads until unstalled\n\nDWStallControl expects the caller to loop on top of the wait call to make\nprogress with flushing if the DW is stalled. This logic wasn't applied such that\nDW only stalled for one second and then released the indexing thread. This can cause\nOOM if for instance during a full flush one DWPT gets stuck and onther threads keep on\nindexing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzc1MzQy", "url": "https://github.com/apache/lucene-solr/pull/2085#pullrequestreview-533375342", "createdAt": "2020-11-18T12:00:54Z", "commit": {"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjowMDo1NFrOH1qgLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMjowMjoyN1rOH1qjrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMjk0Mg==", "bodyText": "pull it up into the same try (semicolon-separated)?", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526032942", "createdAt": "2020-11-18T12:00:54Z", "author": {"login": "dweiss"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -4258,4 +4258,47 @@ public void testPendingNumDocs() throws Exception {\n       }\n     }\n   }\n+\n+  public void testIndexWriterBlocksOnStall() throws IOException, InterruptedException {\n+    try (Directory dir = newDirectory()) {\n+      try (IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAzMzgzNw==", "bodyText": "oh, wonderful.", "url": "https://github.com/apache/lucene-solr/pull/2085#discussion_r526033837", "createdAt": "2020-11-18T12:02:27Z", "author": {"login": "dweiss"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriter.java", "diffHunk": "@@ -371,19 +371,15 @@ public void close() throws IOException {\n   private boolean preUpdate() throws IOException {\n     ensureOpen();\n     boolean hasEvents = false;\n-\n-    if (flushControl.anyStalledThreads() || (flushControl.numQueuedFlushes() > 0 && config.checkPendingFlushOnUpdate)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjQ2MzY1", "url": "https://github.com/apache/lucene-solr/pull/2085#pullrequestreview-533646365", "createdAt": "2020-11-18T16:46:22Z", "commit": {"oid": "25a13d2eef68c047ae4ce5d17c5b830cf6a520b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b74923629772d4a40507a93058bca0c53eb1f5", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/a8b74923629772d4a40507a93058bca0c53eb1f5", "committedDate": "2020-11-24T10:52:17Z", "message": "Merge branch 'master' into LUCENE-9508"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2598, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}