{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MjkzMTE5", "number": 1687, "title": "SOLR-14658: Fix colstatus solrj interfaces to return one or all collections", "bodyText": "Description\nThis fixes a bug in the solrj interface for the COLSTATUS collection api as detailed in the JIRA such that using the class CollectionAdminRequest.collectionStatus(collectionName) to issue colstatus commands would return all collections vs just the one specified. This is an issue as the operation sends a request to all collections' shard leaders.\nSolution\nCollectionAdminRequest.collectionStatus(collectionName) will now only return one collection. To support getting the status for all collections, I've added CollectionAdminRequest.collectionStatuses(). The documented API still works exactly as it is detailed.\nTests\nI've added a new test case to test these new interfaces. I've also provided a snippet of code and steps for manual validation in the JIRA (to repro the bug) but i can be used to test the fix as well:\n    String host = \"http://localhost:8983/solr\";\n    HttpSolrClient.Builder builder = new HttpSolrClient.Builder(host);\n    HttpSolrClient solrClient = builder.build();\n\n    String collection = \"tes\";\n    final NamedList<Object> response = \n      //solrClient.request(CollectionAdminRequest.collectionStatus(collection));\n      solrClient.request(CollectionAdminRequest.collectionStatuses());\n      response._forEachEntry((k,v) -> {\n        System.out.println(k);\n      });\n    System.out.println(response);\n\nUsing just the API and not solrj for verification:\n\nhttp://localhost:8983/solr/admin/collections?action=COLSTATUS&collection=tester1\n\nreturn one collection\n\n\nhttp://localhost:8983/solr/admin/collections?action=COLSTATUS\n\nreturn all collections\n\n\n\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ant precommit and the appropriate test suite.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-07-22T18:50:50Z", "url": "https://github.com/apache/lucene-solr/pull/1687", "merged": true, "mergeCommit": {"oid": "2544df8f6d9a23e285d899c6a754611dd830f68f"}, "closed": true, "closedAt": "2020-09-03T18:25:37Z", "author": {"login": "andyvuong"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3fPW-gH2gAyNDU1MjkzMTE5OjNiMDFhY2FlMTZhYzViYTJmZTlkODI4MjU2NjQ5OGVmODMxMWUyZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFU0CmAH2gAyNDU1MjkzMTE5OjFlNGMxMGE2ZjE4YjMzOGJkMDk2YmFiOTZhNjU1NTE2YWZkOWY5NDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/3b01acae16ac5ba2fe9d8282566498ef8311e2f3", "committedDate": "2020-07-22T18:35:45Z", "message": "Fix colstatus solrj interfaces to return one or all collections"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTk0NjE2", "url": "https://github.com/apache/lucene-solr/pull/1687#pullrequestreview-453594616", "createdAt": "2020-07-22T18:51:59Z", "commit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1MTo1OVrOG1v07g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo1NDo1MFrOG1v7ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMTMxMA==", "bodyText": "Removed this because it's not documented in the API anyway and the CoreAdminParams.NAME isn't copied anyway.", "url": "https://github.com/apache/lucene-solr/pull/1687#discussion_r459011310", "createdAt": "2020-07-22T18:51:59Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/CollectionsHandler.java", "diffHunk": "@@ -517,10 +517,7 @@ private static void addStatusToResponse(NamedList<Object> results, RequestStatus\n           ColStatus.RAW_SIZE_DETAILS_PROP,\n           ColStatus.RAW_SIZE_SAMPLING_PERCENT_PROP,\n           ColStatus.SIZE_INFO_PROP);\n-      // make sure we can get the name if there's \"name\" but not \"collection\"\n-      if (props.containsKey(CoreAdminParams.NAME) && !props.containsKey(COLLECTION_PROP)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMjk4Nw==", "bodyText": "AsyncCollectionSpecificAdminRequest enforces a non-null collection name passed in which doesn't work if the solrj colstatus interface's intention is to allow either one collection return or all collections returned as documented in the collection api doc. If no collection = null, i.e. empty, then collectionshandler will treat it as returning all collections staying consistent with the documented api.", "url": "https://github.com/apache/lucene-solr/pull/1687#discussion_r459012987", "createdAt": "2020-07-22T18:54:50Z", "author": {"login": "andyvuong"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/request/CollectionAdminRequest.java", "diffHunk": "@@ -863,13 +863,23 @@ public SolrParams getParams() {\n   }\n \n   /**\n-   * Return a SolrRequest for low-level detailed status of the collection.\n+   * Return a SolrRequest for low-level detailed status of the specified collection. \n+   * @param collection the collection to get the status of.\n    */\n   public static ColStatus collectionStatus(String collection) {\n+    checkNotNull(CoreAdminParams.COLLECTION, collection);\n     return new ColStatus(collection);\n   }\n+  \n+  /**\n+   * Return a SolrRequest for low-level detailed status of all collections on the cluster.\n+   */\n+  public static ColStatus collectionStatuses() {\n+    return new ColStatus();\n+  }\n \n-  public static class ColStatus extends AsyncCollectionSpecificAdminRequest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTQ3MTA3", "url": "https://github.com/apache/lucene-solr/pull/1687#pullrequestreview-480947107", "createdAt": "2020-09-02T15:33:59Z", "commit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMDMyNjA0", "url": "https://github.com/apache/lucene-solr/pull/1687#pullrequestreview-472032604", "createdAt": "2020-08-20T22:40:36Z", "commit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjo0MDozNlrOHEVoUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQyMjo0NTo1MlrOHEVvCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMDczNw==", "bodyText": "please convert to expectThrows", "url": "https://github.com/apache/lucene-solr/pull/1687#discussion_r474310737", "createdAt": "2020-08-20T22:40:36Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/test/org/apache/solr/cloud/CollectionsAPISolrJTest.java", "diffHunk": "@@ -662,6 +662,44 @@ public void testColStatus() throws Exception {\n     Number down = (Number) rsp.getResponse().findRecursive(collectionName, \"shards\", \"shard1\", \"replicas\", \"down\");\n     assertTrue(\"should be some down replicas, but there were none in shard1:\" + rsp, down.intValue() > 0);\n   }\n+  \n+  @Test\n+  public void testColStatusCollectionName() throws Exception {\n+    final String[] collectionNames = {\"collectionStatusTest_1\", \"collectionStatusTest_2\"};\n+    for (String collectionName : collectionNames) {\n+      CollectionAdminRequest.createCollection(collectionName, \"conf2\", 1, 1)\n+      .process(cluster.getSolrClient());\n+      cluster.waitForActiveCollection(collectionName, 1, 1);\n+    }\n+    // assert only one collection is returned using the solrj colstatus interface\n+    CollectionAdminRequest.ColStatus req = CollectionAdminRequest.collectionStatus(collectionNames[0]);\n+    CollectionAdminResponse rsp = req.process(cluster.getSolrClient());\n+    assertNotNull(rsp.getResponse().get(collectionNames[0]));\n+    assertNull(rsp.getResponse().get(collectionNames[1]));\n+   \n+    req = CollectionAdminRequest.collectionStatus(collectionNames[1]);\n+    rsp = req.process(cluster.getSolrClient());\n+    assertNotNull(rsp.getResponse().get(collectionNames[1]));\n+    assertNull(rsp.getResponse().get(collectionNames[0]));\n+    \n+    // assert passing null collection fails\n+    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDMxMjQ1Ng==", "bodyText": "CC @sigram I believe you added the lines of code here that Andy thinks should be removed.", "url": "https://github.com/apache/lucene-solr/pull/1687#discussion_r474312456", "createdAt": "2020-08-20T22:45:52Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/CollectionsHandler.java", "diffHunk": "@@ -517,10 +517,7 @@ private static void addStatusToResponse(NamedList<Object> results, RequestStatus\n           ColStatus.RAW_SIZE_DETAILS_PROP,\n           ColStatus.RAW_SIZE_SAMPLING_PERCENT_PROP,\n           ColStatus.SIZE_INFO_PROP);\n-      // make sure we can get the name if there's \"name\" but not \"collection\"\n-      if (props.containsKey(CoreAdminParams.NAME) && !props.containsKey(COLLECTION_PROP)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMTMxMA=="}, "originalCommit": {"oid": "3b01acae16ac5ba2fe9d8282566498ef8311e2f3"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72122a694b14112170949b18d707242ba0342bed", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/72122a694b14112170949b18d707242ba0342bed", "committedDate": "2020-09-03T07:25:23Z", "message": "Merge branch 'master' into jira/SOLR-14658"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea4c037348e4606921dca2f0f1da79f0fe7c69a5", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/ea4c037348e4606921dca2f0f1da79f0fe7c69a5", "committedDate": "2020-09-03T18:09:20Z", "message": "Fix exception check and add change item"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a948e944571c492b632e3c02a47511cd32bf038f", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/a948e944571c492b632e3c02a47511cd32bf038f", "committedDate": "2020-09-03T18:16:28Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e4c10a6f18b338bd096bab96a655516afd9f942", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/1e4c10a6f18b338bd096bab96a655516afd9f942", "committedDate": "2020-09-03T18:21:48Z", "message": "Merge branch 'master' into jira/SOLR-14658"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2488, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}