{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODM1OTIz", "number": 1223, "title": "SOLR-14213: Configuring Solr Cloud to use Shared Storage", "bodyText": "This is an initial PR that allows Solr Cloud to be configured to use shared storage or not. Prior to this, shared storage is \"on\" by default with components be lazily initialized as needed e.g. when a collection of type shared is created. This of course is difficult to do correctly.\nThe solution proposed by this PR is check for the presence of a  section in solr.xml that indicates the user's intention to use shared storage and initiate the components on startup. This also sets the stage for future work we need to do to move some hard coded values into configurable parameters that would be specified in sharedStorage. See the JIRA for further discussion.\nChanges:\n\nsolr.xml supports a bare-bone  section that should be added to enable shared storage on the cluster\nIf core discovery discovers a shared collection but the cluster is not shared storage enabled, this is considered a fatal error (user error) and solr will not start in stable state\nCollections of type shared can only be created if the cluster is shared storage enabled (all shared functionality is already gated behind the presence of shared replicas within shared collections)\nAdded a test in SimpleSharedStorageCollectionTest to ensure proper feature gating\nRefactored our test setup for anything using SolrCloudSharedStoreTestCase to automatically start a mini solr cluster with a solr.xml (added solr-sharedstorage.xml) containing the sharedStorage section. Also made a change moving the local FS client setup into this parent class  so that any extending test classes don't need to worry about setting the shared directory up unless they want to mock the client themselves", "createdAt": "2020-01-30T00:42:05Z", "url": "https://github.com/apache/lucene-solr/pull/1223", "merged": true, "mergeCommit": {"oid": "d46803f4fe9844f5e09f7b7d4548457e446933f0"}, "closed": true, "closedAt": "2020-02-28T02:11:36Z", "author": {"login": "andyvuong"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_PWHAgH2gAyMzY4ODM1OTIzOmQ5YzQ2NDFkZjZlNjZmN2RjOTAzYTMxOTA1ODVmMTY5NDM3N2MyMzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIj1_2AFqTM2NjA2OTU5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d9c4641df6e66f7dc903a3190585f1694377c232", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/d9c4641df6e66f7dc903a3190585f1694377c232", "committedDate": "2020-01-30T00:24:53Z", "message": "Add SharedStoreConfig for initiating shared store support and refactor tests setup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNzEwMTc4", "url": "https://github.com/apache/lucene-solr/pull/1223#pullrequestreview-351710178", "createdAt": "2020-01-31T19:00:08Z", "commit": {"oid": "d9c4641df6e66f7dc903a3190585f1694377c232"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxOTowMDowOVrOFkU2hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxOTowMDowOVrOFkU2hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzYzNDY5Mg==", "bodyText": "This doesn't actually stop the process from starting up and currently not sure of a good way to abort the process if it's misconfigured. There used to be a setting by that was deprecated a long time ago.", "url": "https://github.com/apache/lucene-solr/pull/1223#discussion_r373634692", "createdAt": "2020-01-31T19:00:09Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -756,6 +763,12 @@ public void load() {\n         // is set to true for them\n         // TODO: should this go behind some config?\n         List<CoreDescriptor> additionalCoreDescriptors = discoverAdditionalCoreDescriptorsForSharedReplicas(cds);\n+        if (!isSharedStoreEnabled() && discoveredSharedCollection) {\n+          throw new SolrException(SolrException.ErrorCode.SERVER_ERROR, ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9c4641df6e66f7dc903a3190585f1694377c232"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14cbbb6e52f774fc4ed3cf9dde5e271accdb12a6", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/14cbbb6e52f774fc4ed3cf9dde5e271accdb12a6", "committedDate": "2020-01-31T20:21:23Z", "message": "Add missing condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9673d3b773726b5fb4960a0652e3ca8ab75f0ebc", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/9673d3b773726b5fb4960a0652e3ca8ab75f0ebc", "committedDate": "2020-02-06T18:17:06Z", "message": "Merge branch 'jira/SOLR-13101' into jira/SOLR-13101-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94e59d3740d2d9aa2f22ac28ec2a9ac7f84d3cab", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/94e59d3740d2d9aa2f22ac28ec2a9ac7f84d3cab", "committedDate": "2020-02-18T22:55:22Z", "message": "Fix test failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTkzODYz", "url": "https://github.com/apache/lucene-solr/pull/1223#pullrequestreview-361593863", "createdAt": "2020-02-20T02:18:44Z", "commit": {"oid": "94e59d3740d2d9aa2f22ac28ec2a9ac7f84d3cab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMjoxODo0NFrOFr_ltQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMjoyNzoyNFrOFr_4sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3NDkzMw==", "bodyText": "It is not clear why BlobCoreSyncer is initialized here inside load method instead of the constructor.\nThe comment says things here depend on initiated SharedStoreManager. That statement is incomplete. It is that plus the CoreContainer#sharedStoreManager is initialized because CorePullerFeeder depends on that. Also blobCoreSyncer and blobProcessUtil are two fields that are not initialized yet. The comment suggests all the public facing fields would have been initialized by now. Even if that is not what the comment means, there is nothing preventing them from being accessed in null state.\nThe other problem is that if the CoreContainer#load fails then CoreContainer@shutdown is called for cleanup. At least inside CoreContainer#createAndLoad. That can hit an NPE when calling sharedStoreManager.getBlobProcessManager().shutdown() because it is possible the exception that started the shutdown was in sharedStoreManager#load before blobProcessUtil was even initialized.\nThe second problem can be solved by creating a shutdown method inside SharedStoreManager and moving  sharedStoreManager.getBlobProcessManager().shutdown() there, protected by blobProcessUtil!= null check.\nThough, I don't have any good ideas for the first problem.", "url": "https://github.com/apache/lucene-solr/pull/1223#discussion_r381674933", "createdAt": "2020-02-20T02:18:44Z", "author": {"login": "mbwaheed"}, "path": "solr/core/src/java/org/apache/solr/store/shared/SharedStoreManager.java", "diffHunk": "@@ -43,68 +43,38 @@\n \n   public SharedStoreManager(ZkController controller) {\n     zkController = controller;\n-    // initialize BlobProcessUtil with the SharedStoreManager for background processes to be ready\n-    blobProcessUtil = new BlobProcessUtil(zkController.getCoreContainer());\n-    blobCoreSyncer = new BlobCoreSyncer();\n-    sharedCoreConcurrencyController = new SharedCoreConcurrencyController(zkController.getCoreContainer());\n-  }\n-  \n-  @VisibleForTesting\n-  public void initBlobStorageProvider(BlobStorageProvider blobStorageProvider) {\n-    this.blobStorageProvider = blobStorageProvider;\n-  }\n-  \n-  @VisibleForTesting\n-  public void initBlobProcessUtil(BlobProcessUtil processUtil) {\n-    if (blobProcessUtil != null) {\n-      blobProcessUtil.shutdown();\n-    }\n-    blobProcessUtil = processUtil;\n+    blobStorageProvider = new BlobStorageProvider();\n+    blobDeleteManager = new BlobDeleteManager(getBlobStorageProvider().getClient());\n+    corePullTracker = new CorePullTracker();\n+    sharedShardMetadataController = new SharedShardMetadataController(zkController.getSolrCloudManager());\n+    sharedCoreConcurrencyController = new SharedCoreConcurrencyController(sharedShardMetadataController);\n   }\n   \n-  /*\n-   * Initiates a SharedShardMetadataController if it doesn't exist and returns one \n+  /**\n+   * Start blob processes that depend on an initiated SharedStoreManager\n    */\n+  public void load() {\n+    blobCoreSyncer = new BlobCoreSyncer();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94e59d3740d2d9aa2f22ac28ec2a9ac7f84d3cab"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTY3OTc5NQ==", "bodyText": "Don't need 3 node cluster here, one should be enough?", "url": "https://github.com/apache/lucene-solr/pull/1223#discussion_r381679795", "createdAt": "2020-02-20T02:27:24Z", "author": {"login": "mbwaheed"}, "path": "solr/core/src/test/org/apache/solr/cloud/api/collections/SimpleSharedStorageCollectionTest.java", "diffHunk": "@@ -76,6 +62,28 @@ public void testCreateCollection() throws Exception {\n     waitForState(\"Timed-out wait for collection to be created\", collectionName, clusterShape(1, 1));\n     assertTrue(cloudClient.getZkStateReader().getZkClient().exists(ZkStateReader.COLLECTIONS_ZKNODE + \"/\" + collectionName, false));\n   }\n+  \n+  /**\n+   * Test that verifies that a collection creation command for a \"shared\" type collection fails\n+   * if the cluster was not enabled with shared storage\n+   */\n+  @Test\n+  public void testCreateCollectionSharedDisabled() throws Exception {\n+    setupClusterSharedDisable(3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94e59d3740d2d9aa2f22ac28ec2a9ac7f84d3cab"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a8cb09bb9c50cef26f43b061072f41ee132e80", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/29a8cb09bb9c50cef26f43b061072f41ee132e80", "committedDate": "2020-02-25T18:18:50Z", "message": "Initialize fields in constructor and fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "627618eeaf58d009136abad4cae3b76d0ea86f7e", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/627618eeaf58d009136abad4cae3b76d0ea86f7e", "committedDate": "2020-02-27T00:44:03Z", "message": "load shared store manager vs corecontainer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "092e97602666642047a8ed2d9fa9feb67d3c73a6", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/092e97602666642047a8ed2d9fa9feb67d3c73a6", "committedDate": "2020-02-27T00:46:17Z", "message": "Undo change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MDY5NTk0", "url": "https://github.com/apache/lucene-solr/pull/1223#pullrequestreview-366069594", "createdAt": "2020-02-27T23:23:08Z", "commit": {"oid": "092e97602666642047a8ed2d9fa9feb67d3c73a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2285, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}