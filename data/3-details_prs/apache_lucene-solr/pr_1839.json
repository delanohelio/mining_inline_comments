{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNjI3MDA4", "number": 1839, "title": "LUCENE-9511: Include StoredFieldsWriter in DWPT accounting", "bodyText": "StoredFieldsWriter might consume some heap space memory that\ncan have a significant impact on decisions made in the IW if\nwriters should be stalled or DWPTs should be flushed if memory\nsettings are small in IWC and flushes are frequent. This change adds\nRAM accounting to the StoredFieldsWriter since it's part of the\nDWPT lifecycle and not just present during flush.", "createdAt": "2020-09-07T20:19:10Z", "url": "https://github.com/apache/lucene-solr/pull/1839", "merged": true, "mergeCommit": {"oid": "98e55f0ea824ea0f39b6cc66f9d40b2532a85466"}, "closed": true, "closedAt": "2020-09-08T16:18:14Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGo2w4AH2gAyNDgxNjI3MDA4OjUwYTc4ODFlOTRhY2QwNDhmNmRhM2Y1YTQwMDk5OGFiYTI2NDZkODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG6CMKAH2gAyNDgxNjI3MDA4OjJlZTYxNzQ2NzgzZWRhYWMwNzk5MjZlNzA2ZmI0ZGU0ZGI5YjEyMTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/50a7881e94acd048f6da3f5a400998aba2646d86", "committedDate": "2020-09-07T20:16:48Z", "message": "LUCENE-9511: Include StoredFieldsWriter in DWPT accounting\n\nStoredFieldsWriter might consume some heap space memory that\ncan have a significant impact on decisions made in the IW if\nwriters should be stalled or DWPTs should be flushed if memory\nsettings are small in IWC and flushes are frequent. This change adds\nRAM accounting to the StoredFieldsWriter since it's part of the\nDWPT lifecycle and not just present during flush."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MTMxMDg5", "url": "https://github.com/apache/lucene-solr/pull/1839#pullrequestreview-484131089", "createdAt": "2020-09-08T13:20:08Z", "commit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyMDowOVrOHOcgCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMzoyNzoyNFrOHOdBgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTA2NA==", "bodyText": "Whoa, this was a latent (over-counting) bug?  Maybe grep for other places we are possibly incorrectly using Integer.SIZE!\nThough, I think this array is typically tiny (usually 0 length), since it holds docs that hit non-aborting exception during indexing?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909064", "createdAt": "2020-09-08T13:20:09Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -351,7 +354,7 @@ FlushedSegment flush(DocumentsWriter.FlushNotifications flushNotifications) thro\n         flushState.liveDocs.clear(deleteDocIDs[i]);\n       }\n       flushState.delCountOnFlush = numDeletedDocIds;\n-      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.SIZE));\n+      bytesUsed.addAndGet(-(deleteDocIDs.length * Integer.BYTES));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkwOTM0MQ==", "bodyText": "Also a latent over-counting bug?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484909341", "createdAt": "2020-09-08T13:20:22Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterPerThread.java", "diffHunk": "@@ -292,7 +295,7 @@ private void deleteLastDocs(int docCount) {\n     for (int docId = from; docId < to; docId++) {\n       deleteDocIDs[numDeletedDocIds++] = docId;\n     }\n-    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.SIZE);\n+    bytesUsed.addAndGet((deleteDocIDs.length - size) * Integer.BYTES);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkxNzYzMw==", "bodyText": "So we are breaking out a separate Counter for DefaultIndexingChain, from DWPT, when previously they shared the same counter?", "url": "https://github.com/apache/lucene-solr/pull/1839#discussion_r484917633", "createdAt": "2020-09-08T13:27:24Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -52,7 +52,7 @@\n /** Default general purpose indexing chain, which handles\n  *  indexing all types of fields. */\n final class DefaultIndexingChain extends DocConsumer {\n-  final Counter bytesUsed;\n+  final Counter bytesUsed = Counter.newCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a7881e94acd048f6da3f5a400998aba2646d86"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ee61746783edaac079926e706fb4de4db9b1213", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/2ee61746783edaac079926e706fb4de4db9b1213", "committedDate": "2020-09-08T16:17:40Z", "message": "add changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2233, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}