{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNjUxNzY1", "number": 1848, "title": "LUCENE-9515: Detach DWPT from DefaultIndexingChain", "bodyText": "This change removes the DWPT dependency from DefaultIndexingChain\nand rather passes on the primitives needed for creating the chain.", "createdAt": "2020-09-09T08:30:15Z", "url": "https://github.com/apache/lucene-solr/pull/1848", "merged": true, "mergeCommit": {"oid": "4d46caa05d01e6f7e2b3a3b432906eb45732bbfe"}, "closed": true, "closedAt": "2020-09-14T07:46:57Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHH3dYgH2gAyNDgyNjUxNzY1OjFmMzczYTkyODUzZjZkZjZjNGE1NjQwZjA4ZDcyYmRmNWE1ZDNiNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIuBl0AH2gAyNDgyNjUxNzY1OmY5MmNhMGQ1NTQ3OGEyMGRjYmRmY2VhZDRmYWMyOTMwYTJlNzAxZDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1f373a92853f6df6c4a5640f08d72bdf5a5d3b41", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/1f373a92853f6df6c4a5640f08d72bdf5a5d3b41", "committedDate": "2020-09-09T08:24:37Z", "message": "LUCENE-9515: Detach DWPT from DefaultIndexingChain\n\nThis change removes the DWPT dependency from DefaultIndexingChain\nand rather passes on the primitives needed for creating the chain."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9", "committedDate": "2020-09-09T08:51:59Z", "message": "fix imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODYxNDA4", "url": "https://github.com/apache/lucene-solr/pull/1848#pullrequestreview-484861408", "createdAt": "2020-09-09T10:12:26Z", "commit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDoxMjoyNlrOHPAfBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDoxMjoyNlrOHPAfBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5ODYzMA==", "bodyText": "Don't need the = false -- it is java's default already.", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485498630", "createdAt": "2020-09-09T10:12:26Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -73,21 +78,38 @@\n   // Holds fields seen in each document\n   private PerField[] fields = new PerField[1];\n   private final InfoStream infoStream;\n-\n-  DefaultIndexingChain(DocumentsWriterPerThread docWriter) {\n-    this.docWriter = docWriter;\n-    this.fieldInfos = docWriter.getFieldInfosBuilder();\n-    this.infoStream = docWriter.getIndexWriterConfig().getInfoStream();\n+  private final ByteBlockPool.Allocator byteBlockAllocator;\n+  private final LiveIndexWriterConfig indexWriterConfig;\n+  private final int indexCreatedVersionMajor;\n+  private final Consumer<Throwable> abortingExceptionConsumer;\n+  private boolean hasHitAbortingException = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "originalPosition": 47}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0ODYzMDA0", "url": "https://github.com/apache/lucene-solr/pull/1848#pullrequestreview-484863004", "createdAt": "2020-09-09T10:14:38Z", "commit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDoxNDozOFrOHPAjzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMDoxNDozOFrOHPAjzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTQ5OTg1Mw==", "bodyText": "This was moved from DWPT?\nAhh, no, we forked it from there, ok.", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485499853", "createdAt": "2020-09-09T10:14:38Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/DefaultIndexingChain.java", "diffHunk": "@@ -73,21 +78,38 @@\n   // Holds fields seen in each document\n   private PerField[] fields = new PerField[1];\n   private final InfoStream infoStream;\n-\n-  DefaultIndexingChain(DocumentsWriterPerThread docWriter) {\n-    this.docWriter = docWriter;\n-    this.fieldInfos = docWriter.getFieldInfosBuilder();\n-    this.infoStream = docWriter.getIndexWriterConfig().getInfoStream();\n+  private final ByteBlockPool.Allocator byteBlockAllocator;\n+  private final LiveIndexWriterConfig indexWriterConfig;\n+  private final int indexCreatedVersionMajor;\n+  private final Consumer<Throwable> abortingExceptionConsumer;\n+  private boolean hasHitAbortingException = false;\n+\n+  DefaultIndexingChain(int indexCreatedVersionMajor, SegmentInfo segmentInfo, Directory directory, FieldInfos.Builder fieldInfos, LiveIndexWriterConfig indexWriterConfig,\n+                       Consumer<Throwable> abortingExceptionConsumer) {\n+    this.indexCreatedVersionMajor = indexCreatedVersionMajor;\n+    byteBlockAllocator = new ByteBlockPool.DirectTrackingAllocator(bytesUsed);\n+    IntBlockPool.Allocator intBlockAllocator = new IntBlockAllocator(bytesUsed);\n+    this.indexWriterConfig = indexWriterConfig;\n+    assert segmentInfo.getIndexSort() == indexWriterConfig.getIndexSort();\n+    this.fieldInfos = fieldInfos;\n+    this.infoStream = indexWriterConfig.getInfoStream();\n+    this.abortingExceptionConsumer = abortingExceptionConsumer;\n \n     final TermsHash termVectorsWriter;\n-    if (docWriter.getSegmentInfo().getIndexSort() == null) {\n-      storedFieldsConsumer = new StoredFieldsConsumer(docWriter.codec, docWriter.directory, docWriter.getSegmentInfo());\n-      termVectorsWriter = new TermVectorsConsumer(docWriter);\n+    if (segmentInfo.getIndexSort() == null) {\n+      storedFieldsConsumer = new StoredFieldsConsumer(indexWriterConfig.getCodec(), directory, segmentInfo);\n+      termVectorsWriter = new TermVectorsConsumer(intBlockAllocator, byteBlockAllocator, directory, segmentInfo, indexWriterConfig.getCodec());\n     } else {\n-      storedFieldsConsumer = new SortingStoredFieldsConsumer(docWriter.codec, docWriter.directory, docWriter.getSegmentInfo());\n-      termVectorsWriter = new SortingTermVectorsConsumer(docWriter);\n+      storedFieldsConsumer = new SortingStoredFieldsConsumer(indexWriterConfig.getCodec(), directory, segmentInfo);\n+      termVectorsWriter = new SortingTermVectorsConsumer(intBlockAllocator, byteBlockAllocator, directory, segmentInfo, indexWriterConfig.getCodec());\n     }\n-    termsHash = new FreqProxTermsWriter(docWriter, bytesUsed, termVectorsWriter);\n+    termsHash = new FreqProxTermsWriter(intBlockAllocator, byteBlockAllocator, bytesUsed, termVectorsWriter);\n+  }\n+\n+  private void onAbortingException(Throwable th) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MDUyNTYx", "url": "https://github.com/apache/lucene-solr/pull/1848#pullrequestreview-485052561", "createdAt": "2020-09-09T14:12:41Z", "commit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNDoxMjo0MVrOHPJZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxNDoxNjozMVrOHPJlDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NDcwMQ==", "bodyText": "Maybe remove this stale comment :)  FieldCache is long gone!", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485644701", "createdAt": "2020-09-09T14:12:41Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -272,7 +273,9 @@ static int getActualMaxDocs() {\n    * and a message is printed to infoStream, if set (see {@link\n    * IndexWriterConfig#setInfoStream(InfoStream)}).\n    */\n-  public final static int MAX_TERM_LENGTH = DocumentsWriterPerThread.MAX_TERM_LENGTH_UTF8;\n+  // if you increase this, you must fix field cache impl for\n+  // getTerms/getTermsIndex requires <= 32768", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTY0NzYzMQ==", "bodyText": "Ooh good catch (char[] vs byte[]).", "url": "https://github.com/apache/lucene-solr/pull/1848#discussion_r485647631", "createdAt": "2020-09-09T14:16:31Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -1533,7 +1533,7 @@ public void testWickedLongTerm() throws IOException {\n     Directory dir = newDirectory();\n     RandomIndexWriter w = new RandomIndexWriter(random(), dir, new StringSplitAnalyzer());\n \n-    char[] chars = new char[DocumentsWriterPerThread.MAX_TERM_LENGTH_UTF8];\n+    char[] chars = new char[IndexWriter.MAX_TERM_LENGTH];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1NDc1Nzkw", "url": "https://github.com/apache/lucene-solr/pull/1848#pullrequestreview-485475790", "createdAt": "2020-09-09T23:49:48Z", "commit": {"oid": "d2edb8e9d837609b9a608e24fe40a7a7f5dd6be9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5b161ca7741d219bb2efd5dfe0a87eb39ed711", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/6f5b161ca7741d219bb2efd5dfe0a87eb39ed711", "committedDate": "2020-09-14T07:14:50Z", "message": "apply feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab9287a2b6fdcf438a43a4e8e64eb644f8119695", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/ab9287a2b6fdcf438a43a4e8e64eb644f8119695", "committedDate": "2020-09-14T07:21:47Z", "message": "Merge branch 'master' into detach_dwpt_from_indexing_chain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f92ca0d55478a20dcbdfcead4fac2930a2e701d9", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/f92ca0d55478a20dcbdfcead4fac2930a2e701d9", "committedDate": "2020-09-14T07:26:00Z", "message": "add changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2253, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}