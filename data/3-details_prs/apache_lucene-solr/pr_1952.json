{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTkwMjI0", "number": 1952, "title": "LUCENE-9565 Fix competitive iteration", "bodyText": "PR #1351 introduced a sort optimization where documents can be skipped.\nBut iteration over competitive iterators was not properly organized,\nas they were not storing the current docID, and\nwhen competitive iterator was updated, the current doc ID was lost.\nThis patch fixes it.\nRelates to #1351", "createdAt": "2020-10-06T14:29:12Z", "url": "https://github.com/apache/lucene-solr/pull/1952", "merged": true, "mergeCommit": {"oid": "874c446ab945aded465d12f01085af89b83563c6"}, "closed": true, "closedAt": "2020-10-06T17:22:17Z", "author": {"login": "mayya-sharipova"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdP5L8YAH2gAyNDk4NTkwMjI0OjU3NDI0NWM5NmRiMTkyOTExMzhiMmViNzI1MzQ1MWI1NjdjNjlkODk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP-W97AFqTUwMzMzMDY5Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "574245c96db19291138b2eb7253451b567c69d89", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/apache/lucene-solr/commit/574245c96db19291138b2eb7253451b567c69d89", "committedDate": "2020-10-06T14:23:44Z", "message": "LUCENE-9565 Fix competitive iteration\n\nPR #1351 introduced a sort optimization where documents can be skipped.\nBut iteration over competitive iterators was not properly organized,\nas they were not storing the current docID, and\nwhen competitive iterator was updated the current doc ID was lost.\n\nThis patch fixed it.\n\nRelates to #1351"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDcxOTIx", "url": "https://github.com/apache/lucene-solr/pull/1952#pullrequestreview-503071921", "createdAt": "2020-10-06T15:09:31Z", "commit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowOTozMVrOHdMUsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowOTozMVrOHdMUsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA==", "bodyText": "I don't think that this is good enough as we might be advancing ahead of scorerIterator? This was why I thought that we should instead wrap scorerIterator in such a way that its initial docID would be -1.", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500372658", "createdAt": "2020-10-06T15:09:31Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cba6cf75f48a26cd48f09152c25518c91fd6660d", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/apache/lucene-solr/commit/cba6cf75f48a26cd48f09152c25518c91fd6660d", "committedDate": "2020-10-06T15:53:39Z", "message": "Wrap ScorerIterator to start from -1 for conjunction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTczMTYw", "url": "https://github.com/apache/lucene-solr/pull/1952#pullrequestreview-503173160", "createdAt": "2020-10-06T16:56:37Z", "commit": {"oid": "cba6cf75f48a26cd48f09152c25518c91fd6660d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo1NjozN1rOHdRPFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjo1NjozN1rOHdRPFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1MzE0MA==", "bodyText": "oh, I had not considered setting scorerIterator.docID() as a min docID, maybe this means that we no longer need the min parameter of RangeDISIWrapper?", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500453140", "createdAt": "2020-10-06T16:56:37Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA=="}, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/apache/lucene-solr/commit/d42c4649c81364f13c51c0b147dd600e57d7cccc", "committedDate": "2020-10-06T17:07:23Z", "message": "Address Adrien's comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzMwNjky", "url": "https://github.com/apache/lucene-solr/pull/1952#pullrequestreview-503330692", "createdAt": "2020-10-06T20:25:18Z", "commit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNToxOFrOHdYohQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNToxOFrOHdYohQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDM0MQ==", "bodyText": "it just occurred to me that this implementation is not correct in the case that the minimum bound of the range of doc IDs to score is less than the current doc ID of the scorer, have you seen any failures with your change? I wonder that we would need to do\nif (target >= scorer.docID()) { return scorer.docID(); }\n\nbut we should create a test that fails without this", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500574341", "createdAt": "2020-10-06T20:25:18Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -266,4 +274,45 @@ static void scoreAll(LeafCollector collector, DocIdSetIterator iterator, TwoPhas\n     }\n   }\n \n+  /**\n+   * Wraps an internal docIdSetIterator for it to start with docID = -1\n+   */\n+  protected static class RangeDISIWrapper extends DocIdSetIterator {\n+    private final DocIdSetIterator in;\n+    private final int min;\n+    private final int max;\n+    private int docID = -1;\n+\n+    public RangeDISIWrapper(DocIdSetIterator in, int max) {\n+      this.in = in;\n+      this.min = in.docID();\n+      this.max = max;\n+    }\n+\n+    @Override\n+    public int docID() {\n+      return docID;\n+    }\n+\n+    @Override\n+    public int nextDoc() throws IOException {\n+      return advance(docID + 1);\n+    }\n+\n+    @Override\n+    public int advance(int target) throws IOException {\n+      target = Math.max(min, target);\n+      if (target >= max) {\n+        return docID = NO_MORE_DOCS;\n+      }\n+      return docID = in.advance(target);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2687, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}