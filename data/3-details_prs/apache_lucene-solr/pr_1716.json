{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyODQ4MzYx", "number": 1716, "title": "SOLR-14706: Fix support for default autoscaling policy", "bodyText": "https://issues.apache.org/jira/browse/SOLR-14706\nThis is to introduce backwards compatibility for the default autoscaling policy that was removed in 8.6.1 (and 8.7).\nThe upgrade notes now include the steps to remove the default autoscaling policy via the autoscaling API.\nI have tested the following upgrade patterns, and am happy with the results. I'll do more tests if y'all think it is necessary.\n8.6.0 -> 8.6.1 RC1 (fail)\n8.6.0 -> this patch (success)\n8.6.0 -> 8.6.1 RCI -> this patch (success)\nI will also be porting this with a few documentation tweaks to 8x", "createdAt": "2020-08-04T15:41:07Z", "url": "https://github.com/apache/lucene-solr/pull/1716", "merged": true, "mergeCommit": {"oid": "6e11a1c3f0599f1c918bc69c4f51928d23160e99"}, "closed": true, "closedAt": "2020-08-10T15:43:29Z", "author": {"login": "HoustonPutman"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7oZqlgH2gAyNDYyODQ4MzYxOmNmMmIzMGJjYjE5ZTZiOTczMTBhZjc2Y2Y2ZDQ4NDg4ZDUyZjIxMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8m2JAAH2gAyNDYyODQ4MzYxOmNiMDc5ZmE5MGVjYzA0Yjk4MGUwZGUyNDVmZmI0Y2E3NTlkMmJlMWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf2b30bcb19e6b97310af76cf6d48488d52f2122", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/cf2b30bcb19e6b97310af76cf6d48488d52f2122", "committedDate": "2020-08-04T15:31:51Z", "message": "SOLR-14706: Fix support for default autoscaling policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTM4MDUz", "url": "https://github.com/apache/lucene-solr/pull/1716#pullrequestreview-460938053", "createdAt": "2020-08-04T15:42:17Z", "commit": {"oid": "cf2b30bcb19e6b97310af76cf6d48488d52f2122"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTo0MjoxN1rOG7mS5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTo0MjoxN1rOG7mS5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE0NjU5OQ==", "bodyText": "I brought this back in from the revert because it looks like an improvement that was unrelated to the default policy.\nI'm happy to remove it if y'all think I should.", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r465146599", "createdAt": "2020-08-04T15:42:17Z", "author": {"login": "HoustonPutman"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/cloud/autoscaling/Clause.java", "diffHunk": "@@ -686,7 +686,7 @@ boolean isShardAbsent() {\n       for (Row r : session.matrix) {\n         computedValueEvaluator.node = r.node;\n         SealedClause sealedClause = getSealedClause(computedValueEvaluator);\n-        if (!sealedClause.getGlobalTag().isPass(r)) {\n+        if (r.isLive() && !sealedClause.getGlobalTag().isPass(r)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf2b30bcb19e6b97310af76cf6d48488d52f2122"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af7c31321199ef583601836fdcd0b149425d8eb2", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/af7c31321199ef583601836fdcd0b149425d8eb2", "committedDate": "2020-08-04T19:32:54Z", "message": "Adding info to upgrade notes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzI3NDI5", "url": "https://github.com/apache/lucene-solr/pull/1716#pullrequestreview-461327429", "createdAt": "2020-08-05T04:15:16Z", "commit": {"oid": "af7c31321199ef583601836fdcd0b149425d8eb2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDoxNToxNlrOG75hTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNDoxNToxNlrOG75hTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTQ2MTU4Mg==", "bodyText": "The other caveat is probably that they shouldn't run this command if they have been actively using autoscaling cluster policies before they upgraded to 8.6.0", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r465461582", "createdAt": "2020-08-05T04:15:16Z", "author": {"login": "gus-asf"}, "path": "solr/solr-ref-guide/src/solr-upgrade-notes.adoc", "diffHunk": "@@ -34,17 +34,24 @@ Detailed steps for upgrading a Solr cluster are in the section <<upgrading-a-sol\n \n If you are upgrading from 7.x, see the section <<Upgrading from 7.x Releases>> below.\n \n-=== Solr 8.6.1\n+=== Solr 8.6.1 (Upgrading from 8.6.0 only)\n \n *Autoscaling*\n \n * As mentioned in the 8.6 upgrade notes, a default autoscaling policy was provided starting in 8.6.0.\n This default autoscaling policy resulted in increasingly slow collection creation calls in large clusters (50+ collections).\n +\n In 8.6.1 the default autoscaling policy has been removed, and clouds will not use autoscaling unless a policy has explicitly been created.\n-In order to fix the performance degradations introduced in 8.6.0, merely upgrade to 8.6.1.\n+If your cloud has been upgraded to 8.6.0 and you wish to fix this performance degredations, upgrade to 8.6.1 and remove the default cluster policy via the following command.\n+Replace `localhost:8983` with your Solr endpoint.\n++\n+```\n+curl -X POST -H 'Content-type:application/json'  -d '{set-cluster-policy : []}' http://localhost:8983/api/cluster/autoscaling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af7c31321199ef583601836fdcd0b149425d8eb2"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1606b63a17d7de4b7c838a7bb2b3446c05ded51", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/e1606b63a17d7de4b7c838a7bb2b3446c05ded51", "committedDate": "2020-08-05T14:23:17Z", "message": "Updating wording of upgrade notes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "effbbcac0fbae034e25fd8c1a6047f98f349a27d", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/effbbcac0fbae034e25fd8c1a6047f98f349a27d", "committedDate": "2020-08-05T16:10:07Z", "message": "Adding back in old functionality and making error message better."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/9b7a3884ffb9ce3f244c1a08e9b5681f7e440705", "committedDate": "2020-08-05T16:29:42Z", "message": "Adding missing import."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODUzNzk4", "url": "https://github.com/apache/lucene-solr/pull/1716#pullrequestreview-461853798", "createdAt": "2020-08-05T16:58:53Z", "commit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjo1ODo1M1rOG8ShBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNjo1ODo1M1rOG8ShBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3MTEwOQ==", "bodyText": "from my very limited understanding of this code it appears that something like\n    if (globalTagName.isPresent()) {\n      validateGlobalTag(m, globalTagName.get());\n      globalTag = parse(globalTagName.get(), m);\n ...\nand \n...\n  private void validateGlobalTag(Map<String, Object> m, String tagName) {\n    if (m.size() > 2) {\n      if (!m.containsKey(\"strict\") || m.size() > 3) {\n        throw new RuntimeException(\"Only, 'strict' and one extra tag supported for the tag \" + tagName + \" in \" + toJSONString(m));\n      }\n    }\n  }\n\nwould be the real intention here... but it would be great if @sigram could confirm that.", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r465871109", "createdAt": "2020-08-05T16:58:53Z", "author": {"login": "gus-asf"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/cloud/autoscaling/Clause.java", "diffHunk": "@@ -117,10 +117,10 @@ private Clause(Map<String, Object> m) {\n     strict = Boolean.parseBoolean(String.valueOf(m.getOrDefault(\"strict\", \"true\")));\n     Optional<String> globalTagName = m.keySet().stream().filter(Policy.GLOBAL_ONLY_TAGS::contains).findFirst();\n     if (globalTagName.isPresent()) {\n-      globalTag = parse(globalTagName.get(), m);\n-      if (m.size() > 2) {\n-        throw new RuntimeException(\"Only one extra tag supported for the tag \" + globalTagName.get() + \" in \" + toJSONString(m));\n+      if (m.size() > 3) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzYyNzAy", "url": "https://github.com/apache/lucene-solr/pull/1716#pullrequestreview-462762702", "createdAt": "2020-08-06T18:12:19Z", "commit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoxMjoxOVrOG8-1ZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxODoyOTowNFrOG8_YsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU5NzIyMA==", "bodyText": "Setting preferences to [] actually removes the default preferences that have always been implicitly present, so this changes the behavior as compared with 8.5 and earlier. We should only reset the cluster_policy to [].", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r466597220", "createdAt": "2020-08-06T18:12:19Z", "author": {"login": "sigram"}, "path": "solr/solr-ref-guide/src/solr-upgrade-notes.adoc", "diffHunk": "@@ -34,17 +34,29 @@ Detailed steps for upgrading a Solr cluster are in the section <<upgrading-a-sol\n \n If you are upgrading from 7.x, see the section <<Upgrading from 7.x Releases>> below.\n \n-=== Solr 8.6.1\n+=== Solr 8.6.1 (Upgrading from 8.6.0 only)\n+\n+See the https://cwiki.apache.org/confluence/display/SOLR/ReleaseNote861[8.6.1 Release Notes^]\n+for an overview of the fixes included in Solr 8.6.1.\n+\n+When upgrading to 8.6.1 users should be aware of the following major changes from 8.6.0.\n \n *Autoscaling*\n \n * As mentioned in the 8.6 upgrade notes, a default autoscaling policy was provided starting in 8.6.0.\n This default autoscaling policy resulted in increasingly slow collection creation calls in large clusters (50+ collections).\n +\n In 8.6.1 the default autoscaling policy has been removed, and clouds will not use autoscaling unless a policy has explicitly been created.\n-In order to fix the performance degradations introduced in 8.6.0, merely upgrade to 8.6.1.\n+If your cloud is running 8.6.0 and **not using an explicit autoscaling policy**, upgrade to 8.6.1 and remove the default cluster policy and preferences via the following command.\n+Replace `localhost:8983` with your Solr endpoint.\n++\n+```\n+curl -X POST -H 'Content-type:application/json'  -d '{set-cluster-policy : [], set-cluster-preferences : []}' http://localhost:8983/api/cluster/autoscaling", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU5OTEwMA==", "bodyText": "This statement conflicts with the statement above. 8.5.x and 8.6.1 includes default preferences but not the default policy.", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r466599100", "createdAt": "2020-08-06T18:15:46Z", "author": {"login": "sigram"}, "path": "solr/solr-ref-guide/src/solr-upgrade-notes.adoc", "diffHunk": "@@ -72,7 +84,9 @@ More information about this new feature is available in the section <<common-que\n \n *Autoscaling*\n \n-* Solr now includes a default autoscaling policy.\n+* **NOTE: The default autoscaling policy has been removed as of 8.6.1**\n++\n+Solr now includes a default autoscaling policy.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTM0OQ==", "bodyText": "@gus-asf yes, that's the intent, though your pseudo-code is still incorrect - if there's no strict tag then m.size() > 2 is already an error. In other words, for global tags we expect exactly 2 keys (tag and operand), with optional third key strict.", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r466605349", "createdAt": "2020-08-06T18:27:21Z", "author": {"login": "sigram"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/cloud/autoscaling/Clause.java", "diffHunk": "@@ -117,10 +117,10 @@ private Clause(Map<String, Object> m) {\n     strict = Boolean.parseBoolean(String.valueOf(m.getOrDefault(\"strict\", \"true\")));\n     Optional<String> globalTagName = m.keySet().stream().filter(Policy.GLOBAL_ONLY_TAGS::contains).findFirst();\n     if (globalTagName.isPresent()) {\n-      globalTag = parse(globalTagName.get(), m);\n-      if (m.size() > 2) {\n-        throw new RuntimeException(\"Only one extra tag supported for the tag \" + globalTagName.get() + \" in \" + toJSONString(m));\n+      if (m.size() > 3) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg3MTEwOQ=="}, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNTc3MA==", "bodyText": "+1, this was a genuine bug in 8.5.", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r466605770", "createdAt": "2020-08-06T18:28:10Z", "author": {"login": "sigram"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/cloud/autoscaling/Clause.java", "diffHunk": "@@ -686,7 +686,7 @@ boolean isShardAbsent() {\n       for (Row r : session.matrix) {\n         computedValueEvaluator.node = r.node;\n         SealedClause sealedClause = getSealedClause(computedValueEvaluator);\n-        if (!sealedClause.getGlobalTag().isPass(r)) {\n+        if (r.isLive() && !sealedClause.getGlobalTag().isPass(r)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjYwNjI1Ng==", "bodyText": "+1, this fixed a genuine bug in < 8.6.0", "url": "https://github.com/apache/lucene-solr/pull/1716#discussion_r466606256", "createdAt": "2020-08-06T18:29:04Z", "author": {"login": "sigram"}, "path": "solr/core/src/java/org/apache/solr/cloud/autoscaling/sim/SimScenario.java", "diffHunk": "@@ -814,7 +814,9 @@ public void execute(SimScenario scenario) throws Exception {\n         values.put(key, val);\n       }\n       for (String node : nodes) {\n-        scenario.cluster.getSimNodeStateProvider().simSetNodeValues(node, values);\n+        Map<String, Object> newValues = new HashMap<>(scenario.cluster.getSimNodeStateProvider().simGetNodeValues(node));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b7a3884ffb9ce3f244c1a08e9b5681f7e440705"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a63aec648a9a0fbc2aa5df64df19cefa8593a577", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/a63aec648a9a0fbc2aa5df64df19cefa8593a577", "committedDate": "2020-08-07T16:07:53Z", "message": "Using Gus' logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb079fa90ecc04b980e0de245ffb4ca759d2be1b", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/cb079fa90ecc04b980e0de245ffb4ca759d2be1b", "committedDate": "2020-08-07T16:17:04Z", "message": "Updating changes.txt"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2316, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}