{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwOTQwNzUx", "number": 1909, "title": "LUCENE-9539: Remove caches from SortingCodecReader", "bodyText": "SortingCodecReader keeps all docvalues in memory that are loaded from this reader.\nYet, this reader should only be used for merging which happens sequentially. This makes\ncaching docvalues unnecessary.", "createdAt": "2020-09-22T13:28:31Z", "url": "https://github.com/apache/lucene-solr/pull/1909", "merged": true, "mergeCommit": {"oid": "17c285d61743da0c06735e06235b20bd5aac4e14"}, "closed": true, "closedAt": "2020-09-23T12:21:29Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLX-c9AH2gAyNDkwOTQwNzUxOmYzZWEyYThiYzM0YjlhMWQ2Yjk5NjAxNTZhYWU4MGNhYzUzMTJiNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLrRmwgH2gAyNDkwOTQwNzUxOjA0MzFjNWNlNDUzMWNjZTA2ZWU1OTA2YTdhMzdiYjI3NTA3ZTliZjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3ea2a8bc34b9a1d6b9960156aae80cac5312b49", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/f3ea2a8bc34b9a1d6b9960156aae80cac5312b49", "committedDate": "2020-09-22T13:26:26Z", "message": "LUCENE-9539: Remove caches from SorgingCodecReader\n\nSortingCodecReader keeps all docvalues in memory that are loaded from this reader.\nYet, this reader should only be used for merging which happens sequentially. This makes\ncaching docvalues unnecessary."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNzAzNDkw", "url": "https://github.com/apache/lucene-solr/pull/1909#pullrequestreview-493703490", "createdAt": "2020-09-22T17:45:01Z", "commit": {"oid": "f3ea2a8bc34b9a1d6b9960156aae80cac5312b49"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo0NTowMVrOHWFhtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNzo0NTowMVrOHWFhtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjkyMTI3MA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * NOTE: This reader should only be used for merging. Pulling fields from this ready might be very costly and memory\n          \n          \n            \n             * NOTE: This reader should only be used for merging. Pulling fields from this reader might be very costly and memory", "url": "https://github.com/apache/lucene-solr/pull/1909#discussion_r492921270", "createdAt": "2020-09-22T17:45:01Z", "author": {"login": "jimczi"}, "path": "lucene/core/src/java/org/apache/lucene/index/SortingCodecReader.java", "diffHunk": "@@ -41,21 +41,13 @@\n  * {@link Sort}. This can be used to re-sort and index after it's been created by wrapping all\n  * readers of the index with this reader and adding it to a fresh IndexWriter via\n  * {@link IndexWriter#addIndexes(CodecReader...)}.\n+ * NOTE: This reader should only be used for merging. Pulling fields from this ready might be very costly and memory", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3ea2a8bc34b9a1d6b9960156aae80cac5312b49"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "703f167f90a071198ccb361ef406ec63e79caf2b", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/703f167f90a071198ccb361ef406ec63e79caf2b", "committedDate": "2020-09-22T19:23:02Z", "message": "Update lucene/core/src/java/org/apache/lucene/index/SortingCodecReader.java\n\nCo-authored-by: Jim Ferenczi <jim.ferenczi@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75ab5d3d42269be3a145f68200dba7850ca77e3f", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/75ab5d3d42269be3a145f68200dba7850ca77e3f", "committedDate": "2020-09-22T19:29:38Z", "message": "improve loop readability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ecbf48851c2f3acc179ac26ff654eb6a34499180", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/ecbf48851c2f3acc179ac26ff654eb6a34499180", "committedDate": "2020-09-22T19:46:42Z", "message": "add changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22e5447a17862058f2ca44c0ffa0e246f5a41ec1", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/22e5447a17862058f2ca44c0ffa0e246f5a41ec1", "committedDate": "2020-09-22T20:05:36Z", "message": "fix naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzODIyNjM4", "url": "https://github.com/apache/lucene-solr/pull/1909#pullrequestreview-493822638", "createdAt": "2020-09-22T20:30:47Z", "commit": {"oid": "22e5447a17862058f2ca44c0ffa0e246f5a41ec1"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ad2f2b4433456c1603bbfdeae2f79f7dfff23eb", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/9ad2f2b4433456c1603bbfdeae2f79f7dfff23eb", "committedDate": "2020-09-23T07:21:51Z", "message": "try to cache the last pulled DV / Norms to ensure we reuse the instance during merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fa6437128af08c672a506dfbec69f76285b404c", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/0fa6437128af08c672a506dfbec69f76285b404c", "committedDate": "2020-09-23T07:25:36Z", "message": "add supporess warning"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0Mzk3MjM2", "url": "https://github.com/apache/lucene-solr/pull/1909#pullrequestreview-494397236", "createdAt": "2020-09-23T07:59:31Z", "commit": {"oid": "0fa6437128af08c672a506dfbec69f76285b404c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1OTozMVrOHWbXxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzo1OTozMVrOHWbXxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI3OTE3Mg==", "bodyText": "I think we might cache norms twice if full-text is indexed, as we'd pull norms once for merging norms, and another time to index impacts in postings for the same field.", "url": "https://github.com/apache/lucene-solr/pull/1909#discussion_r493279172", "createdAt": "2020-09-23T07:59:31Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SortingCodecReader.java", "diffHunk": "@@ -510,4 +457,52 @@ public LeafMetaData getMetaData() {\n     return metaData;\n   }\n \n+  // we try to cache the last used DV or Norms instance since during merge\n+  // this instance is used more than once. We could in addition to this single instance\n+  // also cache the fields that are used for sorting since we do the work twice for these fields\n+  private String cachedField;\n+  private Object cachedObject;\n+  private boolean cacheIsNorms;\n+\n+  private <T> T getOrCreateNorms(String field, IOSupplier<T> supplier) throws IOException {\n+    return getOrCreate(field, true, supplier);\n+  }\n+\n+  @SuppressWarnings(\"unchecked\")\n+  private synchronized  <T> T getOrCreate(String field, boolean norms, IOSupplier<T> supplier) throws IOException {\n+    if ((field.equals(cachedField) && cacheIsNorms == norms) == false) {\n+      assert assertCreatedOnlyOnce(field, norms);\n+      cachedObject = supplier.get();\n+      cachedField = field;\n+      cacheIsNorms = norms;\n+\n+    }\n+    assert cachedObject != null;\n+    return (T) cachedObject;\n+  }\n+\n+  private final Map<String, Integer> cacheStats = new HashMap<>(); // only with assertions enabled\n+  private boolean assertCreatedOnlyOnce(String field, boolean norms) {\n+    assert Thread.holdsLock(this);\n+    // this is mainly there to make sure we change anything in the way we merge we realize it early\n+    Integer timesCached = cacheStats.compute(field + \"N:\" + norms, (s, i) -> i == null ? 1 : i.intValue() + 1);\n+    if (timesCached > 1) {\n+      assert norms == false :\"[\" + field + \"] norms must not be cached twice\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0fa6437128af08c672a506dfbec69f76285b404c"}, "originalPosition": 234}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0431c5ce4531cce06ee5906a7a37bb27507e9bf7", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/0431c5ce4531cce06ee5906a7a37bb27507e9bf7", "committedDate": "2020-09-23T11:55:33Z", "message": "beef up test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2309, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}