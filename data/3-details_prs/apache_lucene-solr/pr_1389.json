{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1Mzg4Nzk0", "number": 1389, "title": "LUCENE-9298: Improve RAM accounting in BufferedUpdates when deleted doc IDs and terms are cleared", "bodyText": "the method clearDeletedDocIds in BufferedUpdates.java has a bug, it can't reset bytesUsed correctly.\nvoid clearDeletedDocIds() {\n  deleteDocIDs.clear();\n  bytesUsed.addAndGet(-deleteDocIDs.size() * BufferedUpdates.BYTES_PER_DEL_DOCID);\n}\nthis PR will fix it.", "createdAt": "2020-03-30T03:50:12Z", "url": "https://github.com/apache/lucene-solr/pull/1389", "merged": true, "mergeCommit": {"oid": "2935186c5b807394f25ea7a6d42ee3d7dbef5e43"}, "closed": true, "closedAt": "2020-04-10T10:30:47Z", "author": {"login": "bringyou"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSmHXAgH2gAyMzk1Mzg4Nzk0OjYwNWFmMjNmYjlkZGVjMzZjOTRjYzJjNzZlNTE2YzBiODdmMjlhZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWHiVLgH2gAyMzk1Mzg4Nzk0OmQ3NzQ4MzUyNzQ4NjI0MWE5MWY3ZDFkYzZkNTA3ZDMyZGZmYTAxNDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "605af23fb9ddec36c94cc2c76e516c0b87f29ade", "author": {"user": {"login": "bringyou", "name": "YuBinglei"}}, "url": "https://github.com/apache/lucene-solr/commit/605af23fb9ddec36c94cc2c76e516c0b87f29ade", "committedDate": "2020-03-30T03:41:09Z", "message": "Update BufferedUpdates.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MjQ0NjIx", "url": "https://github.com/apache/lucene-solr/pull/1389#pullrequestreview-385244621", "createdAt": "2020-04-01T03:35:15Z", "commit": {"oid": "605af23fb9ddec36c94cc2c76e516c0b87f29ade"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1afaa05e3f89d40734451db73fe83da60101513", "author": {"user": {"login": "bringyou", "name": "YuBinglei"}}, "url": "https://github.com/apache/lucene-solr/commit/b1afaa05e3f89d40734451db73fe83da60101513", "committedDate": "2020-04-08T16:08:06Z", "message": "1. add UnitTest for BufferedUpdates;\n2. decrease bytesUsed when clearDeleteTerms;\n3. fix the clearDeletedDocIds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "691f1f93177664ad9cd10eaf7e1aa1ea0162e80c", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/691f1f93177664ad9cd10eaf7e1aa1ea0162e80c", "committedDate": "2020-04-08T16:08:52Z", "message": "Merge branch 'master' of https://github.com/bringyou/lucene-solr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "421d83413b2f004c963ca941e501583cf2a072c6", "author": {"user": {"login": "bringyou", "name": "YuBinglei"}}, "url": "https://github.com/apache/lucene-solr/commit/421d83413b2f004c963ca941e501583cf2a072c6", "committedDate": "2020-04-08T16:21:07Z", "message": "add license for TestBufferedUpdates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzEwMDk5", "url": "https://github.com/apache/lucene-solr/pull/1389#pullrequestreview-390310099", "createdAt": "2020-04-08T20:33:04Z", "commit": {"oid": "421d83413b2f004c963ca941e501583cf2a072c6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDozMzowNFrOGC_36w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMDozMzowNFrOGC_36w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTc5Njg0Mw==", "bodyText": "Instead of counting this here on clear, can we use a second counter for the deleteTerms next to bytesUsed? This would be great. It doesn't need to be thread safe IMO", "url": "https://github.com/apache/lucene-solr/pull/1389#discussion_r405796843", "createdAt": "2020-04-08T20:33:04Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/BufferedUpdates.java", "diffHunk": "@@ -176,8 +176,11 @@ void addBinaryUpdate(BinaryDocValuesUpdate update, int docIDUpto) {\n   }\n \n   void clearDeleteTerms() {\n-    deleteTerms.clear();\n     numTermDeletes.set(0);\n+    deleteTerms.forEach((term, docIDUpto) -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "421d83413b2f004c963ca941e501583cf2a072c6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f661d4341e8e72e41eb7da07f753dbfd66a1d58", "author": {"user": {"login": "bringyou", "name": "YuBinglei"}}, "url": "https://github.com/apache/lucene-solr/commit/0f661d4341e8e72e41eb7da07f753dbfd66a1d58", "committedDate": "2020-04-09T02:46:11Z", "message": "add new counter for terms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNTYyNTIx", "url": "https://github.com/apache/lucene-solr/pull/1389#pullrequestreview-390562521", "createdAt": "2020-04-09T07:47:29Z", "commit": {"oid": "0f661d4341e8e72e41eb7da07f753dbfd66a1d58"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzoyOVrOGDNVlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQwNzo0NzoyOVrOGDNVlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjAxNzQzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              private final Counter termsBytesUsed = Counter.newCounter();\n          \n          \n            \n              private final Counter termsBytesUsed = Counter.newCounter(true);\n          \n      \n    \n    \n  \n\nSorry I looked at it again and we have one case where we use it in a global context in the delete queue so we need the threadsafety. Rest looks great.", "url": "https://github.com/apache/lucene-solr/pull/1389#discussion_r406017431", "createdAt": "2020-04-09T07:47:29Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/BufferedUpdates.java", "diffHunk": "@@ -80,6 +80,7 @@ load factor (say 2 * POINTER).  Entry is object w/\n \n   private final Counter bytesUsed = Counter.newCounter(true);\n   final Counter fieldUpdatesBytesUsed = Counter.newCounter(true);\n+  private final Counter termsBytesUsed = Counter.newCounter();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f661d4341e8e72e41eb7da07f753dbfd66a1d58"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2038dfed3c10d0f5b5ba36c98975157442e57fe", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/e2038dfed3c10d0f5b5ba36c98975157442e57fe", "committedDate": "2020-04-09T07:48:14Z", "message": "Update lucene/core/src/java/org/apache/lucene/index/BufferedUpdates.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27813700fb79e7f00649ab40a1481754e0b3d676", "author": {"user": {"login": "bringyou", "name": "YuBinglei"}}, "url": "https://github.com/apache/lucene-solr/commit/27813700fb79e7f00649ab40a1481754e0b3d676", "committedDate": "2020-04-10T02:18:51Z", "message": "add changelogs for our changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d77483527486241a91f7d1dc6d507d32dffa0140", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/d77483527486241a91f7d1dc6d507d32dffa0140", "committedDate": "2020-04-10T02:19:15Z", "message": "Merge remote-tracking branch 'origin/master'"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2067, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}