{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwNDA2NzAw", "number": 1360, "title": "LUCENE-9281: Retire SPIClassIterator from master because Java 9+ uses different mechanism to load services when module system is used", "bodyText": "See https://issues.apache.org/jira/browse/LUCENE-9281 for more details:\nWe currently have our own implementation of the service loader standard (SPI) fo several reasons:\n(1) In some older JDKs the order of classpath was not respected and this lead to wrong order of codecs implementing the same SPI name. This caused tests to sometimes use wrong class (we had this in Lucene 4 where we had a test-only read/write Lucene3 codec that was listed before the read-only one). That's no longer an issue, the order of loading does not matter. In addition, Java now does everything correct.\n(2) In Analysis, we require SPI classes to have a constructor taking args (a Map of params in our case). We also extract the NAME from a static field. Standard service loader does not support this, it tries to instantiate the class with default ctor.\nWith Java 9+, the ServiceLoader now has a stream() method that allows to filter and preprocess classes: https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.html#stream()\nThis allows us to use the new interface and just get the loaded class (which may come from module-info.class or a conventional SPI file): https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/ServiceLoader.Provider.html#type()\nThis change allows us to convert Lucene to modules listing all SPIs in the module-info.java.", "createdAt": "2020-03-18T12:29:38Z", "url": "https://github.com/apache/lucene-solr/pull/1360", "merged": true, "mergeCommit": {"oid": "2c7a7109456e8c018b286ff43f754d77c5064d79"}, "closed": true, "closedAt": "2020-03-25T17:03:37Z", "author": {"login": "uschindler"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcO2jCdAH2gAyMzkwNDA2NzAwOmY1YWExMGE3ZDhmNDI5ZTczNTdjNzQ4NmQ3OWIwOGU2MmUyZDU1M2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRKZiEAFqTM4MTM0MTE3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5aa10a7d8f429e7357c7486d79b08e62e2d553f", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/f5aa10a7d8f429e7357c7486d79b08e62e2d553f", "committedDate": "2020-03-18T12:34:10Z", "message": "LUCENE-9281: First mockup of SPIClassIterator retirement"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c3a7b3b7c396b0bfe8d1d798ed16bb8a7705117d", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/c3a7b3b7c396b0bfe8d1d798ed16bb8a7705117d", "committedDate": "2020-03-18T12:28:39Z", "message": "LUCENE-9281: First mockup of SPIClassIterator retirement"}, "afterCommit": {"oid": "f5aa10a7d8f429e7357c7486d79b08e62e2d553f", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/f5aa10a7d8f429e7357c7486d79b08e62e2d553f", "committedDate": "2020-03-18T12:34:10Z", "message": "LUCENE-9281: First mockup of SPIClassIterator retirement"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4MzcwNzcz", "url": "https://github.com/apache/lucene-solr/pull/1360#pullrequestreview-378370773", "createdAt": "2020-03-20T10:30:07Z", "commit": {"oid": "f5aa10a7d8f429e7357c7486d79b08e62e2d553f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozMDowN1rOF5OcRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxMDozMDowN1rOF5OcRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTU0OTc2Ng==", "bodyText": "This could be package private (since the original method was not public and still this is called only from classes in the same package)?", "url": "https://github.com/apache/lucene-solr/pull/1360#discussion_r395549766", "createdAt": "2020-03-20T10:30:07Z", "author": {"login": "mocobeta"}, "path": "lucene/analysis/common/src/java/org/apache/lucene/analysis/util/AnalysisSPILoader.java", "diffHunk": "@@ -143,6 +144,24 @@ public S newInstance(String name, Map<String,String> args) {\n   public Set<String> availableServices() {\n     return originalNames;\n   }  \n+\n+  /**\n+   * Looks up SPI name (static \"NAME\" field) with appropriate modifiers.\n+   * Also it must be a String class and declared in the concrete class.\n+   * @return the SPI name\n+   * @throws NoSuchFieldException - if the \"NAME\" field is not defined.\n+   * @throws IllegalAccessException - if the \"NAME\" field is inaccessible.\n+   * @throws IllegalStateException - if the \"NAME\" field does not have appropriate modifiers or isn't a String field.\n+   */\n+  public static String lookupSPIName(Class<? extends AbstractAnalysisFactory> service) throws NoSuchFieldException, IllegalAccessException, IllegalStateException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5aa10a7d8f429e7357c7486d79b08e62e2d553f"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6775c0ca029d136d9323f3f1dff2252d293840f8", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/6775c0ca029d136d9323f3f1dff2252d293840f8", "committedDate": "2020-03-24T16:18:15Z", "message": "Merge branch 'master' of https://gitbox.apache.org/repos/asf/lucene-solr into jira/LUCENE-9281"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b5c3e5647fe70471be09b6b750d8b3cca3230fb", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/1b5c3e5647fe70471be09b6b750d8b3cca3230fb", "committedDate": "2020-03-24T17:29:34Z", "message": "LUCENE-9281: Add empty ctor to all factories to make them compatible with SPI requirements enforced by ServiceLoader"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0183775684fc61f230113b0690d51dfad04e20e", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/c0183775684fc61f230113b0690d51dfad04e20e", "committedDate": "2020-03-25T13:30:42Z", "message": "LUCENE-9281: Javadocs updates and formatting changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d90d1b35e5b37a89220c5f4a3f1fb9efca414bf3", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/d90d1b35e5b37a89220c5f4a3f1fb9efca414bf3", "committedDate": "2020-03-25T13:51:52Z", "message": "LUCENE-9281: Add migration guide and changes entry"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjYzNDgz", "url": "https://github.com/apache/lucene-solr/pull/1360#pullrequestreview-381263483", "createdAt": "2020-03-25T15:29:30Z", "commit": {"oid": "d90d1b35e5b37a89220c5f4a3f1fb9efca414bf3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToyOTozMFrOF7gvmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToyOTozMFrOF7gvmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk0Njc3Ng==", "bodyText": "i did nothing here and had no idea about this issue...", "url": "https://github.com/apache/lucene-solr/pull/1360#discussion_r397946776", "createdAt": "2020-03-25T15:29:30Z", "author": {"login": "mocobeta"}, "path": "lucene/CHANGES.txt", "diffHunk": "@@ -47,6 +47,13 @@ API Changes\n * LUCENE-9264: SimpleFSDirectory has been removed in favor of NIOFSDirectory.\n   (Yannick Welsch)\n \n+* LUCENE-9281: Use java.util.ServiceLoader to load codec components and analysis\n+  factories to be compatible with Java Module System. This allows to load factories\n+  without META-INF/service from a Java module exposing the factory in the module\n+  descriptor. This breaks backwards compatibility as custom factories must now\n+  also implement the default constructor (see MIGRATE.txt).\n+  (Uwe Schindler, Dawid Weiss, Tomoko Uchida)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d90d1b35e5b37a89220c5f4a3f1fb9efca414bf3"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d792a6a2b701701125cdcec02f96bcd9cced6e1", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/9d792a6a2b701701125cdcec02f96bcd9cced6e1", "committedDate": "2020-03-25T15:38:50Z", "message": "LUCENE-9281: Remove Tomoko from CHANGES.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b97449c0075561ff3bfdc76a03b52a0eebcda48c", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/b97449c0075561ff3bfdc76a03b52a0eebcda48c", "committedDate": "2020-03-25T16:22:43Z", "message": "LUCENE-9281: be more specific in CHANGES.txt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMzQxMTc4", "url": "https://github.com/apache/lucene-solr/pull/1360#pullrequestreview-381341178", "createdAt": "2020-03-25T16:49:44Z", "commit": {"oid": "b97449c0075561ff3bfdc76a03b52a0eebcda48c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2210, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}