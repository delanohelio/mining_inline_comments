{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NzYxODMz", "number": 1877, "title": "SOLR-13181: param macro expansion could throw", "bodyText": "StringIndexOutOfBoundsException on bad syntax\nTODO run tests etc.\nhttps://issues.apache.org/jira/browse/SOLR-13181", "createdAt": "2020-09-16T06:25:35Z", "url": "https://github.com/apache/lucene-solr/pull/1877", "merged": true, "mergeCommit": {"oid": "2197776be67384d628f12a5def8663db9e4220cf"}, "closed": true, "closedAt": "2020-09-22T19:47:00Z", "author": {"login": "dsmiley"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJWTC2AH2gAyNDg3NzYxODMzOjczMTJjZWY3ZmRkMjY5Yzg2M2RmZWMzNmQ0OTE2YTM2ODU5NzE0OGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLZ4IEAH2gAyNDg3NzYxODMzOjE3OGFmZDA0NWQxNDMwMjM4NmMyZDI3MzA1NzdjYTAzMTk3OWQyMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/7312cef7fdd269c863dfec36d4916a368597148b", "committedDate": "2020-09-16T06:21:16Z", "message": "SOLR-13181: param macro expansion could throw\nStringIndexOutOfBoundsException on bad syntax"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjYyNjA4", "url": "https://github.com/apache/lucene-solr/pull/1877#pullrequestreview-489662608", "createdAt": "2020-09-16T14:06:19Z", "commit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDowNjoyMFrOHSyleA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNDoxOToyMFrOHSzLJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NTIwOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int matchedStart = idx;\n          \n          \n            \n                  final int matchedStart = idx;", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489465208", "createdAt": "2020-09-16T14:06:20Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,11 +136,12 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      int matchedStart = idx;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ2NTc3OA==", "bodyText": "How about removing rather than amending the // String inbetween = val.substring(idx, rbrace); commented out code line?", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489465778", "createdAt": "2020-09-16T14:07:05Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -154,14 +155,14 @@ else if (idx < 0) {\n       }\n \n       if (matchedStart > 0) {\n-        sb.append(val.substring(start, matchedStart));\n+        sb.append(val, start, matchedStart);\n       }\n \n       // update \"start\" to be at the end of ${...}\n-      start = rbrace + 1;\n+      idx = start = rbrace + 1;\n \n-      // String inbetween = val.substring(idx, rbrace);\n-      StrParser parser = new StrParser(val, idx, rbrace);\n+      // String in-between = val.substring(idx, rbrace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3MDE3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  int rbrace = val.indexOf('}', idx);\n          \n          \n            \n                  int rbrace = val.indexOf('}', matchedStart + macroStart.length());\n          \n      \n    \n    \n  \n\nsimilar to line 165 below and then the idx += macroStart.length(); assignment would not be needed since there would be no use of idx between that incrementing assigment and the idx = start = rbrace + 1; resetting assignment below.", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489470172", "createdAt": "2020-09-16T14:13:08Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,11 +136,12 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      int matchedStart = idx;\n       idx += macroStart.length();\n \n       int rbrace = val.indexOf('}', idx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ3NDg1NA==", "bodyText": "observation: foo.append(bar.substring(x,y)); is also found in other places in the code base, not sure how it might work implementation wise but it would be lovely if tooling would flag up that there's a more efficient alternative", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r489474854", "createdAt": "2020-09-16T14:19:20Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -188,7 +189,7 @@ else if (failOnMissingParams) {\n \n       } catch (SyntaxError syntaxError) {\n         // append the part we would have skipped\n-        sb.append( val.substring(matchedStart, start) );\n+        sb.append(val, matchedStart, start);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7312cef7fdd269c863dfec36d4916a368597148b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68083e1d5a54d44521417887553610f689dff9f1", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/68083e1d5a54d44521417887553610f689dff9f1", "committedDate": "2020-09-17T17:18:13Z", "message": "Update solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\nCo-authored-by: Christine Poerschke <cpoerschke@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/c04ae84543bd80fe8adf6e5724c68ac8793bd263", "committedDate": "2020-09-17T17:19:00Z", "message": "Update solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java\n\nCo-authored-by: Christine Poerschke <cpoerschke@apache.org>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODM0ODky", "url": "https://github.com/apache/lucene-solr/pull/1877#pullrequestreview-490834892", "createdAt": "2020-09-17T17:33:42Z", "commit": {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzozMzo0MlrOHTt-fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNzozMzo0MlrOHTt-fA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQzODI2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  // String in-between = val.substring(idx, rbrace);\n          \n          \n            \n                  // String in-between braces", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r490438268", "createdAt": "2020-09-17T17:33:42Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -154,14 +155,14 @@ else if (idx < 0) {\n       }\n \n       if (matchedStart > 0) {\n-        sb.append(val.substring(start, matchedStart));\n+        sb.append(val, start, matchedStart);\n       }\n \n       // update \"start\" to be at the end of ${...}\n-      start = rbrace + 1;\n+      idx = start = rbrace + 1;\n \n-      // String inbetween = val.substring(idx, rbrace);\n-      StrParser parser = new StrParser(val, idx, rbrace);\n+      // String in-between = val.substring(idx, rbrace);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODg5MzEx", "url": "https://github.com/apache/lucene-solr/pull/1877#pullrequestreview-490889311", "createdAt": "2020-09-17T18:48:18Z", "commit": {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODo0ODoxOFrOHTwipA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODo0ODoxOFrOHTwipA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ4MDI5Mg==", "bodyText": "Can now remove idx manipulation until later when idx & start are changed in one line\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  idx += macroStart.length();", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r490480292", "createdAt": "2020-09-17T18:48:18Z", "author": {"login": "dsmiley"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -136,14 +136,15 @@ private String _expand(String val) {\n       }\n       else if (idx < 0) {\n         if (sb == null) return val;\n-        sb.append(val.substring(start));\n+        sb.append(val, start, val.length());\n         return sb.toString();\n       }\n \n       // found unescaped \"${\"\n+      final int matchedStart = idx;\n       idx += macroStart.length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c04ae84543bd80fe8adf6e5724c68ac8793bd263"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0", "committedDate": "2020-09-17T18:49:11Z", "message": "Apply suggestions from code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNTg4NzUx", "url": "https://github.com/apache/lucene-solr/pull/1877#pullrequestreview-491588751", "createdAt": "2020-09-18T15:53:52Z", "commit": {"oid": "9e6dd9d31bdc662ae39c592e8a59bfeb7edc95d0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa", "committedDate": "2020-09-18T21:56:31Z", "message": "fix infinite loop when no close.\nfailOnMissingParams: should have been returning null in more cases."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODEwMjg2", "url": "https://github.com/apache/lucene-solr/pull/1877#pullrequestreview-492810286", "createdAt": "2020-09-21T16:59:25Z", "commit": {"oid": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNjo1OToyNVrOHVaMgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzowODozNlrOHVag_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxMTMzMA==", "bodyText": "... fix infinite loop when no close ...\n\nAh, yes, good catch!\nAnd since the logic in the loop is quite complex the \"infinite loop\" wording inspired me to go lookup again about the loop invariants and loop variants concepts and work it through here:\n\nval.size() - idx looks like the loops variant and to ensure loop termination it must decrease i.e. idx must advance (or we must break or return out of the loop)\nidx > 0 leads to advancing\nidx < 0 previously returned and now it breaks i.e. either gets us out of the loop\nidx == 0 if combined with rbrace == -1 i.e. no closing would get us stuck in the loop if continue is used but both return null or break get us out of the loop", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492211330", "createdAt": "2020-09-21T16:59:25Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/request/macro/MacroExpander.java", "diffHunk": "@@ -135,33 +135,34 @@ private String _expand(String val) {\n         }\n       }\n       else if (idx < 0) {\n-        if (sb == null) return val;\n-        sb.append(val.substring(start));\n-        return sb.toString();\n+        break;\n       }\n \n       // found unescaped \"${\"\n-      idx += macroStart.length();\n+      final int matchedStart = idx;\n \n-      int rbrace = val.indexOf('}', idx);\n+      int rbrace = val.indexOf('}', matchedStart + macroStart.length());\n       if (rbrace == -1) {\n         // no matching close brace...\n-        continue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIxNjU3NQ==", "bodyText": "How about adding (say) ${goodAnswer} ${noClose as another case and it turning into 42 ${noClose if there is a goodAnswer=42 mapping i.e. to demonstrate that absence of closing curly bracket partially affects expansion (as opposed to no expansion at all happening)?", "url": "https://github.com/apache/lucene-solr/pull/1877#discussion_r492216575", "createdAt": "2020-09-21T17:08:36Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/test/org/apache/solr/request/macro/TestMacroExpander.java", "diffHunk": "@@ -143,15 +142,31 @@ public void testMapExprExpandOn() {\n     String oldVal = System.getProperty(\"StreamingExpressionMacros\",\"false\");\n     System.setProperty(\"StreamingExpressionMacros\", \"true\");\n     try {\n-      @SuppressWarnings({\"rawtypes\"})\n-      Map expanded = MacroExpander.expand(request);\n-      assertEquals(\"zero\", ((String[])expanded.get(\"fq\"))[0]);\n-      assertEquals(\"one\", ((String[])expanded.get(\"fq\"))[1]);\n-      assertEquals(\"two\", ((String[]) expanded.get(\"fq\"))[2]);\n-      assertEquals(\"three\", ((String[]) expanded.get(\"fq\"))[3]);\n-      assertEquals(\"one\", ((String[])expanded.get(\"expr\"))[0]);\n+      Map<String, String[]> expanded = MacroExpander.expand(request);\n+      assertEquals(\"zero\", expanded.get(\"fq\")[0]);\n+      assertEquals(\"one\", expanded.get(\"fq\")[1]);\n+      assertEquals(\"two\", expanded.get(\"fq\")[2]);\n+      assertEquals(\"three\", expanded.get(\"fq\")[3]);\n+      assertEquals(\"one\", expanded.get(\"expr\")[0]);\n     } finally {\n       System.setProperty(\"StreamingExpressionMacros\", oldVal);\n     }\n   }\n+\n+  @Test\n+  public void testUnbalanced() { // SOLR-13181\n+    final MacroExpander meSkipOnMissingParams = new MacroExpander(Collections.emptyMap());\n+    final MacroExpander meFailOnMissingParams = new MacroExpander(Collections.emptyMap(), true);\n+    assertEquals(\"${noClose\", meSkipOnMissingParams.expand(\"${noClose\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72e2d6cd4df90d7dc59f1cdbf3e7ab48cdf98daa"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0eb63f6f4a71c292e0492e85e2ec52d2e35f891e", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/0eb63f6f4a71c292e0492e85e2ec52d2e35f891e", "committedDate": "2020-09-21T17:17:26Z", "message": "CHANGES.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "178afd045d14302386c2d2730577ca031979d214", "author": {"user": {"login": "cpoerschke", "name": "Christine Poerschke"}}, "url": "https://github.com/apache/lucene-solr/commit/178afd045d14302386c2d2730577ca031979d214", "committedDate": "2020-09-22T15:39:20Z", "message": "demonstrate partial expansion behaviour in TestMacroExpander.testUnbalanced"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2280, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}