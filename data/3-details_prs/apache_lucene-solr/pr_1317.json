{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTg3ODAz", "number": 1317, "title": "SOLR-13101: Create metadataSuffix znode only at common shard creating api calls", "bodyText": "Shared collections make use of something called the metadataSuffix znode per shard in ZooKeeper to understand what core.metadata file to pull from blob store and hydrate a replica with the most up-to-date and correct index data. Shared collections would create the node on-demand with a default value (e.g. indexing) but this is not correct behavior when considering restore operations in the future. We'll want to create the node with a non-default value down the line.\nThis change initiates the node when we create the shard in common collection API commands and includes CREATE, CREATESHARD, SPLITSHARD. Other operations such as RESTORE are not currently supported by solr shared storage so are not in scope of this change.", "createdAt": "2020-03-05T00:00:06Z", "url": "https://github.com/apache/lucene-solr/pull/1317", "merged": true, "mergeCommit": {"oid": "e0a0e2e5bfbc51d0222d101426808d82a402dc67"}, "closed": true, "closedAt": "2020-03-16T17:11:53Z", "author": {"login": "andyvuong"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKf1CngH2gAyMzgzOTg3ODAzOmRlNzRjNWYwMDFhZWFlNjg1OWM1OGEzZDlhYTE0ZDgxOWVjNTY5ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNaxD4gFqTM3NDY4NzE2NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "de74c5f001aeae6859c58a3d9aa14d819ec569e9", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/de74c5f001aeae6859c58a3d9aa14d819ec569e9", "committedDate": "2020-03-04T23:50:19Z", "message": "Create metadataSuffix znode only at common shard creating api calls"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyOTU0NTEy", "url": "https://github.com/apache/lucene-solr/pull/1317#pullrequestreview-372954512", "createdAt": "2020-03-11T17:03:49Z", "commit": {"oid": "de74c5f001aeae6859c58a3d9aa14d819ec569e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzowMzo0OVrOF1AVmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNzowMzo0OVrOF1AVmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTEyNDM3Ng==", "bodyText": "Wouldn't it be more appropriate to call it createMetadataNode and fail in case the node already exists?", "url": "https://github.com/apache/lucene-solr/pull/1317#discussion_r391124376", "createdAt": "2020-03-11T17:03:49Z", "author": {"login": "mbwaheed"}, "path": "solr/core/src/java/org/apache/solr/store/shared/metadata/SharedShardMetadataController.java", "diffHunk": "@@ -53,12 +53,12 @@ public SharedShardMetadataController(SolrCloudManager cloudManager) {\n   \n   /**\n    * Creates a new metadata node if it doesn't exist for shared shared index whose correctness metadata \n-   * is managed by ZooKeeper\n+   * is managed by ZooKeeper. This node should only be created during Shard creation or Recovery events\n    *  \n    * @param collectionName name of the collection that needs a metadata node\n    * @param shardName name of the shard that needs a metadata node\n    */\n-  public void ensureMetadataNodeExists(String collectionName, String shardName) throws IOException {\n+  public void initiateMetadataNode(String collectionName, String shardName) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de74c5f001aeae6859c58a3d9aa14d819ec569e9"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8", "author": {"user": {"login": "andyvuong", "name": "Andy Vuong"}}, "url": "https://github.com/apache/lucene-solr/commit/0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8", "committedDate": "2020-03-14T01:25:38Z", "message": "Throw error if node already exists"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg2NDUx", "url": "https://github.com/apache/lucene-solr/pull/1317#pullrequestreview-374686451", "createdAt": "2020-03-14T01:28:30Z", "commit": {"oid": "0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMToyODozMFrOF2XA2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMToyODozMFrOF2XA2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NDQ3Mw==", "bodyText": "#makePath will also throw an AlreadyExistsException if the node exists and failOnExists=true", "url": "https://github.com/apache/lucene-solr/pull/1317#discussion_r392544473", "createdAt": "2020-03-14T01:28:30Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/store/shared/metadata/SharedShardMetadataController.java", "diffHunk": "@@ -146,20 +148,18 @@ public void cleanUpMetadataNodes(String collectionName, String shardName) {\n     }\n   }\n \n-  private void createPersistentNodeIfNonExistent(String path, byte[] data) {\n+  private void createPersistentNode(String path, byte[] data) {\n     try {\n       if (!stateManager.hasData(path)) {\n-        try {\n-          stateManager.makePath(path, data, CreateMode.PERSISTENT, /* failOnExists */ false);\n-        } catch (AlreadyExistsException e) {\n-          // it's okay if another beats us creating the node\n-        }\n+        stateManager.makePath(path, data, CreateMode.PERSISTENT, /* failOnExists */ true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Njg3MTY0", "url": "https://github.com/apache/lucene-solr/pull/1317#pullrequestreview-374687164", "createdAt": "2020-03-14T01:37:34Z", "commit": {"oid": "0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMTozNzozNFrOF2XDvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwMTozNzozNFrOF2XDvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU0NTIxNA==", "bodyText": "few typos.", "url": "https://github.com/apache/lucene-solr/pull/1317#discussion_r392545214", "createdAt": "2020-03-14T01:37:34Z", "author": {"login": "mbwaheed"}, "path": "solr/core/src/test/org/apache/solr/store/shared/metadata/SharedShardMetadataControllerTest.java", "diffHunk": "@@ -77,10 +77,26 @@ public void cleanup() throws Exception {\n    */\n   @Test\n   public void testSetupMetadataNode() throws Exception {    \n-    shardMetadataController.ensureMetadataNodeExists(TEST_COLLECTION_NAME, TEST_SHARD_NAME);\n+    shardMetadataController.createMetadataNode(TEST_COLLECTION_NAME, TEST_SHARD_NAME);\n     assertTrue(cluster.getZkClient().exists(metadataNodePath, false));\n   }\n   \n+  /**\n+   * Test if we try to create the same metadat anode twice, we faile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f30bc90e2a9c93a5a54c5c7ea4a4a27dc5e74a8"}, "originalPosition": 10}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2175, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}