{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MjM3MjM3", "number": 1444, "title": "LUCENE-9338: Clean up type safety in SimpleBindings", "bodyText": "Replaces SimpleBindings' Map<String, Object> with a map of\nSupplier<DoubleValuesSource> to improve type safety.  Also moves cycle\ndetection directly into ExpressionValuesSource.", "createdAt": "2020-04-22T11:47:00Z", "url": "https://github.com/apache/lucene-solr/pull/1444", "merged": true, "mergeCommit": {"oid": "ed3caab2d86b69ec4b3ed8e787827c0931b43d1b"}, "closed": true, "closedAt": "2020-04-24T09:23:51Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaGye2gH2gAyNDA3MjM3MjM3OjY2YjRjNTRlMDgzNWM5NmZhMjE4OWQ4MWU2NjExYmE4NGMyNWVlZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcatyowgFqTM5OTc3MjQyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66b4c54e0835c96fa2189d81e6611ba84c25eefd", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/apache/lucene-solr/commit/66b4c54e0835c96fa2189d81e6611ba84c25eefd", "committedDate": "2020-04-22T11:42:41Z", "message": "Clean up type safety in SimpleBindings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MTQ5OTI4", "url": "https://github.com/apache/lucene-solr/pull/1444#pullrequestreview-398149928", "createdAt": "2020-04-22T12:43:21Z", "commit": {"oid": "66b4c54e0835c96fa2189d81e6611ba84c25eefd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMjo0MzoyMVrOGJ0Vvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxMjo0MzoyMVrOGJ0Vvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjk0NzkwMw==", "bodyText": "Hmm this is a pre-existing issues but catching stack overflows is usually a bad idea as it might leave objects in an inconsistent state. I wonder if it could be checked differently. Also is it ok to move the catch from validate() to here?", "url": "https://github.com/apache/lucene-solr/pull/1444#discussion_r412947903", "createdAt": "2020-04-22T12:43:21Z", "author": {"login": "jpountz"}, "path": "lucene/expressions/src/java/org/apache/lucene/expressions/ExpressionValueSource.java", "diffHunk": "@@ -42,13 +42,17 @@\n     this.expression = Objects.requireNonNull(expression);\n     variables = new DoubleValuesSource[expression.variables.length];\n     boolean needsScores = false;\n-    for (int i = 0; i < variables.length; i++) {\n-      DoubleValuesSource source = bindings.getDoubleValuesSource(expression.variables[i]);\n-      if (source == null) {\n-        throw new RuntimeException(\"Internal error. Variable (\" + expression.variables[i] + \") does not exist.\");\n+    try {\n+      for (int i = 0; i < variables.length; i++) {\n+        DoubleValuesSource source = bindings.getDoubleValuesSource(expression.variables[i]);\n+        if (source == null) {\n+          throw new RuntimeException(\"Internal error. Variable (\" + expression.variables[i] + \") does not exist.\");\n+        }\n+        needsScores |= source.needsScores();\n+        variables[i] = source;\n       }\n-      needsScores |= source.needsScores();\n-      variables[i] = source;\n+    } catch (StackOverflowError e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66b4c54e0835c96fa2189d81e6611ba84c25eefd"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "423c9da6aa661e157c324c22b47cc3181abbfef9", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/apache/lucene-solr/commit/423c9da6aa661e157c324c22b47cc3181abbfef9", "committedDate": "2020-04-23T09:39:25Z", "message": "Improve cycle detection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4a935d2c5ca6e563aa17801b535891eb9d11bc9", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/apache/lucene-solr/commit/f4a935d2c5ca6e563aa17801b535891eb9d11bc9", "committedDate": "2020-04-23T13:34:25Z", "message": "Merge remote-tracking branch 'origin/master' into simplebindings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f31cb0601615b147f1f980115216f0965b092287", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/apache/lucene-solr/commit/f31cb0601615b147f1f980115216f0965b092287", "committedDate": "2020-04-23T13:44:37Z", "message": "Detect recursion at more than one level"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjI5Njkz", "url": "https://github.com/apache/lucene-solr/pull/1444#pullrequestreview-399229693", "createdAt": "2020-04-23T15:42:00Z", "commit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0MjowMFrOGKu6Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNTo0MjowMFrOGKu6Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkwNzQ2Mg==", "bodyText": "Have you considered returning the map, or an immutable view on it, so that callers can use this to enumerate all the dependencies? In a similar framework, I've found this to be pretty helpful for analyzing query patterns. It's also nice to know if the same name occurs multiple times in the dependency tree; maybe one should cache its value in that case.", "url": "https://github.com/apache/lucene-solr/pull/1444#discussion_r413907462", "createdAt": "2020-04-23T15:42:00Z", "author": {"login": "msokolov"}, "path": "lucene/expressions/src/java/org/apache/lucene/expressions/SimpleBindings.java", "diffHunk": "@@ -96,24 +90,51 @@ public DoubleValuesSource getDoubleValuesSource(String name) {\n       case SCORE:\n         return DoubleValuesSource.SCORES;\n       default:\n-        throw new UnsupportedOperationException(); \n+        throw new UnsupportedOperationException();\n     }\n   }\n   \n-  /** \n-   * Traverses the graph of bindings, checking there are no cycles or missing references \n-   * @throws IllegalArgumentException if the bindings is inconsistent \n+  @Override\n+  public DoubleValuesSource getDoubleValuesSource(String name) {\n+    if (map.containsKey(name) == false) {\n+      throw new IllegalArgumentException(\"Invalid reference '\" + name + \"'\");\n+    }\n+    return map.get(name).apply(this);\n+  }\n+\n+  /**\n+   * Traverses the graph of bindings, checking there are no cycles or missing references\n+   * @throws IllegalArgumentException if the bindings is inconsistent\n    */\n   public void validate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5MjU5NDk4", "url": "https://github.com/apache/lucene-solr/pull/1444#pullrequestreview-399259498", "createdAt": "2020-04-23T16:14:02Z", "commit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNjoxNDowMlrOGKwdzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxNjoxNDowMlrOGKwdzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzkzMzAwNw==", "bodyText": "Is containsKey boolean check more clear than get with a null check? I think the latter is going to be more efficient because it's only a single map operation, but I guess this way might be better for the JVM's escape analysis?", "url": "https://github.com/apache/lucene-solr/pull/1444#discussion_r413933007", "createdAt": "2020-04-23T16:14:02Z", "author": {"login": "madrob"}, "path": "lucene/expressions/src/java/org/apache/lucene/expressions/SimpleBindings.java", "diffHunk": "@@ -96,24 +90,51 @@ public DoubleValuesSource getDoubleValuesSource(String name) {\n       case SCORE:\n         return DoubleValuesSource.SCORES;\n       default:\n-        throw new UnsupportedOperationException(); \n+        throw new UnsupportedOperationException();\n     }\n   }\n   \n-  /** \n-   * Traverses the graph of bindings, checking there are no cycles or missing references \n-   * @throws IllegalArgumentException if the bindings is inconsistent \n+  @Override\n+  public DoubleValuesSource getDoubleValuesSource(String name) {\n+    if (map.containsKey(name) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "originalPosition": 75}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5Njk1Njgz", "url": "https://github.com/apache/lucene-solr/pull/1444#pullrequestreview-399695683", "createdAt": "2020-04-24T07:16:27Z", "commit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNzoxNjoyOFrOGLJ7Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNFQwNzoyMjo0MFrOGLKIIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MDA5OQ==", "bodyText": "nit: use entrySet() since you consume both keys and values?", "url": "https://github.com/apache/lucene-solr/pull/1444#discussion_r414350099", "createdAt": "2020-04-24T07:16:28Z", "author": {"login": "jpountz"}, "path": "lucene/expressions/src/java/org/apache/lucene/expressions/SimpleBindings.java", "diffHunk": "@@ -96,24 +90,51 @@ public DoubleValuesSource getDoubleValuesSource(String name) {\n       case SCORE:\n         return DoubleValuesSource.SCORES;\n       default:\n-        throw new UnsupportedOperationException(); \n+        throw new UnsupportedOperationException();\n     }\n   }\n   \n-  /** \n-   * Traverses the graph of bindings, checking there are no cycles or missing references \n-   * @throws IllegalArgumentException if the bindings is inconsistent \n+  @Override\n+  public DoubleValuesSource getDoubleValuesSource(String name) {\n+    if (map.containsKey(name) == false) {\n+      throw new IllegalArgumentException(\"Invalid reference '\" + name + \"'\");\n+    }\n+    return map.get(name).apply(this);\n+  }\n+\n+  /**\n+   * Traverses the graph of bindings, checking there are no cycles or missing references\n+   * @throws IllegalArgumentException if the bindings is inconsistent\n    */\n   public void validate() {\n-    for (Object o : map.values()) {\n-      if (o instanceof Expression) {\n-        Expression expr = (Expression) o;\n-        try {\n-          expr.getDoubleValuesSource(this);\n-        } catch (StackOverflowError e) {\n-          throw new IllegalArgumentException(\"Recursion Error: Cycle detected originating in (\" + expr.sourceText + \")\");\n-        }\n+    for (String origin : map.keySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDM1MzQ0MQ==", "bodyText": "I provided this test but I don't think we should add it as it relies on iteration order and might get defeated on some JVMs or future versions of Java. I'd suggest to not add this test, or to change the map in SimpleBindings from a HashMap to a TreeMap to be able to better test such cases (in which case we'd have to swap cycle0/cycle2), this could be done in a follow-up too.", "url": "https://github.com/apache/lucene-solr/pull/1444#discussion_r414353441", "createdAt": "2020-04-24T07:22:40Z", "author": {"login": "jpountz"}, "path": "lucene/expressions/src/test/org/apache/lucene/expressions/TestExpressionValidation.java", "diffHunk": "@@ -110,4 +110,15 @@ public void testCoRecursion4() throws Exception {\n     });\n     assertTrue(expected.getMessage().contains(\"Cycle detected\"));\n   }\n+\n+  public void testCoRecursion42() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f31cb0601615b147f1f980115216f0965b092287"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8823281fec0c55fe35dd57938d731fb3cbdaaa4c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/apache/lucene-solr/commit/8823281fec0c55fe35dd57938d731fb3cbdaaa4c", "committedDate": "2020-04-24T09:05:39Z", "message": "feedback, changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NzcyNDI0", "url": "https://github.com/apache/lucene-solr/pull/1444#pullrequestreview-399772424", "createdAt": "2020-04-24T09:09:09Z", "commit": {"oid": "8823281fec0c55fe35dd57938d731fb3cbdaaa4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2121, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}