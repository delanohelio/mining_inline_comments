{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyOTExOTg3", "number": 2121, "title": "SOLR-10860: Return proper error code for bad input incase of inplace updates", "bodyText": "Additionally,\n\nReturn proper error when inc operation is specified for non-numeric fields", "createdAt": "2020-12-05T06:27:11Z", "url": "https://github.com/apache/lucene-solr/pull/2121", "merged": true, "mergeCommit": {"oid": "d4fa1aae213a4750d1b9834753ac400b93b58cd8"}, "closed": true, "closedAt": "2021-01-07T15:14:48Z", "author": {"login": "munendrasn"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjQzxigFqTU0NTY0MDU4Mg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdt1ViLgBqjQxODAyMjU3OTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1NjQwNTgy", "url": "https://github.com/apache/lucene-solr/pull/2121#pullrequestreview-545640582", "createdAt": "2020-12-05T18:39:37Z", "commit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3NjI4MDc4", "url": "https://github.com/apache/lucene-solr/pull/2121#pullrequestreview-547628078", "createdAt": "2020-12-08T21:01:11Z", "commit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMTowMToxMVrOIB2Arg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQyMToxMDozMFrOIB2VwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwNDM5OA==", "bodyText": "can we default to (unknown id) otherwise the error message will look weird I think.", "url": "https://github.com/apache/lucene-solr/pull/2121#discussion_r538804398", "createdAt": "2020-12-08T21:01:11Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/update/processor/AtomicUpdateDocumentMerger.java", "diffHunk": "@@ -143,6 +147,15 @@ public SolrInputDocument merge(final SolrInputDocument fromDoc, SolrInputDocumen\n     return toDoc;\n   }\n \n+  private static String getID(SolrInputDocument doc, IndexSchema schema) {\n+    String id = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwODg3Mw==", "bodyText": "I don't think we want msg copied since it will be in the cause anyway.", "url": "https://github.com/apache/lucene-solr/pull/2121#discussion_r538808873", "createdAt": "2020-12-08T21:08:52Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/update/processor/AtomicUpdateDocumentMerger.java", "diffHunk": "@@ -553,7 +574,15 @@ private Object getNativeFieldValue(String fieldName, Object val) {\n       return val;\n     }\n     SchemaField sf = schema.getField(fieldName);\n-    return sf.getType().toNativeType(val);\n+    try {\n+      return sf.getType().toNativeType(val);\n+    } catch (SolrException ex) {\n+      throw new SolrException(SolrException.ErrorCode.getErrorCode(ex.code()),\n+          \"Error converting field '\" + sf.getName() + \"'='\" +val+\"' to native type, msg=\" + ex.getMessage(), ex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODgwOTc5Mw==", "bodyText": "This surprises me a little bit that we can't increment a float by an integer amount?", "url": "https://github.com/apache/lucene-solr/pull/2121#discussion_r538809793", "createdAt": "2020-12-08T21:10:30Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/update/TestInPlaceUpdatesStandalone.java", "diffHunk": "@@ -121,6 +123,36 @@ public void deleteAllAndCommit() throws Exception {\n     assertU(commit(\"softCommit\", \"false\"));\n   }\n \n+  @Test\n+  public void testUpdateBadRequest() throws Exception {\n+    final long version1 = addAndGetVersion(sdoc(\"id\", \"1\", \"title_s\", \"first\", \"inplace_updatable_float\", 41), null);\n+    assertU(commit());\n+\n+    // invalid value with set operation\n+    SolrException e = expectThrows(SolrException.class,\n+        () -> addAndAssertVersion(version1, \"id\", \"1\", \"inplace_updatable_float\", map(\"set\", \"NOT_NUMBER\")));\n+    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n+    MatcherAssert.assertThat(e.getMessage(), containsString(\"For input string: \\\"NOT_NUMBER\\\"\"));\n+\n+    // invalid value with inc operation\n+    e = expectThrows(SolrException.class,\n+        () -> addAndAssertVersion(version1, \"id\", \"1\", \"inplace_updatable_float\", map(\"inc\", \"NOT_NUMBER\")));\n+    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n+    MatcherAssert.assertThat(e.getMessage(), containsString(\"For input string: \\\"NOT_NUMBER\\\"\"));\n+\n+    // inc op with null value\n+    e = expectThrows(SolrException.class,\n+        () -> addAndAssertVersion(version1, \"id\", \"1\", \"inplace_updatable_float\", map(\"inc\", null)));\n+    assertEquals(SolrException.ErrorCode.BAD_REQUEST.code, e.code());\n+    MatcherAssert.assertThat(e.getMessage(), containsString(\"Invalid input 'null' for field inplace_updatable_float\"));\n+\n+    e = expectThrows(SolrException.class,\n+        () -> addAndAssertVersion(version1, \"id\", \"1\", \"inplace_updatable_float\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjUyMTkw", "url": "https://github.com/apache/lucene-solr/pull/2121#pullrequestreview-552652190", "createdAt": "2020-12-15T16:40:19Z", "commit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0MDoyMFrOIGU1Zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjo0MDoyMFrOIGU1Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzUwMzcxOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                if( sf != null ) {\n          \n          \n            \n                if ( sf != null ) {", "url": "https://github.com/apache/lucene-solr/pull/2121#discussion_r543503718", "createdAt": "2020-12-15T16:40:20Z", "author": {"login": "jbampton"}, "path": "solr/core/src/java/org/apache/solr/update/processor/AtomicUpdateDocumentMerger.java", "diffHunk": "@@ -143,6 +147,15 @@ public SolrInputDocument merge(final SolrInputDocument fromDoc, SolrInputDocumen\n     return toDoc;\n   }\n \n+  private static String getID(SolrInputDocument doc, IndexSchema schema) {\n+    String id = \"\";\n+    SchemaField sf = schema.getUniqueKeyField();\n+    if( sf != null ) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyOTY3Mjgx", "url": "https://github.com/apache/lucene-solr/pull/2121#pullrequestreview-552967281", "createdAt": "2020-12-15T22:08:01Z", "commit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f61a64a1cc77792e0e8fbd888a3cc9cdbeca96", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/d8f61a64a1cc77792e0e8fbd888a3cc9cdbeca96", "committedDate": "2021-01-07T14:45:39Z", "message": "SOLR-10860: return proper error code on invalid val with inplace update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d43777d601074c65df12190d87c1f4fa04f2e4a", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/8d43777d601074c65df12190d87c1f4fa04f2e4a", "committedDate": "2021-01-07T14:45:39Z", "message": "SOLR-10860: handle invalid value for inc op with inplace update\n\nUses toNativeType to convert increment value instead of direct parsing.\nAlso, throw error when inc operation is specified for non-numeric field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1a017827d0f9e4aea37857e2eacb476a7840bc3", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/e1a017827d0f9e4aea37857e2eacb476a7840bc3", "committedDate": "2021-01-07T14:45:39Z", "message": "SOLR-10860: add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cc90d81878b0a90483db596e3a5b45b9f4d9113", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/7cc90d81878b0a90483db596e3a5b45b9f4d9113", "committedDate": "2021-01-07T14:47:35Z", "message": "add changes entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e329e309d4a0b76224edc10c9a1cae7b00dd3f38", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/e329e309d4a0b76224edc10c9a1cae7b00dd3f38", "committedDate": "2021-01-07T14:51:17Z", "message": "feat: address review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e2925ab079ead8d16ad312f777858478a2e0b651", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/e2925ab079ead8d16ad312f777858478a2e0b651", "committedDate": "2020-12-05T06:24:25Z", "message": "add changes entry"}, "afterCommit": {"oid": "e329e309d4a0b76224edc10c9a1cae7b00dd3f38", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/e329e309d4a0b76224edc10c9a1cae7b00dd3f38", "committedDate": "2021-01-07T14:51:17Z", "message": "feat: address review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2396, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}