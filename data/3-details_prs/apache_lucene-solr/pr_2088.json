{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIzNDUwODcx", "number": 2088, "title": "LUCENE-9617: Reset lowestUnassignedFieldNumber in FieldNumbers.clear()", "bodyText": "FieldNumbers.clear() is called from IndexWriter.deleteAll(), which is\nsupposed to completely reset the state of the index. This includes\nclearing all known fields.\nPrior to this change, it would allocate progressively higher field\nnumbers, which results in larger and  larger arrays for\nFieldInfos.byNumber, effectively \"leaking\" field numbers every time\ndeleteAll() is called.\n\nDescription\nIf you run a loop that repeatedly adds documents to an IndexWriter and calls deleteAll, new fields will be given progressively higher index numbers. Since these index numbers are reflected in the size of the FieldInfos.byNumber array, this is effectively a memory leak.\nSolution\nReset lowestUnassignedFieldNumber to -1 when FieldNumbers.clear() is called (resetting the state to that of a newly-created FieldNumbers instance).\nTests\nAdded a unit test to confirm that after calling clear(), the next field is given number 0.\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ./gradlew check.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-11-18T20:27:10Z", "url": "https://github.com/apache/lucene-solr/pull/2088", "merged": true, "mergeCommit": {"oid": "8e162e26708631099f673a9da41804ef440fda73"}, "closed": true, "closedAt": "2020-12-18T21:30:34Z", "author": {"login": "msfroh"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddz9T_AH2gAyNTIzNDUwODcxOjcwNGYyNDJjMzc1MTNhZTVkOTEyNjZmZmFiNjUzYjE3ODRhMDlhMTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhZMh_gFqTU0MDUzMzgyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "704f242c37513ae5d91266ffab653b1784a09a16", "author": {"user": {"login": "msfroh", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/704f242c37513ae5d91266ffab653b1784a09a16", "committedDate": "2020-11-18T20:13:10Z", "message": "LUCENE-9617: Reset lowestUnassignedFieldNumber in FieldNumbers.clear()\n\nFieldNumbers.clear() is called from IndexWriter.deleteAll(), which is\nsupposed to completely reset the state of the index. This includes\nclearing all known fields.\n\nPrior to this change, it would allocate progressively higher field\nnumbers, which results in larger and  larger arrays for\nFieldInfos.byNumber, effectively \"leaking\" field numbers every time\ndeleteAll() is called."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM0NDUzNDI1", "url": "https://github.com/apache/lucene-solr/pull/2088#pullrequestreview-534453425", "createdAt": "2020-11-19T13:39:43Z", "commit": {"oid": "704f242c37513ae5d91266ffab653b1784a09a16"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMzozOTo0NFrOH2fDKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxMzo0MTo0OVrOH2fIXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5Mzg2Nw==", "bodyText": "Can you rewrite in terms of what a user might understand?  e.g.\nIndexWriter.deleteAll now resets internal field numbers; prevents ever-increasing numbers in unusual use-cases\nThe latter part of what you wrote isn't bad but the first part is technical mumbo-jumbo that only Lucene deep divers would even recognize.", "url": "https://github.com/apache/lucene-solr/pull/2088#discussion_r526893867", "createdAt": "2020-11-19T13:39:44Z", "author": {"login": "dsmiley"}, "path": "lucene/CHANGES.txt", "diffHunk": "@@ -184,6 +184,9 @@ Bug fixes\n * LUCENE-9365: FuzzyQuery was missing matches when prefix length was equal to the term length\n   (Mark Harwood, Mike Drob)\n \n+* LUCENE-9617: Reset lowestUnassignedFieldNumber on FieldNumbers.clear(), to avoid leaking", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704f242c37513ae5d91266ffab653b1784a09a16"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjg5NTE5OA==", "bodyText": "My only problem with unit tests like this is that it doesn't test what we really want to know -- that when IW.deleteAll() is called (a user level thing, fieldNumbers.clear() is not), that the field numbers get reset.", "url": "https://github.com/apache/lucene-solr/pull/2088#discussion_r526895198", "createdAt": "2020-11-19T13:41:49Z", "author": {"login": "dsmiley"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestFieldInfos.java", "diffHunk": "@@ -187,4 +187,23 @@ public void testMergedFieldInfos_singleLeaf() throws IOException {\n     writer.close();\n     dir.close();\n   }\n+\n+  public void testFieldNumbersAutoIncrement() {\n+    FieldInfos.FieldNumbers fieldNumbers = new FieldInfos.FieldNumbers(\"softDeletes\");\n+    for (int i = 0; i < 10; i++) {\n+      fieldNumbers.addOrGet(\"field\" + i, -1, IndexOptions.NONE, DocValuesType.NONE,\n+          0, 0, 0, 0,\n+          VectorValues.SearchStrategy.NONE, false);\n+    }\n+    int idx = fieldNumbers.addOrGet(\"EleventhField\", -1, IndexOptions.NONE, DocValuesType.NONE,\n+        0, 0, 0, 0,\n+        VectorValues.SearchStrategy.NONE, false);\n+    assertEquals(\"Field numbers 0 through 9 were allocated\", 10, idx);\n+\n+    fieldNumbers.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "704f242c37513ae5d91266ffab653b1784a09a16"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ce385dda633cbcd10b4ec4186c08d608a2489f8b", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/ce385dda633cbcd10b4ec4186c08d608a2489f8b", "committedDate": "2020-11-20T23:31:18Z", "message": "Update change description and add deleteAll test\n\n1. Updated CHANGES.txt message for the issue to better reflect the user\n   impact (i.e. IndexWriter.deleteAll doesn't leak any more).\n2. Added a test that triggered an OOME without the fix."}, "afterCommit": {"oid": "19537f2350728ee8f1d9a2cdbff5097af725db54", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/19537f2350728ee8f1d9a2cdbff5097af725db54", "committedDate": "2020-11-20T23:39:55Z", "message": "Update change description and add deleteAll test\n\n1. Updated CHANGES.txt message for the issue to better reflect the user\n   impact (i.e. IndexWriter.deleteAll doesn't leak any more).\n2. Added a test that triggered an OOME without the fix."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4f6be31c8e7b0fb5af24bdd25f34ca53fdbab60", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/d4f6be31c8e7b0fb5af24bdd25f34ca53fdbab60", "committedDate": "2020-11-20T23:55:09Z", "message": "Update change description and add deleteAll test\n\n1. Updated CHANGES.txt message for the issue to better reflect the user\n   impact (i.e. IndexWriter.deleteAll doesn't leak any more).\n2. Added a test that triggered an OOME without the fix."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19537f2350728ee8f1d9a2cdbff5097af725db54", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/19537f2350728ee8f1d9a2cdbff5097af725db54", "committedDate": "2020-11-20T23:39:55Z", "message": "Update change description and add deleteAll test\n\n1. Updated CHANGES.txt message for the issue to better reflect the user\n   impact (i.e. IndexWriter.deleteAll doesn't leak any more).\n2. Added a test that triggered an OOME without the fix."}, "afterCommit": {"oid": "d4f6be31c8e7b0fb5af24bdd25f34ca53fdbab60", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/d4f6be31c8e7b0fb5af24bdd25f34ca53fdbab60", "committedDate": "2020-11-20T23:55:09Z", "message": "Update change description and add deleteAll test\n\n1. Updated CHANGES.txt message for the issue to better reflect the user\n   impact (i.e. IndexWriter.deleteAll doesn't leak any more).\n2. Added a test that triggered an OOME without the fix."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTMzODIy", "url": "https://github.com/apache/lucene-solr/pull/2088#pullrequestreview-540533822", "createdAt": "2020-11-29T23:18:03Z", "commit": {"oid": "d4f6be31c8e7b0fb5af24bdd25f34ca53fdbab60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2603, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}