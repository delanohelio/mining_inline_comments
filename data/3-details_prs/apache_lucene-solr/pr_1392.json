{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MzczMDM4", "number": 1392, "title": "SOLR-14371 Zk StatusHandler should know about dynamic zk config", "bodyText": "See https://issues.apache.org/jira/browse/SOLR-14371", "createdAt": "2020-03-31T14:25:48Z", "url": "https://github.com/apache/lucene-solr/pull/1392", "merged": true, "mergeCommit": {"oid": "03363f413f2134594b012175deb3f10ec9384400"}, "closed": true, "closedAt": "2020-04-17T14:30:28Z", "author": {"login": "janhoy"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS2areAH2gAyMzk2MzczMDM4Ojk4N2NiZTNiYjQ4NjYxOWMzYjk2OTk0MzM1ZTE3ZjNlMzQ0YmM0Mzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYhyLCAH2gAyMzk2MzczMDM4OmI5MTIxZjIwMGJlZDY5Njk3NzBlNDk0YWQ2Yzk2NDk5MGEyZjFiMGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "987cbe3bb486619c3b96994335e17f3e344bc439", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/987cbe3bb486619c3b96994335e17f3e344bc439", "committedDate": "2020-03-30T22:40:44Z", "message": "SOLR-14371: Zk StatusHandler should know about dynamic zk config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/66270fa70298d6df869b54d7837cfdfdb722465b", "committedDate": "2020-03-31T14:23:57Z", "message": "Able to parse zkstatus both from connection string and config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0ODM0MzUw", "url": "https://github.com/apache/lucene-solr/pull/1392#pullrequestreview-384834350", "createdAt": "2020-03-31T15:12:17Z", "commit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNToxMjoxN1rOF-asJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoyMjoxMlrOF-d4Zg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDk5MzMxNw==", "bodyText": "The precommit may dislike this", "url": "https://github.com/apache/lucene-solr/pull/1392#discussion_r400993317", "createdAt": "2020-03-31T15:12:17Z", "author": {"login": "HoustonPutman"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperStatusHandler.java", "diffHunk": "@@ -24,15 +24,12 @@\n import java.io.Writer;\n import java.lang.invoke.MethodHandles;\n import java.net.Socket;\n-import java.util.ArrayList;\n-import java.util.Arrays;\n-import java.util.HashMap;\n-import java.util.List;\n-import java.util.Locale;\n-import java.util.Map;\n+import java.nio.charset.StandardCharsets;\n+import java.util.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0MjY2Mw==", "bodyText": "Looking at the docs here https://zookeeper.apache.org/doc/r3.5.7/zookeeperReconfig.html, in the \"Specifying the client port\" section, it looks like the role of the zk instance is either observer or participant (where participant is the default). Participant isn't a new thing, just a name for a regular member of the ensemble (not an observer).\nThis state check change may be making everything a \"participant\" as that's the default role. Maybe keep the original state logic, but add in an additional check in the beginning to see if the role is observer?", "url": "https://github.com/apache/lucene-solr/pull/1392#discussion_r401042663", "createdAt": "2020-03-31T16:17:59Z", "author": {"login": "HoustonPutman"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperStatusHandler.java", "diffHunk": "@@ -108,27 +128,30 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n         if (\"true\".equals(String.valueOf(stat.get(\"ok\")))) {\n           numOk++;\n         }\n-        String state = String.valueOf(stat.get(\"zk_server_state\"));\n+        String state = zk.role != null ? zk.role : String.valueOf(stat.get(\"zk_server_state\"));\n         if (\"follower\".equals(state)) {\n           followers++;\n         } else if (\"leader\".equals(state)) {\n           leaders++;\n           reportedFollowers = Integer.parseInt(String.valueOf(stat.get(\"zk_followers\")));\n         } else if (\"standalone\".equals(state)) {\n           standalone++;\n+        } else if (\"participant\".equals(state)) {\n+          // NOCOMMIT: What does participant mean vs leader or follower?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0Mjg3Nw==", "bodyText": "precommit issue?", "url": "https://github.com/apache/lucene-solr/pull/1392#discussion_r401042877", "createdAt": "2020-03-31T16:18:18Z", "author": {"login": "HoustonPutman"}, "path": "solr/core/src/test/org/apache/solr/handler/admin/ZookeeperStatusHandlerTest.java", "diffHunk": "@@ -47,8 +48,7 @@\n import org.slf4j.Logger;\n import org.slf4j.LoggerFactory;\n \n-import static org.mockito.ArgumentMatchers.any;\n-import static org.mockito.ArgumentMatchers.anyString;\n+import static org.mockito.ArgumentMatchers.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0NTYwNg==", "bodyText": "these can all likely be final correct?", "url": "https://github.com/apache/lucene-solr/pull/1392#discussion_r401045606", "createdAt": "2020-03-31T16:22:12Z", "author": {"login": "HoustonPutman"}, "path": "solr/solrj/src/java/org/apache/solr/common/cloud/SolrZkClient.java", "diffHunk": "@@ -818,6 +834,49 @@ public void downloadFromZK(String zkPath, Path dir) throws IOException {\n     ZkMaintenanceUtils.downloadFromZK(this, zkPath, dir);\n   }\n \n+  /**\n+   * Represents one line in dynamic ZK config\n+   */\n+  public static class ZkConfigDyn {\n+    // server.<positive id> = <address1>:<port1>:<port2>[:role];[<client port address>:]<client port>\n+    public static Pattern linePattern = Pattern.compile(\"server\\\\.(?<serverId>\\\\d+) ?= ?(?<address>[^:]+):(?<leaderPort>\\\\d+):(?<leaderElectionPort>\\\\d+)(:(?<role>.*?))?(;((?<clientPortAddress>.*?):)?(?<clientPort>\\\\d+))?\");\n+    public int serverId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66270fa70298d6df869b54d7837cfdfdb722465b"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b625db16ff43cef7810d7fde57fd67fd5f7a1eb", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/9b625db16ff43cef7810d7fde57fd67fd5f7a1eb", "committedDate": "2020-04-01T13:14:14Z", "message": "Make variables final, use constructor, use Integer over int"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46a26c9362334cce278f7df0ee79e384a27e1d42", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/46a26c9362334cce278f7df0ee79e384a27e1d42", "committedDate": "2020-04-01T14:08:54Z", "message": "Adding more config options to the list of valid\nand remove server.X since they are covered elsewhere and too long to render"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b5542ad55da601e0bdfda96bad8c2ccabbbc397", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/9b5542ad55da601e0bdfda96bad8c2ccabbbc397", "committedDate": "2020-04-01T14:11:15Z", "message": "Remove nocommit. Count observer status as follower\nAdd 'role' to output, if exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9938a1bd398d29026ad0ed7ae52af04e558bef11", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/9938a1bd398d29026ad0ed7ae52af04e558bef11", "committedDate": "2020-04-01T15:28:11Z", "message": "Revert adding a bunch of config keys that are not available through 4lw"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9777985041830b9ec66d3f1d137eb3a258990ce9", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/9777985041830b9ec66d3f1d137eb3a258990ce9", "committedDate": "2020-04-01T17:06:00Z", "message": "Move role to ensemble section\nShow dynamic reconfig\nFilter empty keys"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1ODA0MjQ0", "url": "https://github.com/apache/lucene-solr/pull/1392#pullrequestreview-385804244", "createdAt": "2020-04-01T17:35:24Z", "commit": {"oid": "9777985041830b9ec66d3f1d137eb3a258990ce9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzozNToyNFrOF_LXcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNzozNToyNFrOF_LXcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTc5MDgzMw==", "bodyText": "I think this should live up here where the reconfig check is done. https://github.com/apache/lucene-solr/pull/1392/files#diff-2f0decb1314fc7f7d3e6e0f497839745R109", "url": "https://github.com/apache/lucene-solr/pull/1392#discussion_r401790833", "createdAt": "2020-04-01T17:35:24Z", "author": {"login": "HoustonPutman"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/ZookeeperStatusHandler.java", "diffHunk": "@@ -109,25 +133,30 @@ public void handleRequestBody(SolrQueryRequest req, SolrQueryResponse rsp) throw\n           numOk++;\n         }\n         String state = String.valueOf(stat.get(\"zk_server_state\"));\n-        if (\"follower\".equals(state)) {\n+        if (\"follower\".equals(state) || \"observer\".equals(state)) {\n           followers++;\n         } else if (\"leader\".equals(state)) {\n           leaders++;\n           reportedFollowers = Integer.parseInt(String.valueOf(stat.get(\"zk_followers\")));\n         } else if (\"standalone\".equals(state)) {\n           standalone++;\n         }\n+        if (zk.role != null) {\n+          stat.put(\"role\", zk.role);\n+          dynamicReconfig = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9777985041830b9ec66d3f1d137eb3a258990ce9"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e765ac26e04994bc73a74a46222aaeac41fecf19", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/e765ac26e04994bc73a74a46222aaeac41fecf19", "committedDate": "2020-04-01T18:43:44Z", "message": "More review fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2cd1ee76e4bb306811804ad032017481a06003d", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/a2cd1ee76e4bb306811804ad032017481a06003d", "committedDate": "2020-04-01T22:24:28Z", "message": "Fix tests, handle null input to parseLines method, add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7288b3c825e32c64120d09c28dc99aa76ed44d7", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/c7288b3c825e32c64120d09c28dc99aa76ed44d7", "committedDate": "2020-04-01T22:41:57Z", "message": "Return 400 error instead of 500 error if parsing of zk config line fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6aa692e96cf089d918e5edaaa7f65715843ba3e", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/c6aa692e96cf089d918e5edaaa7f65715843ba3e", "committedDate": "2020-04-02T09:58:59Z", "message": "Add error handling if connection string host list is different from dynamic config host list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f61a3ae3c23593ea2c3bff7258ee7677bd35f1", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/57f61a3ae3c23593ea2c3bff7258ee7677bd35f1", "committedDate": "2020-04-02T10:01:57Z", "message": "Update tests with new error msg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b989f23480d7d04a6f2cfb2372864e66e8a1cc19", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/b989f23480d7d04a6f2cfb2372864e66e8a1cc19", "committedDate": "2020-04-05T15:58:14Z", "message": "Merge branch 'master' into solr14371-zk-status\n\n# Conflicts:\n#\tsolr/CHANGES.txt"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MzUzNTkx", "url": "https://github.com/apache/lucene-solr/pull/1392#pullrequestreview-388353591", "createdAt": "2020-04-06T15:16:58Z", "commit": {"oid": "b989f23480d7d04a6f2cfb2372864e66e8a1cc19"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3975ae2a03a52070334f0148c9963969b05877a0", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/3975ae2a03a52070334f0148c9963969b05877a0", "committedDate": "2020-04-07T11:08:06Z", "message": "Merge branch 'master' into solr14371-zk-status"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7946a6f0f4fd427d759bb95e7af331c35947e619", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/7946a6f0f4fd427d759bb95e7af331c35947e619", "committedDate": "2020-04-07T11:16:02Z", "message": "Re-phrase docs, do not state that Solr supports reconfiguration."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d024c9691580d7780dead7d14358d507ede06303", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/d024c9691580d7780dead7d14358d507ede06303", "committedDate": "2020-04-07T11:31:25Z", "message": "Align try block better"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "060978af7c75597557e81ead5c61d13e871f4498", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/060978af7c75597557e81ead5c61d13e871f4498", "committedDate": "2020-04-07T13:20:42Z", "message": "Factor out ZkConfigDyn into its own class 'ZkDynamicConfig', move out of SolrZkClient\nParsing /zookeeper config string now returns the ZkDynamicConfig object instead of a List<>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9121f200bed6969770e494ad6c964990a2f1b0f", "author": {"user": {"login": "janhoy", "name": "Jan H\u00f8ydahl"}}, "url": "https://github.com/apache/lucene-solr/commit/b9121f200bed6969770e494ad6c964990a2f1b0f", "committedDate": "2020-04-17T14:01:56Z", "message": "Merge branch 'master' into solr14371-zk-status"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2071, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}