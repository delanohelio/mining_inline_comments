{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTc5NzEz", "number": 1806, "title": "LUCENE-9475: Switch validateSourcePatterns away from Ant legacy", "bodyText": "This PR changes the legacy setp of the checkSourcePatterns task to directly execute the checker code in the running Gradle VM.\nBecause of Ant compatibility we preserved the old code using Ant's Groovy task. So it was executing Groovy shell inside Groovy. The code changes are minimal, further improvements are coming later.\nThis task has no outputs, so it's declared to run always. We may improve this, if we make the checked files and patterns a task input. Quick tests on different branches showed that task works.\nThis PR fixes the stupid warning caused by the groovy-inside-groovy:\n> Task :validateSourcePatterns\nTrying to override old definition of task fileScanner", "createdAt": "2020-08-30T23:40:17Z", "url": "https://github.com/apache/lucene-solr/pull/1806", "merged": true, "mergeCommit": {"oid": "bbf3aec38e38c3c12692287f12213ea00334a242"}, "closed": true, "closedAt": "2020-08-31T10:52:05Z", "author": {"login": "uschindler"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEG7d5gH2gAyNDc1OTc5NzEzOjgyY2ZjMWFmZDMyMzA1ZTY4YzVhZmVjMjQ5NDAwMzM0MzE4ZDVmYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEQgeUgFqTQ3ODUwNTMyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82cfc1afd32305e68c5afec249400334318d5fb8", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/82cfc1afd32305e68c5afec249400334318d5fb8", "committedDate": "2020-08-30T23:37:19Z", "message": "LUCENE-9475: Switch validateSourcePatters away from Ant legacy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Mzc1ODI3", "url": "https://github.com/apache/lucene-solr/pull/1806#pullrequestreview-478375827", "createdAt": "2020-08-31T07:20:48Z", "commit": {"oid": "82cfc1afd32305e68c5afec249400334318d5fb8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b249b2d9fcd83c0d658afa726ff5c3b6a9d42c60", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/b249b2d9fcd83c0d658afa726ff5c3b6a9d42c60", "committedDate": "2020-08-31T09:17:03Z", "message": "Use gradle FileTree instead of Ant's FileScanner (in prepartion to inputs for this task)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f68caae693d826208caea3bf436a0ce29a1bc14", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/8f68caae693d826208caea3bf436a0ce29a1bc14", "committedDate": "2020-08-31T09:21:57Z", "message": "Merge branch 'master' of https://gitbox.apache.org/repos/asf/lucene-solr into jira/LUCENE-9475"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/3edd1b520fd98b0b0e63b66db6f61cf9e71efff2", "committedDate": "2020-08-31T10:01:55Z", "message": "Convert the task to a class; add @InputFiles (please note we need outputs.uptodateWhen(true), see gradle docs!)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDg2MDI2", "url": "https://github.com/apache/lucene-solr/pull/1806#pullrequestreview-478486026", "createdAt": "2020-08-31T10:17:09Z", "commit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMDoxNzowOVrOHJyxDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMDoxNzowOVrOHJyxDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAzMDk5MQ==", "bodyText": "I would move it to the class's constructor? Then inputs and outputs are consistently in the same code.", "url": "https://github.com/apache/lucene-solr/pull/1806#discussion_r480030991", "createdAt": "2020-08-31T10:17:09Z", "author": {"login": "dweiss"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -15,27 +15,233 @@\n  * limitations under the License.\n  */\n \n-// This should be eventually rewritten in plain gradle. For now, delegate to\n-// the ant/groovy script we already have.\n+import org.apache.rat.Defaults;\n+import org.apache.rat.document.impl.FileDocument;\n+import org.apache.rat.api.MetaData;\n \n-configure(rootProject) {\n-  configurations {\n-    checkSourceDeps\n+buildscript {\n+  repositories {\n+    mavenCentral()\n   }\n \n   dependencies {\n-    checkSourceDeps \"org.codehaus.groovy:groovy-all:2.4.17\"\n-    checkSourceDeps \"org.apache.rat:apache-rat:${scriptDepVersions['apache-rat']}\"\n+    classpath \"org.apache.rat:apache-rat:${scriptDepVersions['apache-rat']}\"\n+  }\n+}\n+\n+configure(rootProject) {\n+  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) {\n+    group = 'Verification'\n+    description = 'Validate Source Patterns'\n+    \n+    // this task has no outputs, so it's always uptodate (if inputs don't change).\n+    outputs.upToDateWhen { true }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDg2NDEx", "url": "https://github.com/apache/lucene-solr/pull/1806#pullrequestreview-478486411", "createdAt": "2020-08-31T10:17:52Z", "commit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMDoxNzo1MlrOHJyyRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQxMDoxNzo1MlrOHJyyRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDAzMTMwMg==", "bodyText": "And this I'd move to the task declaration block (so that it's not hardcoded but configured :)", "url": "https://github.com/apache/lucene-solr/pull/1806#discussion_r480031302", "createdAt": "2020-08-31T10:17:52Z", "author": {"login": "dweiss"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -15,27 +15,233 @@\n  * limitations under the License.\n  */\n \n-// This should be eventually rewritten in plain gradle. For now, delegate to\n-// the ant/groovy script we already have.\n+import org.apache.rat.Defaults;\n+import org.apache.rat.document.impl.FileDocument;\n+import org.apache.rat.api.MetaData;\n \n-configure(rootProject) {\n-  configurations {\n-    checkSourceDeps\n+buildscript {\n+  repositories {\n+    mavenCentral()\n   }\n \n   dependencies {\n-    checkSourceDeps \"org.codehaus.groovy:groovy-all:2.4.17\"\n-    checkSourceDeps \"org.apache.rat:apache-rat:${scriptDepVersions['apache-rat']}\"\n+    classpath \"org.apache.rat:apache-rat:${scriptDepVersions['apache-rat']}\"\n+  }\n+}\n+\n+configure(rootProject) {\n+  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) {\n+    group = 'Verification'\n+    description = 'Validate Source Patterns'\n+    \n+    // this task has no outputs, so it's always uptodate (if inputs don't change).\n+    outputs.upToDateWhen { true }\n   }\n+}\n+\n+class ValidateSourcePatternsTask extends DefaultTask {\n+\n+  @InputFiles\n+  final ConfigurableFileTree sourceFiles = project.fileTree(project.rootDir) {\n+    [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDg2ODM1", "url": "https://github.com/apache/lucene-solr/pull/1806#pullrequestreview-478486835", "createdAt": "2020-08-31T10:18:38Z", "commit": {"oid": "3edd1b520fd98b0b0e63b66db6f61cf9e71efff2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1224f6be3aa004202ad0de0dc23ab17cefe7a3cc", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/1224f6be3aa004202ad0de0dc23ab17cefe7a3cc", "committedDate": "2020-08-31T10:20:27Z", "message": "Improve logging (especially for the debug case)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4b7cdd96285c144b343a71f31f1539c02350022", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/d4b7cdd96285c144b343a71f31f1539c02350022", "committedDate": "2020-08-31T10:35:10Z", "message": "Apply Dawid's changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NTA1MzIz", "url": "https://github.com/apache/lucene-solr/pull/1806#pullrequestreview-478505323", "createdAt": "2020-08-31T10:46:53Z", "commit": {"oid": "d4b7cdd96285c144b343a71f31f1539c02350022"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2420, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}