{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5ODQ3MTQ1", "number": 1963, "reviewThreads": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowMzo1OVrOErmnRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxMTo1MVrOFHP_ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2ODY5OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowMzo1OVrOHedgLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowMzo1OVrOHedgLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjcwMA==", "bodyText": "NULL_DEREFERENCE:  object returned by getDocument(schemaConf) could be null and is dereferenced at line 496.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702700", "createdAt": "2020-10-08T13:03:59Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "diffHunk": "@@ -474,23 +481,28 @@ protected Analyzer getWrappedAnalyzer(String fieldName) {\n     }\n   }\n \n-  protected void readSchema(InputSource is) {\n+  protected void readSchema(ConfigSetService.ConfigResource is) {\n     assert null != is : \"schema InputSource should never be null\";\n     try {\n-      // pass the config resource loader to avoid building an empty one for no reason:\n-      // in the current case though, the stream is valid so we wont load the resource by name\n-      XmlConfigFile schemaConf = new XmlConfigFile(loader, SCHEMA, is, SLASH+SCHEMA+SLASH, substitutableProperties);\n-      Document document = schemaConf.getDocument();\n-      final XPath xpath = schemaConf.getXPath();\n-      String expression = stepsToPath(SCHEMA, AT + NAME);\n-      Node nd = (Node) xpath.evaluate(expression, document, XPathConstants.NODE);\n+      rootNode = is.getParsed();\n+      if(rootNode == null) {\n+        // pass the config resource loader to avoid building an empty one for no reason:\n+        // in the current case though, the stream is valid so we wont load the resource by name\n+        XmlConfigFile schemaConf = new XmlConfigFile(loader, SCHEMA, is.getSource(), SLASH+SCHEMA+SLASH, null);\n+//      Document document = schemaConf.getDocument();\n+//      final XPath xpath = schemaConf.getXPath();\n+//      String expression = stepsToPath(SCHEMA, AT + NAME);\n+//      Node nd = (Node) xpath.evaluate(expression, document, XPathConstants.NODE);\n+        rootNode = new DataConfigNode(new DOMConfigNode(schemaConf.getDocument().getDocumentElement())) ;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2ODg3OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowMVrOHedgSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowMVrOHedgSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjcyOQ==", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method IndexSchema.readSchema(...) writes to field this.dynamicCopyFields outside of synchronization.\nReporting because another access to the same memory occurs on a background thread, although this access may not.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702729", "createdAt": "2020-10-08T13:04:01Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "diffHunk": "@@ -608,7 +629,7 @@ protected void readSchema(InputSource is) {\n       // expression = \"/schema/copyField\";\n \n       dynamicCopyFields = new DynamicCopy[] {};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 216}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTA2OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowM1rOHedgXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowM1rOHedgXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjc1MQ==", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method ManagedIndexSchemaFactory.create(...) reads without synchronization from this.loadedResource. Potentially races with write in method ManagedIndexSchemaFactory.create(...).\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702751", "createdAt": "2020-10-08T13:04:03Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -174,8 +175,8 @@ public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n     }\n     InputSource inputSource = new InputSource(schemaInputStream);\n     inputSource.setSystemId(SystemIdResolver.createSystemIdFromResourceName(loadedResource));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTEyOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowNVrOHedgbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowNVrOHedgbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjc2NQ==", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method ManagedIndexSchemaFactory.create(...) reads without synchronization from this.shouldUpgrade. Potentially races with write in method ManagedIndexSchemaFactory.create(...).\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702765", "createdAt": "2020-10-08T13:04:05Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -174,8 +175,8 @@ public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n     }\n     InputSource inputSource = new InputSource(schemaInputStream);\n     inputSource.setSystemId(SystemIdResolver.createSystemIdFromResourceName(loadedResource));\n-    schema = new ManagedIndexSchema(config, loadedResource, inputSource, isMutable,\n-                                    managedSchemaResourceName, schemaZkVersion, getSchemaUpdateLock());\n+    schema = new ManagedIndexSchema(config, loadedResource, () -> inputSource, isMutable,\n+        managedSchemaResourceName, schemaZkVersion, getSchemaUpdateLock());\n     if (shouldUpgrade) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTIwOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowNlrOHedgew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowNlrOHedgew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjc3OQ==", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ManagedIndexSchemaFactory.create(...) indirectly writes to field config.overlay outside of synchronization.\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702779", "createdAt": "2020-10-08T13:04:06Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -174,8 +175,8 @@ public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n     }\n     InputSource inputSource = new InputSource(schemaInputStream);\n     inputSource.setSystemId(SystemIdResolver.createSystemIdFromResourceName(loadedResource));\n-    schema = new ManagedIndexSchema(config, loadedResource, inputSource, isMutable,\n-                                    managedSchemaResourceName, schemaZkVersion, getSchemaUpdateLock());\n+    schema = new ManagedIndexSchema(config, loadedResource, () -> inputSource, isMutable,\n+        managedSchemaResourceName, schemaZkVersion, getSchemaUpdateLock());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTI2OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowOFrOHedgiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowOFrOHedgiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjc5Mw==", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ManagedIndexSchemaFactory.create(...) writes to field this.config outside of synchronization.\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702793", "createdAt": "2020-10-08T13:04:08Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -109,7 +110,7 @@ public String getSchemaResourceName(String cdResourceName) {\n    * renamed by appending the extension named in {@link #UPGRADED_SCHEMA_EXTENSION}.\n    */\n   @Override\n-  public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n+  public ManagedIndexSchema create(String resourceName, SolrConfig config, ConfigSetService configSetService) {\n     this.resourceName = resourceName;\n     this.config = config;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTM1OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowOVrOHedgnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDowOVrOHedgnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjgxMg==", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ManagedIndexSchemaFactory.create(...) writes to field this.loader outside of synchronization.\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702812", "createdAt": "2020-10-08T13:04:09Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -109,7 +110,7 @@ public String getSchemaResourceName(String cdResourceName) {\n    * renamed by appending the extension named in {@link #UPGRADED_SCHEMA_EXTENSION}.\n    */\n   @Override\n-  public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n+  public ManagedIndexSchema create(String resourceName, SolrConfig config, ConfigSetService configSetService) {\n     this.resourceName = resourceName;\n     this.config = config;\n     this.loader = config.getResourceLoader();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MTU2OTQyOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDoxMFrOHedgrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMzowNDoxMFrOHedgrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTcwMjgyOQ==", "bodyText": "THREAD_SAFETY_VIOLATION:  Unprotected write. Non-private method ManagedIndexSchemaFactory.create(...) writes to field this.resourceName outside of synchronization.\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r501702829", "createdAt": "2020-10-08T13:04:10Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -109,7 +110,7 @@ public String getSchemaResourceName(String cdResourceName) {\n    * renamed by appending the extension named in {@link #UPGRADED_SCHEMA_EXTENSION}.\n    */\n   @Override\n-  public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n+  public ManagedIndexSchema create(String resourceName, SolrConfig config, ConfigSetService configSetService) {\n     this.resourceName = resourceName;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b991edc3eca1ca16f5a6b7074eaf43264ec9d2e"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzY5MzQ4OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNTozOVrOHfXpbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNjoyODo1MVrOHfdqLA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1NTM0Mg==", "bodyText": "this probably needs to be static.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502655342", "createdAt": "2020-10-09T20:25:39Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1MzgzNg==", "bodyText": "It's an interface. All fields are public static final by default", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502753836", "createdAt": "2020-10-10T06:28:51Z", "author": {"login": "noblepaul"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1NTM0Mg=="}, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzY5OTA3OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNzozOFrOHfXssQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNzozOFrOHfXssQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1NjE3Nw==", "bodyText": "Please add javadoc for what these methods do", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502656177", "createdAt": "2020-10-09T20:27:38Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {\n+    return child(null, name);\n+  }\n+\n+  default ConfigNode child(Predicate<ConfigNode> test, String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzY5OTYxOnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNzo1M1rOHfXtFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDoyNzo1M1rOHfXtFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY1NjI3Ng==", "bodyText": "I don't understand what the return value of the function is supposed to represent", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502656276", "createdAt": "2020-10-09T20:27:53Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {\n+    return child(null, name);\n+  }\n+\n+  default ConfigNode child(Predicate<ConfigNode> test, String name) {\n+    ConfigNode[] result = new ConfigNode[1];\n+    forEachChild(it -> {\n+      if (name!=null && !name.equals(it.name())) return Boolean.TRUE;\n+      if (test == null || test.test(it)) {\n+        result[0] = it;\n+        return Boolean.FALSE;\n+      }\n+      return Boolean.TRUE;\n+    });\n+    return result[0];\n+  }\n+\n+  default List<ConfigNode> children(Predicate<ConfigNode> test, String... nodeNames) {\n+    return children(test, nodeNames == null ? Collections.emptySet() : Set.of(nodeNames));\n+  }\n+\n+  default List<ConfigNode> children(Predicate<ConfigNode> test, Set<String> set) {\n+    List<ConfigNode> result = new ArrayList<>();\n+    forEachChild(it -> {\n+      if (set != null && !set.isEmpty() && !set.contains(it.name())) return Boolean.TRUE;\n+      if (test == null || test.test(it)) result.add(it);\n+      return Boolean.TRUE;\n+    });\n+    return result;\n+  }\n+\n+  default List<ConfigNode> children(String name) {\n+    return children(null, Collections.singleton(name));\n+  }\n+\n+  void forEachChild(Function<ConfigNode, Boolean> fun);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0NzcyOTU1OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/util/DOMUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDozOTozOVrOHfX_OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMFQwNjoyMTo1MlrOHfdn0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY2MDkyMQ==", "bodyText": "can we use Set.of instead of ImmutableSet", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502660921", "createdAt": "2020-10-09T20:39:39Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/util/DOMUtil.java", "diffHunk": "@@ -39,9 +42,23 @@\n \n   public static final String XML_RESERVED_PREFIX = \"xml\";\n \n+  static final Set<String>  NL_TAGS = ImmutableSet.of(\"str\", \"int\",\"long\",\"float\",\"double\",\"bool\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjc1MzIzNA==", "bodyText": "Set.of() is java 9. I'm hoping to put this into Solr 8.x", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502753234", "createdAt": "2020-10-10T06:21:52Z", "author": {"login": "noblepaul"}, "path": "solr/core/src/java/org/apache/solr/util/DOMUtil.java", "diffHunk": "@@ -39,9 +42,23 @@\n \n   public static final String XML_RESERVED_PREFIX = \"xml\";\n \n+  static final Set<String>  NL_TAGS = ImmutableSet.of(\"str\", \"int\",\"long\",\"float\",\"double\",\"bool\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY2MDkyMQ=="}, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Nzc2MjY1OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDo1MzowOFrOHfYTrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQyMDo1MzowOFrOHfYTrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjY2NjE1OQ==", "bodyText": "missing @defaultOperator?", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r502666159", "createdAt": "2020-10-09T20:53:08Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/schema/IndexSchema.java", "diffHunk": "@@ -537,26 +554,30 @@ protected void readSchema(InputSource is) {\n       }\n \n       //                      /schema/defaultSearchField/text()\n-      expression = stepsToPath(SCHEMA, \"defaultSearchField\", TEXT_FUNCTION);\n-      node = (Node) xpath.evaluate(expression, document, XPathConstants.NODE);\n+//      expression = stepsToPath(SCHEMA, \"defaultSearchField\", TEXT_FUNCTION);\n+//      node = (Node) xpath.evaluate(expression, document, XPathConstants.NODE);\n+      ConfigNode node = rootNode.child(\"defaultSearchField\");\n       if (node != null) {\n         throw new SolrException(ErrorCode.SERVER_ERROR, \"Setting defaultSearchField in schema not supported since Solr 7\");\n       }\n+      node = rootNode.child(\"solrQueryParser\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4772a5c9dc3248beea053e5c63e6a86775e4f35b"}, "originalPosition": 187}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjU4NDkwOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/cloud/CloudConfigSetService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyMzozNlrOHgA5aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyMzozNlrOHgA5aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMTE3Nw==", "bodyText": "nit: make final?", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503331177", "createdAt": "2020-10-12T14:23:36Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/cloud/CloudConfigSetService.java", "diffHunk": "@@ -39,14 +43,28 @@\n  */\n public class CloudConfigSetService extends ConfigSetService {\n   private static final Logger log = LoggerFactory.getLogger(MethodHandles.lookup().lookupClass());\n-  \n+  private Map<String, ConfigCacheEntry> cache = new ConcurrentHashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjU5MTg4OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/core/XmlConfigFile.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyNToxMFrOHgA9gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDoyNToxMFrOHgA9gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzMjIyNA==", "bodyText": "If these are always the same, down still need two copies of it?", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503332224", "createdAt": "2020-10-12T14:25:10Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/core/XmlConfigFile.java", "diffHunk": "@@ -145,15 +139,15 @@ public XmlConfigFile(SolrResourceLoader loader, String name, InputSource is, Str\n       db.setErrorHandler(xmllog);\n       try {\n         doc = db.parse(is);\n-        origDoc = copyDoc(doc);\n+        origDoc = doc;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjYyNzg1OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/FieldTypePluginLoader.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozMzoxNlrOHgBTDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozMzoxNlrOHgBTDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzNzc0Mw==", "bodyText": "We can remove this and a few of the other suppressions.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503337743", "createdAt": "2020-10-12T14:33:16Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/schema/FieldTypePluginLoader.java", "diffHunk": "@@ -254,9 +253,9 @@ private Analyzer readAnalyzer(Node node) throws XPathExpressionException {\n       (\"[schema.xml] analyzer/charFilter\", CharFilterFactory.class, false, false) {\n \n       @Override\n-      @SuppressWarnings({\"rawtypes\"})\n-      protected CharFilterFactory create(SolrClassLoader loader, String name, String className, Node node) throws Exception {\n-        final Map<String,String> params = DOMUtil.toMap(node.getAttributes());\n+      @SuppressWarnings(\"rawtypes\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjY0MTYwOnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNjoyMFrOHgBbGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNjoyMFrOHgBbGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMzOTgwMw==", "bodyText": "I think these are more natural with the order of the parameters reversed. It also aligns better with the single argument version calling child(name, null) - easier to reason about in an IDE autocomplete.\nchild(name, test) reads more similarly to the previous XPath //name[test].", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503339803", "createdAt": "2020-10-12T14:36:20Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {\n+    return child(null, name);\n+  }\n+\n+  /**Iterate through child nodes with the name and return the first child that matches\n+   */\n+  default ConfigNode child(Predicate<ConfigNode> test, String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjY0MzMyOnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNjo0OFrOHgBcOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNjo0OFrOHgBcOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0MDA4OQ==", "bodyText": "This is never used, let's not add new API methods that we don't need", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503340089", "createdAt": "2020-10-12T14:36:48Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {\n+    return child(null, name);\n+  }\n+\n+  /**Iterate through child nodes with the name and return the first child that matches\n+   */\n+  default ConfigNode child(Predicate<ConfigNode> test, String name) {\n+    ConfigNode[] result = new ConfigNode[1];\n+    forEachChild(it -> {\n+      if (name!=null && !name.equals(it.name())) return Boolean.TRUE;\n+      if (test == null || test.test(it)) {\n+        result[0] = it;\n+        return Boolean.FALSE;\n+      }\n+      return Boolean.TRUE;\n+    });\n+    return result[0];\n+  }\n+\n+  /**Iterate through child nodes with the names and return all the matching children\n+   * @param nodeNames names of tags to be returned\n+   * @param  test check for the nodes to be returned\n+   */\n+  default List<ConfigNode> children(Predicate<ConfigNode> test, String... nodeNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjY0Njk3OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNzo0MFrOHgBeXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDozNzo0MFrOHgBeXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0MDYzOQ==", "bodyText": "I would reverse this argument order too.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503340639", "createdAt": "2020-10-12T14:37:40Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {\n+    return child(null, name);\n+  }\n+\n+  /**Iterate through child nodes with the name and return the first child that matches\n+   */\n+  default ConfigNode child(Predicate<ConfigNode> test, String name) {\n+    ConfigNode[] result = new ConfigNode[1];\n+    forEachChild(it -> {\n+      if (name!=null && !name.equals(it.name())) return Boolean.TRUE;\n+      if (test == null || test.test(it)) {\n+        result[0] = it;\n+        return Boolean.FALSE;\n+      }\n+      return Boolean.TRUE;\n+    });\n+    return result[0];\n+  }\n+\n+  /**Iterate through child nodes with the names and return all the matching children\n+   * @param nodeNames names of tags to be returned\n+   * @param  test check for the nodes to be returned\n+   */\n+  default List<ConfigNode> children(Predicate<ConfigNode> test, String... nodeNames) {\n+    return children(test, nodeNames == null ? Collections.emptySet() : Set.of(nodeNames));\n+  }\n+\n+  /**Iterate through child nodes with the names and return all the matching children\n+   * @param matchNames names of tags to be returned\n+   * @param  test check for the nodes to be returned\n+   */\n+  default List<ConfigNode> children(Predicate<ConfigNode> test, Set<String> matchNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjY5NzA3OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo0OTo0NVrOHgB89A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo0OTo0NVrOHgB89A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0ODQ2OA==", "bodyText": "I think this is a place where returning Optional<ConfigNode> makes sense, to align ourselves with JDK stream findFirst-like methods.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503348468", "createdAt": "2020-10-12T14:49:45Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/ConfigNode.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package org.apache.solr.common;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Function;\n+import java.util.function.Predicate;\n+\n+import org.apache.solr.cluster.api.SimpleMap;\n+\n+/**\n+ * A generic interface that represents a config file, mostly XML\n+ */\n+public interface ConfigNode {\n+  ThreadLocal<Function<String,String>> SUBSTITUTES = new ThreadLocal<>();\n+\n+  /**\n+   * Name of the tag\n+   */\n+  String name();\n+\n+  /**\n+   * Text value of the node\n+   */\n+  String textValue();\n+\n+  /**\n+   * Attributes\n+   */\n+  SimpleMap<String> attributes();\n+\n+  /**\n+   * Child by name\n+   */\n+  default ConfigNode child(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjcwMTQzOnYy", "diffSide": "LEFT", "path": "solr/core/src/java/org/apache/solr/util/plugin/AbstractPluginLoader.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNDo1MDo0NVrOHgB_nA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwNDowOTo1N1rOHgUtXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0OTE0OA==", "bodyText": "Does this have to be a list? Iterable<? extends ConfigNode>?", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503349148", "createdAt": "2020-10-12T14:50:45Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/util/plugin/AbstractPluginLoader.java", "diffHunk": "@@ -135,15 +134,13 @@ protected T create(SolrClassLoader loader, String name, String className, Node n\n    * If a default element is defined, it will be returned from this function.\n    * \n    */\n-  public T load(SolrClassLoader loader, NodeList nodes )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY1NTc3NA==", "bodyText": "it could be", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503655774", "createdAt": "2020-10-13T04:09:57Z", "author": {"login": "noblepaul"}, "path": "solr/core/src/java/org/apache/solr/util/plugin/AbstractPluginLoader.java", "diffHunk": "@@ -135,15 +134,13 @@ protected T create(SolrClassLoader loader, String name, String className, Node n\n    * If a default element is defined, it will be returned from this function.\n    * \n    */\n-  public T load(SolrClassLoader loader, NodeList nodes )", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0OTE0OA=="}, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1Mjc4OTg4OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/util/DOMUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNToxMjo0MFrOHgC1mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxNToxMjo0MFrOHgC1mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM2Mjk3MA==", "bodyText": "I wish this were a Set instead of an array, but I see the parallel to the other implementation of this.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r503362970", "createdAt": "2020-10-12T15:12:40Z", "author": {"login": "madrob"}, "path": "solr/solrj/src/java/org/apache/solr/common/util/DOMUtil.java", "diffHunk": "@@ -37,9 +39,24 @@\n \n   public static final String XML_RESERVED_PREFIX = \"xml\";\n \n+  public static final Set<String>  NL_TAGS = Set.of(\"str\", \"int\",\"long\",\"float\",\"double\",\"bool\");\n+\n+\n   public static Map<String,String> toMap(NamedNodeMap attrs) {\n     return toMapExcept(attrs);\n   }\n+  public static Map<String,String> toMap(ConfigNode node) {\n+    return toMapExcept(node);\n+  }\n+  public static Map<String,String> toMapExcept(ConfigNode node, String... exclusions) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "499d6ab50d44140d158ee4f0260548f4afb65339"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzI2OTA2OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/core/ConfigSetService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1ODo1OFrOIBDVmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1ODo1OFrOIBDVmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NDE2OQ==", "bodyText": "NULL_DEREFERENCE:  object returned by getDocument(schemaConf) could be null and is dereferenced at line 211.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r537974169", "createdAt": "2020-12-08T01:58:58Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/core/ConfigSetService.java", "diffHunk": "@@ -186,6 +198,20 @@ protected NamedList loadConfigSetFlags(CoreDescriptor cd, SolrResourceLoader loa\n    */\n   public abstract String configSetName(CoreDescriptor cd);\n \n+  public interface ConfigResource {\n+\n+    ConfigNode get() throws Exception;\n+\n+  }\n+  public static ConfigNode getParsedSchema(InputStream is, SolrResourceLoader loader, String name) throws IOException, SAXException, ParserConfigurationException {\n+    XmlConfigFile schemaConf = null;\n+    InputSource inputSource = new InputSource(is);\n+    inputSource.setSystemId(SystemIdResolver.createSystemIdFromResourceName(name));\n+    schemaConf = new XmlConfigFile(loader, SCHEMA, inputSource, SLASH + SCHEMA + SLASH, null);\n+    return new DataConfigNode(new DOMConfigNode(schemaConf.getDocument().getDocumentElement()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "898a8d9826770b9504748bd0095b634e7bdde0f4"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzI2OTE0OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1OTowMlrOIBDVpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1OTowMlrOIBDVpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NDE4Mg==", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method ManagedIndexSchemaFactory.create(...) indirectly reads with synchronization from this.config. Potentially races with unsynchronized write in method ManagedIndexSchemaFactory.create(...).\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r537974182", "createdAt": "2020-12-08T01:59:02Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -210,7 +215,7 @@ private InputStream readSchemaLocally() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "898a8d9826770b9504748bd0095b634e7bdde0f4"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3NzI2OTE2OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1OTowM1rOIBDVrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwMTo1OTowM1rOIBDVrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzk3NDE4OA==", "bodyText": "THREAD_SAFETY_VIOLATION:  Read/Write race. Non-private method ManagedIndexSchemaFactory.create(...) indirectly reads without synchronization from configSetService.zkController.cloudManager. Potentially races with write in method ManagedIndexSchemaFactory.create(...).\nReporting because this access may occur on a background thread.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r537974188", "createdAt": "2020-12-08T01:59:03Z", "author": {"login": "sonatype-lift"}, "path": "solr/core/src/java/org/apache/solr/schema/ManagedIndexSchemaFactory.java", "diffHunk": "@@ -174,8 +175,12 @@ public ManagedIndexSchema create(String resourceName, SolrConfig config) {\n     }\n     InputSource inputSource = new InputSource(schemaInputStream);\n     inputSource.setSystemId(SystemIdResolver.createSystemIdFromResourceName(loadedResource));\n-    schema = new ManagedIndexSchema(config, loadedResource, inputSource, isMutable,\n-                                    managedSchemaResourceName, schemaZkVersion, getSchemaUpdateLock());\n+    try {\n+      schema = new ManagedIndexSchema(config, loadedResource,IndexSchemaFactory.getConfigResource(configSetService, schemaInputStream, loader, managedSchemaResourceName) , isMutable,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "898a8d9826770b9504748bd0095b634e7bdde0f4"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQzMTQ2Mzc4OnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/common/util/PropertiesUtil.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxMTo1MVrOIIpQdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjoxMTo1MVrOIIpQdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTkzNTQ3Ng==", "bodyText": "@noblepaul  FYI java.util.function.UnaryOperator is a Function over same-type.  No need to go change this now; it's a minor point.", "url": "https://github.com/apache/lucene-solr/pull/1963#discussion_r545935476", "createdAt": "2020-12-18T16:11:51Z", "author": {"login": "dsmiley"}, "path": "solr/solrj/src/java/org/apache/solr/common/util/PropertiesUtil.java", "diffHunk": "@@ -22,17 +22,23 @@\n import java.util.Iterator;\n import java.util.List;\n import java.util.Properties;\n+import java.util.function.Function;\n+\n \n /**\n  * Breaking out some utility methods into a separate class as part of SOLR-4196. These utils have nothing to do with\n  * the DOM (they came from DomUtils) and it's really confusing to see them in something labeled DOM\n  */\n public class PropertiesUtil {\n+  public static String substituteProperty(String value, Properties coreProperties) {\n+    if(coreProperties == null) return substitute(value, null);\n+    return substitute(value, coreProperties::getProperty);\n+  }\n   /*\n   * This method borrowed from Ant's PropertyHelper.replaceProperties:\n   *   http://svn.apache.org/repos/asf/ant/core/trunk/src/main/org/apache/tools/ant/PropertyHelper.java\n   */\n-  public static String substituteProperty(String value, Properties coreProperties) {\n+  public static String substitute(String value, Function<String,String> coreProperties) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7251b65b804636bc6d023607101202271e56ff0e"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1137, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}