{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MzU5Mzg1", "number": 1434, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyNToxMlrODygDyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODowODowNlrODy_z2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MjgwNjUxOnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyNToxMlrOGGlItA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDo0OToxNVrOGHRIdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MzA3Ng==", "bodyText": "This happens during IndexWriter.addIndexes(Directory[]) right?  I wonder whether we should give a new id instead of reusing the old one?  E.g. the segment (likely) now has a new name, and is in a different Directory, and is copied/forked from a prior segment, so maybe it should get a new id?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409553076", "createdAt": "2020-04-16T13:25:12Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3081,7 +3081,7 @@ private SegmentCommitInfo copySegmentAsIs(SegmentCommitInfo info, String segName\n                                           info.info.getUseCompoundFile(), info.info.getCodec(), \n                                           info.info.getDiagnostics(), info.info.getId(), info.info.getAttributes(), info.info.getIndexSort());\n     SegmentCommitInfo newInfoPerCommit = new SegmentCommitInfo(newInfo, info.getDelCount(), info.getSoftDelCount(), info.getDelGen(),\n-                                                               info.getFieldInfosGen(), info.getDocValuesGen());\n+                                                               info.getFieldInfosGen(), info.getDocValuesGen(), info.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3ODQyOA==", "bodyText": "we do share the info.info.getId() here as well so I think we should be consistent?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409578428", "createdAt": "2020-04-16T13:59:01Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3081,7 +3081,7 @@ private SegmentCommitInfo copySegmentAsIs(SegmentCommitInfo info, String segName\n                                           info.info.getUseCompoundFile(), info.info.getCodec(), \n                                           info.info.getDiagnostics(), info.info.getId(), info.info.getAttributes(), info.info.getIndexSort());\n     SegmentCommitInfo newInfoPerCommit = new SegmentCommitInfo(newInfo, info.getDelCount(), info.getSoftDelCount(), info.getDelGen(),\n-                                                               info.getFieldInfosGen(), info.getDocValuesGen());\n+                                                               info.getFieldInfosGen(), info.getDocValuesGen(), info.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MzA3Ng=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MzkxMQ==", "bodyText": "ok", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410273911", "createdAt": "2020-04-17T14:49:15Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -3081,7 +3081,7 @@ private SegmentCommitInfo copySegmentAsIs(SegmentCommitInfo info, String segName\n                                           info.info.getUseCompoundFile(), info.info.getCodec(), \n                                           info.info.getDiagnostics(), info.info.getId(), info.info.getAttributes(), info.info.getIndexSort());\n     SegmentCommitInfo newInfoPerCommit = new SegmentCommitInfo(newInfo, info.getDelCount(), info.getSoftDelCount(), info.getDelGen(),\n-                                                               info.getFieldInfosGen(), info.getDocValuesGen());\n+                                                               info.getFieldInfosGen(), info.getDocValuesGen(), info.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1MzA3Ng=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MjgxMzc3OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyNjo1OFrOGGlNfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzo1NzozN1rOGHXvuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NDMwMQ==", "bodyText": "Do we need some thread safety here?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409554301", "createdAt": "2020-04-16T13:26:58Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -388,4 +399,17 @@ public SegmentCommitInfo clone() {\n   final int getDelCount(boolean includeSoftDeletes) {\n     return includeSoftDeletes ? getDelCount() + getSoftDelCount() : getDelCount();\n   }\n+\n+  private void generationAdvanced() {\n+    sizeInBytes = -1;\n+    id = null;\n+  }\n+\n+  public byte[] getId() {\n+    if (id == null) {\n+      // we advanced a generation - need to generate a new ID\n+      id = StringHelper.randomId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3NTk1NQ==", "bodyText": "yeah good question, as far as I can tell we never read or write any of the member vars on this class unless we hold a lock that protects it. But it's a mess so I guess we should. Yet, if we do that we should make every method on this class synced no?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409575955", "createdAt": "2020-04-16T13:55:50Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -388,4 +399,17 @@ public SegmentCommitInfo clone() {\n   final int getDelCount(boolean includeSoftDeletes) {\n     return includeSoftDeletes ? getDelCount() + getSoftDelCount() : getDelCount();\n   }\n+\n+  private void generationAdvanced() {\n+    sizeInBytes = -1;\n+    id = null;\n+  }\n+\n+  public byte[] getId() {\n+    if (id == null) {\n+      // we advanced a generation - need to generate a new ID\n+      id = StringHelper.randomId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NDMwMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI3MzY3MQ==", "bodyText": "I agree it's messy.  It's just that this sounds like a simple getter w/o side effect, yet, it does have an important and surprising side effect of setting the id.  It would be bad if two threads called it at once and got two different ids back.\nIf we really believe all callers are already sync'd (by IW's monitor lock), can we 1) add a comment stating this assumption, and 2) fix the assignment to do something like this instead:\n  byte[] newID = StringHelper.randomId();\n  assert id == null;\n  id = newID;\n\n?\nThat is still best effort, but might catch us in tests if we have cases where two threads really are invoking getId at once.\nOr, maybe we can change this to assign the id at the same time as the SCI was changed (e.g. delGen increased), instead of at get time?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410273671", "createdAt": "2020-04-17T14:48:49Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -388,4 +399,17 @@ public SegmentCommitInfo clone() {\n   final int getDelCount(boolean includeSoftDeletes) {\n     return includeSoftDeletes ? getDelCount() + getSoftDelCount() : getDelCount();\n   }\n+\n+  private void generationAdvanced() {\n+    sizeInBytes = -1;\n+    id = null;\n+  }\n+\n+  public byte[] getId() {\n+    if (id == null) {\n+      // we advanced a generation - need to generate a new ID\n+      id = StringHelper.randomId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NDMwMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 125}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4MjI2NQ==", "bodyText": "I changed this to roll over to a new ID each time the generation is incremented. I don't really like that we call StringHelper.randomId() over and over again. I wonder if it would be better to set a new ID from the outside just before we clone in order to commit instead of doing it inside SegmentCommitInfo. This would make things more explicit IMO", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410382265", "createdAt": "2020-04-17T17:57:37Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -388,4 +399,17 @@ public SegmentCommitInfo clone() {\n   final int getDelCount(boolean includeSoftDeletes) {\n     return includeSoftDeletes ? getDelCount() + getSoftDelCount() : getDelCount();\n   }\n+\n+  private void generationAdvanced() {\n+    sizeInBytes = -1;\n+    id = null;\n+  }\n+\n+  public byte[] getId() {\n+    if (id == null) {\n+      // we advanced a generation - need to generate a new ID\n+      id = StringHelper.randomId();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NDMwMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 125}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0MjgyNjE0OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "isResolved": true, "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxMzoyOTo1MVrOGGlVYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNDozNzo0MFrOGHQryg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ==", "bodyText": "Good question ... maybe we could use info.getId()?   Then it'd be unique across SCI, but, shared across SI which is also weird.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409556321", "createdAt": "2020-04-16T13:29:51Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU3NzgwNA==", "bodyText": "I don't think we should use info.getId() since that would mean that the same SegmentInfo instances are treated the same even if two IW made changes to it and it's generations. The way we have it now it's only considered the same if the overall commit is the same which is good i guess?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409577804", "createdAt": "2020-04-16T13:58:16Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgwNDI3Mg==", "bodyText": "When we introduced SegmentInfos#getId, we returned null as an ID for older segments. This is probably a safer option here as well, as callers can fall back to whatever behavior makes sense for them such as using a strong hash of the commit files as an ID, or re-downloading all files of the commit all the time and giving up incrementality?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409804272", "createdAt": "2020-04-16T19:41:18Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgxMjc5Ng==", "bodyText": "I think this case is a bit more complicated due to the changing nature of this ID. For each change (DV, llive docs, fields) we need to move to a new ID. Should we then just accept null and create a new ID once it changes or should we stick with null on these segments until they are written first time? Introducing null requires quite some changes in how we handle this which we can do, for sure. I still wonder if we can get away with stealing the parent ID and have a smooth upgrade path.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409812796", "createdAt": "2020-04-16T19:57:12Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTgzOTE1NA==", "bodyText": "I pushed a new commit f0a72f8 to address this.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409839154", "createdAt": "2020-04-16T20:48:39Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg0NDA0Ng==", "bodyText": "I don't understand the idea of stealing the parent ID, wouldn't it cause Lucene to consider commits equal when they are not, which would be a much worse problem than considering commits different when they are equal?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409844046", "createdAt": "2020-04-16T20:58:08Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg1MTUyMQ==", "bodyText": "I don't understand the idea of stealing the parent ID, wouldn't it cause Lucene to consider commits equal when they are not, which would be a much worse problem than considering commits different when they are equal?\n\nthe idea was to use the SegmentInfos ID which is different for every commit as a default. It would not cause Lucene to consider commits equal when they are not. I just moved to using null instead, it was an idea that has downsides too we can just go with null. The real question is when do we assign an ID then? Once we write the SCI again even if it didn't change? I think we should but that would then bring back the same problem with the fallback.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409851521", "createdAt": "2020-04-16T21:12:44Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTg2NjQ2Mg==", "bodyText": "Ah sorry I got confused because I thought that \"parent\" was referring to SegmentInfo (no s) instead of SegmentInfos, but I agree that SegmentInfos is not great either.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409866462", "createdAt": "2020-04-16T21:44:05Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI2NjU3MA==", "bodyText": "+1 for null and have caller deal with the BWC.  Stealing the id from another place (either \"parent\" SegmentInfos or the corresponding SegmentInfo) seems too dangerous.", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410266570", "createdAt": "2020-04-17T14:37:40Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,15 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74) {\n+        sciId = new byte[StringHelper.ID_LENGTH];\n+        input.readBytes(sciId, 0, sciId.length);\n+      } else {\n+        sciId = infos.id;\n+        // NOCOMMIT can we do this? it would at least give us consistent BWC but we can't identify the same SCI in different commits", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTU1NjMyMQ=="}, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDI5ODQxOnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToyNDo1MVrOGGz7qg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToyNDo1MVrOGGz7qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5NTQ5OA==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               *  @param info\n          \n          \n            \n               * @param info", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r409795498", "createdAt": "2020-04-16T19:24:51Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -79,8 +85,7 @@\n \n   /**\n    * Sole constructor.\n-   * \n-   * @param info\n+   *  @param info", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9da9d88f48348bb3c204183e09c94501d0184776"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc3MzM2OnYy", "diffSide": "RIGHT", "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDowMFrOGHLtGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDowMFrOGHLtGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4NDk4Nw==", "bodyText": "nit: turn it in such a way that it would return a non-null SCI to make it easier to debug in case it fails? E.g.\nassertNull(\"none of the segments should have been upgraded\", si.asList().stream().filter(sci -> sci.getId() != null).findAny().orElse(null));", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410184987", "createdAt": "2020-04-17T12:20:00Z", "author": {"login": "jpountz"}, "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "diffHunk": "@@ -830,8 +829,9 @@ public void testAddOldIndexes() throws IOException {\n       IndexWriter w = new IndexWriter(targetDir, newIndexWriterConfig(new MockAnalyzer(random())));\n       w.addIndexes(oldDir);\n       w.close();\n-      targetDir.close();\n \n+      SegmentInfos si = SegmentInfos.readLatestCommit(targetDir);\n+      assertEquals(\"none of the segments should have been upgraded\", 0, si.asList().stream().filter(sci -> sci.getId() != null).count());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc3MzcxOnYy", "diffSide": "RIGHT", "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDowN1rOGHLtSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMDowN1rOGHLtSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4NTAzNA==", "bodyText": "here too?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410185034", "createdAt": "2020-04-17T12:20:07Z", "author": {"login": "jpountz"}, "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "diffHunk": "@@ -862,7 +862,8 @@ public void testAddOldIndexesReader() throws IOException {\n       TestUtil.addIndexesSlowly(w, reader);\n       w.close();\n       reader.close();\n-            \n+      SegmentInfos si = SegmentInfos.readLatestCommit(targetDir);\n+      assertEquals(\"all SCIs should have an id now\", 0, si.asList().stream().filter(sci -> sci.getId() == null).count());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0Njc4NTIyOnYy", "diffSide": "RIGHT", "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyMzo1M1rOGHL0aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzozNTozNlrOGHXCwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4Njg1Ng==", "bodyText": "we need to make this assert depend on the version to be future-proof? Ie.\nif (info.info.getVersion().onOrAfter(Version.LUCENE_8_6_0)) {\n  assertNotNull(info.toString(), info.getId());\n} else {\n  assertNull(info.toString(), info.getId());\n}\n\n?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410186856", "createdAt": "2020-04-17T12:23:53Z", "author": {"login": "jpountz"}, "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "diffHunk": "@@ -1367,6 +1368,16 @@ public void testIndexCreatedVersion() throws IOException {\n     }\n   }\n \n+  public void testSegmentCommitInfoId() throws IOException {\n+    for (String name : oldNames) {\n+      Directory dir = oldIndexDirs.get(name);\n+      SegmentInfos infos = SegmentInfos.readLatestCommit(dir);\n+      for (SegmentCommitInfo info : infos) {\n+        assertNull(info.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDc1NA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410370754", "createdAt": "2020-04-17T17:35:36Z", "author": {"login": "s1monw"}, "path": "lucene/backward-codecs/src/test/org/apache/lucene/index/TestBackwardsCompatibility.java", "diffHunk": "@@ -1367,6 +1368,16 @@ public void testIndexCreatedVersion() throws IOException {\n     }\n   }\n \n+  public void testSegmentCommitInfoId() throws IOException {\n+    for (String name : oldNames) {\n+      Directory dir = oldIndexDirs.get(name);\n+      SegmentInfos infos = SegmentInfos.readLatestCommit(dir);\n+      for (SegmentCommitInfo info : infos) {\n+        assertNull(info.getId());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4Njg1Ng=="}, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjgwMDYwOnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjoyOTowM1rOGHL-Dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzozNTo0N1rOGHXDIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4OTMyNw==", "bodyText": "can you be stricter and throw a CorruptIndexException if the byte is neither 0 nor 1?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410189327", "createdAt": "2020-04-17T12:29:03Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,18 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74 ) {\n+        if (input.readByte() == 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM3MDg0OQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410370849", "createdAt": "2020-04-17T17:35:47Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -374,7 +376,18 @@ public static final SegmentInfos readCommit(Directory directory, ChecksumIndexIn\n       if (softDelCount + delCount > info.maxDoc()) {\n         throw new CorruptIndexException(\"invalid deletion count: \" + softDelCount + delCount + \" vs maxDoc=\" + info.maxDoc(), input);\n       }\n-      SegmentCommitInfo siPerCommit = new SegmentCommitInfo(info, delCount, softDelCount, delGen, fieldInfosGen, dvGen);\n+      final byte[] sciId;\n+      if (format > VERSION_74 ) {\n+        if (input.readByte() == 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE4OTMyNw=="}, "originalCommit": {"oid": "3224de64404f139c8f0a84345bec7a00803676ce"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0ODAwODU4OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODowODowNlrOGHYFUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxODowODowNlrOGHYFUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM4Nzc5Mw==", "bodyText": "We can remove this now?", "url": "https://github.com/apache/lucene-solr/pull/1434#discussion_r410387793", "createdAt": "2020-04-17T18:08:06Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentCommitInfo.java", "diffHunk": "@@ -77,9 +83,11 @@\n   // this is never written to/read from the Directory\n   private long bufferedDeletesGen = -1;\n \n+  // is set once any of the generations has been advanced.\n+  private boolean hasAdvanced;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af4896cfdc491ea645c24f0392f6739303e654f"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 775, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}