{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3MDk4MDUx", "number": 2068, "title": "LUCENE-8982: Separate out native code to another module to allow cpp build with gradle", "bodyText": "Description\nWhen working on https://issues.apache.org/jira/browse/LUCENE-8982, we realized that there may no longer be a way to build native cpp code due to migration away from ant. This patch separate out native code to another module to allow cpp build with gradle.\nSolution\nCreate a new lucene module and new parameter -Pbuild.native=true for cpp code compilation.\nTests\nPending\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ./gradlew check.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-11-07T06:52:46Z", "url": "https://github.com/apache/lucene-solr/pull/2068", "merged": true, "mergeCommit": {"oid": "ebc87a8a27f3b3bd89ea7c38c8b701d94e50788d"}, "closed": true, "closedAt": "2020-11-16T08:40:04Z", "author": {"login": "zacharymorn"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaF1UnAH2gAyNTE3MDk4MDUxOjU2Y2ZhZjZhMzkxZGJhNDA3YzkyYzY0ODA3MDBmZDkzOTlkOTlmNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABddAZbmgH2gAyNTE3MDk4MDUxOjNlYjhmYWY2ZmMxOTc3ZDlkNmIwNDMxYWI2ZjlhMmUxOTkzNzEwODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/56cfaf6a391dba407c92c6480700fd9399d99f4a", "committedDate": "2020-11-07T06:47:02Z", "message": "LUCENE-8982: Separate out native code to another module to allow cpp build with gradle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1Nzg5ODA1", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-525789805", "createdAt": "2020-11-08T09:27:39Z", "commit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwOToyNzozOVrOHvQhTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwOTozMzo1NVrOHvQrNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxNTc4OA==", "bodyText": "this should be resolved relative to the JVM we compile against, not gradle's JVM. See alternative-jdk-support.gradle and use root project's property:\n// Set up root project's property.\nrootProject.ext.runtimeJava = altJvm", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519315788", "createdAt": "2020-11-08T09:27:39Z", "author": {"login": "dweiss"}, "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMxODMyNQ==", "bodyText": "Maybe we should check for existence of these folders and add them only if they exist? Seems strange to add includes for all of them.", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519318325", "createdAt": "2020-11-08T09:33:55Z", "author": {"login": "dweiss"}, "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')\n+    privateHeaders.from file(System.getProperty('java.home') + '/include/darwin')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NzkwNjUx", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-525790651", "createdAt": "2020-11-08T09:39:37Z", "commit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwOTozOTozN1rOHvQ0Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOFQwOTozOTozN1rOHvQ0Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTMyMDY0Ng==", "bodyText": "Are these really a folder up from java.home? On my linux (java 11-15) they seem to be right under JDK's home (although I install Java manually, not via distribution-specific package manager).", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r519320646", "createdAt": "2020-11-08T09:39:37Z", "author": {"login": "dweiss"}, "path": "lucene/native/build.gradle", "diffHunk": "@@ -0,0 +1,42 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+apply plugin: 'cpp-library'\n+\n+description = 'Module for native code'\n+\n+library {\n+    baseName = 'NativePosixUtil'\n+\n+    privateHeaders.from file(System.getProperty('java.home') + '/include')\n+    privateHeaders.from file(System.getProperty('java.home') + '/include/darwin')\n+    privateHeaders.from file(System.getProperty('java.home') + '/../include/solaris')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56cfaf6a391dba407c92c6480700fd9399d99f4a"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55212151aa81d745ff8fef7276dae523abea0e0d", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/55212151aa81d745ff8fef7276dae523abea0e0d", "committedDate": "2020-11-09T00:07:31Z", "message": "Condition native build by using -Pbuild.native=true attribute"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6c16c00faaad2c626a93495f9dfbf878d62968b", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/b6c16c00faaad2c626a93495f9dfbf878d62968b", "committedDate": "2020-11-09T01:02:33Z", "message": "Use rootProject.ext.runtimeJava instead of plain vanilla java.home"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31f10be6219e4a745aaae0ec29b75202e391d234", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/31f10be6219e4a745aaae0ec29b75202e391d234", "committedDate": "2020-11-09T03:46:07Z", "message": "Check include folder exist before using"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/085c71c384442ceb7b2a0ca371429321e7b1b4fe", "committedDate": "2020-11-09T21:10:17Z", "message": "Windows build. Cleanups."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjYxMjI4", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-526661228", "createdAt": "2020-11-09T21:17:18Z", "commit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMToxNzoxOVrOHwB8XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMToxNzoxOVrOHwB8XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg==", "bodyText": "I wonder if we should rename the resulting native library something more specific...", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520125532", "createdAt": "2020-11-09T21:17:19Z", "author": {"login": "dweiss"}, "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODM3NzM2", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-526837736", "createdAt": "2020-11-10T04:07:09Z", "commit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDowNzoxMFrOHwK92A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwNDowNzoxMFrOHwK92A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzM2OA==", "bodyText": "Just curious, shall we also modify the compiler args when it\u2019s on Windows, to be the same with what's used before?\n\n  \n    \n      lucene-solr/lucene/misc/src/java/org/apache/lucene/store/WindowsDirectory.java\n    \n    \n        Lines 31 to 35\n      in\n      ec9a659\n    \n    \n    \n    \n\n        \n          \n            * c:\\mingw\\bin\\g++ -Wall -D_JNI_IMPLEMENTATION_ -Wl,--kill-at  \n        \n\n        \n          \n            * -I\"%JAVA_HOME%\\include\" -I\"%JAVA_HOME%\\include\\win32\" -static-libgcc  \n        \n\n        \n          \n            * -static-libstdc++ -shared WindowsDirectory.cpp -o WindowsDirectory.dll \n        \n\n        \n          \n            *       </blockquote>  \n        \n\n        \n          \n            *       For 64-bit JREs, use mingw64, with the -m64 option.  \n        \n    \n  \n\n\nA quick search shows that some of these flags might be specific to MinGW compiler though, so I'm not sure if these flags are still relevant.", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520273368", "createdAt": "2020-11-10T04:07:10Z", "author": {"login": "zacharymorn"}, "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'\n+\n+  // Native build for Windows platform will be added in later stage\n+  targetMachines = [\n+      machines.linux.x86_64,\n+      machines.macOS.x86_64,\n+      machines.windows.x86_64\n+  ]\n+\n+  // Point at platform-specific sources. Other platforms will be ignored\n+  // (plugin won't find the toolchain).\n+  if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n+    source.from file(\"${projectDir}/src/main/windows\")\n+  } else if (Os.isFamily(Os.FAMILY_UNIX) || Os.isFamily(Os.FAMILY_MAC)) {\n+    source.from file(\"${projectDir}/src/main/posix\")\n+  }\n+}\n+\n+tasks.withType(CppCompile).configureEach {\n+  def javaHome = rootProject.ext.runtimeJava.getInstallationDirectory().getAsFile().getPath()\n+\n+  // Assume standard openjdk layout. This means only one architecture-specific include folder\n+  // is present.\n+  systemIncludes.from file(\"${javaHome}/include\")\n+\n+  for (def path : [\n+      file(\"${javaHome}/include/win32\"),\n+      file(\"${javaHome}/include/darwin\"),\n+      file(\"${javaHome}/include/linux\"),\n+      file(\"${javaHome}/include/solaris\")]) {\n+    if (path.exists()) {\n+      systemIncludes.from path\n+    }\n+  }\n+\n+  compilerArgs.add '-fPIC'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2OTcxOTUx", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-526971951", "createdAt": "2020-11-10T08:44:24Z", "commit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwODo0NDoyNFrOHwRv0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQwODo0Njo0M1rOHwR12g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NDQ2Nw==", "bodyText": "Sure. Maybe LuceneNativeIO though so that it's clear what dll it is?", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520384467", "createdAt": "2020-11-10T08:44:24Z", "author": {"login": "dweiss"}, "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDEyNTUzMg=="}, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NTA5MA==", "bodyText": "I wouldn't add anything if it works (and it currently does for me). There are compiler toolchain-specific ways of adding options but like I said - if it's not required, I wouldn't worry about it.", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520385090", "createdAt": "2020-11-10T08:45:18Z", "author": {"login": "dweiss"}, "path": "lucene/misc/native/build.gradle", "diffHunk": "@@ -0,0 +1,69 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+/*\n+ * This gets separated out from misc module into a native module due to incompatibility between cpp-library and java-library plugins.\n+ * For details, please see https://github.com/gradle/gradle-native/issues/352#issuecomment-461724948\n+ */\n+import org.apache.tools.ant.taskdefs.condition.Os\n+\n+description = 'Module for native code'\n+\n+apply plugin: 'cpp-library'\n+\n+library {\n+  baseName = 'NativePosixUtil'\n+\n+  // Native build for Windows platform will be added in later stage\n+  targetMachines = [\n+      machines.linux.x86_64,\n+      machines.macOS.x86_64,\n+      machines.windows.x86_64\n+  ]\n+\n+  // Point at platform-specific sources. Other platforms will be ignored\n+  // (plugin won't find the toolchain).\n+  if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n+    source.from file(\"${projectDir}/src/main/windows\")\n+  } else if (Os.isFamily(Os.FAMILY_UNIX) || Os.isFamily(Os.FAMILY_MAC)) {\n+    source.from file(\"${projectDir}/src/main/posix\")\n+  }\n+}\n+\n+tasks.withType(CppCompile).configureEach {\n+  def javaHome = rootProject.ext.runtimeJava.getInstallationDirectory().getAsFile().getPath()\n+\n+  // Assume standard openjdk layout. This means only one architecture-specific include folder\n+  // is present.\n+  systemIncludes.from file(\"${javaHome}/include\")\n+\n+  for (def path : [\n+      file(\"${javaHome}/include/win32\"),\n+      file(\"${javaHome}/include/darwin\"),\n+      file(\"${javaHome}/include/linux\"),\n+      file(\"${javaHome}/include/solaris\")]) {\n+    if (path.exists()) {\n+      systemIncludes.from path\n+    }\n+  }\n+\n+  compilerArgs.add '-fPIC'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDI3MzM2OA=="}, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NTU5Ng==", "bodyText": "I removed the flag and forgot to update the docs here.", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520385596", "createdAt": "2020-11-10T08:46:04Z", "author": {"login": "dweiss"}, "path": "lucene/misc/src/java/org/apache/lucene/store/NativeUnixDirectory.java", "diffHunk": "@@ -47,10 +47,10 @@\n  *\n  * <p>To use this you must compile\n  * NativePosixUtil.cpp (exposes Linux-specific APIs through\n- * JNI) for your platform, by running <code>ant\n- * build-native-unix</code>, and then putting the resulting\n- * <code>libNativePosixUtil.so</code> (from\n- * <code>lucene/build/native</code>) onto your dynamic\n+ * JNI) for your platform, by running <code>\n+ * ./gradlew build -Pbuild.native=true</code>, and then putting the resulting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDM4NjAxMA==", "bodyText": "This reference needs an updated path - it'll probably fail when building the whole project.", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r520386010", "createdAt": "2020-11-10T08:46:43Z", "author": {"login": "dweiss"}, "path": "lucene/packaging/build.gradle", "diffHunk": "@@ -32,7 +32,9 @@ def includeInBinaries = project(\":lucene\").subprojects.findAll {subproject ->\n         \":lucene:packaging\",\n         \":lucene:documentation\",\n         // Exclude parent container project of analysis modules (no artifacts).\n-        \":lucene:analysis\"\n+        \":lucene:analysis\",\n+        // Exclude native module, which requires manual copying and enabling\n+        \":lucene:native\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "085c71c384442ceb7b2a0ca371429321e7b1b4fe"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ac440fa1ee5b901130d1ee712c1af7880a508a35", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/ac440fa1ee5b901130d1ee712c1af7880a508a35", "committedDate": "2020-11-11T03:07:39Z", "message": "Update naming, references and documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6557a17fedcb31b933d7cba1b85e6e0d455e7751", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/6557a17fedcb31b933d7cba1b85e6e0d455e7751", "committedDate": "2020-11-11T03:17:54Z", "message": "Merge branch 'master' into LUCENE-8982-NativeBuild"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b", "committedDate": "2020-11-11T04:05:02Z", "message": "Remove outdated files created during merge conflict resolution, this would cause git to think there's a move for the 2 files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDE3MDc1", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-528017075", "createdAt": "2020-11-11T09:47:55Z", "commit": {"oid": "d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTo0Nzo1NVrOHxF2UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTo0Nzo1NVrOHxF2UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIzODA5Nw==", "bodyText": "Hmm... how come you have intellij's old-style files and not the folder-based layout? :)", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521238097", "createdAt": "2020-11-11T09:47:55Z", "author": {"login": "dweiss"}, "path": ".gitignore", "diffHunk": "@@ -8,6 +8,10 @@ build/\n /.idea/\n #    IntelliJ creates this folder, ignore.\n /dev-tools/missing-doclet/out/\n+*.iml", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7322ef0a4e0dafa12e2f24034fbdea68fdb2f4b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90763e71290986160f1cfc7fb7ac8bb11d317a41", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/90763e71290986160f1cfc7fb7ac8bb11d317a41", "committedDate": "2020-11-11T20:34:23Z", "message": "Add 'build.native' kill switch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a27baf8ff39e5240635de9cccbe93a6b67aa87f", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/1a27baf8ff39e5240635de9cccbe93a6b67aa87f", "committedDate": "2020-11-12T03:28:30Z", "message": "Merge branch 'master' into LUCENE-8982-NativeBuild"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "948f873ba59315d4d79b72d0010b01cb75f72054", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/948f873ba59315d4d79b72d0010b01cb75f72054", "committedDate": "2020-11-12T03:28:51Z", "message": "Update native code and overview.html to reflect the new locations / way of buildling native code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NzI2NDIw", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-528726420", "createdAt": "2020-11-12T03:32:43Z", "commit": {"oid": "948f873ba59315d4d79b72d0010b01cb75f72054"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMzozMjo0M1rOHxoUQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwMzozMjo0M1rOHxoUQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTgwMjgxNw==", "bodyText": "These paths need to be adjusted as the native code has been moved in d111039", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r521802817", "createdAt": "2020-11-12T03:32:43Z", "author": {"login": "zacharymorn"}, "path": "lucene/misc/native/src/main/posix/NativePosixUtil.cpp", "diffHunk": "@@ -38,12 +38,12 @@\n \n #ifdef LINUX\n /*\n- * Class:     org_apache_lucene_store_NativePosixUtil\n+ * Class:     org_apache_lucene_misc_store_NativePosixUtil\n  * Method:    posix_fadvise\n  * Signature: (Ljava/io/FileDescriptor;JJI)V\n  */\n extern \"C\"\n-JNIEXPORT jint JNICALL Java_org_apache_lucene_store_NativePosixUtil_posix_1fadvise(JNIEnv *env, jclass _ignore, jobject fileDescriptor, jlong offset, jlong len, jint advice)\n+JNIEXPORT jint JNICALL Java_org_apache_lucene_misc_store_NativePosixUtil_posix_1fadvise(JNIEnv *env, jclass _ignore, jobject fileDescriptor, jlong offset, jlong len, jint advice)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "948f873ba59315d4d79b72d0010b01cb75f72054"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4dac53d510bcdce5056cd68073ba5dc4c7a187c", "author": {"user": {"login": "zacharymorn", "name": "zacharymorn"}}, "url": "https://github.com/apache/lucene-solr/commit/e4dac53d510bcdce5056cd68073ba5dc4c7a187c", "committedDate": "2020-11-12T05:37:55Z", "message": "Add test and fix WindowsDirectory library name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b60b0c0988dcd437fc3076c530fd4ee1d3f4718", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/9b60b0c0988dcd437fc3076c530fd4ee1d3f4718", "committedDate": "2020-11-13T08:16:10Z", "message": "Clean up the overview a bit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f", "committedDate": "2020-11-13T10:03:09Z", "message": "Run or ignore native tests on multiple platforms."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a635b564a1d4701ec26e8adf927c030c639c3ecb", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/a635b564a1d4701ec26e8adf927c030c639c3ecb", "committedDate": "2020-11-13T10:08:54Z", "message": "Add require permission on linux."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwNTQ2Mzcw", "url": "https://github.com/apache/lucene-solr/pull/2068#pullrequestreview-530546370", "createdAt": "2020-11-14T02:28:02Z", "commit": {"oid": "22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMjoyODowMlrOHzHEsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNFQwMjoyODowMlrOHzHEsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzM1NTMxNQ==", "bodyText": "This configuration block seems very auto-magical to me in that it somehow gets linked to :lucene:misc:native/build folder (no reference to nativeProjects here),  and the copyNativeDeps task below copies only the needed library artifact without all the nested folder structure (nor does it seems to copy any other random file I created in :lucene:misc:native/build folder to test thing out). Is this some convention trigged by the two attribute settings below?", "url": "https://github.com/apache/lucene-solr/pull/2068#discussion_r523355315", "createdAt": "2020-11-14T02:28:02Z", "author": {"login": "zacharymorn"}, "path": "gradle/native/disable-native.gradle", "diffHunk": "@@ -17,20 +17,65 @@\n \n // This is the master switch to disable all tasks that compile\n // native (cpp) code.\n-def buildNative = propertyOrDefault(\"build.native\", true).toBoolean()\n+rootProject.ext {\n+  buildNative = propertyOrDefault(\"build.native\", true).toBoolean()\n+}\n+\n+// Explicitly list all projects that should be configured for native extensions.\n+// We could scan for projects with a the cpp-library plugin but this is faster.\n+def nativeProjects = allprojects.findAll {it.path in [\n+    \":lucene:misc:native\"\n+]}\n+\n+def javaProjectsWithNativeDeps = allprojects.findAll {it.path in [\n+    \":lucene:misc\"\n+]}\n+\n+// Set up defaults for projects with native dependencies.\n+configure(javaProjectsWithNativeDeps, {\n+  configurations {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "22a1bdcabe62c4eaa08093e13a8b5e73c0346a7f"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e959967fd587874af7eb4efb1e92dbe402415f2f", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/e959967fd587874af7eb4efb1e92dbe402415f2f", "committedDate": "2020-11-16T07:58:30Z", "message": "Merge remote-tracking branch 'origin/master' into LUCENE-8982-NativeBuild"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb8faf6fc1977d9d6b0431ab6f9a2e199371089", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/3eb8faf6fc1977d9d6b0431ab6f9a2e199371089", "committedDate": "2020-11-16T08:08:49Z", "message": "Added changes entry."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2582, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}