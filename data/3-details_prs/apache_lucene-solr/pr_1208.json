{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MDUwMjY4", "number": 1208, "title": "SOLR-13101: Convert nanotime to ms", "bodyText": "Description\nContinue logging ms, but use System.nanoTime instead of System.currentTimeMillis for more precise measurement of elapsed time. Specifically updating references from this previous PR: #1117\nSolution\nDivide nanoseconds by 1000000 to get milliseconds. Converting nanoTime to milliseconds is more precise than using currentTimeMillis because it does not use the system clock time which could face disruptions\nTests\nRan ant test and manually examined loglines", "createdAt": "2020-01-24T23:07:08Z", "url": "https://github.com/apache/lucene-solr/pull/1208", "merged": true, "mergeCommit": {"oid": "51bf98cf8367a67d5d17fec6e172625967221cb4"}, "closed": true, "closedAt": "2020-02-05T02:54:34Z", "author": {"login": "ebehrendt"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9mYQoAH2gAyMzY3MDUwMjY4OjlmMTJhOGM2MTcwMTVlZjM2ZDQ2ZDJkODc1ZWFmMTVjYzBkMjBjMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBKTwPAFqTM1MzM4MDQ0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9f12a8c617015ef36d46d2d875eaf15cc0d20c2a", "author": {"user": {"login": "ebehrendt", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/9f12a8c617015ef36d46d2d875eaf15cc0d20c2a", "committedDate": "2020-01-24T22:07:12Z", "message": "Convert nanoseconds to milliseconds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "author": {"user": {"login": "ebehrendt", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/6c0e904cb4f94fc5bb21f7e03ef288744f582dde", "committedDate": "2020-01-24T22:18:47Z", "message": "Clean up from incorrect merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MjczOTgz", "url": "https://github.com/apache/lucene-solr/pull/1208#pullrequestreview-348273983", "createdAt": "2020-01-24T23:10:23Z", "commit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMzoxMDoyM1rOFhszLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQyMzoxMDoyM1rOFhszLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MTMyNg==", "bodyText": "From what I could find, deletedAt and deleteDelay is only set using System.nanoTime/1000000, so there should not be any mismatch from comparing times that used nanoTime and times that used currentTimeMillis", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370881326", "createdAt": "2020-01-24T23:10:23Z", "author": {"login": "ebehrendt"}, "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java", "diffHunk": "@@ -499,7 +500,7 @@ void enqueueForHardDelete(BlobCoreMetadataBuilder bcmBuilder) throws Exception {\n     @VisibleForTesting\n     protected boolean okForHardDelete(BlobCoreMetadata.BlobFileToDelete file) {\n       // For now we only check how long ago the file was marked for delete.\n-      return System.nanoTime() - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();\n+      return (System.nanoTime() / 1000000) - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4Mjg2NTI2", "url": "https://github.com/apache/lucene-solr/pull/1208#pullrequestreview-348286526", "createdAt": "2020-01-25T00:02:13Z", "commit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQwMDowMjoxM1rOFhtcCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNVQwMDowMzowMFrOFhtciQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTc4Nw==", "bodyText": "It might be a good idea to update the BlobFileToDelete class to make it explicit via the javadoc (actually it doesn't have any) that the getDeletedAt() returns the timestamp in milliseconds", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370891787", "createdAt": "2020-01-25T00:02:13Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java", "diffHunk": "@@ -499,7 +500,7 @@ void enqueueForHardDelete(BlobCoreMetadataBuilder bcmBuilder) throws Exception {\n     @VisibleForTesting\n     protected boolean okForHardDelete(BlobCoreMetadata.BlobFileToDelete file) {\n       // For now we only check how long ago the file was marked for delete.\n-      return System.nanoTime() - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();\n+      return (System.nanoTime() / 1000000) - file.getDeletedAt() >= deleteManager.getDeleteDelayMs();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg4MTMyNg=="}, "originalCommit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDg5MTkxMw==", "bodyText": "I'd consider making System.nanoTime() / 1000000 a util method in BlobStoreUtils", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r370891913", "createdAt": "2020-01-25T00:03:00Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/store/blob/metadata/CorePushPull.java", "diffHunk": "@@ -114,7 +114,7 @@ protected CoreContainer getContainerFromServerMetadata(ServerSideMetadata solrSe\n      * @param newMetadataSuffix suffix of the new core.metadata file to be created as part of this push\n      */\n     public BlobCoreMetadata pushToBlobStore(String currentMetadataSuffix, String newMetadataSuffix) throws Exception {\n-      long startTimeMs = System.nanoTime();\n+      long startTimeMs = System.nanoTime() / 1000000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c0e904cb4f94fc5bb21f7e03ef288744f582dde"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "author": {"user": {"login": "ebehrendt", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/cf4bbfeac67a4493b24cefbf74cf60dd885db6a5", "committedDate": "2020-02-04T00:05:50Z", "message": "Incorporate CR feedback to move time to a utility function. Use TimeUnit java util to convert from nanoseconds to milliseconds."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTk1MDg3", "url": "https://github.com/apache/lucene-solr/pull/1208#pullrequestreview-353195087", "createdAt": "2020-02-04T18:17:09Z", "commit": {"oid": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODoxNzoxMFrOFleXrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxODoxNzoxMFrOFleXrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgzOTIxNQ==", "bodyText": "Why not just call it getCurrentTimeMs and let the javadoc make it clear it's not the same as System.currentTimeMillis(), the main reason being it was changed originally to fix ant precommit failures?", "url": "https://github.com/apache/lucene-solr/pull/1208#discussion_r374839215", "createdAt": "2020-02-04T18:17:10Z", "author": {"login": "andyvuong"}, "path": "solr/core/src/java/org/apache/solr/store/blob/util/BlobStoreUtils.java", "diffHunk": "@@ -75,6 +76,16 @@ public static String generateMetadataSuffix() {\n     return UUID.randomUUID().toString();\n   }\n \n+  /**\n+   * Returns current nano time in millisecond resolution for use in measuring elapsed time.\n+   * \n+   * Note: Do not combine this value with currentTimeMillis - currentTimeMillis will return ms relative to epoch\n+   * while this method returns ms relative to some arbitrary time\n+   */\n+  public static long getCurrentNanoTimeInMs() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cf4bbfeac67a4493b24cefbf74cf60dd885db6a5"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d211e360f43c4bfa930bc156f7d361d01032075b", "author": {"user": {"login": "ebehrendt", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/d211e360f43c4bfa930bc156f7d361d01032075b", "committedDate": "2020-02-04T23:29:51Z", "message": "Rename method from getCurrentNanoTimeInMs to getCurrentTimeMs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e54811314065715cd4500481b2ec649ece12c7", "author": {"user": {"login": "ebehrendt", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/f4e54811314065715cd4500481b2ec649ece12c7", "committedDate": "2020-02-04T23:38:20Z", "message": "Resolve merge conflict"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMzgwNDQ4", "url": "https://github.com/apache/lucene-solr/pull/1208#pullrequestreview-353380448", "createdAt": "2020-02-04T23:40:38Z", "commit": {"oid": "f4e54811314065715cd4500481b2ec649ece12c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2261, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}