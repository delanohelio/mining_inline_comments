{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNDA5NDE5", "number": 1777, "title": "LUCENE-9477: Don't leave potentially broken segments file behind", "bodyText": "If we fail to rollback an already renamed pending segments file during\ncommit due to a failure in directory syncing we might not fully roll back\nto a proper state if we hit a failure during rollback which leaves the index\nin a broken state. This is a best effort approach to remove the renamed file\nin the case of a failure during sync.", "createdAt": "2020-08-24T10:07:45Z", "url": "https://github.com/apache/lucene-solr/pull/1777", "merged": true, "mergeCommit": {"oid": "da095bc7da6ff5f8e2005d55156605ac5144ebda"}, "closed": true, "closedAt": "2020-08-24T18:19:44Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB_tnOAH2gAyNDcyNDA5NDE5OmI4ZjY4ZTliMDE5MTUxMzkxZGRhMWQ5M2YwOGI4ZDJmNjZlZmY5ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCBlgEgFqTQ3MzQwNzI0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8f68e9b019151391dda1d93f08b8d2f66eff9ed", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/b8f68e9b019151391dda1d93f08b8d2f66eff9ed", "committedDate": "2020-08-24T10:05:00Z", "message": "LUCENE-9477: Don't leave potentially broken segments file behind\n\nIf we fail to rollback an already renamed pending segments file during\ncommit due to a failure in directory syncing we might not fully roll back\nto a proper state if we hit a failure during rollback which leaves the index\nin a broken state. This is a best effort approach to remove the renamed file\nin the case of a failure during sync."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fcf00f2e314b51a82ac8914084c80f68925e54", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/c1fcf00f2e314b51a82ac8914084c80f68925e54", "committedDate": "2020-08-24T10:08:21Z", "message": "remove sysout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aff469b99dea98a94e9b8d0600cf51b0280f590", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/8aff469b99dea98a94e9b8d0600cf51b0280f590", "committedDate": "2020-08-24T10:12:34Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNDA3MTY4", "url": "https://github.com/apache/lucene-solr/pull/1777#pullrequestreview-473407168", "createdAt": "2020-08-24T12:15:49Z", "commit": {"oid": "8aff469b99dea98a94e9b8d0600cf51b0280f590"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNTo1MFrOHFhpVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNTo1MFrOHFhpVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1NjE4MA==", "bodyText": "Our wild randomized testing infra was throwing an exception, rarely, in syncMetaData?", "url": "https://github.com/apache/lucene-solr/pull/1777#discussion_r475556180", "createdAt": "2020-08-24T12:15:50Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/SegmentInfos.java", "diffHunk": "@@ -836,16 +835,24 @@ final String finishCommit(Directory dir) throws IOException {\n     if (pendingCommit == false) {\n       throw new IllegalStateException(\"prepareCommit was not called\");\n     }\n-    boolean success = false;\n+    boolean successRenameAndSync = false;\n     final String dest;\n     try {\n       final String src = IndexFileNames.fileNameFromGeneration(IndexFileNames.PENDING_SEGMENTS, \"\", generation);\n       dest = IndexFileNames.fileNameFromGeneration(IndexFileNames.SEGMENTS, \"\", generation);\n       dir.rename(src, dest);\n-      dir.syncMetaData();\n-      success = true;\n+      try {\n+        dir.syncMetaData();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8aff469b99dea98a94e9b8d0600cf51b0280f590"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNDA3MjQ4", "url": "https://github.com/apache/lucene-solr/pull/1777#pullrequestreview-473407248", "createdAt": "2020-08-24T12:15:58Z", "commit": {"oid": "8aff469b99dea98a94e9b8d0600cf51b0280f590"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2403, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}