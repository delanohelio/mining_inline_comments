{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NDE0NjI0", "number": 1866, "title": "LUCENE-9523: Speed up query shapes for geometries that generate multiple points", "bodyText": "see https://issues.apache.org/jira/browse/LUCENE-9523.\nThis PR adds a check to determine if the relationship between a doc and the query shape is already known, so that it can skip an expensive relate method.\nIn addition it adds a dense intersect visitor that it is used when the number of points > 4* number of docs so we can use the same strategy for intersects queries.\nPerformance test shows a great increase in QPS in most cases:\n|point|intersects|0.00|0.00|-2%|321.21|326.21|-2%|2644|2644| 0%|\n|box|intersects|6.45|5.74|12%|43.87|39.04|12%|33081264|33081264| 0%|\n|distance|intersects|6.42|5.22|23%|22.53|18.35|23%|64062400|64062400| 0%|\n|poly 10|intersects|5.44|4.44|23%|20.71|16.90|23%|59064569|59064569| 0%|\n|polyMedium|intersects|0.44|0.34|29%|27.29|21.24|29%|528812|528812| 0%|\n|polyRussia|intersects|1.86|1.09|70%|7.59|4.46|70%|244848|244848| 0%|\n|point|contains|0.00|0.00| 1%|297.94|295.05| 1%|2644|2644| 0%|\n|box|contains|0.00|0.00|10%|39.92|36.37|10%|484|484| 0%|\n|distance|contains|0.00|0.00|18%|22.93|19.51|18%|406|406| 0%|\n|poly 10|contains|0.00|0.00|17%|19.63|16.79|17%|402|402| 0%|\n|polyMedium|contains|0.00|0.00|19%|19.42|16.38|19%|147|147| 0%|\n|point|within|0.00|0.00| 0%|362.16|362.01| 0%|0|0| 0%|\n|box|within|0.58|0.54| 6%|3.94|3.72| 6%|32911251|32911251| 0%|\n|distance|within|1.00|1.02|-2%|3.52|3.61|-2%|63868270|63868270| 0%|\n|poly 10|within|0.95|0.92| 3%|3.62|3.51| 3%|58873224|58873224| 0%|\n|polyMedium|within|0.05|0.05| 4%|3.37|3.25| 4%|522739|522739| 0%|\n|polyRussia|within|0.75|0.69| 9%|3.07|2.82| 9%|244661|244661| 0%|\n|point|disjoint|264.37|263.24| 0%|20.08|19.99| 0%|2962178156|2962178156| 0%|\n|box|disjoint|185.65|181.04| 3%|14.26|13.91| 3%|2929099536|2929099536| 0%|\n|distance|disjoint|143.19|130.91| 9%|11.12|10.16| 9%|2898118400|2898118400| 0%|\n|poly 10|disjoint|138.35|123.17|12%|10.72|9.55|12%|2903116231|2903116231| 0%|\n|polyMedium|disjoint|159.57|141.88|12%|12.14|10.79|12%|433924372|433924372| 0%|\n|polyRussia|disjoint|80.56|52.82|53%|6.23|4.09|53%|12920400|12920400| 0%|", "createdAt": "2020-09-14T07:42:38Z", "url": "https://github.com/apache/lucene-solr/pull/1866", "merged": true, "mergeCommit": {"oid": "fbf8e4f04481a14617618d05a54ba925842c7058"}, "closed": true, "closedAt": "2020-09-18T05:50:58Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIuDtjgH2gAyNDg2NDE0NjI0OjRmZDc5MTU1MzJjMzhlZWQzMTUyMzI5ZTQ0ZmMzNDA2MzlkZjQ3MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ-id_gH2gAyNDg2NDE0NjI0Ojk5MTU2YjU0ZTA0NDlmYzdiZDI5MDEzYzAwMTBkMmZhY2VkZmQ2NDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4fd7915532c38eed3152329e44fc340639df4700", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/4fd7915532c38eed3152329e44fc340639df4700", "committedDate": "2020-09-14T07:28:19Z", "message": "Speed up queryShape by checking if the relationship is already known"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b80145209142e9d0cf50d97516397f1e65b472d", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/5b80145209142e9d0cf50d97516397f1e65b472d", "committedDate": "2020-09-14T07:28:33Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60c95d987bf354b01952cab63758f4dd81cc581b", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/60c95d987bf354b01952cab63758f4dd81cc581b", "committedDate": "2020-09-14T12:33:51Z", "message": "use bitwise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59911274be343a622159693daf2c3da7eff5848e", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/59911274be343a622159693daf2c3da7eff5848e", "committedDate": "2020-09-14T12:50:51Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "099328084c3496739befd902ce944fea43c305b4", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/099328084c3496739befd902ce944fea43c305b4", "committedDate": "2020-09-16T08:53:20Z", "message": "fix javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDU3NDAw", "url": "https://github.com/apache/lucene-solr/pull/1866#pullrequestreview-489457400", "createdAt": "2020-09-16T09:47:15Z", "commit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTo0NzoxNVrOHSpDHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTo1NTozMFrOHSpW3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwODk1Nw==", "bodyText": "I think we should be careful with overflows, maybe divide instead of multiplying, ie.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  if (values.getDocCount() << 2 < values.size()) {\n          \n          \n            \n                  if (values.getDocCount() < (values.size() >>> 2)) {", "url": "https://github.com/apache/lucene-solr/pull/1866#discussion_r489308957", "createdAt": "2020-09-16T09:47:15Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/document/ShapeQuery.java", "diffHunk": "@@ -265,10 +265,20 @@ private Scorer getSparseScorer(final LeafReader reader, final Weight weight, fin\n         final DocIdSetIterator iterator = new BitSetIterator(result, cost[0]);\n         return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n       }\n-      final DocIdSetBuilder docIdSetBuilder = new DocIdSetBuilder(reader.maxDoc(), values, query.getField());\n-      values.intersect(getSparseVisitor(query, docIdSetBuilder));\n-      final DocIdSetIterator iterator = docIdSetBuilder.build().iterator();\n-      return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n+      if (values.getDocCount() << 2 < values.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMTU1Ng==", "bodyText": "We just need one long?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final long[] cost = new long[]{reader.maxDoc()};\n          \n          \n            \n                    final long[] cost = new long[]{1};", "url": "https://github.com/apache/lucene-solr/pull/1866#discussion_r489311556", "createdAt": "2020-09-16T09:51:19Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/document/ShapeQuery.java", "diffHunk": "@@ -265,10 +265,20 @@ private Scorer getSparseScorer(final LeafReader reader, final Weight weight, fin\n         final DocIdSetIterator iterator = new BitSetIterator(result, cost[0]);\n         return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n       }\n-      final DocIdSetBuilder docIdSetBuilder = new DocIdSetBuilder(reader.maxDoc(), values, query.getField());\n-      values.intersect(getSparseVisitor(query, docIdSetBuilder));\n-      final DocIdSetIterator iterator = docIdSetBuilder.build().iterator();\n-      return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n+      if (values.getDocCount() << 2 < values.size()) {\n+        // we use a dense structure so we can skip already visited documents\n+        final FixedBitSet result = new FixedBitSet(reader.maxDoc());\n+        final long[] cost = new long[]{reader.maxDoc()};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMjc5OA==", "bodyText": "I wonder if we should use SparseFixedBitSet to avoid allocating so much memory at once.", "url": "https://github.com/apache/lucene-solr/pull/1866#discussion_r489312798", "createdAt": "2020-09-16T09:53:33Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/document/ShapeQuery.java", "diffHunk": "@@ -265,10 +265,20 @@ private Scorer getSparseScorer(final LeafReader reader, final Weight weight, fin\n         final DocIdSetIterator iterator = new BitSetIterator(result, cost[0]);\n         return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n       }\n-      final DocIdSetBuilder docIdSetBuilder = new DocIdSetBuilder(reader.maxDoc(), values, query.getField());\n-      values.intersect(getSparseVisitor(query, docIdSetBuilder));\n-      final DocIdSetIterator iterator = docIdSetBuilder.build().iterator();\n-      return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n+      if (values.getDocCount() << 2 < values.size()) {\n+        // we use a dense structure so we can skip already visited documents\n+        final FixedBitSet result = new FixedBitSet(reader.maxDoc());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxNDAxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               * when the number of points <= 4 * number of docs ) */\n          \n          \n            \n               * when the number of docs <= 4 * number of points ) */", "url": "https://github.com/apache/lucene-solr/pull/1866#discussion_r489314015", "createdAt": "2020-09-16T09:55:30Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/document/ShapeQuery.java", "diffHunk": "@@ -340,7 +351,8 @@ public Relation compare(byte[] minTriangle, byte[] maxTriangle) {\n     };\n   }\n \n-  /** create a visitor that adds documents that match the query using a sparse bitset. (Used by INTERSECT) */\n+  /** create a visitor that adds documents that match the query using a sparse bitset. (Used by INTERSECT\n+   * when the number of points <= 4 * number of docs ) */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "254071d6ded11319f1926d78665737985c80d686", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/254071d6ded11319f1926d78665737985c80d686", "committedDate": "2020-09-16T11:58:06Z", "message": "address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjQ1OTE3", "url": "https://github.com/apache/lucene-solr/pull/1866#pullrequestreview-489645917", "createdAt": "2020-09-16T13:49:56Z", "commit": {"oid": "254071d6ded11319f1926d78665737985c80d686"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzo0OTo1NlrOHSx1hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzo0OTo1NlrOHSx1hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQ1MjkzNA==", "bodyText": "ok, let's keep a FixedBitSet for now then", "url": "https://github.com/apache/lucene-solr/pull/1866#discussion_r489452934", "createdAt": "2020-09-16T13:49:56Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/document/ShapeQuery.java", "diffHunk": "@@ -265,10 +265,20 @@ private Scorer getSparseScorer(final LeafReader reader, final Weight weight, fin\n         final DocIdSetIterator iterator = new BitSetIterator(result, cost[0]);\n         return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n       }\n-      final DocIdSetBuilder docIdSetBuilder = new DocIdSetBuilder(reader.maxDoc(), values, query.getField());\n-      values.intersect(getSparseVisitor(query, docIdSetBuilder));\n-      final DocIdSetIterator iterator = docIdSetBuilder.build().iterator();\n-      return new ConstantScoreScorer(weight, boost, scoreMode, iterator);\n+      if (values.getDocCount() << 2 < values.size()) {\n+        // we use a dense structure so we can skip already visited documents\n+        final FixedBitSet result = new FixedBitSet(reader.maxDoc());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMxMjc5OA=="}, "originalCommit": {"oid": "099328084c3496739befd902ce944fea43c305b4"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55745fab06ea415516e69d71e1588134cccbc1ad", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/55745fab06ea415516e69d71e1588134cccbc1ad", "committedDate": "2020-09-18T05:03:28Z", "message": "Merge branch 'master' into speedupQueryShape"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99156b54e0449fc7bd29013c0010d2facedfd641", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/apache/lucene-solr/commit/99156b54e0449fc7bd29013c0010d2facedfd641", "committedDate": "2020-09-18T05:14:19Z", "message": "add entry in CHANGES.txt"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2272, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}