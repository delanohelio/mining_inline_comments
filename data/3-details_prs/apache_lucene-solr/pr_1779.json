{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyNjIzNzIy", "number": 1779, "title": "LUCENE-9478: Prevent DWPTDeleteQueue from referencing itself and leaking memory", "bodyText": "In LUCENE-9304 we introduced some fixes that unfortunately hold on to the previous\nDWPTDeleteQueue which is essentially leaking IW memory and cause applications to fail.\nThis fixes the memory leak and adds a test to ensure its not leaking memory.", "createdAt": "2020-08-24T16:14:05Z", "url": "https://github.com/apache/lucene-solr/pull/1779", "merged": true, "mergeCommit": {"oid": "098f0dc8b414ca9c9a47cf7ebf4383198fb946fe"}, "closed": true, "closedAt": "2020-08-24T19:29:27Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCE6BogH2gAyNDcyNjIzNzIyOjUxZjY0NDBhZmYwMGNjYzZhMDA5Yjk4MmFmODk4MWI0YWJkMzhjMjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCHwDDAFqTQ3Mzc5Mjg3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/51f6440aff00ccc6a009b982af8981b4abd38c25", "committedDate": "2020-08-24T16:08:05Z", "message": "LUCENE-9478: Prevent DWPTDeleteQueue from referencing itself and leaking memory\n\nIn LUCENE-9304 we introduced some fixes that unfortunately hold on to the previous\nDWPTDeleteQueue which is essentially leaking IW memory and cause applications to fail.\nThis fixes the memory leak and adds a test to ensure it's not leaking memory."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjYwMDU3", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473660057", "createdAt": "2020-08-24T16:25:43Z", "commit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyNTo0M1rOHFsuJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjoyNTo0M1rOHFsuJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTczNzYzOA==", "bodyText": "this is terrible but I don't know of a better way of doing this. this at least works on my machine :) and would have found the issue", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475737638", "createdAt": "2020-08-24T16:25:43Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestDocumentsWriterDeleteQueue.java", "diffHunk": "@@ -36,6 +37,26 @@\n  */\n public class TestDocumentsWriterDeleteQueue extends LuceneTestCase {\n \n+\n+  public void testAdvanceReferencesOriginal() {\n+    WeakAndNext weakAndNext = new WeakAndNext();\n+    DocumentsWriterDeleteQueue next = weakAndNext.next;\n+    assertNotNull(next);\n+    System.gc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjY4Njc3", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473668677", "createdAt": "2020-08-24T16:35:00Z", "commit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjozNTowMFrOHFtJkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjozNTowMFrOHFtJkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc0NDY1Nw==", "bodyText": "Maybe add a comment to this method referencing the issue, Simon?", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475744657", "createdAt": "2020-08-24T16:35:00Z", "author": {"login": "dweiss"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java", "diffHunk": "@@ -573,6 +573,10 @@ long getMaxCompletedSeqNo() {\n     }\n   }\n \n+  private static LongSupplier getPrevMaxSeqIdSupplier(AtomicLong nextSeqNo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNjc5OTcz", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473679973", "createdAt": "2020-08-24T16:50:31Z", "commit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjo1MDozMlrOHFtyDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxNjo1MDozMlrOHFtyDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NTAyMw==", "bodyText": "I checked openjdk sources and they use System.gc() with a similar expectation that it will always try to flush all weak refs before returning, so this seems fine. The test itself could maybe be made more explicit by utilizing an explicit ReferenceQueue rather than asserting the reference has been cleared but this is a matter of taste - if this works, it will in both cases.", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475755023", "createdAt": "2020-08-24T16:50:32Z", "author": {"login": "dweiss"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestDocumentsWriterDeleteQueue.java", "diffHunk": "@@ -36,6 +37,26 @@\n  */\n public class TestDocumentsWriterDeleteQueue extends LuceneTestCase {\n \n+\n+  public void testAdvanceReferencesOriginal() {\n+    WeakAndNext weakAndNext = new WeakAndNext();\n+    DocumentsWriterDeleteQueue next = weakAndNext.next;\n+    assertNotNull(next);\n+    System.gc();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adb173107f78b878fdf419ce1ad72dd4656c5a10", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/adb173107f78b878fdf419ce1ad72dd4656c5a10", "committedDate": "2020-08-24T18:24:26Z", "message": "Merge branch 'master' into fix_fuckedup_lambda"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2de2209007d6c93e03f5bba6011408662e63e42", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/d2de2209007d6c93e03f5bba6011408662e63e42", "committedDate": "2020-08-24T18:26:05Z", "message": "add comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzU5MjYx", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473759261", "createdAt": "2020-08-24T18:35:46Z", "commit": {"oid": "d2de2209007d6c93e03f5bba6011408662e63e42"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzY0NDk3", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473764497", "createdAt": "2020-08-24T18:43:33Z", "commit": {"oid": "d2de2209007d6c93e03f5bba6011408662e63e42"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxODo0MzozM1rOHFxzWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxODo0MzozM1rOHFxzWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgyMDg5MQ==", "bodyText": "I would also use a ReferenceQueue to do the check. The weak.get() has a bad taste to me.\nI did not check that System.gc() tries to cleanup weak refs, but if it does and we can rely on this, I am fine.", "url": "https://github.com/apache/lucene-solr/pull/1779#discussion_r475820891", "createdAt": "2020-08-24T18:43:33Z", "author": {"login": "uschindler"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestDocumentsWriterDeleteQueue.java", "diffHunk": "@@ -36,6 +37,26 @@\n  */\n public class TestDocumentsWriterDeleteQueue extends LuceneTestCase {\n \n+\n+  public void testAdvanceReferencesOriginal() {\n+    WeakAndNext weakAndNext = new WeakAndNext();\n+    DocumentsWriterDeleteQueue next = weakAndNext.next;\n+    assertNotNull(next);\n+    System.gc();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1NTAyMw=="}, "originalCommit": {"oid": "51f6440aff00ccc6a009b982af8981b4abd38c25"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e75fd13086db9519263791a31da8d014683d6efe", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/e75fd13086db9519263791a31da8d014683d6efe", "committedDate": "2020-08-24T19:25:06Z", "message": "add changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNzkyODcz", "url": "https://github.com/apache/lucene-solr/pull/1779#pullrequestreview-473792873", "createdAt": "2020-08-24T19:26:54Z", "commit": {"oid": "e75fd13086db9519263791a31da8d014683d6efe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2405, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}