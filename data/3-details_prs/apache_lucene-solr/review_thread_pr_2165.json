{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTQ5MDI4", "number": 2165, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozMjoxOVrOFIpjrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjowNTo0NFrOFLdZXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjEzODA1OnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozMjoxOVrOIKrv4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozMjoxOVrOIKrv4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3MzQ0MQ==", "bodyText": "Please add a human readable comment describing the intent", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548073441", "createdAt": "2020-12-23T17:32:19Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjE1NDg0OnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNjowMVrOIKr6oA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOToxODo1NFrOIKw6hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NjE5Mg==", "bodyText": "Noble just spent a bunch of effort getting rid of XPath in other places, is this a good direction to be going now?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548076192", "createdAt": "2020-12-23T17:36:01Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -105,17 +108,23 @@ public static MetricsConfiguration from(String resource) throws Exception {\n   public static MetricsConfiguration from(Document config) throws Exception {\n     Node settings = getNode(config, \"/config/settings\");\n \n+    Map<String,MetricsQueryTemplate> jqTemplatesMap = null;\n+    NodeList jqTemplates = (NodeList)(xpathFactory.newXPath()).evaluate(\"/config/jq-templates/template\", config, XPathConstants.NODESET);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyNjkwOQ==", "bodyText": "The code is already using XPath, I'm not introducing it here?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548126909", "createdAt": "2020-12-23T18:39:23Z", "author": {"login": "thelabdude"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -105,17 +108,23 @@ public static MetricsConfiguration from(String resource) throws Exception {\n   public static MetricsConfiguration from(Document config) throws Exception {\n     Node settings = getNode(config, \"/config/settings\");\n \n+    Map<String,MetricsQueryTemplate> jqTemplatesMap = null;\n+    NodeList jqTemplates = (NodeList)(xpathFactory.newXPath()).evaluate(\"/config/jq-templates/template\", config, XPathConstants.NODESET);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NjE5Mg=="}, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE1ODA4Ng==", "bodyText": "Also, this happens once during initialization of the Prom exporter, so efficiency of XPath isn't so much of a concern. A few extra millis (if that much) during init doesn't seem like a problem to me, esp. if it makes the code cleaner.", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548158086", "createdAt": "2020-12-23T19:18:54Z", "author": {"login": "thelabdude"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -105,17 +108,23 @@ public static MetricsConfiguration from(String resource) throws Exception {\n   public static MetricsConfiguration from(Document config) throws Exception {\n     Node settings = getNode(config, \"/config/settings\");\n \n+    Map<String,MetricsQueryTemplate> jqTemplatesMap = null;\n+    NodeList jqTemplates = (NodeList)(xpathFactory.newXPath()).evaluate(\"/config/jq-templates/template\", config, XPathConstants.NODESET);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NjE5Mg=="}, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjE1NTk4OnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNjoxNFrOIKr7VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNjoxNFrOIKr7VA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NjM3Mg==", "bodyText": "Did we need a null check first?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548076372", "createdAt": "2020-12-23T17:36:14Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -105,17 +108,23 @@ public static MetricsConfiguration from(String resource) throws Exception {\n   public static MetricsConfiguration from(Document config) throws Exception {\n     Node settings = getNode(config, \"/config/settings\");\n \n+    Map<String,MetricsQueryTemplate> jqTemplatesMap = null;\n+    NodeList jqTemplates = (NodeList)(xpathFactory.newXPath()).evaluate(\"/config/jq-templates/template\", config, XPathConstants.NODESET);\n+    if (jqTemplates.getLength() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjE2MDgwOnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQuery.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNzowM1rOIKr-TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNzowM1rOIKr-TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NzEzMg==", "bodyText": "jqTemplates could be null", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548077132", "createdAt": "2020-12-23T17:37:03Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQuery.java", "diffHunk": "@@ -116,6 +117,23 @@ public String getPath() {\n       List<JsonQuery> compiledQueries = new ArrayList<>();\n       if (jsonQueries != null) {\n         for (String jsonQuery : jsonQueries) {\n+\n+          // does this query refer to a reusable jq template to reduce boilerplate in the config?\n+          String stripWs = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+          if (stripWs.startsWith(\"$jq:\")) {\n+            Optional<Matcher> maybeMatcher = MetricsQueryTemplate.matches(stripWs);\n+            if (maybeMatcher.isPresent()) {\n+              Matcher matcher = maybeMatcher.get();\n+              String templateName = matcher.group(\"TEMPLATE\");\n+              MetricsQueryTemplate template = jqTemplates.get(templateName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjE2MjQwOnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNzoyNFrOIKr_VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozNzoyNFrOIKr_VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3NzM5Nw==", "bodyText": "Is this going to be slooooooow?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548077397", "createdAt": "2020-12-23T17:37:24Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -141,12 +150,29 @@ private static Node getNode(Document doc, String path) {\n     }\n   }\n \n-  private static List<MetricsQuery> toMetricQueries(Node node) throws JsonQueryException {\n+  private static List<MetricsQuery> toMetricQueries(Node node, Map<String,MetricsQueryTemplate> jqTemplatesMap) throws JsonQueryException {\n     if (node == null) {\n       return Collections.emptyList();\n     }\n \n-    return MetricsQuery.from(node);\n+    return MetricsQuery.from(node, jqTemplatesMap);\n   }\n \n+  private static Map<String,MetricsQueryTemplate> loadJqTemplates(NodeList jqTemplates) {\n+    Map<String,MetricsQueryTemplate> map = new HashMap<>();\n+    for (int t=0; t < jqTemplates.getLength(); t++) {\n+      Node template = jqTemplates.item(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjE2NzYxOnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozODoyN1rOIKsCyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxNzozODoyN1rOIKsCyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODA3ODI4MQ==", "bodyText": "Check for name.trim.isEmpty also? Isn't there a StringUtils method that does this for us safely?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548078281", "createdAt": "2020-12-23T17:38:27Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsConfiguration.java", "diffHunk": "@@ -141,12 +150,29 @@ private static Node getNode(Document doc, String path) {\n     }\n   }\n \n-  private static List<MetricsQuery> toMetricQueries(Node node) throws JsonQueryException {\n+  private static List<MetricsQuery> toMetricQueries(Node node, Map<String,MetricsQueryTemplate> jqTemplatesMap) throws JsonQueryException {\n     if (node == null) {\n       return Collections.emptyList();\n     }\n \n-    return MetricsQuery.from(node);\n+    return MetricsQuery.from(node, jqTemplatesMap);\n   }\n \n+  private static Map<String,MetricsQueryTemplate> loadJqTemplates(NodeList jqTemplates) {\n+    Map<String,MetricsQueryTemplate> map = new HashMap<>();\n+    for (int t=0; t < jqTemplates.getLength(); t++) {\n+      Node template = jqTemplates.item(t);\n+      if (template.getNodeType() == Node.ELEMENT_NODE && template.hasAttributes()) {\n+        Node nameAttr = template.getAttributes().getNamedItem(\"name\");\n+        String tmpl = template.getTextContent();\n+        if (nameAttr != null && tmpl != null && !tmpl.trim().isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b32cb0e513fb5eca82d08955abd038188d172d43"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjQ0MzI0OnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODozNTowNVrOIKuzXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo0MTowM1rOIKvFng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyMzQ4NQ==", "bodyText": "Are we trying to be too helpful here? Or is this matching some existing spec?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548123485", "createdAt": "2020-12-23T18:35:05Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");\n+\n+  public static Optional<Matcher> matches(String jsonQuery) {\n+    Optional<Matcher> maybe = Optional.empty();\n+    if (jsonQuery != null) {\n+      String toMatch = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+      Matcher m = matchJqTemplate.matcher(toMatch);\n+      if (m.matches()) {\n+        maybe = Optional.of(m);\n+      }\n+    }\n+    return maybe;\n+  }\n+\n+  private final String name;\n+  private final String defaultType;\n+  private final String template;\n+\n+  public MetricsQueryTemplate(String name, String template, String defaultType) {\n+    Objects.requireNonNull(name, \"jq template must have a name\");\n+    Objects.requireNonNull(template, \"jq template is required\");\n+\n+    this.name = name;\n+    this.template = template.replaceAll(\"\\\\s+\", \" \").trim();\n+    if (this.template.isEmpty()) {\n+      throw new IllegalArgumentException(\"jq template must not be empty\");\n+    }\n+    this.defaultType = defaultType != null ? defaultType : \"GAUGE\";\n+  }\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public String getDefaultType() {\n+    return defaultType;\n+  }\n+\n+  public String getTemplate() {\n+    return template;\n+  }\n+\n+  public String applyTemplate(final Matcher matched) {\n+    String keySelector = matched.group(\"KEYSELECTOR\");\n+    if (keySelector != null) {\n+      if (!keySelector.contains(\"select(\") && !keySelector.contains(\".key\")) {\n+        if (keySelector.contains(\"(\") && keySelector.contains(\")\")) {\n+          // some kind of function here ...\n+          keySelector = \".key | \" + keySelector.trim();\n+        } else {\n+          keySelector = \".key == \" + keySelector.trim();\n+        }\n+      }\n+    }\n+    String unique = matched.group(\"UNIQUE\").trim();\n+    String type = matched.group(\"TYPE\");\n+    if (type == null) {\n+      type = defaultType;\n+    }\n+\n+    String metric = matched.group(\"METRIC\");\n+    if (metric == null) {\n+      metric = unique;\n+    }\n+\n+    // could be a simple field name or some kind of function here\n+    if (!metric.contains(\"$\")) {\n+      if (\"object.value\".equals(metric)) {\n+        metric = \"$object.value\"; // don't require the user to supply the $", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4aab8ef1d050b14e44e46053fb942dad682a78"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODE1OA==", "bodyText": "just trying to be helpful to keep the template syntax simpler ... e.g. I like {{count}} vs. {{$object.value.count}}", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548128158", "createdAt": "2020-12-23T18:41:03Z", "author": {"login": "thelabdude"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");\n+\n+  public static Optional<Matcher> matches(String jsonQuery) {\n+    Optional<Matcher> maybe = Optional.empty();\n+    if (jsonQuery != null) {\n+      String toMatch = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+      Matcher m = matchJqTemplate.matcher(toMatch);\n+      if (m.matches()) {\n+        maybe = Optional.of(m);\n+      }\n+    }\n+    return maybe;\n+  }\n+\n+  private final String name;\n+  private final String defaultType;\n+  private final String template;\n+\n+  public MetricsQueryTemplate(String name, String template, String defaultType) {\n+    Objects.requireNonNull(name, \"jq template must have a name\");\n+    Objects.requireNonNull(template, \"jq template is required\");\n+\n+    this.name = name;\n+    this.template = template.replaceAll(\"\\\\s+\", \" \").trim();\n+    if (this.template.isEmpty()) {\n+      throw new IllegalArgumentException(\"jq template must not be empty\");\n+    }\n+    this.defaultType = defaultType != null ? defaultType : \"GAUGE\";\n+  }\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public String getDefaultType() {\n+    return defaultType;\n+  }\n+\n+  public String getTemplate() {\n+    return template;\n+  }\n+\n+  public String applyTemplate(final Matcher matched) {\n+    String keySelector = matched.group(\"KEYSELECTOR\");\n+    if (keySelector != null) {\n+      if (!keySelector.contains(\"select(\") && !keySelector.contains(\".key\")) {\n+        if (keySelector.contains(\"(\") && keySelector.contains(\")\")) {\n+          // some kind of function here ...\n+          keySelector = \".key | \" + keySelector.trim();\n+        } else {\n+          keySelector = \".key == \" + keySelector.trim();\n+        }\n+      }\n+    }\n+    String unique = matched.group(\"UNIQUE\").trim();\n+    String type = matched.group(\"TYPE\");\n+    if (type == null) {\n+      type = defaultType;\n+    }\n+\n+    String metric = matched.group(\"METRIC\");\n+    if (metric == null) {\n+      metric = unique;\n+    }\n+\n+    // could be a simple field name or some kind of function here\n+    if (!metric.contains(\"$\")) {\n+      if (\"object.value\".equals(metric)) {\n+        metric = \"$object.value\"; // don't require the user to supply the $", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyMzQ4NQ=="}, "originalCommit": {"oid": "0b4aab8ef1d050b14e44e46053fb942dad682a78"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjQ1MDkxOnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODozNjo0MFrOIKu4hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODozNjo0MFrOIKu4hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyNDgwNw==", "bodyText": "unused?", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548124807", "createdAt": "2020-12-23T18:36:40Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");\n+\n+  public static Optional<Matcher> matches(String jsonQuery) {\n+    Optional<Matcher> maybe = Optional.empty();\n+    if (jsonQuery != null) {\n+      String toMatch = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+      Matcher m = matchJqTemplate.matcher(toMatch);\n+      if (m.matches()) {\n+        maybe = Optional.of(m);\n+      }\n+    }\n+    return maybe;\n+  }\n+\n+  private final String name;\n+  private final String defaultType;\n+  private final String template;\n+\n+  public MetricsQueryTemplate(String name, String template, String defaultType) {\n+    Objects.requireNonNull(name, \"jq template must have a name\");\n+    Objects.requireNonNull(template, \"jq template is required\");\n+\n+    this.name = name;\n+    this.template = template.replaceAll(\"\\\\s+\", \" \").trim();\n+    if (this.template.isEmpty()) {\n+      throw new IllegalArgumentException(\"jq template must not be empty\");\n+    }\n+    this.defaultType = defaultType != null ? defaultType : \"GAUGE\";\n+  }\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public String getDefaultType() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4aab8ef1d050b14e44e46053fb942dad682a78"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjQ1MjMzOnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODozNjo1M1rOIKu5Rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODozNjo1M1rOIKu5Rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyNDk5OA==", "bodyText": "unused", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r548124998", "createdAt": "2020-12-23T18:36:53Z", "author": {"login": "madrob"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,128 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");\n+\n+  public static Optional<Matcher> matches(String jsonQuery) {\n+    Optional<Matcher> maybe = Optional.empty();\n+    if (jsonQuery != null) {\n+      String toMatch = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+      Matcher m = matchJqTemplate.matcher(toMatch);\n+      if (m.matches()) {\n+        maybe = Optional.of(m);\n+      }\n+    }\n+    return maybe;\n+  }\n+\n+  private final String name;\n+  private final String defaultType;\n+  private final String template;\n+\n+  public MetricsQueryTemplate(String name, String template, String defaultType) {\n+    Objects.requireNonNull(name, \"jq template must have a name\");\n+    Objects.requireNonNull(template, \"jq template is required\");\n+\n+    this.name = name;\n+    this.template = template.replaceAll(\"\\\\s+\", \" \").trim();\n+    if (this.template.isEmpty()) {\n+      throw new IllegalArgumentException(\"jq template must not be empty\");\n+    }\n+    this.defaultType = defaultType != null ? defaultType : \"GAUGE\";\n+  }\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public String getDefaultType() {\n+    return defaultType;\n+  }\n+\n+  public String getTemplate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b4aab8ef1d050b14e44e46053fb942dad682a78"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ3NTYwMjg2OnYy", "diffSide": "RIGHT", "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjowNTo0NFrOIOpQ2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQyMjowNTo0NFrOIOpQ2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjIyNzAzNQ==", "bodyText": "NULL_DEREFERENCE:  object returned by matched.group(\"UNIQUE\") could be null and is dereferenced at line 88.", "url": "https://github.com/apache/lucene-solr/pull/2165#discussion_r552227035", "createdAt": "2021-01-05T22:05:44Z", "author": {"login": "sonatype-lift"}, "path": "solr/contrib/prometheus-exporter/src/java/org/apache/solr/prometheus/exporter/MetricsQueryTemplate.java", "diffHunk": "@@ -0,0 +1,135 @@\n+/*\n+ * Licensed to the Apache Software Foundation (ASF) under one or more\n+ * contributor license agreements.  See the NOTICE file distributed with\n+ * this work for additional information regarding copyright ownership.\n+ * The ASF licenses this file to You under the Apache License, Version 2.0\n+ * (the \"License\"); you may not use this file except in compliance with\n+ * the License.  You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.solr.prometheus.exporter;\n+\n+import java.util.Objects;\n+import java.util.Optional;\n+import java.util.regex.Matcher;\n+import java.util.regex.Pattern;\n+\n+public class MetricsQueryTemplate {\n+  /*\n+  A regex with named groups is used to match template references to template + vars using the basic pattern:\n+\n+      $jq:<TEMPLATE>( <UNIQUE>, <KEYSELECTOR>, <METRIC>, <TYPE> )\n+\n+  For instance,\n+\n+      $jq:core(requests_total, endswith(\".requestTimes\"), count, COUNTER)\n+\n+  TEMPLATE = core\n+  UNIQUE = requests_total (unique suffix for this metric, results in a metric named \"solr_metrics_core_requests_total\")\n+  KEYSELECTOR = endswith(\".requestTimes\") (filter to select the specific key for this metric)\n+  METRIC = count\n+  TYPE = COUNTER\n+  */\n+  private static final Pattern matchJqTemplate =\n+      Pattern.compile(\"^\\\\$jq:(?<TEMPLATE>.*?)\\\\(\\\\s?(?<UNIQUE>[^,]*),\\\\s?(?<KEYSELECTOR>[^,]*)(,\\\\s?(?<METRIC>[^,]*)\\\\s?)?(,\\\\s?(?<TYPE>[^,]*)\\\\s?)?\\\\)$\");\n+\n+  public static Optional<Matcher> matches(String jsonQuery) {\n+    Optional<Matcher> maybe = Optional.empty();\n+    if (jsonQuery != null) {\n+      String toMatch = jsonQuery.replaceAll(\"\\\\s+\", \" \").trim();\n+      Matcher m = matchJqTemplate.matcher(toMatch);\n+      if (m.matches()) {\n+        maybe = Optional.of(m);\n+      }\n+    }\n+    return maybe;\n+  }\n+\n+  private final String name;\n+  private final String defaultType;\n+  private final String template;\n+\n+  public MetricsQueryTemplate(String name, String template, String defaultType) {\n+    Objects.requireNonNull(name, \"jq template must have a name\");\n+    Objects.requireNonNull(template, \"jq template is required\");\n+\n+    this.name = name;\n+    this.template = template.replaceAll(\"\\\\s+\", \" \").trim();\n+    if (this.template.isEmpty()) {\n+      throw new IllegalArgumentException(\"jq template must not be empty\");\n+    }\n+    this.defaultType = defaultType != null ? defaultType : \"GAUGE\";\n+  }\n+\n+  public String getName() {\n+    return name;\n+  }\n+\n+  public String applyTemplate(final Matcher matched) {\n+    String keySelector = matched.group(\"KEYSELECTOR\");\n+    if (keySelector != null) {\n+      if (!keySelector.contains(\"select(\") && !keySelector.contains(\".key\")) {\n+        if (keySelector.contains(\"(\") && keySelector.contains(\")\")) {\n+          // some kind of function here ...\n+          keySelector = \".key | \" + keySelector.trim();\n+        } else {\n+          keySelector = \".key == \" + keySelector.trim();\n+        }\n+      }\n+    }\n+    String unique = matched.group(\"UNIQUE\").trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98e333719019663fb8a4208f352c3e12d5cab15e"}, "originalPosition": 88}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1008, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}