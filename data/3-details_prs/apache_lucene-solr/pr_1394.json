{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2OTIzNDM0", "number": 1394, "title": "LUCENE-9300: Fix field infos update on doc values update", "bodyText": "Today a doc values update creates a new field infos file that contains the original field infos updated for the new generation as well as the new fields created by the doc values update.\nHowever existing fields are cloned through the global fields (shared in the index writer) instead of the local ones (present in the segment).\nIn practice this is not an issue since field numbers are shared between segments created by the same index writer.\nBut this assumption doesn't hold for segments created by different writers and added through IndexWriter#addIndexes(Directory).\nIn this case, the field number of the same field can differ between segments so any doc values update can corrupt the index\nby assigning the wrong field number to an existing field in the next generation.\nWhen this happens, queries and merges can access wrong fields without throwing any error, leading to a silent corruption in the index.\nThis change ensures that we preserve local field numbers when creating\na new field infos generation.", "createdAt": "2020-04-01T11:05:01Z", "url": "https://github.com/apache/lucene-solr/pull/1394", "merged": true, "mergeCommit": {"oid": "b5c5ebe37cf0ac12caecbd1ab46d5f7ec0762f06"}, "closed": true, "closedAt": "2020-04-03T11:58:06Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTVogzAH2gAyMzk2OTIzNDM0OjA2MTk2NThiMzYzY2Y5MTFkMmYyOTE2ZWIxZjNlZmE1NTE0YjM0Yzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcT-8eqgH2gAyMzk2OTIzNDM0OmY3MmNhYjVhMmIwNWYwNDJlYzkwMDkyMDc3NWU1MGZkNTkxODNkYTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0619658b363cf911d2f2916eb1f3efa5514b34c7", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/0619658b363cf911d2f2916eb1f3efa5514b34c7", "committedDate": "2020-04-01T11:02:54Z", "message": "LUCENE-9300: Fix field infos update on doc values update\n\nToday a doc values update creates a new field infos file that contains the original field infos updated for the new generation as well as the new fields created by the doc values update.\n\nHowever existing fields are cloned through the global fields (shared in the index writer) instead of the local ones (present in the segment).\nIn practice this is not an issue since field numbers are shared between segments created by the same index writer.\nBut this assumption doesn't hold for segments created by different writers and added through IndexWriter#addIndexes(Directory).\nIn this case, the field number of the same field can differ between segments so any doc values update can corrupt the index\nby assigning the wrong field number to an existing field in the next generation.\n\nWhen this happens, queries and merges can access wrong fields without throwing any error, leading to a silent corruption in the index.\n\nThis change ensures that we preserve local field numbers when creating\na new field infos generation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/a5084d15c0137d113b81a66eb27738a7b5dd2f32", "committedDate": "2020-04-01T11:16:32Z", "message": "fix precommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTE0NDI0", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-385514424", "createdAt": "2020-04-01T11:58:18Z", "commit": {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1ODoxOFrOF-9Rkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMTo1ODoxOFrOF-9Rkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU1OTk1NQ==", "bodyText": "after?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401559955", "createdAt": "2020-04-01T11:58:18Z", "author": {"login": "juanka588"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestNumericDocValuesUpdates.java", "diffHunk": "@@ -1483,6 +1484,81 @@ public void testAddIndexes() throws Exception {\n     IOUtils.close(dir1, dir2);\n   }\n \n+  public void testUpdatesAterAddIndexes() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NTg5OTY5", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-385589969", "createdAt": "2020-04-01T13:34:45Z", "commit": {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMzozNDo0NlrOF_A4OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMzozNDo0NlrOF_A4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYxOTAwMA==", "bodyText": "Had a quick discussion about this line with Jim. This isn't good enough as this might return a field number that already exists in the reader if the field exists in the writer with a number that it less than the number of fields in the reader.", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401619000", "createdAt": "2020-04-01T13:34:46Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,30 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = new FieldInfo(fi);\n+          newFields.put(clone.name, clone);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo fi = newFields.get(update.field);\n+          if (fi == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            fi = builder.getOrAdd(update.field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a5084d15c0137d113b81a66eb27738a7b5dd2f32"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd5e08170cc8b7963c0aff3d58afa5766afcb32", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/abd5e08170cc8b7963c0aff3d58afa5766afcb32", "committedDate": "2020-04-01T14:45:02Z", "message": "address comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "387a7c30eaee45771491b4ff9e8afeff3dac63a8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/387a7c30eaee45771491b4ff9e8afeff3dac63a8", "committedDate": "2020-04-01T14:54:20Z", "message": "unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NzE3MDky", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-385717092", "createdAt": "2020-04-01T15:48:01Z", "commit": {"oid": "387a7c30eaee45771491b4ff9e8afeff3dac63a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTo0ODowMVrOF_HAGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNTo0ODowMVrOF_HAGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTcxOTMyMA==", "bodyText": "Do we need to set the doc-value type before cloning to make sure the doc-value type is set on the writer? I also wonder if we should use FieldInfos.Builder since this logic you implemented looks similar to FieldInfos.Builder#add.", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r401719320", "createdAt": "2020-04-01T15:48:01Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,36 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo fi = newFields.get(update.field);\n+          if (fi == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            fi = builder.getOrAdd(update.field);\n+            if (fi.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              fi = cloneFieldInfo(fi, ++maxFieldNumber);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "387a7c30eaee45771491b4ff9e8afeff3dac63a8"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "090ef78171dfe671b0fb1ab238951fdd617bd65c", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/090ef78171dfe671b0fb1ab238951fdd617bd65c", "committedDate": "2020-04-01T16:21:35Z", "message": "set the dv types of the field info before cloning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8", "committedDate": "2020-04-01T19:31:15Z", "message": "also update dv type globally"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzE2MTc3", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-386316177", "createdAt": "2020-04-02T10:56:58Z", "commit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDo1Njo1OFrOF_l7Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMToxOToxNVrOF_mmhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyNTkzOA==", "bodyText": "Sorry I wasn't sure how that worked when doing previous reviews, but the field infos of the writer should be updated when the doc-value update is performed. So the FieldInfo should always exist at this point and the doc-value type should always be correct. So we should be able to assert here instead of calling setDocValuesType.", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402225938", "createdAt": "2020-04-02T10:56:58Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyODA2NQ==", "bodyText": "Sorry I suggested this on the previous review, but the doc-value type is actually supposed to be set on the updateDocValue call, so we should even be able to assert that the doc-value type is correct at this stage instead of setting it.", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402228065", "createdAt": "2020-04-02T11:01:02Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTc5Mw==", "bodyText": "I think we should either have an else branch that updates the maxFieldNumber to avoid conflicts (in case dv updates introduce multiple fields) or always clone the FieldInfo to update the number. I have a preference for the latter since it requires fewer branches and makes the code easier to reason about?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402231793", "createdAt": "2020-04-02T11:08:28Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMTk0Ng==", "bodyText": "this put call should be unnecessary since the field is already in the map?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402231946", "createdAt": "2020-04-02T11:08:47Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);\n+            }\n+            newFields.put(update.field, globalFieldInfo);\n+          } else {\n+            segmentFieldInfo.setDocValuesType(update.type);\n+            newFields.put(update.field, segmentFieldInfo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzMzkzNw==", "bodyText": "maybe add a comment on the above getOrAdd call to mention that it never needs to add the field?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402233937", "createdAt": "2020-04-02T11:12:58Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIyODA2NQ=="}, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNDExNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                      // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n          \n          \n            \n                      // if the segment was created externally (and added to this index with IndexWriter#addIndexes(Directory)).", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402234114", "createdAt": "2020-04-02T11:13:20Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIzNzA2Mg==", "bodyText": "It might be better to split into one unit test for the addIndexes case when the updated field already exists in the segment, and another one for the case when the updated field doesn't exist in the segment yet?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402237062", "createdAt": "2020-04-02T11:19:15Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestNumericDocValuesUpdates.java", "diffHunk": "@@ -1483,6 +1484,83 @@ public void testAddIndexes() throws Exception {\n     IOUtils.close(dir1, dir2);\n   }\n \n+  public void testUpdatesAfterAddIndexes() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa08579e41a041e41d07a9ae91120ccbf396c4bf", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/fa08579e41a041e41d07a9ae91120ccbf396c4bf", "committedDate": "2020-04-02T12:16:21Z", "message": "Revert \"also update dv type globally\"\n\nThis reverts commit 8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "347c5e960263c366588c486f2939a2f40c311afa", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/347c5e960263c366588c486f2939a2f40c311afa", "committedDate": "2020-04-02T12:16:45Z", "message": "Revert \"set the dv types of the field info before cloning\"\n\nThis reverts commit 090ef78171dfe671b0fb1ab238951fdd617bd65c."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NDU5MTI1", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-386459125", "createdAt": "2020-04-02T14:04:48Z", "commit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDowNDo0OFrOF_s1kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNDowODozN1rOF_tASg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjMzOTIxOQ==", "bodyText": "extra newline", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402339219", "createdAt": "2020-04-02T14:04:48Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -644,6 +656,13 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n     return true;\n   }\n \n+  private FieldInfo cloneFieldInfo(FieldInfo fi, int fieldNumber) {\n+    return new FieldInfo(fi.name, fieldNumber, fi.hasVectors(), fi.omitsNorms(), fi.hasPayloads(),\n+        fi.getIndexOptions(), fi.getDocValuesType(), fi.getDocValuesGen(), new HashMap<>(fi.attributes()),\n+        fi.getPointDimensionCount(), fi.getPointIndexDimensionCount(), fi.getPointNumBytes(), fi.isSoftDeletesField());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjM0MTk2Mg==", "bodyText": "we should set the DV type here too no?", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402341962", "createdAt": "2020-04-02T14:08:37Z", "author": {"login": "s1monw"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,39 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> newFields = new HashMap<>();\n         for (FieldInfo fi : reader.getFieldInfos()) {\n-          FieldInfo clone = builder.add(fi);\n-          // copy the stuff FieldInfos.Builder doesn't copy\n-          for (Entry<String,String> e : fi.attributes().entrySet()) {\n-            clone.putAttribute(e.getKey(), e.getValue());\n-          }\n-          clone.setDocValuesGen(fi.getDocValuesGen());\n+          // cannot use builder.add(fi) because it does not preserve\n+          // the local field number. Field numbers can be different from the global ones\n+          // if the segment was created externally (with IndexWriter#addIndexes(Directory)).\n+          FieldInfo clone = cloneFieldInfo(fi, fi.number);\n+          newFields.put(clone.name, clone);\n+          maxFieldNumber = Math.max(clone.number, maxFieldNumber);\n         }\n \n         // create new fields with the right DV type\n+        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n         for (List<DocValuesFieldUpdates> updates : pendingDVUpdates.values()) {\n           DocValuesFieldUpdates update = updates.get(0);\n-          FieldInfo fieldInfo = builder.getOrAdd(update.field);\n-          fieldInfo.setDocValuesType(update.type);\n+          FieldInfo globalFieldInfo =  builder.getOrAdd(update.field);\n+          globalFieldInfo.setDocValuesType(update.type);\n+          FieldInfo segmentFieldInfo = newFields.get(update.field);\n+          if (segmentFieldInfo == null) {\n+            // the field is not present in this segment so we can fallback to the global fields.\n+            if (globalFieldInfo.number <= maxFieldNumber) {\n+              // the global field number is already used in this segment for a different field so we force a new one locally.\n+              globalFieldInfo = cloneFieldInfo(globalFieldInfo, ++maxFieldNumber);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4b4e8fcda9fa63babe22f5a0be02fca38a3be8"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d755888d4744ff6a1beba17e20580f43841f12", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/00d755888d4744ff6a1beba17e20580f43841f12", "committedDate": "2020-04-02T15:09:01Z", "message": "simplify cloning and fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ede44994c0fe72b8ef26c9b5a80819aa526039a9", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/ede44994c0fe72b8ef26c9b5a80819aa526039a9", "committedDate": "2020-04-02T15:11:58Z", "message": "add assert to check dv type update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34718cb64e747e56ebc5341f9180d2f12aace029", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/34718cb64e747e56ebc5341f9180d2f12aace029", "committedDate": "2020-04-02T15:14:21Z", "message": "extra line"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01cf8d21e2dbdf4434d5bcad5f65481ee65a8738", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/01cf8d21e2dbdf4434d5bcad5f65481ee65a8738", "committedDate": "2020-04-02T15:18:28Z", "message": "restore comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81", "committedDate": "2020-04-02T15:24:55Z", "message": "add more comments and assertion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2NjIxODA3", "url": "https://github.com/apache/lucene-solr/pull/1394#pullrequestreview-386621807", "createdAt": "2020-04-02T17:01:58Z", "commit": {"oid": "0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzowMTo1OVrOF_0vzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzowMTo1OVrOF_0vzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ2ODgxMw==", "bodyText": "nit: we call it byNameelsewhere", "url": "https://github.com/apache/lucene-solr/pull/1394#discussion_r402468813", "createdAt": "2020-04-02T17:01:59Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/index/ReadersAndUpdates.java", "diffHunk": "@@ -543,27 +543,37 @@ public synchronized boolean writeFieldUpdates(Directory dir, FieldInfos.FieldNum\n       \n       try {\n         // clone FieldInfos so that we can update their dvGen separately from\n-        // the reader's infos and write them to a new fieldInfos_gen file\n-        FieldInfos.Builder builder = new FieldInfos.Builder(fieldNumbers);\n-        // cannot use builder.add(reader.getFieldInfos()) because it does not\n-        // clone FI.attributes as well FI.dvGen\n+        // the reader's infos and write them to a new fieldInfos_gen file.\n+        int maxFieldNumber = -1;\n+        Map<String, FieldInfo> perName = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b5c6c896bcc67f8ec6d9206d5dc9caa5cc5ee81"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fed4319409a4d6c3a70e500cc51a58766116e21", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/9fed4319409a4d6c3a70e500cc51a58766116e21", "committedDate": "2020-04-03T09:53:56Z", "message": "perName -> byName"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52dcc9034100fa932566e2003fa48eeba8a6859d", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/52dcc9034100fa932566e2003fa48eeba8a6859d", "committedDate": "2020-04-03T11:10:28Z", "message": "add entry to changes.txt"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72cab5a2b05f042ec900920775e50fd59183da7", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/apache/lucene-solr/commit/f72cab5a2b05f042ec900920775e50fd59183da7", "committedDate": "2020-04-03T11:10:49Z", "message": "Merge branch 'master' into doc_values_update_field_infos_gen"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2073, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}