{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1OTE5OTkx", "number": 1736, "title": "Harden RequestRateLimiter Tests", "bodyText": "This commit adds higher data size and load in the test path. Also improves\nthe asserts that are performed.", "createdAt": "2020-08-11T07:23:30Z", "url": "https://github.com/apache/lucene-solr/pull/1736", "merged": true, "mergeCommit": {"oid": "1d2749295b5378db9f54d603b581d1d9a1e3cc93"}, "closed": true, "closedAt": "2020-08-11T17:12:54Z", "author": {"login": "atris"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9xld0AH2gAyNDY1OTE5OTkxOmU1MWUzMzRhNGQxYjlhMTkyMjg1NDQ4M2RiYmE2ZWI5OGVmMTEyYTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc95-WKgFqTQ2NTI2NDUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e51e334a4d1b9a1922854483dbba6eb98ef112a8", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/e51e334a4d1b9a1922854483dbba6eb98ef112a8", "committedDate": "2020-08-11T07:21:44Z", "message": "Harden RequestRateLimiter Tests\n\nThis commit adds higher data size and load in the test path. Also improves\nthe asserts that are performed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MDE3MDI0", "url": "https://github.com/apache/lucene-solr/pull/1736#pullrequestreview-465017024", "createdAt": "2020-08-11T12:30:35Z", "commit": {"oid": "e51e334a4d1b9a1922854483dbba6eb98ef112a8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjozMDozNVrOG-1lzQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjozMjoxMVrOG-1pXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0MjkyNQ==", "bodyText": "Can we limit the higher footprint to Nightly?", "url": "https://github.com/apache/lucene-solr/pull/1736#discussion_r468542925", "createdAt": "2020-08-11T12:30:35Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter.java", "diffHunk": "@@ -66,15 +66,11 @@ public void testConcurrentQueries() throws Exception {\n \n     solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n \n-    processTest(client);\n+    processTest(client, 10000 /* number of documents */, 350 /* number of queries */);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51e334a4d1b9a1922854483dbba6eb98ef112a8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0MzI1NQ==", "bodyText": "Somewhat concerning that the fix to the test is to relax the assertion conditions", "url": "https://github.com/apache/lucene-solr/pull/1736#discussion_r468543255", "createdAt": "2020-08-11T12:31:08Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter.java", "diffHunk": "@@ -66,15 +66,11 @@ public void testConcurrentQueries() throws Exception {\n \n     solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n \n-    processTest(client);\n+    processTest(client, 10000 /* number of documents */, 350 /* number of queries */);\n \n     MockRequestRateLimiter mockQueryRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.QUERY);\n \n-    assertEquals(25, mockQueryRateLimiter.incomingRequestCount.get());\n-    assertTrue(\"Incoming accepted new request count did not match. Expected 5 incoming \" + mockQueryRateLimiter.acceptedNewRequestCount.get(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51e334a4d1b9a1922854483dbba6eb98ef112a8"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU0MzgzNg==", "bodyText": "should be numDocuments", "url": "https://github.com/apache/lucene-solr/pull/1736#discussion_r468543836", "createdAt": "2020-08-11T12:32:11Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter.java", "diffHunk": "@@ -124,12 +120,12 @@ private void processTest(CloudSolrClient client) throws Exception {\n     List<Future<Boolean>> futures;\n \n     try {\n-      for (int i = 0; i < 25; i++) {\n+      for (int i = 0; i < numQueries; i++) {\n         callableList.add(() -> {\n           try {\n             QueryResponse response = client.query(new SolrQuery(\"*:*\"));\n \n-            assertEquals(100, response.getResults().getNumFound());\n+            assertEquals(10000, response.getResults().getNumFound());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e51e334a4d1b9a1922854483dbba6eb98ef112a8"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0efc703209cac572b479651ec29b5783d63c1716", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/0efc703209cac572b479651ec29b5783d63c1716", "committedDate": "2020-08-11T15:38:24Z", "message": "Update per comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83e7d8adbddebaa3388e9d48d08d9dccb12577b6", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/83e7d8adbddebaa3388e9d48d08d9dccb12577b6", "committedDate": "2020-08-11T15:46:26Z", "message": "Remove blah"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90fa9270f0a80388a1e4c40e69a60f812883e72a", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/90fa9270f0a80388a1e4c40e69a60f812883e72a", "committedDate": "2020-08-11T16:09:27Z", "message": "Fix Precommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjMyNDMx", "url": "https://github.com/apache/lucene-solr/pull/1736#pullrequestreview-465232431", "createdAt": "2020-08-11T16:27:14Z", "commit": {"oid": "90fa9270f0a80388a1e4c40e69a60f812883e72a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjoyNzoxNFrOG-_uhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxNjoyNzo1N1rOG-_whQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwODk5Ng==", "bodyText": "This isn't what I meant, sorry for being unclear. Keep this as @Test but when selecting the number of documents and queries do something like https://github.com/apache/lucene-solr/blob/master/lucene/core/src/test/org/apache/lucene/index/TestMultiDocValues.java#L52", "url": "https://github.com/apache/lucene-solr/pull/1736#discussion_r468708996", "createdAt": "2020-08-11T16:27:14Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter.java", "diffHunk": "@@ -48,7 +47,7 @@ public static void setupCluster() throws Exception {\n     configureCluster(1).addConfig(FIRST_COLLECTION, configset(\"cloud-minimal\")).configure();\n   }\n \n-  @Test\n+  @Nightly", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fa9270f0a80388a1e4c40e69a60f812883e72a"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODcwOTUwOQ==", "bodyText": "Should we assert that accepted + rejected = total?\nAnd that accepted > 0.", "url": "https://github.com/apache/lucene-solr/pull/1736#discussion_r468709509", "createdAt": "2020-08-11T16:27:57Z", "author": {"login": "madrob"}, "path": "solr/core/src/test/org/apache/solr/servlet/TestRequestRateLimiter.java", "diffHunk": "@@ -66,20 +65,19 @@ public void testConcurrentQueries() throws Exception {\n \n     solrDispatchFilter.replaceRateLimitManager(rateLimitManager);\n \n-    processTest(client);\n+    processTest(client, 10000 /* number of documents */, 350 /* number of queries */);\n \n     MockRequestRateLimiter mockQueryRateLimiter = (MockRequestRateLimiter) rateLimitManager.getRequestRateLimiter(SolrRequest.SolrRequestType.QUERY);\n \n-    assertEquals(25, mockQueryRateLimiter.incomingRequestCount.get());\n-    assertTrue(\"Incoming accepted new request count did not match. Expected 5 incoming \" + mockQueryRateLimiter.acceptedNewRequestCount.get(),\n-        mockQueryRateLimiter.acceptedNewRequestCount.get() < 25);\n-    assertTrue(\"Incoming rejected new request count did not match. Expected 20 incoming \" + mockQueryRateLimiter.rejectedRequestCount.get(),\n-        mockQueryRateLimiter.rejectedRequestCount.get() > 0);\n+    assertEquals(350, mockQueryRateLimiter.incomingRequestCount.get());\n+\n+    assertTrue((mockQueryRateLimiter.acceptedNewRequestCount.get() == mockQueryRateLimiter.incomingRequestCount.get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90fa9270f0a80388a1e4c40e69a60f812883e72a"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7260228123a5a02d92a238769a6575d80ea0d52", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/d7260228123a5a02d92a238769a6575d80ea0d52", "committedDate": "2020-08-11T16:36:52Z", "message": "Update per comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3cb50a5a0670c7540478473c4e14c610a3429da", "author": {"user": {"login": "atris", "name": "Atri Sharma"}}, "url": "https://github.com/apache/lucene-solr/commit/f3cb50a5a0670c7540478473c4e14c610a3429da", "committedDate": "2020-08-11T16:56:15Z", "message": "Revert nightly change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1MjY0NTEx", "url": "https://github.com/apache/lucene-solr/pull/1736#pullrequestreview-465264511", "createdAt": "2020-08-11T17:08:09Z", "commit": {"oid": "f3cb50a5a0670c7540478473c4e14c610a3429da"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2348, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}