{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY1NjA2OTE1", "number": 1731, "title": "LUCENE-9451 Sort.rewrite does not always return this when unchanged", "bodyText": "https://issues.apache.org/jira/browse/LUCENE-9451", "createdAt": "2020-08-10T16:31:30Z", "url": "https://github.com/apache/lucene-solr/pull/1731", "merged": true, "mergeCommit": {"oid": "6c94ca9cb33795cdc29797ff2d17f1869813d3f9"}, "closed": true, "closedAt": "2020-09-04T14:46:04Z", "author": {"login": "madrob"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9k20HgFqTQ2NDM5MDU4Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdABLyegFqTQ2OTAzMDg1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY0MzkwNTg3", "url": "https://github.com/apache/lucene-solr/pull/1731#pullrequestreview-464390587", "createdAt": "2020-08-10T16:31:54Z", "commit": {"oid": "9035c95dd0b3ac7b8bf9687d8f2173d4ceca02fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjozMTo1NVrOG-WYaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMFQxNjozMTo1NVrOG-WYaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzMTU5Mg==", "bodyText": "This might be better as an object equality check instead of reference equality, I'm not sure.", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r468031592", "createdAt": "2020-08-10T16:31:55Z", "author": {"login": "madrob"}, "path": "lucene/core/src/java/org/apache/lucene/search/DoubleValuesSource.java", "diffHunk": "@@ -456,13 +456,16 @@ public String toString() {\n \n     @Override\n     public SortField rewrite(IndexSearcher searcher) throws IOException {\n-      DoubleValuesSortField rewritten = new DoubleValuesSortField(producer.rewrite(searcher), reverse);\n+      DoubleValuesSource rewrittenSource = producer.rewrite(searcher);\n+      if (rewrittenSource == producer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9035c95dd0b3ac7b8bf9687d8f2173d4ceca02fa"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODY5ODg2", "url": "https://github.com/apache/lucene-solr/pull/1731#pullrequestreview-465869886", "createdAt": "2020-08-12T12:31:58Z", "commit": {"oid": "6c6da31797c931a42b2c381e4b1164b2a6b98384"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjozMTo1OVrOG_fLow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMjozNTozNFrOG_fTpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNDM1NQ==", "bodyText": "Reference equality is the right check.", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469224355", "createdAt": "2020-08-12T12:31:59Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/DoubleValuesSource.java", "diffHunk": "@@ -456,13 +456,16 @@ public String toString() {\n \n     @Override\n     public SortField rewrite(IndexSearcher searcher) throws IOException {\n-      DoubleValuesSortField rewritten = new DoubleValuesSortField(producer.rewrite(searcher), reverse);\n+      DoubleValuesSource rewrittenSource = producer.rewrite(searcher);\n+      if (rewrittenSource == producer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODAzMTU5Mg=="}, "originalCommit": {"oid": "9035c95dd0b3ac7b8bf9687d8f2173d4ceca02fa"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNTIzNw==", "bodyText": "this should remain a reference equality check", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469225237", "createdAt": "2020-08-12T12:33:27Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Sort.java", "diffHunk": "@@ -177,12 +177,12 @@ public Sort rewrite(IndexSearcher searcher) throws IOException {\n     SortField[] rewrittenSortFields = new SortField[fields.length];\n     for (int i = 0; i < fields.length; i++) {\n       rewrittenSortFields[i] = fields[i].rewrite(searcher);\n-      if (fields[i] != rewrittenSortFields[i]) {\n+      if (! fields[i].equals(rewrittenSortFields[i])) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6da31797c931a42b2c381e4b1164b2a6b98384"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTIyNjQwNA==", "bodyText": "This test looks like it belongs to TestDoubleValuesSource/TestLongValuesSource more than it belongs to TestSort?", "url": "https://github.com/apache/lucene-solr/pull/1731#discussion_r469226404", "createdAt": "2020-08-12T12:35:34Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/test/org/apache/lucene/search/TestSort.java", "diffHunk": "@@ -878,4 +878,22 @@ public void testMultiSort() throws IOException {\n     ir.close();\n     dir.close();\n   }\n+\n+  public void testRewrite() throws IOException {\n+    try (Directory dir = newDirectory()) {\n+      RandomIndexWriter writer = new RandomIndexWriter(random(), dir);\n+      IndexSearcher searcher = newSearcher(writer.getReader());\n+      writer.close();\n+\n+      LongValuesSource longSource = LongValuesSource.constant(1L);\n+      Sort sort = new Sort(longSource.getSortField(false));\n+\n+      assertSame(sort, sort.rewrite(searcher));\n+\n+      DoubleValuesSource doubleSource = DoubleValuesSource.constant(1.0);\n+      sort = new Sort(doubleSource.getSortField(false));\n+\n+      assertSame(sort, sort.rewrite(searcher));\n+    }\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c6da31797c931a42b2c381e4b1164b2a6b98384"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5a859615c95c9f629077129880d08ab1ace11e3", "author": {"user": {"login": "madrob", "name": "Mike Drob"}}, "url": "https://github.com/apache/lucene-solr/commit/c5a859615c95c9f629077129880d08ab1ace11e3", "committedDate": "2020-08-17T15:37:47Z", "message": "LUCENE-9451 Sort.rewrite does not always return this when unchanged"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14ec015e22cc3c8e0bcad50c277a440346b8464d", "author": {"user": {"login": "madrob", "name": "Mike Drob"}}, "url": "https://github.com/apache/lucene-solr/commit/14ec015e22cc3c8e0bcad50c277a440346b8464d", "committedDate": "2020-08-17T15:37:48Z", "message": "precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8205edcda046b8d98093db868fda901bdb70f11", "author": {"user": {"login": "madrob", "name": "Mike Drob"}}, "url": "https://github.com/apache/lucene-solr/commit/e8205edcda046b8d98093db868fda901bdb70f11", "committedDate": "2020-08-17T15:47:44Z", "message": "Review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c6da31797c931a42b2c381e4b1164b2a6b98384", "author": {"user": {"login": "madrob", "name": "Mike Drob"}}, "url": "https://github.com/apache/lucene-solr/commit/6c6da31797c931a42b2c381e4b1164b2a6b98384", "committedDate": "2020-08-10T16:36:13Z", "message": "precommit"}, "afterCommit": {"oid": "e8205edcda046b8d98093db868fda901bdb70f11", "author": {"user": {"login": "madrob", "name": "Mike Drob"}}, "url": "https://github.com/apache/lucene-solr/commit/e8205edcda046b8d98093db868fda901bdb70f11", "committedDate": "2020-08-17T15:47:44Z", "message": "Review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MDMwODU0", "url": "https://github.com/apache/lucene-solr/pull/1731#pullrequestreview-469030854", "createdAt": "2020-08-18T06:40:01Z", "commit": {"oid": "e8205edcda046b8d98093db868fda901bdb70f11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2339, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}