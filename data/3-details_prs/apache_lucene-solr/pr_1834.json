{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgwMjQyMjkx", "number": 1834, "title": "Make sure to test normal scorers with asserting wrappers.", "bodyText": "When a query is run at the top-level, the searcher uses Weight#bulkScorer.\nMany queries don't implement this explicitly and instead rely on the default\nimplementation which delegates to Weight#scorer.\nPreviously AssertingWeight would always wrap the delegate's bulk scorer. So\nfor queries that rely on Weight#scorer, we weren't wrapping the scorer or\niterator to run checks. This change proposes that AssertingWeight#bulkScorer\nsometimes use the default implementation to make sure we also test normal\nscorers.\nThis change would have caught the bug in LUCENE-9501.", "createdAt": "2020-09-04T23:00:00Z", "url": "https://github.com/apache/lucene-solr/pull/1834", "merged": true, "mergeCommit": {"oid": "fceab765c1c2c3266d14bb5900c88458f958cce4"}, "closed": true, "closedAt": "2020-09-14T16:06:42Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFu_OggH2gAyNDgwMjQyMjkxOjFhMDA3YWFhNmM3MmZhYTM1NDI2YTY5NDE4YWI1NzIzM2ViNGFjM2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI1Im6AH2gAyNDgwMjQyMjkxOmViN2RlOWMyNGUwMGI1OTcyM2IyNTg2MjViYzI5ODhjNjI2OGFkYjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a007aaa6c72faa35426a69418ab57233eb4ac3c", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/1a007aaa6c72faa35426a69418ab57233eb4ac3c", "committedDate": "2020-09-05T00:51:33Z", "message": "Make sure to test normal scorers with asserting wrappers."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66b9f92b05b82a868c3382e0162e1318705e52e0", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/66b9f92b05b82a868c3382e0162e1318705e52e0", "committedDate": "2020-09-04T22:54:56Z", "message": "Make sure to test normal scorers with asserting wrappers."}, "afterCommit": {"oid": "1a007aaa6c72faa35426a69418ab57233eb4ac3c", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/1a007aaa6c72faa35426a69418ab57233eb4ac3c", "committedDate": "2020-09-05T00:51:33Z", "message": "Make sure to test normal scorers with asserting wrappers."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDY2Mzcy", "url": "https://github.com/apache/lucene-solr/pull/1834#pullrequestreview-483066372", "createdAt": "2020-09-05T16:53:29Z", "commit": {"oid": "1a007aaa6c72faa35426a69418ab57233eb4ac3c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxNjo1MzozMFrOHNjDTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxNjo1MzozMFrOHNjDTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk2NzgyMg==", "bodyText": "I know of several tests that test first with a top-level query and then with a filter to make sure that both the bulk scorer and the scorer are tested. With this change, 50% of the time, we wouldn't be testing the bulk scorer, so I wonder if we should replace random.nextBoolean() with frequently() or something like that.", "url": "https://github.com/apache/lucene-solr/pull/1834#discussion_r483967822", "createdAt": "2020-09-05T16:53:30Z", "author": {"login": "jpountz"}, "path": "lucene/test-framework/src/java/org/apache/lucene/search/AssertingWeight.java", "diffHunk": "@@ -85,11 +85,18 @@ public long cost() {\n \n   @Override\n   public BulkScorer bulkScorer(LeafReaderContext context) throws IOException {\n-    BulkScorer inScorer = in.bulkScorer(context);\n+    BulkScorer inScorer;\n+    // We explicitly test both the delegate's bulk scorer, and also the normal scorer.\n+    // This ensures that normal scorers are sometimes tested with an asserting wrapper.\n+    if (random.nextBoolean()) {\n+      inScorer = in.bulkScorer(context);\n+    } else {\n+      inScorer = super.bulkScorer(context);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a007aaa6c72faa35426a69418ab57233eb4ac3c"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1829abe99195ed5205876ffc7d0cf7a6056ba010", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/1829abe99195ed5205876ffc7d0cf7a6056ba010", "committedDate": "2020-09-08T16:53:23Z", "message": "Decrease the frequency for testing Scorer directly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a444e75015869015bf4602895449036f05bd87a8", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/a444e75015869015bf4602895449036f05bd87a8", "committedDate": "2020-09-08T17:01:50Z", "message": "Merge remote-tracking branch 'upstream/master' into asserting-scorer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c630178dd3e9a66c13ed43ee3798b081d99ecf43", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/c630178dd3e9a66c13ed43ee3798b081d99ecf43", "committedDate": "2020-09-08T17:01:57Z", "message": "Update changelog entry."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTkzNzUy", "url": "https://github.com/apache/lucene-solr/pull/1834#pullrequestreview-487593752", "createdAt": "2020-09-14T09:50:53Z", "commit": {"oid": "c630178dd3e9a66c13ed43ee3798b081d99ecf43"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwOTo1MDo1NFrOHRMPkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwOTo1MDo1NFrOHRMPkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc4ODQzNA==", "bodyText": "I'm not sure I'd understand what \"sometimes wrap scorers\" would mean as a user reading the changelog. Maybe say something along the lines of \"sometimes exercise the Weight#scorer API rather than Weight#bulkScorer for top-level queries\".", "url": "https://github.com/apache/lucene-solr/pull/1834#discussion_r487788434", "createdAt": "2020-09-14T09:50:54Z", "author": {"login": "jpountz"}, "path": "lucene/CHANGES.txt", "diffHunk": "@@ -204,7 +204,8 @@ Improvements\n * LUCENE-9446: In BooleanQuery rewrite, always remove MatchAllDocsQuery filter clauses\n   when possible. (Julie Tibshirani)\n \n-* LUCENE-9501: Improve how Asserting* test classes handle singleton doc values.\n+* LUCENE-9501: Improve coverage for Asserting* test classes: make sure to handle singleton doc\n+  values, and sometimes wrap Scorers by default. (Julie Tibshirani)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c630178dd3e9a66c13ed43ee3798b081d99ecf43"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb7de9c24e00b59723b258625bc2988c6268adb9", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/apache/lucene-solr/commit/eb7de9c24e00b59723b258625bc2988c6268adb9", "committedDate": "2020-09-14T15:43:00Z", "message": "Clarify changelog entry."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2226, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}