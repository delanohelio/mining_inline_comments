{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0ODY5MTc5", "number": 1497, "title": "SOLR-8394: /admin/luke didn't computeindexHeapUsageBytes", "bodyText": "Needed to call FilterLeafReader.unwrap.\nhttps://issues.apache.org/jira/browse/SOLR-8394\nCC @sigram", "createdAt": "2020-05-07T19:11:51Z", "url": "https://github.com/apache/lucene-solr/pull/1497", "merged": true, "mergeCommit": {"oid": "803aad91757be4140c6f96f12e3cf74f5c6e3a87"}, "closed": true, "closedAt": "2020-05-15T18:02:50Z", "author": {"login": "dsmiley"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcfCK9fgH2gAyNDE0ODY5MTc5OmFmNDc0MmFkMmZmZjVhOTUwY2UwOTZlMTU4MjUxOWZkMTM3MjBkNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcic4eUAFqTQxMzQ0NTkzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "af4742ad2fff5a950ce096e1582519fd13720d77", "author": {"user": {"login": "igiguere", "name": null}}, "url": "https://github.com/apache/lucene-solr/commit/af4742ad2fff5a950ce096e1582519fd13720d77", "committedDate": "2020-05-07T19:09:31Z", "message": "SOLR-8394: /admin/luke didn't computeindexHeapUsageBytes\nNeeded to call FilterLeafReader.unwrap."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5ODcxMTk0", "url": "https://github.com/apache/lucene-solr/pull/1497#pullrequestreview-409871194", "createdAt": "2020-05-12T09:38:44Z", "commit": {"oid": "af4742ad2fff5a950ce096e1582519fd13720d77"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTozODo0NVrOGT-hnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQwOTozODo0NVrOGT-hnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzYwMDU0Mw==", "bodyText": "I like the first 4 lines (this is rare for me to see a clear stream). But the last 2 lines are less clear, it took me some time to understand why it's needed.", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r423600543", "createdAt": "2020-05-12T09:38:45Z", "author": {"login": "bruno-roustant"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {\n+            return ((Accountable) leafReader).ramBytesUsed();\n+          } else {\n+            return -1L; // unsupported\n+          }\n+        })\n+        .mapToLong(Long::longValue)\n+        .reduce(0, (left, right) -> left == -1 || right == -1 ? -1 : left + right);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af4742ad2fff5a950ce096e1582519fd13720d77"}, "originalPosition": 60}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97", "author": {"user": {"login": "dsmiley", "name": "David Smiley"}}, "url": "https://github.com/apache/lucene-solr/commit/525616cd949af1dd12e8231df9e9f4e718519d97", "committedDate": "2020-05-15T18:01:32Z", "message": "Merge branch 'master' into solr-8394-lukeIndexHeapUsageBytes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNDQ1OTM4", "url": "https://github.com/apache/lucene-solr/pull/1497#pullrequestreview-413445938", "createdAt": "2020-05-18T09:58:32Z", "commit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1ODozMlrOGWwFig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwOTo1ODozMlrOGWwFig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjUwOTcwNg==", "bodyText": "can we filter here instead?", "url": "https://github.com/apache/lucene-solr/pull/1497#discussion_r426509706", "createdAt": "2020-05-18T09:58:32Z", "author": {"login": "juanka588"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/LukeRequestHandler.java", "diffHunk": "@@ -634,17 +635,19 @@ private static long getSegmentsFileLength(IndexCommit commit) {\n \n   /** Returns the sum of RAM bytes used by each segment */\n   private static long getIndexHeapUsed(DirectoryReader reader) {\n-    long indexHeapRamBytesUsed = 0;\n-    for(LeafReaderContext leafReaderContext : reader.leaves()) {\n-      LeafReader leafReader = leafReaderContext.reader();\n-      if (leafReader instanceof SegmentReader) {\n-        indexHeapRamBytesUsed += ((SegmentReader) leafReader).ramBytesUsed();\n-      } else {\n-        // Not supported for any reader that is not a SegmentReader\n-        return -1;\n-      }\n-    }\n-    return indexHeapRamBytesUsed;\n+    return reader.leaves().stream()\n+        .map(LeafReaderContext::reader)\n+        .map(FilterLeafReader::unwrap)\n+        .map(leafReader -> {\n+          if (leafReader instanceof Accountable) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "525616cd949af1dd12e8231df9e9f4e718519d97"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2693, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}