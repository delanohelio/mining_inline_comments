{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0NDU5ODM4", "number": 1928, "title": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels", "bodyText": "Description\nThis PR improves test coverage for TaxonomyFacetLabels ( added in PR 1893 ) by exercising the API - TaxonomyFacetLabels.nextFacetLabel(docId, facetDimension) to fetch facet labels for a specific dimension.\nSolution\nThe solution enhances the test method - TestTaxonomyFacetCounts.testRandom() and does the following\n\nPick a dimension at random\nFilter expected facet labels to retain entries for chosen dimension only.\nInvoke the API - TaxonomyFacetLabels.nextFacetLabel(docId, facetDimension) to get facet labels for specific dimension.\nEnsures that expected and actual facet labels match.\n\nTests\n\nTestTaxonomyFacetCounts.testRandom() is enhanced to improve test coverage for TaxonomyFacetLabels.\nFacetTestCase is refactored to add a dimension parameter to utility method getAllTaxonomyFacetLabels(...)\n\nChecklist\nPlease review the following and check all that apply:\n\n[x ] I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n[ x] I have created a Jira issue and added the issue ID to my pull request title.\n[ x] I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n[ x] I have developed this patch against the master branch.\n[x ] I have run ./gradlew check.\n[x ] I have added tests for my changes.\n[x ] I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-09-28T23:45:01Z", "url": "https://github.com/apache/lucene-solr/pull/1928", "merged": true, "mergeCommit": {"oid": "2e2161b0e09808b1856c746a6748875c395b855e"}, "closed": true, "closedAt": "2020-09-30T17:21:18Z", "author": {"login": "goankur"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKPwOsAH2gAyNDk0NDU5ODM4OmJmOGVhZjk4OTAxY2JlODNmMjMwNjdiZWE5MGRmYjJmMzEwMjYwM2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOAIIBgFqTQ5OTY1MzAyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf8eaf98901cbe83f23067bea90dfb2f3102603a", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/bf8eaf98901cbe83f23067bea90dfb2f3102603a", "committedDate": "2020-09-19T01:17:44Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75ff251ebac9034c93edbb43dcf5d8dd0f1058ae", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/75ff251ebac9034c93edbb43dcf5d8dd0f1058ae", "committedDate": "2020-09-23T04:23:23Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71222c288a83e4a05d0be6020f6903ad340d959d", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/71222c288a83e4a05d0be6020f6903ad340d959d", "committedDate": "2020-09-23T17:19:13Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2600be2694de92f7eb881a7f4e65de77f2175e8d", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/2600be2694de92f7eb881a7f4e65de77f2175e8d", "committedDate": "2020-09-25T00:21:04Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3c992c4bae6f98d65d8f42ef752a583bd1e8f4d", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/e3c992c4bae6f98d65d8f42ef752a583bd1e8f4d", "committedDate": "2020-09-26T00:22:33Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a87e115e867f56a46323827d184cd65661feb870", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/a87e115e867f56a46323827d184cd65661feb870", "committedDate": "2020-09-28T22:45:13Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef061a5d53f4de81fb7e846bf3eca77595711856", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/ef061a5d53f4de81fb7e846bf3eca77595711856", "committedDate": "2020-09-28T22:59:19Z", "message": "LUCENE-9444 Utility class to get facet labels from taxonomy for a facet field. This is useful if a facet field is requested in the list of return fields for each hit."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4NTAzMDYx", "url": "https://github.com/apache/lucene-solr/pull/1928#pullrequestreview-498503061", "createdAt": "2020-09-29T14:01:22Z", "commit": {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDowMToyMlrOHZuwfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQxNDowMjo0N1rOHZu0hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MjUyNQ==", "bodyText": "Missing space before {?", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496742525", "createdAt": "2020-09-29T14:01:22Z", "author": {"login": "mikemccand"}, "path": "lucene/facet/src/test/org/apache/lucene/facet/FacetTestCase.java", "diffHunk": "@@ -70,32 +70,51 @@ public Facets getTaxonomyFacetCounts(TaxonomyReader taxoReader, FacetsConfig con\n    *\n    * @param taxoReader {@link TaxonomyReader} used to read taxonomy during search. This instance is expected to be open for reading.\n    * @param fc         {@link FacetsCollector} A collector with matching hits.\n-   * @return {@code List<List<FacetLabel>} where outer list has one non-null entry per document\n+   * @param dimension  facet dimension for which labels are requested. A null value fetches labels for all dimensions.\n+   * @return {@code List<List<FacetLabel>} where outer list has one non-null entry per document.\n    * and inner list contain all {@link FacetLabel} entries that belong to a document.\n    * @throws IOException when a low-level IO issue occurs.\n    */\n-  public List<List<FacetLabel>> getAllTaxonomyFacetLabels(TaxonomyReader taxoReader, FacetsCollector fc) throws IOException {\n+  public List<List<FacetLabel>> getAllTaxonomyFacetLabels(String dimension, TaxonomyReader taxoReader, FacetsCollector fc) throws IOException {\n     List<List<FacetLabel>> actualLabels = new ArrayList<>();\n     TaxonomyFacetLabels taxoLabels = new TaxonomyFacetLabels(taxoReader, FacetsConfig.DEFAULT_INDEX_FIELD_NAME);\n-\n     for (MatchingDocs m : fc.getMatchingDocs()) {\n       FacetLabelReader facetLabelReader = taxoLabels.getFacetLabelReader(m.context);\n-\n       DocIdSetIterator disi = m.bits.iterator();\n       while (disi.nextDoc() != DocIdSetIterator.NO_MORE_DOCS) {\n-        List<FacetLabel> facetLabels = new ArrayList<>();\n-        int docId = disi.docID();\n-        FacetLabel facetLabel = facetLabelReader.nextFacetLabel(docId);\n-        while (facetLabel != null) {\n-          facetLabels.add(facetLabel);\n-          facetLabel = facetLabelReader.nextFacetLabel(docId);\n-        }\n-        actualLabels.add(facetLabels);\n+        actualLabels.add(allFacetLabels(disi.docID(), dimension, facetLabelReader));\n       }\n     }\n     return actualLabels;\n   }\n \n+  /**\n+   * Utility method to get all facet labels for an input docId and dimension using the supplied\n+   * {@link FacetLabelReader}.\n+   *\n+   * @param docId docId for which facet labels are needed.\n+   * @param dimension Retain facet labels for supplied dimension only. A null value fetches all facet labels.\n+   * @param facetLabelReader {@FacetLabelReader} instance use to get facet labels for input docId.\n+   * @return {@code List<FacetLabel>} containing matching facet labels.\n+   * @throws IOException when a low-level IO issue occurs while reading facet labels.\n+   */\n+  List<FacetLabel> allFacetLabels(int docId, String dimension, FacetLabelReader facetLabelReader) throws IOException {\n+    List<FacetLabel> facetLabels = new ArrayList<>();\n+    FacetLabel facetLabel;\n+    if (dimension != null) {\n+      for (facetLabel = facetLabelReader.nextFacetLabel(docId, dimension); facetLabel != null; ){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Njc0MzU1OQ==", "bodyText": "Hmm remove this added space?", "url": "https://github.com/apache/lucene-solr/pull/1928#discussion_r496743559", "createdAt": "2020-09-29T14:02:47Z", "author": {"login": "mikemccand"}, "path": "lucene/facet/src/test/org/apache/lucene/facet/taxonomy/TestTaxonomyFacetCounts.java", "diffHunk": "@@ -696,10 +696,9 @@ public void testRandom() throws Exception {\n               } else {\n                 expectedCounts[j].put(doc.dims[j], v.intValue() + 1);\n               }\n-\n               // Add document facet labels\n               facetLabels.add(new FacetLabel(\"dim\" + j, doc.dims[j]));\n-            }\n+             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945"}, "originalPosition": 17}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c2b2f271773db7884b1149aab1477aadabad00f", "author": {"user": {"login": "munendrasn", "name": "S N Munendra"}}, "url": "https://github.com/apache/lucene-solr/commit/5c2b2f271773db7884b1149aab1477aadabad00f", "committedDate": "2020-09-29T18:30:54Z", "message": "Revert \"SOLR-14767 : Fix NumberFormatException when int/long field value is floating num\"\n\nThis reverts commit 63f0b6b706dcbc8e92a8ff3ee8b81d6d6900aa67."}, "afterCommit": {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/cc03488bc67178c6d182263a2100ef05e5acb945", "committedDate": "2020-09-28T23:58:41Z", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "789747255e4a7a3db6a84eb638f6b3f0a581c74e", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/789747255e4a7a3db6a84eb638f6b3f0a581c74e", "committedDate": "2020-09-29T18:53:59Z", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc03488bc67178c6d182263a2100ef05e5acb945", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/cc03488bc67178c6d182263a2100ef05e5acb945", "committedDate": "2020-09-28T23:58:41Z", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels"}, "afterCommit": {"oid": "789747255e4a7a3db6a84eb638f6b3f0a581c74e", "author": {"user": null}, "url": "https://github.com/apache/lucene-solr/commit/789747255e4a7a3db6a84eb638f6b3f0a581c74e", "committedDate": "2020-09-29T18:53:59Z", "message": "LUCENE-9444: Improve test coverage for TaxonomyFacetLabels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NjUzMDIw", "url": "https://github.com/apache/lucene-solr/pull/1928#pullrequestreview-499653020", "createdAt": "2020-09-30T17:21:03Z", "commit": {"oid": "789747255e4a7a3db6a84eb638f6b3f0a581c74e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2651, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}