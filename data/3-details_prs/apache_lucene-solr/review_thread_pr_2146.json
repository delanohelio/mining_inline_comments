{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5OTMwNTU0", "number": 2146, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDozNFrOFFhMwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1MlrOFFhNRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMzMxMTM4OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDozNFrOIGEVEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDozNFrOIGEVEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzI5Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/apache/lucene-solr/pull/2146#discussion_r543233296", "createdAt": "2020-12-15T10:40:34Z", "author": {"login": "jbampton"}, "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "diffHunk": "@@ -218,4 +218,28 @@ public BitsetBounds(long lower, long upper) {\n       this.upper = upper;\n     }\n   }\n+\n+  /**\n+   * A {@link TopLevelJoinQuery} implementation optimized for when 'from' and 'to' cores and fields match and no ordinal-\n+   * conversion is necessary.\n+   */\n+  static class SelfJoin extends TopLevelJoinQuery {\n+    public SelfJoin(String joinField, Query subQuery) {\n+      super(joinField, joinField, null, subQuery);\n+    }\n+\n+    protected BitsetBounds convertFromOrdinalsIntoToField(LongBitSet fromOrdBitSet, SortedSetDocValues fromDocValues,\n+                                                          LongBitSet toOrdBitSet, SortedSetDocValues toDocValues) throws IOException {\n+\n+      // 'from' and 'to' ordinals are identical for self-joins.\n+      toOrdBitSet.or(fromOrdBitSet);\n+\n+      // Calculate boundary ords used for other optimizations\n+      final long firstToOrd = toOrdBitSet.nextSetBit(0);\n+      final long lastToOrd = toOrdBitSet.prevSetBit(toOrdBitSet.length() - 1);\n+      return new BitsetBounds(firstToOrd, lastToOrd);\n+    }\n+  }\n }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMzMxMjY5OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1MlrOIGEV4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMDo0MDo1MlrOIGEV4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzIzMzUwNw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/apache/lucene-solr/pull/2146#discussion_r543233507", "createdAt": "2020-12-15T10:40:52Z", "author": {"login": "jbampton"}, "path": "solr/core/src/java/org/apache/solr/search/TopLevelJoinQuery.java", "diffHunk": "@@ -218,4 +218,28 @@ public BitsetBounds(long lower, long upper) {\n       this.upper = upper;\n     }\n   }\n+\n+  /**\n+   * A {@link TopLevelJoinQuery} implementation optimized for when 'from' and 'to' cores and fields match and no ordinal-\n+   * conversion is necessary.\n+   */\n+  static class SelfJoin extends TopLevelJoinQuery {\n+    public SelfJoin(String joinField, Query subQuery) {\n+      super(joinField, joinField, null, subQuery);\n+    }\n+\n+    protected BitsetBounds convertFromOrdinalsIntoToField(LongBitSet fromOrdBitSet, SortedSetDocValues fromDocValues,\n+                                                          LongBitSet toOrdBitSet, SortedSetDocValues toDocValues) throws IOException {\n+\n+      // 'from' and 'to' ordinals are identical for self-joins.\n+      toOrdBitSet.or(fromOrdBitSet);\n+\n+      // Calculate boundary ords used for other optimizations\n+      final long firstToOrd = toOrdBitSet.nextSetBit(0);\n+      final long lastToOrd = toOrdBitSet.prevSetBit(toOrdBitSet.length() - 1);\n+      return new BitsetBounds(firstToOrd, lastToOrd);\n+    }\n+  }\n }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ce101864bfa93829bd84dca2445ed49b173b086"}, "originalPosition": 46}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 983, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}