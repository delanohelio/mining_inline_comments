{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzg4NTYy", "number": 1908, "title": "LUCENE-9539: Use more compact datastructures for sorting doc-values", "bodyText": "This change cuts over from object based datastructures to primitive / compressed datastructures.", "createdAt": "2020-09-22T08:52:16Z", "url": "https://github.com/apache/lucene-solr/pull/1908", "merged": true, "mergeCommit": {"oid": "c82b99464dae6379380f214f250592a450bbe23b"}, "closed": true, "closedAt": "2020-09-22T13:10:53Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLUB0_AH2gAyNDkwNzg4NTYyOmExYTQwYzg0MjZhMjZjMmIwZmZiZmM3NTYzMDZjMjNjNmQ2MDNjYzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLXvNXgH2gAyNDkwNzg4NTYyOjg5MGRjMjI2NmUyZDkyNzc4YTI4OGVmMmY5YTdkMTlmZDYzNDI1YzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1a40c8426a26c2b0ffbfc756306c23c6d603cc9", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/a1a40c8426a26c2b0ffbfc756306c23c6d603cc9", "committedDate": "2020-09-22T08:50:30Z", "message": "LUCENE-9539: Use more compact datastructures for sorting doc-values"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMjg0NDY3", "url": "https://github.com/apache/lucene-solr/pull/1908#pullrequestreview-493284467", "createdAt": "2020-09-22T09:35:39Z", "commit": {"oid": "a1a40c8426a26c2b0ffbfc756306c23c6d603cc9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9480aca9637c910f21a5e8e20be3ba75861e4916", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/9480aca9637c910f21a5e8e20be3ba75861e4916", "committedDate": "2020-09-22T09:41:53Z", "message": "fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f571593b2721e46d45f4a2b53e0771c3e21ad8e", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/2f571593b2721e46d45f4a2b53e0771c3e21ad8e", "committedDate": "2020-09-22T09:44:10Z", "message": "fix some style issues'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adb99b54d3f7241072be87c65f76420d04af904e", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/adb99b54d3f7241072be87c65f76420d04af904e", "committedDate": "2020-09-22T09:52:14Z", "message": "improve loop readablility"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab213768c76533f7935f2371b8e452c2ff30d64", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/dab213768c76533f7935f2371b8e452c2ff30d64", "committedDate": "2020-09-22T09:54:25Z", "message": "remove imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMzQ3OTEz", "url": "https://github.com/apache/lucene-solr/pull/1908#pullrequestreview-493347913", "createdAt": "2020-09-22T11:05:26Z", "commit": {"oid": "dab213768c76533f7935f2371b8e452c2ff30d64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTowNToyNlrOHV05tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMTowNToyNlrOHV05tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjY0ODg4Nw==", "bodyText": "Technically you could also have a sign switch as boundary (~value marks first value) but I don't think it'd result in any savings and would only complicate the value stream.", "url": "https://github.com/apache/lucene-solr/pull/1908#discussion_r492648887", "createdAt": "2020-09-22T11:05:26Z", "author": {"login": "dweiss"}, "path": "lucene/core/src/java/org/apache/lucene/index/SortedSetDocValuesWriter.java", "diffHunk": "@@ -379,4 +352,31 @@ public long getValueCount() {\n       return in.getValueCount();\n     }\n   }\n+\n+  static final class DocOrds {\n+    final long[] offsets;\n+    final PackedLongValues ords;\n+\n+    DocOrds(int maxDoc, Sorter.DocMap sortMap, SortedSetDocValues oldValues, float acceptableOverheadRatio) throws IOException {\n+      offsets = new long[maxDoc];\n+      PackedLongValues.Builder builder = PackedLongValues.packedBuilder(acceptableOverheadRatio);\n+      long ordOffset = 1; // 0 marks docs with no values\n+      int docID;\n+      while ((docID = oldValues.nextDoc()) != NO_MORE_DOCS) {\n+        int newDocID = sortMap.oldToNew(docID);\n+        long startOffset = ordOffset;\n+        long ord;\n+        while ((ord = oldValues.nextOrd()) != NO_MORE_ORDS) {\n+          builder.add(ord + 1);\n+          ordOffset++;\n+        }\n+        if (startOffset != ordOffset) { // do we have any values?\n+          offsets[newDocID] = startOffset;\n+          builder.add(0); // 0 ord marks next value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dab213768c76533f7935f2371b8e452c2ff30d64"}, "originalPosition": 171}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb93c1276c39709fb670d39f72bf99695c4069fd", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/bb93c1276c39709fb670d39f72bf99695c4069fd", "committedDate": "2020-09-22T13:08:09Z", "message": "add changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "890dc2266e2d92778a288ef2f9a7d19fd63425c3", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/890dc2266e2d92778a288ef2f9a7d19fd63425c3", "committedDate": "2020-09-22T13:09:47Z", "message": "Merge branch 'master' into LUCENE-9539"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2306, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}