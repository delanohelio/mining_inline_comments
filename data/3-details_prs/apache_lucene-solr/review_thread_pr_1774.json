{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxOTMxNjA1", "number": 1774, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxODozNjoyNVrOEbPQ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNjo1N1rOEbigcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk2OTk3MDg4OnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMlQxODozNjoyNVrOHFG66Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjowNzowNFrOHHfY8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw==", "bodyText": "why are we calling loader.newInstance directly instead of createHandler?", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r475118313", "createdAt": "2020-08-22T18:36:25Z", "author": {"login": "madrob"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTYyNDc5NA==", "bodyText": "If the intent here to use loader.newInstance is for pluggable implementations, then this may not work with packages. Hence, this should be avoided.", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r475624794", "createdAt": "2020-08-24T13:53:10Z", "author": {"login": "chatman"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw=="}, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTc1Njg0Ng==", "bodyText": "why are we calling loader.newInstance directly instead of createHandler?\n\nI did this because createHandler also registers the handler to a path and initializes metrics. HealthCheckHandler currently is ran inside InfoHandler, so that's where the path is registered (and I guess the metrics are merged there). I didn't want to move to another path as part of this PR, don't know if that's needed. True that it looks a bit weird, but otherwise requires a bunch of changes to support compatibility.\n\nIf the intent here to use loader.newInstance is for pluggable implementations, then this may not work with packages. Hence, this should be avoided.\n\nI can handle that. I don't see any of the other top level handlers load from packages other than the built in (which is what loader.newInstance. What do you suggest?", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r475756846", "createdAt": "2020-08-24T16:53:38Z", "author": {"login": "tflobbe"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw=="}, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTgwMjczOQ==", "bodyText": "@chatman, looking a bit at the Packages code. Is the idea that we need to use PackageListeningClassLoader? That's not currently used in CoreContainer, and I only see it for loading schema plugins. Maybe I'm missing something. If none of the existing top level handlers can be loaded from packages, then we probably want to tackle that in a different Jira issue?", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r475802739", "createdAt": "2020-08-24T18:11:44Z", "author": {"login": "tflobbe"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw=="}, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzQzODk2OQ==", "bodyText": "... I did this because createHandler also registers the handler to a path and initializes metrics. HealthCheckHandler currently is ran inside InfoHandler, so that's where the path is registered (and I guess the metrics are merged there). ...\n\nI wonder if it would be helpful to have that as a comment in the code for future reference, the bit about not wishing to register to a path and initialise metrics.\nAs far as I can tell InfoHandler does not do any metric initialisation, so the health check handler would then be consistent with the other handlers whose path is registered in InfoHandler. Or maybe I'm missing how the metrics initialisation happens indirectly?", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r477438969", "createdAt": "2020-08-26T16:40:22Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw=="}, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxNjM3MQ==", "bodyText": "As far as I can tell InfoHandler does not do any metric initialisation,\n\nFrom what I can see, InfoHandler extends SolrMetricProducer, so a call to CoreContainer.createHandler  will initialize it (seems to be getting everything fromRequestHandlerBase\nbq. I wonder if it would be helpful to have that as a comment in the code for future reference, the bit about not wishing to register to a path and initialise metrics.\nWill do", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r477616371", "createdAt": "2020-08-26T22:07:04Z", "author": {"login": "tflobbe"}, "path": "solr/core/src/java/org/apache/solr/core/CoreContainer.java", "diffHunk": "@@ -719,6 +719,7 @@ public void load() {\n     createHandler(ZK_PATH, ZookeeperInfoHandler.class.getName(), ZookeeperInfoHandler.class);\n     createHandler(ZK_STATUS_PATH, ZookeeperStatusHandler.class.getName(), ZookeeperStatusHandler.class);\n     collectionsHandler = createHandler(COLLECTIONS_HANDLER_PATH, cfg.getCollectionsHandlerClass(), CollectionsHandler.class);\n+    healthCheckHandler = loader.newInstance(cfg.getHealthCheckHandlerClass(), HealthCheckHandler.class, null, new Class<?>[]{CoreContainer.class}, new Object[]{this});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTExODMxMw=="}, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MzEyMzcwOnYy", "diffSide": "RIGHT", "path": "solr/core/src/java/org/apache/solr/handler/admin/InfoHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNjo1N1rOHFhrrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMjoxNjo1N1rOHFhrrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU1Njc4Mw==", "bodyText": "throw new IllegalStateException(\"HealthCheckHandler needs to be initialized before creating InfoHandler\");\n\nHow about also having a \"HealthCheckHandler then InfoHandler order matters because ...\" style comment in CoreContainer?", "url": "https://github.com/apache/lucene-solr/pull/1774#discussion_r475556783", "createdAt": "2020-08-24T12:16:57Z", "author": {"login": "cpoerschke"}, "path": "solr/core/src/java/org/apache/solr/handler/admin/InfoHandler.java", "diffHunk": "@@ -50,7 +50,10 @@ public InfoHandler(final CoreContainer coreContainer) {\n     handlers.put(\"properties\", new PropertiesRequestHandler());\n     handlers.put(\"logging\", new LoggingHandler(coreContainer));\n     handlers.put(\"system\", new SystemInfoHandler(coreContainer));\n-    handlers.put(\"health\", new HealthCheckHandler(coreContainer));\n+    if (coreContainer.getHealthCheckHandler() == null) {\n+      throw new IllegalStateException(\"HealthCheckHandler needs to be initialized before creating InfoHandler\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ffaaf6c5466a874144f6b8b5b50fff9f543c284"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1319, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}