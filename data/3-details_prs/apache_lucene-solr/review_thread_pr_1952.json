{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTkwMjI0", "number": 1952, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowOTozMVrOEqyYNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNToxOFrOEq6JNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMzAxMDQ2OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNTowOTozMVrOHdMUsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoxMDowOFrOHdRv1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA==", "bodyText": "I don't think that this is good enough as we might be advancing ahead of scorerIterator? This was why I thought that we should instead wrap scorerIterator in such a way that its initial docID would be -1.", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500372658", "createdAt": "2020-10-06T15:09:31Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQxMjA2Mw==", "bodyText": "@jpountz  Addressed in cba6cf7", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500412063", "createdAt": "2020-10-06T15:54:29Z", "author": {"login": "mayya-sharipova"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA=="}, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ1MzE0MA==", "bodyText": "oh, I had not considered setting scorerIterator.docID() as a min docID, maybe this means that we no longer need the min parameter of RangeDISIWrapper?", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500453140", "createdAt": "2020-10-06T16:56:37Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA=="}, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2MTUyNg==", "bodyText": "Thanks @jpountz , addressed in d42c464", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500461526", "createdAt": "2020-10-06T17:10:08Z", "author": {"login": "mayya-sharipova"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -204,9 +204,14 @@ public int score(LeafCollector collector, Bits acceptDocs, int min, int max) thr\n       collector.setScorer(scorer);\n       DocIdSetIterator scorerIterator = twoPhase == null ? iterator : twoPhase.approximation();\n       DocIdSetIterator collectorIterator = collector.competitiveIterator();\n-      // if possible filter scorerIterator to keep only competitive docs as defined by collector\n-      DocIdSetIterator filteredIterator = collectorIterator == null ? scorerIterator :\n-          ConjunctionDISI.intersectIterators(Arrays.asList(scorerIterator, collectorIterator));\n+      DocIdSetIterator filteredIterator = scorerIterator;\n+      if (collectorIterator != null) {\n+        if (scorerIterator.docID() != -1) {\n+          collectorIterator.advance(scorerIterator.docID());\n+        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDM3MjY1OA=="}, "originalCommit": {"oid": "574245c96db19291138b2eb7253451b567c69d89"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzNDI4Mjc5OnYy", "diffSide": "RIGHT", "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMDoyNToxOFrOHdYohQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QwMjozNjo1N1rOHdgidQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDM0MQ==", "bodyText": "it just occurred to me that this implementation is not correct in the case that the minimum bound of the range of doc IDs to score is less than the current doc ID of the scorer, have you seen any failures with your change? I wonder that we would need to do\nif (target >= scorer.docID()) { return scorer.docID(); }\n\nbut we should create a test that fails without this", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500574341", "createdAt": "2020-10-06T20:25:18Z", "author": {"login": "jpountz"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -266,4 +274,45 @@ static void scoreAll(LeafCollector collector, DocIdSetIterator iterator, TwoPhas\n     }\n   }\n \n+  /**\n+   * Wraps an internal docIdSetIterator for it to start with docID = -1\n+   */\n+  protected static class RangeDISIWrapper extends DocIdSetIterator {\n+    private final DocIdSetIterator in;\n+    private final int min;\n+    private final int max;\n+    private int docID = -1;\n+\n+    public RangeDISIWrapper(DocIdSetIterator in, int max) {\n+      this.in = in;\n+      this.min = in.docID();\n+      this.max = max;\n+    }\n+\n+    @Override\n+    public int docID() {\n+      return docID;\n+    }\n+\n+    @Override\n+    public int nextDoc() throws IOException {\n+      return advance(docID + 1);\n+    }\n+\n+    @Override\n+    public int advance(int target) throws IOException {\n+      target = Math.max(min, target);\n+      if (target >= max) {\n+        return docID = NO_MORE_DOCS;\n+      }\n+      return docID = in.advance(target);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYwNDA5Mw==", "bodyText": "Indeed the recent failures on Lucene are because of this. ReqExclBulkScorer callsscore method several times and sometimes with the minimum bound that is <= scorer.docID().\nI am thinking the logic is becoming more difficult. I am thinking to go back to the initial commit and advance collectorIterator to the same doc as scorerIterator. At the beginning a  collectorIterator matches all docs, so it should precisely advance to the `scorerIterator.docID()).", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500604093", "createdAt": "2020-10-06T21:23:21Z", "author": {"login": "mayya-sharipova"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -266,4 +274,45 @@ static void scoreAll(LeafCollector collector, DocIdSetIterator iterator, TwoPhas\n     }\n   }\n \n+  /**\n+   * Wraps an internal docIdSetIterator for it to start with docID = -1\n+   */\n+  protected static class RangeDISIWrapper extends DocIdSetIterator {\n+    private final DocIdSetIterator in;\n+    private final int min;\n+    private final int max;\n+    private int docID = -1;\n+\n+    public RangeDISIWrapper(DocIdSetIterator in, int max) {\n+      this.in = in;\n+      this.min = in.docID();\n+      this.max = max;\n+    }\n+\n+    @Override\n+    public int docID() {\n+      return docID;\n+    }\n+\n+    @Override\n+    public int nextDoc() throws IOException {\n+      return advance(docID + 1);\n+    }\n+\n+    @Override\n+    public int advance(int target) throws IOException {\n+      target = Math.max(min, target);\n+      if (target >= max) {\n+        return docID = NO_MORE_DOCS;\n+      }\n+      return docID = in.advance(target);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDM0MQ=="}, "originalCommit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDYxNjU3MA==", "bodyText": "@jpountz  I've created a new PR: #1955.  So sorry for the mess.", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500616570", "createdAt": "2020-10-06T21:50:44Z", "author": {"login": "mayya-sharipova"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -266,4 +274,45 @@ static void scoreAll(LeafCollector collector, DocIdSetIterator iterator, TwoPhas\n     }\n   }\n \n+  /**\n+   * Wraps an internal docIdSetIterator for it to start with docID = -1\n+   */\n+  protected static class RangeDISIWrapper extends DocIdSetIterator {\n+    private final DocIdSetIterator in;\n+    private final int min;\n+    private final int max;\n+    private int docID = -1;\n+\n+    public RangeDISIWrapper(DocIdSetIterator in, int max) {\n+      this.in = in;\n+      this.min = in.docID();\n+      this.max = max;\n+    }\n+\n+    @Override\n+    public int docID() {\n+      return docID;\n+    }\n+\n+    @Override\n+    public int nextDoc() throws IOException {\n+      return advance(docID + 1);\n+    }\n+\n+    @Override\n+    public int advance(int target) throws IOException {\n+      target = Math.max(min, target);\n+      if (target >= max) {\n+        return docID = NO_MORE_DOCS;\n+      }\n+      return docID = in.advance(target);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDM0MQ=="}, "originalCommit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDcwMzg2MQ==", "bodyText": "@jpountz\n\nBy this if (target >= scorer.docID()) { return scorer.docID(); }\n\nDid you mean if (target <= scorer.docID()) { return scorer.docID(); } ?", "url": "https://github.com/apache/lucene-solr/pull/1952#discussion_r500703861", "createdAt": "2020-10-07T02:36:57Z", "author": {"login": "mayya-sharipova"}, "path": "lucene/core/src/java/org/apache/lucene/search/Weight.java", "diffHunk": "@@ -266,4 +274,45 @@ static void scoreAll(LeafCollector collector, DocIdSetIterator iterator, TwoPhas\n     }\n   }\n \n+  /**\n+   * Wraps an internal docIdSetIterator for it to start with docID = -1\n+   */\n+  protected static class RangeDISIWrapper extends DocIdSetIterator {\n+    private final DocIdSetIterator in;\n+    private final int min;\n+    private final int max;\n+    private int docID = -1;\n+\n+    public RangeDISIWrapper(DocIdSetIterator in, int max) {\n+      this.in = in;\n+      this.min = in.docID();\n+      this.max = max;\n+    }\n+\n+    @Override\n+    public int docID() {\n+      return docID;\n+    }\n+\n+    @Override\n+    public int nextDoc() throws IOException {\n+      return advance(docID + 1);\n+    }\n+\n+    @Override\n+    public int advance(int target) throws IOException {\n+      target = Math.max(min, target);\n+      if (target >= max) {\n+        return docID = NO_MORE_DOCS;\n+      }\n+      return docID = in.advance(target);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDU3NDM0MQ=="}, "originalCommit": {"oid": "d42c4649c81364f13c51c0b147dd600e57d7cccc"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1127, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}