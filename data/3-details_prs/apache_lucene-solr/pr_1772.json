{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjQ5MzQ2", "number": 1772, "title": "LUCENE-9473: Ensure merges are stopped during abort merges", "bodyText": "We need to disable merges while we wait for running merges since\nIW calls timed wait on it's lock that releases the monitor for the time\nbeing which allows new merges to be registered unless we disable them.", "createdAt": "2020-08-21T13:56:54Z", "url": "https://github.com/apache/lucene-solr/pull/1772", "merged": true, "mergeCommit": {"oid": "8480329213bd629e8a512d0ac675e0b9110bb786"}, "closed": true, "closedAt": "2020-08-24T07:15:42Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBFN7hAH2gAyNDcxNjQ5MzQ2Ojk3YWMyNGU3YzdlN2NjZjViZmZkMzQxZDczN2U4OGVlYjZlMzAwZjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB9ReDgH2gAyNDcxNjQ5MzQ2Ojc0YTRiM2E2NGI0ZWRiYTkxOGYwNzJhODQ2MTRiYjM2YjkyN2YxNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97ac24e7c7e7ccf5bffd341d737e88eeb6e300f3", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/97ac24e7c7e7ccf5bffd341d737e88eeb6e300f3", "committedDate": "2020-08-21T13:55:54Z", "message": "LUCENE-9473: Ensure merges are stopped during abort merges\n\nWe need to disable merges while we wait for running merges since\nIW calls timed wait on it's lock that releases the monitor for the time\nbeing which allows new merges to be registered unless we disable them."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69e85559b0b797dba2c8a4c3303e88e9111f0e77", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/69e85559b0b797dba2c8a4c3303e88e9111f0e77", "committedDate": "2020-08-21T13:57:31Z", "message": "fix imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTY2MjQ5", "url": "https://github.com/apache/lucene-solr/pull/1772#pullrequestreview-472566249", "createdAt": "2020-08-21T15:00:50Z", "commit": {"oid": "69e85559b0b797dba2c8a4c3303e88e9111f0e77"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNTowMDo1MFrOHEwqsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQxNTowMDo1MFrOHEwqsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDc1MzcxNA==", "bodyText": "I think this closed variable is not used?", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r474753714", "createdAt": "2020-08-21T15:00:50Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -5728,4 +5735,25 @@ public String toString() {\n       return writer.segString();\n     }\n   }\n+\n+  private class Merges {\n+    boolean closed = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69e85559b0b797dba2c8a4c3303e88e9111f0e77"}, "originalPosition": 104}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619", "committedDate": "2020-08-21T18:18:19Z", "message": "remove dead variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyOTgzNjc1", "url": "https://github.com/apache/lucene-solr/pull/1772#pullrequestreview-472983675", "createdAt": "2020-08-23T06:28:58Z", "commit": {"oid": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwNjoyODo1OFrOHFKjkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QwNjoyOTowM1rOHFKjmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE3Nzg3NA==", "bodyText": "Nice -- this forced merge-on-getReader/commit to be used more often in this test?", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r475177874", "createdAt": "2020-08-23T06:28:58Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriterDelete.java", "diffHunk": "@@ -300,10 +300,11 @@ public void testDeleteAllSimple() throws IOException {\n     modifier.close();\n     dir.close();\n   }\n-  \n+\n   public void testDeleteAllNoDeadLock() throws IOException, InterruptedException {\n     Directory dir = newDirectory();\n-    final RandomIndexWriter modifier = new RandomIndexWriter(random(), dir); \n+    final RandomIndexWriter modifier = new RandomIndexWriter(random(), dir,\n+        newIndexWriterConfig().setMergePolicy(new MockRandomMergePolicy(random())));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTE3Nzg4Mg==", "bodyText": "Aha, this is the meat of the change!  We need to be able to stop all running merges, but not prevent new merges.\nMaybe add a comment explaining this?  The code looks a little odd to abortMerges to only then merges.enable() in a finally clause.  The finally clause is necessary here because on exception we want to be certain to re-enable merges?  An exception during abortMerges is not tragic for IW right?  I.e. it can resume operations, and maybe not all docs were deleted?", "url": "https://github.com/apache/lucene-solr/pull/1772#discussion_r475177882", "createdAt": "2020-08-23T06:29:03Z", "author": {"login": "mikemccand"}, "path": "lucene/core/src/java/org/apache/lucene/index/IndexWriter.java", "diffHunk": "@@ -2427,7 +2426,13 @@ public long deleteAll() throws IOException {\n           synchronized (this) {\n             try {\n               // Abort any running merges\n-              abortMerges();\n+              try {\n+                abortMerges();\n+                assert merges.areEnabled() == false : \"merges should be disabled - who enabled them?\";\n+                assert mergingSegments.isEmpty() : \"found merging segments but merges are disabled: \" + mergingSegments;\n+              } finally {\n+                merges.enable();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c35998b3a24e3da9d9d1d2aaec3b6ca1473f619"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a4b3a64b4edba918f072a84614bb36b927f150", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/74a4b3a64b4edba918f072a84614bb36b927f150", "committedDate": "2020-08-24T07:14:27Z", "message": "add comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2392, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}