{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5NTA0ODE5", "number": 1830, "title": "LUCENE-9506: Gradle: split validateSourcePatterns into per-project an\u2026", "bodyText": "", "createdAt": "2020-09-04T09:33:51Z", "url": "https://github.com/apache/lucene-solr/pull/1830", "merged": true, "mergeCommit": {"oid": "b988d557d75d92f4378e98804261f6733f04378a"}, "closed": true, "closedAt": "2020-09-08T08:08:52Z", "author": {"login": "dweiss"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFh2f3gH2gAyNDc5NTA0ODE5OmJiMWFmY2E5Njg2YjYyMWZmYjc2MzY3NWU1MTRiNDhmZDY2NjcwYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGyxe8gH2gAyNDc5NTA0ODE5OmU3YTNmNTE5ZjQ2MTc3NzE4ZWE1MzE0Mzg4OGZjNWUyNzMyNDY4Yzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/bb1afca9686b621ffb763675e514b48fd66670a7", "committedDate": "2020-09-04T09:33:15Z", "message": "LUCENE-9506: Gradle: split validateSourcePatterns into per-project and root-specific tasks (allow parallelism)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyODUwODM3", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-482850837", "createdAt": "2020-09-04T17:59:17Z", "commit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNzo1OToxN1rOHNXM3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNzo1OToxN1rOHNXM3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc3MzY2MA==", "bodyText": "should the excludes be an input property so that we don't have to repeat them later on root project?", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483773660", "createdAt": "2020-09-04T17:59:17Z", "author": {"login": "madrob"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,117 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"*.${it}\"\n+      }\n+\n+      // default excludes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDUwOTE5", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483050919", "createdAt": "2020-09-05T11:59:13Z", "commit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxMTo1OToxM1rOHNhnQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQxMjowMzowNVrOHNhonw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDI1OA==", "bodyText": "this wont work in per directory setting -> remove\nsame for solr a bit down.", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944258", "createdAt": "2020-09-05T11:59:13Z", "author": {"login": "uschindler"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,117 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"*.${it}\"\n+      }\n+\n+      // default excludes.\n+      exclude \"$buildDir/**\"\n+      exclude '**/dist/**'\n+      exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow \"var\" on master\n+      exclude 'lucene/benchmark/work/**'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDM5MQ==", "bodyText": "But if the code does not fail, mabe remove the exclude (outdated?).", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944391", "createdAt": "2020-09-05T12:00:16Z", "author": {"login": "uschindler"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,117 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"*.${it}\"\n+      }\n+\n+      // default excludes.\n+      exclude \"$buildDir/**\"\n+      exclude '**/dist/**'\n+      exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow \"var\" on master\n+      exclude 'lucene/benchmark/work/**'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDI1OA=="}, "originalCommit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDQ4MQ==", "bodyText": "Cool!", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944481", "createdAt": "2020-09-05T12:01:23Z", "author": {"login": "uschindler"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -181,8 +252,13 @@ class ValidateSourcePatternsTask extends DefaultTask {\n       }\n     }\n \n+    ProgressLogger progress = progressLoggerFactory.newOperation(this.class)\n+    progress.start(this.name, this.name)\n+\n     sourceFiles.each{ f ->\n-      logger.debug('Scanning source file: {}', f);\n+      progress.progress(\"Scanning ${f.name}\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "originalPosition": 164}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzk0NDYwNw==", "bodyText": "I would keep this as debug or remove after adding the progress meter.\nI often try to run gradlew with --info, but theis is way too much information.\nDo you know how to silence the palantir version-lock checker? I hate that it prints so much information during configuration phase to info.\nI'd like to enable --info on jenkins, but that's way to much.", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r483944607", "createdAt": "2020-09-05T12:03:05Z", "author": {"login": "uschindler"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -181,8 +252,13 @@ class ValidateSourcePatternsTask extends DefaultTask {\n       }\n     }\n \n+    ProgressLogger progress = progressLoggerFactory.newOperation(this.class)\n+    progress.start(this.name, this.name)\n+\n     sourceFiles.each{ f ->\n-      logger.debug('Scanning source file: {}', f);\n+      progress.progress(\"Scanning ${f.name}\")\n+      logger.info('Scanning source file: {}', f);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzMDUxMzk4", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483051398", "createdAt": "2020-09-05T12:09:16Z", "commit": {"oid": "bb1afca9686b621ffb763675e514b48fd66670a7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58c6c15c8cade9d15bbac611d1f9d88838132762", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/58c6c15c8cade9d15bbac611d1f9d88838132762", "committedDate": "2020-09-07T09:36:40Z", "message": "cleanup excludes, fix file extension pattern"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4", "committedDate": "2020-09-07T21:23:24Z", "message": "Don't go into subprojects while scanning for files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzExODkw", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483711890", "createdAt": "2020-09-07T21:25:32Z", "commit": {"oid": "99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzEyMDAx", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483712001", "createdAt": "2020-09-07T21:26:12Z", "commit": {"oid": "99e571d1d7d1b87ee7c38a8f8c52d4fd5bccb5f4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987a6a593fcee9f0d6a80ae2103c7045bc74fd32", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/987a6a593fcee9f0d6a80ae2103c7045bc74fd32", "committedDate": "2020-09-07T21:30:09Z", "message": "Cleanup some excludes no longer needed with Gradle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "affe2c6c7b002e9b421092bd67f2c23481549117", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/affe2c6c7b002e9b421092bd67f2c23481549117", "committedDate": "2020-09-07T21:54:24Z", "message": "Merge branch 'master' of https://gitbox.apache.org/repos/asf/lucene-solr into LUCENE-9506"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ce69d368ae762b448aff163d54b466c907e1278", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/6ce69d368ae762b448aff163d54b466c907e1278", "committedDate": "2020-09-07T21:57:04Z", "message": "Ensure that *.md files are scanned everywhere"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e46266785f165cbe9e85b658757797b179c7358", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/9e46266785f165cbe9e85b658757797b179c7358", "committedDate": "2020-09-07T22:07:24Z", "message": "Move project-specific excludes to a separate project configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43866c75a6e84431e66e495453eddd5ce150cecc", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/43866c75a6e84431e66e495453eddd5ce150cecc", "committedDate": "2020-09-07T22:18:21Z", "message": "subproject -> child project"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c555db52b1284ee2b81c5548512476f5358a272e", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/c555db52b1284ee2b81c5548512476f5358a272e", "committedDate": "2020-09-07T22:24:33Z", "message": "Make per project check depend on \"validateLogCalls\" for consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba0b265cca69f010fc940f9801209d2753c06a43", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/ba0b265cca69f010fc940f9801209d2753c06a43", "committedDate": "2020-09-07T23:20:44Z", "message": "We have no xml-templates anymore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83aaa7def25e4bda9cffebc6a92e7ce08e2c0348", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/83aaa7def25e4bda9cffebc6a92e7ce08e2c0348", "committedDate": "2020-09-07T23:25:16Z", "message": "Set precommit dependency for each subproject"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/39d3e8fe7caecf82e81b53e024c38614b8af30fa", "committedDate": "2020-09-07T23:26:58Z", "message": "Remove obsolete precommit dependency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODIzMTgw", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483823180", "createdAt": "2020-09-08T06:18:20Z", "commit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoxODoyMFrOHOONOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoxODoyMFrOHOONOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3NDg3Mw==", "bodyText": "Yep, that should do it.", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484674873", "createdAt": "2020-09-08T06:18:20Z", "author": {"login": "dweiss"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,127 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'md',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n-        include \"*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n       }\n-      // TODO: For now we don't scan txt / md files, so we\n-      // check licenses in top-level folders separately:\n-      include '*.txt'\n-      include '*/*.txt'\n-      include '*.md'\n-      include '*/*.md'\n-      // excludes:\n+      \n+      // Don't go into child projects (scanned separately).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa"}, "originalPosition": 83}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzODI3Nzc5", "url": "https://github.com/apache/lucene-solr/pull/1830#pullrequestreview-483827779", "createdAt": "2020-09-08T06:28:07Z", "commit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoyODowN1rOHOOcZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQwNjoyODoyMVrOHOOcxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODc1OQ==", "bodyText": "I think we can leave the dependency on the root task as it depends on other source pattern validations. Or remove the snippet that connects them later.", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484678759", "createdAt": "2020-09-08T06:28:07Z", "author": {"login": "dweiss"}, "path": "gradle/validation/precommit.gradle", "diffHunk": "@@ -26,7 +26,6 @@ configure(rootProject) {\n     dependsOn \":verifyLocks\"\n     dependsOn \":versionsPropsAreSorted\"\n     dependsOn \":checkWorkingCopyClean\"\n-    dependsOn \":validateSourcePatterns\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDY3ODg1NQ==", "bodyText": "(here).", "url": "https://github.com/apache/lucene-solr/pull/1830#discussion_r484678855", "createdAt": "2020-09-08T06:28:21Z", "author": {"login": "dweiss"}, "path": "gradle/validation/validate-source-patterns.gradle", "diffHunk": "@@ -29,50 +33,127 @@ buildscript {\n   }\n }\n \n-configure(rootProject) {\n-  task(\"validateSourcePatterns\", type: ValidateSourcePatternsTask) { task ->\n+def extensions = [\n+    'adoc',\n+    'bat',\n+    'cmd',\n+    'css',\n+    'g4',\n+    'gradle',\n+    'groovy',\n+    'html',\n+    'java',\n+    'jflex',\n+    'jj',\n+    'js',\n+    'json',\n+    'md',\n+    'mdtext',\n+    'pl',\n+    'policy',\n+    'properties',\n+    'py',\n+    'sh',\n+    'template',\n+    'vm',\n+    'xml',\n+    'xsl',\n+]\n+\n+// Create source validation task local for each project's files.\n+subprojects {\n+  task validateSourcePatterns(type: ValidateSourcePatternsTask) { task ->\n     group = 'Verification'\n     description = 'Validate Source Patterns'\n \n     // This task has no proper outputs.\n     setupDummyOutputs(task)\n \n-    sourceFiles = project.fileTree(project.rootDir) {\n-      [\n-        'java', 'jflex', 'py', 'pl', 'g4', 'jj', 'html', 'js',\n-        'css', 'xml', 'xsl', 'vm', 'sh', 'cmd', 'bat', 'policy',\n-        'properties', 'mdtext', 'groovy', 'gradle',\n-        'template', 'adoc', 'json',\n-      ].each{\n-        include \"lucene/**/*.${it}\"\n-        include \"solr/**/*.${it}\"\n-        include \"dev-tools/**/*.${it}\"\n-        include \"gradle/**/*.${it}\"\n-        include \"*.${it}\"\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n       }\n-      // TODO: For now we don't scan txt / md files, so we\n-      // check licenses in top-level folders separately:\n-      include '*.txt'\n-      include '*/*.txt'\n-      include '*.md'\n-      include '*/*.md'\n-      // excludes:\n+      \n+      // Don't go into child projects (scanned separately).\n+      childProjects.keySet().each{\n+        exclude \"${it}/**\"\n+      }\n+\n+      // default excludes.\n+      exclude 'build/**'\n+    }\n+  }\n+\n+  // Add source validation to per-project checks as well.\n+  check.dependsOn validateSourcePatterns\n+}\n+\n+configure(project(':lucene:benchmark')) {\n+  project.tasks.withType(ValidateSourcePatternsTask) {\n+    sourceFiles.exclude 'temp/**'\n+    sourceFiles.exclude 'work/**'\n+  }\n+}\n+\n+configure(project(':solr:core')) {\n+  project.tasks.withType(ValidateSourcePatternsTask) {\n+    sourceFiles.exclude 'src/**/CheckLoggingConfiguration.java'\n+    sourceFiles.exclude 'src/test/org/apache/hadoop/**'\n+  }\n+}\n+\n+configure(rootProject) {\n+  task validateRootAndOtherFiles(type: ValidateSourcePatternsTask) { task ->\n+    // This task has no proper outputs.\n+    setupDummyOutputs(task)\n+\n+    sourceFiles = fileTree(projectDir) {\n+      extensions.each{\n+        include \"**/*.${it}\"\n+      }\n+\n+      // We do not scan for *.txt by default (broken files in subprojects),\n+      // but in root we can do this).\n+      include '**/*.txt'\n+\n+      // Don't go into child projects (scanned separately).\n+      childProjects.keySet().each{\n+        exclude \"${it}/**\"\n+      }\n+\n+      // default excludes.\n       exclude '**/build/**'\n-      exclude '**/dist/**'\n       exclude 'dev-tools/missing-doclet/src/**/*.java' // <-- TODO: remove once we allow \"var\" on master\n-      exclude 'lucene/benchmark/work/**'\n-      exclude 'lucene/benchmark/temp/**'\n-      exclude '**/CheckLoggingConfiguration.java'\n-      exclude 'solr/core/src/test/org/apache/hadoop/**'\n-      exclude '**/validate-source-patterns.gradle' // ourselves :-)\n+\n+      // ourselves :-)\n+      exclude 'gradle/validation/validate-source-patterns.gradle'\n     }\n   }\n+\n+  task validateSourcePatterns() {\n+    group = 'Verification'\n+    description = 'Validate Source Patterns'\n+\n+    // Make it depend on all so-named tasks from subprojects.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d3e8fe7caecf82e81b53e024c38614b8af30fa"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a6fb786ba9b5a8ebc667af2695aa3f8fc47b4d", "author": {"user": {"login": "dweiss", "name": "Dawid Weiss"}}, "url": "https://github.com/apache/lucene-solr/commit/26a6fb786ba9b5a8ebc667af2695aa3f8fc47b4d", "committedDate": "2020-09-08T07:04:19Z", "message": "Simplify task dependencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a3f519f46177718ea53143888fc5e2732468c7", "author": {"user": {"login": "uschindler", "name": "Uwe Schindler"}}, "url": "https://github.com/apache/lucene-solr/commit/e7a3f519f46177718ea53143888fc5e2732468c7", "committedDate": "2020-09-08T07:50:05Z", "message": "Move to more general type (we no longer need the basedir of the filetree)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2807, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}