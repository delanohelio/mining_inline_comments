{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMzQwNzk3", "number": 1764, "title": "Ensure we only rollback IW once", "bodyText": "Today we might rollback IW more than once if we hit an exception during\nthe rollback code when we shutdown. This change moves the rollback code outside\nof the try block to ensure we always roll back but never roll back twice.", "createdAt": "2020-08-19T18:35:16Z", "url": "https://github.com/apache/lucene-solr/pull/1764", "merged": true, "mergeCommit": {"oid": "5fcb859ecea6de2d69a601a09d3de3ee1cbcf1cc"}, "closed": true, "closedAt": "2020-08-20T06:40:26Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAW3JfgH2gAyNDcwMzQwNzk3OjFhMTJlMWY3ZjY0YTcxNzM2MDQyNGU0OWJjMzM4MmQ2OWZhMDhkOGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAqX_RgH2gAyNDcwMzQwNzk3OjljZjZmNGY1MTI2OWQ3YzBmMzdlZTRmYzc4ODNhODBlMDhhYjM1YTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a12e1f7f64a717360424e49bc3382d69fa08d8b", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/1a12e1f7f64a717360424e49bc3382d69fa08d8b", "committedDate": "2020-08-19T07:55:23Z", "message": "Ensure we only rollback IW once\n\nToday we might rollback IW more than once if we hit an exception during\nthe rollback code when we shutdown. This change moves the rollback code outside\nof the try block to ensure we always roll back but never roll back twice."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzQ1NTMz", "url": "https://github.com/apache/lucene-solr/pull/1764#pullrequestreview-470745533", "createdAt": "2020-08-19T18:49:30Z", "commit": {"oid": "1a12e1f7f64a717360424e49bc3382d69fa08d8b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNzUzODA3", "url": "https://github.com/apache/lucene-solr/pull/1764#pullrequestreview-470753807", "createdAt": "2020-08-19T19:01:52Z", "commit": {"oid": "1a12e1f7f64a717360424e49bc3382d69fa08d8b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOTowMTo1MlrOHDVL6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxOTowMTo1MlrOHDVL6g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzI1NDg5MA==", "bodyText": "why x ;)", "url": "https://github.com/apache/lucene-solr/pull/1764#discussion_r473254890", "createdAt": "2020-08-19T19:01:52Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriterExceptions.java", "diffHunk": "@@ -2023,4 +2023,44 @@ public void eval(MockDirectoryWrapper dir) throws IOException {\n \n     dir.close();\n   }\n+\n+\n+  public void testOnlyRollbackOnceOnException() throws IOException {\n+    AtomicBoolean once = new AtomicBoolean(false);\n+    InfoStream stream = new InfoStream() {\n+      @Override\n+      public void message(String component, String message) {\n+        if (\"TP\".equals(component) && \"rollback before checkpoint\".equals(message)) {\n+          if (once.compareAndSet(false, true)) {\n+            throw new RuntimeException(\"boom\");\n+          } else {\n+            throw new AssertionError(\"has been rolled back twice\");\n+          }\n+\n+        }\n+      }\n+\n+      @Override\n+      public boolean isEnabled(String component) {\n+        return \"TP\".equals(component);\n+      }\n+\n+      @Override\n+      public void close() {\n+      }\n+    };\n+    try (Directory dir = newDirectory()) {\n+      try (IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig().setInfoStream(stream)){\n+        @Override\n+        protected boolean isEnableTestPoints() {\n+          return true;\n+        }\n+      }) {\n+      }\n+    } catch (RuntimeException x) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a12e1f7f64a717360424e49bc3382d69fa08d8b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cf6f4f51269d7c0f37ee4fc7883a80e08ab35a8", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/9cf6f4f51269d7c0f37ee4fc7883a80e08ab35a8", "committedDate": "2020-08-20T06:39:27Z", "message": "why not e"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2380, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}