{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTc3Mjg3", "number": 1480, "title": "SOLR-14456: Fix Content-Type header forwarding on compressed requests", "bodyText": "Description\nHttpSolrCall and HttpSolrClient were using Content-Encoding header incorrectly, as they were setting the charset as the encoding for the request. This bug surfaces only when a Solr node is forwarding a request to another node and tries to forward the original headers.\nSolution\nAdjusted the behaviour to set the charset encoding as part of the Content-Type (as is specified by the HTTP standard) and Content-Encoding is now properly forwarded when available.\nTests\nRun the Solr test suites successfully but only from IntelliJ as from the terminal was failing everywhere (from lucene tests to some other random failures, even with badapples set to false).\nRegardin new/modified unit tests, none. Since the HttpSolrCall has no tests and this takes a really complicated setup to test it, I just wanted to verify that the introduced changes won't break existing suites. Of course I'm open to add them but I'd appreciate some direction on how to build such a test.\nChecklist\nPlease review the following and check all that apply:\n\n I have reviewed the guidelines for How to Contribute and my code conforms to the standards described there to the best of my ability.\n I have created a Jira issue and added the issue ID to my pull request title.\n I have given Solr maintainers access to contribute to my PR branch. (optional but recommended)\n I have developed this patch against the master branch.\n I have run ant precommit and the appropriate test suite.\n I have added tests for my changes.\n I have added documentation for the Ref Guide (for Solr changes only).", "createdAt": "2020-05-03T09:53:13Z", "url": "https://github.com/apache/lucene-solr/pull/1480", "merged": true, "mergeCommit": {"oid": "adddab9d1466675cd79fd06c37592000a56841d2"}, "closed": true, "closedAt": "2020-05-12T21:50:08Z", "author": {"login": "samuelgmartinez"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcdxhXsgBqjMyOTc4NDMwNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgpZ9JgH2gAyNDEyNTc3Mjg3OjM4NDM2NmM0YmI0ZGZhZmQzYWI3YmY1MTFjZjczODNiODIyNTcyNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98b55fccd617efd31166b4b338cb04c2e376ad0c", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/98b55fccd617efd31166b4b338cb04c2e376ad0c", "committedDate": "2020-05-03T09:00:42Z", "message": "SOLR-14456: Fix Content-Type header forwarding on compressed requests"}, "afterCommit": {"oid": "63544463fe9a007195c74ab3662fdea656dde6eb", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/63544463fe9a007195c74ab3662fdea656dde6eb", "committedDate": "2020-05-03T21:11:25Z", "message": "SOLR-14456: Fix Content-Type header forwarding on compressed requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95bf715b7731beaaf4797d27da8e360571f51212", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/95bf715b7731beaaf4797d27da8e360571f51212", "committedDate": "2020-05-05T21:19:24Z", "message": "SOLR-14456: Fix Content-Type header forwarding on compressed requests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "63544463fe9a007195c74ab3662fdea656dde6eb", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/63544463fe9a007195c74ab3662fdea656dde6eb", "committedDate": "2020-05-03T21:11:25Z", "message": "SOLR-14456: Fix Content-Type header forwarding on compressed requests"}, "afterCommit": {"oid": "0d68038eb5eba072880eef4fcebda144367487ae", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/0d68038eb5eba072880eef4fcebda144367487ae", "committedDate": "2020-05-05T21:40:25Z", "message": "SOLR-14456: Refactor HTTP2 client to use ContentType header parsing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "362178a46edd2119813a586ac16c6f833cce8ebe", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/362178a46edd2119813a586ac16c6f833cce8ebe", "committedDate": "2020-05-06T18:22:48Z", "message": "SOLR-14456: Refactor HTTP2 client to use ContentType header parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d68038eb5eba072880eef4fcebda144367487ae", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/0d68038eb5eba072880eef4fcebda144367487ae", "committedDate": "2020-05-05T21:40:25Z", "message": "SOLR-14456: Refactor HTTP2 client to use ContentType header parsing"}, "afterCommit": {"oid": "362178a46edd2119813a586ac16c6f833cce8ebe", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/362178a46edd2119813a586ac16c6f833cce8ebe", "committedDate": "2020-05-06T18:22:48Z", "message": "SOLR-14456: Refactor HTTP2 client to use ContentType header parsing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTcwMjMx", "url": "https://github.com/apache/lucene-solr/pull/1480#pullrequestreview-406970231", "createdAt": "2020-05-06T20:41:10Z", "commit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo0MToxMVrOGRkl-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo0MToxMVrOGRkl-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3ODUyMg==", "bodyText": "I would recommend setting charset to FALLBACK_CHARSET if it's null here, and setting the charsetName afterwards.  You have potential for some nullPointerExceptions below. such as on lines 626 and 634", "url": "https://github.com/apache/lucene-solr/pull/1480#discussion_r421078522", "createdAt": "2020-05-06T20:41:11Z", "author": {"login": "HoustonPutman"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java", "diffHunk": "@@ -568,12 +568,18 @@ private HttpEntityEnclosingRequestBase fillContentStream(SolrRequest request, Co\n       // Read the contents\n       entity = response.getEntity();\n       respBody = entity.getContent();\n-      Header ctHeader = response.getLastHeader(\"content-type\");\n-      String contentType;\n-      if (ctHeader != null) {\n-        contentType = ctHeader.getValue();\n-      } else {\n-        contentType = \"\";\n+      String mimeType = null;\n+      Charset charset = null;\n+      String charsetName = null;\n+\n+      ContentType contentType = ContentType.get(entity);\n+      if (contentType != null) {\n+        mimeType = contentType.getMimeType().trim().toLowerCase(Locale.ROOT);\n+        charset = contentType.getCharset();\n+\n+        if (charset != null) {\n+          charsetName = charset.name();\n+        }\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794"}, "originalPosition": 56}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/3db86573385d0d79787d1b8f68fcfa6634068794", "committedDate": "2020-05-06T19:29:44Z", "message": "SOLR-14456: Rearrange imports for Solr Http client unit tests"}, "afterCommit": {"oid": "429bfb15f1b883b818564832d6a0223b0ed524fd", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/429bfb15f1b883b818564832d6a0223b0ed524fd", "committedDate": "2020-05-08T21:19:40Z", "message": "SOLR-14456: Rearrange imports for Solr Http client unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7210e82f690f33191640a44eca31ecc1af0d6753", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/7210e82f690f33191640a44eca31ecc1af0d6753", "committedDate": "2020-05-08T21:52:00Z", "message": "SOLR-14456: Rearrange imports for Solr Http client unit tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "429bfb15f1b883b818564832d6a0223b0ed524fd", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/429bfb15f1b883b818564832d6a0223b0ed524fd", "committedDate": "2020-05-08T21:19:40Z", "message": "SOLR-14456: Rearrange imports for Solr Http client unit tests"}, "afterCommit": {"oid": "7210e82f690f33191640a44eca31ecc1af0d6753", "author": {"user": {"login": "samuelgmartinez", "name": "Samuel Garc\u00eda Mart\u00ednez"}}, "url": "https://github.com/apache/lucene-solr/commit/7210e82f690f33191640a44eca31ecc1af0d6753", "committedDate": "2020-05-08T21:52:00Z", "message": "SOLR-14456: Rearrange imports for Solr Http client unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69144b605b569e4cb2635d7f8e4eb04c3cc46bce", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/69144b605b569e4cb2635d7f8e4eb04c3cc46bce", "committedDate": "2020-05-11T22:15:51Z", "message": "Update location of CHANGES.txt entry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68bf5a58da0237313346d6377def5abdc8daccb4", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/68bf5a58da0237313346d6377def5abdc8daccb4", "committedDate": "2020-05-11T22:16:50Z", "message": "Merge branch 'master' into bugfix/SOLR-14456"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384366c4bb4dfafd3ab7bf511cf7383b82257259", "author": {"user": {"login": "HoustonPutman", "name": "Houston Putman"}}, "url": "https://github.com/apache/lucene-solr/commit/384366c4bb4dfafd3ab7bf511cf7383b82257259", "committedDate": "2020-05-12T19:26:07Z", "message": "Merge branch 'master' into bugfix/SOLR-14456"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2673, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}