{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAyMzg3NDk1", "number": 1427, "title": "LUCENE-9304: Fix IW#getMaxCompletedSequenceNumber() ", "bodyText": "After recent refactorings on LUCENE-9304 IW#getMaxCompletedSequenceNumber() might return values that belong to non-completed operations if a full flush is running, a new delete queue is already in place but not all DWPTs that participate in the full flush have finished it's in-flight operation. This caused rare failures in TestControlledRealTimeReopenThread#testControlledRealTimeReopenThread were documents are not actually visible given the max completed seqNo. This change streamlines the delete queue advance, adds a dedicated testcase and ensures that a delete queues sequence Id space is never exhausted.", "createdAt": "2020-04-12T19:31:43Z", "url": "https://github.com/apache/lucene-solr/pull/1427", "merged": true, "mergeCommit": {"oid": "18af6325ed98b50c23a1f026ab9d05f17039c731"}, "closed": true, "closedAt": "2020-04-14T17:39:24Z", "author": {"login": "s1monw"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcW3g8tgH2gAyNDAyMzg3NDk1Ojg2ZmIzNGQ0ODQwMzUxNDczOWVlNmNiMTE4ODQ1Y2I0YjVlYTU2MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXgCQZAH2gAyNDAyMzg3NDk1OjAyMTdkNGM3YzhjODI0MzkzNmQ4OTQ2YjA4YTY4ZjM5NTE1N2IyZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86fb34d48403514739ee6cb118845cb4b5ea5631", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/86fb34d48403514739ee6cb118845cb4b5ea5631", "committedDate": "2020-04-12T10:13:11Z", "message": "fist cut"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4f2892e6b9b44e9dbd3e62b5f98e951d2b97212", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/b4f2892e6b9b44e9dbd3e62b5f98e951d2b97212", "committedDate": "2020-04-12T13:51:37Z", "message": "fixed it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fe912951ad84204513e6f9d6e1271e01b2ea94e", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/5fe912951ad84204513e6f9d6e1271e01b2ea94e", "committedDate": "2020-04-12T19:18:29Z", "message": "progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/b82ee712a262013effaa4d17b5d94a83a7006d7e", "committedDate": "2020-04-13T11:46:01Z", "message": "Merge branch 'master' into fix_max_seq_id"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNTkzMTcw", "url": "https://github.com/apache/lucene-solr/pull/1427#pullrequestreview-392593170", "createdAt": "2020-04-14T04:20:04Z", "commit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNDoyMDowNFrOGE9plw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwNDo1MDoxOFrOGE-IXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1NzU1OQ==", "bodyText": "maybe use updateAndGet instead of loop.", "url": "https://github.com/apache/lucene-solr/pull/1427#discussion_r407857559", "createdAt": "2020-04-14T04:20:04Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -3949,4 +3950,69 @@ public void testRandomOperationsWithSoftDeletes() throws Exception {\n       }\n     }\n   }\n+\n+  public void testMaxCompletedSequenceNumber() throws IOException, InterruptedException {\n+    try (Directory dir = newDirectory();\n+         IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig());) {\n+      assertEquals(1, writer.addDocument(new Document()));\n+      assertEquals(2, writer.updateDocument(new Term(\"foo\", \"bar\"), new Document()));\n+      writer.flushNextBuffer();\n+      assertEquals(3, writer.commit());\n+      assertEquals(4, writer.addDocument(new Document()));\n+      assertEquals(4, writer.getMaxCompletedSequenceNumber());\n+      // commit moves seqNo by 2 since there is one DWPT that could still be in-flight\n+      assertEquals(6, writer.commit());\n+      assertEquals(6, writer.getMaxCompletedSequenceNumber());\n+      assertEquals(7, writer.addDocument(new Document()));\n+      writer.getReader().close();\n+      // getReader moves seqNo by 2 since there is one DWPT that could still be in-flight\n+      assertEquals(9, writer.getMaxCompletedSequenceNumber());\n+    }\n+    try (Directory dir = newDirectory();\n+         IndexWriter writer = new IndexWriter(dir, newIndexWriterConfig());\n+         SearcherManager manager = new SearcherManager(writer, new SearcherFactory())) {\n+      CountDownLatch start = new CountDownLatch(1);\n+      int numDocs = 100 + random().nextInt(500);\n+      AtomicLong maxCompletedSeqID = new AtomicLong(-1);\n+      Thread[] threads = new Thread[2 + random().nextInt(2)];\n+      for (int i = 0; i < threads.length; i++) {\n+        int idx = i;\n+        threads[i] = new Thread(() -> {\n+          try {\n+            start.await();\n+            for (int j = 0; j < numDocs; j++) {\n+              Document doc = new Document();\n+              String id = idx +\"-\"+j;\n+              doc.add(new StringField(\"id\", id, Field.Store.NO));\n+              long seqNo = writer.addDocument(doc);\n+              if (maxCompletedSeqID.get() < seqNo) {\n+                long maxCompletedSequenceNumber = writer.getMaxCompletedSequenceNumber();\n+                manager.maybeRefreshBlocking();\n+                long prevValue;\n+                while ((prevValue = maxCompletedSeqID.get()) < maxCompletedSequenceNumber) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg1Nzk2NQ==", "bodyText": "s/the the/the", "url": "https://github.com/apache/lucene-solr/pull/1427#discussion_r407857965", "createdAt": "2020-04-14T04:21:48Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java", "diffHunk": "@@ -538,17 +546,65 @@ public String toString() {\n \n   public long getNextSequenceNumber() {\n     long seqNo = nextSeqNo.getAndIncrement();\n-    assert seqNo < maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n+    assert seqNo <= maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n     return seqNo;\n   }  \n \n-  public long getLastSequenceNumber() {\n+  long getLastSequenceNumber() {\n     return nextSeqNo.get()-1;\n   }  \n \n   /** Inserts a gap in the sequence numbers.  This is used by IW during flush or commit to ensure any in-flight threads get sequence numbers\n    *  inside the gap */\n-  public void skipSequenceNumbers(long jump) {\n+  void skipSequenceNumbers(long jump) {\n     nextSeqNo.addAndGet(jump);\n-  }  \n+  }\n+\n+  /**\n+   * Returns the maximum completed seq no for this queue.\n+   */\n+  long getMaxCompletedSeqNo() {\n+    if (startSeqNo < nextSeqNo.get()) {\n+      return getLastSequenceNumber();\n+    } else {\n+      // if we haven't advanced the seqNo make sure we fall back to the previous queue\n+      long value = previousMaxSeqId.getAsLong();\n+      assert value <= startSeqNo : \"illegal max sequence ID: \" + value + \" start was: \" + startSeqNo;\n+      return value;\n+    }\n+  }\n+\n+  /**\n+   * Advances the queue to the next queue on flush. This carries over the the generation to the next queue and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg2MTEzOA==", "bodyText": "I ran the second part of this test without the fix several thousand iterations, but all of them passed. It would be great if this test can reproduce the current issue.", "url": "https://github.com/apache/lucene-solr/pull/1427#discussion_r407861138", "createdAt": "2020-04-14T04:33:48Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/test/org/apache/lucene/index/TestIndexWriter.java", "diffHunk": "@@ -3949,4 +3950,69 @@ public void testRandomOperationsWithSoftDeletes() throws Exception {\n       }\n     }\n   }\n+\n+  public void testMaxCompletedSequenceNumber() throws IOException, InterruptedException {\n+    try (Directory dir = newDirectory();\n+         IndexWriter writer = new IndexWriter(dir, new IndexWriterConfig());) {\n+      assertEquals(1, writer.addDocument(new Document()));\n+      assertEquals(2, writer.updateDocument(new Term(\"foo\", \"bar\"), new Document()));\n+      writer.flushNextBuffer();\n+      assertEquals(3, writer.commit());\n+      assertEquals(4, writer.addDocument(new Document()));\n+      assertEquals(4, writer.getMaxCompletedSequenceNumber());\n+      // commit moves seqNo by 2 since there is one DWPT that could still be in-flight\n+      assertEquals(6, writer.commit());\n+      assertEquals(6, writer.getMaxCompletedSequenceNumber());\n+      assertEquals(7, writer.addDocument(new Document()));\n+      writer.getReader().close();\n+      // getReader moves seqNo by 2 since there is one DWPT that could still be in-flight\n+      assertEquals(9, writer.getMaxCompletedSequenceNumber());\n+    }\n+    try (Directory dir = newDirectory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg2NDY1NQ==", "bodyText": "I think we can harden the assertion as value should always be smaller than startSeqNo.", "url": "https://github.com/apache/lucene-solr/pull/1427#discussion_r407864655", "createdAt": "2020-04-14T04:47:20Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java", "diffHunk": "@@ -538,17 +546,65 @@ public String toString() {\n \n   public long getNextSequenceNumber() {\n     long seqNo = nextSeqNo.getAndIncrement();\n-    assert seqNo < maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n+    assert seqNo <= maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n     return seqNo;\n   }  \n \n-  public long getLastSequenceNumber() {\n+  long getLastSequenceNumber() {\n     return nextSeqNo.get()-1;\n   }  \n \n   /** Inserts a gap in the sequence numbers.  This is used by IW during flush or commit to ensure any in-flight threads get sequence numbers\n    *  inside the gap */\n-  public void skipSequenceNumbers(long jump) {\n+  void skipSequenceNumbers(long jump) {\n     nextSeqNo.addAndGet(jump);\n-  }  \n+  }\n+\n+  /**\n+   * Returns the maximum completed seq no for this queue.\n+   */\n+  long getMaxCompletedSeqNo() {\n+    if (startSeqNo < nextSeqNo.get()) {\n+      return getLastSequenceNumber();\n+    } else {\n+      // if we haven't advanced the seqNo make sure we fall back to the previous queue\n+      long value = previousMaxSeqId.getAsLong();\n+      assert value <= startSeqNo : \"illegal max sequence ID: \" + value + \" start was: \" + startSeqNo;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzg2NTQzOA==", "bodyText": "Should () -> nextSeqNo.get() - 1 be this:: getMaxCompletedSeqNo instead?", "url": "https://github.com/apache/lucene-solr/pull/1427#discussion_r407865438", "createdAt": "2020-04-14T04:50:18Z", "author": {"login": "dnhatn"}, "path": "lucene/core/src/java/org/apache/lucene/index/DocumentsWriterDeleteQueue.java", "diffHunk": "@@ -538,17 +546,65 @@ public String toString() {\n \n   public long getNextSequenceNumber() {\n     long seqNo = nextSeqNo.getAndIncrement();\n-    assert seqNo < maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n+    assert seqNo <= maxSeqNo: \"seqNo=\" + seqNo + \" vs maxSeqNo=\" + maxSeqNo;\n     return seqNo;\n   }  \n \n-  public long getLastSequenceNumber() {\n+  long getLastSequenceNumber() {\n     return nextSeqNo.get()-1;\n   }  \n \n   /** Inserts a gap in the sequence numbers.  This is used by IW during flush or commit to ensure any in-flight threads get sequence numbers\n    *  inside the gap */\n-  public void skipSequenceNumbers(long jump) {\n+  void skipSequenceNumbers(long jump) {\n     nextSeqNo.addAndGet(jump);\n-  }  \n+  }\n+\n+  /**\n+   * Returns the maximum completed seq no for this queue.\n+   */\n+  long getMaxCompletedSeqNo() {\n+    if (startSeqNo < nextSeqNo.get()) {\n+      return getLastSequenceNumber();\n+    } else {\n+      // if we haven't advanced the seqNo make sure we fall back to the previous queue\n+      long value = previousMaxSeqId.getAsLong();\n+      assert value <= startSeqNo : \"illegal max sequence ID: \" + value + \" start was: \" + startSeqNo;\n+      return value;\n+    }\n+  }\n+\n+  /**\n+   * Advances the queue to the next queue on flush. This carries over the the generation to the next queue and\n+   * set the {@link #getMaxSeqNo()} based on the given maxNumPendingOps. This method can only be called once, subsequently\n+   * the returned queue should be used.\n+   * @param maxNumPendingOps the max number of possible concurrent operations that will execute on this queue after\n+   *                         it was advanced. This corresponds the the number of DWPTs that own the current queue at the\n+   *                         moment when this queue is advanced since each these DWPTs can increment the seqId after we\n+   *                         advanced it.\n+   * @return a new queue as a successor of this queue.\n+   */\n+  synchronized DocumentsWriterDeleteQueue advanceQueue(int maxNumPendingOps) {\n+    if (advanced) {\n+      throw new IllegalStateException(\"queue was already advanced\");\n+    }\n+    advanced = true;\n+    long seqNo = getLastSequenceNumber() + maxNumPendingOps + 1;\n+    maxSeqNo = seqNo;\n+    return new DocumentsWriterDeleteQueue(infoStream, generation + 1, seqNo + 1, () -> nextSeqNo.get() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b82ee712a262013effaa4d17b5d94a83a7006d7e"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3674ad67c8c1a7a819ce381edff19595aa715c06", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/3674ad67c8c1a7a819ce381edff19595aa715c06", "committedDate": "2020-04-14T09:01:51Z", "message": "add better testcase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad5fd1fcd23850506ab8c6854a47fa80120f935", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/bad5fd1fcd23850506ab8c6854a47fa80120f935", "committedDate": "2020-04-14T09:15:45Z", "message": "apply review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0217d4c7c8c8243936d8946b08a68f395157b2f2", "author": {"user": {"login": "s1monw", "name": "Simon Willnauer"}}, "url": "https://github.com/apache/lucene-solr/commit/0217d4c7c8c8243936d8946b08a68f395157b2f2", "committedDate": "2020-04-14T09:25:46Z", "message": "foo"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2097, "cost": 1, "resetAt": "2021-10-29T19:57:52Z"}}}