{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNTc3Mjg3", "number": 1480, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo0MToxMVrOD5_M6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo0MToxMVrOD5_M6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMTMwOTIzOnYy", "diffSide": "RIGHT", "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDo0MToxMVrOGRkl-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMzoxNjoyNVrOGRou7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3ODUyMg==", "bodyText": "I would recommend setting charset to FALLBACK_CHARSET if it's null here, and setting the charsetName afterwards.  You have potential for some nullPointerExceptions below. such as on lines 626 and 634", "url": "https://github.com/apache/lucene-solr/pull/1480#discussion_r421078522", "createdAt": "2020-05-06T20:41:11Z", "author": {"login": "HoustonPutman"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java", "diffHunk": "@@ -568,12 +568,18 @@ private HttpEntityEnclosingRequestBase fillContentStream(SolrRequest request, Co\n       // Read the contents\n       entity = response.getEntity();\n       respBody = entity.getContent();\n-      Header ctHeader = response.getLastHeader(\"content-type\");\n-      String contentType;\n-      if (ctHeader != null) {\n-        contentType = ctHeader.getValue();\n-      } else {\n-        contentType = \"\";\n+      String mimeType = null;\n+      Charset charset = null;\n+      String charsetName = null;\n+\n+      ContentType contentType = ContentType.get(entity);\n+      if (contentType != null) {\n+        mimeType = contentType.getMimeType().trim().toLowerCase(Locale.ROOT);\n+        charset = contentType.getCharset();\n+\n+        if (charset != null) {\n+          charsetName = charset.name();\n+        }\n       }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjU4Ng==", "bodyText": "I made the change already and was about to push it when I just wondered if it's the right decision. Here is my thinking:\n\nThe 626 log line wouldn't cause an NPE but just concat null. I agree that it should not be like that and should log a proper value.\nI'm afraid of taking the decision of the default encoding in this class as 'null' encoding for most operations would mean: \"either default on Charset.defaultCharset() or take the decision yourself based on whatever you know you are parsing\", specially regarding the ResponseParsers.\n\nFor example, the Json parser is defaulting to UTF-8 when the encoding is passed as null, but it could be that any other parser defaults to JVM file.encoding or an XML parser defaults to ISO-8859-1. In the original PR I just replaced the hardcoded references to UTF-8 to the properly referenced FALLBACK_CHARSET, while I kept the response's original encoding (whether it's null or not) usages; like the one in line 634, processor.processResponse is passing null in the original code also.\nDo you think that we can safely take the decision at this component layer (and hardcoded it to UTF-8) instead of delegating it to the ResponseParsers?", "url": "https://github.com/apache/lucene-solr/pull/1480#discussion_r421106586", "createdAt": "2020-05-06T21:35:02Z", "author": {"login": "samuelgmartinez"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java", "diffHunk": "@@ -568,12 +568,18 @@ private HttpEntityEnclosingRequestBase fillContentStream(SolrRequest request, Co\n       // Read the contents\n       entity = response.getEntity();\n       respBody = entity.getContent();\n-      Header ctHeader = response.getLastHeader(\"content-type\");\n-      String contentType;\n-      if (ctHeader != null) {\n-        contentType = ctHeader.getValue();\n-      } else {\n-        contentType = \"\";\n+      String mimeType = null;\n+      Charset charset = null;\n+      String charsetName = null;\n+\n+      ContentType contentType = ContentType.get(entity);\n+      if (contentType != null) {\n+        mimeType = contentType.getMimeType().trim().toLowerCase(Locale.ROOT);\n+        charset = contentType.getCharset();\n+\n+        if (charset != null) {\n+          charsetName = charset.name();\n+        }\n       }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3ODUyMg=="}, "originalCommit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTE0NjM0OA==", "bodyText": "That's completely fair. We don't want to dictate the default for each response parser. If you fixed that logging line, I think that's enough. It'd be nice to have UTF8 instead of null", "url": "https://github.com/apache/lucene-solr/pull/1480#discussion_r421146348", "createdAt": "2020-05-06T23:16:25Z", "author": {"login": "HoustonPutman"}, "path": "solr/solrj/src/java/org/apache/solr/client/solrj/impl/HttpSolrClient.java", "diffHunk": "@@ -568,12 +568,18 @@ private HttpEntityEnclosingRequestBase fillContentStream(SolrRequest request, Co\n       // Read the contents\n       entity = response.getEntity();\n       respBody = entity.getContent();\n-      Header ctHeader = response.getLastHeader(\"content-type\");\n-      String contentType;\n-      if (ctHeader != null) {\n-        contentType = ctHeader.getValue();\n-      } else {\n-        contentType = \"\";\n+      String mimeType = null;\n+      Charset charset = null;\n+      String charsetName = null;\n+\n+      ContentType contentType = ContentType.get(entity);\n+      if (contentType != null) {\n+        mimeType = contentType.getMimeType().trim().toLowerCase(Locale.ROOT);\n+        charset = contentType.getCharset();\n+\n+        if (charset != null) {\n+          charsetName = charset.name();\n+        }\n       }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3ODUyMg=="}, "originalCommit": {"oid": "3db86573385d0d79787d1b8f68fcfa6634068794"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1508, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}