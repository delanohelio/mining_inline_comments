{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNjEzNTMw", "number": 34, "title": "fix: stop sending RPCs to deleted database", "bodyText": "DatabaseClients should not continue to try to send RPCs to a database that has been deleted. Instead, the session pool will keep track of whether a DatabaseNotFound error has been returned for a database, and if so, will invalidate itself. All subsequent calls for this database will return a DatabaseNotFoundException without calling a RPC.\nIf a database is re-created, the user must create a new DatabaseClient with a new session pool in order to resume usage of the database.\nFixes #16", "createdAt": "2020-01-14T12:40:00Z", "url": "https://github.com/googleapis/java-spanner/pull/34", "merged": true, "mergeCommit": {"oid": "11e4a90e73af8a5baf9aa593daa6192520363398"}, "closed": true, "closedAt": "2020-01-22T06:40:08Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6R4c7gBqjI5NDcyODYyNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8vlcGgBqjI5Njg4MTUzODY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "842c2f735de7c4ca359e83a951e9170b70b64966", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/842c2f735de7c4ca359e83a951e9170b70b64966", "committedDate": "2020-01-14T12:33:39Z", "message": "fix: client should stop sending rpcs after database dropped\n\nDatabaseClients should not continue to try to send RPCs to a database that has\nbeen deleted. Instead, the session pool will keep track of whether a database\nnot found error has been returned for a database, and if so, will invalidate\nitself. All subsequent calls for this database will return a DatabaseNotFoundException\nwithout calling a RPC.\n\nIf a database is re-created, the user must create a new DatabaseClient with a new\nsession pool in order to resume usage of the database.\n\nFixes #16"}, "afterCommit": {"oid": "2a5f71ee1ce117e57c0843e9a34f36375a1ff8d1", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2a5f71ee1ce117e57c0843e9a34f36375a1ff8d1", "committedDate": "2020-01-14T14:32:25Z", "message": "fix: remove double check on isValid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzM1NDky", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-344335492", "createdAt": "2020-01-17T02:36:33Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjozNjozM1rOFetYOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjozNjozM1rOFetYOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0NTA4MQ==", "bodyText": "nits: use else if?", "url": "https://github.com/googleapis/java-spanner/pull/34#discussion_r367745081", "createdAt": "2020-01-17T02:36:33Z", "author": {"login": "hengfengli"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -775,6 +776,15 @@ public void close() {\n       if (lastException != null && isSessionNotFound(lastException)) {\n         invalidateSession(this);\n       } else {\n+        if (lastException != null && isDatabaseNotFound(lastException)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzM3ODQ1", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-344337845", "createdAt": "2020-01-17T02:47:19Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjo0NzoxOVrOFetf_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMjo0NzoxOVrOFetf_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc0NzA2OA==", "bodyText": "Why use a regex matching instead of message.contains()? I mean that it is very sensitive to any small text/format change in the message.", "url": "https://github.com/googleapis/java-spanner/pull/34#discussion_r367747068", "createdAt": "2020-01-17T02:47:19Z", "author": {"login": "hengfengli"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SpannerExceptionFactory.java", "diffHunk": "@@ -176,6 +182,8 @@ private static SpannerException newSpannerExceptionPreformatted(\n       case NOT_FOUND:\n         if (message != null && message.contains(\"Session not found\")) {\n           return new SessionNotFoundException(token, message, cause);\n+        } else if (message != null && DATABASE_NOT_FOUND_MSG_PATTERN.matcher(message).matches()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzQyMDcz", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-344342073", "createdAt": "2020-01-17T03:07:08Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMzowNzowOVrOFettew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMzowNzowOVrOFettew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc1MDUyMw==", "bodyText": "nits: I feel that a hardcoded message is more clear here, because if the message in the code has been mistakenly changed, this test will let it pass instead of finding out the difference.", "url": "https://github.com/googleapis/java-spanner/pull/34#discussion_r367750523", "createdAt": "2020-01-17T03:07:09Z", "author": {"login": "hengfengli"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/DatabaseClientImplTest.java", "diffHunk": "@@ -51,8 +51,21 @@\n \n @RunWith(JUnit4.class)\n public class DatabaseClientImplTest {\n-  private static final String DATABASE_DOES_NOT_EXIST_MSG =\n-      \"Database not found: projects/<project>/instances/<instance>/databases/<database> resource_type: \\\"type.googleapis.com/google.spanner.admin.database.v1.Database\\\" resource_name: \\\"projects/<project>/instances/<instance>/databases/<database>\\\" description: \\\"Database does not exist.\\\"\";\n+  private static final String DATABASE_NOT_FOUND_FORMAT =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzQ3NDcy", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-344347472", "createdAt": "2020-01-17T03:32:35Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMzozMjozNVrOFet_8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwMzozMjozNVrOFet_8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzc1NTI0OA==", "bodyText": "I guess we should break the while here once we get the error.", "url": "https://github.com/googleapis/java-spanner/pull/34#discussion_r367755248", "createdAt": "2020-01-17T03:32:35Z", "author": {"login": "hengfengli"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITDatabaseTest.java", "diffHunk": "@@ -43,4 +54,68 @@ public void badDdl() {\n \n     env.getTestHelper().createTestDatabase(\"CREATE TABLE T ( Illegal Way To Define A Table )\");\n   }\n+\n+  @Test\n+  public void databaseDeletedTest() throws Exception {\n+    // Create a test db, do a query, then delete it and verify that it returns\n+    // DatabaseNotFoundExceptions.\n+    Database db = env.getTestHelper().createTestDatabase();\n+    DatabaseClient client = env.getTestHelper().getClient().getDatabaseClient(db.getId());\n+    try (ResultSet rs = client.singleUse().executeQuery(Statement.of(\"SELECT 1\"))) {\n+      assertThat(rs.next()).isTrue();\n+      assertThat(rs.getLong(0)).isEqualTo(1L);\n+      assertThat(rs.next()).isFalse();\n+    }\n+\n+    // Delete the database.\n+    db.drop();\n+    // We need to wait a little before Spanner actually starts sending DatabaseNotFound errors.\n+    ExponentialBackOff backoff =\n+        new ExponentialBackOff.Builder()\n+            .setInitialIntervalMillis(1000)\n+            .setMaxElapsedTimeMillis(35000)\n+            .setMaxIntervalMillis(5000)\n+            .build();\n+    DatabaseNotFoundException notFoundException = null;\n+    long millis = 0L;\n+    while ((millis = backoff.nextBackOffMillis()) != ExponentialBackOff.STOP) {\n+      Thread.sleep(millis);\n+      // Queries to this database should eventually return DatabaseNotFoundExceptions.\n+      try (ResultSet rs = client.singleUse().executeQuery(Statement.of(\"SELECT 1\"))) {\n+        rs.next();\n+      } catch (DatabaseNotFoundException e) {\n+        // This is what we expect.\n+        notFoundException = e;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzQ4MDAx", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-344348001", "createdAt": "2020-01-17T03:34:53Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjQ2ODc3", "url": "https://github.com/googleapis/java-spanner/pull/34#pullrequestreview-343646877", "createdAt": "2020-01-16T02:49:44Z", "commit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjo0OTo0NFrOFeMmiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjo0OTo0NFrOFeMmiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwODA3NQ==", "bodyText": "2020", "url": "https://github.com/googleapis/java-spanner/pull/34#discussion_r367208075", "createdAt": "2020-01-16T02:49:44Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/DatabaseNotFoundException.java", "diffHunk": "@@ -0,0 +1,34 @@\n+/*\n+ * Copyright 2019 Google LLC", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cdd2ceed9ca7dd43e7ee4de08ad97186fff62063"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "948ba363280b92ae06d9da86b35eddb6dbb641fe", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/948ba363280b92ae06d9da86b35eddb6dbb641fe", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: stop sending rpcs on deleted db"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a35e03593c948a96724d6751ef80a9834a03ec1", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/6a35e03593c948a96724d6751ef80a9834a03ec1", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: client should stop sending rpcs after database dropped\n\nDatabaseClients should not continue to try to send RPCs to a database that has\nbeen deleted. Instead, the session pool will keep track of whether a database\nnot found error has been returned for a database, and if so, will invalidate\nitself. All subsequent calls for this database will return a DatabaseNotFoundException\nwithout calling a RPC.\n\nIf a database is re-created, the user must create a new DatabaseClient with a new\nsession pool in order to resume usage of the database.\n\nFixes #16"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a83158f16ce12e58326994e66e5a988219fcf86", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/8a83158f16ce12e58326994e66e5a988219fcf86", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: remove double check on isValid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a8f22182b5113c068fb8be2ddbd81ed08f3a81c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/3a8f22182b5113c068fb8be2ddbd81ed08f3a81c", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: add wait to deleted db integration test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed29debf751680f22f0f0d7bef1ebcc5012901dc", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/ed29debf751680f22f0f0d7bef1ebcc5012901dc", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: process review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd6c56bb4aa784bdfb29bdaeb09f6a9461eccc63", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/dd6c56bb4aa784bdfb29bdaeb09f6a9461eccc63", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: update copyright year"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e26496daa3decd39b03fb3a907b0c74fdbee173", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/1e26496daa3decd39b03fb3a907b0c74fdbee173", "committedDate": "2020-01-19T18:04:10Z", "message": "fix: process review comments"}, "afterCommit": {"oid": "dd6c56bb4aa784bdfb29bdaeb09f6a9461eccc63", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/dd6c56bb4aa784bdfb29bdaeb09f6a9461eccc63", "committedDate": "2020-01-22T06:16:39Z", "message": "fix: update copyright year"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 901, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}