{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczMjg3Njgx", "number": 67, "title": "feat: add metrics to capture acquired and released sessions data", "bodyText": "Updates #53 and continuation of #54 and #65.\nNew Metrics:\ncloud.google.com/java/spanner/num_acquired_sessions => The number of sessions acquired from the session pool.\ncloud.google.com/java/spanner/num_released_sessions => The number of sessions released (or destroyed) by the user and pool maintainer.\nAnother option, instead of having two metrics what if we just include one metric cloud.google.com/java/spanner/diff_acquired_released_sessions to indicate diff/gaps between acquired and released sessions. I think stand alone they both (num_acquired_sessions and num_released_sessions) are adding very less value unless we combine them to see the session leaks or other anomalies.", "createdAt": "2020-02-10T18:32:13Z", "url": "https://github.com/googleapis/java-spanner/pull/67", "merged": true, "mergeCommit": {"oid": "94d05575c37c7c7c7e9d7d3fbaea46c6d2eb6a4d"}, "closed": true, "closedAt": "2020-02-27T17:36:18Z", "author": {"login": "mayurkale22"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDCKSTAFqTM1NjE5NTc3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcIedi7AH2gAyMzczMjg3NjgxOmUzOWRiYjYyNGY3N2I2ZmRjNDY0Zjk3ODU2NmQ2YTgxM2UwZDJlNDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTk1Nzc3", "url": "https://github.com/googleapis/java-spanner/pull/67#pullrequestreview-356195777", "createdAt": "2020-02-10T19:18:54Z", "commit": {"oid": "ac25485719558a2545bd63b21d35e3c9063772e9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToxODo1NFrOFnyYnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxOToxODo1NFrOFnyYnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzI2NDI4NA==", "bodyText": "@olavloite I added these counters based on my understanding, let me know if there is a better way to get these (acquired and released sessions) values.", "url": "https://github.com/googleapis/java-spanner/pull/67#discussion_r377264284", "createdAt": "2020-02-10T19:18:54Z", "author": {"login": "mayurkale22"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1346,9 +1359,11 @@ PooledSession getReadSession() throws SpannerException {\n           readWaiters.add(waiter);\n         } else {\n           span.addAnnotation(\"Acquired read write session\");\n+          numSessionsAcquired++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac25485719558a2545bd63b21d35e3c9063772e9"}, "originalPosition": 52}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ac25485719558a2545bd63b21d35e3c9063772e9", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ac25485719558a2545bd63b21d35e3c9063772e9", "committedDate": "2020-02-10T18:06:06Z", "message": "update the description"}, "afterCommit": {"oid": "93a0692549ce6a69fcab12602b482a390d184c5b", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/93a0692549ce6a69fcab12602b482a390d184c5b", "committedDate": "2020-02-14T18:53:54Z", "message": "update the description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzYxNjE1", "url": "https://github.com/googleapis/java-spanner/pull/67#pullrequestreview-360761615", "createdAt": "2020-02-19T00:05:21Z", "commit": {"oid": "93a0692549ce6a69fcab12602b482a390d184c5b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDowNToyMlrOFrW4lw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDowNzoyNFrOFrW6uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODAyMw==", "bodyText": "I don't think releasing sessions is the same as closing the session pool. Releasing is to do with the user handing the session back to the pool. Closing is shutting down the connection all together.\nI think you want to add this to releaseSession on line 1522.", "url": "https://github.com/googleapis/java-spanner/pull/67#discussion_r381008023", "createdAt": "2020-02-19T00:05:22Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -795,6 +799,7 @@ public TransactionRunner readWriteTransaction() {\n     @Override\n     public void close() {\n       synchronized (lock) {\n+        numSessionsReleased++;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a0692549ce6a69fcab12602b482a390d184c5b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAwODU3MQ==", "bodyText": "I think you can remove this as well.", "url": "https://github.com/googleapis/java-spanner/pull/67#discussion_r381008571", "createdAt": "2020-02-19T00:07:24Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1025,6 +1030,7 @@ private void closeIdleSessions(Instant currTime) {\n           }\n           numSessionsToClose -= sessionsToClose.size();\n         }\n+        numSessionsReleased += sessionsToClose.size();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93a0692549ce6a69fcab12602b482a390d184c5b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNzcwMTg2", "url": "https://github.com/googleapis/java-spanner/pull/67#pullrequestreview-360770186", "createdAt": "2020-02-19T00:31:33Z", "commit": {"oid": "5d397a4aa010c88fea569e9b155813a7148afcfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDozMTozM1rOFrXUnw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwMDozMTozM1rOFrXUnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTAxNTE5OQ==", "bodyText": "@skuruppu thanks for the suggestions. I made the changes, but somehow test results look fishy to me. After change, NUM_RELEASED_SESSIONS == 5 and NUM_ACQUIRED_SESSIONS == 0.", "url": "https://github.com/googleapis/java-spanner/pull/67#discussion_r381015199", "createdAt": "2020-02-19T00:31:33Z", "author": {"login": "mayurkale22"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java", "diffHunk": "@@ -1628,7 +1628,7 @@ public Void call() {\n     assertThat(record.getMetrics())\n         .containsEntry(MetricRegistryConstants.NUM_ACQUIRED_SESSIONS, 0L);\n     assertThat(record.getMetrics())\n-        .containsEntry(MetricRegistryConstants.NUM_RELEASED_SESSIONS, 3L);\n+        .containsEntry(MetricRegistryConstants.NUM_RELEASED_SESSIONS, 5L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d397a4aa010c88fea569e9b155813a7148afcfb"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5d397a4aa010c88fea569e9b155813a7148afcfb", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/5d397a4aa010c88fea569e9b155813a7148afcfb", "committedDate": "2020-02-19T00:28:14Z", "message": "Apply skuruppu@'s recommendations"}, "afterCommit": {"oid": "ed6e1304b31bc1370a4515c60004274c7cf27e66", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ed6e1304b31bc1370a4515c60004274c7cf27e66", "committedDate": "2020-02-20T05:23:47Z", "message": "Apply skuruppu@'s recommendations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed6e1304b31bc1370a4515c60004274c7cf27e66", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ed6e1304b31bc1370a4515c60004274c7cf27e66", "committedDate": "2020-02-20T05:23:47Z", "message": "Apply skuruppu@'s recommendations"}, "afterCommit": {"oid": "d6c99a323be58b12a161ebcaa47c5b27be8441d3", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/d6c99a323be58b12a161ebcaa47c5b27be8441d3", "committedDate": "2020-02-21T22:04:50Z", "message": "Apply skuruppu@'s recommendations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d6c99a323be58b12a161ebcaa47c5b27be8441d3", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/d6c99a323be58b12a161ebcaa47c5b27be8441d3", "committedDate": "2020-02-21T22:04:50Z", "message": "Apply skuruppu@'s recommendations"}, "afterCommit": {"oid": "a268a3b91371d35c6cdae5c84b0d0f00468222e6", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/a268a3b91371d35c6cdae5c84b0d0f00468222e6", "committedDate": "2020-02-25T18:38:01Z", "message": "Apply skuruppu@'s recommendations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0NTkyODc2", "url": "https://github.com/googleapis/java-spanner/pull/67#pullrequestreview-364592876", "createdAt": "2020-02-26T02:51:32Z", "commit": {"oid": "341feee4e99379fb3231effea714e0f354564c7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1Nzc3OTU3", "url": "https://github.com/googleapis/java-spanner/pull/67#pullrequestreview-365777957", "createdAt": "2020-02-27T15:57:28Z", "commit": {"oid": "ebfa0859256571afcfbe6fdd913ac822294995ee"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b33434351e05bfb40a39894c1c0f9c8b1ed88388", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/b33434351e05bfb40a39894c1c0f9c8b1ed88388", "committedDate": "2020-02-27T16:48:48Z", "message": "add acquired and released sessions data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e59b250691249e320e2764066def2665210bcf8b", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/e59b250691249e320e2764066def2665210bcf8b", "committedDate": "2020-02-27T16:48:48Z", "message": "update the description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fd83ba9b2c342b80729e7c2076c9729fbb18028", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/8fd83ba9b2c342b80729e7c2076c9729fbb18028", "committedDate": "2020-02-27T16:48:49Z", "message": "update the description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b6462075b459f8102a37260327b34dd82ac3f85", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/4b6462075b459f8102a37260327b34dd82ac3f85", "committedDate": "2020-02-27T16:48:49Z", "message": "Apply skuruppu@'s recommendations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89cb12a5e4793d992418bf58e3f85f4d1df99113", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/89cb12a5e4793d992418bf58e3f85f4d1df99113", "committedDate": "2020-02-27T16:48:49Z", "message": "apply olavloite@'s recommendations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab228d1f3939cc9c0a8004ec3f49edc0748fd118", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ab228d1f3939cc9c0a8004ec3f49edc0748fd118", "committedDate": "2020-02-27T16:48:49Z", "message": "minor fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ebfa0859256571afcfbe6fdd913ac822294995ee", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ebfa0859256571afcfbe6fdd913ac822294995ee", "committedDate": "2020-02-27T06:07:14Z", "message": "minor fix"}, "afterCommit": {"oid": "ab228d1f3939cc9c0a8004ec3f49edc0748fd118", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/ab228d1f3939cc9c0a8004ec3f49edc0748fd118", "committedDate": "2020-02-27T16:48:49Z", "message": "minor fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e39dbb624f77b6fdc464f978566d6a813e0d2e43", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/e39dbb624f77b6fdc464f978566d6a813e0d2e43", "committedDate": "2020-02-27T17:06:54Z", "message": "attempt to fix build"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 861, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}