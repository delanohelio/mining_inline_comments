{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwNDk0MDc5", "number": 505, "title": "fix: AsyncTransactionManager should rollback on close", "bodyText": "AsyncTransctionManager should rollback the transaction if close is called while the transaction is still in state STARTED. Failing to do so, will keep the transaction open on the backend for longer than necessary, holding on to locks until it is garbage collected after 10 seconds.\nFixes #504", "createdAt": "2020-10-09T10:23:48Z", "url": "https://github.com/googleapis/java-spanner/pull/505", "merged": true, "mergeCommit": {"oid": "c580df8e1175bde293890c2a68e8816951c068d3"}, "closed": true, "closedAt": "2020-10-14T13:18:01Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQzhW2gH2gAyNTAwNDk0MDc5OmQ3OWM0NjBiZjBkMTJiMjcyZTZlYzZkYjVkNTVkMzk0OTE4YTdiZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSNuoHAFqTUwNzc2MDQ1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d79c460bf0d12b272e6ec6db5d55d394918a7beb", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/d79c460bf0d12b272e6ec6db5d55d394918a7beb", "committedDate": "2020-10-09T10:21:37Z", "message": "fix: AsyncTransactionManager should rollback on close\n\nAsyncTransctionManager should rollback the transaction if close is called\nwhile the transaction is still in state STARTED. Failing to do so, will\nkeep the transaction open on the backend for longer than necessary, holding\non to locks until it is garbage collected after 10 seconds.\n\nFixes #504"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NzQwNzY5", "url": "https://github.com/googleapis/java-spanner/pull/505#pullrequestreview-505740769", "createdAt": "2020-10-09T14:43:45Z", "commit": {"oid": "d79c460bf0d12b272e6ec6db5d55d394918a7beb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNDo0Mzo0NVrOHfMx8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQxNDo0Mzo0NVrOHfMx8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjQ3NzI5Nw==", "bodyText": "Can there be a version of close() that propagates the ApiFutrue from rollbackAsync() back to the caller? Otherwise the application could shut down (or, in my case, the test terminate) before the rollback happens.", "url": "https://github.com/googleapis/java-spanner/pull/505#discussion_r502477297", "createdAt": "2020-10-09T14:43:45Z", "author": {"login": "elefeint"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncTransactionManagerImpl.java", "diffHunk": "@@ -54,6 +54,9 @@ public void setSpan(Span span) {\n \n   @Override\n   public void close() {\n+    if (txnState == TransactionState.STARTED) {\n+      rollbackAsync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d79c460bf0d12b272e6ec6db5d55d394918a7beb"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daed417fdc2453d0365c545083b673eac3c06763", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/daed417fdc2453d0365c545083b673eac3c06763", "committedDate": "2020-10-13T14:57:48Z", "message": "feat: return rollback result from close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0614cc4ca8b180f9880affb8d40f695b03fd752c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/0614cc4ca8b180f9880affb8d40f695b03fd752c", "committedDate": "2020-10-13T15:00:28Z", "message": "fix: add ignored diff to clirr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NzYwNDU4", "url": "https://github.com/googleapis/java-spanner/pull/505#pullrequestreview-507760458", "createdAt": "2020-10-13T19:27:34Z", "commit": {"oid": "0614cc4ca8b180f9880affb8d40f695b03fd752c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1020, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}