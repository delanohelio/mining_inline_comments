{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwOTcyMTE5", "number": 24, "title": "perf: close sessions async", "bodyText": "Sessions should be closed using an async gRPC call in order to speed up the closing of a large session pool. Instead of using its own executor, which is limited to 8 worker threads, to execute asynchronous delete session calls, the session pool should use the asynchronous call option in gRPC. This allows a larger number of asynchronous delete session calls to be executed in parallel and speeds up closing a session pool with a large number of sessions.\nTesting against a real Cloud Spanner database with a session pool containing 1,000 sessions shows the following performance for closing the session pool:\nWithout this change (3 test runs):\n6603ms\n8169ms\n8367ms\nWith this change (3 test runs):\n1297ms\n1710ms\n1851ms\nFixes #19", "createdAt": "2020-01-09T13:56:10Z", "url": "https://github.com/googleapis/java-spanner/pull/24", "merged": true, "mergeCommit": {"oid": "ab250871cae51b3f496719d579db5bb6e263d5c3"}, "closed": true, "closedAt": "2020-01-23T02:51:39Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6SnxQAH2gAyMzYwOTcyMTE5OjAyMzkzOTM4NGFkODFlZTExYWRjZmUxZjY2M2FjYjg4YzQ4M2ZhMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7FN0mgFqTM0NDMzMTg1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "023939384ad81ee11adcfe1f663acb88c483fa35", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/023939384ad81ee11adcfe1f663acb88c483fa35", "committedDate": "2020-01-14T15:24:16Z", "message": "perf: close sessions async\n\nSessions should be closed using an async gRPC call in order\nto speed up the closing of a large session pool. Instead of\nusing its own executor, which is limited to 8 worker threads,\nto execute asynchronous delete session calls, the session pool\nshould use the asynchronous call option in gRPC. This allows a\nlarger number of asynchronous delete session calls to be executed\nin parallel and speeds up closing a session pool with a large\nnumber of sessions.\n\nTesting against a real Cloud Spanner database with a session pool\ncontaining 1,000 sessions shows the following performance for\nclosing the session pool:\n\nBefore (3 runs):\n6603ms\n8169ms\n8367ms\n\nAfter (3 runs):\n1297ms\n1710ms\n1851ms\n\nFixes #19."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b1ee9ca071c4dc1059b03c52e17519535443609", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5b1ee9ca071c4dc1059b03c52e17519535443609", "committedDate": "2020-01-14T15:24:16Z", "message": "fix: wait for test servers to terminate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "426ab82ffad8909f7d24b1e76fa99bb0a84476a2", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/426ab82ffad8909f7d24b1e76fa99bb0a84476a2", "committedDate": "2020-01-14T15:24:16Z", "message": "remove tracing for async call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2ed3bcad2fe7efe1bad8af7ec5f966a99b9dfce", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/d2ed3bcad2fe7efe1bad8af7ec5f966a99b9dfce", "committedDate": "2020-01-14T15:24:16Z", "message": "do not use directExecutor which could be a gRPC thread"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a2be79274a40363c63fc4a016bf8a360a3507fb1", "committedDate": "2020-01-14T15:49:01Z", "message": "fix: return failed future instead of throwing exception"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b3cfae44d95edf6221e179b3c3f9de08a552e0f0", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b3cfae44d95edf6221e179b3c3f9de08a552e0f0", "committedDate": "2020-01-10T10:49:39Z", "message": "do not use directExecutor which could be a gRPC thread"}, "afterCommit": {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a2be79274a40363c63fc4a016bf8a360a3507fb1", "committedDate": "2020-01-14T15:49:01Z", "message": "fix: return failed future instead of throwing exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjQxOTk1", "url": "https://github.com/googleapis/java-spanner/pull/24#pullrequestreview-343641995", "createdAt": "2020-01-16T02:29:03Z", "commit": {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjoyOTowM1rOFeMW5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwMjoyOTowM1rOFeMW5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzIwNDA3MQ==", "bodyText": "Why is this commented out?", "url": "https://github.com/googleapis/java-spanner/pull/24#discussion_r367204071", "createdAt": "2020-01-16T02:29:03Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolStressTest.java", "diffHunk": "@@ -139,6 +142,8 @@ public Void answer(InvocationOnMock invocation) throws Throwable {\n   private void setupSession(final Session session) {\n     ReadContext mockContext = mock(ReadContext.class);\n     final ResultSet mockResult = mock(ResultSet.class);\n+    //\n+    // when(session.asyncClose()).thenReturn(ApiFutures.immediateFuture(Empty.getDefaultInstance()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2be79274a40363c63fc4a016bf8a360a3507fb1"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712", "committedDate": "2020-01-16T18:51:27Z", "message": "fix: remove commented code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0MzMxODU4", "url": "https://github.com/googleapis/java-spanner/pull/24#pullrequestreview-344331858", "createdAt": "2020-01-17T02:21:05Z", "commit": {"oid": "8429fc26bb4fc5e94432aa9f7152cf4dfd0b5712"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 899, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}