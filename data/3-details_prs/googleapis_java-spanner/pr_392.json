{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMjg3NTg1", "number": 392, "title": "feat!: async connection API", "bodyText": "Description\nThis PR adds async methods for the Connection API. Note that the Connection API, including the async methods, still assumes the following:\n\nA Connection instance is not thread safe.\nAt most one statement will be actively executed at any time.\n\nTechnical Implementation\n\nThe PR adds Async versions for all execute and transaction methods of the Connection interface.\nThe ConnectionImpl class already has a single-threaded executor that will actually execute the statements on the backend. This was already implemented this way in preparation for a future async version of the API, and because it made it possible to cancel statements and make individual statements have a specific timeout.\nAll Async methods are executed using the executor from 2, and are basically the same as the current synchronous version, except the API no longer waits for the statement to finish, but returns the Future that is returned by the executor. Some extra logic is added for retrying statements in case of an AbortedException.\nStatements with a timeout used to implement the timeout by calling Future.get() with a timeout. That is now replaced with the new timeout feature that was recently added to the client library. This makes the timeout feature also usable for asynchronous statements.\nDDL statements cannot use the new timeout feature in the client library, as these execute RPCs on the DatabaseAdmin interface instead of the Spanner interface, still implement the timeout by calling Future.get() with a timeout.\nThe UnitOfWork interface is the base interface for all transactions in the Connection API. All the methods in this interface have been changed from sync to async, and the synchronous methods in the Connection interface use the async methods under the hood. This ensures that there is only one implementation of each method. It also ensures that all existing (integration) tests also invoke the new async methods.", "createdAt": "2020-08-19T16:40:34Z", "url": "https://github.com/googleapis/java-spanner/pull/392", "merged": true, "mergeCommit": {"oid": "3dd0675d2d7882d40a6af1e12fda3b4617019870"}, "closed": true, "closedAt": "2020-10-08T14:08:51Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 45, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc9foAYgH2gAyNDcwMjg3NTg1OmVjNGNjMzAzYTRlNzFkZDlhZTUwNzEyNDEzMWE4MTcyMjUyYTE2NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQQhF5gH2gAyNDcwMjg3NTg1OmI2ZTE3NWFiZTE0NzQyMzE3ZWQxNDYyZTZkZjM4MjFhNWRlODkxMTc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ec4cc303a4e71dd9ae507124131a8172252a1648", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/ec4cc303a4e71dd9ae507124131a8172252a1648", "committedDate": "2020-08-10T10:26:13Z", "message": "feat: support setting timeout per RPC\n\nThe Spanner client allows a user to set custom timeouts while creating a\nSpannerOptions instance, but these timeouts are static and are applied to\nall invocations of the RPCs. This change introduces the possibility to set\ncustom timeouts and other call options on a per-RPC basis.\n\nFixes #378"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd2715702423eedc8c9e907e6ccf1e33876f6074", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/dd2715702423eedc8c9e907e6ccf1e33876f6074", "committedDate": "2020-08-10T13:14:39Z", "message": "fix: change grpc deps from test to compile scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ae9a115ef4cf31d52bef1e057749099f5cad13d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2ae9a115ef4cf31d52bef1e057749099f5cad13d", "committedDate": "2020-08-19T16:39:22Z", "message": "feat: add async api for connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d28817d92eb57791d646542d8e319831aea9669", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5d28817d92eb57791d646542d8e319831aea9669", "committedDate": "2020-08-23T17:28:32Z", "message": "fix: fix test failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5655607f8cd98a4dfdddd2ba78f681ab71b9f01", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b5655607f8cd98a4dfdddd2ba78f681ab71b9f01", "committedDate": "2020-08-24T06:35:46Z", "message": "fix: move state handling from callback to callable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24461111fa29798bbfaf3fb7e4c5f4b11e3efd4d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/24461111fa29798bbfaf3fb7e4c5f4b11e3efd4d", "committedDate": "2020-08-24T17:09:22Z", "message": "fix: fix integration tests with emulator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321d23cf0e659bcc431a23272508850221850bc0", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/321d23cf0e659bcc431a23272508850221850bc0", "committedDate": "2020-08-24T18:31:05Z", "message": "fix: fix timeout integration test on emulator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c753e7c86a1822da404bd396543a164b89e03444", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c753e7c86a1822da404bd396543a164b89e03444", "committedDate": "2020-08-24T18:52:04Z", "message": "fix: prevent flakiness in DDL tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a80a858e8867d657e815b40f48405c7c2b08561", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/0a80a858e8867d657e815b40f48405c7c2b08561", "committedDate": "2020-08-25T12:05:46Z", "message": "fix: fix clirr build failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79308b6d5e16823b57e26ae2059a9da303f33e84", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/79308b6d5e16823b57e26ae2059a9da303f33e84", "committedDate": "2020-08-25T12:06:01Z", "message": "fix: do not set transaction state for Aborted err"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d5a61874ceb44ef06b844ba28cfff417a65167a", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/8d5a61874ceb44ef06b844ba28cfff417a65167a", "committedDate": "2020-08-25T12:29:20Z", "message": "Merge branch 'master' into async-connection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d531c5b7d901038257f0df6e8cfea711bb9480d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2d531c5b7d901038257f0df6e8cfea711bb9480d", "committedDate": "2020-08-25T13:13:54Z", "message": "fix: set transaction state after retry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce6795ed1b1a5f79f1df9c1b1918ee180a86e67", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/1ce6795ed1b1a5f79f1df9c1b1918ee180a86e67", "committedDate": "2020-08-25T15:31:26Z", "message": "cleanup: remove sync methods and use async instead"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a33a31f3b45fa59932d15a5b6cc99388751ee7cc", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a33a31f3b45fa59932d15a5b6cc99388751ee7cc", "committedDate": "2020-08-25T15:38:05Z", "message": "cleanup: remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "911179866436e4221df3a61f3fe4e2cfabd3d139", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/911179866436e4221df3a61f3fe4e2cfabd3d139", "committedDate": "2020-08-25T15:59:52Z", "message": "feat: make ddl async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2711d470ec060d84982060e3b4b17c9d51c84959", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2711d470ec060d84982060e3b4b17c9d51c84959", "committedDate": "2020-08-25T16:04:03Z", "message": "fix: reduce timeout and remove debug info"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "895b0243045d38274f63343e95c57a9d439d2cb8", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/895b0243045d38274f63343e95c57a9d439d2cb8", "committedDate": "2020-08-25T17:28:33Z", "message": "feat: make runBatch async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8d29ecc440d6d8869b02dfa19a73371a686366", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/3b8d29ecc440d6d8869b02dfa19a73371a686366", "committedDate": "2020-08-25T17:29:03Z", "message": "test: set forkCount to 1 to investigate test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc64a3178c316a041331ae7631dcb3d606a7ae4", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/fdc64a3178c316a041331ae7631dcb3d606a7ae4", "committedDate": "2020-08-25T17:53:07Z", "message": "fix: linting + clirr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6ff32d23775ee59c387f26e653a6ecc16b64b90", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c6ff32d23775ee59c387f26e653a6ecc16b64b90", "committedDate": "2020-08-25T18:46:23Z", "message": "fix: prevent deadlock in DmlBatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3096ef691262d4d761ce50a77a5ca72aa927e84c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/3096ef691262d4d761ce50a77a5ca72aa927e84c", "committedDate": "2020-08-26T11:54:45Z", "message": "fix: fix DMLBatch state handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "039541334d6ea85c75cc9398f0c6bf1739c29c26", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/039541334d6ea85c75cc9398f0c6bf1739c29c26", "committedDate": "2020-08-26T15:40:44Z", "message": "tests: add tests for aborted async transactions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb130b1084f5337fc6df1edec6d04a12edbde243", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/bb130b1084f5337fc6df1edec6d04a12edbde243", "committedDate": "2020-08-26T20:25:32Z", "message": "test: add aborted tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35210df1c148b1fa69d5823cd0a6646bd716be6c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/35210df1c148b1fa69d5823cd0a6646bd716be6c", "committedDate": "2020-08-29T17:01:30Z", "message": "fix: add change to clirr + more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e84dc16f6d24a8807d267dbc7a136ad6cc57f09", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2e84dc16f6d24a8807d267dbc7a136ad6cc57f09", "committedDate": "2020-08-30T05:39:01Z", "message": "fix: require a rollback after a tx has aborted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2500e426e608c5471ed188d8cc0302564e555506", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2500e426e608c5471ed188d8cc0302564e555506", "committedDate": "2020-08-30T08:01:50Z", "message": "docs: add javadoc for new methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24bc392e43fa93b6196b8157cb00682738514a62", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/24bc392e43fa93b6196b8157cb00682738514a62", "committedDate": "2020-08-30T20:45:09Z", "message": "tests: add integration tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d671278793351f40447e22cb9cfec8eee5a47129", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/d671278793351f40447e22cb9cfec8eee5a47129", "committedDate": "2020-08-31T18:56:42Z", "message": "fix: wait for commit before select"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a25857945880640f74e1e4084f17010dc6de82e8", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a25857945880640f74e1e4084f17010dc6de82e8", "committedDate": "2020-09-05T11:27:53Z", "message": "fix: fix handling aborted commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2878257bbe8ca5a92beae9885849887d08b36bf7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/2878257bbe8ca5a92beae9885849887d08b36bf7", "committedDate": "2020-09-05T12:09:20Z", "message": "docs: document behavior -Async methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea", "committedDate": "2020-09-08T05:21:02Z", "message": "fix: iterating without callback could cause exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c75bee6c7692ded2e0d33be8b9cd7941ad47d65", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5c75bee6c7692ded2e0d33be8b9cd7941ad47d65", "committedDate": "2020-09-08T14:37:26Z", "message": "fix: remove todos and commented code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDU2OTU3", "url": "https://github.com/googleapis/java-spanner/pull/392#pullrequestreview-484056957", "createdAt": "2020-09-08T11:53:09Z", "commit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMTo1MzowOVrOHOZWZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNDozMzozM1rOHOgI5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg1NzQ0Nw==", "bodyText": "Changed to public to be accessible from the com.google.cloud.spanner.connection package.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484857447", "createdAt": "2020-09-08T11:53:09Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/ErrorCode.java", "diffHunk": "@@ -89,7 +89,7 @@ static ErrorCode valueOf(String name, ErrorCode defaultValue) {\n   /**\n    * Returns the error code corresponding to a gRPC status, or {@code UNKNOWN} if not recognized.\n    */\n-  static ErrorCode fromGrpcStatus(Status status) {\n+  public static ErrorCode fromGrpcStatus(Status status) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg1ODQ5Ng==", "bodyText": "Allow specifying a buffer size instead of always using a default size.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484858496", "createdAt": "2020-09-08T11:55:09Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/ResultSets.java", "diffHunk": "@@ -65,8 +68,41 @@ public static AsyncResultSet toAsyncResultSet(ResultSet delegate) {\n    * ExecutorProvider}.\n    */\n   public static AsyncResultSet toAsyncResultSet(\n-      ResultSet delegate, ExecutorProvider executorProvider) {\n-    return new AsyncResultSetImpl(executorProvider, delegate, 100);\n+      ResultSet delegate, ExecutorProvider executorProvider, QueryOption... options) {\n+    Options readOptions = Options.fromQueryOptions(options);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3MjI4MA==", "bodyText": "Keeps track of whether this transaction has already aborted, and stops allowing any further statements on the transaction until it has been rolled back. Otherwise, a list of 'blind' async statements could lead to multiple unnecessary round-trips to the backend:\nconnection.executeUpdateAsync(statement1);\nconnection.executeUpdateAsync(statement2);\nconnection.commitAsync();\nIf the first statement in the example above aborts, the following statements will not be sent to the backend, but will return the aborted error of the first statement.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484872280", "createdAt": "2020-09-08T12:20:27Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -65,12 +74,15 @@\n   private int transactionRetryAttempts;\n   private int successfulRetries;\n   private final List<TransactionRetryListener> transactionRetryListeners;\n-  private volatile TransactionContext txContext;\n+  private volatile ApiFuture<TransactionContext> txContextFuture;\n+  private volatile SettableApiFuture<Timestamp> commitTimestampFuture;\n   private volatile UnitOfWorkState state = UnitOfWorkState.STARTED;\n+  private volatile AbortedException abortedException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3MzI0OQ==", "bodyText": "We allow submitting a statement on an aborted transaction, as the aborted error will be returned through the ApiFuture that is returned. This guarantees that multiple blind async statements in a row will not cause unexpected exceptions.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484873249", "createdAt": "2020-09-08T12:22:11Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -154,36 +166,71 @@ public boolean isReadOnly() {\n     return false;\n   }\n \n+  private static final ParsedStatement BEGIN_STATEMENT =\n+      StatementParser.INSTANCE.parse(Statement.of(\"BEGIN\"));\n+\n   @Override\n   void checkValidTransaction() {\n+    checkValidState();\n+    if (txContextFuture == null) {\n+      transactionStarted = Timestamp.now();\n+      txContextFuture =\n+          executeStatementAsync(\n+              BEGIN_STATEMENT,\n+              new Callable<TransactionContext>() {\n+                @Override\n+                public TransactionContext call() throws Exception {\n+                  return txManager.begin();\n+                }\n+              },\n+              SpannerGrpc.getBeginTransactionMethod());\n+    }\n+  }\n+\n+  private void checkValidState() {\n     ConnectionPreconditions.checkState(\n-        state == UnitOfWorkState.STARTED,\n+        this.state == UnitOfWorkState.STARTED || this.state == UnitOfWorkState.ABORTED,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3MzY4Nw==", "bodyText": "try-catch block removed, as the exception is returned by the ApiFuture.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484873687", "createdAt": "2020-09-08T12:23:01Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -229,108 +275,138 @@ private void handlePossibleInvalidatingException(SpannerException e) {\n   }\n \n   @Override\n-  public ResultSet executeQuery(\n+  public ApiFuture<ResultSet> executeQueryAsync(\n       final ParsedStatement statement,\n       final AnalyzeMode analyzeMode,\n       final QueryOption... options) {\n     Preconditions.checkArgument(statement.isQuery(), \"Statement is not a query\");\n     checkValidTransaction();\n-    try {\n-      if (retryAbortsInternally) {\n-        return asyncExecuteStatement(\n-            statement,\n-            new Callable<ResultSet>() {\n-              @Override\n-              public ResultSet call() throws Exception {\n-                return runWithRetry(\n-                    new Callable<ResultSet>() {\n-                      @Override\n-                      public ResultSet call() throws Exception {\n-                        try {\n-                          getStatementExecutor()\n-                              .invokeInterceptors(\n-                                  statement,\n-                                  StatementExecutionStep.EXECUTE_STATEMENT,\n-                                  ReadWriteTransaction.this);\n-                          ResultSet delegate =\n-                              DirectExecuteResultSet.ofResultSet(\n-                                  internalExecuteQuery(statement, analyzeMode, options));\n-                          return createAndAddRetryResultSet(\n-                              delegate, statement, analyzeMode, options);\n-                        } catch (AbortedException e) {\n-                          throw e;\n-                        } catch (SpannerException e) {\n-                          createAndAddFailedQuery(e, statement, analyzeMode, options);\n-                          throw e;\n+\n+    ApiFuture<ResultSet> res;\n+    if (retryAbortsInternally) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3NDA2MA==", "bodyText": "try-catch block removed as exceptions are returned by the ApiFuture.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484874060", "createdAt": "2020-09-08T12:23:36Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -229,108 +275,138 @@ private void handlePossibleInvalidatingException(SpannerException e) {\n   }\n \n   @Override\n-  public ResultSet executeQuery(\n+  public ApiFuture<ResultSet> executeQueryAsync(\n       final ParsedStatement statement,\n       final AnalyzeMode analyzeMode,\n       final QueryOption... options) {\n     Preconditions.checkArgument(statement.isQuery(), \"Statement is not a query\");\n     checkValidTransaction();\n-    try {\n-      if (retryAbortsInternally) {\n-        return asyncExecuteStatement(\n-            statement,\n-            new Callable<ResultSet>() {\n-              @Override\n-              public ResultSet call() throws Exception {\n-                return runWithRetry(\n-                    new Callable<ResultSet>() {\n-                      @Override\n-                      public ResultSet call() throws Exception {\n-                        try {\n-                          getStatementExecutor()\n-                              .invokeInterceptors(\n-                                  statement,\n-                                  StatementExecutionStep.EXECUTE_STATEMENT,\n-                                  ReadWriteTransaction.this);\n-                          ResultSet delegate =\n-                              DirectExecuteResultSet.ofResultSet(\n-                                  internalExecuteQuery(statement, analyzeMode, options));\n-                          return createAndAddRetryResultSet(\n-                              delegate, statement, analyzeMode, options);\n-                        } catch (AbortedException e) {\n-                          throw e;\n-                        } catch (SpannerException e) {\n-                          createAndAddFailedQuery(e, statement, analyzeMode, options);\n-                          throw e;\n+\n+    ApiFuture<ResultSet> res;\n+    if (retryAbortsInternally) {\n+      res =\n+          executeStatementAsync(\n+              statement,\n+              new Callable<ResultSet>() {\n+                @Override\n+                public ResultSet call() throws Exception {\n+                  return runWithRetry(\n+                      new Callable<ResultSet>() {\n+                        @Override\n+                        public ResultSet call() throws Exception {\n+                          try {\n+                            getStatementExecutor()\n+                                .invokeInterceptors(\n+                                    statement,\n+                                    StatementExecutionStep.EXECUTE_STATEMENT,\n+                                    ReadWriteTransaction.this);\n+                            ResultSet delegate =\n+                                DirectExecuteResultSet.ofResultSet(\n+                                    internalExecuteQuery(statement, analyzeMode, options));\n+                            return createAndAddRetryResultSet(\n+                                delegate, statement, analyzeMode, options);\n+                          } catch (AbortedException e) {\n+                            throw e;\n+                          } catch (SpannerException e) {\n+                            createAndAddFailedQuery(e, statement, analyzeMode, options);\n+                            throw e;\n+                          }\n                         }\n-                      }\n-                    });\n-              }\n-            },\n-            InterceptorsUsage\n-                .IGNORE_INTERCEPTORS); // ignore interceptors here as they are invoked in the\n-        // Callable.\n-      } else {\n-        return super.executeQuery(statement, analyzeMode, options);\n-      }\n-    } catch (SpannerException e) {\n-      handlePossibleInvalidatingException(e);\n-      throw e;\n+                      });\n+                }\n+              },\n+              // ignore interceptors here as they are invoked in the Callable.\n+              InterceptorsUsage.IGNORE_INTERCEPTORS,\n+              ImmutableList.<MethodDescriptor<?, ?>>of(SpannerGrpc.getExecuteStreamingSqlMethod()));\n+    } else {\n+      res = super.executeQueryAsync(statement, analyzeMode, options);\n     }\n+\n+    ApiFutures.addCallback(\n+        res,\n+        new ApiFutureCallback<ResultSet>() {\n+          @Override\n+          public void onFailure(Throwable t) {\n+            if (t instanceof SpannerException) {\n+              handlePossibleInvalidatingException((SpannerException) t);\n+            }\n+          }\n+\n+          @Override\n+          public void onSuccess(ResultSet result) {}\n+        },\n+        MoreExecutors.directExecutor());\n+    return res;\n   }\n \n   @Override\n-  public long executeUpdate(final ParsedStatement update) {\n+  public ApiFuture<Long> executeUpdateAsync(final ParsedStatement update) {\n     Preconditions.checkNotNull(update);\n     Preconditions.checkArgument(update.isUpdate(), \"The statement is not an update statement\");\n     checkValidTransaction();\n-    try {\n-      if (retryAbortsInternally) {\n-        return asyncExecuteStatement(\n-            update,\n-            new Callable<Long>() {\n-              @Override\n-              public Long call() throws Exception {\n-                return runWithRetry(\n-                    new Callable<Long>() {\n-                      @Override\n-                      public Long call() throws Exception {\n-                        try {\n-                          getStatementExecutor()\n-                              .invokeInterceptors(\n-                                  update,\n-                                  StatementExecutionStep.EXECUTE_STATEMENT,\n-                                  ReadWriteTransaction.this);\n-                          long updateCount = txContext.executeUpdate(update.getStatement());\n-                          createAndAddRetriableUpdate(update, updateCount);\n-                          return updateCount;\n-                        } catch (AbortedException e) {\n-                          throw e;\n-                        } catch (SpannerException e) {\n-                          createAndAddFailedUpdate(e, update);\n-                          throw e;\n+    ApiFuture<Long> res;\n+    if (retryAbortsInternally) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 296}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDkzMTgzOQ==", "bodyText": "Ensure that only one retry is executed at any time. Previously, a retry would normally be executed by the connection executor. Now, a retry could also be initiated by a worker thread of an AsyncResultSet. The worker thread of an AsyncResultSet will iterate over the underlying ResultSet and buffer the results. Each call to ResultSet#next() on the underlying result set could cause an AbortedException, and will trigger a retry of the transaction.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484931839", "createdAt": "2020-09-08T13:44:41Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ReadWriteTransaction.java", "diffHunk": "@@ -508,18 +624,21 @@ public Void call() throws Exception {\n    */\n   <T> T runWithRetry(Callable<T> callable) throws SpannerException {\n     while (true) {\n-      try {\n-        return callable.call();\n-      } catch (final AbortedException aborted) {\n-        if (retryAbortsInternally) {\n-          handleAborted(aborted);\n-        } else {\n-          throw aborted;\n+      synchronized (abortedLock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 652}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1NzcxMQ==", "bodyText": "This is no longer needed thanks to the new feature in the client library for setting a timeout per RPC.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484957711", "createdAt": "2020-09-08T14:19:36Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/StatementExecutor.java", "diffHunk": "@@ -151,18 +180,6 @@ private static ExecutorService createExecutorService() {\n     this.interceptors = Collections.unmodifiableList(interceptors);\n   }\n \n-  /**\n-   * Recreates this {@link StatementExecutor} and its {@link ExecutorService}. This can be necessary\n-   * if a statement times out or is cancelled, and it cannot be guaranteed that the statement\n-   * execution can be terminated. In order to prevent the single threaded {@link ExecutorService} to\n-   * continue to block on the timed out/cancelled statement, a new {@link ExecutorService} is\n-   * created.\n-   */\n-  void recreate() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk1ODc3MQ==", "bodyText": "State added as a commitAsync will initiate a commit, but return before the outcome of the commit is known. Setting this state is needed in order to know that the following statement should be executed in a new transaction.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484958771", "createdAt": "2020-09-08T14:20:56Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -39,9 +41,11 @@\n \n   enum UnitOfWorkState {\n     STARTED,\n+    COMMITTING,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk2Mzk0OQ==", "bodyText": "This property is used to trigger an error halfway a stream of PartialResultSets.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484963949", "createdAt": "2020-09-08T14:27:36Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/MockSpannerServiceImpl.java", "diffHunk": "@@ -408,6 +409,7 @@ private StatusRuntimeException getException() {\n     private final int randomExecutionTime;\n     private final Queue<Exception> exceptions;\n     private final boolean stickyException;\n+    private final Queue<Long> streamIndices;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk2Njg0Ng==", "bodyText": "Disable logging of certain warnings that may be ignored during these tests. These are generated because we force errors halfway streams etc.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484966846", "createdAt": "2020-09-08T14:31:14Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/AbstractMockServerTest.java", "diffHunk": "@@ -124,11 +160,32 @@ public static void stopServer() throws Exception {\n   @Before\n   public void setupResults() {\n     mockSpanner.reset();\n+    mockDatabaseAdmin.reset();\n+    mockInstanceAdmin.reset();\n+\n+    futureParentHandlers = Logger.getLogger(AbstractFuture.class.getName()).getUseParentHandlers();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDk2ODY3OQ==", "bodyText": "These tests have been replaced by tests using a mock server.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r484968679", "createdAt": "2020-09-08T14:33:33Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/connection/SingleUseTransactionTest.java", "diffHunk": "@@ -707,81 +673,42 @@ public void testMultiUse() {\n     ParsedStatement ddl = createParsedDdl(sql);\n     DdlClient ddlClient = createDefaultMockDdlClient();\n     SingleUseTransaction subject = createDdlSubject(ddlClient);\n-    subject.executeDdl(ddl);\n+    get(subject.executeDdlAsync(ddl));\n     verify(ddlClient).executeDdl(sql);\n     try {\n-      subject.executeDdl(ddl);\n+      get(subject.executeDdlAsync(ddl));\n       fail(\"missing expected exception\");\n     } catch (IllegalStateException e) {\n     }\n \n     ParsedStatement update = createParsedUpdate(VALID_UPDATE);\n     subject = createSubject();\n-    long updateCount = subject.executeUpdate(update);\n+    long updateCount = get(subject.executeUpdateAsync(update));\n     assertThat(updateCount).isEqualTo(VALID_UPDATE_COUNT);\n     assertThat(subject.getCommitTimestamp()).isNotNull();\n     try {\n-      subject.executeUpdate(update);\n+      get(subject.executeUpdateAsync(update));\n       fail(\"missing expected exception\");\n     } catch (IllegalStateException e) {\n     }\n \n     subject = createSubject();\n-    subject.write(Mutation.newInsertBuilder(\"FOO\").build());\n+    get(subject.writeAsync(Collections.singleton(Mutation.newInsertBuilder(\"FOO\").build())));\n     assertThat(subject.getCommitTimestamp()).isNotNull();\n     try {\n-      subject.write(Mutation.newInsertBuilder(\"FOO\").build());\n+      get(subject.writeAsync(Collections.singleton(Mutation.newInsertBuilder(\"FOO\").build())));\n       fail(\"missing expected exception\");\n     } catch (IllegalStateException e) {\n     }\n \n     subject = createSubject();\n     Mutation mutation = Mutation.newInsertBuilder(\"FOO\").build();\n-    subject.write(Arrays.asList(mutation, mutation));\n+    get(subject.writeAsync(Arrays.asList(mutation, mutation)));\n     assertThat(subject.getCommitTimestamp()).isNotNull();\n     try {\n-      subject.write(Arrays.asList(mutation, mutation));\n+      get(subject.writeAsync(Arrays.asList(mutation, mutation)));\n       fail(\"missing expected exception\");\n     } catch (IllegalStateException e) {\n     }\n   }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81b70c39ee2c6af5986aeb749a6bb8093dbcd7ea"}, "originalPosition": 294}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1a40eea6544dde92eb57b2a37ef0d305fb4bdeb", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/f1a40eea6544dde92eb57b2a37ef0d305fb4bdeb", "committedDate": "2020-09-11T12:21:50Z", "message": "feat: keep track of caller to include in stacktrace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a541398e7dbb2ab0d5b1773f0ac2d0afc3fe0c6a", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a541398e7dbb2ab0d5b1773f0ac2d0afc3fe0c6a", "committedDate": "2020-09-11T12:23:42Z", "message": "Merge branch 'master' into async-connection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2NzYwMzY1", "url": "https://github.com/googleapis/java-spanner/pull/392#pullrequestreview-486760365", "createdAt": "2020-09-11T12:27:56Z", "commit": {"oid": "a541398e7dbb2ab0d5b1773f0ac2d0afc3fe0c6a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjoyNzo1N1rOHQcymg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMjoyNzo1N1rOHQcymg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzAxMDk3MA==", "bodyText": "The delegate ResultSet should not be closed by the callback executor, but only by the executor that fetches and buffers the rows (in the ProduceRowsCallable at line 380)", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r487010970", "createdAt": "2020-09-11T12:27:57Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncResultSetImpl.java", "diffHunk": "@@ -275,7 +282,7 @@ public void run() {\n               switch (response) {\n                 case DONE:\n                   state = State.DONE;\n-                  closeDelegateResultSet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a541398e7dbb2ab0d5b1773f0ac2d0afc3fe0c6a"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ef086926ff083af43c1f1dcc5182dab0d7992c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/51ef086926ff083af43c1f1dcc5182dab0d7992c", "committedDate": "2020-09-11T13:33:53Z", "message": "docs: explain why Aborted is active"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ded2101e0bf64fbd1be6ebef73e6d8f7f3e74b07", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/ded2101e0bf64fbd1be6ebef73e6d8f7f3e74b07", "committedDate": "2020-09-11T13:34:15Z", "message": "fix: use ticker for better testability"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5989efbce07a10eb5080e9bf906942627ed9fbff", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5989efbce07a10eb5080e9bf906942627ed9fbff", "committedDate": "2020-09-11T14:59:40Z", "message": "test: increase coverage and remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50f1edef519dcb1fbe79b6ca0ffc6a98e272b73", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c50f1edef519dcb1fbe79b6ca0ffc6a98e272b73", "committedDate": "2020-09-12T10:39:07Z", "message": "test: add additional tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c5fba074cdebac48753e9f90e06960b15b8055b6", "committedDate": "2020-10-05T08:03:43Z", "message": "Merge branch 'master' into async-connection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMTI5NDA5", "url": "https://github.com/googleapis/java-spanner/pull/392#pullrequestreview-503129409", "createdAt": "2020-10-06T16:05:38Z", "commit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNjowNTozOFrOHdPN_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzoxODozMlrOHdSEEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyMDA5NQ==", "bodyText": "The executeQueryAsync method will produce a Future<ResultSet> that should be used as the underlying delegate of an AsyncResultSet.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500420095", "createdAt": "2020-10-06T16:05:38Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncResultSetImpl.java", "diffHunk": "@@ -89,7 +91,7 @@ private State(boolean shouldStop) {\n   private final BlockingDeque<Struct> buffer;\n   private Struct currentRow;\n   /** The underlying synchronous {@link ResultSet} that is producing the rows. */\n-  private final ResultSet delegateResultSet;\n+  private final Supplier<ResultSet> delegateResultSet;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyMDU1Nw==", "bodyText": "Returns the same exception instance if e is already a SpannerException, instead of wrapping a SpannerException in another SpannerException.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500420557", "createdAt": "2020-10-06T16:06:15Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncResultSetImpl.java", "diffHunk": "@@ -261,7 +268,7 @@ public void run() {\n                 // we'll keep the cancelled state.\n                 return;\n               }\n-              executionException = SpannerExceptionFactory.newSpannerException(e);\n+              executionException = SpannerExceptionFactory.asSpannerException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyMTE5Mg==", "bodyText": "Convenience method that will catch and wrap common exceptions.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500421192", "createdAt": "2020-10-06T16:07:07Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SpannerApiFutures.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright 2020 Google LLC\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *       http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.google.cloud.spanner;\n+\n+import com.google.api.core.ApiFuture;\n+import com.google.common.base.Preconditions;\n+import java.util.concurrent.CancellationException;\n+import java.util.concurrent.ExecutionException;\n+\n+public class SpannerApiFutures {\n+  public static <T> T get(ApiFuture<T> future) throws SpannerException {\n+    return getOrNull(Preconditions.checkNotNull(future));\n+  }\n+\n+  public static <T> T getOrNull(ApiFuture<T> future) throws SpannerException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQyODQ5MA==", "bodyText": "All methods in the UnitOfWork interface have been changed from sync to async. The sync methods in the Connection interface now use the async versions in UnitOfWork under the hood.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500428490", "createdAt": "2020-10-06T16:18:25Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -67,30 +71,35 @@ public boolean isActive() {\n    * Commits the changes in this unit of work to the database. For read-only transactions, this only\n    * closes the {@link ReadContext}. This method will throw a {@link SpannerException} if called for\n    * a {@link Type#BATCH}.\n+   *\n+   * @return An {@link ApiFuture} that is done when the commit has finished.\n    */\n-  void commit();\n+  ApiFuture<Void> commitAsync();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMTIwOA==", "bodyText": "This has been moved to the NextCallable to make it retriable.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500431208", "createdAt": "2020-10-06T16:22:26Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ChecksumResultSet.java", "diffHunk": "@@ -107,13 +113,7 @@ public Boolean call() throws Exception {\n   @Override\n   public boolean next() {\n     // Call next() with retry.\n-    boolean res = transaction.runWithRetry(nextCallable);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQzMzA3MQ==", "bodyText": "This block of code is moved to the Callable below, that can be used as input for the generic executeStatementAsync method.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500433071", "createdAt": "2020-10-06T16:25:14Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/DdlBatch.java", "diffHunk": "@@ -214,62 +210,50 @@ public void write(Iterable<Mutation> mutations) {\n       StatementParser.INSTANCE.parse(Statement.of(\"RUN BATCH\"));\n \n   @Override\n-  public long[] runBatch() {\n+  public ApiFuture<long[]> runBatchAsync() {\n     ConnectionPreconditions.checkState(\n         state == UnitOfWorkState.STARTED, \"The batch is no longer active and cannot be ran\");\n-    try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NTEzOA==", "bodyText": "Use a Ticker to measure time to make it easier to test.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500465138", "createdAt": "2020-10-06T17:15:57Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/SpannerPool.java", "diffHunk": "@@ -236,14 +237,17 @@ public int hashCode() {\n   @GuardedBy(\"this\")\n   private final Map<SpannerPoolKey, Long> lastConnectionClosedAt = new HashMap<>();\n \n+  private final Ticker ticker;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NTkxMg==", "bodyText": "Create a ListeningExecutorService. The ListenableFutures that are returned by this can be converted to ApiFutures.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500465912", "createdAt": "2020-10-06T17:17:13Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/StatementExecutor.java", "diffHunk": "@@ -129,12 +141,13 @@ public boolean hasDuration() {\n           .build();\n \n   /** Creates an {@link ExecutorService} for a {@link StatementExecutor}. */\n-  private static ExecutorService createExecutorService() {\n-    return new ThreadPoolExecutor(\n-        1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<Runnable>(), THREAD_FACTORY);\n+  private static ListeningExecutorService createExecutorService() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ2NjcwNw==", "bodyText": "This state is added to indicate that a batch is running, but not yet finished, and that all subsequent statements should not be included in the batch.", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500466707", "createdAt": "2020-10-06T17:18:32Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/UnitOfWork.java", "diffHunk": "@@ -39,9 +41,11 @@\n \n   enum UnitOfWorkState {\n     STARTED,\n+    COMMITTING,\n     COMMITTED,\n     COMMIT_FAILED,\n     ROLLED_BACK,\n+    RUNNING,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5fba074cdebac48753e9f90e06960b15b8055b6"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e775b10b21b7d04108807ac8c8b120712fc5904", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/3e775b10b21b7d04108807ac8c8b120712fc5904", "committedDate": "2020-10-06T17:24:54Z", "message": "docs: add missing @override"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNDI0NDkz", "url": "https://github.com/googleapis/java-spanner/pull/392#pullrequestreview-503424493", "createdAt": "2020-10-06T23:19:33Z", "commit": {"oid": "3e775b10b21b7d04108807ac8c8b120712fc5904"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMzoxOTozM1rOHddMGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQyMzoxOTozM1rOHddMGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDY0ODk4Nw==", "bodyText": "Is this comment accurate now? (since executeQueryAsync will produce a Future<ResultSet> to be used here)", "url": "https://github.com/googleapis/java-spanner/pull/392#discussion_r500648987", "createdAt": "2020-10-06T23:19:33Z", "author": {"login": "thiagotnunes"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/AsyncResultSetImpl.java", "diffHunk": "@@ -89,7 +91,7 @@ private State(boolean shouldStop) {\n   private final BlockingDeque<Struct> buffer;\n   private Struct currentRow;\n   /** The underlying synchronous {@link ResultSet} that is producing the rows. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e775b10b21b7d04108807ac8c8b120712fc5904"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6e175abe14742317ed1462e6df3821a5de89117", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b6e175abe14742317ed1462e6df3821a5de89117", "committedDate": "2020-10-07T17:34:39Z", "message": "docs: fix comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 823, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}