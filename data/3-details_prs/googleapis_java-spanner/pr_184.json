{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4OTM3MDk4", "number": 184, "title": "tests: Attempt to fix random timeouts in ITBackup", "bodyText": "The ITBackup test fails randomly (and lately: consistently) on the CI environment with timeout errors. This seems to be caused by several backup operations that are still in progress and do not finish. Cancelling these before starting the actual backup tests seems to solve the problem (for now).", "createdAt": "2020-04-25T16:48:39Z", "url": "https://github.com/googleapis/java-spanner/pull/184", "merged": true, "mergeCommit": {"oid": "90413f7e0240c50a37282f5fdc6a1370e48f8c11"}, "closed": true, "closedAt": "2020-04-29T06:17:07Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcb-b1KgH2gAyNDA4OTM3MDk4OmRkYjgxY2Y0YTA3NmQ5MWU0ODE1NjA4ZThlMzYyMmIzZmEwYzZkNGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccBbd0AFqTQwMTcwODQ0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ddb81cf4a076d91e4815608e8e3622b3fa0c6d4d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/ddb81cf4a076d91e4815608e8e3622b3fa0c6d4d", "committedDate": "2020-04-28T07:06:33Z", "message": "tests: attempt to fix timeouts of ITBackup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "492463a7f2f83383b21bf3f7fb1a0853e5a5851d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/492463a7f2f83383b21bf3f7fb1a0853e5a5851d", "committedDate": "2020-04-28T07:06:33Z", "message": "fix: fix second timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04a3629ad44c454eda310ff88e5e7801cf628f5b", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/04a3629ad44c454eda310ff88e5e7801cf628f5b", "committedDate": "2020-04-28T07:06:33Z", "message": "tests: add operation name to log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be3c6b9c1fe46671bf2ea5ea96a4dcd34820e116", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/be3c6b9c1fe46671bf2ea5ea96a4dcd34820e116", "committedDate": "2020-04-28T07:06:33Z", "message": "tests: add additional logging to ITBackup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c26d86cf71091a5a208bdb20b7f48716de78776f", "committedDate": "2020-04-28T07:06:33Z", "message": "tests: cancel long-running backup operations before test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b9cd7deb2013f46a66921dc27fc3930307b001e7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b9cd7deb2013f46a66921dc27fc3930307b001e7", "committedDate": "2020-04-26T07:05:12Z", "message": "tests: cancel long-running backup operations before test"}, "afterCommit": {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c26d86cf71091a5a208bdb20b7f48716de78776f", "committedDate": "2020-04-28T07:06:33Z", "message": "tests: cancel long-running backup operations before test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzA3MzIz", "url": "https://github.com/googleapis/java-spanner/pull/184#pullrequestreview-401707323", "createdAt": "2020-04-28T10:34:08Z", "commit": {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDozNDowOFrOGNNozQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMDozNDowOFrOGNNozQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjUwODEwOQ==", "bodyText": "If for any reason in the future, the cancelling still doesn't work, your other option may be to just call delete on those backups. AFAIK, backups in the process of being created can be deleted.", "url": "https://github.com/googleapis/java-spanner/pull/184#discussion_r416508109", "createdAt": "2020-04-28T10:34:08Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/it/ITBackupTest.java", "diffHunk": "@@ -93,6 +100,40 @@ public void setUp() throws Exception {\n     instanceAdminClient = testHelper.getClient().getInstanceAdminClient();\n     instance = instanceAdminClient.getInstance(testHelper.getInstanceId().getInstance());\n     logger.info(\"Finished setup\");\n+\n+    // Cancel any backup operation that has been started by this integration test if it has been\n+    // running for at least 6 hours.\n+    logger.info(\"Cancelling long-running test backup operations\");\n+    Pattern pattern = Pattern.compile(\".*/backups/testbck_\\\\d{6}_\\\\d{4}_bck\\\\d/operations/.*\");\n+    try {\n+      for (Operation operation :\n+          dbAdminClient.listBackupOperations(instance.getId().getInstance()).iterateAll()) {\n+        Matcher matcher = pattern.matcher(operation.getName());\n+        if (matcher.matches()) {\n+          if (!operation.getDone()) {\n+            Timestamp currentTime = Timestamp.now();\n+            Timestamp startTime =\n+                Timestamp.fromProto(\n+                    operation\n+                        .getMetadata()\n+                        .unpack(CreateBackupMetadata.class)\n+                        .getProgress()\n+                        .getStartTime());\n+            long diffSeconds = currentTime.getSeconds() - startTime.getSeconds();\n+            if (TimeUnit.HOURS.convert(diffSeconds, TimeUnit.SECONDS) >= 6L) {\n+              logger.warning(\n+                  String.format(\n+                      \"Cancelling test backup operation %s that was started at %s\",\n+                      operation.getName(), startTime.toString()));\n+              dbAdminClient.cancelOperation(operation.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzA4NDQz", "url": "https://github.com/googleapis/java-spanner/pull/184#pullrequestreview-401708443", "createdAt": "2020-04-28T10:35:52Z", "commit": {"oid": "c26d86cf71091a5a208bdb20b7f48716de78776f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 830, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}