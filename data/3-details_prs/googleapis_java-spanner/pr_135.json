{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NTE4NjA5", "number": 135, "title": "feat: optimize maintainer to let sessions be GC'ed instead of deleted", "bodyText": "Optimizes the session pool maintainer to:\n\nLet the backend garbage collect sessions instead of explicitly deleting them. This reduces the number of RPCs needed.\nOnly keep MinSessions + MaxIdleSessions alive in the session pool. Let all other sessions automatically expire and remove these from the pool if they are not being used. This reduces the required number of RPCs to keep sessions alive.", "createdAt": "2020-03-30T09:22:18Z", "url": "https://github.com/googleapis/java-spanner/pull/135", "merged": true, "mergeCommit": {"oid": "d65747cbc704508f6f1bcef6eea53aa411d42ee2"}, "closed": true, "closedAt": "2020-04-22T01:46:47Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcU49yCAFqTM4Nzk3MDI3NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZxLYTABqjMyNTU2MDQ2MDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3OTcwMjc1", "url": "https://github.com/googleapis/java-spanner/pull/135#pullrequestreview-387970275", "createdAt": "2020-04-06T06:46:44Z", "commit": {"oid": "6401cb9231621ecc0bcb936b3ba7a1cf7aa076e6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6401cb9231621ecc0bcb936b3ba7a1cf7aa076e6", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/6401cb9231621ecc0bcb936b3ba7a1cf7aa076e6", "committedDate": "2020-04-02T08:22:39Z", "message": "fix: revert using GetSession as ping"}, "afterCommit": {"oid": "c95aed62d25e5f7444212493a7d953ee93a1b2ba", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c95aed62d25e5f7444212493a7d953ee93a1b2ba", "committedDate": "2020-04-08T05:28:17Z", "message": "fix: merge conflicts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNjE4ODg1", "url": "https://github.com/googleapis/java-spanner/pull/135#pullrequestreview-393618885", "createdAt": "2020-04-15T09:45:32Z", "commit": {"oid": "c95aed62d25e5f7444212493a7d953ee93a1b2ba"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOTo0NTozMlrOGFyCtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOTo0NTozMlrOGFyCtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODcxNTk1Ng==", "bodyText": "Doesn't this logic meant that over time we won't be maintaining the ratio of write prepared sessions to read sessions since we always favor keeping read sessions alive?", "url": "https://github.com/googleapis/java-spanner/pull/135#discussion_r408715956", "createdAt": "2020-04-15T09:45:32Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SessionPool.java", "diffHunk": "@@ -1053,9 +1057,11 @@ private void keepAliveSessions(Instant currTime) {\n       while (numSessionsToKeepAlive > 0) {\n         PooledSession sessionToKeepAlive = null;\n         synchronized (lock) {\n-          sessionToKeepAlive = findSessionToKeepAlive(readSessions, keepAliveThreshold);\n+          sessionToKeepAlive = findSessionToKeepAlive(readSessions, keepAliveThreshold, 0);\n           if (sessionToKeepAlive == null) {\n-            sessionToKeepAlive = findSessionToKeepAlive(writePreparedSessions, keepAliveThreshold);\n+            sessionToKeepAlive =\n+                findSessionToKeepAlive(\n+                    writePreparedSessions, keepAliveThreshold, readSessions.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c95aed62d25e5f7444212493a7d953ee93a1b2ba"}, "originalPosition": 159}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6284794e26bd3c00c309d0b19af485b36555b21", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b6284794e26bd3c00c309d0b19af485b36555b21", "committedDate": "2020-04-21T10:24:57Z", "message": "perf: increase sessions in the pool in batches\n\nWhen more sessions are requested by the user application than are available in the session pool,\nthe session pool will now create new sessions in batches instead of in steps of 1. This reduces\nthe number of RPCs needed to serve a burst of requests.\n\nA benchmark for the session pool has also been added to be able to compare performance and the\nnumber of RPCs needed before and after this change. This benchmark can also be used for future\nchanges to verify that the change does not deteriorate performance or increase the number of\nRPCs needed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "424d3704cd8c6e68ae131d14c943663096564dea", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/424d3704cd8c6e68ae131d14c943663096564dea", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa222f28daa64a8d3395294629328170707f7606", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/fa222f28daa64a8d3395294629328170707f7606", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: include num rpcs and sessions in benchmark results"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d96c2f8de5cf715a20edd6d091cb29bd46d7452", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/4d96c2f8de5cf715a20edd6d091cb29bd46d7452", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: include num rpcs and sessions in benchmark results"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87af06805a2b4db725fe63d4d43dd4eb8e1e24f2", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/87af06805a2b4db725fe63d4d43dd4eb8e1e24f2", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: revert using GetSession as ping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5c88dcf88ce336fd2731f085e793a9a3e5bcf2c", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/b5c88dcf88ce336fd2731f085e793a9a3e5bcf2c", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: merge conflicts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7d307e0a6c0bbea327a51c2643e9ac3271bd412", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c7d307e0a6c0bbea327a51c2643e9ac3271bd412", "committedDate": "2020-04-21T10:24:57Z", "message": "tests: add test to verify writeFraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9df4713854a2318c148f322b35afbbce7a83f3d1", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/9df4713854a2318c148f322b35afbbce7a83f3d1", "committedDate": "2020-04-21T10:24:57Z", "message": "fix: sessions being prepared should be included in comparison"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0dfa0872e1cfbb48d835796f5845f40b7205a97", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a0dfa0872e1cfbb48d835796f5845f40b7205a97", "committedDate": "2020-04-21T10:31:48Z", "message": "fix: update renamed mock server"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6ede807a5e47417fa2426bde853c27c9ae2e9bae", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/6ede807a5e47417fa2426bde853c27c9ae2e9bae", "committedDate": "2020-04-21T09:54:01Z", "message": "fix: sessions being prepared should be included in comparison"}, "afterCommit": {"oid": "a0dfa0872e1cfbb48d835796f5845f40b7205a97", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/a0dfa0872e1cfbb48d835796f5845f40b7205a97", "committedDate": "2020-04-21T10:31:48Z", "message": "fix: update renamed mock server"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 886, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}