{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTkyOTI1", "number": 65, "title": "feat: add session timeout metric", "bodyText": "Updates #53 and continuation of #54\nNew Metric:\ncloud.google.com/java/spanner/get_sessions_timeout => The number of get session timeouts due to pool exhaustion. This value is continuously increasing, so decided to use Cumulative (or Counter) type to record it.", "createdAt": "2020-02-07T01:34:08Z", "url": "https://github.com/googleapis/java-spanner/pull/65", "merged": true, "mergeCommit": {"oid": "8d84b53efd2d237e193b68bc36345d338b0cdf20"}, "closed": true, "closedAt": "2020-02-14T18:30:41Z", "author": {"login": "mayurkale22"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcB8nU-AFqTM1NTA1MDg5NA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEG_wfgFqTM1ODY5NDM1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDUwODk0", "url": "https://github.com/googleapis/java-spanner/pull/65#pullrequestreview-355050894", "createdAt": "2020-02-07T10:07:36Z", "commit": {"oid": "2d8d25fee52ab92c4a2cc54c3aab86da3296ffbe"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDowNzozNlrOFm4JfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMDoxNjoyNVrOFm4ZZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxMDE0MQ==", "bodyText": "Suggestion: Call this GET_SESSION_TIMEOUT, as it is not a timeout on (a) session(s), but a timeout to get a session.", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r376310141", "createdAt": "2020-02-07T10:07:36Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -45,9 +45,13 @@\n   static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n   static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String SESSIONS_TIMEOUT = \"cloud.google.com/java/spanner/sessions_timeout\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d8d25fee52ab92c4a2cc54c3aab86da3296ffbe"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxMDUzMQ==", "bodyText": "Suggestion: \"The number of get session timeouts due to pool exhaustion\"", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r376310531", "createdAt": "2020-02-07T10:08:29Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -45,9 +45,13 @@\n   static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n   static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String SESSIONS_TIMEOUT = \"cloud.google.com/java/spanner/sessions_timeout\";\n+\n   static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n       \"The maximum number of sessions in use during the last 10 minute interval.\";\n   static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n       \"The maximum number of sessions allowed. Configurable by the user.\";\n   static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use.\";\n+  static final String SESSIONS_TIMEOUT_DESCRIPTION =\n+      \"The count of number of sessions timeout due to pool exhaustion\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d8d25fee52ab92c4a2cc54c3aab86da3296ffbe"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjMxNDIxNA==", "bodyText": "I'm a little bit worried that this assert could turn out to be flaky. If I understand the test code correctly, the get session timeout will happen for the first time after 20ms. You poll the number of timeouts every 5ms and break the loop if you have at least 1 timeout. If the following lines of code happen to take more than 15ms to execute, you might have more than 1 timeouts in your metrics. Would it be possible to make this assert check that the number of timeouts is at least 1 (instead of equal to 1)?", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r376314214", "createdAt": "2020-02-07T10:16:25Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/test/java/com/google/cloud/spanner/SessionPoolTest.java", "diffHunk": "@@ -1583,16 +1585,45 @@ public void testSessionMetrics() {\n     Session session2 = pool.getReadSession();\n \n     MetricsRecord record = metricRegistry.pollRecord();\n+    assertThat(record.getMetrics().size()).isEqualTo(4);\n     assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.IN_USE_SESSIONS, 2L);\n     assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.MAX_IN_USE_SESSIONS, 2L);\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.SESSIONS_TIMEOUT, 0L);\n     assertThat(record.getMetrics())\n         .containsEntry(\n             MetricRegistryConstants.MAX_ALLOWED_SESSIONS, (long) options.getMaxSessions());\n     assertThat(record.getLabels()).containsEntry(SPANNER_LABEL_KEYS, labelValues);\n \n+    final CountDownLatch latch = new CountDownLatch(1);\n+    // Try asynchronously to take another session. This attempt should time out.\n+    Future<Void> fut =\n+        executor.submit(\n+            new Callable<Void>() {\n+              @Override\n+              public Void call() {\n+                latch.countDown();\n+                Session session = pool.getReadSession();\n+                session.close();\n+                return null;\n+              }\n+            });\n+    // Wait until the background thread is actually waiting for a session.\n+    latch.await();\n+    // Wait until the request has timed out.\n+    int waitCount = 0;\n+    while (pool.getNumWaiterTimeouts() == 0L && waitCount < 1000) {\n+      Thread.sleep(5L);\n+      waitCount++;\n+    }\n+    // Return the checked out session to the pool so the async request will get a session and\n+    // finish.\n     session2.close();\n-    session1.close();\n+    // Verify that the async request also succeeds.\n+    fut.get(10L, TimeUnit.SECONDS);\n+    executor.shutdown();\n \n+    session1.close();\n+    assertThat(record.getMetrics()).containsEntry(MetricRegistryConstants.SESSIONS_TIMEOUT, 1L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d8d25fee52ab92c4a2cc54c3aab86da3296ffbe"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NTM2NjM3", "url": "https://github.com/googleapis/java-spanner/pull/65#pullrequestreview-355536637", "createdAt": "2020-02-08T08:07:23Z", "commit": {"oid": "4184203d5485b9b29cf481882814d61da9e2db80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MTM3MzE3", "url": "https://github.com/googleapis/java-spanner/pull/65#pullrequestreview-356137317", "createdAt": "2020-02-10T17:47:45Z", "commit": {"oid": "4184203d5485b9b29cf481882814d61da9e2db80"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzo0Nzo0NVrOFnvi1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxNzo0OTozM1rOFnvmpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxNzc0OQ==", "bodyText": "not sure about the name get_sessions_timeout. Maybe session_open_retries? This would go well with other metrics session_opened and sessions_closed if those are implemented.", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r377217749", "createdAt": "2020-02-10T17:47:45Z", "author": {"login": "rghetia"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -45,9 +45,13 @@\n   static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n   static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String GET_SESSION_TIMEOUT = \"cloud.google.com/java/spanner/get_sessions_timeout\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4184203d5485b9b29cf481882814d61da9e2db80"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzIxODcyNg==", "bodyText": "Based on previous comment this could be changed to\nThe number of retries to open a session. Retries occur when session pool is exhausted.", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r377218726", "createdAt": "2020-02-10T17:49:33Z", "author": {"login": "rghetia"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -45,9 +45,13 @@\n   static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n   static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String GET_SESSION_TIMEOUT = \"cloud.google.com/java/spanner/get_sessions_timeout\";\n+\n   static final String MAX_IN_USE_SESSIONS_DESCRIPTION =\n       \"The maximum number of sessions in use during the last 10 minute interval.\";\n   static final String MAX_ALLOWED_SESSIONS_DESCRIPTION =\n       \"The maximum number of sessions allowed. Configurable by the user.\";\n   static final String IN_USE_SESSIONS_DESCRIPTION = \"The number of sessions currently in use.\";\n+  static final String SESSIONS_TIMEOUT_DESCRIPTION =\n+      \"The number of get session timeouts due to pool exhaustion\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4184203d5485b9b29cf481882814d61da9e2db80"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3OTQ2NTMw", "url": "https://github.com/googleapis/java-spanner/pull/65#pullrequestreview-357946530", "createdAt": "2020-02-13T04:22:27Z", "commit": {"oid": "2ddb9c11f2ea16183f03881ede321a416218d639"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDoyMjoyN1rOFpGn9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwNDoyMjoyN1rOFpGn9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODY0NDQ3MQ==", "bodyText": "There's a discrepancy in the naming here.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n              static final String GET_SESSION_TIMEOUTS = \"cloud.google.com/java/spanner/get_sessions_timeouts\";\n          \n          \n            \n              static final String GET_SESSIONS_TIMEOUTS = \"cloud.google.com/java/spanner/get_sessions_timeouts\";", "url": "https://github.com/googleapis/java-spanner/pull/65#discussion_r378644471", "createdAt": "2020-02-13T04:22:27Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/MetricRegistryConstants.java", "diffHunk": "@@ -42,12 +42,16 @@\n   static final String COUNT = \"1\";\n \n   // The Metric name and description\n-  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_session\";\n+  static final String MAX_IN_USE_SESSIONS = \"cloud.google.com/java/spanner/max_in_use_sessions\";\n   static final String MAX_ALLOWED_SESSIONS = \"cloud.google.com/java/spanner/max_allowed_sessions\";\n   static final String IN_USE_SESSIONS = \"cloud.google.com/java/spanner/in_use_sessions\";\n+  static final String GET_SESSION_TIMEOUTS = \"cloud.google.com/java/spanner/get_sessions_timeouts\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ddb9c11f2ea16183f03881ede321a416218d639"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dc65447405c0c11a40bc51aa5e230056194c527", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/2dc65447405c0c11a40bc51aa5e230056194c527", "committedDate": "2020-02-13T04:38:49Z", "message": "feat: add session timeout metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2a2e975c1fc25f4315f215b20e84dae96081703", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/d2a2e975c1fc25f4315f215b20e84dae96081703", "committedDate": "2020-02-13T04:38:49Z", "message": "minor patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "608004f78abad4f4968a1b9450fdcbd35b92147f", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/608004f78abad4f4968a1b9450fdcbd35b92147f", "committedDate": "2020-02-13T04:38:49Z", "message": "rename metric name and description"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94e5a8878b8910d0c9000be294838ff011828be4", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/94e5a8878b8910d0c9000be294838ff011828be4", "committedDate": "2020-02-13T04:38:49Z", "message": "fix potential flaky test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "581460117209c9bb0ec545e39d0bd09d8bf1b9f3", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/581460117209c9bb0ec545e39d0bd09d8bf1b9f3", "committedDate": "2020-02-13T04:38:49Z", "message": "fix code format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2ffc9f28415055c1e37148b5408920fcf5c7e71", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/d2ffc9f28415055c1e37148b5408920fcf5c7e71", "committedDate": "2020-02-13T04:38:49Z", "message": "update metric name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3dea395dd2b394e65934dcf8e0bb63754340d94", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/e3dea395dd2b394e65934dcf8e0bb63754340d94", "committedDate": "2020-02-13T04:38:49Z", "message": "minor nit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3799554dc9207771c4b664f55360330dcc5ff3f", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/f3799554dc9207771c4b664f55360330dcc5ff3f", "committedDate": "2020-02-13T04:42:08Z", "message": "fix review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ddb9c11f2ea16183f03881ede321a416218d639", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/2ddb9c11f2ea16183f03881ede321a416218d639", "committedDate": "2020-02-10T22:56:16Z", "message": "minor nit"}, "afterCommit": {"oid": "f3799554dc9207771c4b664f55360330dcc5ff3f", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/f3799554dc9207771c4b664f55360330dcc5ff3f", "committedDate": "2020-02-13T04:42:08Z", "message": "fix review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67058f13b1ef30db42cc1ecf6008aefb4783bf6d", "author": {"user": {"login": "mayurkale22", "name": "Mayur Kale"}}, "url": "https://github.com/googleapis/java-spanner/commit/67058f13b1ef30db42cc1ecf6008aefb4783bf6d", "committedDate": "2020-02-14T03:24:16Z", "message": "rename get_sessions_timeouts to get_session_timeouts"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4Njk0MzUx", "url": "https://github.com/googleapis/java-spanner/pull/65#pullrequestreview-358694351", "createdAt": "2020-02-14T03:30:51Z", "commit": {"oid": "67058f13b1ef30db42cc1ecf6008aefb4783bf6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 858, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}