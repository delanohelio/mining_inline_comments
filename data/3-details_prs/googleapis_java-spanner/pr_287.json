{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3MDY3NjUx", "number": 287, "title": "perf: use streaming RPC for PDML", "bodyText": "Changes Partitioned DML from using the ExecuteSql RPC to ExecuteStreamingSql.", "createdAt": "2020-06-19T12:13:43Z", "url": "https://github.com/googleapis/java-spanner/pull/287", "merged": true, "mergeCommit": {"oid": "df47c13a4c00bdf5e6eafa01bbb64c12a96d7fb8"}, "closed": true, "closedAt": "2020-06-30T15:25:30Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsx_KGgH2gAyNDM3MDY3NjUxOjhmNjdkZDc0N2M1NTFlZDgxZTlkMDM5ODc1YWIxNTBlMTBhZGYwNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwW0-IgH2gAyNDM3MDY3NjUxOjg1MGU0YTFhMzcxOGU2ZTEzOTIwZDc2MTJhNWIyNzBlZWNhZTVlNmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8f67dd747c551ed81e9d039875ab150e10adf066", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/8f67dd747c551ed81e9d039875ab150e10adf066", "committedDate": "2020-06-19T12:13:05Z", "message": "perf: use streaming RPC for PDML"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7981059ae935ce3da61f35df1cdba09390dfd037", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/7981059ae935ce3da61f35df1cdba09390dfd037", "committedDate": "2020-06-19T12:26:53Z", "message": "fix: reset resume token for each tx"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5235a38bd38a668d1671800650ffa2def26c9b9a", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5235a38bd38a668d1671800650ffa2def26c9b9a", "committedDate": "2020-06-19T14:58:49Z", "message": "cleanup: remove test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51930fa426c1d6377fda9d68283461164ee838d5", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/51930fa426c1d6377fda9d68283461164ee838d5", "committedDate": "2020-06-20T16:23:19Z", "message": "fix: retry depening on resume token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff3ce4ba0e3ad6f0359c179eaabff87939b3613", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/3ff3ce4ba0e3ad6f0359c179eaabff87939b3613", "committedDate": "2020-06-20T19:10:37Z", "message": "fix: remove unused attempt param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ca881314819f07026c912d888510d392f3ca77", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/82ca881314819f07026c912d888510d392f3ca77", "committedDate": "2020-06-22T08:53:14Z", "message": "fix: fix check for resume token"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0808d9fb7363f6f7a3889c7fa7de27f513a6a7f8", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/0808d9fb7363f6f7a3889c7fa7de27f513a6a7f8", "committedDate": "2020-06-24T12:34:09Z", "message": "fix: keep track of total timeout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "223bd1ae59bcdb05a18fe4bcb76e73a0f076dce7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/223bd1ae59bcdb05a18fe4bcb76e73a0f076dce7", "committedDate": "2020-06-24T13:02:08Z", "message": "fix: clirr build failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5689e53cd9e3bb5863382c0a46145cbf329f8098", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5689e53cd9e3bb5863382c0a46145cbf329f8098", "committedDate": "2020-06-24T16:56:20Z", "message": "cleanup: add comments + remove unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c9cdf3c5787203e35cdfa4cd740029b25ae080", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/77c9cdf3c5787203e35cdfa4cd740029b25ae080", "committedDate": "2020-06-24T17:16:14Z", "message": "tests: add missing exec time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52f91e3af1c20030b0f416ce0789447866065cfb", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/52f91e3af1c20030b0f416ce0789447866065cfb", "committedDate": "2020-06-24T17:19:19Z", "message": "chore: run formatter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NjcyMjYw", "url": "https://github.com/googleapis/java-spanner/pull/287#pullrequestreview-439672260", "createdAt": "2020-06-30T05:05:05Z", "commit": {"oid": "52f91e3af1c20030b0f416ce0789447866065cfb"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNTowNTowNlrOGqr1ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwNTowNTowNlrOGqr1ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQxMTU3OQ==", "bodyText": "nit: I don't know if you need to check for the resumeToken != null condition since you always init it to EMPTY and only update it if it's not null.", "url": "https://github.com/googleapis/java-spanner/pull/287#discussion_r447411579", "createdAt": "2020-06-30T05:05:06Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/PartitionedDMLTransaction.java", "diffHunk": "@@ -60,41 +72,88 @@ private ByteString initTransaction() {\n \n   /**\n    * Executes the {@link Statement} using a partitioned dml transaction with automatic retry if the\n-   * transaction was aborted.\n+   * transaction was aborted. The update method uses the ExecuteStreamingSql RPC to execute the\n+   * statement, and will retry the stream if an {@link UnavailableException} is thrown, using the\n+   * last seen resume token if the server returns any.\n    */\n-  long executePartitionedUpdate(final Statement statement) {\n+  long executeStreamingPartitionedUpdate(final Statement statement, Duration timeout) {\n     checkState(isValid, \"Partitioned DML has been invalidated by a new operation on the session\");\n-    Callable<com.google.spanner.v1.ResultSet> callable =\n-        new Callable<com.google.spanner.v1.ResultSet>() {\n-          @Override\n-          public com.google.spanner.v1.ResultSet call() throws Exception {\n-            ByteString transactionId = initTransaction();\n-            final ExecuteSqlRequest.Builder builder =\n-                ExecuteSqlRequest.newBuilder()\n-                    .setSql(statement.getSql())\n-                    .setQueryMode(QueryMode.NORMAL)\n-                    .setSession(session.getName())\n-                    .setTransaction(TransactionSelector.newBuilder().setId(transactionId).build());\n-            Map<String, Value> stmtParameters = statement.getParameters();\n-            if (!stmtParameters.isEmpty()) {\n-              com.google.protobuf.Struct.Builder paramsBuilder = builder.getParamsBuilder();\n-              for (Map.Entry<String, Value> param : stmtParameters.entrySet()) {\n-                paramsBuilder.putFields(param.getKey(), param.getValue().toProto());\n-                builder.putParamTypes(param.getKey(), param.getValue().getType().toProto());\n+    log.log(Level.FINER, \"Starting PartitionedUpdate statement\");\n+    boolean foundStats = false;\n+    long updateCount = 0L;\n+    Duration remainingTimeout = timeout;\n+    Stopwatch stopWatch = Stopwatch.createStarted();\n+    try {\n+      // Loop to catch AbortedExceptions.\n+      while (true) {\n+        ByteString resumeToken = ByteString.EMPTY;\n+        try {\n+          ByteString transactionId = initTransaction();\n+          final ExecuteSqlRequest.Builder builder =\n+              ExecuteSqlRequest.newBuilder()\n+                  .setSql(statement.getSql())\n+                  .setQueryMode(QueryMode.NORMAL)\n+                  .setSession(session.getName())\n+                  .setTransaction(TransactionSelector.newBuilder().setId(transactionId).build());\n+          Map<String, Value> stmtParameters = statement.getParameters();\n+          if (!stmtParameters.isEmpty()) {\n+            com.google.protobuf.Struct.Builder paramsBuilder = builder.getParamsBuilder();\n+            for (Map.Entry<String, Value> param : stmtParameters.entrySet()) {\n+              paramsBuilder.putFields(param.getKey(), param.getValue().toProto());\n+              builder.putParamTypes(param.getKey(), param.getValue().getType().toProto());\n+            }\n+          }\n+          while (true) {\n+            remainingTimeout =\n+                remainingTimeout.minus(stopWatch.elapsed(TimeUnit.MILLISECONDS), ChronoUnit.MILLIS);\n+            try {\n+              builder.setResumeToken(resumeToken);\n+              ServerStream<PartialResultSet> stream =\n+                  rpc.executeStreamingPartitionedDml(\n+                      builder.build(), session.getOptions(), remainingTimeout);\n+              for (PartialResultSet rs : stream) {\n+                if (rs.getResumeToken() != null && !ByteString.EMPTY.equals(rs.getResumeToken())) {\n+                  resumeToken = rs.getResumeToken();\n+                }\n+                if (rs.hasStats()) {\n+                  foundStats = true;\n+                  updateCount += rs.getStats().getRowCountLowerBound();\n+                }\n+              }\n+              break;\n+            } catch (UnavailableException e) {\n+              // Retry the stream in the same transaction if the stream breaks with\n+              // UnavailableException and we have a resume token. Otherwise, we just retry the\n+              // entire transaction.\n+              if (resumeToken != null && !ByteString.EMPTY.equals(resumeToken)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "52f91e3af1c20030b0f416ce0789447866065cfb"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32acacb7e83f2ca798fad2e630634a4bfcb49452", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/32acacb7e83f2ca798fad2e630634a4bfcb49452", "committedDate": "2020-06-30T14:21:24Z", "message": "chore: remove unnecessary null check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e803a5906c0ab09b3d14d90a6a4c515e6cbb8f6", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/9e803a5906c0ab09b3d14d90a6a4c515e6cbb8f6", "committedDate": "2020-06-30T14:25:29Z", "message": "Merge branch 'master' into streaming-pdml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "850e4a1a3718e6e13920d7612a5b270eecae5e6d", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/850e4a1a3718e6e13920d7612a5b270eecae5e6d", "committedDate": "2020-06-30T14:50:13Z", "message": "tests: add missing exec time"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 853, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}