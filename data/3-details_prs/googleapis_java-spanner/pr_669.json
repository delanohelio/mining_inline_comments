{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2NTEwMzk3", "number": 669, "title": "feat: retry admin request limit exceeded error", "bodyText": "Automatically retry requests that fail because the admin requests per seconds limit has been exceeded using an exponential backoff.\nFixes #655 and others", "createdAt": "2020-11-24T14:17:40Z", "url": "https://github.com/googleapis/java-spanner/pull/669", "merged": true, "mergeCommit": {"oid": "3f9f74aed52bce681b4bfd10d1006e5fa05b7cc9"}, "closed": true, "closedAt": "2020-11-30T23:04:22Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfqba3gH2gAyNTI2NTEwMzk3OjMxNzQyNGIxMmI0MmE5N2Y3MGVhYzA2ZWE2ZGJiZmExOGM1M2RiNGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgips6AH2gAyNTI2NTEwMzk3OjQ0MWRjZjI1MWRlODVlNzQ3ZDU2ODIwZGUyNDA1OWYxZDM5Nzc3OWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "317424b12b42a97f70eac06ea6dbbfa18c53db4e", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/317424b12b42a97f70eac06ea6dbbfa18c53db4e", "committedDate": "2020-11-24T14:14:51Z", "message": "feat: retry admin request limit exceeded error\n\nAutomatically retry requests that fail because the admin requests per seconds\nlimit has been exceeded using an exponential backoff.\n\nFixes #655 and others"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fc862ab2270cdeea506e181b7745bba14d85e19", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/4fc862ab2270cdeea506e181b7745bba14d85e19", "committedDate": "2020-11-24T14:17:30Z", "message": "fix: remove unused variable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3OTg5Njkz", "url": "https://github.com/googleapis/java-spanner/pull/669#pullrequestreview-537989693", "createdAt": "2020-11-24T21:46:11Z", "commit": {"oid": "4fc862ab2270cdeea506e181b7745bba14d85e19"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMTo0NjoxMVrOH5WbEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQyMTo0NjoxMVrOH5WbEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTg5ODI1OQ==", "bodyText": "nit: could we extract constants for the literal Strings?", "url": "https://github.com/googleapis/java-spanner/pull/669#discussion_r529898259", "createdAt": "2020-11-24T21:46:11Z", "author": {"login": "thiagotnunes"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SpannerExceptionFactory.java", "diffHunk": "@@ -213,13 +216,31 @@ private static ResourceInfo extractResourceInfo(Throwable cause) {\n     return null;\n   }\n \n+  private static ErrorInfo extractErrorInfo(Throwable cause) {\n+    if (cause != null) {\n+      Metadata trailers = Status.trailersFromThrowable(cause);\n+      if (trailers != null) {\n+        return trailers.get(KEY_ERROR_INFO);\n+      }\n+    }\n+    return null;\n+  }\n+\n   static SpannerException newSpannerExceptionPreformatted(\n       ErrorCode code, @Nullable String message, @Nullable Throwable cause) {\n     // This is the one place in the codebase that is allowed to call constructors directly.\n     DoNotConstructDirectly token = DoNotConstructDirectly.ALLOWED;\n     switch (code) {\n       case ABORTED:\n         return new AbortedException(token, message, cause);\n+      case RESOURCE_EXHAUSTED:\n+        ErrorInfo info = extractErrorInfo(cause);\n+        if (info != null\n+            && info.getMetadataMap().containsKey(\"quota_limit\")\n+            && \"AdminMethodQuotaPerMinutePerProject\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fc862ab2270cdeea506e181b7745bba14d85e19"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "441dcf251de85e747d56820de24059f1d397779a", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/441dcf251de85e747d56820de24059f1d397779a", "committedDate": "2020-11-27T07:45:08Z", "message": "fix: extract strings to constants"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 924, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}