{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5MDAzMTQx", "number": 734, "title": "fix: reduce the probability of RESOURCE_EXHAUSTED errors during tests", "bodyText": "Reduces the probability of RESOURCE_EXHAUSTED errors during tests by making the GetOperation method retry errors with this code with an exponential backoff. The GetOperation method is called repeatedly for long-running operations by a polling future. These calls also count towards the max 5 admin requests per second.\nFixes #733", "createdAt": "2020-12-13T19:06:57Z", "url": "https://github.com/googleapis/java-spanner/pull/734", "merged": true, "mergeCommit": {"oid": "cd946d71501a2af7a2b3bb986ef75272c3ed92e1"}, "closed": true, "closedAt": "2020-12-16T22:54:00Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdl17pSgH2gAyNTM5MDAzMTQxOmRhOGI2NjZmM2E5NGI0NWM3M2FlOTU4YzljNDkyYWVmZTBjMTM0YjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm3CaJAFqTU1NDE1MDg5MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "da8b666f3a94b45c73ae958c9c492aefe0c134b6", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/da8b666f3a94b45c73ae958c9c492aefe0c134b6", "committedDate": "2020-12-13T19:02:33Z", "message": "fix: reduce the probability of RESOURCE_EXHAUSTED errors during tests\n\nReduces the probability of RESOURCE_EXHAUSTED errors during tests by making the\nGetOperation method retry errors with this code with an exponential backoff.\nThe GetOperation method is called repeatedly for long-running operations by a\npolling future. These calls also count towards the max 5 admin requests per second.\n\nFixes #733"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ca6794d1223983744369b0419507a69ce31ff3", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/85ca6794d1223983744369b0419507a69ce31ff3", "committedDate": "2020-12-13T19:06:47Z", "message": "fix: use default retry settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTQ5ODgw", "url": "https://github.com/googleapis/java-spanner/pull/734#pullrequestreview-550949880", "createdAt": "2020-12-13T19:08:52Z", "commit": {"oid": "85ca6794d1223983744369b0419507a69ce31ff3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxOTowODo1MlrOIE4Jdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxOTowODo1MlrOIE4Jdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk4NTE0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            callSettings =\n          \n          \n            \n                                callSettings\n          \n          \n            \n                                    .toBuilder()\n          \n          \n            \n                                    .setRetryableCodes(codes)\n          \n          \n            \n                                    .build();\n          \n          \n            \n                            callSettings = callSettings.toBuilder().setRetryableCodes(codes).build();", "url": "https://github.com/googleapis/java-spanner/pull/734#discussion_r541985143", "createdAt": "2020-12-13T19:08:52Z", "author": {"login": "yoshi-code-bot"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -428,7 +435,37 @@ public GapicSpannerRpc(final SpannerOptions options) {\n               .setCredentialsProvider(credentialsProvider)\n               .setStreamWatchdogProvider(watchdogProvider)\n               .build();\n-      this.databaseAdminStub = GrpcDatabaseAdminStub.create(this.databaseAdminStubSettings);\n+      GrpcStubCallableFactory factory =\n+          new GrpcDatabaseAdminCallableFactory() {\n+            @Override\n+            public <RequestT, ResponseT> UnaryCallable<RequestT, ResponseT> createUnaryCallable(\n+                GrpcCallSettings<RequestT, ResponseT> grpcCallSettings,\n+                UnaryCallSettings<RequestT, ResponseT> callSettings,\n+                ClientContext clientContext) {\n+              // Make GetOperation retry on RESOURCE_EXHAUSTED to prevent polling operations from\n+              // failing with an Administrative requests limit exceeded error.\n+              if (grpcCallSettings\n+                  .getMethodDescriptor()\n+                  .getFullMethodName()\n+                  .equals(\"google.longrunning.Operations/GetOperation\")) {\n+                Set<StatusCode.Code> codes =\n+                    ImmutableSet.<StatusCode.Code>builderWithExpectedSize(\n+                            callSettings.getRetryableCodes().size() + 1)\n+                        .addAll(callSettings.getRetryableCodes())\n+                        .add(StatusCode.Code.RESOURCE_EXHAUSTED)\n+                        .build();\n+                callSettings =\n+                    callSettings\n+                        .toBuilder()\n+                        .setRetryableCodes(codes)\n+                        .build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ca6794d1223983744369b0419507a69ce31ff3"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "167ae14cc0e0e60f48e87b69236acf75017d56d4", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/167ae14cc0e0e60f48e87b69236acf75017d56d4", "committedDate": "2020-12-13T19:21:16Z", "message": "chore: run formatter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwOTUxMDk5", "url": "https://github.com/googleapis/java-spanner/pull/734#pullrequestreview-550951099", "createdAt": "2020-12-13T19:22:33Z", "commit": {"oid": "167ae14cc0e0e60f48e87b69236acf75017d56d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxOToyMjozM1rOIE4TCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xM1QxOToyMjozM1rOIE4TCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MTk4NzU5Mw==", "bodyText": "It would be preferable if this could be changed in the generated code, but I don't know whether that is possible considering this comes from the generic com.google.longrunning.stub.OperationsStub.", "url": "https://github.com/googleapis/java-spanner/pull/734#discussion_r541987593", "createdAt": "2020-12-13T19:22:33Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -428,7 +435,33 @@ public GapicSpannerRpc(final SpannerOptions options) {\n               .setCredentialsProvider(credentialsProvider)\n               .setStreamWatchdogProvider(watchdogProvider)\n               .build();\n-      this.databaseAdminStub = GrpcDatabaseAdminStub.create(this.databaseAdminStubSettings);\n+      GrpcStubCallableFactory factory =\n+          new GrpcDatabaseAdminCallableFactory() {\n+            @Override\n+            public <RequestT, ResponseT> UnaryCallable<RequestT, ResponseT> createUnaryCallable(\n+                GrpcCallSettings<RequestT, ResponseT> grpcCallSettings,\n+                UnaryCallSettings<RequestT, ResponseT> callSettings,\n+                ClientContext clientContext) {\n+              // Make GetOperation retry on RESOURCE_EXHAUSTED to prevent polling operations from\n+              // failing with an Administrative requests limit exceeded error.\n+              if (grpcCallSettings\n+                  .getMethodDescriptor()\n+                  .getFullMethodName()\n+                  .equals(\"google.longrunning.Operations/GetOperation\")) {\n+                Set<StatusCode.Code> codes =\n+                    ImmutableSet.<StatusCode.Code>builderWithExpectedSize(\n+                            callSettings.getRetryableCodes().size() + 1)\n+                        .addAll(callSettings.getRetryableCodes())\n+                        .add(StatusCode.Code.RESOURCE_EXHAUSTED)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "167ae14cc0e0e60f48e87b69236acf75017d56d4"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8fef88dff5e8a9cecba10be88703df8c0e8d241", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/c8fef88dff5e8a9cecba10be88703df8c0e8d241", "committedDate": "2020-12-14T10:46:07Z", "message": "Merge branch 'master' into reduce-resource-exhausted-errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918d4afbef484e81e8658ef67fa2df11762620cf", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/918d4afbef484e81e8658ef67fa2df11762620cf", "committedDate": "2020-12-16T14:58:54Z", "message": "Merge branch 'master' into reduce-resource-exhausted-errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76bcbec7a7d928cb73055cbcb1c9ef0995b157ce", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/76bcbec7a7d928cb73055cbcb1c9ef0995b157ce", "committedDate": "2020-12-16T15:10:24Z", "message": "fix: only retry RESOURCE_EXHAUSTED when throttling requests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MTUwODkx", "url": "https://github.com/googleapis/java-spanner/pull/734#pullrequestreview-554150891", "createdAt": "2020-12-16T22:53:46Z", "commit": {"oid": "76bcbec7a7d928cb73055cbcb1c9ef0995b157ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 942, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}