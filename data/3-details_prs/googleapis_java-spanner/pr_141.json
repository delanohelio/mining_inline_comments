{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMTI0MzI0", "number": 141, "title": "fix: retry non-idempotent long-running RPCs", "bodyText": "RPCs returning a long-running operation, such as CreateDatabase, CreateBackup and RestoreDatabase, are non-idempotent and cannot be retried automatically by gax. This means that these RPCs sometimes fail with transient errors, such as UNAVAILABLE or DEADLINE_EXCEEDED. This change introduces automatic retries of these RPCs using the following logic:\n\nExecute the RPC and wait for the operation to be returned.\nIf a transient error occurs while waiting for the operation, the client library queries the backend for the corresponding operation. If the operation is found, the resumes the tracking of the existing operation and returns that to the user.\nIf no corresponding operation is found in step 2, the client library retries the RPC from step 1.\n\nFixes GoogleCloudPlatform/java-docs-samples#2571", "createdAt": "2020-04-07T08:39:42Z", "url": "https://github.com/googleapis/java-spanner/pull/141", "merged": true, "mergeCommit": {"oid": "4669c02a24e0f7b1d53c9edf5ab7b146b4116960"}, "closed": true, "closedAt": "2020-04-13T09:00:13Z", "author": {"login": "olavloite"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVh-VtgFqTM4OTY4NjEzMA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWToQbgBqjMyMjIzNjUwNzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5Njg2MTMw", "url": "https://github.com/googleapis/java-spanner/pull/141#pullrequestreview-389686130", "createdAt": "2020-04-08T06:33:27Z", "commit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5ODIxNzUz", "url": "https://github.com/googleapis/java-spanner/pull/141#pullrequestreview-389821753", "createdAt": "2020-04-08T09:51:22Z", "commit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo1MToyM1rOGCntIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwOTo1MToyM1rOGCntIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTQwMDg2Nw==", "bodyText": "I think we don't specify retry settings for non-idempotent RPCs. Do you know what this will default to then?", "url": "https://github.com/googleapis/java-spanner/pull/141#discussion_r405400867", "createdAt": "2020-04-08T09:51:23Z", "author": {"login": "skuruppu"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/spi/v1/GapicSpannerRpc.java", "diffHunk": "@@ -584,30 +780,92 @@ public Database getDatabase(String databaseName) throws SpannerException {\n \n   @Override\n   public OperationFuture<Backup, CreateBackupMetadata> createBackup(\n-      String instanceName, String backupId, Backup backup) throws SpannerException {\n-    acquireAdministrativeRequestsRateLimiter();\n+      final String instanceName, final String backupId, final Backup backup)\n+      throws SpannerException {\n     CreateBackupRequest request =\n         CreateBackupRequest.newBuilder()\n             .setParent(instanceName)\n             .setBackupId(backupId)\n             .setBackup(backup)\n             .build();\n-    GrpcCallContext context = newCallContext(null, instanceName);\n-    return databaseAdminStub.createBackupOperationCallable().futureCall(request, context);\n+    OperationFutureCallable<CreateBackupRequest, Backup, CreateBackupMetadata> callable =\n+        new OperationFutureCallable<CreateBackupRequest, Backup, CreateBackupMetadata>(\n+            CreateBackupMetadata.class,\n+            databaseAdminStub.createBackupOperationCallable(),\n+            request,\n+            instanceName,\n+            new OperationsLister() {\n+              @Override\n+              public Paginated<Operation> listOperations(String nextPageToken) {\n+                return listBackupOperations(\n+                    instanceName,\n+                    0,\n+                    String.format(\n+                        \"(metadata.name:%s) AND (metadata.@type:type.googleapis.com/%s)\",\n+                        String.format(\"%s/backups/%s\", instanceName, backupId),\n+                        CreateBackupMetadata.getDescriptor().getFullName()),\n+                    nextPageToken);\n+              }\n+            },\n+            new Function<CreateBackupMetadata, Timestamp>() {\n+              @Override\n+              public Timestamp apply(CreateBackupMetadata input) {\n+                return input.getProgress().getStartTime();\n+              }\n+            });\n+    return RetryHelper.runWithRetries(\n+        callable,\n+        databaseAdminStubSettings\n+            .createBackupOperationSettings()\n+            .getInitialCallSettings()\n+            .getRetrySettings(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169"}, "originalPosition": 349}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzc3NDQ3", "url": "https://github.com/googleapis/java-spanner/pull/141#pullrequestreview-390377447", "createdAt": "2020-04-08T22:34:09Z", "commit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjozNDowOVrOGDDUCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMjozNDowOVrOGDDUCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTg1MzE5Mw==", "bodyText": "Why do we need to manually specify the retryable codes here? In the gapic config file (https://github.com/googleapis/googleapis/blob/d741cd976975c745d0199987aff0e908b8352992/google/spanner/admin/database/v1/spanner_admin_database_grpc_service_config.json#L58-L67), updateBackup will retry DEADLINE_EXCEEDED and UNAVAILABLE. Shouldn't this code be auto-generated?\nI guess Java gapic code generator is using a different config file: https://github.com/googleapis/googleapis/blob/master/google/spanner/admin/database/v1/spanner_admin_database_gapic.yaml#L83-L86.", "url": "https://github.com/googleapis/java-spanner/pull/141#discussion_r405853193", "createdAt": "2020-04-08T22:34:09Z", "author": {"login": "hengfengli"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/SpannerOptions.java", "diffHunk": "@@ -291,7 +292,8 @@ private Builder() {\n           .setRetrySettings(longRunningRetrySettings);\n       databaseAdminStubSettingsBuilder\n           .updateBackupSettings()\n-          .setRetrySettings(longRunningRetrySettings);\n+          .setRetrySettings(longRunningRetrySettings)\n+          .setRetryableCodes(StatusCode.Code.DEADLINE_EXCEEDED, StatusCode.Code.UNAVAILABLE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bbb6fc64ffadb79a2d17bfb6a1c933f979db3b2", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/5bbb6fc64ffadb79a2d17bfb6a1c933f979db3b2", "committedDate": "2020-04-10T16:22:02Z", "message": "fix: retry non-idempotent long-running RPCs\n\nRPCs returning a long-running operation, such as CreateDatabase,\nCreateBackup and RestoreDatabase, are non-idempotent and cannot be\nretried automatically by gax. This means that these RPCs sometimes fail\nwith transient errors, such as UNAVAILABLE or DEADLINE_EXCEEDED. This\nchange introduces automatic retries of these RPCs using the following\nlogic:\n1. Execute the RPC and wait for the operation to be returned.\n2. If a transient error occurs while waiting for the operation, the\n   client library queries the backend for the corresponding operation.\n   If the operation is found, the resumes the tracking of the existing\n   operation and returns that to the user.\n3. If no corresponding operation is found in step 2, the client library\n   retries the RPC from step 1.\n\nFixes https://github.com/GoogleCloudPlatform/java-docs-samples/issues/2571"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e329a1bbe8762506f53a55d44834b29c8e070deb", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/e329a1bbe8762506f53a55d44834b29c8e070deb", "committedDate": "2020-04-10T16:22:02Z", "message": "fix: remove unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd96869a2ea1003d889a2747d6fcf70d25de95ca", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/cd96869a2ea1003d889a2747d6fcf70d25de95ca", "committedDate": "2020-04-10T16:22:02Z", "message": "tests: retry restore if it fails on max pending restores"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e9c4a6de7c268b3dd5b6b59e384e826d4605994", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/1e9c4a6de7c268b3dd5b6b59e384e826d4605994", "committedDate": "2020-04-10T16:22:02Z", "message": "fix: fix retry condition test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605b67204f76dffc5de4568a6aae63058feb7ac7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/605b67204f76dffc5de4568a6aae63058feb7ac7", "committedDate": "2020-04-10T16:22:02Z", "message": "fix: use create time of database for retries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "771ae9037fa3b503c76c49264ec7d093dc64b169", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/771ae9037fa3b503c76c49264ec7d093dc64b169", "committedDate": "2020-04-07T10:08:36Z", "message": "fix: fix retry condition test"}, "afterCommit": {"oid": "605b67204f76dffc5de4568a6aae63058feb7ac7", "author": {"user": {"login": "olavloite", "name": "Knut Olav L\u00f8ite"}}, "url": "https://github.com/googleapis/java-spanner/commit/605b67204f76dffc5de4568a6aae63058feb7ac7", "committedDate": "2020-04-10T16:22:02Z", "message": "fix: use create time of database for retries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 889, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}