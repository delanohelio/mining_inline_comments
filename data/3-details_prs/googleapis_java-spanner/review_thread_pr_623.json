{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTIwNzE1OTY1", "number": 623, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMTo1NToxN1rOE5Pd-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMTo1NjowN1rOE5PeZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NDU3NzIwOnYy", "diffSide": "RIGHT", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMTo1NToxN1rOHzlsEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMDoxNzo0NlrOHzzHCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NjkxMw==", "bodyText": "How will this behave if the user never set a transaction tag?", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r523856913", "createdAt": "2020-11-16T01:55:17Z", "author": {"login": "thiagotnunes"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -959,6 +1034,7 @@ private UnitOfWork createNewUnitOfWork() {\n               .setReadOnlyStaleness(readOnlyStaleness)\n               .setStatementTimeout(statementTimeout)\n               .withStatementExecutor(statementExecutor)\n+              .setTransactionTag(transactionTag)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fcbdd022d9bf610a437f237814e4147cf1106db"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3NjgxMA==", "bodyText": "It is nullable, so that is not a problem. It is verified by this test case.", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524076810", "createdAt": "2020-11-16T10:17:46Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -959,6 +1034,7 @@ private UnitOfWork createNewUnitOfWork() {\n               .setReadOnlyStaleness(readOnlyStaleness)\n               .setStatementTimeout(statementTimeout)\n               .withStatementExecutor(statementExecutor)\n+              .setTransactionTag(transactionTag)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NjkxMw=="}, "originalCommit": {"oid": "6fcbdd022d9bf610a437f237814e4147cf1106db"}, "originalPosition": 167}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI4NDU3ODMxOnYy", "diffSide": "RIGHT", "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQwMTo1NjowN1rOHzlsqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQxMzoxNTozOFrOHz-OhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ==", "bodyText": "Out of curiosity, could we prevent the calling of this for a COMMIT? The user should not be able to do a statement tag in that case.", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r523857065", "createdAt": "2020-11-16T01:56:07Z", "author": {"login": "thiagotnunes"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -476,6 +482,42 @@ public void setTransactionMode(TransactionMode transactionMode) {\n     this.unitOfWorkType = UnitOfWorkType.of(transactionMode);\n   }\n \n+  @Override\n+  public String getTransactionTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return transactionTag;\n+  }\n+\n+  @Override\n+  public void setTransactionTag(String tag) {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Cannot set transaction tag while in a batch\");\n+    ConnectionPreconditions.checkState(isInTransaction(), \"This connection has no transaction\");\n+    ConnectionPreconditions.checkState(\n+        !isTransactionStarted(),\n+        \"The transaction tag cannot be set after the transaction has started\");\n+\n+    this.transactionBeginMarked = true;\n+    this.transactionTag = tag;\n+  }\n+\n+  @Override\n+  public String getStatementTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return statementTag;\n+  }\n+\n+  @Override\n+  public void setStatementTag(String tag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fcbdd022d9bf610a437f237814e4147cf1106db"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDA3OTUwNw==", "bodyText": "Good question. We can't prevent it before the COMMIT, but we can throw an exception if COMMIT is called after a statement tag has been set, and I think that makes sense as we are quite strict in checking the order of other statements (e.g. you are only allowed to get a commit timestamp if you actually committed etc.).", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524079507", "createdAt": "2020-11-16T10:20:16Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -476,6 +482,42 @@ public void setTransactionMode(TransactionMode transactionMode) {\n     this.unitOfWorkType = UnitOfWorkType.of(transactionMode);\n   }\n \n+  @Override\n+  public String getTransactionTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return transactionTag;\n+  }\n+\n+  @Override\n+  public void setTransactionTag(String tag) {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Cannot set transaction tag while in a batch\");\n+    ConnectionPreconditions.checkState(isInTransaction(), \"This connection has no transaction\");\n+    ConnectionPreconditions.checkState(\n+        !isTransactionStarted(),\n+        \"The transaction tag cannot be set after the transaction has started\");\n+\n+    this.transactionBeginMarked = true;\n+    this.transactionTag = tag;\n+  }\n+\n+  @Override\n+  public String getStatementTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return statementTag;\n+  }\n+\n+  @Override\n+  public void setStatementTag(String tag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ=="}, "originalCommit": {"oid": "6fcbdd022d9bf610a437f237814e4147cf1106db"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDI1ODk0OQ==", "bodyText": "I've changed the implementation to check for this, and to throw an error if the application tries to set a statement tag for a COMMIT or ROLLBACK statement. This change also adds a change relating to DML batches: DML batches can only include one statement tag, as the statements are sent as one ExecuteBatchDmlRequest, which only allows one statement tag. This statement tag must be set before calling START BATCH DML, e.g.\nSET STATEMENT_TAG = 'tag-1';\nSTART BATCH DML;\nINSERT INTO Singers (SingerId, Name) VALUES (1, 'Morrison');\nINSERT INTO Singers (SingerId, Name) VALUES (2, 'Pieterson');\nRUN BATCH;", "url": "https://github.com/googleapis/java-spanner/pull/623#discussion_r524258949", "createdAt": "2020-11-16T13:15:38Z", "author": {"login": "olavloite"}, "path": "google-cloud-spanner/src/main/java/com/google/cloud/spanner/connection/ConnectionImpl.java", "diffHunk": "@@ -476,6 +482,42 @@ public void setTransactionMode(TransactionMode transactionMode) {\n     this.unitOfWorkType = UnitOfWorkType.of(transactionMode);\n   }\n \n+  @Override\n+  public String getTransactionTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return transactionTag;\n+  }\n+\n+  @Override\n+  public void setTransactionTag(String tag) {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(\n+        !isBatchActive(), \"Cannot set transaction tag while in a batch\");\n+    ConnectionPreconditions.checkState(isInTransaction(), \"This connection has no transaction\");\n+    ConnectionPreconditions.checkState(\n+        !isTransactionStarted(),\n+        \"The transaction tag cannot be set after the transaction has started\");\n+\n+    this.transactionBeginMarked = true;\n+    this.transactionTag = tag;\n+  }\n+\n+  @Override\n+  public String getStatementTag() {\n+    ConnectionPreconditions.checkState(!isClosed(), CLOSED_ERROR_MSG);\n+    ConnectionPreconditions.checkState(!isDdlBatchActive(), \"This connection is in a DDL batch\");\n+    return statementTag;\n+  }\n+\n+  @Override\n+  public void setStatementTag(String tag) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzg1NzA2NQ=="}, "originalCommit": {"oid": "6fcbdd022d9bf610a437f237814e4147cf1106db"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3324, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}