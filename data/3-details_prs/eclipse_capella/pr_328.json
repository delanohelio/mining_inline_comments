{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxNjEzOTA2", "number": 328, "title": "[566264] Some operations might create unwanted Entities as a side effect", "bodyText": "The problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture, boolean: TRUE) method in functions called at the Operational Level.\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru sandu.postaru@thalesgroup.com", "createdAt": "2020-08-21T12:49:18Z", "url": "https://github.com/eclipse/capella/pull/328", "merged": true, "mergeCommit": {"oid": "e65a310e32a47e0c495de7ceae964614c36a23cf"}, "closed": true, "closedAt": "2020-08-24T15:08:28Z", "author": {"login": "sandupostaru"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBGgIQgFqTQ3MjU4NTI1MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCD8eLgFqTQ3MzU4ODI1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTg1MjUw", "url": "https://github.com/eclipse/capella/pull/328#pullrequestreview-472585250", "createdAt": "2020-08-21T15:25:41Z", "commit": {"oid": "5b35ff3c4539e564c3bbcc7b9d9a3507f49eb69b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNTkwNjQ1", "url": "https://github.com/eclipse/capella/pull/328#pullrequestreview-472590645", "createdAt": "2020-08-21T15:32:43Z", "commit": {"oid": "5b35ff3c4539e564c3bbcc7b9d9a3507f49eb69b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302", "author": {"user": {"login": "sandupostaru", "name": "Sandu Postaru"}}, "url": "https://github.com/eclipse/capella/commit/605561b88349aacdd379d1fdf30d45e5b6fa8302", "committedDate": "2020-08-24T11:40:42Z", "message": "[566264] Some operations might create unwanted Entities as a side effect\n\nThe problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture,\nboolean: TRUE) method in functions called at the Operational Level.\n\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\n\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b35ff3c4539e564c3bbcc7b9d9a3507f49eb69b", "author": {"user": {"login": "sandupostaru", "name": "Sandu Postaru"}}, "url": "https://github.com/eclipse/capella/commit/5b35ff3c4539e564c3bbcc7b9d9a3507f49eb69b", "committedDate": "2020-08-21T12:47:38Z", "message": "[566264] Some operations might create unwanted Entities as a side effect\n\nThe problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture,\nboolean: TRUE) method in functions called at the Operational Level.\n\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\n\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>"}, "afterCommit": {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302", "author": {"user": {"login": "sandupostaru", "name": "Sandu Postaru"}}, "url": "https://github.com/eclipse/capella/commit/605561b88349aacdd379d1fdf30d45e5b6fa8302", "committedDate": "2020-08-24T11:40:42Z", "message": "[566264] Some operations might create unwanted Entities as a side effect\n\nThe problem resides in the use of the\norg.polarsys.capella.core.model.helpers.BlockArchitectureExt.getFirstComponent(BlockArchitecture,\nboolean: TRUE) method in functions called at the Operational Level.\n\nSince there is no Operational System concept at that level, this method\nconstantly creates a new Entity at each call.\n\nChange-Id: I3f031760613b3c6759910bce56ea1d479d7a9e85\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMzg3NjQ4", "url": "https://github.com/eclipse/capella/pull/328#pullrequestreview-473387648", "createdAt": "2020-08-24T11:43:52Z", "commit": {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTo0Mzo1MlrOHFgtmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMTo0Mzo1MlrOHFgtmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU0MDg4OA==", "bodyText": "the getOrCreateSystem can still be dangerous on oa, as it will create always a new entity.\nmaybe we can replace oa.getSystem call by a getFirstEntity?\n\nDone.", "url": "https://github.com/eclipse/capella/pull/328#discussion_r475540888", "createdAt": "2020-08-24T11:43:52Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.model.helpers/src/org/polarsys/capella/core/model/helpers/BlockArchitectureExt.java", "diffHunk": "@@ -684,15 +684,24 @@ public static boolean isDefaultNameRootFunction(AbstractNamedElement element) {\n    * @param architecture\n    * @param create\n    * @return\n+   * \n+   * @deprecated use {@link BlockArchitecture::getSystem} or {@link BlockArchitectureExt::getOrCreateComponent} instead.\n    */\n+  @Deprecated\n   public static Component getFirstComponent(BlockArchitecture architecture, boolean create) {\n     Component first = null;\n \n     if (architecture instanceof OperationalAnalysis) {\n-      first = ((OperationalAnalysis) architecture).getSystem();\n+      EntityPkg entityPkg = (EntityPkg) getComponentPkg(architecture, true);\n+      EList<Entity> ownedEntities = entityPkg.getOwnedEntities();\n+\n+      first = ownedEntities.stream().filter(x -> !x.isActor()).findFirst().orElse(null);\n+\n       if ((first == null) && create) {\n         first = OaFactory.eINSTANCE.createEntity(NamingConstants.CreateOaAnalysisCmd_entity_name);\n-        ((EntityPkg) getComponentPkg(architecture, true)).getOwnedEntities().add((Entity) first);\n+        ownedEntities.add((Entity) first);\n+\n+        CapellaElementExt.creationService(first);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNTg4MjU3", "url": "https://github.com/eclipse/capella/pull/328#pullrequestreview-473588257", "createdAt": "2020-08-24T15:00:51Z", "commit": {"oid": "605561b88349aacdd379d1fdf30d45e5b6fa8302"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1314, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}