{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NzgxNjQy", "number": 141, "title": "Search in diagram and note implementation bugzilla/558030/search and replace", "bodyText": "", "createdAt": "2020-03-17T11:33:09Z", "url": "https://github.com/eclipse/capella/pull/141", "merged": true, "mergeCommit": {"oid": "38bd4413de0d312d71596a24638eaca8653911a5"}, "closed": true, "closedAt": "2020-03-24T14:55:05Z", "author": {"login": "minhtutonthat"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOhGCYgH2gAyMzg5NzgxNjQyOjNkOGQzYmNhN2Q2ODU4OTM5YzA0NzFjN2ZmNzMyNDgyNTI4NzllNDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ0HkWAFqTM4MDM1NDk0MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44", "author": {"user": {"login": "minhtutonthat", "name": "Minh Tu Ton That"}}, "url": "https://github.com/eclipse/capella/commit/3d8d3bca7d6858939c0471c7ff73248252879e44", "committedDate": "2020-03-17T11:34:29Z", "message": "Add the possibility to search in diagram and note. Introduce the\nSearchItem objects to prepare for the extensibility of these elemements.\n\nChange-Id: I77d4b6dc5662a9f4dcd303ca1ba7e0fbc2bd32b1\nSigned-off-by: Tu Ton <minhtutonthat@gmail.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9af51a094e9c7980911848d8ca0b2a539eafe4e", "author": {"user": {"login": "minhtutonthat", "name": "Minh Tu Ton That"}}, "url": "https://github.com/eclipse/capella/commit/d9af51a094e9c7980911848d8ca0b2a539eafe4e", "committedDate": "2020-03-17T11:30:38Z", "message": "Add the possibility to search in diagram and note. Introduce the\nSearchItem objects to prepare for the extensibility of these elemements.\n\nChange-Id: I77d4b6dc5662a9f4dcd303ca1ba7e0fbc2bd32b1\nSigned-off-by: Tu Ton <minhtutonthat@gmail.com>"}, "afterCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44", "author": {"user": {"login": "minhtutonthat", "name": "Minh Tu Ton That"}}, "url": "https://github.com/eclipse/capella/commit/3d8d3bca7d6858939c0471c7ff73248252879e44", "committedDate": "2020-03-17T11:34:29Z", "message": "Add the possibility to search in diagram and note. Introduce the\nSearchItem objects to prepare for the extensibility of these elemements.\n\nChange-Id: I77d4b6dc5662a9f4dcd303ca1ba7e0fbc2bd32b1\nSigned-off-by: Tu Ton <minhtutonthat@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MDg2OTEx", "url": "https://github.com/eclipse/capella/pull/141#pullrequestreview-376086911", "createdAt": "2020-03-17T14:28:17Z", "commit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDoyODoxOFrOF3exVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNDozNDo1NVrOF3fFAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDE0OQ==", "bodyText": "This will load the diagram on T4C. So first time we use the search, all diagram will be loaded no?", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393720149", "createdAt": "2020-03-17T14:28:18Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchQuery.java", "diffHunk": "@@ -23,19 +25,52 @@\n import org.eclipse.core.runtime.Status;\r\n import org.eclipse.core.runtime.SubMonitor;\r\n import org.eclipse.emf.ecore.EAttribute;\r\n-import org.eclipse.emf.ecore.EClass;\r\n import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.gmf.runtime.diagram.core.util.ViewType;\r\n+import org.eclipse.gmf.runtime.notation.Diagram;\r\n+import org.eclipse.gmf.runtime.notation.NotationPackage;\r\n+import org.eclipse.gmf.runtime.notation.Shape;\r\n import org.eclipse.jface.viewers.ITreeContentProvider;\r\n import org.eclipse.search.ui.ISearchQuery;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.ui.business.api.query.DDiagramGraphicalQuery;\r\n+import org.eclipse.sirius.ext.base.Option;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.DRepresentationDescriptor;\r\n import org.polarsys.capella.core.commands.preferences.util.PreferencesHelper;\r\n import org.polarsys.capella.core.platform.sirius.ui.navigator.viewer.CapellaNavigatorContentProvider;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForAttributeItem;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForClassItem;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForNoteItem;\r\n \r\n public class CapellaSearchQuery implements ISearchQuery {\r\n \r\n   private final CapellaSearchResult capellaSearchResult = new CapellaSearchResult(this);\r\n   private final CapellaSearchSettings capellaSearchSettings;\r\n \r\n-  private final ITreeContentProvider contentProvider = new CapellaNavigatorContentProvider();\r\n+  private final ITreeContentProvider contentProvider = new CapellaNavigatorContentProvider() {\r\n+    // Extend the search scope to include note from diagram\r\n+    @Override\r\n+    public Object[] getChildren(Object element) {\r\n+      if (element instanceof DRepresentationDescriptor) {\r\n+        DRepresentation representation = ((DRepresentationDescriptor) element).getRepresentation();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDQ0NQ==", "bodyText": "same here", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393720445", "createdAt": "2020-03-17T14:28:40Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchResult.java", "diffHunk": "@@ -32,7 +38,22 @@\n   public CapellaSearchResult(CapellaSearchQuery capellaSearchQuery) {\r\n     this.capellaSearchQuery = capellaSearchQuery;\r\n     setActiveMatchFilters(new MatchFilter[] {});\r\n-    treeData = new TreeData(new ArrayList<Object>(), null);\r\n+    treeData = new TreeData(new ArrayList<Object>(), null) {\r\n+      // Customize this to add notes into search scope\r\n+      @Override\r\n+      protected Object doGetParent(Object element) {\r\n+        if (element instanceof DRepresentationDescriptor) {\r\n+          return ((DRepresentationDescriptor) element).getTarget();\r\n+        } else if (element instanceof Shape) {\r\n+          Diagram diagram = ((Shape) element).getDiagram();\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMTg5Nw==", "bodyText": "For that, i think we can use PlatformUI.getDecoratorManagerXX to use decorations used in Preferecnes / General / Appareance / Label Decorations.", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393721897", "createdAt": "2020-03-17T14:30:34Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchResultLabelProvider.java", "diffHunk": "@@ -55,27 +64,28 @@ public StyledString getStyledText(Object element) {\n     StyledString str = new StyledString();\r\n \r\n     str.append(getLabelText(element));\r\n-    str.append(\" \"); \r\n+    str.append(\" \");\r\n \r\n     if (element instanceof EObject) {\r\n       boolean isLockedByOther = CapellaReadOnlyHelper.getReadOnlySectionHandler().isLockedByOthers((EObject) element);\r\n       if (isLockedByOther) {\r\n-        str.append(\"(Read-Only)\", StyledString.DECORATIONS_STYLER); \r\n+        str.append(\"(Read-Only)\", StyledString.DECORATIONS_STYLER);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyNDE2NQ==", "bodyText": "maybe we can use eclipse Adapters, to adapt something to something else.\nThat way, we can avoid hard dependencies everywhere, and being extensible quite easily.\nhttps://github.com/eclipse/capella/blob/b05bc20ce8fc38b98ac7789c16c0f347d10d050b/tests/plugins/org.polarsys.capella.test.business.queries.ju/src/org/polarsys/capella/test/business/queries/ju/QueryAdapterFactory.java\nhttps://github.com/eclipse/capella/blob/b05bc20ce8fc38b98ac7789c16c0f347d10d050b/tests/plugins/org.polarsys.capella.test.business.queries.ju/src/org/polarsys/capella/test/business/queries/ju/views/BqLabelProvider.java", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393724165", "createdAt": "2020-03-17T14:33:34Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchResultLabelProvider.java", "diffHunk": "@@ -55,27 +64,28 @@ public StyledString getStyledText(Object element) {\n     StyledString str = new StyledString();\r\n \r\n     str.append(getLabelText(element));\r\n-    str.append(\" \"); \r\n+    str.append(\" \");\r\n \r\n     if (element instanceof EObject) {\r\n       boolean isLockedByOther = CapellaReadOnlyHelper.getReadOnlySectionHandler().isLockedByOthers((EObject) element);\r\n       if (isLockedByOther) {\r\n-        str.append(\"(Read-Only)\", StyledString.DECORATIONS_STYLER); \r\n+        str.append(\"(Read-Only)\", StyledString.DECORATIONS_STYLER);\r\n       }\r\n     }\r\n     return str;\r\n   }\r\n \r\n   public StyledString getLabelText(Object element) {\r\n-    StyledString labelText = new StyledString(\"\"); \r\n+    StyledString labelText = new StyledString(\"\");\r\n     if (element instanceof CapellaSearchMatchEntry) {\r\n       CapellaSearchMatchEntry capellaSearchMatchEntry = (CapellaSearchMatchEntry) element;\r\n       EAttribute attribute = (EAttribute) capellaSearchMatchEntry.getAttribute();\r\n       labelText.append(attribute.getName());\r\n       labelText.append(\": \");\r\n       labelText.append(capellaSearchMatchEntry.getText());\r\n-    }\r\n-    else {\r\n+    } else if (element instanceof Shape && ViewType.NOTE.equals(((Shape) element).getType())) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyNDkxOQ==", "bodyText": "EObjectLabel.getText no?", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393724919", "createdAt": "2020-03-17T14:34:31Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/item/SearchForAttributeItem.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *  \n+ * Contributors:\n+ *    Thales - initial API and implementation\n+ *******************************************************************************/\n+package org.polarsys.capella.core.ui.search.searchfor.item;\n+\n+import java.util.HashSet;\n+import java.util.Set;\n+\n+import org.eclipse.emf.ecore.EAttribute;\n+import org.eclipse.emf.ecore.EObject;\n+import org.eclipse.emf.ecore.provider.EcoreEditPlugin;\n+import org.eclipse.emf.edit.ui.provider.ExtendedImageRegistry;\n+import org.eclipse.swt.graphics.Image;\n+\n+public class SearchForAttributeItem implements SearchForItem {\n+  // An attribute item can represent many attributes with the same name\n+  private Set<Object> attributes;\n+\n+  public SearchForAttributeItem() {\n+    this.attributes = new HashSet<>();\n+  }\n+\n+  /**\n+   * \n+   * @param eObj\n+   * @return the search text matched from this search item\n+   */\n+  public String getTextToSearch(EObject eObj) {\n+    Object attribute = getAttributeFor(eObj);\n+    if (attribute instanceof EAttribute) {\n+      return (String) eObj.eGet((EAttribute) attribute);\n+    }\n+    return null;\n+  }\n+\n+  @Override\n+  public String getText() {\n+    return ((EAttribute) attributes.iterator().next()).getName();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyNTE4NA==", "bodyText": "@yugansan has added the helper in EObjectLaProHelper", "url": "https://github.com/eclipse/capella/pull/141#discussion_r393725184", "createdAt": "2020-03-17T14:34:55Z", "author": {"login": "pdulth"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/item/SearchForClassItem.java", "diffHunk": "@@ -0,0 +1,75 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *  \n+ * Contributors:\n+ *    Thales - initial API and implementation\n+ *******************************************************************************/\n+package org.polarsys.capella.core.ui.search.searchfor.item;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import org.eclipse.emf.common.notify.AdapterFactory;\n+import org.eclipse.emf.ecore.EClass;\n+import org.eclipse.emf.ecore.EObject;\n+import org.eclipse.emf.edit.provider.ComposedAdapterFactory;\n+import org.eclipse.swt.graphics.Image;\n+import org.polarsys.capella.core.model.handler.provider.CapellaAdapterFactoryProvider;\n+import org.polarsys.capella.core.ui.search.searchfor.GetImagesFromEClassUtil;\n+\n+/**\n+ * \n+ * Search item for EClass\n+ */\n+public class SearchForClassItem implements SearchForItem {\n+  private Object obj;\n+\n+  public SearchForClassItem(Object obj) {\n+    this.obj = obj;\n+  }\n+\n+  /**\n+   * Check if this search item covers the input object\n+   * \n+   * @param eObj\n+   */\n+  public boolean cover(Object object) {\n+    return object instanceof EObject && obj instanceof EClass && ((EObject) object).eClass() == obj;\n+  }\n+\n+  @Override\n+  public String getText() {\n+    return ((EClass) obj).getName();\n+  }\n+\n+  @Override\n+  public Image getImage() {\n+    AdapterFactory adapterFactory = CapellaAdapterFactoryProvider.getInstance().getAdapterFactory();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25e182f98525ab544d44d42b27d16ca1775c7519", "author": {"user": {"login": "minhtutonthat", "name": "Minh Tu Ton That"}}, "url": "https://github.com/eclipse/capella/commit/25e182f98525ab544d44d42b27d16ca1775c7519", "committedDate": "2020-03-18T15:06:45Z", "message": "- Allow decorations on search result.\n- Do not load all diagrams when searching\n\nChange-Id: I302bf0bfb3966a91a34696b5d5d6484bfd510ae8\nSigned-off-by: Tu Ton <minhtutonthat@gmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzU0OTQw", "url": "https://github.com/eclipse/capella/pull/141#pullrequestreview-380354940", "createdAt": "2020-03-24T14:19:42Z", "commit": {"oid": "25e182f98525ab544d44d42b27d16ca1775c7519"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDoxOTo0MlrOF6ycbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNDozNjo1NFrOF6zRQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzE4ODIwNw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/eclipse/capella/pull/141#discussion_r397188207", "createdAt": "2020-03-24T14:19:42Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchQuery.java", "diffHunk": "@@ -23,19 +25,53 @@\n import org.eclipse.core.runtime.Status;\r\n import org.eclipse.core.runtime.SubMonitor;\r\n import org.eclipse.emf.ecore.EAttribute;\r\n-import org.eclipse.emf.ecore.EClass;\r\n import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.gmf.runtime.diagram.core.util.ViewType;\r\n+import org.eclipse.gmf.runtime.notation.Diagram;\r\n+import org.eclipse.gmf.runtime.notation.NotationPackage;\r\n+import org.eclipse.gmf.runtime.notation.Shape;\r\n import org.eclipse.jface.viewers.ITreeContentProvider;\r\n import org.eclipse.search.ui.ISearchQuery;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.ui.business.api.query.DDiagramGraphicalQuery;\r\n+import org.eclipse.sirius.ext.base.Option;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.DRepresentationDescriptor;\r\n import org.polarsys.capella.core.commands.preferences.util.PreferencesHelper;\r\n import org.polarsys.capella.core.platform.sirius.ui.navigator.viewer.CapellaNavigatorContentProvider;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForAttributeItem;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForClassItem;\r\n+import org.polarsys.capella.core.ui.search.searchfor.item.SearchForNoteItem;\r\n \r\n public class CapellaSearchQuery implements ISearchQuery {\r\n \r\n   private final CapellaSearchResult capellaSearchResult = new CapellaSearchResult(this);\r\n   private final CapellaSearchSettings capellaSearchSettings;\r\n \r\n-  private final ITreeContentProvider contentProvider = new CapellaNavigatorContentProvider();\r\n+  private final ITreeContentProvider contentProvider = new CapellaNavigatorContentProvider() {\r\n+    // Extend the search scope to include note from diagram\r\n+    @Override\r\n+    public Object[] getChildren(Object element) {\r\n+      if (element instanceof DRepresentationDescriptor\r\n+          && ((DRepresentationDescriptor) element).isLoadedRepresentation()) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25e182f98525ab544d44d42b27d16ca1775c7519"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzIwMTcyOQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/eclipse/capella/pull/141#discussion_r397201729", "createdAt": "2020-03-24T14:36:54Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/CapellaSearchResult.java", "diffHunk": "@@ -32,7 +38,22 @@\n   public CapellaSearchResult(CapellaSearchQuery capellaSearchQuery) {\r\n     this.capellaSearchQuery = capellaSearchQuery;\r\n     setActiveMatchFilters(new MatchFilter[] {});\r\n-    treeData = new TreeData(new ArrayList<Object>(), null);\r\n+    treeData = new TreeData(new ArrayList<Object>(), null) {\r\n+      // Customize this to add notes into search scope\r\n+      @Override\r\n+      protected Object doGetParent(Object element) {\r\n+        if (element instanceof DRepresentationDescriptor) {\r\n+          return ((DRepresentationDescriptor) element).getTarget();\r\n+        } else if (element instanceof Shape) {\r\n+          Diagram diagram = ((Shape) element).getDiagram();\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzcyMDQ0NQ=="}, "originalCommit": {"oid": "3d8d3bca7d6858939c0471c7ff73248252879e44"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1425, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}