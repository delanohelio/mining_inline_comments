{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MDQwMzA1", "number": 57, "title": "Bugzilla/558032/title block", "bodyText": "[558032] Title Block lines and columns and Properties.", "createdAt": "2020-01-30T12:12:35Z", "url": "https://github.com/eclipse/capella/pull/57", "merged": true, "mergeCommit": {"oid": "04c6c8a86dd347a52f87ff015938caf8b0453f95"}, "closed": true, "closedAt": "2020-03-06T09:39:17Z", "author": {"login": "Cosmin-Visan"}, "timelineItems": {"totalCount": 57, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9KH9LgH2gAyMzY5MDQwMzA1OmQwYjY0MDE4ZjVlMDc1N2EwNjlkNjg3NGVlODc5YWI0OGI3ZTEwOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK82CRgFqTM3MDE5MTQ5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d0b64018f5e0757a069d6874ee879ab48b7e1098", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/d0b64018f5e0757a069d6874ee879ab48b7e1098", "committedDate": "2020-01-23T13:12:03Z", "message": "[draft] Test pull request\n\nChange-Id: I5f1ca59f5b210a8d2495bb9866bd625aa434a443\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30160eaa94d9ad56feb4b2a4f4ef00efb8c78847", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/30160eaa94d9ad56feb4b2a4f4ef00efb8c78847", "committedDate": "2020-01-23T14:04:15Z", "message": "[draft] Test pull request 2.\n\nChange-Id: Ie86f6c3081d735d3c1266b5395b2305b7b6aa3f0\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66825fccd88e51bb71f598833a30647a4e7fc7ec", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/66825fccd88e51bb71f598833a30647a4e7fc7ec", "committedDate": "2020-01-30T11:19:04Z", "message": "Merge pull request #1 from eclipse/bugzilla/558032/titleBlock\n\nBugzilla/558032/title block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e93334786c275a0b658940ebc5a953a3151573e", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/4e93334786c275a0b658940ebc5a953a3151573e", "committedDate": "2020-01-30T11:44:15Z", "message": "[draft] Title Block lines and columns and Properties.\n\nChange-Id: Ia2a4b0ebdf1e6701b959db5397d1dd7f0daeaa7e\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/29766df4ff9af31a9dfb18e1e20ba2de5280588a", "committedDate": "2020-01-30T12:08:53Z", "message": "[558032] Title Block lines and columns and Properties.\n\nChange-Id: I716ed359efe0346b50ffadbe713ec4f5c4c85b4c\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTI2NDIy", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-351526422", "createdAt": "2020-01-31T14:08:00Z", "commit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNDowODowMFrOFkMYFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNDozODo0OVrOFkNU1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5NTgzMA==", "bodyText": "There's no need to contribute to BaseCapella since the title block only appears on diagram. Same remark applies for BaseSiriusTable.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373495830", "createdAt": "2020-01-31T14:08:00Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/plugin.xml", "diffHunk": "@@ -97,6 +97,12 @@\n                id=\"org.polarsys.capella.core.data.core.properties.sections.StringPropertyValueSection\"\r\n                tab=\"BaseCapella\">\r\n          </propertySection>\r\n+         <propertySection\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5NzI2Mw==", "bodyText": "What is this method supposed to do? There's no feature \"name\" associated to a DAnnotation.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373497263", "createdAt": "2020-01-31T14:10:54Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Name:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  private void setContentValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Content:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  /**\r\n+   *\r\n+   */\r\n+  public void clearNameField() {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5Nzg3Mw==", "bodyText": "Content field?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373497873", "createdAt": "2020-01-31T14:12:09Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Name:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  private void setContentValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Content:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  /**\r\n+   *\r\n+   */\r\n+  public void clearNameField() {\r\n+    if (null != nameTextField) {\r\n+      setDataValue(semanticElement, ModellingcorePackage.eINSTANCE.getAbstractNamedElement_Name(), \"\");\r\n+      nameTextField.setText(\"\");\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the name text field is enabled\r\n+   */\r\n+  public void enableNameField(boolean enabled) {\r\n+    if (null != nameTextField && !nameTextField.isDisposed()) {\r\n+      nameTextField.setEnabled(enabled);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the summary text field is enabled\r\n+   */\r\n+  public void enableSummaryField(boolean enabled) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 156}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMDc3Ng==", "bodyText": "To test in collaborative mode to see if the cell is locked when being modifed by someone else.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373500776", "createdAt": "2020-01-31T14:18:00Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Name:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  private void setContentValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Content:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  /**\r\n+   *\r\n+   */\r\n+  public void clearNameField() {\r\n+    if (null != nameTextField) {\r\n+      setDataValue(semanticElement, ModellingcorePackage.eINSTANCE.getAbstractNamedElement_Name(), \"\");\r\n+      nameTextField.setText(\"\");\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the name text field is enabled\r\n+   */\r\n+  public void enableNameField(boolean enabled) {\r\n+    if (null != nameTextField && !nameTextField.isDisposed()) {\r\n+      nameTextField.setEnabled(enabled);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the summary text field is enabled\r\n+   */\r\n+  public void enableSummaryField(boolean enabled) {\r\n+    if (null != contentTextField && !contentTextField.isDisposed()) {\r\n+      contentTextField.setEnabled(enabled);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  @Override\r\n+  public void setEnabled(boolean enabled) {\r\n+    LockHelper.getInstance().enable(nameTextField, enabled);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 167}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUwMTcwOQ==", "bodyText": "Is this change wanted?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373501709", "createdAt": "2020-01-31T14:19:50Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/description/common.odesign", "diffHunk": "@@ -2894,14 +2894,24 @@\n           </style>\r\n         </edgeMappings>\r\n         <edgeMappings name=\"DT_PVGconnector\" synchronizationLock=\"true\" sourceMapping=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_PVG']\" targetMapping=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_PVG'] //@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@nodeMappings[name='DT_PV']\" targetFinderExpression=\"service:PVinPVG\">\r\n-          <style lineStyle=\"dash\" sourceArrow=\"FillDiamond\">\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxMDYxNQ==", "bodyText": "What's the reusedContainerMappings (reusedContainerMappings=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_TitleBlockContainer']\") for?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373510615", "createdAt": "2020-01-31T14:37:16Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/description/common.odesign", "diffHunk": "@@ -2894,14 +2894,24 @@\n           </style>\r\n         </edgeMappings>\r\n         <edgeMappings name=\"DT_PVGconnector\" synchronizationLock=\"true\" sourceMapping=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_PVG']\" targetMapping=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_PVG'] //@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@nodeMappings[name='DT_PV']\" targetFinderExpression=\"service:PVinPVG\">\r\n-          <style lineStyle=\"dash\" sourceArrow=\"FillDiamond\">\r\n+          <style lineStyle=\"dash\" sourceArrow=\"Diamond\">\r\n             <strokeColor xsi:type=\"description:SystemColor\" href=\"environment:/viewpoint#//@systemColors/@entries[name='black']\"/>\r\n             <centerLabelStyleDescription>\r\n               <labelColor xsi:type=\"description:SystemColor\" href=\"environment:/viewpoint#//@systemColors/@entries[name='black']\"/>\r\n             </centerLabelStyleDescription>\r\n           </style>\r\n         </edgeMappings>\r\n-        <containerMappings name=\"DT_Class\" deletionDescription=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='Delete_DataType']\" labelDirectEdit=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='name']\" semanticCandidatesExpression=\"\" createElements=\"false\" domainClass=\"Class\" dropDescriptions=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='D%26D%20DataValue%20From%20Project%20Explorer'] //@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='DataValue%20Into%20Class']\" childrenPresentation=\"List\">\r\n+        <edgeMappings name=\"DT_TitleBlockEdge\" targetMapping=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_TitleBlockContainer']\" targetFinderExpression=\"service:computeTitleBlockElements(diagram)\">\r\n+          <sourceMapping xsi:type=\"description_1:ContainerMapping\" href=\"#//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_Class']\"/>\r\n+          <sourceMapping xsi:type=\"description_1:ContainerMapping\" href=\"physical.odesign#//@ownedViewpoints[name='Physical%20Architecture']/@ownedRepresentations[name='Physical%20Architecture%20Blank']/@defaultLayer/@containerMappings[name='PAB_PC']\"/>\r\n+          <style lineStyle=\"dash\" targetArrow=\"NoDecoration\" sizeComputationExpression=\"2\">\r\n+            <strokeColor xsi:type=\"description:SystemColor\" href=\"environment:/viewpoint#//@systemColors/@entries[name='gray']\"/>\r\n+            <centerLabelStyleDescription labelSize=\"12\">\r\n+              <labelColor xsi:type=\"description:SystemColor\" href=\"environment:/viewpoint#//@systemColors/@entries[name='black']\"/>\r\n+            </centerLabelStyleDescription>\r\n+          </style>\r\n+        </edgeMappings>\r\n+        <containerMappings name=\"DT_Class\" deletionDescription=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='Delete_DataType']\" labelDirectEdit=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='name']\" semanticCandidatesExpression=\"\" createElements=\"false\" domainClass=\"Class\" dropDescriptions=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='D%26D%20DataValue%20From%20Project%20Explorer'] //@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@toolSections.0/@ownedTools[name='DataValue%20Into%20Class']\" reusedContainerMappings=\"//@ownedViewpoints[name='Common']/@ownedRepresentations[name='Class%20Diagram%20Blank']/@defaultLayer/@containerMappings[name='DT_TitleBlockContainer']\" childrenPresentation=\"List\">\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzUxMTM4MA==", "bodyText": "Is this change wanted?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r373511380", "createdAt": "2020-01-31T14:38:49Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/description/common.odesign", "diffHunk": "@@ -3839,9 +3888,7 @@\n             <elementView name=\"elementView\"/>\r\n             <containerView name=\"containerView\"/>\r\n             <initialOperation>\r\n-              <firstModelOperations xsi:type=\"tool_1:ChangeContext\" browseExpression=\"aql:elementView.sourceNode.target\">\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3c5f32660f8b013b061c3acdb4996e544275fb", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/3e3c5f32660f8b013b061c3acdb4996e544275fb", "committedDate": "2020-02-03T10:01:11Z", "message": "[558032] Title Block some review comments and Properties.\n\nChange-Id: Ie266753fb20bb4fde2cd013a082cd42bfd249fdd\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca384b485c06a9e9a0785624bbcbef8678a225e3", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/ca384b485c06a9e9a0785624bbcbef8678a225e3", "committedDate": "2020-02-03T15:08:53Z", "message": "[558032] Title Block some review comments and Properties.\n\nChange-Id: I99896fec45fc2e80789ea32c263388b6af5c5bd2\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c51cdb16babb8faef52b7e8f0f6048e4549dd89", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/5c51cdb16babb8faef52b7e8f0f6048e4549dd89", "committedDate": "2020-02-04T14:35:50Z", "message": "[558032] Title Block delete functionality.\n\nChange-Id: Ic2e68afd8c699008f7e1cdb2f2fba7b28a37d12b\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTQwODIw", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-353540820", "createdAt": "2020-02-05T08:39:56Z", "commit": {"oid": "5c51cdb16babb8faef52b7e8f0f6048e4549dd89"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/8e21c35f93fe2b198b5bdd995224a4c81e20c3af", "committedDate": "2020-02-05T14:03:41Z", "message": "[558032] Title Block edge reconnection.\n\nChange-Id: I924f46e4a7a2f456260227b1342d8a19ebb14f38\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzODg0NDc5", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-353884479", "createdAt": "2020-02-05T17:01:56Z", "commit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzowMTo1NlrOFl_r7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzoxNzo1NFrOFmAPog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NTA3MA==", "bodyText": "Could you extract this code into a method to avoid code duplication?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375385070", "createdAt": "2020-02-05T17:01:56Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.addModifyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    if (!((DAnnotation) object).getDetails().get(\"Name:\").equals(value.toString())) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NjE4OQ==", "bodyText": "Sorry I was not clear.\nsetDataValue(semanticElement, ModellingcorePackage.eINSTANCE.getAbstractNamedElement_Name(), \"\"); is not necessary here. semanticElement is a DAnnotation which does not take part in the ModellingcorePackage and does not have a name.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375386189", "createdAt": "2020-02-05T17:03:57Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,175 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Name:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  private void setContentValue(EObject object, final Object value) {\r\n+    AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+      @Override\r\n+      public void run() {\r\n+        ((DAnnotation) object).getDetails().put(\"Content:\", value.toString());\r\n+      }\r\n+    };\r\n+    executeCommand(command);\r\n+  }\r\n+\r\n+  /**\r\n+   *\r\n+   */\r\n+  public void clearNameField() {\r", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5NzI2Mw=="}, "originalCommit": {"oid": "29766df4ff9af31a9dfb18e1e20ba2de5280588a"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NzM0Nw==", "bodyText": "Could you extract Keywords like \"TB\" into constants with meaningful name so that it's easier to maintain the code?", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375387347", "createdAt": "2020-02-05T17:05:58Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/sections/TitleBlockCellSection.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *  \n+ * Contributors:\n+ *    Thales - initial API and implementation\n+ *******************************************************************************/\n+package org.polarsys.capella.core.data.core.properties.sections;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.emf.ecore.EObject;\n+import org.eclipse.jface.viewers.ISelection;\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\n+import org.eclipse.swt.widgets.Composite;\n+import org.eclipse.ui.IWorkbenchPart;\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetPage;\n+import org.polarsys.capella.core.data.core.properties.fields.TitleBlockBasicElementGroup;\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\n+import org.polarsys.capella.core.ui.properties.sections.AbstractSection;\n+\n+/**\n+ * The PropertyValueGroup section.\n+ */\n+public class TitleBlockCellSection extends AbstractSection {\n+  protected TitleBlockBasicElementGroup titleBlockBasicElementGroup;\n+\n+  /**\n+   * @see org.eclipse.jface.viewers.IFilter#select(java.lang.Object)\n+   */\n+  @Override\n+  public boolean select(Object toTest) {\n+    EObject eObjectToTest = super.selection(toTest);\n+\n+    return ((eObjectToTest != null) && (eObjectToTest instanceof DAnnotation)\n+        && ((DAnnotation) eObjectToTest).getSource().startsWith(\"TB\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM4NzY4Mg==", "bodyText": "Same remark as above for cell names.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375387682", "createdAt": "2020-02-05T17:06:35Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/sections/TitleBlockCellSection.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*******************************************************************************\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\n+ * All rights reserved. This program and the accompanying materials\n+ * are made available under the terms of the Eclipse Public License v1.0\n+ * which accompanies this distribution, and is available at\n+ * http://www.eclipse.org/legal/epl-v10.html\n+ *  \n+ * Contributors:\n+ *    Thales - initial API and implementation\n+ *******************************************************************************/\n+package org.polarsys.capella.core.data.core.properties.sections;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import org.eclipse.emf.ecore.EObject;\n+import org.eclipse.jface.viewers.ISelection;\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\n+import org.eclipse.swt.widgets.Composite;\n+import org.eclipse.ui.IWorkbenchPart;\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetPage;\n+import org.polarsys.capella.core.data.core.properties.fields.TitleBlockBasicElementGroup;\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\n+import org.polarsys.capella.core.ui.properties.sections.AbstractSection;\n+\n+/**\n+ * The PropertyValueGroup section.\n+ */\n+public class TitleBlockCellSection extends AbstractSection {\n+  protected TitleBlockBasicElementGroup titleBlockBasicElementGroup;\n+\n+  /**\n+   * @see org.eclipse.jface.viewers.IFilter#select(java.lang.Object)\n+   */\n+  @Override\n+  public boolean select(Object toTest) {\n+    EObject eObjectToTest = super.selection(toTest);\n+\n+    return ((eObjectToTest != null) && (eObjectToTest instanceof DAnnotation)\n+        && ((DAnnotation) eObjectToTest).getSource().startsWith(\"TB\"));\n+  }\n+\n+  @Override\n+  public List<AbstractSemanticField> getSemanticFields() {\n+    List<AbstractSemanticField> fields = new ArrayList<AbstractSemanticField>();\n+    fields.add(titleBlockBasicElementGroup);\n+    return fields;\n+  }\n+\n+  @Override\n+  public void createContents(Composite parent, TabbedPropertySheetPage aTabbedPropertySheetPage) {\n+    titleBlockBasicElementGroup = new TitleBlockBasicElementGroup(parent, getWidgetFactory(), true, true);\n+    titleBlockBasicElementGroup.setDisplayedInWizard(isDisplayedInWizard());\n+  }\n+\n+  @Override\n+  public void loadData(EObject capellaElement) {\n+    super.loadData(capellaElement);\n+    String name = ((DAnnotation) capellaElement).getDetails().get(\"Name:\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5MTk4Mw==", "bodyText": "This method is called for KeyPressed events which makes the expression evaluated for each key press. This can cause performance issue and not really necessary. Focus lost event should be good.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375391983", "createdAt": "2020-02-05T17:14:00Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,204 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.data.modellingcore.ModellingcorePackage;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.addModifyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setNameValue(semanticElement, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setContentValue(semanticElement, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setNameValue(EObject object, final Object value) {\r\n+    if (!((DAnnotation) object).getDetails().get(\"Name:\").equals(value.toString())) {\r\n+      DDiagram diagram = (DDiagram) object.eContainer();\r\n+      AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+        @Override\r\n+        public void run() {\r\n+          ((DAnnotation) object).getDetails().put(\"Name:\", value.toString());\r\n+          RefreshRepresentationsCommand refreshCommand = new RefreshRepresentationsCommand(\r\n+              TransactionUtil.getEditingDomain(diagram), new NullProgressMonitor(), diagram);\r\n+          refreshCommand.execute();\r\n+        }\r\n+      };\r\n+      executeCommand(command);\r\n+    }\r\n+  }\r\n+\r\n+  private void setContentValue(EObject object, final Object value) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5NDIxMA==", "bodyText": "As I observe, this is evaluated on the graphical elements but not the semantic elements. For example, typing feature:summary on a cell of a title block linked to a class does not show anything though a class does have a summary.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r375394210", "createdAt": "2020-02-05T17:17:54Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2019 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(\"TitleBlock\");\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(\"Name:\", \"Name\");\r\n+          annotationCol.getDetails().put(\"Content:\", \"feature:name\");\r\n+          if (!elementView.equals(diagram)) {\r\n+            annotationCol.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+          }\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeTarget(EObject elementView, DAnnotation source, DAnnotation target) {\r\n+    source.getReferences().remove(elementView);\r\n+    target.getReferences().add(elementView);\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeSource(EObject elementView, EObject source, EObject target, DEdge edgeView) {\r\n+    DNodeContainer targetNode = (DNodeContainer) edgeView.getTargetNode();\r\n+    DAnnotation annotation = (DAnnotation) targetNode.getTarget();\r\n+    annotation.getReferences().remove(source);\r\n+    annotation.getReferences().add(target);\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (((DAnnotation) titleBlock).getReferences().get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (((DAnnotation) titleBlock).getReferences().get(i))).getReferences().add(annotationCol);\r\n+              representation.getEAnnotations().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(\"TitleBlock\"))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e21c35f93fe2b198b5bdd995224a4c81e20c3af"}, "originalPosition": 211}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/cb3f1fe6b18135ff038380be23260559565a372c", "committedDate": "2020-02-06T10:19:37Z", "message": "[558032] Title Block implemented review comments.\n\nChange-Id: I8de1f14e430e352bf0a55ea9759ffa090b17d2d4\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTEwNzQ4", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355110748", "createdAt": "2020-02-07T12:01:20Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMToyMVrOFm69ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMToyMVrOFm69ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1NjIxOQ==", "bodyText": "No need for these fields, should be removed.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376356219", "createdAt": "2020-02-07T12:01:21Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTEwODcw", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355110870", "createdAt": "2020-02-07T12:01:36Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMTozNlrOFm698w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMTozNlrOFm698w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1NjMzOQ==", "bodyText": "remove check.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376356339", "createdAt": "2020-02-07T12:01:36Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTExMDA0", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355111004", "createdAt": "2020-02-07T12:01:51Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMTo1MVrOFm6-Qw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMTo1MVrOFm6-Qw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1NjQxOQ==", "bodyText": "Remove check.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376356419", "createdAt": "2020-02-07T12:01:51Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MTExODIw", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355111820", "createdAt": "2020-02-07T12:03:31Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMzozMVrOFm7Aiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxMjowMzozMVrOFm7Aiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjM1NzAwMw==", "bodyText": "I think this can be removed.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376357003", "createdAt": "2020-02-07T12:03:31Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,179 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.events.ModifyEvent;\r\n+import org.eclipse.swt.events.ModifyListener;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField implements ModifyListener {\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory) {\r\n+    this(parent, widgetFactory, true, true);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r\n+  public TitleBlockBasicElementGroup(Composite parent, TabbedPropertySheetWidgetFactory widgetFactory,\r\n+      boolean hasNameField, boolean hasContentField) {\r\n+    super(widgetFactory);\r\n+\r\n+    Group textGroup = widgetFactory.createGroup(parent, ICommonConstants.EMPTY_STRING);\r\n+    textGroup.setLayout(new GridLayout(2, false));\r\n+    GridData gd = new GridData(GridData.FILL_HORIZONTAL);\r\n+    gd.horizontalSpan = 2;\r\n+    textGroup.setLayoutData(gd);\r\n+\r\n+    // Name\r\n+    if (hasNameField) {\r\n+      nameTextField = createTextField(textGroup, Messages.getString(\"NamedElement.NameLabel\"));\r\n+    }\r\n+    // Content\r\n+    if (hasContentField) {\r\n+      contentTextField = createTextField(textGroup, Messages.getString(\"NamedElement.ContentLabel\"));\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textGroup\r\n+   * @param textLabel\r\n+   */\r\n+  private Text createTextField(Group textGroup, String textLabel) {\r\n+    widgetFactory.createCLabel(textGroup, textLabel);\r\n+\r\n+    Text textField = widgetFactory.createText(textGroup, ICommonConstants.EMPTY_STRING);\r\n+    textField.addFocusListener(this);\r\n+    textField.addKeyListener(this);\r\n+    textField.addModifyListener(this);\r\n+    textField.setLayoutData(new GridData(GridData.FILL_HORIZONTAL));\r\n+\r\n+    return textField;\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  public void loadData(EObject semanticElement, String name, String content) {\r\n+    super.loadData(semanticElement, null);\r\n+\r\n+    if (null != semanticElement) {\r\n+      if (null != nameTextField)\r\n+        setTextValue(nameTextField, name);\r\n+      if (null != contentTextField)\r\n+        setTextValue(contentTextField, content);\r\n+    }\r\n+  }\r\n+\r\n+  protected void setTextValue(Text text, String value) {\r\n+    text.setText(value);\r\n+  }\r\n+\r\n+  /**\r\n+   * @param textField\r\n+   *          text field to be filled\r\n+   */\r\n+  @Override\r\n+  protected void fillTextField(Text textField) {\r\n+    if (textField.equals(nameTextField)) {\r\n+      setFieldValue(semanticElement, NAME, nameTextField.getText());\r\n+    } else if (textField.equals(contentTextField)) {\r\n+      setFieldValue(semanticElement, CONTENT, contentTextField.getText());\r\n+    }\r\n+  }\r\n+\r\n+  private void setFieldValue(EObject object, String field, final Object value) {\r\n+    if (!((DAnnotation) object).getDetails().get(field).equals(value.toString())) {\r\n+      DDiagram diagram = (DDiagram) object.eContainer();\r\n+      AbstractReadWriteCommand command = new AbstractReadWriteCommand() {\r\n+        @Override\r\n+        public void run() {\r\n+          ((DAnnotation) object).getDetails().put(field, value.toString());\r\n+          RefreshRepresentationsCommand refreshCommand = new RefreshRepresentationsCommand(\r\n+              TransactionUtil.getEditingDomain(diagram), new NullProgressMonitor(), diagram);\r\n+          refreshCommand.execute();\r\n+        }\r\n+      };\r\n+      executeCommand(command);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the name text field is enabled\r\n+   */\r\n+  public void enableNameField(boolean enabled) {\r\n+    if (null != nameTextField && !nameTextField.isDisposed()) {\r\n+      nameTextField.setEnabled(enabled);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * @param enabled\r\n+   *          whether or not the content text field is enabled\r\n+   */\r\n+  public void enableContentField(boolean enabled) {\r\n+    if (null != contentTextField && !contentTextField.isDisposed()) {\r\n+      contentTextField.setEnabled(enabled);\r\n+    }\r\n+  }\r\n+\r\n+  /**\r\n+   * {@inheritDoc}\r\n+   */\r\n+  @Override\r\n+  public void setEnabled(boolean enabled) {\r\n+    LockHelper.getInstance().enable(nameTextField, enabled);\r\n+    LockHelper.getInstance().enable(contentTextField, enabled);\r\n+  }\r\n+\r\n+  @Override\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 165}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzY1MjA5", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355765209", "createdAt": "2020-02-10T08:49:47Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODo0OTo0N1rOFnd23Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODo0OTo0N1rOFnd23Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyNzk2NQ==", "bodyText": "remove comment", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376927965", "createdAt": "2020-02-10T08:49:47Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(\"TitleBlock\");\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(\"Name:\", \"Name\");\r\n+          annotationCol.getDetails().put(\"Content:\", \"feature:name\");\r\n+          if (!elementView.equals(diagram)) {\r\n+            annotationCol.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+          }\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeTarget(EObject elementView, DAnnotation source, DAnnotation target) {\r\n+    source.getReferences().remove(elementView);\r\n+    target.getReferences().add(elementView);\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeSource(EObject elementView, EObject source, EObject target, DEdge edgeView) {\r\n+    DNodeContainer targetNode = (DNodeContainer) edgeView.getTargetNode();\r\n+    DAnnotation annotation = (DAnnotation) targetNode.getTarget();\r\n+    annotation.getReferences().remove(source);\r\n+    annotation.getReferences().add(target);\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+              representation.getEAnnotations().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(\"TitleBlock\"))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) cell;\r\n+        String idCell = annotation.getSource();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          // String feature = propertiesContent.get(idCell);\r\n+          String feature = annotation.getDetails().get(\"Content:\");\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            if (!annotation.getReferences().isEmpty()) {\r\n+              objToEvaluate = annotation.getReferences().get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(\"Content:\", (String) obj);\r\n+                DRepresentation representation = (DRepresentation) diagram;\r\n+                representation.getEAnnotations().add(annotationContent);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          // TODO Auto-generated catch block\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) cell;\r\n+      String idCell = annotation.getSource();\r\n+      // String name = propertiesName.get(idCell);\r\n+      String name = ((DAnnotation) cell).getDetails().get(\"Name:\");\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    // feature:name\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 268}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NzY1MzE2", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-355765316", "createdAt": "2020-02-10T08:49:57Z", "commit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODo0OTo1N1rOFnd3LQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQwODo0OTo1N1rOFnd3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjkyODA0NQ==", "bodyText": "remove comment", "url": "https://github.com/eclipse/capella/pull/57#discussion_r376928045", "createdAt": "2020-02-10T08:49:57Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,286 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(\"TitleBlock\");\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(\"Name:\", \"Name\");\r\n+          annotationCol.getDetails().put(\"Content:\", \"feature:name\");\r\n+          if (!elementView.equals(diagram)) {\r\n+            annotationCol.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+          }\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeTarget(EObject elementView, DAnnotation source, DAnnotation target) {\r\n+    source.getReferences().remove(elementView);\r\n+    target.getReferences().add(elementView);\r\n+  }\r\n+\r\n+  public void reconnectTitleBlockEdgeSource(EObject elementView, EObject source, EObject target, DEdge edgeView) {\r\n+    DNodeContainer targetNode = (DNodeContainer) edgeView.getTargetNode();\r\n+    DAnnotation annotation = (DAnnotation) targetNode.getTarget();\r\n+    annotation.getReferences().remove(source);\r\n+    annotation.getReferences().add(target);\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+              representation.getEAnnotations().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(\"TitleBlock\"))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) cell;\r\n+        String idCell = annotation.getSource();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          // String feature = propertiesContent.get(idCell);\r\n+          String feature = annotation.getDetails().get(\"Content:\");\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            if (!annotation.getReferences().isEmpty()) {\r\n+              objToEvaluate = annotation.getReferences().get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(\"Content:\", (String) obj);\r\n+                DRepresentation representation = (DRepresentation) diagram;\r\n+                representation.getEAnnotations().add(annotationContent);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          // TODO Auto-generated catch block\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) cell;\r\n+      String idCell = annotation.getSource();\r\n+      // String name = propertiesName.get(idCell);\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb3f1fe6b18135ff038380be23260559565a372c"}, "originalPosition": 259}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89227a45b3346b28f4970c00e2a4a7841425c663", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/89227a45b3346b28f4970c00e2a4a7841425c663", "committedDate": "2020-02-10T09:28:32Z", "message": "[558032] Title Block implemented review comments.\n\nChange-Id: I7bd4d3efb8cb1f552c4fdc6aeef49fbbb662d5b1\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cf3bcf69f8a278928401eeecdec158cdab97fa0", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/7cf3bcf69f8a278928401eeecdec158cdab97fa0", "committedDate": "2020-02-10T09:34:17Z", "message": "[558032] Title Block implemented review comments.\n\nChange-Id: Ibf10d6cf6f81264b40f8beda505b71d4753bfc9a\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b390f6dca26adaa766db8b1472f3609fce347492", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/b390f6dca26adaa766db8b1472f3609fce347492", "committedDate": "2020-02-17T10:46:36Z", "message": "[558032] Title Block filter and show/hide.\n\nChange-Id: Id2bde0e73847d9a7cf1b3ba76cd629be4da9605c\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8606eee7c8235d2424c033b08225f63853be5a2", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/c8606eee7c8235d2424c033b08225f63853be5a2", "committedDate": "2020-02-18T11:03:41Z", "message": "[558032] Title Block unique diagram title block and icon.\n\nChange-Id: I8ea99dc6a52737a946ea390177a3ecf957ae5acf\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzg3MzMy", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-360387332", "createdAt": "2020-02-18T14:36:05Z", "commit": {"oid": "c8606eee7c8235d2424c033b08225f63853be5a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDozNjowNlrOFrEs6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDozNjowNlrOFrEs6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxMDEyMA==", "bodyText": "remove hasNameField, hasContentField from description.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r380710120", "createdAt": "2020-02-18T14:36:06Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.data.core.properties/src/org/polarsys/capella/core/data/core/properties/fields/TitleBlockBasicElementGroup.java", "diffHunk": "@@ -0,0 +1,152 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.data.core.properties.fields;\r\n+\r\n+import org.eclipse.core.runtime.NullProgressMonitor;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.emf.transaction.util.TransactionUtil;\r\n+import org.eclipse.sirius.business.api.dialect.command.RefreshRepresentationsCommand;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.swt.layout.GridData;\r\n+import org.eclipse.swt.layout.GridLayout;\r\n+import org.eclipse.swt.widgets.Composite;\r\n+import org.eclipse.swt.widgets.Group;\r\n+import org.eclipse.swt.widgets.Text;\r\n+import org.eclipse.ui.views.properties.tabbed.TabbedPropertySheetWidgetFactory;\r\n+import org.polarsys.capella.common.ef.command.AbstractReadWriteCommand;\r\n+import org.polarsys.capella.common.mdsofa.common.constant.ICommonConstants;\r\n+import org.polarsys.capella.core.data.core.properties.Messages;\r\n+import org.polarsys.capella.core.ui.properties.fields.AbstractSemanticField;\r\n+import org.polarsys.capella.core.ui.properties.helpers.LockHelper;\r\n+\r\n+public class TitleBlockBasicElementGroup extends AbstractSemanticField {\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  protected Text nameTextField;\r\n+  protected Text contentTextField;\r\n+\r\n+  /**\r\n+   * @param parent\r\n+   * @param widgetFactory\r\n+   * @param hasNameField\r\n+   * @param hasContentField\r\n+   */\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8606eee7c8235d2424c033b08225f63853be5a2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMzkyNzEz", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-360392713", "createdAt": "2020-02-18T14:42:35Z", "commit": {"oid": "c8606eee7c8235d2424c033b08225f63853be5a2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo0MjozNVrOFrE8-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNDo0MjozNVrOFrE8-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDcxNDIzNA==", "bodyText": "Clean up a little bit this file:\n\nremove comments\nremove unnecessary code", "url": "https://github.com/eclipse/capella/pull/57#discussion_r380714234", "createdAt": "2020-02-18T14:42:35Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,408 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8606eee7c8235d2424c033b08225f63853be5a2"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5585df2d33f5257aeb41fb99265c12f18399a35e", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/5585df2d33f5257aeb41fb99265c12f18399a35e", "committedDate": "2020-02-19T14:12:17Z", "message": "[558032] Title Block delete dangling title block.\n\nChange-Id: Iaac8cc103430386401c4d0820431e7e0f0130b88\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5893842f54ddb3bbcb04b03e6eb84fda334d044", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/e5893842f54ddb3bbcb04b03e6eb84fda334d044", "committedDate": "2020-02-20T13:08:18Z", "message": "[558032] Title Block delete and hide dangling title block.\n\nChange-Id: I6f96d0f57f94f0d4b08482f710ff0a9573c3dd7c\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb401f1e4b4cf0ff183ea3404a440ca0e57ad53", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/ccb401f1e4b4cf0ff183ea3404a440ca0e57ad53", "committedDate": "2020-02-24T09:45:34Z", "message": "[558032] Title Block filters for diagram and element title blocks.\n\nChange-Id: Ide10510cfd8ef1fc792f458a964471249453b5d7\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ad576f5e43334071c6ce467545baa0d303cb136", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/1ad576f5e43334071c6ce467545baa0d303cb136", "committedDate": "2020-02-25T13:10:05Z", "message": "[558032] Created separate groups for diagram and element TBs.\n\nChange-Id: I724dcf872f046d74ec133c69db7977a61fb48e0b\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5466aa54b42338eba02aa9061ad627cfe72bc3", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/ff5466aa54b42338eba02aa9061ad627cfe72bc3", "committedDate": "2020-02-25T14:26:20Z", "message": "[558032] Unique element title block.\n\nChange-Id: I9c3d7081863ad593e394382148eaa547ef3baa01\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/0d423369ed4d96990d3c1b3c928a3f973eedf228", "committedDate": "2020-02-27T09:00:47Z", "message": "[558032] Added title block icon and label for show/hide dialog.\n\nChange-Id: Ia0d28ade32e977e4a0f73b2f94783c807ce2c09e\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjM4MDU1", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365638055", "createdAt": "2020-02-27T12:24:18Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNDoxOFrOFvQQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNDoxOFrOFvQQJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5MzY2OA==", "bodyText": "Split this function in createDiagramTitleBlock and createElementTitleBlock.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385093668", "createdAt": "2020-02-27T12:24:18Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 103}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjM4NzIz", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365638723", "createdAt": "2020-02-27T12:25:25Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNToyNlrOFvQSBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNToyNlrOFvQSBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5NDE0OA==", "bodyText": "rename maybe to isDiagramTileBlock", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385094148", "createdAt": "2020-02-27T12:25:26Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 191}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjM5NDg1", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365639485", "createdAt": "2020-02-27T12:26:45Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNjo0NVrOFvQUdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyNjo0NVrOFvQUdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5NDc3Mw==", "bodyText": "It if is an element title block, it will reference also the semantic element so lines = lines = 1.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385094773", "createdAt": "2020-02-27T12:26:45Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 213}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjQwMzk2", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365640396", "createdAt": "2020-02-27T12:28:15Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyODoxNVrOFvQXHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjoyODoxNVrOFvQXHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA5NTQ1Mw==", "bodyText": "before doing EObject obj = titleBlock.getReferences().get(1), check that titleBlock.getReferences().size() > 1", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385095453", "createdAt": "2020-02-27T12:28:15Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 217}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUwOTk0", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365650994", "createdAt": "2020-02-27T12:46:20Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0NjoyMFrOFvQ3fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0NjoyMFrOFvQ3fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwMzc0Mg==", "bodyText": "create getAvailableDiagramTitleBlocks and another one getAvailableElementTitleBlocks. Instead of TITLE_BLOCK use DIAGRAM_TITLE_BLOCK and ELEMENT_TITLE_BLOCK.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385103742", "createdAt": "2020-02-27T12:46:20Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 362}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUxMzUx", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365651351", "createdAt": "2020-02-27T12:46:54Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0Njo1NFrOFvQ4jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0Njo1NFrOFvQ4jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNDAxMw==", "bodyText": "same remark as for getAvailableTitleBlocks, create 2 functions one for Diagram TB one for Element TB.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385104013", "createdAt": "2020-02-27T12:46:54Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 385}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUxNjQ1", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365651645", "createdAt": "2020-02-27T12:47:26Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0NzoyNlrOFvQ5Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0NzoyNlrOFvQ5Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNDIwNw==", "bodyText": "also here, create one function for diagram TB and one for element TB.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385104207", "createdAt": "2020-02-27T12:47:26Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r\n+      boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>(1);\r\n+    DSemanticDiagram diagram = (DSemanticDiagram) CapellaServices.getService().getDiagramContainer(elementView);\r\n+    if (elementView.equals(diagram)) {\r\n+      EList<DAnnotation> diagramElements = diagram.getEAnnotations();\r\n+      for (DAnnotation dDiagramElement : diagramElements) {\r\n+        if (dDiagramElement.getSource().equals(TITLE_BLOCK)) {\r\n+          if (null != dDiagramElement.getDetails().get(VISIBILITY)) {\r\n+            if (dDiagramElement.getDetails().get(VISIBILITY).equals(TRUE)) {\r\n+              result.add(dDiagramElement);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public EObject showHideTitleBlocks(EObject context, List<DAnnotation> selectedTitleBlocks, DDiagram diagram,\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 416}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUyMjg3", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365652287", "createdAt": "2020-02-27T12:48:25Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0ODoyNVrOFvQ7WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo0ODoyNVrOFvQ7WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNDcyOA==", "bodyText": "do not hardcode mapping.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385104728", "createdAt": "2020-02-27T12:48:25Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r\n+      boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>(1);\r\n+    DSemanticDiagram diagram = (DSemanticDiagram) CapellaServices.getService().getDiagramContainer(elementView);\r\n+    if (elementView.equals(diagram)) {\r\n+      EList<DAnnotation> diagramElements = diagram.getEAnnotations();\r\n+      for (DAnnotation dDiagramElement : diagramElements) {\r\n+        if (dDiagramElement.getSource().equals(TITLE_BLOCK)) {\r\n+          if (null != dDiagramElement.getDetails().get(VISIBILITY)) {\r\n+            if (dDiagramElement.getDetails().get(VISIBILITY).equals(TRUE)) {\r\n+              result.add(dDiagramElement);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public EObject showHideTitleBlocks(EObject context, List<DAnnotation> selectedTitleBlocks, DDiagram diagram,\r\n+      boolean isDiagram) {\r\n+    Map<DAnnotation, DDiagramElement> visibleElements = new HashMap<>();\r\n+    List<EObject> allNodes = new ArrayList<>();\r\n+    allNodes.addAll(((DSemanticDiagram) context).getOwnedDiagramElements());\r\n+    for (EObject aObject : allNodes) {\r\n+      if (aObject instanceof DNodeContainer) {\r\n+        if (((DNodeContainer) aObject).getTarget() instanceof DAnnotation) {\r\n+          if (((DAnnotation) ((DNodeContainer) aObject).getTarget()).getSource().equals(TITLE_BLOCK)) {\r\n+            DDiagramElement aNode = ((DDiagramElement) aObject);\r\n+            EObject nodeTarget = aNode.getTarget();\r\n+            if (nodeTarget instanceof DAnnotation && aNode instanceof DDiagramElement) {\r\n+              visibleElements.put((DAnnotation) nodeTarget, aNode);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (Entry<DAnnotation, DDiagramElement> me : visibleElements.entrySet()) {\r\n+      if (!selectedTitleBlocks.contains(me.getKey())) {\r\n+        EObject container = me.getValue().eContainer();\r\n+        if (container instanceof DSemanticDiagram) {\r\n+          DAnnotation annotation = ((DAnnotation) (me.getValue().getTarget()));\r\n+          if (isDiagram) {\r\n+            if (isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          } else {\r\n+            if (!isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (DAnnotation aTitleBlock : selectedTitleBlocks) {\r\n+      if (!visibleElements.containsKey(aTitleBlock)) {\r\n+\r\n+        createTitleBlockView(context, aTitleBlock, diagram);\r\n+      }\r\n+    }\r\n+    return context;\r\n+  }\r\n+\r\n+  private AbstractDNode createTitleBlockView(EObject context, DAnnotation titleBlock, DDiagram diagram) {\r\n+    String mappingName = IMappingNameConstants.CDB_TITLE_BLOCK;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 463}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUzNDk5", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365653499", "createdAt": "2020-02-27T12:50:20Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MDoyMFrOFvQ-5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MDoyMFrOFvQ-5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNTYzNw==", "bodyText": "insetad of TITLE_BLOCK use DIAGRAM_TITLE_BLOCK.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385105637", "createdAt": "2020-02-27T12:50:20Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r\n+      boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>(1);\r\n+    DSemanticDiagram diagram = (DSemanticDiagram) CapellaServices.getService().getDiagramContainer(elementView);\r\n+    if (elementView.equals(diagram)) {\r\n+      EList<DAnnotation> diagramElements = diagram.getEAnnotations();\r\n+      for (DAnnotation dDiagramElement : diagramElements) {\r\n+        if (dDiagramElement.getSource().equals(TITLE_BLOCK)) {\r\n+          if (null != dDiagramElement.getDetails().get(VISIBILITY)) {\r\n+            if (dDiagramElement.getDetails().get(VISIBILITY).equals(TRUE)) {\r\n+              result.add(dDiagramElement);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public EObject showHideTitleBlocks(EObject context, List<DAnnotation> selectedTitleBlocks, DDiagram diagram,\r\n+      boolean isDiagram) {\r\n+    Map<DAnnotation, DDiagramElement> visibleElements = new HashMap<>();\r\n+    List<EObject> allNodes = new ArrayList<>();\r\n+    allNodes.addAll(((DSemanticDiagram) context).getOwnedDiagramElements());\r\n+    for (EObject aObject : allNodes) {\r\n+      if (aObject instanceof DNodeContainer) {\r\n+        if (((DNodeContainer) aObject).getTarget() instanceof DAnnotation) {\r\n+          if (((DAnnotation) ((DNodeContainer) aObject).getTarget()).getSource().equals(TITLE_BLOCK)) {\r\n+            DDiagramElement aNode = ((DDiagramElement) aObject);\r\n+            EObject nodeTarget = aNode.getTarget();\r\n+            if (nodeTarget instanceof DAnnotation && aNode instanceof DDiagramElement) {\r\n+              visibleElements.put((DAnnotation) nodeTarget, aNode);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (Entry<DAnnotation, DDiagramElement> me : visibleElements.entrySet()) {\r\n+      if (!selectedTitleBlocks.contains(me.getKey())) {\r\n+        EObject container = me.getValue().eContainer();\r\n+        if (container instanceof DSemanticDiagram) {\r\n+          DAnnotation annotation = ((DAnnotation) (me.getValue().getTarget()));\r\n+          if (isDiagram) {\r\n+            if (isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          } else {\r\n+            if (!isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (DAnnotation aTitleBlock : selectedTitleBlocks) {\r\n+      if (!visibleElements.containsKey(aTitleBlock)) {\r\n+\r\n+        createTitleBlockView(context, aTitleBlock, diagram);\r\n+      }\r\n+    }\r\n+    return context;\r\n+  }\r\n+\r\n+  private AbstractDNode createTitleBlockView(EObject context, DAnnotation titleBlock, DDiagram diagram) {\r\n+    String mappingName = IMappingNameConstants.CDB_TITLE_BLOCK;\r\n+    NodeMapping mapping = DiagramServices.getDiagramServices().getNodeMapping(diagram, mappingName);\r\n+    if (context instanceof DNodeList) {\r\n+      if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+        titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+      }\r\n+      return DiagramServices.getDiagramServices().createDNodeListElement(mapping, titleBlock,\r\n+          (DragAndDropTarget) context, diagram);\r\n+    }\r\n+    if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+      titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+    }\r\n+    return DiagramServices.getDiagramServices().createNode(mapping, titleBlock, (DragAndDropTarget) context, diagram);\r\n+  }\r\n+\r\n+  public boolean isUniqueDiagramTitleBlock(EObject diagram) {\r\n+    Collection<DAnnotation> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 481}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjUzNzQw", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365653740", "createdAt": "2020-02-27T12:50:43Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MDo0M1rOFvQ_ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MDo0M1rOFvQ_ow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNTgyNw==", "bodyText": "instead of TITLE_BLOCK use ELEMENT_TITLE_BLOCK.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385105827", "createdAt": "2020-02-27T12:50:43Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r\n+      boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>(1);\r\n+    DSemanticDiagram diagram = (DSemanticDiagram) CapellaServices.getService().getDiagramContainer(elementView);\r\n+    if (elementView.equals(diagram)) {\r\n+      EList<DAnnotation> diagramElements = diagram.getEAnnotations();\r\n+      for (DAnnotation dDiagramElement : diagramElements) {\r\n+        if (dDiagramElement.getSource().equals(TITLE_BLOCK)) {\r\n+          if (null != dDiagramElement.getDetails().get(VISIBILITY)) {\r\n+            if (dDiagramElement.getDetails().get(VISIBILITY).equals(TRUE)) {\r\n+              result.add(dDiagramElement);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public EObject showHideTitleBlocks(EObject context, List<DAnnotation> selectedTitleBlocks, DDiagram diagram,\r\n+      boolean isDiagram) {\r\n+    Map<DAnnotation, DDiagramElement> visibleElements = new HashMap<>();\r\n+    List<EObject> allNodes = new ArrayList<>();\r\n+    allNodes.addAll(((DSemanticDiagram) context).getOwnedDiagramElements());\r\n+    for (EObject aObject : allNodes) {\r\n+      if (aObject instanceof DNodeContainer) {\r\n+        if (((DNodeContainer) aObject).getTarget() instanceof DAnnotation) {\r\n+          if (((DAnnotation) ((DNodeContainer) aObject).getTarget()).getSource().equals(TITLE_BLOCK)) {\r\n+            DDiagramElement aNode = ((DDiagramElement) aObject);\r\n+            EObject nodeTarget = aNode.getTarget();\r\n+            if (nodeTarget instanceof DAnnotation && aNode instanceof DDiagramElement) {\r\n+              visibleElements.put((DAnnotation) nodeTarget, aNode);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (Entry<DAnnotation, DDiagramElement> me : visibleElements.entrySet()) {\r\n+      if (!selectedTitleBlocks.contains(me.getKey())) {\r\n+        EObject container = me.getValue().eContainer();\r\n+        if (container instanceof DSemanticDiagram) {\r\n+          DAnnotation annotation = ((DAnnotation) (me.getValue().getTarget()));\r\n+          if (isDiagram) {\r\n+            if (isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          } else {\r\n+            if (!isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (DAnnotation aTitleBlock : selectedTitleBlocks) {\r\n+      if (!visibleElements.containsKey(aTitleBlock)) {\r\n+\r\n+        createTitleBlockView(context, aTitleBlock, diagram);\r\n+      }\r\n+    }\r\n+    return context;\r\n+  }\r\n+\r\n+  private AbstractDNode createTitleBlockView(EObject context, DAnnotation titleBlock, DDiagram diagram) {\r\n+    String mappingName = IMappingNameConstants.CDB_TITLE_BLOCK;\r\n+    NodeMapping mapping = DiagramServices.getDiagramServices().getNodeMapping(diagram, mappingName);\r\n+    if (context instanceof DNodeList) {\r\n+      if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+        titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+      }\r\n+      return DiagramServices.getDiagramServices().createDNodeListElement(mapping, titleBlock,\r\n+          (DragAndDropTarget) context, diagram);\r\n+    }\r\n+    if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+      titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+    }\r\n+    return DiagramServices.getDiagramServices().createNode(mapping, titleBlock, (DragAndDropTarget) context, diagram);\r\n+  }\r\n+\r\n+  public boolean isUniqueDiagramTitleBlock(EObject diagram) {\r\n+    Collection<DAnnotation> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .filter(x -> x.getReferences().size() == 2).collect(Collectors.toList());\r\n+    }\r\n+    return (result.size() == 0);\r\n+  }\r\n+\r\n+  public boolean isUniqueElementTitleBlock(Object elementView, EObject diagram) {\r\n+    Collection<DAnnotation> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 492}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NjU0MTc3", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-365654177", "createdAt": "2020-02-27T12:51:29Z", "commit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MToyOVrOFvRBKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMjo1MToyOVrOFvRBKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTEwNjIxNw==", "bodyText": "remove commented code.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r385106217", "createdAt": "2020-02-27T12:51:29Z", "author": {"login": "georgiana-ecobici"}, "path": "core/plugins/org.polarsys.capella.core.sirius.analysis/src/org/polarsys/capella/core/sirius/analysis/TitleBlockServices.java", "diffHunk": "@@ -0,0 +1,515 @@\n+/*******************************************************************************\r\n+ * Copyright (c) 2020 THALES GLOBAL SERVICES.\r\n+ * All rights reserved. This program and the accompanying materials\r\n+ * are made available under the terms of the Eclipse Public License v1.0\r\n+ * which accompanies this distribution, and is available at\r\n+ * http://www.eclipse.org/legal/epl-v10.html\r\n+ *  \r\n+ * Contributors:\r\n+ *    Thales - initial API and implementation\r\n+ *******************************************************************************/\r\n+package org.polarsys.capella.core.sirius.analysis;\r\n+\r\n+import java.net.URL;\r\n+import java.util.ArrayList;\r\n+import java.util.Collection;\r\n+import java.util.HashMap;\r\n+import java.util.List;\r\n+import java.util.Map;\r\n+import java.util.Map.Entry;\r\n+import java.util.Objects;\r\n+import java.util.stream.Collectors;\r\n+\r\n+import org.eclipse.core.runtime.FileLocator;\r\n+import org.eclipse.core.runtime.Path;\r\n+import org.eclipse.emf.common.util.EList;\r\n+import org.eclipse.emf.ecore.EObject;\r\n+import org.eclipse.jface.resource.ImageDescriptor;\r\n+import org.eclipse.sirius.common.tools.api.interpreter.EvaluationException;\r\n+import org.eclipse.sirius.common.tools.internal.interpreter.FeatureInterpreter;\r\n+import org.eclipse.sirius.diagram.AbstractDNode;\r\n+import org.eclipse.sirius.diagram.DDiagram;\r\n+import org.eclipse.sirius.diagram.DDiagramElement;\r\n+import org.eclipse.sirius.diagram.DEdge;\r\n+import org.eclipse.sirius.diagram.DNodeContainer;\r\n+import org.eclipse.sirius.diagram.DNodeList;\r\n+import org.eclipse.sirius.diagram.DSemanticDiagram;\r\n+import org.eclipse.sirius.diagram.DragAndDropTarget;\r\n+import org.eclipse.sirius.diagram.description.NodeMapping;\r\n+import org.eclipse.sirius.viewpoint.DRepresentation;\r\n+import org.eclipse.sirius.viewpoint.description.DAnnotation;\r\n+import org.eclipse.sirius.viewpoint.description.DescriptionFactory;\r\n+import org.eclipse.swt.graphics.Image;\r\n+import org.polarsys.capella.core.data.information.impl.ClassImpl;\r\n+import org.polarsys.capella.core.data.information.impl.DataPkgImpl;\r\n+import org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator;\r\n+\r\n+public class TitleBlockServices {\r\n+  private static TitleBlockServices service = null;\r\n+\r\n+  static Map<String, String> propertiesName = new HashMap<String, String>();\r\n+  static Map<String, String> propertiesContent = new HashMap<String, String>();\r\n+\r\n+  private static final String TITLE_BLOCK = \"TitleBlock\";\r\n+  private static final String NAME = \"Name:\";\r\n+  private static final String CONTENT = \"Content:\";\r\n+  private static final String VISIBILITY = \"Visibility\";\r\n+  private static final String IS_ELEMENT_TITLE_BLOCK = \"Is Element Title Block\";\r\n+  private static final String TRUE = \"True\";\r\n+  private static final String FALSE = \"False\";\r\n+\r\n+  public static TitleBlockServices getService() {\r\n+    if (service == null) {\r\n+      init();\r\n+      service = new TitleBlockServices();\r\n+    }\r\n+    return service;\r\n+  }\r\n+\r\n+  public static void init() {\r\n+    propertiesName.put(\"TB_0_0\", \"Name\");\r\n+    propertiesName.put(\"TB_0_1\", \"Documentation\");\r\n+    propertiesName.put(\"TB_1_0\", \"Contextual elements\");\r\n+    propertiesContent.put(\"TB_0_0\", \"feature:name\");\r\n+    propertiesContent.put(\"TB_0_1\", \"\");// \"feature:documentation\");\r\n+    propertiesContent.put(\"TB_1_0\", \"\");\r\n+  }\r\n+\r\n+  public boolean isDiagram(EObject container) {\r\n+    return (container instanceof DataPkgImpl);\r\n+  }\r\n+\r\n+  public void createDiagramTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (elementView instanceof DSemanticDiagram && isUniqueDiagramTitleBlock(diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public void createElementTitleBlock(EObject elementView, EObject diagram) {\r\n+    if (!(elementView instanceof DSemanticDiagram) && isUniqueElementTitleBlock(elementView, diagram)) {\r\n+      createTitleBlock(elementView, diagram);\r\n+    }\r\n+  }\r\n+\r\n+  public boolean isDiagramTitleBlock(DAnnotation titleBlock) {\r\n+    List<EObject> references = titleBlock.getReferences().stream().filter(x -> !(x instanceof DAnnotation))\r\n+        .collect(Collectors.toList());\r\n+    if (references.isEmpty()) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  private void createTitleBlock(EObject elementView, EObject diagram) {\r\n+    DRepresentation representation = null;\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      representation = (DRepresentation) diagram;\r\n+    }\r\n+\r\n+    if (representation != null) {\r\n+      // todo - read from properties\r\n+      int numLines = 2;\r\n+      int numCols = 2;\r\n+\r\n+      DAnnotation annotation = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotation.setSource(TITLE_BLOCK);\r\n+      annotation.getDetails().put(VISIBILITY, TRUE);\r\n+\r\n+      List<DAnnotation> annotationLines = new ArrayList<DAnnotation>();\r\n+      for (int i = 0; i < numLines; i++) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+\r\n+        // addColumnsToLine(annotationLine, representation, numCols); start\r\n+        List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+        for (int j = 0; j < numCols; j++) {\r\n+          DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+          annotationCol.setSource(\"TB_\" + i + \"_\" + j);\r\n+          annotationCol.getDetails().put(NAME, \"Name\");\r\n+          annotationCol.getDetails().put(CONTENT, \"feature:name\");\r\n+          annotationCols.add(annotationCol);\r\n+          representation.getEAnnotations().add(annotationCol);\r\n+        }\r\n+        annotationLine.getReferences().addAll(annotationCols);\r\n+        representation.getEAnnotations().add(annotationLine);\r\n+        // stop\r\n+\r\n+        annotationLines.add(annotationLine);\r\n+      }\r\n+\r\n+      if (!elementView.equals(diagram)) {\r\n+        annotation.getReferences().add(((DDiagramElement) elementView).getTarget());\r\n+        annotation.getDetails().put(IS_ELEMENT_TITLE_BLOCK, TRUE);\r\n+      }\r\n+      annotation.getReferences().addAll(annotationLines);\r\n+      representation.getEAnnotations().add(annotation);\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockLine(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        DAnnotation annotationLine = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+        annotationLine.setSource(\"TitleBlockLine\");\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numCols = getNumColumns((DAnnotation) titleBlock);\r\n+          if (numCols > 0) {\r\n+            ((DAnnotation) titleBlock).getReferences().add(annotationLine);\r\n+            addColumnsToLine(annotationLine, representation, numCols, getNumLines((DAnnotation) titleBlock));\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  public void createTitleBlockColumn(EObject titleBlock, EObject diagram) {\r\n+    if (!isDiagramLevel(titleBlock)) {\r\n+      DRepresentation representation = null;\r\n+      if ((diagram instanceof DRepresentation)) {\r\n+        representation = (DRepresentation) diagram;\r\n+      }\r\n+      if (representation != null) {\r\n+        if (titleBlock instanceof DAnnotation) {\r\n+          int numLines = ((DAnnotation) titleBlock).getReferences().size();\r\n+          List<EObject> lines = ((DAnnotation) titleBlock).getReferences();\r\n+          for (int i = 0; i < numLines; i++) {\r\n+            DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+            annotationCol.setSource(\"TitleBlockLineCol\");\r\n+            if (lines.get(i) instanceof DAnnotation) {\r\n+              ((DAnnotation) (lines.get(i))).getReferences().add(annotationCol);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+  }\r\n+\r\n+  private boolean isDiagramLevel(EObject titleBlock) {\r\n+    for (EObject reference : ((DAnnotation) titleBlock).getReferences()) {\r\n+      if (!(reference instanceof DAnnotation)) {\r\n+        return false;\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  private void addColumnsToLine(DAnnotation annotationLine, DRepresentation representation, int numCols,\r\n+      int lineNumber) {\r\n+    List<DAnnotation> annotationCols = new ArrayList<DAnnotation>();\r\n+    for (int j = 0; j < numCols; j++) {\r\n+      DAnnotation annotationCol = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+      annotationCol.setSource(\"TB_\" + lineNumber + \"_\" + j);\r\n+      annotationCols.add(annotationCol);\r\n+      representation.getEAnnotations().add(annotationCol);\r\n+    }\r\n+    annotationLine.getReferences().addAll(annotationCols);\r\n+    representation.getEAnnotations().add(annotationLine);\r\n+  }\r\n+\r\n+  public int getNumLines(DAnnotation titleBlock) {\r\n+    return titleBlock.getReferences().size();\r\n+  }\r\n+\r\n+  public int getNumColumns(DAnnotation titleBlock) {\r\n+    EObject obj = titleBlock.getReferences().get(1);\r\n+    if (obj instanceof DAnnotation)\r\n+      return ((DAnnotation) obj).getReferences().size();\r\n+    return 0;\r\n+  }\r\n+\r\n+  public Collection<EObject> computeTitleBlockElements(EObject elem, EObject diagram) {\r\n+    Collection<EObject> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getReferences().contains(elem))\r\n+          .collect(Collectors.toList());\r\n+    }\r\n+    return result;\r\n+  }\r\n+\r\n+  public List<DAnnotation> checkIsTitleBlockContainer(Object elementView) {\r\n+    List<DAnnotation> list = new ArrayList<DAnnotation>();\r\n+    if ((elementView instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) elementView;\r\n+      list = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      deleteDanglingTitleBlock(list, elementView);\r\n+      // clearEAnnotations(elementView);\r\n+      list = list.stream().filter(x -> Objects.nonNull(x.getDetails().get(VISIBILITY)))\r\n+          .filter(x -> x.getDetails().get(VISIBILITY).equals(TRUE)).collect(Collectors.toList());\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  private void deleteDanglingTitleBlock(List<DAnnotation> list, Object elementView) {\r\n+    List<DAnnotation> deleteList = new ArrayList<DAnnotation>();\r\n+    for (DAnnotation annotation : list) {\r\n+      boolean hasExternalElementReference = false;\r\n+      for (EObject element : annotation.getReferences()) {\r\n+        if (!(element instanceof DAnnotation)) {\r\n+          hasExternalElementReference = true;\r\n+          boolean elementPresentInDiagram = false;\r\n+          List<DDiagramElement> diagramElementsList = ((DSemanticDiagram) elementView).getOwnedDiagramElements();\r\n+          for (DDiagramElement diagramElement : diagramElementsList) {\r\n+            if (!(diagramElement instanceof DEdge) && diagramElement.getTarget().equals(element)) {\r\n+              elementPresentInDiagram = true;\r\n+            }\r\n+          }\r\n+          if (!(elementPresentInDiagram)) {\r\n+            annotation.getDetails().put(VISIBILITY, FALSE);\r\n+          }\r\n+        }\r\n+      }\r\n+      if (!(hasExternalElementReference)) {\r\n+        deleteList.add(annotation);\r\n+      }\r\n+    }\r\n+    deleteList = deleteList.stream().filter(x -> Objects.nonNull(x.getDetails().get(IS_ELEMENT_TITLE_BLOCK)))\r\n+        .filter(x -> x.getDetails().get(IS_ELEMENT_TITLE_BLOCK).equals(TRUE)).collect(Collectors.toList());\r\n+    CapellaServices.getService().removeElements(deleteList);\r\n+  }\r\n+\r\n+  public void clearEAnnotations(Object elementView, DAnnotation element) {\r\n+    List<DAnnotation> annotationsList = new ArrayList<>();\r\n+    for (EObject titleBlockLine : element.getReferences()) {\r\n+      if (titleBlockLine instanceof DAnnotation) {\r\n+        annotationsList.add((DAnnotation) titleBlockLine); // title block lines\r\n+        if (!((DAnnotation) titleBlockLine).getReferences().isEmpty()) {\r\n+          for (EObject titleBlockCell : ((DAnnotation) titleBlockLine).getReferences()) {\r\n+            if (titleBlockCell instanceof DAnnotation) {\r\n+              annotationsList.add((DAnnotation) titleBlockCell);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    ((DSemanticDiagram) elementView).getEAnnotations().removeAll(annotationsList);\r\n+  }\r\n+\r\n+  public List<Object> getTitleBlockCellContent(EObject diagram, EObject cell, EObject containerView) {\r\n+    init();\r\n+    List<Object> list = new ArrayList<Object>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      if (cell instanceof DAnnotation) {\r\n+        DAnnotation annotation = (DAnnotation) ((DNodeContainer) (containerView.eContainer().eContainer())).getTarget();\r\n+        FeatureInterpreter interpreter = new FeatureInterpreter();\r\n+        try {\r\n+          String feature = ((DAnnotation) cell).getDetails().get(CONTENT);\r\n+          if (feature != null) {\r\n+            EObject objToEvaluate = diagram;\r\n+            List<EObject> modelElements = annotation.getReferences().parallelStream()\r\n+                .filter(x -> !(x instanceof DAnnotation)).collect(Collectors.toList());\r\n+            if (!modelElements.isEmpty()) {\r\n+              objToEvaluate = modelElements.get(0);\r\n+            }\r\n+            Object obj = interpreter.evaluate(objToEvaluate, feature);\r\n+            if (obj != null) {\r\n+              if (obj instanceof EObject) {\r\n+                list.add(obj);\r\n+              } else if (obj instanceof String) {\r\n+                DAnnotation annotationContent = DescriptionFactory.eINSTANCE.createDAnnotation();\r\n+                annotationContent.setSource(\"abc\");\r\n+                annotationContent.getDetails().put(CONTENT, (String) obj);\r\n+                list.add(annotationContent);\r\n+              }\r\n+            } else {\r\n+              DRepresentation representation = (DRepresentation) diagram;\r\n+              list = representation.getOwnedRepresentationElements().stream()\r\n+                  .filter(x -> (x.getTarget() instanceof ClassImpl)).collect(Collectors.toList());\r\n+            }\r\n+          }\r\n+        } catch (EvaluationException e) {\r\n+          e.printStackTrace();\r\n+        }\r\n+      }\r\n+    }\r\n+    return list;\r\n+  }\r\n+\r\n+  public String getTitleBlockCellLabel(EObject diagram, EObject cell) {\r\n+    init();\r\n+    if (cell instanceof DAnnotation) {\r\n+      String name = ((DAnnotation) cell).getDetails().get(NAME);\r\n+      if (name != null)\r\n+        return name;\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public String getCellLabel(EObject obj) {\r\n+    if (obj instanceof DAnnotation) {\r\n+      DAnnotation annotation = (DAnnotation) obj;\r\n+      return annotation.getDetails().get(CONTENT);\r\n+    }\r\n+    return \"\";\r\n+  }\r\n+\r\n+  public boolean isAnnotation(EObject obj) {\r\n+    return obj instanceof DAnnotation;\r\n+  }\r\n+\r\n+  public boolean isTitleBlockAllowed(EObject element, EObject containerView) {\r\n+    if (containerView instanceof DRepresentation) {\r\n+      return true;\r\n+    }\r\n+    return false;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getAvailableTitleBlocksToInsert(final EObject elementView, boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>();\r\n+    EList<DAnnotation> eList = ((DDiagram) elementView).getEAnnotations();\r\n+    for (DAnnotation elem : eList) {\r\n+      if (elem.getSource().equals(TITLE_BLOCK)) {\r\n+        result.add(elem);\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public List<DAnnotation> getInitialSelectionOfShowHideTitleBlocks(final EObject elementView,\r\n+      boolean isDiagramTitleBlock) {\r\n+    List<DAnnotation> result = new ArrayList<>(1);\r\n+    DSemanticDiagram diagram = (DSemanticDiagram) CapellaServices.getService().getDiagramContainer(elementView);\r\n+    if (elementView.equals(diagram)) {\r\n+      EList<DAnnotation> diagramElements = diagram.getEAnnotations();\r\n+      for (DAnnotation dDiagramElement : diagramElements) {\r\n+        if (dDiagramElement.getSource().equals(TITLE_BLOCK)) {\r\n+          if (null != dDiagramElement.getDetails().get(VISIBILITY)) {\r\n+            if (dDiagramElement.getDetails().get(VISIBILITY).equals(TRUE)) {\r\n+              result.add(dDiagramElement);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    List<DAnnotation> finalResult = new ArrayList<>();\r\n+    for (DAnnotation annotation : result) {\r\n+      if (isDiagramTitleBlock) {\r\n+        if (isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      } else {\r\n+        if (!isDiagramTitleBlock(annotation)) {\r\n+          finalResult.add(annotation);\r\n+        }\r\n+      }\r\n+    }\r\n+    return finalResult;\r\n+  }\r\n+\r\n+  public EObject showHideTitleBlocks(EObject context, List<DAnnotation> selectedTitleBlocks, DDiagram diagram,\r\n+      boolean isDiagram) {\r\n+    Map<DAnnotation, DDiagramElement> visibleElements = new HashMap<>();\r\n+    List<EObject> allNodes = new ArrayList<>();\r\n+    allNodes.addAll(((DSemanticDiagram) context).getOwnedDiagramElements());\r\n+    for (EObject aObject : allNodes) {\r\n+      if (aObject instanceof DNodeContainer) {\r\n+        if (((DNodeContainer) aObject).getTarget() instanceof DAnnotation) {\r\n+          if (((DAnnotation) ((DNodeContainer) aObject).getTarget()).getSource().equals(TITLE_BLOCK)) {\r\n+            DDiagramElement aNode = ((DDiagramElement) aObject);\r\n+            EObject nodeTarget = aNode.getTarget();\r\n+            if (nodeTarget instanceof DAnnotation && aNode instanceof DDiagramElement) {\r\n+              visibleElements.put((DAnnotation) nodeTarget, aNode);\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (Entry<DAnnotation, DDiagramElement> me : visibleElements.entrySet()) {\r\n+      if (!selectedTitleBlocks.contains(me.getKey())) {\r\n+        EObject container = me.getValue().eContainer();\r\n+        if (container instanceof DSemanticDiagram) {\r\n+          DAnnotation annotation = ((DAnnotation) (me.getValue().getTarget()));\r\n+          if (isDiagram) {\r\n+            if (isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          } else {\r\n+            if (!isDiagramTitleBlock(annotation)) {\r\n+              annotation.getDetails().put(VISIBILITY, FALSE);\r\n+              DiagramServices.getDiagramServices().removeAbstractDNodeView((DNodeContainer) me.getValue());\r\n+            }\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    for (DAnnotation aTitleBlock : selectedTitleBlocks) {\r\n+      if (!visibleElements.containsKey(aTitleBlock)) {\r\n+\r\n+        createTitleBlockView(context, aTitleBlock, diagram);\r\n+      }\r\n+    }\r\n+    return context;\r\n+  }\r\n+\r\n+  private AbstractDNode createTitleBlockView(EObject context, DAnnotation titleBlock, DDiagram diagram) {\r\n+    String mappingName = IMappingNameConstants.CDB_TITLE_BLOCK;\r\n+    NodeMapping mapping = DiagramServices.getDiagramServices().getNodeMapping(diagram, mappingName);\r\n+    if (context instanceof DNodeList) {\r\n+      if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+        titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+      }\r\n+      return DiagramServices.getDiagramServices().createDNodeListElement(mapping, titleBlock,\r\n+          (DragAndDropTarget) context, diagram);\r\n+    }\r\n+    if (null != titleBlock.getDetails().get(VISIBILITY)) {\r\n+      titleBlock.getDetails().put(VISIBILITY, TRUE);\r\n+    }\r\n+    return DiagramServices.getDiagramServices().createNode(mapping, titleBlock, (DragAndDropTarget) context, diagram);\r\n+  }\r\n+\r\n+  public boolean isUniqueDiagramTitleBlock(EObject diagram) {\r\n+    Collection<DAnnotation> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .filter(x -> x.getReferences().size() == 2).collect(Collectors.toList());\r\n+    }\r\n+    return (result.size() == 0);\r\n+  }\r\n+\r\n+  public boolean isUniqueElementTitleBlock(Object elementView, EObject diagram) {\r\n+    Collection<DAnnotation> result = new ArrayList<>();\r\n+    if ((diagram instanceof DRepresentation)) {\r\n+      DRepresentation representation = (DRepresentation) diagram;\r\n+      result = representation.getEAnnotations().stream().filter(x -> x.getSource().equals(TITLE_BLOCK))\r\n+          .collect(Collectors.toList());\r\n+      for (DAnnotation annotation : result) {\r\n+        for (EObject reference : annotation.getReferences()) {\r\n+          if (reference == ((DNodeList) elementView).getTarget()) {\r\n+            return false;\r\n+          }\r\n+        }\r\n+      }\r\n+    }\r\n+    return true;\r\n+  }\r\n+\r\n+  public static Image getImage(Object object) {\r\n+    DAnnotation annotation = (DAnnotation) object;\r\n+    // if is diag ann\r\n+    String imagePath = \"/icons/full/obj16/TitleBlock_16.png\";\r\n+    URL url = FileLocator.find(SiriusViewActivator.getInstance().getBundle(), new Path(imagePath), null);\r\n+\r\n+    // org.polarsys.capella.core.sirius.analysis.activator.SiriusViewActivator.getPlugin()\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d423369ed4d96990d3c1b3c928a3f973eedf228"}, "originalPosition": 511}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920ebe0aadfd200ce6ee2fff7c0eb18b873b451f", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/920ebe0aadfd200ce6ee2fff7c0eb18b873b451f", "committedDate": "2020-02-28T09:14:25Z", "message": "[558032] Implemented some review comments.\n\nChange-Id: I756a1e7d624fa203d70f08e8c6272509f1166848\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6baec5a91f4bca7509a62789d299d2a5faadd3ab", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/6baec5a91f4bca7509a62789d299d2a5faadd3ab", "committedDate": "2020-02-28T09:27:58Z", "message": "[558032] Implemented some review comments.\n\nChange-Id: Id7cbc2abd0485af44b6fa8de00aeb1714a59d661\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6e2ec077f2de3735bcee94c7e842a9ff1ea48cf", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/a6e2ec077f2de3735bcee94c7e842a9ff1ea48cf", "committedDate": "2020-02-28T13:15:44Z", "message": "[558032] Added separate methods for show/hide for diag&elem TB.\n\nChange-Id: Ia88697b95a6aaf4fd449794daa00300a67e29fd5\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c78080c28b26e17c8601c596bacbc566e038b00", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/2c78080c28b26e17c8601c596bacbc566e038b00", "committedDate": "2020-02-28T14:09:41Z", "message": "[558032] Implemented review comment..\n\nChange-Id: I73d058e332081ec56c5e163903e5fa47eb6ba81c\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MjI5MDkx", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-367229091", "createdAt": "2020-03-02T14:15:32Z", "commit": {"oid": "2c78080c28b26e17c8601c596bacbc566e038b00"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNDoxNTozM1rOFwg-kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxNDoxNjozM1rOFwhA9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxNjI3Mg==", "bodyText": "Could you check that this should apply to only DAnnotations that represent title blocks. Your code applies to all DAnnotation which is not what we want.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r386416272", "createdAt": "2020-03-02T14:15:33Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.ui.properties/src/org/polarsys/capella/core/ui/properties/providers/CapellaTransfertViewerLabelProvider.java", "diffHunk": "@@ -39,25 +46,32 @@\n import org.polarsys.capella.core.model.handler.helpers.CapellaProjectHelper.TriStateBoolean;\n import org.polarsys.capella.core.model.helpers.ComponentExchangeExt;\n import org.polarsys.capella.core.ui.properties.CapellaUIPropertiesPlugin;\n+import org.polarsys.capella.core.ui.resources.CapellaUIResourcesPlugin;\n \n public class CapellaTransfertViewerLabelProvider extends DataLabelProvider {\n \n   private static String PATTERN1 = \" [{0} -> {1}]{2}\"; //$NON-NLS-1$\n   private static String UNAMED = \"<unnamed>\"; //$NON-NLS-1$\n-  \n+\n   private boolean disableLabelComputation = CapellaUIPropertiesPlugin.getDefault().isDisableLabelComputation();\n \n   /**\n    * {@inheritDoc}\n    */\n   @Override\n   public Image getImage(Object object) {\n-    if (object instanceof DView) { //Sirius-2822\n+    if (object instanceof DView) { // Sirius-2822\n       Viewpoint viewpoint = ((DView) object).getViewpoint();\n       if (viewpoint != null) {\n         return getImage(viewpoint);\n       }\n     }\n+    if (object instanceof DAnnotation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c78080c28b26e17c8601c596bacbc566e038b00"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjQxNjg4NQ==", "bodyText": "Same remark as above.", "url": "https://github.com/eclipse/capella/pull/57#discussion_r386416885", "createdAt": "2020-03-02T14:16:33Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.ui.properties/src/org/polarsys/capella/core/ui/properties/providers/CapellaTransfertViewerLabelProvider.java", "diffHunk": "@@ -150,6 +163,18 @@ private String doGetText(Object object) {\n         return viewpoint.getName();\n       }\n \n+    } else if (object instanceof DAnnotation) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c78080c28b26e17c8601c596bacbc566e038b00"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc76013a92e56bfd3edf6980278e907ded6f564", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/8cc76013a92e56bfd3edf6980278e907ded6f564", "committedDate": "2020-03-03T15:27:46Z", "message": "[558032] Add line and columns when click on cell.\n\nChange-Id: I1b460c0cad7c80622b0051e118c88933a33569b0\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8112ef61173ab2de1a1535b5d59acf834410af03", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/8112ef61173ab2de1a1535b5d59acf834410af03", "committedDate": "2020-03-04T14:03:16Z", "message": "[558032] Fixed bugs, changed icons.\n\nChange-Id: I80e1e0ca749fef4e2a0585f5a2eff92247936ddc\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1abafb092dc836b45ac5a560bfdf619cc6dc110f", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/1abafb092dc836b45ac5a560bfdf619cc6dc110f", "committedDate": "2020-03-04T14:13:30Z", "message": "[558032] Fixed cell deletion.\n\nChange-Id: I3b6482f1b35dc35f134d40e3953e1944a4902946\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad2af1b7970186090b81dcf0e01fdbb7a737456d", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/ad2af1b7970186090b81dcf0e01fdbb7a737456d", "committedDate": "2020-03-04T14:57:06Z", "message": "[558032] Added delete icons.\n\nChange-Id: I131b8712a01e5c01c4bb5765b33a67177440b760\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52d603a38af0f42178a894fcf21cd75ef41b056b", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/52d603a38af0f42178a894fcf21cd75ef41b056b", "committedDate": "2020-03-05T08:39:21Z", "message": "[558032] Fixed failing test ToolAndLabelCoherenceTest.\n\nChange-Id: Ieb5e9a9b71873d65858502f2b1c2c8b11f9f93fa\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e3a899d67b552fb8f2f4edd2ec2f423026565ff", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/8e3a899d67b552fb8f2f4edd2ec2f423026565ff", "committedDate": "2020-03-05T09:34:26Z", "message": "[558032] Added edge for property value group.\n\nChange-Id: Iafe60c1cad68e8683fc8d26e7401a348a1c96b98\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1927b87407b32a37f02bf6f0c2624656149b3eba", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/1927b87407b32a37f02bf6f0c2624656149b3eba", "committedDate": "2020-03-05T13:17:41Z", "message": "[558032] Remove line tool.\n\nChange-Id: I293f6afb8b47ff08e313c910313aa0424a7e2d93\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0b8273a1b386c38f9b4126161db51dc35ac445", "author": {"user": {"login": "Cosmin-Visan", "name": null}}, "url": "https://github.com/eclipse/capella/commit/9f0b8273a1b386c38f9b4126161db51dc35ac445", "committedDate": "2020-03-05T13:51:57Z", "message": "[558032] Remove column tool.\n\nChange-Id: I25d5fd3cc6d712853703123d5ad71fb437c4d838\nSigned-off-by: Cosmin Visan <cosmin.visan@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTg5OTEx", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-370189911", "createdAt": "2020-03-06T09:36:13Z", "commit": {"oid": "9f0b8273a1b386c38f9b4126161db51dc35ac445"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTkxNDk0", "url": "https://github.com/eclipse/capella/pull/57#pullrequestreview-370191494", "createdAt": "2020-03-06T09:38:39Z", "commit": {"oid": "9f0b8273a1b386c38f9b4126161db51dc35ac445"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1465, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}