{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzQ4ODQ5", "number": 287, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMTo1OFrOEJs29A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMzowMFrOEJs4vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjA3NjA0OnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMTo1OFrOGqVH0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyOTozNlrOGqWVrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTQ0Mw==", "bodyText": "Could you extract this code into a separate method (e.g. isViewpointElement)?", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447039443", "createdAt": "2020-06-29T15:01:58Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1OTM3NQ==", "bodyText": "Done", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447059375", "createdAt": "2020-06-29T15:29:36Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTQ0Mw=="}, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 152}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4NjA4MDYyOnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMzowMFrOGqVKsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToyOTo0OVrOGqWWTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDE3OA==", "bodyText": "Could you move this to a separated helper class?", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447040178", "createdAt": "2020-06-29T15:03:00Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();\n+      return getViewpointPackages().contains(ePackage);\n+    }\n+\n+    return true;\n+  }\n+\n+  private static Object sanitizeResultItem(Object resultItem) {\n+    if (isValidResultItem(resultItem)) {\n+      return resultItem;\n+    }\n+\n+    String sanitizedText = EObjectLabelProviderHelper.getText(resultItem);\n+\n+    if (sanitizedText != null && !sanitizedText.isEmpty()) {\n+      return sanitizedText;\n+    }\n+\n+    return resultItem != null ? resultItem.toString() : \"\";\n+  }\n+\n+  private static Object sanitizeResultItems(Collection<?> originalResult) {\n+    return originalResult.stream().map(TitleBlockHelper::sanitizeResultItem).collect(Collectors.toList());\n+  }\n+\n+  private static Set<EPackage> getViewpointPackages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 177}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA1OTUzNA==", "bodyText": "Done", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447059534", "createdAt": "2020-06-29T15:29:49Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();\n+      return getViewpointPackages().contains(ePackage);\n+    }\n+\n+    return true;\n+  }\n+\n+  private static Object sanitizeResultItem(Object resultItem) {\n+    if (isValidResultItem(resultItem)) {\n+      return resultItem;\n+    }\n+\n+    String sanitizedText = EObjectLabelProviderHelper.getText(resultItem);\n+\n+    if (sanitizedText != null && !sanitizedText.isEmpty()) {\n+      return sanitizedText;\n+    }\n+\n+    return resultItem != null ? resultItem.toString() : \"\";\n+  }\n+\n+  private static Object sanitizeResultItems(Collection<?> originalResult) {\n+    return originalResult.stream().map(TitleBlockHelper::sanitizeResultItem).collect(Collectors.toList());\n+  }\n+\n+  private static Set<EPackage> getViewpointPackages() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDE3OA=="}, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 177}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4222, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}