{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkwOTczNDA2", "number": 149, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTozNDowNVrODq2MTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjowMzozMlrODq3ETw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjU0NjY4OnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTozNDowNVrOF62C9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTozNDowNVrOF62C9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI0NzIyMw==", "bodyText": "Even if we only have two elements I think that the best solution for the contains and indexOf operations is a Map<String, Integer> (the key is the category, and the value is the index) instead of a list.\nIn this way the complexity for both contains and indexOf is O(1) and not O(n).\nThis is just a precaution in case the size of the elements increases in the future.", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397247223", "createdAt": "2020-03-24T15:34:05Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "diffHunk": "@@ -133,4 +143,57 @@ public void refreshOtherSideArea() {\n       otherSideArea.filteredTree.getViewer().refresh();\r\n     }\r\n   }\r\n+\r\n+  @Override\r\n+  protected void createContentArea() {\r\n+    super.createContentArea();\r\n+    List<String> fixedCategories = Arrays.asList(CapellaSearchConstants.ModelElements_Key,\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 72}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjU3NDE1OnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaRightSearchForContainerArea.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTozOTo0N1rOF62UYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTozOTo0N1rOF62UYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1MTY4Mw==", "bodyText": "Same as above I think that the best solution for the contains and indexOf operations is a Map<String, Integer> (the key is the category, and the value is the index).\nIn this way the complexity for both contains and indexOf is O(1) and not O(n).\nThis is just a precaution in case the size of the elements increases in the future.", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397251683", "createdAt": "2020-03-24T15:39:47Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaRightSearchForContainerArea.java", "diffHunk": "@@ -33,8 +51,59 @@ protected AbstractSearchForContentProvider getSearchForContentProvider() {\n   protected PatternFilter createPatternFilter() {\r\n     return new PatternFilter();\r\n   }\r\n-  \r\n+\r\n   public void updateSearchSettings() {\r\n     searchPage.getCapellaSearchSettings().setSearchAttributeItems(getCheckedElements());\r\n   }\r\n+\r\n+  @Override\r\n+  protected void createContentArea() {\r\n+    super.createContentArea();\r\n+\r\n+    filteredTree.getViewer().setComparator(new ViewerComparator() {\r\n+      @Override\r\n+      public int compare(Viewer viewer, Object e1, Object e2) {\r\n+        if (e1 instanceof SearchForAttributeItem && e2 instanceof SearchForAttributeItem) {\r\n+          SearchForAttributeItem item1 = (SearchForAttributeItem) e1;\r\n+          SearchForAttributeItem item2 = (SearchForAttributeItem) e2;\r\n+          Optional<EAttribute> item1TopAttribute = topAttributes.stream().filter(item1::represent).findAny();\r\n+          Optional<EAttribute> item2TopAttribute = topAttributes.stream().filter(item2::represent).findAny();\r\n+          if (item1TopAttribute.isPresent() && item2TopAttribute.isPresent()) {\r\n+            return topAttributes.indexOf(item1TopAttribute.get()) < topAttributes.indexOf(item2TopAttribute.get()) ? -1\r\n+                : 1;\r\n+          } else if (item1TopAttribute.isPresent()) {\r\n+            return -1;\r\n+          } else if (item2TopAttribute.isPresent()) {\r\n+            return 1;\r\n+          }\r\n+          return ((SearchForItem) e1).getText().compareTo(((SearchForItem) e2).getText());\r\n+        }\r\n+        return 0;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjU4MDgxOnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0MToxMVrOF62YnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0MToxMVrOF62YnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1Mjc2NA==", "bodyText": "fixedCategories.contains(category1) becomes fixedCategories.get(category1) != null", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397252764", "createdAt": "2020-03-24T15:41:11Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "diffHunk": "@@ -133,4 +143,57 @@ public void refreshOtherSideArea() {\n       otherSideArea.filteredTree.getViewer().refresh();\r\n     }\r\n   }\r\n+\r\n+  @Override\r\n+  protected void createContentArea() {\r\n+    super.createContentArea();\r\n+    List<String> fixedCategories = Arrays.asList(CapellaSearchConstants.ModelElements_Key,\r\n+        CapellaSearchConstants.DiagramElements_Key);\r\n+    filteredTree.getViewer().setComparator(new ViewerComparator() {\r\n+      @Override\r\n+      public int compare(Viewer viewer, Object e1, Object e2) {\r\n+        if (e1 instanceof SearchForItem && e2 instanceof SearchForItem) {\r\n+          return ((SearchForItem) e1).getText().compareTo(((SearchForItem) e2).getText());\r\n+        } else if (e1 instanceof String && e2 instanceof String) {\r\n+          String category1 = (String) e1;\r\n+          String category2 = (String) e2;\r\n+          if (fixedCategories.contains(category1) && fixedCategories.contains(category2)) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjU4MzUzOnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0MTo0M1rOF62aSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0MTo0M1rOF62aSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1MzE5NQ==", "bodyText": "fixedCategories.indexOf(category1) becomes fixedCategories.get(category1)", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397253195", "createdAt": "2020-03-24T15:41:43Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/CapellaLeftSearchForContainerArea.java", "diffHunk": "@@ -133,4 +143,57 @@ public void refreshOtherSideArea() {\n       otherSideArea.filteredTree.getViewer().refresh();\r\n     }\r\n   }\r\n+\r\n+  @Override\r\n+  protected void createContentArea() {\r\n+    super.createContentArea();\r\n+    List<String> fixedCategories = Arrays.asList(CapellaSearchConstants.ModelElements_Key,\r\n+        CapellaSearchConstants.DiagramElements_Key);\r\n+    filteredTree.getViewer().setComparator(new ViewerComparator() {\r\n+      @Override\r\n+      public int compare(Viewer viewer, Object e1, Object e2) {\r\n+        if (e1 instanceof SearchForItem && e2 instanceof SearchForItem) {\r\n+          return ((SearchForItem) e1).getText().compareTo(((SearchForItem) e2).getText());\r\n+        } else if (e1 instanceof String && e2 instanceof String) {\r\n+          String category1 = (String) e1;\r\n+          String category2 = (String) e2;\r\n+          if (fixedCategories.contains(category1) && fixedCategories.contains(category2)) {\r\n+            return fixedCategories.indexOf(category1) < fixedCategories.indexOf(category2) ? -1 : 1;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjYwOTk4OnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0NzowNVrOF62rXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0NzowNVrOF62rXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1NzU2NA==", "bodyText": "The classID2DiagItemMap name is kinda deceiving this contains both SearchForDiagramItem and SearchForNoteItem ... change the name or split the cache into 2? Whichever makes more sense", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397257564", "createdAt": "2020-03-24T15:47:05Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "diffHunk": "@@ -16,85 +16,110 @@\n import java.util.Map;\r\n import java.util.Optional;\r\n import java.util.Set;\r\n+import java.util.stream.Collectors;\r\n \r\n+import org.eclipse.emf.common.util.URI;\r\n import org.eclipse.emf.ecore.EAttribute;\r\n import org.eclipse.emf.ecore.EClass;\r\n import org.eclipse.emf.ecore.EClassifier;\r\n import org.eclipse.emf.ecore.EDataType;\r\n import org.eclipse.emf.ecore.EPackage;\r\n+import org.eclipse.emf.ecore.resource.ResourceSet;\r\n+import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;\r\n import org.eclipse.gmf.runtime.notation.NotationPackage;\r\n import org.eclipse.sirius.viewpoint.ViewpointPackage;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForAttributeItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForClassItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForDiagramItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForNoteItem;\r\n+import org.polarsys.kitalpha.ad.common.utils.URIHelper;\r\n+import org.polarsys.kitalpha.ad.services.manager.ViewpointManager;\r\n+import org.polarsys.kitalpha.ad.viewpoint.coredomain.viewpoint.model.Viewpoint;\r\n \r\n /**\r\n  * \r\n  * Cache of classes and attributes to search for\r\n  */\r\n public class SearchForItemCache {\r\n-\r\n-  private Map<String, SearchForItem> searchForClassItemMap;\r\n-  private Map<String, SearchForItem> searchForDiagItemMap;\r\n-  private Map<String, SearchForAttributeItem> searchForAttributeItemMap;\r\n-  private Set<String> packages;\r\n+  private Map<String, SearchForClassItem> classID2ClassItemMap;\r\n+  private Map<String, SearchForClassItem> classID2DiagItemMap;\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjYxNjMyOnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0ODoxN1rOF62vZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNTo0ODoxN1rOF62vZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI1ODU5Nw==", "bodyText": "Can you import the org.polarsys.kitalpha.resourcereuse.model.Resource class please?", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397258597", "createdAt": "2020-03-24T15:48:17Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "diffHunk": "@@ -16,85 +16,110 @@\n import java.util.Map;\r\n import java.util.Optional;\r\n import java.util.Set;\r\n+import java.util.stream.Collectors;\r\n \r\n+import org.eclipse.emf.common.util.URI;\r\n import org.eclipse.emf.ecore.EAttribute;\r\n import org.eclipse.emf.ecore.EClass;\r\n import org.eclipse.emf.ecore.EClassifier;\r\n import org.eclipse.emf.ecore.EDataType;\r\n import org.eclipse.emf.ecore.EPackage;\r\n+import org.eclipse.emf.ecore.resource.ResourceSet;\r\n+import org.eclipse.emf.ecore.resource.impl.ResourceSetImpl;\r\n import org.eclipse.gmf.runtime.notation.NotationPackage;\r\n import org.eclipse.sirius.viewpoint.ViewpointPackage;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForAttributeItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForClassItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForDiagramItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForItem;\r\n import org.polarsys.capella.core.ui.search.searchfor.item.SearchForNoteItem;\r\n+import org.polarsys.kitalpha.ad.common.utils.URIHelper;\r\n+import org.polarsys.kitalpha.ad.services.manager.ViewpointManager;\r\n+import org.polarsys.kitalpha.ad.viewpoint.coredomain.viewpoint.model.Viewpoint;\r\n \r\n /**\r\n  * \r\n  * Cache of classes and attributes to search for\r\n  */\r\n public class SearchForItemCache {\r\n-\r\n-  private Map<String, SearchForItem> searchForClassItemMap;\r\n-  private Map<String, SearchForItem> searchForDiagItemMap;\r\n-  private Map<String, SearchForAttributeItem> searchForAttributeItemMap;\r\n-  private Set<String> packages;\r\n+  private Map<String, SearchForClassItem> classID2ClassItemMap;\r\n+  private Map<String, SearchForClassItem> classID2DiagItemMap;\r\n+  private Map<String, SearchForAttributeItem> attributeName2AttributeItemMap;\r\n+  private Set<Viewpoint> viewpoints;\r\n+  private Map<String, Viewpoint> classID2ViewpointMap;\r\n \r\n   private static SearchForItemCache instance;\r\n \r\n   private SearchForItemCache() {\r\n-    searchForClassItemMap = new HashMap<>();\r\n-    searchForDiagItemMap = new HashMap<>();\r\n-    searchForAttributeItemMap = new HashMap<>();\r\n-    packages = new HashSet<>();\r\n+    classID2ClassItemMap = new HashMap<>();\r\n+    classID2DiagItemMap = new HashMap<>();\r\n+    attributeName2AttributeItemMap = new HashMap<>();\r\n+    viewpoints = new HashSet<>();\r\n+    classID2ViewpointMap = new HashMap<>();\r\n     initModelElements();\r\n     initDiagramElements();\r\n+    initViewpointElements();\r\n+    \r\n+    initAttributes(classID2ClassItemMap);\r\n+    initAttributes(classID2DiagItemMap);\r\n   }\r\n \r\n-  private void initModelElements() {\r\n-    for (String nsURI : EPackage.Registry.INSTANCE.keySet()) {\r\n-      if (nsURI.startsWith(\"http://www.polarsys.org/capella\")) {\r\n-        if (!packages.contains(nsURI)) {\r\n-          packages.add(nsURI);\r\n-          EPackage ePackage = EPackage.Registry.INSTANCE.getEPackage(nsURI);\r\n-          for (EClassifier eClassifier : ePackage.getEClassifiers()) {\r\n+  private void initViewpointElements() {\r\n+    ResourceSet set = new ResourceSetImpl();\r\n+    for (org.polarsys.kitalpha.resourcereuse.model.Resource res : ViewpointManager.getAvailableViewpoints()) {\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 70}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ2MjY5MDA3OnYy", "diffSide": "RIGHT", "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjowMzozMlrOF63fWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxNjowMzozMlrOF63fWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzI3MDg3Mw==", "bodyText": "Here it is faster to just iterate on the vpClasses instead of iterating on all of the classID2ClassItemMap.keySet(). And in this way vpClasses can just be a simple List, no need for a Set.\nvpClasses.stream().map(cls -> classID2ClassItemMap.get(cls)).filter(Objects::nonNull).collect(Collectors.toSet())", "url": "https://github.com/eclipse/capella/pull/149#discussion_r397270873", "createdAt": "2020-03-24T16:03:32Z", "author": {"login": "sandupostaru"}, "path": "core/plugins/org.polarsys.capella.core.ui.search/src/org/polarsys/capella/core/ui/search/searchfor/SearchForItemCache.java", "diffHunk": "@@ -109,28 +134,40 @@ public static SearchForItemCache getInstance() {\n     return instance;\r\n   }\r\n \r\n-  public Set<SearchForItem> getSearchForDiagramItems() {\r\n-    return new HashSet<>(searchForDiagItemMap.values());\r\n+  public Set<SearchForItem> getDiagramItems() {\r\n+    return new HashSet<>(classID2DiagItemMap.values());\r\n   }\r\n \r\n-  public Set<SearchForItem> getSearchForClassItems() {\r\n-    return new HashSet<>(searchForClassItemMap.values());\r\n+  public Set<SearchForItem> getClassItems() {\r\n+    return new HashSet<>(classID2ClassItemMap.values());\r\n   }\r\n \r\n-  public Set<SearchForItem> getSearchForAttributeItems() {\r\n-    return new HashSet<>(searchForAttributeItemMap.values());\r\n+  public Set<SearchForItem> getCapellaClassItems() {\r\n+    return classID2ClassItemMap.values().stream().filter(item -> !classID2ViewpointMap.containsKey(item.getUniqueID()))\r\n+        .collect(Collectors.toSet());\r\n+  }\r\n+\r\n+  public Set<SearchForItem> getAttributeItems() {\r\n+    return new HashSet<>(attributeName2AttributeItemMap.values());\r\n+  }\r\n+\r\n+  public Set<SearchForItem> getAddonItems(Viewpoint vp) {\r\n+    Set<String> vpClasses = classID2ViewpointMap.keySet().stream().filter(cls -> classID2ViewpointMap.get(cls) == vp)\r\n+        .collect(Collectors.toSet());\r\n+    return classID2ClassItemMap.keySet().stream().filter(vpClasses::contains)\r\n+        .map(cls -> classID2ClassItemMap.get(cls)).collect(Collectors.toSet());\r", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4c49c0d8d02ccce15ef156de290f1567d5b6ec2"}, "originalPosition": 170}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4325, "cost": 1, "resetAt": "2021-11-12T18:49:56Z"}}}