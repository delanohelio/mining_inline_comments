{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzQ4ODQ5", "number": 287, "title": "[558032] Add Title Block content sanitization", "bodyText": "Sanitize title block content in order to avoid adding invalid semantic\nreferences to external resources in the .aird\n\n\nFix Title Block Cell content display for Collections of primitive data\n-- Only the last element in the collection was displayed\n\n\nBug: 558032\nChange-Id: Ifb5e9efa69479ebe8b58a2b34ed6fccf65387ea0\nSigned-off-by: Sandu Postaru sandu.postaru@thalesgroup.com", "createdAt": "2020-06-29T11:43:31Z", "url": "https://github.com/eclipse/capella/pull/287", "merged": true, "mergeCommit": {"oid": "0fe14817f1c84f4b08c55bbfb4088d43f1e10fd2"}, "closed": true, "closedAt": "2020-06-30T07:00:28Z", "author": {"login": "sandupostaru"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv_feJgH2gAyNDQxMzQ4ODQ5OmMwNjE1OTM0YzdkZWRjMTQyNTQ3YjUxMWM4ZTAwZTA4M2FiMjliMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwQF2VgFqTQzOTcyMTgzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a", "author": {"user": {"login": "sandupostaru", "name": "Sandu Postaru"}}, "url": "https://github.com/eclipse/capella/commit/c0615934c7dedc142547b511c8e00e083ab29b2a", "committedDate": "2020-06-29T11:38:55Z", "message": "[558032] Add Title Block content sanitization\n\n- Sanitize title block content in order to avoid adding invalid semantic\nreferences to external resources in the .aird\n\n- Fix Title Block Cell content display for Collections of primitive data\n-- Only the last element in the collection was displayed\n\nBug: 558032\nChange-Id: Ifb5e9efa69479ebe8b58a2b34ed6fccf65387ea0\nSigned-off-by: Sandu Postaru <sandu.postaru@thalesgroup.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjM0MDM4", "url": "https://github.com/eclipse/capella/pull/287#pullrequestreview-439234038", "createdAt": "2020-06-29T15:01:57Z", "commit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMTo1OFrOGqVH0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNTowMzowMFrOGqVKsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzAzOTQ0Mw==", "bodyText": "Could you extract this code into a separate method (e.g. isViewpointElement)?", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447039443", "createdAt": "2020-06-29T15:01:58Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0MDE3OA==", "bodyText": "Could you move this to a separated helper class?", "url": "https://github.com/eclipse/capella/pull/287#discussion_r447040178", "createdAt": "2020-06-29T15:03:00Z", "author": {"login": "minhtutonthat"}, "path": "core/plugins/org.polarsys.capella.core.diagram.helpers/src/org/polarsys/capella/core/diagram/helpers/TitleBlockHelper.java", "diffHunk": "@@ -661,4 +643,98 @@ public static String getTitleBlockName(String type) {\n     }\n     return \"\";\n   }\n+\n+  /**\n+   * Returns the evaluation result of a Title Block expression (aql expression or capella semantic browser query).\n+   * \n+   * @param descriptor\n+   * @param expression\n+   * @param titleBlock\n+   * @return the evaluation result of a Title Block expression.\n+   */\n+  public static Object getResultOfExpression(DRepresentationDescriptor descriptor, String expression,\n+      DAnnotation titleBlock) {\n+    EObject semanticElement = TitleBlockHelper.getSemanticElementReference(titleBlock);\n+\n+    // if is a Diagram Title Block, the semantic element will be the descriptor\n+    if (semanticElement == null) {\n+      semanticElement = descriptor;\n+    }\n+\n+    IInterpreterProvider provider = CompoundInterpreter.INSTANCE.getProviderForExpression(expression);\n+\n+    if (provider instanceof DefaultInterpreterProvider) {\n+      return new EvaluationException();\n+    }\n+\n+    IInterpreter interpreter = provider.createInterpreter();\n+    Object result = null;\n+    try {\n+      result = interpreter.evaluate(semanticElement, expression);\n+    } catch (EvaluationException e) {\n+      return e;\n+    }\n+\n+    if (result instanceof Collection) {\n+      Collection<?> originalResult = (Collection<?>) result;\n+      return sanitizeResultItems(originalResult);\n+    }\n+\n+    return sanitizeResultItem(result);\n+  }\n+\n+  private static boolean isValidResultItem(Object item) {\n+    if (item instanceof EObject) {\n+      EObject eObject = (EObject) item;\n+\n+      if (eObject instanceof Element || eObject instanceof DRepresentationDescriptor) {\n+        return true;\n+      }\n+\n+      EPackage ePackage = eObject.eClass().getEPackage();\n+      return getViewpointPackages().contains(ePackage);\n+    }\n+\n+    return true;\n+  }\n+\n+  private static Object sanitizeResultItem(Object resultItem) {\n+    if (isValidResultItem(resultItem)) {\n+      return resultItem;\n+    }\n+\n+    String sanitizedText = EObjectLabelProviderHelper.getText(resultItem);\n+\n+    if (sanitizedText != null && !sanitizedText.isEmpty()) {\n+      return sanitizedText;\n+    }\n+\n+    return resultItem != null ? resultItem.toString() : \"\";\n+  }\n+\n+  private static Object sanitizeResultItems(Collection<?> originalResult) {\n+    return originalResult.stream().map(TitleBlockHelper::sanitizeResultItem).collect(Collectors.toList());\n+  }\n+\n+  private static Set<EPackage> getViewpointPackages() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0615934c7dedc142547b511c8e00e083ab29b2a"}, "originalPosition": 177}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adea727822c4796b2c7eaf2c71a7988011258031", "author": {"user": {"login": "sandupostaru", "name": "Sandu Postaru"}}, "url": "https://github.com/eclipse/capella/commit/adea727822c4796b2c7eaf2c71a7988011258031", "committedDate": "2020-06-29T15:28:08Z", "message": "Review comments\n\nChange-Id: I31179669ceccfd0c4aeb3c79c722d8f3b4bbcd74"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzIxODM5", "url": "https://github.com/eclipse/capella/pull/287#pullrequestreview-439721839", "createdAt": "2020-06-30T06:59:19Z", "commit": {"oid": "adea727822c4796b2c7eaf2c71a7988011258031"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1304, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}