{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMzM5NzU5", "number": 2880, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyNDo0NFrODdVFOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo1MjoxMlrODdXBAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDgwNjk5OnYy", "diffSide": "RIGHT", "path": "core/schema/src/main/liquibase/26.0.0/changelog.xml", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyNDo0NFrOFl3iPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDoyMjo1NlrOFl5eig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MTUxNg==", "bodyText": "I'm guessing we need to re-create these views because we change the node table?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375251516", "createdAt": "2020-02-05T13:24:44Z", "author": {"login": "j-white"}, "path": "core/schema/src/main/liquibase/26.0.0/changelog.xml", "diffHunk": "@@ -88,4 +88,138 @@\n                                  referencedTableName=\"graph_elements\" referencedColumnNames=\"id\" onDelete=\"CASCADE\"/>\n     </changeSet>\n \n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-snmpinterface\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropNotNullConstraint tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        <dropColumn tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+\n+        <addColumn tableName=\"snmpinterface\">\n+            <column name=\"last_ingress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+            <column name=\"last_egress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+        </addColumn>\n+    </changeSet>\n+\n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-node\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"node\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropView viewName=\"node_outages\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI4MjA3NA==", "bodyText": "Right", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375282074", "createdAt": "2020-02-05T14:21:09Z", "author": {"login": "christianpape"}, "path": "core/schema/src/main/liquibase/26.0.0/changelog.xml", "diffHunk": "@@ -88,4 +88,138 @@\n                                  referencedTableName=\"graph_elements\" referencedColumnNames=\"id\" onDelete=\"CASCADE\"/>\n     </changeSet>\n \n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-snmpinterface\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropNotNullConstraint tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        <dropColumn tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+\n+        <addColumn tableName=\"snmpinterface\">\n+            <column name=\"last_ingress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+            <column name=\"last_egress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+        </addColumn>\n+    </changeSet>\n+\n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-node\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"node\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropView viewName=\"node_outages\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MTUxNg=="}, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI4MzMzOA==", "bodyText": "That sucks :(\nCan we add a comment to make this clear?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375283338", "createdAt": "2020-02-05T14:22:56Z", "author": {"login": "j-white"}, "path": "core/schema/src/main/liquibase/26.0.0/changelog.xml", "diffHunk": "@@ -88,4 +88,138 @@\n                                  referencedTableName=\"graph_elements\" referencedColumnNames=\"id\" onDelete=\"CASCADE\"/>\n     </changeSet>\n \n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-snmpinterface\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropNotNullConstraint tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        <dropColumn tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+\n+        <addColumn tableName=\"snmpinterface\">\n+            <column name=\"last_ingress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+            <column name=\"last_egress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+        </addColumn>\n+    </changeSet>\n+\n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-node\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"node\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropView viewName=\"node_outages\"/>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MTUxNg=="}, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDgxNzU0OnYy", "diffSide": "RIGHT", "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyNzo1NVrOFl3oqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDoyMjozNlrOFl5djg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MzE2MQ==", "bodyText": "Can we do both ingress egress in a single transaction?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375253161", "createdAt": "2020-02-05T13:27:55Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "diffHunk": "@@ -193,11 +196,28 @@ public ElasticFlowRepository(MetricRegistry metricRegistry, JestClient jestClien\n         logMarkingTimer = metricRegistry.timer(\"logMarking\");\n         flowsPerLog = metricRegistry.histogram(\"flowsPerLog\");\n \n-        // Pre-populate marker cache with values from DB\n+        this.markerCache.put(Direction.INGRESS, CacheBuilder.newBuilder()\n+                .expireAfterWrite(1, TimeUnit.HOURS)\n+                .build());\n+\n+        this.sessionUtils.withTransaction(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI4MzA4Ng==", "bodyText": "Done", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375283086", "createdAt": "2020-02-05T14:22:36Z", "author": {"login": "christianpape"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "diffHunk": "@@ -193,11 +196,28 @@ public ElasticFlowRepository(MetricRegistry metricRegistry, JestClient jestClien\n         logMarkingTimer = metricRegistry.timer(\"logMarking\");\n         flowsPerLog = metricRegistry.histogram(\"flowsPerLog\");\n \n-        // Pre-populate marker cache with values from DB\n+        this.markerCache.put(Direction.INGRESS, CacheBuilder.newBuilder()\n+                .expireAfterWrite(1, TimeUnit.HOURS)\n+                .build());\n+\n+        this.sessionUtils.withTransaction(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MzE2MQ=="}, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMDgyMTc2OnYy", "diffSide": "RIGHT", "path": "opennms-base-assembly/src/main/filtered/etc/opennms.properties", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyOToxNFrOFl3rUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDoyNTozOFrOFl5k_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1Mzg0MA==", "bodyText": "Can we rename the variable to maxFlowAgeSeconds to make the unit explicit?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375253840", "createdAt": "2020-02-05T13:29:14Z", "author": {"login": "j-white"}, "path": "opennms-base-assembly/src/main/filtered/etc/opennms.properties", "diffHunk": "@@ -874,3 +874,14 @@ org.opennms.newts.nan_on_counter_wrap=true\n # Defines which endpoints are dispatched to the \"osgi rest provider\".\n # By default /rest and /api/v2 resources are dispatched.\n # org.opennms.features.osgi.bridge.restAliases=/rest,/api/v2\n+\n+# ###### Flow Indicator Cleanup ######\n+# An interface is marked if flow data has been received within the number of seconds specified here.\n+# By default this value is 604800 seconds (= 7 days)\n+# org.opennms.features.telemetry.maxFlowAge=604800", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI4NDk5MQ==", "bodyText": "done", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375284991", "createdAt": "2020-02-05T14:25:38Z", "author": {"login": "christianpape"}, "path": "opennms-base-assembly/src/main/filtered/etc/opennms.properties", "diffHunk": "@@ -874,3 +874,14 @@ org.opennms.newts.nan_on_counter_wrap=true\n # Defines which endpoints are dispatched to the \"osgi rest provider\".\n # By default /rest and /api/v2 resources are dispatched.\n # org.opennms.features.osgi.bridge.restAliases=/rest,/api/v2\n+\n+# ###### Flow Indicator Cleanup ######\n+# An interface is marked if flow data has been received within the number of seconds specified here.\n+# By default this value is 604800 seconds (= 7 days)\n+# org.opennms.features.telemetry.maxFlowAge=604800", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1Mzg0MA=="}, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMTA5MDU2OnYy", "diffSide": "RIGHT", "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo0Mzo0NFrOFl6RkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo0Mzo0NFrOFl6RkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjQwMQ==", "bodyText": "(Beside the missing final ...) a TreeMap used for two variables seems to be overkill. There are cases of conditional handling below anyways.\nA Map#get() and Map#put() compared to reading and writing two variable seems to be wrong.\nIf we decide to keep the Map, there is EnumMap...", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375296401", "createdAt": "2020-02-05T14:43:44Z", "author": {"login": "fooker"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "diffHunk": "@@ -167,7 +170,7 @@\n      *\n      * This maps a node ID to a set if snmpInterface IDs.\n      */\n-    private final ConcurrentMap<Integer, Set<Integer>> markerCache = Maps.newConcurrentMap();\n+    private Map<Direction, Cache<Integer, Set<Integer>>> markerCache = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMyMTEyMzg2OnYy", "diffSide": "RIGHT", "path": "opennms-model/src/main/java/org/opennms/netmgt/model/OnmsNode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo1MjoxMlrOFl6mdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNTowMToyMFrOFl69uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMwMTc1MA==", "bodyText": "new Date().getTime() can be replaced by System.currentTimeMillis()", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375301750", "createdAt": "2020-02-05T14:52:12Z", "author": {"login": "fooker"}, "path": "opennms-model/src/main/java/org/opennms/netmgt/model/OnmsNode.java", "diffHunk": "@@ -448,14 +449,51 @@ public void setSysName(String nodesysname) {\n         m_sysName = nodesysname;\n     }\n \n-    @Column(name=\"hasFlows\", nullable=false)\n-    @XmlAttribute(name=\"hasFlows\")\n+    @Transient\n     public boolean getHasFlows() {\n-        return m_hasFlows;\n+        if (OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED) {\n+            return getHasIngressFlows() && getHasEgressFlows();\n+        } else {\n+            return getHasIngressFlows() || getHasEgressFlows();\n+        }\n+    }\n+\n+    @Transient\n+    public boolean getHasIngressFlows() {\n+        if (m_lastIngressFlow == null) {\n+            return false;\n+        }\n+        return (new Date().getTime() - m_lastIngressFlow.getTime()) / 1000 < OnmsSnmpInterface.MAX_FLOW_AGE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMwNzcwNw==", "bodyText": "done", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375307707", "createdAt": "2020-02-05T15:01:20Z", "author": {"login": "christianpape"}, "path": "opennms-model/src/main/java/org/opennms/netmgt/model/OnmsNode.java", "diffHunk": "@@ -448,14 +449,51 @@ public void setSysName(String nodesysname) {\n         m_sysName = nodesysname;\n     }\n \n-    @Column(name=\"hasFlows\", nullable=false)\n-    @XmlAttribute(name=\"hasFlows\")\n+    @Transient\n     public boolean getHasFlows() {\n-        return m_hasFlows;\n+        if (OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED) {\n+            return getHasIngressFlows() && getHasEgressFlows();\n+        } else {\n+            return getHasIngressFlows() || getHasEgressFlows();\n+        }\n+    }\n+\n+    @Transient\n+    public boolean getHasIngressFlows() {\n+        if (m_lastIngressFlow == null) {\n+            return false;\n+        }\n+        return (new Date().getTime() - m_lastIngressFlow.getTime()) / 1000 < OnmsSnmpInterface.MAX_FLOW_AGE;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMwMTc1MA=="}, "originalCommit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 737, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}