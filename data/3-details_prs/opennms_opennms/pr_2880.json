{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMzM5NzU5", "number": 2880, "title": "NMS-12279: Cleanup interfaces tagged for flows", "bodyText": "JIRA: https://issues.opennms.org/browse/NMS-12279", "createdAt": "2020-02-05T12:11:10Z", "url": "https://github.com/OpenNMS/opennms/pull/2880", "merged": true, "mergeCommit": {"oid": "863492bcfaa21047ab56602e5867a80b5e499d58"}, "closed": true, "closedAt": "2020-02-12T06:41:37Z", "author": {"login": "christianpape"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBW4LogFqTM1MzcxMDMzOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDXmKGgFqTM1Njk2MzcxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNzEwMzM5", "url": "https://github.com/OpenNMS/opennms/pull/2880#pullrequestreview-353710339", "createdAt": "2020-02-05T13:24:44Z", "commit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyNDo0NFrOFl3iPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxMzoyOToxNFrOFl3rUA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MTUxNg==", "bodyText": "I'm guessing we need to re-create these views because we change the node table?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375251516", "createdAt": "2020-02-05T13:24:44Z", "author": {"login": "j-white"}, "path": "core/schema/src/main/liquibase/26.0.0/changelog.xml", "diffHunk": "@@ -88,4 +88,138 @@\n                                  referencedTableName=\"graph_elements\" referencedColumnNames=\"id\" onDelete=\"CASCADE\"/>\n     </changeSet>\n \n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-snmpinterface\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropNotNullConstraint tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+        <dropColumn tableName=\"snmpinterface\" columnName=\"hasflows\" />\n+\n+        <addColumn tableName=\"snmpinterface\">\n+            <column name=\"last_ingress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+            <column name=\"last_egress_flow\" type=\"TIMESTAMP WITH TIME ZONE\"  />\n+        </addColumn>\n+    </changeSet>\n+\n+    <changeSet author=\"cpape\" id=\"26.0.0-has-flows-node\">\n+        <preConditions onFail=\"MARK_RAN\">\n+            <columnExists tableName=\"node\" columnName=\"hasflows\" />\n+        </preConditions>\n+\n+        <dropView viewName=\"node_outages\"/>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1MzE2MQ==", "bodyText": "Can we do both ingress egress in a single transaction?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375253161", "createdAt": "2020-02-05T13:27:55Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "diffHunk": "@@ -193,11 +196,28 @@ public ElasticFlowRepository(MetricRegistry metricRegistry, JestClient jestClien\n         logMarkingTimer = metricRegistry.timer(\"logMarking\");\n         flowsPerLog = metricRegistry.histogram(\"flowsPerLog\");\n \n-        // Pre-populate marker cache with values from DB\n+        this.markerCache.put(Direction.INGRESS, CacheBuilder.newBuilder()\n+                .expireAfterWrite(1, TimeUnit.HOURS)\n+                .build());\n+\n+        this.sessionUtils.withTransaction(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI1Mzg0MA==", "bodyText": "Can we rename the variable to maxFlowAgeSeconds to make the unit explicit?", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375253840", "createdAt": "2020-02-05T13:29:14Z", "author": {"login": "j-white"}, "path": "opennms-base-assembly/src/main/filtered/etc/opennms.properties", "diffHunk": "@@ -874,3 +874,14 @@ org.opennms.newts.nan_on_counter_wrap=true\n # Defines which endpoints are dispatched to the \"osgi rest provider\".\n # By default /rest and /api/v2 resources are dispatched.\n # org.opennms.features.osgi.bridge.restAliases=/rest,/api/v2\n+\n+# ###### Flow Indicator Cleanup ######\n+# An interface is marked if flow data has been received within the number of seconds specified here.\n+# By default this value is 604800 seconds (= 7 days)\n+# org.opennms.features.telemetry.maxFlowAge=604800", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2fb5aede8436e3806f7a2f38dc73438c9d16fb2"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNzY5MzY5", "url": "https://github.com/OpenNMS/opennms/pull/2880#pullrequestreview-353769369", "createdAt": "2020-02-05T14:43:44Z", "commit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo0Mzo0NFrOFl6RkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo0Mzo0NFrOFl6RkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTI5NjQwMQ==", "bodyText": "(Beside the missing final ...) a TreeMap used for two variables seems to be overkill. There are cases of conditional handling below anyways.\nA Map#get() and Map#put() compared to reading and writing two variable seems to be wrong.\nIf we decide to keep the Map, there is EnumMap...", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375296401", "createdAt": "2020-02-05T14:43:44Z", "author": {"login": "fooker"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/ElasticFlowRepository.java", "diffHunk": "@@ -167,7 +170,7 @@\n      *\n      * This maps a node ID to a set if snmpInterface IDs.\n      */\n-    private final ConcurrentMap<Integer, Set<Integer>> markerCache = Maps.newConcurrentMap();\n+    private Map<Direction, Cache<Integer, Set<Integer>>> markerCache = new TreeMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNzc2NDIy", "url": "https://github.com/OpenNMS/opennms/pull/2880#pullrequestreview-353776422", "createdAt": "2020-02-05T14:52:12Z", "commit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo1MjoxMlrOFl6mdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNDo1MjoxMlrOFl6mdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTMwMTc1MA==", "bodyText": "new Date().getTime() can be replaced by System.currentTimeMillis()", "url": "https://github.com/OpenNMS/opennms/pull/2880#discussion_r375301750", "createdAt": "2020-02-05T14:52:12Z", "author": {"login": "fooker"}, "path": "opennms-model/src/main/java/org/opennms/netmgt/model/OnmsNode.java", "diffHunk": "@@ -448,14 +449,51 @@ public void setSysName(String nodesysname) {\n         m_sysName = nodesysname;\n     }\n \n-    @Column(name=\"hasFlows\", nullable=false)\n-    @XmlAttribute(name=\"hasFlows\")\n+    @Transient\n     public boolean getHasFlows() {\n-        return m_hasFlows;\n+        if (OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED) {\n+            return getHasIngressFlows() && getHasEgressFlows();\n+        } else {\n+            return getHasIngressFlows() || getHasEgressFlows();\n+        }\n+    }\n+\n+    @Transient\n+    public boolean getHasIngressFlows() {\n+        if (m_lastIngressFlow == null) {\n+            return false;\n+        }\n+        return (new Date().getTime() - m_lastIngressFlow.getTime()) / 1000 < OnmsSnmpInterface.MAX_FLOW_AGE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8caabff7eea3472fb3f1c13c21994a758f9394b"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f5514fb4357fe4062668ce12ef229b73d124606", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/8f5514fb4357fe4062668ce12ef229b73d124606", "committedDate": "2020-02-05T15:02:12Z", "message": "NMS-12279: More fixes"}, "afterCommit": {"oid": "ef1790d631893a2961e76f6f9541d307469cc422", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/ef1790d631893a2961e76f6f9541d307469cc422", "committedDate": "2020-02-05T15:10:15Z", "message": "NMS-12279: Cleanup interfaces tagged for flows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7353275fa11c250398c842da9ab0b10ad04056", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/6f7353275fa11c250398c842da9ab0b10ad04056", "committedDate": "2020-02-05T15:26:27Z", "message": "NMS-12279: Cleanup interfaces tagged for flows"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef1790d631893a2961e76f6f9541d307469cc422", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/ef1790d631893a2961e76f6f9541d307469cc422", "committedDate": "2020-02-05T15:10:15Z", "message": "NMS-12279: Cleanup interfaces tagged for flows"}, "afterCommit": {"oid": "6f7353275fa11c250398c842da9ab0b10ad04056", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/6f7353275fa11c250398c842da9ab0b10ad04056", "committedDate": "2020-02-05T15:26:27Z", "message": "NMS-12279: Cleanup interfaces tagged for flows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab8bc6bea4e23eb17e149f424a04c7cf2e3dae68", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/ab8bc6bea4e23eb17e149f424a04c7cf2e3dae68", "committedDate": "2020-02-06T07:35:34Z", "message": "NMS-12279: Fixed smoke test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2OTYzNzEy", "url": "https://github.com/OpenNMS/opennms/pull/2880#pullrequestreview-356963712", "createdAt": "2020-02-11T20:17:21Z", "commit": {"oid": "ab8bc6bea4e23eb17e149f424a04c7cf2e3dae68"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3729, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}