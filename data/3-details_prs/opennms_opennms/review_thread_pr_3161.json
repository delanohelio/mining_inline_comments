{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MzQ3MTA2", "number": 3161, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDowMDo0OVrOElGWtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowNTo0N1rOEmPtQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MzM2ODg1OnYy", "diffSide": "RIGHT", "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDowMDo0OVrOHUaN2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQyMDowMDo0OVrOHUaN2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE2MzA5OQ==", "bodyText": "@fooker , @christianpape, the test will succeed with this implementation. But It is not clear to me why the system behaves like it does. Why is it green when I implement it that way?\nI assume the checkInterfaces method is implemented wrong. I don't have enough domain knowledge to understand what we need to test for...\nMaybe you can help me out here... Thanks!", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r491163099", "createdAt": "2020-09-18T20:00:49Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +236,81 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+        }\n+    }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Assert.assertThat(nodeDao.findAllHavingFlows(), is(empty()));\n+            Assert.assertThat(snmpInterfaceDao.findAllHavingFlows(1), is(empty()));\n+            Assert.assertThat(snmpInterfaceDao.findAllHavingFlows(2), is(empty()));\n+\n+            elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n+            checkInterfaces(1, \"192.168.1.1\");\n+            checkInterfaces(2);\n+\n+            elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.INGRESS)), getMockFlowSource());\n+            checkInterfaces(1, \"192.168.1.1\", \"192.168.1.1\");\n+            checkInterfaces(2);\n+\n+            elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.INGRESS)), getMockFlowSource());\n+            checkInterfaces(1, \"192.168.1.1\", \"192.168.1.1\");\n+            checkInterfaces(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da7b3a7ddde10090b2fa7b14232946d603c42d75"}, "originalPosition": 115}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTM3MjM3OnYy", "diffSide": "RIGHT", "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowMTozMVrOHWKSXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo1ODozNVrOHWv4_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5OTI2Mw==", "bodyText": "Comment / code mismatch (ingress vs egress)", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r492999263", "createdAt": "2020-09-22T20:01:31Z", "author": {"login": "fooker"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;\n+            Integer egress = 3;\n+\n+            // no flows persisted -> we shouldn't have any interfaces\n+            expectAllInterfaces();\n+            expectIngressInterfaces();\n+            expectEgressInterfaces();\n+\n+            // persist egress flow", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNTM1Ng==", "bodyText": "fixed", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493615356", "createdAt": "2020-09-23T13:58:35Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;\n+            Integer egress = 3;\n+\n+            // no flows persisted -> we shouldn't have any interfaces\n+            expectAllInterfaces();\n+            expectIngressInterfaces();\n+            expectEgressInterfaces();\n+\n+            // persist egress flow", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5OTI2Mw=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTM3Mjc3OnYy", "diffSide": "RIGHT", "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowMTo0MVrOHWKSpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo1ODo0MVrOHWv5XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5OTMzMw==", "bodyText": "And the other way around", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r492999333", "createdAt": "2020-09-22T20:01:41Z", "author": {"login": "fooker"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;\n+            Integer egress = 3;\n+\n+            // no flows persisted -> we shouldn't have any interfaces\n+            expectAllInterfaces();\n+            expectIngressInterfaces();\n+            expectEgressInterfaces();\n+\n+            // persist egress flow\n+            elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.INGRESS)), getMockFlowSource());\n+            expectAllInterfaces(ingress);\n+            expectIngressInterfaces(ingress);\n+            expectEgressInterfaces();\n+\n+            // persist ingress flow", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNTQ1Mg==", "bodyText": "fixed", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493615452", "createdAt": "2020-09-23T13:58:41Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;\n+            Integer egress = 3;\n+\n+            // no flows persisted -> we shouldn't have any interfaces\n+            expectAllInterfaces();\n+            expectIngressInterfaces();\n+            expectEgressInterfaces();\n+\n+            // persist egress flow\n+            elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.INGRESS)), getMockFlowSource());\n+            expectAllInterfaces(ingress);\n+            expectIngressInterfaces(ingress);\n+            expectEgressInterfaces();\n+\n+            // persist ingress flow", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjk5OTMzMw=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTM4MjA2OnYy", "diffSide": "RIGHT", "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowNDoyOVrOHWKYUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxMzo0NToxNlrOHWvOIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMDc4Nw==", "bodyText": "Use SessionUtils instead. It saves you from a lot of boilerplate code", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493000787", "createdAt": "2020-09-22T20:04:29Z", "author": {"login": "fooker"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -108,6 +116,9 @@\n     @Autowired\n     private InterfaceToNodeCache interfaceToNodeCache;\n \n+    @Autowired\n+    private TransactionTemplate transactionTemplate;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYwNDM4Nw==", "bodyText": "\ud83d\udc4d  fixed", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493604387", "createdAt": "2020-09-23T13:45:16Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -108,6 +116,9 @@\n     @Autowired\n     private InterfaceToNodeCache interfaceToNodeCache;\n \n+    @Autowired\n+    private TransactionTemplate transactionTemplate;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMDc4Nw=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NTM4NjkwOnYy", "diffSide": "RIGHT", "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQyMDowNTo0N1rOHWKbOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QxNDowMToxMVrOHWwBhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMTUyOA==", "bodyText": "Any reason why these (and others below) are Integer, not int?", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493001528", "createdAt": "2020-09-22T20:05:47Z", "author": {"login": "fooker"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMjExOQ==", "bodyText": "In this case: just inline them or make them real constants (same for the nodeId below.", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493002119", "createdAt": "2020-09-22T20:06:59Z", "author": {"login": "fooker"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMTUyOA=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNTcyNg==", "bodyText": "Any reason why these (and others below) are Integer, not int?\nnope. fixed.", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493615726", "createdAt": "2020-09-23T13:58:58Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMTUyOA=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 83}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzYxNzU0Mw==", "bodyText": "In this case: just inline them or make them real constants (same for the nodeId below.\n\nThe reason I wanted to use a named variable (and not inline) is that it reads easier (\"2\" has no meaning).\nBut they are only used in the scope of the method so I didn't wanted to make it a class constant.\nI made it final as a compromise. Sounds good?", "url": "https://github.com/OpenNMS/opennms/pull/3161#discussion_r493617543", "createdAt": "2020-09-23T14:01:11Z", "author": {"login": "patrick-schweizer"}, "path": "features/flows/itests/src/test/java/org/opennms/netmgt/flows/elastic/MarkerCacheIT.java", "diffHunk": "@@ -221,11 +232,97 @@ public void testNMS12740() throws Exception {\n \n             elasticFlowRepository.persist(Lists.newArrayList(getMockFlow(Flow.Direction.EGRESS)), getMockFlowSource());\n \n-            Assert.assertEquals(0,snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingIngressFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingEgressFlows(2).size());\n \n             // the following call resulted to two wrong entries before, since the wrong query returned entries from other nodes with egress flows\n-            Assert.assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n+            assertEquals(0, snmpInterfaceDao.findAllHavingFlows(2).size());\n         }\n     }\n+\n+    @Test\n+    public void shouldDistinguishBetweenIngressAndEgressWhenDeterminingIfFlowsAreAvailable() throws Exception {\n+        Assert.assertFalse(OnmsSnmpInterface.INGRESS_AND_EGRESS_REQUIRED);\n+\n+        stubFor(post(\"/_bulk\")\n+                .willReturn(aResponse()\n+                        .withStatus(200)\n+                        .withHeader(\"Content-Type\", \"application/json\")));\n+\n+        final ClassificationEngine classificationEngine = new DefaultClassificationEngine(() -> Lists.newArrayList(\n+                new RuleBuilder().withName(\"http\").withDstPort(\"80\").withProtocol(\"tcp,udp\").build(),\n+                new RuleBuilder().withName(\"https\").withDstPort(\"443\").withProtocol(\"tcp,udp\").build()\n+        ), FilterService.NOOP);\n+\n+        final DocumentEnricher documentEnricher = new DocumentEnricher(\n+                new MetricRegistry(), nodeDao, interfaceToNodeCache, sessionUtils, classificationEngine,\n+                new CacheConfigBuilder()\n+                        .withName(\"flows.node\")\n+                        .withMaximumSize(1000)\n+                        .withExpireAfterWrite(300)\n+                        .build());\n+\n+        final JestClientFactory factory = new JestClientFactory();\n+        factory.setHttpClientConfig(new HttpClientConfig.Builder(\"http://localhost:\" + wireMockRule.port()).build());\n+\n+        try (JestClient client = factory.getObject()) {\n+            final ElasticFlowRepository elasticFlowRepository = new ElasticFlowRepository(new MetricRegistry(),\n+                    client, IndexStrategy.MONTHLY, documentEnricher,\n+                    sessionUtils, nodeDao, snmpInterfaceDao,\n+                    new MockIdentity(), new MockTracerRegistry(), new MockDocumentForwarder(), new IndexSettings(),\n+                    mock(SmartQueryService.class));\n+\n+            Integer ingress = 2;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzAwMTUyOA=="}, "originalCommit": {"oid": "c797dd7820ab1f07f690d8ee91e89b5ff31b06da"}, "originalPosition": 83}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2972, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}