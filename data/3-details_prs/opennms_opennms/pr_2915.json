{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2OTI1Mzg5", "number": 2915, "title": "NMS-12580: Improve NodeInfoCache handling", "bodyText": "Query the InterfaceNodeCache first and if there is a relavant nodeId query NodeInfoCache for the node document.\nAlso modify nodeCache settings to cache 10000 elements and set the cache to not to expire.\nExternal References\n\nJIRA (Issue Tracker): http://issues.opennms.org/browse/NMS-12580\nBamboo (Continuous Integration): https://bamboo.opennms.org/", "createdAt": "2020-03-11T21:19:15Z", "url": "https://github.com/OpenNMS/opennms/pull/2915", "merged": true, "mergeCommit": {"oid": "30818589681c94c875b17f74e7c05a6b24b1e35f"}, "closed": true, "closedAt": "2020-03-13T20:03:38Z", "author": {"login": "cgorantla"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMtJtBAH2gAyMzg2OTI1Mzg5OmYzN2IyMzlkODQzYWJjZDZiY2MwMTA2YTMwZjVmYjM5YjNiZWU4NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNUzEngFqTM3NDUzMTcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f37b239d843abcd6bcc0106a30f5fb39b3bee846", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/f37b239d843abcd6bcc0106a30f5fb39b3bee846", "committedDate": "2020-03-11T20:29:30Z", "message": "NMS-12580: Modify the NodeInfoCache to be keyed by nodeId\n\nAlso try to check the presence of exporter/src/dest addresses\nfrom the InterfacetoNodeCache before querying NodeInfoCache."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76400c54cc3fa9005bb3dbfc13417f76dcb543b6", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/76400c54cc3fa9005bb3dbfc13417f76dcb543b6", "committedDate": "2020-03-11T20:50:47Z", "message": "NMS-12580: Modify nodeCache settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjE1NzUy", "url": "https://github.com/OpenNMS/opennms/pull/2915#pullrequestreview-373215752", "createdAt": "2020-03-12T00:46:37Z", "commit": {"oid": "d1948cd49cd22742a1d4182be36822cb95395b13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDo0NjozOFrOF1N9uA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwMDo0NjozOFrOF1N9uA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTM0NzY0MA==", "bodyText": "We need to keep this logic. We can perform the check before the interfaceToNodeCache lookup, and store the results in a separate cache (keyed by contextKey).", "url": "https://github.com/OpenNMS/opennms/pull/2915#discussion_r391347640", "createdAt": "2020-03-12T00:46:38Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/DocumentEnricher.java", "diffHunk": "@@ -150,40 +148,24 @@ private static boolean isPrivateAddress(String ipAddress) {\n         return inetAddress.isLoopbackAddress() || inetAddress.isLinkLocalAddress() || inetAddress.isSiteLocalAddress();\n     }\n \n-    private Optional<NodeDocument> getNodeInfoFromCache(final String location, final String ipAddress, final ContextKey contextKey, final String value) {\n-        final NodeInfoKey key = new NodeInfoKey(location, ipAddress, contextKey, value);\n-        try {\n-            return nodeInfoCache.get(key);\n-        } catch (ExecutionException e) {\n-            LOG.error(\"Error while retrieving NodeDocument from NodeInfoCache: {}.\", e.getMessage(), e);\n-            throw new RuntimeException(e);\n+    private Optional<NodeDocument> getNodeInfoFromCache(final String location, final String ipAddress) {\n+        final Optional<Integer> nodeId = interfaceToNodeCache.getFirstNodeId(location, InetAddressUtils.addr(ipAddress));\n+        if(nodeId.isPresent()) {\n+            try {\n+                return nodeInfoCache.get(nodeId.get());\n+            } catch (ExecutionException e) {\n+                LOG.error(\"Error while retrieving NodeDocument from NodeInfoCache: {}.\", e.getMessage(), e);\n+                throw new RuntimeException(e);\n+            }\n         }\n+        return Optional.empty();\n     }\n \n-    private Optional<NodeDocument> getNodeInfo(final String location, final String ipAddress, final ContextKey contextKey, final String value) {\n-        return getNodeInfo(location, InetAddressUtils.addr(ipAddress), contextKey, value);\n-    }\n \n-    private Optional<NodeDocument> getNodeInfo(final String location, final InetAddress ipAddress, final ContextKey contextKey, final String value) {\n+    private Optional<NodeDocument> getNodeInfo(Integer nodeId) {\n         OnmsNode onmsNode = null;\n-\n-        if (contextKey != null && !Strings.isNullOrEmpty(value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1948cd49cd22742a1d4182be36822cb95395b13"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/620df1354a0ce717a5623bbdfc94e412b237d864", "committedDate": "2020-03-12T22:10:57Z", "message": "NMS-12580: Add cache for metadata context"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1948cd49cd22742a1d4182be36822cb95395b13", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/d1948cd49cd22742a1d4182be36822cb95395b13", "committedDate": "2020-03-11T21:50:19Z", "message": "NMS-12580: Fix test"}, "afterCommit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/620df1354a0ce717a5623bbdfc94e412b237d864", "committedDate": "2020-03-12T22:10:57Z", "message": "NMS-12580: Add cache for metadata context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczOTk5NjQ5", "url": "https://github.com/OpenNMS/opennms/pull/2915#pullrequestreview-373999649", "createdAt": "2020-03-13T01:44:49Z", "commit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo0NDo0OVrOF11GhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwMTo0NzowMFrOF11IhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk4ODg2OA==", "bodyText": "Let's only perform this if contextKey != null && !Strings.isNullOrEmpty(value) and remove that check from the cache loader (i.e. getNodeInfoFromMetadataContext)", "url": "https://github.com/OpenNMS/opennms/pull/2915#discussion_r391988868", "createdAt": "2020-03-13T01:44:49Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/DocumentEnricher.java", "diffHunk": "@@ -151,68 +163,40 @@ private static boolean isPrivateAddress(String ipAddress) {\n     }\n \n     private Optional<NodeDocument> getNodeInfoFromCache(final String location, final String ipAddress, final ContextKey contextKey, final String value) {\n-        final NodeInfoKey key = new NodeInfoKey(location, ipAddress, contextKey, value);\n+\n+        Optional<NodeDocument> nodeDocument;\n+        final NodeMetadataKey metadataKey = new NodeMetadataKey(contextKey, value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk4OTA0Ng==", "bodyText": "Would be nice to time this with the nodeLoadTimer too.", "url": "https://github.com/OpenNMS/opennms/pull/2915#discussion_r391989046", "createdAt": "2020-03-13T01:45:39Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/DocumentEnricher.java", "diffHunk": "@@ -221,19 +205,58 @@ private NodeInfoKey(final String location, final String ipAddress, final Context\n         public boolean equals(Object o) {\n             if (this == o) return true;\n             if (o == null || getClass() != o.getClass()) return false;\n-            final NodeInfoKey that = (NodeInfoKey) o;\n-            return Objects.equals(location, that.location) &&\n-                    Objects.equals(ipAddress, that.ipAddress) &&\n-                    Objects.equals(contextKey, that.contextKey) &&\n+            final NodeMetadataKey that = (NodeMetadataKey) o;\n+            return Objects.equals(contextKey, that.contextKey) &&\n                     Objects.equals(value, that.value);\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hash(location, ipAddress, contextKey, value);\n+            return Objects.hash(contextKey, value);\n         }\n     }\n \n+    private Optional<NodeDocument> getNodeInfoFromMetadataContext(ContextKey contextKey, String value) {\n+        OnmsNode onmsNode = null;\n+        if (contextKey != null && !Strings.isNullOrEmpty(value)) {\n+            final List<OnmsNode> nodes = nodeDao.findNodeWithMetaData(contextKey.getContext(), contextKey.getKey(), value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864"}, "originalPosition": 148}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk4OTM4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            onmsNode = nodes.get(0);\n          \n          \n            \n                            return mapOnmsNodeToNodeDocument(nodes.get(0));\n          \n      \n    \n    \n  \n\nthen can remove onmsNode local variable and other if statement bellow.", "url": "https://github.com/OpenNMS/opennms/pull/2915#discussion_r391989381", "createdAt": "2020-03-13T01:47:00Z", "author": {"login": "j-white"}, "path": "features/flows/elastic/src/main/java/org/opennms/netmgt/flows/elastic/DocumentEnricher.java", "diffHunk": "@@ -221,19 +205,58 @@ private NodeInfoKey(final String location, final String ipAddress, final Context\n         public boolean equals(Object o) {\n             if (this == o) return true;\n             if (o == null || getClass() != o.getClass()) return false;\n-            final NodeInfoKey that = (NodeInfoKey) o;\n-            return Objects.equals(location, that.location) &&\n-                    Objects.equals(ipAddress, that.ipAddress) &&\n-                    Objects.equals(contextKey, that.contextKey) &&\n+            final NodeMetadataKey that = (NodeMetadataKey) o;\n+            return Objects.equals(contextKey, that.contextKey) &&\n                     Objects.equals(value, that.value);\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hash(location, ipAddress, contextKey, value);\n+            return Objects.hash(contextKey, value);\n         }\n     }\n \n+    private Optional<NodeDocument> getNodeInfoFromMetadataContext(ContextKey contextKey, String value) {\n+        OnmsNode onmsNode = null;\n+        if (contextKey != null && !Strings.isNullOrEmpty(value)) {\n+            final List<OnmsNode> nodes = nodeDao.findNodeWithMetaData(contextKey.getContext(), contextKey.getKey(), value);\n+\n+            if (!nodes.isEmpty()) {\n+                onmsNode = nodes.get(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "620df1354a0ce717a5623bbdfc94e412b237d864"}, "originalPosition": 151}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1c44863c9d6641140a92e5ba32ca9f2cdd1379", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/fc1c44863c9d6641140a92e5ba32ca9f2cdd1379", "committedDate": "2020-03-13T17:59:47Z", "message": "NMS-12580: Update NodeMetadaCache"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NTMxNzEx", "url": "https://github.com/OpenNMS/opennms/pull/2915#pullrequestreview-374531711", "createdAt": "2020-03-13T18:40:59Z", "commit": {"oid": "fc1c44863c9d6641140a92e5ba32ca9f2cdd1379"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3791, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}