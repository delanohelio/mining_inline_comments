{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0Mzk3MjEz", "number": 2912, "title": "NMS-12578: Confd templates for Minion configuration", "bodyText": "This PR adds the ability for some of Minion's configuration to be applied by confd via a yaml file mounted on container startup. Similar to how the OpenNMS container was updated to use confd in this PR opennms-forge/docker-horizon-core-web#58.\nThis PR isn't meant to cover all of Minion's configuration, just a part 1 covering the low hanging fruit.\nAll Contributors\n\n Have you read and followed our Contribution Guidelines?\n Have you made an issue in the OpenNMS issue tracker?If so, you should:\n\nupdate the title of this PR to be of the format: ${JIRA-ISSUE-NUMBER}: subject of pull request\nupdate the JIRA link at the bottom of this comment to refer to the real issue number\nprefix your commit messages with the issue number, if possible\n\n\n Have you made a comment in that issue which points back to this PR?\n Have you updated the JIRA link at the bottom of this comment to link to your issue?\n If this is a new or updated feature, is there documentation for the new behavior?\n If this is new code, are there unit and/or integration tests?\n If this PR targets a foundation-* branch, does it avoid changing files in $OPENNMS_HOME/etc/?\n\nPull Request Process\nOne or more reviewers should be assigned to each PR.\nIf you know that a particular person is subject matter expert in the area your PR affects, feel free to assign one or more reviewers when you create this PR, otherwise reviewers will be assigned for you.\nOnce the reviewer(s) accept the PR and the branch passes continuous integration in Bamboo, the PR is eligible for merge.\nAt that time, if you have commit access (are an OpenNMS Group employee or a member of the Order of the Green Polo) you are welcome to merge the PR.\nOtherwise, a reviewer can merge it for you.\nThanks for taking time to contribute!\nExternal References\n\nJIRA (Issue Tracker): http://issues.opennms.org/browse/NMS-12578\nBamboo (Continuous Integration): https://bamboo.opennms.org/", "createdAt": "2020-03-05T17:07:04Z", "url": "https://github.com/OpenNMS/opennms/pull/2912", "merged": true, "mergeCommit": {"oid": "d2c5723ed2c41d972d1d99ac1a8fe33f1679eb4e"}, "closed": true, "closedAt": "2020-03-12T17:50:53Z", "author": {"login": "mattixtech"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKuhn4gH2gAyMzg0Mzk3MjEzOjRjY2NjZDQxYzNlOGVmM2Q3MjVkYjc0YjYwNWM1Nzc0NDdmZTJjMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcM-GseAH2gAyMzg0Mzk3MjEzOjY3Y2NmZGMwNjFmYzcxMmNiOTcxZmNjMTljMTNiMzQ1Y2QwYjlmNTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4ccccd41c3e8ef3d725db74b605c577447fe2c02", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/4ccccd41c3e8ef3d725db74b605c577447fe2c02", "committedDate": "2020-03-05T16:57:41Z", "message": "NMS-12578: Confd templates for Minion configuration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzcxNTA3", "url": "https://github.com/OpenNMS/opennms/pull/2912#pullrequestreview-369771507", "createdAt": "2020-03-05T17:31:21Z", "commit": {"oid": "4ccccd41c3e8ef3d725db74b605c577447fe2c02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzozMToyMVrOFydDKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNzozMToyMVrOFydDKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ0OTA2NA==", "bodyText": "Can we update the default/existing system.properties files to include a statement like ${optionals} = confd.system.properties  and append the properties there rather than templating this file?\nThat would save us from having to maintain this template for Karaf upgrades going forward.", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388449064", "createdAt": "2020-03-05T17:31:21Z", "author": {"login": "j-white"}, "path": "opennms-container/minion/confd/templates/system.properties.tmpl", "diffHunk": "@@ -0,0 +1,161 @@\n+################################################################################", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ccccd41c3e8ef3d725db74b605c577447fe2c02"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/eccf9eef9d116218e2b02f34e21cf3b0e0a636a2", "committedDate": "2020-03-05T22:39:43Z", "message": "Review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDE4OTM0", "url": "https://github.com/OpenNMS/opennms/pull/2912#pullrequestreview-370418934", "createdAt": "2020-03-06T15:42:14Z", "commit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo0MjoxNFrOFy9Rfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo1MzoxMFrOFy9qQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk3NzAyMg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388977022", "createdAt": "2020-03-06T15:42:14Z", "author": {"login": "indigo423"}, "path": "opennms-container/minion/Dockerfile", "diffHunk": "@@ -68,6 +68,15 @@ RUN if [[ \"$(ls -1 /tmp/rpms/*.rpm 2>/dev/null | wc -l)\" != 0 ]]; then dnf -y in\n \n COPY ./assets/* /\n \n+# Install confd\n+ARG CONFD_VERSION=\"0.16.0\"\n+ARG CONFD_ARCH=\"amd64\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4MzM2MA==", "bodyText": "Just to be sure, we nail it down to use only the minion-config.yaml file and don't allow other configuration backends right? Just as a quick idea, we could gain some flexibility using a confd.toml and call the binary with -config-file. By default it picks up a confd.toml from /etc/confd/confd.toml.\nconfdir = \"/etc/confd\"\nbackend = \"file\"\nfile = \"/opt/minion/minion-config.yaml\"\n\nI don't worry much - no blocker for and really just a minor comment.", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r388983360", "createdAt": "2020-03-06T15:53:10Z", "author": {"login": "indigo423"}, "path": "opennms-container/minion/assets/entrypoint.sh", "diffHunk": "@@ -149,12 +152,42 @@ applyOverlayConfig() {\n   fi\n }\n \n+applyConfd() {\n+  if [ -f \"${CONFD_KEY_STORE}\" ]; then\n+    echo \"Found a configuration key store, applying configuration via confd.\"\n+    runConfd\n+  else\n+    echo \"No configuration key store present, skipping confd configuration.\"\n+  fi\n+}\n+\n start() {\n     export KARAF_EXEC=\"exec\"\n     cd ${MINION_HOME}/bin\n     exec ./karaf server\n }\n \n+runConfd() {\n+  # Create any directories that confd might write to\n+  while IFS= read -r dir; do\n+    local dirToCreate=\"$MINION_HOME\"/\"$dir\"\n+    echo \"Creating $dirToCreate so confd can write to it\"\n+    mkdir -p \"$dirToCreate\"\n+  done < \"$CONFD_CONFIG_DIR\"/directories\n+\n+  \"$CONFD_BIN\" -log-level debug -onetime -backend=file -file \"$CONFD_KEY_STORE\" -confdir \"$CONFD_CONFIG_DIR\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNTAwNTI4", "url": "https://github.com/OpenNMS/opennms/pull/2912#pullrequestreview-370500528", "createdAt": "2020-03-06T17:31:07Z", "commit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzozMTowN1rOFzBNOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNzozMTozOFrOFzBOPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTQ2Ng==", "bodyText": "Given this is in the default system.properties file and not just in the container, maybe we should actually rename it.\nKaraf has this stanza in their default configuration, maybe we just reuse it? https://github.com/apache/karaf/blob/master/assemblies/features/base/src/main/resources/resources/etc/system.properties#L25\nNote that it's also at the top of the time, and not the bottom, not sure if that makes a difference.", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389041466", "createdAt": "2020-03-06T17:31:07Z", "author": {"login": "j-white"}, "path": "features/container/minion/src/main/filtered-resources/etc/system.properties", "diffHunk": "@@ -148,3 +148,5 @@ karaf.secured.services = (&(osgi.command.scope=*)(osgi.command.function=*))\n \n # OPENNMS: Enable SNMP4J Log4j logging\n snmp4j.LogFactory=org.snmp4j.log.Log4jLogFactory\n+\n+${optionals} = confd.system.properties", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTA0MTcyNg==", "bodyText": "Should be be strongly modeling all of the system properties, or try and keep this generic from a template perspective?", "url": "https://github.com/OpenNMS/opennms/pull/2912#discussion_r389041726", "createdAt": "2020-03-06T17:31:38Z", "author": {"login": "j-white"}, "path": "opennms-container/minion/confd/templates/confd.system.properties.tmpl", "diffHunk": "@@ -0,0 +1,10 @@\n+{{$snmp2In1Key := \"/snmp/snmp4j/org.opennms.snmp.snmp4j.allowSNMPv2InV1\" -}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eccf9eef9d116218e2b02f34e21cf3b0e0a636a2"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0872476f759ed2da5c65432f09e7a131706c0fe", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/d0872476f759ed2da5c65432f09e7a131706c0fe", "committedDate": "2020-03-06T20:08:33Z", "message": "More review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b7d2ac016fe95b48c9efdf58a6e352941ed0f71", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/5b7d2ac016fe95b48c9efdf58a6e352941ed0f71", "committedDate": "2020-03-09T16:08:12Z", "message": "In the case of no single port telemetry config, don't provide a default configuration (will rely on overlay to configure that for now)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18aace38d733c283cd7f54514806d85a51c2c437", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/18aace38d733c283cd7f54514806d85a51c2c437", "committedDate": "2020-03-10T18:59:20Z", "message": "Update smoke tests to use minion-config.yaml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44171535c0de168100d087d6be8aa847b29062d5", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/44171535c0de168100d087d6be8aa847b29062d5", "committedDate": "2020-03-10T20:48:45Z", "message": "Tweak smoke tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "100c10a8963489543aafb03f7fa59adea972f24e", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/100c10a8963489543aafb03f7fa59adea972f24e", "committedDate": "2020-03-10T20:54:44Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0075c44624a188272ac6333edb8987e5cc348194", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/0075c44624a188272ac6333edb8987e5cc348194", "committedDate": "2020-03-11T01:24:21Z", "message": "Include id, location, and broker settings in yaml config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f55688a089a26dea1f1a444725d11dffc0fc78f", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/7f55688a089a26dea1f1a444725d11dffc0fc78f", "committedDate": "2020-03-11T01:35:54Z", "message": "TODO: Need to figure out what we want to be configurable via yaml for flows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56e46985491ba678133c105bbbba1ce8792589c5", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/56e46985491ba678133c105bbbba1ce8792589c5", "committedDate": "2020-03-11T14:08:22Z", "message": "Typo!!! :("}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc15ad35be184d18fdac1926128e299b717837a2", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/fc15ad35be184d18fdac1926128e299b717837a2", "committedDate": "2020-03-11T20:21:30Z", "message": "Expand confd configuration of flows"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMjE2OTEx", "url": "https://github.com/OpenNMS/opennms/pull/2912#pullrequestreview-373216911", "createdAt": "2020-03-12T00:50:54Z", "commit": {"oid": "fc15ad35be184d18fdac1926128e299b717837a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67ccfdc061fc712cb971fcc19c13b345cd0b9f51", "author": {"user": {"login": "mattixtech", "name": "Matthew Brooks"}}, "url": "https://github.com/OpenNMS/opennms/commit/67ccfdc061fc712cb971fcc19c13b345cd0b9f51", "committedDate": "2020-03-12T16:14:36Z", "message": "Add an assert to the test, oops!\n[skip-ci]"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3789, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}