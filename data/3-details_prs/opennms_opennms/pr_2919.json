{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MjIwMzA2", "number": 2919, "title": "NMS-12483: Publish AMD64/ARMv7/ARM64 Docker images for Minion", "bodyText": "All Contributors\n\n Have you read and followed our Contribution Guidelines?\n Have you made an issue in the OpenNMS issue tracker?If so, you should:\n\nupdate the title of this PR to be of the format: ${JIRA-ISSUE-NUMBER}: subject of pull request\nupdate the JIRA link at the bottom of this comment to refer to the real issue number\nprefix your commit messages with the issue number, if possible\n\n\n Have you made a comment in that issue which points back to this PR?\n Have you updated the JIRA link at the bottom of this comment to link to your issue?\n If this is a new or updated feature, is there documentation for the new behavior?\n If this is new code, are there unit and/or integration tests?\n If this PR targets a foundation-* branch, does it avoid changing files in $OPENNMS_HOME/etc/?\n\nBuild Minion for AMD64/ARMv7/ARM64 Architecture\nIntroducing multiarchitecture build for our Minion Docker file. We use Docker buildx experimental features to build the OCI file for multiple architectures. To get distribution independent and reduce the OCI image size we install now from the Minion tarball assembly instead of the RPM files. To support multiple architectures, we have to migrate away from CentOS 8 as a base image which supports just AMD64. We use Ubuntu Eoan instead.\nBuilding the container image:\n\n./assemble.pl -Dopennms.home=/opt/opennms -DskipTests\ncd opennms-container/minion && make && make install\nImage is built and loaded into the Docker context\nmake clean-all -> Docker builder is destroyed, tarball in Docker context removed and OCI image deleted\n\nReviewer Hints:\n\nRemoved the OCI build for Minion from the RPM build job\nAdded a tarball assembly build job which runs in parallel to the DEB and RPM build jobs\nImage is published to a registry for master | develop | jira/NMS-12483 for AMD64/ARMv7/ARM64 all other branches just AMD64 as OCI file artifact\nWe drop support to build the Docker image from RPMs locally or from remote repositories.\nThis build does not contain cross-compiled build for JICMP/JICMP6\nWe satisfy requirements to support Windows installer (makensis) with a fake version, so we don't have to install and maintain it on our Ubuntu 16 machine environment.\n\nTodo:\n\n Change registry organisation from temporary to opennms\n Remove jira/NMS-12483 publish from build job\n\nExternal References\n\nJIRA (Issue Tracker): http://issues.opennms.org/browse/NMS-12483", "createdAt": "2020-03-16T13:02:00Z", "url": "https://github.com/OpenNMS/opennms/pull/2919", "merged": true, "mergeCommit": {"oid": "429dc05a800953b545e23131ee7539d5980d394e"}, "closed": true, "closedAt": "2020-03-17T10:41:21Z", "author": {"login": "indigo423"}, "timelineItems": {"totalCount": 49, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcN9BfUAH2gAyMzg5MjIwMzA2OjE4MjUwNTFmMzdmNTM1MTRmNDJmZGE0OWI5NzUwZjJkNDIzNGU4NzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOfwtcgBqjMxMzY2MTk1Nzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1825051f37f53514f42fda49b9750f2d4234e875", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/1825051f37f53514f42fda49b9750f2d4234e875", "committedDate": "2020-03-15T17:32:56Z", "message": "NMS-12483: Remove OCI build from RPM build job"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23ac3c417b882d7e0ce6f06f5735ae4088fe8e8b", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/23ac3c417b882d7e0ce6f06f5735ae4088fe8e8b", "committedDate": "2020-03-15T17:32:56Z", "message": "NMS-12483: Switch Minion OCI build from RPM in DEB build jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630678131db8169c2853d97be5a4984499559b1c", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/630678131db8169c2853d97be5a4984499559b1c", "committedDate": "2020-03-15T17:32:56Z", "message": "NMS-12483: Fetch Minion tarball and store as artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ef1d109350584cab478b82aaa080dcc6b8df5fd", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/4ef1d109350584cab478b82aaa080dcc6b8df5fd", "committedDate": "2020-03-15T17:32:57Z", "message": "NMS-12483: We double gzip the minion.tar.gz, it prevents us using ADD in Dockerfile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47a685b56218c33634c74f768a698a38268454f7", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/47a685b56218c33634c74f768a698a38268454f7", "committedDate": "2020-03-15T17:32:57Z", "message": "NMS-12483: Migrate OCI build for Minion to Ubuntu\n\nMigrated from our CentOS 8 to an Ubuntu base image.  We add Multi-Stage\nsupport to reduce the final image size."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "308ada1b3790bff529968e0600cd4244154ec07c", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/308ada1b3790bff529968e0600cd4244154ec07c", "committedDate": "2020-03-15T17:32:57Z", "message": "NMS-12483: Add OCI build step and persist artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e25a971c3bde4da1b13b5196c6725847d1c1daae", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/e25a971c3bde4da1b13b5196c6725847d1c1daae", "committedDate": "2020-03-15T17:32:57Z", "message": "NMS-12483: Minimal smoke depends now on Minion DEB build job instead of RPM"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57088af0c26b06942177e8db10a349645b058fe2", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/57088af0c26b06942177e8db10a349645b058fe2", "committedDate": "2020-03-15T17:32:58Z", "message": "NMS-12483: Set permissions explicitly, Docker 19+ preserves permissions, everything earlier doesn't"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70a5080eb6ba1afc3c006729d1977d4be81d0182", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/70a5080eb6ba1afc3c006729d1977d4be81d0182", "committedDate": "2020-03-15T17:32:58Z", "message": "NMS-12483: Add a tarball assembly and remove makedeb dependencies which prevents running in a machine on old ubuntu 16"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6646e88caa9fd032d8dd5dd191c02e3a61493363", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/6646e88caa9fd032d8dd5dd191c02e3a61493363", "committedDate": "2020-03-15T17:32:58Z", "message": "NMS-12483: We compile with skip tarball workaround with a another compile run"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8febac0b711f48e6c0c28adefb3415fb593692d0", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/8febac0b711f48e6c0c28adefb3415fb593692d0", "committedDate": "2020-03-15T17:32:58Z", "message": "NMS-12483: Migrate tarball to a machine job which can run the docker buildx features"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ba74114c89597a43430349b4db8e8bad53aa940", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/7ba74114c89597a43430349b4db8e8bad53aa940", "committedDate": "2020-03-15T17:32:59Z", "message": "NMS-12483: Set vcpu for tarball to 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b9640fb18455d787785f6a7a3682c5e2aff6310", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/9b9640fb18455d787785f6a7a3682c5e2aff6310", "committedDate": "2020-03-15T17:32:59Z", "message": "NMS-12483: Enable tarballs in compile job to be able to run the assemble"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8633b22ed708564f4beceb7a14202a78fd36d8cf", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/8633b22ed708564f4beceb7a14202a78fd36d8cf", "committedDate": "2020-03-15T17:32:59Z", "message": "NMS-12483: Add docker build to tarball build step\n\nAdd makensis fake script which is a dependency in our assembly step. We don't need it for Linux based distrubutions.\nSetup a docker buildx and setup the environment to enable multiarch build. The Minion Docker OCI build steps are moved\nfrom the minion-deb-build to the tarball-assembly job."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a62f9d9cc0c173c4ddadb43d778acd84ddd8998", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/1a62f9d9cc0c173c4ddadb43d778acd84ddd8998", "committedDate": "2020-03-15T17:32:59Z", "message": "NMS-12483: Migrate to use docker-buildx instead of docker build"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a20799b154a9549d09d7fda40df6e1eab24f419", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/7a20799b154a9549d09d7fda40df6e1eab24f419", "committedDate": "2020-03-15T17:32:59Z", "message": "NMS-12483: Depend smoke tests on tarball assembly for OCI files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90d035c9d0b94b6ce6facd236904b75b884d921e", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/90d035c9d0b94b6ce6facd236904b75b884d921e", "committedDate": "2020-03-15T17:33:00Z", "message": "NMS-12483: Add docker buildx for releases as multi arch and single OCI\n\nEnhance our bild job to build for master a multi-architecture OCI with a manifest for arm/v7, arm64 and amd64 when we\nmake a release and push it directly to the registry.\n\nTo run same build instruction and remove Bash script complexity, I've migrated the our build scripts to a single\nMakefile. When run make it creates the OCI file as local build for the single x86_64 architecture as OCI file. The\nversion number as docker tag is fetched from the root pom.xml. For a release we create additionally a OCI file for\nx86_64 as artifact file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "928fbbeaaebe1a6a792fc2b191dbaee86a1ad25b", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/928fbbeaaebe1a6a792fc2b191dbaee86a1ad25b", "committedDate": "2020-03-15T17:33:00Z", "message": "NMS-12483: Trigger a build and test publish Minion Multi-arch image to registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "343024d9db94876d9b3b0c8922be0449dbd588cb", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/343024d9db94876d9b3b0c8922be0449dbd588cb", "committedDate": "2020-03-15T17:33:00Z", "message": "NMS-12483: Restore Minion Deb steps and branch filters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f7482d70f2029367280191455e5ada37dbe3998", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/0f7482d70f2029367280191455e5ada37dbe3998", "committedDate": "2020-03-15T17:33:00Z", "message": "NMS-12483: Allow to set a base image in Makefile"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd8659c8418124e369f88c5d7b1527fbbac5960c", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/dd8659c8418124e369f88c5d7b1527fbbac5960c", "committedDate": "2020-03-15T17:33:01Z", "message": "NMS-12483: Load minion.oci instead of generic container.oci file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "530e512ad0de489b534b7743df8b4423aa9482a5", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/530e512ad0de489b534b7743df8b4423aa9482a5", "committedDate": "2020-03-15T17:33:01Z", "message": "NMS-12483: Add circleci build number to artifact OCI file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a09f177996f53925eee12fa3e9e6a2614bb9857c", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/a09f177996f53925eee12fa3e9e6a2614bb9857c", "committedDate": "2020-03-15T17:33:01Z", "message": "NMS-12483: Restore minion-deb-build requirements and set python2 explicitly in makensis fake"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14d1e62b6c6ab6da46a88e5249bda45dbe2c7c2e", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/14d1e62b6c6ab6da46a88e5249bda45dbe2c7c2e", "committedDate": "2020-03-15T17:33:01Z", "message": "NMS-12483: Improve readme and add all make targets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2be880dcee7ec0297d5fa079409c8c4311430b07", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/2be880dcee7ec0297d5fa079409c8c4311430b07", "committedDate": "2020-03-15T17:33:02Z", "message": "NMS-12483: Set defaults for build information"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f13088221176105edd4935b0070a503879700402", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/f13088221176105edd4935b0070a503879700402", "committedDate": "2020-03-15T17:33:02Z", "message": "NMS-12483: Remove Minion publish oci jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3caafa234a61a91b34e94676240fbf7089e9fb96", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/3caafa234a61a91b34e94676240fbf7089e9fb96", "committedDate": "2020-03-15T17:33:02Z", "message": "NMS-12483: Make container-fs consistent for scripts and assets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99ba363749c5a04b7069c46ce0a16325efb2fcc5", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/99ba363749c5a04b7069c46ce0a16325efb2fcc5", "committedDate": "2020-03-15T17:33:02Z", "message": "NMS-12483: Set default container image with SSH client for Karaf health check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eabc6f5d8d7feca252afb02674c0146d250fb8ec", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/eabc6f5d8d7feca252afb02674c0146d250fb8ec", "committedDate": "2020-03-15T17:33:03Z", "message": "NMS-12483: Restore SSH authentication for health check and fix NMS-12600"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "776f793a867d410622666125a92dbd2e2964b392", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/776f793a867d410622666125a92dbd2e2964b392", "committedDate": "2020-03-15T17:33:03Z", "message": "NMS-12483: Set OCI artifact tag to minion:latest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29d98e5ec3cc42f7f004025475d771a4986a1c26", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/29d98e5ec3cc42f7f004025475d771a4986a1c26", "committedDate": "2020-03-15T17:33:03Z", "message": "NMS-12483: Migrate confd configuration from NMS-12578"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ba73c3e648b86994c53490cbfeded0bae6ef95", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/b9ba73c3e648b86994c53490cbfeded0bae6ef95", "committedDate": "2020-03-15T17:33:03Z", "message": "NMS-12483: We drop support installing Minion container from packages like RPMS/DEB and use just tarballs instead."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fb2dfd16369daf9a5e1b5454eaf9bc7fd862c9d", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/6fb2dfd16369daf9a5e1b5454eaf9bc7fd862c9d", "committedDate": "2020-03-15T17:33:04Z", "message": "NMS-12483: Cleanup whitespaces"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a760740133d89159a79dbc34d866b8c3d20b9f", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/31a760740133d89159a79dbc34d866b8c3d20b9f", "committedDate": "2020-03-15T17:33:04Z", "message": "NMS-12483: Move to container-fs directory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "918b767da0bf8694117c25d6a2782459376be78e", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/918b767da0bf8694117c25d6a2782459376be78e", "committedDate": "2020-03-15T17:33:04Z", "message": "NMS-12483: Add a switch case for branches we want to push images to the registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b561a3b3e655a4721dd8b73df75958c40cc2558a", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/b561a3b3e655a4721dd8b73df75958c40cc2558a", "committedDate": "2020-03-15T17:33:05Z", "message": "NMS-12483: Whitespace cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e6bb288c0895718213d0fad0643ad25b56942ea", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/2e6bb288c0895718213d0fad0643ad25b56942ea", "committedDate": "2020-03-15T17:33:05Z", "message": "NMS-12483: Cross fingers - smoke-test-full"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/982ded24b4a1343a6357e20e643d6339a9f509cf", "committedDate": "2020-03-16T12:51:35Z", "message": "NMS-12483: Fetch assembly in Makefile to make it easier to run locally"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MjAzMTA1", "url": "https://github.com/OpenNMS/opennms/pull/2919#pullrequestreview-375203105", "createdAt": "2020-03-16T13:18:00Z", "commit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzoxODowMFrOF2zwJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzoxODowMFrOF2zwJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAxNTMzMg==", "bodyText": "\u26a0\ufe0f Change this to opennms before merge.", "url": "https://github.com/OpenNMS/opennms/pull/2919#discussion_r393015332", "createdAt": "2020-03-16T13:18:00Z", "author": {"login": "indigo423"}, "path": "opennms-container/minion/Makefile", "diffHunk": "@@ -0,0 +1,106 @@\n+## \n+# Makefile to build Minion container image with Docker\n+##\n+.PHONY: help test build install uninstall clean clean-all\n+\n+.DEFAULT_GOAL := build\n+\n+VERSION                 := localbuild\n+SHELL                   := /bin/bash -o nounset -o pipefail -o errexit\n+BUILD_DATE              := $(shell date -u +\"%Y-%m-%dT%H:%M:%SZ\")\n+BASE_IMAGE              := opennms/deploy-base:jre-1.0.0.b31\n+DOCKER_CLI_EXPERIMENTAL := enabled\n+DOCKERX_INSTANCE        := env-minion-oci\n+DOCKER_REGISTRY         := docker.io\n+DOCKER_ORG              := no42org", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MjAzNDkw", "url": "https://github.com/OpenNMS/opennms/pull/2919#pullrequestreview-375203490", "createdAt": "2020-03-16T13:18:29Z", "commit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzoxODoyOVrOF2zxQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxMzoxODoyOVrOF2zxQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzAxNTYxOQ==", "bodyText": "\u26a0\ufe0f Remove this before merge.", "url": "https://github.com/OpenNMS/opennms/pull/2919#discussion_r393015619", "createdAt": "2020-03-16T13:18:29Z", "author": {"login": "indigo423"}, "path": ".circleci/config.yml", "diffHunk": "@@ -437,6 +432,94 @@ jobs:\n     steps:\n       - run-build:\n           number-vcpu: 8\n+\n+  tarball-assembly:\n+    machine:\n+      image: ubuntu-1604:201903-01\n+      docker_layer_caching: true\n+    environment:\n+      DOCKER_CLI_EXPERIMENTAL: enabled\n+    parameters:\n+      number-vcpu:\n+        default: 2\n+        type: integer\n+      vaadin-javamaxmem:\n+        default: 1g\n+        type: string\n+    steps:\n+      - attach_workspace:\n+          at: ~/\n+      - run:\n+          name: multiarch/qemu-user-static\n+          command: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n+      - run:\n+          name: Install Docker buildx\n+          command: |\n+            sudo wget https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64 -O /usr/local/bin/docker-buildx\n+            sudo chmod a+x /usr/local/bin/docker-buildx\n+            sudo systemctl restart docker\n+      - dockerhub-login\n+      - run:\n+          name: Assemble tarballs\n+          # Install fake makensis to satisfy the assemble dependency\n+          command: |\n+            sudo cp .circleci/scripts/makensis.py /usr/local/bin/makensis\n+            ./assemble.pl -Dopennms.home=/opt/opennms \\\n+                          -DskipTests \\\n+                          -DupdatePolicy=never\n+      - run:\n+          name: Collect tarball artifacts\n+          command: |\n+            mkdir target/tarballs\n+            find ./target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/opennms.tar.gz \\;\n+            find ./opennms-assemblies/minion/target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/minion.tar.gz \\;\n+            find ./opennms-assemblies/sentinel/target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/sentinel.tar.gz \\;\n+      - run:\n+          name: Build Minion OCI\n+          command: |\n+            cd opennms-container/minion\n+            make DOCKER_TAG=\"minion:latest\" BUILD_NUMBER=\"${CIRCLE_BUILD_NUM}\" BUILD_URL=\"${CIRCLE_BUILD_URL}\" BUILD_BRANCH=\"${CIRCLE_BRANCH}\"\n+            case \"${CIRCLE_BRANCH}\" in\n+              master)\n+                make DOCKER_ARCH=\"linux/amd64,linux/arm/v7,linux/arm64\" \\\n+                     DOCKER_FLAGS=--push \\\n+                     VERSION=\"$(../pom2version.py ../../pom.xml)\" \\\n+                     BUILD_NUMBER=\"${CIRCLE_BUILD_NUM}\" \\\n+                     BUILD_URL=\"${CIRCLE_BUILD_URL}\" \\\n+                     BUILD_BRANCH=\"${CIRCLE_BRANCH}\"\n+                ;;\n+              develop)\n+                make DOCKER_ARCH=\"linux/amd64,linux/arm/v7,linux/arm64\" \\\n+                     DOCKER_FLAGS=--push \\\n+                     VERSION=\"$(../pom2version.py ../../pom.xml)\" \\\n+                     BUILD_NUMBER=\"${CIRCLE_BUILD_NUM}\" \\\n+                     BUILD_URL=\"${CIRCLE_BUILD_URL}\" \\\n+                     BUILD_BRANCH=\"${CIRCLE_BRANCH}\"\n+                ;;\n+              jira/NMS-12483)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "originalPosition": 140}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MjQzNDgw", "url": "https://github.com/OpenNMS/opennms/pull/2919#pullrequestreview-375243480", "createdAt": "2020-03-16T14:06:25Z", "commit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDowNjoyNVrOF21p6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNDowNjoyNVrOF21p6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzA0NjUwNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                          master)\n          \n          \n            \n                          \"master\" | \"develop\")\n          \n      \n    \n    \n  \n\nIt looks like the code blocks here are the same. We can de-duplicate them with an OR for the case statement?", "url": "https://github.com/OpenNMS/opennms/pull/2919#discussion_r393046507", "createdAt": "2020-03-16T14:06:25Z", "author": {"login": "j-white"}, "path": ".circleci/config.yml", "diffHunk": "@@ -437,6 +432,94 @@ jobs:\n     steps:\n       - run-build:\n           number-vcpu: 8\n+\n+  tarball-assembly:\n+    machine:\n+      image: ubuntu-1604:201903-01\n+      docker_layer_caching: true\n+    environment:\n+      DOCKER_CLI_EXPERIMENTAL: enabled\n+    parameters:\n+      number-vcpu:\n+        default: 2\n+        type: integer\n+      vaadin-javamaxmem:\n+        default: 1g\n+        type: string\n+    steps:\n+      - attach_workspace:\n+          at: ~/\n+      - run:\n+          name: multiarch/qemu-user-static\n+          command: docker run --rm --privileged multiarch/qemu-user-static --reset -p yes\n+      - run:\n+          name: Install Docker buildx\n+          command: |\n+            sudo wget https://github.com/docker/buildx/releases/download/v0.3.1/buildx-v0.3.1.linux-amd64 -O /usr/local/bin/docker-buildx\n+            sudo chmod a+x /usr/local/bin/docker-buildx\n+            sudo systemctl restart docker\n+      - dockerhub-login\n+      - run:\n+          name: Assemble tarballs\n+          # Install fake makensis to satisfy the assemble dependency\n+          command: |\n+            sudo cp .circleci/scripts/makensis.py /usr/local/bin/makensis\n+            ./assemble.pl -Dopennms.home=/opt/opennms \\\n+                          -DskipTests \\\n+                          -DupdatePolicy=never\n+      - run:\n+          name: Collect tarball artifacts\n+          command: |\n+            mkdir target/tarballs\n+            find ./target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/opennms.tar.gz \\;\n+            find ./opennms-assemblies/minion/target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/minion.tar.gz \\;\n+            find ./opennms-assemblies/sentinel/target -name \"*.tar.gz\" -type f -not -iname '*source*' -exec cp {} ./target/tarballs/sentinel.tar.gz \\;\n+      - run:\n+          name: Build Minion OCI\n+          command: |\n+            cd opennms-container/minion\n+            make DOCKER_TAG=\"minion:latest\" BUILD_NUMBER=\"${CIRCLE_BUILD_NUM}\" BUILD_URL=\"${CIRCLE_BUILD_URL}\" BUILD_BRANCH=\"${CIRCLE_BRANCH}\"\n+            case \"${CIRCLE_BRANCH}\" in\n+              master)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc1MzcyMjc5", "url": "https://github.com/OpenNMS/opennms/pull/2919#pullrequestreview-375372279", "createdAt": "2020-03-16T16:18:23Z", "commit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxODoyNFrOF27qgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNlQxNjoxODoyNFrOF27qgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzE0NDk2Mg==", "bodyText": "Do we need line 45 given line 38?", "url": "https://github.com/OpenNMS/opennms/pull/2919#discussion_r393144962", "createdAt": "2020-03-16T16:18:24Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/Dockerfile", "diffHunk": "@@ -1,88 +1,64 @@\n ##\n-# Use Java base image and setup required RPMS as cacheable image.\n+# Pre-stage image to extract and manipulate Minion directory structure\n+# Normally we install to /opt/minion and not /opt/minion-26.0.0-SNAPSHOT\n+# To avoid issues, we rearrange the directories in pre-stage to avoid injecting these\n+# as addtional layers into the final image.\n ##\n-ARG BASE_IMAGE=\"opennms/openjdk\"\n-ARG BASE_IMAGE_VERSION=\"11.0.5.10-b3108\"\n+ARG BASE_IMAGE=\"opennms/deploy-base:jre-1.0.0.b31\"\n \n-FROM ${BASE_IMAGE}:${BASE_IMAGE_VERSION} as minion-base\n+FROM ${BASE_IMAGE} as minion-base\n \n-ARG REQUIRED_RPMS=\"wget gettext jicmp jicmp6 openssh-clients\"\n+ADD ./tarball/minion.tar.gz /opt/\n \n-ARG REPO_KEY_URL=\"https://yum.opennms.org/OPENNMS-GPG-KEY\"\n-ARG REPO_RPM=\"https://yum.opennms.org/repofiles/opennms-repo-stable-rhel8.noarch.rpm\"\n+# Organize files based on the build home dir /opt/minion\n+RUN mv /opt/minion-* /opt/minion\n \n-SHELL [\"/bin/bash\", \"-c\"]\n-\n-# Collect generic steps in a layer for caching\n-RUN rpm --import \"${REPO_KEY_URL}\" && \\\n-    dnf -y install epel-release && \\\n-    dnf -y install \"${REPO_RPM}\" && \\\n-    dnf -y install ${REQUIRED_RPMS} && \\\n-    dnf clean all && \\\n-    rm -rf /var/cache/yum\n-\n-# Allow to send ICMP messages as non-root user\n-RUN setcap cap_net_raw+ep ${JAVA_HOME}/bin/java && \\\n-    echo ${JAVA_HOME}/lib/jli > /etc/ld.so.conf.d/java-latest.conf && \\\n-    ldconfig\n-\n-# Create Minion user with a specific group ID\n-RUN groupadd -g 10001 minion && \\\n-    adduser -u 10001 -g 10001 -d /opt/minion -s /usr/bin/bash minion\n-\n-# Create SSH Key-Pair to use with the Karaf Shell\n-RUN mkdir /opt/minion/.ssh && \\\n-    chmod 700 /opt/minion/.ssh && \\\n-    ssh-keygen -t rsa -f /opt/minion/.ssh/id_rsa -q -N \"\"\n+# We set the correct permissions in this stage, so we don't have this as an addtional\n+# layer in our deploy image.\n+RUN groupadd --gid 10001 minion && \\\n+    useradd --system --uid 10001 --gid minion minion --home-dir /opt/minion && \\\n+    chown 10001 /opt/minion -R && \\\n+    chgrp -R 0 /opt/minion && \\\n+    chmod -R g=u /opt/minion\n \n ##\n-# Install and setup OpenNMS Minion RPMS\n+# Prod image with minimal image size\n ##\n-FROM minion-base\n+FROM ${BASE_IMAGE}\n \n-ARG USER=\"minion\"\n+# Create user to be able to run as non root with a known user and group id.\n+RUN groupadd --gid 10001 minion && \\\n+    useradd --system --uid 10001 --gid minion minion --home-dir /opt/minion\n \n-# A default which installs the minimum required Minion packages\n-ARG MINION_PACKAGES=\"opennms-minion\"\n+# Install entrypoint wrapper and health check script\n+COPY container-fs/entrypoint.sh /\n+COPY container-fs/health.sh /\n \n-# Allow to install optional packages via YUM\n-ARG ADD_YUM_PACKAGES\n+# Install confd configuration\n+COPY ./container-fs/confd/ /opt/minion/confd/\n \n-COPY ./rpms /tmp/rpms\n+# If you copy from /opt/minion to /opt/minion the permissions are not preserved\n+# We would have 755 for minion:root instead of 775 and prevents writing lock files in /opt/minion\n+COPY --chown=10001:0 --from=minion-base /opt /opt\n \n-SHELL [\"/bin/bash\", \"-c\"]\n+# Install confd.io configuration files and scripts and ensure they are executable\n+COPY ./container-fs/confd/ /opt/minion/confd/", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "982ded24b4a1343a6357e20e643d6339a9f509cf"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1216991649045b89eebe5999deac6e9535ff60", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/cf1216991649045b89eebe5999deac6e9535ff60", "committedDate": "2020-03-16T18:01:41Z", "message": "NMS-12483: Fix duplicate line from resolving a merge conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dcefb849b710f37b9c16ae39d6972bb90f19f69", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/2dcefb849b710f37b9c16ae39d6972bb90f19f69", "committedDate": "2020-03-17T06:21:04Z", "message": "NMS-12483: Remove test push registry organisation\n\nRemove filter for push this branch to the registry. Set target organisation to opennms on DockerHub. The branch filter\nfor mvr branches are removed as well.\n\n[ci skip]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44e809911b036465bf137b2d10e94a9ff12c6fa1", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/44e809911b036465bf137b2d10e94a9ff12c6fa1", "committedDate": "2020-03-17T06:35:15Z", "message": "NMS-12483: Remove duplicated code for master and develop branch\n\n[ci skip]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cd81c6b48758b262889a239caa653df514c0d1d", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/1cd81c6b48758b262889a239caa653df514c0d1d", "committedDate": "2020-03-17T06:56:31Z", "message": "NMS-12483: Add comments in branch logic and add the version number into the build artifact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "617e96442a576a4465036ea00a73453885cece11", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/617e96442a576a4465036ea00a73453885cece11", "committedDate": "2020-03-17T07:13:50Z", "message": "NMS-12483: Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5223557103e90abe27490a2f19f7d9675053435", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/e5223557103e90abe27490a2f19f7d9675053435", "committedDate": "2020-03-17T09:12:22Z", "message": "NMS-12483: Update base image to use a architecture independent JAVA_HOME\n\n[ci skip]"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5fa7f680a9fb66d644cd2cfc34e9443a61d70a97", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/5fa7f680a9fb66d644cd2cfc34e9443a61d70a97", "committedDate": "2020-03-17T08:32:53Z", "message": "NMS-12483: Update base image to use a version independent JAVA_HOME"}, "afterCommit": {"oid": "e5223557103e90abe27490a2f19f7d9675053435", "author": {"user": {"login": "indigo423", "name": "Ronny Trommer"}}, "url": "https://github.com/OpenNMS/opennms/commit/e5223557103e90abe27490a2f19f7d9675053435", "committedDate": "2020-03-17T09:12:22Z", "message": "NMS-12483: Update base image to use a architecture independent JAVA_HOME\n\n[ci skip]"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3795, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}