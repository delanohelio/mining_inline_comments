{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODk4MTI3", "number": 3006, "title": "NMS-12679: Update database and send events only on changes", "bodyText": "JIRA: https://issues.opennms.org/browse/NMS-12679", "createdAt": "2020-05-12T18:32:26Z", "url": "https://github.com/OpenNMS/opennms/pull/3006", "merged": true, "mergeCommit": {"oid": "9813fef256fade7a7a14cb35b7ecfd36a9433530"}, "closed": true, "closedAt": "2020-05-20T05:51:10Z", "author": {"login": "christianpape"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgomYXgH2gAyNDE2ODk4MTI3OjEzMzFjNjdjNmFmYjFiNTE1NGM5ZjE0ZGViNzA3ODU3Mzc0OWZkMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci7brIAFqTQxNDg0MDExNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/1331c67c6afb1b5154c9f14deb7078573749fd17", "committedDate": "2020-05-12T18:29:47Z", "message": "NMS-12679: Update database and send events only on changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzODY1OTUx", "url": "https://github.com/OpenNMS/opennms/pull/3006#pullrequestreview-413865951", "createdAt": "2020-05-18T19:08:40Z", "commit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowODo0MFrOGXEFZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjowMVrOGXEMAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzNzM0OA==", "bodyText": "Should we update if the reason changes?", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426837348", "createdAt": "2020-05-18T19:08:40Z", "author": {"login": "fooker"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());\n \n-        this.locationSpecificStatusDao.saveStatusChange(status);\n+        if (oldLocationSpecificStatus == null || oldLocationSpecificStatus.getPollResult().getStatusCode() != pollResult.getStatusCode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODA1MQ==", "bodyText": "The whole select/update cycle should run in a single transaction", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426838051", "createdAt": "2020-05-18T19:10:05Z", "author": {"login": "fooker"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0MQ==", "bodyText": "Not sure if...", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426839041", "createdAt": "2020-05-18T19:12:01Z", "author": {"login": "fooker"}, "path": "opennms-base-assembly/src/main/filtered/etc/create.sql", "diffHunk": "@@ -343,7 +343,7 @@ CREATE TABLE scanreports (\n     CONSTRAINT scanreports_monitoringlocations_fkey FOREIGN KEY (location) REFERENCES monitoringlocations (id) ON DELETE CASCADE ON UPDATE CASCADE\n );\n \n-CREATE UNIQUE INDEX scanreports_id_idx on scanreport(id);\n+CREATE UNIQUE INDEX scanreports_id_idx on scanreports(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef4097aa60a8455ae1698c8a66198aa005a43f7f", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/ef4097aa60a8455ae1698c8a66198aa005a43f7f", "committedDate": "2020-05-19T06:30:32Z", "message": "NMS-12679: Review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODQwMTE3", "url": "https://github.com/OpenNMS/opennms/pull/3006#pullrequestreview-414840117", "createdAt": "2020-05-19T21:34:08Z", "commit": {"oid": "ef4097aa60a8455ae1698c8a66198aa005a43f7f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3645, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}