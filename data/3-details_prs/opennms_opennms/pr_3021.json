{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMzkzMzMx", "number": 3021, "title": "NMS-12678: added RemotePollerd configuration reloading", "bodyText": "JIRA: https://issues.opennms.org/browse/NMS-12678", "createdAt": "2020-05-26T18:57:45Z", "url": "https://github.com/OpenNMS/opennms/pull/3021", "merged": true, "mergeCommit": {"oid": "0f2ac3d3aa7a75f32c365e8ec7158e33646cfb66"}, "closed": true, "closedAt": "2020-06-02T18:10:16Z", "author": {"login": "christianpape"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclJOzuAH2gAyNDIzMzkzMzMxOjcyMThmNmJlMDNhMjMzYzc0MmRjNDVjOTcyZWMwYjQ0MjkwNGUyZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnYMyWgFqTQyMjg5NDg4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7218f6be03a233c742dc45c972ec0b442904e2f7", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/7218f6be03a233c742dc45c972ec0b442904e2f7", "committedDate": "2020-05-26T18:46:36Z", "message": "NMS-12678: added RemotePollerd configuration reloading"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyNzI2OTMz", "url": "https://github.com/OpenNMS/opennms/pull/3021#pullrequestreview-422726933", "createdAt": "2020-06-02T14:18:32Z", "commit": {"oid": "7218f6be03a233c742dc45c972ec0b442904e2f7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDoxODozMlrOGdz-pA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMlQxNDoxODozMlrOGdz-pA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzkxMzUwOA==", "bodyText": "This is basically a duplicate of the code in {{scheduleAllServices}}. Can we deduplicate this?", "url": "https://github.com/OpenNMS/opennms/pull/3021#discussion_r433913508", "createdAt": "2020-06-02T14:18:32Z", "author": {"login": "fooker"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -196,6 +199,88 @@ public void scheduleAllServices() {\n         });\n     }\n \n+    private Map<JobKey, RemotePolledService> getMapOfScheduledServices(final String locationName) {\n+        final Map<JobKey, RemotePolledService> mapOfScheduledServices = new TreeMap<>();\n+        try {\n+            for(final JobKey jobKey : scheduler.getJobKeys(GroupMatcher.jobGroupEquals(locationName))) {\n+                try {\n+                    final JobDetail jobDetail = scheduler.getJobDetail(jobKey);\n+\n+                    if (locationName.equals(jobDetail.getJobDataMap().get(RemotePollJob.LOCATION_NAME)) &&\n+                        jobDetail.getJobDataMap().get(RemotePollJob.REMOTE_POLLER_BACKEND) == this) {\n+                        mapOfScheduledServices.put(jobKey, (RemotePolledService) jobDetail.getJobDataMap().get(RemotePollJob.POLLED_SERVICE));\n+                    }\n+                } catch (SchedulerException e) {\n+                    LOG.warn(\"Failed to retrieve job details {}.\", jobKey, e);\n+                }\n+            }\n+        } catch (SchedulerException e) {\n+            LOG.warn(\"Failed to query scheduled jobs.\", e);\n+        }\n+\n+        return mapOfScheduledServices;\n+    }\n+\n+    public void handleConfigurationChanged() {\n+        final Map<String, List<RemotePolledService>> servicesByPackage = new HashMap<>();\n+\n+        try {\n+            this.pollerConfig.update();\n+        } catch (IOException e) {\n+            LOG.warn(\"Error reloading poller-configuration.xml\");\n+        }\n+\n+        LOG.info(\"Re-scheduling all services...\");\n+        sessionUtils.withReadOnlyTransaction(() -> {\n+            for (final OnmsMonitoringLocation loc : monitoringLocationDao.findAll()) {\n+                final List<String> pollingPackageNames = loc.getPollingPackageNames();\n+                LOG.debug(\"Location '{}' has polling packages: {}\", loc.getLocationName(), pollingPackageNames);\n+\n+                final Set<RemotePolledService> servicesToBeScheduled = new HashSet<>();\n+\n+                for (final String pollingPackageName : pollingPackageNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7218f6be03a233c742dc45c972ec0b442904e2f7"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1314195694278788dbe0863e696e490748edf62", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/c1314195694278788dbe0863e696e490748edf62", "committedDate": "2020-06-02T15:00:39Z", "message": "NMS-12678: Review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyODk0ODgx", "url": "https://github.com/OpenNMS/opennms/pull/3021#pullrequestreview-422894881", "createdAt": "2020-06-02T17:20:49Z", "commit": {"oid": "c1314195694278788dbe0863e696e490748edf62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3658, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}