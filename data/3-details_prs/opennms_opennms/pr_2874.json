{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDUwMTc0", "number": 2874, "title": "NMS-12479: Remove module name from Kafka RPC topic names.", "bodyText": "By moving module name to proto from the topic names, we can save the number of topics by order of number of RPC modules.\nRemove the need for module name in topic names.\nInclude topic name in proto message.\nupgrade kafka-rpc.proto to proto3.\nUse kafka specific topic name generation.\nExternal References\n\nJIRA (Issue Tracker): http://issues.opennms.org/browse/NMS-12479\nBamboo (Continuous Integration): https://bamboo.opennms.org/", "createdAt": "2020-01-21T00:52:13Z", "url": "https://github.com/OpenNMS/opennms/pull/2874", "merged": true, "mergeCommit": {"oid": "818f52080a2fb2d3431fb98bf65bb49ee045650e"}, "closed": true, "closedAt": "2020-02-06T16:42:14Z", "author": {"login": "cgorantla"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8WPqKAH2gAyMzY1MDUwMTc0OmJiYTNmNzQxOWI1OWY1OTE1NzFhMTA2MmJiMDAyMmJhYTlmZDQ3ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBtf3-gH2gAyMzY1MDUwMTc0OjY0ZmViNWM1MzNjZTI4ZDI2NTdiMGI4MmM3MGJjYjQyOGYyZGUwZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bba3f7419b59f591571a1062bb0022baa9fd47fb", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/bba3f7419b59f591571a1062bb0022baa9fd47fb", "committedDate": "2020-01-21T00:45:24Z", "message": "NMS-12479: Remove module from kafka rpc topics\n\nRemove the need for module name in topic names.\nInclude topic name in proto message.\nAlso upgrade kafka-rpc.proto to proto3.\nRe-generate proto source files.\nUse kafka specific topic name generation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "633ff4eff487b7c25042cc7e9ae689d12b306ccd", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/633ff4eff487b7c25042cc7e9ae689d12b306ccd", "committedDate": "2020-01-21T00:48:18Z", "message": "Merge branch 'develop' into jira/NMS-12479"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36288cf055b079ce690b6819f3694acf9c92e076", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/36288cf055b079ce690b6819f3694acf9c92e076", "committedDate": "2020-01-21T14:31:06Z", "message": "NMS-12479: Handle unmarshalling and execution in separate thread\n\nAs all the requests are handled with one consumer thread, unmarshalling\nand execution are handled in a separate thread.\nNote that execution may still happen in completely different thread."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTc0MzEw", "url": "https://github.com/OpenNMS/opennms/pull/2874#pullrequestreview-346174310", "createdAt": "2020-01-21T20:37:00Z", "commit": {"oid": "36288cf055b079ce690b6819f3694acf9c92e076"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDozNzowMFrOFgIAbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDozNzowMFrOFgIAbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyOTkzNQ==", "bodyText": "This is a problem - if a Minion doesn't have a module loaded it still consumes the relevant requests and drops them silently.", "url": "https://github.com/OpenNMS/opennms/pull/2874#discussion_r369229935", "createdAt": "2020-01-21T20:37:00Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -258,40 +256,24 @@ public void run() {\n                             if (rpcMessage.getTotalChunks() > 1) {\n                                 // Handle multiple chunks\n                                 boolean allChunksReceived = handleChunks(rpcMessage);\n-                                if(!allChunksReceived) {\n+                                if (!allChunksReceived) {\n                                     continue;\n                                 }\n                                 rpcContent = messageCache.get(rpcId);\n                                 //Remove rpcId from cache.\n                                 messageCache.remove(rpcId);\n                                 currentChunkCache.remove(rpcId);\n                             }\n-                            //Build child span from rpcMessage and start minion span.\n-                            Tracer.SpanBuilder spanBuilder = buildSpanFromRpcMessage(rpcMessage);\n-                            Span minionSpan = spanBuilder.start();\n-\n-                            RpcRequest request = module.unmarshalRequest(rpcContent.toStringUtf8());\n-                            setTagsOnMinion(rpcMessage, request, minionSpan);\n-\n-                            CompletableFuture<RpcResponse> future = module.execute(request);\n-                            future.whenComplete((res, ex) -> {\n-                                final RpcResponse response;\n-                                if (ex != null) {\n-                                    // An exception occurred, store the exception in a new response\n-                                    LOG.warn(\"An error occured while executing a call in {}.\", module.getId(), ex);\n-                                    response = module.createResponseWithException(ex);\n-                                    minionSpan.log(ex.getMessage());\n-                                    minionSpan.setTag(TAG_RPC_FAILED, \"true\");\n-                                } else {\n-                                    // No exception occurred, use the given response\n-                                    response = res;\n-                                }\n-                                // Finish minion Span\n-                                minionSpan.finish();\n-                                sendResponse(rpcId, response);\n-                            });\n+                            final RpcModule module = modulesById.get(rpcMessage.getModuleId());\n+                            if(module == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36288cf055b079ce690b6819f3694acf9c92e076"}, "originalPosition": 207}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6793a4faa7163da820c5835530cf45c4d391a7ee", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/6793a4faa7163da820c5835530cf45c4d391a7ee", "committedDate": "2020-01-22T21:16:44Z", "message": "NMS-12479: Move subscribe before looping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8f8744227f65d804ba269516608af60b2fe3f19", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/b8f8744227f65d804ba269516608af60b2fe3f19", "committedDate": "2020-01-24T22:44:09Z", "message": "NMS-12479: Make it configurable to use single topic for all modules\n\nBy default, each module has it's own topic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6d22c20f4046c602bef0794e26a73015498f463", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/f6d22c20f4046c602bef0794e26a73015498f463", "committedDate": "2020-01-29T00:44:39Z", "message": "NMS-12479: Use one consumer on OpenNMS as before"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9758cc4c1b2b4f799b044833f0d8dc350f0c84c5", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/9758cc4c1b2b4f799b044833f0d8dc350f0c84c5", "committedDate": "2020-01-29T00:53:19Z", "message": "Merge branch 'develop' into jira/NMS-12479"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0MDQ2NDAz", "url": "https://github.com/OpenNMS/opennms/pull/2874#pullrequestreview-354046403", "createdAt": "2020-02-05T21:17:43Z", "commit": {"oid": "9758cc4c1b2b4f799b044833f0d8dc350f0c84c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64feb5c533ce28d2657b0b82c70bcb428f2de0df", "author": {"user": {"login": "Bonrob2", "name": null}}, "url": "https://github.com/OpenNMS/opennms/commit/64feb5c533ce28d2657b0b82c70bcb428f2de0df", "committedDate": "2020-02-06T16:40:33Z", "message": "Review of Using Single Topic documentation (#2881)"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3723, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}