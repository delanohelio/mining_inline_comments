{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2NDI1ODA4", "number": 3005, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDoyNjoxNFrOD9aw4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowODo1OVrOD-u9nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzI4MjI1OnYy", "diffSide": "RIGHT", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDoyNjoxNFrOGW5oWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNToxNzowMlrOGW73uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA==", "bodyText": "Can you elaborate on why we still need to process the request?\nIf we continue processing the request there may still be >maxConcurrentCalls active.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426666074", "createdAt": "2020-05-18T14:26:14Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -287,8 +301,12 @@ public void run() {\n                             }\n                             // Should have complete message by this point.\n                             final ByteString requestMessage = rpcContent;\n+                            // Incoming RPC requests are gated to restrict number of threads used by Kafka RPC.\n+                            // Need to process the requests after timeout even though permission acquisition fails.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY4MDk0Mg==", "bodyText": "I'm thinking this as gradual increase of threads instead of a burst that could cause issues with too many threads.  As per current defaults,  only 10 extra threads will be allowed per sec after a threshold of maxConcurrentCalls.   Currently burst only happens with Provisiond and this allows it to not to have a burst of requests within few secs.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426680942", "createdAt": "2020-05-18T14:47:10Z", "author": {"login": "cgorantla"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -287,8 +301,12 @@ public void run() {\n                             }\n                             // Should have complete message by this point.\n                             final ByteString requestMessage = rpcContent;\n+                            // Incoming RPC requests are gated to restrict number of threads used by Kafka RPC.\n+                            // Need to process the requests after timeout even though permission acquisition fails.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA=="}, "originalCommit": {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjcwMjc3OQ==", "bodyText": "Makes sense - this will slow down and put back-pressure on the topic for bursts.\nLet's also make sure to expose a Gauge for the actual number of threads active - since this may differ from the number of active calls being tracked by the bulkhead.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426702779", "createdAt": "2020-05-18T15:17:02Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -287,8 +301,12 @@ public void run() {\n                             }\n                             // Should have complete message by this point.\n                             final ByteString requestMessage = rpcContent;\n+                            // Incoming RPC requests are gated to restrict number of threads used by Kafka RPC.\n+                            // Need to process the requests after timeout even though permission acquisition fails.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NjA3NA=="}, "originalCommit": {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzI4OTUxOnYy", "diffSide": "RIGHT", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDoyNzo0NlrOGW5svg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNDoyNzo0NlrOGW5svg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY2NzE5OA==", "bodyText": "Let's expose the bulk head metrics like we've done here: https://github.com/OpenNMS/opennms/blob/develop/features/dnsresolver/netty/src/main/java/org/opennms/netmgt/dnsresolver/netty/NettyDnsResolver.java#L126", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426667198", "createdAt": "2020-05-18T14:27:46Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -162,6 +171,11 @@ public void init() throws IOException {\n         });\n         tracerRegistry.init(minionIdentity.getLocation() + \"@\" + minionIdentity.getId());\n \n+        BulkheadConfig bulkheadConfig = BulkheadConfig.custom()\n+                .maxConcurrentCalls(maxConcurrentCalls)\n+                .maxWaitDuration(java.time.Duration.ofMillis(maxWaitDuration))\n+                .build();\n+        bulkhead = Bulkhead.of(\"ipc-rpc-kafka\", bulkheadConfig);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1NzQ5MTQzOnYy", "diffSide": "RIGHT", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNToxMzowM1rOGW7slg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxNToxMzowM1rOGW7slg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjY5OTkyNg==", "bodyText": "This should only be called if tryAcquirePermission returned true.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r426699926", "createdAt": "2020-05-18T15:13:03Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -329,10 +347,12 @@ private void handleRequest(RpcMessageProto rpcRequestProto, ByteString rpcConten\n                 }\n                 // Finish minion Span\n                 minionSpan.finish();\n+                bulkhead.onComplete();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d5e8c08b5f0e97b0164b9d250d7ddb982584db3"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MzE1NjU4OnYy", "diffSide": "RIGHT", "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyNjoyOFrOGXzPHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyNjoyOFrOGXzPHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYwOTg4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Currently max number of concurrent requests is set to 1000 with maximum wait time of 100ms.\n          \n          \n            \n            Currently the maximum number of concurrent requests is set to 1,000 with a maximum wait time of 100ms.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r427609887", "createdAt": "2020-05-19T21:26:28Z", "author": {"login": "Bonrob2"}, "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "diffHunk": "@@ -0,0 +1,20 @@\n+// Allow GitHub image rendering\n+:imagesdir: ../../images\n+\n+===  Tuning Kafka RPC on Minion\n+\n+To avoid too many requests hogging the system at once, Kafka RPC on Minion limits the maximum number of concurrent RPC requests.\n+Currently max number of concurrent requests is set to 1000 with maximum wait time of 100ms.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84fbf2b9be12c54344280f30b127eb9d459da904"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MzE2MjM2OnYy", "diffSide": "RIGHT", "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyODowNFrOGXzSeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyODowNFrOGXzSeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMDc0NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            With these settings when concurrent requests reach 1000, it only allow 10 extra requests per sec.\n          \n          \n            \n            With these settings, when concurrent requests reach 1000, Kafka RPC will allow only 10 extra requests per second.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r427610745", "createdAt": "2020-05-19T21:28:04Z", "author": {"login": "Bonrob2"}, "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "diffHunk": "@@ -0,0 +1,20 @@\n+// Allow GitHub image rendering\n+:imagesdir: ../../images\n+\n+===  Tuning Kafka RPC on Minion\n+\n+To avoid too many requests hogging the system at once, Kafka RPC on Minion limits the maximum number of concurrent RPC requests.\n+Currently max number of concurrent requests is set to 1000 with maximum wait time of 100ms.\n+With these settings when concurrent requests reach 1000, it only allow 10 extra requests per sec.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84fbf2b9be12c54344280f30b127eb9d459da904"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2MzE2MzQzOnYy", "diffSide": "RIGHT", "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyODoyNlrOGXzTHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMToyODoyNlrOGXzTHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzYxMDkwOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            These settings can be tuned as below\n          \n          \n            \n            Tune these settings as below:", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r427610909", "createdAt": "2020-05-19T21:28:26Z", "author": {"login": "Bonrob2"}, "path": "opennms-doc/guide-admin/src/asciidoc/text/minion/kafka-rpc.adoc", "diffHunk": "@@ -0,0 +1,20 @@\n+// Allow GitHub image rendering\n+:imagesdir: ../../images\n+\n+===  Tuning Kafka RPC on Minion\n+\n+To avoid too many requests hogging the system at once, Kafka RPC on Minion limits the maximum number of concurrent RPC requests.\n+Currently max number of concurrent requests is set to 1000 with maximum wait time of 100ms.\n+With these settings when concurrent requests reach 1000, it only allow 10 extra requests per sec.\n+\n+These settings can be tuned as below", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84fbf2b9be12c54344280f30b127eb9d459da904"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTA3NzQxOnYy", "diffSide": "RIGHT", "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowODo1OVrOGZBIkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDoxODoyMVrOGZBarQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NjE2MA==", "bodyText": "We can omit location here since all the requests will be for the same location right?", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r428886160", "createdAt": "2020-05-21T20:08:59Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -315,6 +368,8 @@ private void handleRequest(RpcMessageProto rpcRequestProto, ByteString rpcConten\n             setTagsOnMinion(rpcRequestProto, request, minionSpan);\n             // Modules may run the execution in their own thread pool.\n             CompletableFuture<RpcResponse> future = module.execute(request);\n+            final Meter requestSentMeter = getMetrics().meter(MetricRegistry.name(request.getLocation(), module.getId(), RPC_COUNT));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e790a9af27be8feda182b62d6be5137c7f9a2b3"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg5MDc5Nw==", "bodyText": "Maybe we should rename to requestsReceived? From this perspective we're processing the received request.", "url": "https://github.com/OpenNMS/opennms/pull/3005#discussion_r428890797", "createdAt": "2020-05-21T20:18:21Z", "author": {"login": "j-white"}, "path": "core/ipc/rpc/kafka/src/main/java/org/opennms/core/ipc/rpc/kafka/KafkaRpcServerManager.java", "diffHunk": "@@ -315,6 +368,8 @@ private void handleRequest(RpcMessageProto rpcRequestProto, ByteString rpcConten\n             setTagsOnMinion(rpcRequestProto, request, minionSpan);\n             // Modules may run the execution in their own thread pool.\n             CompletableFuture<RpcResponse> future = module.execute(request);\n+            final Meter requestSentMeter = getMetrics().meter(MetricRegistry.name(request.getLocation(), module.getId(), RPC_COUNT));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NjE2MA=="}, "originalCommit": {"oid": "5e790a9af27be8feda182b62d6be5137c7f9a2b3"}, "originalPosition": 170}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 659, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}