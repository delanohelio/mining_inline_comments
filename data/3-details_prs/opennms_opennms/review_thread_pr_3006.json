{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODk4MTI3", "number": 3006, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowODo0MFrOD9hPoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjowMFrOD9hTtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM0NDAwOnYy", "diffSide": "RIGHT", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOTowODo0MFrOGXEFZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjozMDo0N1rOGXRoQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzNzM0OA==", "bodyText": "Should we update if the reason changes?", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426837348", "createdAt": "2020-05-18T19:08:40Z", "author": {"login": "fooker"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());\n \n-        this.locationSpecificStatusDao.saveStatusChange(status);\n+        if (oldLocationSpecificStatus == null || oldLocationSpecificStatus.getPollResult().getStatusCode() != pollResult.getStatusCode()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1OTI2NQ==", "bodyText": "done.", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r427059265", "createdAt": "2020-05-19T06:30:47Z", "author": {"login": "christianpape"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());\n \n-        this.locationSpecificStatusDao.saveStatusChange(status);\n+        if (oldLocationSpecificStatus == null || oldLocationSpecificStatus.getPollResult().getStatusCode() != pollResult.getStatusCode()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzNzM0OA=="}, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM0ODMyOnYy", "diffSide": "RIGHT", "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMDowNVrOGXEIIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjozMDo1OVrOGXRojw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODA1MQ==", "bodyText": "The whole select/update cycle should run in a single transaction", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426838051", "createdAt": "2020-05-18T19:10:05Z", "author": {"login": "fooker"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1OTM0Mw==", "bodyText": "done.", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r427059343", "createdAt": "2020-05-19T06:30:59Z", "author": {"login": "christianpape"}, "path": "features/remotepollerng/daemon/src/main/java/org/opennms/netmgt/remotepollerng/RemotePollerd.java", "diffHunk": "@@ -261,12 +261,22 @@ public LocationAwarePollerClient getLocationAwarePollerClient() {\n     protected void reportResult(final String locationName, final RemotePolledService polledService, final PollStatus pollResult) {\n         final OnmsMonitoringLocation location = this.monitoringLocationDao.get(locationName);\n \n-        final OnmsLocationSpecificStatus status = new OnmsLocationSpecificStatus();\n-        status.setLocation(location);\n-        status.setMonitoredService(polledService.getMonSvc());\n-        status.setPollResult(pollResult);\n+        final OnmsLocationSpecificStatus oldLocationSpecificStatus = this.locationSpecificStatusDao.getMostRecentStatusChange(location, polledService.getMonSvc());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzODA1MQ=="}, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1ODM1NDQ0OnYy", "diffSide": "RIGHT", "path": "opennms-base-assembly/src/main/filtered/etc/create.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQxOToxMjowMVrOGXEMAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQwNjozMjowOFrOGXRqSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0MQ==", "bodyText": "Not sure if...", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r426839041", "createdAt": "2020-05-18T19:12:01Z", "author": {"login": "fooker"}, "path": "opennms-base-assembly/src/main/filtered/etc/create.sql", "diffHunk": "@@ -343,7 +343,7 @@ CREATE TABLE scanreports (\n     CONSTRAINT scanreports_monitoringlocations_fkey FOREIGN KEY (location) REFERENCES monitoringlocations (id) ON DELETE CASCADE ON UPDATE CASCADE\n );\n \n-CREATE UNIQUE INDEX scanreports_id_idx on scanreport(id);\n+CREATE UNIQUE INDEX scanreports_id_idx on scanreports(id);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzA1OTc4Nw==", "bodyText": "Oh, come on, it's not really hurting anyone.", "url": "https://github.com/OpenNMS/opennms/pull/3006#discussion_r427059787", "createdAt": "2020-05-19T06:32:08Z", "author": {"login": "christianpape"}, "path": "opennms-base-assembly/src/main/filtered/etc/create.sql", "diffHunk": "@@ -343,7 +343,7 @@ CREATE TABLE scanreports (\n     CONSTRAINT scanreports_monitoringlocations_fkey FOREIGN KEY (location) REFERENCES monitoringlocations (id) ON DELETE CASCADE ON UPDATE CASCADE\n );\n \n-CREATE UNIQUE INDEX scanreports_id_idx on scanreport(id);\n+CREATE UNIQUE INDEX scanreports_id_idx on scanreports(id);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjgzOTA0MQ=="}, "originalCommit": {"oid": "1331c67c6afb1b5154c9f14deb7078573749fd17"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 661, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}