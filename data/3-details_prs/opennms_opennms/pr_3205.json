{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0NzE4NDMx", "number": 3205, "title": "NMS-12982: Add Slack confd templates", "bodyText": "All Contributors\n\n Have you read and followed our Contribution Guidelines?\n Have you made an issue in the OpenNMS issue tracker?If so, you should:\n\nupdate the title of this PR to be of the format: ${JIRA-ISSUE-NUMBER}: subject of pull request\nupdate the JIRA link at the bottom of this comment to refer to the real issue number\nprefix your commit messages with the issue number, if possible\n\n\n Have you made a comment in that issue which points back to this PR?\n Have you updated the JIRA link at the bottom of this comment to link to your issue?\n If this is a new or updated feature, is there documentation for the new behavior?\n If this is new code, are there unit and/or integration tests?\n If this PR targets a foundation-* branch, does it avoid changing files in $OPENNMS_HOME/etc/?\n\nPull Request Process\nOne or more reviewers should be assigned to each PR.\nIf you know that a particular person is subject matter expert in the area your PR affects, feel free to assign one or more reviewers when you create this PR, otherwise reviewers will be assigned for you.\nIf you have made additions or changes to the documentation, or if you need documentation for these code changes, please make sure a technical writer has looked it over.\nOnce the reviewer(s) accept the PR and the branch passes continuous integration, the PR is eligible for merge.\nAt that time, if you have commit access (are an OpenNMS Group employee or a member of the Order of the Green Polo) you are welcome to merge the PR.\nOtherwise, a reviewer can merge it for you.\nThanks for taking time to contribute!\nExternal References\n\nJIRA (Issue Tracker): https://issues.opennms.org/browse/NMS-12982", "createdAt": "2020-11-03T13:02:22Z", "url": "https://github.com/OpenNMS/opennms/pull/3205", "merged": true, "mergeCommit": {"oid": "be52b198c2dd491bd25287f70f9010086566f4db"}, "closed": true, "closedAt": "2020-11-30T13:00:10Z", "author": {"login": "mfuhrmann"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY4wdfAH2gAyNTE0NzE4NDMxOmUyNmMzMGRlYmQ3NWEzNmFkMmMyMjllNmFjNDUzYWMwN2ExNGI3ZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdhkzEdAFqTU0MDg3NjQ2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/e26c30debd75a36ad2c229e6ac453ac07a14b7e6", "committedDate": "2020-11-03T12:59:02Z", "message": "Add Slack confd templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzYyMDEx", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-526362011", "createdAt": "2020-11-09T15:21:03Z", "commit": {"oid": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNToyMTowM1rOHvzwwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNToyNDo1OFrOHvz9MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5MzE4Ng==", "bodyText": "We can simplify this to just include the base path for slack\nkeys = [\n   \"opennms/notifd/slack\"\n]", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519893186", "createdAt": "2020-11-09T15:21:03Z", "author": {"login": "mattixtech"}, "path": "opennms-container/horizon/container-fs/confd/conf.d/slack.properties.toml", "diffHunk": "@@ -0,0 +1,10 @@\n+[template]\n+src = \"slack.properties.tpl\"\n+dest = \"/opt/opennms/etc/opennms.properties.d/_confd.slack.properties\"\n+keys = [\n+   \"opennms/notifd/slack/channel\",\n+   \"opennms/notifd/slack/userName\",\n+   \"opennms/notifd/slack/iconEmoji\",\n+   \"opennms/notifd/slack/iconURL\",\n+   \"opennms/notifd/slack/useSystemProxy\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg5NjM2OA==", "bodyText": "We should add the base path to a variable and then reference it throughout:\n{{$slackPath := \"/opennms/notifd/slack/\" -}}\n\norg.opennms.netmgt.notifd.slack.username={{getv (print $slackPath \"userName\") \"none\"}}\n\nThe print above concatenates the variable and string to form the full path.", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r519896368", "createdAt": "2020-11-09T15:24:58Z", "author": {"login": "mattixtech"}, "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -0,0 +1,10 @@\n+#\n+# DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n+#\n+\n+# Configure storage strategy\n+org.opennms.netmgt.notifd.slack.channel={{getv \"opennms/notifd/slack/channel\" \"Webhook\"}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e26c30debd75a36ad2c229e6ac453ac07a14b7e6"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76dda66232f7368993b01506ec06030c3842f511", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/76dda66232f7368993b01506ec06030c3842f511", "committedDate": "2020-11-09T16:44:16Z", "message": "Added requested changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Njc1NjUy", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-526675652", "createdAt": "2020-11-09T21:39:16Z", "commit": {"oid": "76dda66232f7368993b01506ec06030c3842f511"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6d726d5fbc0ebdd808c6267572be8e00490e5c9", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/f6d726d5fbc0ebdd808c6267572be8e00490e5c9", "committedDate": "2020-11-11T17:34:05Z", "message": "Add confd readme file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/bcc549c8b737b2ab3c62428a30a546c3cf693191", "committedDate": "2020-11-11T17:40:24Z", "message": "Added docs hint for more details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MDk2NzM5", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-529096739", "createdAt": "2020-11-12T13:43:16Z", "commit": {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MDk4MjM5", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-529098239", "createdAt": "2020-11-12T13:44:59Z", "commit": {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo0NDo1OVrOHx7YZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMzo0NDo1OVrOHx7YZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjExNTE3NA==", "bodyText": "The slack path is $slackPath := \"/opennms/notifd/slack/\". Should it be then:\n---\nopennms:\n  notifd:\n    slack:\n      channel: ...", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r522115174", "createdAt": "2020-11-12T13:44:59Z", "author": {"login": "indigo423"}, "path": "opennms-container/horizon/CONFD_README.md", "diffHunk": "@@ -0,0 +1,26 @@\n+# Configuring Horizon via confd\n+(instructions for testing/developing confd templates are given at the end of this document)\n+## Mounting\n+When starting the Horizon container, mount a yaml file to the following path `/opt/minion/horizon-config.yaml`.\n+\n+Any configuration provided to confd will overwrite configuration specified as environment variables. Direct overlay of\n+specific configuration files will overwrite the corresponding config provided by confd.\n+\n+## Contents\n+The following describes the keys that can be specified in `horizon-config.yaml` to configure Horizon via confd.\n+\n+### Slack\n+\n+```\n+--- \n+notifd:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTg5NjE1", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-529189615", "createdAt": "2020-11-12T15:15:52Z", "commit": {"oid": "bcc549c8b737b2ab3c62428a30a546c3cf693191"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90482cc94612c48484ce07b34fa41e793546cb9e", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/90482cc94612c48484ce07b34fa41e793546cb9e", "committedDate": "2020-11-16T16:29:56Z", "message": "Test: Using ENV variables in confd templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNzI0OTU1", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-531724955", "createdAt": "2020-11-16T20:31:30Z", "commit": {"oid": "90482cc94612c48484ce07b34fa41e793546cb9e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDozMTozMFrOH0QOWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xNlQyMDozMTozMFrOH0QOWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDU1MzgxNw==", "bodyText": "I don't think these should be in this file. When I was talking about testing using environment variables I meant as an alternative key source rather than a yaml file. When confd runs it can pull keys out of the ENV to write to the template.", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r524553817", "createdAt": "2020-11-16T20:31:30Z", "author": {"login": "mattixtech"}, "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -2,11 +2,17 @@\n # DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n #\n \n+export OPENNMS_NOTIFD_SLACK_CHANNEL", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "90482cc94612c48484ce07b34fa41e793546cb9e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5af95179e57387c42a20c661393999fc0c91752d", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/5af95179e57387c42a20c661393999fc0c91752d", "committedDate": "2020-11-17T18:40:11Z", "message": "Added support for ENV or YAML input"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjgyMDgx", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-533682081", "createdAt": "2020-11-18T17:20:55Z", "commit": {"oid": "5af95179e57387c42a20c661393999fc0c91752d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzoyMDo1NlrOH14xFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNzoyMDo1NlrOH14xFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjI2NjY0Nw==", "bodyText": "You can get rid of this along with the conditional. When confd is invoked you can tell it to source keys from the environment rather than yaml or another key source. We don't want to be explicitly checking for the env vars in the template.\nOnce that is done I'm good with this PR. I'm not familiar with what confd key source horizon is using so I don't need to see the env test work if we aren't using it, Ronny could provide guidance there perhaps.", "url": "https://github.com/OpenNMS/opennms/pull/3205#discussion_r526266647", "createdAt": "2020-11-18T17:20:56Z", "author": {"login": "mattixtech"}, "path": "opennms-container/horizon/container-fs/confd/templates/slack.properties.tpl", "diffHunk": "@@ -2,17 +2,22 @@\n # DON'T EDIT THIS FILE :: GENERATED WITH CONFD\n #\n \n-export OPENNMS_NOTIFD_SLACK_CHANNEL\n-export OPENNMS_NOTIFD_SLACK_USERNAME\n-export OPENNMS_NOTIFD_SLACK_ICONEMOJI\n-export OPENNMS_NOTIFD_SLACK_ICONURL\n-export OPENNMS_NOTIFD_SLACK_USESYSTEMPROXY\n+{{ if getenv \"OPENNMS_NOTIFD_SLACK_CHANNEL\" }}\n+\n+org.opennms.netmgt.notifd.slack.channel={{getenv \"OPENNMS_NOTIFD_SLACK_CHANNEL\" \"Webhook\"}}\n+org.opennms.netmgt.notifd.slack.username={{getenv \"OPENNMS_NOTIFD_SLACK_USERNAME\" \"none\"}}\n+org.opennms.netmgt.notifd.slack.iconEmoji={{getenv \"OPENNMS_NOTIFD_SLACK_ICONEMOJI\" \"\"}}\n+org.opennms.netmgt.notifd.slack.iconURL={{getenv \"OPENNMS_NOTIFD_SLACK_ICONURL\" \"\"}}\n+org.opennms.netmgt.notifd.slack.useSystemProxy={{getenv \"OPENNMS_NOTIFD_SLACK_USESYSTEMPROXY\" \"true\"}}\n+\n+{{ else }}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5af95179e57387c42a20c661393999fc0c91752d"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15b96c30d251a3a4044e9aa312af7e05f52f1c91", "author": {"user": {"login": "mfuhrmann", "name": "Marcel Fuhrmann"}}, "url": "https://github.com/OpenNMS/opennms/commit/15b96c30d251a3a4044e9aa312af7e05f52f1c91", "committedDate": "2020-11-24T19:41:41Z", "message": "Revert to old state\n\nJust use the YAML settings instead of ENV and/or YAML."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDU1NjUz", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-539455653", "createdAt": "2020-11-26T16:39:54Z", "commit": {"oid": "15b96c30d251a3a4044e9aa312af7e05f52f1c91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODc2NDYw", "url": "https://github.com/OpenNMS/opennms/pull/3205#pullrequestreview-540876460", "createdAt": "2020-11-30T12:49:06Z", "commit": {"oid": "15b96c30d251a3a4044e9aa312af7e05f52f1c91"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3835, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}