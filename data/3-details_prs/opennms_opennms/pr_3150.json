{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0MDI3NTMw", "number": 3150, "title": "NMS-12794: Add support for metadata for threshold fields", "bodyText": "Support metadata in Threshold fields like value rearm trigger in Simple-DS and Expression threshold configs.\nExternal References\n\nJIRA (Issue Tracker): http://issues.opennms.org/browse/NMS-12794", "createdAt": "2020-09-10T15:48:32Z", "url": "https://github.com/OpenNMS/opennms/pull/3150", "merged": true, "mergeCommit": {"oid": "e533456db816720f5800d62eb6e7ac803589460c"}, "closed": true, "closedAt": "2020-09-21T21:38:58Z", "author": {"login": "cgorantla"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH12b-AH2gAyNDg0MDI3NTMwOjcyZDczMjJiY2ViMzBjY2VhNzk1M2RlMjI0YTlmYzM1OTQ4NTFhN2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLGjO7gFqTQ5MjgxNjkwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/72d7322bceb30ccea7953de224a9fc3594851a7a", "committedDate": "2020-09-11T13:59:08Z", "message": "NMS-12794: Add support for metadata for threshold fields"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e5709fa5a27e726cce1420ab5569395af926b6d", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/6e5709fa5a27e726cce1420ab5569395af926b6d", "committedDate": "2020-09-10T15:46:09Z", "message": "NMS-12794: Add support for metadata for threshold fields"}, "afterCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/72d7322bceb30ccea7953de224a9fc3594851a7a", "committedDate": "2020-09-11T13:59:08Z", "message": "NMS-12794: Add support for metadata for threshold fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MTI4NDI3", "url": "https://github.com/OpenNMS/opennms/pull/3150#pullrequestreview-486128427", "createdAt": "2020-09-10T16:51:04Z", "commit": {"oid": "6e5709fa5a27e726cce1420ab5569395af926b6d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjo1MTowNFrOHP9Dug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNjoyMjo0NVrOHQldkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ5MTA2Ng==", "bodyText": "null and \"\" are already covered cases by parseInt() and parseDouble(). Is there a specific reason to add this additional check?", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r486491066", "createdAt": "2020-09-10T16:51:04Z", "author": {"login": "mattixtech"}, "path": "core/lib/src/main/java/org/opennms/core/utils/StringUtils.java", "diffHunk": "@@ -455,11 +457,25 @@ public static String getHumanReadableByteCount(long bytes, boolean si) {\n     }\n \n     public static Integer parseInt(String value, Integer defaultValue) {\n+        if(Strings.isNullOrEmpty(value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e5709fa5a27e726cce1420ab5569395af926b6d"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExMjU3Nw==", "bodyText": "Do we need this cached field? It looks like the presence or absence of a value in thresholdValues would be sufficient.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487112577", "createdAt": "2020-09-11T15:13:14Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/AbstractThresholdEvaluatorState.java", "diffHunk": "@@ -128,6 +128,8 @@ public Long load(String key) {\n \n     static abstract class AbstractState implements Serializable {\n         String interpolatedExpression = null;\n+        boolean cached = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNDcyNg==", "bodyText": "Unnecessary indentation from the else branch.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (!state.isCached()) {\n          \n          \n            \n                        return thresholdValuesConsumer.get(thresholdValues -> {\n          \n          \n            \n                            state.setThresholdValues(thresholdValues);\n          \n          \n            \n                            state.setCached(true);\n          \n          \n            \n                        });\n          \n          \n            \n                    } else {\n          \n          \n            \n                        Double dsvalue = thresholdValuesConsumer.getDsValue();\n          \n          \n            \n                        ThresholdValues thresholdValues = state.getThresholdValues();\n          \n          \n            \n                        thresholdValues.setDsValue(dsvalue);\n          \n          \n            \n                        return thresholdValues;\n          \n          \n            \n                    }\n          \n          \n            \n                    if (!state.isCached()) {\n          \n          \n            \n                        return thresholdValuesConsumer.get(thresholdValues -> {\n          \n          \n            \n                            state.setThresholdValues(thresholdValues);\n          \n          \n            \n                            state.setCached(true);\n          \n          \n            \n                        });\n          \n          \n            \n                    }\n          \n          \n            \n            \n          \n          \n            \n                    Double dsvalue = thresholdValuesConsumer.getDsValue();\n          \n          \n            \n                    ThresholdValues thresholdValues = state.getThresholdValues();\n          \n          \n            \n                    thresholdValues.setDsValue(dsvalue);\n          \n          \n            \n                    return thresholdValues;", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487114726", "createdAt": "2020-09-11T15:16:45Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/AbstractThresholdEvaluatorState.java", "diffHunk": "@@ -263,21 +287,51 @@ public synchronized Status evaluate(double dsValue, Long sequenceNumber) {\n     @Override\n     public ValueStatus evaluate(ExpressionThresholdValue valueSupplier, Long sequenceNumber)\n             throws ThresholdExpressionException {\n-        double dsValue = getValueForExpressionThreshold(valueSupplier);\n-        Status status = evaluate(dsValue, sequenceNumber);\n+        ExpressionConfigWrapper.ExpressionValue expressionValue = getValueForExpressionThreshold(valueSupplier);\n+        Status status = evaluate(expressionValue.value, expressionValue.getThresholdValues(), sequenceNumber);\n+\n+        return new ValueStatus(expressionValue.value, status, expressionValue.getThresholdValues());\n+    }\n+\n+    @Override\n+    public ValueStatus evaluate(ThresholdValuesConsumer thresholdValuesConsumer, Long sequenceNumber)\n+            throws ThresholdExpressionException {\n+        ThresholdValues thresholdValues = getThresholdValues(thresholdValuesConsumer);\n+        Status status = evaluate(thresholdValues.getDsValue(), thresholdValues, sequenceNumber);\n+        return new ValueStatus(thresholdValues.getDsValue(), status, thresholdValues);\n+    }\n+\n+    private ThresholdValues getThresholdValues(ThresholdValuesConsumer thresholdValuesConsumer) {\n \n-        return new ValueStatus(dsValue, status);\n+        if (!state.isCached()) {\n+            return thresholdValuesConsumer.get(thresholdValues -> {\n+                state.setThresholdValues(thresholdValues);\n+                state.setCached(true);\n+            });\n+        } else {\n+            Double dsvalue = thresholdValuesConsumer.getDsValue();\n+            ThresholdValues thresholdValues = state.getThresholdValues();\n+            thresholdValues.setDsValue(dsvalue);\n+            return thresholdValues;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzExNjI3OA==", "bodyText": "Why does this method take a consumer? It looks like it would be sufficient to simply return the values and take no parameters here.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487116278", "createdAt": "2020-09-11T15:19:17Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/ThresholdValuesConsumer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.threshd;\n+\n+import java.util.function.Consumer;\n+\n+public interface ThresholdValuesConsumer {\n+\n+    ThresholdEvaluatorState.ThresholdValues get(Consumer<ThresholdEvaluatorState.ThresholdValues> thresholdsConsumer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEyMjc0MQ==", "bodyText": "The interface name here is misleading as this seems to be supplying rather than consuming.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487122741", "createdAt": "2020-09-11T15:29:49Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/ThresholdValuesConsumer.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*******************************************************************************\n+ * This file is part of OpenNMS(R).\n+ *\n+ * Copyright (C) 2020 The OpenNMS Group, Inc.\n+ * OpenNMS(R) is Copyright (C) 1999-2020 The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is a registered trademark of The OpenNMS Group, Inc.\n+ *\n+ * OpenNMS(R) is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU Affero General Public License as published\n+ * by the Free Software Foundation, either version 3 of the License,\n+ * or (at your option) any later version.\n+ *\n+ * OpenNMS(R) is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n+ * GNU Affero General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU Affero General Public License\n+ * along with OpenNMS(R).  If not, see:\n+ *      http://www.gnu.org/licenses/\n+ *\n+ * For more information contact:\n+ *     OpenNMS(R) Licensing <license@opennms.org>\n+ *     http://www.opennms.org/\n+ *     http://www.opennms.com/\n+ *******************************************************************************/\n+\n+package org.opennms.netmgt.threshd;\n+\n+import java.util.function.Consumer;\n+\n+public interface ThresholdValuesConsumer {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzMTEwMg==", "bodyText": "Looks like this doesn't need to accept a consumer either. The caller should be able to use the return value.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487131102", "createdAt": "2020-09-11T15:43:37Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/ExpressionThresholdValue.java", "diffHunk": "@@ -32,10 +32,10 @@\n \n public interface ExpressionThresholdValue {\n     /**\n-     * @param expressionConsumer a consumer for accepting the interpolated expression for caching purposes\n+     * @param expressionConsumer a consumer for accepting the interpolated expression and threshold values for caching purposes\n      * @return the expression value\n      */\n-    double get(Consumer<String> expressionConsumer) throws ThresholdExpressionException;\n+    ExpressionConfigWrapper.ExpressionValue get(Consumer<ExpressionConfigWrapper.ExpressionValue> expressionConsumer) throws ThresholdExpressionException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzEzNjYyNw==", "bodyText": "Since we are already using Optional in this class in some places to signify the absence of a value can we use that for the new/refactored methods rather than returning null.\nThis applies for the rest of new code in this class as well where nullable values are being returned.\nAlso the javadoc should either be updated or deleted as these methods don't return primitives anymore and the javadoc does not indicate when they would return null (or if we update them optional).", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487136627", "createdAt": "2020-09-11T15:53:15Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/BaseThresholdDefConfigWrapper.java", "diffHunk": "@@ -124,7 +127,11 @@ public String getDsType() {\n      *\n      * @return a double.\n      */\n-    public double getRearm() {\n+    public Double getRearm() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE0MjA3OA==", "bodyText": "Looks like we don't need to churn this file.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487142078", "createdAt": "2020-09-11T16:02:46Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/ThresholdConfigWrapper.java", "diffHunk": "@@ -83,4 +83,5 @@ public double evaluate(Map<String, Double> values) {\n     public void accept(ThresholdDefVisitor thresholdDefVisitor) {\n         thresholdDefVisitor.visit(this);\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzE1MzA0MQ==", "bodyText": "Since this method and isRearmExceeded will NPE if given nulls can we update the method signature to take a primitive. That way their preconditions will be enforced.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r487153041", "createdAt": "2020-09-11T16:22:45Z", "author": {"login": "mattixtech"}, "path": "features/collection/thresholding/impl/src/main/java/org/opennms/netmgt/threshd/ThresholdEvaluatorHighLow.java", "diffHunk": "@@ -201,32 +211,53 @@ public Status evaluateAfterFetch(double dsValue) {\n             return Status.NO_CHANGE;\n         }\n \n-        protected boolean isThresholdExceeded(double dsValue) {\n+        protected boolean isThresholdExceeded(double dsValue, Double value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72d7322bceb30ccea7953de224a9fc3594851a7a"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383b5da3f73833ffead5b43116998af28a38cba0", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/383b5da3f73833ffead5b43116998af28a38cba0", "committedDate": "2020-09-15T19:20:19Z", "message": "NMS-12794: Handle review comments\n\nadd ui changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5ODIwOTk5", "url": "https://github.com/OpenNMS/opennms/pull/3150#pullrequestreview-489820999", "createdAt": "2020-09-16T16:57:03Z", "commit": {"oid": "383b5da3f73833ffead5b43116998af28a38cba0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b2f4ef0930d11af2e020b6ab8f147c3209fd03c", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/9b2f4ef0930d11af2e020b6ab8f147c3209fd03c", "committedDate": "2020-09-16T18:01:42Z", "message": "NMS-12794: Update doc\n\n[ci skip]"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNTU1MzY4", "url": "https://github.com/OpenNMS/opennms/pull/3150#pullrequestreview-490555368", "createdAt": "2020-09-17T12:48:22Z", "commit": {"oid": "9b2f4ef0930d11af2e020b6ab8f147c3209fd03c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMjo0ODoyMlrOHTgZIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMjo1MDozMVrOHTgfIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIxNTcxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Metadata is also supported in Value, Rearm, Trigger fields for Single-DS and expression-based thresholds.\n          \n          \n            \n            Metadata is also supported in Value, Re-arm, and Trigger fields for Single-DS and expression-based thresholds.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r490215713", "createdAt": "2020-09-17T12:48:22Z", "author": {"login": "Bonrob2"}, "path": "opennms-doc/guide-admin/src/asciidoc/text/thresholds/thresholding.adoc", "diffHunk": "@@ -173,11 +173,10 @@ During evaluation of an expression, the following scopes are available:\n * Interface metadata\n * Service metadata\n \n+Metadata is also supported in Value, Rearm, Trigger fields for Single-DS and expression-based thresholds.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2f4ef0930d11af2e020b6ab8f147c3209fd03c"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIxNzI1MA==", "bodyText": "The metadata link is broken.", "url": "https://github.com/OpenNMS/opennms/pull/3150#discussion_r490217250", "createdAt": "2020-09-17T12:50:31Z", "author": {"login": "Bonrob2"}, "path": "opennms-doc/guide-admin/src/asciidoc/text/thresholds/thresholding.adoc", "diffHunk": "@@ -173,11 +173,10 @@ During evaluation of an expression, the following scopes are available:\n * Interface metadata\n * Service metadata\n \n+Metadata is also supported in Value, Rearm, Trigger fields for Single-DS and expression-based thresholds.\n+\n For more information on metadata and how to define it, see link:metadata[Metadata].", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2f4ef0930d11af2e020b6ab8f147c3209fd03c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4f6de2a6de55ebc2aa94b58cea49958f695fd8a", "author": {"user": {"login": "cgorantla", "name": "Chandra Gorantla"}}, "url": "https://github.com/OpenNMS/opennms/commit/f4f6de2a6de55ebc2aa94b58cea49958f695fd8a", "committedDate": "2020-09-17T15:00:20Z", "message": "NMS-12794: Update docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODE2OTA2", "url": "https://github.com/OpenNMS/opennms/pull/3150#pullrequestreview-492816906", "createdAt": "2020-09-21T17:08:19Z", "commit": {"oid": "f4f6de2a6de55ebc2aa94b58cea49958f695fd8a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3879, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}