{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjYwMzk4", "number": 3025, "title": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API - Part 1", "bodyText": "This PR contains performance improvements for the Timeseries Integration Layer. The overall ticket is: NMS-12731: Optimize Performance of Timeseries Integration Layer\nSince these are large changes I split them in multiple PRs. This PR addresses the following sub tasks:\n\nNMS-12744: Limit number of calls to find metrics by\n\nquerying for all metrics under a given resource path (instead of querying for only the next level).\ncaching the results by the index tags\n\n\nNMS-12745: Limit the calls to the timeseries_metatable:  by filling the cache already during writing (before it was only during reading)\nNMS-12746: Remove (if possible) the conversion from Opennms -> Newts -> TS\n\nIt also removes some unused code.\nExternal References\n\nJIRA (Issue Tracker): https://issues.opennms.org/browse/NMS-12731", "createdAt": "2020-05-31T19:45:09Z", "url": "https://github.com/OpenNMS/opennms/pull/3025", "merged": true, "mergeCommit": {"oid": "b90f605053418271ea5b5944ceca32ceae4ec5b3"}, "closed": true, "closedAt": "2020-07-08T19:38:44Z", "author": {"login": "patrick-schweizer"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpp54_gBqjM0MjY0MjgyNjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy9gSJAFqTQ0NDk2MTg3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fba945adac76f5dea341612ed6e410445bcc9ca7", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/fba945adac76f5dea341612ed6e410445bcc9ca7", "committedDate": "2020-06-02T14:09:50Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao: fix checkstyle"}, "afterCommit": {"oid": "64677b439fc9b02fc2a91636f25cc8c2363acdf4", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/64677b439fc9b02fc2a91636f25cc8c2363acdf4", "committedDate": "2020-06-09T18:46:41Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: introduce timeseriesSearcherCache"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8b7845d7e9541a3816fa29f318dcead6f2a962d8", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/8b7845d7e9541a3816fa29f318dcead6f2a962d8", "committedDate": "2020-06-10T22:33:22Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}, "afterCommit": {"oid": "390791be1c977fe5783344ae3a57b6e286a8a1b0", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/390791be1c977fe5783344ae3a57b6e286a8a1b0", "committedDate": "2020-06-14T16:51:08Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "390791be1c977fe5783344ae3a57b6e286a8a1b0", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/390791be1c977fe5783344ae3a57b6e286a8a1b0", "committedDate": "2020-06-14T16:51:08Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}, "afterCommit": {"oid": "026b677162a672639b72711c23a41e572f988671", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/026b677162a672639b72711c23a41e572f988671", "committedDate": "2020-06-17T19:03:34Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8062cd005f77301190373295397fd38c15adb7f9", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/8062cd005f77301190373295397fd38c15adb7f9", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: Initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8487ba7d5ac5fa12c82b70af5fdb87f85ac7abd", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/e8487ba7d5ac5fa12c82b70af5fdb87f85ac7abd", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5d8fca4d522fdb4810dd635bb7157c6edcccf53", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/c5d8fca4d522fdb4810dd635bb7157c6edcccf53", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao: add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6055d0540a75df47420110d4419bf6e0d76a21", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/3d6055d0540a75df47420110d4419bf6e0d76a21", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: be smarter about database writes in TimeSeriesMetaDataDao: fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d118e6d9bc768b51cfb352c57f6409227827a2a3", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/d118e6d9bc768b51cfb352c57f6409227827a2a3", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: cleanup unused config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f31d030f2fb6f4674c93de03cc93bb0bdf8d6fc", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/3f31d030f2fb6f4674c93de03cc93bb0bdf8d6fc", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: introduce timeseriesSearcherCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/3a18feec70529160d1f801b13ad7da89d729d732", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "026b677162a672639b72711c23a41e572f988671", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/026b677162a672639b72711c23a41e572f988671", "committedDate": "2020-06-17T19:03:34Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}, "afterCommit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/3a18feec70529160d1f801b13ad7da89d729d732", "committedDate": "2020-06-20T22:18:25Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API: remove newts context, remove write mapping from opennms to newts to timeseries api, do direct mapping from opennms -> timeseries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3ODQxMTgx", "url": "https://github.com/OpenNMS/opennms/pull/3025#pullrequestreview-437841181", "createdAt": "2020-06-25T20:38:58Z", "commit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMDozODo1OFrOGpK-Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQyMToyMTo0MlrOGpMO6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTgyNDUzNQ==", "bodyText": "There is no need for the try block. If the call throws, it must be a runtime exception and we can just propagate without wrapping.", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445824535", "createdAt": "2020-06-25T20:38:58Z", "author": {"login": "fooker"}, "path": "core/cache/src/main/java/org/opennms/core/cache/Cache.java", "diffHunk": "@@ -84,6 +85,18 @@ public V get(K key) throws ExecutionException {\n         }\n     }\n \n+    public V get(K key, Callable<? extends V> valueLoader) throws ExecutionException {\n+        Objects.requireNonNull(key);\n+        if (config.isEnabled()) {\n+            return delegate.get(key, valueLoader);\n+        }\n+        try {\n+            return valueLoader.call();\n+        } catch (Throwable t) {\n+            throw new RuntimeException(t);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0MTMxMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        Map<String, String> attributesForResource = cache.get(meta.getResourceId(), HashMap::new);\n          \n          \n            \n                        if(attributesForResource.get(meta.getName()) == null) {\n          \n          \n            \n                        Map<String, String> attributesForResource = cache.getIfPresent(meta.getResourceId());\n          \n          \n            \n                        if(attributesForResource != null && attributesForResource.contains(meta.getName())) {\n          \n      \n    \n    \n  \n\nTo save the allocation", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445841313", "createdAt": "2020-06-25T21:13:05Z", "author": {"login": "fooker"}, "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/meta/TimeSeriesMetaDataDao.java", "diffHunk": "@@ -69,34 +69,35 @@\n \n     private final DataSource dataSource;\n \n-    private final Map<String, Map<String, String>> cache; // resourceId, Map<name, value>\n+    private final Cache<String, Map<String, String>> cache; // resourceId, Map<name, value>\n \n     @Autowired\n     public TimeSeriesMetaDataDao(final DataSource dataSource,\n                                  @Named(\"timeseries.metadata.cache_size\") long cacheSize,\n                                  @Named(\"timeseries.metadata.cache_duration\") long cacheDuration) {\n         this.dataSource = dataSource;\n-        Cache<String, Map<String, String>> cache = CacheBuilder.newBuilder()\n+        this.cache = CacheBuilder.newBuilder()\n                 .maximumSize(cacheSize)\n                 .expireAfterWrite(cacheDuration, TimeUnit.SECONDS) // to make sure cache and db are in sync\n                 .build();\n-        this.cache = cache.asMap();\n     }\n \n-    public void store(final Collection<MetaData> metaDataCollection) throws SQLException {\n+    public void store(final Collection<MetaData> metaDataCollection) throws SQLException, ExecutionException {\n         Objects.requireNonNull(metaDataCollection);\n-        Set<MetaData> uncached = new HashSet<>();\n+        Set<MetaData> writeToDb = new HashSet<>();\n \n         // find all MetaData that is not present in the cache\n         for(MetaData meta : metaDataCollection) {\n-            if(!Optional\n-                    .ofNullable(cache.get(meta.getResourceId()))\n-                    .map(entry -> entry.get(meta.getName()))\n-                    .isPresent()) {\n-                uncached.add(meta);\n+            Map<String, String> attributesForResource = cache.get(meta.getResourceId(), HashMap::new);\n+            if(attributesForResource.get(meta.getName()) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NDk1OQ==", "bodyText": "If you call the other side that you should prefix the instance with this. :-)\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Objects.equals(m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(m_relativePath, that.m_relativePath) &&\n          \n          \n            \n                            Objects.equals(m_rrdFile, that.m_rrdFile) &&\n          \n          \n            \n                            Objects.equals(m_resource, that.m_resource);\n          \n          \n            \n                    return Objects.equals(this.m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(this.m_relativePath, that.m_relativePath) &&\n          \n          \n            \n                            Objects.equals(this.m_rrdFile, that.m_rrdFile) &&\n          \n          \n            \n                            Objects.equals(this.m_resource, that.m_resource);", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445844959", "createdAt": "2020-06-25T21:21:06Z", "author": {"login": "fooker"}, "path": "opennms-model/src/main/java/org/opennms/netmgt/model/RrdGraphAttribute.java", "diffHunk": "@@ -136,4 +137,19 @@ public String toString() {\n     \treturn \"\"+m_resource + '.' + m_name;\n \t}\n \n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) return true;\n+        if (o == null || getClass() != o.getClass()) return false;\n+        RrdGraphAttribute that = (RrdGraphAttribute) o;\n+        return Objects.equals(m_name, that.m_name) &&\n+                Objects.equals(m_relativePath, that.m_relativePath) &&\n+                Objects.equals(m_rrdFile, that.m_rrdFile) &&\n+                Objects.equals(m_resource, that.m_resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTg0NTIyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Objects.equals(m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(m_value, that.m_value) &&\n          \n          \n            \n                            Objects.equals(m_resource, that.m_resource);\n          \n          \n            \n                    return Objects.equals(this.m_name, that.m_name) &&\n          \n          \n            \n                            Objects.equals(this.m_value, that.m_value) &&\n          \n          \n            \n                            Objects.equals(this.m_resource, that.m_resource);", "url": "https://github.com/OpenNMS/opennms/pull/3025#discussion_r445845227", "createdAt": "2020-06-25T21:21:42Z", "author": {"login": "fooker"}, "path": "opennms-model/src/main/java/org/opennms/netmgt/model/StringPropertyAttribute.java", "diffHunk": "@@ -89,4 +91,19 @@ public OnmsResource getResource() {\n     public void setResource(OnmsResource resource) {\n         m_resource = resource;\n     }\n+\n+    @Override\n+    public boolean equals(Object o) {\n+        if (this == o) return true;\n+        if (o == null || getClass() != o.getClass()) return false;\n+        StringPropertyAttribute that = (StringPropertyAttribute) o;\n+        return Objects.equals(m_name, that.m_name) &&\n+                Objects.equals(m_value, that.m_value) &&\n+                Objects.equals(m_resource, that.m_resource);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3a18feec70529160d1f801b13ad7da89d729d732"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/8e08fe7efbf1a4d9c57ee7a7d0e71120f7e2ab4c", "committedDate": "2020-06-26T15:10:45Z", "message": "Apply suggestions from code review\r\n\r\nNMS-12731: PR suggestions\n\nCo-authored-by: Dustin Frisch <fooker@lab.sh>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1292d46c92bee9ef530d50312370b1243aae354b", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/1292d46c92bee9ef530d50312370b1243aae354b", "committedDate": "2020-06-29T17:20:32Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage: fix java version problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01e87c13716a63c9ecc228cf3d2911527b9d142c", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/01e87c13716a63c9ecc228cf3d2911527b9d142c", "committedDate": "2020-07-01T20:19:40Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage: fix cache problem"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abcdfd29b92792e0a133a52488f72cac44f3afc3", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/abcdfd29b92792e0a133a52488f72cac44f3afc3", "committedDate": "2020-07-07T00:19:00Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API - Part 2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37d635f56308d665565b64bf425edacd2d09f6e", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/e37d635f56308d665565b64bf425edacd2d09f6e", "committedDate": "2020-07-08T16:29:04Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: fix caching of non existent paths under wildcard"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0OTYxODcz", "url": "https://github.com/OpenNMS/opennms/pull/3025#pullrequestreview-444961873", "createdAt": "2020-07-08T17:01:46Z", "commit": {"oid": "e37d635f56308d665565b64bf425edacd2d09f6e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3662, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}