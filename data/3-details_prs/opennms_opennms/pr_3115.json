{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODg3MjAy", "number": 3115, "title": "CLOUD-435: configure Java options for Minion process", "bodyText": "All Contributors\n\n Have you read and followed our Contribution Guidelines?\n Have you made an issue in the OpenNMS issue tracker?If so, you should:\n\nupdate the title of this PR to be of the format: ${JIRA-ISSUE-NUMBER}: subject of pull request\nupdate the JIRA link at the bottom of this comment to refer to the real issue number\nprefix your commit messages with the issue number, if possible\n\n\n Have you made a comment in that issue which points back to this PR?\n Have you updated the JIRA link at the bottom of this comment to link to your issue?\n If this is a new or updated feature, is there documentation for the new behavior?\n If this is new code, are there unit and/or integration tests?\n If this PR targets a foundation-* branch, does it avoid changing files in $OPENNMS_HOME/etc/?\n\nPull Request Process\nOne or more reviewers should be assigned to each PR.\nIf you know that a particular person is subject matter expert in the area your PR affects, feel free to assign one or more reviewers when you create this PR, otherwise reviewers will be assigned for you.\nIf you have made additions or changes to the documentation, or if you need documentation for these code changes, please make sure a technical writer has looked it over.\nOnce the reviewer(s) accept the PR and the branch passes continuous integration, the PR is eligible for merge.\nAt that time, if you have commit access (are an OpenNMS Group employee or a member of the Order of the Green Polo) you are welcome to merge the PR.\nOtherwise, a reviewer can merge it for you.\nThanks for taking time to contribute!\nExternal References\n\nJIRA (Issue Tracker): https://issues.opennms.org/browse/CLOUD-435", "createdAt": "2020-08-17T14:59:46Z", "url": "https://github.com/OpenNMS/opennms/pull/3115", "merged": true, "mergeCommit": {"oid": "2e662782eeef47646af47cceb6ac978446791c76"}, "closed": true, "closedAt": "2020-08-24T08:47:09Z", "author": {"login": "swachter"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_z3rUgFqTQ2ODU0ODE5Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB-lLegBqjM2ODQzODg2Njg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTQ4MTk2", "url": "https://github.com/OpenNMS/opennms/pull/3115#pullrequestreview-468548196", "createdAt": "2020-08-17T15:07:00Z", "commit": {"oid": "4d671a8982e4c8f530ffb847823ba9fbf04c4eae"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTowNzowMFrOHBsvgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTowODozOFrOHBszlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0MzY4Mg==", "bodyText": "The org.opennms.minion.*.cfg files are normally used for storing properties referenced by features i.e. https://github.com/OpenNMS/opennms/blob/develop/features/minion/dominion/grpc-client/src/main/resources/OSGI-INF/blueprint/blueprint.xml#L20\nI'd rename this to /opt/minion/bin/minion-env.sh or similar.", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471543682", "createdAt": "2020-08-17T15:07:00Z", "author": {"login": "j-white"}, "path": "opennms-container/minion/container-fs/entrypoint.sh", "diffHunk": "@@ -9,6 +9,7 @@\n umask 002\n MINION_HOME=\"/opt/minion\"\n MINION_CONFIG=\"/opt/minion/etc/org.opennms.minion.controller.cfg\"\n+MINION_PROCESS_ENV_CFG=\"/opt/minion/etc/org.opennms.minion.process-env.cfg\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d671a8982e4c8f530ffb847823ba9fbf04c4eae"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NDM1OQ==", "bodyText": "What's the expected behavior if JAVA_OPTS is already set in the environment?", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471544359", "createdAt": "2020-08-17T15:08:04Z", "author": {"login": "j-white"}, "path": "opennms-container/minion/container-fs/entrypoint.sh", "diffHunk": "@@ -183,6 +184,10 @@ configure() {\n   initConfig\n   applyConfd\n   applyOverlayConfig\n+  chmod a+x \"$MINION_PROCESS_ENV_CFG\"\n+  set -a\n+  source \"$MINION_PROCESS_ENV_CFG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NDcyNQ==", "bodyText": "References /java-opts.sh", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471544725", "createdAt": "2020-08-17T15:08:38Z", "author": {"login": "j-white"}, "path": "opennms-container/minion/CONFD_README.md", "diffHunk": "@@ -201,3 +202,39 @@ scv:\n ```\n Can be used to override the default SCV provider from the JCEKS implementation (which uses the file system) to a gRPC\n based implementation which requests credentials from Dominion. If not specified the default JCEKS will be used.\n+\n+### Java Options\n+```\n+---\n+process-env:\n+    java-opts:\n+        - -Xmx4096m\n+        - -Xdebug\n+        - -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=7896\n+```\n+\n+Can be used to specify an arbitrary list of Java options. Config specified is written to the script `/java-opts.sh` that contains a corresponding `export JAVA_OPTS=\"...\"` statement.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4NTkxNjU5", "url": "https://github.com/OpenNMS/opennms/pull/3115#pullrequestreview-468591659", "createdAt": "2020-08-17T15:57:21Z", "commit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNTo1NzoyMlrOHBu0QA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxNjoxMDo0N1rOHBvVbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU3NzY2NA==", "bodyText": "We can set the key path to be more permissive here for the small chance we want to add things in the future.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                \"/process-env/java-opts\"\n          \n          \n            \n                \"/process-env\"", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471577664", "createdAt": "2020-08-17T15:57:22Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/container-fs/confd/conf.d/org.opennms.minion.process-env.toml", "diffHunk": "@@ -0,0 +1,7 @@\n+[template]\n+src = \"org.opennms.minion.process-env.tmpl\"\n+dest = \"/opt/minion/etc/org.opennms.minion.process-env.cfg\"\n+keys = [\n+    \"/process-env/java-opts\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MDc5Mg==", "bodyText": "I'd rather not add this to bin and not name it with .sh as I wanted to avoid a constraint on this file that it be sourceable/runnable. Renaming it should be fine, we could even just call it process-env.txt.\nIMO this file can simply be a text file that we parse what we want out of.", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471580792", "createdAt": "2020-08-17T16:02:11Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/container-fs/entrypoint.sh", "diffHunk": "@@ -9,6 +9,7 @@\n umask 002\n MINION_HOME=\"/opt/minion\"\n MINION_CONFIG=\"/opt/minion/etc/org.opennms.minion.controller.cfg\"\n+MINION_PROCESS_ENV_CFG=\"/opt/minion/etc/org.opennms.minion.process-env.cfg\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0MzY4Mg=="}, "originalCommit": {"oid": "4d671a8982e4c8f530ffb847823ba9fbf04c4eae"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MTY5MA==", "bodyText": "Instead of making the file executable, can we just read the value we want out of it, then export the environment variable for JAVA_OPTS to the value we read out of the file?\nAlso keep in mind that we are only creating the file if some config has been provided so we need a conditional to check if the file is present and only override the options in that case.\nOnly export the env variable if we found the config file and we were able to parse java options out of it, otherwise noop and use existing behavior.", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471581690", "createdAt": "2020-08-17T16:03:37Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/container-fs/entrypoint.sh", "diffHunk": "@@ -183,6 +184,10 @@ configure() {\n   initConfig\n   applyConfd\n   applyOverlayConfig\n+  chmod a+x \"$MINION_PROCESS_ENV_CFG\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MjU1MA==", "bodyText": "My preference is to overwrite in the case we have been explicitly provided one via confd. This should only ever be set by a user intending to provide their own options in full. The plan is to move the config that dominion already sets in the environment to go through confd instead to preserve the existing defaults.", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471582550", "createdAt": "2020-08-17T16:05:02Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/container-fs/entrypoint.sh", "diffHunk": "@@ -183,6 +184,10 @@ configure() {\n   initConfig\n   applyConfd\n   applyOverlayConfig\n+  chmod a+x \"$MINION_PROCESS_ENV_CFG\"\n+  set -a\n+  source \"$MINION_PROCESS_ENV_CFG\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU0NDM1OQ=="}, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4MzIyNA==", "bodyText": "We should surround this whole block with a conditional to check if any keys exist under /process-env/java-opts/ so that we don't output any content if there isn't any.\nThat way the remove-if-empty will work as intended.", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471583224", "createdAt": "2020-08-17T16:06:05Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/container-fs/confd/templates/org.opennms.minion.process-env.tmpl", "diffHunk": "@@ -0,0 +1,8 @@\n+#", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTU4NjE1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            1. If the result is not yet satifactory then remove the container by `docker rm -f minion`, edit the files in your IDE, and start the image again\n          \n          \n            \n            1. If the result is not yet satisfactory then remove the container by `docker rm -f minion`, edit the files in your IDE, and start the image again", "url": "https://github.com/OpenNMS/opennms/pull/3115#discussion_r471586157", "createdAt": "2020-08-17T16:10:47Z", "author": {"login": "mattixtech"}, "path": "opennms-container/minion/CONFD_README.md", "diffHunk": "@@ -201,3 +202,39 @@ scv:\n ```\n Can be used to override the default SCV provider from the JCEKS implementation (which uses the file system) to a gRPC\n based implementation which requests credentials from Dominion. If not specified the default JCEKS will be used.\n+\n+### Java Options\n+```\n+---\n+process-env:\n+    java-opts:\n+        - -Xmx4096m\n+        - -Xdebug\n+        - -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=7896\n+```\n+\n+Can be used to specify an arbitrary list of Java options. Config specified is written to the script `/java-opts.sh` that contains a corresponding `export JAVA_OPTS=\"...\"` statement.\n+\n+## Test/Develop confd templates\n+`confd` template changes can locally be tested by running a Minion container and mapping the corresponding files into the container. The following procedure might be useful:\n+\n+1. A Minion Docker image is required. It can be downloaded from a build in CircleCI.\n+1. Load the image into Docker: `docker load minion.oci`\n+1. Create a `docker-compose.yaml` file in the parent folder of the checked out `opennms` repo. An example compose file is given below\n+1. Start the image: `docker-compose up -d`\n+1. Open a shell in the container using `docker exec -ti minion bash` or look at the logs `docker logs minion`\n+1. If the result is not yet satifactory then remove the container by `docker rm -f minion`, edit the files in your IDE, and start the image again", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4b07b9b4da9e0cd0cc5347fe33f151c656069653"}, "originalPosition": 31}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2870d717e34d3205e8e729b742f590dbb6ab1f0f", "author": {"user": {"login": "swachter", "name": "Stefan Wachter"}}, "url": "https://github.com/OpenNMS/opennms/commit/2870d717e34d3205e8e729b742f590dbb6ab1f0f", "committedDate": "2020-08-18T13:40:14Z", "message": "incorporate review"}, "afterCommit": {"oid": "324d66097b0025efda80ff5e8eead3e3cc233c36", "author": {"user": {"login": "swachter", "name": "Stefan Wachter"}}, "url": "https://github.com/OpenNMS/opennms/commit/324d66097b0025efda80ff5e8eead3e3cc233c36", "committedDate": "2020-08-21T15:04:16Z", "message": "use file name 'minion-process.env' when configuring the environment of the minion process"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyNjAwNzc1", "url": "https://github.com/OpenNMS/opennms/pull/3115#pullrequestreview-472600775", "createdAt": "2020-08-21T15:46:49Z", "commit": {"oid": "87df7ccb31d9da6ca9df1cf5a4b495c3da639a14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeff79242294b4fff2dbb275eafd020bc7ad0e66", "author": {"user": {"login": "swachter", "name": "Stefan Wachter"}}, "url": "https://github.com/OpenNMS/opennms/commit/aeff79242294b4fff2dbb275eafd020bc7ad0e66", "committedDate": "2020-08-24T08:39:03Z", "message": "cloud-435: Support setting environment variables of minion process; for now only java-opts are considered"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87df7ccb31d9da6ca9df1cf5a4b495c3da639a14", "author": {"user": {"login": "swachter", "name": "Stefan Wachter"}}, "url": "https://github.com/OpenNMS/opennms/commit/87df7ccb31d9da6ca9df1cf5a4b495c3da639a14", "committedDate": "2020-08-21T15:12:54Z", "message": "fix CONFD_README.md"}, "afterCommit": {"oid": "aeff79242294b4fff2dbb275eafd020bc7ad0e66", "author": {"user": {"login": "swachter", "name": "Stefan Wachter"}}, "url": "https://github.com/OpenNMS/opennms/commit/aeff79242294b4fff2dbb275eafd020bc7ad0e66", "committedDate": "2020-08-24T08:39:03Z", "message": "cloud-435: Support setting environment variables of minion process; for now only java-opts are considered"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3521, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}