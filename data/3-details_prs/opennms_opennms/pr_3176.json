{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2NzU0NzIw", "number": 3176, "title": "NMS-12800: Drop flows with negative duration", "bodyText": "JIRA: https://issues.opennms.org/browse/NMS-12800", "createdAt": "2020-10-02T08:09:59Z", "url": "https://github.com/OpenNMS/opennms/pull/3176", "merged": true, "mergeCommit": {"oid": "f34d1195ea7ca3d51a5d3f0b4e7d149ef20c3f3e"}, "closed": true, "closedAt": "2020-10-08T05:28:33Z", "author": {"login": "christianpape"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOhvBQABqjM4MzI5Mjc0NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQReWzAFqTUwNDE2Njk3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "02a94a609e3ca64531bcf5e04b530366cc61c54b", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/02a94a609e3ca64531bcf5e04b530366cc61c54b", "committedDate": "2020-10-02T07:52:30Z", "message": "NMS-12800: Drop flows with negative duration"}, "afterCommit": {"oid": "e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a", "committedDate": "2020-10-02T08:30:00Z", "message": "NMS-12800: Drop flows with negative duration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTE5NjEx", "url": "https://github.com/OpenNMS/opennms/pull/3176#pullrequestreview-501119611", "createdAt": "2020-10-02T13:09:28Z", "commit": {"oid": "e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowOToyOFrOHbs9vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMzowOToyOFrOHbs9vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgxMDMwMw==", "bodyText": "Can we use a rate limited logger or move this up into the block above? (Trying to avoid spamming the logs with this.)\nCan we also include the exporter address in the log message?", "url": "https://github.com/OpenNMS/opennms/pull/3176#discussion_r498810303", "createdAt": "2020-10-02T13:09:28Z", "author": {"login": "j-white"}, "path": "features/telemetry/protocols/netflow/parser/src/main/java/org/opennms/netmgt/telemetry/protocols/netflow/parser/ParserBase.java", "diffHunk": "@@ -241,7 +265,32 @@ public void setThreads(int threads) {\n                     // if we can't keep up\n                     final Runnable dispatch = () -> {\n                         // Let's serialize\n-                        byte[] flowMessage = buildMessage(record, enrichment);\n+                        byte[] flowMessage = new byte[0];\n+                        try {\n+                            flowMessage = buildMessage(record, enrichment);\n+                        } catch (IllegalFlowException e) {\n+                            final Optional<Instant> instant = illegalFlowEventCache.getUnchecked(remoteAddress.getAddress());\n+\n+                            if (!instant.isPresent() || Duration.between(instant.get(), Instant.now()).getSeconds() > getIllegalFlowEventRate()) {\n+                                illegalFlowEventCache.put(remoteAddress.getAddress(), Optional.of(Instant.now()));\n+\n+                                eventForwarder.sendNow(new EventBuilder()\n+                                        .setUei(ILLEGAL_FLOW_EVENT_UEI)\n+                                        .setTime(new Date())\n+                                        .setSource(getName())\n+                                        .setInterface(remoteAddress.getAddress())\n+                                        .setDistPoller(identity.getId())\n+                                        .addParam(\"monitoringSystemId\", identity.getId())\n+                                        .addParam(\"monitoringSystemLocation\", identity.getLocation())\n+                                        .setParam(\"cause\", e.getMessage())\n+                                        .setParam(\"illegalFlowEventRate\", (int) getIllegalFlowEventRate())\n+                                        .getEvent());\n+                            }\n+\n+                            LOG.warn(\"Illegal flow detected\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9233ef3ff90e4b8a6b52f4c8071e9c777c0509a"}, "originalPosition": 94}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "815bce686c08f0abbc37e7330b2c900f83951a35", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/815bce686c08f0abbc37e7330b2c900f83951a35", "committedDate": "2020-10-02T15:11:06Z", "message": "NMS-12800: Review changes"}, "afterCommit": {"oid": "f3b07330f396fc9932e67697b058c328b9517d03", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/f3b07330f396fc9932e67697b058c328b9517d03", "committedDate": "2020-10-02T15:12:57Z", "message": "NMS-12800: Review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c522861ff9d16107ab0e2b5d6ebc4777f1b82f2", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/1c522861ff9d16107ab0e2b5d6ebc4777f1b82f2", "committedDate": "2020-10-03T07:53:13Z", "message": "NMS-12800: Drop flows with negative duration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bdacb4787947cb190fb079cccbe971ad24188059", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/bdacb4787947cb190fb079cccbe971ad24188059", "committedDate": "2020-10-03T07:53:13Z", "message": "NMS-12800: Review changes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3b07330f396fc9932e67697b058c328b9517d03", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/f3b07330f396fc9932e67697b058c328b9517d03", "committedDate": "2020-10-02T15:12:57Z", "message": "NMS-12800: Review changes"}, "afterCommit": {"oid": "bdacb4787947cb190fb079cccbe971ad24188059", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/bdacb4787947cb190fb079cccbe971ad24188059", "committedDate": "2020-10-03T07:53:13Z", "message": "NMS-12800: Review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad4e472cd01d91b4e7cb3834206cbc766c2e3691", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/ad4e472cd01d91b4e7cb3834206cbc766c2e3691", "committedDate": "2020-10-05T13:34:31Z", "message": "NMS-12800: Also check NF5 and IPFIX for negative duration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNDgxNDE0", "url": "https://github.com/OpenNMS/opennms/pull/3176#pullrequestreview-502481414", "createdAt": "2020-10-05T23:10:12Z", "commit": {"oid": "ad4e472cd01d91b4e7cb3834206cbc766c2e3691"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a667c1f59d3a9feed1532e09aafa1363e6604ef8", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/a667c1f59d3a9feed1532e09aafa1363e6604ef8", "committedDate": "2020-10-06T05:57:55Z", "message": "NMS-12800: Fixed build error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f844cf468fe375e39d9fddcbaccd1d4865f23d3", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/0f844cf468fe375e39d9fddcbaccd1d4865f23d3", "committedDate": "2020-10-06T16:42:46Z", "message": "NMS-12800: Fixed tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5333ec9fd8bcd6c6336cb70f026ed4a4fcd1ac14", "author": {"user": {"login": "christianpape", "name": "Christian Pape"}}, "url": "https://github.com/OpenNMS/opennms/commit/5333ec9fd8bcd6c6336cb70f026ed4a4fcd1ac14", "committedDate": "2020-10-07T05:40:40Z", "message": "NMS-12800: Fixed smoke test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MTY2OTc2", "url": "https://github.com/OpenNMS/opennms/pull/3176#pullrequestreview-504166976", "createdAt": "2020-10-07T18:41:34Z", "commit": {"oid": "5333ec9fd8bcd6c6336cb70f026ed4a4fcd1ac14"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3904, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}