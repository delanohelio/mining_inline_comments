{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzODc4MTI0", "number": 3036, "title": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API - Part 2", "bodyText": "This PR contains performance improvements for the Timeseries Integration Layer. The overall ticket is: NMS-12731: Optimize Performance of Timeseries Integration Layer\nSince these are large changes I split them in multiple PRs. This PR addresses the following sub tasks:\n\n NMS-12747: Add JMX Meters to measure and export performance\n NMS-12748: Remove unnecessary writes to meta_data table\n NMS-12749: Remove conversation to Newts objects in read operation\nsome code cleanup\n\nExternal References\n\nJIRA (Issue Tracker): https://issues.opennms.org/browse/NMS-12731", "createdAt": "2020-06-12T20:46:29Z", "url": "https://github.com/OpenNMS/opennms/pull/3036", "merged": true, "mergeCommit": {"oid": "abcdfd29b92792e0a133a52488f72cac44f3afc3"}, "closed": true, "closedAt": "2020-07-07T00:19:00Z", "author": {"login": "patrick-schweizer"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrPNMogBqjM0NDE4NjU1NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyUd2WAH2gAyNDMzODc4MTI0OjFmNDlkMGU1OWEyYmI5ZjEyNzBmYjIxNDlkZGE2YWQwNTBjMDc1MmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "072c362fe0c889b420d5bdb067bb94561986a9cf", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/072c362fe0c889b420d5bdb067bb94561986a9cf", "committedDate": "2020-06-13T17:48:16Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}, "afterCommit": {"oid": "9cfac0714c398c7492763cca2ce3ce8aaa9d404f", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/9cfac0714c398c7492763cca2ce3ce8aaa9d404f", "committedDate": "2020-06-14T17:07:16Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9cfac0714c398c7492763cca2ce3ce8aaa9d404f", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/9cfac0714c398c7492763cca2ce3ce8aaa9d404f", "committedDate": "2020-06-14T17:07:16Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}, "afterCommit": {"oid": "a1f277fea01e6587b3ab2a4a62a0baada6575452", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/a1f277fea01e6587b3ab2a4a62a0baada6575452", "committedDate": "2020-06-17T19:19:29Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a1f277fea01e6587b3ab2a4a62a0baada6575452", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/a1f277fea01e6587b3ab2a4a62a0baada6575452", "committedDate": "2020-06-17T19:19:29Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}, "afterCommit": {"oid": "d9898d8d5fe02117d98c5098905d08a7e2f602ad", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/d9898d8d5fe02117d98c5098905d08a7e2f602ad", "committedDate": "2020-06-20T22:20:58Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTQxMjk3", "url": "https://github.com/OpenNMS/opennms/pull/3036#pullrequestreview-440941297", "createdAt": "2020-07-01T14:48:33Z", "commit": {"oid": "d9898d8d5fe02117d98c5098905d08a7e2f602ad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNDo0ODozM1rOGrpNXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwODo1Mjo0MlrOGsDqlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQxNzExNg==", "bodyText": "Returning a Callable here seems quite strange. Why not just pass a lambda in the submit function above?", "url": "https://github.com/OpenNMS/opennms/pull/3036#discussion_r448417116", "createdAt": "2020-07-01T14:48:33Z", "author": {"login": "fooker"}, "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/TimeseriesFetchStrategy.java", "diffHunk": "@@ -167,108 +246,15 @@ public FetchResults fetch(long start, long end, long step, int maxrows, Long int\n                 throw Throwables.propagate(e);\n             }\n         }\n-\n-        // Now group the sources by Newts Resource ID, which differs from the OpenNMS Resource ID.\n-        Map<String, List<Source>> sourcesByNewtsResourceId = Maps.newHashMap();\n-        for (Entry<OnmsResource, List<Source>> entry : sourcesByResource.entrySet()) {\n-            final OnmsResource resource = entry.getKey();\n-            for (Source source : entry.getValue()) {\n-                // Gather the values from strings.properties\n-                Utils.convertStringAttributesToConstants(source.getLabel(), resource.getStringPropertyAttributes(), constants);\n-\n-                resources.add(getResourceInfo(resource, source));\n-\n-                // Grab the attribute that matches the source\n-                RrdGraphAttribute rrdGraphAttribute = resource.getRrdGraphAttributes().get(source.getAttribute());\n-\n-                if (rrdGraphAttribute == null && !Strings.isNullOrEmpty(source.getFallbackAttribute())) {\n-                    LOG.error(\"No attribute with name '{}', using fallback-attribute with name '{}'\", source.getAttribute(), source.getFallbackAttribute());\n-                    source.setAttribute(source.getFallbackAttribute());\n-                    source.setFallbackAttribute(null);\n-                    rrdGraphAttribute = resource.getRrdGraphAttributes().get(source.getAttribute());\n-                }\n-\n-                if (rrdGraphAttribute == null) {\n-                    if (relaxed) continue;\n-                    LOG.error(\"No attribute with name: {}\", source.getAttribute());\n-                    return null;\n-                }\n-\n-                // The Newts Resource ID is stored in the rrdFile attribute\n-                String newtsResourceId = rrdGraphAttribute.getRrdRelativePath();\n-                // Remove the file separator prefix, added by the RrdGraphAttribute class\n-                if (newtsResourceId.startsWith(File.separator)) {\n-                    newtsResourceId = newtsResourceId.substring(File.separator.length(), newtsResourceId.length());\n-                }\n-\n-                List<Source> listOfSources = sourcesByNewtsResourceId.get(newtsResourceId);\n-                // Create the list if it doesn't exist\n-                if (listOfSources == null) {\n-                    listOfSources = Lists.newLinkedList();\n-                    sourcesByNewtsResourceId.put(newtsResourceId, listOfSources);\n-                }\n-                listOfSources.add(source);\n-            }\n-        }\n-\n-        // The Newts API only allows us to perform a query using a single (Newts) Resource ID,\n-        // so we perform multiple queries in parallel, and aggregate the results.\n-        Map<String, Future<Collection<Row<Measurement>>>> measurementsByNewtsResourceId = Maps.newHashMapWithExpectedSize(sourcesByNewtsResourceId.size());\n-        for (Entry<String, List<Source>> entry : sourcesByNewtsResourceId.entrySet()) {\n-            measurementsByNewtsResourceId.put(entry.getKey(), threadPool.submit(\n-                    getMeasurementsForResourceCallable(entry.getKey(), entry.getValue(), startTs, endTs, lag)));\n-        }\n-\n-        long[] timestamps = null;\n-        Map<String, double[]> columns = Maps.newHashMap();\n-\n-        for (Entry<String, Future<Collection<Row<Measurement>>>> entry : measurementsByNewtsResourceId.entrySet()) {\n-            Collection<Row<Measurement>> rows;\n-            try {\n-                rows = entry.getValue().get();\n-            } catch (InterruptedException | ExecutionException e) {\n-                throw Throwables.propagate(e);\n-            }\n-\n-            final int N = rows.size();\n-\n-            if (timestamps == null) {\n-                timestamps = new long[N];\n-                int k = 0;\n-                for (final Row<Measurement> row : rows) {\n-                    timestamps[k] = row.getTimestamp().asMillis();\n-                    k++;\n-                }\n-            }\n-\n-            int k = 0;\n-            for (Row<Measurement> row : rows) {\n-                for (Measurement measurement : row.getElements()) {\n-                    double[] column = columns.get(measurement.getName());\n-                    if (column == null) {\n-                        column = new double[N];\n-                        columns.put(measurement.getName(), column);\n-                    }\n-                    column[k] = measurement.getValue();\n-                }\n-                k += 1;\n-            }\n-        }\n-\n-        FetchResults fetchResults = new FetchResults(timestamps, columns, lag.getStep(), constants, new QueryMetadata(resources));\n-        if (relaxed) {\n-            Utils.fillMissingValues(fetchResults, sources);\n-        }\n-        LOG.trace(\"Fetch results: {}\", fetchResults);\n-        return fetchResults;\n+        return sourcesByResource;\n     }\n \n-    private Callable<Collection<Row<Measurement>>> getMeasurementsForResourceCallable(final String resourceId, final List<Source> listOfSources, final Optional<Timestamp> start, final Optional<Timestamp> end, final LateAggregationParams lag) {\n-        return new Callable<Collection<Row<Measurement>>>() {\n+    private Callable<Map<Source, List<Sample>>> getMeasurementsForResourceCallable(final String resourceId, final List<Source> listOfSources, final Instant start, final Instant end, final LateAggregationParams lag) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9898d8d5fe02117d98c5098905d08a7e2f602ad"}, "originalPosition": 301}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODg1MDU4MA==", "bodyText": "This metric may be not detailed enough. I see two problems here:\n\nThis measures to calls to the implementation which we maybe want to inspect separately.\nWe also measure the time needed to build the list of samples to insert/index.", "url": "https://github.com/OpenNMS/opennms/pull/3036#discussion_r448850580", "createdAt": "2020-07-02T08:52:42Z", "author": {"login": "fooker"}, "path": "features/timeseries/src/main/java/org/opennms/netmgt/timeseries/integration/persistence/TimeseriesPersistOperationBuilder.java", "diffHunk": "@@ -122,8 +122,10 @@ public void setAttributeMetadata(String metricIdentifier, String name) {\n \n     @Override\n     public void commit() {\n-        writer.insert(getSamplesToInsert());\n-        writer.index(getSamplesToIndex());\n+        try(final Timer.Context context = commitTimer.time()) {\n+            writer.insert(getSamplesToInsert());\n+            writer.index(getSamplesToIndex());\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9898d8d5fe02117d98c5098905d08a7e2f602ad"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91e58beea3ae1769dad96405f6e02e1d5a7702d3", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/91e58beea3ae1769dad96405f6e02e1d5a7702d3", "committedDate": "2020-07-02T20:06:22Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: NMS-12747 Add JMX Meters to measure and export performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98551b997c730c72235d83e8c4f50f35108d8586", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/98551b997c730c72235d83e8c4f50f35108d8586", "committedDate": "2020-07-02T20:06:22Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer:     NMS-12749: Remove conversation to Newts objects in read operation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112f351ba178e5880c72943df36aefbe52ca6da4", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/112f351ba178e5880c72943df36aefbe52ca6da4", "committedDate": "2020-07-02T20:06:22Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer:         NMS-12748 Remove unnecessary writes to meta_data table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0416cab4470f1a495d68ee851ca589bf0692f835", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/0416cab4470f1a495d68ee851ca589bf0692f835", "committedDate": "2020-07-02T20:06:23Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer:         clean up code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eb4489fb378d9d9c076c4916989d6f751bed0b8", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/4eb4489fb378d9d9c076c4916989d6f751bed0b8", "committedDate": "2020-07-02T20:06:23Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: remove dependency (and transformations) to Newts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98a1fcc6668f651b0429f5ae36f55b92078122f9", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/98a1fcc6668f651b0429f5ae36f55b92078122f9", "committedDate": "2020-07-02T20:06:23Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: move LateAggregationParams to its own class, move all Newts classes to the aggregation package (which is the only onw that should depend on Newts)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf9447d0a12aeb92849d818b4341e929653ef7e9", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/bf9447d0a12aeb92849d818b4341e929653ef7e9", "committedDate": "2020-07-02T20:06:23Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: address PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fae3b3c8f9fb04babaa0a651a558270bab63077c", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/fae3b3c8f9fb04babaa0a651a558270bab63077c", "committedDate": "2020-07-02T17:20:30Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: address PR comments"}, "afterCommit": {"oid": "bf9447d0a12aeb92849d818b4341e929653ef7e9", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/bf9447d0a12aeb92849d818b4341e929653ef7e9", "committedDate": "2020-07-02T20:06:23Z", "message": "NMS-12731 Optimize Performance of Timeseries Integration Layer: address PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f49d0e59a2bb9f1270fb2149dda6ad050c0752d", "author": {"user": {"login": "patrick-schweizer", "name": "Patrick Schweizer"}}, "url": "https://github.com/OpenNMS/opennms/commit/1f49d0e59a2bb9f1270fb2149dda6ad050c0752d", "committedDate": "2020-07-06T17:13:00Z", "message": "NMS-12731: ResourceDao performance enhancements for the Time Series Storage API"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3680, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}