{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMTQ3Njcy", "number": 1512, "title": "[#1505] isCaughtUp() always returns true for pushing-\"Event Streams\"", "bodyText": "This pull request introduce a minute change in the TrackingEventProcessor#processBatch(Segment, BlockingStream<TrackedEventMessage<?>>) method, namely moving the private checkSegmentCaughtUp method until after the first eventAvailabilityTimeout has been triggered.\nPrior to this change, there was a window of opportunity within which an opened BlockingStream was referred to as empty whilst in actuality events were present. This can only occur of the underlying implementation of the  BlockingStream gets the events pushed (e.g. Axon Server), instead of pulling them itself (e.g. the EmbeddedEventStore). Further more, the checkSegmentCaughtUp validates whether the end of the BlockingStream has been reached and if this was true, the caughtUp flag was set to true. As an empty stream automatically means the end of the stream has been reached, caughtUp was set to true immediately.\nNext to the aforementioned change, a test case has been added which uses some new AssertUtils methods.\nThis pull request resolves issue #1505.", "createdAt": "2020-09-21T09:02:09Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1512", "merged": true, "mergeCommit": {"oid": "e4d7e42029a24841f834f91b08735a0089dc1a1a"}, "closed": true, "closedAt": "2020-09-22T17:35:46Z", "author": {"login": "smcvb"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdKGmoLAH2gAyNDkwMTQ3NjcyOmEwZTZiYjU5ZDYwNjM1M2ViNzRlNmFlMGJjNWUxZDkwOGU1M2RlMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLYuItgFqTQ5MzUxMDc1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0e6bb59d606353eb74e6ae0bc5e1d908e53de12", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/a0e6bb59d606353eb74e6ae0bc5e1d908e53de12", "committedDate": "2020-09-18T14:38:06Z", "message": "Adjust update position of caughtUp flag\n\nWhilst using a RDBMS to provide events to a TEP, the caughtUp flag would\n correctly reflect whenever the segment in question actually caughtUp as\n it proactively retrieves events. When using AxonServer, it is AS' job\n to push the events to the TEP. If pushing events took longer than the\n defined eventAvailabilityTimeout, the caughtUp flag could incorrectly\n show it was caughtUp since the TEP thought not events where present\n whilst it actually was still pending event. Moving the\n checkSegmentCaughtUp() to after handling an actual batch of events more\n directly reflects if the stream is updated.\n\n#1505"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fec3bf30e04f63ad3370013eb0dfe85ed3d697d7", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/fec3bf30e04f63ad3370013eb0dfe85ed3d697d7", "committedDate": "2020-09-21T08:03:46Z", "message": "Merge remote-tracking branch 'origin/axon-4.4.x' into bug/1505"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f72a9aca705de410ee78011a9ca509be0c6aa471", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/f72a9aca705de410ee78011a9ca509be0c6aa471", "committedDate": "2020-09-21T08:40:02Z", "message": "Fine tune testing of validating caughtUp flag\n\nThe original tests used sleeps to wait for a specified amount of time.\nTo mitigate this usage, methods which can assert for a given period of\ntime (with intervals) should be added to the AssertUtils. Further more,\nthese should be used at the right trigger moment, thus when the event\navailability time out kicks in.\n\n#1505"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e4435211d90f89bc4a3510a82a33f60c778b5f0", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/6e4435211d90f89bc4a3510a82a33f60c778b5f0", "committedDate": "2020-09-21T11:50:26Z", "message": "Change event availability timeout\n\nChange event availability timeout to cope with adjusted caughtUp flag\nupdate\n\n#1505"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTk0NTgz", "url": "https://github.com/AxonFramework/AxonFramework/pull/1512#pullrequestreview-492594583", "createdAt": "2020-09-21T13:23:01Z", "commit": {"oid": "6e4435211d90f89bc4a3510a82a33f60c778b5f0"}, "state": "DISMISSED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzoyMzowMVrOHVPv0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzoyMzowMVrOHVPv0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA0MDE0Ng==", "bodyText": "There is a check after the entire if block, so I don't see why there should be one here?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1512#discussion_r492040146", "createdAt": "2020-09-21T13:23:01Z", "author": {"login": "abuijze"}, "path": "messaging/src/main/java/org/axonframework/eventhandling/TrackingEventProcessor.java", "diffHunk": "@@ -437,6 +436,7 @@ private void processBatch(Segment segment, BlockingStream<TrackedEventMessage<?>\n                     return;\n                 }\n             } else {\n+                checkSegmentCaughtUp(segment, eventStream);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e4435211d90f89bc4a3510a82a33f60c778b5f0"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzNTEwNzU0", "url": "https://github.com/AxonFramework/AxonFramework/pull/1512#pullrequestreview-493510754", "createdAt": "2020-09-22T14:18:31Z", "commit": {"oid": "6e4435211d90f89bc4a3510a82a33f60c778b5f0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1787, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}