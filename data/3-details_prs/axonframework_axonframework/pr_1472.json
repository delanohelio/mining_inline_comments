{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NTg0ODkz", "number": 1472, "title": "[#1442] Use UPDATE query on storing a token", "bodyText": "This pull request adjusts the TokenStore#storeToken(TrackingToken, String, int) method for both the JpaTokenStore and the JdbcTokenStore. The current implementation first does a fetch, trying to achieve a token claim if necessary, and only after that the token entry is updated.\nAlthough this works, we can optimize this process by doing an UPDATE query instead, which is exactly what this PR provides. If the UPDATE query yielded zero updates, we move back to the old process of load-then-save.\nThis pull request resolves #1442.", "createdAt": "2020-07-23T09:30:44Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1472", "merged": true, "mergeCommit": {"oid": "e5dff7cd33d6cae00c127448c464c228a141ec11"}, "closed": true, "closedAt": "2020-07-27T12:48:49Z", "author": {"login": "smcvb"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3bUVjAH2gAyNDU1NTg0ODkzOmE1Y2U4MTNmMjdkNmVkZmM4YTc0OGI5YWE1ZjAyMmI4YWZlZDQxNGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5A-5eAH2gAyNDU1NTg0ODkzOjg2OTY1OWI3ZGUyNDI5ZGQxYzlkZDNjMzUyY2ZiNzQ5ZjliNzA4ZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a5ce813f27d6edfc8a748b9aa5f022b8afed414a", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/a5ce813f27d6edfc8a748b9aa5f022b8afed414a", "committedDate": "2020-07-22T14:01:34Z", "message": "Add another getOrDefault method\n\nAdd another getOrDefault method which allows the provisioning of a\nFunction ingesting the verified instance. Alongside that, fine tune\njavadoc a little\n\n#1442"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2a0492a36cdf38458ef14c10e7aefec5842996", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/bb2a0492a36cdf38458ef14c10e7aefec5842996", "committedDate": "2020-07-22T14:02:57Z", "message": "Adjust getTokenType method\n\nMake getTokenType public so that it can be accessed elsewhere.\nAdditionally, check if the set tokenType is null and return null if this\n is the case. Otherwise an exception wil be thrown by the\n SimpleSerializedType constructor\n\n#1442"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2535bc28dc7e20b814b0489ab953878f9a999a30", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/2535bc28dc7e20b814b0489ab953878f9a999a30", "committedDate": "2020-07-22T14:03:51Z", "message": "Introduce update query on storing a token\n\nIntroduce an update query on storing a token. If the update does no\nsucceed, fallback to the old behaviour of fetching the token with a new\nclaim, and than updating it.\n\n#1442"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cecc4d201dca4e5d70606ec579fac243716a42f", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/2cecc4d201dca4e5d70606ec579fac243716a42f", "committedDate": "2020-07-22T14:04:24Z", "message": "Introduce update query on storing a token\n\nIntroduce an update query on storing a token. If the update does no\nsucceed, fallback to the old behaviour of fetching the token with a new\nclaim, and than updating it. Add the creation of the PreparedStatement\nto a protected method, so that users are able to override it.\n\n#1442"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7924fd6f77ab5ec7951f108142ea352489703838", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/7924fd6f77ab5ec7951f108142ea352489703838", "committedDate": "2020-07-23T11:24:47Z", "message": "Merge remote-tracking branch 'origin/master' into feature/1442"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0OTM4OTM3", "url": "https://github.com/AxonFramework/AxonFramework/pull/1472#pullrequestreview-454938937", "createdAt": "2020-07-24T14:35:24Z", "commit": {"oid": "7924fd6f77ab5ec7951f108142ea352489703838"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDozNToyNFrOG2x0ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yNFQxNDozNToyNFrOG2x0ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDA5MjUyMg==", "bodyText": "Is it useful to log.debug for example when it happens?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1472#discussion_r460092522", "createdAt": "2020-07-24T14:35:24Z", "author": {"login": "lfgcampos"}, "path": "messaging/src/main/java/org/axonframework/eventhandling/tokenstore/jpa/JpaTokenStore.java", "diffHunk": "@@ -118,8 +118,31 @@ public void initializeTokenSegments(String processorName, int segmentCount, Trac\n     @Override\n     public void storeToken(TrackingToken token, String processorName, int segment) {\n         EntityManager entityManager = entityManagerProvider.getEntityManager();\n-        TokenEntry tokenEntry = loadToken(processorName, segment, entityManager);\n-        tokenEntry.updateToken(token, serializer);\n+        TokenEntry tokenToStore = new TokenEntry(processorName, segment, token, serializer);\n+        byte[] tokenDataToStore =\n+                getOrDefault(tokenToStore.getSerializedToken(), SerializedObject::getData, new byte[0]);\n+        String tokenTypeToStore = getOrDefault(tokenToStore.getTokenType(), SerializedType::getName, null);\n+\n+        int updatedTokens = entityManager.createQuery(\"UPDATE TokenEntry te SET \"\n+                                                              + \"te.token = :token, \"\n+                                                              + \"te.tokenType = :tokenType, \"\n+                                                              + \"te.timestamp = :timestamp \"\n+                                                              + \"WHERE te.owner = :owner \"\n+                                                              + \"AND te.processorName = :processorName \"\n+                                                              + \"AND te.segment = :segment\")\n+                                         .setParameter(\"token\", tokenDataToStore)\n+                                         .setParameter(\"tokenType\", tokenTypeToStore)\n+                                         .setParameter(\"timestamp\", tokenToStore.timestampAsString())\n+                                         .setParameter(\"owner\", nodeId)\n+                                         .setParameter(\"processorName\", processorName)\n+                                         .setParameter(\"segment\", segment)\n+                                         .executeUpdate();\n+\n+        if (updatedTokens == 0) {\n+            // Update couldn't succeed, trying to first load the token and than update it instead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7924fd6f77ab5ec7951f108142ea352489703838"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a841630bea59adf47d196fcd1ed09ead8e081d1d", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/a841630bea59adf47d196fcd1ed09ead8e081d1d", "committedDate": "2020-07-27T08:10:37Z", "message": "Replace comment for debug logging\n\nReplace comment for debug logging, as that's clearer for the developers\nand users\n\n#1442"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "869659b7de2429dd1c9dd3c352cfb749f9b708d6", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/869659b7de2429dd1c9dd3c352cfb749f9b708d6", "committedDate": "2020-07-27T12:28:28Z", "message": "Add and use executeUpdate method\n\nInstead of using the JdbcUtils#executeUpdates method in the\nJdbcTokenStore, we should add an JdbcUtils#executeUpdate method and use\nthat instead.\n\n#1442"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1771, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}