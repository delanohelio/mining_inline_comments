{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NTQyNDA5", "number": 1656, "title": "[#1469] End Saga when Deadline expires", "bodyText": "This pull request changes when a message handling member in a Saga can end a saga.\nIt does so by adjusting the validation done in the AnnotatedSaga, to simply check whether a MessageHandlingMember contains the @EndSaga annotation.\nAs an AnnotatedSaga can only be invoked for message handling through EventMessages and DeadlineMessages, I deemed this adjusted easier than introduce a new Handler Enhancer Definition for this exact combination. Or, adjusting the DeadlineMethodMessageHandlerDefinition to include specifics about Sagas, which I feel don't belong there.\nTests have been included from the perspective of a SagaTestFixture, as well as the DeadlineManager test suite.\nAs such, this PR resolves #1469", "createdAt": "2020-12-29T16:00:50Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656", "merged": true, "mergeCommit": {"oid": "7bce0c4d42baf0f5250f6fac5b5de24ca77c4e23"}, "closed": true, "closedAt": "2021-01-18T16:24:10Z", "author": {"login": "smcvb"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdq81VkgH2gAyNTQ2NTQyNDA5OmE0MDRmNzcxZGE4MjZhZjMwNDM4MTRiZjg2YzYyNTQ5NDBjMDdhMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdxZNoBAFqTU3MDYzNTQzOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a404f771da826af3043814bf86c6254940c07a04", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/a404f771da826af3043814bf86c6254940c07a04", "committedDate": "2020-12-29T15:54:37Z", "message": "Allow EndSaga on other MessageHandlingMembers\n\nAdjust the isEndingHandler validation to simply validate the existence\nof the EndSaga annotation. Doing so opens up this annotation to be\nplaced on DeadlineHandler annotated methods too. Tests/assertions should\n be included to validate a Saga to be ended on a deadline handler yes/no\n\n#1469"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cc7ce8532eea2c537edd2f7985584ae2bdee916", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/2cc7ce8532eea2c537edd2f7985584ae2bdee916", "committedDate": "2020-12-29T15:55:49Z", "message": "Add DeadlineManager centric validation\n\nAdd assertions to the deadline manager test suite which validate the\n\"life\" of a Saga when using deadlines\n\n#1469"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1Njc4NDY2", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#pullrequestreview-565678466", "createdAt": "2021-01-11T19:39:17Z", "commit": {"oid": "2cc7ce8532eea2c537edd2f7985584ae2bdee916"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxOTozOToxN1rOIRkWpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxOTozOToxN1rOIRkWpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTI5MjMyNw==", "bodyText": "for backwards compatibility, wouldn't it be better to check for the SagaMethodMessageHandlingMember::isEndingHandler and in the orElse do the handler.hasAnnotation(EndSaga.class).\nI also think that the isEndingHandler is invoked for each Saga Handler invocation. I'm wondering if it wouldn't be better to wrap an Event Handler annotated with @EndSaga with the behavior to end the Saga using SagaLifecycle.end()", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#discussion_r555292327", "createdAt": "2021-01-11T19:39:17Z", "author": {"login": "abuijze"}, "path": "modelling/src/main/java/org/axonframework/modelling/saga/AnnotatedSaga.java", "diffHunk": "@@ -131,9 +131,7 @@ private Object handle(MessageHandlingMember<? super T> handler, EventMessage<?>\n     }\n \n     private Boolean isEndingHandler(MessageHandlingMember<? super T> handler) {\n-        return handler.unwrap(SagaMethodMessageHandlingMember.class)\n-                      .map(SagaMethodMessageHandlingMember::isEndingHandler)\n-                      .orElse(false);\n+        return handler.hasAnnotation(EndSaga.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cc7ce8532eea2c537edd2f7985584ae2bdee916"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1Njk1NDAw", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#pullrequestreview-565695400", "createdAt": "2021-01-11T20:03:49Z", "commit": {"oid": "2cc7ce8532eea2c537edd2f7985584ae2bdee916"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34972b2a28b7a14466d2f54bc2fcd26d35cc6553", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/34972b2a28b7a14466d2f54bc2fcd26d35cc6553", "committedDate": "2021-01-15T13:11:45Z", "message": "Add HandlerEnhancerDefinition for EndSaga\n\nIntroduce a HandlerEnhancerDefinition which wraps handlers annotated\nwith EndSaga. When wrapping, the handle method should invoke\nSagaLifecycle.end() prior to returning the result. This allows for the\ndeprecation of the SagaMethodMessageHandlingMember#isEndingHandler\nmethod, as well as the removal of validating if it's an ending handler\ninside the AnnotatedAggregate\n\n#1469"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY5MjkxOTM3", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#pullrequestreview-569291937", "createdAt": "2021-01-15T14:12:09Z", "commit": {"oid": "34972b2a28b7a14466d2f54bc2fcd26d35cc6553"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNDoxMjowOVrOIUd2og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQxNDoxNDoyN1rOIUd73w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODMzMTU1NA==", "bodyText": "The previous behavior was to also call end() when an exception is thrown. Since end() is only actually executed on when the UoW commits, it leaves it up to the configuration to decide whether the exception is a reason to roll back.\nSo I suggest:\ntry {\n    Object result = super.handle(message, target);\n} finally {\n    Sagalifecycle.end();\n}", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#discussion_r558331554", "createdAt": "2021-01-15T14:12:09Z", "author": {"login": "abuijze"}, "path": "modelling/src/main/java/org/axonframework/modelling/saga/EndSagaMessageHandlerDefinition.java", "diffHunk": "@@ -0,0 +1,48 @@\n+package org.axonframework.modelling.saga;\n+\n+import org.axonframework.messaging.Message;\n+import org.axonframework.messaging.annotation.HandlerEnhancerDefinition;\n+import org.axonframework.messaging.annotation.MessageHandlingMember;\n+import org.axonframework.messaging.annotation.WrappedMessageHandlingMember;\n+\n+/**\n+ * A {@link HandlerEnhancerDefinition} inspecting the existence of the {@link EndSaga} annotation on {@link\n+ * MessageHandlingMember}s. If present, the given {@code MessageHandlingMember} will be wrapped in a {@link\n+ * EndSageMessageHandlingMember}.\n+ *\n+ * @author Steven van Beelen\n+ * @since 4.5\n+ */\n+public class EndSagaMessageHandlerDefinition implements HandlerEnhancerDefinition {\n+\n+    @Override\n+    public <T> MessageHandlingMember<T> wrapHandler(MessageHandlingMember<T> original) {\n+        return original.hasAnnotation(EndSaga.class) ? new EndSageMessageHandlingMember<>(original) : original;\n+    }\n+\n+    /**\n+     * A {@link WrappedMessageHandlingMember} implementation dedicated towards {@link MessageHandlingMember}s annotated\n+     * with {@link EndSaga}. After invocation of the {@link #handle(Message, Object)} method, the saga's is ended\n+     * through the {@link SagaLifecycle#end()} method.\n+     *\n+     * @param <T> the entity type wrapped by this {@link MessageHandlingMember}\n+     */\n+    public static class EndSageMessageHandlingMember<T> extends WrappedMessageHandlingMember<T> {\n+\n+        /**\n+         * Initializes the member using the given {@code delegate}.\n+         *\n+         * @param delegate the actual message handling member to delegate to\n+         */\n+        protected EndSageMessageHandlingMember(MessageHandlingMember<T> delegate) {\n+            super(delegate);\n+        }\n+\n+        @Override\n+        public Object handle(Message<?> message, T target) throws Exception {\n+            Object result = super.handle(message, target);\n+            SagaLifecycle.end();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34972b2a28b7a14466d2f54bc2fcd26d35cc6553"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1ODMzMjg5NQ==", "bodyText": "If you are concerned about backwards compatibility on this one, then simply ignoring the value here isn't an option. It will change the behavior to a degree that you'd much rather have a compilation error.\nSince this is not likely to be a component others use directly, I suggest removing the constructor instead.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#discussion_r558332895", "createdAt": "2021-01-15T14:14:27Z", "author": {"login": "abuijze"}, "path": "modelling/src/main/java/org/axonframework/modelling/saga/SagaMethodMessageHandlingMember.java", "diffHunk": "@@ -46,10 +46,16 @@\n      * @param associationPropertyName The association property name to look up in the message\n      * @param associationResolver     The association resolver configured for this handler\n      * @param endingHandler           Flag to indicate if an invocation of the given handler should end the saga\n+     * @deprecated in favour of the constructor not providing the {@code endingHandler} parameter, since that parameter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34972b2a28b7a14466d2f54bc2fcd26d35cc6553"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fee1356aa7960bb1d063e147629c6d2c449b5934", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/fee1356aa7960bb1d063e147629c6d2c449b5934", "committedDate": "2021-01-15T14:48:25Z", "message": "Address review comments\n\n- Invoke SagaLifecycle.end in try-finally block\n- Remove deprecated constructor, as chances are slim anybody is using it\n\n#1469"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNTU3MjIw", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#pullrequestreview-570557220", "createdAt": "2021-01-18T14:49:22Z", "commit": {"oid": "fee1356aa7960bb1d063e147629c6d2c449b5934"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxNDo0OToyMlrOIVsX3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xOFQxNDo0OToyMlrOIVsX3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1OTYxODAxMg==", "bodyText": "Deprecating this doesn't make sense. The method is set to return false in any case. That breaks backward compatibility already. Rather break it through a compilation error, than through a subtle change at runtime.\nSince this is not a public API method, I suggest removing the it.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#discussion_r559618012", "createdAt": "2021-01-18T14:49:22Z", "author": {"login": "abuijze"}, "path": "modelling/src/main/java/org/axonframework/modelling/saga/SagaMethodMessageHandlingMember.java", "diffHunk": "@@ -91,10 +90,12 @@ public SagaCreationPolicy getCreationPolicy() {\n     /**\n      * Indicates whether this handler is one that ends the Saga lifecycle\n      *\n-     * @return {@code true} if the Saga lifecycle ends unconditionally after this call, otherwise\n-     * {@code false}\n+     * @return {@code true} if the Saga lifecycle ends unconditionally after this call, otherwise {@code false}\n+     * @deprecated in favor of the dedicated {@link EndSagaMessageHandlerDefinition} and {@link\n+     * EndSagaMessageHandlerDefinition.EndSageMessageHandlingMember}\n      */\n+    @Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fee1356aa7960bb1d063e147629c6d2c449b5934"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aaabcfe5af21dd5a9c01a39f98bb1a4f77d9d1e9", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/aaabcfe5af21dd5a9c01a39f98bb1a4f77d9d1e9", "committedDate": "2021-01-18T16:02:28Z", "message": "Remove deprecated method\n\nRemove deprecated method as we assume nobody is using this any how\n\n#1469"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTcwNjM1NDM4", "url": "https://github.com/AxonFramework/AxonFramework/pull/1656#pullrequestreview-570635438", "createdAt": "2021-01-18T16:22:02Z", "commit": {"oid": "aaabcfe5af21dd5a9c01a39f98bb1a4f77d9d1e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2053, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}