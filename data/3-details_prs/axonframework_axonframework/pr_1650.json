{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQzNDg5ODY1", "number": 1650, "title": "[#1647] Replace CI Services for Test Containers", "bodyText": "This pull request adjusts the Oracle11SagaSqlSchemaTest, Oracle11EventTableFactoryTest and the MysqlJdbcEventStorageEngineTest to spin up a Test Container to run Oracle-XE and MySQL.\nPreviously these tests assumed Oracle/MySQL was running on the background.\nThe intent of this PR is to keep the GitHub actions introduced recently simple.\nTo achieve this, we did not want to include spinning up MySQL or Oracle up and instead opted for Test Containers.\nThis pull request resolves #1647", "createdAt": "2020-12-21T13:39:01Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650", "merged": true, "mergeCommit": {"oid": "2c3c16442fe58f6bb9905aedf5498244591b9494"}, "closed": true, "closedAt": "2020-12-23T12:29:59Z", "author": {"login": "smcvb"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdoVyDYgH2gAyNTQzNDg5ODY1OmNkZTdlNzg2NTBkYzdmZmNkZDliN2Q1N2MwODFkY2U3YjZjMmYwNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdo9EkGAFqTU1Nzc5OTA0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cde7e78650dc7ffcdd9b7d57c081dce7b6c2f071", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/cde7e78650dc7ffcdd9b7d57c081dce7b6c2f071", "committedDate": "2020-12-21T13:16:53Z", "message": "Introduce mysql test container\n\nIntroduce a mysql test container to replace the expectation of MySQL\nrunning in the background during tests\n\n#1647"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26c6b372df0a19ae457944d37da1185f43b93a2f", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/26c6b372df0a19ae457944d37da1185f43b93a2f", "committedDate": "2020-12-21T13:17:35Z", "message": "Add test containers version to properties\n\nAdd the test containers version used to the properties section in the\nmain pom\n\n#1647"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e6aa96620d2b48db8f985f01970207ce1b8f19f", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/6e6aa96620d2b48db8f985f01970207ce1b8f19f", "committedDate": "2020-12-21T13:18:42Z", "message": "Introduce Oracle test container\n\nIntroduce an Oracle test container to replace the expectation of\nOracle11g/OracleXE running in the background during tests\n\n#1647"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDY5OTIx", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#pullrequestreview-556469921", "createdAt": "2020-12-21T15:39:11Z", "commit": {"oid": "6e6aa96620d2b48db8f985f01970207ce1b8f19f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNTozOToxMlrOIJcgqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNTozOToxMlrOIJcgqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Njc3NTIxMA==", "bodyText": "With current approach we should be able to remove this try-catch block, right?\nSame applies for the other 2 tests.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r546775210", "createdAt": "2020-12-21T15:39:12Z", "author": {"login": "lfgcampos"}, "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/eventstore/jdbc/MysqlJdbcEventStorageEngineTest.java", "diffHunk": "@@ -36,56 +37,58 @@\n  *\n  * @author Albert Attard (JavaCreed)\n  */\n+@Testcontainers\n class MysqlJdbcEventStorageEngineTest {\n \n-    private MysqlDataSource dataSource;\n+    @Container\n+    private static final MySQLContainer<?> MYSQL_CONTAINER = new MySQLContainer<>(\"mysql\")\n+            .withDatabaseName(\"axon\")\n+            .withUsername(\"admin\")\n+            .withPassword(\"some-password\");\n+\n     private JdbcEventStorageEngine testSubject;\n \n     @BeforeEach\n-    void setUp() throws Exception {\n-        /* Load the DB properties */\n-        final Properties properties = new Properties();\n-        properties.load(getClass().getResourceAsStream(\"/mysql.test.database.properties\"));\n-\n-        dataSource = new MysqlDataSource();\n-        dataSource.setUrl(properties.getProperty(\"jdbc.url\"));\n-        dataSource.setUser(properties.getProperty(\"jdbc.username\"));\n-        dataSource.setPassword(properties.getProperty(\"jdbc.password\"));\n+    void setUp() {\n+        MysqlDataSource dataSource = new MysqlDataSource();\n+        dataSource.setUrl(MYSQL_CONTAINER.getJdbcUrl());\n+        dataSource.setUser(MYSQL_CONTAINER.getUsername());\n+        dataSource.setPassword(MYSQL_CONTAINER.getPassword());\n         try {\n-            testSubject = createEngine(new SQLErrorCodesResolver(dataSource));\n+            testSubject = createEngine(dataSource);\n         } catch (Exception e) {\n             throw new TestAbortedException(\"Ignoring this test, as no valid MySQL instance is configured\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e6aa96620d2b48db8f985f01970207ce1b8f19f"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0276949973877024eba894a5096d0dde9a258047", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/0276949973877024eba894a5096d0dde9a258047", "committedDate": "2020-12-22T16:32:20Z", "message": "Remove try-catch blocks when creating a connection\n\nTest containers should simply succeed, so we can remove the try-catch\naround the connection creation in the test\n\n#1647"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08b7d53192afce227f9b615c5c08ea78f22b2a2e", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/08b7d53192afce227f9b615c5c08ea78f22b2a2e", "committedDate": "2020-12-22T17:09:53Z", "message": "Add env setting to Oracle container\n\nDefine that the Oracle-XE container should not set the timezone with\nregion info, as github actions do not start a container with region\ninformation\n\n#1647"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3MjQ5MzMy", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#pullrequestreview-557249332", "createdAt": "2020-12-22T17:37:05Z", "commit": {"oid": "08b7d53192afce227f9b615c5c08ea78f22b2a2e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzozNzowNVrOIKDNNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMlQxNzozNzowNVrOIKDNNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzQwOTIwNw==", "bodyText": "You have to set it on the connection (few lines below, on setUp)", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#discussion_r547409207", "createdAt": "2020-12-22T17:37:05Z", "author": {"login": "lfgcampos"}, "path": "integrationtests/src/test/java/org/axonframework/integrationtests/eventsourcing/eventstore/jdbc/Oracle11EventTableFactoryTest.java", "diffHunk": "@@ -18,32 +18,43 @@\n \n import org.axonframework.eventsourcing.eventstore.jdbc.EventSchema;\n import org.axonframework.eventsourcing.eventstore.jdbc.Oracle11EventTableFactory;\n-import org.junit.jupiter.api.AfterEach;\n-import org.junit.jupiter.api.BeforeEach;\n-import org.junit.jupiter.api.Test;\n-import org.opentest4j.TestAbortedException;\n+import org.junit.jupiter.api.*;\n+import org.testcontainers.containers.OracleContainer;\n+import org.testcontainers.junit.jupiter.Container;\n+import org.testcontainers.junit.jupiter.Testcontainers;\n \n import java.sql.Connection;\n import java.sql.DriverManager;\n import java.sql.SQLException;\n \n import static org.axonframework.common.io.IOUtils.closeQuietly;\n \n+/**\n+ * Integration test class validating the {@link Oracle11EventTableFactory}.\n+ *\n+ * @author Joris van der Kallen\n+ */\n+@SuppressWarnings({\"SqlDialectInspection\", \"SqlNoDataSourceInspection\"})\n+@Testcontainers\n class Oracle11EventTableFactoryTest {\n \n+    private static final String USERNAME = \"system\";\n+    private static final String PASSWORD = \"oracle\";\n+\n+    @Container\n+    private static final OracleContainer ORACLE_CONTAINER = new OracleContainer(\"gautamsaggar/oracle11g:v2\")\n+            //Disable oracle.jdbc.timezoneAsRegion as when on true GHA fails to run this test due to missing region-info\n+            .withEnv(\"oracle.jdbc.timezoneAsRegion\", \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08b7d53192afce227f9b615c5c08ea78f22b2a2e"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e776c36b320561d54895eb0ba1b50b95cb2cd7", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/05e776c36b320561d54895eb0ba1b50b95cb2cd7", "committedDate": "2020-12-23T08:17:24Z", "message": "Move property to connection creation\n\nMove the timeezoneAsRegion property to the connection, as Lucas assumes\nthat to resolve the problem.\n\n#1647"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3Nzk5MDQ4", "url": "https://github.com/AxonFramework/AxonFramework/pull/1650#pullrequestreview-557799048", "createdAt": "2020-12-23T11:03:24Z", "commit": {"oid": "05e776c36b320561d54895eb0ba1b50b95cb2cd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2049, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}