{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM0MzcwMTU0", "number": 1448, "reviewThreads": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODozOTozNVrOEFcVFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxNTo0MFrOEHHL1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTQyNDg0OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODozOTozNVrOGjojYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwODozOTozNVrOGjojYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAxNzc2Mg==", "bodyText": "Should we do this? It will break some Grafana Dashboards, but make sense to have processor names as tags/dimensions.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440017762", "createdAt": "2020-06-15T08:39:35Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -94,7 +97,13 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      */\n     public MessageMonitor<? extends Message<?>> registerComponent(Class<?> componentType, String componentName) {\n         if (EventProcessor.class.isAssignableFrom(componentType)) {\n-            return registerEventProcessor(componentName);\n+            // TODO This will introduce a breaking change on the metrics API level, as it will change the name of the metrics.\n+            // The name of the metrics is fixed to \"eventProcessor\" now, and the processor name is not part/prefix of the metrics name any more. It is a meter tag/dimension now.\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTUxNDIxOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTowMjozOVrOGjpZww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTowMjozOVrOGjpZww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzMTY4Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates a capacity monitor with the default system clock\n          \n          \n            \n                 * Creates a capacity monitor with the default system clock.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440031683", "createdAt": "2020-06-15T09:02:39Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "diffHunk": "@@ -61,15 +70,43 @@ public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the created capacity monitor\n+     */\n+    public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                               Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        return buildMonitor(meterNamePrefix, meterRegistry, 10, TimeUnit.MINUTES, tagsBuilder);\n+    }\n+\n+    /**\n+     * Creates a capacity monitor with the default system clock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTUxNDY2OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTowMjo0N1rOGjpaCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTowMjo0N1rOGjpaCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzMTc1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates a capacity monitor with the default system clock\n          \n          \n            \n                 * Creates a capacity monitor with the default system clock.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440031752", "createdAt": "2020-06-15T09:02:47Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "diffHunk": "@@ -61,15 +70,43 @@ public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the created capacity monitor\n+     */\n+    public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                               Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        return buildMonitor(meterNamePrefix, meterRegistry, 10, TimeUnit.MINUTES, tagsBuilder);\n+    }\n+\n+    /**\n+     * Creates a capacity monitor with the default system clock\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n      * @param window          The length of the window to measure the capacity over\n      * @param timeUnit        The temporal unit of the time window\n-     * @return the created capacity monitor\n+     * @return the created capacity monitor (with the default tag `payloadType`)\n      */\n     public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, long window,\n                                                TimeUnit timeUnit) {\n         return buildMonitor(meterNamePrefix, meterRegistry, window, timeUnit, Clock.SYSTEM);\n     }\n \n+    /**\n+     * Creates a capacity monitor with the default system clock", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTU0NzA5OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToxMTozMFrOGjptmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDo1MDo0NVrOGjtCvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzNjc2Mg==", "bodyText": "If my mind serves me right, you can do a putIfAbsent on the timeWindowedDurationMeasurementsMap too, like so:\nreturn timeWindowedDurationMeasurementsMap.putIfAbsent(key, new SlidingTimeWindowReservoir(window, timeUnit, clock));", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440036762", "createdAt": "2020-06-15T09:11:30Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "diffHunk": "@@ -79,26 +116,87 @@ public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry\n      * @param window          The length of the window to measure the capacity over\n      * @param timeUnit        The temporal unit of the time window\n      * @param clock           The clock used to measure the process time per message\n-     * @return the created capacity monitor\n+     * @return the created capacity monitor (with the default tag `payloadType`)\n      */\n     public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, long window,\n                                                TimeUnit timeUnit, Clock clock) {\n-        CapacityMonitor capacityMonitor = new CapacityMonitor(window, timeUnit, clock);\n-        meterRegistry.gauge(meterNamePrefix + \".capacity\", capacityMonitor, CapacityMonitor::calculateCapacity);\n-        return capacityMonitor;\n+\n+        return new CapacityMonitor(window, timeUnit, clock, meterNamePrefix, meterRegistry);\n     }\n \n+    /**\n+     * Creates a capacity monitor with the given time window. Uses the provided clock\n+     * to measure process time per message.\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param window          The length of the window to measure the capacity over\n+     * @param timeUnit        The temporal unit of the time window\n+     * @param clock           The clock used to measure the process time per message\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the created capacity monitor\n+     */\n+    public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, long window,\n+                                               TimeUnit timeUnit, Clock clock,\n+                                               Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+\n+        return new CapacityMonitor(window, timeUnit, clock, meterNamePrefix, meterRegistry, tagsBuilder);\n+    }\n+\n+\n+    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock, String meterNamePrefix,\n+                            MeterRegistry meterRegistry) {\n+        this(window,\n+             timeUnit,\n+             clock,\n+             meterNamePrefix,\n+             meterRegistry,\n+             message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG, message.getPayloadType().getSimpleName()));\n+    }\n \n-    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock) {\n-        this.timeWindowedDurationMeasurements = new SlidingTimeWindowReservoir(window, timeUnit, clock);\n+    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock, String meterNamePrefix,\n+                            MeterRegistry meterRegistry,\n+                            Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        this.timeWindowedDurationMeasurementsMap = new ConcurrentHashMap<>();\n         this.timeUnit = timeUnit;\n         this.clock = clock;\n         this.window = window;\n+        this.meterNamePrefix = meterNamePrefix;\n+        this.meterRegistry = meterRegistry;\n+        this.tagsBuilder = tagsBuilder;\n+    }\n+\n+    private SlidingTimeWindowReservoir createIfAbsent(String meterNamePrefix, Tags tags, long window, TimeUnit timeUnit,\n+                                                      Clock clock) {\n+        String key = meterNamePrefix + tags.stream()\n+                                           .map(tag -> tag.getKey() + tag.getValue())\n+                                           .reduce(String::concat)\n+                                           .orElse(\"\");\n+        SlidingTimeWindowReservoir value;\n+        if ((value = timeWindowedDurationMeasurementsMap.get(key)) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MTMyNA==", "bodyText": "will give it a try Steven, thanks!\nTo give more context behind this map: The metrics in Micrometer is uniquely identified by the combination of the metrics name and tags (key-value). This map is introduced in order to have an independent SlidingTimeWindowReservoir for each metrics/meter.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440091324", "createdAt": "2020-06-15T10:50:45Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/CapacityMonitor.java", "diffHunk": "@@ -79,26 +116,87 @@ public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry\n      * @param window          The length of the window to measure the capacity over\n      * @param timeUnit        The temporal unit of the time window\n      * @param clock           The clock used to measure the process time per message\n-     * @return the created capacity monitor\n+     * @return the created capacity monitor (with the default tag `payloadType`)\n      */\n     public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, long window,\n                                                TimeUnit timeUnit, Clock clock) {\n-        CapacityMonitor capacityMonitor = new CapacityMonitor(window, timeUnit, clock);\n-        meterRegistry.gauge(meterNamePrefix + \".capacity\", capacityMonitor, CapacityMonitor::calculateCapacity);\n-        return capacityMonitor;\n+\n+        return new CapacityMonitor(window, timeUnit, clock, meterNamePrefix, meterRegistry);\n     }\n \n+    /**\n+     * Creates a capacity monitor with the given time window. Uses the provided clock\n+     * to measure process time per message.\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param window          The length of the window to measure the capacity over\n+     * @param timeUnit        The temporal unit of the time window\n+     * @param clock           The clock used to measure the process time per message\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the created capacity monitor\n+     */\n+    public static CapacityMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, long window,\n+                                               TimeUnit timeUnit, Clock clock,\n+                                               Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+\n+        return new CapacityMonitor(window, timeUnit, clock, meterNamePrefix, meterRegistry, tagsBuilder);\n+    }\n+\n+\n+    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock, String meterNamePrefix,\n+                            MeterRegistry meterRegistry) {\n+        this(window,\n+             timeUnit,\n+             clock,\n+             meterNamePrefix,\n+             meterRegistry,\n+             message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG, message.getPayloadType().getSimpleName()));\n+    }\n \n-    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock) {\n-        this.timeWindowedDurationMeasurements = new SlidingTimeWindowReservoir(window, timeUnit, clock);\n+    private CapacityMonitor(long window, TimeUnit timeUnit, Clock clock, String meterNamePrefix,\n+                            MeterRegistry meterRegistry,\n+                            Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        this.timeWindowedDurationMeasurementsMap = new ConcurrentHashMap<>();\n         this.timeUnit = timeUnit;\n         this.clock = clock;\n         this.window = window;\n+        this.meterNamePrefix = meterNamePrefix;\n+        this.meterRegistry = meterRegistry;\n+        this.tagsBuilder = tagsBuilder;\n+    }\n+\n+    private SlidingTimeWindowReservoir createIfAbsent(String meterNamePrefix, Tags tags, long window, TimeUnit timeUnit,\n+                                                      Clock clock) {\n+        String key = meterNamePrefix + tags.stream()\n+                                           .map(tag -> tag.getKey() + tag.getValue())\n+                                           .reduce(String::concat)\n+                                           .orElse(\"\");\n+        SlidingTimeWindowReservoir value;\n+        if ((value = timeWindowedDurationMeasurementsMap.get(key)) == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzNjc2Mg=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTU2MzI5OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/EventProcessorLatencyMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToxNTo1MFrOGjp3vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToxNTo1MFrOGjp3vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDAzOTM1OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates an event processor latency monitor\n          \n          \n            \n                 * Creates an event processor latency monitor.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440039358", "createdAt": "2020-06-15T09:15:50Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/EventProcessorLatencyMonitor.java", "diffHunk": "@@ -46,19 +65,36 @@ private EventProcessorLatencyMonitor() {\n      * @return the created event processor latency monitor\n      */\n     public static EventProcessorLatencyMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry) {\n-        EventProcessorLatencyMonitor eventProcessorLatencyMonitor = new EventProcessorLatencyMonitor();\n-        Gauge.builder(meterNamePrefix + \".latency\",\n-                      eventProcessorLatencyMonitor,\n-                      EventProcessorLatencyMonitor::calculateLatency).register(meterRegistry);\n-        return eventProcessorLatencyMonitor;\n+        return new EventProcessorLatencyMonitor(meterNamePrefix, meterRegistry);\n+    }\n+\n+    /**\n+     * Creates an event processor latency monitor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTU4NjczOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToyMTo1MFrOGjqGFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDo1MTo1M1rOGjtExg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0MzAzMQ==", "bodyText": "When deprecating a method it should be clear in the javadoc what method/logic should replace this one.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440043031", "createdAt": "2020-06-15T09:21:50Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -118,6 +127,7 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      * @param name the name under which the EventProcessor should be registered to the registry\n      * @return MessageMonitor to monitor the behavior of an EventProcessor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5MTg0Ng==", "bodyText": "Yes, the initial idea is to use registerEventProcessor(String name, Function<Message<?>, Iterable> tagsBuilder) instead. I would be fine by removing @deprecated as well.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440091846", "createdAt": "2020-06-15T10:51:53Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -118,6 +127,7 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      * @param name the name under which the EventProcessor should be registered to the registry\n      * @return MessageMonitor to monitor the behavior of an EventProcessor", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0MzAzMQ=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTYxMzEwOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOToyOToxM1rOGjqWzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxMDoxMFrOGmUQ_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NzMwOA==", "bodyText": "Understand you're doing this, but I don't think this is overly ideal...\nWhat about we add a toggle in the GlobalMetricRegistry to use dimensions yes/no?\nSo by default, we'd use the old approach, and only if somebody builds a new GlobalMetricRegistry(metricRegistry, {yes-to-dimensions!}) will this dimension logic be added? That way, users can switch it on for the command, event and query bus too through the GlobalMetricRegistry.\nGoing a step further by looking at spring auto configuration, this could be a property to be set on an application.properties/application.yml, making it even easier. Adding this could be done on the MetricsProperties class, but first a subclass Micrometer should be added to specify the config is for Micrometer only.\nWhat do you think?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440047308", "createdAt": "2020-06-15T09:29:13Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -94,7 +97,13 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      */\n     public MessageMonitor<? extends Message<?>> registerComponent(Class<?> componentType, String componentName) {\n         if (EventProcessor.class.isAssignableFrom(componentType)) {\n-            return registerEventProcessor(componentName);\n+            // TODO This will introduce a breaking change on the metrics API level, as it will change the name of the metrics.\n+            // The name of the metrics is fixed to \"eventProcessor\" now, and the processor name is not part/prefix of the metrics name any more. It is a meter tag/dimension now.\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA3Nzc4NA==", "bodyText": "hmm, I guess we can externalize the property to handle this. Please note that this is the only place we are not backward compatible with the metrics API level. Here, we are changing the name of the event processor metrics. For example, the old names were: MyProcessorName1.ingestedCounter ,  MyProcessorName2.ingestedCounter. The new metrics: eventProcessor.ingestedCounter{processorType=MyProcessorName1}, eventProcessor.ingestedCounter{processorType=MyProcessorName2} The thing is that the name-prefix of these metrics is general/fixed now with eventProcessor and the name of the processor is a Tag/Dimension now. So, this externalized property can mark if you want to use old hierarchical names of the event processor metrics, or you use the processor name as a Tag/Dimension (which should be a default, in my opinion, there is more power in it).", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440077784", "createdAt": "2020-06-15T10:23:30Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -94,7 +97,13 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      */\n     public MessageMonitor<? extends Message<?>> registerComponent(Class<?> componentType, String componentName) {\n         if (EventProcessor.class.isAssignableFrom(componentType)) {\n-            return registerEventProcessor(componentName);\n+            // TODO This will introduce a breaking change on the metrics API level, as it will change the name of the metrics.\n+            // The name of the metrics is fixed to \"eventProcessor\" now, and the processor name is not part/prefix of the metrics name any more. It is a meter tag/dimension now.\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NzMwOA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTc2Mjc5NQ==", "bodyText": "GlobalMetricRegistry.registerWithConfigurerWithDefaultTags has been added to enable usage of Tags/Dimensions. This is backward compatible. MetricsProperties is altered by adding axon.metrics.micrometer.dimensional property to mark if Dimensions/Tags should be used or not. By default, Dimensions/Tags are NOT used.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r441762795", "createdAt": "2020-06-17T18:54:31Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -94,7 +97,13 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      */\n     public MessageMonitor<? extends Message<?>> registerComponent(Class<?> componentType, String componentName) {\n         if (EventProcessor.class.isAssignableFrom(componentType)) {\n-            return registerEventProcessor(componentName);\n+            // TODO This will introduce a breaking change on the metrics API level, as it will change the name of the metrics.\n+            // The name of the metrics is fixed to \"eventProcessor\" now, and the processor name is not part/prefix of the metrics name any more. It is a meter tag/dimension now.\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NzMwOA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMTEwMQ==", "bodyText": "Awesome work @idugalic!", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442831101", "createdAt": "2020-06-19T13:10:10Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -94,7 +97,13 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n      */\n     public MessageMonitor<? extends Message<?>> registerComponent(Class<?> componentType, String componentName) {\n         if (EventProcessor.class.isAssignableFrom(componentType)) {\n-            return registerEventProcessor(componentName);\n+            // TODO This will introduce a breaking change on the metrics API level, as it will change the name of the metrics.\n+            // The name of the metrics is fixed to \"eventProcessor\" now, and the processor name is not part/prefix of the metrics name any more. It is a meter tag/dimension now.\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0NzMwOA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTYxNjYwOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTozMDowN1rOGjqY4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDo1Njo1NlrOGjtOvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0Nzg0MQ==", "bodyText": "Any reasons why you aren't providing the tagsBuilder to the EventProcessorLatencyMonitor#buildMonitor method?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440047841", "createdAt": "2020-06-15T09:30:07Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -133,6 +143,33 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return new MultiMessageMonitor<>(monitors);\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor an {@link EventProcessor}. The monitor will be registered with\n+     * the registry under the given {@code name}. The returned {@link MessageMonitor} can be installed\n+     * on the event processor to initiate the monitoring.\n+     *\n+     * @param name        The name under which the EventProcessor should be registered to the registry\n+     * @param tagsBuilder The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return The messageMonitor to monitor the behavior of an EventProcessor\n+     */\n+    public MessageMonitor<? super EventMessage<?>> registerEventProcessor(String name,\n+                                                                          Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        MessageTimerMonitor messageTimerMonitor = MessageTimerMonitor.buildMonitor(name, registry, tagsBuilder);\n+        EventProcessorLatencyMonitor eventProcessorLatencyMonitor = EventProcessorLatencyMonitor.buildMonitor(name,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA5NDM5OQ==", "bodyText": "ahh, good catch. No reason :)", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440094399", "createdAt": "2020-06-15T10:56:56Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -133,6 +143,33 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return new MultiMessageMonitor<>(monitors);\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor an {@link EventProcessor}. The monitor will be registered with\n+     * the registry under the given {@code name}. The returned {@link MessageMonitor} can be installed\n+     * on the event processor to initiate the monitoring.\n+     *\n+     * @param name        The name under which the EventProcessor should be registered to the registry\n+     * @param tagsBuilder The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return The messageMonitor to monitor the behavior of an EventProcessor\n+     */\n+    public MessageMonitor<? super EventMessage<?>> registerEventProcessor(String name,\n+                                                                          Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        MessageTimerMonitor messageTimerMonitor = MessageTimerMonitor.buildMonitor(name, registry, tagsBuilder);\n+        EventProcessorLatencyMonitor eventProcessorLatencyMonitor = EventProcessorLatencyMonitor.buildMonitor(name,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0Nzg0MQ=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTYxOTU4OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTozMDo1NVrOGjqazg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDozNTowN1rOGjslCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODMzNA==", "bodyText": "Are these needed to be public? If not, I'd suggest to make them private. If yes, than they need javadoc.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440048334", "createdAt": "2020-06-15T09:30:55Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "diffHunk": "@@ -29,45 +33,69 @@\n  */\n public class MessageCountingMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Counter ingestedCounter;\n-    private final Counter successCounter;\n-    private final Counter failureCounter;\n-    private final Counter processedCounter;\n-    private final Counter ignoredCounter;\n-\n-    private MessageCountingMonitor(Counter ingestedCounter, Counter successCounter, Counter failureCounter,\n-                                   Counter processedCounter, Counter ignoredCounter) {\n-        this.ingestedCounter = ingestedCounter;\n-        this.successCounter = successCounter;\n-        this.failureCounter = failureCounter;\n-        this.processedCounter = processedCounter;\n-        this.ignoredCounter = ignoredCounter;\n+    public static final String INGESTED_COUNTER = \".ingestedCounter\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4MzcyMw==", "bodyText": "private is fine. It will be changed", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440083723", "createdAt": "2020-06-15T10:35:07Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "diffHunk": "@@ -29,45 +33,69 @@\n  */\n public class MessageCountingMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Counter ingestedCounter;\n-    private final Counter successCounter;\n-    private final Counter failureCounter;\n-    private final Counter processedCounter;\n-    private final Counter ignoredCounter;\n-\n-    private MessageCountingMonitor(Counter ingestedCounter, Counter successCounter, Counter failureCounter,\n-                                   Counter processedCounter, Counter ignoredCounter) {\n-        this.ingestedCounter = ingestedCounter;\n-        this.successCounter = successCounter;\n-        this.failureCounter = failureCounter;\n-        this.processedCounter = processedCounter;\n-        this.ignoredCounter = ignoredCounter;\n+    public static final String INGESTED_COUNTER = \".ingestedCounter\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA0ODMzNA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTYzMDEzOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTozNDowMFrOGjqhjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDozNjoyN1rOGjsnog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MDA2MA==", "bodyText": "At first I thought \"why are you creating new Counters all the time?\", but than I read the javadoc and noticed the MeterRegistery will return an existing one if present.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440050060", "createdAt": "2020-06-15T09:34:00Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "diffHunk": "@@ -29,45 +33,69 @@\n  */\n public class MessageCountingMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Counter ingestedCounter;\n-    private final Counter successCounter;\n-    private final Counter failureCounter;\n-    private final Counter processedCounter;\n-    private final Counter ignoredCounter;\n-\n-    private MessageCountingMonitor(Counter ingestedCounter, Counter successCounter, Counter failureCounter,\n-                                   Counter processedCounter, Counter ignoredCounter) {\n-        this.ingestedCounter = ingestedCounter;\n-        this.successCounter = successCounter;\n-        this.failureCounter = failureCounter;\n-        this.processedCounter = processedCounter;\n-        this.ignoredCounter = ignoredCounter;\n+    public static final String INGESTED_COUNTER = \".ingestedCounter\";\n+    public static final String SUCCESS_COUNTER = \".successCounter\";\n+    public static final String FAILURE_COUNTER = \".failureCounter\";\n+    public static final String PROCESSED_COUNTER = \".processedCounter\";\n+    public static final String IGNORED_COUNTER = \".ignoredCounter\";\n+\n+    private final String meterNamePrefix;\n+    private final MeterRegistry meterRegistry;\n+    private final Function<Message<?>, Iterable<Tag>> tagsBuilder;\n+\n+    private MessageCountingMonitor(String meterNamePrefix, MeterRegistry meterRegistry) {\n+\n+        this(meterNamePrefix,\n+             meterRegistry,\n+             message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG, message.getPayloadType().getSimpleName()));\n+    }\n+\n+\n+    private MessageCountingMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                   Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        this.meterNamePrefix = meterNamePrefix;\n+        this.meterRegistry = meterRegistry;\n+        this.tagsBuilder = tagsBuilder;\n     }\n \n     /**\n      * Creates a message counting monitor\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @return the message counting monitor\n+     * @return the message counting monitor (with the default tag `payloadType`)\n      */\n     public static MessageCountingMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry) {\n-        Counter ingestedCounter = meterRegistry.counter(meterNamePrefix + \".ingestedCounter\");\n-        Counter successCounter = meterRegistry.counter(meterNamePrefix + \".successCounter\");\n-        Counter failureCounter = meterRegistry.counter(meterNamePrefix + \".failureCounter\");\n-        Counter processedCounter = meterRegistry.counter(meterNamePrefix + \".processedCounter\");\n-        Counter ignoredCounter = meterRegistry.counter(meterNamePrefix + \".ignoredCounter\");\n-\n-        return new MessageCountingMonitor(ingestedCounter,\n-                                          successCounter,\n-                                          failureCounter,\n-                                          processedCounter,\n-                                          ignoredCounter);\n+\n+        return new MessageCountingMonitor(meterNamePrefix, meterRegistry);\n+    }\n+\n+    /**\n+     * Creates a message counting monitor\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the message counting monitor\n+     */\n+    public static MessageCountingMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                                      Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+\n+        return new MessageCountingMonitor(meterNamePrefix, meterRegistry, tagsBuilder);\n     }\n \n     @Override\n     public MonitorCallback onMessageIngested(Message<?> message) {\n+\n+        Iterable<Tag> tags = tagsBuilder.apply(message);\n+        Counter ingestedCounter = meterRegistry.counter(meterNamePrefix + INGESTED_COUNTER, tags);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4NDM4Ng==", "bodyText": "Yes, MeterRegistery is taking care of this for us. Which is very nice actually. Enables this approach in general.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440084386", "createdAt": "2020-06-15T10:36:27Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageCountingMonitor.java", "diffHunk": "@@ -29,45 +33,69 @@\n  */\n public class MessageCountingMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Counter ingestedCounter;\n-    private final Counter successCounter;\n-    private final Counter failureCounter;\n-    private final Counter processedCounter;\n-    private final Counter ignoredCounter;\n-\n-    private MessageCountingMonitor(Counter ingestedCounter, Counter successCounter, Counter failureCounter,\n-                                   Counter processedCounter, Counter ignoredCounter) {\n-        this.ingestedCounter = ingestedCounter;\n-        this.successCounter = successCounter;\n-        this.failureCounter = failureCounter;\n-        this.processedCounter = processedCounter;\n-        this.ignoredCounter = ignoredCounter;\n+    public static final String INGESTED_COUNTER = \".ingestedCounter\";\n+    public static final String SUCCESS_COUNTER = \".successCounter\";\n+    public static final String FAILURE_COUNTER = \".failureCounter\";\n+    public static final String PROCESSED_COUNTER = \".processedCounter\";\n+    public static final String IGNORED_COUNTER = \".ignoredCounter\";\n+\n+    private final String meterNamePrefix;\n+    private final MeterRegistry meterRegistry;\n+    private final Function<Message<?>, Iterable<Tag>> tagsBuilder;\n+\n+    private MessageCountingMonitor(String meterNamePrefix, MeterRegistry meterRegistry) {\n+\n+        this(meterNamePrefix,\n+             meterRegistry,\n+             message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG, message.getPayloadType().getSimpleName()));\n+    }\n+\n+\n+    private MessageCountingMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                   Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        this.meterNamePrefix = meterNamePrefix;\n+        this.meterRegistry = meterRegistry;\n+        this.tagsBuilder = tagsBuilder;\n     }\n \n     /**\n      * Creates a message counting monitor\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @return the message counting monitor\n+     * @return the message counting monitor (with the default tag `payloadType`)\n      */\n     public static MessageCountingMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry) {\n-        Counter ingestedCounter = meterRegistry.counter(meterNamePrefix + \".ingestedCounter\");\n-        Counter successCounter = meterRegistry.counter(meterNamePrefix + \".successCounter\");\n-        Counter failureCounter = meterRegistry.counter(meterNamePrefix + \".failureCounter\");\n-        Counter processedCounter = meterRegistry.counter(meterNamePrefix + \".processedCounter\");\n-        Counter ignoredCounter = meterRegistry.counter(meterNamePrefix + \".ignoredCounter\");\n-\n-        return new MessageCountingMonitor(ingestedCounter,\n-                                          successCounter,\n-                                          failureCounter,\n-                                          processedCounter,\n-                                          ignoredCounter);\n+\n+        return new MessageCountingMonitor(meterNamePrefix, meterRegistry);\n+    }\n+\n+    /**\n+     * Creates a message counting monitor\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n+     * @return the message counting monitor\n+     */\n+    public static MessageCountingMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                                      Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+\n+        return new MessageCountingMonitor(meterNamePrefix, meterRegistry, tagsBuilder);\n     }\n \n     @Override\n     public MonitorCallback onMessageIngested(Message<?> message) {\n+\n+        Iterable<Tag> tags = tagsBuilder.apply(message);\n+        Counter ingestedCounter = meterRegistry.counter(meterNamePrefix + INGESTED_COUNTER, tags);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MDA2MA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTYzOTIwOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTozNjozNlrOGjqnPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDozNzowOVrOGjso_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MTUxOA==", "bodyText": "Might be nice to reference the micrometer Tag class in the javadoc, as now it might be rather ambiguous what's meant with \"tag\".\nThus something like so:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * @return the message timer monitor (with the default tag `payloadType`)\n          \n          \n            \n                 * @return the message timer monitor (with the default {@link Tag} `payloadType`)\n          \n      \n    \n    \n  \n\nDoing this at all the other spots where the Tag class is referenced would be good too I think.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440051518", "createdAt": "2020-06-15T09:36:36Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "diffHunk": "@@ -34,18 +37,18 @@\n  */\n public class MessageTimerMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Timer allTimer;\n-    private final Timer successTimer;\n-    private final Timer failureTimer;\n-    private final Timer ignoredTimer;\n+    private final String meterNamePrefix;\n+    private final MeterRegistry meterRegistry;\n+    private final Function<Message<?>, Iterable<Tag>> tagsBuilder;\n+\n     private final Clock clock;\n \n     /**\n      * Creates a message timer monitor\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @return the message timer monitor\n+     * @return the message timer monitor (with the default tag `payloadType`)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4NDczMw==", "bodyText": "Agreed", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440084733", "createdAt": "2020-06-15T10:37:09Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "diffHunk": "@@ -34,18 +37,18 @@\n  */\n public class MessageTimerMonitor implements MessageMonitor<Message<?>> {\n \n-    private final Timer allTimer;\n-    private final Timer successTimer;\n-    private final Timer failureTimer;\n-    private final Timer ignoredTimer;\n+    private final String meterNamePrefix;\n+    private final MeterRegistry meterRegistry;\n+    private final Function<Message<?>, Iterable<Tag>> tagsBuilder;\n+\n     private final Clock clock;\n \n     /**\n      * Creates a message timer monitor\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @return the message timer monitor\n+     * @return the message timer monitor (with the default tag `payloadType`)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1MTUxOA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTY2NTE4OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo0Mzo0MVrOGjq3jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo0Mzo0MVrOGjq3jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1NTY5Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates a message timer monitor\n          \n          \n            \n                 * Creates a message timer monitor.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440055693", "createdAt": "2020-06-15T09:43:41Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "diffHunk": "@@ -56,36 +59,78 @@ public static MessageTimerMonitor buildMonitor(String meterNamePrefix, MeterRegi\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @param clock           The clock used to measure the process time per message\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n      * @return the message timer monitor\n      */\n+    public static MessageTimerMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                                   Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        return buildMonitor(meterNamePrefix, meterRegistry, Clock.SYSTEM, tagsBuilder);\n+    }\n+\n+    /**\n+     * Creates a message timer monitor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTY2NTUyOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo0Mzo0N1rOGjq30Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo0Mzo0N1rOGjq30Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA1NTc2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Creates a message timer monitor\n          \n          \n            \n                 * Creates a message timer monitor.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440055761", "createdAt": "2020-06-15T09:43:47Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/MessageTimerMonitor.java", "diffHunk": "@@ -56,36 +59,78 @@ public static MessageTimerMonitor buildMonitor(String meterNamePrefix, MeterRegi\n      *\n      * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n      * @param meterRegistry   The meter registry used to create and register the meters\n-     * @param clock           The clock used to measure the process time per message\n+     * @param tagsBuilder     The function used to construct the list of micrometer tags, based on the ingested message\n      * @return the message timer monitor\n      */\n+    public static MessageTimerMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry,\n+                                                   Function<Message<?>, Iterable<Tag>> tagsBuilder) {\n+        return buildMonitor(meterNamePrefix, meterRegistry, Clock.SYSTEM, tagsBuilder);\n+    }\n+\n+    /**\n+     * Creates a message timer monitor\n+     *\n+     * @param meterNamePrefix The prefix for the meter name that will be created in the given meterRegistry\n+     * @param meterRegistry   The meter registry used to create and register the meters\n+     * @param clock           The clock used to measure the process time per message\n+     * @return the message timer monitor (with the default tag `payloadType`)\n+     */\n     public static MessageTimerMonitor buildMonitor(String meterNamePrefix, MeterRegistry meterRegistry, Clock clock) {\n-        Timer allTimer = buildTimer(meterNamePrefix, \"allTimer\", meterRegistry);\n-        Timer successTimer = buildTimer(meterNamePrefix, \"successTimer\", meterRegistry);\n-        Timer failureTimer = buildTimer(meterNamePrefix, \"failureTimer\", meterRegistry);\n-        Timer ignoredTimer = buildTimer(meterNamePrefix, \"ignoredTimer\", meterRegistry);\n-        return new MessageTimerMonitor(allTimer, successTimer, failureTimer, ignoredTimer, clock);\n+        return new MessageTimerMonitor(meterNamePrefix, meterRegistry, clock);\n     }\n \n-    private static Timer buildTimer(String meterNamePrefix, String timerName, MeterRegistry meterRegistry) {\n+    /**\n+     * Creates a message timer monitor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTcxMDc4OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo1NjoxM1rOGjrULg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo1NjoxM1rOGjrULg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2MzAyMg==", "bodyText": "Missing javadoc on this class altogether.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440063022", "createdAt": "2020-06-15T09:56:13Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "diffHunk": "@@ -0,0 +1,7 @@\n+package org.axonframework.micrometer;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTcxMjE5OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQwOTo1NjozN1rOGjrVHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDo0MjoxNlrOGjsy4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2MzI2MA==", "bodyText": "The deprecation reason should be explained, as well as what's replacing it. Please add that to the javadoc with the @deprecated tag.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440063260", "createdAt": "2020-06-15T09:56:37Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "diffHunk": "@@ -32,11 +32,11 @@\n  * MessageMonitor}.\n  *\n  * @param <T> The type of the MessageMonitor created for every payload type.Must implement both {@link MessageMonitor}\n- *\n  * @author Steven van Beelen\n  * @author Marijn van Zelst\n  * @since 4.1\n  */\n+@Deprecated", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA4NzI2Ng==", "bodyText": "Yes. The thing here is that we do not need this wrapper any more. The new/changed monitors (CapacityMonitor, CountingMonitor,...) are registering metrics on onMessageIngested method. We are able to create and register  custom metrics in our configuration in a simpler way by using this monitors directlly. I plan to update the Ref Guide for this.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440087266", "createdAt": "2020-06-15T10:42:16Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "diffHunk": "@@ -32,11 +32,11 @@\n  * MessageMonitor}.\n  *\n  * @param <T> The type of the MessageMonitor created for every payload type.Must implement both {@link MessageMonitor}\n- *\n  * @author Steven van Beelen\n  * @author Marijn van Zelst\n  * @since 4.1\n  */\n+@Deprecated", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2MzI2MA=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc0MTcyNDQyOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/test/java/org/axonframework/micrometer/CapacityMonitorTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQxMDowMDoxMFrOGjrc4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwODo1Nzo1M1rOGm30lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2NTI0OQ==", "bodyText": "Isn't there still value in the single and multi threaded capacity test?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r440065249", "createdAt": "2020-06-15T10:00:10Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/test/java/org/axonframework/micrometer/CapacityMonitorTest.java", "diffHunk": "@@ -36,39 +38,50 @@\n class CapacityMonitorTest {\n \n     @Test\n-    void testSingleThreadedCapacity() {\n+    void testCapacity() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTEzNDI3OA==", "bodyText": "Not sure why this test method was named testSingleThreadedCapacity  and the one below testMultithreadedCapacity", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r441134278", "createdAt": "2020-06-16T20:51:12Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/test/java/org/axonframework/micrometer/CapacityMonitorTest.java", "diffHunk": "@@ -36,39 +38,50 @@\n class CapacityMonitorTest {\n \n     @Test\n-    void testSingleThreadedCapacity() {\n+    void testCapacity() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2NTI0OQ=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxMzY1Mg==", "bodyText": "I am guessing it was because of the provided properties the single threaded test did?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r443413652", "createdAt": "2020-06-22T08:57:53Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/test/java/org/axonframework/micrometer/CapacityMonitorTest.java", "diffHunk": "@@ -36,39 +38,50 @@\n class CapacityMonitorTest {\n \n     @Test\n-    void testSingleThreadedCapacity() {\n+    void testCapacity() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDA2NTI0OQ=="}, "originalCommit": {"oid": "7c3e4119c23d259c50db8f55fae62978f9c37ee2"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODg5Mzg2OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzowMzowNlrOGmUDkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDowOToxNFrOGm6TEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyNzY2NA==", "bodyText": "Nit: Might it be reasonable to add the following to the TagsUtil?:\npublic static final Function<Message<?>, Tag> PAYLOAD_TYPE_TAGGER = message > Tags.of(PAYLOAD_TYPE_TAG, message.getPayloadType().getSimpleName());\nHaving some of these functions on the TagsUtil class would make it easier for users to pick and choose from the defaults we have. If they'd now want to set up their own monitor with the defaults we have, they'll have to provide this line too.\nMinor improvement of course, not that big a deal.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442827664", "createdAt": "2020-06-19T13:03:06Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -110,12 +129,55 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return NoOpMessageMonitor.instance();\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor a component of given {@code type}. The monitor will be\n+     * registered with the registry under the given {@code name} and the default set of Micrometer {@link Tag}s.\n+     * The default set of Micrometer {@link Tag}s includes the 'message payload type' and additionally the 'processor\n+     * name'\n+     * for the event processors.\n+     * The returned {@link MessageMonitor} can be installed on the component to initiate the monitoring.\n+     *\n+     * @param componentType The type of component to register\n+     * @param componentName The name under which the component should be registered to the registry\n+     * @return MessageMonitor (with Micrometer {@link Tag}s/dimensions enabled) to monitor the behavior of a given type\n+     *\n+     * @throws IllegalArgumentException if the component type is not recognized\n+     */\n+    public MessageMonitor<? extends Message<?>> registerComponentWithDefaultTags(Class<?> componentType,\n+                                                                                 String componentName) {\n+        if (EventProcessor.class.isAssignableFrom(componentType)) {\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,\n+                                          message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG,\n+                                                             message.getPayloadType().getSimpleName(),\n+                                                             TagsUtil.PROCESSOR_NAME_TAG,\n+                                                             componentName));\n+        }\n+        if (CommandBus.class.isAssignableFrom(componentType)) {\n+            return registerCommandBus(componentName,\n+                                      message -> Tags", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ1NDIyNA==", "bodyText": "Done", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r443454224", "createdAt": "2020-06-22T10:09:14Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -110,12 +129,55 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return NoOpMessageMonitor.instance();\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor a component of given {@code type}. The monitor will be\n+     * registered with the registry under the given {@code name} and the default set of Micrometer {@link Tag}s.\n+     * The default set of Micrometer {@link Tag}s includes the 'message payload type' and additionally the 'processor\n+     * name'\n+     * for the event processors.\n+     * The returned {@link MessageMonitor} can be installed on the component to initiate the monitoring.\n+     *\n+     * @param componentType The type of component to register\n+     * @param componentName The name under which the component should be registered to the registry\n+     * @return MessageMonitor (with Micrometer {@link Tag}s/dimensions enabled) to monitor the behavior of a given type\n+     *\n+     * @throws IllegalArgumentException if the component type is not recognized\n+     */\n+    public MessageMonitor<? extends Message<?>> registerComponentWithDefaultTags(Class<?> componentType,\n+                                                                                 String componentName) {\n+        if (EventProcessor.class.isAssignableFrom(componentType)) {\n+            return registerEventProcessor(EVENT_PROCESSOR_METRICS_NAME,\n+                                          message -> Tags.of(TagsUtil.PAYLOAD_TYPE_TAG,\n+                                                             message.getPayloadType().getSimpleName(),\n+                                                             TagsUtil.PROCESSOR_NAME_TAG,\n+                                                             componentName));\n+        }\n+        if (CommandBus.class.isAssignableFrom(componentType)) {\n+            return registerCommandBus(componentName,\n+                                      message -> Tags", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyNzY2NA=="}, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODkwMzcwOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzowNjoxMFrOGmUJrw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzowNjo0N1rOGmUKyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyOTIzMQ==", "bodyText": "Nit: might be nice to deviate a little with the documentation compared to the registerEventBus(String) method, by for example doing the following:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Registers new metrics to the registry to monitor an {@link EventBus}. The monitor will be registered with the\n          \n          \n            \n                 * Registers new metrics to the registry to monitor an {@link EventBus} using {@link Tag}s through the given {@code tagsBuilder}. The monitor will be registered with the", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442829231", "createdAt": "2020-06-19T13:06:10Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -148,30 +239,78 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return new MultiMessageMonitor<>(Arrays.asList(messageCountingMonitor, messageTimerMonitor));\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor an {@link EventBus}. The monitor will be registered with the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 174}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyOTUxMw==", "bodyText": "I'd expect a similar adjustment to the other registration methods which add the tagsBuilder parameter.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442829513", "createdAt": "2020-06-19T13:06:47Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/GlobalMetricRegistry.java", "diffHunk": "@@ -148,30 +239,78 @@ public Configurer registerWithConfigurer(Configurer configurer) {\n         return new MultiMessageMonitor<>(Arrays.asList(messageCountingMonitor, messageTimerMonitor));\n     }\n \n+    /**\n+     * Registers new metrics to the registry to monitor an {@link EventBus}. The monitor will be registered with the", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgyOTIzMQ=="}, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 174}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODkyOTUyOnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxNDo0OFrOGmUZ8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwODo0Mzo0MlrOGm3UBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzM5NA==", "bodyText": "I believe this is purely deprecated because of the use of Tags right?\nSo, I would expect something like this.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * @deprecated As of release 4.4, replaced by specific monitors {@link MessageCountingMonitor}, {@link CapacityMonitor},\n          \n          \n            \n             * {@link EventProcessorLatencyMonitor}, {@link MessageCountingMonitor} that can be used to register meters on Axon\n          \n          \n            \n             * components directly.\n          \n          \n            \n             * @deprecated As of release 4.4, replaced by using {@link Tag}s on the monitor implementations.\n          \n          \n            \n             * Use {@link org.axonframework.micrometer.GlobalMetricRegistry#registerWithConfigurerWithDefaultTags(Configurer) to achieve the same behavior as this implementation.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442833394", "createdAt": "2020-06-19T13:14:48Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "diffHunk": "@@ -32,11 +32,14 @@\n  * MessageMonitor}.\n  *\n  * @param <T> The type of the MessageMonitor created for every payload type.Must implement both {@link MessageMonitor}\n- *\n  * @author Steven van Beelen\n  * @author Marijn van Zelst\n  * @since 4.1\n+ * @deprecated As of release 4.4, replaced by specific monitors {@link MessageCountingMonitor}, {@link CapacityMonitor},\n+ * {@link EventProcessorLatencyMonitor}, {@link MessageCountingMonitor} that can be used to register meters on Axon\n+ * components directly.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQwNTMxNg==", "bodyText": "Yes, correct. No need for the PayloadTypeMessageMonitorWrapper.java any more", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r443405316", "createdAt": "2020-06-22T08:43:42Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/PayloadTypeMessageMonitorWrapper.java", "diffHunk": "@@ -32,11 +32,14 @@\n  * MessageMonitor}.\n  *\n  * @param <T> The type of the MessageMonitor created for every payload type.Must implement both {@link MessageMonitor}\n- *\n  * @author Steven van Beelen\n  * @author Marijn van Zelst\n  * @since 4.1\n+ * @deprecated As of release 4.4, replaced by specific monitors {@link MessageCountingMonitor}, {@link CapacityMonitor},\n+ * {@link EventProcessorLatencyMonitor}, {@link MessageCountingMonitor} that can be used to register meters on Axon\n+ * components directly.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzM5NA=="}, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODkzMTE1OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxNToyM1rOGmUbCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxNjowOVrOGmUcig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzY3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * metrics.\n          \n          \n            \n             */\n          \n          \n            \n             * metrics.\n          \n          \n            \n             *\n          \n          \n            \n             * @author Ivan Dugalic\n          \n          \n            \n             * @since 4.4\n          \n          \n            \n             */", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442833673", "createdAt": "2020-06-19T13:15:23Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package org.axonframework.micrometer;\n+\n+/**\n+ * Utility class for micrometer tag management.\n+ * <p>\n+ * Contains 'static final' fields which represent the micrometer tag KEY that should be consistent across different\n+ * metrics.\n+ */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzNDA1OA==", "bodyText": "Don't forget to honor yourself for adding this feature ;-)", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442834058", "createdAt": "2020-06-19T13:16:09Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package org.axonframework.micrometer;\n+\n+/**\n+ * Utility class for micrometer tag management.\n+ * <p>\n+ * Contains 'static final' fields which represent the micrometer tag KEY that should be consistent across different\n+ * metrics.\n+ */", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzY3Mw=="}, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1ODkzMjA2OnYy", "diffSide": "RIGHT", "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xOVQxMzoxNTo0MFrOGmUbmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQwOTowODoxNlrOGm4L8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzgxOA==", "bodyText": "However boring, constants also require javadoc.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r442833818", "createdAt": "2020-06-19T13:15:40Z", "author": {"login": "smcvb"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package org.axonframework.micrometer;\n+\n+/**\n+ * Utility class for micrometer tag management.\n+ * <p>\n+ * Contains 'static final' fields which represent the micrometer tag KEY that should be consistent across different\n+ * metrics.\n+ */\n+public class TagsUtil {\n+\n+    private TagsUtil() {\n+    }\n+\n+    public static final String PAYLOAD_TYPE_TAG = \"payloadType\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQxOTYzMg==", "bodyText": "agreed", "url": "https://github.com/AxonFramework/AxonFramework/pull/1448#discussion_r443419632", "createdAt": "2020-06-22T09:08:16Z", "author": {"login": "idugalic"}, "path": "metrics-micrometer/src/main/java/org/axonframework/micrometer/TagsUtil.java", "diffHunk": "@@ -0,0 +1,16 @@\n+package org.axonframework.micrometer;\n+\n+/**\n+ * Utility class for micrometer tag management.\n+ * <p>\n+ * Contains 'static final' fields which represent the micrometer tag KEY that should be consistent across different\n+ * metrics.\n+ */\n+public class TagsUtil {\n+\n+    private TagsUtil() {\n+    }\n+\n+    public static final String PAYLOAD_TYPE_TAG = \"payloadType\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MjgzMzgxOA=="}, "originalCommit": {"oid": "960c7ea256a7486dcb4b29c3ad8f7c4a6118de9f"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3205, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}