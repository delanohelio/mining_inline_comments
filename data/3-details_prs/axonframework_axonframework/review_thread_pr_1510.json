{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NjQ4NzEz", "number": 1510, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzowMzoxMFrOEkhnUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMTo1NDo0OVrOEk8GcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzM0OTI5OnYy", "diffSide": "RIGHT", "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzowMzoxMFrOHThAqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzowMzoxMFrOHThAqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNTgzMg==", "bodyText": "I would change this testcase and include 2 variants.\nMove the \"verify\" code outside of the onCommit. It's unreliable to put assertions there. If the UoW is rolled back, the test passes.\nOne variant should do a UOW Commit, and the other a rollback. In case of the commit there is an invocation, in case of rollback, there isn't", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490225832", "createdAt": "2020-09-17T13:03:10Z", "author": {"login": "abuijze"}, "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "diffHunk": "@@ -70,24 +70,45 @@ void tearDown() {\n     }\n \n     @Test\n-    void testSnapshotterTriggeredOnUnitOfWorkCommit() {\n+    void testSnapshotterTriggeredOnUnitOfWorkCleanup() {\n         SnapshotTrigger trigger = testSubject.prepareTrigger(aggregate.rootType());\n-        GenericDomainEventMessage<String> msg = new GenericDomainEventMessage<>(\"type\", aggregateIdentifier, (long) 0,\n+        GenericDomainEventMessage<String> msg = new GenericDomainEventMessage<>(\"type\", aggregateIdentifier, 0,\n                                                                                 \"Mock contents\", MetaData.emptyInstance());\n         trigger.eventHandled(msg);\n         trigger.eventHandled(msg);\n         trigger.eventHandled(msg);\n         trigger.eventHandled(msg);\n \n         verify(mockSnapshotter, never()).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n+        CurrentUnitOfWork.get()\n+                         .onCommit(uow -> verify(mockSnapshotter, never())\n+                                 .scheduleSnapshot(aggregate.rootType(), aggregateIdentifier));\n         CurrentUnitOfWork.commit();\n         verify(mockSnapshotter).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n     }\n \n+    @Test\n+    void testSnapshotterTriggeredOnUnitOfWorkCommit() {\n+        SnapshotTrigger trigger = testSubject.prepareTrigger(aggregate.rootType());\n+        GenericDomainEventMessage<String> msg = new GenericDomainEventMessage<>(\"type\", aggregateIdentifier, 0,\n+                                                                                \"Mock contents\", MetaData.emptyInstance());\n+        trigger.initializationFinished();\n+        trigger.eventHandled(msg);\n+        trigger.eventHandled(msg);\n+        trigger.eventHandled(msg);\n+        trigger.eventHandled(msg);\n+\n+        verify(mockSnapshotter, never()).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n+        CurrentUnitOfWork.get()\n+                         .onCommit(uow -> verify(mockSnapshotter)\n+                                 .scheduleSnapshot(aggregate.rootType(), aggregateIdentifier));\n+        CurrentUnitOfWork.commit();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73167745a36832f1716d35ea06a35ec1e0104b9c"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzM1NzQ4OnYy", "diffSide": "RIGHT", "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzowNDo1OVrOHThFYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoyNTozNFrOHTiBAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNzA0Mg==", "bodyText": "This blocks multiple invocations from the same unit of work, but will not prevent different UoW to trigger the creation of a snapshot....", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490227042", "createdAt": "2020-09-17T13:04:59Z", "author": {"login": "abuijze"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "diffHunk": "@@ -64,14 +70,23 @@ protected AbstractSnapshotter(Builder builder) {\n \n     @Override\n     public void scheduleSnapshot(Class<?> aggregateType, String aggregateIdentifier) {\n-        if (CurrentUnitOfWork.isStarted()) {\n+        if (CurrentUnitOfWork.isStarted() && CurrentUnitOfWork.get().phase().isBefore(UnitOfWork.Phase.COMMIT)) {\n             CurrentUnitOfWork.get().afterCommit(u -> doScheduleSnapshot(aggregateType, aggregateIdentifier));\n         } else {\n             doScheduleSnapshot(aggregateType, aggregateIdentifier);\n         }\n     }\n \n     private void doScheduleSnapshot(Class<?> aggregateType, String aggregateIdentifier) {\n+        if (CurrentUnitOfWork.isStarted()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73167745a36832f1716d35ea06a35ec1e0104b9c"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0MjMwNQ==", "bodyText": "That is correct. However, is it possible to have several UoWs triggering a snapshot on the same Aggregate? (Aggregate is locked until UoW cleans up).", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490242305", "createdAt": "2020-09-17T13:25:34Z", "author": {"login": "m1l4n54v1c"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "diffHunk": "@@ -64,14 +70,23 @@ protected AbstractSnapshotter(Builder builder) {\n \n     @Override\n     public void scheduleSnapshot(Class<?> aggregateType, String aggregateIdentifier) {\n-        if (CurrentUnitOfWork.isStarted()) {\n+        if (CurrentUnitOfWork.isStarted() && CurrentUnitOfWork.get().phase().isBefore(UnitOfWork.Phase.COMMIT)) {\n             CurrentUnitOfWork.get().afterCommit(u -> doScheduleSnapshot(aggregateType, aggregateIdentifier));\n         } else {\n             doScheduleSnapshot(aggregateType, aggregateIdentifier);\n         }\n     }\n \n     private void doScheduleSnapshot(Class<?> aggregateType, String aggregateIdentifier) {\n+        if (CurrentUnitOfWork.isStarted()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIyNzA0Mg=="}, "originalCommit": {"oid": "73167745a36832f1716d35ea06a35ec1e0104b9c"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTY1NTEwOnYy", "diffSide": "RIGHT", "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMTo0NDozMFrOHUJv-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxNjoxMDoxOVrOHUTapw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5MzMwNw==", "bodyText": "I think this method should be private.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490893307", "createdAt": "2020-09-18T11:44:30Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "diffHunk": "@@ -205,6 +264,32 @@ public void run() {\n                 }\n             }\n         }\n+\n+        public Runnable andFinally(Runnable r) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTAxODcwNA==", "bodyText": "I disagree. This method is intended to be invoked from outside this class. It happens to be an inner class right now, but there is bo real reason why not to make this a public utility class. In that case, a private method wouldn't work.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r491018704", "createdAt": "2020-09-18T15:15:14Z", "author": {"login": "abuijze"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "diffHunk": "@@ -205,6 +264,32 @@ public void run() {\n                 }\n             }\n         }\n+\n+        public Runnable andFinally(Runnable r) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5MzMwNw=="}, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTA1MTY4Nw==", "bodyText": "Through GitHub code folding magic, I completely missed this method was part of the SilentTask class...mea culpa.\nI agree with you @abuijze, this should stay public, thanks for correcting me.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r491051687", "createdAt": "2020-09-18T16:10:19Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/AbstractSnapshotter.java", "diffHunk": "@@ -205,6 +264,32 @@ public void run() {\n                 }\n             }\n         }\n+\n+        public Runnable andFinally(Runnable r) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5MzMwNw=="}, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTY2OTM0OnYy", "diffSide": "RIGHT", "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMTo0ODo1M1rOHUJ3-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMTo0ODo1M1rOHUJ3-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5NTM1NA==", "bodyText": "Nit: wouldn't hurt to adjust the class level javadoc to specify both angles when a snapshot can be created.\nThus, firstly because during applying the threshold is reached, and secondly when the threshold is reached during initialization.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490895354", "createdAt": "2020-09-18T11:48:53Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/main/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinition.java", "diffHunk": "@@ -76,24 +78,30 @@ public EventCountSnapshotTrigger(Snapshotter snapshotter, Class<?> aggregateType\n \n         @Override\n         public void eventHandled(EventMessage<?> msg) {\n-            if (++counter >= threshold && msg instanceof DomainEventMessage) {\n+            if (msg instanceof DomainEventMessage && ++counter >= threshold) {\n                 if (CurrentUnitOfWork.isStarted()) {\n-                    CurrentUnitOfWork.get().onPrepareCommit(\n-                            u -> scheduleSnapshot((DomainEventMessage) msg));\n+                    if (initialized) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MTY4ODgxOnYy", "diffSide": "RIGHT", "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMTo1NDo0OVrOHUKDUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxMzoxNjoxOVrOHV5fiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5ODI1OQ==", "bodyText": "Nit: wouldn't it be beneficial to state this should only occur if the snapshot is triggered in the pre-apply phase? Thus, prior before the aggregate has been initialized? Because, only then will we we invoke this onCleanUp", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490898259", "createdAt": "2020-09-18T11:54:49Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "diffHunk": "@@ -84,10 +103,26 @@ void testSnapshotterTriggeredOnUnitOfWorkCommit() {\n         verify(mockSnapshotter).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n     }\n \n+    @Test\n+    void testSnapshotterTriggeredOnUnitOfWorkRollback() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5OTM4NQ==", "bodyText": "Does make the trigger.initializationFinished(); weird for me right now...so might be have a misconception here. Please tell me if I am wrong on the matter.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r490899385", "createdAt": "2020-09-18T11:57:03Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "diffHunk": "@@ -84,10 +103,26 @@ void testSnapshotterTriggeredOnUnitOfWorkCommit() {\n         verify(mockSnapshotter).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n     }\n \n+    @Test\n+    void testSnapshotterTriggeredOnUnitOfWorkRollback() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5ODI1OQ=="}, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjcyNDEwNQ==", "bodyText": "Alright, I've only just now noticed the verify twice expect it never() to happen. That was what I was missing here. No stress!", "url": "https://github.com/AxonFramework/AxonFramework/pull/1510#discussion_r492724105", "createdAt": "2020-09-22T13:16:19Z", "author": {"login": "smcvb"}, "path": "eventsourcing/src/test/java/org/axonframework/eventsourcing/EventCountSnapshotTriggerDefinitionTest.java", "diffHunk": "@@ -84,10 +103,26 @@ void testSnapshotterTriggeredOnUnitOfWorkCommit() {\n         verify(mockSnapshotter).scheduleSnapshot(aggregate.rootType(), aggregateIdentifier);\n     }\n \n+    @Test\n+    void testSnapshotterTriggeredOnUnitOfWorkRollback() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg5ODI1OQ=="}, "originalCommit": {"oid": "481f7fb76c67110d8b35f9ebf421ce1211c5c26f"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3229, "cost": 1, "resetAt": "2021-11-12T11:18:39Z"}}}