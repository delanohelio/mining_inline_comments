{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ2NTcwMzQ1", "number": 1657, "title": "[#1588] Automatic @Revision-based SnapshotFilter", "bodyText": "This pull request introduces a new implementation of the SnapshotFilter: the RevisionSnapshotFilter.\nThis filter upon construction takes in an \"allowed revision\".\nThis String is validated against the revision on the type of the payload present in the DomainEventData when test is invoked.\nFurthermore, the AggregateConfigurer checks for the existence of the @Revision annotation on the aggregate Class. If it's present, the attribute revision is used to create a RevisionSnapshotFilter, which is then set as the snapshot filter for this aggregate.\nThis pull request resolves #1588", "createdAt": "2020-12-29T17:22:20Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657", "merged": true, "mergeCommit": {"oid": "fa446b4fceb573b2a9d2a5874cfeb9d089cfea6b"}, "closed": true, "closedAt": "2021-01-11T15:34:06Z", "author": {"login": "smcvb"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdq9dUKgH2gAyNTQ2NTcwMzQ1OmRjNmMwODRmZGQxNTJjOTk3YTE5NTQ0NTBmMWM0NjIwZDk5NmE0ZTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvGhMpAFqTU2NTM1MTEyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc6c084fdd152c997a1954450f1c4620d996a4e3", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/dc6c084fdd152c997a1954450f1c4620d996a4e3", "committedDate": "2020-12-29T16:38:17Z", "message": "Add Revision based SnapshotFilter\n\nIntroduce a RevisionSnapshotFilter, which based on a given allowed\nrevision can filter out DomainEventData entries which contain that\nrevision\n\n#1588"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935", "author": {"user": {"login": "smcvb", "name": "Steven van Beelen"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/92203c326e2c87d3144199a6cdab4e93bff42935", "committedDate": "2020-12-29T17:14:50Z", "message": "Create RevisionSnapshotFilter if Revision is present\n\nWhen constructing the AggregateConfigurer, check if the aggregate Class\ncontains the Revision annotation. If it does, use the revision attribute\n on the annotation to create a RevisionSnapshotFilter as the\n SnapshotFilter for this aggregate\n\n#1588"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMDgzODUw", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#pullrequestreview-560083850", "createdAt": "2020-12-30T15:04:27Z", "commit": {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1MzIxNjY0", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#pullrequestreview-565321664", "createdAt": "2021-01-11T12:47:06Z", "commit": {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjo0NzowNlrOIRT5GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxMjo0NzowNlrOIRT5GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTAyMjYxNw==", "bodyText": "Wouldn't this change break backwards compatibility? I'd opt for finding a way to toggle this feature instead of using it by default.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#discussion_r555022617", "createdAt": "2021-01-11T12:47:06Z", "author": {"login": "m1l4n54v1c"}, "path": "config/src/main/java/org/axonframework/config/AggregateConfigurer.java", "diffHunk": "@@ -178,7 +182,13 @@ protected AggregateConfigurer(Class<A> aggregate) {\n         );\n         snapshotTriggerDefinition = new Component<>(() -> parent, name(\"snapshotTriggerDefinition\"),\n                                                     c -> NoSnapshotTriggerDefinition.INSTANCE);\n-        snapshotFilter = new Component<>(() -> parent, name(\"snapshotFilter\"), c -> SnapshotFilter.allowAll());\n+        snapshotFilter = new Component<>(() -> parent, name(\"snapshotFilter\"), c -> {\n+            Optional<String> revisionValue =\n+                    AnnotationUtils.findAnnotationAttribute(aggregate, Revision.class, \"revision\");\n+            return revisionValue.isPresent()\n+                    ? new RevisionSnapshotFilter(revisionValue.get())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1MzUxMTIx", "url": "https://github.com/AxonFramework/AxonFramework/pull/1657#pullrequestreview-565351121", "createdAt": "2021-01-11T13:27:22Z", "commit": {"oid": "92203c326e2c87d3144199a6cdab4e93bff42935"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}