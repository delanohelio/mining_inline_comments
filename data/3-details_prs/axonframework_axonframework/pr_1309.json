{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwMDAxMDQw", "number": 1309, "title": "Axon Server connector notifies the success or failure of the execution of an event processor split/merge instruction.", "bodyText": "This should be part of the milestone 4.4 of Axon Framework.\nThis partially solves the issue #1001 .", "createdAt": "2020-01-07T13:55:57Z", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309", "merged": true, "mergeCommit": {"oid": "5a69522b9b35021784ac83eebc3be519d27c00d9"}, "closed": true, "closedAt": "2020-03-30T10:10:55Z", "author": {"login": "saratry"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4AoL_gH2gAyMzYwMDAxMDQwOjlhNGNjZGY0NWRhNzYzMzRmNWFkZGJlOGIyZGMzMDQ4NjUzNTQ4MmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRKbHoAH2gAyMzYwMDAxMDQwOmQxZWJjMGRlNzJkZWE1MTMwNGE0ODBmNGRhZTNjOTFiMTAzNmZkNmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a4ccdf45da76334f5addbe8b2dc30486535482a", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/9a4ccdf45da76334f5addbe8b2dc30486535482a", "committedDate": "2020-01-07T13:18:35Z", "message": "Axon Server connector notifies the success or failure of the execution of a event processor split/merge instruction."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/086b897038007b145fbec3f02a6e5f738ab5e183", "committedDate": "2020-01-07T13:48:59Z", "message": "Fix unit test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5Nzg0MzIz", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#pullrequestreview-339784323", "createdAt": "2020-01-08T10:49:24Z", "commit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDo0OToyNFrOFbTOHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMDo1Nzo0NlrOFbTbsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE3MDc4Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Responsible to publish through gRPC call the {@link InstructionResult} messages to Axon Server.\n          \n          \n            \n             * Responsible for publishing the {@link InstructionResult} messages through a gRPC call to Axon Server.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r364170783", "createdAt": "2020-01-08T10:49:24Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/GrpcInstructionResultPublisher.java", "diffHunk": "@@ -0,0 +1,79 @@\n+package org.axonframework.axonserver.connector;\n+\n+import io.axoniq.axonserver.grpc.ErrorMessage;\n+import io.axoniq.axonserver.grpc.InstructionResult;\n+import io.axoniq.axonserver.grpc.control.PlatformInboundInstruction;\n+import org.axonframework.axonserver.connector.util.ExceptionSerializer;\n+\n+import java.util.function.Supplier;\n+\n+import static io.axoniq.axonserver.grpc.ErrorMessage.newBuilder;\n+import static org.axonframework.axonserver.connector.ErrorCode.INSTRUCTION_EXECUTION_ERROR;\n+\n+/**\n+ * Responsible to publish through gRPC call the {@link InstructionResult} messages to Axon Server.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE3MjY2Ng==", "bodyText": "Just changing the constructors would essentially mean a breaking changes. I however think that the amount of users constructing a EventProcessorControlService themselves is near zero..should be fine for once to just change the constructor then.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r364172666", "createdAt": "2020-01-08T10:53:49Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/processor/EventProcessorControlService.java", "diffHunk": "@@ -58,10 +62,15 @@\n      *                                    {@link PlatformOutboundInstruction} have been received\n      * @param eventProcessorController    the {@link EventProcessorController} used to perform operations on the\n      *                                    {@link EventProcessor}s\n+     * @param axonServerConfiguration     the {@link AxonServerConfiguration} used to retrieve the client identifier\n      */\n     public EventProcessorControlService(AxonServerConnectionManager axonServerConnectionManager,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE3NDIwNA==", "bodyText": "The EventProcessorController#splitSegment(String, int) method returns a boolean which states whether the operation was successful according to the TrackingEventProcessor. Might be valuable to use this result too to either publish a success or failure.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r364174204", "createdAt": "2020-01-08T10:57:38Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/processor/EventProcessorControlService.java", "diffHunk": "@@ -143,8 +154,10 @@ private void splitSegment(PlatformOutboundInstruction platformOutboundInstructio\n         String processorName = splitSegment.getProcessorName();\n         try {\n             eventProcessorController.splitSegment(processorName, segmentId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDE3NDI1Nw==", "bodyText": "The EventProcessorController#mergeSegment(String, int) method returns a boolean which states whether the operation was successful according to the TrackingEventProcessor. Might be valuable to use this result too to either publish a success or failure.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r364174257", "createdAt": "2020-01-08T10:57:46Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/processor/EventProcessorControlService.java", "diffHunk": "@@ -154,8 +167,10 @@ private void mergeSegment(PlatformOutboundInstruction platformOutboundInstructio\n         int segmentId = mergeSegment.getSegmentIdentifier();\n         try {\n             eventProcessorController.mergeSegment(processorName, segmentId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "086b897038007b145fbec3f02a6e5f738ab5e183"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a01106b76147b108a7c2bd6e216700320e96d573", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/a01106b76147b108a7c2bd6e216700320e96d573", "committedDate": "2020-01-08T11:03:20Z", "message": "Update axon-server-connector/src/main/java/org/axonframework/axonserver/connector/GrpcInstructionResultPublisher.java\n\nCo-Authored-By: Steven van Beelen <steven.vanbeelen@axoniq.io>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjczODEw", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#pullrequestreview-342673810", "createdAt": "2020-01-14T16:37:43Z", "commit": {"oid": "a01106b76147b108a7c2bd6e216700320e96d573"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjozNzo0M1rOFdeFsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjo0MDowNFrOFdeLAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0NjAwMQ==", "bodyText": "Not all failures are represented by a Throwable. Having an overload with a String representing a cause could be beneficial. What do you think?", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r366446001", "createdAt": "2020-01-14T16:37:43Z", "author": {"login": "m1l4n54v1c"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/InstructionResultPublisher.java", "diffHunk": "@@ -0,0 +1,25 @@\n+package org.axonframework.axonserver.connector;\n+\n+/**\n+ * Interface that encapsulates the instruction result publication functionality.\n+ *\n+ * @author Sara Pellegrini\n+ * @since 4.4\n+ */\n+public interface InstructionResultPublisher {\n+\n+    /**\n+     * Notifies to Axon Server a successful execution of the specified instruction.\n+     *\n+     * @param instructionId the identifier of the instruction that has been successfully processed.\n+     */\n+    void publishSuccessFor(String instructionId);\n+\n+    /**\n+     * Notifies to Axon Server a failure during the execution of the specified instruction.\n+     *\n+     * @param instructionId the identifier of the instruction.\n+     * @param error         the error happened during the instruction execution.\n+     */\n+    void publishFailureFor(String instructionId, Throwable error);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a01106b76147b108a7c2bd6e216700320e96d573"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0NzM2Mg==", "bodyText": "I'm missing tests for checking whether instruction result is sent after split/merge.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r366447362", "createdAt": "2020-01-14T16:40:04Z", "author": {"login": "m1l4n54v1c"}, "path": "axon-server-connector/src/test/java/org/axonframework/axonserver/connector/processor/EventProcessorControlServiceTest.java", "diffHunk": "@@ -27,15 +28,18 @@\n \n class EventProcessorControlServiceTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a01106b76147b108a7c2bd6e216700320e96d573"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2640905748023292a091f0447c76a10117c1cb7e", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/2640905748023292a091f0447c76a10117c1cb7e", "committedDate": "2020-03-23T15:08:04Z", "message": "Publish a failure message to Axon Server any time the Axon client receive a split/merge instruction for an Event Processor that is not a Tracking Event Processor instance."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f859e744ccd2224f12d9c99e7806c3aafa9632bb", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/f859e744ccd2224f12d9c99e7806c3aafa9632bb", "committedDate": "2020-03-23T15:25:53Z", "message": "Add an overload of publishFailureFor method with a String representing the cause of the failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab7608257bd76fe3e69b9cd46515574b9c8d4935", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/ab7608257bd76fe3e69b9cd46515574b9c8d4935", "committedDate": "2020-03-24T11:13:09Z", "message": "Add test for InstructionResult on split and merge operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f67e4842c8ff78e67f3b02ee367748663967d432", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/f67e4842c8ff78e67f3b02ee367748663967d432", "committedDate": "2020-03-24T14:22:31Z", "message": "Merge branch 'master' into feature/split-merge-result"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTUzOTY0", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#pullrequestreview-380953964", "createdAt": "2020-03-25T08:53:40Z", "commit": {"oid": "f67e4842c8ff78e67f3b02ee367748663967d432"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwODo1Mzo0MFrOF7RMrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwODo1NDozNlrOF7ROwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY5MjA3Ng==", "bodyText": "The EventProcessorController#splitSegment(String, int) function will also return false if the underlying TrackingEventProcessor couldn't fulfill the request. Thus stating it's an IllegalArgumentException because the given processorName is not a TrackingEventProcessor is not always correct.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r397692076", "createdAt": "2020-03-25T08:53:40Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/processor/EventProcessorControlService.java", "diffHunk": "@@ -146,9 +158,13 @@ private void splitSegment(PlatformOutboundInstruction platformOutboundInstructio\n         int segmentId = splitSegment.getSegmentIdentifier();\n         String processorName = splitSegment.getProcessorName();\n         try {\n-            eventProcessorController.splitSegment(processorName, segmentId);\n+            if (!eventProcessorController.splitSegment(processorName, segmentId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f67e4842c8ff78e67f3b02ee367748663967d432"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY5MjE3OQ==", "bodyText": "The EventProcessorController#mergeSegment(String, int) function will also return false if the underlying TrackingEventProcessor couldn't fulfill the request. Thus stating it's an IllegalArgumentException because the given processorName is not a TrackingEventProcessor is not always correct.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r397692179", "createdAt": "2020-03-25T08:53:51Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/main/java/org/axonframework/axonserver/connector/processor/EventProcessorControlService.java", "diffHunk": "@@ -157,9 +173,13 @@ private void mergeSegment(PlatformOutboundInstruction platformOutboundInstructio\n         String processorName = mergeSegment.getProcessorName();\n         int segmentId = mergeSegment.getSegmentIdentifier();\n         try {\n-            eventProcessorController.mergeSegment(processorName, segmentId);\n+            if (!eventProcessorController.mergeSegment(processorName, segmentId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f67e4842c8ff78e67f3b02ee367748663967d432"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY5MjYwOA==", "bodyText": "Nit: I think the test constants can be made private.", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#discussion_r397692608", "createdAt": "2020-03-25T08:54:36Z", "author": {"login": "smcvb"}, "path": "axon-server-connector/src/test/java/org/axonframework/axonserver/connector/processor/EventProcessorControlServiceTest.java", "diffHunk": "@@ -16,26 +16,55 @@\n \n package org.axonframework.axonserver.connector.processor;\n \n+import io.axoniq.axonserver.grpc.ErrorMessage;\n+import io.axoniq.axonserver.grpc.InstructionResult;\n+import io.axoniq.axonserver.grpc.control.EventProcessorSegmentReference;\n+import io.axoniq.axonserver.grpc.control.PlatformInboundInstruction;\n+import io.axoniq.axonserver.grpc.control.PlatformOutboundInstruction;\n+import org.axonframework.axonserver.connector.AxonServerConfiguration;\n import org.axonframework.axonserver.connector.AxonServerConnectionManager;\n import org.junit.jupiter.api.*;\n \n+import java.util.concurrent.atomic.AtomicReference;\n import java.util.function.Consumer;\n+import javax.annotation.Nonnull;\n \n import static io.axoniq.axonserver.grpc.control.PlatformOutboundInstruction.RequestCase.*;\n import static org.axonframework.axonserver.connector.TestTargetContextResolver.BOUNDED_CONTEXT;\n import static org.mockito.Mockito.*;\n \n class EventProcessorControlServiceTest {\n \n+    public static final String GOOD_INSTRUCTION_ID = \"goodInstructionId\";\n+    public static final String TRACKING_EVENT_PROCESSOR = \"TEP\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f67e4842c8ff78e67f3b02ee367748663967d432"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "989847fba1c7bf190f045716d6cb5a120d64cef3", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/989847fba1c7bf190f045716d6cb5a120d64cef3", "committedDate": "2020-03-25T15:33:21Z", "message": "Fix the error message and the exception thrown when the split/merge operation fails."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMzE2ODYw", "url": "https://github.com/AxonFramework/AxonFramework/pull/1309#pullrequestreview-381316860", "createdAt": "2020-03-25T16:23:27Z", "commit": {"oid": "989847fba1c7bf190f045716d6cb5a120d64cef3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad66b477a0cfc7a8235b74cec7d22393ae7cef26", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/ad66b477a0cfc7a8235b74cec7d22393ae7cef26", "committedDate": "2020-03-25T16:28:45Z", "message": "Set AxonServerCommandBus running property to false only after termination of the execution of commands that are in progress."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1ebc0de72dea51304a480f4dae3c91b1036fd6a", "author": {"user": {"login": "saratry", "name": "sara pellegrini"}}, "url": "https://github.com/AxonFramework/AxonFramework/commit/d1ebc0de72dea51304a480f4dae3c91b1036fd6a", "committedDate": "2020-03-25T16:51:28Z", "message": "Fix the error message when the split/merge operation fails."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1814, "cost": 1, "resetAt": "2021-11-01T11:59:11Z"}}}