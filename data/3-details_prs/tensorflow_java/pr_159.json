{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4NjE0NjIx", "number": 159, "title": "Add option to run TensorFlow job on the preferred device (via Scope)", "bodyText": "Related to the issue #77", "createdAt": "2020-11-27T13:30:18Z", "url": "https://github.com/tensorflow/java/pull/159", "merged": true, "mergeCommit": {"oid": "83715291a1f3c486d58c8ce4ac9a29a681d786c8"}, "closed": true, "closedAt": "2020-12-04T04:26:39Z", "author": {"login": "zaleslaw"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgnjZFAH2gAyNTI4NjE0NjIxOjBlYjVjZTcyODZjNWFkOGNkMDVlOTFhMjJkMWFhNTY3MDAxMDBlYTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiqmckAFqTU0NDQ5MzcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0eb5ce7286c5ad8cd05e91a22d1aa56700100ea4", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/0eb5ce7286c5ad8cd05e91a22d1aa56700100ea4", "committedDate": "2020-11-27T13:27:46Z", "message": "Draft for DeviceSpec integration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63160579872ddcc8e02950d340a11d1ae2020e48", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/63160579872ddcc8e02950d340a11d1ae2020e48", "committedDate": "2020-11-27T17:20:03Z", "message": "Added generation for Ops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/7523713b5f9823b52c70175c96b479ad51d56968", "committedDate": "2020-11-27T17:29:30Z", "message": "Removed something from generated Ops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNDIwMDg2", "url": "https://github.com/tensorflow/java/pull/159#pullrequestreview-540420086", "createdAt": "2020-11-28T22:01:18Z", "commit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQyMjowMToxOFrOH7df0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yOFQyMjoxMjozNFrOH7dj2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMTMxNQ==", "bodyText": "Let's avoid wildcard imports, as per Google Java style guide suggestion.", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532111315", "createdAt": "2020-11-28T22:01:18Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/gen/annotations/org/tensorflow/op/Ops.java", "diffHunk": "@@ -19,11 +19,8 @@\n \n import java.nio.charset.Charset;\n import java.util.List;\n-import org.tensorflow.DataType;\n-import org.tensorflow.EagerSession;\n-import org.tensorflow.ExecutionEnvironment;\n-import org.tensorflow.Operand;\n-import org.tensorflow.Tensor;\n+\n+import org.tensorflow.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMTQ5MA==", "bodyText": "All generated ops should have been update by your change in the op generator above, they should be all updated by this PR as well, not only this one (there must be 1000+ files to be added).", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532111490", "createdAt": "2020-11-28T22:03:41Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/gen/java/org/tensorflow/op/math/Abs.java", "diffHunk": "@@ -50,6 +50,7 @@\n   @Endpoint(describeByClass = true)\n   public static <T extends TNumber> Abs<T> create(Scope scope, Operand<T> x) {\n     OperationBuilder opBuilder = scope.env().opBuilder(\"Abs\", scope.makeOpName(\"Abs\"));\n+    opBuilder.setDevice(scope.makeDeviceString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMTgxOA==", "bodyText": "TODO: add docs :)", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532111818", "createdAt": "2020-11-28T22:06:52Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/main/java/org/tensorflow/op/Scope.java", "diffHunk": "@@ -121,7 +123,12 @@ public Scope withSubScope(String childScopeName) {\n    * @throws IllegalArgumentException if the name is invalid\n    */\n   public Scope withName(String opName) {\n-    return new Scope(env, nameScope.withName(opName), controlDependencies);\n+    return new Scope(env, nameScope.withName(opName), controlDependencies, deviceSpec);\n+  }\n+\n+  // TODO: add docs", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMTg4NQ==", "bodyText": "No wildcard imports", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532111885", "createdAt": "2020-11-28T22:07:33Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/test/java/org/tensorflow/op/core/ConstantTest.java", "diffHunk": "@@ -23,11 +23,11 @@\n import java.nio.FloatBuffer;\n import java.nio.IntBuffer;\n import java.nio.LongBuffer;\n+import java.util.Collection;\n+\n import org.junit.jupiter.api.Test;\n-import org.tensorflow.AutoCloseableList;\n-import org.tensorflow.Graph;\n-import org.tensorflow.Session;\n-import org.tensorflow.Tensor;\n+import org.tensorflow.*;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMTkyNg==", "bodyText": "This comment is probably a leftover", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532111926", "createdAt": "2020-11-28T22:08:32Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/test/java/org/tensorflow/op/core/ConstantTest.java", "diffHunk": "@@ -70,6 +71,46 @@ public void createInts() {\n     }\n   }\n \n+  @Test\n+  public void absDeviceSpec() {\n+    ConfigProto config = ConfigProto.newBuilder(ConfigProto.getDefaultInstance())\n+            .setLogDevicePlacement(true)\n+            .build();\n+\n+    try (Graph g = new Graph();\n+         Session sess = new Session(g, config)) {\n+\n+      Ops tf = Ops.create(g).withSubScope(\"anotherJob\");\n+\n+      Tensor<TInt32> a = TInt32.scalarOf(-1);\n+\n+      Output<TInt32> aOps = g\n+              .opBuilder(\"Const\", \"aOps\")\n+              .setAttr(\"dtype\", a.dataType())\n+              .setAttr(\"value\", a)\n+              .setDevice(\"/job:localhost/replica:0/task:0/device:CPU:0\")\n+              .build()\n+              .output(0);\n+      DeviceSpec deviceSpec = DeviceSpec.newBuilder()\n+              .job(\"localhost\")\n+              .replica(0)\n+              .task(1)\n+              .deviceType(DeviceSpec.DeviceType.CPU)\n+              .build();\n+\n+      //DeviceSpec deviceSpec = DeviceSpec.newBuilder().build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjExMjM0NQ==", "bodyText": "The Ops class should now have this new method in it but it does not appear in the version you've committed.\nAlso, I would rephrase its documentation for something like this:\n\"Returns an API that places the created operations on the device(s) matching the provided spec. @see...\"", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532112345", "createdAt": "2020-11-28T22:12:34Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-generator/src/main/java/org/tensorflow/processor/operator/OperatorProcessor.java", "diffHunk": "@@ -537,6 +538,18 @@ private static TypeSpec buildTopClass(OpsSpec spec) {\n                 T_SCOPE)\n             .build());\n \n+    opsBuilder.addMethod(\n+            MethodSpec.methodBuilder(\"withDevice\")\n+                    .addModifiers(Modifier.PUBLIC)\n+                    .addParameter(T_DEVICE_SPEC, \"deviceSpec\")\n+                    .returns(T_OPS)\n+                    .addStatement(\"return new Ops(scope.withDevice(deviceSpec))\")\n+                    .addJavadoc(\n+                            \"Returns an API that uses the provided DeviceSpec for an op.\\n\\n\"\n+                                    + \"@see {@link $T#withDevice(DeviceSpec)}\\n\",\n+                            T_SCOPE)\n+                    .build());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7523713b5f9823b52c70175c96b479ad51d56968"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2da526dad99c07fbcd41b5657a889a7a3fd16d76", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/2da526dad99c07fbcd41b5657a889a7a3fd16d76", "committedDate": "2020-11-30T11:38:50Z", "message": "Finalized the PR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTQ5NTg1", "url": "https://github.com/tensorflow/java/pull/159#pullrequestreview-540949585", "createdAt": "2020-11-30T14:18:47Z", "commit": {"oid": "2da526dad99c07fbcd41b5657a889a7a3fd16d76"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDoxODo0N1rOH79ILw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxNDoxODo0N1rOH79ILw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYyOTU1MQ==", "bodyText": "Hey @zaleslaw , I have another change to propose you that I just thought of. I think if we merge together scope.applyControlDependencies and this new step for adding the device string to the opBuilder would make the whole process of building an op simpler, especially with non-generated ones.\nSo what about that:\n\nWe rename scope.applyControlDependencies(opBuilder) to scope.apply(opBuilder)\nIn Scope.apply, we apply both control dependencies, the device string (and eventually more data if needed)\n\nBy doing so, we also won't need scope.makeDeviceString() anymore. Let me know what you think", "url": "https://github.com/tensorflow/java/pull/159#discussion_r532629551", "createdAt": "2020-11-30T14:18:47Z", "author": {"login": "karllessard"}, "path": "tensorflow-core/tensorflow-core-api/src/bazel/op_generator/op_generator.cc", "diffHunk": "@@ -246,6 +246,10 @@ void RenderFactoryMethods(const OpSpec& op, const Type& op_class,\n       writer->EndLine();\n     }\n   }\n+  // Add Device String\n+  writer->Append(\"opBuilder.setDevice(scope.makeDeviceString());\");\n+  writer->EndLine();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2da526dad99c07fbcd41b5657a889a7a3fd16d76"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bbb93b1ac5463c969cda615caff6c9fcb897faa", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/2bbb93b1ac5463c969cda615caff6c9fcb897faa", "committedDate": "2020-12-03T14:44:41Z", "message": "Refactored Scope.apply method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27fde851d9701a9805108e51a43ea1b09cdf3ba5", "author": {"user": {"login": "zaleslaw", "name": "Alexey Zinoviev"}}, "url": "https://github.com/tensorflow/java/commit/27fde851d9701a9805108e51a43ea1b09cdf3ba5", "committedDate": "2020-12-03T14:54:12Z", "message": "Handle case of separate usage of control dependencies in Init method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDkzNzI2", "url": "https://github.com/tensorflow/java/pull/159#pullrequestreview-544493726", "createdAt": "2020-12-03T22:08:40Z", "commit": {"oid": "27fde851d9701a9805108e51a43ea1b09cdf3ba5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3466, "cost": 1, "resetAt": "2021-11-02T12:20:56Z"}}}