{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTAyNzIy", "number": 1122, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo0NToyOFrOE3XK3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOToxNjoyMFrOE3YD5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NDg2NzUwOnYy", "diffSide": "RIGHT", "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo0NToyOVrOHwqcVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo0NToyOVrOHwqcVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4OTA3OA==", "bodyText": "is this unnecessary", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520789078", "createdAt": "2020-11-10T18:45:29Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -196,27 +238,28 @@ private void transferDepositManifests(PID objPid, Resource resc, BinaryTransferS\n             }\n \n             PID manifestPid = getDepositManifestPid(objPid, manifestFile.getName());\n-            transferFile(manifestPid, manifestUri, transferSession, resc, CdrDeposit.storageUri);\n+            transferFile(manifestPid, manifestUri, transferSession, resc, CdrDeposit.hasDatastreamManifest);\n         }\n     }\n \n     private void transferFile(PID binPid, URI stagingUri, BinaryTransferSession transferSession,\n-            Resource resc, Property storageProperty) {\n-\n-        log.debug(\"Transferring {} file from {} for {}\", storageProperty.getLocalName(),\n-                stagingUri, binPid.getQualifiedId());\n+            Resource parentResc, Property datastreamProperty) {\n         URI storageUri = null;\n+        String digest = null;\n+        Resource binResc = model.getResource(binPid.getRepositoryPath());\n+\n+        // Already has storageUri, skip transfer\n+        if (binResc.hasProperty(CdrDeposit.storageUri)) {\n+            return;\n+        }\n+\n+        log.debug(\"Transferring file from {} for {}\", stagingUri, binPid.getQualifiedId());\n+\n+        Statement digestStmt = binResc.getProperty(DEFAULT_ALGORITHM.getDepositProperty());\n         try {\n             BinaryTransferOutcome outcome = transferSession.transfer(binPid, stagingUri);\n-            Statement digestStmt = resc.getProperty(DigestAlgorithm.DEFAULT_ALGORITHM.getDepositProperty());\n-            if (digestStmt != null) {\n-                String digest = digestStmt.getString();\n-                if (!digest.equals(outcome.getSha1())) {\n-                    throw new InvalidChecksumException(\"Checksum of copied file for \" + binPid\n-                            + \" from \" + stagingUri + \" did not match expected SHA1: expected \"\n-                            + digest + \", calculated \" + outcome.getSha1());\n-                }\n-            }\n+            digest = outcome.getSha1();\n+            assertProvidedDigestMatches(digestStmt, digest, binPid, stagingUri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 192}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NDk4ODc2OnYy", "diffSide": "RIGHT", "path": "deposit/src/test/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJobTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTowOTozMFrOHwrryg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOTowOTozMFrOHwrryg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTQxOA==", "bodyText": "Are we verifying that fits history is being transferred?", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520809418", "createdAt": "2020-11-10T19:09:30Z", "author": {"login": "bbpennel"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJobTest.java", "diffHunk": "@@ -181,6 +192,47 @@ public void depositWithWorkContainingFileAndFits() throws Exception {\n         verify(jobStatusFactory, times(3)).incrCompletion(eq(jobUUID), eq(1));\n     }\n \n+    @Test\n+    public void depositWithWorkContainingFileAndFitsHistory() throws Exception {\n+        Bag workBag = addContainerObject(depBag, Cdr.Work);\n+        Resource fileResc = addFileObject(workBag, FILE_CONTENT1, true);\n+        workBag.addProperty(Cdr.primaryObject, fileResc);\n+\n+        String historyContent = \"History of fitness\";\n+        PID pid = PIDs.get(workBag.getURI());\n+        Path preHistoryPath = depositDirManager.writeHistoryFile(pid, TECHNICAL_METADATA_HISTORY,\n+                IOUtils.toInputStream(historyContent, UTF_8));\n+        Resource preHistoryResc = DepositModelHelpers.addDatastream(workBag, TECHNICAL_METADATA_HISTORY);\n+        preHistoryResc.addLiteral(CdrDeposit.stagingLocation, preHistoryPath.toUri().toString());\n+\n+        job.closeModel();\n+\n+        job.run();\n+\n+        Model model = job.getReadOnlyModel();\n+        Resource postFileResc = model.getResource(fileResc.getURI());\n+\n+        assertOriginalFileTransferred(postFileResc, FILE_CONTENT1);\n+        assertFitsFileTransferred(postFileResc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2NTAxMzQ5OnYy", "diffSide": "RIGHT", "path": "metadata/src/main/java/edu/unc/lib/dl/util/DepositStatusFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOToxNjoyMFrOHwr7GA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOToxNjoyMFrOHwr7GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMzMzNg==", "bodyText": "delete me", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520813336", "createdAt": "2020-11-10T19:16:20Z", "author": {"login": "bbpennel"}, "path": "metadata/src/main/java/edu/unc/lib/dl/util/DepositStatusFactory.java", "diffHunk": "@@ -65,13 +65,6 @@ public DepositStatusFactory() {\n         return result;\n     }\n \n-    public void addManifest(String depositUUID, String value) {\n-        try (Jedis jedis = getJedisPool().getResource()) {\n-            jedis.rpush(DEPOSIT_MANIFEST_PREFIX + depositUUID, value);\n-        }\n-\n-    }\n-\n     public List<String> getManifestURIs(String depositUUID) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 582, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}