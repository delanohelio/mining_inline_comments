{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ3NDI0ODcx", "number": 1040, "title": "BXC-2711 - Improve deposit pausing", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2711\n\nAdds breakpoints in longer running deposit jobs, where the job checks to see if it has been paused or interrupted, and ends early if so.\nSwitch binary transfer client to write using utility method which can be interrupted\nAdjustments to exception throwing, fix for virus scans, and cleanup of extraneous code", "createdAt": "2020-07-10T12:57:01Z", "url": "https://github.com/UNC-Libraries/box-c/pull/1040", "merged": true, "mergeCommit": {"oid": "84fbc9478601f1cffb6fe1cb6f7382edb215c2fe"}, "closed": true, "closedAt": "2020-07-10T14:45:08Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczTfNHAH2gAyNDQ3NDI0ODcxOjBmZGZjN2FhMzM0YTcwOWQ4ZGVjYzJlMDUxNjI4MWQ2YjVjYjk3YmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczjZZLAFqTQ0NjM4NzU2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0fdfc7aa334a709d8decc2e0516281d6b5cb97ba", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/0fdfc7aa334a709d8decc2e0516281d6b5cb97ba", "committedDate": "2020-07-09T18:38:30Z", "message": "Switch binary transfers to using FileUtils methods, since they are using FileChannels behind the scenes, which can be more performant and are interruptible"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c27fdc8e09ab8e2ba629597b07ec725b69ec63a", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/6c27fdc8e09ab8e2ba629597b07ec725b69ec63a", "committedDate": "2020-07-09T20:36:13Z", "message": "Add breakpoints into deposit jobs where it will check to see if the thread has been interrupted or the deposit paused. If so, a JobInterruptedException is thrown. Interruption logged at info level.\n\nFix bug in virus scan job caused when not exception is returned by clam.\nIngest job throwing original exceptions instead of transaction exceptions.\nRemoved unused exception handling block from supervisor.\nRemoved extra scan of files in directory normalization job."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/f7726e75942f5796d8948c8fe7a860a8999e5c98", "committedDate": "2020-07-10T12:44:56Z", "message": "Tests for pausing and resuming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2MzgzODM4", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#pullrequestreview-446383838", "createdAt": "2020-07-10T13:04:58Z", "commit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzowNDo1OVrOGv2jJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzowNDo1OVrOGv2jJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgyOTk5MQ==", "bodyText": "Would this cause any noticeable slowdown in ingest, checking for interruptions so often in succession?", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#discussion_r452829991", "createdAt": "2020-07-10T13:04:59Z", "author": {"login": "lfarrell"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/normalize/BagIt2N3BagJob.java", "diffHunk": "@@ -92,10 +92,14 @@ public void runJob() {\n             MandatoryVerifier.checkBagitFileExists(bagReader.getRootDir(), bagReader.getVersion());\n \n             try (BagVerifier verifier = new BagVerifier()) {\n+                interruptJobIfStopped();\n                 verifier.isComplete(bagReader, false);\n+                interruptJobIfStopped();\n                 verifier.isValid(bagReader, false);\n             }\n \n+            interruptJobIfStopped();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Mzg2NDU5", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#pullrequestreview-446386459", "createdAt": "2020-07-10T13:08:59Z", "commit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzowODo1OVrOGv2rRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzowODo1OVrOGv2rRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzMjA2OA==", "bodyText": "Does DepositState.running need to be here twice?", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#discussion_r452832068", "createdAt": "2020-07-10T13:08:59Z", "author": {"login": "lfarrell"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJobTest.java", "diffHunk": "@@ -441,6 +450,52 @@ public void resumeIngestWorkObjectTest() throws Exception {\n         verify(jobStatusFactory).setTotalCompletion(eq(jobUUID), eq(3));\n     }\n \n+    @Test\n+    public void pauseAndResumeTest() throws Exception {\n+        PID workPid = makePid(RepositoryPathConstants.CONTENT_BASE);\n+        WorkObject work = mock(WorkObject.class);\n+        Bag workBag = setupWork(workPid, work);\n+\n+        String mainLoc = \"pdf.pdf\";\n+        String mainMime = \"application/pdf\";\n+        PID mainPid = addFileObject(workBag, mainLoc, mainMime);\n+\n+        workBag.addProperty(Cdr.primaryObject, model.getResource(mainPid.getRepositoryPath()));\n+\n+        job.closeModel();\n+\n+        when(work.addDataFile(any(PID.class), any(URI.class),\n+                anyString(), anyString(), anyString(), anyString(), any(Model.class)))\n+                .thenReturn(mockFileObj);\n+        when(mockFileObj.getPid()).thenReturn(mainPid);\n+\n+        when(depositStatusFactory.getState(depositUUID))\n+                .thenReturn(DepositState.running)\n+                .thenReturn(DepositState.running)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "originalPosition": 87}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ2Mzg3NTY5", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#pullrequestreview-446387569", "createdAt": "2020-07-10T13:10:38Z", "commit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzoxMDozOFrOGv2u1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xMFQxMzoxMDozOFrOGv2u1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjgzMjk4MA==", "bodyText": "Same here, does it need to be here twice?", "url": "https://github.com/UNC-Libraries/box-c/pull/1040#discussion_r452832980", "createdAt": "2020-07-10T13:10:38Z", "author": {"login": "lfarrell"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/validate/VirusScanJobTest.java", "diffHunk": "@@ -233,6 +234,49 @@ public void errorScanTest() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void pauseScanTest() throws Exception {\n+        when(scanResult.getStatus()).thenReturn(Status.PASSED);\n+\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        File pdfFile = new File(depositDir, \"pdf.pdf\");\n+        File textFile = new File(depositDir, \"text.txt\");\n+        PID file1Pid = addFileObject(depBag, pdfFile);\n+        PID file2Pid = addFileObject(depBag, textFile);\n+\n+        // Should be running for the first file, then paused\n+        when(depositStatusFactory.getState(depositUUID))\n+                .thenReturn(DepositState.running)\n+                .thenReturn(DepositState.running)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7726e75942f5796d8948c8fe7a860a8999e5c98"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2254, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}