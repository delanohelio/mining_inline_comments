{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3OTAyNzIy", "number": 1122, "title": "BXC-2854 - Deposit datastream resources", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2854\n\nRefactors datastreams in the deposit model to be their own resources so that they can have more properties recorded for them\nRecords digests for all datastreams which are transferred during deposits, including in some conflict scenarios\nSome additional properties recorded for more datastreams, like mimetype\nRemoves IngestDepositRecordJobTest as it is the exact same test as IngestDepositRecordJobIT\nRemoves unused methods and properties", "createdAt": "2020-11-09T16:56:24Z", "url": "https://github.com/UNC-Libraries/box-c/pull/1122", "merged": true, "mergeCommit": {"oid": "3591b05f7ac3180855c6e606370853216155fa95"}, "closed": true, "closedAt": "2020-11-10T20:28:20Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdaVYozgH2gAyNTE3OTAyNzIyOmRjOTQ2ZTA4MWJhNzY0NTQ2MTk1ODczZDdmMjU4MTM5N2MxYjU5YTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbOuJcAH2gAyNTE3OTAyNzIyOjRjMTlkZjI1Mzg0ODUyMjcxZjBlNTZkZjJiMjFlZDE4NjdhMjI2NTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dc946e081ba764546195873d7f2581397c1b59a0", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/dc946e081ba764546195873d7f2581397c1b59a0", "committedDate": "2020-11-08T00:54:11Z", "message": "First batch of updates to change binaries to being resource in deposit model, so that properties can be stored for each of them"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffd70d564070b2c6060f12695495731bd00fcfa2", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/ffd70d564070b2c6060f12695495731bd00fcfa2", "committedDate": "2020-11-08T00:54:11Z", "message": "Update transfer job to new binary model. Include sha1 in binary details"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a868e8b89a5b4d4355a64b5b1e0c869bd13f40d", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/2a868e8b89a5b4d4355a64b5b1e0c869bd13f40d", "committedDate": "2020-11-09T13:50:52Z", "message": "Update additional deposit jobs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0daf5ecc33413ca3e14a9e2b7e2447ef1457622d", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/0daf5ecc33413ca3e14a9e2b7e2447ef1457622d", "committedDate": "2020-11-09T16:43:34Z", "message": "Add helper methods for working with datastreams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0696bd7a8272ba572301beeab7ed3fb77062d20", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/c0696bd7a8272ba572301beeab7ed3fb77062d20", "committedDate": "2020-11-09T22:01:20Z", "message": "Fix PID of mods history datastream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/7b11ca0df2651a3bcc5dbf72724333478d5a9f1b", "committedDate": "2020-11-10T15:26:39Z", "message": "Add migration and deposit of fits history files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTA2Mjgy", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#pullrequestreview-527506282", "createdAt": "2020-11-10T18:45:28Z", "commit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxODo0NToyOVrOHwqcVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxOToxNjoyMFrOHwr7GA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDc4OTA3OA==", "bodyText": "is this unnecessary", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520789078", "createdAt": "2020-11-10T18:45:29Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -196,27 +238,28 @@ private void transferDepositManifests(PID objPid, Resource resc, BinaryTransferS\n             }\n \n             PID manifestPid = getDepositManifestPid(objPid, manifestFile.getName());\n-            transferFile(manifestPid, manifestUri, transferSession, resc, CdrDeposit.storageUri);\n+            transferFile(manifestPid, manifestUri, transferSession, resc, CdrDeposit.hasDatastreamManifest);\n         }\n     }\n \n     private void transferFile(PID binPid, URI stagingUri, BinaryTransferSession transferSession,\n-            Resource resc, Property storageProperty) {\n-\n-        log.debug(\"Transferring {} file from {} for {}\", storageProperty.getLocalName(),\n-                stagingUri, binPid.getQualifiedId());\n+            Resource parentResc, Property datastreamProperty) {\n         URI storageUri = null;\n+        String digest = null;\n+        Resource binResc = model.getResource(binPid.getRepositoryPath());\n+\n+        // Already has storageUri, skip transfer\n+        if (binResc.hasProperty(CdrDeposit.storageUri)) {\n+            return;\n+        }\n+\n+        log.debug(\"Transferring file from {} for {}\", stagingUri, binPid.getQualifiedId());\n+\n+        Statement digestStmt = binResc.getProperty(DEFAULT_ALGORITHM.getDepositProperty());\n         try {\n             BinaryTransferOutcome outcome = transferSession.transfer(binPid, stagingUri);\n-            Statement digestStmt = resc.getProperty(DigestAlgorithm.DEFAULT_ALGORITHM.getDepositProperty());\n-            if (digestStmt != null) {\n-                String digest = digestStmt.getString();\n-                if (!digest.equals(outcome.getSha1())) {\n-                    throw new InvalidChecksumException(\"Checksum of copied file for \" + binPid\n-                            + \" from \" + stagingUri + \" did not match expected SHA1: expected \"\n-                            + digest + \", calculated \" + outcome.getSha1());\n-                }\n-            }\n+            digest = outcome.getSha1();\n+            assertProvidedDigestMatches(digestStmt, digest, binPid, stagingUri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 192}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgwOTQxOA==", "bodyText": "Are we verifying that fits history is being transferred?", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520809418", "createdAt": "2020-11-10T19:09:30Z", "author": {"login": "bbpennel"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJobTest.java", "diffHunk": "@@ -181,6 +192,47 @@ public void depositWithWorkContainingFileAndFits() throws Exception {\n         verify(jobStatusFactory, times(3)).incrCompletion(eq(jobUUID), eq(1));\n     }\n \n+    @Test\n+    public void depositWithWorkContainingFileAndFitsHistory() throws Exception {\n+        Bag workBag = addContainerObject(depBag, Cdr.Work);\n+        Resource fileResc = addFileObject(workBag, FILE_CONTENT1, true);\n+        workBag.addProperty(Cdr.primaryObject, fileResc);\n+\n+        String historyContent = \"History of fitness\";\n+        PID pid = PIDs.get(workBag.getURI());\n+        Path preHistoryPath = depositDirManager.writeHistoryFile(pid, TECHNICAL_METADATA_HISTORY,\n+                IOUtils.toInputStream(historyContent, UTF_8));\n+        Resource preHistoryResc = DepositModelHelpers.addDatastream(workBag, TECHNICAL_METADATA_HISTORY);\n+        preHistoryResc.addLiteral(CdrDeposit.stagingLocation, preHistoryPath.toUri().toString());\n+\n+        job.closeModel();\n+\n+        job.run();\n+\n+        Model model = job.getReadOnlyModel();\n+        Resource postFileResc = model.getResource(fileResc.getURI());\n+\n+        assertOriginalFileTransferred(postFileResc, FILE_CONTENT1);\n+        assertFitsFileTransferred(postFileResc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDgxMzMzNg==", "bodyText": "delete me", "url": "https://github.com/UNC-Libraries/box-c/pull/1122#discussion_r520813336", "createdAt": "2020-11-10T19:16:20Z", "author": {"login": "bbpennel"}, "path": "metadata/src/main/java/edu/unc/lib/dl/util/DepositStatusFactory.java", "diffHunk": "@@ -65,13 +65,6 @@ public DepositStatusFactory() {\n         return result;\n     }\n \n-    public void addManifest(String depositUUID, String value) {\n-        try (Jedis jedis = getJedisPool().getResource()) {\n-            jedis.rpush(DEPOSIT_MANIFEST_PREFIX + depositUUID, value);\n-        }\n-\n-    }\n-\n     public List<String> getManifestURIs(String depositUUID) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b11ca0df2651a3bcc5dbf72724333478d5a9f1b"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c19df25384852271f0e56df2b21ed1867a22659", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/4c19df25384852271f0e56df2b21ed1867a22659", "committedDate": "2020-11-10T19:42:16Z", "message": "Remove unused methods, fix fits history transfer test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2180, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}