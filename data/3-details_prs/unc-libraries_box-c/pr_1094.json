{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1Njk1Nzcx", "number": 1094, "title": "BXC-2803: Switch ingest file transfers from move to copy", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2803", "createdAt": "2020-09-30T18:23:58Z", "url": "https://github.com/UNC-Libraries/box-c/pull/1094", "merged": true, "mergeCommit": {"oid": "4eb70b7e2826a5ffe0bf61e4a8a8a6e0b6665cda"}, "closed": true, "closedAt": "2020-10-02T18:22:21Z", "author": {"login": "lfarrell"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOCJlLgBqjM4MjYxNTk1MDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOqMMBAFqTUwMTM1MzU0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "12f0b68b36ade0dff88d98617ddfdd86d3ce5151", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/12f0b68b36ade0dff88d98617ddfdd86d3ce5151", "committedDate": "2020-09-30T18:19:47Z", "message": "Switch ingest file transfers from move to copy"}, "afterCommit": {"oid": "a7f37336fd3b0826cbea47bff846b920cafa4bb0", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/a7f37336fd3b0826cbea47bff846b920cafa4bb0", "committedDate": "2020-09-30T19:42:13Z", "message": "Switch ingest file transfers from move to copy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d643c485877b96718fddb7a1638332f1fc3e3065", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/d643c485877b96718fddb7a1638332f1fc3e3065", "committedDate": "2020-09-30T19:44:42Z", "message": "Move CSV export to services and add IT test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a7f37336fd3b0826cbea47bff846b920cafa4bb0", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/a7f37336fd3b0826cbea47bff846b920cafa4bb0", "committedDate": "2020-09-30T19:42:13Z", "message": "Switch ingest file transfers from move to copy"}, "afterCommit": {"oid": "d643c485877b96718fddb7a1638332f1fc3e3065", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/d643c485877b96718fddb7a1638332f1fc3e3065", "committedDate": "2020-09-30T19:44:42Z", "message": "Move CSV export to services and add IT test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMzk4MTI5", "url": "https://github.com/UNC-Libraries/box-c/pull/1094#pullrequestreview-500398129", "createdAt": "2020-10-01T14:19:42Z", "commit": {"oid": "d643c485877b96718fddb7a1638332f1fc3e3065"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoxOTo0MlrOHbMstw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNDoyNjoxMlrOHbNArg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4MTY1NQ==", "bodyText": "we still want to use move for renaming the temp/old files since it is within the same storage location, its just for source files (which doesn't exist for this client) that we want to switch to copy", "url": "https://github.com/UNC-Libraries/box-c/pull/1094#discussion_r498281655", "createdAt": "2020-10-01T14:19:42Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/transfer/StreamToFSTransferClient.java", "diffHunk": "@@ -98,7 +98,7 @@ protected URI writeStream(PID binPid, InputStream sourceStream, boolean allowOve\n             }\n \n             // Move temp file into final location\n-            Files.move(newFilePath, destPath, REPLACE_EXISTING);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d643c485877b96718fddb7a1638332f1fc3e3065"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODI4Njc2Ng==", "bodyText": "We don't want to perform cleanup in here, the code calling the transfer client should now be responsible for cleanup of the source file. For instance, with deposits the cleanup deposit job should handle this (you should verify that it does so after these changes. To test on your vm I suggest setting the cleanup time property for the deposit application to something very low, like 20second). The intention of switching to copy is so that we don't lose the source data in the case that the larger operation fails.\nYou should also check if there are other uses of this transfer method from non-deposit related activities, since they should now be doing their own source file cleanup.", "url": "https://github.com/UNC-Libraries/box-c/pull/1094#discussion_r498286766", "createdAt": "2020-10-01T14:26:12Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/transfer/FSToFSTransferClient.java", "diffHunk": "@@ -112,6 +108,16 @@ public URI transfer(PID binPid, URI sourceFileUri, boolean allowOverwrite) {\n                 // Ignore. New file is already in place\n                 log.warn(\"Unable to delete {}. Reason {}\", oldFilePath, e.getMessage());\n             }\n+\n+            // Remove source file after deposited\n+            if (!source.isReadOnly()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d643c485877b96718fddb7a1638332f1fc3e3065"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52ec5e086250a2869bb1c4c19b72e3dd4c62c54a", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/52ec5e086250a2869bb1c4c19b72e3dd4c62c54a", "committedDate": "2020-10-02T13:30:23Z", "message": "Don't clean up files immediately after transfer"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0275421fe3b034b3946d5b218a7b2e0596f75aa3", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/0275421fe3b034b3946d5b218a7b2e0596f75aa3", "committedDate": "2020-10-02T12:57:25Z", "message": "Don't clean up files immediately after transfer"}, "afterCommit": {"oid": "52ec5e086250a2869bb1c4c19b72e3dd4c62c54a", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/52ec5e086250a2869bb1c4c19b72e3dd4c62c54a", "committedDate": "2020-10-02T13:30:23Z", "message": "Don't clean up files immediately after transfer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e09d1ad7f5f816eea67ed6d90a2953f4c047729", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/7e09d1ad7f5f816eea67ed6d90a2953f4c047729", "committedDate": "2020-10-02T18:21:10Z", "message": "Remove commented out line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMzUzNTQ4", "url": "https://github.com/UNC-Libraries/box-c/pull/1094#pullrequestreview-501353548", "createdAt": "2020-10-02T18:21:30Z", "commit": {"oid": "7e09d1ad7f5f816eea67ed6d90a2953f4c047729"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2289, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}