{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjI3MzI5", "number": 1032, "title": "Add retry if work object ingest gives a checksum mismatch", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2698", "createdAt": "2020-06-30T18:45:38Z", "url": "https://github.com/UNC-Libraries/box-c/pull/1032", "merged": true, "mergeCommit": {"oid": "c842f75b9d857b7914c83e59522ad5c629a6cf77"}, "closed": true, "closedAt": "2020-07-02T17:08:34Z", "author": {"login": "lfarrell"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwaQtnAH2gAyNDQyMjI3MzI5OjJjM2ZjYzM5NmRkYzkzODUyN2ZkMzU3MmQ5NWQ3ZmRhZTQ3MTQzMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxAbckgBqjM1MDc2MTA2OTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2c3fcc396ddc938527fd3572d95d7fdae4714300", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/2c3fcc396ddc938527fd3572d95d7fdae4714300", "committedDate": "2020-06-30T18:50:14Z", "message": "Add retry if work object ingest gives a checksum mismatch"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aa7b5872fc791eafb3a715ad56f090cc0e1e3a9a", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/aa7b5872fc791eafb3a715ad56f090cc0e1e3a9a", "committedDate": "2020-06-30T18:43:28Z", "message": "Add retry if work object ingest gives a checksum mismatch"}, "afterCommit": {"oid": "2c3fcc396ddc938527fd3572d95d7fdae4714300", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/2c3fcc396ddc938527fd3572d95d7fdae4714300", "committedDate": "2020-06-30T18:50:14Z", "message": "Add retry if work object ingest gives a checksum mismatch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2d310eb0e654e80722f8311f8d03020aefd7d5e", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/f2d310eb0e654e80722f8311f8d03020aefd7d5e", "committedDate": "2020-06-30T19:48:13Z", "message": "Move retry to IngestWork method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79ee7dadf60673869525854b4b36e5e8da3b486a", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/79ee7dadf60673869525854b4b36e5e8da3b486a", "committedDate": "2020-07-01T15:07:33Z", "message": "Cancel transaction before retrying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxMDMwMjk0", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#pullrequestreview-441030294", "createdAt": "2020-07-01T16:36:19Z", "commit": {"oid": "79ee7dadf60673869525854b4b36e5e8da3b486a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozNjoyMFrOGrtWeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozNjoyMFrOGrtWeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4NDk4NA==", "bodyText": "what about overriding the method signature to private void ingestWork(ContentContainerObject parent, Resource parentResc, Resource childResc, int retries) and the same thing without retries. Most stuff would call the version without retries, which would supply the starting number of retries at 3.\nThen you should be able to do something like:\n} catch (ChecksumMismatchException e) {\n     // Rollback changes for the work so far\n     txRefresher.interrupt();\n     tx.cancel();\n     if (retries > 0) {\n         retries--;\n         ingestWork(parent, parentResc, childResc, retries);\n     } else {\n         failJob(...);\n     }\n\nI think if a work had more than one file and failed partway through, it would try to reingest those other files and run into a conflict since they'd already exist.", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448484984", "createdAt": "2020-07-01T16:36:20Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,28 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79ee7dadf60673869525854b4b36e5e8da3b486a"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c001893ddcd2d69212945c775a8dd6bba4ebbf2", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/9c001893ddcd2d69212945c775a8dd6bba4ebbf2", "committedDate": "2020-07-01T17:02:24Z", "message": "Add retries as a method parameter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174b3dc7400c8288090428873f930710fde2c5de", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/174b3dc7400c8288090428873f930710fde2c5de", "committedDate": "2020-07-01T19:14:07Z", "message": "Cancel transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d", "committedDate": "2020-07-01T19:45:35Z", "message": "Update expected error"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNjM5MDg4", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#pullrequestreview-441639088", "createdAt": "2020-07-02T12:41:21Z", "commit": {"oid": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjo0MToyMVrOGsLEZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjo0MToyMVrOGsLEZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MTg3OQ==", "bodyText": "Could you add a warn level message stating that there was a checksum mismatch, probably include the message from the error? So that we see if this issue is occurring", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448971879", "createdAt": "2020-07-02T12:41:21Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,16 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {\n+                txRefresher.interrupt();\n+                tx.cancelAndIgnore();\n+\n+                if (retries > 0) {\n+                    retries--;\n+                    ingestWork(parent, parentResc, childResc, retries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8d857fab40e331bc321f59d08278c8a6c7f55e", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/da8d857fab40e331bc321f59d08278c8a6c7f55e", "committedDate": "2020-07-02T15:18:05Z", "message": "Add log warning if retrying ingest due to a checksum mismatch."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ba31f51b1eb596d7df96005a204f99308f17134f", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/ba31f51b1eb596d7df96005a204f99308f17134f", "committedDate": "2020-07-02T13:59:14Z", "message": "Move log message"}, "afterCommit": {"oid": "da8d857fab40e331bc321f59d08278c8a6c7f55e", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/da8d857fab40e331bc321f59d08278c8a6c7f55e", "committedDate": "2020-07-02T15:18:05Z", "message": "Add log warning if retrying ingest due to a checksum mismatch."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2242, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}