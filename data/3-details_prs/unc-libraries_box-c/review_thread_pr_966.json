{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMTQ2MTM2", "number": 966, "reviewThreads": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDoyMjoxMVrOD3OCww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxNTo0NFrOEDCKAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MjI4MzU1OnYy", "diffSide": "RIGHT", "path": "metadata/src/main/java/edu/unc/lib/dl/rdf/Premis.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDoyMjoxMVrOGNWj2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDoyMjoxMVrOGNWj2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY1NDI5Ng==", "bodyText": "Could you rename this to \"Dissemination\" and move it up in with the other eventTypes above, alphabetically?", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416654296", "createdAt": "2020-04-28T14:22:11Z", "author": {"login": "bbpennel"}, "path": "metadata/src/main/java/edu/unc/lib/dl/rdf/Premis.java", "diffHunk": "@@ -268,4 +268,7 @@ public static String getURI() {\n     public static final Resource Fail = createResource(\"http://id.loc.gov/vocabulary/preservation/eventOutcome/fai\");\n \n     public static final Resource Success = createResource(\"http://id.loc.gov/vocabulary/preservation/eventOutcome/suc\");\n+\n+    public static final Resource ExpireEmbargo = createResource(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MjM2NzE5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDozODozM1rOGNXYHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNDozODozM1rOGNXYHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjY2NzY3Ng==", "bodyText": "you can do model.getResource(repoObj.getResource()); to save a step", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416667676", "createdAt": "2020-04-28T14:38:33Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {\n+            RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+            Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+            Resource resc = model.getResource(repoObj.getPid().getRepositoryPath());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Mjk0NjE5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjozNjoxNVrOGNc98A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjozNjoxNVrOGNc98A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1OTI4MA==", "bodyText": "So it seems like the two remaining steps are detecting expired embargoes, and performing this check periodically.\nTo detect expired embargoes, you'll need to run a sparql query. You should be able to inject an instance of SparqlQueryService to do this. For an example of its usage, you can see:\nhttps://github.com/UNC-Libraries/Carolina-Digital-Repository/blob/fcrepo4/persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyProxyService.java#L82-L105\nYou'll need to query for objects with an embargoUtil property in the past. This post might be helpful https://stackoverflow.com/questions/24051435/filter-by-date-range-in-sparql\nMy guess is that implementing this will inform the design of expireEmbargo some as well. You will most likely just be starting from a PID.\nFor the other step of performing a method on a schedule, one option is this annotation:\nhttps://www.baeldung.com/spring-scheduled-tasks", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416759280", "createdAt": "2020-04-28T16:36:15Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Mjk4MjQ4OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo0NDo1MVrOGNdUrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo0NDo1MVrOGNdUrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2NTEwMA==", "bodyText": "You may want to use the deleteProperty method in RepositoryObjectFactory which can be used to delete all triples with a particular predicate on an object directly in the repository.\nYou may have already been looking some at the existing service for updating patron access controls:\nhttps://github.com/UNC-Libraries/Carolina-Digital-Repository/blob/8f456d1b07a9737b389756a9fe1cbb38c5d238e2/persistence/src/main/java/edu/unc/lib/dl/persist/services/acl/PatronAccessAssignmentService.java\nBut it updates a lot of settings at once, so it might not be a great model. There may be useful details in the updateEmbargo method, but its probably overkill.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416765100", "createdAt": "2020-04-28T16:44:51Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {\n+            RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+            Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+            Resource resc = model.getResource(repoObj.getPid().getRepositoryPath());\n+\n+            String eventText = null;\n+\n+            // remove embargo from access controls\n+            Date accessDetailsEmbargo = accessDetails.getEmbargo();\n+\n+            boolean expiredEmbargo = false;\n+            if (accessDetailsEmbargo != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5Mjk5NzM0OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo0ODoxMVrOGNddvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo0ODoxMVrOGNddvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc2NzQyMg==", "bodyText": "You should wrap removal of the embargo and adding of the premis event into a transaction. There should be good examples of the usage patterns for TransactionManager elsewhere in this module.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416767422", "createdAt": "2020-04-28T16:48:11Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzAyMTM4OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo1MzoyNFrOGNdseg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo1MzoyNFrOGNdseg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3MTE5NA==", "bodyText": "Looks like we want to use a software agent for these events according to the profile. There are enumerations for these, although we may need to update one of them to match the profile.\nSee edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent\nThe profile is here:\nhttps://docs.google.com/spreadsheets/d/1GdHWCI_4iY0TcQv_B_Xa4-mZoA4X-BgSafnXA4FRVsI/edit#gid=1409504546&range=324:337\nSo I think the value is supposed to be embargo-update-service", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416771194", "createdAt": "2020-04-28T16:53:24Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {\n+            RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+            Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+            Resource resc = model.getResource(repoObj.getPid().getRepositoryPath());\n+\n+            String eventText = null;\n+\n+            // remove embargo from access controls\n+            Date accessDetailsEmbargo = accessDetails.getEmbargo();\n+\n+            boolean expiredEmbargo = false;\n+            if (accessDetailsEmbargo != null) {\n+                accessDetails.setEmbargo(null);\n+                expiredEmbargo = true;\n+            }\n+            if (resc.hasProperty(embargoUntil)) {\n+                resc.removeAll(embargoUntil);\n+                expiredEmbargo = true;\n+            }\n+\n+            if (expiredEmbargo) {\n+                eventText = \"Expired an embargo which ended \" + accessDetailsEmbargo.toString();\n+            } else {\n+                eventText = \"Failed to expire embargo.\";\n+            }\n+\n+            // Produce the premis event for this embargo\n+            Resource embargoEvent = repoObj.getPremisLog().buildEvent(Premis.ExpireEmbargo)\n+                    .addImplementorAgent(agent.getUsernameUri())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzA0NDA5OnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo1ODo1MlrOGNd6kA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjo1ODo1MlrOGNd6kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3NDgwMA==", "bodyText": "It would be good to have an integration test of this functionality, and it may actually be easier to write than a unit test, particularly once you have the sparql query stuff in there, so you're welcome to switch this over to being an integration test.\nDestroyObjectsJobIT would probably be a good reference, it has a lot of the same needs as this service, plus some extra stuff you don't need (you don't need to create nearly as many objects for example). The context files it uses might be fine too, although i haven't looked closely. The treeIndexer usage should be pretty helpful in terms of populating the triple store. I'm happy to consult or help get things started if that would be useful.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416774800", "createdAt": "2020-04-28T16:58:52Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceTest.java", "diffHunk": "@@ -0,0 +1,143 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisEventBuilder;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.test.SelfReturningAnswer;\n+import org.apache.jena.rdf.model.Literal;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+\n+import java.util.Calendar;\n+import java.util.Date;\n+import java.util.UUID;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static org.junit.Assert.assertEquals;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Matchers.anyString;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+public class ExpireEmbargoServiceTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzA0OTE0OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzowMDoxMFrOGNd9wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzowMDoxMFrOGNd9wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3NTYxNg==", "bodyText": "I don't think you need to do this step, the usage of writeAndClose just above this should be pushing the event directly to fedora.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416775616", "createdAt": "2020-04-28T17:00:10Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {\n+            RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+            Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+            Resource resc = model.getResource(repoObj.getPid().getRepositoryPath());\n+\n+            String eventText = null;\n+\n+            // remove embargo from access controls\n+            Date accessDetailsEmbargo = accessDetails.getEmbargo();\n+\n+            boolean expiredEmbargo = false;\n+            if (accessDetailsEmbargo != null) {\n+                accessDetails.setEmbargo(null);\n+                expiredEmbargo = true;\n+            }\n+            if (resc.hasProperty(embargoUntil)) {\n+                resc.removeAll(embargoUntil);\n+                expiredEmbargo = true;\n+            }\n+\n+            if (expiredEmbargo) {\n+                eventText = \"Expired an embargo which ended \" + accessDetailsEmbargo.toString();\n+            } else {\n+                eventText = \"Failed to expire embargo.\";\n+            }\n+\n+            // Produce the premis event for this embargo\n+            Resource embargoEvent = repoObj.getPremisLog().buildEvent(Premis.ExpireEmbargo)\n+                    .addImplementorAgent(agent.getUsernameUri())\n+                    .addEventDetail(eventText)\n+                    .writeAndClose();\n+            // write premis event to log\n+            writePremisEvents(repoObj, embargoEvent);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 83}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5MzA1MjQ1OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzowMTowMlrOGNd_7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNzowMTowMlrOGNd_7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc3NjE3Mg==", "bodyText": "I think we will need to emit a message if an embargo is expired. It should be the same as here https://github.com/UNC-Libraries/Carolina-Digital-Repository/blob/8f456d1b07a9737b389756a9fe1cbb38c5d238e2/persistence/src/main/java/edu/unc/lib/dl/persist/services/acl/PatronAccessAssignmentService.java#L127", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r416776172", "createdAt": "2020-04-28T17:01:02Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,101 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.acl.PatronAccessDetails;\n+import edu.unc.lib.dl.rdf.Premis;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+\n+import java.util.Date;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectLoader repoObjLoader;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    public void expireEmbargo(PID pid, PatronAccessDetails accessDetails, AgentPrincipals agent) {\n+        try (Timer.Context context = timer.time()) {\n+            RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+            Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+            Resource resc = model.getResource(repoObj.getPid().getRepositoryPath());\n+\n+            String eventText = null;\n+\n+            // remove embargo from access controls\n+            Date accessDetailsEmbargo = accessDetails.getEmbargo();\n+\n+            boolean expiredEmbargo = false;\n+            if (accessDetailsEmbargo != null) {\n+                accessDetails.setEmbargo(null);\n+                expiredEmbargo = true;\n+            }\n+            if (resc.hasProperty(embargoUntil)) {\n+                resc.removeAll(embargoUntil);\n+                expiredEmbargo = true;\n+            }\n+\n+            if (expiredEmbargo) {\n+                eventText = \"Expired an embargo which ended \" + accessDetailsEmbargo.toString();\n+            } else {\n+                eventText = \"Failed to expire embargo.\";\n+            }\n+\n+            // Produce the premis event for this embargo\n+            Resource embargoEvent = repoObj.getPremisLog().buildEvent(Premis.ExpireEmbargo)\n+                    .addImplementorAgent(agent.getUsernameUri())\n+                    .addEventDetail(eventText)\n+                    .writeAndClose();\n+            // write premis event to log\n+            writePremisEvents(repoObj, embargoEvent);\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4668a5c51d3f16524db10be8e9a2905004ab79f"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzI3MzgwOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1ODoyM1rOGYbslQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxOTo1ODoyM1rOGYbslQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI3Mjc4OQ==", "bodyText": "Should be a timer for ExpireEmbargoService", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428272789", "createdAt": "2020-05-20T19:58:23Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzUwODYyOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNDoxNFrOGYeB3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNDoxNFrOGYeB3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMTAwNw==", "bodyText": "You should be able to reuse DateTimeUtil.utcFormatter", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428311007", "createdAt": "2020-05-20T21:14:14Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    expiredEmbargo = true;\n+                }\n+\n+                if (expiredEmbargo) {\n+                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                } else {\n+                    eventText = \"Failed to expire embargo.\";\n+                }\n+\n+                // Produce the premis event for this embargo\n+                repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                        .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                        .addEventDetail(eventText)\n+                        .writeAndClose();\n+            }\n+\n+            // send a message for expired embargoes\n+            operationsMessageSender.sendOperationMessage(SoftwareAgent.embargoExpirationService.getFullname(),\n+                    JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL,\n+                    pids);\n+        } catch (Exception e) {\n+            tx.cancelAndIgnore();\n+            throw e;\n+        } finally {\n+            tx.close();\n+        }\n+    }\n+\n+    private final static String EMBARGO_QUERY =\n+            \"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\\n\" +\n+                    \"select ?resource ?date\\n\" +\n+                    \"where {\\n\" +\n+                    \"  ?resource <http://cdr.unc.edu/definitions/acl#embargoUntil> ?date .\\n\" +\n+                    \"  FILTER (?date < \\\"%s\\\"^^xsd:dateTime)\\n\" +\n+                    \"}\";\n+\n+    private List<String> getEmbargoInfo() {\n+        DateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzUxNDQxOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNjoyMlrOGYeFiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToxNjoyMlrOGYeFiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMTk0NA==", "bodyText": "I don't think you need to return ?date here since its not being used outside the query", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428311944", "createdAt": "2020-05-20T21:16:22Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    expiredEmbargo = true;\n+                }\n+\n+                if (expiredEmbargo) {\n+                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                } else {\n+                    eventText = \"Failed to expire embargo.\";\n+                }\n+\n+                // Produce the premis event for this embargo\n+                repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                        .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                        .addEventDetail(eventText)\n+                        .writeAndClose();\n+            }\n+\n+            // send a message for expired embargoes\n+            operationsMessageSender.sendOperationMessage(SoftwareAgent.embargoExpirationService.getFullname(),\n+                    JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL,\n+                    pids);\n+        } catch (Exception e) {\n+            tx.cancelAndIgnore();\n+            throw e;\n+        } finally {\n+            tx.close();\n+        }\n+    }\n+\n+    private final static String EMBARGO_QUERY =\n+            \"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\\n\" +\n+                    \"select ?resource ?date\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzUyNDA0OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToyMDowMVrOGYeL8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToyMDowMVrOGYeL8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxMzU4NQ==", "bodyText": "since you don't really need the loop control variable's value here, it'd probably make more sense to use a for each\nfor (String rescUri: resourceList) { ...\nor\nresourceList.forEach(rescUri -> { ...", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428313585", "createdAt": "2020-05-20T21:20:01Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzU1MDY5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToyOTowNVrOGYecPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMToyOTowNVrOGYecPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxNzc1OQ==", "bodyText": "I think you can remove this conditional, everything returned by the sparql query should have it, and if it weren't present i think there would be a null pointer exception at line 93", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428317759", "createdAt": "2020-05-20T21:29:05Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzU2MTQ2OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozMjowMlrOGYejIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozMjowMlrOGYejIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMxOTUyMg==", "bodyText": "you can probably skip cloning this model. The deleteProperty method edits the value directly to fedora rather than the local copy. Also, you can go directly to the resource by calling repoObj.getResource()", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428319522", "createdAt": "2020-05-20T21:32:02Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzU3NjU2OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozNzoyN1rOGYessw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozNzoyN1rOGYessw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMTk3MQ==", "bodyText": "this method isn't used", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428321971", "createdAt": "2020-05-20T21:37:27Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    expiredEmbargo = true;\n+                }\n+\n+                if (expiredEmbargo) {\n+                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                } else {\n+                    eventText = \"Failed to expire embargo.\";\n+                }\n+\n+                // Produce the premis event for this embargo\n+                repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                        .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                        .addEventDetail(eventText)\n+                        .writeAndClose();\n+            }\n+\n+            // send a message for expired embargoes\n+            operationsMessageSender.sendOperationMessage(SoftwareAgent.embargoExpirationService.getFullname(),\n+                    JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL,\n+                    pids);\n+        } catch (Exception e) {\n+            tx.cancelAndIgnore();\n+            throw e;\n+        } finally {\n+            tx.close();\n+        }\n+    }\n+\n+    private final static String EMBARGO_QUERY =\n+            \"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\\n\" +\n+                    \"select ?resource ?date\\n\" +\n+                    \"where {\\n\" +\n+                    \"  ?resource <http://cdr.unc.edu/definitions/acl#embargoUntil> ?date .\\n\" +\n+                    \"  FILTER (?date < \\\"%s\\\"^^xsd:dateTime)\\n\" +\n+                    \"}\";\n+\n+    private List<String> getEmbargoInfo() {\n+        DateFormat dateFormat = new SimpleDateFormat(\"yyyy-MM-dd'T'HH:mm:ss.SSS'Z'\");\n+        String today = dateFormat.format(new Date());\n+        String query = String.format(EMBARGO_QUERY, today);\n+\n+        try (QueryExecution exec = sparqlQueryService.executeQuery(query)) {\n+            ResultSet resultSet = exec.execSelect();\n+            List<String> embargoedRescList = new ArrayList<>();\n+\n+            for (; resultSet.hasNext() ;) {\n+                QuerySolution soln = resultSet.nextSolution();\n+                Resource resc = soln.getResource(\"resource\");\n+                embargoedRescList.add(resc.getURI());\n+            }\n+            return embargoedRescList;\n+        }\n+    }\n+\n+\n+    /**\n+     * @param sparqlQueryService the sparqlQueryService to set\n+     */\n+    public void setSparqlQueryService(SparqlQueryService sparqlQueryService) {\n+        this.sparqlQueryService = sparqlQueryService;\n+    }\n+\n+    private void writePremisEvents(RepositoryObject repoObj, Resource embargoEvent) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 161}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzU4Mjg5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozOTo0N1rOGYew2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTozOTo0N1rOGYew2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyMzAzMg==", "bodyText": "You can remove the pid from the log entry", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428323032", "createdAt": "2020-05-20T21:39:47Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    expiredEmbargo = true;\n+                }\n+\n+                if (expiredEmbargo) {\n+                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 102}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzYxMDA0OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo0ODo1N1rOGYfB3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo0ODo1N1rOGYfB3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyNzM5MA==", "bodyText": "I see that this came from the premis spreadsheet, but i'm not really sure what cases we would be capturing with the failed premis event (maybe just that the triple store was out of sync with fedora?). I'd be inclined to remove this. A more likely failure would be a thrown exception, but there's a pretty high chance in that case that we wouldn't be able to update the premis log in fedora.\nSpeaking of which, i'm not really sure how an error thrown in here gets logged, did you see if it went to the services-camel log?", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428327390", "createdAt": "2020-05-20T21:48:57Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();\n+\n+        try (Timer.Context context = timer.time()) {\n+            // get list of expired embargoes\n+            List<String> resourceList = getEmbargoInfo();\n+            Collection<PID> pids = new ArrayList<>();\n+\n+            // remove all expired embargoes\n+            for (int i = 0; i < resourceList.size(); i++) {\n+                String rescUri = resourceList.get(i);\n+                PID pid = PIDs.get(rescUri);\n+                RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n+                Resource resc = model.getResource(rescUri);\n+\n+                String eventText = null;\n+                boolean expiredEmbargo = false;\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+\n+                if (resc.hasProperty(embargoUntil)) {\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    expiredEmbargo = true;\n+                }\n+\n+                if (expiredEmbargo) {\n+                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                } else {\n+                    eventText = \"Failed to expire embargo.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzYxNzI5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1MTo0M1rOGYfGcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1MTo0M1rOGYfGcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyODU2MQ==", "bodyText": "It should probably be a transaction per object having its embargo expired. If one were to fail, then none of the others would get updated, so we might end up with no embargoes getting expired for a while", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428328561", "createdAt": "2020-05-20T21:51:43Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.event.PremisLogger;\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.ModelFactory;\n+import org.apache.jena.rdf.model.Resource;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+\n+import java.text.DateFormat;\n+import java.text.SimpleDateFormat;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        FedoraTransaction tx = txManager.startTransaction();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 76}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzYyMDAzOnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1MjozMVrOGYfIBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1MjozMVrOGYfIBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyODk2Ng==", "bodyText": "queryModel and fcrepoClient aren't being used here", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428328966", "createdAt": "2020-05-20T21:52:31Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzYyNTc5OnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1NDoyMFrOGYfLTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1NDoyMFrOGYfLTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMyOTgwNg==", "bodyText": "could you add a test to verify that no embargoes get cleared when there are embargoes present in the future?", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428329806", "createdAt": "2020-05-20T21:54:20Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzYzMzQzOnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1NzowNlrOGYfP3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1NzowNlrOGYfP3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMDk3NQ==", "bodyText": "should split this into two lines, 120 is the max line length (I think checkstyles might be configured weird for tests at the moment)", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428330975", "createdAt": "2020-05-20T21:57:06Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;\n+    @Autowired\n+    private FcrepoClient fcrepoClient;\n+    @Autowired\n+    private RepositoryObjectLoader repoObjLoader;\n+    @Autowired\n+    private RepositoryObjectFactory repoObjFactory;\n+    @Mock\n+    private OperationsMessageSender operationsMessageSender;\n+    @Autowired\n+    private TransactionManager txManager;\n+    @Autowired\n+    private SparqlQueryService sparqlQueryService;\n+    @Autowired\n+    private RepositoryObjectTreeIndexer treeIndexer;\n+    @Captor\n+    private ArgumentCaptor<List<PID>> pidListCaptor;\n+\n+    private ExpireEmbargoService service;\n+\n+    private ContentRootObject contentRoot;\n+\n+    private AdminUnit adminUnit;\n+\n+    private CollectionObject collObj1;\n+    private CollectionObject collObj2;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        TestHelper.setContentBase(baseAddress);\n+\n+        service = new ExpireEmbargoService();\n+        service.setOperationsMessageSender(operationsMessageSender);\n+        service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n+        service.setTransactionManager(txManager);\n+        service.setSparqlQueryService(sparqlQueryService);\n+\n+        PID contentRootPid = RepositoryPaths.getContentRootPid();\n+        try {\n+            repoObjFactory.createContentRootObject(\n+                    contentRootPid.getRepositoryUri(), null);\n+        } catch (FedoraException e) {\n+            // Ignore failure as the content root will already exist after first test\n+        }\n+        contentRoot = repoObjLoader.getContentRootObject(contentRootPid);\n+    }\n+\n+    @Test\n+    public void expireSingleEmbargoTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(1, eventDetails.size());\n+        assertEventWithDetail(eventDetails, \"Expired an embargo for \" + pid.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 146}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzY0MDQwOnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1OToxNFrOGYfT2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMTo1OToxNFrOGYfT2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzMTk5Mg==", "bodyText": "this method isn't being used right now, so you can either remove it or may use of it. You'd just need to allow it to take multiple pids. Easiest way to do that would be to change the signature to take an array with PID... pid", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428331992", "createdAt": "2020-05-20T21:59:14Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;\n+    @Autowired\n+    private FcrepoClient fcrepoClient;\n+    @Autowired\n+    private RepositoryObjectLoader repoObjLoader;\n+    @Autowired\n+    private RepositoryObjectFactory repoObjFactory;\n+    @Mock\n+    private OperationsMessageSender operationsMessageSender;\n+    @Autowired\n+    private TransactionManager txManager;\n+    @Autowired\n+    private SparqlQueryService sparqlQueryService;\n+    @Autowired\n+    private RepositoryObjectTreeIndexer treeIndexer;\n+    @Captor\n+    private ArgumentCaptor<List<PID>> pidListCaptor;\n+\n+    private ExpireEmbargoService service;\n+\n+    private ContentRootObject contentRoot;\n+\n+    private AdminUnit adminUnit;\n+\n+    private CollectionObject collObj1;\n+    private CollectionObject collObj2;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        TestHelper.setContentBase(baseAddress);\n+\n+        service = new ExpireEmbargoService();\n+        service.setOperationsMessageSender(operationsMessageSender);\n+        service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n+        service.setTransactionManager(txManager);\n+        service.setSparqlQueryService(sparqlQueryService);\n+\n+        PID contentRootPid = RepositoryPaths.getContentRootPid();\n+        try {\n+            repoObjFactory.createContentRootObject(\n+                    contentRootPid.getRepositoryUri(), null);\n+        } catch (FedoraException e) {\n+            // Ignore failure as the content root will already exist after first test\n+        }\n+        contentRoot = repoObjLoader.getContentRootObject(contentRootPid);\n+    }\n+\n+    @Test\n+    public void expireSingleEmbargoTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(1, eventDetails.size());\n+        assertEventWithDetail(eventDetails, \"Expired an embargo for \" + pid.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        assertTrue(pidListCaptor.getValue().contains(pid));\n+    }\n+\n+\n+    @Test\n+    public void expireMultipleEmbargoesTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+        // create first embargoed collection\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid1 = collObj1.getPid();\n+        // create second embargoed collection\n+        createSecondCollectionInUnit(new AclModelBuilder(\"Another collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid2 = collObj2.getPid();\n+\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target1 = repoObjLoader.getRepositoryObject(pid1);\n+        RepositoryObject target2 = repoObjLoader.getRepositoryObject(pid2);\n+        assertNoEmbargo(target1);\n+        assertNoEmbargo(target2);\n+\n+        List<String> eventDetails1 = getEventDetails(target1);\n+        List<String> eventDetails2 = getEventDetails(target2);\n+        assertEquals(1, eventDetails1.size());\n+        assertEquals(1, eventDetails2.size());\n+\n+        assertEventWithDetail(eventDetails1, \"Expired an embargo for \" + pid1.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        assertEventWithDetail(eventDetails2, \"Expired an embargo for \" + pid2.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        List<PID> pids = pidListCaptor.getValue();\n+        assertTrue(pids.contains(pid1));\n+        assertTrue(pids.contains(pid2));\n+    }\n+\n+    @Test\n+    public void expireNoEmbargoesTest() throws Exception {\n+        createCollectionInUnit(null);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        // collection was not created with an embargo and should not have one\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        // no event should have been created since no embargoes were expired\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(0, eventDetails.size());\n+    }\n+    \n+    private Calendar yesterday() {\n+        final Calendar cal = Calendar.getInstance();\n+        cal.add(Calendar.DATE, -1);\n+        return cal;\n+    }\n+\n+    private void createCollectionInUnit(Model collModel) {\n+        adminUnit = repoObjFactory.createAdminUnit(null);\n+        contentRoot.addMember(adminUnit);\n+        collObj1 = repoObjFactory.createCollectionObject(collModel);\n+        adminUnit.addMember(collObj1);\n+    }\n+\n+    private void createSecondCollectionInUnit(Model collModel) {\n+        adminUnit = repoObjFactory.createAdminUnit(null);\n+        contentRoot.addMember(adminUnit);\n+        collObj2 = repoObjFactory.createCollectionObject(collModel);\n+        adminUnit.addMember(collObj2);\n+    }\n+\n+    private void assertNoEmbargo(RepositoryObject obj) {\n+        Resource resc = obj.getResource();\n+        assertFalse(\"Unexpected embargo assigned to \" + obj.getPid().getId(),\n+                resc.hasProperty(CdrAcl.embargoUntil));\n+    }\n+\n+    private List<String> getEventDetails(RepositoryObject repoObj) {\n+        List<String> details = new ArrayList<>();\n+\n+        Model eventsModel = repoObj.getPremisLog().getEventsModel();\n+        Resource objResc = eventsModel.getResource(repoObj.getPid().getRepositoryPath());\n+        StmtIterator it = eventsModel.listStatements(null, Prov.used, objResc);\n+        while (it.hasNext()) {\n+            Statement stmt = it.next();\n+            Resource eventResc = stmt.getSubject();\n+\n+            assertTrue(\"Event type was not set\",\n+                    eventResc.hasProperty(RDF.type, Premis.Dissemination));\n+            Resource execAgent = eventResc.getProperty(Premis.hasEventRelatedAgentExecutor).getResource();\n+            assertTrue(\"Executing agent did not have software type\",\n+                    execAgent.hasProperty(RDF.type, PremisAgentType.Software));\n+            assertTrue(\"Executing agent did not have name\",\n+                    execAgent.hasLiteral(Rdf.label, SoftwareAgent.embargoExpirationService.getFullname()));\n+            details.add(eventResc.getProperty(Premis.note).getString());\n+        }\n+\n+        return details;\n+    }\n+\n+    private void assertEventWithDetail(List<String> eventDetails, String expected) {\n+        assertTrue(\"No event with expected detail '\" + expected + \"'\",\n+                eventDetails.stream().anyMatch(d -> d.contains(expected)));\n+    }\n+\n+    private void assertMessageSent(PID pid) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 268}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzY1NjQ0OnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjowNToyMVrOGYfduw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjowNToyMVrOGYfduw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzNDUyMw==", "bodyText": "I think you only need createCollectionInUnit, you would just need to return collObj at the end. You're not currently using adminUnit anywhere outside of this method, so it probably doesn't need to be an instance variable.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428334523", "createdAt": "2020-05-20T22:05:21Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;\n+    @Autowired\n+    private FcrepoClient fcrepoClient;\n+    @Autowired\n+    private RepositoryObjectLoader repoObjLoader;\n+    @Autowired\n+    private RepositoryObjectFactory repoObjFactory;\n+    @Mock\n+    private OperationsMessageSender operationsMessageSender;\n+    @Autowired\n+    private TransactionManager txManager;\n+    @Autowired\n+    private SparqlQueryService sparqlQueryService;\n+    @Autowired\n+    private RepositoryObjectTreeIndexer treeIndexer;\n+    @Captor\n+    private ArgumentCaptor<List<PID>> pidListCaptor;\n+\n+    private ExpireEmbargoService service;\n+\n+    private ContentRootObject contentRoot;\n+\n+    private AdminUnit adminUnit;\n+\n+    private CollectionObject collObj1;\n+    private CollectionObject collObj2;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        TestHelper.setContentBase(baseAddress);\n+\n+        service = new ExpireEmbargoService();\n+        service.setOperationsMessageSender(operationsMessageSender);\n+        service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n+        service.setTransactionManager(txManager);\n+        service.setSparqlQueryService(sparqlQueryService);\n+\n+        PID contentRootPid = RepositoryPaths.getContentRootPid();\n+        try {\n+            repoObjFactory.createContentRootObject(\n+                    contentRootPid.getRepositoryUri(), null);\n+        } catch (FedoraException e) {\n+            // Ignore failure as the content root will already exist after first test\n+        }\n+        contentRoot = repoObjLoader.getContentRootObject(contentRootPid);\n+    }\n+\n+    @Test\n+    public void expireSingleEmbargoTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(1, eventDetails.size());\n+        assertEventWithDetail(eventDetails, \"Expired an embargo for \" + pid.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        assertTrue(pidListCaptor.getValue().contains(pid));\n+    }\n+\n+\n+    @Test\n+    public void expireMultipleEmbargoesTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+        // create first embargoed collection\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid1 = collObj1.getPid();\n+        // create second embargoed collection\n+        createSecondCollectionInUnit(new AclModelBuilder(\"Another collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid2 = collObj2.getPid();\n+\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target1 = repoObjLoader.getRepositoryObject(pid1);\n+        RepositoryObject target2 = repoObjLoader.getRepositoryObject(pid2);\n+        assertNoEmbargo(target1);\n+        assertNoEmbargo(target2);\n+\n+        List<String> eventDetails1 = getEventDetails(target1);\n+        List<String> eventDetails2 = getEventDetails(target2);\n+        assertEquals(1, eventDetails1.size());\n+        assertEquals(1, eventDetails2.size());\n+\n+        assertEventWithDetail(eventDetails1, \"Expired an embargo for \" + pid1.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        assertEventWithDetail(eventDetails2, \"Expired an embargo for \" + pid2.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        List<PID> pids = pidListCaptor.getValue();\n+        assertTrue(pids.contains(pid1));\n+        assertTrue(pids.contains(pid2));\n+    }\n+\n+    @Test\n+    public void expireNoEmbargoesTest() throws Exception {\n+        createCollectionInUnit(null);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        // collection was not created with an embargo and should not have one\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        // no event should have been created since no embargoes were expired\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(0, eventDetails.size());\n+    }\n+    \n+    private Calendar yesterday() {\n+        final Calendar cal = Calendar.getInstance();\n+        cal.add(Calendar.DATE, -1);\n+        return cal;\n+    }\n+\n+    private void createCollectionInUnit(Model collModel) {\n+        adminUnit = repoObjFactory.createAdminUnit(null);\n+        contentRoot.addMember(adminUnit);\n+        collObj1 = repoObjFactory.createCollectionObject(collModel);\n+        adminUnit.addMember(collObj1);\n+    }\n+\n+    private void createSecondCollectionInUnit(Model collModel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 227}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzY2NjY1OnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjowOToyOVrOGYfkRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjowOToyOVrOGYfkRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzNjE5Nw==", "bodyText": "This is already being set in the @Before method, so you can remove these from the test methods.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428336197", "createdAt": "2020-05-20T22:09:29Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;\n+    @Autowired\n+    private FcrepoClient fcrepoClient;\n+    @Autowired\n+    private RepositoryObjectLoader repoObjLoader;\n+    @Autowired\n+    private RepositoryObjectFactory repoObjFactory;\n+    @Mock\n+    private OperationsMessageSender operationsMessageSender;\n+    @Autowired\n+    private TransactionManager txManager;\n+    @Autowired\n+    private SparqlQueryService sparqlQueryService;\n+    @Autowired\n+    private RepositoryObjectTreeIndexer treeIndexer;\n+    @Captor\n+    private ArgumentCaptor<List<PID>> pidListCaptor;\n+\n+    private ExpireEmbargoService service;\n+\n+    private ContentRootObject contentRoot;\n+\n+    private AdminUnit adminUnit;\n+\n+    private CollectionObject collObj1;\n+    private CollectionObject collObj2;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        TestHelper.setContentBase(baseAddress);\n+\n+        service = new ExpireEmbargoService();\n+        service.setOperationsMessageSender(operationsMessageSender);\n+        service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n+        service.setTransactionManager(txManager);\n+        service.setSparqlQueryService(sparqlQueryService);\n+\n+        PID contentRootPid = RepositoryPaths.getContentRootPid();\n+        try {\n+            repoObjFactory.createContentRootObject(\n+                    contentRootPid.getRepositoryUri(), null);\n+        } catch (FedoraException e) {\n+            // Ignore failure as the content root will already exist after first test\n+        }\n+        contentRoot = repoObjLoader.getContentRootObject(contentRootPid);\n+    }\n+\n+    @Test\n+    public void expireSingleEmbargoTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 136}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY2NzY2ODY0OnYy", "diffSide": "RIGHT", "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjoxMDoxM1rOGYflYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMjoxMDoxM1rOGYflYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODMzNjQ4MA==", "bodyText": "Check that no messages were sent. You can use the never() method with verify for that", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428336480", "createdAt": "2020-05-20T22:10:13Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoServiceIT.java", "diffHunk": "@@ -0,0 +1,275 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.AdminUnit;\n+import edu.unc.lib.dl.fcrepo4.CollectionObject;\n+import edu.unc.lib.dl.fcrepo4.ContentRootObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.RepositoryPaths;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.FedoraException;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.rdf.CdrAcl;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.rdf.PremisAgentType;\n+import edu.unc.lib.dl.rdf.Prov;\n+import edu.unc.lib.dl.rdf.Rdf;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.test.AclModelBuilder;\n+import edu.unc.lib.dl.test.RepositoryObjectTreeIndexer;\n+import edu.unc.lib.dl.test.TestHelper;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import org.apache.jena.rdf.model.Model;\n+import org.apache.jena.rdf.model.Resource;\n+import org.apache.jena.rdf.model.Statement;\n+import org.apache.jena.rdf.model.StmtIterator;\n+import org.apache.jena.vocabulary.RDF;\n+import org.fcrepo.client.FcrepoClient;\n+import org.junit.Before;\n+import org.junit.Test;\n+import org.junit.runner.RunWith;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Captor;\n+import org.mockito.Mock;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.test.context.ContextConfiguration;\n+import org.springframework.test.context.ContextHierarchy;\n+import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;\n+\n+import java.util.ArrayList;\n+import java.util.Calendar;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static org.junit.Assert.assertEquals;\n+import static org.junit.Assert.assertFalse;\n+import static org.junit.Assert.assertTrue;\n+import static org.mockito.Matchers.eq;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.MockitoAnnotations.initMocks;\n+\n+@RunWith(SpringJUnit4ClassRunner.class)\n+@ContextHierarchy({\n+        @ContextConfiguration(\"/spring-test/test-fedora-container.xml\"),\n+        @ContextConfiguration(\"/spring-test/cdr-client-container.xml\")\n+})\n+public class ExpireEmbargoServiceIT {\n+\n+    @Autowired\n+    private String baseAddress;\n+    @Autowired\n+    private Model queryModel;\n+    @Autowired\n+    private FcrepoClient fcrepoClient;\n+    @Autowired\n+    private RepositoryObjectLoader repoObjLoader;\n+    @Autowired\n+    private RepositoryObjectFactory repoObjFactory;\n+    @Mock\n+    private OperationsMessageSender operationsMessageSender;\n+    @Autowired\n+    private TransactionManager txManager;\n+    @Autowired\n+    private SparqlQueryService sparqlQueryService;\n+    @Autowired\n+    private RepositoryObjectTreeIndexer treeIndexer;\n+    @Captor\n+    private ArgumentCaptor<List<PID>> pidListCaptor;\n+\n+    private ExpireEmbargoService service;\n+\n+    private ContentRootObject contentRoot;\n+\n+    private AdminUnit adminUnit;\n+\n+    private CollectionObject collObj1;\n+    private CollectionObject collObj2;\n+\n+    @Before\n+    public void init() throws Exception {\n+        initMocks(this);\n+        TestHelper.setContentBase(baseAddress);\n+\n+        service = new ExpireEmbargoService();\n+        service.setOperationsMessageSender(operationsMessageSender);\n+        service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n+        service.setTransactionManager(txManager);\n+        service.setSparqlQueryService(sparqlQueryService);\n+\n+        PID contentRootPid = RepositoryPaths.getContentRootPid();\n+        try {\n+            repoObjFactory.createContentRootObject(\n+                    contentRootPid.getRepositoryUri(), null);\n+        } catch (FedoraException e) {\n+            // Ignore failure as the content root will already exist after first test\n+        }\n+        contentRoot = repoObjLoader.getContentRootObject(contentRootPid);\n+    }\n+\n+    @Test\n+    public void expireSingleEmbargoTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(1, eventDetails.size());\n+        assertEventWithDetail(eventDetails, \"Expired an embargo for \" + pid.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        assertTrue(pidListCaptor.getValue().contains(pid));\n+    }\n+\n+\n+    @Test\n+    public void expireMultipleEmbargoesTest() throws Exception {\n+        Calendar embargoUntil = yesterday();\n+        // create first embargoed collection\n+        createCollectionInUnit(new AclModelBuilder(\"Collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid1 = collObj1.getPid();\n+        // create second embargoed collection\n+        createSecondCollectionInUnit(new AclModelBuilder(\"Another collection with embargo\")\n+                .addEmbargoUntil(embargoUntil)\n+                .model);\n+        PID pid2 = collObj2.getPid();\n+\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        RepositoryObject target1 = repoObjLoader.getRepositoryObject(pid1);\n+        RepositoryObject target2 = repoObjLoader.getRepositoryObject(pid2);\n+        assertNoEmbargo(target1);\n+        assertNoEmbargo(target2);\n+\n+        List<String> eventDetails1 = getEventDetails(target1);\n+        List<String> eventDetails2 = getEventDetails(target2);\n+        assertEquals(1, eventDetails1.size());\n+        assertEquals(1, eventDetails2.size());\n+\n+        assertEventWithDetail(eventDetails1, \"Expired an embargo for \" + pid1.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+        assertEventWithDetail(eventDetails2, \"Expired an embargo for \" + pid2.toString() + \" which ended \" + formatDateToUTC(embargoUntil.getTime()));\n+\n+        verify(operationsMessageSender).sendOperationMessage(\n+                eq(SoftwareAgent.embargoExpirationService.getFullname()),\n+                eq(JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL),\n+                pidListCaptor.capture());\n+        List<PID> pids = pidListCaptor.getValue();\n+        assertTrue(pids.contains(pid1));\n+        assertTrue(pids.contains(pid2));\n+    }\n+\n+    @Test\n+    public void expireNoEmbargoesTest() throws Exception {\n+        createCollectionInUnit(null);\n+        PID pid = collObj1.getPid();\n+        TestHelper.setContentBase(baseAddress);\n+        treeIndexer.indexAll(baseAddress);\n+\n+        service.expireEmbargoes();\n+\n+        // collection was not created with an embargo and should not have one\n+        RepositoryObject target = repoObjLoader.getRepositoryObject(pid);\n+        assertNoEmbargo(target);\n+\n+        // no event should have been created since no embargoes were expired\n+        List<String> eventDetails = getEventDetails(target);\n+        assertEquals(0, eventDetails.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "710eb52c8640059e945d5a57485a8e09b1a1ad61"}, "originalPosition": 211}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTA2NjA3OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowNTowOFrOGZBBLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowNTowOFrOGZBBLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NDI3MQ==", "bodyText": "I think this is always going to be true now, so you can remove the variable and this conditional", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428884271", "createdAt": "2020-05-21T20:05:08Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -65,76 +61,71 @@\n     private TransactionManager txManager;\n     private SparqlQueryService sparqlQueryService;\n \n-    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+    private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n \n     public ExpireEmbargoService() {\n     }\n \n     // run service every day 1 minute after midnight\n     @Scheduled(cron = \"0 1 0 * * *\")\n     public void expireEmbargoes() {\n-        FedoraTransaction tx = txManager.startTransaction();\n+        // get list of expired embargoes\n+        List<String> resourceList = getEmbargoInfo();\n+        Collection<PID> pids = new ArrayList<>();\n \n-        try (Timer.Context context = timer.time()) {\n-            // get list of expired embargoes\n-            List<String> resourceList = getEmbargoInfo();\n-            Collection<PID> pids = new ArrayList<>();\n+        // remove all expired embargoes\n+        for (String rescUri: resourceList) {\n+            FedoraTransaction tx = txManager.startTransaction();\n \n-            // remove all expired embargoes\n-            for (int i = 0; i < resourceList.size(); i++) {\n-                String rescUri = resourceList.get(i);\n+            try (Timer.Context context = timer.time()) {\n                 PID pid = PIDs.get(rescUri);\n                 RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n-                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n-                Resource resc = model.getResource(rescUri);\n+                Resource resc = repoObj.getResource();\n \n                 String eventText = null;\n                 boolean expiredEmbargo = false;\n-                String embargoDate = resc.getProperty(embargoUntil).getString();\n \n-                if (resc.hasProperty(embargoUntil)) {\n-                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n-                    pids.add(pid);\n-                    expiredEmbargo = true;\n-                }\n+                // remove embargo\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+                repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                pids.add(pid);\n+                expiredEmbargo = true;\n \n                 if (expiredEmbargo) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5debf34b24d8478be5db5cdf8bb5f5dd6472b192"}, "originalPosition": 81}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTA3MzUzOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowNzo0OVrOGZBGHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDowNzo0OVrOGZBGHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODg4NTUzNQ==", "bodyText": "You will need to log the error rather than rethrow it now so that it will attempt to continue on with the rest of the embargoed objects, otherwise the messages for successful embargo updates won't get sent.", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428885535", "createdAt": "2020-05-21T20:07:49Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -65,76 +61,71 @@\n     private TransactionManager txManager;\n     private SparqlQueryService sparqlQueryService;\n \n-    private static final Timer timer = TimerFactory.createTimerForClass(EditTitleService.class);\n+    private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n \n     public ExpireEmbargoService() {\n     }\n \n     // run service every day 1 minute after midnight\n     @Scheduled(cron = \"0 1 0 * * *\")\n     public void expireEmbargoes() {\n-        FedoraTransaction tx = txManager.startTransaction();\n+        // get list of expired embargoes\n+        List<String> resourceList = getEmbargoInfo();\n+        Collection<PID> pids = new ArrayList<>();\n \n-        try (Timer.Context context = timer.time()) {\n-            // get list of expired embargoes\n-            List<String> resourceList = getEmbargoInfo();\n-            Collection<PID> pids = new ArrayList<>();\n+        // remove all expired embargoes\n+        for (String rescUri: resourceList) {\n+            FedoraTransaction tx = txManager.startTransaction();\n \n-            // remove all expired embargoes\n-            for (int i = 0; i < resourceList.size(); i++) {\n-                String rescUri = resourceList.get(i);\n+            try (Timer.Context context = timer.time()) {\n                 PID pid = PIDs.get(rescUri);\n                 RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n-                Model model = ModelFactory.createDefaultModel().add(repoObj.getModel());\n-                Resource resc = model.getResource(rescUri);\n+                Resource resc = repoObj.getResource();\n \n                 String eventText = null;\n                 boolean expiredEmbargo = false;\n-                String embargoDate = resc.getProperty(embargoUntil).getString();\n \n-                if (resc.hasProperty(embargoUntil)) {\n-                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n-                    pids.add(pid);\n-                    expiredEmbargo = true;\n-                }\n+                // remove embargo\n+                String embargoDate = resc.getProperty(embargoUntil).getString();\n+                repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                pids.add(pid);\n+                expiredEmbargo = true;\n \n                 if (expiredEmbargo) {\n-                    eventText = \"Expired an embargo for \" + pid.toString() + \" which ended \" +\n+                    eventText = \"Expired an embargo which ended \" +\n                             formatDateToUTC(parseUTCToDate(embargoDate));\n-                } else {\n-                    eventText = \"Failed to expire embargo.\";\n+                    // Produce the premis event for this embargo\n+                    repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                            .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                            .addEventDetail(eventText)\n+                            .writeAndClose();\n                 }\n-\n-                // Produce the premis event for this embargo\n-                repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n-                        .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n-                        .addEventDetail(eventText)\n-                        .writeAndClose();\n+            } catch (Exception e) {\n+                tx.cancelAndIgnore();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5debf34b24d8478be5db5cdf8bb5f5dd6472b192"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTE2NjU3OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDozODoxMVrOGZCBlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDozODoxMVrOGZCBlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkwMDc1Nw==", "bodyText": "you don't actually need the {} for an exception when its the last parameter in a log statement. But it probably wouldn't be a bad idea to log the PID of the object that it failed to clear the embargo on along with the exception", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428900757", "createdAt": "2020-05-21T20:38:11Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -82,27 +86,20 @@ public void expireEmbargoes() {\n                 RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n                 Resource resc = repoObj.getResource();\n \n-                String eventText = null;\n-                boolean expiredEmbargo = false;\n-\n                 // remove embargo\n                 String embargoDate = resc.getProperty(embargoUntil).getString();\n                 repoObjFactory.deleteProperty(repoObj, embargoUntil);\n                 pids.add(pid);\n-                expiredEmbargo = true;\n-\n-                if (expiredEmbargo) {\n-                    eventText = \"Expired an embargo which ended \" +\n-                            formatDateToUTC(parseUTCToDate(embargoDate));\n-                    // Produce the premis event for this embargo\n-                    repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n-                            .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n-                            .addEventDetail(eventText)\n-                            .writeAndClose();\n-                }\n+                String eventText = \"Expired an embargo which ended \" +\n+                        formatDateToUTC(parseUTCToDate(embargoDate));\n+                // Produce the premis event for this embargo\n+                repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                        .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                        .addEventDetail(eventText)\n+                        .writeAndClose();\n             } catch (Exception e) {\n                 tx.cancelAndIgnore();\n-                throw e;\n+                log.error(\"Failed to expire embargo: {}\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16ba789a2b5859478eba6d502fbda684c4237e8"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY3MTE2Njk3OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDozODoyMlrOGZCB3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMDo0MjoyNlrOGZCJhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkwMDgzMA==", "bodyText": "guessing you didn't mean to commit this change", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428900830", "createdAt": "2020-05-21T20:38:22Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -63,11 +65,13 @@\n \n     private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n \n+    private static final Logger log = LoggerFactory.getLogger(ExpireEmbargoService.class);\n+\n     public ExpireEmbargoService() {\n     }\n \n     // run service every day 1 minute after midnight\n-    @Scheduled(cron = \"0 1 0 * * *\")\n+    @Scheduled(cron = \"0 15 16 * * *\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a16ba789a2b5859478eba6d502fbda684c4237e8"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkwMjc5MQ==", "bodyText": "nope!  sorry!", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r428902791", "createdAt": "2020-05-21T20:42:26Z", "author": {"login": "smithjp"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -63,11 +65,13 @@\n \n     private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n \n+    private static final Logger log = LoggerFactory.getLogger(ExpireEmbargoService.class);\n+\n     public ExpireEmbargoService() {\n     }\n \n     // run service every day 1 minute after midnight\n-    @Scheduled(cron = \"0 1 0 * * *\")\n+    @Scheduled(cron = \"0 15 16 * * *\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkwMDgzMA=="}, "originalCommit": {"oid": "a16ba789a2b5859478eba6d502fbda684c4237e8"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjE0MDI5OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzowNjo1N1rOGf2bdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzowNjo1N1rOGf2bdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA1MDgwNA==", "bodyText": "make this info", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r436050804", "createdAt": "2020-06-05T17:06:57Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.DateTimeUtil;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Resource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@Component\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n+\n+    private static final Logger log = LoggerFactory.getLogger(ExpireEmbargoService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        log.info(\"running ExpireEmbargoService\");\n+        // get list of expired embargoes\n+        List<String> resourceList = getEmbargoInfo();\n+        Collection<PID> pids = new ArrayList<>();\n+        PID currentPid = null;\n+\n+        if (resourceList.size() > 0) {\n+            // remove all expired embargoes\n+            for (String rescUri: resourceList) {\n+                FedoraTransaction tx = txManager.startTransaction();\n+\n+                try (Timer.Context context = timer.time()) {\n+                    PID pid = PIDs.get(rescUri);\n+                    currentPid = pid;\n+                    RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                    Resource resc = repoObj.getResource();\n+\n+                    // remove embargo\n+                    String embargoDate = resc.getProperty(embargoUntil).getString();\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    String eventText = \"Expired an embargo which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                    // Produce the premis event for this embargo\n+                    repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                            .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                            .addEventDetail(eventText)\n+                            .writeAndClose();\n+                } catch (Exception e) {\n+                    tx.cancelAndIgnore();\n+                    log.error(\"Failed to expire embargo for {} with error:\", currentPid, e);\n+                } finally {\n+                    tx.close();\n+                }\n+            }\n+        } else {\n+            log.error(\"No embargoes to expire\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464cfb6ed513be75cf7583fd6a02970a72c227c7"}, "originalPosition": 114}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjE0OTEwOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxMDowNVrOGf2hRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxMDowNVrOGf2hRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA1MjI5Mw==", "bodyText": "Its not all that common to want to catch a NullPointerException. Which part of this is throwing one? Would it be possible to check whatever object it is that is triggering it to make sure its not null first?", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r436052293", "createdAt": "2020-06-05T17:10:05Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.DateTimeUtil;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Resource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@Component\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n+\n+    private static final Logger log = LoggerFactory.getLogger(ExpireEmbargoService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        log.info(\"running ExpireEmbargoService\");\n+        // get list of expired embargoes\n+        List<String> resourceList = getEmbargoInfo();\n+        Collection<PID> pids = new ArrayList<>();\n+        PID currentPid = null;\n+\n+        if (resourceList.size() > 0) {\n+            // remove all expired embargoes\n+            for (String rescUri: resourceList) {\n+                FedoraTransaction tx = txManager.startTransaction();\n+\n+                try (Timer.Context context = timer.time()) {\n+                    PID pid = PIDs.get(rescUri);\n+                    currentPid = pid;\n+                    RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                    Resource resc = repoObj.getResource();\n+\n+                    // remove embargo\n+                    String embargoDate = resc.getProperty(embargoUntil).getString();\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);\n+                    String eventText = \"Expired an embargo which ended \" +\n+                            formatDateToUTC(parseUTCToDate(embargoDate));\n+                    // Produce the premis event for this embargo\n+                    repoObj.getPremisLog().buildEvent(Premis.Dissemination)\n+                            .addSoftwareAgent(SoftwareAgent.embargoExpirationService.getFullname())\n+                            .addEventDetail(eventText)\n+                            .writeAndClose();\n+                } catch (Exception e) {\n+                    tx.cancelAndIgnore();\n+                    log.error(\"Failed to expire embargo for {} with error:\", currentPid, e);\n+                } finally {\n+                    tx.close();\n+                }\n+            }\n+        } else {\n+            log.error(\"No embargoes to expire\");\n+        }\n+\n+        if (!pids.isEmpty()) {\n+            // send a message for expired embargoes\n+            operationsMessageSender.sendOperationMessage(SoftwareAgent.embargoExpirationService.getFullname(),\n+                    JMSMessageUtil.CDRActions.EDIT_ACCESS_CONTROL,\n+                    pids);\n+        }\n+    }\n+\n+    private final static String EMBARGO_QUERY =\n+            \"PREFIX xsd: <http://www.w3.org/2001/XMLSchema#>\\n\" +\n+                    \"select ?resource\\n\" +\n+                    \"where {\\n\" +\n+                    \"  ?resource <http://cdr.unc.edu/definitions/acl#embargoUntil> ?date .\\n\" +\n+                    \"  FILTER (?date < \\\"%s\\\"^^xsd:dateTime)\\n\" +\n+                    \"}\";\n+\n+    private List<String> getEmbargoInfo() {\n+        String today = DateTimeUtil.formatDateToUTC(new Date());\n+        String query = String.format(EMBARGO_QUERY, today);\n+\n+        try (QueryExecution exec = sparqlQueryService.executeQuery(query)) {\n+            ResultSet resultSet = exec.execSelect();\n+            List<String> embargoedRescList = new ArrayList<>();\n+\n+            for (; resultSet.hasNext() ;) {\n+                QuerySolution soln = resultSet.nextSolution();\n+                Resource resc = soln.getResource(\"resource\");\n+                embargoedRescList.add(resc.getURI());\n+            }\n+            return embargoedRescList;\n+        } catch (NullPointerException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464cfb6ed513be75cf7583fd6a02970a72c227c7"}, "originalPosition": 147}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjE1NDI2OnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxMTo1NFrOGf2kfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxMTo1NFrOGf2kfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA1MzExNw==", "bodyText": "it would probably make sense to put this class (and its test) in edu.unc.lib.dl.persist.services.acl", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r436053117", "createdAt": "2020-06-05T17:11:54Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464cfb6ed513be75cf7583fd6a02970a72c227c7"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNjE2NTEzOnYy", "diffSide": "RIGHT", "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxNTo0NFrOGf2rjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNzoxNTo0NFrOGf2rjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjA1NDkyNw==", "bodyText": "Might be nice to add a log statement at debug or info level to say that an embargo was cleared for a particular object in case we have to debug this at some point", "url": "https://github.com/UNC-Libraries/box-c/pull/966#discussion_r436054927", "createdAt": "2020-06-05T17:15:44Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/ExpireEmbargoService.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import edu.unc.lib.dl.fcrepo4.FedoraTransaction;\n+import edu.unc.lib.dl.fcrepo4.PIDs;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectFactory;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fcrepo4.TransactionManager;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.rdf.Premis;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.sparql.SparqlQueryService;\n+import edu.unc.lib.dl.util.DateTimeUtil;\n+import edu.unc.lib.dl.util.JMSMessageUtil;\n+import edu.unc.lib.dl.util.SoftwareAgentConstants.SoftwareAgent;\n+import io.dropwizard.metrics5.Timer;\n+import org.apache.jena.query.QueryExecution;\n+import org.apache.jena.query.QuerySolution;\n+import org.apache.jena.query.ResultSet;\n+import org.apache.jena.rdf.model.Resource;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.scheduling.annotation.EnableScheduling;\n+import org.springframework.scheduling.annotation.Scheduled;\n+import org.springframework.stereotype.Component;\n+\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static edu.unc.lib.dl.rdf.CdrAcl.embargoUntil;\n+import static edu.unc.lib.dl.util.DateTimeUtil.formatDateToUTC;\n+import static edu.unc.lib.dl.util.DateTimeUtil.parseUTCToDate;\n+\n+/**\n+ * Service that manages embargo expiration\n+ *\n+ * @author smithjp\n+ *\n+ */\n+@Component\n+@EnableScheduling\n+public class ExpireEmbargoService {\n+\n+    private RepositoryObjectFactory repoObjFactory;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private TransactionManager txManager;\n+    private SparqlQueryService sparqlQueryService;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(ExpireEmbargoService.class);\n+\n+    private static final Logger log = LoggerFactory.getLogger(ExpireEmbargoService.class);\n+\n+    public ExpireEmbargoService() {\n+    }\n+\n+    // run service every day 1 minute after midnight\n+    @Scheduled(cron = \"0 1 0 * * *\")\n+    public void expireEmbargoes() {\n+        log.info(\"running ExpireEmbargoService\");\n+        // get list of expired embargoes\n+        List<String> resourceList = getEmbargoInfo();\n+        Collection<PID> pids = new ArrayList<>();\n+        PID currentPid = null;\n+\n+        if (resourceList.size() > 0) {\n+            // remove all expired embargoes\n+            for (String rescUri: resourceList) {\n+                FedoraTransaction tx = txManager.startTransaction();\n+\n+                try (Timer.Context context = timer.time()) {\n+                    PID pid = PIDs.get(rescUri);\n+                    currentPid = pid;\n+                    RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+                    Resource resc = repoObj.getResource();\n+\n+                    // remove embargo\n+                    String embargoDate = resc.getProperty(embargoUntil).getString();\n+                    repoObjFactory.deleteProperty(repoObj, embargoUntil);\n+                    pids.add(pid);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464cfb6ed513be75cf7583fd6a02970a72c227c7"}, "originalPosition": 98}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 765, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}