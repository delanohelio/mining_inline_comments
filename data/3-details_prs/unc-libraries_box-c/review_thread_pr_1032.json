{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMjI3MzI5", "number": 1032, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozNjoyMFrOEKlTgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjo0MToyMVrOEK4P-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTMyNDE5OnYy", "diffSide": "RIGHT", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozNjoyMFrOGrtWeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNjozNjoyMFrOGrtWeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ4NDk4NA==", "bodyText": "what about overriding the method signature to private void ingestWork(ContentContainerObject parent, Resource parentResc, Resource childResc, int retries) and the same thing without retries. Most stuff would call the version without retries, which would supply the starting number of retries at 3.\nThen you should be able to do something like:\n} catch (ChecksumMismatchException e) {\n     // Rollback changes for the work so far\n     txRefresher.interrupt();\n     tx.cancel();\n     if (retries > 0) {\n         retries--;\n         ingestWork(parent, parentResc, childResc, retries);\n     } else {\n         failJob(...);\n     }\n\nI think if a work had more than one file and failed partway through, it would try to reingest those other files and run into a conflict since they'd already exist.", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448484984", "createdAt": "2020-07-01T16:36:20Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,28 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79ee7dadf60673869525854b4b36e5e8da3b486a"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5ODQyODExOnYy", "diffSide": "RIGHT", "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjo0MToyMVrOGsLEZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxMjo0MToyMVrOGsLEZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODk3MTg3OQ==", "bodyText": "Could you add a warn level message stating that there was a checksum mismatch, probably include the message from the error? So that we see if this issue is occurring", "url": "https://github.com/UNC-Libraries/box-c/pull/1032#discussion_r448971879", "createdAt": "2020-07-02T12:41:21Z", "author": {"login": "bbpennel"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/fcrepo4/IngestContentObjectsJob.java", "diffHunk": "@@ -630,6 +630,16 @@ private void ingestWork(ContentContainerObject parent, Resource parentResc, Reso\n \n                 // Cease refreshing the transaction\n                 txRefresher.stop();\n+            } catch (ChecksumMismatchException e) {\n+                txRefresher.interrupt();\n+                tx.cancelAndIgnore();\n+\n+                if (retries > 0) {\n+                    retries--;\n+                    ingestWork(parent, parentResc, childResc, retries);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e09b3faf2e63674f90ca3ff2dfcd3240cbcd48d"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 645, "cost": 1, "resetAt": "2021-11-12T12:57:47Z"}}}