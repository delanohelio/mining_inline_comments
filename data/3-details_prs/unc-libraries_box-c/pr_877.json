{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNjc4OTAw", "number": 877, "title": "BXC-2471 - Destroy action cleans up external files", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2471\n\nDestroy action deletes original file from external binary location\nDestroy action triggers clearing of destroyed records from search index\nDestroy execution moved to asynchronous job in services-camel\nAdds transfer client method for deleting external binary\nNormalizes file uris from file:/// to file:/ since fedora is doing this internally\nFills in tests for destroy operations", "createdAt": "2020-01-08T22:13:00Z", "url": "https://github.com/UNC-Libraries/box-c/pull/877", "merged": true, "mergeCommit": {"oid": "8a8f492e3eefd621eb97add4d013a175bc240f79"}, "closed": true, "closedAt": "2020-01-14T14:15:15Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4FUllAH2gAyMzYwNjc4OTAwOmExODEyZjJmMmU3MGI3ZTc5YzRmNDdlMDA0OWM5NTU3ZjA5NDJlMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6DExkAH2gAyMzYwNjc4OTAwOjI3ZGQ3OWFlNjMwNmNlODQ3YjNmMDhlYzQyNjBhYmFlNjExOGExZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a1812f2f2e70b7e79c4f47e0049c9557f0942e2e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/a1812f2f2e70b7e79c4f47e0049c9557f0942e2e", "committedDate": "2020-01-07T18:46:42Z", "message": "Refactor destroy action into a camel task. Add test for destroy service. Split acl service initialization into its own context for tests\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55b13250e57ad6527f36d89a02346be2232b0c29", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/55b13250e57ad6527f36d89a02346be2232b0c29", "committedDate": "2020-01-07T19:04:03Z", "message": "Add method to delete files from storage locations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bdaaffc72ff51e69ea09e9fc7690b5ee45a8fed", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/8bdaaffc72ff51e69ea09e9fc7690b5ee45a8fed", "committedDate": "2020-01-08T18:58:50Z", "message": "Destroy action cleans up external binaries for original files. Normalizing external binary uris to only have :/ instead of :/// for file uris, since fedora does this to the uris"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b4da9485a6e061497b88f708bb214cd417fce59", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/8b4da9485a6e061497b88f708bb214cd417fce59", "committedDate": "2020-01-08T22:02:39Z", "message": "Clear objects from solr index after they are destroyed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMDc4ODI0", "url": "https://github.com/UNC-Libraries/box-c/pull/877#pullrequestreview-342078824", "createdAt": "2020-01-13T19:21:08Z", "commit": {"oid": "8b4da9485a6e061497b88f708bb214cd417fce59"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxOToyMTowOFrOFdBwtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxOToyMTowOFrOFdBwtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk4MTg3Ng==", "bodyText": "Don't delete the binaries until the fedora cleanup has been successful, otherwise the rollback can result in objects with missing files.", "url": "https://github.com/UNC-Libraries/box-c/pull/877#discussion_r365981876", "createdAt": "2020-01-13T19:21:08Z", "author": {"login": "bbpennel"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/destroy/DestroyObjectsJob.java", "diffHunk": "@@ -84,10 +112,18 @@ public void run() {\n             // convert each destroyed obj to a tombstone\n             for (PID pid : objsToDestroy) {\n                 RepositoryObject repoObj = repoObjLoader.getRepositoryObject(pid);\n+\n+                assertCanDestroy(agent, repoObj, aclService);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8b4da9485a6e061497b88f708bb214cd417fce59"}, "originalPosition": 85}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a442fdd9c20c1936028a1414d81b5c3a80d00ef", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/8a442fdd9c20c1936028a1414d81b5c3a80d00ef", "committedDate": "2020-01-13T19:45:13Z", "message": "Defer binary cleanup until after fedora destroy transaction completes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27dd79ae6306ce847b3f08ec4260abae6118a1e5", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/27dd79ae6306ce847b3f08ec4260abae6118a1e5", "committedDate": "2020-01-13T21:17:28Z", "message": "Skip binary destruction if the uri array is empty"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2393, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}