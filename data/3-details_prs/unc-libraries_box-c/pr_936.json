{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNjk4MTUz", "number": 936, "title": "BXC-2527 - MODS History/versioning", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2527\n\nImplements service for updating files which are versioned\nImplements datastream history log for adding textual contents to a history log\nAdds namespace for packaging xml\nRemoves contentObject.setDescription in favor of UpdateDescriptionService\n\nService now adds description relations, transfers binaries, employs versioning, and is more configurable\n\n\nIngestContentObjectJob now uses UpdateDescriptionService for setting mods\n\nTransfer of mods now takes place during this job\n\n\nAdds method for getting creation timestamp of objects", "createdAt": "2020-03-20T19:09:49Z", "url": "https://github.com/UNC-Libraries/box-c/pull/936", "merged": true, "mergeCommit": {"oid": "13e4819d9e957da4bf9dc75ee034efcb37f084ea"}, "closed": true, "closedAt": "2020-03-27T12:49:24Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRNSVNgH2gAyMzkxNjk4MTUzOmU5MGE2Mjg5ZWEyOTQ1ZWZkMTMzMjU4NmUwNGUxM2NjNjhjZGM1NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRv958gH2gAyMzkxNjk4MTUzOmUzOTQyNzNjODk1MTY4MmYxNDE0MTJmYmIyYzMwOGRlM2Y0NDNjZmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e90a6289ea2945efd1332586e04e13cc68cdc563", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/e90a6289ea2945efd1332586e04e13cc68cdc563", "committedDate": "2020-03-25T20:11:35Z", "message": "Make service exceptions a type of repo exception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb33c6530c5d87978b6b59f5485260b63d70d539", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/fb33c6530c5d87978b6b59f5485260b63d70d539", "committedDate": "2020-03-25T20:11:35Z", "message": "Implement history log and service for adding new versions to a versioned datastream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fe8e70607dff56b74c15a1bb31409424c58de37", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/3fe8e70607dff56b74c15a1bb31409424c58de37", "committedDate": "2020-03-25T20:11:35Z", "message": "add test for history log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a48c84c536f10bbcaabb533291f4c3b554488d28", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/a48c84c536f10bbcaabb533291f4c3b554488d28", "committedDate": "2020-03-25T20:11:35Z", "message": "add integration test for VersionedDatastreamService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ba82084faab58776879646e9ba88c644ca1cb05", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/5ba82084faab58776879646e9ba88c644ca1cb05", "committedDate": "2020-03-25T20:11:35Z", "message": "replacing setDescription with update description service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f2f1540c6d08db319b4940823b1f1eb9cecbbc", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/e6f2f1540c6d08db319b4940823b1f1eb9cecbbc", "committedDate": "2020-03-25T20:11:35Z", "message": "Use namespace for datastream history"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc1f6a7c138510ed26b50512d76fd4c0b41b8cc6", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/fc1f6a7c138510ed26b50512d76fd4c0b41b8cc6", "committedDate": "2020-03-25T20:11:35Z", "message": "Remove unused exists method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9554d50c5e0d3cd9dc364d57a7a65cd6edbee9", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/ad9554d50c5e0d3cd9dc364d57a7a65cd6edbee9", "committedDate": "2020-03-25T20:11:35Z", "message": "Use last modified timestamp for versions created after the first one added to the log."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddc0f50c9b86b5835b2c790400b3859c7fb9030a", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/ddc0f50c9b86b5835b2c790400b3859c7fb9030a", "committedDate": "2020-03-25T20:11:35Z", "message": "Add manager for getting locks on pids"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfd292d90a2192c784a211f86c673efe50426da6", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/cfd292d90a2192c784a211f86c673efe50426da6", "committedDate": "2020-03-25T20:11:35Z", "message": "Lock pids for writing before beginning version updating. Not using fedora transaction here since it would not protect binary transfers and there are inconsistencies as to whether or not fedora returns a date created in a transaction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/37730b37acdad9e0a7caef37ea6a4308d762918e", "committedDate": "2020-03-25T20:11:35Z", "message": "Fixes to fedora content service to require valid datastreams be selected, and to allow access to datastreams other than the original file. Datastreams now record what container they can be found in. Added datastream for mods history"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b436c8c42a3778e44a35e3215370a65db0a94512", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/b436c8c42a3778e44a35e3215370a65db0a94512", "committedDate": "2020-03-24T16:08:18Z", "message": "Fixes to fedora content service to require valid datastreams be selected, and to allow access to datastreams other than the original file. Datastreams now record what container they can be found in. Added datastream for mods history"}, "afterCommit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/37730b37acdad9e0a7caef37ea6a4308d762918e", "committedDate": "2020-03-25T20:11:35Z", "message": "Fixes to fedora content service to require valid datastreams be selected, and to allow access to datastreams other than the original file. Datastreams now record what container they can be found in. Added datastream for mods history"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjk0MzI1", "url": "https://github.com/UNC-Libraries/box-c/pull/936#pullrequestreview-382294325", "createdAt": "2020-03-26T18:26:08Z", "commit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNjowOVrOF8Uq2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNjowOVrOF8Uq2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5NzUyOA==", "bodyText": "Is this needed?", "url": "https://github.com/UNC-Libraries/box-c/pull/936#discussion_r398797528", "createdAt": "2020-03-26T18:26:09Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/UpdateDescriptionServiceTest.java", "diffHunk": "@@ -114,34 +117,49 @@ public void init() throws Exception{\n         objPid = PIDs.get(UUID.randomUUID().toString());\n         modsPid = getMdDescriptivePid(objPid);\n         modsStream = new ByteArrayInputStream(FILE_CONTENT.getBytes());\n-        transferredUri = URI.create(\"file:///path/to/transferred/file.txt\");\n \n-        when(obj.setDescription(any(URI.class))).thenReturn(mock(BinaryObject.class));\n+        when(versioningService.addVersion(any(DatastreamVersion.class))).thenReturn(mockDescBin);\n         when(obj.getPid()).thenReturn(objPid);\n \n-        when(transferSession.transferReplaceExisting(modsPid, modsStream)).thenReturn(transferredUri);\n-\n         service = new UpdateDescriptionService();\n         service.setAclService(aclService);\n         service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n         service.setOperationsMessageSender(messageSender);\n         service.setModsValidator(modsValidator);\n-        service.setTransferService(transferService);\n+        service.setVersionedDatastreamService(versioningService);\n     }\n \n     @Test\n     public void updateDescriptionTest() throws Exception {\n-        when(transferService.getSession(obj)).thenReturn(transferSession);\n-\n         service.updateDescription(agent, objPid, modsStream);\n \n-        verify(transferSession).transferReplaceExisting(eq(modsPid), inputStreamCaptor.capture());\n-        assertEquals(FILE_CONTENT, IOUtils.toString(inputStreamCaptor.getValue()));\n+        verify(versioningService).addVersion(versionCaptor.capture());\n+        DatastreamVersion version = versionCaptor.getValue();\n+        assertEquals(modsPid, version.getDsPid());\n+        assertEquals(\"text/xml\", version.getContentType());\n+        assertEquals(FILE_CONTENT, IOUtils.toString(version.getContentStream()));\n \n-        verify(obj).setDescription(transferredUri);\n+        verify(versioningService).addVersion(any(DatastreamVersion.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjk0NzUy", "url": "https://github.com/UNC-Libraries/box-c/pull/936#pullrequestreview-382294752", "createdAt": "2020-03-26T18:26:40Z", "commit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNjo0MVrOF8UsNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNjo0MVrOF8UsNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5Nzg3OA==", "bodyText": "check", "url": "https://github.com/UNC-Libraries/box-c/pull/936#discussion_r398797878", "createdAt": "2020-03-26T18:26:41Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/UpdateDescriptionServiceTest.java", "diffHunk": "@@ -114,34 +117,49 @@ public void init() throws Exception{\n         objPid = PIDs.get(UUID.randomUUID().toString());\n         modsPid = getMdDescriptivePid(objPid);\n         modsStream = new ByteArrayInputStream(FILE_CONTENT.getBytes());\n-        transferredUri = URI.create(\"file:///path/to/transferred/file.txt\");\n \n-        when(obj.setDescription(any(URI.class))).thenReturn(mock(BinaryObject.class));\n+        when(versioningService.addVersion(any(DatastreamVersion.class))).thenReturn(mockDescBin);\n         when(obj.getPid()).thenReturn(objPid);\n \n-        when(transferSession.transferReplaceExisting(modsPid, modsStream)).thenReturn(transferredUri);\n-\n         service = new UpdateDescriptionService();\n         service.setAclService(aclService);\n         service.setRepositoryObjectLoader(repoObjLoader);\n+        service.setRepositoryObjectFactory(repoObjFactory);\n         service.setOperationsMessageSender(messageSender);\n         service.setModsValidator(modsValidator);\n-        service.setTransferService(transferService);\n+        service.setVersionedDatastreamService(versioningService);\n     }\n \n     @Test\n     public void updateDescriptionTest() throws Exception {\n-        when(transferService.getSession(obj)).thenReturn(transferSession);\n-\n         service.updateDescription(agent, objPid, modsStream);\n \n-        verify(transferSession).transferReplaceExisting(eq(modsPid), inputStreamCaptor.capture());\n-        assertEquals(FILE_CONTENT, IOUtils.toString(inputStreamCaptor.getValue()));\n+        verify(versioningService).addVersion(versionCaptor.capture());\n+        DatastreamVersion version = versionCaptor.getValue();\n+        assertEquals(modsPid, version.getDsPid());\n+        assertEquals(\"text/xml\", version.getContentType());\n+        assertEquals(FILE_CONTENT, IOUtils.toString(version.getContentStream()));\n \n-        verify(obj).setDescription(transferredUri);\n+        verify(versioningService).addVersion(any(DatastreamVersion.class));\n \n         assertMessageSent();\n+    }\n+\n+    @Test\n+    public void updateDescriptionAlreadyExistsTest() throws Exception {\n+        when(repoObjFactory.objectExists(modsPid.getRepositoryUri())).thenReturn(true);\n+\n+        service.updateDescription(agent, objPid, modsStream);\n \n+        verify(versioningService).addVersion(versionCaptor.capture());\n+        DatastreamVersion version = versionCaptor.getValue();\n+        assertEquals(modsPid, version.getDsPid());\n+        assertEquals(\"text/xml\", version.getContentType());\n+        assertEquals(FILE_CONTENT, IOUtils.toString(version.getContentStream()));\n+\n+        verify(versioningService).addVersion(any(DatastreamVersion.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "originalPosition": 121}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMjk1Mjkx", "url": "https://github.com/UNC-Libraries/box-c/pull/936#pullrequestreview-382295291", "createdAt": "2020-03-26T18:27:21Z", "commit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNzoyMVrOF8Ut3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODoyNzoyMVrOF8Ut3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODc5ODMwMw==", "bodyText": "check", "url": "https://github.com/UNC-Libraries/box-c/pull/936#discussion_r398798303", "createdAt": "2020-03-26T18:27:21Z", "author": {"login": "bbpennel"}, "path": "persistence/src/test/java/edu/unc/lib/dl/persist/services/edit/UpdateDescriptionServiceTest.java", "diffHunk": "@@ -171,14 +202,31 @@ public void invalidModsValidationOff() throws Exception {\n     public void updateDescriptionProvidedSession() throws Exception {\n         service.updateDescription(transferSession, agent, objPid, modsStream);\n \n-        verify(transferSession).transferReplaceExisting(eq(modsPid), inputStreamCaptor.capture());\n-        assertEquals(FILE_CONTENT, IOUtils.toString(inputStreamCaptor.getValue()));\n-\n-        verify(obj).setDescription(transferredUri);\n+        verify(versioningService).addVersion(versionCaptor.capture());\n+        DatastreamVersion version = versionCaptor.getValue();\n+        assertEquals(FILE_CONTENT, IOUtils.toString(version.getContentStream()));\n+        assertEquals(transferSession, version.getTransferSession());\n \n         assertMessageSent();\n     }\n \n+    @Test\n+    public void updateDescriptionDisableMassgesTest() throws Exception {\n+        service.setSendsMessages(false);\n+\n+        service.updateDescription(agent, objPid, modsStream);\n+\n+        verify(versioningService).addVersion(versionCaptor.capture());\n+        DatastreamVersion version = versionCaptor.getValue();\n+        assertEquals(modsPid, version.getDsPid());\n+        assertEquals(\"text/xml\", version.getContentType());\n+        assertEquals(FILE_CONTENT, IOUtils.toString(version.getContentStream()));\n+\n+        verify(versioningService).addVersion(any(DatastreamVersion.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "originalPosition": 175}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzAyMzEx", "url": "https://github.com/UNC-Libraries/box-c/pull/936#pullrequestreview-382302311", "createdAt": "2020-03-26T18:36:16Z", "commit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODozNjoxNlrOF8VEkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxODozNjoxNlrOF8VEkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODgwNDExMw==", "bodyText": "Do these need to be here?", "url": "https://github.com/UNC-Libraries/box-c/pull/936#discussion_r398804113", "createdAt": "2020-03-26T18:36:16Z", "author": {"login": "bbpennel"}, "path": "services/src/test/resources/retrieve-mods-it-servlet.xml", "diffHunk": "@@ -32,6 +32,25 @@\n \n     <context:component-scan resource-pattern=\"**/RetrieveMODSController*\" base-package=\"edu.unc.lib.dl.cdr.services.rest\"/>\n     \n+    <bean id=\"versionedDatastreamService\" class=\"edu.unc.lib.dl.persist.services.versioning.VersionedDatastreamService\" >", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37730b37acdad9e0a7caef37ea6a4308d762918e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9854396e55933f6f331adfe47f079c176ba00ac1", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/9854396e55933f6f331adfe47f079c176ba00ac1", "committedDate": "2020-03-26T18:43:19Z", "message": "Remove unneeded code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMzUwNjQ0", "url": "https://github.com/UNC-Libraries/box-c/pull/936#pullrequestreview-382350644", "createdAt": "2020-03-26T19:36:07Z", "commit": {"oid": "9854396e55933f6f331adfe47f079c176ba00ac1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozNjowN1rOF8XUlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxOTozNjowN1rOF8XUlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODg0MDk4MA==", "bodyText": "Did you want to remove this?", "url": "https://github.com/UNC-Libraries/box-c/pull/936#discussion_r398840980", "createdAt": "2020-03-26T19:36:07Z", "author": {"login": "lfarrell"}, "path": "fcrepo-clients/src/main/java/edu/unc/lib/dl/fcrepo4/RepositoryObjectLoader.java", "diffHunk": "@@ -143,5 +143,4 @@ public RepositoryObject getRepositoryObject(PID pid) {\n             }\n         }\n     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9854396e55933f6f331adfe47f079c176ba00ac1"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e394273c8951682f141412fbb2c308de3f443cfd", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/e394273c8951682f141412fbb2c308de3f443cfd", "committedDate": "2020-03-27T12:35:57Z", "message": "Undo change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2312, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}