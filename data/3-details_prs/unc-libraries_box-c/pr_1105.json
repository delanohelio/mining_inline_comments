{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MDY2ODg4", "number": 1105, "title": "Only mark a file completed if it passes virus checking", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2812", "createdAt": "2020-10-16T19:41:58Z", "url": "https://github.com/UNC-Libraries/box-c/pull/1105", "merged": true, "mergeCommit": {"oid": "6bccefecad890325c92168bebede959f70647f1f"}, "closed": true, "closedAt": "2020-10-22T14:53:28Z", "author": {"login": "lfarrell"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTLuCLAH2gAyNTA1MDY2ODg4OjVkMDkzMmYwZDgzMDJhNDcxMTg2ZGE4MzE0MjZiN2FmM2IyMzhkZDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVDMu2AFqTUxNDgxNzc0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d0932f0d8302a471186da831426b7af3b238dd7", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/5d0932f0d8302a471186da831426b7af3b238dd7", "committedDate": "2020-10-16T19:41:02Z", "message": "Only mark a file completed if it passes virus checking"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTkxOTY0", "url": "https://github.com/UNC-Libraries/box-c/pull/1105#pullrequestreview-514191964", "createdAt": "2020-10-21T21:15:46Z", "commit": {"oid": "5d0932f0d8302a471186da831426b7af3b238dd7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxNTo0N1rOHmF31g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQyMToxODowN1rOHmF_ZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwNDE1MA==", "bodyText": "I don't think you want this in a finally block, it means that it will still run even if the fail() up above was called", "url": "https://github.com/UNC-Libraries/box-c/pull/1105#discussion_r509704150", "createdAt": "2020-10-21T21:15:47Z", "author": {"login": "bbpennel"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/validate/VirusScanJobTest.java", "diffHunk": "@@ -205,6 +207,38 @@ public void failOneScanTest() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void failAndRescanTest() throws Exception {\n+        when(scanResult.getStatus()).thenReturn(Status.FAILED)\n+                .thenReturn(Status.PASSED);\n+        File textFile = new File(depositDir, \"text.txt\");\n+        doReturn(scanResult).when(clamScan).scan(argThat(new FileArgumentMatcher(textFile)));\n+\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        PID filePid = addFileObject(depBag, textFile);\n+\n+        job.closeModel();\n+\n+        try {\n+            job.run();\n+            fail();\n+        } catch(JobFailedException e) {\n+            verify(jobStatusFactory).setTotalCompletion(eq(jobUUID), eq(1));\n+            verify(jobStatusFactory, times(0)).incrCompletion(eq(jobUUID), eq(0));\n+        } finally {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0932f0d8302a471186da831426b7af3b238dd7"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTcwNjA4NA==", "bodyText": "very minor, but you can use never() instead of times(0)", "url": "https://github.com/UNC-Libraries/box-c/pull/1105#discussion_r509706084", "createdAt": "2020-10-21T21:18:07Z", "author": {"login": "bbpennel"}, "path": "deposit/src/test/java/edu/unc/lib/deposit/validate/VirusScanJobTest.java", "diffHunk": "@@ -205,6 +207,38 @@ public void failOneScanTest() throws Exception {\n         }\n     }\n \n+    @Test\n+    public void failAndRescanTest() throws Exception {\n+        when(scanResult.getStatus()).thenReturn(Status.FAILED)\n+                .thenReturn(Status.PASSED);\n+        File textFile = new File(depositDir, \"text.txt\");\n+        doReturn(scanResult).when(clamScan).scan(argThat(new FileArgumentMatcher(textFile)));\n+\n+        Model model = job.getWritableModel();\n+        Bag depBag = model.createBag(depositPid.getRepositoryPath());\n+\n+        PID filePid = addFileObject(depBag, textFile);\n+\n+        job.closeModel();\n+\n+        try {\n+            job.run();\n+            fail();\n+        } catch(JobFailedException e) {\n+            verify(jobStatusFactory).setTotalCompletion(eq(jobUUID), eq(1));\n+            verify(jobStatusFactory, times(0)).incrCompletion(eq(jobUUID), eq(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d0932f0d8302a471186da831426b7af3b238dd7"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c9c2d66e5d0f4e11af55a3f8269c45edf3859d2", "author": {"user": {"login": "lfarrell", "name": "Dean Farrell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/3c9c2d66e5d0f4e11af55a3f8269c45edf3859d2", "committedDate": "2020-10-22T12:14:22Z", "message": "Minor test cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0ODE3NzQ0", "url": "https://github.com/UNC-Libraries/box-c/pull/1105#pullrequestreview-514817744", "createdAt": "2020-10-22T14:53:16Z", "commit": {"oid": "3c9c2d66e5d0f4e11af55a3f8269c45edf3859d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2174, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}