{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU4Nzc5NDg0", "number": 873, "title": "BXC-2469 - More external binaries", "bodyText": "https://jira.lib.unc.edu/browse/BXC-2469\n\nEnables external binary ingest jobs\nUpdates actions which change MODS to store to external binary locations\nBulk metadata updates performed in camel\nRefactor of multi-destination transfer sessions so that they can be used in the same code as single destination sessions.\nAdds support for copying streams to external storage locations\nDeposit manifests stored as external", "createdAt": "2020-01-02T20:12:09Z", "url": "https://github.com/UNC-Libraries/box-c/pull/873", "merged": true, "mergeCommit": {"oid": "1d9bb84ad63c51e8c49471257c39505fc89c455b"}, "closed": true, "closedAt": "2020-01-03T16:59:30Z", "author": {"login": "bbpennel"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbxXGEmAH2gAyMzU4Nzc5NDg0OjU5NTkxNDhmYjRjNDBjNzZlMjU2MzFkYmNhZTU5ZTllYmFmZTViMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb2xSOvAH2gAyMzU4Nzc5NDg0Ojk2MTJjYzAxYjM3NzYzOGVhMjEyMmM0NWNhZjgzMzgyNWQ5YTY5MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5959148fb4c40c76e25631dbcae59e9ebafe5b1e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/5959148fb4c40c76e25631dbcae59e9ebafe5b1e", "committedDate": "2019-12-17T21:31:40Z", "message": "Refactor multi-destination transfer sessions to produce single destination sessions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf825634fee4b45285ae1d7d2c13056d190f61fe", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/cf825634fee4b45285ae1d7d2c13056d190f61fe", "committedDate": "2019-12-18T13:52:03Z", "message": "Add support for transferring streams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec38c4bb3663be585e6abd744b3890f79c89024d", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/ec38c4bb3663be585e6abd744b3890f79c89024d", "committedDate": "2019-12-18T14:10:31Z", "message": "Merge branch 'fcrepo4' into bxc-2469-mods-ext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fc46cdca91b84b5daf2ba8319afd31cbb91fc35", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/8fc46cdca91b84b5daf2ba8319afd31cbb91fc35", "committedDate": "2019-12-18T14:56:10Z", "message": "Move UpdateDescriptionService to persistence, use it in EditTitleService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ad8dc0904fc22e657815134f4fa14729ca38603", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/0ad8dc0904fc22e657815134f4fa14729ca38603", "committedDate": "2019-12-18T15:54:27Z", "message": "Change contentObject.setDescription to take a URI instead of a stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b468c3ae9d1d47ae39dd2e735e9c61d38eb454ea", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/b468c3ae9d1d47ae39dd2e735e9c61d38eb454ea", "committedDate": "2019-12-18T19:28:36Z", "message": "Update ingest jobs to treat mods as external binaries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "129fbefbd234a9a19ec5f3fe735c017c21c65317", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/129fbefbd234a9a19ec5f3fe735c017c21c65317", "committedDate": "2019-12-19T15:51:49Z", "message": "XML import job using transfer session, refactor tests to generate metadata import files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da2b4934f442e45560f7f9cca7c11b6e06abebf3", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/da2b4934f442e45560f7f9cca7c11b6e06abebf3", "committedDate": "2019-12-19T16:02:51Z", "message": "Merge branch 'fcrepo4' into bxc-2469-mods-ext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e6bca857e8b013a49c089fe3af532ed3b0b29e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/00e6bca857e8b013a49c089fe3af532ed3b0b29e", "committedDate": "2019-12-23T15:28:08Z", "message": "Add binary transfer jobs to deposit pipeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be221e848a1222f5a873300218e38b195d69418e", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/be221e848a1222f5a873300218e38b195d69418e", "committedDate": "2019-12-24T00:54:37Z", "message": "Add method to check for object existense to obj factory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34fb54be2160c4152d7bf8c205cb5953bd92605a", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/34fb54be2160c4152d7bf8c205cb5953bd92605a", "committedDate": "2019-12-24T00:56:01Z", "message": "Ingest deposit manifests as external binaries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c07a57d4a1b5d315739047bd2eb87d20eea875d", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/0c07a57d4a1b5d315739047bd2eb87d20eea875d", "committedDate": "2020-01-02T17:13:42Z", "message": "Import XML submits messages to jms and are processed by camel. Move most import xml code to persistence. Log access exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7", "committedDate": "2020-01-02T19:56:02Z", "message": "Add integration test for import of bulk descriptions in camel. Move import xml service to persistence"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MDk4NzUx", "url": "https://github.com/UNC-Libraries/box-c/pull/873#pullrequestreview-338098751", "createdAt": "2020-01-03T14:19:03Z", "commit": {"oid": "11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNDoxOTowM1rOFaA_YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNDoxOTowM1rOFaA_YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjgyMzUyMQ==", "bodyText": "Does the timer get used?", "url": "https://github.com/UNC-Libraries/box-c/pull/873#discussion_r362823521", "createdAt": "2020-01-03T14:19:03Z", "author": {"login": "lfarrell"}, "path": "persistence/src/main/java/edu/unc/lib/dl/persist/services/edit/UpdateDescriptionService.java", "diffHunk": "@@ -0,0 +1,185 @@\n+/**\n+ * Copyright 2008 The University of North Carolina at Chapel Hill\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *         http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package edu.unc.lib.dl.persist.services.edit;\n+\n+import static edu.unc.lib.dl.model.DatastreamPids.getMdDescriptivePid;\n+import static java.util.Arrays.asList;\n+import static org.apache.commons.io.IOUtils.toByteArray;\n+\n+import java.io.ByteArrayInputStream;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.net.URI;\n+\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+\n+import edu.unc.lib.dl.acl.service.AccessControlService;\n+import edu.unc.lib.dl.acl.util.AgentPrincipals;\n+import edu.unc.lib.dl.acl.util.Permission;\n+import edu.unc.lib.dl.fcrepo4.ContentObject;\n+import edu.unc.lib.dl.fcrepo4.RepositoryObjectLoader;\n+import edu.unc.lib.dl.fedora.PID;\n+import edu.unc.lib.dl.metrics.TimerFactory;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocation;\n+import edu.unc.lib.dl.persist.services.storage.StorageLocationManager;\n+import edu.unc.lib.dl.persist.services.transfer.BinaryTransferService;\n+import edu.unc.lib.dl.persist.services.transfer.BinaryTransferSession;\n+import edu.unc.lib.dl.services.OperationsMessageSender;\n+import edu.unc.lib.dl.validation.MODSValidator;\n+import edu.unc.lib.dl.validation.MetadataValidationException;\n+import io.dropwizard.metrics5.Timer;\n+\n+/**\n+ * Service that manages description, e.g., MODS, updates\n+ *\n+ * @author harring\n+ *\n+ */\n+public class UpdateDescriptionService {\n+    private static final Logger log = LoggerFactory.getLogger(UpdateDescriptionService.class);\n+\n+    private AccessControlService aclService;\n+    private RepositoryObjectLoader repoObjLoader;\n+    private OperationsMessageSender operationsMessageSender;\n+    private MODSValidator modsValidator;\n+    private BinaryTransferService transferService;\n+    private StorageLocationManager locationManager;\n+\n+    private boolean validate;\n+\n+    private static final Timer timer = TimerFactory.createTimerForClass(UpdateDescriptionService.class);\n+\n+    public UpdateDescriptionService() {\n+        validate = true;\n+    }\n+\n+    /**\n+     * Updates the MODS description of a single object\n+     *\n+     * @param agent\n+     * @param pid\n+     * @param modsStream\n+     * @throws MetadataValidationException\n+     * @throws IOException\n+     */\n+    public void updateDescription(AgentPrincipals agent, PID pid, InputStream modsStream)\n+            throws MetadataValidationException, IOException {\n+\n+        ContentObject obj = (ContentObject) repoObjLoader.getRepositoryObject(pid);\n+        StorageLocation destLocation = locationManager.getStorageLocation(obj);\n+\n+        try (BinaryTransferSession transferSession = transferService.getSession(destLocation)) {\n+            updateDescription(transferSession, agent, obj, modsStream);\n+        }\n+    }\n+\n+    /**\n+     * Updates the MODS description of an object as part of the provided ongoing session.\n+     *\n+     * @param transferSession ongoing transfer session\n+     * @param agent\n+     * @param pid\n+     * @param modsStream\n+     * @throws MetadataValidationException\n+     * @throws IOException\n+     */\n+    public void updateDescription(BinaryTransferSession transferSession, AgentPrincipals agent,\n+            PID pid, InputStream modsStream) throws MetadataValidationException, IOException {\n+\n+        ContentObject obj = (ContentObject) repoObjLoader.getRepositoryObject(pid);\n+\n+        updateDescription(transferSession, agent, obj, modsStream);\n+    }\n+\n+    private void updateDescription(BinaryTransferSession transferSession, AgentPrincipals agent,\n+            ContentObject obj, InputStream modsStream) throws IOException {\n+\n+        log.debug(\"Updating description for {}\", obj.getPid().getId());\n+        try (Timer.Context context = timer.time()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11e86d7b2b3c29ef93b246ce25d3c7899a7ee6d7"}, "originalPosition": 112}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1baeee0e737e75698ec8216acffd5f1412862b2", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/a1baeee0e737e75698ec8216acffd5f1412862b2", "committedDate": "2020-01-03T14:28:07Z", "message": "Trim whitespace off end of derivative path before adding extension, and reuse uuid generator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "187b5ef7fc29fbe9c3e51e5f6de689348d3e462a", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/187b5ef7fc29fbe9c3e51e5f6de689348d3e462a", "committedDate": "2020-01-03T14:44:18Z", "message": "Copy files to temp before supplying to fedora"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e659b634e6aa514bb489b0c12fe1c1476e8e7af2", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/e659b634e6aa514bb489b0c12fe1c1476e8e7af2", "committedDate": "2020-01-03T15:26:23Z", "message": "Copy more test files to temp before setting description"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4MTM1MTA3", "url": "https://github.com/UNC-Libraries/box-c/pull/873#pullrequestreview-338135107", "createdAt": "2020-01-03T15:34:50Z", "commit": {"oid": "e659b634e6aa514bb489b0c12fe1c1476e8e7af2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTozNDo1MFrOFaCvHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTozNDo1MFrOFaCvHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1MjEyNA==", "bodyText": "Can probably get rid of this blank line", "url": "https://github.com/UNC-Libraries/box-c/pull/873#discussion_r362852124", "createdAt": "2020-01-03T15:34:50Z", "author": {"login": "lfarrell"}, "path": "deposit/src/main/java/edu/unc/lib/deposit/transfer/TransferBinariesToStorageJob.java", "diffHunk": "@@ -91,9 +100,17 @@ public void runJob() {\n     private void transferBinaries(Resource resc, BinaryTransferSession transferSession) {\n         PID objPid = PIDs.get(resc.toString());\n \n-        if (resc.hasProperty(RDF.type, Cdr.FileObject)) {\n+        Set<Resource> rescTypes = resc.listProperties(RDF.type).toList().stream()\n+                .map(Statement::getResource).collect(toSet());\n+\n+        if (TYPES_ALLOWING_DESC.stream().anyMatch(rescTypes::contains)) {\n+            transferModsFile(objPid, resc, transferSession);\n+        }\n+\n+        if (rescTypes.contains(Cdr.FileObject)) {\n             transferOriginalFile(objPid, resc, transferSession);\n             transferFitsExtract(objPid, resc, transferSession);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e659b634e6aa514bb489b0c12fe1c1476e8e7af2"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9612cc01b377638ea2122c45caf833825d9a6915", "author": {"user": {"login": "bbpennel", "name": "Ben Pennell"}}, "url": "https://github.com/UNC-Libraries/box-c/commit/9612cc01b377638ea2122c45caf833825d9a6915", "committedDate": "2020-01-03T16:52:06Z", "message": "Delete blank line"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2390, "cost": 1, "resetAt": "2021-11-01T16:37:27Z"}}}