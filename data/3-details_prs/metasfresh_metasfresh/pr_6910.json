{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5OTgzMTY0", "number": 6910, "title": "Servicefees per Provider Customer", "bodyText": "#6904", "createdAt": "2020-06-25T12:19:47Z", "url": "https://github.com/metasfresh/metasfresh/pull/6910", "merged": true, "mergeCommit": {"oid": "bc0f2daa74d291236719ae1bb86ed3cbacdd9222"}, "closed": true, "closedAt": "2020-07-02T11:11:13Z", "author": {"login": "TheBestPessimist"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcu8nJuAFqTQzODAyNjY5MA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcw8xBpAFqTQ0MTU3Mjg4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDI2Njkw", "url": "https://github.com/metasfresh/metasfresh/pull/6910#pullrequestreview-438026690", "createdAt": "2020-06-26T05:43:40Z", "commit": {"oid": "5daad277a614e433908a238954c83649c86fd72d"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDI2OTk4", "url": "https://github.com/metasfresh/metasfresh/pull/6910#pullrequestreview-438026998", "createdAt": "2020-06-26T05:44:39Z", "commit": {"oid": "5daad277a614e433908a238954c83649c86fd72d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTo0NDozOVrOGpUYqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTo0NDozOVrOGpUYqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3ODc5Mw==", "bodyText": "consider indexing by bpartnerId", "url": "https://github.com/metasfresh/metasfresh/pull/6910#discussion_r445978793", "createdAt": "2020-06-26T05:44:39Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/invoiceProcessingServiceCompany/InvoiceProcessingServiceCompanyConfig.java", "diffHunk": "@@ -45,6 +49,34 @@\n \t@NonNull\n \tProductId serviceFeeProductId;\n \n+\t@NonNull ZonedDateTime validFrom;\n+\n+\t@Getter(AccessLevel.NONE)\n+\t@NonNull ImmutableList<InvoiceProcessingServiceCompanyConfigBPartnerDetails> bpartnerDetails;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5daad277a614e433908a238954c83649c86fd72d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4MDI3NjI1", "url": "https://github.com/metasfresh/metasfresh/pull/6910#pullrequestreview-438027625", "createdAt": "2020-06-26T05:46:38Z", "commit": {"oid": "5daad277a614e433908a238954c83649c86fd72d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTo0NjozOFrOGpUaqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQwNTo0NjozOFrOGpUaqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTk3OTMwNQ==", "bodyText": "extract the mapper into a method (static preferably)", "url": "https://github.com/metasfresh/metasfresh/pull/6910#discussion_r445979305", "createdAt": "2020-06-26T05:46:38Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/invoiceProcessingServiceCompany/InvoiceProcessingServiceCompanyConfigRepository.java", "diffHunk": "@@ -47,77 +45,53 @@\n {\n \tprivate final IQueryBL queryBL = Services.get(IQueryBL.class);\n \n-\tprivate final CCache<InvoiceProcessingServiceCompanyConfigId, InvoiceProcessingServiceCompanyConfig> //\n-\tconfigsById = CCache.<InvoiceProcessingServiceCompanyConfigId, InvoiceProcessingServiceCompanyConfig> builder()\n-\t\t\t.tableName(I_InvoiceProcessingServiceCompany.Table_Name)\n-\t\t\t.build();\n-\n-\tprivate final CCache<Integer, CustomerToConfigAssignmentMap> //\n-\tcustomerToConfigAssignmentsCache = CCache.<Integer, CustomerToConfigAssignmentMap> builder()\n-\t\t\t.tableName(I_InvoiceProcessingServiceCompany_BPartnerAssignment.Table_Name)\n-\t\t\t.build();\n+\tprivate final CCache<Integer, InvoiceProcessingServiceCompanyConfigMap> configsMapCache =\n+\t\t\tCCache.<Integer, InvoiceProcessingServiceCompanyConfigMap>builder()\n+\t\t\t\t\t.tableName(I_InvoiceProcessingServiceCompany.Table_Name)\n+\t\t\t\t\t.additionalTableNameToResetFor(I_InvoiceProcessingServiceCompany_BPartnerAssignment.Table_Name)\n+\t\t\t\t\t.build();\n \n-\tpublic Optional<InvoiceProcessingServiceCompanyConfig> getByCustomerId(@NonNull final BPartnerId customerId)\n+\tpublic Optional<InvoiceProcessingServiceCompanyConfig> getByCustomerId(@NonNull final BPartnerId customerId, @NonNull final ZonedDateTime evaluationDate)\n \t{\n-\t\treturn getConfigIdByCustomerId(customerId)\n-\t\t\t\t.map(this::getById)\n-\t\t\t\t.filter(InvoiceProcessingServiceCompanyConfig::isActive);\n+\t\tfinal InvoiceProcessingServiceCompanyConfigMap config = configsMapCache.getOrLoad(0, this::retrieveAllCompanyConfigs);\n+\t\treturn config.getByCustomerIdAndDate(customerId, evaluationDate);\n \t}\n \n-\tprivate Optional<InvoiceProcessingServiceCompanyConfigId> getConfigIdByCustomerId(@NonNull final BPartnerId customerId)\n+\t@NonNull\n+\tprivate InvoiceProcessingServiceCompanyConfigMap retrieveAllCompanyConfigs()\n \t{\n-\t\tfinal CustomerToConfigAssignmentMap customerToConfigAssignmentMap = customerToConfigAssignmentsCache.getOrLoad(0, this::retrieveCustomerToConfigAssignmentMap);\n-\t\treturn customerToConfigAssignmentMap.getConfigIdByCustomerId(customerId);\n-\t}\n-\n-\tprivate InvoiceProcessingServiceCompanyConfig getById(@NonNull final InvoiceProcessingServiceCompanyConfigId configId)\n-\t{\n-\t\treturn configsById.getOrLoad(configId, this::retrieveById);\n-\t}\n-\n-\tprivate InvoiceProcessingServiceCompanyConfig retrieveById(@NonNull final InvoiceProcessingServiceCompanyConfigId configId)\n-\t{\n-\t\tfinal I_InvoiceProcessingServiceCompany record = loadOutOfTrx(configId, I_InvoiceProcessingServiceCompany.class);\n-\n-\t\treturn InvoiceProcessingServiceCompanyConfig.builder()\n-\t\t\t\t.active(record.isActive())\n-\t\t\t\t.serviceCompanyBPartnerId(BPartnerId.ofRepoId(record.getServiceCompany_BPartner_ID()))\n-\t\t\t\t.serviceInvoiceDocTypeId(DocTypeId.ofRepoId(record.getServiceInvoice_DocType_ID()))\n-\t\t\t\t.serviceFeeProductId(ProductId.ofRepoId(record.getServiceFee_Product_ID()))\n-\t\t\t\t.feePercentageOfGrandTotal(Percent.of(record.getFeePercentageOfGrandTotal()))\n-\t\t\t\t.build();\n+\t\tfinal ImmutableList<InvoiceProcessingServiceCompanyConfig> collect = queryBL.createQueryBuilder(I_InvoiceProcessingServiceCompany.class)\n+\t\t\t\t.addOnlyActiveRecordsFilter()\n+\t\t\t\t.create()\n+\t\t\t\t.iterateAndStream()\n+\t\t\t\t.map(record -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5daad277a614e433908a238954c83649c86fd72d"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb7236f9a15c1ad189a909aefdb213153400cb51", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/eb7236f9a15c1ad189a909aefdb213153400cb51", "committedDate": "2020-06-26T05:51:16Z", "message": "Add sql changes to `Invoice Processing Service Company`\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a696010533b7f78fae5448f0437a1ca1bffbf48e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a696010533b7f78fae5448f0437a1ca1bffbf48e", "committedDate": "2020-06-26T05:52:50Z", "message": "InvoiceProcessingServiceCompany: add ValidFrom and Percent\n\nTake into account ValidFrom when selecting the correct InvoiceProcessingServiceCompanyConfig\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0a390a6eb85936966c64b5da0a3ec915839de66", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/d0a390a6eb85936966c64b5da0a3ec915839de66", "committedDate": "2020-06-26T05:53:00Z", "message": "Bugfix\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a19a9b4788615a728a4ac9564e4c8c4522410420", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a19a9b4788615a728a4ac9564e4c8c4522410420", "committedDate": "2020-06-26T05:53:00Z", "message": "Sql Bugfix\n\nI don't know how i removed that\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f8d8f3a3f6bdba72f984e2e75ead18f09dce654", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/5f8d8f3a3f6bdba72f984e2e75ead18f09dce654", "committedDate": "2020-06-26T06:08:56Z", "message": "Fixes after \ud83c\udf52 and rebase\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5daad277a614e433908a238954c83649c86fd72d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/5daad277a614e433908a238954c83649c86fd72d", "committedDate": "2020-06-26T04:19:57Z", "message": "Sql Bugfix\n\nI don't know how i removed that\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}, "afterCommit": {"oid": "5f8d8f3a3f6bdba72f984e2e75ead18f09dce654", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/5f8d8f3a3f6bdba72f984e2e75ead18f09dce654", "committedDate": "2020-06-26T06:08:56Z", "message": "Fixes after \ud83c\udf52 and rebase\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "502ee46dedbf56643fd35404d5fe551515fc6816", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/502ee46dedbf56643fd35404d5fe551515fc6816", "committedDate": "2020-06-26T06:26:58Z", "message": "Update copyright\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72f9393c241d6e4292f45bb8e82577d68098771d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/72f9393c241d6e4292f45bb8e82577d68098771d", "committedDate": "2020-06-26T06:43:53Z", "message": "Index `bpartnerDetails` by bpartnerId\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a6195ca5c5678d72739320493449d518b3e441", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/74a6195ca5c5678d72739320493449d518b3e441", "committedDate": "2020-06-26T07:25:23Z", "message": "Small warning fix\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10cbf0660faaaff8c8d4c8204c022ef77e5c7b88", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/10cbf0660faaaff8c8d4c8204c022ef77e5c7b88", "committedDate": "2020-06-26T07:26:44Z", "message": "Add JUnit for `InvoiceProcessingServiceCompanyConfigRepository`\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "954f5756db8264130d3fa75e5a71a62f67460b48", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/954f5756db8264130d3fa75e5a71a62f67460b48", "committedDate": "2020-06-26T07:31:34Z", "message": "One more JUnit\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7558f8851ae0af58893a2f7b60b308100c76344", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a7558f8851ae0af58893a2f7b60b308100c76344", "committedDate": "2020-06-26T09:19:56Z", "message": "Formatting\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5442965acc0f3b586b48e491a49a9eb821cbb81e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/5442965acc0f3b586b48e491a49a9eb821cbb81e", "committedDate": "2020-06-26T09:20:15Z", "message": "Update JUnit\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6dd0f23f0176fa176acf83a80755576ccfb07ca", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a6dd0f23f0176fa176acf83a80755576ccfb07ca", "committedDate": "2020-06-26T09:21:27Z", "message": "Fix N+1 problem\n\nThanks teo for pointing out the obvious\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fe220e245fabdc8fcc2415ef60a2a7dfecaa080", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/6fe220e245fabdc8fcc2415ef60a2a7dfecaa080", "committedDate": "2020-06-30T12:29:07Z", "message": "Change Name\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "128d316a4ba163950815e26cc669b4f11d480598", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/128d316a4ba163950815e26cc669b4f11d480598", "committedDate": "2020-07-01T10:48:33Z", "message": "Use Payment.Date and BPartner when creating the Invoice Processing Service Company Purchase Invoice\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4906d965dddc9a64b93abc1befa79a6f3b29be44", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/4906d965dddc9a64b93abc1befa79a6f3b29be44", "committedDate": "2020-07-01T10:50:54Z", "message": "C_Payment, C_Invoice: add Partner as identifier for easier search\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c48fce938147c531e42e6264d64740025440ee57", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/c48fce938147c531e42e6264d64740025440ee57", "committedDate": "2020-07-01T13:02:40Z", "message": "Add Unit test\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4085bdc612ad82f501d8d01bcf4e7a2bd1f8323b", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/4085bdc612ad82f501d8d01bcf4e7a2bd1f8323b", "committedDate": "2020-07-01T13:06:53Z", "message": "Cleanup\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee6f14b567962cbe6d67ebf986ba3d57368b21d0", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ee6f14b567962cbe6d67ebf986ba3d57368b21d0", "committedDate": "2020-07-01T13:07:51Z", "message": "Cleanup\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "985645d6f7c65c6223bbc3c284b1f2a5de4b217f", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/985645d6f7c65c6223bbc3c284b1f2a5de4b217f", "committedDate": "2020-07-01T13:17:14Z", "message": "Cleanup\n\nhttps://github.com/metasfresh/metasfresh/issues/6904"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNTcyODg0", "url": "https://github.com/metasfresh/metasfresh/pull/6910#pullrequestreview-441572884", "createdAt": "2020-07-02T11:02:18Z", "commit": {"oid": "985645d6f7c65c6223bbc3c284b1f2a5de4b217f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3291, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}