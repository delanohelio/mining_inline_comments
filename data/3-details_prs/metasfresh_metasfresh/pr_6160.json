{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNDg0ODgz", "number": 6160, "title": "Jasper Report: Profit & Loss Report", "bodyText": "#6148", "createdAt": "2020-02-11T05:48:32Z", "url": "https://github.com/metasfresh/metasfresh/pull/6160", "merged": true, "mergeCommit": {"oid": "cd120ced9fa903dbca2459e0e1f1c7d13a86c5a7"}, "closed": true, "closedAt": "2020-02-14T11:44:47Z", "author": {"login": "TheBestPessimist"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDPnXrAFqTM1NjU2MTEwNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEKiaWgBqjMwMzc3NDAxOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NTYxMTA1", "url": "https://github.com/metasfresh/metasfresh/pull/6160#pullrequestreview-356561105", "createdAt": "2020-02-11T10:49:59Z", "commit": {"oid": "50b9e1d9c72d2bc66e1da8d7af3874a288fd7492"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMDo0OTo1OVrOFoEejg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxMDo1OTowNVrOFoEviQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2MDcxOA==", "bodyText": "do we have an index on fas.c_period_id?`if not, do we need one?\nEDI: we have one", "url": "https://github.com/metasfresh/metasfresh/pull/6160#discussion_r377560718", "createdAt": "2020-02-11T10:49:59Z", "author": {"login": "metas-ts"}, "path": "de.metas.acct.base/src/main/sql/postgresql/ddl/functions/ProfitAndLossBalanceForAccountInPeriod.sql", "diffHunk": "@@ -0,0 +1,59 @@\n+DROP FUNCTION IF EXISTS ProfitAndLossBalanceForAccountInPeriod(IN p_C_ElementValue_ID numeric, IN p_startDate timestamp, IN p_endDate timestamp);\n+\n+CREATE OR REPLACE FUNCTION ProfitAndLossBalanceForAccountInPeriod(IN p_C_ElementValue_ID numeric, IN p_startDate timestamp, IN p_endDate timestamp)\n+    RETURNS NUMERIC\n+AS\n+$BODY$\n+\n+WITH periods_between_dates AS\n+         (\n+             SELECT --\n+                    p.c_period_id,\n+                    p.startdate,\n+                    p.enddate\n+             FROM c_period p\n+             WHERE TRUE\n+               AND p.startdate >= p_startDate\n+               AND p.enddate <= p_endDate\n+         ),\n+     fact_acct_summary_for_periods AS\n+         (\n+             -- fact_acct_summary filtered for selected period\n+             SELECT fas.*\n+             FROM periods_between_dates p\n+                      INNER JOIN fact_acct_summary fas ON fas.c_period_id = p.c_period_id", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b9e1d9c72d2bc66e1da8d7af3874a288fd7492"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NDA5Ng==", "bodyText": "when it's possible - i think in this case it is - one should use STABLE(check the docu for details)", "url": "https://github.com/metasfresh/metasfresh/pull/6160#discussion_r377564096", "createdAt": "2020-02-11T10:57:00Z", "author": {"login": "metas-ts"}, "path": "de.metas.acct.base/src/main/sql/postgresql/ddl/functions/ProfitAndLossBalanceForAccountInPeriod.sql", "diffHunk": "@@ -0,0 +1,59 @@\n+DROP FUNCTION IF EXISTS ProfitAndLossBalanceForAccountInPeriod(IN p_C_ElementValue_ID numeric, IN p_startDate timestamp, IN p_endDate timestamp);\n+\n+CREATE OR REPLACE FUNCTION ProfitAndLossBalanceForAccountInPeriod(IN p_C_ElementValue_ID numeric, IN p_startDate timestamp, IN p_endDate timestamp)\n+    RETURNS NUMERIC\n+AS\n+$BODY$\n+\n+WITH periods_between_dates AS\n+         (\n+             SELECT --\n+                    p.c_period_id,\n+                    p.startdate,\n+                    p.enddate\n+             FROM c_period p\n+             WHERE TRUE\n+               AND p.startdate >= p_startDate\n+               AND p.enddate <= p_endDate\n+         ),\n+     fact_acct_summary_for_periods AS\n+         (\n+             -- fact_acct_summary filtered for selected period\n+             SELECT fas.*\n+             FROM periods_between_dates p\n+                      INNER JOIN fact_acct_summary fas ON fas.c_period_id = p.c_period_id\n+             WHERE fas.account_id = p_C_ElementValue_ID\n+         ),\n+     result_table AS\n+         (\n+             SELECT coalesce(sum(acctbalance(fas.account_id, fas.amtacctdr, fas.amtacctcr)), 0) balance\n+             FROM c_elementvalue ev\n+                      INNER JOIN fact_acct_summary_for_periods fas ON fas.account_id = ev.c_elementvalue_id\n+             WHERE TRUE\n+               AND ev.accounttype IN ('E', 'R')\n+               -- only 'Actual' posting type is used\n+               AND fas.postingtype = 'A'\n+             GROUP BY ev.value, ev.name\n+             ORDER BY ev.name\n+         )\n+SELECT balance\n+FROM result_table\n+\n+/**\n+  Why is this union needed?\n+  In case no `fact_acct_summary` for an account_id exists, `result_table` returns no rows. It doesn't return null (so that i can use coalesce), but returns NO rows.\n+     example: SELECT ProfitAndLossBalanceForAccountInPeriod(1, '1993-01-01'::Timestamp, '2992-01-01'::Timestamp); -- this returns NO rows\n+  I have simply added this union in case the select returns nothing. If you have a better solution, i'm more than happy to hear it, as this feels like a hack.\n+ */\n+UNION ALL\n+(\n+    SELECT 0\n+)\n+LIMIT 1\n+    ;\n+$BODY$\n+    LANGUAGE SQL\n+    VOLATILE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b9e1d9c72d2bc66e1da8d7af3874a288fd7492"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzU2NTA2NQ==", "bodyText": "it's great to provide this info, but this please also add it as a comment to the function in question, so future devs can see it there too", "url": "https://github.com/metasfresh/metasfresh/pull/6160#discussion_r377565065", "createdAt": "2020-02-11T10:59:05Z", "author": {"login": "metas-ts"}, "path": "de.metas.acct.base/src/main/sql/postgresql/ddl/functions/acctBalanceUntilDate.sql", "diffHunk": "@@ -1,12 +1,36 @@\n -- Function: de_metas_acct.acctbalanceuntildate(numeric, numeric, date, character)\n \n- DROP FUNCTION IF EXISTS de_metas_acct.acctbalanceuntildate(numeric, numeric, date, character);\n+DROP FUNCTION IF EXISTS de_metas_acct.acctbalanceuntildate(numeric, numeric, date, character);\n \n-DROP FUNCTION IF EXISTS   de_metas_acct.acctbalanceuntildate(p_account_id numeric, p_c_acctschema_id numeric, p_dateacct date,  ad_org_id numeric, p_includepostingtypestatistical character);\n-DROP FUNCTION IF EXISTS   de_metas_acct.acctbalanceuntildate(p_account_id numeric, p_c_acctschema_id numeric, p_dateacct date,  ad_org_id numeric, p_includepostingtypestatistical character, IN  p_ExcludePostingTypeYearEnd character);\n+DROP FUNCTION IF EXISTS de_metas_acct.acctbalanceuntildate(p_account_id numeric, p_c_acctschema_id numeric, p_dateacct date, ad_org_id numeric, p_includepostingtypestatistical character);\n+DROP FUNCTION IF EXISTS de_metas_acct.acctbalanceuntildate(p_account_id numeric, p_c_acctschema_id numeric, p_dateacct date, ad_org_id numeric, p_includepostingtypestatistical character, IN p_ExcludePostingTypeYearEnd character);\n \n+--\n+--\n+--\n+--\n+--\n+-- TODO this will be deleted in https://github.com/metasfresh/metasfresh/issues/6149\n+--      DO NOT USE THIS ANYMORE\n+--      PLEASE USE acctBalanceToDate", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50b9e1d9c72d2bc66e1da8d7af3874a288fd7492"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MDE1MDQ5", "url": "https://github.com/metasfresh/metasfresh/pull/6160#pullrequestreview-358015049", "createdAt": "2020-02-13T08:01:27Z", "commit": {"oid": "1d3ba0254ccfdbbb00c48cbd666afd32428e291c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwODowMToyN1rOFpKE9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QwODowMTo0NlrOFpKFgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwMTA0NA==", "bodyText": "better name the columns as:\n\nvalue => AccountValue\nname => AccountName\nIsSummary => take out\nthree_years_ago => Balance_3yAgo\ntwo_years_ago => Balance_2yAgo\none_year_ago => Balance_1yAgo\ncurrent_period => Balance", "url": "https://github.com/metasfresh/metasfresh/pull/6160#discussion_r378701044", "createdAt": "2020-02-13T08:01:27Z", "author": {"login": "teosarca"}, "path": "de.metas.acct.base/src/main/sql/postgresql/ddl/functions/ProfitAndLossReport.sql", "diffHunk": "@@ -0,0 +1,39 @@\n+DROP FUNCTION IF EXISTS ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp, IN p_compareWithPrevious1Year boolean, IN p_compareWithPrevious3Years boolean);\n+DROP FUNCTION IF EXISTS ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp);\n+\n+CREATE OR REPLACE FUNCTION ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp)\n+    RETURNS TABLE\n+            (\n+                name            text,\n+                value           text,\n+                isSummary       text,\n+                three_years_ago numeric,\n+                two_years_ago   numeric,\n+                one_year_ago    numeric,\n+                current_period  numeric", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3ba0254ccfdbbb00c48cbd666afd32428e291c"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODcwMTE4NQ==", "bodyText": "also filter by ev.IsSummary=N", "url": "https://github.com/metasfresh/metasfresh/pull/6160#discussion_r378701185", "createdAt": "2020-02-13T08:01:46Z", "author": {"login": "teosarca"}, "path": "de.metas.acct.base/src/main/sql/postgresql/ddl/functions/ProfitAndLossReport.sql", "diffHunk": "@@ -0,0 +1,39 @@\n+DROP FUNCTION IF EXISTS ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp, IN p_compareWithPrevious1Year boolean, IN p_compareWithPrevious3Years boolean);\n+DROP FUNCTION IF EXISTS ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp);\n+\n+CREATE OR REPLACE FUNCTION ProfitAndLossReport(IN p_startDate timestamp, IN p_endDate timestamp)\n+    RETURNS TABLE\n+            (\n+                name            text,\n+                value           text,\n+                isSummary       text,\n+                three_years_ago numeric,\n+                two_years_ago   numeric,\n+                one_year_ago    numeric,\n+                current_period  numeric\n+            )\n+AS\n+$BODY$\n+\n+SELECT ev.name,\n+       ev.value,\n+       ev.issummary::text,\n+       ProfitAndLossBalanceForAccountInPeriod(ev.c_elementvalue_id, p_startDate - '3 Year'::interval, p_endDate - '3 Year'::interval) three_years_ago_balance,\n+       ProfitAndLossBalanceForAccountInPeriod(ev.c_elementvalue_id, p_startDate - '2 Year'::interval, p_endDate - '2 Year'::interval) two_years_ago_balance,\n+       ProfitAndLossBalanceForAccountInPeriod(ev.c_elementvalue_id, p_startDate - '1 Year'::interval, p_endDate - '1 Year'::interval) one_year_ago_balance,\n+       ProfitAndLossBalanceForAccountInPeriod(ev.c_elementvalue_id, p_startDate, p_endDate)                                           current_balance\n+FROM c_elementvalue ev\n+WHERE TRUE\n+  AND ev.accounttype IN ('E', 'R')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1d3ba0254ccfdbbb00c48cbd666afd32428e291c"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82e14ee11bf4bfc5a9f3c2115920b34aaf6526ed", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/82e14ee11bf4bfc5a9f3c2115920b34aaf6526ed", "committedDate": "2020-02-14T07:34:23Z", "message": "Add ProfitAndLossBalance related sql functions\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b58a637f7f344286635ceb35e1c884de2a3a2d5", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/1b58a637f7f344286635ceb35e1c884de2a3a2d5", "committedDate": "2020-02-14T07:34:23Z", "message": "Element Values window: add AccountType to filters\n\nhttps://github.com/metasfresh/metasfresh/issues/6061"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3462f6bd020830a3ddd15a0a5ecb5904ca137e3c", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/3462f6bd020830a3ddd15a0a5ecb5904ca137e3c", "committedDate": "2020-02-14T07:34:23Z", "message": "Mark sql for deletion\n\nhttps://github.com/metasfresh/metasfresh/issues/6061"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a0fa361fa906942f76278d0d647b79db52c0e4", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a7a0fa361fa906942f76278d0d647b79db52c0e4", "committedDate": "2020-02-14T07:34:23Z", "message": "Update function and columns name\n\nhttps://github.com/metasfresh/metasfresh/issues/6061"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d42b51d68680f3aa1c8516f2c3e6d08fe6e7e8eb", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/d42b51d68680f3aa1c8516f2c3e6d08fe6e7e8eb", "committedDate": "2020-02-14T07:34:23Z", "message": "Move sql file\n\nhttps://github.com/metasfresh/metasfresh/issues/6061"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64fb0b60378072580586958d308aec0431b8e75e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/64fb0b60378072580586958d308aec0431b8e75e", "committedDate": "2020-02-14T07:34:23Z", "message": "Add Profit And Loss Report excel process\n\nhttps://github.com/metasfresh/metasfresh/issues/6061"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73c4ff77d0dc25a9325ff75b94c253b1cd49c90b", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/73c4ff77d0dc25a9325ff75b94c253b1cd49c90b", "committedDate": "2020-02-14T07:34:23Z", "message": "Mark ProfitAndLossBalanceForAccountInPeriod as stable\n\nhttps://github.com/metasfresh/metasfresh/issues/6121"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0be5006e729355853f068b12e0773fdfb2bb5d20", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/0be5006e729355853f068b12e0773fdfb2bb5d20", "committedDate": "2020-02-14T07:34:23Z", "message": "Add comment for function deprecation warning\n\nhttps://github.com/metasfresh/metasfresh/issues/6121"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebf5b68addb1b0a8a2ec2f506510e173af9ec0c0", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ebf5b68addb1b0a8a2ec2f506510e173af9ec0c0", "committedDate": "2020-02-14T07:34:24Z", "message": "Add IsSummary flag to ProfitAndLossReport\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "961ecb148c9da079679799f4c369e8ed5e0f1b88", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/961ecb148c9da079679799f4c369e8ed5e0f1b88", "committedDate": "2020-02-14T07:34:24Z", "message": "Change trls\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28f5d40d6cf17aa983204c01cc2e7b87457062b7", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/28f5d40d6cf17aa983204c01cc2e7b87457062b7", "committedDate": "2020-02-14T07:34:24Z", "message": "Mark function as stable, not volatile\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f01c0235fffdabd91f1ab677f987dd4cbcc9319d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/f01c0235fffdabd91f1ab677f987dd4cbcc9319d", "committedDate": "2020-02-14T07:34:24Z", "message": "Update trl + add new ProfitAndLoss functions migration scripts\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "306dd3769a565620740704661df0967d9c2c9f74", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/306dd3769a565620740704661df0967d9c2c9f74", "committedDate": "2020-02-14T06:09:05Z", "message": "Update trl + add new ProfitAndLoss functions migration scripts\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}, "afterCommit": {"oid": "f01c0235fffdabd91f1ab677f987dd4cbcc9319d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/f01c0235fffdabd91f1ab677f987dd4cbcc9319d", "committedDate": "2020-02-14T07:34:24Z", "message": "Update trl + add new ProfitAndLoss functions migration scripts\n\nhttps://github.com/metasfresh/metasfresh/issues/6148"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3603, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}