{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNzg2NjM3", "number": 6810, "title": "Materialentnahme with kg palettes creates extra 0.001Kg TU", "bodyText": "#6808", "createdAt": "2020-06-09T13:16:54Z", "url": "https://github.com/metasfresh/metasfresh/pull/6810", "merged": true, "mergeCommit": {"oid": "e1e44f82dd5168ab493c782dec4fbab44c810478"}, "closed": true, "closedAt": "2020-06-22T10:33:05Z", "author": {"login": "TheBestPessimist"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcplB7LAFqTQyNzE0MDc4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABctuWWPgH2gAyNDMxNzg2NjM3OjQxYjA0MDhlOGJmYzYyYjgyNmNlN2I1MDBhZDVkMzU3MDRjNzE0YzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3MTQwNzg2", "url": "https://github.com/metasfresh/metasfresh/pull/6810#pullrequestreview-427140786", "createdAt": "2020-06-09T13:25:34Z", "commit": {"oid": "1361bb4d50ed44a6378194a84a4208027188cf4e"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b047a16dbd0759be4809a9855c659da7493abfa", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/9b047a16dbd0759be4809a9855c659da7493abfa", "committedDate": "2020-06-10T04:22:11Z", "message": "Fix warnings\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "568e6a2deb4a2c1e81fe0cabb7c7c7d23d0b8251", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/568e6a2deb4a2c1e81fe0cabb7c7c7d23d0b8251", "committedDate": "2020-06-10T04:22:11Z", "message": "Update JUnit\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adc362c0482f454db9c2d07ad111b9284854aa42", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/adc362c0482f454db9c2d07ad111b9284854aa42", "committedDate": "2020-06-10T04:22:11Z", "message": "When calculating the splitQty fro an aggregated TU, take into account precision: if the qty is smaller in absolute value than the precision, return 0.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1361bb4d50ed44a6378194a84a4208027188cf4e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/1361bb4d50ed44a6378194a84a4208027188cf4e", "committedDate": "2020-06-09T12:55:38Z", "message": "When calculating the splitQty fro an aggregated TU, take into account precision: if the qty is smaller in absolute value than the precision, return 0.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}, "afterCommit": {"oid": "adc362c0482f454db9c2d07ad111b9284854aa42", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/adc362c0482f454db9c2d07ad111b9284854aa42", "committedDate": "2020-06-10T04:22:11Z", "message": "When calculating the splitQty fro an aggregated TU, take into account precision: if the qty is smaller in absolute value than the precision, return 0.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a0da8ced37741d3ca604da988d123c35823d087", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/7a0da8ced37741d3ca604da988d123c35823d087", "committedDate": "2020-06-10T09:07:26Z", "message": "One more fix after testing\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb7ecc3fa6d8b34955cafba94350b91fb7ed8d05", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/bb7ecc3fa6d8b34955cafba94350b91fb7ed8d05", "committedDate": "2020-06-10T12:18:37Z", "message": "Change calculation formula for the initial CuPerTuQty\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5527945cd6d936e1598e3bd738e670e4c0807409", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/5527945cd6d936e1598e3bd738e670e4c0807409", "committedDate": "2020-06-10T13:41:23Z", "message": "Undo scale calculation\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd79952b199271ce558798f7d3369b7a21b5d0d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/4bd79952b199271ce558798f7d3369b7a21b5d0d", "committedDate": "2020-06-10T13:41:44Z", "message": "First draft of a test. Need help with this one.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MzI0MzUw", "url": "https://github.com/metasfresh/metasfresh/pull/6810#pullrequestreview-428324350", "createdAt": "2020-06-10T18:31:29Z", "commit": {"oid": "4bd79952b199271ce558798f7d3369b7a21b5d0d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxODozMTozMFrOGiBeGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxODozMTozMFrOGiBeGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODMyODg1Nw==", "bodyText": "...brainfart of the day: then maybe better use HUTransformService do the split..just like the user would", "url": "https://github.com/metasfresh/metasfresh/pull/6810#discussion_r438328857", "createdAt": "2020-06-10T18:31:30Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/test/java/de/metas/handlingunits/attributes/impl/split/SplitWeightAttributePropagationTest.java", "diffHunk": "@@ -260,23 +258,81 @@ public void testSplitWeightTransfer_LU_On_Another_SameType_LU_1TU_7CU()\n \t\t\t\tnewHUWeightsExpectation(\"6.436\", \"5.436\", \"1\", \"0\"));\n \t}\n \n+\t@Test\n+\tpublic void testSplit7TuFromLu()\n+\t{\n+\t\tfinal I_M_HU palletToSplit = createIncomingLoadingUnit(huItemIFCO_10, materialItemProductTomato_10, BigDecimal.valueOf(200), BigDecimal.valueOf(545.217)); // 20 x Tomato TUs with a certain weight. + the weight of the LU+TU\n+\t\t// dev note: weight per TU is 25.01085 ~= 25.011\n+\n+\t\t// final Node luXml = HUXmlConverter.toXml( paletToSplit);\n+\t\t// System.out.println(\"aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa\");\n+\t\t// System.out.println(HUXmlConverter.toString(luXml));\n+\n+\t\t// Assert initial data is as expected\n+\t\tassertLoadingUnitStorageWeights(palletToSplit, huItemIFCO_10, 20,\n+\t\t\t\tnewHUWeightsExpectation(\"545.217\", \"500.217\", \"45\", \"0\"),\n+\t\t\t\tnewHUWeightsExpectation(\"520.217\", \"500.217\", \"20\", \"0\") // aggregate TU with the whole qty\n+\t\t);\n+\n+\t\t// TODO tbp: i don't understand what all these params are and what do they do?\n+\t\t// \t\ti need to move 1 TU. i don't care about the CUs, but the TU.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bd79952b199271ce558798f7d3369b7a21b5d0d"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53f2cc5c6f6cdae90246a4078dd579bd5af0c1b0", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/53f2cc5c6f6cdae90246a4078dd579bd5af0c1b0", "committedDate": "2020-06-11T05:32:10Z", "message": "Don't split a LU with qty just a bit greater than Packing Instruction capacity, as that breaks the expected number of LUs after a split.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8b8deb5823c90d991d24b1ddb00b57fa435bfaa", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a8b8deb5823c90d991d24b1ddb00b57fa435bfaa", "committedDate": "2020-06-11T06:26:44Z", "message": "Update the test once again\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fea323d4afb734035437c26b5298b9e0f63297b7", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/fea323d4afb734035437c26b5298b9e0f63297b7", "committedDate": "2020-06-11T06:39:33Z", "message": "Better variable names\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2262f6bbc65cc0b21f882f977393768ca7f04409", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/2262f6bbc65cc0b21f882f977393768ca7f04409", "committedDate": "2020-06-11T06:55:05Z", "message": "Redo scale calculation: don't store more than required decimals\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b86bda2640981505c7c361a73d0293dcc4cf517", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/0b86bda2640981505c7c361a73d0293dcc4cf517", "committedDate": "2020-06-11T07:01:57Z", "message": "Merge remote-tracking branch 'origin/master' into gh6808-0.001Kg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "171e00f69f082281bcf0cc91a495b0a9e1a8be60", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/171e00f69f082281bcf0cc91a495b0a9e1a8be60", "committedDate": "2020-06-11T09:28:20Z", "message": "Merge remote-tracking branch 'origin/gh6808-0.001Kg' into gh6808-0.001Kg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38074a233270afffa49a504e9a2a1bf028584ef9", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/38074a233270afffa49a504e9a2a1bf028584ef9", "committedDate": "2020-06-11T10:54:30Z", "message": "#6808 get one step further with the test by committing the trx\n\nalso bunch of small improvements here and there"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c0369db355a4751b0651fe641bde75c13659290", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/3c0369db355a4751b0651fe641bde75c13659290", "committedDate": "2020-06-11T12:04:02Z", "message": "#6808 extract test into dedicated class to create KG-HUs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4c4cb3af590e785923d95321e001b19f481a9c5", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/b4c4cb3af590e785923d95321e001b19f481a9c5", "committedDate": "2020-06-18T09:23:00Z", "message": "Merge branch 'master' into gh6808-0.001Kg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7b79f18a2113a41aec1fe7e3721d901dd11e89d", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/e7b79f18a2113a41aec1fe7e3721d901dd11e89d", "committedDate": "2020-06-18T13:00:47Z", "message": "Materialentnahme with kg palettes creates extra 0.001Kg TU #6808\n\ncreate unit test to reproduce the issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93524f43e20437043301494358f9445124cfa323", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/93524f43e20437043301494358f9445124cfa323", "committedDate": "2020-06-19T10:13:21Z", "message": "Use Floor rounding when splitting aggregate HUs with Kg\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9308d03b7c16ced2e2d86b8acf75ae48d7765941", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/9308d03b7c16ced2e2d86b8acf75ae48d7765941", "committedDate": "2020-06-19T11:02:41Z", "message": "Add multiple test cases for hu weight splitting\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f73e3492c5e2d6b0a78afe8c88f073ee51c7a4", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/e4f73e3492c5e2d6b0a78afe8c88f073ee51c7a4", "committedDate": "2020-06-19T11:06:24Z", "message": "Store the quantity of TUs to split, and use that to update the TU qty after split\n\nIf we split exactly N TUs (integer), there's no need for all the dance to figure out the new correct # of TUs for the qty, and splitting the extra qty.\nWe shall just update the new qty of TUs in the aggregate TU.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6a522d1c7d048b95033b61a72157642c85c0acd", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/d6a522d1c7d048b95033b61a72157642c85c0acd", "committedDate": "2020-06-19T11:21:36Z", "message": "Fix warnings, etc.\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d0ee3747342da947194d1fdf6974d45fb00419", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/28d0ee3747342da947194d1fdf6974d45fb00419", "committedDate": "2020-06-19T11:28:45Z", "message": "Fix failing test\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b85e932eb2ca79a1a747d7a7db454b2dea80b4", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/62b85e932eb2ca79a1a747d7a7db454b2dea80b4", "committedDate": "2020-06-19T11:37:02Z", "message": "Properly fix failing test\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae992ab9ca650c6e1ab3ae841dd0fdfd9c1029bf", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ae992ab9ca650c6e1ab3ae841dd0fdfd9c1029bf", "committedDate": "2020-06-22T04:21:21Z", "message": "Remove NPE testing test\n\nWe already know lombok is working properly\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1ecfa59aea318223ac8fdfcc70e6a21e087a86", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/0b1ecfa59aea318223ac8fdfcc70e6a21e087a86", "committedDate": "2020-06-22T05:20:30Z", "message": "Don't return too early\n\nhttps://github.com/metasfresh/metasfresh/issues/6808"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM0Nzk0MTkx", "url": "https://github.com/metasfresh/metasfresh/pull/6810#pullrequestreview-434794191", "createdAt": "2020-06-22T10:24:08Z", "commit": {"oid": "0b1ecfa59aea318223ac8fdfcc70e6a21e087a86"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDoyNDowOFrOGm6w1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yMlQxMDoyNDowOFrOGm6w1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MzQ2MTg0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\tif (qtyTUsToSplit != null && BigDecimal.ZERO.compareTo(qtyTUsToSplit) != 0)\n          \n          \n            \n            \t\tif (qtyTUsToSplit != null && qtyTUsToSplit.signum() != 0)", "url": "https://github.com/metasfresh/metasfresh/pull/6810#discussion_r443461847", "createdAt": "2020-06-22T10:24:08Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/allocation/spi/impl/AggregateHUTrxListener.java", "diffHunk": "@@ -148,45 +156,68 @@ private void updateItemQtyAndSplitIfNeeded(final IHUContext huContext, final Map\n \t\t\treturn; // nothing to do\n \t\t}\n \n-\t\tfinal IHUTransactionCandidate trx = itemId2Trx.get(item.getM_HU_Item_ID());\n-\t\tfinal BigDecimal storageQty = storage.getQty(trx.getProductId(), trx.getQuantity().getUOM());\n-\n-\t\t// get the new TU quantity, which as TUs go needs to be an integer\n-\t\tfinal BigDecimal newTuQty = storageQty.divide(cuQtyBeforeLoad,\n-\t\t\t\t0,\n-\t\t\t\tRoundingMode.FLOOR);\n-\n-\t\titem.setQty(newTuQty);\n-\t\tInterfaceWrapperHelper.save(item);\n-\n-\t\t// find out if we need to perform a split in order to preserve the former CU-per-TU quantity\n-\t\tfinal BigDecimal splitQty = computeSplitQty(storageQty, cuQtyBeforeLoad);\n-\n-\t\tif (splitQty.signum() != 0)\n+\t\t// If we split exactly N TUs (integer), there's no need for all the dance to figure out the new correct # of TUs for the qty, and splitting the extra qty.\n+\t\t// We shall just update the new qty of TUs in this aggregate TU.\n+\t\tfinal BigDecimal qtyTUsToSplit = huContext.getProperty(AggregateHUTrxListener.mkQtyTUsToSplitPropertyKey(item));\n+\t\tif (qtyTUsToSplit != null && BigDecimal.ZERO.compareTo(qtyTUsToSplit) != 0)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b1ecfa59aea318223ac8fdfcc70e6a21e087a86"}, "originalPosition": 139}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41b0408e8bfc62b826ce7b500ad5d35704c714c2", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/41b0408e8bfc62b826ce7b500ad5d35704c714c2", "committedDate": "2020-06-22T10:32:43Z", "message": "Update backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/allocation/spi/impl/AggregateHUTrxListener.java\r\n\r\n#6808"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3362, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}