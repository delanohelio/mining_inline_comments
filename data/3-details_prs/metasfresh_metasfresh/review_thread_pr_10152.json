{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4NzgxOTI1", "number": 10152, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNTozNjoyN1rOExwX3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNTozODoyN1rOExwZDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA4MjIzOnYy", "diffSide": "RIGHT", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNTozNjoyN1rOHoBZDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNjo1MTozNVrOHoClJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNzg4Ng==", "bodyText": "ArchiveId shall not be used for C_Doc_OutBound_Log_ID.\n(note that we have a dedicated AD_Archive table that is also referenced by C_Doc_Outbound_Log_Line)", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511727886", "createdAt": "2020-10-26T05:36:27Z", "author": {"login": "metas-ts"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableSet;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.process.IProcessDefaultParameter;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.process.IProcessPrecondition;\n+import de.metas.process.Param;\n+import de.metas.process.ProcessPreconditionsResolution;\n+import de.metas.ui.web.process.adprocess.ViewBasedProcessTemplate;\n+import de.metas.ui.web.process.descriptor.ProcessParamLookupValuesProvider;\n+import de.metas.ui.web.window.datatypes.DocumentIdsSelection;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.ui.web.window.descriptor.DocumentLayoutElementFieldDescriptor.LookupSource;\n+import de.metas.ui.web.window.model.lookup.LookupDataSourceContext;\n+import org.adempiere.archive.ArchiveId;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+\n+public class ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView\n+\t\textends ViewBasedProcessTemplate\n+\t\timplements IProcessPrecondition, IProcessDefaultParametersProvider\n+{\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\tprotected static final String PARAM_TargetExportStatus = I_EDI_Desadv.COLUMNNAME_EDI_ExportStatus;\n+\t@Param(parameterName = PARAM_TargetExportStatus)\n+\tprivate String p_TargetExportStatus;\n+\n+\t@Override\n+\tpublic ProcessPreconditionsResolution checkPreconditionsApplicable()\n+\t{\n+\t\tfinal ImmutableSet<ArchiveId> docOutboundLogIds = getSelectedDocOutboundLogIds();\n+\t\tif (docOutboundLogIds.isEmpty())\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectBecauseNoSelection();\n+\t\t}\n+\n+\t\t// technical detail: all records must have the same Export Status\n+\t\tEDIExportStatus sameExportStatus = null;\n+\n+\t\tfor (final ArchiveId logId : docOutboundLogIds)\n+\t\t{\n+\t\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\t\tif (!ChangeEDI_ExportStatusHelper.checkIsInvoiceAndEDI(docOutboundLog))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\t\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofNullableCode(docOutboundLog.getEDI_ExportStatus());\n+\t\t\tif (fromExportStatus == null)\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\n+\t\t\tif (ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus).isEmpty())\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Cannot change ExportStatus from the current one: \" + fromExportStatus);\n+\t\t\t}\n+\n+\t\t\tif (sameExportStatus == null)\n+\t\t\t{\n+\t\t\t\tsameExportStatus = fromExportStatus;\n+\t\t\t}\n+\n+\t\t\tif (!sameExportStatus.equals(fromExportStatus))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"All records must have the same EDI ExportStatus\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn ProcessPreconditionsResolution.accept();\n+\t}\n+\n+\t@ProcessParamLookupValuesProvider(parameterName = PARAM_TargetExportStatus, numericKey = false, lookupSource = LookupSource.list)\n+\tprivate LookupValuesList getTargetExportStatusLookupValues(final LookupDataSourceContext context)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeTargetExportStatusLookupValues(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\t@Nullable\n+\tpublic Object getParameterDefaultValue(final IProcessDefaultParameter parameter)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeParameterDefaultValue(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\tprotected String doIt() throws Exception\n+\t{\n+\t\tfinal EDIExportStatus targetExportStatus = EDIExportStatus.ofCode(p_TargetExportStatus);\n+\n+\t\tfor (final ArchiveId logId : getSelectedDocOutboundLogIds())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0MjE4OQ==", "bodyText": "ArchiveId shall not be used for C_Doc_OutBound_Log_ID.\n\nSo should i add the ID class DocOutboundLogId or do you have something else in mind?", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511742189", "createdAt": "2020-10-26T06:33:44Z", "author": {"login": "TheBestPessimist"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableSet;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.process.IProcessDefaultParameter;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.process.IProcessPrecondition;\n+import de.metas.process.Param;\n+import de.metas.process.ProcessPreconditionsResolution;\n+import de.metas.ui.web.process.adprocess.ViewBasedProcessTemplate;\n+import de.metas.ui.web.process.descriptor.ProcessParamLookupValuesProvider;\n+import de.metas.ui.web.window.datatypes.DocumentIdsSelection;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.ui.web.window.descriptor.DocumentLayoutElementFieldDescriptor.LookupSource;\n+import de.metas.ui.web.window.model.lookup.LookupDataSourceContext;\n+import org.adempiere.archive.ArchiveId;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+\n+public class ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView\n+\t\textends ViewBasedProcessTemplate\n+\t\timplements IProcessPrecondition, IProcessDefaultParametersProvider\n+{\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\tprotected static final String PARAM_TargetExportStatus = I_EDI_Desadv.COLUMNNAME_EDI_ExportStatus;\n+\t@Param(parameterName = PARAM_TargetExportStatus)\n+\tprivate String p_TargetExportStatus;\n+\n+\t@Override\n+\tpublic ProcessPreconditionsResolution checkPreconditionsApplicable()\n+\t{\n+\t\tfinal ImmutableSet<ArchiveId> docOutboundLogIds = getSelectedDocOutboundLogIds();\n+\t\tif (docOutboundLogIds.isEmpty())\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectBecauseNoSelection();\n+\t\t}\n+\n+\t\t// technical detail: all records must have the same Export Status\n+\t\tEDIExportStatus sameExportStatus = null;\n+\n+\t\tfor (final ArchiveId logId : docOutboundLogIds)\n+\t\t{\n+\t\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\t\tif (!ChangeEDI_ExportStatusHelper.checkIsInvoiceAndEDI(docOutboundLog))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\t\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofNullableCode(docOutboundLog.getEDI_ExportStatus());\n+\t\t\tif (fromExportStatus == null)\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\n+\t\t\tif (ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus).isEmpty())\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Cannot change ExportStatus from the current one: \" + fromExportStatus);\n+\t\t\t}\n+\n+\t\t\tif (sameExportStatus == null)\n+\t\t\t{\n+\t\t\t\tsameExportStatus = fromExportStatus;\n+\t\t\t}\n+\n+\t\t\tif (!sameExportStatus.equals(fromExportStatus))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"All records must have the same EDI ExportStatus\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn ProcessPreconditionsResolution.accept();\n+\t}\n+\n+\t@ProcessParamLookupValuesProvider(parameterName = PARAM_TargetExportStatus, numericKey = false, lookupSource = LookupSource.list)\n+\tprivate LookupValuesList getTargetExportStatusLookupValues(final LookupDataSourceContext context)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeTargetExportStatusLookupValues(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\t@Nullable\n+\tpublic Object getParameterDefaultValue(final IProcessDefaultParameter parameter)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeParameterDefaultValue(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\tprotected String doIt() throws Exception\n+\t{\n+\t\tfinal EDIExportStatus targetExportStatus = EDIExportStatus.ofCode(p_TargetExportStatus);\n+\n+\t\tfor (final ArchiveId logId : getSelectedDocOutboundLogIds())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNzg4Ng=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NTMzMg==", "bodyText": "pls add DocOutboundLogId", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511745332", "createdAt": "2020-10-26T06:44:53Z", "author": {"login": "metas-ts"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableSet;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.process.IProcessDefaultParameter;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.process.IProcessPrecondition;\n+import de.metas.process.Param;\n+import de.metas.process.ProcessPreconditionsResolution;\n+import de.metas.ui.web.process.adprocess.ViewBasedProcessTemplate;\n+import de.metas.ui.web.process.descriptor.ProcessParamLookupValuesProvider;\n+import de.metas.ui.web.window.datatypes.DocumentIdsSelection;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.ui.web.window.descriptor.DocumentLayoutElementFieldDescriptor.LookupSource;\n+import de.metas.ui.web.window.model.lookup.LookupDataSourceContext;\n+import org.adempiere.archive.ArchiveId;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+\n+public class ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView\n+\t\textends ViewBasedProcessTemplate\n+\t\timplements IProcessPrecondition, IProcessDefaultParametersProvider\n+{\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\tprotected static final String PARAM_TargetExportStatus = I_EDI_Desadv.COLUMNNAME_EDI_ExportStatus;\n+\t@Param(parameterName = PARAM_TargetExportStatus)\n+\tprivate String p_TargetExportStatus;\n+\n+\t@Override\n+\tpublic ProcessPreconditionsResolution checkPreconditionsApplicable()\n+\t{\n+\t\tfinal ImmutableSet<ArchiveId> docOutboundLogIds = getSelectedDocOutboundLogIds();\n+\t\tif (docOutboundLogIds.isEmpty())\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectBecauseNoSelection();\n+\t\t}\n+\n+\t\t// technical detail: all records must have the same Export Status\n+\t\tEDIExportStatus sameExportStatus = null;\n+\n+\t\tfor (final ArchiveId logId : docOutboundLogIds)\n+\t\t{\n+\t\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\t\tif (!ChangeEDI_ExportStatusHelper.checkIsInvoiceAndEDI(docOutboundLog))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\t\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofNullableCode(docOutboundLog.getEDI_ExportStatus());\n+\t\t\tif (fromExportStatus == null)\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\n+\t\t\tif (ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus).isEmpty())\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Cannot change ExportStatus from the current one: \" + fromExportStatus);\n+\t\t\t}\n+\n+\t\t\tif (sameExportStatus == null)\n+\t\t\t{\n+\t\t\t\tsameExportStatus = fromExportStatus;\n+\t\t\t}\n+\n+\t\t\tif (!sameExportStatus.equals(fromExportStatus))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"All records must have the same EDI ExportStatus\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn ProcessPreconditionsResolution.accept();\n+\t}\n+\n+\t@ProcessParamLookupValuesProvider(parameterName = PARAM_TargetExportStatus, numericKey = false, lookupSource = LookupSource.list)\n+\tprivate LookupValuesList getTargetExportStatusLookupValues(final LookupDataSourceContext context)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeTargetExportStatusLookupValues(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\t@Nullable\n+\tpublic Object getParameterDefaultValue(final IProcessDefaultParameter parameter)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeParameterDefaultValue(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\tprotected String doIt() throws Exception\n+\t{\n+\t\tfinal EDIExportStatus targetExportStatus = EDIExportStatus.ofCode(p_TargetExportStatus);\n+\n+\t\tfor (final ArchiveId logId : getSelectedDocOutboundLogIds())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNzg4Ng=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NzM2Nw==", "bodyText": "done", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511747367", "createdAt": "2020-10-26T06:51:35Z", "author": {"login": "TheBestPessimist"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableSet;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.process.IProcessDefaultParameter;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.process.IProcessPrecondition;\n+import de.metas.process.Param;\n+import de.metas.process.ProcessPreconditionsResolution;\n+import de.metas.ui.web.process.adprocess.ViewBasedProcessTemplate;\n+import de.metas.ui.web.process.descriptor.ProcessParamLookupValuesProvider;\n+import de.metas.ui.web.window.datatypes.DocumentIdsSelection;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.ui.web.window.descriptor.DocumentLayoutElementFieldDescriptor.LookupSource;\n+import de.metas.ui.web.window.model.lookup.LookupDataSourceContext;\n+import org.adempiere.archive.ArchiveId;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+\n+public class ChangeEDI_ExportStatus_C_Doc_Outbound_Log_GridView\n+\t\textends ViewBasedProcessTemplate\n+\t\timplements IProcessPrecondition, IProcessDefaultParametersProvider\n+{\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\tprotected static final String PARAM_TargetExportStatus = I_EDI_Desadv.COLUMNNAME_EDI_ExportStatus;\n+\t@Param(parameterName = PARAM_TargetExportStatus)\n+\tprivate String p_TargetExportStatus;\n+\n+\t@Override\n+\tpublic ProcessPreconditionsResolution checkPreconditionsApplicable()\n+\t{\n+\t\tfinal ImmutableSet<ArchiveId> docOutboundLogIds = getSelectedDocOutboundLogIds();\n+\t\tif (docOutboundLogIds.isEmpty())\n+\t\t{\n+\t\t\treturn ProcessPreconditionsResolution.rejectBecauseNoSelection();\n+\t\t}\n+\n+\t\t// technical detail: all records must have the same Export Status\n+\t\tEDIExportStatus sameExportStatus = null;\n+\n+\t\tfor (final ArchiveId logId : docOutboundLogIds)\n+\t\t{\n+\t\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\t\tif (!ChangeEDI_ExportStatusHelper.checkIsInvoiceAndEDI(docOutboundLog))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\t\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofNullableCode(docOutboundLog.getEDI_ExportStatus());\n+\t\t\tif (fromExportStatus == null)\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Selected record is not an EDI Invoice: \" + docOutboundLog);\n+\t\t\t}\n+\n+\t\t\tif (ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus).isEmpty())\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"Cannot change ExportStatus from the current one: \" + fromExportStatus);\n+\t\t\t}\n+\n+\t\t\tif (sameExportStatus == null)\n+\t\t\t{\n+\t\t\t\tsameExportStatus = fromExportStatus;\n+\t\t\t}\n+\n+\t\t\tif (!sameExportStatus.equals(fromExportStatus))\n+\t\t\t{\n+\t\t\t\treturn ProcessPreconditionsResolution.rejectWithInternalReason(\"All records must have the same EDI ExportStatus\");\n+\t\t\t}\n+\t\t}\n+\n+\t\treturn ProcessPreconditionsResolution.accept();\n+\t}\n+\n+\t@ProcessParamLookupValuesProvider(parameterName = PARAM_TargetExportStatus, numericKey = false, lookupSource = LookupSource.list)\n+\tprivate LookupValuesList getTargetExportStatusLookupValues(final LookupDataSourceContext context)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeTargetExportStatusLookupValues(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\t@Nullable\n+\tpublic Object getParameterDefaultValue(final IProcessDefaultParameter parameter)\n+\t{\n+\t\tfinal I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(getSelectedDocOutboundLogIds().iterator().next());\n+\n+\t\tfinal EDIExportStatus fromExportStatus = EDIExportStatus.ofCode(docOutboundLog.getEDI_ExportStatus());\n+\n+\t\treturn ChangeEDI_ExportStatusHelper.computeParameterDefaultValue(fromExportStatus);\n+\t}\n+\n+\t@Override\n+\tprotected String doIt() throws Exception\n+\t{\n+\t\tfinal EDIExportStatus targetExportStatus = EDIExportStatus.ofCode(p_TargetExportStatus);\n+\n+\t\tfor (final ArchiveId logId : getSelectedDocOutboundLogIds())", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyNzg4Ng=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIwNjA4NTI2OnYy", "diffSide": "RIGHT", "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatusHelper.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNTozODoyN1rOHoBavg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQwNjo1MToyMlrOHoCk3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyODMxOA==", "bodyText": "in theory you could check for C_Invoice.IsEdiEnabled..but that's an extra load..\nor you could check for edi-export-status to be not null..but you already do that in the process anyways..", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511728318", "createdAt": "2020-10-26T05:38:27Z", "author": {"login": "metas-ts"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatusHelper.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableList;\n+import de.metas.edi.api.EDIDesadvId;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.api.IDesadvDAO;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.edi.model.I_C_Invoice;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.invoice.InvoiceId;\n+import de.metas.invoice.service.IInvoiceDAO;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.ui.web.window.datatypes.LookupValue;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import lombok.experimental.UtilityClass;\n+import org.adempiere.ad.service.IADReferenceDAO;\n+import org.adempiere.archive.ArchiveId;\n+import org.adempiere.exceptions.AdempiereException;\n+import org.adempiere.util.lang.impl.TableRecordReference;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@UtilityClass\n+public class ChangeEDI_ExportStatusHelper\n+{\n+\tprivate final IDesadvDAO desadvDAO = Services.get(IDesadvDAO.class);\n+\tprivate final IADReferenceDAO adReferenceDAO = Services.get(IADReferenceDAO.class);\n+\tprivate final IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\t@NonNull\n+\tpublic List<EDIExportStatus> getAvailableTargetExportStatuses(@NonNull final EDIExportStatus fromStatus)\n+\t{\n+\t\tswitch (fromStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending);\n+\t\t\tcase Pending:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.DontSend);\n+\t\t\tcase Sent:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending, EDIExportStatus.DontSend);\n+\t\t\tdefault:\n+\t\t\t\treturn ImmutableList.of();\n+\t\t}\n+\t}\n+\n+\tpublic boolean computeIsProcessedByTargetExportStatus(@NonNull final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tswitch (targetExportStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn true;\n+\t\t\tcase Pending:\n+\t\t\t\treturn false;\n+\t\t\tdefault:\n+\t\t\t\tthrow new AdempiereException(\"Cannot change Export Status to: \" + targetExportStatus);\n+\t\t}\n+\t}\n+\n+\tpublic void EDI_DesadvDoIt(@NonNull final EDIDesadvId desadvId, @NonNull final EDIExportStatus targetExportStatus, final boolean isProcessed)\n+\t{\n+\t\tfinal I_EDI_Desadv edi = desadvDAO.retrieveById(desadvId);\n+\t\tedi.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tedi.setProcessed(isProcessed);\n+\t\tdesadvDAO.save(edi);\n+\t}\n+\n+\tpublic void C_DocOutbound_LogDoIt(final EDIExportStatus targetExportStatus, final ArchiveId logId)\n+\t{\n+\t\t// technical detail: the I_C_Doc_Outbound_Log is updated when we update the C_Invoice, via interceptor: de.metas.edi.model.validator.C_Invoice.updateDocOutBoundLog\n+\t\tfinal de.metas.edi.model.I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\tfinal TableRecordReference invoiceRecordReference = TableRecordReference.ofReferenced(docOutboundLog);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(invoiceRecordReference.getRecord_ID());\n+\n+\t\tChangeEDI_ExportStatusHelper.C_InvoiceDoIt(invoiceId, targetExportStatus);\n+\n+\t\tdocOutboundLog.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tediDocOutBoundLogService.save(docOutboundLog);\n+\t}\n+\n+\tpublic void C_InvoiceDoIt(final InvoiceId invoiceId, final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tfinal de.metas.edi.model.I_C_Invoice invoice = ediDocOutBoundLogService.retreiveById(invoiceId);\n+\t\tinvoice.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tinvoiceDAO.save(invoice);\n+\t}\n+\n+\t@NonNull\n+\tpublic LookupValuesList computeTargetExportStatusLookupValues(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\n+\t\treturn availableTargetStatuses.stream()\n+\t\t\t\t.map(s -> LookupValue.StringLookupValue.of(s.getCode(), adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, s.getCode())))\n+\t\t\t\t.collect(LookupValuesList.collect());\n+\t}\n+\n+\t@Nullable\n+\tpublic Object computeParameterDefaultValue(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\t\tif (!availableTargetStatuses.isEmpty())\n+\t\t{\n+\t\t\tfinal String code = availableTargetStatuses.get(0).getCode();\n+\t\t\treturn LookupValue.StringLookupValue.of(code, adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, code));\n+\t\t}\n+\t\treturn IProcessDefaultParametersProvider.DEFAULT_VALUE_NOTAVAILABLE;\n+\t}\n+\n+\t/**\n+\t * TODO tbp: how to check if this docOutboundLog is for edi or not?\n+\t * docOutboundLog.isEdiEnabled() is a virtual column!\n+\t * in swing this is checked by \"\"\"(select bp.IsEdiInvoicRecipient from C_BPartner bp where bp.C_BPartner_ID=C_Doc_Outbound_Log.C_BPartner_ID)\"\"\"\n+\t * do i need to check for if the AD_Table is C_Invoice as well?\n+\t * help maybe?\n+\t */\n+\tpublic boolean checkIsInvoiceAndEDI(final I_C_Doc_Outbound_Log docOutboundLog)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0Mzk4NQ==", "bodyText": "Checking for edi-export-status to be not null is not enough, because the C_Doc_Outbound_Log might also reference Sales Orders or Delivery Notes, and we don't want to change their statuses afaiu.", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511743985", "createdAt": "2020-10-26T06:40:04Z", "author": {"login": "TheBestPessimist"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatusHelper.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableList;\n+import de.metas.edi.api.EDIDesadvId;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.api.IDesadvDAO;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.edi.model.I_C_Invoice;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.invoice.InvoiceId;\n+import de.metas.invoice.service.IInvoiceDAO;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.ui.web.window.datatypes.LookupValue;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import lombok.experimental.UtilityClass;\n+import org.adempiere.ad.service.IADReferenceDAO;\n+import org.adempiere.archive.ArchiveId;\n+import org.adempiere.exceptions.AdempiereException;\n+import org.adempiere.util.lang.impl.TableRecordReference;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@UtilityClass\n+public class ChangeEDI_ExportStatusHelper\n+{\n+\tprivate final IDesadvDAO desadvDAO = Services.get(IDesadvDAO.class);\n+\tprivate final IADReferenceDAO adReferenceDAO = Services.get(IADReferenceDAO.class);\n+\tprivate final IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\t@NonNull\n+\tpublic List<EDIExportStatus> getAvailableTargetExportStatuses(@NonNull final EDIExportStatus fromStatus)\n+\t{\n+\t\tswitch (fromStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending);\n+\t\t\tcase Pending:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.DontSend);\n+\t\t\tcase Sent:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending, EDIExportStatus.DontSend);\n+\t\t\tdefault:\n+\t\t\t\treturn ImmutableList.of();\n+\t\t}\n+\t}\n+\n+\tpublic boolean computeIsProcessedByTargetExportStatus(@NonNull final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tswitch (targetExportStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn true;\n+\t\t\tcase Pending:\n+\t\t\t\treturn false;\n+\t\t\tdefault:\n+\t\t\t\tthrow new AdempiereException(\"Cannot change Export Status to: \" + targetExportStatus);\n+\t\t}\n+\t}\n+\n+\tpublic void EDI_DesadvDoIt(@NonNull final EDIDesadvId desadvId, @NonNull final EDIExportStatus targetExportStatus, final boolean isProcessed)\n+\t{\n+\t\tfinal I_EDI_Desadv edi = desadvDAO.retrieveById(desadvId);\n+\t\tedi.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tedi.setProcessed(isProcessed);\n+\t\tdesadvDAO.save(edi);\n+\t}\n+\n+\tpublic void C_DocOutbound_LogDoIt(final EDIExportStatus targetExportStatus, final ArchiveId logId)\n+\t{\n+\t\t// technical detail: the I_C_Doc_Outbound_Log is updated when we update the C_Invoice, via interceptor: de.metas.edi.model.validator.C_Invoice.updateDocOutBoundLog\n+\t\tfinal de.metas.edi.model.I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\tfinal TableRecordReference invoiceRecordReference = TableRecordReference.ofReferenced(docOutboundLog);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(invoiceRecordReference.getRecord_ID());\n+\n+\t\tChangeEDI_ExportStatusHelper.C_InvoiceDoIt(invoiceId, targetExportStatus);\n+\n+\t\tdocOutboundLog.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tediDocOutBoundLogService.save(docOutboundLog);\n+\t}\n+\n+\tpublic void C_InvoiceDoIt(final InvoiceId invoiceId, final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tfinal de.metas.edi.model.I_C_Invoice invoice = ediDocOutBoundLogService.retreiveById(invoiceId);\n+\t\tinvoice.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tinvoiceDAO.save(invoice);\n+\t}\n+\n+\t@NonNull\n+\tpublic LookupValuesList computeTargetExportStatusLookupValues(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\n+\t\treturn availableTargetStatuses.stream()\n+\t\t\t\t.map(s -> LookupValue.StringLookupValue.of(s.getCode(), adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, s.getCode())))\n+\t\t\t\t.collect(LookupValuesList.collect());\n+\t}\n+\n+\t@Nullable\n+\tpublic Object computeParameterDefaultValue(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\t\tif (!availableTargetStatuses.isEmpty())\n+\t\t{\n+\t\t\tfinal String code = availableTargetStatuses.get(0).getCode();\n+\t\t\treturn LookupValue.StringLookupValue.of(code, adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, code));\n+\t\t}\n+\t\treturn IProcessDefaultParametersProvider.DEFAULT_VALUE_NOTAVAILABLE;\n+\t}\n+\n+\t/**\n+\t * TODO tbp: how to check if this docOutboundLog is for edi or not?\n+\t * docOutboundLog.isEdiEnabled() is a virtual column!\n+\t * in swing this is checked by \"\"\"(select bp.IsEdiInvoicRecipient from C_BPartner bp where bp.C_BPartner_ID=C_Doc_Outbound_Log.C_BPartner_ID)\"\"\"\n+\t * do i need to check for if the AD_Table is C_Invoice as well?\n+\t * help maybe?\n+\t */\n+\tpublic boolean checkIsInvoiceAndEDI(final I_C_Doc_Outbound_Log docOutboundLog)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyODMxOA=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NTk3NA==", "bodyText": "or you could check for edi-export-status to be not null\n\n...in addition to the check for C_Invoice which you do already", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511745974", "createdAt": "2020-10-26T06:46:58Z", "author": {"login": "metas-ts"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatusHelper.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableList;\n+import de.metas.edi.api.EDIDesadvId;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.api.IDesadvDAO;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.edi.model.I_C_Invoice;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.invoice.InvoiceId;\n+import de.metas.invoice.service.IInvoiceDAO;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.ui.web.window.datatypes.LookupValue;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import lombok.experimental.UtilityClass;\n+import org.adempiere.ad.service.IADReferenceDAO;\n+import org.adempiere.archive.ArchiveId;\n+import org.adempiere.exceptions.AdempiereException;\n+import org.adempiere.util.lang.impl.TableRecordReference;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@UtilityClass\n+public class ChangeEDI_ExportStatusHelper\n+{\n+\tprivate final IDesadvDAO desadvDAO = Services.get(IDesadvDAO.class);\n+\tprivate final IADReferenceDAO adReferenceDAO = Services.get(IADReferenceDAO.class);\n+\tprivate final IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\t@NonNull\n+\tpublic List<EDIExportStatus> getAvailableTargetExportStatuses(@NonNull final EDIExportStatus fromStatus)\n+\t{\n+\t\tswitch (fromStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending);\n+\t\t\tcase Pending:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.DontSend);\n+\t\t\tcase Sent:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending, EDIExportStatus.DontSend);\n+\t\t\tdefault:\n+\t\t\t\treturn ImmutableList.of();\n+\t\t}\n+\t}\n+\n+\tpublic boolean computeIsProcessedByTargetExportStatus(@NonNull final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tswitch (targetExportStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn true;\n+\t\t\tcase Pending:\n+\t\t\t\treturn false;\n+\t\t\tdefault:\n+\t\t\t\tthrow new AdempiereException(\"Cannot change Export Status to: \" + targetExportStatus);\n+\t\t}\n+\t}\n+\n+\tpublic void EDI_DesadvDoIt(@NonNull final EDIDesadvId desadvId, @NonNull final EDIExportStatus targetExportStatus, final boolean isProcessed)\n+\t{\n+\t\tfinal I_EDI_Desadv edi = desadvDAO.retrieveById(desadvId);\n+\t\tedi.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tedi.setProcessed(isProcessed);\n+\t\tdesadvDAO.save(edi);\n+\t}\n+\n+\tpublic void C_DocOutbound_LogDoIt(final EDIExportStatus targetExportStatus, final ArchiveId logId)\n+\t{\n+\t\t// technical detail: the I_C_Doc_Outbound_Log is updated when we update the C_Invoice, via interceptor: de.metas.edi.model.validator.C_Invoice.updateDocOutBoundLog\n+\t\tfinal de.metas.edi.model.I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\tfinal TableRecordReference invoiceRecordReference = TableRecordReference.ofReferenced(docOutboundLog);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(invoiceRecordReference.getRecord_ID());\n+\n+\t\tChangeEDI_ExportStatusHelper.C_InvoiceDoIt(invoiceId, targetExportStatus);\n+\n+\t\tdocOutboundLog.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tediDocOutBoundLogService.save(docOutboundLog);\n+\t}\n+\n+\tpublic void C_InvoiceDoIt(final InvoiceId invoiceId, final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tfinal de.metas.edi.model.I_C_Invoice invoice = ediDocOutBoundLogService.retreiveById(invoiceId);\n+\t\tinvoice.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tinvoiceDAO.save(invoice);\n+\t}\n+\n+\t@NonNull\n+\tpublic LookupValuesList computeTargetExportStatusLookupValues(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\n+\t\treturn availableTargetStatuses.stream()\n+\t\t\t\t.map(s -> LookupValue.StringLookupValue.of(s.getCode(), adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, s.getCode())))\n+\t\t\t\t.collect(LookupValuesList.collect());\n+\t}\n+\n+\t@Nullable\n+\tpublic Object computeParameterDefaultValue(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\t\tif (!availableTargetStatuses.isEmpty())\n+\t\t{\n+\t\t\tfinal String code = availableTargetStatuses.get(0).getCode();\n+\t\t\treturn LookupValue.StringLookupValue.of(code, adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, code));\n+\t\t}\n+\t\treturn IProcessDefaultParametersProvider.DEFAULT_VALUE_NOTAVAILABLE;\n+\t}\n+\n+\t/**\n+\t * TODO tbp: how to check if this docOutboundLog is for edi or not?\n+\t * docOutboundLog.isEdiEnabled() is a virtual column!\n+\t * in swing this is checked by \"\"\"(select bp.IsEdiInvoicRecipient from C_BPartner bp where bp.C_BPartner_ID=C_Doc_Outbound_Log.C_BPartner_ID)\"\"\"\n+\t * do i need to check for if the AD_Table is C_Invoice as well?\n+\t * help maybe?\n+\t */\n+\tpublic boolean checkIsInvoiceAndEDI(final I_C_Doc_Outbound_Log docOutboundLog)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyODMxOA=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 146}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTc0NzI5Mg==", "bodyText": "done", "url": "https://github.com/metasfresh/metasfresh/pull/10152#discussion_r511747292", "createdAt": "2020-10-26T06:51:22Z", "author": {"login": "TheBestPessimist"}, "path": "backend/metasfresh-webui-api/src/main/java/de/metas/ui/web/edi_desadv/ChangeEDI_ExportStatusHelper.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * #%L\n+ * metasfresh-webui-api\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.ui.web.edi_desadv;\n+\n+import com.google.common.collect.ImmutableList;\n+import de.metas.edi.api.EDIDesadvId;\n+import de.metas.edi.api.EDIDocOutBoundLogService;\n+import de.metas.edi.api.EDIExportStatus;\n+import de.metas.edi.api.IDesadvDAO;\n+import de.metas.edi.model.I_C_Doc_Outbound_Log;\n+import de.metas.edi.model.I_C_Invoice;\n+import de.metas.esb.edi.model.I_EDI_Desadv;\n+import de.metas.invoice.InvoiceId;\n+import de.metas.invoice.service.IInvoiceDAO;\n+import de.metas.process.IProcessDefaultParametersProvider;\n+import de.metas.ui.web.window.datatypes.LookupValue;\n+import de.metas.ui.web.window.datatypes.LookupValuesList;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import lombok.experimental.UtilityClass;\n+import org.adempiere.ad.service.IADReferenceDAO;\n+import org.adempiere.archive.ArchiveId;\n+import org.adempiere.exceptions.AdempiereException;\n+import org.adempiere.util.lang.impl.TableRecordReference;\n+import org.compiere.SpringContextHolder;\n+\n+import javax.annotation.Nullable;\n+import java.util.List;\n+\n+@UtilityClass\n+public class ChangeEDI_ExportStatusHelper\n+{\n+\tprivate final IDesadvDAO desadvDAO = Services.get(IDesadvDAO.class);\n+\tprivate final IADReferenceDAO adReferenceDAO = Services.get(IADReferenceDAO.class);\n+\tprivate final IInvoiceDAO invoiceDAO = Services.get(IInvoiceDAO.class);\n+\tprivate final EDIDocOutBoundLogService ediDocOutBoundLogService = SpringContextHolder.instance.getBean(EDIDocOutBoundLogService.class);\n+\n+\t@NonNull\n+\tpublic List<EDIExportStatus> getAvailableTargetExportStatuses(@NonNull final EDIExportStatus fromStatus)\n+\t{\n+\t\tswitch (fromStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending);\n+\t\t\tcase Pending:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.DontSend);\n+\t\t\tcase Sent:\n+\t\t\t\treturn ImmutableList.of(EDIExportStatus.Pending, EDIExportStatus.DontSend);\n+\t\t\tdefault:\n+\t\t\t\treturn ImmutableList.of();\n+\t\t}\n+\t}\n+\n+\tpublic boolean computeIsProcessedByTargetExportStatus(@NonNull final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tswitch (targetExportStatus)\n+\t\t{\n+\t\t\tcase DontSend:\n+\t\t\t\treturn true;\n+\t\t\tcase Pending:\n+\t\t\t\treturn false;\n+\t\t\tdefault:\n+\t\t\t\tthrow new AdempiereException(\"Cannot change Export Status to: \" + targetExportStatus);\n+\t\t}\n+\t}\n+\n+\tpublic void EDI_DesadvDoIt(@NonNull final EDIDesadvId desadvId, @NonNull final EDIExportStatus targetExportStatus, final boolean isProcessed)\n+\t{\n+\t\tfinal I_EDI_Desadv edi = desadvDAO.retrieveById(desadvId);\n+\t\tedi.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tedi.setProcessed(isProcessed);\n+\t\tdesadvDAO.save(edi);\n+\t}\n+\n+\tpublic void C_DocOutbound_LogDoIt(final EDIExportStatus targetExportStatus, final ArchiveId logId)\n+\t{\n+\t\t// technical detail: the I_C_Doc_Outbound_Log is updated when we update the C_Invoice, via interceptor: de.metas.edi.model.validator.C_Invoice.updateDocOutBoundLog\n+\t\tfinal de.metas.edi.model.I_C_Doc_Outbound_Log docOutboundLog = ediDocOutBoundLogService.retreiveById(logId);\n+\n+\t\tfinal TableRecordReference invoiceRecordReference = TableRecordReference.ofReferenced(docOutboundLog);\n+\n+\t\tfinal InvoiceId invoiceId = InvoiceId.ofRepoId(invoiceRecordReference.getRecord_ID());\n+\n+\t\tChangeEDI_ExportStatusHelper.C_InvoiceDoIt(invoiceId, targetExportStatus);\n+\n+\t\tdocOutboundLog.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tediDocOutBoundLogService.save(docOutboundLog);\n+\t}\n+\n+\tpublic void C_InvoiceDoIt(final InvoiceId invoiceId, final EDIExportStatus targetExportStatus)\n+\t{\n+\t\tfinal de.metas.edi.model.I_C_Invoice invoice = ediDocOutBoundLogService.retreiveById(invoiceId);\n+\t\tinvoice.setEDI_ExportStatus(targetExportStatus.getCode());\n+\t\tinvoiceDAO.save(invoice);\n+\t}\n+\n+\t@NonNull\n+\tpublic LookupValuesList computeTargetExportStatusLookupValues(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\n+\t\treturn availableTargetStatuses.stream()\n+\t\t\t\t.map(s -> LookupValue.StringLookupValue.of(s.getCode(), adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, s.getCode())))\n+\t\t\t\t.collect(LookupValuesList.collect());\n+\t}\n+\n+\t@Nullable\n+\tpublic Object computeParameterDefaultValue(final EDIExportStatus fromExportStatus)\n+\t{\n+\t\tfinal List<EDIExportStatus> availableTargetStatuses = ChangeEDI_ExportStatusHelper.getAvailableTargetExportStatuses(fromExportStatus);\n+\t\tif (!availableTargetStatuses.isEmpty())\n+\t\t{\n+\t\t\tfinal String code = availableTargetStatuses.get(0).getCode();\n+\t\t\treturn LookupValue.StringLookupValue.of(code, adReferenceDAO.retrieveListNameTranslatableString(EDIExportStatus.AD_Reference_ID, code));\n+\t\t}\n+\t\treturn IProcessDefaultParametersProvider.DEFAULT_VALUE_NOTAVAILABLE;\n+\t}\n+\n+\t/**\n+\t * TODO tbp: how to check if this docOutboundLog is for edi or not?\n+\t * docOutboundLog.isEdiEnabled() is a virtual column!\n+\t * in swing this is checked by \"\"\"(select bp.IsEdiInvoicRecipient from C_BPartner bp where bp.C_BPartner_ID=C_Doc_Outbound_Log.C_BPartner_ID)\"\"\"\n+\t * do i need to check for if the AD_Table is C_Invoice as well?\n+\t * help maybe?\n+\t */\n+\tpublic boolean checkIsInvoiceAndEDI(final I_C_Doc_Outbound_Log docOutboundLog)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTcyODMxOA=="}, "originalCommit": {"oid": "0f090456a8e833e085110404633c757f5a7e132c"}, "originalPosition": 146}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1233, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}