{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0NzM0MDA2", "number": 10272, "title": "Bank Statement Import improvements", "bodyText": "#10270\nSigned-off-by: TheBestPessimist cristian@tbp.land", "createdAt": "2020-11-20T14:15:41Z", "url": "https://github.com/metasfresh/metasfresh/pull/10272", "merged": true, "mergeCommit": {"oid": "d1cb6c338b1748e2371c0c66fe6f8df357cd6095"}, "closed": true, "closedAt": "2020-11-23T12:29:10Z", "author": {"login": "TheBestPessimist"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeW-vKAH2gAyNTI0NzM0MDA2Ojk5YTBmYjFhOTVmNWU1MTgxNzIyNWNkMjA3ODdmMTg3NGI3YjM0NDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfTuZtAFqTUzNjM5OTA2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "99a0fb1a95f5e51817225cd20787f1874b7b3448", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/99a0fb1a95f5e51817225cd20787f1874b7b3448", "committedDate": "2020-11-20T13:01:24Z", "message": "Add multiple columns to I_BankStatement\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6774a41125a40a6755bbfedc66b42019eff0a9b3", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/6774a41125a40a6755bbfedc66b42019eff0a9b3", "committedDate": "2020-11-20T13:50:11Z", "message": "Import Format: `SkipFirstNRows` and `FileCharset`\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3c12e3e0631e2237161e190f2888753c1ddc88", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/0b3c12e3e0631e2237161e190f2888753c1ddc88", "committedDate": "2020-11-20T13:52:11Z", "message": "Handle multiple formats for receiving TrxAmt in the csv file\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\n\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "049c41cea485dbc8cec3dc13caa24dadac2766a0", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/049c41cea485dbc8cec3dc13caa24dadac2766a0", "committedDate": "2020-11-20T14:03:12Z", "message": "Add autodetection for I_BankStatement.AmtFormat\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\n\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/050cf8d40137394763ae1258ef526025948a5d83", "committedDate": "2020-11-20T14:10:35Z", "message": "Skip nulls when updating Description\n\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDc3MDQ5", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535477049", "createdAt": "2020-11-20T14:31:58Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMTo1OVrOH3SIHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMTo1OVrOH3SIHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczMDcxNg==", "bodyText": "consider java.nio.charset.Charset (or some other immutable alternative) instead of String", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527730716", "createdAt": "2020-11-20T14:31:59Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/impexp/format/ImpFormat.java", "diffHunk": "@@ -42,7 +47,9 @@ private ImpFormat(\n \t\t\tfinal boolean multiLine,\n \t\t\tfinal boolean manualImport,\n \t\t\t@NonNull final ImportTableDescriptor importTableDescriptor,\n-\t\t\t@NonNull @Singular final List<ImpFormatColumn> columns)\n+\t\t\t@NonNull @Singular final List<ImpFormatColumn> columns,\n+\t\t\t@NonNull final String charset,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDc3ODgw", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535477880", "createdAt": "2020-11-20T14:32:55Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMjo1NVrOH3SKcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMjo1NVrOH3SKcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczMTMxNA==", "bodyText": "pls validate/normalize this parameter\ne.g.\nskipFirstNRows = skipFirstNRows > 0 ? skipFirstNRows : 0;", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527731314", "createdAt": "2020-11-20T14:32:55Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/impexp/format/ImpFormat.java", "diffHunk": "@@ -54,6 +61,8 @@ private ImpFormat(\n \t\tthis.manualImport = manualImport;\n \t\tthis.importTableDescriptor = importTableDescriptor;\n \t\tthis.columns = ImmutableList.copyOf(columns);\n+\t\tthis.charset = charset;\n+\t\tthis.skipFirstNRows = skipFirstNRows;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDc4NzM4", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535478738", "createdAt": "2020-11-20T14:33:53Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMzo1NFrOH3SMvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozMzo1NFrOH3SMvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczMTkwMw==", "bodyText": "same as above.\n\nconsider using Charset\nnormalize/validate skipFirstNRows", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527731903", "createdAt": "2020-11-20T14:33:54Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.adempiere.adempiere/base/src/main/java/de/metas/impexp/parser/ImpDataParser.java", "diffHunk": "@@ -39,25 +37,31 @@\n @ToString\n public final class ImpDataParser\n {\n-\tprivate static final Charset CHARSET = StandardCharsets.UTF_8;\n-\n \tprivate final boolean multiline;\n \tprivate final ImpDataLineParser lineParser;\n+\tprivate final String charset;\n+\tprivate final int skipFirstNRows;\n \n \t@Builder\n \tprivate ImpDataParser(\n \t\t\tfinal boolean multiline,\n-\t\t\t@NonNull final ImpDataLineParser lineParser)\n+\t\t\t@NonNull final ImpDataLineParser lineParser,\n+\t\t\t@NonNull final String charset,\n+\t\t\tfinal int skipFirstNRows\n+\t)\n \t{\n \t\tthis.multiline = multiline;\n \t\tthis.lineParser = lineParser;\n+\t\tthis.charset = charset;\n+\t\tthis.skipFirstNRows = skipFirstNRows;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDgxMjM3", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535481237", "createdAt": "2020-11-20T14:36:40Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozNjo0MFrOH3SUBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozNjo0MFrOH3SUBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczMzc2Nw==", "bodyText": "avoid hardcoded \"S\".\nPls use X_I_BankStatement.AMOUNTPLUSINDICATOR_Debit or X_I_BankStatement.AMOUNTPLUSINDICATOR_Credit", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527733767", "createdAt": "2020-11-20T14:36:40Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.banking/de.metas.banking.base/src/main/java/de/metas/banking/impexp/BankStatementImportProcess.java", "diffHunk": "@@ -175,62 +180,147 @@ private void createBankStatementLine(final I_I_BankStatement importRecord)\n \n \t\tfinal CurrencyId currencyId = CurrencyId.ofRepoId(importRecord.getC_Currency_ID());\n \n-\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(BankStatementLineCreateRequest.builder()\n-\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n-\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n-\t\t\t\t.lineNo(importRecord.getLine())\n-\t\t\t\t//\n-\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n-\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n-\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n-\t\t\t\t//\n-\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n-\t\t\t\t.lineDescription(importRecord.getLineDescription())\n-\t\t\t\t.memo(importRecord.getMemo())\n-\t\t\t\t//\n-\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n-\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n-\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n-\t\t\t\t//\n-\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n-\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n-\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n-\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n-\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n-\t\t\t\t//\n-\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.trxId(importRecord.getEftTrxID())\n-\t\t\t\t\t\t.trxType(importRecord.getEftTrxType())\n-\t\t\t\t\t\t.checkNo(importRecord.getEftCheckNo())\n-\t\t\t\t\t\t.reference(importRecord.getEftReference())\n-\t\t\t\t\t\t.memo(importRecord.getEftMemo())\n-\t\t\t\t\t\t.payee(importRecord.getEftPayee())\n-\t\t\t\t\t\t.payeeAccount(importRecord.getEftPayeeAccount())\n-\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n-\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n-\t\t\t\t\t\t.currency(importRecord.getEftCurrency())\n-\t\t\t\t\t\t.amt(importRecord.getEftAmt())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t//\n-\t\t\t\t.build());\n+\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(\n+\t\t\t\tBankStatementLineCreateRequest.builder()\n+\t\t\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n+\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n+\t\t\t\t\t\t.lineNo(importRecord.getLine())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n+\t\t\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n+\t\t\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n+\t\t\t\t\t\t.lineDescription(importRecord.getLineDescription())\n+\t\t\t\t\t\t.memo(importRecord.getMemo())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n+\t\t\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n+\t\t\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n+\t\t\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n+\t\t\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t .trxId(importRecord.getEftTrxID())\n+\t\t\t\t\t\t\t\t\t .trxType(importRecord.getEftTrxType())\n+\t\t\t\t\t\t\t\t\t .checkNo(importRecord.getEftCheckNo())\n+\t\t\t\t\t\t\t\t\t .reference(importRecord.getEftReference())\n+\t\t\t\t\t\t\t\t\t .memo(importRecord.getEftMemo())\n+\t\t\t\t\t\t\t\t\t .payee(importRecord.getEftPayee())\n+\t\t\t\t\t\t\t\t\t .payeeAccount(importRecord.getEftPayeeAccount())\n+\t\t\t\t\t\t\t\t\t .statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n+\t\t\t\t\t\t\t\t\t .valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n+\t\t\t\t\t\t\t\t\t .currency(importRecord.getEftCurrency())\n+\t\t\t\t\t\t\t\t\t .amt(importRecord.getEftAmt())\n+\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.build());\n \n \t\timportRecord.setC_BankStatementLine_ID(bankStatementLineId.getRepoId());\n \t}\n \n \tprivate BankStatementId createBankStatement(@NonNull final I_I_BankStatement importBankStatement)\n \t{\n \t\treturn bankStatementDAO.createBankStatement(BankStatementCreateRequest.builder()\n-\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n-\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n-\t\t\t\t// TODO add documentNo to import\n-\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n-\t\t\t\t.name(importBankStatement.getName())\n-\t\t\t\t.description(importBankStatement.getDescription())\n-\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n-\t\t\t\t\t\t.statementReference(importBankStatement.getEftStatementReference())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t.build());\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// TODO add documentNo to import\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.name(importBankStatement.getName())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.description(importBankStatement.getDescription())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementReference(importBankStatement.getEftStatementReference())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.build());\n+\t}\n+\n+\t@VisibleForTesting\n+\tstatic void computeUpdateLineAmts(@NonNull final I_I_BankStatement importRecord)\n+\t{\n+\t\tfinal String amtFormat = getAmtFormat(importRecord);\n+\n+\t\tif (X_I_BankStatement.AMTFORMAT_AmountPlusIndicator.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal trxAmt;\n+\t\t\tfinal boolean isDebit = \"S\".equals(importRecord.getDebitOrCreditIndicator());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 185}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDgyNzYz", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535482763", "createdAt": "2020-11-20T14:38:23Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODoyM1rOH3SYZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODoyM1rOH3SYZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczNDg4Nw==", "bodyText": "IMHO here the stmtAmt shall be trxAmt + chargeAmt + interestAmt", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527734887", "createdAt": "2020-11-20T14:38:23Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.banking/de.metas.banking.base/src/main/java/de/metas/banking/impexp/BankStatementImportProcess.java", "diffHunk": "@@ -175,62 +180,147 @@ private void createBankStatementLine(final I_I_BankStatement importRecord)\n \n \t\tfinal CurrencyId currencyId = CurrencyId.ofRepoId(importRecord.getC_Currency_ID());\n \n-\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(BankStatementLineCreateRequest.builder()\n-\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n-\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n-\t\t\t\t.lineNo(importRecord.getLine())\n-\t\t\t\t//\n-\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n-\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n-\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n-\t\t\t\t//\n-\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n-\t\t\t\t.lineDescription(importRecord.getLineDescription())\n-\t\t\t\t.memo(importRecord.getMemo())\n-\t\t\t\t//\n-\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n-\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n-\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n-\t\t\t\t//\n-\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n-\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n-\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n-\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n-\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n-\t\t\t\t//\n-\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.trxId(importRecord.getEftTrxID())\n-\t\t\t\t\t\t.trxType(importRecord.getEftTrxType())\n-\t\t\t\t\t\t.checkNo(importRecord.getEftCheckNo())\n-\t\t\t\t\t\t.reference(importRecord.getEftReference())\n-\t\t\t\t\t\t.memo(importRecord.getEftMemo())\n-\t\t\t\t\t\t.payee(importRecord.getEftPayee())\n-\t\t\t\t\t\t.payeeAccount(importRecord.getEftPayeeAccount())\n-\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n-\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n-\t\t\t\t\t\t.currency(importRecord.getEftCurrency())\n-\t\t\t\t\t\t.amt(importRecord.getEftAmt())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t//\n-\t\t\t\t.build());\n+\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(\n+\t\t\t\tBankStatementLineCreateRequest.builder()\n+\t\t\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n+\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n+\t\t\t\t\t\t.lineNo(importRecord.getLine())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n+\t\t\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n+\t\t\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n+\t\t\t\t\t\t.lineDescription(importRecord.getLineDescription())\n+\t\t\t\t\t\t.memo(importRecord.getMemo())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n+\t\t\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n+\t\t\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n+\t\t\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n+\t\t\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t .trxId(importRecord.getEftTrxID())\n+\t\t\t\t\t\t\t\t\t .trxType(importRecord.getEftTrxType())\n+\t\t\t\t\t\t\t\t\t .checkNo(importRecord.getEftCheckNo())\n+\t\t\t\t\t\t\t\t\t .reference(importRecord.getEftReference())\n+\t\t\t\t\t\t\t\t\t .memo(importRecord.getEftMemo())\n+\t\t\t\t\t\t\t\t\t .payee(importRecord.getEftPayee())\n+\t\t\t\t\t\t\t\t\t .payeeAccount(importRecord.getEftPayeeAccount())\n+\t\t\t\t\t\t\t\t\t .statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n+\t\t\t\t\t\t\t\t\t .valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n+\t\t\t\t\t\t\t\t\t .currency(importRecord.getEftCurrency())\n+\t\t\t\t\t\t\t\t\t .amt(importRecord.getEftAmt())\n+\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.build());\n \n \t\timportRecord.setC_BankStatementLine_ID(bankStatementLineId.getRepoId());\n \t}\n \n \tprivate BankStatementId createBankStatement(@NonNull final I_I_BankStatement importBankStatement)\n \t{\n \t\treturn bankStatementDAO.createBankStatement(BankStatementCreateRequest.builder()\n-\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n-\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n-\t\t\t\t// TODO add documentNo to import\n-\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n-\t\t\t\t.name(importBankStatement.getName())\n-\t\t\t\t.description(importBankStatement.getDescription())\n-\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n-\t\t\t\t\t\t.statementReference(importBankStatement.getEftStatementReference())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t.build());\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// TODO add documentNo to import\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.name(importBankStatement.getName())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.description(importBankStatement.getDescription())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementReference(importBankStatement.getEftStatementReference())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.build());\n+\t}\n+\n+\t@VisibleForTesting\n+\tstatic void computeUpdateLineAmts(@NonNull final I_I_BankStatement importRecord)\n+\t{\n+\t\tfinal String amtFormat = getAmtFormat(importRecord);\n+\n+\t\tif (X_I_BankStatement.AMTFORMAT_AmountPlusIndicator.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal trxAmt;\n+\t\t\tfinal boolean isDebit = \"S\".equals(importRecord.getDebitOrCreditIndicator());\n+\t\t\tif (isDebit)\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt().negate();\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt();\n+\t\t\t}\n+\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t\tfinal BigDecimal stmtAmt = trxAmt.add(importRecord.getChargeAmt()).add(importRecord.getInterestAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_DebitPlusCredit.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal stmtAmt = importRecord.getCreditStmtAmt().subtract(importRecord.getDebitStmtAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t\tfinal BigDecimal trxAmt = stmtAmt.subtract(importRecord.getInterestAmt()).subtract(importRecord.getChargeAmt());\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_Straight.equals(amtFormat))\n+\t\t{\n+\t\t\timportRecord.setStmtAmt(importRecord.getTrxAmt());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 208}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDgzMjI3", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535483227", "createdAt": "2020-11-20T14:38:54Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODo1NVrOH3SZoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDozODo1NVrOH3SZoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczNTIwMA==", "bodyText": "what case is this?\nShouldn't we throw exception for this case?", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527735200", "createdAt": "2020-11-20T14:38:55Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.banking/de.metas.banking.base/src/main/java/de/metas/banking/impexp/BankStatementImportProcess.java", "diffHunk": "@@ -175,62 +180,147 @@ private void createBankStatementLine(final I_I_BankStatement importRecord)\n \n \t\tfinal CurrencyId currencyId = CurrencyId.ofRepoId(importRecord.getC_Currency_ID());\n \n-\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(BankStatementLineCreateRequest.builder()\n-\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n-\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n-\t\t\t\t.lineNo(importRecord.getLine())\n-\t\t\t\t//\n-\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n-\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n-\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n-\t\t\t\t//\n-\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n-\t\t\t\t.lineDescription(importRecord.getLineDescription())\n-\t\t\t\t.memo(importRecord.getMemo())\n-\t\t\t\t//\n-\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n-\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n-\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n-\t\t\t\t//\n-\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n-\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n-\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n-\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n-\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n-\t\t\t\t//\n-\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.trxId(importRecord.getEftTrxID())\n-\t\t\t\t\t\t.trxType(importRecord.getEftTrxType())\n-\t\t\t\t\t\t.checkNo(importRecord.getEftCheckNo())\n-\t\t\t\t\t\t.reference(importRecord.getEftReference())\n-\t\t\t\t\t\t.memo(importRecord.getEftMemo())\n-\t\t\t\t\t\t.payee(importRecord.getEftPayee())\n-\t\t\t\t\t\t.payeeAccount(importRecord.getEftPayeeAccount())\n-\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n-\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n-\t\t\t\t\t\t.currency(importRecord.getEftCurrency())\n-\t\t\t\t\t\t.amt(importRecord.getEftAmt())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t//\n-\t\t\t\t.build());\n+\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(\n+\t\t\t\tBankStatementLineCreateRequest.builder()\n+\t\t\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n+\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n+\t\t\t\t\t\t.lineNo(importRecord.getLine())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n+\t\t\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n+\t\t\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n+\t\t\t\t\t\t.lineDescription(importRecord.getLineDescription())\n+\t\t\t\t\t\t.memo(importRecord.getMemo())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n+\t\t\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n+\t\t\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n+\t\t\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n+\t\t\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t .trxId(importRecord.getEftTrxID())\n+\t\t\t\t\t\t\t\t\t .trxType(importRecord.getEftTrxType())\n+\t\t\t\t\t\t\t\t\t .checkNo(importRecord.getEftCheckNo())\n+\t\t\t\t\t\t\t\t\t .reference(importRecord.getEftReference())\n+\t\t\t\t\t\t\t\t\t .memo(importRecord.getEftMemo())\n+\t\t\t\t\t\t\t\t\t .payee(importRecord.getEftPayee())\n+\t\t\t\t\t\t\t\t\t .payeeAccount(importRecord.getEftPayeeAccount())\n+\t\t\t\t\t\t\t\t\t .statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n+\t\t\t\t\t\t\t\t\t .valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n+\t\t\t\t\t\t\t\t\t .currency(importRecord.getEftCurrency())\n+\t\t\t\t\t\t\t\t\t .amt(importRecord.getEftAmt())\n+\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.build());\n \n \t\timportRecord.setC_BankStatementLine_ID(bankStatementLineId.getRepoId());\n \t}\n \n \tprivate BankStatementId createBankStatement(@NonNull final I_I_BankStatement importBankStatement)\n \t{\n \t\treturn bankStatementDAO.createBankStatement(BankStatementCreateRequest.builder()\n-\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n-\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n-\t\t\t\t// TODO add documentNo to import\n-\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n-\t\t\t\t.name(importBankStatement.getName())\n-\t\t\t\t.description(importBankStatement.getDescription())\n-\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n-\t\t\t\t\t\t.statementReference(importBankStatement.getEftStatementReference())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t.build());\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// TODO add documentNo to import\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.name(importBankStatement.getName())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.description(importBankStatement.getDescription())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementReference(importBankStatement.getEftStatementReference())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.build());\n+\t}\n+\n+\t@VisibleForTesting\n+\tstatic void computeUpdateLineAmts(@NonNull final I_I_BankStatement importRecord)\n+\t{\n+\t\tfinal String amtFormat = getAmtFormat(importRecord);\n+\n+\t\tif (X_I_BankStatement.AMTFORMAT_AmountPlusIndicator.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal trxAmt;\n+\t\t\tfinal boolean isDebit = \"S\".equals(importRecord.getDebitOrCreditIndicator());\n+\t\t\tif (isDebit)\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt().negate();\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt();\n+\t\t\t}\n+\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t\tfinal BigDecimal stmtAmt = trxAmt.add(importRecord.getChargeAmt()).add(importRecord.getInterestAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_DebitPlusCredit.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal stmtAmt = importRecord.getCreditStmtAmt().subtract(importRecord.getDebitStmtAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t\tfinal BigDecimal trxAmt = stmtAmt.subtract(importRecord.getInterestAmt()).subtract(importRecord.getChargeAmt());\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_Straight.equals(amtFormat))\n+\t\t{\n+\t\t\timportRecord.setStmtAmt(importRecord.getTrxAmt());\n+\t\t}\n+\n+\t\t{\n+\t\t\tfinal BigDecimal sum = importRecord.getTrxAmt().add(importRecord.getInterestAmt()).add(importRecord.getChargeAmt());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 212}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NDg1NjE1", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-535485615", "createdAt": "2020-11-20T14:41:39Z", "commit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDo0MTo0MFrOH3SgxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxNDo0MTo0MFrOH3SgxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzczNzAyOQ==", "bodyText": "use de.metas.util.StringUtils#trimBlankToNull on of of the list descriptions parts.\ni.e.\n.join(\nStringUtils.trimBlankToNull(importRecord.getLineDescription()),\nStringUtils.trimBlankToNull(importRecord.getLineDescriptionExtra_1()),\n....\n);", "url": "https://github.com/metasfresh/metasfresh/pull/10272#discussion_r527737029", "createdAt": "2020-11-20T14:41:40Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.banking/de.metas.banking.base/src/main/java/de/metas/banking/impexp/BankStatementImportProcess.java", "diffHunk": "@@ -175,62 +180,147 @@ private void createBankStatementLine(final I_I_BankStatement importRecord)\n \n \t\tfinal CurrencyId currencyId = CurrencyId.ofRepoId(importRecord.getC_Currency_ID());\n \n-\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(BankStatementLineCreateRequest.builder()\n-\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n-\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n-\t\t\t\t.lineNo(importRecord.getLine())\n-\t\t\t\t//\n-\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n-\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n-\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n-\t\t\t\t//\n-\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n-\t\t\t\t.lineDescription(importRecord.getLineDescription())\n-\t\t\t\t.memo(importRecord.getMemo())\n-\t\t\t\t//\n-\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n-\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n-\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n-\t\t\t\t//\n-\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n-\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n-\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n-\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n-\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n-\t\t\t\t//\n-\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.trxId(importRecord.getEftTrxID())\n-\t\t\t\t\t\t.trxType(importRecord.getEftTrxType())\n-\t\t\t\t\t\t.checkNo(importRecord.getEftCheckNo())\n-\t\t\t\t\t\t.reference(importRecord.getEftReference())\n-\t\t\t\t\t\t.memo(importRecord.getEftMemo())\n-\t\t\t\t\t\t.payee(importRecord.getEftPayee())\n-\t\t\t\t\t\t.payeeAccount(importRecord.getEftPayeeAccount())\n-\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n-\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n-\t\t\t\t\t\t.currency(importRecord.getEftCurrency())\n-\t\t\t\t\t\t.amt(importRecord.getEftAmt())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t//\n-\t\t\t\t.build());\n+\t\tfinal BankStatementLineId bankStatementLineId = bankStatementDAO.createBankStatementLine(\n+\t\t\t\tBankStatementLineCreateRequest.builder()\n+\t\t\t\t\t\t.bankStatementId(BankStatementId.ofRepoId(importRecord.getC_BankStatement_ID()))\n+\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importRecord.getAD_Org_ID()))\n+\t\t\t\t\t\t.lineNo(importRecord.getLine())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.bpartnerId(BPartnerId.ofRepoIdOrNull(importRecord.getC_BPartner_ID()))\n+\t\t\t\t\t\t.importedBillPartnerName(importRecord.getBill_BPartner_Name())\n+\t\t\t\t\t\t.importedBillPartnerIBAN(importRecord.getIBAN_To())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.referenceNo(importRecord.getReferenceNo())\n+\t\t\t\t\t\t.lineDescription(importRecord.getLineDescription())\n+\t\t\t\t\t\t.memo(importRecord.getMemo())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementLineDate(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getStatementLineDate(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.dateAcct(TimeUtil.asLocalDate(CoalesceUtil.coalesce(importRecord.getDateAcct(), importRecord.getStatementDate())))\n+\t\t\t\t\t\t.valutaDate(TimeUtil.asLocalDate(importRecord.getValutaDate()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.statementAmt(Money.of(importRecord.getStmtAmt(), currencyId))\n+\t\t\t\t\t\t.trxAmt(Money.of(importRecord.getTrxAmt(), currencyId))\n+\t\t\t\t\t\t.chargeAmt(Money.of(importRecord.getChargeAmt(), currencyId))\n+\t\t\t\t\t\t.interestAmt(Money.of(importRecord.getInterestAmt(), currencyId))\n+\t\t\t\t\t\t.chargeId(ChargeId.ofRepoIdOrNull(importRecord.getC_Charge_ID()))\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.eft(ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t .trxId(importRecord.getEftTrxID())\n+\t\t\t\t\t\t\t\t\t .trxType(importRecord.getEftTrxType())\n+\t\t\t\t\t\t\t\t\t .checkNo(importRecord.getEftCheckNo())\n+\t\t\t\t\t\t\t\t\t .reference(importRecord.getEftReference())\n+\t\t\t\t\t\t\t\t\t .memo(importRecord.getEftMemo())\n+\t\t\t\t\t\t\t\t\t .payee(importRecord.getEftPayee())\n+\t\t\t\t\t\t\t\t\t .payeeAccount(importRecord.getEftPayeeAccount())\n+\t\t\t\t\t\t\t\t\t .statementLineDate(TimeUtil.asLocalDate(importRecord.getEftStatementLineDate()))\n+\t\t\t\t\t\t\t\t\t .valutaDate(TimeUtil.asLocalDate(importRecord.getEftValutaDate()))\n+\t\t\t\t\t\t\t\t\t .currency(importRecord.getEftCurrency())\n+\t\t\t\t\t\t\t\t\t .amt(importRecord.getEftAmt())\n+\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t//\n+\t\t\t\t\t\t.build());\n \n \t\timportRecord.setC_BankStatementLine_ID(bankStatementLineId.getRepoId());\n \t}\n \n \tprivate BankStatementId createBankStatement(@NonNull final I_I_BankStatement importBankStatement)\n \t{\n \t\treturn bankStatementDAO.createBankStatement(BankStatementCreateRequest.builder()\n-\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n-\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n-\t\t\t\t// TODO add documentNo to import\n-\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n-\t\t\t\t.name(importBankStatement.getName())\n-\t\t\t\t.description(importBankStatement.getDescription())\n-\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n-\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n-\t\t\t\t\t\t.statementReference(importBankStatement.getEftStatementReference())\n-\t\t\t\t\t\t.build())\n-\t\t\t\t.build());\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgId(OrgId.ofRepoId(importBankStatement.getAD_Org_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.orgBankAccountId(BankAccountId.ofRepoId(importBankStatement.getC_BP_BankAccount_ID()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t// TODO add documentNo to import\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.statementDate(TimeUtil.asLocalDate(importBankStatement.getStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.name(importBankStatement.getName())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.description(importBankStatement.getDescription())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.eft(BankStatementCreateRequest.ElectronicFundsTransfer.builder()\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementDate(TimeUtil.asLocalDate(importBankStatement.getEftStatementDate()))\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .statementReference(importBankStatement.getEftStatementReference())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t .build())\n+\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t.build());\n+\t}\n+\n+\t@VisibleForTesting\n+\tstatic void computeUpdateLineAmts(@NonNull final I_I_BankStatement importRecord)\n+\t{\n+\t\tfinal String amtFormat = getAmtFormat(importRecord);\n+\n+\t\tif (X_I_BankStatement.AMTFORMAT_AmountPlusIndicator.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal trxAmt;\n+\t\t\tfinal boolean isDebit = \"S\".equals(importRecord.getDebitOrCreditIndicator());\n+\t\t\tif (isDebit)\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt().negate();\n+\t\t\t}\n+\t\t\telse\n+\t\t\t{\n+\t\t\t\ttrxAmt = importRecord.getDebitOrCreditAmt();\n+\t\t\t}\n+\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t\tfinal BigDecimal stmtAmt = trxAmt.add(importRecord.getChargeAmt()).add(importRecord.getInterestAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_DebitPlusCredit.equals(amtFormat))\n+\t\t{\n+\t\t\tfinal BigDecimal stmtAmt = importRecord.getCreditStmtAmt().subtract(importRecord.getDebitStmtAmt());\n+\t\t\timportRecord.setStmtAmt(stmtAmt);\n+\t\t\tfinal BigDecimal trxAmt = stmtAmt.subtract(importRecord.getInterestAmt()).subtract(importRecord.getChargeAmt());\n+\t\t\timportRecord.setTrxAmt(trxAmt);\n+\t\t}\n+\t\telse if (X_I_BankStatement.AMTFORMAT_Straight.equals(amtFormat))\n+\t\t{\n+\t\t\timportRecord.setStmtAmt(importRecord.getTrxAmt());\n+\t\t}\n+\n+\t\t{\n+\t\t\tfinal BigDecimal sum = importRecord.getTrxAmt().add(importRecord.getInterestAmt()).add(importRecord.getChargeAmt());\n+\t\t\tif (importRecord.getStmtAmt().compareTo(sum) != 0)\n+\t\t\t{\n+\t\t\t\tthrow new AdempiereException(\"Invalid amount\");\n+\t\t\t}\n+\t\t}\n+\t}\n+\n+\tprivate static void updateDescription(@NonNull final I_I_BankStatement importRecord)\n+\t{\n+\t\tfinal String lineDescription = Joiner.on(\" / \")\n+\t\t\t\t.skipNulls()\n+\t\t\t\t.join(importRecord.getLineDescription(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "050cf8d40137394763ae1258ef526025948a5d83"}, "originalPosition": 224}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab59b48d4ed7115f53336c6334f0986ba4537cc6", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ab59b48d4ed7115f53336c6334f0986ba4537cc6", "committedDate": "2020-11-23T06:12:23Z", "message": "Trim blank strings to null, so they can be properly skipped\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\n\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "533186afdcdfd7fe7c6fd267951d3b7eeb3990fa", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/533186afdcdfd7fe7c6fd267951d3b7eeb3990fa", "committedDate": "2020-11-23T06:33:47Z", "message": "Validate `charset` and `skipFirstNRows`\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\n\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10259281bb5c910560374803e17d4b9e8cab9a5e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/10259281bb5c910560374803e17d4b9e8cab9a5e", "committedDate": "2020-11-23T06:40:44Z", "message": "Don't hardcode strings, use constants\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08821934fb4ab529d7ef52dd0f1d934229827374", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/08821934fb4ab529d7ef52dd0f1d934229827374", "committedDate": "2020-11-23T06:47:07Z", "message": "Possible fix, unsure.\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1736f42bfcfeb5057cb3f174daeec8c00c02c71", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/a1736f42bfcfeb5057cb3f174daeec8c00c02c71", "committedDate": "2020-11-23T07:02:16Z", "message": "Fix tests\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de84db6b8b0aec23c34d27bf41445dec6ba2799c", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/de84db6b8b0aec23c34d27bf41445dec6ba2799c", "committedDate": "2020-11-23T08:29:45Z", "message": "Add nullability annotations, fix warnings\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88265fd3b8be168390f9df10c380b0179788606d", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/88265fd3b8be168390f9df10c380b0179788606d", "committedDate": "2020-11-23T08:30:27Z", "message": "Add test for `AmtFormat`\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32b4411463d9fcc2f6f7f756dbb3e691a5a3d15e", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/32b4411463d9fcc2f6f7f756dbb3e691a5a3d15e", "committedDate": "2020-11-23T09:44:01Z", "message": "Add migration files\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1ebd6740fa190a5268c9426cb1153af454df62", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/4e1ebd6740fa190a5268c9426cb1153af454df62", "committedDate": "2020-11-23T10:43:39Z", "message": "Herpa derpa\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1632539126c96eca4c315d6648e3b52794b35cf1", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/1632539126c96eca4c315d6648e3b52794b35cf1", "committedDate": "2020-11-23T10:15:35Z", "message": "Herpa derpa\n\nhttps://github.com/metasfresh/td156/issues/66\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}, "afterCommit": {"oid": "4e1ebd6740fa190a5268c9426cb1153af454df62", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/4e1ebd6740fa190a5268c9426cb1153af454df62", "committedDate": "2020-11-23T10:43:39Z", "message": "Herpa derpa\n\nhttps://github.com/metasfresh/metasfresh/issues/10270\nSigned-off-by: TheBestPessimist <cristian@tbp.land>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2Mzk5MDY2", "url": "https://github.com/metasfresh/metasfresh/pull/10272#pullrequestreview-536399066", "createdAt": "2020-11-23T11:47:46Z", "commit": {"oid": "4e1ebd6740fa190a5268c9426cb1153af454df62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3029, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}