{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NjQ1NDkx", "number": 9959, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoxNjo1NVrOEkh_GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoxNzoyM1rOEkh_6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzQxMDE3OnYy", "diffSide": "RIGHT", "path": "backend/de.metas.fresh/de.metas.fresh.base/src/main/sql/postgresql/system/70-de.metas.fresh/5567880_sys_gh9878_M_CostElement_CostingMethod_UniqueIndex.sql", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoxNjo1NVrOHThlXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoxNjo1NVrOHThlXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNTIyOQ==", "bodyText": "M_CostElement seems to be \"Client\" only, so we don't need to consider AD_Org_ID \ud83d\udc4d", "url": "https://github.com/metasfresh/metasfresh/pull/9959#discussion_r490235229", "createdAt": "2020-09-17T13:16:55Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.fresh/de.metas.fresh.base/src/main/sql/postgresql/system/70-de.metas.fresh/5567880_sys_gh9878_M_CostElement_CostingMethod_UniqueIndex.sql", "diffHunk": "@@ -0,0 +1,25 @@\n+-- 2020-09-17T08:32:28.233Z\n+-- URL zum Konzept\n+INSERT INTO AD_Index_Table (AD_Client_ID,AD_Index_Table_ID,AD_Org_ID,AD_Table_ID,Created,CreatedBy,EntityType,IsActive,IsUnique,Name,Processing,Updated,UpdatedBy,WhereClause) VALUES (0,540552,0,770,TO_TIMESTAMP('2020-09-17 11:32:27','YYYY-MM-DD HH24:MI:SS'),100,'D','Y','Y','M_CostElement_CostingMethod_Unique','N',TO_TIMESTAMP('2020-09-17 11:32:27','YYYY-MM-DD HH24:MI:SS'),100,'IsActive = ''Y''')\n+;\n+\n+-- 2020-09-17T08:32:28.406Z\n+-- URL zum Konzept\n+INSERT INTO AD_Index_Table_Trl (AD_Language,AD_Index_Table_ID, ErrorMsg, IsTranslated,AD_Client_ID,AD_Org_ID,Created,Createdby,Updated,UpdatedBy) SELECT l.AD_Language, t.AD_Index_Table_ID, t.ErrorMsg, 'N',t.AD_Client_ID,t.AD_Org_ID,t.Created,t.Createdby,t.Updated,t.UpdatedBy FROM AD_Language l, AD_Index_Table t WHERE l.IsActive='Y'AND (l.IsSystemLanguage='Y' AND l.IsBaseLanguage='N') AND t.AD_Index_Table_ID=540552 AND NOT EXISTS (SELECT 1 FROM AD_Index_Table_Trl tt WHERE tt.AD_Language=l.AD_Language AND tt.AD_Index_Table_ID=t.AD_Index_Table_ID)\n+;\n+\n+-- 2020-09-17T08:33:51.579Z\n+-- URL zum Konzept\n+UPDATE AD_Index_Table SET Description='This index is important for the sql function M_Cost_CostPrice_Function. Please, keep them synchronized.',Updated=TO_TIMESTAMP('2020-09-17 11:33:51','YYYY-MM-DD HH24:MI:SS'),UpdatedBy=100 WHERE AD_Index_Table_ID=540552\n+;\n+\n+-- 2020-09-17T08:34:09.835Z\n+-- URL zum Konzept\n+INSERT INTO AD_Index_Column (AD_Client_ID,AD_Column_ID,AD_Index_Column_ID,AD_Index_Table_ID,AD_Org_ID,Created,CreatedBy,EntityType,IsActive,SeqNo,Updated,UpdatedBy) VALUES (0,13463,541040,540552,0,TO_TIMESTAMP('2020-09-17 11:34:09','YYYY-MM-DD HH24:MI:SS'),100,'D','Y',10,TO_TIMESTAMP('2020-09-17 11:34:09','YYYY-MM-DD HH24:MI:SS'),100)\n+;\n+\n+-- 2020-09-17T08:34:15.585Z\n+-- URL zum Konzept\n+CREATE UNIQUE INDEX M_CostElement_CostingMethod_Unique ON M_CostElement (CostingMethod) WHERE IsActive = 'Y'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb3cfdf6b8cb86ee46eb31683e65725cedeefae"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzQxMjI1OnYy", "diffSide": "RIGHT", "path": "backend/de.metas.fresh/de.metas.fresh.base/src/main/sql/postgresql/system/70-de.metas.fresh/5567910_sys_gh9878_Lagerwert_Functions_Modified.sql", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoxNzoyM1rOHThmtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzoyNzoyOVrOHTiHdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNTU3Mg==", "bodyText": "can'T this be stable?", "url": "https://github.com/metasfresh/metasfresh/pull/9959#discussion_r490235572", "createdAt": "2020-09-17T13:17:23Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.fresh/de.metas.fresh.base/src/main/sql/postgresql/system/70-de.metas.fresh/5567910_sys_gh9878_Lagerwert_Functions_Modified.sql", "diffHunk": "@@ -0,0 +1,259 @@\n+DROP FUNCTION if exists getCurrentCost(numeric, date, numeric, numeric, numeric);\n+CREATE OR REPLACE FUNCTION getCurrentCost(p_M_Product_ID numeric, p_Date date, p_AcctSchema_ID numeric,\n+                                          p_M_CostElement_Id numeric,\n+                                          p_AD_Client_ID numeric, p_AD_Org_ID numeric)\n+    returns numeric\n+AS\n+$BODY$\n+WITH x as\n+         (\n+             SELECT m_costdetail_ID,\n+                    cd.prev_currentcostprice,\n+                    cd.M_Product_ID,\n+                    COALESCE(mi.dateAcct, mpo.dateAcct, pp.dateAcct, inv.movementDate, m.MovementDate, io.dateAcct,\n+                             NULL) as dateAcct\n+\n+             from m_costdetail cd\n+\n+                      JOIN AD_Org org on cd.ad_org_ID = org.ad_org_id\n+\n+\n+                      left join M_MatchInv mi ON mi.m_matchinv_id = cd.m_matchinv_id\n+                      left JOIN M_MatchPO mpo on mpo.M_MatchPO_ID = cd.m_MatchPO_ID\n+                      left JOIN PP_Cost_Collector pp ON pp.PP_Cost_Collector_ID = cd.pp_cost_collector_id\n+                      left JOIN m_inventoryline il on il.m_inventoryline_id = cd.m_inventoryline_id\n+                      LEFT JOIN M_Inventory inv on inv.m_inventory_id = il.m_inventory_id\n+                      LEFT JOIN M_MovementLine ml on ml.m_movementline_id = cd.m_movementline_id\n+                      LEFT JOIN M_Movement m on m.m_movement_id = ml.m_movement_ID\n+                      LEFT JOIN m_inoutline iol on iol.m_inoutline_id = cd.m_inoutline_id\n+                      LEFT JOIN M_InOut io on iol.M_InOut_ID = io.M_InOut_ID\n+\n+             WHERE cd.ischangingcosts = 'Y'\n+               and cd.c_acctschema_id = p_acctSchema_ID\n+               and cd.m_costelement_id = p_M_CostElement_Id\n+               and cd.M_Product_ID = p_M_Product_ID\n+               and cd.ad_client_id = p_AD_Client_ID\n+               and cd.ad_org_ID = p_AD_Org_ID\n+         )\n+\n+\n+Select COALESCE((SELECT prev_currentcostprice from x where dateAcct > p_Date limit 1), cost.currentCostPrice)\n+           as currentCostPrice\n+\n+from M_Cost cost\n+\n+\n+WHERE cost.m_product_id = p_M_Product_ID\n+  and cost.c_acctschema_id = p_acctSchema_ID\n+  and cost.m_costelement_id = p_M_CostElement_Id\n+  and cost.ad_client_id = p_AD_Client_ID\n+  and cost.AD_Org_Id = p_AD_Org_ID;\n+\n+$BODY$\n+    LANGUAGE SQL\n+    VOLATILE", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3fb3cfdf6b8cb86ee46eb31683e65725cedeefae"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI0Mzk1OQ==", "bodyText": "It could and should. Modified it.", "url": "https://github.com/metasfresh/metasfresh/pull/9959#discussion_r490243959", "createdAt": "2020-09-17T13:27:29Z", "author": {"login": "metas-rc"}, "path": "backend/de.metas.fresh/de.metas.fresh.base/src/main/sql/postgresql/system/70-de.metas.fresh/5567910_sys_gh9878_Lagerwert_Functions_Modified.sql", "diffHunk": "@@ -0,0 +1,259 @@\n+DROP FUNCTION if exists getCurrentCost(numeric, date, numeric, numeric, numeric);\n+CREATE OR REPLACE FUNCTION getCurrentCost(p_M_Product_ID numeric, p_Date date, p_AcctSchema_ID numeric,\n+                                          p_M_CostElement_Id numeric,\n+                                          p_AD_Client_ID numeric, p_AD_Org_ID numeric)\n+    returns numeric\n+AS\n+$BODY$\n+WITH x as\n+         (\n+             SELECT m_costdetail_ID,\n+                    cd.prev_currentcostprice,\n+                    cd.M_Product_ID,\n+                    COALESCE(mi.dateAcct, mpo.dateAcct, pp.dateAcct, inv.movementDate, m.MovementDate, io.dateAcct,\n+                             NULL) as dateAcct\n+\n+             from m_costdetail cd\n+\n+                      JOIN AD_Org org on cd.ad_org_ID = org.ad_org_id\n+\n+\n+                      left join M_MatchInv mi ON mi.m_matchinv_id = cd.m_matchinv_id\n+                      left JOIN M_MatchPO mpo on mpo.M_MatchPO_ID = cd.m_MatchPO_ID\n+                      left JOIN PP_Cost_Collector pp ON pp.PP_Cost_Collector_ID = cd.pp_cost_collector_id\n+                      left JOIN m_inventoryline il on il.m_inventoryline_id = cd.m_inventoryline_id\n+                      LEFT JOIN M_Inventory inv on inv.m_inventory_id = il.m_inventory_id\n+                      LEFT JOIN M_MovementLine ml on ml.m_movementline_id = cd.m_movementline_id\n+                      LEFT JOIN M_Movement m on m.m_movement_id = ml.m_movement_ID\n+                      LEFT JOIN m_inoutline iol on iol.m_inoutline_id = cd.m_inoutline_id\n+                      LEFT JOIN M_InOut io on iol.M_InOut_ID = io.M_InOut_ID\n+\n+             WHERE cd.ischangingcosts = 'Y'\n+               and cd.c_acctschema_id = p_acctSchema_ID\n+               and cd.m_costelement_id = p_M_CostElement_Id\n+               and cd.M_Product_ID = p_M_Product_ID\n+               and cd.ad_client_id = p_AD_Client_ID\n+               and cd.ad_org_ID = p_AD_Org_ID\n+         )\n+\n+\n+Select COALESCE((SELECT prev_currentcostprice from x where dateAcct > p_Date limit 1), cost.currentCostPrice)\n+           as currentCostPrice\n+\n+from M_Cost cost\n+\n+\n+WHERE cost.m_product_id = p_M_Product_ID\n+  and cost.c_acctschema_id = p_acctSchema_ID\n+  and cost.m_costelement_id = p_M_CostElement_Id\n+  and cost.ad_client_id = p_AD_Client_ID\n+  and cost.AD_Org_Id = p_AD_Org_ID;\n+\n+$BODY$\n+    LANGUAGE SQL\n+    VOLATILE", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDIzNTU3Mg=="}, "originalCommit": {"oid": "3fb3cfdf6b8cb86ee46eb31683e65725cedeefae"}, "originalPosition": 54}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1293, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}