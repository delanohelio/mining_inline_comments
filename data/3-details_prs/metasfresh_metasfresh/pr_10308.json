{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3Njc1Njk0", "number": 10308, "title": "Tests for QuickActions and related", "bodyText": "Also found a case when we were getting a duplicated QA request.\nRelated to #10195", "createdAt": "2020-11-25T20:23:19Z", "url": "https://github.com/metasfresh/metasfresh/pull/10308", "merged": true, "mergeCommit": {"oid": "55c041554705ee8021282b517b4cdc82e5d0fc5c"}, "closed": true, "closedAt": "2020-12-07T06:07:42Z", "author": {"login": "siemiatj"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdgCOK7AH2gAyNTI3Njc1Njk0OjE1NmRmNDU0MjU2YjYzNzAzNWRlMmFmYzg2MDNkOTNiZjY4YjY3MWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdjvPxagFqTU0NTg1MTY2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "156df454256b637035de2afc8603d93bf68b671c", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/156df454256b637035de2afc8603d93bf68b671c", "committedDate": "2020-11-25T17:58:06Z", "message": "#10195 always check if quick actions are not already loading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b5f0759fc78bf23547efda31d28c3d4c725c827", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/6b5f0759fc78bf23547efda31d28c3d4c725c827", "committedDate": "2020-11-25T17:58:20Z", "message": "#10195 remove some unused props"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8e835e3383e86a5a3913176a045d09ab665890", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ed8e835e3383e86a5a3913176a045d09ab665890", "committedDate": "2020-11-25T20:12:20Z", "message": "#10195 add more tables tests (with included views/qa)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1927a5ba383020193f8154a6aebb6f5f65ce521", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/e1927a5ba383020193f8154a6aebb6f5f65ce521", "committedDate": "2020-11-26T15:40:43Z", "message": "#10195 test for deselecting rows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee122d2f47e9fb448acfabb59549151221fdf0ee", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ee122d2f47e9fb448acfabb59549151221fdf0ee", "committedDate": "2020-11-26T17:18:34Z", "message": "#10195 QA actions tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62f6aff1cb12e58366224c2802a5f135ed76f4e9", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/62f6aff1cb12e58366224c2802a5f135ed76f4e9", "committedDate": "2020-11-30T10:24:59Z", "message": "#10195 re-fix fetching parent's QA when child selection changes and add a unit test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8300b5497b736a3a59df9603202eaa6dff487dd5", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/8300b5497b736a3a59df9603202eaa6dff487dd5", "committedDate": "2020-11-30T15:36:55Z", "message": "#10195 cleanup and comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82bf6c8605ce3f54b390be7aeb8174ef0fe4dca2", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/82bf6c8605ce3f54b390be7aeb8174ef0fe4dca2", "committedDate": "2020-11-30T15:37:10Z", "message": "#10195 unskip main reducer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "072c5b29f30aa8fcba4474bad29a942a4591b351", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/072c5b29f30aa8fcba4474bad29a942a4591b351", "committedDate": "2020-11-30T15:37:27Z", "message": "#10195 quick actions reducer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d668e467cb34401241f05f0ba7774bea98c8c4", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/64d668e467cb34401241f05f0ba7774bea98c8c4", "committedDate": "2020-11-30T19:11:05Z", "message": "#10195 return promises from some AC's for easier testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c73eb4b738b9f3b974de6732ea7320caabff4a0b", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/c73eb4b738b9f3b974de6732ea7320caabff4a0b", "committedDate": "2020-11-30T19:12:07Z", "message": "#10195 update tests and get rid of some suppressed errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f60d47d916ac31d485bde13cc63abb0804c18f7b", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/f60d47d916ac31d485bde13cc63abb0804c18f7b", "committedDate": "2020-12-01T09:58:30Z", "message": "#10195 fix linter errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71c927502ca7e7de98613d6dbd87661bbf2b1e47", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/71c927502ca7e7de98613d6dbd87661bbf2b1e47", "committedDate": "2020-12-01T14:35:02Z", "message": "#10195 fix errors in Modal tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNTEyNzUz", "url": "https://github.com/metasfresh/metasfresh/pull/10308#pullrequestreview-542512753", "createdAt": "2020-12-02T05:39:50Z", "commit": {"oid": "71c927502ca7e7de98613d6dbd87661bbf2b1e47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba2e731c2f4cc5469e21b218a6a5706b0cb05c86", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/ba2e731c2f4cc5469e21b218a6a5706b0cb05c86", "committedDate": "2020-12-03T15:52:50Z", "message": "#10195 rewrite QA fetching to properly account for included views\n#10195 simplify logic a bit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "963c5b8c645d6389fb84564b693b45826f2959eb", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/963c5b8c645d6389fb84564b693b45826f2959eb", "committedDate": "2020-12-03T15:53:12Z", "message": "#10195 update and remove/add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd3168d4dce0c0fb06018576cd18c134d1136b13", "author": {"user": {"login": "siemiatj", "name": "Kuba Siemi\u0105tkowski"}}, "url": "https://github.com/metasfresh/metasfresh/commit/cd3168d4dce0c0fb06018576cd18c134d1136b13", "committedDate": "2020-12-04T13:16:50Z", "message": "#10195 fix linter errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1ODUxNjYx", "url": "https://github.com/metasfresh/metasfresh/pull/10308#pullrequestreview-545851661", "createdAt": "2020-12-07T06:05:27Z", "commit": {"oid": "cd3168d4dce0c0fb06018576cd18c134d1136b13"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNjowNToyN1rOIAXSWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwNjowNToyN1rOIAXSWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzI1MjQ0Mw==", "bodyText": "string", "url": "https://github.com/metasfresh/metasfresh/pull/10308#discussion_r537252443", "createdAt": "2020-12-07T06:05:27Z", "author": {"login": "petrican"}, "path": "frontend/src/actions/Actions.js", "diffHunk": "@@ -11,131 +11,166 @@ import {\n } from '../constants/ActionTypes';\n \n import { getQuickActionsId, getQuickActions } from '../reducers/actionsHandler';\n-import { getTable } from '../reducers/tables';\n+import { getTable, getTableId } from '../reducers/tables';\n import { getView } from '../reducers/viewHandler';\n \n /*\n- * @method getTableActions\n+ * @method fetchQuickActions\n  * @summary Action creator that calls the quick actions fetch internally for\n  * when we're updating the table selection \n  \n- * @param {string} tableId\n  * @param {number} windowId\n  * @param {string} viewId\n  * @param {boolean} isModal\n+ * @param {string} viewProfileId\n  */\n-export function getTableActions({ tableId, windowId, viewId, isModal }) {\n+export function fetchQuickActions({\n+  windowId,\n+  viewId,\n+  isModal,\n+  viewProfileId = null,\n+}) {\n   return (dispatch, getState) => {\n+    let actionPromises = null;\n     const state = getState();\n-    const table = getTable(state, tableId);\n-    const selectedIds = table.selected;\n-    const { includedView } = state.viewHandler;\n-    const viewProfileId =\n-      includedView.windowId === windowId ? includedView.viewProfileId : null;\n-    let fetchActions = true;\n-\n-    if (viewId) {\n-      const quickActionsId = getQuickActionsId({\n-        windowId,\n-        viewId,\n-      });\n-      const quickActions = getQuickActions(state, quickActionsId);\n-      fetchActions = quickActions.pending === false;\n-    }\n+    const includedView = state.viewHandler.includedView.windowId\n+      ? state.viewHandler.includedView\n+      : null;\n \n-    if (fetchActions) {\n-      dispatch(\n-        fetchQuickActions({\n-          windowId,\n-          viewId,\n-          viewProfileId,\n-          selectedIds,\n-        })\n-      );\n+    if (includedView) {\n+      viewProfileId = viewProfileId || includedView.viewProfileId;\n+\n+      const isParent = includedView.parentId === windowId;\n+      const isChild = includedView.windowId === windowId;\n+\n+      if (isParent || isChild) {\n+        const requests = dispatch(\n+          getQuickActionRequests({\n+            windowId,\n+            viewId,\n+            includedView,\n+            viewProfileId,\n+            isModal,\n+            isParent,\n+          })\n+        );\n+\n+        actionPromises = [].concat(requests);\n+      }\n+    } else {\n+      const tableId = getTableId({ windowId, viewId });\n+      const table = getTable(state, tableId);\n+\n+      actionPromises = [\n+        dispatch(\n+          requestQuickActions({\n+            windowId,\n+            viewId,\n+            selectedIds: table.selected,\n+            viewProfileId,\n+          })\n+        ),\n+      ];\n     }\n \n-    dispatch(\n-      fetchIncludedQuickActions({\n-        windowId,\n-        selectedIds,\n-        isModal,\n-      })\n-    );\n+    return Promise.all(actionPromises);\n   };\n }\n \n /*\n  * @method fetchIncludedQuickActions\n- * @summary Action creator that calls the quick actions fetch internally for parent/child\n- * quick actions, when a table selection has changed\n+ * @summary Action creator that calls the creates the requests for included quick actions\n  *\n- * @param {string} windowId\n- * @param {array} selectedIds\n+ * @param {number} windowId", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cd3168d4dce0c0fb06018576cd18c134d1136b13"}, "originalPosition": 113}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3047, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}