{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1ODQ3Njk3", "number": 6872, "title": "Gh6866 MasterWidget", "bodyText": "", "createdAt": "2020-06-17T13:20:56Z", "url": "https://github.com/metasfresh/metasfresh/pull/6872", "merged": true, "mergeCommit": {"oid": "20cc8d50a7599c9d57bfb6c041c90ac0a7abad37"}, "closed": true, "closedAt": "2020-06-18T08:01:15Z", "author": {"login": "petrican"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsDctAgH2gAyNDM1ODQ3Njk3OjgzNWY2Y2I3NGI1ZGI4ZDNlNTA2MTlhNzgwZGY1NzNlYTYwOGRiM2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsZf3dgFqTQzMzAxODgxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "835f6cb74b5db8d3e50619a780df573ea608db3e", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/835f6cb74b5db8d3e50619a780df573ea608db3e", "committedDate": "2020-06-17T05:59:49Z", "message": "Extract isNumberField function to an external util file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dab38bcb18be116898f74c37241d66d0d37ab846", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/dab38bcb18be116898f74c37241d66d0d37ab846", "committedDate": "2020-06-17T06:25:02Z", "message": "format dateParse arr from the constants prevent DRY"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3bffe48833d46ad819e2c3f363add1e0a2f6ae9f", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/3bffe48833d46ad819e2c3f363add1e0a2f6ae9f", "committedDate": "2020-06-17T07:12:29Z", "message": "Removed the logic from componentDidMount that was causing extra re-rendering by setting the state"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d82193c84ccde74763db362f4c50f4811d89ec3", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/4d82193c84ccde74763db362f4c50f4811d89ec3", "committedDate": "2020-06-17T07:17:56Z", "message": "Added back the original doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02887e45e732efcd0bac86a9ac0edafab14a978e", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/02887e45e732efcd0bac86a9ac0edafab14a978e", "committedDate": "2020-06-17T08:31:24Z", "message": "Add unit tests for the isNumberField fnct"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c24053bbc293dc066e81a58f80093feebd305a1", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/6c24053bbc293dc066e81a58f80093feebd305a1", "committedDate": "2020-06-17T11:21:40Z", "message": "Ditch the UNSAFE_componentWillReceiveProp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b73dc9eafe67142789fcda98599fa9b557cc7a67", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/b73dc9eafe67142789fcda98599fa9b557cc7a67", "committedDate": "2020-06-17T12:11:19Z", "message": "handlePatch refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f1bf61a6829a2f188be62d61075e772d5a38df", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/51f1bf61a6829a2f188be62d61075e772d5a38df", "committedDate": "2020-06-17T12:49:59Z", "message": "More refactoring within MasterWidget move validatePrecision outside"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5189f3dc52f158d9a3cb4fd941a9231ab490d3f7", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/5189f3dc52f158d9a3cb4fd941a9231ab490d3f7", "committedDate": "2020-06-17T13:06:40Z", "message": "Add unit tests for formatValueByWidgetType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "813eb6821f99b76620e1be308d60706689cba857", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/813eb6821f99b76620e1be308d60706689cba857", "committedDate": "2020-06-17T13:15:15Z", "message": "Add unit tests for the validatePrecision"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDI1MDk3", "url": "https://github.com/metasfresh/metasfresh/pull/6872#pullrequestreview-432425097", "createdAt": "2020-06-17T13:53:36Z", "commit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzo1MzozNlrOGlG28w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QyMzo0NjoxMFrOGla-kA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2Mjg2Nw==", "bodyText": "why not just import the 3 ACs we actually need ?", "url": "https://github.com/metasfresh/metasfresh/pull/6872#discussion_r441562867", "createdAt": "2020-06-17T13:53:36Z", "author": {"login": "siemiatj"}, "path": "frontend/src/components/widget/MasterWidget.js", "diffHunk": "@@ -1,89 +1,84 @@\n import PropTypes from 'prop-types';\n-import React, { Component } from 'react';\n+import React, { PureComponent } from 'react';\n import { connect } from 'react-redux';\n import Moment from 'moment-timezone';\n import * as windowActions from '../../actions/WindowActions';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2NTA0NQ==", "bodyText": "Are we sure we can run split on widgetValue at all times ?", "url": "https://github.com/metasfresh/metasfresh/pull/6872#discussion_r441565045", "createdAt": "2020-06-17T13:56:24Z", "author": {"login": "siemiatj"}, "path": "frontend/src/utils/widgetHelper.js", "diffHunk": "@@ -0,0 +1,49 @@\n+/**\n+ * @method isNumberField\n+ * @summary verifies if the widgetType passed as argument is a number field or not. Returns a boolean value\n+ * @param {string} widgetType\n+ */\n+export function isNumberField(widgetType) {\n+  switch (widgetType) {\n+    case 'Integer':\n+    case 'Amount':\n+    case 'Quantity':\n+      return true;\n+    default:\n+      return false;\n+  }\n+}\n+\n+/**\n+ * @method formatValueByWidgetType\n+ * @summary Performs patching at MasterWidget level, shaping in the same time the `value` for various cases\n+ * @param {string} widgetType\n+ * @param {string|undefined} value\n+ */\n+export function formatValueByWidgetType({ widgetType, value }) {\n+  const numberField = isNumberField(widgetType);\n+  if (widgetType === 'Quantity' && value === '') {\n+    return null;\n+  } else if (numberField && !value) {\n+    return '0';\n+  }\n+}\n+\n+/**\n+ * @method validatePrecision\n+ * @summary Validates the precision based on the widget value and type props\n+ * @param {string} widgetValue\n+ * @param {string} widgetType\n+ * @param {integer} precision\n+ */\n+export function validatePrecision({ widgetValue, widgetType, precision }) {\n+  let precisionProcessed = precision;\n+\n+  if (widgetType === 'Integer' || widgetType === 'Quantity') {\n+    precisionProcessed = 0;\n+  }\n+\n+  return precisionProcessed < (widgetValue.split('.')[1] || []).length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU2NjA4Ng==", "bodyText": "I don't think we need a comment for built-in React functions. I always remove them because it's an unnecessary noise.", "url": "https://github.com/metasfresh/metasfresh/pull/6872#discussion_r441566086", "createdAt": "2020-06-17T13:57:44Z", "author": {"login": "siemiatj"}, "path": "frontend/src/components/widget/MasterWidget.js", "diffHunk": "@@ -260,7 +204,7 @@ class MasterWidget extends Component {\n \n   /**\n    * @method render\n-   * @summary ToDo: Describe the method.\n+   * @summary Main render function", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "originalPosition": 305}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg5MTYzNg==", "bodyText": "can we use less cryptic variable name ?", "url": "https://github.com/metasfresh/metasfresh/pull/6872#discussion_r441891636", "createdAt": "2020-06-17T23:43:02Z", "author": {"login": "siemiatj"}, "path": "frontend/src/components/widget/MasterWidget.js", "diffHunk": "@@ -1,89 +1,84 @@\n import PropTypes from 'prop-types';\n-import React, { Component } from 'react';\n+import React, { PureComponent } from 'react';\n import { connect } from 'react-redux';\n import Moment from 'moment-timezone';\n import * as windowActions from '../../actions/WindowActions';\n import { getZoomIntoWindow } from '../../api';\n import { convertTimeStringToMoment } from '../../utils/documentListHelper';\n import { formatDateWithZeros } from '../../utils/documentListHelper';\n import RawWidget from './RawWidget';\n+import {\n+  validatePrecision,\n+  formatValueByWidgetType,\n+} from '../../utils/widgetHelper';\n+import { DATE_FIELD_TYPES, TIME_FIELD_TYPES } from '../../constants/Constants';\n+import _ from 'lodash';\n \n-function isNumberField(widgetType) {\n-  switch (widgetType) {\n-    case 'Integer':\n-    case 'Amount':\n-    case 'Quantity':\n-      return true;\n-    default:\n-      return false;\n-  }\n-}\n-\n-const dateParse = ['Date', 'DateTime', 'ZonedDateTime', 'Timestamp', 'Time'];\n+const dateParse = [...DATE_FIELD_TYPES, ...TIME_FIELD_TYPES];\n \n /**\n  * @file Class based component.\n  * @module MasterWidget\n  * @extends Component\n  */\n-class MasterWidget extends Component {\n-  state = {\n-    updated: false,\n-    edited: false,\n-    data: '',\n-  };\n-\n-  componentDidMount() {\n+class MasterWidget extends PureComponent {\n+  constructor(props) {\n+    super(props);\n     const { data, widgetData, clearValue } = this.props;\n-\n-    // `clearValue` removes current field value for the widget. This is used when\n-    // user focuses on table cell and starts typing\n-    this.setState({\n+    // `clearValue` removes current field value for the widget. This is used when user focuses on table cell and starts typing\n+    this.state = {\n+      updated: false,\n+      edited: false,\n       data: data || (clearValue ? '' : widgetData[0].value),\n-    });\n+      widgetData: props.widgetData, // this is used for comparison in the getDerivedStateFromProps lifecycle\n+    };\n   }\n \n-  UNSAFE_componentWillReceiveProps(nextProps) {\n-    const { widgetData, widgetType } = this.props;\n-    const { edited, data } = this.state;\n+  /**\n+   * @method getDerivedStateFromProps\n+   * @summary is invoked right before calling the render method, both on the initial mount and on subsequent updates\n+   *          updates the data and the widgetData from the MasterWidget state, also the updated flag\n+   *          Used this in order to ditch the deprecated UNSAFE_componentWillReceiveProps\n+   */\n+  static getDerivedStateFromProps(nextProps, prevState) {\n+    const { widgetType } = nextProps;\n+    const { edited, widgetData } = prevState;\n     let next = nextProps.widgetData[0].value;\n+    let bringsModifs = widgetData[0] && !_.isEqual(widgetData[0].value, next);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTg5MjQ5Ng==", "bodyText": "Does this really give us anything ?", "url": "https://github.com/metasfresh/metasfresh/pull/6872#discussion_r441892496", "createdAt": "2020-06-17T23:46:10Z", "author": {"login": "siemiatj"}, "path": "frontend/src/components/widget/MasterWidget.js", "diffHunk": "@@ -102,31 +97,15 @@ class MasterWidget extends Component {\n       isAdvanced = false,\n       viewId,\n     } = this.props;\n-    const numberField = isNumberField(widgetType);\n \n-    if (widgetType === 'Quantity' && value === '') {\n-      value = null;\n-    } else if (numberField && !value) {\n-      value = '0';\n-    }\n-\n-    let { entity } = this.props;\n-    let currRowId = rowId;\n+    let entity = viewId ? 'documentView' : this.props.entity;\n+    value = formatValueByWidgetType({ widgetType, value });\n+    let currRowId = rowId === 'NEW' ? relativeDocId : rowId;\n     let ret = null;\n-    let isEdit = false;\n-\n-    if (rowId === 'NEW') {\n-      currRowId = relativeDocId;\n-    }\n+    let isEdit = viewId ? true : false;\n \n-    if (widgetType !== 'Button') {\n+    widgetType !== 'Button' &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "813eb6821f99b76620e1be308d60706689cba857"}, "originalPosition": 166}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb1b5aba384341b43e7a623c480fed169dbe315d", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/eb1b5aba384341b43e7a623c480fed169dbe315d", "committedDate": "2020-06-18T06:01:10Z", "message": "Import only the necessary actions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "880513aa1c382a6a71dac892ec50e48e077f109e", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/880513aa1c382a6a71dac892ec50e48e077f109e", "committedDate": "2020-06-18T06:08:28Z", "message": "Removed desc on main render function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c89bc0a3d14da63fa12b34c8a1eeb176bb0e957", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/1c89bc0a3d14da63fa12b34c8a1eeb176bb0e957", "committedDate": "2020-06-18T06:19:11Z", "message": "Changed variable name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c561017392e38684c066e75992b0070c37d378e9", "author": {"user": null}, "url": "https://github.com/metasfresh/metasfresh/commit/c561017392e38684c066e75992b0070c37d378e9", "committedDate": "2020-06-18T07:13:45Z", "message": "Added extra safety checks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMzMDE4ODE4", "url": "https://github.com/metasfresh/metasfresh/pull/6872#pullrequestreview-433018818", "createdAt": "2020-06-18T07:41:11Z", "commit": {"oid": "c561017392e38684c066e75992b0070c37d378e9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3391, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}