{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzNjg0Mjc1", "number": 9922, "title": "handle returns", "bodyText": "refs: #9920", "createdAt": "2020-09-10T11:03:45Z", "url": "https://github.com/metasfresh/metasfresh/pull/9922", "merged": true, "mergeCommit": {"oid": "3fb35e7246a4aa2ac036b841047927b0bc438757"}, "closed": true, "closedAt": "2020-09-13T19:46:46Z", "author": {"login": "pvpurcarcosmin"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHeiWzgH2gAyNDgzNjg0Mjc1OjM1NmY3ZTJiNWMwNzE0NTFmZjExYmIwNjM3NWM5MWRlNGVmYzM1ZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH3Mc2gH2gAyNDgzNjg0Mjc1OmRlOWZjOTNmYTEwM2NiZmEwMTJhZjQyYmZmZTE1NTE3NmJmYjJlMWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/356f7e2b5c071451ff11bb06375c91de4efc35e0", "committedDate": "2020-09-10T10:49:23Z", "message": "handle returns\n\nrefs: https://github.com/metasfresh/metasfresh/issues/9920"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1OTE5MjMy", "url": "https://github.com/metasfresh/metasfresh/pull/9922#pullrequestreview-485919232", "createdAt": "2020-09-10T13:18:18Z", "commit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMzoxODoxOFrOHPzIKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMzo1MTozM1rOHP0-iA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMyODM2Mw==", "bodyText": "just a minor thing: i believe we should prefer ImmutableList and use immutable collections be default, unless we explicitly want them to be mutable", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486328363", "createdAt": "2020-09-10T13:18:18Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.business.rest-api-impl/src/main/java/de/metas/rest_api/receipt/ReceiptRestController.java", "diffHunk": "@@ -84,17 +85,37 @@ public ResponseEntity createReceipts(@RequestBody final JsonCreateReceiptsReques\n \t\t}\n \t}\n \n+\tprivate JsonCreateReceiptsResponse createReceipts_0(@NonNull final JsonCreateReceiptsRequest jsonCreateReceiptsRequest)\n+\t{\n+\t\tfinal List<InOutId> createdReceiptIds = jsonCreateReceiptsRequest.getJsonCreateReceiptInfoList().isEmpty()\n+\t\t\t\t? ImmutableList.of()\n+\t\t\t\t: receiptService.updateReceiptCandidatesAndGenerateReceipts(jsonCreateReceiptsRequest);\n+\n+\t\tfinal List<InOutId> createdReturnIds = jsonCreateReceiptsRequest.getJsonCreateCustomerReturnInfoList().isEmpty()\n+\t\t\t\t? ImmutableList.of()\n+\t\t\t\t: customerReturnService.handleReturns(jsonCreateReceiptsRequest.getJsonCreateCustomerReturnInfoList());\n+\n+\t\treturn toJsonCreateReceiptsResponse(createdReceiptIds, createdReturnIds);\n+\t}\n+\n \t@NonNull\n-\tprivate JsonCreateReceiptsResponse toJsonCreateReceiptsResponse(@NonNull final List<InOutId> receiptIds)\n+\tprivate JsonCreateReceiptsResponse toJsonCreateReceiptsResponse(@NonNull final List<InOutId> receiptIds, @NonNull final List<InOutId> returnIds)\n \t{\n-\t\tfinal List<JsonMetasfreshId> jsonIds = receiptIds\n+\t\tfinal List<JsonMetasfreshId> jsonReceiptIds = receiptIds\n+\t\t\t\t.stream()\n+\t\t\t\t.map(InOutId::getRepoId)\n+\t\t\t\t.map(JsonMetasfreshId::of)\n+\t\t\t\t.collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMzOTYzMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tvoid setHUStatus(final I_M_HU hu, final IContextAware contextProvider, final String huStatus);\n          \n          \n            \n            \tvoid setHUStatus(I_M_HU hu, IContextAware contextProvider, String huStatus);", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486339630", "createdAt": "2020-09-10T13:33:42Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/IHandlingUnitsBL.java", "diffHunk": "@@ -548,4 +545,6 @@ static I_M_HU_PI_Item_Product extractPIItemProductOrNull(final I_M_HU hu)\n \t}\n \n \tAttributesKey getStorageRelevantAttributesKey(@NonNull I_M_HU hu);\n+\n+\tvoid setHUStatus(final I_M_HU hu, final IContextAware contextProvider, final String huStatus);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MDE0OQ==", "bodyText": "..also, why not have this method in IHUStatusBL directly?", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486340149", "createdAt": "2020-09-10T13:34:25Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/IHandlingUnitsBL.java", "diffHunk": "@@ -548,4 +545,6 @@ static I_M_HU_PI_Item_Product extractPIItemProductOrNull(final I_M_HU hu)\n \t}\n \n \tAttributesKey getStorageRelevantAttributesKey(@NonNull I_M_HU hu);\n+\n+\tvoid setHUStatus(final I_M_HU hu, final IContextAware contextProvider, final String huStatus);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjMzOTYzMA=="}, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM0MjE0MQ==", "bodyText": "eeee..is this really a repository though? maybe better call it sth like CustomerReturnInOutRecordFactory (...or sth shorter)", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486342141", "createdAt": "2020-09-10T13:36:46Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/inout/impl/CustomerReturnRepository.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * #%L\n+ * de.metas.handlingunits.base\n+ * %%\n+ * Copyright (C) 2020 metas GmbH\n+ * %%\n+ * This program is free software: you can redistribute it and/or modify\n+ * it under the terms of the GNU General Public License as\n+ * published by the Free Software Foundation, either version 2 of the\n+ * License, or (at your option) any later version.\n+ *\n+ * This program is distributed in the hope that it will be useful,\n+ * but WITHOUT ANY WARRANTY; without even the implied warranty of\n+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the\n+ * GNU General Public License for more details.\n+ *\n+ * You should have received a copy of the GNU General Public\n+ * License along with this program. If not, see\n+ * <http://www.gnu.org/licenses/gpl-2.0.html>.\n+ * #L%\n+ */\n+\n+package de.metas.handlingunits.inout.impl;\n+\n+import de.metas.handlingunits.model.I_M_InOut;\n+import de.metas.handlingunits.model.I_M_InOutLine;\n+import de.metas.inout.IInOutDAO;\n+import de.metas.util.Services;\n+import lombok.NonNull;\n+import org.adempiere.model.InterfaceWrapperHelper;\n+import org.adempiere.warehouse.WarehouseId;\n+import org.adempiere.warehouse.api.IWarehouseBL;\n+import org.springframework.stereotype.Repository;\n+\n+import static org.compiere.model.X_M_InOut.MOVEMENTTYPE_CustomerReturns;\n+import static org.compiere.util.TimeUtil.asTimestamp;\n+\n+@Repository\n+public class CustomerReturnRepository", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM1MTc0Ng==", "bodyText": "do we need this though? i thought we just created them?", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486351746", "createdAt": "2020-09-10T13:45:24Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.handlingunits.base/src/main/java/de/metas/handlingunits/model/validator/M_InOut.java", "diffHunk": "@@ -291,9 +295,13 @@ public void generateHUsForCustomerReturn(final I_M_InOut customerReturn)\n \n \t\tfinal List<I_M_HU> existingHandlingUnits = Services.get(IHUInOutDAO.class).retrieveHandlingUnits(customerReturn);\n \n+\t\t// the handling units are already created\n \t\tif (!existingHandlingUnits.isEmpty())\n \t\t{\n-\t\t\t// the handling units are already created\n+\t\t\tfinal IContextAware contextProvider = InterfaceWrapperHelper.getContextAware(customerReturn);\n+\n+\t\t\t//make sure they all have status active\n+\t\t\texistingHandlingUnits.forEach(hu -> handlingUnitsBL.setHUStatus(hu, contextProvider, X_M_HU.HUSTATUS_Active));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM1ODY2NA==", "bodyText": "teo proposed that we move this to a utility class, because it has no state and therefore doesn't really need to be a super-class..\npls coordinate with him to avaoid nasty conflicts", "url": "https://github.com/metasfresh/metasfresh/pull/9922#discussion_r486358664", "createdAt": "2020-09-10T13:51:33Z", "author": {"login": "metas-ts"}, "path": "misc/services/camel/de-metas-camel-shipping/src/main/java/de/metas/camel/shipping/XmlToJsonBaseProcessor.java", "diffHunk": "@@ -40,18 +40,15 @@\n import java.util.Map;\n import java.util.Optional;\n import java.util.Set;\n-import java.util.function.BiFunction;\n import java.util.function.Function;\n-import java.util.stream.Collectors;\n \n public class XmlToJsonBaseProcessor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "356f7e2b5c071451ff11bb06375c91de4efc35e0"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c3ed93f010670983494f89382d7e78e2e53d15a", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/8c3ed93f010670983494f89382d7e78e2e53d15a", "committedDate": "2020-09-10T23:02:13Z", "message": "small ImmutableList refactor\nrefs: https://github.com/metasfresh/metasfresh/issues/9920"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73375d4ae376541f6a419512134073cd51300e1c", "author": {"user": {"login": "teosarca", "name": "Teo Sarca"}}, "url": "https://github.com/metasfresh/metasfresh/commit/73375d4ae376541f6a419512134073cd51300e1c", "committedDate": "2020-09-11T10:08:06Z", "message": "remove XmlToJsonBaseProcessor; introduce XmlToJsonProcessorUtil\nCP from https://github.com/metasfresh/metasfresh/commit/14fa80fa91831a9bb50126939f4944f3be1f33be"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ef2d78c00da2e561d04a8c33e8ef2213553e987", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/3ef2d78c00da2e561d04a8c33e8ef2213553e987", "committedDate": "2020-09-11T10:12:46Z", "message": "refactor after\nCP from https://github.com/metasfresh/metasfresh/commit/14fa80fa91831a9bb50126939f4944f3be1f33be"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e37f8d875d8714750d5de4e6560f64c45b3225ce", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/e37f8d875d8714750d5de4e6560f64c45b3225ce", "committedDate": "2020-09-11T12:08:17Z", "message": "Merge branch 'blonde_monkey_uat' into gh9920-returns\n\n# Conflicts:\n#\tmisc/de-metas-common/de-metas-common-shipping/src/main/java/de/metas/common/receipt/JsonCreateReceiptsRequest.java\n#\tmisc/de-metas-common/de-metas-common-shipping/src/main/java/de/metas/common/receipt/JsonCreateReceiptsResponse.java\n#\tmisc/de-metas-common/de-metas-common-shipping/src/main/java/de/metas/common/shipment/JsonCreateShipmentRequest.java\n#\tmisc/services/camel/de-metas-camel-shipping/src/main/java/de/metas/camel/shipping/CommonUtil.java\n#\tmisc/services/camel/de-metas-camel-shipping/src/main/java/de/metas/camel/shipping/XmlToJsonProcessorUtil.java\n#\tmisc/services/camel/de-metas-camel-shipping/src/main/java/de/metas/camel/shipping/receipt/ReceiptXmlToJsonProcessor.java\n#\tmisc/services/camel/de-metas-camel-shipping/src/main/java/de/metas/camel/shipping/shipment/ShipmentXmlToJsonProcessor.java\n#\tmisc/services/camel/de-metas-camel-shipping/src/main/resources/shipping.properties"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d668c829d5ee57fc1275ff9bad9697dddd856c", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/a0d668c829d5ee57fc1275ff9bad9697dddd856c", "committedDate": "2020-09-11T14:03:27Z", "message": "build fix\nrefs: https://github.com/metasfresh/metasfresh/issues/9877"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "871a997504ebb16b6cff38c97668cdb940660972", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/871a997504ebb16b6cff38c97668cdb940660972", "committedDate": "2020-09-11T14:35:31Z", "message": "build fix\nhttps://github.com/metasfresh/metasfresh/issues/9877"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de9fc93fa103cbfa012af42bffe155176bfb2e1c", "author": {"user": {"login": "pvpurcarcosmin", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/de9fc93fa103cbfa012af42bffe155176bfb2e1c", "committedDate": "2020-09-11T15:33:05Z", "message": "small change\nhttps://github.com/metasfresh/metasfresh/issues/9920"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3169, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}