{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NzE5MzUx", "number": 9876, "title": "Fix possible timing problem for C_Invoice allocation", "bodyText": "#7171", "createdAt": "2020-09-02T10:19:33Z", "url": "https://github.com/metasfresh/metasfresh/pull/9876", "merged": true, "mergeCommit": {"oid": "2c07d687295fc76167d7977eb60470d46c1bc8e8"}, "closed": true, "closedAt": "2020-09-03T04:49:49Z", "author": {"login": "TheBestPessimist"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE6DWSgFqTQ4MDcxNTA2NQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFJLWcABqjM3MjI4NjEwMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzE1MDY1", "url": "https://github.com/metasfresh/metasfresh/pull/9876#pullrequestreview-480715065", "createdAt": "2020-09-02T11:11:05Z", "commit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMTowNVrOHLqOcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMTowNVrOHLqOcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4ODIwOQ==", "bodyText": "why do we have to call testAndMarkAsPaid again? we are already calling it at line 92....\nI think we shall try calling it only once.", "url": "https://github.com/metasfresh/metasfresh/pull/9876#discussion_r481988209", "createdAt": "2020-09-02T11:11:05Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -86,24 +86,26 @@ public C_Invoice(@NonNull final PaymentReservationService paymentReservationServ\n \t\tthis.paymentReservationService = paymentReservationService;\n \t}\n \n-\t@DocValidate(timings = { ModelValidator.TIMING_BEFORE_COMPLETE })\n-\tpublic void onBeforeComplete(final I_C_Invoice invoice)\n-\t{\n-\t\tallocateInvoiceAgainstCreditMemo(invoice);\n-\t\tlinkInvoiceToPaymentIfNeeded(invoice);\n-\t}\n-\n \t@DocValidate(timings = { ModelValidator.TIMING_AFTER_COMPLETE })\n \tpublic void onAfterComplete(final I_C_Invoice invoice)\n \t{\n-\t\tmarkAsPaid(invoice);\n+\t\ttestAndMarkAsPaid(invoice);\n+\t\tallocateInvoiceAgainstCreditMemo(invoice);\n+\t\tlinkInvoiceToPaymentIfNeeded(invoice);\n \t\tallocateInvoiceAgainstPaymentIfNeeded(invoice);\n+\t\tautoAllocateAvailablePayments(invoice);\n \t\tcaptureMoneyIfNeeded(invoice);\n \t\tensureUOMsAreNotNull(invoice);\n \n \t\tC_Invoice_CreateExportData.scheduleOnTrxCommit(invoice);\n \t}\n \n+\tprivate void autoAllocateAvailablePayments(final I_C_Invoice invoice)\n+\t{\n+\t\tallocationBL.autoAllocateAvailablePayments(invoice);\n+\t\ttestAndMarkAsPaid(invoice);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzE1NDkz", "url": "https://github.com/metasfresh/metasfresh/pull/9876#pullrequestreview-480715493", "createdAt": "2020-09-02T11:11:45Z", "commit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMTo0NVrOHLqPyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMTo0NVrOHLqPyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4ODU1Mw==", "bodyText": "ahh, and here again", "url": "https://github.com/metasfresh/metasfresh/pull/9876#discussion_r481988553", "createdAt": "2020-09-02T11:11:45Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -236,6 +238,7 @@ private void allocateInvoiceAgainstCreditMemo(final I_C_Invoice creditMemo)\n \t\t\t// Allocate the minimum between parent invoice open amt and what is left of the creditMemo's grand Total\n \t\t\tinvoiceBL.allocateCreditMemo(parentInvoice, creditMemo, amtToAllocate);\n \t\t}\n+\t\ttestAndMarkAsPaid(creditMemo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzE2Mjc4", "url": "https://github.com/metasfresh/metasfresh/pull/9876#pullrequestreview-480716278", "createdAt": "2020-09-02T11:12:56Z", "commit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMjo1NlrOHLqR6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMjo1NlrOHLqR6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTA5Nw==", "bodyText": "and again", "url": "https://github.com/metasfresh/metasfresh/pull/9876#discussion_r481989097", "createdAt": "2020-09-02T11:12:56Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -293,20 +296,22 @@ private void linkInvoiceToPaymentIfNeeded(final I_C_Invoice invoice)\n \t\t\tpaymentDAO.save(payment);\n \n \t\t\tallocationBL.autoAllocateSpecificPayment(invoice, payment, true);\n+\t\t\ttestAndMarkAsPaid(invoice);\n \t\t}\n \t}\n \n-\tprivate void allocateInvoiceAgainstPaymentIfNeeded(final I_C_Invoice invoice)\n+\tprivate void allocateInvoiceAgainstPaymentIfNeeded(@NonNull final I_C_Invoice invoice)\n \t{\n \t\tfinal I_C_Order order = invoice.getC_Order();\n \t\tif (paymentBL.canAllocateOrderPaymentToInvoice(order))\n \t\t{\n \t\t\tfinal I_C_Payment payment = order.getC_Payment();\n \t\t\tallocationBL.autoAllocateSpecificPayment(invoice, payment, true);\n+\t\t\ttestAndMarkAsPaid(invoice);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNzE2NDA3", "url": "https://github.com/metasfresh/metasfresh/pull/9876#pullrequestreview-480716407", "createdAt": "2020-09-02T11:13:09Z", "commit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMzoxMFrOHLqSQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxMToxMzoxMFrOHLqSQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTk4OTE4NQ==", "bodyText": "and again", "url": "https://github.com/metasfresh/metasfresh/pull/9876#discussion_r481989185", "createdAt": "2020-09-02T11:13:10Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/invoice/interceptor/C_Invoice.java", "diffHunk": "@@ -293,20 +296,22 @@ private void linkInvoiceToPaymentIfNeeded(final I_C_Invoice invoice)\n \t\t\tpaymentDAO.save(payment);\n \n \t\t\tallocationBL.autoAllocateSpecificPayment(invoice, payment, true);\n+\t\t\ttestAndMarkAsPaid(invoice);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53c5cf3f6f44083a422a82ec088938ad82a92e2a"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b8f236560b64f45bea0448a697f0bd6966cf8be", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/3b8f236560b64f45bea0448a697f0bd6966cf8be", "committedDate": "2020-09-03T04:46:59Z", "message": "Fix possible timing problem for C_Invoice allocation\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0d732f8b79933f68e57a3afd320df976f380ab4", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/e0d732f8b79933f68e57a3afd320df976f380ab4", "committedDate": "2020-09-03T04:46:59Z", "message": "Use field for service access\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0968b6790793f57020a6b138da8165373148a4cb", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/0968b6790793f57020a6b138da8165373148a4cb", "committedDate": "2020-09-03T04:47:19Z", "message": "Fix NPE\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5f2575379d2a352d30c060841be93d61e0f1758", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/d5f2575379d2a352d30c060841be93d61e0f1758", "committedDate": "2020-09-03T04:47:22Z", "message": "Add nullability annotations\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d75273f60b4dbf1dbedf61e4dd082ef0c55b217", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/2d75273f60b4dbf1dbedf61e4dd082ef0c55b217", "committedDate": "2020-09-03T04:47:22Z", "message": "Add test which checks for null\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09a235b8ae98532f2d8685c33107471e73523d5b", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/09a235b8ae98532f2d8685c33107471e73523d5b", "committedDate": "2020-09-03T04:47:22Z", "message": "Add a BIG FIXME\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64b48fbf0b9d5da622cc880bd8a2aba74416ca6a", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/64b48fbf0b9d5da622cc880bd8a2aba74416ca6a", "committedDate": "2020-09-03T04:46:07Z", "message": "Add a BIG FIXME\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}, "afterCommit": {"oid": "09a235b8ae98532f2d8685c33107471e73523d5b", "author": {"user": {"login": "TheBestPessimist", "name": "TheBestPessimist"}}, "url": "https://github.com/metasfresh/metasfresh/commit/09a235b8ae98532f2d8685c33107471e73523d5b", "committedDate": "2020-09-03T04:47:22Z", "message": "Add a BIG FIXME\n\nhttps://github.com/metasfresh/metasfresh/issues/7171"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3156, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}