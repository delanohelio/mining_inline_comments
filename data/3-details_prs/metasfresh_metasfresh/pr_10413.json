{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2MDMzNjkw", "number": 10413, "title": "Gh10412", "bodyText": "#10412", "createdAt": "2020-12-10T15:49:34Z", "url": "https://github.com/metasfresh/metasfresh/pull/10413", "merged": true, "mergeCommit": {"oid": "60742dcf2507c7aafadcc8c270ef744eaf2e6073"}, "closed": true, "closedAt": "2020-12-18T12:06:13Z", "author": {"login": "dragospodariu96"}, "timelineItems": {"totalCount": 29, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk1UybgH2gAyNTM2MDMzNjkwOmI4NDllNWUzZGM1ZDM0ODIyZDZhMjIxZTIwNjhhMzZlZDI2ODI4Nzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnVta9AH2gAyNTM2MDMzNjkwOmI5OTU2YzdkM2VlM2JlZGY4ZjM4M2I5N2E5ODA1ODUwOTljYWUwZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b849e5e3dc5d34822d6a221e2068a36ed2682877", "author": {"user": {"login": "dragospodariu96", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/b849e5e3dc5d34822d6a221e2068a36ed2682877", "committedDate": "2020-12-10T15:46:11Z", "message": "#10412\n - Added HaddexCheck, DateHaddexCheck and HaddexControlNr columns to m_product table\n - Added fields to product window\n - added sys config MAX_HADDEX_DATE\n - added error msg\n - when trying to add a product to a sales orderline, if current date - product.haddexcheckdate (in months) > the added sys config, throw error msg."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34ffe1fa791b92a1b2c39d6a98f0034807f81246", "author": {"user": {"login": "dragospodariu96", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/34ffe1fa791b92a1b2c39d6a98f0034807f81246", "committedDate": "2020-12-10T15:48:00Z", "message": "#10412\n  - Added sales order check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2", "author": {"user": {"login": "dragospodariu96", "name": null}}, "url": "https://github.com/metasfresh/metasfresh/commit/0d81b6f3e8f26b45ff6227a3f25882876cd1baf2", "committedDate": "2020-12-11T12:22:53Z", "message": "#10412\n - Update Sys Config Name"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzU4Mzgz", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-552358383", "createdAt": "2020-12-15T11:31:21Z", "commit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMToyMVrOIGGU7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMToyMVrOIGGU7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2NjAyOQ==", "bodyText": "pls use AdMessageKey instead of String", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r543266029", "createdAt": "2020-12-15T11:31:21Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -66,6 +74,12 @@\n \tprivate final OrderGroupCompensationChangesHandler groupChangesHandler;\n \n \tpublic static final String ERR_NEGATIVE_QTY_RESERVED = \"MSG_NegativeQtyReserved\";\n+\tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE = \"MAX_HADDEX_AGE_IN_MONTHS\";\n+\tprivate static final String MSG_HADDEX_CHECK_ERROR = \"de.metas.base.producthadexerror\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzU5NDg2", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-552359486", "createdAt": "2020-12-15T11:32:53Z", "commit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMjo1NFrOIGGYqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMjo1NFrOIGGYqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2Njk4NA==", "bodyText": "rename method to getMaxHaddexAgeInMonths", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r543266984", "createdAt": "2020-12-15T11:32:54Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -126,6 +140,37 @@ public void setQtyEnteredInPriceUOM(final I_C_OrderLine orderLine)\n \t\torderLine.setQtyEnteredInPriceUOM(qtyEnteredInPriceUOM);\n \t}\n \n+\t@ModelChange(timings = { ModelValidator.TYPE_BEFORE_NEW,\n+\t\t\tModelValidator.TYPE_BEFORE_CHANGE\n+\t}, ifColumnsChanged = {\n+\t\t\tI_C_OrderLine.COLUMNNAME_M_Product_ID\n+\t})\n+\tpublic void checkHaddexDate(final I_C_OrderLine orderLine)\n+\t{\n+\t\tif (!orderDAO.getById(OrderId.ofRepoId(orderLine.getC_Order_ID())).isSOTrx())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal I_M_Product product = productDAO.getById(orderLine.getM_Product_ID());\n+\n+\t\tif (product.isHaddexCheck() && product.getDateHaddexCheck() != null)\n+\t\t{\n+\t\t\tfinal long hadexAllowedDifference = Math.abs(ChronoUnit.MONTHS.between(SystemTime.asZonedDateTime(),\n+\t\t\t\t\tTimeUtil.asZonedDateTime(product.getDateHaddexCheck())));\n+\t\t\tif (hadexAllowedDifference > getMaxHaddexAge(orderLine.getAD_Client_ID(), orderLine.getAD_Org_ID()))\n+\t\t\t{\n+\t\t\t\tthrow new AdempiereException(MSG_HADDEX_CHECK_ERROR).markAsUserValidationError();\n+\t\t\t}\n+\t\t}\n+\n+\t}\n+\n+\tprivate int getMaxHaddexAge(int clientID, int orgID)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzU5NzQ0", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-552359744", "createdAt": "2020-12-15T11:33:15Z", "commit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMzoxNVrOIGGZXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozMzoxNVrOIGGZXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI2NzE2NA==", "bodyText": "rename to SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r543267164", "createdAt": "2020-12-15T11:33:15Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -66,6 +74,12 @@\n \tprivate final OrderGroupCompensationChangesHandler groupChangesHandler;\n \n \tpublic static final String ERR_NEGATIVE_QTY_RESERVED = \"MSG_NegativeQtyReserved\";\n+\tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE = \"MAX_HADDEX_AGE_IN_MONTHS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d81b6f3e8f26b45ff6227a3f25882876cd1baf2"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c3edfd5ae20fd33cd260d991a56dbf61c2a3640", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/1c3edfd5ae20fd33cd260d991a56dbf61c2a3640", "committedDate": "2020-12-16T12:04:36Z", "message": "Changed fields two fields: SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS  and MSG_HADDEX_CHECK_ERROR;   and two methods: checkHaddexDate and getMaxHaddexAgeInMonths"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNzE4Njc2", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-553718676", "createdAt": "2020-12-16T14:08:11Z", "commit": {"oid": "1c3edfd5ae20fd33cd260d991a56dbf61c2a3640"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNDowODoxMlrOIHHA_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNDowODoxMlrOIHHA_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDMyNTg4Nw==", "bodyText": "why is the product.getDateHaddexCheck() no longer used?", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r544325887", "createdAt": "2020-12-16T14:08:12Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -156,19 +157,22 @@ public void checkHaddexDate(final I_C_OrderLine orderLine)\n \n \t\tif (product.isHaddexCheck() && product.getDateHaddexCheck() != null)\n \t\t{\n-\t\t\tfinal long hadexAllowedDifference = Math.abs(ChronoUnit.MONTHS.between(SystemTime.asZonedDateTime(),\n-\t\t\t\t\tTimeUtil.asZonedDateTime(product.getDateHaddexCheck())));\n-\t\t\tif (hadexAllowedDifference > getMaxHaddexAge(orderLine.getAD_Client_ID(), orderLine.getAD_Org_ID()))\n+\t\t\tfinal long differenceBetweenNowAndPromisedDateInMonths = Math.abs(\n+\t\t\t\t\tChronoUnit.MONTHS.between(\n+\t\t\t\t\t\t\tSystemTime.asZonedDateTime(),\n+\t\t\t\t\t\t\tTimeUtil.asZonedDateTime(orderLine.getDatePromised())\n+\t\t\t\t\t\t\t));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c3edfd5ae20fd33cd260d991a56dbf61c2a3640"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe9cc922284eaa257e1515b58c617c87b1add30", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/8fe9cc922284eaa257e1515b58c617c87b1add30", "committedDate": "2020-12-16T17:35:39Z", "message": "Changing the differenceBetweenHaddexCheckDateAndPromisedDateInMonths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199ebb4fbace1e1a298a0181f5e72e2a0d1f5f6e", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/199ebb4fbace1e1a298a0181f5e72e2a0d1f5f6e", "committedDate": "2020-12-16T18:20:46Z", "message": "Adding messagens, translations, and sysconfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/b59a163b603236135f5306c34dc1a8342466e053", "committedDate": "2020-12-17T12:26:05Z", "message": "Updating key for error message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjExNzU3", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-554611757", "createdAt": "2020-12-17T13:40:30Z", "commit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0MDozMFrOIH2FaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0MDozMFrOIH2FaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5NzA2NQ==", "bodyText": "this sysconfig was already added by backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5574550_sys_gh10412HaddexColumnsToProductTableAndSysConfigsAndErrMsgAndProductWindowAdjustments.sql\nThat's why this script is failing.", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545097065", "createdAt": "2020-12-17T13:40:30Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql", "diffHunk": "@@ -0,0 +1,5 @@\n+-- 2020-12-16T13:50:13.970Z\n+-- URL zum Konzept\n+INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If the current date - the value from the haddex date column of a product is bigger than the value from this sys config so that product can''t be added to a sales orderline. This value must be in months.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')\n+;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjEzNjMx", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-554613631", "createdAt": "2020-12-17T13:42:38Z", "commit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0MjozOFrOIH2LqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0MjozOFrOIH2LqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5ODY2NA==", "bodyText": "See backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5574550_sys_gh10412HaddexColumnsToProductTableAndSysConfigsAndErrMsgAndProductWindowAdjustments.sql.\nDragos already added an AD_Message with Value=de.metas.base.producthadexerror.\nI prefer your naming, i.e. de.metas.order.producthadexerror but in this case we have to remove the AD_Message from previous script.\nElse we will add an unused AD_Message record which would make harder to maintain.", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545098664", "createdAt": "2020-12-17T13:42:38Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575090_sys_gh10412AddMessageAndTranslations.sql", "diffHunk": "@@ -0,0 +1,35 @@\n+-- 2020-12-16T13:17:59.005Z\n+-- URL zum Konzept\n+INSERT INTO AD_Message (AD_Client_ID,AD_Message_ID,AD_Org_ID,Created,CreatedBy,EntityType,IsActive,MsgText,MsgType,Updated,UpdatedBy,Value) VALUES (0,545019,0,TO_TIMESTAMP('2020-12-16 10:17:56','YYYY-MM-DD HH24:MI:SS'),100,'U','Y','Cannot add product due haddex check','E',TO_TIMESTAMP('2020-12-16 10:17:56','YYYY-MM-DD HH24:MI:SS'),100,'de.metas.order.producthadexerror1')\n+;\n+\n+-- 2020-12-16T13:17:59.234Z\n+-- URL zum Konzept\n+INSERT INTO AD_Message_Trl (AD_Language,AD_Message_ID, MsgText,MsgTip, IsTranslated,AD_Client_ID,AD_Org_ID,Created,Createdby,Updated,UpdatedBy) SELECT l.AD_Language, t.AD_Message_ID, t.MsgText,t.MsgTip, 'N',t.AD_Client_ID,t.AD_Org_ID,t.Created,t.Createdby,t.Updated,t.UpdatedBy FROM AD_Language l, AD_Message t WHERE l.IsActive='Y'AND (l.IsSystemLanguage='Y') AND t.AD_Message_ID=545019 AND NOT EXISTS (SELECT 1 FROM AD_Message_Trl tt WHERE tt.AD_Language=l.AD_Language AND tt.AD_Message_ID=t.AD_Message_ID)\n+;\n+\n+-- 2020-12-16T13:19:25.696Z\n+-- URL zum Konzept\n+UPDATE AD_Message SET Value='de.metas.order.producthadexerror',Updated=TO_TIMESTAMP('2020-12-16 10:19:25','YYYY-MM-DD HH24:MI:SS'),UpdatedBy=100 WHERE AD_Message_ID=545019", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjE0ODMz", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-554614833", "createdAt": "2020-12-17T13:44:04Z", "commit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0NDowNFrOIH2PWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0NDowNFrOIH2PWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5OTYwOQ==", "bodyText": "the string from here shall match with the AD_Message.Value.\nElse, no message will be found.", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545099609", "createdAt": "2020-12-17T13:44:04Z", "author": {"login": "teosarca"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -66,6 +74,13 @@\n \tprivate final OrderGroupCompensationChangesHandler groupChangesHandler;\n \n \tpublic static final String ERR_NEGATIVE_QTY_RESERVED = \"MSG_NegativeQtyReserved\";\n+\tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS = \"MAX_HADDEX_AGE_IN_MONTHS\";\n+\tprivate static final AdMessageKey MSG_HADDEX_CHECK_ERROR = AdMessageKey.of(\"de.metas.order.model.interceptor.producthadexerror\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjE1NTY4", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-554615568", "createdAt": "2020-12-17T13:44:56Z", "commit": {"oid": "b59a163b603236135f5306c34dc1a8342466e053"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be79685c9dc7072de82b32d50d61a4d508c23f83", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/be79685c9dc7072de82b32d50d61a4d508c23f83", "committedDate": "2020-12-17T14:19:30Z", "message": "Updating sysconfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6538b33e697784f88b8fba21c9d1a705ee3c9d68", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/6538b33e697784f88b8fba21c9d1a705ee3c9d68", "committedDate": "2020-12-17T14:26:36Z", "message": "Solving duplicated sysconfig and message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32d5e6882fdb21f74d8b3edda071f94ba42c514c", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/32d5e6882fdb21f74d8b3edda071f94ba42c514c", "committedDate": "2020-12-17T14:27:54Z", "message": "Updating MessageKey as teo suggested"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389be64b1d53e397c12c2a7185541048bc74d133", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/389be64b1d53e397c12c2a7185541048bc74d133", "committedDate": "2020-12-17T16:39:23Z", "message": "Updating MessageKey"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d599ff2854f3676ebab2a8ef649bc450e81b3031", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/d599ff2854f3676ebab2a8ef649bc450e81b3031", "committedDate": "2020-12-17T19:05:00Z", "message": "Updating AD_Messages and  AD_Message_Trl. de_DE must be the default!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0OTIyMzIx", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-554922321", "createdAt": "2020-12-17T19:31:20Z", "commit": {"oid": "d599ff2854f3676ebab2a8ef649bc450e81b3031"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxOTozMToyMFrOIIFdOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxOTozNDoyOVrOIIFkrw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM0ODkyMQ==", "bodyText": "I'm not 100% sure that the order line already has the right DatePromised on beforeNew or beforeChange.\nTherefor i think it's better if you take the DatePromised valud from the C_Order which you load in line 151", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545348921", "createdAt": "2020-12-17T19:31:20Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -126,6 +141,42 @@ public void setQtyEnteredInPriceUOM(final I_C_OrderLine orderLine)\n \t\torderLine.setQtyEnteredInPriceUOM(qtyEnteredInPriceUOM);\n \t}\n \n+\t@ModelChange(timings = { ModelValidator.TYPE_BEFORE_NEW,\n+\t\t\tModelValidator.TYPE_BEFORE_CHANGE\n+\t}, ifColumnsChanged = {\n+\t\t\tI_C_OrderLine.COLUMNNAME_M_Product_ID\n+\t})\n+\tpublic void checkHaddexDate(final I_C_OrderLine orderLine)\n+\t{\n+\t\tif (!orderDAO.getById(OrderId.ofRepoId(orderLine.getC_Order_ID())).isSOTrx())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal I_M_Product product = productDAO.getById(orderLine.getM_Product_ID());\n+\n+\t\tif (product.isHaddexCheck() && product.getDateHaddexCheck() != null)\n+\t\t{\n+\t\t\tfinal long differenceBetweenHaddexCheckDateAndPromisedDateInMonths = Math.abs(\n+\t\t\t\t\tChronoUnit.MONTHS.between(\n+\t\t\t\t\t\t\tTimeUtil.asZonedDateTime(product.getDateHaddexCheck()),\n+\t\t\t\t\t\t\tTimeUtil.asZonedDateTime(orderLine.getDatePromised())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d599ff2854f3676ebab2a8ef649bc450e81b3031"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTM1MDgzMQ==", "bodyText": "please revise this AD_SysConfig's description.", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545350831", "createdAt": "2020-12-17T19:34:29Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql", "diffHunk": "@@ -0,0 +1,5 @@\n+-- 2020-12-16T13:50:13.970Z\n+-- URL zum Konzept\n+INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If the current date - the value from the haddex date column of a product is bigger than the value from this sys config so that product can''t be added to a sales orderline. This value must be in months.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d599ff2854f3676ebab2a8ef649bc450e81b3031"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e637d03571df2cf7058d3eccd1270cd9a0bb68e", "author": {"user": {"login": "arthurlmf", "name": "Arthur Farias"}}, "url": "https://github.com/metasfresh/metasfresh/commit/3e637d03571df2cf7058d3eccd1270cd9a0bb68e", "committedDate": "2020-12-18T09:08:41Z", "message": "Updating sysconfig message and using order instead orderline to access DatePromised."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzY1MDE4", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-555365018", "createdAt": "2020-12-18T10:20:24Z", "commit": {"oid": "3e637d03571df2cf7058d3eccd1270cd9a0bb68e"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoyMDoyNVrOIIdIww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDoyNzoxMVrOIIdXEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTczNjg5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If the order promised date - the value from the haddex date column of a product is bigger than the value from this sys config so that product can''t be added to a sales orderline. This value must be in months.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')\n          \n          \n            \n            INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If a sales order''s promised date is more than the given number of months after after a product''s last haddex-check, then the product can''t be added to the order. A value less than 1 disables the check.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545736899", "createdAt": "2020-12-18T10:20:25Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql", "diffHunk": "@@ -1,5 +1,5 @@\n -- 2020-12-16T13:50:13.970Z\n -- URL zum Konzept\n-INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If the current date - the value from the haddex date column of a product is bigger than the value from this sys config so that product can''t be added to a sales orderline. This value must be in months.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')\n+INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If the order promised date - the value from the haddex date column of a product is bigger than the value from this sys config so that product can''t be added to a sales orderline. This value must be in months.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e637d03571df2cf7058d3eccd1270cd9a0bb68e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc0MDU2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \t\treturn sysConfigBL.getIntValue(SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS, 24, clientID, orgID);\n          \n          \n            \n            \t\tfinal int months = sysConfigBL.getIntValue(SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS, 24, clientID, orgID);\n          \n          \n            \n            \t\tif (months > 0)\n          \n          \n            \n            \t\t{\n          \n          \n            \n            \t\t\treturn months;\n          \n          \n            \n            \t\t}\n          \n          \n            \n            \t\treturn Integer.MAX_VALUE;", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545740563", "createdAt": "2020-12-18T10:27:11Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -126,6 +141,43 @@ public void setQtyEnteredInPriceUOM(final I_C_OrderLine orderLine)\n \t\torderLine.setQtyEnteredInPriceUOM(qtyEnteredInPriceUOM);\n \t}\n \n+\t@ModelChange(timings = { ModelValidator.TYPE_BEFORE_NEW,\n+\t\t\tModelValidator.TYPE_BEFORE_CHANGE\n+\t}, ifColumnsChanged = {\n+\t\t\tI_C_OrderLine.COLUMNNAME_M_Product_ID\n+\t})\n+\tpublic void checkHaddexDate(final I_C_OrderLine orderLine)\n+\t{\n+\t\tfinal I_C_Order order = orderDAO.getById(OrderId.ofRepoId(orderLine.getC_Order_ID()));\n+\t\tif (!order.isSOTrx())\n+\t\t{\n+\t\t\treturn;\n+\t\t}\n+\n+\t\tfinal I_M_Product product = productDAO.getById(orderLine.getM_Product_ID());\n+\n+\t\tif (product.isHaddexCheck() && product.getDateHaddexCheck() != null)\n+\t\t{\n+\t\t\tfinal long differenceBetweenHaddexCheckDateAndPromisedDateInMonths = Math.abs(\n+\t\t\t\t\tChronoUnit.MONTHS.between(\n+\t\t\t\t\t\t\tTimeUtil.asZonedDateTime(product.getDateHaddexCheck()),\n+\t\t\t\t\t\t\tTimeUtil.asZonedDateTime(order.getDatePromised())\n+\t\t\t\t\t\t\t));\n+\n+\n+\t\t\tif (differenceBetweenHaddexCheckDateAndPromisedDateInMonths > getMaxHaddexAgeInMonths(orderLine.getAD_Client_ID(), orderLine.getAD_Org_ID()))\n+\t\t\t{\n+\t\t\t\tthrow new AdempiereException(MSG_HADDEX_CHECK_ERROR).markAsUserValidationError();\n+\t\t\t}\n+\t\t}\n+\n+\t}\n+\n+\tprivate int getMaxHaddexAgeInMonths(int clientID, int orgID)\n+\t{\n+\t\treturn sysConfigBL.getIntValue(SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS, 24, clientID, orgID);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e637d03571df2cf7058d3eccd1270cd9a0bb68e"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37b462a29fae974857c5aede638b8466a70faf5d", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/37b462a29fae974857c5aede638b8466a70faf5d", "committedDate": "2020-12-18T10:29:55Z", "message": "Update backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3a57e758bc3a5c2d78808113e0b9feea28b2aba", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/c3a57e758bc3a5c2d78808113e0b9feea28b2aba", "committedDate": "2020-12-18T10:30:01Z", "message": "Update backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MzcyMTAw", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-555372100", "createdAt": "2020-12-18T10:30:11Z", "commit": {"oid": "c3a57e758bc3a5c2d78808113e0b9feea28b2aba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1Mzc2MzUw", "url": "https://github.com/metasfresh/metasfresh/pull/10413#pullrequestreview-555376350", "createdAt": "2020-12-18T10:36:26Z", "commit": {"oid": "c3a57e758bc3a5c2d78808113e0b9feea28b2aba"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDozNjoyNlrOIIdpqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMDozNzowOVrOIIdrPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc0NTMyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            \tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS = \"MAX_HADDEX_AGE_IN_MONTHS\";\n          \n          \n            \n            \tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS = \"de.metas.order.MAX_HADDEX_AGE_IN_MONTHS\";", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545745323", "createdAt": "2020-12-18T10:36:26Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java", "diffHunk": "@@ -66,6 +74,13 @@\n \tprivate final OrderGroupCompensationChangesHandler groupChangesHandler;\n \n \tpublic static final String ERR_NEGATIVE_QTY_RESERVED = \"MSG_NegativeQtyReserved\";\n+\tprivate static final String SYS_CONFIG_MAX_HADDEX_AGE_IN_MONTHS = \"MAX_HADDEX_AGE_IN_MONTHS\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a57e758bc3a5c2d78808113e0b9feea28b2aba"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc0NTcyNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If a sales order''s promised date is more than the given number of months after after a product''s last haddex-check, then the product can''t be added to the order. A value less than 1 disables the check.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')\n          \n          \n            \n            INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If a sales order''s promised date is more than the given number of months after after a product''s last haddex-check, then the product can''t be added to the order. A value less than 1 disables the check.','D','Y','de.metas.order.MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')", "url": "https://github.com/metasfresh/metasfresh/pull/10413#discussion_r545745725", "createdAt": "2020-12-18T10:37:09Z", "author": {"login": "metas-ts"}, "path": "backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql", "diffHunk": "@@ -0,0 +1,4 @@\n+-- 2020-12-16T13:50:13.970Z\n+-- URL zum Konzept\n+INSERT INTO AD_SysConfig (AD_Client_ID,AD_Org_ID,AD_SysConfig_ID,ConfigurationLevel,Created,CreatedBy,Description,EntityType,IsActive,Name,Updated,UpdatedBy,Value) VALUES (0,0,541351,'O',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'If a sales order''s promised date is more than the given number of months after after a product''s last haddex-check, then the product can''t be added to the order. A value less than 1 disables the check.','D','Y','MAX_HADDEX_AGE_IN_MONTHS',TO_TIMESTAMP('2020-12-16 10:50:11','YYYY-MM-DD HH24:MI:SS'),100,'24')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3a57e758bc3a5c2d78808113e0b9feea28b2aba"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f90bff80601c8a64c38be43ad548802fae691aa7", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/f90bff80601c8a64c38be43ad548802fae691aa7", "committedDate": "2020-12-18T10:37:42Z", "message": "Update backend/de.metas.adempiere.adempiere/migration/src/main/sql/postgresql/system/10-de.metas.adempiere/5575110_sys_gh10412_AddSysconfig.sql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9956c7d3ee3bedf8f383b97a980585099cae0f4", "author": {"user": {"login": "metas-ts", "name": "Tobias Sch\u00f6neberg"}}, "url": "https://github.com/metasfresh/metasfresh/commit/b9956c7d3ee3bedf8f383b97a980585099cae0f4", "committedDate": "2020-12-18T10:37:54Z", "message": "Update backend/de.metas.business/src/main/java/de/metas/order/model/interceptor/C_OrderLine.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2967, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}