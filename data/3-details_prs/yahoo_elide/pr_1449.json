{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUyNzY1MjQ3", "number": 1449, "title": "Dynamic config schema validation; Read resources from jar", "bodyText": "Authored-by: AvaniMakwana\nOne of the multiple PRs to support  #1178\nDescription\n\nAdd Table, Security & variable config validation against schema\nAbility to read model config from resources\n\nMotivation and Context\nPlease refer #1178\nHow Has This Been Tested?\nUnit tests have been included.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-07-19T20:44:37Z", "url": "https://github.com/yahoo/elide/pull/1449", "merged": true, "mergeCommit": {"oid": "36fc33495c3e45ec5ffa4d452b391fe885acf1e8"}, "closed": true, "closedAt": "2020-08-07T18:31:19Z", "author": {"login": "AvaniMakwana"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2jPZKgH2gAyNDUyNzY1MjQ3OjVhMTJjNjFhNGEwNzUyZGYzZGZkMmIzZTU5YmJmNGRkNzE0OTdmNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8nSSwgH2gAyNDUyNzY1MjQ3OjVlMDYxYzBjZTJiZTU1MTNjODI5ZWJiZmRkODExODM3MDJhYjJlNGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a12c61a4a0752df3dfd2b3e59bbf4dd71497f50", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/5a12c61a4a0752df3dfd2b3e59bbf4dd71497f50", "committedDate": "2020-07-19T20:41:29Z", "message": "schema validation\n\nresource from classpath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a4c4a8ae7d3a16ac5a9e721503ca7f67df10826", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8a4c4a8ae7d3a16ac5a9e721503ca7f67df10826", "committedDate": "2020-07-20T02:13:16Z", "message": "test update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d48b4bf1517376513109fd37072e2fd81226570", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9d48b4bf1517376513109fd37072e2fd81226570", "committedDate": "2020-07-22T04:11:51Z", "message": "added testcase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7796a3edef0c36d222221d48ecfa7f5ac16403b2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/7796a3edef0c36d222221d48ecfa7f5ac16403b2", "committedDate": "2020-07-24T04:36:19Z", "message": "table config resource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a3b20d80d33a221747ec6f0133637b938787504", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/7a3b20d80d33a221747ec6f0133637b938787504", "committedDate": "2020-07-24T07:31:00Z", "message": "variable/security optional"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c983f8fcff26b27bc0bce14509806a9dcd7d63a6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c983f8fcff26b27bc0bce14509806a9dcd7d63a6", "committedDate": "2020-07-27T03:46:36Z", "message": "code clean up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a61ba91f0205090b43eeacff867b01d7f4805b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/29a61ba91f0205090b43eeacff867b01d7f4805b", "committedDate": "2020-07-30T02:28:54Z", "message": "update readtableconfig"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4Nzg2NDU4", "url": "https://github.com/yahoo/elide/pull/1449#pullrequestreview-458786458", "createdAt": "2020-07-30T22:01:02Z", "commit": {"oid": "29a61ba91f0205090b43eeacff867b01d7f4805b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowMTowMlrOG51WCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowMzozNVrOG51aMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NjAxMQ==", "bodyText": "I think we can remove this function and also readConfigFile (see later comment).", "url": "https://github.com/yahoo/elide/pull/1449#discussion_r463296011", "createdAt": "2020-07-30T22:01:02Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/DynamicConfigHelpers.java", "diffHunk": "@@ -190,4 +156,40 @@ public static String readConfigFile(File configFile) {\n         }\n         return sb.toString();\n     }\n+\n+    /**\n+     * Read config from classpath.\n+     * @param resourcePath : path to resource\n+     * @return content of resource\n+     * @throws IOException\n+     */\n+    public static String readResource(String resourcePath) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a61ba91f0205090b43eeacff867b01d7f4805b"}, "originalPosition": 204}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5NzA3NQ==", "bodyText": "I feel like this is the best place to construct the spring resource URL with either file:// or resource://.\nthis.configDir value could actually be a URL containing file:// or resource:// and then used for loading security, variables, and tables (all using spring resource loader).", "url": "https://github.com/yahoo/elide/pull/1449#discussion_r463297075", "createdAt": "2020-07-30T22:03:35Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -53,11 +53,28 @@\n     private static final String SQL_SPLIT_REGEX = \"\\\\s+\";\n     private static final String SEMI_COLON = \";\";\n     private static final Pattern HANDLEBAR_REGEX = Pattern.compile(\"<%(.*?)%>\");\n+    private static final String RESOURCES = \"resources\";\n+    private static final int RESOURCE_LENGTH = 10; //\"resources/\".length()\n+    private static final String CLASSPATH_PATTERN = \"classpath*:\";\n+    private static final String FILEPATH_PATTERN = \"file://\";\n+    private static final String HJSON_EXTN = \"*.hjson\";\n \n     private ElideTableConfig elideTableConfig;\n     private ElideSecurityConfig elideSecurityConfig;\n     private Map<String, Object> variables;\n     private String configDir;\n+    private boolean configInClassPath;\n+\n+    public DynamicConfigValidator(String configDir) {\n+        File config = new File(configDir);\n+\n+        if (config.exists()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29a61ba91f0205090b43eeacff867b01d7f4805b"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "617be2947e50d422830169132d8496dca40ca44d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/617be2947e50d422830169132d8496dca40ca44d", "committedDate": "2020-08-03T05:32:27Z", "message": "update resource reading"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ff5800d5321a8bd746dcba4ae6f37c151a8a4e5", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/0ff5800d5321a8bd746dcba4ae6f37c151a8a4e5", "committedDate": "2020-08-03T05:39:10Z", "message": "minor update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c2f93de2eed911a6f58e3dfff04b6548ded94d8", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/1c2f93de2eed911a6f58e3dfff04b6548ded94d8", "committedDate": "2020-08-03T06:26:21Z", "message": "update to resourceMap"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYzNDQ3Mzky", "url": "https://github.com/yahoo/elide/pull/1449#pullrequestreview-463447392", "createdAt": "2020-08-07T16:31:05Z", "commit": {"oid": "1c2f93de2eed911a6f58e3dfff04b6548ded94d8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjozMTowNVrOG9gTzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wN1QxNjozNDoxNlrOG9gZ6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0NTY3OQ==", "bodyText": "Should forward slash here also be File.separator?", "url": "https://github.com/yahoo/elide/pull/1449#discussion_r467145679", "createdAt": "2020-08-07T16:31:05Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/Config.java", "diffHunk": "@@ -0,0 +1,47 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers;\n+\n+import java.io.File;\n+/**\n+ * Dynamic Config enum.\n+ */\n+public enum Config {\n+\n+    TABLE(\"table\",\n+          \"tables\" + File.separator,\n+          \"/elideTableSchema.json\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2f93de2eed911a6f58e3dfff04b6548ded94d8"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0NjIwMg==", "bodyText": "A method like this should either return false or throw an exception but not both.  Otherwise the contract is confusing.", "url": "https://github.com/yahoo/elide/pull/1449#discussion_r467146202", "createdAt": "2020-08-07T16:32:07Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/DynamicConfigSchemaValidator.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers;\n+\n+import com.fasterxml.jackson.databind.ObjectMapper;\n+import com.github.fge.jsonschema.core.exceptions.ProcessingException;\n+import com.github.fge.jsonschema.core.report.ProcessingReport;\n+import com.github.fge.jsonschema.main.JsonSchema;\n+import com.github.fge.jsonschema.main.JsonSchemaFactory;\n+\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.IOException;\n+import java.io.InputStreamReader;\n+import java.io.Reader;\n+\n+/**\n+ * Dynamic Model Schema validation.\n+ */\n+@Slf4j\n+public class DynamicConfigSchemaValidator {\n+\n+    private static final JsonSchemaFactory FACTORY = JsonSchemaFactory.byDefault();\n+    private JsonSchema tableSchema;\n+    private JsonSchema securitySchema;\n+    private JsonSchema variableSchema;\n+\n+    public DynamicConfigSchemaValidator() {\n+        tableSchema = loadSchema(Config.TABLE.getConfigSchema());\n+        securitySchema = loadSchema(Config.SECURITY.getConfigSchema());\n+        variableSchema = loadSchema(Config.VARIABLE.getConfigSchema());\n+    }\n+    /**\n+     *  Verify config against schema.\n+     * @param configType\n+     * @param jsonConfig\n+     * @return whether config is valid\n+     * @throws IOException\n+     * @throws ProcessingException\n+     */\n+    public boolean verifySchema(Config configType, String jsonConfig) throws IOException, ProcessingException {\n+        ProcessingReport results = null;\n+        boolean isSuccess = false;\n+\n+        switch (configType) {\n+        case TABLE :\n+            results = this.tableSchema.validate(new ObjectMapper().readTree(jsonConfig));\n+            break;\n+        case SECURITY :\n+            results = this.securitySchema.validate(new ObjectMapper().readTree(jsonConfig));\n+            break;\n+        case VARIABLE :\n+            results = this.variableSchema.validate(new ObjectMapper().readTree(jsonConfig));\n+            break;\n+        default :\n+            log.error(\"Not a valid config type :\" + configType);\n+            return false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2f93de2eed911a6f58e3dfff04b6548ded94d8"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NzE0NzI0MA==", "bodyText": "Why not just new HashMap<>?", "url": "https://github.com/yahoo/elide/pull/1449#discussion_r467147240", "createdAt": "2020-08-07T16:34:16Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -53,11 +56,29 @@\n     private static final String SQL_SPLIT_REGEX = \"\\\\s+\";\n     private static final String SEMI_COLON = \";\";\n     private static final Pattern HANDLEBAR_REGEX = Pattern.compile(\"<%(.*?)%>\");\n+    private static final String RESOURCES = \"resources\";\n+    private static final int RESOURCE_LENGTH = 10; //\"resources/\".length()\n+    private static final String CLASSPATH_PATTERN = \"classpath*:\";\n+    private static final String FILEPATH_PATTERN = \"file:\";\n+    private static final String HJSON_EXTN = \"**/*.hjson\";\n \n-    private ElideTableConfig elideTableConfig;\n-    private ElideSecurityConfig elideSecurityConfig;\n-    private Map<String, Object> variables;\n+    private ElideTableConfig elideTableConfig = new ElideTableConfig();\n+    private ElideSecurityConfig elideSecurityConfig = new ElideSecurityConfig();\n+    private Map<String, Object> variables = Collections.<String, Object>emptyMap();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1c2f93de2eed911a6f58e3dfff04b6548ded94d8"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e061c0ce2be5513c829ebbfdd81183702ab2e4e", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/5e061c0ce2be5513c829ebbfdd81183702ab2e4e", "committedDate": "2020-08-07T16:47:49Z", "message": "review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 901, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}