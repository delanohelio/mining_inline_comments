{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3MTU1MTE5", "number": 1569, "title": "Integration test for Security HJSON", "bodyText": "Description\nIntegration Test for Dynamic Security HJSON\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-02T22:05:09Z", "url": "https://github.com/yahoo/elide/pull/1569", "merged": true, "mergeCommit": {"oid": "4a1081dd6bd9b2ee320526735d01b0ea8a8fb253"}, "closed": true, "closedAt": "2020-10-06T21:40:12Z", "author": {"login": "rishi-aga"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOtulRgBqjM4MzU4MzYxNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP_bV5gFqTUwMzM3OTA2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f3848b601c59a73d9381bb49535424eb905d9627", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f3848b601c59a73d9381bb49535424eb905d9627", "committedDate": "2020-10-02T22:16:51Z", "message": "Minor Changes"}, "afterCommit": {"oid": "d144f0fb4bf908f9ff6f41d9677992bf25a7b2c2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d144f0fb4bf908f9ff6f41d9677992bf25a7b2c2", "committedDate": "2020-10-02T22:28:34Z", "message": "Integration test for Security HJSON"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601", "committedDate": "2020-10-02T22:32:25Z", "message": "Integration test for Security HJSON"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d144f0fb4bf908f9ff6f41d9677992bf25a7b2c2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d144f0fb4bf908f9ff6f41d9677992bf25a7b2c2", "committedDate": "2020-10-02T22:28:34Z", "message": "Integration test for Security HJSON"}, "afterCommit": {"oid": "dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601", "committedDate": "2020-10-02T22:32:25Z", "message": "Integration test for Security HJSON"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNjc3OTU1", "url": "https://github.com/yahoo/elide/pull/1569#pullrequestreview-501677955", "createdAt": "2020-10-05T01:04:26Z", "commit": {"oid": "dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMTowNDoyN1rOHcLaSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwMTowNDoyN1rOHcLaSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTMwOTEzMA==", "bodyText": "Does Handlebar allow to chain functions? would something like this work\n<%#replaceSpace<%#toUpperCase this%><%/toUpperCase%>%><%/replaceSpace%>", "url": "https://github.com/yahoo/elide/pull/1569#discussion_r499309130", "createdAt": "2020-10-05T01:04:27Z", "author": {"login": "moizarafat"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/resources/templates/security.hbs", "diffHunk": "@@ -8,10 +8,10 @@ package dynamicconfig.models;\n import com.yahoo.elide.annotation.SecurityCheck;\n import com.yahoo.elide.security.checks.prefab.Role.RoleMemberCheck;\n \n-@SecurityCheck(DynamicConfigOperationChecksPrincipalIs<%#titleCaseRemoveSpaces this%><%/titleCaseRemoveSpaces%>.PRINCIPAL_IS_<%#toUpperCase this%><%/toUpperCase%>)\n+@SecurityCheck(DynamicConfigOperationChecksPrincipalIs<%#titleCaseRemoveSpaces this%><%/titleCaseRemoveSpaces%>.PRINCIPAL_IS_<%#toUpperCaseReplaceSpace this%><%/toUpperCaseReplaceSpace%>)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc1d90e13b2bbca8fcdbca27071c0e7bbd9bc601"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad", "committedDate": "2020-10-05T16:05:04Z", "message": "Use temporary variable to store value in security.hbs to avoid repetition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjE5ODE0", "url": "https://github.com/yahoo/elide/pull/1569#pullrequestreview-502219814", "createdAt": "2020-10-05T16:20:53Z", "commit": {"oid": "d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMjEzNjMy", "url": "https://github.com/yahoo/elide/pull/1569#pullrequestreview-502213632", "createdAt": "2020-10-05T16:13:35Z", "commit": {"oid": "d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjoxMzozNVrOHckNrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNjoyMzo1OVrOHcknXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcxNTUwMA==", "bodyText": "Typo - Hjson instead of hjosn", "url": "https://github.com/yahoo/elide/pull/1569#discussion_r499715500", "createdAt": "2020-10-05T16:13:35Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/integration/AggregationDataStoreDynamicSecurityIT.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.datastores.aggregation.integration;\n+\n+import static com.yahoo.elide.core.EntityDictionary.NO_VERSION;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import com.yahoo.elide.Elide;\n+import com.yahoo.elide.ElideResponse;\n+import com.yahoo.elide.ElideSettingsBuilder;\n+import com.yahoo.elide.annotation.SecurityCheck;\n+import com.yahoo.elide.audit.TestAuditLogger;\n+import com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails;\n+import com.yahoo.elide.contrib.dynamicconfighelpers.compile.ElideDynamicEntityCompiler;\n+import com.yahoo.elide.core.EntityDictionary;\n+import com.yahoo.elide.core.HttpStatus;\n+import com.yahoo.elide.core.datastore.test.DataStoreTestHarness;\n+import com.yahoo.elide.datastores.aggregation.framework.AggregationDataStoreTestHarness;\n+import com.yahoo.elide.initialization.IntegrationTest;\n+import com.yahoo.elide.resources.SecurityContextUser;\n+import com.zaxxer.hikari.HikariConfig;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import javax.persistence.EntityManagerFactory;\n+import javax.persistence.Persistence;\n+import javax.sql.DataSource;\n+import javax.ws.rs.core.MultivaluedHashMap;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.core.SecurityContext;\n+\n+/**\n+ * Integration tests for Dynamic Configs with Security hjson.\n+ */\n+public class AggregationDataStoreDynamicSecurityIT extends IntegrationTest {\n+\n+    private final ElideDynamicEntityCompiler compiler =\n+                    AggregationDataStoreIntegrationTest.getCompiler(\"src/test/resources/configs_with_security_hjson\");\n+\n+    @Override\n+    protected DataStoreTestHarness createHarness() {\n+\n+        HikariConfig config = new HikariConfig(File.separator + \"jpah2db.properties\");\n+        DataSource defaultDataSource = new HikariDataSource(config);\n+        String defaultDialect = \"h2\";\n+        ConnectionDetails defaultConnectionDetails = new ConnectionDetails(defaultDataSource, defaultDialect);\n+\n+        Properties prop = new Properties();\n+        prop.put(\"javax.persistence.jdbc.driver\", config.getDriverClassName());\n+        prop.put(\"javax.persistence.jdbc.url\", config.getJdbcUrl());\n+        EntityManagerFactory emf = Persistence.createEntityManagerFactory(\"aggregationStore\", prop);\n+\n+        Map<String, ConnectionDetails> connectionDetailsMap = new HashMap<>();\n+        // Add connection details fetched from hjson\n+        connectionDetailsMap.putAll(compiler.getConnectionDetailsMap());\n+\n+        return new AggregationDataStoreTestHarness(emf, defaultConnectionDetails, connectionDetailsMap, compiler);\n+    }\n+\n+    @Test\n+    public void testSecurityHjosnWithAggregationModel() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcyMjA3Nw==", "bodyText": "Rather than testing at a lower level, you could look at TestAuthFilter and how it is used.  It might make sense to extend that in some way with a mock that can be controlled in the tests themselves.  Then you could also use Rest Assured here for more readable tests.", "url": "https://github.com/yahoo/elide/pull/1569#discussion_r499722077", "createdAt": "2020-10-05T16:23:59Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/integration/AggregationDataStoreDynamicSecurityIT.java", "diffHunk": "@@ -0,0 +1,162 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.datastores.aggregation.integration;\n+\n+import static com.yahoo.elide.core.EntityDictionary.NO_VERSION;\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+\n+import com.yahoo.elide.Elide;\n+import com.yahoo.elide.ElideResponse;\n+import com.yahoo.elide.ElideSettingsBuilder;\n+import com.yahoo.elide.annotation.SecurityCheck;\n+import com.yahoo.elide.audit.TestAuditLogger;\n+import com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails;\n+import com.yahoo.elide.contrib.dynamicconfighelpers.compile.ElideDynamicEntityCompiler;\n+import com.yahoo.elide.core.EntityDictionary;\n+import com.yahoo.elide.core.HttpStatus;\n+import com.yahoo.elide.core.datastore.test.DataStoreTestHarness;\n+import com.yahoo.elide.datastores.aggregation.framework.AggregationDataStoreTestHarness;\n+import com.yahoo.elide.initialization.IntegrationTest;\n+import com.yahoo.elide.resources.SecurityContextUser;\n+import com.zaxxer.hikari.HikariConfig;\n+import com.zaxxer.hikari.HikariDataSource;\n+\n+import org.junit.jupiter.api.Test;\n+\n+import java.io.File;\n+import java.security.Principal;\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.Properties;\n+\n+import javax.persistence.EntityManagerFactory;\n+import javax.persistence.Persistence;\n+import javax.sql.DataSource;\n+import javax.ws.rs.core.MultivaluedHashMap;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.core.SecurityContext;\n+\n+/**\n+ * Integration tests for Dynamic Configs with Security hjson.\n+ */\n+public class AggregationDataStoreDynamicSecurityIT extends IntegrationTest {\n+\n+    private final ElideDynamicEntityCompiler compiler =\n+                    AggregationDataStoreIntegrationTest.getCompiler(\"src/test/resources/configs_with_security_hjson\");\n+\n+    @Override\n+    protected DataStoreTestHarness createHarness() {\n+\n+        HikariConfig config = new HikariConfig(File.separator + \"jpah2db.properties\");\n+        DataSource defaultDataSource = new HikariDataSource(config);\n+        String defaultDialect = \"h2\";\n+        ConnectionDetails defaultConnectionDetails = new ConnectionDetails(defaultDataSource, defaultDialect);\n+\n+        Properties prop = new Properties();\n+        prop.put(\"javax.persistence.jdbc.driver\", config.getDriverClassName());\n+        prop.put(\"javax.persistence.jdbc.url\", config.getJdbcUrl());\n+        EntityManagerFactory emf = Persistence.createEntityManagerFactory(\"aggregationStore\", prop);\n+\n+        Map<String, ConnectionDetails> connectionDetailsMap = new HashMap<>();\n+        // Add connection details fetched from hjson\n+        connectionDetailsMap.putAll(compiler.getConnectionDetailsMap());\n+\n+        return new AggregationDataStoreTestHarness(emf, defaultConnectionDetails, connectionDetailsMap, compiler);\n+    }\n+\n+    @Test\n+    public void testSecurityHjosnWithAggregationModel() throws Exception {\n+\n+        SecurityContextUser operator = new SecurityContextUser(new SecurityContext() {\n+            @Override\n+            public boolean isUserInRole(String role) {\n+                switch (role) {\n+                    case \"admin\":\n+                        return false;\n+                    case \"operator\":\n+                        return true;\n+                    case \"guest user\":\n+                        return true;\n+                    default:\n+                        return false;\n+                }\n+            }\n+\n+            @Override\n+            public boolean isSecure() {\n+                return false;\n+            }\n+\n+            @Override\n+            public Principal getUserPrincipal() {\n+                return () -> \"1\";\n+            }\n+\n+            @Override\n+            public String getAuthenticationScheme() {\n+                return null;\n+            }\n+        });\n+\n+        SecurityContextUser admin = new SecurityContextUser(new SecurityContext() {\n+            @Override\n+            public boolean isUserInRole(String role) {\n+                switch (role) {\n+                    case \"admin\":\n+                        return true;\n+                    case \"operator\":\n+                        return true;\n+                    case \"guest user\":\n+                        return true;\n+                    default:\n+                        return false;\n+                }\n+            }\n+\n+            @Override\n+            public boolean isSecure() {\n+                return false;\n+            }\n+\n+            @Override\n+            public Principal getUserPrincipal() {\n+                return () -> \"1\";\n+            }\n+\n+            @Override\n+            public String getAuthenticationScheme() {\n+                return null;\n+            }\n+        });\n+\n+        EntityDictionary dictionary = new EntityDictionary(new HashMap<>());\n+        dictionary.addSecurityChecks(compiler.findAnnotatedClasses(SecurityCheck.class));\n+\n+        Elide elide = new Elide(new ElideSettingsBuilder(dataStore)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2c3a5fedf9586d51c2d28405d94b4ddc83e96ad"}, "originalPosition": 138}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c973eb01aadea01da31ff5e1c23a2bc5d2cd20b9", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c973eb01aadea01da31ff5e1c23a2bc5d2cd20b9", "committedDate": "2020-10-05T16:27:45Z", "message": "Review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1d1473da71b9bfd34e674a255d8fc82e12a0e4e", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/e1d1473da71b9bfd34e674a255d8fc82e12a0e4e", "committedDate": "2020-10-06T15:55:44Z", "message": "Mock working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57891d1395bd1588d5527c89de55a795720e2205", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/57891d1395bd1588d5527c89de55a795720e2205", "committedDate": "2020-10-06T17:18:20Z", "message": "Combine into 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abc35ae22971a4fadf45d7d7bb8070d679e44b31", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/abc35ae22971a4fadf45d7d7bb8070d679e44b31", "committedDate": "2020-10-06T17:54:35Z", "message": "CleanUp"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMzc5MDY1", "url": "https://github.com/yahoo/elide/pull/1569#pullrequestreview-503379065", "createdAt": "2020-10-06T21:39:59Z", "commit": {"oid": "abc35ae22971a4fadf45d7d7bb8070d679e44b31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 843, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}