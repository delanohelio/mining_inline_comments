{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2MTIyMjE2", "number": 1497, "title": "Support dynamic configuration for db connections", "bodyText": "One of the multiple PRs that will resolve #1465\nDescription\nDynamic configuration for db\nMotivation and Context\nPlease refer #1465\nHow Has This Been Tested?\nUnit tests have been included.\nExisting Tests Pass\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-08-11T13:57:35Z", "url": "https://github.com/yahoo/elide/pull/1497", "merged": true, "mergeCommit": {"oid": "d16c1b3e7e39f19a08001113e135be0025bc8c34"}, "closed": true, "closedAt": "2020-08-27T15:41:15Z", "author": {"login": "rishi-aga"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc98p1wAFqTQ2NTM5NTMxMg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDCCsxAFqTQ3NjgzMDE4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mzk1MzEy", "url": "https://github.com/yahoo/elide/pull/1497#pullrequestreview-465395312", "createdAt": "2020-08-11T20:15:28Z", "commit": {"oid": "c09baf3777f462dd8a13bc935d75c088746cbe2f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoxNToyOFrOG_HoNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoxNToyOFrOG_HoNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODgzODQ1NA==", "bodyText": "Please add a TODO comment here for the remaining work done in next PR.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r468838454", "createdAt": "2020-08-11T20:15:28Z", "author": {"login": "moizarafat"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/annotation/FromTable.java", "diffHunk": "@@ -25,4 +25,10 @@\n      * @return The table or view name.\n      */\n     String name();\n+\n+    /**\n+     * DB Connection Name for this table\n+     * @return String DB Connection Name\n+     */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c09baf3777f462dd8a13bc935d75c088746cbe2f"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1Mzk3NDY4", "url": "https://github.com/yahoo/elide/pull/1497#pullrequestreview-465397468", "createdAt": "2020-08-11T20:18:58Z", "commit": {"oid": "c09baf3777f462dd8a13bc935d75c088746cbe2f"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQyMDoxODo1OFrOG_Hu-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNDo0NjoxMFrOHA3c0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODg0MDE4NA==", "bodyText": "Not sure what is best - a single variables.hjson file for everything - or we have two separate like this structure.  Also, I wouldn't worry about non-sql right now - let's simplify this and just support sql.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r468840184", "createdAt": "2020-08-11T20:18:58Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/README.md", "diffHunk": "@@ -6,17 +6,28 @@ To build and run:\n ```text\n 1. mvn clean install\n 2. Execute Jar File :\n-   a) java -cp elide-contrib/elide-dynamic-config-helpers/target/elide-dynamic-config-*-jar-with-dependencies.jar com.yahoo.elide.contrib.dynamicconfighelpers.validator.DynamicConfigValidator --configDir <Path for Model Configs Directory>\n+   a) java -cp elide-contrib/elide-dynamic-config-helpers/target/elide-dynamic-config-*-jar-with-dependencies.jar com.yahoo.elide.contrib.dynamicconfighelpers.validator.DynamicConfigValidator --configDir <Path for Config Directory>\n    b) java -cp elide-contrib/elide-dynamic-config-helpers/target/elide-dynamic-config-*-jar-with-dependencies.jar com.yahoo.elide.contrib.dynamicconfighelpers.validator.DynamicConfigValidator --help\n ```\n-Expected Model Configs Directory Structure:\n+Expected Configs Directory Structure:\n ```text\n-\u251c\u2500\u2500 MODEL_CONFIG_DIR/\n-\u2502   \u251c\u2500\u2500 tables\n-\u2502   \u2502   \u251c\u2500\u2500 table1.hjson\n-\u2502   \u2502   \u251c\u2500\u2500 table2.hjson\n-\u2502   \u2502   \u251c\u2500\u2500 ...\n-\u2502   \u2502   \u251c\u2500\u2500 tableN.hjson\n-\u2502   \u251c\u2500\u2500 security.hjson (optional)\n-\u2502   \u251c\u2500\u2500 variables.hjson (optional)\n+\u251c\u2500\u2500 CONFIG_DIR/\n+\u2502   \u251c\u2500\u2500 models\n+\u2502   \u2502   \u251c\u2500\u2500 tables\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 table1.hjson\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 table2.hjson\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 ...\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 tableN.hjson\n+\u2502   \u2502   \u251c\u2500\u2500 security.hjson (optional)\n+\u2502   \u2502   \u251c\u2500\u2500 variables.hjson (optional)\n+\u2502   \u251c\u2500\u2500 db\n+\u2502   \u2502   \u251c\u2500\u2500 sql (optional)\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 db1.hjson\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 ...\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 dbN.hjson\n+\u2502   \u2502   \u251c\u2500\u2500 nonsql (optional)\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 db1.hjson\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 ...\n+\u2502   \u2502   \u2502   \u251c\u2500\u2500 dbN.hjson\n+\u2502   \u2502   \u251c\u2500\u2500 variables.hjson (optional)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c09baf3777f462dd8a13bc935d75c088746cbe2f"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDI0NA==", "bodyText": "What is the purpose of creating an uber-jar here?", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470210244", "createdAt": "2020-08-13T19:54:55Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/pom.xml", "diffHunk": "@@ -172,6 +172,23 @@\n                     <target>1.8</target>\n                 </configuration>\n             </plugin>\n+            <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n+                <artifactId>maven-assembly-plugin</artifactId>\n+                <executions>\n+                    <execution>\n+                        <phase>package</phase>\n+                        <goals>\n+                            <goal>single</goal>\n+                        </goals>\n+                    </execution>\n+                </executions>\n+                <configuration>\n+                    <descriptorRefs>\n+                        <descriptorRef>jar-with-dependencies</descriptorRef>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDQ3NA==", "bodyText": "We generally don't want to publish uber jars - as they create downstream problems.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470210474", "createdAt": "2020-08-13T19:55:12Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/pom.xml", "diffHunk": "@@ -172,6 +172,23 @@\n                     <target>1.8</target>\n                 </configuration>\n             </plugin>\n+            <plugin>\n+                <groupId>org.apache.maven.plugins</groupId>\n+                <artifactId>maven-assembly-plugin</artifactId>\n+                <executions>\n+                    <execution>\n+                        <phase>package</phase>\n+                        <goals>\n+                            <goal>single</goal>\n+                        </goals>\n+                    </execution>\n+                </executions>\n+                <configuration>\n+                    <descriptorRefs>\n+                        <descriptorRef>jar-with-dependencies</descriptorRef>", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMDI0NA=="}, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIxMTQ0OA==", "bodyText": "Why is called type here and dbConnection name in the other annotation?  Can we be consistent?", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470211448", "createdAt": "2020-08-13T19:57:06Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/annotation/FromSubquery.java", "diffHunk": "@@ -25,4 +25,11 @@\n      * @return The SQL subquery.\n      */\n     String sql();\n+\n+    /**\n+     * DB Connection Name for this query\n+     * @return String DB Connection Name\n+     */\n+    // TO DO\n+    String type() default \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzOTAzMA==", "bodyText": "I don't think we need to define this now.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470239030", "createdAt": "2020-08-13T20:48:00Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/model/ElideNonSQLDBConfig.java", "diffHunk": "@@ -0,0 +1,13 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.contrib.dynamicconfighelpers.model;\n+\n+/**\n+ * Elide SQL DB POJO.\n+ */\n+public class ElideNonSQLDBConfig extends ElideDBConfig {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MDU5OQ==", "bodyText": "Should this be Config.VARIABLE.getConfigPath?", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470660599", "createdAt": "2020-08-14T14:33:03Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -118,59 +132,108 @@ public void readAndValidateConfigs() throws IOException {\n     private void loadConfigMap() throws IOException {\n         PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver(\n                 this.getClass().getClassLoader());\n-        Resource[] modelResources = resolver.getResources(this.configDir);\n-        for (Resource resource : modelResources) {\n-            this.resourceMap.put(resource.getFilename(), resource);\n+        if (resolver.getResources(this.configDir).length == 0) {\n+            throw new IllegalStateException(this.configDir + \" : config path does not exist\");\n+        }\n+        int configDirURILength = resolver.getResources(this.configDir)[0].getURI().toString().length();\n+\n+        Resource[] hjsonResources = resolver.getResources(this.configDir + HJSON_EXTN);\n+        for (Resource resource : hjsonResources) {\n+            this.resourceMap.put(resource.getURI().toString().substring(configDirURILength), resource);\n         }\n     }\n \n     /**\n      * Read variable file config.\n-     * @return boolean true if variable config file exists else false\n-     * @throws IOException\n+     * @return Map<String, Object> A map containing all the variables if variable config exists else empty map\n      */\n-    private void readVariableConfig() throws IOException {\n-        String key = Config.VARIABLE.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            this.setVariables(DynamicConfigHelpers.stringToVariablesPojo(content));\n-            this.resourceMap.remove(Config.VARIABLE.getConfigPath());\n-        }\n+    private Map<String, Object> readVariableConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 132}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTMxMg==", "bodyText": "Again - can we use the static as before for the filter here?", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470661312", "createdAt": "2020-08-14T14:34:19Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -118,59 +132,108 @@ public void readAndValidateConfigs() throws IOException {\n     private void loadConfigMap() throws IOException {\n         PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver(\n                 this.getClass().getClassLoader());\n-        Resource[] modelResources = resolver.getResources(this.configDir);\n-        for (Resource resource : modelResources) {\n-            this.resourceMap.put(resource.getFilename(), resource);\n+        if (resolver.getResources(this.configDir).length == 0) {\n+            throw new IllegalStateException(this.configDir + \" : config path does not exist\");\n+        }\n+        int configDirURILength = resolver.getResources(this.configDir)[0].getURI().toString().length();\n+\n+        Resource[] hjsonResources = resolver.getResources(this.configDir + HJSON_EXTN);\n+        for (Resource resource : hjsonResources) {\n+            this.resourceMap.put(resource.getURI().toString().substring(configDirURILength), resource);\n         }\n     }\n \n     /**\n      * Read variable file config.\n-     * @return boolean true if variable config file exists else false\n-     * @throws IOException\n+     * @return Map<String, Object> A map containing all the variables if variable config exists else empty map\n      */\n-    private void readVariableConfig() throws IOException {\n-        String key = Config.VARIABLE.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            this.setVariables(DynamicConfigHelpers.stringToVariablesPojo(content));\n-            this.resourceMap.remove(Config.VARIABLE.getConfigPath());\n-        }\n+    private Map<String, Object> readVariableConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                return DynamicConfigHelpers.stringToVariablesPojo(content);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findFirst()\n+                        .orElse(new HashMap<>());\n     }\n \n     /**\n-     * Read security config file and checks for any missing Handlebar variables.\n-     * @return boolean true if security config file exists else false\n-     * @throws IOException\n+     * Read and validates security config file.\n      */\n-    private void readSecurityConfig() throws IOException {\n-        String key = Config.SECURITY.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            this.setElideSecurityConfig(DynamicConfigHelpers.stringToElideSecurityPojo(content, this.variables));\n-            validateRoleInSecurityConfig(this.getElideSecurityConfig());\n-            this.resourceMap.remove(Config.SECURITY.getConfigPath());\n-        }\n+    private ElideSecurityConfig readSecurityConfig() {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(Config.SECURITY.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                validateConfigForMissingVariables(content, this.modelVariables);\n+                                return DynamicConfigHelpers.stringToElideSecurityPojo(content, this.modelVariables);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findAny()\n+                        .orElse(new ElideSecurityConfig());\n     }\n \n     /**\n-     * Read table config files and checks for any missing Handlebar variables.\n-     * @throws IOException\n+     * Read and validates db config files.\n+     * @return Set<DBConfig> Set of SQL DB Configs\n      */\n-    private void readTableConfig() throws IOException {\n-        Set<Table> tables = new HashSet<>();\n-        if (this.resourceMap.isEmpty()) {\n-            throw new IllegalStateException(\"No Table configs found at: \" + this.configDir);\n-        }\n-        for (Entry<String, Resource> entry : this.resourceMap.entrySet()) {\n-            String content = IOUtils.toString(entry.getValue().getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            ElideTableConfig table = DynamicConfigHelpers.stringToElideTablePojo(content, this.variables);\n-            tables.addAll(table.getTables());\n+    private Set<DBConfig> readDbConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath())).map(entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTY4Nw==", "bodyText": "map should go on its own line separate from filter.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470661687", "createdAt": "2020-08-14T14:34:55Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -118,59 +132,108 @@ public void readAndValidateConfigs() throws IOException {\n     private void loadConfigMap() throws IOException {\n         PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver(\n                 this.getClass().getClassLoader());\n-        Resource[] modelResources = resolver.getResources(this.configDir);\n-        for (Resource resource : modelResources) {\n-            this.resourceMap.put(resource.getFilename(), resource);\n+        if (resolver.getResources(this.configDir).length == 0) {\n+            throw new IllegalStateException(this.configDir + \" : config path does not exist\");\n+        }\n+        int configDirURILength = resolver.getResources(this.configDir)[0].getURI().toString().length();\n+\n+        Resource[] hjsonResources = resolver.getResources(this.configDir + HJSON_EXTN);\n+        for (Resource resource : hjsonResources) {\n+            this.resourceMap.put(resource.getURI().toString().substring(configDirURILength), resource);\n         }\n     }\n \n     /**\n      * Read variable file config.\n-     * @return boolean true if variable config file exists else false\n-     * @throws IOException\n+     * @return Map<String, Object> A map containing all the variables if variable config exists else empty map\n      */\n-    private void readVariableConfig() throws IOException {\n-        String key = Config.VARIABLE.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            this.setVariables(DynamicConfigHelpers.stringToVariablesPojo(content));\n-            this.resourceMap.remove(Config.VARIABLE.getConfigPath());\n-        }\n+    private Map<String, Object> readVariableConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                return DynamicConfigHelpers.stringToVariablesPojo(content);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findFirst()\n+                        .orElse(new HashMap<>());\n     }\n \n     /**\n-     * Read security config file and checks for any missing Handlebar variables.\n-     * @return boolean true if security config file exists else false\n-     * @throws IOException\n+     * Read and validates security config file.\n      */\n-    private void readSecurityConfig() throws IOException {\n-        String key = Config.SECURITY.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            this.setElideSecurityConfig(DynamicConfigHelpers.stringToElideSecurityPojo(content, this.variables));\n-            validateRoleInSecurityConfig(this.getElideSecurityConfig());\n-            this.resourceMap.remove(Config.SECURITY.getConfigPath());\n-        }\n+    private ElideSecurityConfig readSecurityConfig() {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(Config.SECURITY.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                validateConfigForMissingVariables(content, this.modelVariables);\n+                                return DynamicConfigHelpers.stringToElideSecurityPojo(content, this.modelVariables);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findAny()\n+                        .orElse(new ElideSecurityConfig());\n     }\n \n     /**\n-     * Read table config files and checks for any missing Handlebar variables.\n-     * @throws IOException\n+     * Read and validates db config files.\n+     * @return Set<DBConfig> Set of SQL DB Configs\n      */\n-    private void readTableConfig() throws IOException {\n-        Set<Table> tables = new HashSet<>();\n-        if (this.resourceMap.isEmpty()) {\n-            throw new IllegalStateException(\"No Table configs found at: \" + this.configDir);\n-        }\n-        for (Entry<String, Resource> entry : this.resourceMap.entrySet()) {\n-            String content = IOUtils.toString(entry.getValue().getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            ElideTableConfig table = DynamicConfigHelpers.stringToElideTablePojo(content, this.variables);\n-            tables.addAll(table.getTables());\n+    private Set<DBConfig> readDbConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath())).map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                validateConfigForMissingVariables(content, this.dbVariables);\n+                                return DynamicConfigHelpers.stringToElideDBConfigPojo(content, this.dbVariables);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .flatMap(dbconfig -> dbconfig.getDbconfigs().stream())\n+                        .collect(Collectors.toSet());\n+    }\n+\n+    /**\n+     * Read and validates table config files.\n+     */\n+    private Set<Table> readTableConfig() {\n+\n+        Set<Table> tables = this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(Config.TABLE.getConfigPath())).map(entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 221}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2MTgzNw==", "bodyText": "map should go on its own line separate from filter.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470661837", "createdAt": "2020-08-14T14:35:11Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -118,59 +132,108 @@ public void readAndValidateConfigs() throws IOException {\n     private void loadConfigMap() throws IOException {\n         PathMatchingResourcePatternResolver resolver = new PathMatchingResourcePatternResolver(\n                 this.getClass().getClassLoader());\n-        Resource[] modelResources = resolver.getResources(this.configDir);\n-        for (Resource resource : modelResources) {\n-            this.resourceMap.put(resource.getFilename(), resource);\n+        if (resolver.getResources(this.configDir).length == 0) {\n+            throw new IllegalStateException(this.configDir + \" : config path does not exist\");\n+        }\n+        int configDirURILength = resolver.getResources(this.configDir)[0].getURI().toString().length();\n+\n+        Resource[] hjsonResources = resolver.getResources(this.configDir + HJSON_EXTN);\n+        for (Resource resource : hjsonResources) {\n+            this.resourceMap.put(resource.getURI().toString().substring(configDirURILength), resource);\n         }\n     }\n \n     /**\n      * Read variable file config.\n-     * @return boolean true if variable config file exists else false\n-     * @throws IOException\n+     * @return Map<String, Object> A map containing all the variables if variable config exists else empty map\n      */\n-    private void readVariableConfig() throws IOException {\n-        String key = Config.VARIABLE.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            this.setVariables(DynamicConfigHelpers.stringToVariablesPojo(content));\n-            this.resourceMap.remove(Config.VARIABLE.getConfigPath());\n-        }\n+    private Map<String, Object> readVariableConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                return DynamicConfigHelpers.stringToVariablesPojo(content);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findFirst()\n+                        .orElse(new HashMap<>());\n     }\n \n     /**\n-     * Read security config file and checks for any missing Handlebar variables.\n-     * @return boolean true if security config file exists else false\n-     * @throws IOException\n+     * Read and validates security config file.\n      */\n-    private void readSecurityConfig() throws IOException {\n-        String key = Config.SECURITY.getConfigPath();\n-        if (this.resourceMap.containsKey(key)) {\n-            String content = IOUtils.toString(this.resourceMap.get(key).getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            this.setElideSecurityConfig(DynamicConfigHelpers.stringToElideSecurityPojo(content, this.variables));\n-            validateRoleInSecurityConfig(this.getElideSecurityConfig());\n-            this.resourceMap.remove(Config.SECURITY.getConfigPath());\n-        }\n+    private ElideSecurityConfig readSecurityConfig() {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(Config.SECURITY.getConfigPath()))\n+                        .map(entry -> {\n+                            try {\n+                                String content = IOUtils.toString(entry.getValue().getInputStream(), UTF_8);\n+                                validateConfigForMissingVariables(content, this.modelVariables);\n+                                return DynamicConfigHelpers.stringToElideSecurityPojo(content, this.modelVariables);\n+                            } catch (IOException e) {\n+                                throw new IllegalStateException(e);\n+                            }\n+                        })\n+                        .findAny()\n+                        .orElse(new ElideSecurityConfig());\n     }\n \n     /**\n-     * Read table config files and checks for any missing Handlebar variables.\n-     * @throws IOException\n+     * Read and validates db config files.\n+     * @return Set<DBConfig> Set of SQL DB Configs\n      */\n-    private void readTableConfig() throws IOException {\n-        Set<Table> tables = new HashSet<>();\n-        if (this.resourceMap.isEmpty()) {\n-            throw new IllegalStateException(\"No Table configs found at: \" + this.configDir);\n-        }\n-        for (Entry<String, Resource> entry : this.resourceMap.entrySet()) {\n-            String content = IOUtils.toString(entry.getValue().getInputStream(), StandardCharsets.UTF_8);\n-            validateConfigForMissingVariables(content, this.variables);\n-            ElideTableConfig table = DynamicConfigHelpers.stringToElideTablePojo(content, this.variables);\n-            tables.addAll(table.getTables());\n+    private Set<DBConfig> readDbConfig(Config config) {\n+\n+        return this.resourceMap\n+                        .entrySet()\n+                        .stream()\n+                        .filter(entry -> entry.getKey().startsWith(config.getConfigPath())).map(entry -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 200}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY2NzUyNQ==", "bodyText": "Is it possible for DbConnectionName to be null?  I wonder if we should invert this comparison here.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470667525", "createdAt": "2020-08-14T14:43:30Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -211,6 +274,68 @@ private static boolean validateSqlInTableConfig(ElideTableConfig elideTableConfi\n         return true;\n     }\n \n+    /**\n+     * Validates join clause does not refer to a Table which is not in the same DBConnection.\n+     * If joined table is not part of dynamic configuration, then ignore\n+     */\n+    private static void validateJoinedTablesDBConnectionName(ElideTableConfig elideTableConfig) {\n+\n+        for (Table table : elideTableConfig.getTables()) {\n+            if (!table.getJoins().isEmpty()) {\n+\n+                Set<String> joinedTables = table.getJoins()\n+                        .stream()\n+                        .map(join -> join.getTo().toLowerCase(Locale.ENGLISH))\n+                        .collect(Collectors.toSet());\n+\n+                Set<String> connections = elideTableConfig.getTables()\n+                        .stream()\n+                        .filter(t -> joinedTables.contains(t.getName().toLowerCase(Locale.ENGLISH)))\n+                        .map(t -> t.getDbConnectionName())\n+                        .collect(Collectors.toSet());\n+\n+                if (connections.size() > 1 || (connections.size() == 1\n+                                && !table.getDbConnectionName().equals(connections.iterator().next()))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 268}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDY3MDU0Ng==", "bodyText": "Do we have unit tests for this function?", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r470670546", "createdAt": "2020-08-14T14:46:10Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -296,8 +429,10 @@ private static void printHelp(Options options) {\n      * @return Path to model dir\n      */\n     private String formatClassPath(String filePath) {\n-        if (filePath.indexOf(RESOURCES) > -1) {\n-            return filePath.substring(filePath.indexOf(RESOURCES) + RESOURCE_LENGTH);\n+        if (filePath.indexOf(RESOURCES + File.separator) > -1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4e95e311293ad88547fe01b33d5c5da1cbb2e64"}, "originalPosition": 349}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dea6658cd6b6c7648d0e63d1c2659cf3ed5826ee", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/dea6658cd6b6c7648d0e63d1c2659cf3ed5826ee", "committedDate": "2020-08-24T17:16:03Z", "message": "Support dynamic configuration for db connections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a7946269ab31f6b37ce8b39246163b6b7dc9fc", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/72a7946269ab31f6b37ce8b39246163b6b7dc9fc", "committedDate": "2020-08-24T17:16:04Z", "message": "Fixes for reading from JAR file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30d4910602c8a8a99ae93e6be84e5804c57a22a9", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/30d4910602c8a8a99ae93e6be84e5804c57a22a9", "committedDate": "2020-08-24T17:16:04Z", "message": "Create jar with dependencies for config validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4908a217d03c20e6e2621d81d6fd06cb61901b36", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/4908a217d03c20e6e2621d81d6fd06cb61901b36", "committedDate": "2020-08-24T17:16:04Z", "message": "Review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff9b3cf7f751f522d062a1971127b47ea6e10a50", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/ff9b3cf7f751f522d062a1971127b47ea6e10a50", "committedDate": "2020-08-24T17:16:04Z", "message": "Codacy check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15da79e8258e78629c9fce4fa3feebe631bd69c1", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/15da79e8258e78629c9fce4fa3feebe631bd69c1", "committedDate": "2020-08-24T17:16:30Z", "message": "Merge branch 'elide-5.x-dynamic-db-config' of github.com:yahoo/elide into elide-5.x-dynamic-db-config"}, "afterCommit": {"oid": "ff9b3cf7f751f522d062a1971127b47ea6e10a50", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/ff9b3cf7f751f522d062a1971127b47ea6e10a50", "committedDate": "2020-08-24T17:16:04Z", "message": "Codacy check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1OTA5MTMz", "url": "https://github.com/yahoo/elide/pull/1497#pullrequestreview-475909133", "createdAt": "2020-08-26T22:08:39Z", "commit": {"oid": "ff9b3cf7f751f522d062a1971127b47ea6e10a50"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjowODozOVrOHHfbFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMjowODozOVrOHHfbFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzYxNjkxNw==", "bodyText": "Maybe Table and DB should both leverage a common interface (Named or something) and use it to get the name without casting here.  This function could take a set of Named instead of a set of objects.", "url": "https://github.com/yahoo/elide/pull/1497#discussion_r477616917", "createdAt": "2020-08-26T22:08:39Z", "author": {"login": "aklish"}, "path": "elide-contrib/elide-dynamic-config-helpers/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -211,6 +274,51 @@ private static boolean validateSqlInTableConfig(ElideTableConfig elideTableConfi\n         return true;\n     }\n \n+    /**\n+     * Validates join clause does not refer to a Table which is not in the same DBConnection.\n+     * If joined table is not part of dynamic configuration, then ignore\n+     */\n+    private static void validateJoinedTablesDBConnectionName(ElideTableConfig elideTableConfig) {\n+\n+        for (Table table : elideTableConfig.getTables()) {\n+            if (!table.getJoins().isEmpty()) {\n+\n+                Set<String> joinedTables = table.getJoins()\n+                        .stream()\n+                        .map(join -> join.getTo().toLowerCase(Locale.ENGLISH))\n+                        .collect(Collectors.toSet());\n+\n+                Set<String> connections = elideTableConfig.getTables()\n+                        .stream()\n+                        .filter(t -> joinedTables.contains(t.getName().toLowerCase(Locale.ENGLISH)))\n+                        .map(t -> t.getDbConnectionName())\n+                        .collect(Collectors.toSet());\n+\n+                if (connections.size() > 1 || (connections.size() == 1\n+                                && !table.getDbConnectionName().equals(connections.iterator().next()))) {\n+                    throw new IllegalStateException(\"DBConnection name mismatch between table: \" + table.getName()\n+                                    + \" and tables in its Join Clause.\");\n+                }\n+            }\n+        }\n+    }\n+\n+    /**\n+     * Validates table (or db connection) name is unique across all the dynamic table (or db connection) configs.\n+     */\n+    private void validateNameUniqueness(Set<? extends Object> configs) {\n+\n+        Set<String> names = new HashSet<>();\n+\n+        configs.forEach(obj -> {\n+            if (obj instanceof Table && !names.add(((Table) obj).getName().toLowerCase(Locale.ENGLISH))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff9b3cf7f751f522d062a1971127b47ea6e10a50"}, "originalPosition": 284}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e5ac8fad9d01a2cf9828d10ff2dda0eaf76fc07", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/0e5ac8fad9d01a2cf9828d10ff2dda0eaf76fc07", "committedDate": "2020-08-26T23:06:01Z", "message": "Review comment for using Named interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18a03169e8d8a9550825fa8b291ca083a0b93bc4", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/18a03169e8d8a9550825fa8b291ca083a0b93bc4", "committedDate": "2020-08-26T23:13:51Z", "message": "Review comment for using Named interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "572475b1a2d4ab3a8e2e623b061dbece15fc0525", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/572475b1a2d4ab3a8e2e623b061dbece15fc0525", "committedDate": "2020-08-26T23:23:01Z", "message": "Review comment for using Named interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b679bceb20d896fcc196fdf920f9c32ed801a8ac", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/b679bceb20d896fcc196fdf920f9c32ed801a8ac", "committedDate": "2020-08-26T23:29:24Z", "message": "Remove extra code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198600d5a0ea578d5db536096b1dd9c80f85422f", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/198600d5a0ea578d5db536096b1dd9c80f85422f", "committedDate": "2020-08-26T23:38:01Z", "message": "Review comment for using Named interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef398d8fef8df6316e78beb796effc1afdeb92c", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/bef398d8fef8df6316e78beb796effc1afdeb92c", "committedDate": "2020-08-26T23:42:10Z", "message": "Review comment for using Named interface"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "163a26a57be17cd69e201492526d2980b70c26c6", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/163a26a57be17cd69e201492526d2980b70c26c6", "committedDate": "2020-08-27T15:17:08Z", "message": "Review Comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2ODMwMTg5", "url": "https://github.com/yahoo/elide/pull/1497#pullrequestreview-476830189", "createdAt": "2020-08-27T15:21:46Z", "commit": {"oid": "163a26a57be17cd69e201492526d2980b70c26c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 796, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}