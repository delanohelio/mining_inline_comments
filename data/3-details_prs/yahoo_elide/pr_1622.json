{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTIyNjgz", "number": 1622, "title": "Refactor dbconnection", "bodyText": "Description\nRemove dbConnectionName form Table class\nAdd ConnectionDetails to SQLTable class\nHow Has This Been Tested?\nExisting Tests pass.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-30T16:27:15Z", "url": "https://github.com/yahoo/elide/pull/1622", "merged": true, "mergeCommit": {"oid": "4d16a87668765a6377d5cc20ed6a9affce808bc3"}, "closed": true, "closedAt": "2020-10-30T19:52:44Z", "author": {"login": "rishi-aga"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpT_PAH2gAyNTEzMTIyNjgzOmQ1ZmNhNmIxZmFmMTMyNTNlNmU2ZDQwY2FhYjlhNzRlM2MzYWNiNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXsRq4gFqTUyMDk5MTAyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d5fca6b1faf13253e6e6d40caab9a74e3c3acb42", "committedDate": "2020-10-30T16:25:26Z", "message": "Refactoring to add ConnectionDetails object to SQLTable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTMwNDE4", "url": "https://github.com/yahoo/elide/pull/1622#pullrequestreview-520930418", "createdAt": "2020-10-30T18:24:18Z", "commit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODoyNDoxOVrOHrbTCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxODozMzo0NVrOHrblSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODA1OA==", "bodyText": "We can just return connectionDetails here.", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515298058", "createdAt": "2020-10-30T18:24:19Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/query/Queryable.java", "diffHunk": "@@ -138,11 +140,15 @@ default TimeDimensionProjection getTimeDimensionProjection(String name) {\n     }\n \n     /**\n-     * Returns the connection name where this queryable is sourced from.\n-     * @return the connectinon name\n+     * Returns the connection details where this queryable is sourced from.\n+     * @return the connectinon details\n      */\n-    default String getDbConnectionName() {\n-        return getSource().getDbConnectionName();\n+    default ConnectionDetails getConnectionDetails() {\n+        ConnectionDetails connectionDetails = getSource().getConnectionDetails();\n+        if (connectionDetails == null) {\n+            throw new IllegalStateException(\"ConnectionDetails undefined for: \" + getSource().getName());\n+        }\n+        return getSource().getConnectionDetails();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTI5ODkxOQ==", "bodyText": "The SQLTable shouldn't need the default and connectionDetails map.  It should just be handed the only ConnectionDetail object that pertains to it.", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515298919", "createdAt": "2020-10-30T18:26:00Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -106,7 +117,7 @@ public Object apply(ResultSet rs) {\n \n     @Override\n     protected Table constructTable(Class<?> entityClass, EntityDictionary metaDataDictionary) {\n-        return new SQLTable(entityClass, metaDataDictionary);\n+        return new SQLTable(entityClass, metaDataDictionary, defaultConnectionDetails, connectionDetailsMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMTQ5MA==", "bodyText": "I don't feel like the connectionDetailsMap is something this class should be concerned with.\nThe more we keep the metadata models like dumb pojos - the more flexibility we have down the road to do make certain modifications I see coming.  Let's not put any more annotation parsing stuff in them.", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515301490", "createdAt": "2020-10-30T18:31:04Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/metadata/SQLTable.java", "diffHunk": "@@ -33,6 +40,32 @@\n  */\n @EqualsAndHashCode(callSuper = true)\n public class SQLTable extends Table implements Queryable {\n+\n+    @Getter\n+    private ConnectionDetails connectionDetails;\n+\n+    public SQLTable(Class<?> cls,\n+                    EntityDictionary dictionary,\n+                    ConnectionDetails defaultConnectionDetails,\n+                    Map<String, ConnectionDetails> connectionDetailsMap) {\n+        super(cls, dictionary);\n+\n+        String dbConnectionName = null;\n+        Annotation annotation =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjA5Nw==", "bodyText": "How about an empty map here instead of null.", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302097", "createdAt": "2020-10-30T18:32:19Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -67,10 +68,7 @@\n \n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails) {\n-        super(metaDataStore);\n-        referenceTable = new SQLReferenceTable(metaDataStore);\n-        this.defaultConnectionDetails = new ConnectionDetails(defaultConnectionDetails.getDataSource(),\n-                        SQLDialectFactory.getDialect(defaultConnectionDetails.getDialect()));\n+        this(metaDataStore, defaultConnectionDetails, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjM3Nw==", "bodyText": "I would just put google preconditions that defaultConn cannot be null nor can detailsMap.", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302377", "createdAt": "2020-10-30T18:32:58Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -82,11 +80,24 @@ public SQLQueryEngine(MetaDataStore metaDataStore,\n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails,\n                     Map<String, com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails> detailsMap) {\n-        this(metaDataStore, defaultConnectionDetails);\n-        detailsMap.forEach((name, details) -> {\n-            this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n-                            SQLDialectFactory.getDialect(details.getDialect())));\n-        });\n+        if (defaultConnectionDetails == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTMwMjczMQ==", "bodyText": "Is there a reason we moved all this initialization here (and removed final keywords as well from the parent class)?", "url": "https://github.com/yahoo/elide/pull/1622#discussion_r515302731", "createdAt": "2020-10-30T18:33:45Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -82,11 +80,24 @@ public SQLQueryEngine(MetaDataStore metaDataStore,\n     public SQLQueryEngine(MetaDataStore metaDataStore,\n                     com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails defaultConnectionDetails,\n                     Map<String, com.yahoo.elide.contrib.dynamicconfighelpers.compile.ConnectionDetails> detailsMap) {\n-        this(metaDataStore, defaultConnectionDetails);\n-        detailsMap.forEach((name, details) -> {\n-            this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n-                            SQLDialectFactory.getDialect(details.getDialect())));\n-        });\n+        if (defaultConnectionDetails == null) {\n+            this.defaultConnectionDetails = null;\n+        } else {\n+            this.defaultConnectionDetails = new ConnectionDetails(defaultConnectionDetails.getDataSource(),\n+                            SQLDialectFactory.getDialect(defaultConnectionDetails.getDialect()));\n+        }\n+        if (!(detailsMap == null || detailsMap.size() == 0)) {\n+            detailsMap.forEach((name, details) -> {\n+                this.connectionDetailsMap.put(name, new ConnectionDetails(details.getDataSource(),\n+                                SQLDialectFactory.getDialect(details.getDialect())));\n+            });\n+        }\n+        this.metaDataStore = metaDataStore;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5fca6b1faf13253e6e6d40caab9a74e3c3acb42"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "205ebdc46617414bf20b534b44975885e6e6bd6f", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/205ebdc46617414bf20b534b44975885e6e6bd6f", "committedDate": "2020-10-30T19:04:16Z", "message": "Review Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTkxMDI4", "url": "https://github.com/yahoo/elide/pull/1622#pullrequestreview-520991028", "createdAt": "2020-10-30T19:52:37Z", "commit": {"oid": "205ebdc46617414bf20b534b44975885e6e6bd6f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 743, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}