{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NTM0MDU5", "number": 1655, "title": "Validation for tableSource", "bodyText": "Validation for tableSource to make sure it is modelName.logicalColumnName\nHow Has This Been Tested?\nExisting tests pass.\nIntegration test.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-11-10T14:36:58Z", "url": "https://github.com/yahoo/elide/pull/1655", "merged": true, "mergeCommit": {"oid": "7a057e619bb7e3c69b4db94b1a9da061d4f32d81"}, "closed": true, "closedAt": "2020-11-16T19:01:50Z", "author": {"login": "rishi-aga"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbKYviAFqTUyNzI2ODE3Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddIFAigFqTUzMTUyNTUxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MjY4MTc3", "url": "https://github.com/yahoo/elide/pull/1655#pullrequestreview-527268177", "createdAt": "2020-11-10T14:39:16Z", "commit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDozOToxNlrOHwfo2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNDozOToxNlrOHwfo2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDYxMjA1Nw==", "bodyText": "Adding all fields here, do we need to somehow ensure its a dimension ?", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r520612057", "createdAt": "2020-11-10T14:39:16Z", "author": {"login": "rishi-aga"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/compile/ElideDynamicEntityCompiler.java", "diffHunk": "@@ -83,11 +85,35 @@\n             String className = cls.getSimpleName();\n             String pkgName = cls.getPackage().getName();\n             map.put(new ModelMapKey(modelName, modelVersion),\n-                            new ModelMapValue(className, prepareImport(pkgName, className)));\n+                    new ModelMapValue(className, prepareImport(pkgName, className), getFieldNames(cls)));\n         });\n \n         return Collections.unmodifiableMap(map);\n     }\n+\n+    private static Set<String> getFieldNames(Class<?> cls) {\n+        Set<String> fieldNames = new HashSet<String>();\n+        getAllFieldNames(cls, fieldNames);\n+        return fieldNames;\n+    }\n+\n+    private static void getAllFieldNames(Class<?> cls, Set<String> fieldNames) {\n+\n+        if (cls == Object.class) {\n+            return;\n+        }\n+\n+        getAllFieldNames(cls.getSuperclass(), fieldNames);\n+\n+        fieldNames.addAll(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NDExMDYz", "url": "https://github.com/yahoo/elide/pull/1655#pullrequestreview-527411063", "createdAt": "2020-11-10T16:57:29Z", "commit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo1NzoyOVrOHwmLgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjo1ODowMlrOHwmNFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxOTIzMw==", "bodyText": "This is duplicating logic in EntityDictionary/EntityBinding but not correctly.  The more logic we add here, the more I think we need to leverage a private EntityDictionary rather than duplicate the logic.", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r520719233", "createdAt": "2020-11-10T16:57:29Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/compile/ElideDynamicEntityCompiler.java", "diffHunk": "@@ -83,11 +85,35 @@\n             String className = cls.getSimpleName();\n             String pkgName = cls.getPackage().getName();\n             map.put(new ModelMapKey(modelName, modelVersion),\n-                            new ModelMapValue(className, prepareImport(pkgName, className)));\n+                    new ModelMapValue(className, prepareImport(pkgName, className), getFieldNames(cls)));\n         });\n \n         return Collections.unmodifiableMap(map);\n     }\n+\n+    private static Set<String> getFieldNames(Class<?> cls) {\n+        Set<String> fieldNames = new HashSet<String>();\n+        getAllFieldNames(cls, fieldNames);\n+        return fieldNames;\n+    }\n+\n+    private static void getAllFieldNames(Class<?> cls, Set<String> fieldNames) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDcxOTYzOQ==", "bodyText": "Elide \"fields\" can either be methods or attributes.  The logic is a bit complicated and we don't want to duplicate it.", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r520719639", "createdAt": "2020-11-10T16:58:02Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/compile/ElideDynamicEntityCompiler.java", "diffHunk": "@@ -83,11 +85,35 @@\n             String className = cls.getSimpleName();\n             String pkgName = cls.getPackage().getName();\n             map.put(new ModelMapKey(modelName, modelVersion),\n-                            new ModelMapValue(className, prepareImport(pkgName, className)));\n+                    new ModelMapValue(className, prepareImport(pkgName, className), getFieldNames(cls)));\n         });\n \n         return Collections.unmodifiableMap(map);\n     }\n+\n+    private static Set<String> getFieldNames(Class<?> cls) {\n+        Set<String> fieldNames = new HashSet<String>();\n+        getAllFieldNames(cls, fieldNames);\n+        return fieldNames;\n+    }\n+\n+    private static void getAllFieldNames(Class<?> cls, Set<String> fieldNames) {\n+\n+        if (cls == Object.class) {\n+            return;\n+        }\n+\n+        getAllFieldNames(cls.getSuperclass(), fieldNames);\n+\n+        fieldNames.addAll(\n+            Arrays.stream(cls.getDeclaredFields())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd"}, "originalPosition": 42}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf4cc71118d5c15a33b4aba3bde797ba350064fd", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/bf4cc71118d5c15a33b4aba3bde797ba350064fd", "committedDate": "2020-11-10T14:21:22Z", "message": "Validation for tableSource"}, "afterCommit": {"oid": "30122ff1899529b35714a525a995be8dd7628ce2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/30122ff1899529b35714a525a995be8dd7628ce2", "committedDate": "2020-11-12T13:49:36Z", "message": "Validation for tableSource"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38235f70629ad9a87f69796f96c01b560ab3f387", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/38235f70629ad9a87f69796f96c01b560ab3f387", "committedDate": "2020-11-12T14:39:13Z", "message": "Review Comments"}, "afterCommit": {"oid": "c998aac9286fdea8d029ada15071976989fd9af9", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c998aac9286fdea8d029ada15071976989fd9af9", "committedDate": "2020-11-12T14:52:18Z", "message": "Review Comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c998aac9286fdea8d029ada15071976989fd9af9", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c998aac9286fdea8d029ada15071976989fd9af9", "committedDate": "2020-11-12T14:52:18Z", "message": "Review Comments"}, "afterCommit": {"oid": "6a110a796620ea22fa5a51c916cf10dcf980b172", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/6a110a796620ea22fa5a51c916cf10dcf980b172", "committedDate": "2020-11-12T19:04:49Z", "message": "Review Comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDAyNjE2", "url": "https://github.com/yahoo/elide/pull/1655#pullrequestreview-529402616", "createdAt": "2020-11-12T19:04:17Z", "commit": {"oid": "c998aac9286fdea8d029ada15071976989fd9af9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTowNDoxN1rOHyJd7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOToxNDowMFrOHyJ4-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM0NTk2NQ==", "bodyText": "Is there a reason these functions need to be static?", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r522345965", "createdAt": "2020-11-12T19:04:17Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/compile/ElideDynamicEntityCompiler.java", "diffHunk": "@@ -271,4 +277,16 @@ public static String getStaticModelClassImport(String modelName, String modelVer\n         ModelMapValue value = STATIC_MODEL_DETAILS.get(new ModelMapKey(modelName, modelVersion));\n         return value != null ? value.getClassImport() : defaultValue;\n     }\n+\n+    /**\n+     * Checks if field exists in referenced static model.\n+     * @param modelName model name.\n+     * @param modelVersion model version.\n+     * @param fieldName field name to check.\n+     * @return true if model has the field defined else false\n+     */\n+    public static boolean staticModelContainsField(String modelName, String modelVersion, String fieldName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c998aac9286fdea8d029ada15071976989fd9af9"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MjM4NQ==", "bodyText": "I wonder if it would be clearer if some of these methods were moved to ElideTableConfig.", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r522352385", "createdAt": "2020-11-12T19:13:02Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -343,16 +337,77 @@ private static void validateConfigForMissingVariables(String config, Map<String,\n     private static boolean validateTableConfig(ElideTableConfig elideTableConfig) {\n         for (Table table : elideTableConfig.getTables()) {\n             validateSql(table.getSql());\n-            table.getDimensions().forEach(dim -> validateSql(dim.getDefinition()));\n+            table.getDimensions().forEach(dim -> {\n+                validateSql(dim.getDefinition());\n+                validateTableSource(elideTableConfig, dim.getTableSource());\n+            });\n             table.getMeasures().forEach(measure -> validateSql(measure.getDefinition()));\n             table.getJoins().forEach(join -> validateJoin(join, elideTableConfig));\n         }\n+\n         return true;\n     }\n \n+    private static void validateTableSource(ElideTableConfig elideTableConfig, String tableSource) {\n+        if (isNullOrEmpty(tableSource)) {\n+            return; // Nothing to validate\n+        }\n+\n+        String[] split = tableSource.split(\"\\\\.\");\n+        if (split.length != 2) {\n+            throw new IllegalStateException(\"Invalid tableSource: \" + tableSource\n+                            + \". tableSource must be in format: modelName.columnName\");\n+        }\n+        String modelName = split[0];\n+        String fieldName = split[1];\n+\n+        if (!staticModelContainsField(modelName, NO_VERSION, fieldName)\n+                        && !dynamicModelContainsField(elideTableConfig, modelName, fieldName)) {\n+            throw new IllegalStateException(\"Invalid tableSource : \" + tableSource + \" . Either model : \" + modelName\n+                            + \" is undefined or field : \" + fieldName + \" is undefined for this model.\");\n+        }\n+    }\n+\n+    private static boolean dynamicModelContainsField(ElideTableConfig elideTableConfig, String modelName,\n+                    String fieldName) {\n+        if (getNames(elideTableConfig.getTables()).contains(modelName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a110a796620ea22fa5a51c916cf10dcf980b172"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1MjY3Ng==", "bodyText": "We should break these errors out to help the developer.", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r522352676", "createdAt": "2020-11-12T19:13:34Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -343,16 +337,77 @@ private static void validateConfigForMissingVariables(String config, Map<String,\n     private static boolean validateTableConfig(ElideTableConfig elideTableConfig) {\n         for (Table table : elideTableConfig.getTables()) {\n             validateSql(table.getSql());\n-            table.getDimensions().forEach(dim -> validateSql(dim.getDefinition()));\n+            table.getDimensions().forEach(dim -> {\n+                validateSql(dim.getDefinition());\n+                validateTableSource(elideTableConfig, dim.getTableSource());\n+            });\n             table.getMeasures().forEach(measure -> validateSql(measure.getDefinition()));\n             table.getJoins().forEach(join -> validateJoin(join, elideTableConfig));\n         }\n+\n         return true;\n     }\n \n+    private static void validateTableSource(ElideTableConfig elideTableConfig, String tableSource) {\n+        if (isNullOrEmpty(tableSource)) {\n+            return; // Nothing to validate\n+        }\n+\n+        String[] split = tableSource.split(\"\\\\.\");\n+        if (split.length != 2) {\n+            throw new IllegalStateException(\"Invalid tableSource: \" + tableSource\n+                            + \". tableSource must be in format: modelName.columnName\");\n+        }\n+        String modelName = split[0];\n+        String fieldName = split[1];\n+\n+        if (!staticModelContainsField(modelName, NO_VERSION, fieldName)\n+                        && !dynamicModelContainsField(elideTableConfig, modelName, fieldName)) {\n+            throw new IllegalStateException(\"Invalid tableSource : \" + tableSource + \" . Either model : \" + modelName\n+                            + \" is undefined or field : \" + fieldName + \" is undefined for this model.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a110a796620ea22fa5a51c916cf10dcf980b172"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM1Mjg5MQ==", "bodyText": "Seems like another function that could be moved to ElideTableConfig?", "url": "https://github.com/yahoo/elide/pull/1655#discussion_r522352891", "createdAt": "2020-11-12T19:14:00Z", "author": {"login": "aklish"}, "path": "elide-model-config/src/main/java/com/yahoo/elide/contrib/dynamicconfighelpers/validator/DynamicConfigValidator.java", "diffHunk": "@@ -185,21 +180,20 @@ private void flagDimensionsToOverride(Table table, Set<Table> parentTables) {\n         Table current = table;\n \n         while (current != null && current.getExtend() != null && !current.getExtend().equals(\"\")) {\n-            Table parent = getTableByName(current.getExtend().trim());\n+            Table parent = getTableByName(this.elideTableConfig, current.getExtend().trim());\n             parentTables.add(parent);\n             current = parent;\n         }\n         return parentTables;\n     }\n \n-    private Table getTableByName(String tableName) {\n-        Table tableByName = this.elideTableConfig.getTables().stream().filter(\n-                table -> table.getName().equals(tableName)).findFirst().orElse(null);\n-\n-        if (tableByName != null) {\n-            return tableByName;\n-        }\n-        throw new IllegalStateException(\"Table \" + tableName + \" is not defined in Dynamic Config.\");\n+    private static Table getTableByName(ElideTableConfig elideTableConfig, String tableName) {\n+        return elideTableConfig.getTables()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a110a796620ea22fa5a51c916cf10dcf980b172"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f20e59338888d5ab4a20001fcc344fce436d03a6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f20e59338888d5ab4a20001fcc344fce436d03a6", "committedDate": "2020-11-15T14:28:30Z", "message": "Validation for tableSource"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39e3559bd00e6900bbb92671a7248649e0e64cda", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/39e3559bd00e6900bbb92671a7248649e0e64cda", "committedDate": "2020-11-15T14:28:30Z", "message": "Review Comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8307c08be5930e332f93bd49901c84c1e5072e07", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8307c08be5930e332f93bd49901c84c1e5072e07", "committedDate": "2020-11-16T03:00:25Z", "message": "Review comments: consolidate methods"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6a110a796620ea22fa5a51c916cf10dcf980b172", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/6a110a796620ea22fa5a51c916cf10dcf980b172", "committedDate": "2020-11-12T19:04:49Z", "message": "Review Comments"}, "afterCommit": {"oid": "8307c08be5930e332f93bd49901c84c1e5072e07", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8307c08be5930e332f93bd49901c84c1e5072e07", "committedDate": "2020-11-16T03:00:25Z", "message": "Review comments: consolidate methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "666968c03d76fec226956612c1d4cd593bf61a1d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/666968c03d76fec226956612c1d4cd593bf61a1d", "committedDate": "2020-11-16T15:25:19Z", "message": "Checkstyle fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1fb28de3a7414dc5147008ad049af0300d4c4da", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c1fb28de3a7414dc5147008ad049af0300d4c4da", "committedDate": "2020-11-16T15:39:07Z", "message": "Minor Changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48f127e5674a1bfff3b99192366a7abe8a1cd366", "author": {"user": {"login": "rishi-aga", "name": null}}, "url": "https://github.com/yahoo/elide/commit/48f127e5674a1bfff3b99192366a7abe8a1cd366", "committedDate": "2020-11-16T16:54:04Z", "message": "Update elideTableSchema.json"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMxNTI1NTEy", "url": "https://github.com/yahoo/elide/pull/1655#pullrequestreview-531525512", "createdAt": "2020-11-16T17:05:45Z", "commit": {"oid": "48f127e5674a1bfff3b99192366a7abe8a1cd366"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 767, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}