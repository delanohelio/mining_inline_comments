{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4OTU3NTAw", "number": 1280, "title": "Patch Extension Lifecycle tests", "bodyText": "Description\nAdded additional Elide lifecycle tests using Patch Extension\nMotivation and Context\nTest coverage\nHow Has This Been Tested?\nUnit testing\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-04-25T19:22:04Z", "url": "https://github.com/yahoo/elide/pull/1280", "merged": true, "mergeCommit": {"oid": "1fa709690f9f396c9e195971ad211e4baa07b47e"}, "closed": true, "closedAt": "2020-04-28T18:15:59Z", "author": {"login": "wcekan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbLMp-gFqTQwMDQyNDAzOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABccIAm8AFqTQwMjA5MzI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAwNDI0MDM4", "url": "https://github.com/yahoo/elide/pull/1280#pullrequestreview-400424038", "createdAt": "2020-04-25T19:24:48Z", "commit": {"oid": "54d88920dc631eae3b02cb1943ec9e0104c94333"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOToyNDo0OFrOGL5VtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQxOToyNDo0OFrOGL5VtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTEyNjk2NA==", "bodyText": "This will require #1278 for a proper error", "url": "https://github.com/yahoo/elide/pull/1280#discussion_r415126964", "createdAt": "2020-04-25T19:24:48Z", "author": {"login": "wcekan"}, "path": "elide-core/src/test/java/com/yahoo/elide/core/LifeCycleTest.java", "diffHunk": "@@ -664,6 +665,183 @@ public void testElidePatchFailure() throws Exception {\n         verify(tx).close();\n     }\n \n+    @Test\n+    public void testElidePatchExtensionCreate() throws Exception {\n+        DataStore store = mock(DataStore.class);\n+        DataStoreTransaction tx = mock(DataStoreTransaction.class);\n+        FieldTestModel mockModel = mock(FieldTestModel.class);\n+\n+        Elide elide = getElide(store, dictionary, MOCK_AUDIT_LOGGER);\n+\n+        String body = \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"/testModel\\\",\\\"value\\\":{\"\n+                + \"\\\"type\\\":\\\"testModel\\\",\\\"id\\\":\\\"1\\\",\\\"attributes\\\": {\\\"field\\\":\\\"Foo\\\"}}}]\";\n+\n+        when(store.beginTransaction()).thenReturn(tx);\n+        when(tx.createNewObject(FieldTestModel.class)).thenReturn(mockModel);\n+\n+        String contentType = JSONAPI_CONTENT_TYPE_WITH_JSON_PATCH_EXTENSION;\n+        ElideResponse response = elide.patch(contentType, contentType, \"/\", body, null);\n+        assertEquals(HttpStatus.SC_OK, response.getResponseCode());\n+\n+        verify(mockModel, times(1)).classCallback(eq(READ), eq(PRESECURITY));\n+        verify(mockModel, times(1)).classCallback(eq(READ), eq(PRECOMMIT));\n+        verify(mockModel, times(1)).classCallback(eq(READ), eq(POSTCOMMIT));\n+        verify(mockModel, times(1)).classCallback(eq(CREATE), eq(PRESECURITY));\n+        verify(mockModel, times(1)).classCallback(eq(CREATE), eq(PRECOMMIT));\n+        verify(mockModel, times(1)).classCallback(eq(CREATE), eq(POSTCOMMIT));\n+        verify(mockModel, never()).classCallback(eq(UPDATE), any());\n+        verify(mockModel, never()).classCallback(eq(DELETE), any());\n+\n+        verify(mockModel, times(2)).classAllFieldsCallback(any(), any());\n+        verify(mockModel, times(2)).classAllFieldsCallback(eq(CREATE), eq(PRECOMMIT));\n+\n+        verify(mockModel, times(1)).attributeCallback(eq(READ), eq(PRESECURITY), any());\n+        verify(mockModel, times(1)).attributeCallback(eq(READ), eq(PRECOMMIT), any());\n+        verify(mockModel, times(1)).attributeCallback(eq(READ), eq(POSTCOMMIT), any());\n+        verify(mockModel, times(1)).attributeCallback(eq(CREATE), eq(PRESECURITY), any());\n+        verify(mockModel, times(1)).attributeCallback(eq(CREATE), eq(PRECOMMIT), any());\n+        verify(mockModel, times(1)).attributeCallback(eq(CREATE), eq(POSTCOMMIT), any());\n+        verify(mockModel, never()).attributeCallback(eq(UPDATE), any(), any());\n+        verify(mockModel, never()).attributeCallback(eq(DELETE), any(), any());\n+\n+        verify(mockModel, times(1)).relationCallback(eq(READ), eq(PRESECURITY), any());\n+        verify(mockModel, times(1)).relationCallback(eq(READ), eq(PRECOMMIT), any());\n+        verify(mockModel, times(1)).relationCallback(eq(READ), eq(POSTCOMMIT), any());\n+        verify(mockModel, times(1)).relationCallback(eq(CREATE), eq(PRESECURITY), any());\n+        verify(mockModel, times(1)).relationCallback(eq(CREATE), eq(PRECOMMIT), any());\n+        verify(mockModel, times(1)).relationCallback(eq(CREATE), eq(POSTCOMMIT), any());\n+        verify(mockModel, never()).relationCallback(eq(UPDATE), any(), any());\n+        verify(mockModel, never()).relationCallback(eq(DELETE), any(), any());\n+\n+        verify(tx).preCommit();\n+        verify(tx, times(1)).createObject(eq(mockModel), isA(RequestScope.class));\n+        verify(tx).flush(isA(RequestScope.class));\n+        verify(tx).commit(isA(RequestScope.class));\n+        verify(tx).close();\n+    }\n+\n+    @Test\n+    public void failElidePatchExtensionCreate() throws Exception {\n+        DataStore store = mock(DataStore.class);\n+        DataStoreTransaction tx = mock(DataStoreTransaction.class);\n+        FieldTestModel mockModel = mock(FieldTestModel.class);\n+\n+        Elide elide = getElide(store, dictionary, MOCK_AUDIT_LOGGER);\n+\n+        String body = \"[{\\\"op\\\": \\\"add\\\",\\\"path\\\": \\\"/testModel\\\",\\\"value\\\":{\"\n+                + \"\\\"type\\\":\\\"testModel\\\",\\\"attributes\\\": {\\\"field\\\":\\\"Foo\\\"}}}]\";\n+\n+        when(store.beginTransaction()).thenReturn(tx);\n+        when(tx.createNewObject(FieldTestModel.class)).thenReturn(mockModel);\n+\n+        String contentType = JSONAPI_CONTENT_TYPE_WITH_JSON_PATCH_EXTENSION;\n+        ElideResponse response = elide.patch(contentType, contentType, \"/\", body, null);\n+        assertEquals(HttpStatus.SC_BAD_REQUEST, response.getResponseCode());\n+        assertTrue(response.getBody().startsWith(\n+                \"[{\\\"errors\\\":[{\\\"detail\\\":\\\"Invalid value: Resource(type=testModel, id=null, attributes={field=null}, relationships={models=com.yahoo.elide.jsonapi.models.Relationship@\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54d88920dc631eae3b02cb1943ec9e0104c94333"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d14c985b54bd8de4f4423bfae454f51fff815679", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/d14c985b54bd8de4f4423bfae454f51fff815679", "committedDate": "2020-04-28T16:18:44Z", "message": "Patch Extension Lifecycle tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e61da6aaa5fde41995b8fc5f8b1f180a682963d", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/3e61da6aaa5fde41995b8fc5f8b1f180a682963d", "committedDate": "2020-04-28T16:18:44Z", "message": "Missing check"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80e5d005b09e1b894e7d68923fcab8cb08441a20", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/80e5d005b09e1b894e7d68923fcab8cb08441a20", "committedDate": "2020-04-25T19:36:57Z", "message": "Missing check"}, "afterCommit": {"oid": "f79f70ec9372f505d210e007c0ee1a5c094eb2af", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/f79f70ec9372f505d210e007c0ee1a5c094eb2af", "committedDate": "2020-04-28T16:23:49Z", "message": "Update error body"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8697aa69a019610b5e926ed4c99ecca9189d8fb6", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/8697aa69a019610b5e926ed4c99ecca9189d8fb6", "committedDate": "2020-04-28T16:32:53Z", "message": "Update error body"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f79f70ec9372f505d210e007c0ee1a5c094eb2af", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/f79f70ec9372f505d210e007c0ee1a5c094eb2af", "committedDate": "2020-04-28T16:23:49Z", "message": "Update error body"}, "afterCommit": {"oid": "8697aa69a019610b5e926ed4c99ecca9189d8fb6", "author": {"user": {"login": "wcekan", "name": "William Cekan"}}, "url": "https://github.com/yahoo/elide/commit/8697aa69a019610b5e926ed4c99ecca9189d8fb6", "committedDate": "2020-04-28T16:32:53Z", "message": "Update error body"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDkzMjk0", "url": "https://github.com/yahoo/elide/pull/1280#pullrequestreview-402093294", "createdAt": "2020-04-28T18:15:52Z", "commit": {"oid": "8697aa69a019610b5e926ed4c99ecca9189d8fb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 909, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}