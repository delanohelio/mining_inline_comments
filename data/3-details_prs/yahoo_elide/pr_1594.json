{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MjQ1NDI4", "number": 1594, "title": "Elide 5: Sketch out support for nested query plans.", "bodyText": "Description\n\nEach metric has an optional query plan resolver that can produce a custom query plan for that metric.\nQuery plans can be nested.\nAdds support for merging nested and unnested query plans.\nAdds a translator which takes the merged query plan and the client query and constructs a final query.\nFixes a few issues with Time data type serdes.\n\nHow Has This Been Tested?\nMore tests are coming in final phase.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-10-15T16:55:42Z", "url": "https://github.com/yahoo/elide/pull/1594", "merged": true, "mergeCommit": {"oid": "ff9c594422737619f1a1d61c202a069684046ee5"}, "closed": true, "closedAt": "2020-10-15T21:52:48Z", "author": {"login": "aklish"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSM_GHgH2gAyNTA0MjQ1NDI4OjNiNWIzM2QxYjFkMDliMGZjMjE5MTZkMDNkMjg2MmMyZmRmMzFmYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS4u5ngFqTUwOTgyNTQ1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3b5b33d1b1d09b0fc21916d03d2862c2fdf31fae", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3b5b33d1b1d09b0fc21916d03d2862c2fdf31fae", "committedDate": "2020-10-13T18:35:39Z", "message": "added query plan to Metric formula"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78237eb6236fd775e4227bce62446ecfd759c5da", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/78237eb6236fd775e4227bce62446ecfd759c5da", "committedDate": "2020-10-13T19:46:28Z", "message": "Added monthly time grain to playerStats test table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "874028f7ffa05a255576865979f88426823fd20b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/874028f7ffa05a255576865979f88426823fd20b", "committedDate": "2020-10-13T22:08:46Z", "message": "Made query plan queryable.  Added query resolver test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7d1cd9b5b5a3857d9a3d5d50cfd030e49449c3", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/5f7d1cd9b5b5a3857d9a3d5d50cfd030e49449c3", "committedDate": "2020-10-13T22:11:05Z", "message": "Removed visit from SQLTable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40d1c4a78dd4d1da2e90853294a9ee0d91b8d9ad", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/40d1c4a78dd4d1da2e90853294a9ee0d91b8d9ad", "committedDate": "2020-10-13T22:45:01Z", "message": "Added QueryPlanTranslator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0afc7bc9fc1bf82480a4b2752764b017a3aa089", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d0afc7bc9fc1bf82480a4b2752764b017a3aa089", "committedDate": "2020-10-13T23:00:17Z", "message": "Added todo comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91d402177308073dbc2c276195bdc94c1f30f497", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/91d402177308073dbc2c276195bdc94c1f30f497", "committedDate": "2020-10-14T04:02:23Z", "message": "Fixed a number of bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa47a7d0db67d63e3227cb84c1a42e5a0ac8432b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/fa47a7d0db67d63e3227cb84c1a42e5a0ac8432b", "committedDate": "2020-10-14T17:02:58Z", "message": "Fixed more issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cded7e07c6eb9e6f7fcaace4f7c1e55be4dfc84", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/2cded7e07c6eb9e6f7fcaace4f7c1e55be4dfc84", "committedDate": "2020-10-14T18:14:54Z", "message": "Fixed all but one error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3e5b256f02a54f0044780e5f999d0bb2781392", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/2e3e5b256f02a54f0044780e5f999d0bb2781392", "committedDate": "2020-10-14T18:20:36Z", "message": "SQLUnitTest registers custom time serdes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b240f605f4bdaddafc94a7da804c5de529f7b523", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/b240f605f4bdaddafc94a7da804c5de529f7b523", "committedDate": "2020-10-14T19:42:15Z", "message": "Added withSource methods to do proper conversions of projections"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cae710e970668fc22e6d5ecf0c7646927e7b73fa", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/cae710e970668fc22e6d5ecf0c7646927e7b73fa", "committedDate": "2020-10-14T21:22:45Z", "message": "Added nesting and merge logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d19119d19fad329a3365cecc9cfe703a3c174a1f", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d19119d19fad329a3365cecc9cfe703a3c174a1f", "committedDate": "2020-10-14T22:20:07Z", "message": "Fixed issue with query symbol resolution.  QueryPlanResolver now sources projections directly from the SQL table."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9edd4267c49b630d45854897544e2b7c7d1d0496", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9edd4267c49b630d45854897544e2b7c7d1d0496", "committedDate": "2020-10-14T22:52:07Z", "message": "Fixed more issues."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc356ece85f8e09fda4a77ac16e8ee795331ed3d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/dc356ece85f8e09fda4a77ac16e8ee795331ed3d", "committedDate": "2020-10-14T23:53:59Z", "message": "Build passes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "538892d97f023d5d9e094dd585a3ac8d94b006c5", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/538892d97f023d5d9e094dd585a3ac8d94b006c5", "committedDate": "2020-10-15T14:30:59Z", "message": "Decoupled QueryPlan from SQL classes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8825c839ec98e55cb875d8fa50c0c9b7b7bf0ec", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a8825c839ec98e55cb875d8fa50c0c9b7b7bf0ec", "committedDate": "2020-10-15T15:29:59Z", "message": "Build Passes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec74d48e38fa519c7a245078f91a016464bf8dc6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/ec74d48e38fa519c7a245078f91a016464bf8dc6", "committedDate": "2020-10-15T16:09:50Z", "message": "Updated a few comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2bd82c1036549256de7b8f1ad555a3fb146d296", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a2bd82c1036549256de7b8f1ad555a3fb146d296", "committedDate": "2020-10-15T16:52:11Z", "message": "Added new dynamic sql reference resolver which avoids copying all the static lookups for each query."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5Nzg2OTY1", "url": "https://github.com/yahoo/elide/pull/1594#pullrequestreview-509786965", "createdAt": "2020-10-15T20:33:24Z", "commit": {"oid": "a2bd82c1036549256de7b8f1ad555a3fb146d296"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMDozMzoyNFrOHiZASg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMDozMzoyNFrOHiZASg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTgyMzMwNg==", "bodyText": "This could be written as if (!invoked)", "url": "https://github.com/yahoo/elide/pull/1594#discussion_r505823306", "createdAt": "2020-10-15T20:33:24Z", "author": {"login": "moizarafat"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/query/QueryPlanTranslator.java", "diffHunk": "@@ -0,0 +1,140 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+package com.yahoo.elide.datastores.aggregation.queryengines.sql.query;\n+\n+import static com.yahoo.elide.datastores.aggregation.query.QueryPlan.nestColumnProjection;\n+import static com.yahoo.elide.datastores.aggregation.query.QueryPlan.withSource;\n+\n+import com.yahoo.elide.datastores.aggregation.query.ColumnProjection;\n+import com.yahoo.elide.datastores.aggregation.query.Query;\n+import com.yahoo.elide.datastores.aggregation.query.QueryVisitor;\n+import com.yahoo.elide.datastores.aggregation.query.Queryable;\n+import com.yahoo.elide.datastores.aggregation.query.TimeDimensionProjection;\n+import com.google.common.collect.Streams;\n+\n+import java.util.LinkedHashSet;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Translates a merged query plan and a client query into query that can be executed.\n+ *\n+ * Column projection expressions originating from the query plan are left untouched.\n+ * Column projection expressions originating from the client query are nested for outer queries.\n+ */\n+public class QueryPlanTranslator implements QueryVisitor<Query.QueryBuilder> {\n+\n+    private Query clientQuery;\n+\n+    //Whether or not this visitor has been invoked yet.\n+    private boolean invoked = false;\n+\n+    public QueryPlanTranslator(Query clientQuery) {\n+        this.clientQuery = clientQuery;\n+    }\n+\n+    @Override\n+    public Query.QueryBuilder visitQuery(Query query) {\n+        throw new UnsupportedOperationException(\"Visitor does not visit queries\");\n+    }\n+\n+    @Override\n+    public Query.QueryBuilder visitQueryable(Queryable plan) {\n+        if (invoked == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2bd82c1036549256de7b8f1ad555a3fb146d296"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c3ab9c1292d6f9c6ef1f2ee864cf7784dcb11e1", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/5c3ab9c1292d6f9c6ef1f2ee864cf7784dcb11e1", "committedDate": "2020-10-15T21:27:15Z", "message": "Rework"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODI1NDU5", "url": "https://github.com/yahoo/elide/pull/1594#pullrequestreview-509825459", "createdAt": "2020-10-15T21:33:47Z", "commit": {"oid": "5c3ab9c1292d6f9c6ef1f2ee864cf7784dcb11e1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 733, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}