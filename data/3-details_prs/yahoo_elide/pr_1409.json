{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyNDQyNzgx", "number": 1409, "title": "Async change to use onReadPreSecurity Hook", "bodyText": "Description\ni) Moved Async execute query hook to onReadPreSecurity Hook.\nii) Had to tweak the logic for values updated using @PrePersist annotation as they were overriding the values set in onReadPreSecurity hook.\niii) A fix for potential NPE in Async Models Operation Check.\nMotivation and Context\nAsyncQuery submitted through Graphql end-point with asyncAfterSeconds 10 still comes back with embeddable results as null even though it finished before 10 seconds.\nBased on debugging, its happening cos of this. In GraphQL, the only part of the body that is lazily returned is the ID\nHow Has This Been Tested?\nExisting test cases passed.\nModified Graphql tests for Async\nVerified that the example code worked.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-07-01T05:01:32Z", "url": "https://github.com/yahoo/elide/pull/1409", "merged": true, "mergeCommit": {"oid": "ae8444a8b561969b746ba8d44e3ce04ea6ed43c7"}, "closed": true, "closedAt": "2020-07-02T15:07:20Z", "author": {"login": "moizarafat"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwdlitAH2gAyNDQyNDQyNzgxOjdhN2VlYzI3NzhlMGMyMWM1NzJjZjQzZTRhOWU0OTViMDY3ZTcxNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxARKXgFqTQ0MTc2OTMwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7a7eec2778e0c21c572cf43e4a9e495b067e7160", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/7a7eec2778e0c21c572cf43e4a9e495b067e7160", "committedDate": "2020-06-30T22:42:42Z", "message": "Fix for graphql async"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/8c76470483640bdb5347c0ab2ed8e197db250156", "committedDate": "2020-07-01T04:55:46Z", "message": "Aysnc ReadPreSecurity Hook"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTg0Mzgw", "url": "https://github.com/yahoo/elide/pull/1409#pullrequestreview-440984380", "createdAt": "2020-07-01T15:37:08Z", "commit": {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozNzowOFrOGrrL0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozODoyOVrOGrrO6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0OTQ5MQ==", "bodyText": "why would status ever be null?", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448449491", "createdAt": "2020-07-01T15:37:08Z", "author": {"login": "aklish"}, "path": "elide-async/src/main/java/com/yahoo/elide/async/models/AsyncQuery.java", "diffHunk": "@@ -69,7 +69,10 @@\n \n     @PrePersist\n     public void prePersistStatus() {\n-        status = QueryStatus.QUEUED;\n+        if (status == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDEyNg==", "bodyText": "Let's revisit how prePersist and preUpdate work.", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448450126", "createdAt": "2020-07-01T15:38:12Z", "author": {"login": "aklish"}, "path": "elide-async/src/main/java/com/yahoo/elide/async/models/AsyncBase.java", "diffHunk": "@@ -28,7 +28,14 @@\n \n     @PrePersist\n     public void prePersist() {\n-        createdOn = updatedOn = new Date();\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDI4MQ==", "bodyText": "I feel like this doesn't belong in this hook.", "url": "https://github.com/yahoo/elide/pull/1409#discussion_r448450281", "createdAt": "2020-07-01T15:38:29Z", "author": {"login": "aklish"}, "path": "elide-async/src/main/java/com/yahoo/elide/async/hooks/ExecuteQueryHook.java", "diffHunk": "@@ -28,6 +29,9 @@ public ExecuteQueryHook (AsyncExecutorService asyncExecutorService) {\n     @Override\n     public void execute(LifeCycleHookBinding.Operation operation, AsyncQuery query,\n                         RequestScope requestScope, Optional<ChangeSpec> changes) {\n-        asyncExecutorService.executeQuery(query, requestScope.getUser(), requestScope.getApiVersion());\n+        if (query.getStatus() == QueryStatus.QUEUED && query.getResult() == null) {\n+            asyncExecutorService.executeQuery(query, requestScope.getUser(), requestScope.getApiVersion());\n+            query.prePersist();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c76470483640bdb5347c0ab2ed8e197db250156"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a02947d5ec26926c342957517c84b34607655e8", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/4a02947d5ec26926c342957517c84b34607655e8", "committedDate": "2020-07-01T20:58:05Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cc52da43c4aa6e1caa00bd65dad8746003ce371", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/6cc52da43c4aa6e1caa00bd65dad8746003ce371", "committedDate": "2020-07-01T22:38:30Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da782d7db0e34acebdf028276fc42f4e8c7168a3", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/da782d7db0e34acebdf028276fc42f4e8c7168a3", "committedDate": "2020-07-01T22:48:19Z", "message": "Review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b01c8a4268c39c9cf0e609599ac7a508c12547a4", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/b01c8a4268c39c9cf0e609599ac7a508c12547a4", "committedDate": "2020-07-02T14:17:04Z", "message": "fix for NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3ebea5c69e6396f4b26fe466d746775a714714", "author": {"user": {"login": "moizarafat", "name": "Moiz Arafat"}}, "url": "https://github.com/yahoo/elide/commit/6f3ebea5c69e6396f4b26fe466d746775a714714", "committedDate": "2020-07-02T14:38:25Z", "message": "checkstyle fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzY5MzAx", "url": "https://github.com/yahoo/elide/pull/1409#pullrequestreview-441769301", "createdAt": "2020-07-02T15:07:07Z", "commit": {"oid": "b01c8a4268c39c9cf0e609599ac7a508c12547a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 886, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}