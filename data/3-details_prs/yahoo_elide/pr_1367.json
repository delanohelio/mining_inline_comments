{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3NDkwNjI4", "number": 1367, "title": "implement cancel function", "bodyText": "Resolves #1292 (if appropriate)\nDescription\n\n\n\nMotivation and Context\n\nHow Has This Been Tested?\n\n\n\nScreenshots (if appropriate):\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-06-03T22:38:23Z", "url": "https://github.com/yahoo/elide/pull/1367", "merged": true, "mergeCommit": {"oid": "ff86c56fde9064e1719ea35660fd04c42c949662"}, "closed": true, "closedAt": "2020-06-17T16:26:10Z", "author": {"login": "Rkr1992"}, "timelineItems": {"totalCount": 73, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnxS5XgH2gAyNDI3NDkwNjI4OmMwNDkyZmY5ODg3YmYzZWFkODgyZTY2NzZmOGQ0YjZiZWYyZmJjMTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsMZ_cAFqTQzMjU2OTQxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c0492ff9887bf3ead882e6676f8d4b6bef2fbc12", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c0492ff9887bf3ead882e6676f8d4b6bef2fbc12", "committedDate": "2020-06-03T22:35:07Z", "message": "implement cancel function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0NDc1NzQ4", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-424475748", "createdAt": "2020-06-04T13:56:48Z", "commit": {"oid": "c0492ff9887bf3ead882e6676f8d4b6bef2fbc12"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMzo1Njo0OFrOGfHQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxNDowODozNlrOGfHz8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI3Nzg2MA==", "bodyText": "Elide core should not depend directly on Hibernate.  Only the data stores that use hibernate should have this dependency.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435277860", "createdAt": "2020-06-04T13:56:48Z", "author": {"login": "aklish"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/CancelSession.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+import org.hibernate.Session;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0492ff9887bf3ead882e6676f8d4b6bef2fbc12"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI4MTUyMw==", "bodyText": "Instead of creating an abstract class - create a functional interface (with no dependencies on things like hibernate).", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435281523", "createdAt": "2020-06-04T14:01:36Z", "author": {"login": "aklish"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/CancelSession.java", "diffHunk": "@@ -0,0 +1,23 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+import org.hibernate.Session;\n+\n+/**\n+ * Cancel Session implementation.\n+ */\n+\n+public abstract class CancelSession {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0492ff9887bf3ead882e6676f8d4b6bef2fbc12"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTI4NzAyNQ==", "bodyText": "YOu can make this a local variable and use it multiple places.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435287025", "createdAt": "2020-06-04T14:08:36Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -376,10 +378,10 @@ default AuditLogger getAuditLogger() {\n      */\n     default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore aggregationDataStore,\n             EntityManagerFactory entityManagerFactory) {\n-\n+\tCancelSession cancelSession = new CancelSession(entityManagerFactory.get().unwrap(Session.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0492ff9887bf3ead882e6676f8d4b6bef2fbc12"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6dd1de7fddc77fd1ca4f814b4d6e0f0d5de3bb1", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a6dd1de7fddc77fd1ca4f814b4d6e0f0d5de3bb1", "committedDate": "2020-06-04T19:59:53Z", "message": "addressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/b916ca0a64e0659854cd15ae47b1b35b0c1260ce", "committedDate": "2020-06-04T20:01:31Z", "message": "addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0ODUzOTI3", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-424853927", "createdAt": "2020-06-04T21:37:56Z", "commit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMTozNzo1N1rOGfY7Vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQyMjoxNDozOVrOGfZ03A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2NzQ0Nw==", "bodyText": "Don't create an entityManager here.  Let the transaction create the entity manager.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435567447", "createdAt": "2020-06-04T21:37:57Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStore.java", "diffHunk": "@@ -75,6 +83,23 @@ public void populateEntityDictionary(EntityDictionary dictionary) {\n \n     @Override\n     public DataStoreTransaction beginTransaction() {\n-        return new AggregationDataStoreTransaction(queryEngine);\n+\tEntityManager entityManager = entityManagerSupplier.get();        ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2NzYyMg==", "bodyText": "Let's not add an EntityManagerSupplier to the constructor.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435567622", "createdAt": "2020-06-04T21:38:24Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStore.java", "diffHunk": "@@ -22,26 +22,34 @@\n import java.util.List;\n import java.util.Set;\n \n+import javax.persistence.EntityManager;\n+\n /**\n  * DataStore that supports Aggregation. Uses {@link QueryEngine} to return results.\n  */\n public class AggregationDataStore implements DataStore {\n     private QueryEngine queryEngine;\n     private Set<Class<?>> dynamicCompiledClasses;\n+    protected final AggregationDataStoreTransactionCancel aggregationDataStoreTransactionCancel;\n+    protected final EntityManagerSupplier entityManagerSupplier;\n \n     /**\n      * These are the classes the Aggregation Store manages.\n      */\n     private static final List<Class<? extends Annotation>> AGGREGATION_STORE_CLASSES =\n             Arrays.asList(FromTable.class, FromSubquery.class);\n \n-    public AggregationDataStore(QueryEngine queryEngine) {\n+    public AggregationDataStore(EntityManagerSupplier entityManagerSupplier, QueryEngine queryEngine, AggregationDataStoreTransactionCancel aggregationDataStoreTransactionCancel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2NzY4OA==", "bodyText": "Remove", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435567688", "createdAt": "2020-06-04T21:38:35Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStore.java", "diffHunk": "@@ -75,6 +83,23 @@ public void populateEntityDictionary(EntityDictionary dictionary) {\n \n     @Override\n     public DataStoreTransaction beginTransaction() {\n-        return new AggregationDataStoreTransaction(queryEngine);\n+\tEntityManager entityManager = entityManagerSupplier.get();        \n+        return new AggregationDataStoreTransaction(entityManager, queryEngine, aggregationDataStoreTransactionCancel);\n+    }\n+\n+    /**\n+     * Functional interface for describing a method to supply EntityManager.\n+     */\n+    @FunctionalInterface\n+    public interface EntityManagerSupplier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2Nzk3OQ==", "bodyText": "Can we shorten the name of this interface (we already know this is for the AggregationDataStore since it is an inner class).", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435567979", "createdAt": "2020-06-04T21:39:14Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStore.java", "diffHunk": "@@ -75,6 +83,23 @@ public void populateEntityDictionary(EntityDictionary dictionary) {\n \n     @Override\n     public DataStoreTransaction beginTransaction() {\n-        return new AggregationDataStoreTransaction(queryEngine);\n+\tEntityManager entityManager = entityManagerSupplier.get();        \n+        return new AggregationDataStoreTransaction(entityManager, queryEngine, aggregationDataStoreTransactionCancel);\n+    }\n+\n+    /**\n+     * Functional interface for describing a method to supply EntityManager.\n+     */\n+    @FunctionalInterface\n+    public interface EntityManagerSupplier {\n+        EntityManager get();\n+    }\n+\n+    /**\n+     * Functional interface for describing a method to supply AggregationDataStoreTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface  AggregationDataStoreTransactionCancel {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU2ODQzNg==", "bodyText": "Remove the entity manager from the constructor.  The AggregationStore (other than the SQLQueryEngine) should not have a direct dependency on the EntityManager", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435568436", "createdAt": "2020-06-04T21:40:23Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStoreTransaction.java", "diffHunk": "@@ -15,13 +15,20 @@\n import com.google.common.annotations.VisibleForTesting;\n \n import java.io.IOException;\n+\n+import javax.persistence.EntityManager;\n+\n /**\n  * Transaction handler for {@link AggregationDataStore}.\n  */\n public class AggregationDataStoreTransaction extends DataStoreTransactionImplementation {\n+    private EntityManager em;\n     private QueryEngine queryEngine;\n-    public AggregationDataStoreTransaction(QueryEngine queryEngine) {\n-        this.queryEngine = queryEngine;\n+    private AggregationDataStore.AggregationDataStoreTransactionCancel aggregationDataStoreTransactionCancel;\n+    public AggregationDataStoreTransaction(EntityManager em, QueryEngine queryEngine, AggregationDataStore.AggregationDataStoreTransactionCancel aggregationDataStoreTransactionCancel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MDAxOQ==", "bodyText": "Instead of implementing cancel here, why not move this to the super class?", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435570019", "createdAt": "2020-06-04T21:44:12Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/main/java/com/yahoo/elide/datastores/jpa/transaction/NonJtaTransaction.java", "diffHunk": "@@ -61,4 +63,9 @@ public void close() throws IOException {\n     public boolean isOpen() {\n         return transaction.isActive();\n     }\n+\n+    @Override\n+    public void cancel() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MDE3Nw==", "bodyText": "Why not implement cancel here so we don't have to redefine it in each subclass.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435570177", "createdAt": "2020-06-04T21:44:35Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/main/java/com/yahoo/elide/datastores/jpa/transaction/AbstractJpaTransaction.java", "diffHunk": "@@ -55,10 +56,12 @@\n     protected final EntityManager em;\n     private final EntityManagerWrapper emWrapper;\n     private final LinkedHashSet<Runnable> deferredTasks = new LinkedHashSet<>();\n+    private final JpaDataStore.JpaTransactionCancel jpaTransactionCancel;\n \n-    protected AbstractJpaTransaction(EntityManager em) {\n+    protected AbstractJpaTransaction(EntityManager em, JpaDataStore.JpaTransactionCancel jpaTransactionCancel) {\n         this.em = em;\n         this.emWrapper = new EntityManagerWrapper(em);\n+\tthis.jpaTransactionCancel = jpaTransactionCancel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MDY1NA==", "bodyText": "This can be assigned like:\njpaTransactionCancel = (entityManager) -> { entityManager.unwrap(Session.class).cancelQuery();};\nand then you can reuse jpaTransactionCancel below.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435570654", "createdAt": "2020-06-04T21:45:41Z", "author": {"login": "aklish"}, "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideAutoConfiguration.java", "diffHunk": "@@ -170,19 +171,25 @@ public DataStore buildDataStore(EntityManagerFactory entityManagerFactory, Query\n             ObjectProvider<ElideDynamicEntityCompiler> dynamicCompiler, ElideConfigProperties settings)\n             throws ClassNotFoundException {\n         AggregationDataStore aggregationDataStore = null;\n+\tJpaDataStore.JpaTransactionCancel jpaTransactionCancel = null;\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU3MTU4MQ==", "bodyText": "This doesn't look right - why are we defining the cancel method twice here and passing it through two separate functions?", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435571581", "createdAt": "2020-06-04T21:47:44Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -376,11 +377,10 @@ default AuditLogger getAuditLogger() {\n      */\n     default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore aggregationDataStore,\n             EntityManagerFactory entityManagerFactory) {\n-\n         DataStore jpaDataStore = new JpaDataStore(\n                 () -> { return entityManagerFactory.createEntityManager(); },\n-                (em -> { return new NonJtaTransaction(em); }));\n-\n+\t\t(em -> { return new NonJtaTransaction(em, em.unwrap(Session.class).cancelQuery()); }),\n+                     (entityManager -> { entityManager.unwrap(Session.class).cancelQuery();}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU4MTg4Ng==", "bodyText": "Remove entityManagerFactory as an argument.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435581886", "createdAt": "2020-06-04T22:13:56Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -393,18 +393,19 @@ default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore\n      * @return AggregationDataStore object initialized.\n      */\n     default AggregationDataStore getAggregationDataStore(QueryEngine queryEngine,\n-            Optional<ElideDynamicEntityCompiler> optionalCompiler) {\n+            Optional<ElideDynamicEntityCompiler> optionalCompiler, EntityManagerFactory entityManagerFactory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTU4MjE3Mg==", "bodyText": "We define the transaction cancel method four times.  Let's define this once with a static, final variable and just use that everywhere.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r435582172", "createdAt": "2020-06-04T22:14:39Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -393,18 +393,19 @@ default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore\n      * @return AggregationDataStore object initialized.\n      */\n     default AggregationDataStore getAggregationDataStore(QueryEngine queryEngine,\n-            Optional<ElideDynamicEntityCompiler> optionalCompiler) {\n+            Optional<ElideDynamicEntityCompiler> optionalCompiler, EntityManagerFactory entityManagerFactory) {\n         AggregationDataStore aggregationDataStore = null;\n-\n         if (enableDynamicModelConfig()) {\n             Set<Class<?>> annotatedClasses = getDynamicClassesIfAvailable(optionalCompiler, FromTable.class);\n             annotatedClasses.addAll(getDynamicClassesIfAvailable(optionalCompiler, FromSubquery.class));\n-            aggregationDataStore = new AggregationDataStore(queryEngine, annotatedClasses);\n+\t    aggregationDataStore = new AggregationDataStore(\n+            \t() -> { return entityManagerFactory.createEntityManager(); },\n+                queryEngine, annotatedClass, (entityManager -> { entityManager.unwrap(Session.class).cancelQuery();}));\n         } else {\n-            aggregationDataStore = new AggregationDataStore(queryEngine);\n+            aggregationDataStore = new AggregationDataStore(\n+            \t() -> { return entityManagerFactory.createEntityManager(); },\n+                queryEngine, (entityManager -> { entityManager.unwrap(Session.class).cancelQuery();}));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b916ca0a64e0659854cd15ae47b1b35b0c1260ce"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de929061ff81b6969c97c27683791b478c0ac1c2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/de929061ff81b6969c97c27683791b478c0ac1c2", "committedDate": "2020-06-05T18:23:32Z", "message": "Future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f13304cf0dbe305f4b321d4d1a6626186bb82370", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f13304cf0dbe305f4b321d4d1a6626186bb82370", "committedDate": "2020-06-05T18:24:36Z", "message": "Future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9013381cc2c3b0e5c639b3d61dba7211a7c9af33", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9013381cc2c3b0e5c639b3d61dba7211a7c9af33", "committedDate": "2020-06-05T18:29:35Z", "message": "Future implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTM5NTc4", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-425539578", "createdAt": "2020-06-05T18:40:58Z", "commit": {"oid": "9013381cc2c3b0e5c639b3d61dba7211a7c9af33"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxODo0MDo1OFrOGf5dKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxODo0MTozOVrOGf5eog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEwMDM5Mg==", "bodyText": "Just return a Future here instead of the Implementation.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436100392", "createdAt": "2020-06-05T18:40:58Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/QueryEngine.java", "diffHunk": "@@ -163,7 +163,7 @@ private void populateMetaData(MetaDataStore metaDataStore) {\n      * @param query The query customized for a particular persistent storage or storage client\n      * @return query results\n      */\n-    public abstract QueryResult executeQuery(Query query);\n+    public abstract FutureImplementation<QueryResult> executeQuery(Query query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9013381cc2c3b0e5c639b3d61dba7211a7c9af33"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEwMDc3MA==", "bodyText": "You could make this an inner class of the SQLQueryEngine - not abstract - and it can just call the TransactionCancel member.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436100770", "createdAt": "2020-06-05T18:41:39Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/FutureImplementation.java", "diffHunk": "@@ -0,0 +1,21 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+import com.yahoo.elide.datastores.aggregation.query.QueryResult;\n+import com.yahoo.elide.datastores.aggregation.queryengines.sql.query.SQLQueryEngine;\n+\n+import java.util.concurrent.Future;\n+\n+public abstract class FutureImplementation implements Future<QueryResult> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9013381cc2c3b0e5c639b3d61dba7211a7c9af33"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0", "committedDate": "2020-06-05T19:56:20Z", "message": "Future implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NjM4NjI1", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-425638625", "createdAt": "2020-06-05T21:35:28Z", "commit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTozNToyOFrOGf9-9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQyMTo0MjoxMFrOGf-H9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NDU4MA==", "bodyText": "So this line creates a new session and then immediately cancels it.  We want to close the existing session - not a new one.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436174580", "createdAt": "2020-06-05T21:35:28Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +291,28 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+  \n+    public class FutureImplementation implements Future<QueryResult> {\n+        private final TransactionCancel transactionCancel;\n+\tprivate final EntityManagerFactory entityManagerFactory;\n+        /**\n+\t * Cancels transaction\n+         */\n+    \t@Override\n+\tprotected FutureImplementation(EntityManagerFactory entityManagerFactory, TransactionCancel transactionCancel) {\n+\t    this.transactionCancel = transactionCancel;\n+\t    this.entityManagerFactory = entityManagerFactory;\n+\t}\n+    \tpublic boolean cancel(boolean mayInterruptIfRunning) {\n+            transactionCancel.cancel(entityManagerFactory.createEntityManager());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NDcwOA==", "bodyText": "There are several places where spacing is off.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436174708", "createdAt": "2020-06-05T21:35:50Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -60,13 +61,14 @@\n @Slf4j\n public class SQLQueryEngine extends QueryEngine {\n     private final EntityManagerFactory entityManagerFactory;\n-\n+    private final TransactionCancel transactionCancel;\n     private final SQLReferenceTable referenceTable;\n \n-    public SQLQueryEngine(MetaDataStore metaDataStore, EntityManagerFactory entityManagerFactory, Cache cache) {\n+    public SQLQueryEngine(MetaDataStore metaDataStore, EntityManagerFactory entityManagerFactory, Cache cache, TransactionCancel transactionCancel) {\n         super(metaDataStore, cache);\n         this.entityManagerFactory = entityManagerFactory;\n         this.referenceTable = new SQLReferenceTable(metaDataStore);\n+\tthis.transactionCancel = transactionCancel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NTA2MA==", "bodyText": "An inner class can reference the members of the outer class if it is not static.  There is no need to:\n\nDefine private members\nHave a constructor with arguments.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436175060", "createdAt": "2020-06-05T21:36:52Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +291,28 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+  \n+    public class FutureImplementation implements Future<QueryResult> {\n+        private final TransactionCancel transactionCancel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NTUzMw==", "bodyText": "Let's find a better name than FutureImplementation.  How about QueryResultFuture?", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436175533", "createdAt": "2020-06-05T21:38:06Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +291,28 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+  \n+    public class FutureImplementation implements Future<QueryResult> {\n+        private final TransactionCancel transactionCancel;\n+\tprivate final EntityManagerFactory entityManagerFactory;\n+        /**\n+\t * Cancels transaction\n+         */\n+    \t@Override\n+\tprotected FutureImplementation(EntityManagerFactory entityManagerFactory, TransactionCancel transactionCancel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NTY4OQ==", "bodyText": "Add @Override.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436175689", "createdAt": "2020-06-05T21:38:33Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +291,28 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+  \n+    public class FutureImplementation implements Future<QueryResult> {\n+        private final TransactionCancel transactionCancel;\n+\tprivate final EntityManagerFactory entityManagerFactory;\n+        /**\n+\t * Cancels transaction\n+         */\n+    \t@Override\n+\tprotected FutureImplementation(EntityManagerFactory entityManagerFactory, TransactionCancel transactionCancel) {\n+\t    this.transactionCancel = transactionCancel;\n+\t    this.entityManagerFactory = entityManagerFactory;\n+\t}\n+    \tpublic boolean cancel(boolean mayInterruptIfRunning) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3NjMwMA==", "bodyText": "I don't see the implementation of executeQuery that returns a Future here.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436176300", "createdAt": "2020-06-05T21:40:26Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -60,13 +61,14 @@\n @Slf4j\n public class SQLQueryEngine extends QueryEngine {\n     private final EntityManagerFactory entityManagerFactory;\n-\n+    private final TransactionCancel transactionCancel;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjE3Njg4NQ==", "bodyText": "You are missing a lot of the other Future functions.  There is more than just cancel.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r436176885", "createdAt": "2020-06-05T21:42:10Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +291,28 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+  \n+    public class FutureImplementation implements Future<QueryResult> {\n+        private final TransactionCancel transactionCancel;\n+\tprivate final EntityManagerFactory entityManagerFactory;\n+        /**\n+\t * Cancels transaction\n+         */\n+    \t@Override\n+\tprotected FutureImplementation(EntityManagerFactory entityManagerFactory, TransactionCancel transactionCancel) {\n+\t    this.transactionCancel = transactionCancel;\n+\t    this.entityManagerFactory = entityManagerFactory;\n+\t}\n+    \tpublic boolean cancel(boolean mayInterruptIfRunning) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e97a518992f9a15ef4ce2c6a9d48fbacabaa1d0"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f08727cf16a6ab9570bf506573ee9b5995ecb910", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f08727cf16a6ab9570bf506573ee9b5995ecb910", "committedDate": "2020-06-06T00:02:15Z", "message": "Future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e694992ae92fcce5f385921b2180c2c8a5458e4", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/4e694992ae92fcce5f385921b2180c2c8a5458e4", "committedDate": "2020-06-09T21:35:10Z", "message": "adding Future Task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69bb59dc6373110fb697c9f912cc73857df7c26", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/b69bb59dc6373110fb697c9f912cc73857df7c26", "committedDate": "2020-06-09T22:09:12Z", "message": "adding Future Task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65af8b243bc06462059e6c1977505db4efcf5388", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/65af8b243bc06462059e6c1977505db4efcf5388", "committedDate": "2020-06-09T22:33:27Z", "message": "adding Future Task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8064be350bc30ffb58923074f4a08d143f3c21c5", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8064be350bc30ffb58923074f4a08d143f3c21c5", "committedDate": "2020-06-10T17:04:53Z", "message": "fixing future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e34abc31bbdf2ddbdb8dc969684bc3c0c624c3c6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/e34abc31bbdf2ddbdb8dc969684bc3c0c624c3c6", "committedDate": "2020-06-10T18:05:10Z", "message": "fixing future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c63c3d82c2ec38784396bc1fd4ca2d8b18dd891", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/4c63c3d82c2ec38784396bc1fd4ca2d8b18dd891", "committedDate": "2020-06-10T18:07:37Z", "message": "fixing future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4688f151689cff2275c12a329d38538c7ad565f6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/4688f151689cff2275c12a329d38538c7ad565f6", "committedDate": "2020-06-10T18:55:24Z", "message": "fixing future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d67de6ec5eec028d55c9df130c44932fedfe53", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/82d67de6ec5eec028d55c9df130c44932fedfe53", "committedDate": "2020-06-10T19:02:28Z", "message": "fixing future implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c637d51fba403ac0e2c8fad524d4ea781e985951", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c637d51fba403ac0e2c8fad524d4ea781e985951", "committedDate": "2020-06-10T21:39:13Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ea7627e62a20cc5592eae3bf24453e210b79cd9", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3ea7627e62a20cc5592eae3bf24453e210b79cd9", "committedDate": "2020-06-10T22:01:16Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffb6b1c36820405ee659715b424ba9fffeb98848", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/ffb6b1c36820405ee659715b424ba9fffeb98848", "committedDate": "2020-06-10T22:05:31Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cd05225a53f92969d1ad2e198bcc69a8bbf6553", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3cd05225a53f92969d1ad2e198bcc69a8bbf6553", "committedDate": "2020-06-11T00:50:38Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a38cdada5722b35cd77d0afa75b6a83402edcc", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/29a38cdada5722b35cd77d0afa75b6a83402edcc", "committedDate": "2020-06-11T00:55:14Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db6c4df81cfb8cccb5e68525a34a81e9dbac1615", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/db6c4df81cfb8cccb5e68525a34a81e9dbac1615", "committedDate": "2020-06-11T01:12:50Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68abcb04edd68bd0f0ea6af213cc5e78fe3c1031", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/68abcb04edd68bd0f0ea6af213cc5e78fe3c1031", "committedDate": "2020-06-11T01:27:34Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ebdbab6e70fcaf1d59b9ebb0981c0c121a88b03", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3ebdbab6e70fcaf1d59b9ebb0981c0c121a88b03", "committedDate": "2020-06-11T01:43:40Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d139dd8d8e92c95d0b8f84fa9d055008d19a276", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/7d139dd8d8e92c95d0b8f84fa9d055008d19a276", "committedDate": "2020-06-11T03:10:16Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e0ab2803bf8ac47057c1034d4d1959febdbf99a", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9e0ab2803bf8ac47057c1034d4d1959febdbf99a", "committedDate": "2020-06-11T03:21:38Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8a42cd685b6b84d87214b0a08760ed7f087499b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a8a42cd685b6b84d87214b0a08760ed7f087499b", "committedDate": "2020-06-11T03:28:35Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffe953c5821f3ca64e149b0920ec0f47ee862d81", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/ffe953c5821f3ca64e149b0920ec0f47ee862d81", "committedDate": "2020-06-11T03:35:13Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fee0a69a9fbf86639427c06f3c1675cd95d7abb", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3fee0a69a9fbf86639427c06f3c1675cd95d7abb", "committedDate": "2020-06-11T03:49:26Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24a43c7260331ffdf3b6a62853a3601a983a5f63", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/24a43c7260331ffdf3b6a62853a3601a983a5f63", "committedDate": "2020-06-11T03:52:03Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a6dbc1186dfd5231d531fe04795a27b68f4fcd2", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9a6dbc1186dfd5231d531fe04795a27b68f4fcd2", "committedDate": "2020-06-11T04:44:12Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07810b7bffcba1c415accbeada4401a05592beca", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/07810b7bffcba1c415accbeada4401a05592beca", "committedDate": "2020-06-11T05:06:25Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c210de6174fbb8680f4aa6a04ae3adeda9f90e7d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c210de6174fbb8680f4aa6a04ae3adeda9f90e7d", "committedDate": "2020-06-11T05:22:27Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18a8cc9d0da96a239329ca6b6c4b7eecee346b8e", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/18a8cc9d0da96a239329ca6b6c4b7eecee346b8e", "committedDate": "2020-06-11T05:49:07Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "310d11332a6723ae95ce225bfbec09597935909b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/310d11332a6723ae95ce225bfbec09597935909b", "committedDate": "2020-06-11T06:22:02Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da7ea017126a52888a1be9b1b4aa5c084a8700bd", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/da7ea017126a52888a1be9b1b4aa5c084a8700bd", "committedDate": "2020-06-11T06:25:43Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e8f8450a484566ff07562918af320fbffa4c5ed", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9e8f8450a484566ff07562918af320fbffa4c5ed", "committedDate": "2020-06-11T06:49:39Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f287eb56a4bde971ba3121faf61d3c579827e2cd", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f287eb56a4bde971ba3121faf61d3c579827e2cd", "committedDate": "2020-06-11T07:09:21Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "479ad805c404204be32af9870b7bf439d3cf6862", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/479ad805c404204be32af9870b7bf439d3cf6862", "committedDate": "2020-06-11T07:29:28Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c492c68cc1cd98c7ae88b9286a345b73443a8af3", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/c492c68cc1cd98c7ae88b9286a345b73443a8af3", "committedDate": "2020-06-11T14:34:20Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b630aaf4f5175e7587005b180b5617e104cd172", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/6b630aaf4f5175e7587005b180b5617e104cd172", "committedDate": "2020-06-11T14:40:52Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3716a136a00ca61ed4365003e1ccad69f61fc6d3", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3716a136a00ca61ed4365003e1ccad69f61fc6d3", "committedDate": "2020-06-11T14:52:59Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26f34ef28a3beaf029049dd3beec09acf765d0df", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/26f34ef28a3beaf029049dd3beec09acf765d0df", "committedDate": "2020-06-11T15:08:02Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4f5aecf8e7d441dc3839c820184852cdac19e2a", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a4f5aecf8e7d441dc3839c820184852cdac19e2a", "committedDate": "2020-06-11T15:23:43Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "471c4d3c04b78a7e762f891c3b8bc8f8cd62c01d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/471c4d3c04b78a7e762f891c3b8bc8f8cd62c01d", "committedDate": "2020-06-11T15:44:51Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f302a834556e9a38bece0c4b6f1bca6173db345", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/6f302a834556e9a38bece0c4b6f1bca6173db345", "committedDate": "2020-06-11T16:05:55Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e08e565fc31abb27d39659a8381192db2831f858", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/e08e565fc31abb27d39659a8381192db2831f858", "committedDate": "2020-06-11T16:26:12Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbc78efebfee88fee8f9052ca71b03de71d4361c", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/dbc78efebfee88fee8f9052ca71b03de71d4361c", "committedDate": "2020-06-11T16:57:40Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5069401f814dc776db4b3487dfa8b8a7f7b1f09", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/e5069401f814dc776db4b3487dfa8b8a7f7b1f09", "committedDate": "2020-06-11T17:13:24Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cdd85204ff743b88bbdc0422484c5730888a136", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/4cdd85204ff743b88bbdc0422484c5730888a136", "committedDate": "2020-06-11T17:33:46Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86c33d3c97613f23a745dff57f381775d776d1c6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/86c33d3c97613f23a745dff57f381775d776d1c6", "committedDate": "2020-06-11T17:59:11Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ae6a5c40ca2d4afdc72228d181f8c115f77c48", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/97ae6a5c40ca2d4afdc72228d181f8c115f77c48", "committedDate": "2020-06-11T18:11:42Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d54810e706258af15b2411b879d8c33ad66f6772", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d54810e706258af15b2411b879d8c33ad66f6772", "committedDate": "2020-06-11T18:29:12Z", "message": "ExecutionException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a285916e33b17f94ef6c9d76dd39cf45ad365d25", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a285916e33b17f94ef6c9d76dd39cf45ad365d25", "committedDate": "2020-06-11T21:49:27Z", "message": "fixing issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d62363e7c52af8ec7d45eb0c06a7c22bdcf9bc0", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/6d62363e7c52af8ec7d45eb0c06a7c22bdcf9bc0", "committedDate": "2020-06-11T22:44:35Z", "message": "aggregation changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8996a29ba6b51f4a375860b1a17bf103ca2de92", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/b8996a29ba6b51f4a375860b1a17bf103ca2de92", "committedDate": "2020-06-11T23:02:00Z", "message": "aggregation changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7097877104df197c860dc14db785fbad533d5ee", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f7097877104df197c860dc14db785fbad533d5ee", "committedDate": "2020-06-11T23:29:20Z", "message": "aggregation changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3123771c5f0dd5b3f4684a3315f57c941aa3a1f4", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3123771c5f0dd5b3f4684a3315f57c941aa3a1f4", "committedDate": "2020-06-12T03:12:42Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf243848d8af7942dbef80d6cd6f8b0e2c5a2ea4", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/bf243848d8af7942dbef80d6cd6f8b0e2c5a2ea4", "committedDate": "2020-06-12T03:18:44Z", "message": "fixing bugs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43ce9e801ed051344593d1af60db17481904b045", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/43ce9e801ed051344593d1af60db17481904b045", "committedDate": "2020-06-12T03:42:36Z", "message": "fixing bugs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI5ODQwNTI1", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-429840525", "createdAt": "2020-06-12T15:34:55Z", "commit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNTozNDo1NVrOGjIdvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMlQxNTo1NToyMlrOGjJJUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjAyOQ==", "bodyText": "Can you mention in the comments that the implementation must be thread-safe?", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439492029", "createdAt": "2020-06-12T15:34:55Z", "author": {"login": "aklish"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/DataStoreTransaction.java", "diffHunk": "@@ -267,4 +267,9 @@ default boolean supportsPagination(Class<?> entityClass, FilterExpression expres\n      * @return UUID id\n      */\n     UUID getRequestId();\n+\n+    /**\n+     * cancel running transaction", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5MjQ3Nw==", "bodyText": "You don't need to call run() here.  Calling queryResult.get() should invoke queryResult.run()", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439492477", "createdAt": "2020-06-12T15:35:44Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStoreTransaction.java", "diffHunk": "@@ -52,11 +56,21 @@ public void createObject(Object entity, RequestScope scope) {\n     @Override\n     public Iterable<Object> loadObjects(EntityProjection entityProjection, RequestScope scope) {\n         Query query = buildQuery(entityProjection, scope);\n-        QueryResult result = queryEngine.executeQuery(query);\n-        if (entityProjection.getPagination() != null && entityProjection.getPagination().returnPageTotals()) {\n-            entityProjection.getPagination().setPageTotals(result.getPageTotals());\n+        queryResult = queryEngine.executeQuery(query);\n+        queryResult.run();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5Mjk0NA==", "bodyText": "Don't set null here.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439492944", "createdAt": "2020-06-12T15:36:36Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/AggregationDataStoreTransaction.java", "diffHunk": "@@ -52,11 +56,21 @@ public void createObject(Object entity, RequestScope scope) {\n     @Override\n     public Iterable<Object> loadObjects(EntityProjection entityProjection, RequestScope scope) {\n         Query query = buildQuery(entityProjection, scope);\n-        QueryResult result = queryEngine.executeQuery(query);\n-        if (entityProjection.getPagination() != null && entityProjection.getPagination().returnPageTotals()) {\n-            entityProjection.getPagination().setPageTotals(result.getPageTotals());\n+        queryResult = queryEngine.executeQuery(query);\n+        queryResult.run();\n+        try {\n+            QueryResult result = queryResult.get();\n+            if (entityProjection.getPagination() != null && entityProjection.getPagination().returnPageTotals()) {\n+                entityProjection.getPagination().setPageTotals(result.getPageTotals());\n+            }\n+            return result.getData();\n+        } catch (TransactionException e) {\n+            throw new TransactionException(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5Mzk1NQ==", "bodyText": "cache is much more readable than cx.  Can you revert back to the more readable variable names?", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439493955", "createdAt": "2020-06-12T15:38:23Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -60,13 +62,15 @@\n @Slf4j\n public class SQLQueryEngine extends QueryEngine {\n     private final EntityManagerFactory entityManagerFactory;\n-\n+    private final TransactionCancel transactionCancel;\n     private final SQLReferenceTable referenceTable;\n+    private EntityManager entityManager;\n \n-    public SQLQueryEngine(MetaDataStore metaDataStore, EntityManagerFactory entityManagerFactory, Cache cache) {\n-        super(metaDataStore, cache);\n-        this.entityManagerFactory = entityManagerFactory;\n-        this.referenceTable = new SQLReferenceTable(metaDataStore);\n+    public SQLQueryEngine(MetaDataStore mDStore, EntityManagerFactory emFactory, Cache cx, TransactionCancel txCancel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NDEwNA==", "bodyText": "Same for mDStore, qEngine, emFactory, etc.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439494104", "createdAt": "2020-06-12T15:38:39Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -60,13 +62,15 @@\n @Slf4j\n public class SQLQueryEngine extends QueryEngine {\n     private final EntityManagerFactory entityManagerFactory;\n-\n+    private final TransactionCancel transactionCancel;\n     private final SQLReferenceTable referenceTable;\n+    private EntityManager entityManager;\n \n-    public SQLQueryEngine(MetaDataStore metaDataStore, EntityManagerFactory entityManagerFactory, Cache cache) {\n-        super(metaDataStore, cache);\n-        this.entityManagerFactory = entityManagerFactory;\n-        this.referenceTable = new SQLReferenceTable(metaDataStore);\n+    public SQLQueryEngine(MetaDataStore mDStore, EntityManagerFactory emFactory, Cache cx, TransactionCancel txCancel) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5Mzk1NQ=="}, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NTY3Mg==", "bodyText": "This inner class is missing javadoc.  The linter will complain.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439495672", "createdAt": "2020-06-12T15:41:21Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SQLQueryEngine.java", "diffHunk": "@@ -289,4 +302,27 @@ private SQLQuery toPageTotalSQL(SQLQuery sql) {\n     public static String getClassAlias(Class<?> entityClass) {\n         return getTypeAlias(entityClass);\n     }\n+\n+    /**\n+     * Functional interface for describing a method to supply JpaTransaction.\n+     */\n+    @FunctionalInterface\n+    public interface TransactionCancel {\n+        public void cancel(EntityManager entityManager);\n+    }\n+\n+    public class QueryResultFuture<V> extends FutureTask<V> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5NzQxOQ==", "bodyText": "This code is violating DRY (do not repeat yourself).  Make a function in this class to avoid repeating the same block over and over.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439497419", "createdAt": "2020-06-12T15:44:44Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/QueryEngineTest.java", "diffHunk": "@@ -55,8 +58,20 @@ public void testFullTableLoad() {\n                 .timeDimension(toProjection(playerStatsTable.getTimeDimension(\"recordedDate\"), TimeGrain.DAY))\n                 .build();\n \n-        List<Object> results = StreamSupport.stream(engine.executeQuery(query).getData().spliterator(), false)\n+        List<Object> results;\n+        FutureTask<QueryResult> queryResult = engine.executeQuery(query);\n+        queryResult.run();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5Nzc5MA==", "bodyText": "Remove all references to queryResult.run() in this PR.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439497790", "createdAt": "2020-06-12T15:45:25Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SubselectTest.java", "diffHunk": "@@ -87,7 +92,10 @@ public void testJoinToFilter() throws Exception {\n                         PlayerStats.class, false))\n                 .build();\n \n-        List<Object> results = StreamSupport.stream(engine.executeQuery(query).getData().spliterator(), false)\n+        FutureTask<QueryResult> queryResult = engine.executeQuery(query);\n+        queryResult.run();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5ODM3MA==", "bodyText": "The delta between the original line and your modifications can be just 4 characters:\nList<Object> results = StreamSupport.stream(engine.executeQuery(query).get().getData().spliterator(), false)", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439498370", "createdAt": "2020-06-12T15:46:25Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/SubselectTest.java", "diffHunk": "@@ -87,7 +92,10 @@ public void testJoinToFilter() throws Exception {\n                         PlayerStats.class, false))\n                 .build();\n \n-        List<Object> results = StreamSupport.stream(engine.executeQuery(query).getData().spliterator(), false)\n+        FutureTask<QueryResult> queryResult = engine.executeQuery(query);\n+        queryResult.run();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5Nzc5MA=="}, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTQ5OTAwMg==", "bodyText": "For UnitTests, you can simply have the test throw Exception and avoid all these try catch blocks.\nLook at my prior comments - all of this can be changed by just adding 4 characters - without these large blocks of duplicate code.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439499002", "createdAt": "2020-06-12T15:47:40Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/queryengines/sql/ViewTest.java", "diffHunk": "@@ -46,8 +50,20 @@ public void testViewAttribute() {\n                 .sorting(new SortingImpl(sortMap, PlayerStatsWithView.class, dictionary))\n                 .build();\n \n-        List<Object> results = StreamSupport.stream(engine.executeQuery(query).getData().spliterator(), false)\n+        List<Object> results;\n+        FutureTask<QueryResult> queryResult = engine.executeQuery(query);\n+        queryResult.run();\n+        try {\n+            QueryResult result = queryResult.get();\n+            results = StreamSupport.stream(result.getData().spliterator(), false)\n                 .collect(Collectors.toList());\n+        } catch (TransactionException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMDE2MQ==", "bodyText": "You shouldn't need to pass transactionCancel as an argument to the supplier.  When the supplier is created, it can have a reference to transactionSupplier through closure.  Remove this extra argument.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439500161", "createdAt": "2020-06-12T15:49:47Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/main/java/com/yahoo/elide/datastores/jpa/JpaDataStore.java", "diffHunk": "@@ -73,15 +78,15 @@ public void populateEntityDictionary(EntityDictionary dictionary) {\n     @Override\n     public DataStoreTransaction beginReadTransaction() {\n         EntityManager entityManager = entityManagerSupplier.get();\n-        JpaTransaction transaction = readTransactionSupplier.get(entityManager);\n+        JpaTransaction transaction = readTransactionSupplier.get(entityManager, jpaTransactionCancel);\n         transaction.begin();\n         return transaction;\n     }\n \n     @Override\n     public DataStoreTransaction beginTransaction() {\n         EntityManager entityManager = entityManagerSupplier.get();\n-        JpaTransaction transaction = writeTransactionSupplier.get(entityManager);\n+        JpaTransaction transaction = writeTransactionSupplier.get(entityManager, jpaTransactionCancel);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMTIwNQ==", "bodyText": "So for example, there is no need to include txCancel as a parameter to the supplier.  Rewrite like:\n(entityManager) -> { return new NonJtaTransaction(entityManager, jpaTransactionCancel); }", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439501205", "createdAt": "2020-06-12T15:51:43Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/test/java/com/yahoo/elide/datastores/jpa/JpaDataStoreHarness.java", "diffHunk": "@@ -96,7 +99,8 @@ public JpaDataStoreHarness() {\n \n         store = new JpaDataStore(\n                 () -> { return emf.createEntityManager(); },\n-                (entityManager) -> { return new NonJtaTransaction(entityManager); }\n+                (entityManager, txCancel) -> { return new NonJtaTransaction(entityManager, txCancel); },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMjQzMQ==", "bodyText": "Because the signatures are the same, you may be able to define this once as a Function rather than the concrete types above - and just use the single reference below.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439502431", "createdAt": "2020-06-12T15:54:01Z", "author": {"login": "aklish"}, "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideAutoConfiguration.java", "diffHunk": "@@ -56,6 +58,10 @@\n      * @return An instance of ElideDynamicEntityCompiler.\n      * @throws Exception Exception thrown.\n      */\n+\n+     private final AbstractJpaTransaction.JpaTransactionCancel jTC = (e) -> { e.unwrap(Session.class).cancelQuery(); };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMjk0NA==", "bodyText": "Remove txCancel from the supplier.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439502944", "createdAt": "2020-06-12T15:54:59Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -376,10 +382,10 @@ default AuditLogger getAuditLogger() {\n      */\n     default DataStore getDataStore(MetaDataStore metaDataStore, AggregationDataStore aggregationDataStore,\n             EntityManagerFactory entityManagerFactory) {\n-\n         DataStore jpaDataStore = new JpaDataStore(\n                 () -> { return entityManagerFactory.createEntityManager(); },\n-                (em -> { return new NonJtaTransaction(em); }));\n+                ((em, txCancel) -> { return new NonJtaTransaction(em, txCancel); }),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzOTUwMzE4Ng==", "bodyText": "See if these can be consolidated into a single variable using one of Java's built in Function classes.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r439503186", "createdAt": "2020-06-12T15:55:22Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -56,6 +58,10 @@\n  */\n public interface ElideStandaloneSettings {\n     /* Elide settings */\n+\n+     public final AbstractJpaTransaction.JpaTransactionCancel JTC = (m) -> { m.unwrap(Session.class).cancelQuery(); };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43ce9e801ed051344593d1af60db17481904b045"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f1cfb480ee2db34373cee4ca35e5eef6b339a51", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/8f1cfb480ee2db34373cee4ca35e5eef6b339a51", "committedDate": "2020-06-12T23:23:05Z", "message": "rebasing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5094ce020f2de18f1a34294178dd857eba7af5c4", "author": {"user": {"login": "Rkr1992", "name": null}}, "url": "https://github.com/yahoo/elide/commit/5094ce020f2de18f1a34294178dd857eba7af5c4", "committedDate": "2020-06-12T23:44:45Z", "message": "Merge branch 'elide-5.x' into implement-cancel-function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7556cb189b6e83070942c10bdaf33054ecc0f71", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d7556cb189b6e83070942c10bdaf33054ecc0f71", "committedDate": "2020-06-13T04:39:35Z", "message": "adddressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6dd7bddcc572305a4c25663c97a26506b81bc86", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/d6dd7bddcc572305a4c25663c97a26506b81bc86", "committedDate": "2020-06-13T04:58:46Z", "message": "adddressing comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/10b08031c01a3228c6f335ba5b1d51b0da68f8e6", "committedDate": "2020-06-13T04:59:15Z", "message": "addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTAxODc4", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-432501878", "createdAt": "2020-06-17T15:08:40Z", "commit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTowODo0MVrOGlKXSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNToxNDozN1rOGlKp1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMDI5Ng==", "bodyText": "Remove this comment.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r441620296", "createdAt": "2020-06-17T15:08:41Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/main/java/com/yahoo/elide/datastores/jpa/JpaDataStore.java", "diffHunk": "@@ -8,7 +8,7 @@\n import com.yahoo.elide.core.DataStoreTransaction;\n import com.yahoo.elide.core.EntityDictionary;\n import com.yahoo.elide.core.datastore.JPQLDataStore;\n-import com.yahoo.elide.datastores.jpa.transaction.AbstractJpaTransaction;\n+//import com.yahoo.elide.datastores.jpa.transaction.AbstractJpaTransaction;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMTI5Ng==", "bodyText": "Unify the variable names txCancel and jpaTransactionCancel.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r441621296", "createdAt": "2020-06-17T15:09:57Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-jpa/src/main/java/com/yahoo/elide/datastores/jpa/transaction/JtaTransaction.java", "diffHunk": "@@ -22,11 +23,11 @@\n @Slf4j\n public class JtaTransaction extends AbstractJpaTransaction {\n     private final UserTransaction transaction;\n-    public JtaTransaction(EntityManager entityManager, JpaTransactionCancel jpaTransactionCancel) {\n+    public JtaTransaction(EntityManager entityManager, Consumer<EntityManager> jpaTransactionCancel) {\n         this(entityManager, lookupUserTransaction(), jpaTransactionCancel);\n     }\n \n-    public JtaTransaction(EntityManager entityManager, UserTransaction transaction, JpaTransactionCancel txCancel) {\n+    public JtaTransaction(EntityManager entityManager, UserTransaction transaction, Consumer<EntityManager> txCancel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyMzU3Mg==", "bodyText": "txCancel was a better name than func.  I would change everywhere.", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r441623572", "createdAt": "2020-06-17T15:12:43Z", "author": {"login": "aklish"}, "path": "elide-spring/elide-spring-boot-autoconfigure/src/main/java/com/yahoo/elide/spring/config/ElideAutoConfiguration.java", "diffHunk": "@@ -59,8 +60,7 @@\n      * @throws Exception Exception thrown.\n      */\n \n-     private final AbstractJpaTransaction.JpaTransactionCancel jTC = (e) -> { e.unwrap(Session.class).cancelQuery(); };\n-     private final SQLQueryEngine.TransactionCancel txCancel = (em) -> { em.unwrap(Session.class).cancelQuery(); };\n+     private final Consumer<EntityManager> func = (em) -> { em.unwrap(Session.class).cancelQuery(); };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyNDI5NQ==", "bodyText": "Rename to TXCANCEL", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r441624295", "createdAt": "2020-06-17T15:13:33Z", "author": {"login": "aklish"}, "path": "elide-standalone/src/main/java/com/yahoo/elide/standalone/config/ElideStandaloneSettings.java", "diffHunk": "@@ -59,8 +59,7 @@\n public interface ElideStandaloneSettings {\n     /* Elide settings */\n \n-     public final AbstractJpaTransaction.JpaTransactionCancel JTC = (m) -> { m.unwrap(Session.class).cancelQuery(); };\n-     public final SQLQueryEngine.TransactionCancel TXCANCEL = (m) -> { m.unwrap(Session.class).cancelQuery(); };\n+     public final Consumer<EntityManager> FUNC = (em) -> { em.unwrap(Session.class).cancelQuery(); };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYyNTA0NA==", "bodyText": "Let's add javadoc for cancel (close isn't needed because it is an Override).", "url": "https://github.com/yahoo/elide/pull/1367#discussion_r441625044", "createdAt": "2020-06-17T15:14:37Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/QueryEngine.java", "diffHunk": "@@ -157,6 +156,7 @@ private void populateMetaData(MetaDataStore metaDataStore) {\n     public interface Transaction extends AutoCloseable {\n         @Override\n         void close();\n+        void cancel();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10b08031c01a3228c6f335ba5b1d51b0da68f8e6"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "127517bb46972dbe127cfd5e32d70439aa385381", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/127517bb46972dbe127cfd5e32d70439aa385381", "committedDate": "2020-06-17T15:57:56Z", "message": "addressing comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTY5NDE4", "url": "https://github.com/yahoo/elide/pull/1367#pullrequestreview-432569418", "createdAt": "2020-06-17T16:26:00Z", "commit": {"oid": "127517bb46972dbe127cfd5e32d70439aa385381"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 862, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}