{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczODk0MTQ5", "number": 1185, "title": "@Join and JoinPath", "bodyText": "Resolves #1005\nDescription\n\nAdd @Join annotation for Table to use to join to other tables or entities.\nAdd JoinPath which is a path but can navigate through models using @Join annotation.\nAdd TableTag and ColumnTag.\nAdd API in EntityDictionary to allow hiding a field from API.\n\nHow Has This Been Tested?\nunit tests and integration tests.\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-02-11T21:34:55Z", "url": "https://github.com/yahoo/elide/pull/1185", "merged": true, "mergeCommit": {"oid": "c0c645b123ff64639745fb69609d93f26d7a96fa"}, "closed": true, "closedAt": "2020-02-14T21:37:20Z", "author": {"login": "hellohanchen"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDYqXVgH2gAyMzczODk0MTQ5OjI3OTk2YWI5ZTMxODAyYWY4MmQ5NjVmYjI0Nzg2OGNlMWE4Nzk2NmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEVyG5gFqTM1OTIwODQ5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27996ab9e31802af82d965fb247868ce1a87966b", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/27996ab9e31802af82d965fb247868ce1a87966b", "committedDate": "2020-02-11T21:31:51Z", "message": "@Join and JoinPath"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/61009fd265d67ece00180374f489c8418aa3c9e8", "committedDate": "2020-02-11T21:53:12Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4276472725ae74a1f80d545d0a9c2698ee9d18e8", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/4276472725ae74a1f80d545d0a9c2698ee9d18e8", "committedDate": "2020-02-11T22:01:06Z", "message": "hide non-jpd entities in grpahql"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3053cdf49c4b019a7204f1418e77678efe8eac40", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/3053cdf49c4b019a7204f1418e77678efe8eac40", "committedDate": "2020-02-11T22:41:45Z", "message": "hide joins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDU3Mzkz", "url": "https://github.com/yahoo/elide/pull/1185#pullrequestreview-357057393", "createdAt": "2020-02-11T22:54:56Z", "commit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMjo1NDo1NlrOFocK7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQyMzoxMDowMVrOFochIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0ODkwOA==", "bodyText": "This logic is almost identical to code in the Path constructor.   Two recommendations to commonize:\n\nMove resolveJoinPathElements to Path and add a function parameter which determines whether a field is a relationship.\nSubclass EntityDictionary with a copy constructor that overrides isRelation.  Pass the new EntityDictionary to the super class constructor.", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377948908", "createdAt": "2020-02-11T22:54:56Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/core/JoinPath.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.datastores.aggregation.core;\n+\n+import static com.yahoo.elide.datastores.aggregation.metadata.MetaDataStore.isTableJoin;\n+\n+import com.yahoo.elide.core.EntityDictionary;\n+import com.yahoo.elide.core.Path;\n+import com.yahoo.elide.core.exceptions.InvalidValueException;\n+import com.yahoo.elide.datastores.aggregation.annotation.Join;\n+\n+import com.google.common.collect.ImmutableList;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+/**\n+ * JoinPath extends {@link Path} to allow navigation through {@link Join} annotation.\n+ */\n+public class JoinPath extends Path {\n+    public JoinPath(Class<?> entityClass, EntityDictionary dictionary, String dotSeparatedPath) {\n+        super(resolveJoinPathElements(entityClass, dictionary, dotSeparatedPath));\n+    }\n+\n+    private static List<PathElement> resolveJoinPathElements(Class<?> entityClass,\n+                                                             EntityDictionary dictionary,\n+                                                             String dotSeparatedPath) {\n+        List<PathElement> elements = new ArrayList<>();\n+        String[] fieldNames = dotSeparatedPath.split(\"\\\\.\");\n+\n+        Class<?> currentClass = entityClass;\n+        for (String fieldName : fieldNames) {\n+            if (dictionary.isRelation(currentClass, fieldName) || isTableJoin(currentClass, fieldName, dictionary)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTI1Mg==", "bodyText": "Column Tag is removed in the latest model.  It is replaced with a set of strings.", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377949252", "createdAt": "2020-02-11T22:55:50Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/enums/ColumnTag.java", "diffHunk": "@@ -0,0 +1,14 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.datastores.aggregation.metadata.enums;\n+\n+/**\n+ * Tag attached to fields.\n+ */\n+public enum ColumnTag {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTM2NQ==", "bodyText": "Table Tag is removed in the latest model.  It is replaced with a set of Strings.", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377949365", "createdAt": "2020-02-11T22:56:08Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/enums/TableTag.java", "diffHunk": "@@ -8,6 +8,6 @@\n /**\n  * Tag attached to fields.\n  */\n-public enum Tag {\n+public enum TableTag {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTU4Ng==", "bodyText": "Set<String>", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377949586", "createdAt": "2020-02-11T22:56:41Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/models/Column.java", "diffHunk": "@@ -45,7 +45,7 @@\n     private DataType dataType;\n \n     @ToString.Exclude\n-    private Set<Tag> columnTags;\n+    private Set<ColumnTag> columnTags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk0OTc1OA==", "bodyText": "Set<String>", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377949758", "createdAt": "2020-02-11T22:57:05Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/models/Table.java", "diffHunk": "@@ -55,6 +57,9 @@\n     @ToString.Exclude\n     private Set<Dimension> dimensions;\n \n+    @ToString.Exclude\n+    private Set<TableTag> tableTags;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzk1NDU5NA==", "bodyText": "I'm worried countryView is going to show up in the GraphQL schema as an attribute.  While we can always have the developer add @Exclude, it would be better if JoinTo automatically excluded the property.\nOne way to do this is to promote AggregationStore annotations to elide-annotations as  first class citizens.  I think Elide 5.0 should collapse elide-annotations and elide-core because there are natural dependencies between them.\nI don't want to do that collapse now though because it will make rebasing harder.\nAnother option is to allow the entity dictionary to accept hints when the data store binds the entities.  We could make another bindEntity method that takes additional annotations to exclude while binding.  I think for now, I favor this option.", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r377954594", "createdAt": "2020-02-11T23:10:01Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/test/java/com/yahoo/elide/datastores/aggregation/example/PlayerStatsWithView.java", "diffHunk": "@@ -200,8 +200,7 @@ public void setSubCountryIsoCode(String isoCode) {\n         this.subCountryIsoCode = isoCode;\n     }\n \n-    @ToOne\n-    @JoinTo(joinClause = \"%from.country_id = %join.id\")\n+    @Join(\"%from.country_id = %join.id\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "61009fd265d67ece00180374f489c8418aa3c9e8"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e", "committedDate": "2020-02-12T17:08:52Z", "message": "refactor hidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MDI2NDI4", "url": "https://github.com/yahoo/elide/pull/1185#pullrequestreview-359026428", "createdAt": "2020-02-14T15:35:34Z", "commit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTozNTozNFrOFp6mqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNFQxNTo0MjowMFrOFp60xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5NjEwNQ==", "bodyText": "Why not have this method call the new bindEntity method with an empty set (or a set that includes Exclude)?", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r379496105", "createdAt": "2020-02-14T15:35:34Z", "author": {"login": "aklish"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/EntityDictionary.java", "diffHunk": "@@ -872,7 +889,29 @@ public void bindEntity(Class<?> cls) {\n         }\n \n         bindJsonApiToEntity.put(type, declaredClass);\n-        entityBindings.put(declaredClass, new EntityBinding(this, declaredClass, type, name));\n+        entityBindings.put(declaredClass, new EntityBinding(this, declaredClass, type, name, hiddenAnnotations));\n+        if (include.rootLevel()) {\n+            bindEntityRoots.add(declaredClass);\n+        }\n+    }\n+\n+    /**\n+     * Add an EntityBinding instance to dictionary.\n+     *\n+     * @param entityBinding EntityBinding instance\n+     */\n+    public void bindEntity(EntityBinding entityBinding) {\n+        Class<?> declaredClass = entityBinding.entityClass;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5NjYwNQ==", "bodyText": "Nice", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r379496605", "createdAt": "2020-02-14T15:36:28Z", "author": {"login": "aklish"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/Path.java", "diffHunk": "@@ -70,7 +87,20 @@ public Path(Class<?> entityClass, EntityDictionary dictionary, String dotSeparat\n                 throw new InvalidValueException(alias + \" doesn't contain the field \" + fieldName);\n             }\n         }\n-        pathElements = ImmutableList.copyOf(elements);\n+\n+        return ImmutableList.copyOf(elements);\n+    }\n+\n+    /**\n+     * Check whether a field need navigation to another entity.\n+     *\n+     * @param entityClass entity class\n+     * @param fieldName field name\n+     * @param dictionary dictionary\n+     * @return True if the field requires navigation.\n+     */\n+    protected boolean needNavigation(Class<?> entityClass, String fieldName, EntityDictionary dictionary) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5ODEwNQ==", "bodyText": "Why do we need ant?", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r379498105", "createdAt": "2020-02-14T15:39:06Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/pom.xml", "diffHunk": "@@ -178,6 +178,13 @@\n             <version>2.5.0</version>\n             <scope>test</scope>\n         </dependency>\n+\n+        <dependency>\n+            <groupId>org.apache.ant</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTQ5OTcxOA==", "bodyText": "If Table is going to be a simple POJO - we probably don't need to pass dictionary to it.  This will also simplify the Fili integration.", "url": "https://github.com/yahoo/elide/pull/1185#discussion_r379499718", "createdAt": "2020-02-14T15:42:00Z", "author": {"login": "aklish"}, "path": "elide-datastore/elide-datastore-aggregation/src/main/java/com/yahoo/elide/datastores/aggregation/metadata/models/Table.java", "diffHunk": "@@ -55,17 +57,21 @@\n     @ToString.Exclude\n     private Set<Dimension> dimensions;\n \n+    @ToString.Exclude\n+    private Set<String> tableTags;\n+\n     @Exclude\n     @ToString.Exclude\n     private final Map<String, Column> columnMap;\n \n     public Table(Class<?> cls, EntityDictionary dictionary) {\n-        if (!dictionary.getBindings().contains(cls)) {\n+        if (!dictionary.getBoundClasses().contains(cls)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b0d1f7e5e020bb9cd4afc2f2295ba54622f7a7e"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db5479b43fbb135551b430001cd7ecc6c4c56e5c", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/db5479b43fbb135551b430001cd7ecc6c4c56e5c", "committedDate": "2020-02-14T20:43:37Z", "message": "remove ant"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5MjA4NDk5", "url": "https://github.com/yahoo/elide/pull/1185#pullrequestreview-359208499", "createdAt": "2020-02-14T20:44:31Z", "commit": {"oid": "db5479b43fbb135551b430001cd7ecc6c4c56e5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 636, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}