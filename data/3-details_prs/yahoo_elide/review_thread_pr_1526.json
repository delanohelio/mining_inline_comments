{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyNTI4MzAx", "number": 1526, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1MDowOFrOEh2pbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1Nzo1OVrOEh2ziQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTMzODA3OnYy", "diffSide": "RIGHT", "path": "elide-async/src/test/resources/bb31ca4e-ed8f-4be0-a0f3-12099fb9263f", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1MDowOFrOHPZ05g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1MDowOFrOHPZ05g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxMzgzMA==", "bodyText": "Maybe we can move this under a subdirectory with a descriptive name so it is clear what this file is about.", "url": "https://github.com/yahoo/elide/pull/1526#discussion_r485913830", "createdAt": "2020-09-09T20:50:08Z", "author": {"login": "aklish"}, "path": "elide-async/src/test/resources/bb31ca4e-ed8f-4be0-a0f3-12099fb9263f", "diffHunk": "@@ -0,0 +1 @@\n+test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c561cc7d495e19a78069c814100520454684cfda"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTM0NTY5OnYy", "diffSide": "RIGHT", "path": "elide-async/src/main/java/com/yahoo/elide/async/service/FileResultStorageEngine.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1MjoyOFrOHPZ5lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1MjoyOFrOHPZ5lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxNTAyOQ==", "bodyText": "can we add longer names for s and t so it is clear what they are?", "url": "https://github.com/yahoo/elide/pull/1526#discussion_r485915029", "createdAt": "2020-09-09T20:52:28Z", "author": {"login": "aklish"}, "path": "elide-async/src/main/java/com/yahoo/elide/async/service/FileResultStorageEngine.java", "diffHunk": "@@ -0,0 +1,123 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+\n+package com.yahoo.elide.async.service;\n+\n+import com.yahoo.elide.async.models.AsyncQuery;\n+\n+import io.reactivex.Observable;\n+import lombok.Getter;\n+import lombok.Setter;\n+import lombok.extern.slf4j.Slf4j;\n+\n+import java.io.BufferedReader;\n+import java.io.BufferedWriter;\n+import java.io.File;\n+import java.io.IOException;\n+import java.nio.file.Files;\n+import java.nio.file.Paths;\n+import java.util.Iterator;\n+\n+import javax.inject.Singleton;\n+\n+/**\n+ * Default implementation of ResultStorageEngine that stores results on local filesystem.\n+ * It supports Async Module to store results with async query.\n+ */\n+@Singleton\n+@Slf4j\n+@Getter\n+public class FileResultStorageEngine implements ResultStorageEngine {\n+    @Setter private String basePath;\n+\n+    public FileResultStorageEngine() {\n+    }\n+\n+    /**\n+     * Constructor.\n+     * @param basePath basePath for storing the files. Can be absolute or relative.\n+     */\n+    public FileResultStorageEngine(String basePath) {\n+        this.basePath = basePath;\n+    }\n+\n+    @Override\n+    public AsyncQuery storeResults(AsyncQuery asyncQuery, Observable<String> result) {\n+        log.debug(\"store AsyncResults for Download\");\n+\n+        try (BufferedWriter writer = getWriter(asyncQuery.getId())) {\n+            result\n+                .map(s -> s.concat(System.getProperty(\"line.separator\")))\n+                .subscribe(\n+                        s -> {\n+                            writer.write(s);\n+                            writer.flush();\n+                        },\n+                        t -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c561cc7d495e19a78069c814100520454684cfda"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTM2MDEzOnYy", "diffSide": "RIGHT", "path": "elide-async/src/test/java/com/yahoo/elide/async/service/FileResultStorageEngineTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1Njo0MFrOHPaCLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1Njo0MFrOHPaCLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxNzIzMQ==", "bodyText": "This block is repeated over and over.  Let's make a function and reuse it.", "url": "https://github.com/yahoo/elide/pull/1526#discussion_r485917231", "createdAt": "2020-09-09T20:56:40Z", "author": {"login": "aklish"}, "path": "elide-async/src/test/java/com/yahoo/elide/async/service/FileResultStorageEngineTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.async.service;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import com.yahoo.elide.async.models.AsyncQuery;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import io.reactivex.Observable;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+\n+/**\n+ * Test cases for FileResultStorageEngine.\n+ */\n+public class FileResultStorageEngineTest {\n+\n+    @Test\n+    public void testRead() {\n+        FileResultStorageEngine engine = new FileResultStorageEngine(\"src/test/resources\");\n+        String queryId = \"bb31ca4e-ed8f-4be0-a0f3-12099fb9263f\";\n+        String finalResult = engine.getResultsByID(queryId).collect(() -> new StringBuilder(),\n+                (resultBuilder, tempResult) -> {\n+                    if (resultBuilder.length() > 0) {\n+                        resultBuilder.append(System.getProperty(\"line.separator\"));\n+                    }\n+                    resultBuilder.append(tempResult);\n+                }\n+                ).map(StringBuilder::toString).blockingGet();\n+\n+        assertEquals(finalResult, \"test\");\n+    }\n+\n+    @Test\n+    public void testReadEmptyFile() {\n+        FileResultStorageEngine engine = new FileResultStorageEngine(\"src/test/resources\");\n+        String finalResult = engine.getResultsByID(\"bb31ca4e-ed8f-4be0-a0f3-12099fb9263e\").collect(() -> new StringBuilder(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c561cc7d495e19a78069c814100520454684cfda"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzOTM2MzkzOnYy", "diffSide": "RIGHT", "path": "elide-async/src/test/java/com/yahoo/elide/async/service/FileResultStorageEngineTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1Nzo1OVrOHPaEkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQyMDo1Nzo1OVrOHPaEkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTkxNzg0Mw==", "bodyText": "We should read it back and verify we can return what we wrote out.", "url": "https://github.com/yahoo/elide/pull/1526#discussion_r485917843", "createdAt": "2020-09-09T20:57:59Z", "author": {"login": "aklish"}, "path": "elide-async/src/test/java/com/yahoo/elide/async/service/FileResultStorageEngineTest.java", "diffHunk": "@@ -0,0 +1,94 @@\n+/*\n+ * Copyright 2020, Yahoo Inc.\n+ * Licensed under the Apache License, Version 2.0\n+ * See LICENSE file in project root for terms.\n+ */\n+package com.yahoo.elide.async.service;\n+\n+import static org.junit.jupiter.api.Assertions.assertEquals;\n+import static org.junit.jupiter.api.Assertions.assertThrows;\n+import static org.junit.jupiter.api.Assertions.assertTrue;\n+\n+import com.yahoo.elide.async.models.AsyncQuery;\n+\n+import org.junit.jupiter.api.Test;\n+import org.junit.jupiter.api.io.TempDir;\n+\n+import io.reactivex.Observable;\n+\n+import java.io.File;\n+import java.nio.file.Path;\n+\n+/**\n+ * Test cases for FileResultStorageEngine.\n+ */\n+public class FileResultStorageEngineTest {\n+\n+    @Test\n+    public void testRead() {\n+        FileResultStorageEngine engine = new FileResultStorageEngine(\"src/test/resources\");\n+        String queryId = \"bb31ca4e-ed8f-4be0-a0f3-12099fb9263f\";\n+        String finalResult = engine.getResultsByID(queryId).collect(() -> new StringBuilder(),\n+                (resultBuilder, tempResult) -> {\n+                    if (resultBuilder.length() > 0) {\n+                        resultBuilder.append(System.getProperty(\"line.separator\"));\n+                    }\n+                    resultBuilder.append(tempResult);\n+                }\n+                ).map(StringBuilder::toString).blockingGet();\n+\n+        assertEquals(finalResult, \"test\");\n+    }\n+\n+    @Test\n+    public void testReadEmptyFile() {\n+        FileResultStorageEngine engine = new FileResultStorageEngine(\"src/test/resources\");\n+        String finalResult = engine.getResultsByID(\"bb31ca4e-ed8f-4be0-a0f3-12099fb9263e\").collect(() -> new StringBuilder(),\n+                (resultBuilder, tempResult) -> {\n+                    if (resultBuilder.length() > 0) {\n+                        resultBuilder.append(System.getProperty(\"line.separator\"));\n+                    }\n+                    resultBuilder.append(tempResult);\n+                }\n+                ).map(StringBuilder::toString).blockingGet();\n+\n+        assertEquals(finalResult, \"\");\n+    }\n+\n+    @Test\n+    public void testReadNonExistentFile() {\n+        FileResultStorageEngine engine = new FileResultStorageEngine(\"src/test/resources\");\n+        assertThrows(IllegalStateException.class, () ->\n+            engine.getResultsByID(\"bb31ca4e-ed8f-4be0-a0f3-12099fb9263d\").collect(() -> new StringBuilder(),\n+                (resultBuilder, tempResult) -> {\n+                    if (resultBuilder.length() > 0) {\n+                        resultBuilder.append(System.getProperty(\"line.separator\"));\n+                    }\n+                    resultBuilder.append(tempResult);\n+                }\n+            ).map(StringBuilder::toString).blockingGet()\n+        );\n+    }\n+\n+    @Test\n+    public void testStoreResults(@TempDir Path tempDir) {\n+        String queryId = \"bb31ca4e-ed8f-4be0-a0f3-12099fb9263c\";\n+        FileResultStorageEngine engine = new FileResultStorageEngine(tempDir.toString());\n+        AsyncQuery query = new AsyncQuery();\n+        query.setId(queryId);\n+        engine.storeResults(query, Observable.fromArray(new String[]{\"hi\", \"hello\"}));\n+        File file = new File(tempDir.toString() + File.separator + queryId);\n+        assertTrue(file.exists());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c561cc7d495e19a78069c814100520454684cfda"}, "originalPosition": 81}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 966, "cost": 1, "resetAt": "2021-11-13T14:23:39Z"}}}