{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2ODMwOTIw", "number": 1275, "title": "Short Circuit Filter Expression Security If User Checks would pass/fail.", "bodyText": "Description\nEvaluating security for filter expressions currently fetches the relationships involved in the filter expression.  This can result in unnecessary database queries if the only security rules are User checks.\nMotivation and Context\nRemove unnecessary database calls when we can evaluate security statically.\nHow Has This Been Tested?\nUnit Tests - TBD\nLicense\nI confirm that this contribution is made under an Apache 2.0 license and that I have the authority necessary to make this contribution on behalf of its copyright owner.", "createdAt": "2020-04-21T18:25:15Z", "url": "https://github.com/yahoo/elide/pull/1275", "merged": true, "mergeCommit": {"oid": "6993e35fbfabff4144b028e53fa24398dd2d2e39"}, "closed": true, "closedAt": "2020-04-21T21:45:39Z", "author": {"login": "aklish"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZ36LlgH2gAyNDA2ODMwOTIwOjk4NTVmNjU4N2I1MGI0ZmQzNjRiOTkxMzNlMzc2MTVkZDY2NWQ2YTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZ6P0vAFqTM5NzY3NTAzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9855f6587b50b4fd364b99133e37615dd665d6a1", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/9855f6587b50b4fd364b99133e37615dd665d6a1", "committedDate": "2020-04-21T18:22:31Z", "message": "Fleshed out optimization to bypass relationship fetches for filter security evaluation if User Check would pass/fail"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99b0de064e053afa659a747015f2aeeb2c05a448", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/99b0de064e053afa659a747015f2aeeb2c05a448", "committedDate": "2020-04-21T19:08:56Z", "message": "Added unit tests for changes to permission executor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db689788488d8b2688418278927894ab71e94a05", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/db689788488d8b2688418278927894ab71e94a05", "committedDate": "2020-04-21T19:29:48Z", "message": "Finished unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32bc9f1eca5a54702b84b7da23174e9c531ae65d", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/32bc9f1eca5a54702b84b7da23174e9c531ae65d", "committedDate": "2020-04-21T19:42:19Z", "message": "added explicit check that data store transaction was not invoked"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7a3453dfda0e424b3d3003761afb70c49980bfa", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/f7a3453dfda0e424b3d3003761afb70c49980bfa", "committedDate": "2020-04-21T20:17:49Z", "message": "Fixing bug"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d822edd8757e4ff2be00547366d865b8d01eca8", "author": {"user": {"login": "aklish", "name": "Aaron Klish"}}, "url": "https://github.com/yahoo/elide/commit/9d822edd8757e4ff2be00547366d865b8d01eca8", "committedDate": "2020-04-21T20:39:22Z", "message": "Merge branch 'master' into ShortCircuitRelationshipFetches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NjY1NDU1", "url": "https://github.com/yahoo/elide/pull/1275#pullrequestreview-397665455", "createdAt": "2020-04-21T20:50:52Z", "commit": {"oid": "9d822edd8757e4ff2be00547366d865b8d01eca8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDo1MDo1MlrOGJX68g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQyMDo1MDo1MlrOGJX68g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjQ4MjI5MA==", "bodyText": "If this is FAIL should we return FAIL here too?", "url": "https://github.com/yahoo/elide/pull/1275#discussion_r412482290", "createdAt": "2020-04-21T20:50:52Z", "author": {"login": "wcekan"}, "path": "elide-core/src/main/java/com/yahoo/elide/core/VerifyFieldAccessFilterExpressionVisitor.java", "diffHunk": "@@ -74,6 +85,28 @@ public Boolean visitPredicate(FilterPredicate filterPredicate) {\n         return resource.getRelationChecked(fieldName, Optional.empty(), Optional.empty(), Optional.empty()).stream();\n     }\n \n+    private ExpressionResult evaluateUserChecks(Path path) {\n+        PermissionExecutor executor = resource.getRequestScope().getPermissionExecutor();\n+\n+        ExpressionResult result = ExpressionResult.PASS;\n+\n+        for (Path.PathElement element : path.getPathElements()) {\n+            try {\n+                result = executor.checkUserPermissions(\n+                        element.getType(),\n+                        ReadPermission.class,\n+                        element.getFieldName());\n+            } catch (ForbiddenAccessException e) {\n+                return ExpressionResult.FAIL;\n+            }\n+\n+            if (result == ExpressionResult.DEFERRED) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9d822edd8757e4ff2be00547366d865b8d01eca8"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d94404555895aa8bdcaa870707ebf45dbd31bb8", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/1d94404555895aa8bdcaa870707ebf45dbd31bb8", "committedDate": "2020-04-21T20:53:26Z", "message": "Inspection comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e36c5a6a7e515856e637aca725f57d2d28633213", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/e36c5a6a7e515856e637aca725f57d2d28633213", "committedDate": "2020-04-21T20:53:51Z", "message": "Merge branch 'ShortCircuitRelationshipFetches' of github.com:yahoo/elide into ShortCircuitRelationshipFetches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a66998005909b1d75c941dcb01647d53f159943e", "author": {"user": null}, "url": "https://github.com/yahoo/elide/commit/a66998005909b1d75c941dcb01647d53f159943e", "committedDate": "2020-04-21T20:54:55Z", "message": "Minor fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Njc1MDM1", "url": "https://github.com/yahoo/elide/pull/1275#pullrequestreview-397675035", "createdAt": "2020-04-21T21:05:58Z", "commit": {"oid": "a66998005909b1d75c941dcb01647d53f159943e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 907, "cost": 1, "resetAt": "2021-11-02T10:47:05Z"}}}