{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjAzNTk4", "number": 1877, "title": "DataChunk ByteBuffer array", "bodyText": "Update DataChunk to hold an array of ByteBuffer instead of a single ByteBuffer.\nFixes #1876", "createdAt": "2020-05-27T04:44:17Z", "url": "https://github.com/oracle/helidon/pull/1877", "merged": true, "mergeCommit": {"oid": "a9363a3d226a3154e2fb99abe230239758504436"}, "closed": true, "closedAt": "2020-06-02T20:39:40Z", "author": {"login": "romain-grecourt"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclRx0ggH2gAyNDIzNjAzNTk4OjQxZDEwMDMzNmYxYTlkZGJjOTVmZjk2YWMzOTkzZjlkZGJhZjA3MTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnbCAAgFqTQyMzAzOTcyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41d100336f1a9ddbc95ff96ac3993f9ddbaf0713", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/41d100336f1a9ddbc95ff96ac3993f9ddbaf0713", "committedDate": "2020-05-27T04:44:05Z", "message": "Update DataChunk to hold an array of ByteBuffer instead of a single ByteBuffer.\nFixes #1876"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83c26326d121bf193a82085c112617fa9546ae0f", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/83c26326d121bf193a82085c112617fa9546ae0f", "committedDate": "2020-05-27T05:26:50Z", "message": "fix checkstyle errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d29fcdd4e666161b3f417cff69db89f9dd64956b", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/d29fcdd4e666161b3f417cff69db89f9dd64956b", "committedDate": "2020-05-27T06:06:22Z", "message": "fix copyright errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c29070833c2f608979845063b1284981cfc2074", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/4c29070833c2f608979845063b1284981cfc2074", "committedDate": "2020-05-27T06:39:27Z", "message": "Merge remote-tracking branch 'origin/master' into datachunk-bytebuffers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDk3NzY1", "url": "https://github.com/oracle/helidon/pull/1877#pullrequestreview-419097765", "createdAt": "2020-05-27T11:25:10Z", "commit": {"oid": "d29fcdd4e666161b3f417cff69db89f9dd64956b"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjUyNTE4", "url": "https://github.com/oracle/helidon/pull/1877#pullrequestreview-419252518", "createdAt": "2020-05-27T14:14:37Z", "commit": {"oid": "d29fcdd4e666161b3f417cff69db89f9dd64956b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDoxNDozN1rOGbMOnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxNDoxNDozN1rOGbMOnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTE2NTA4NA==", "bodyText": "What would happen with this condition if the last ByteBuffer in the chunk returns 0 and continues in line 144?", "url": "https://github.com/oracle/helidon/pull/1877#discussion_r431165084", "createdAt": "2020-05-27T14:14:37Z", "author": {"login": "spericas"}, "path": "media/common/src/main/java/io/helidon/media/common/DataChunkInputStream.java", "diffHunk": "@@ -132,32 +132,38 @@ public int read(byte[] buf, int off, int len) throws IOException {\n                 return -1;\n             }\n \n-            ByteBuffer currentBuffer = chunk.data();\n-\n-            if (currentBuffer.position() == 0) {\n-                LOGGER.finest(() -> \"Reading chunk ID: \" + chunk.id());\n-            }\n-\n-            // If there is anything to read, then read as much as fits into buf\n-            int rem = currentBuffer.remaining();\n-            if (len > rem) {\n-                len = rem;\n+            ByteBuffer[] currentBuffers = chunk.data();\n+            int count = 0;\n+            for (int i = 0; i < currentBuffers.length; i++) {\n+                if (i == 0 && currentBuffers[i].position() == 0) {\n+                    LOGGER.finest(() -> \"Reading chunk ID: \" + chunk.id());\n+                }\n+                // If there is anything to read, then read as much as fits into buf\n+                int rem = currentBuffers[i].remaining();\n+                if (rem == 0) {\n+                    continue;\n+                }\n+                int currentLen = len;\n+                if (currentLen > rem) {\n+                    currentLen = rem;\n+                }\n+                currentBuffers[i].get(buf, off, currentLen);\n+                off += currentLen;\n+                count += currentLen;\n+\n+                // Chunk is consumed entirely - release the chunk, and prefetch a new chunk; do not\n+                // wait for it to arrive - the next read may have to wait less.\n+                //\n+                // Assert: it is safe to request new chunks eagerly - there is no mechanism\n+                // to push back unconsumed data, so we can assume we own all the chunks,\n+                // consumed and unconsumed.\n+                if (i == currentBuffers.length - 1 && currentLen == rem) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d29fcdd4e666161b3f417cff69db89f9dd64956b"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cfaa8526496eea3588f90522ba0a1a43ceac117a", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/cfaa8526496eea3588f90522ba0a1a43ceac117a", "committedDate": "2020-05-27T18:20:02Z", "message": "Fix DataChunkInputStream\nFix MultiPartDecoder to handle ByteBuffer[]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee925381cb157e6ecbe0e85ea1c0b5f5906e5cf4", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/ee925381cb157e6ecbe0e85ea1c0b5f5906e5cf4", "committedDate": "2020-05-27T19:38:18Z", "message": "fix multipart example to handle ByteBuffer[]"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a091d85f0d00b9dcea8cebf40da4b98f917cf05", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/2a091d85f0d00b9dcea8cebf40da4b98f917cf05", "committedDate": "2020-06-01T22:14:42Z", "message": "Merge remote-tracking branch 'origin/master' into datachunk-bytebuffers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7465510de4696b1cc9d3decbac9f52111d6ccc7e", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/7465510de4696b1cc9d3decbac9f52111d6ccc7e", "committedDate": "2020-06-01T23:11:28Z", "message": "maintain bufferIndex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyOTU2OTQw", "url": "https://github.com/oracle/helidon/pull/1877#pullrequestreview-422956940", "createdAt": "2020-06-02T18:38:11Z", "commit": {"oid": "7465510de4696b1cc9d3decbac9f52111d6ccc7e"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "011a7f9459562d8106e7bee5bff4d4d9799b3e5c", "author": {"user": {"login": "romain-grecourt", "name": "Romain Grecourt"}}, "url": "https://github.com/oracle/helidon/commit/011a7f9459562d8106e7bee5bff4d4d9799b3e5c", "committedDate": "2020-06-02T19:25:05Z", "message": "Improve implementation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMDM5NzIy", "url": "https://github.com/oracle/helidon/pull/1877#pullrequestreview-423039722", "createdAt": "2020-06-02T20:38:45Z", "commit": {"oid": "011a7f9459562d8106e7bee5bff4d4d9799b3e5c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 650, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}