{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMzIwOTcz", "number": 1830, "title": "BufferedEmittingPublisher as replacement for OriginThreadPublisher", "bodyText": "Simplified replacement for OriginThreadPublisher , performance is better and api is cleaner.\nBenchmark                            Mode  Cnt   Score   Error  Units\nEmitterTest.testEmitterReqMillion   thrpt   20  21.261 \u00b1 0.160  ops/s\nEmitterTest.testEmitterReqOneByOne  thrpt   20  11.845 \u00b1 0.357  ops/s\nEmitterTest.testEmitterUnbounded    thrpt   20  44.591 \u00b1 0.131  ops/s\nEmitterTest.testOTPReqMillion       thrpt   20  14.702 \u00b1 0.124  ops/s\nEmitterTest.testOTPReqOneByOne      thrpt   20   7.707 \u00b1 0.088  ops/s\nEmitterTest.testOTPUnbounded        thrpt   20  14.902 \u00b1 0.026  ops/s\n\nJMH test\nUsed in webclient, webserver, Kafka connector and Multipart #1787", "createdAt": "2020-05-19T19:31:01Z", "url": "https://github.com/oracle/helidon/pull/1830", "merged": true, "mergeCommit": {"oid": "66200b545a0ace1a28ef8f750112146969f9ee7d"}, "closed": true, "closedAt": "2020-05-22T18:05:51Z", "author": {"login": "danielkec"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABci5qFmAH2gAyNDIwMzIwOTczOmQ3N2I5ZjU0Y2JkZTQ2MTkzNWEwMDkzMDcxYjI4NGM2YTg0Yzk2NzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcj1hfjgFqTQxNzA2NzY1MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d77b9f54cbde461935a0093071b284c6a84c9671", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/d77b9f54cbde461935a0093071b284c6a84c9671", "committedDate": "2020-05-19T19:30:04Z", "message": "BufferedEmittingPublisher as replacement for OriginThreadPublisher\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bed4825c9bc61839264064a76cfb626b21b913ce", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/bed4825c9bc61839264064a76cfb626b21b913ce", "committedDate": "2020-05-20T09:45:24Z", "message": "Cleanup\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49c2177dc8d367276dbe0d21e9c99b4e597a1567", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/49c2177dc8d367276dbe0d21e9c99b4e597a1567", "committedDate": "2020-05-20T11:21:33Z", "message": "Align with OTP use-cases\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "035083a9d295ed912535270ef5a925089cb409cb", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/035083a9d295ed912535270ef5a925089cb409cb", "committedDate": "2020-05-20T11:27:53Z", "message": "Switch webclient to new OTP replacement\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a298a01fbef2b850852b86e218c6785c67207814", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/a298a01fbef2b850852b86e218c6785c67207814", "committedDate": "2020-05-20T12:28:31Z", "message": "Noop emit for webclient workaround\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aac0d2c443b422e152d1c6daf609c9e0dff5d75a", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/aac0d2c443b422e152d1c6daf609c9e0dff5d75a", "committedDate": "2020-05-20T12:30:13Z", "message": "Javadoc fix\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30fcc8ee232c709756c51753fd415329a9247c15", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/30fcc8ee232c709756c51753fd415329a9247c15", "committedDate": "2020-05-20T12:30:27Z", "message": "Noop emit for webclient workaround\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f17a18dbff54de25ab2d7d4de562832f469920", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/f5f17a18dbff54de25ab2d7d4de562832f469920", "committedDate": "2020-05-20T12:58:23Z", "message": "Javadoc fix\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34260917e90928a05ade689f0d69fa96943aebea", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/34260917e90928a05ade689f0d69fa96943aebea", "committedDate": "2020-05-20T15:07:10Z", "message": "Switch webserver to new OTP replacement\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bf8560559e98633de583722b6a6407557973201", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/8bf8560559e98633de583722b6a6407557973201", "committedDate": "2020-05-20T18:33:40Z", "message": "OTP in webserver Jersey test fix\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "183fe7387df9f7ca30927661400adf1a0ceb903a", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/183fe7387df9f7ca30927661400adf1a0ceb903a", "committedDate": "2020-05-20T20:44:51Z", "message": "Performance boost for unbounded use-cases\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NzY0OTgy", "url": "https://github.com/oracle/helidon/pull/1830#pullrequestreview-415764982", "createdAt": "2020-05-20T22:43:59Z", "commit": {"oid": "183fe7387df9f7ca30927661400adf1a0ceb903a"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f2f2991c57ec107e7d1e8280d7577f0daa4c70", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/a1f2f2991c57ec107e7d1e8280d7577f0daa4c70", "committedDate": "2020-05-21T08:34:32Z", "message": "Another performance boost\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTk3MTEw", "url": "https://github.com/oracle/helidon/pull/1830#pullrequestreview-415997110", "createdAt": "2020-05-21T09:15:32Z", "commit": {"oid": "a1f2f2991c57ec107e7d1e8280d7577f0daa4c70"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOToxNTozMlrOGYr9-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwOToyMTozNlrOGYsJIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUzOTM4Nw==", "bodyText": "Do not use public methods in package local classes", "url": "https://github.com/oracle/helidon/pull/1830#discussion_r428539387", "createdAt": "2020-05-21T09:15:32Z", "author": {"login": "tomas-langer"}, "path": "common/reactive/src/main/java/io/helidon/common/reactive/BiConsumerChain.java", "diffHunk": "@@ -0,0 +1,57 @@\n+/*\n+ * Copyright (c)  2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.common.reactive;\n+\n+import java.util.ArrayList;\n+import java.util.function.BiConsumer;\n+\n+class BiConsumerChain<T, S>\n+        extends ArrayList<BiConsumer<? super T, ? super S>>\n+        implements BiConsumer<T, S> {\n+\n+    @Override\n+    public void accept(T t, S s) {\n+        for (BiConsumer<? super T, ? super S> inner : this) {\n+            inner.accept(t, s);\n+        }\n+    }\n+\n+    public BiConsumerChain<T, S> combineWith(BiConsumer<? super T, ? super S> another) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1f2f2991c57ec107e7d1e8280d7577f0daa4c70"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODU0MjI0MQ==", "bodyText": "Please remove public modifier from methods in package local classes", "url": "https://github.com/oracle/helidon/pull/1830#discussion_r428542241", "createdAt": "2020-05-21T09:21:36Z", "author": {"login": "tomas-langer"}, "path": "common/reactive/src/main/java/io/helidon/common/reactive/RunnableChain.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Copyright (c)  2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.common.reactive;\n+\n+import java.util.ArrayList;\n+\n+/**\n+ * Holds a list of {@link Runnable}s to flatten out a call chain of them.\n+ */\n+class RunnableChain extends ArrayList<Runnable> implements Runnable {\n+    @Override\n+    public void run() {\n+        for (Runnable inner : this) {\n+            inner.run();\n+        }\n+    }\n+\n+    public RunnableChain combineWith(Runnable another) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1f2f2991c57ec107e7d1e8280d7577f0daa4c70"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9eeab8c2d43739e4f1eef97feb5ff83fe4f8187d", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/9eeab8c2d43739e4f1eef97feb5ff83fe4f8187d", "committedDate": "2020-05-21T15:11:11Z", "message": "Cleanup and review issues\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea9da46dceef61a25bd55e31fd13d41a6cff6cbe", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/ea9da46dceef61a25bd55e31fd13d41a6cff6cbe", "committedDate": "2020-05-21T16:28:17Z", "message": "Kafka connector with new emitter\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NDk0NTQ4", "url": "https://github.com/oracle/helidon/pull/1830#pullrequestreview-416494548", "createdAt": "2020-05-21T21:09:59Z", "commit": {"oid": "ea9da46dceef61a25bd55e31fd13d41a6cff6cbe"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMTowOTo1OVrOGZC-FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQyMToxMjoxNlrOGZDCLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxNjI0NA==", "bodyText": "How about having support for onEmit callbacks ?", "url": "https://github.com/oracle/helidon/pull/1830#discussion_r428916244", "createdAt": "2020-05-21T21:09:59Z", "author": {"login": "romain-grecourt"}, "path": "common/reactive/src/main/java/io/helidon/common/reactive/BufferedEmittingPublisher.java", "diffHunk": "@@ -0,0 +1,299 @@\n+/*\n+ * Copyright (c)  2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.common.reactive;\n+\n+import java.util.concurrent.ConcurrentLinkedQueue;\n+import java.util.concurrent.Flow;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.BiConsumer;\n+import java.util.function.Consumer;\n+\n+/**\n+ * Emitting publisher for manual publishing with built-in buffer for handling backpressure.\n+ *\n+ * <p>\n+ * <strong>This publisher allows only a single subscriber</strong>.\n+ * </p>\n+ *\n+ * @param <T> type of emitted item\n+ */\n+public class BufferedEmittingPublisher<T> implements Flow.Publisher<T> {\n+\n+    private final AtomicReference<State> state = new AtomicReference<>(State.READY_TO_EMIT);\n+    private final ConcurrentLinkedQueue<T> buffer = new ConcurrentLinkedQueue<>();\n+    private final EmittingPublisher<T> emitter = new EmittingPublisher<>();\n+    private final AtomicBoolean draining = new AtomicBoolean(false);\n+    private final AtomicBoolean emitting = new AtomicBoolean(false);\n+    private final AtomicReference<Throwable> error = new AtomicReference<>();\n+    private BiConsumer<Long, Long> requestCallback = (n, r) -> {};\n+\n+    protected BufferedEmittingPublisher() {\n+    }\n+\n+    /**\n+     * Create new {@link BufferedEmittingPublisher}.\n+     *\n+     * @param <T> type of emitted item\n+     * @return new instance of BufferedEmittingPublisher\n+     */\n+    public static <T> BufferedEmittingPublisher<T> create() {\n+        return new BufferedEmittingPublisher<T>();\n+    }\n+\n+    @Override\n+    public void subscribe(final Flow.Subscriber<? super T> subscriber) {\n+        emitter.onSubscribe(() -> state.get().drain(this));\n+        emitter.onRequest((n, cnt) -> {\n+            requestCallback.accept(n, cnt);\n+            state.get().drain(this);\n+        });\n+        emitter.onCancel(() -> state.compareAndSet(State.READY_TO_EMIT, State.CANCELLED));\n+        emitter.subscribe(subscriber);\n+    }\n+\n+    /**\n+     * Callback executed when request signal from downstream arrive.\n+     * <ul>\n+     * <li><b>param</b> {@code n} the requested count.</li>\n+     * <li><b>param</b> {@code result} the current total cumulative requested count, ranges between [0, {@link Long#MAX_VALUE}]\n+     * where the max indicates that this publisher is unbounded.</li>\n+     * </ul>\n+     *\n+     * @param requestCallback to be executed\n+     */\n+    public void onRequest(BiConsumer<Long, Long> requestCallback) {\n+        this.requestCallback = BiConsumerChain.combine(this.requestCallback, requestCallback);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea9da46dceef61a25bd55e31fd13d41a6cff6cbe"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODkxNzI5NA==", "bodyText": "The subscriber reference is not released when completed.\nOne way of fixing it would be to add EmittingPublisher.this.subscriber = null; here", "url": "https://github.com/oracle/helidon/pull/1830#discussion_r428917294", "createdAt": "2020-05-21T21:12:16Z", "author": {"login": "romain-grecourt"}, "path": "common/reactive/src/main/java/io/helidon/common/reactive/EmittingPublisher.java", "diffHunk": "@@ -0,0 +1,334 @@\n+/*\n+ * Copyright (c)  2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+\n+package io.helidon.common.reactive;\n+\n+import java.util.Objects;\n+import java.util.concurrent.CompletableFuture;\n+import java.util.concurrent.Flow;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicLong;\n+import java.util.concurrent.atomic.AtomicReference;\n+import java.util.function.BiConsumer;\n+\n+/**\n+ * Emitting publisher for manual publishing on the same thread.\n+ * {@link EmittingPublisher} doesn't have any buffering capability and propagates backpressure\n+ * directly by returning {@code false} from {@link EmittingPublisher#emit(Object)} in case there\n+ * is no demand, or {@code cancel} signal has been received.\n+ * <p>\n+ *     For publishing with buffering in case of backpressure use {@link BufferedEmittingPublisher}.\n+ * </p>\n+ *\n+ * <p>\n+ * <strong>This publisher allows only a single subscriber</strong>.\n+ * </p>\n+ *\n+ * @param <T> type of emitted item\n+ */\n+public class EmittingPublisher<T> implements Flow.Publisher<T> {\n+    private Flow.Subscriber<? super T> subscriber;\n+    private final AtomicReference<State> state = new AtomicReference<>(State.NOT_REQUESTED_YET);\n+    private final AtomicLong requested = new AtomicLong();\n+    private final AtomicBoolean emitting = new AtomicBoolean(false);\n+    private final AtomicBoolean subscribed = new AtomicBoolean(false);\n+    private final CompletableFuture<Void> deferredComplete = new CompletableFuture<>();\n+    private BiConsumer<Long, Long> requestCallback = (n, r) -> {};\n+    private Runnable onSubscribeCallback = () -> {};\n+    private Runnable cancelCallback = () -> {};\n+\n+    EmittingPublisher() {\n+    }\n+\n+    /**\n+     * Create new {@code EmittingPublisher}.\n+     *\n+     * @param <T> type of emitted item\n+     * @return brand new {@code EmittingPublisher}\n+     */\n+    public static <T> EmittingPublisher<T> create() {\n+        return new EmittingPublisher<>();\n+    }\n+\n+    @Override\n+    public void subscribe(final Flow.Subscriber<? super T> subscriber) {\n+        Objects.requireNonNull(subscriber, \"subscriber is null\");\n+\n+        if (!subscribed.compareAndSet(false, true)) {\n+            subscriber.onSubscribe(SubscriptionHelper.CANCELED);\n+            subscriber.onError(new IllegalStateException(\"Only single subscriber is allowed!\"));\n+            return;\n+        }\n+\n+        this.subscriber = subscriber;\n+\n+        onSubscribeCallback.run();\n+        subscriber.onSubscribe(new Flow.Subscription() {\n+            @Override\n+            public void request(final long n) {\n+                if (state.get() == State.CANCELLED) {\n+                    return;\n+                }\n+                if (n < 1) {\n+                    fail(new IllegalArgumentException(\"Rule \u00a73.9 violated: non-positive request amount is forbidden\"));\n+                    return;\n+                }\n+                requested.updateAndGet(r -> Long.MAX_VALUE - r > n ? n + r : Long.MAX_VALUE);\n+                state.compareAndSet(State.NOT_REQUESTED_YET, State.READY_TO_EMIT);\n+                requestCallback.accept(n, requested.get());\n+            }\n+\n+            @Override\n+            public void cancel() {\n+                if (state.compareAndSet(State.NOT_REQUESTED_YET, State.CANCELLED)\n+                        || state.compareAndSet(State.READY_TO_EMIT, State.CANCELLED)) {\n+                    cancelCallback.run();\n+                    EmittingPublisher.this.subscriber = null;\n+                }\n+            }\n+\n+        });\n+        deferredComplete.complete(null);\n+    }\n+\n+    /**\n+     * Properly fail the stream, set publisher to cancelled state and send {@code onError} signal downstream.\n+     * Signal {@code onError} is sent only once, any other call to this method is no-op.\n+     *\n+     * @param throwable Sent as {@code onError} signal\n+     */\n+    public void fail(Throwable throwable) {\n+        if (deferredComplete.isDone()) {\n+            signalOnError(throwable);\n+        } else {\n+            deferredComplete.thenRun(() -> signalOnError(throwable));\n+        }\n+    }\n+\n+    /**\n+     * Properly complete the stream, set publisher to completed state and send {@code onComplete} signal downstream.\n+     * Signal {@code onComplete} is sent only once, any other call to this method is no-op.\n+     */\n+    public void complete() {\n+        deferredComplete.thenRun(this::signalOnComplete);\n+    }\n+\n+    private void signalOnError(Throwable throwable) {\n+        if (state.compareAndSet(State.NOT_REQUESTED_YET, State.FAILED)\n+                || state.compareAndSet(State.READY_TO_EMIT, State.FAILED)) {\n+            for (;;) {\n+                try {\n+                    if (emitting.getAndSet(true)) {\n+                        continue;\n+                    }\n+                    this.subscriber.onError(throwable);\n+                    return;\n+                } catch (Throwable t) {\n+                    throw new IllegalStateException(\"On error threw an exception!\", t);\n+                } finally {\n+                    emitting.set(false);\n+                }\n+            }\n+        }\n+    }\n+\n+    private void signalOnComplete() {\n+        if (state.compareAndSet(State.NOT_REQUESTED_YET, State.COMPLETED)\n+                || state.compareAndSet(State.READY_TO_EMIT, State.COMPLETED)) {\n+            for (;;) {\n+                try {\n+                    if (emitting.getAndSet(true)) {\n+                        continue;\n+                    }\n+                    this.subscriber.onComplete();\n+                    return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea9da46dceef61a25bd55e31fd13d41a6cff6cbe"}, "originalPosition": 158}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8916de6bd54bef6dce8b5ac6111dd090244e5961", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/8916de6bd54bef6dce8b5ac6111dd090244e5961", "committedDate": "2020-05-22T11:18:24Z", "message": "Release subscriber reference on complete/error\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3163b4dab92542ce56a7fc107b69abf2826e2474", "author": {"user": {"login": "danielkec", "name": "Daniel Kec"}}, "url": "https://github.com/oracle/helidon/commit/3163b4dab92542ce56a7fc107b69abf2826e2474", "committedDate": "2020-05-22T13:36:36Z", "message": "OnEmit callback\n\nSigned-off-by: Daniel Kec <daniel.kec@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDMxMTQ0", "url": "https://github.com/oracle/helidon/pull/1830#pullrequestreview-417031144", "createdAt": "2020-05-22T16:19:27Z", "commit": {"oid": "3163b4dab92542ce56a7fc107b69abf2826e2474"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3MDY3NjUw", "url": "https://github.com/oracle/helidon/pull/1830#pullrequestreview-417067650", "createdAt": "2020-05-22T17:14:59Z", "commit": {"oid": "3163b4dab92542ce56a7fc107b69abf2826e2474"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 629, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}