{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjQ1MDcw", "number": 1633, "reviewThreads": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxMDoxMFrODy03EA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1NzoxN1rODy10wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjIxNDU2OnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CORSSupportMP.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxMDoxMFrOGHGLvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxMjozNFrOGHGRNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NDUyNQ==", "bodyText": "Please use camel case: CorsSupportMp and CorsSupport", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410094525", "createdAt": "2020-04-17T09:10:10Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CORSSupportMP.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.microprofile.cors;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.core.MultivaluedHashMap;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.core.Response;\n+\n+import io.helidon.webserver.cors.CORSSupport;\n+import io.helidon.webserver.cors.CrossOriginConfig;\n+\n+/**\n+ * MP implementation of {@link CORSSupport}.\n+ */\n+class CORSSupportMP extends CORSSupport {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NTkyNg==", "bodyText": "Please update all classes in the implementation that use such a naming convention.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410095926", "createdAt": "2020-04-17T09:12:34Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CORSSupportMP.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.microprofile.cors;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.core.MultivaluedHashMap;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.core.Response;\n+\n+import io.helidon.webserver.cors.CORSSupport;\n+import io.helidon.webserver.cors.CrossOriginConfig;\n+\n+/**\n+ * MP implementation of {@link CORSSupport}.\n+ */\n+class CORSSupportMP extends CORSSupport {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NDUyNQ=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjIxODU0OnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CORSSupportMP.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxMTowOVrOGHGOIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxMTowOVrOGHGOIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NTEzNg==", "bodyText": "The class is package local, this method should not be public", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410095136", "createdAt": "2020-04-17T09:11:09Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CORSSupportMP.java", "diffHunk": "@@ -0,0 +1,178 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.microprofile.cors;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import javax.ws.rs.container.ContainerRequestContext;\n+import javax.ws.rs.container.ContainerResponseContext;\n+import javax.ws.rs.core.MultivaluedHashMap;\n+import javax.ws.rs.core.MultivaluedMap;\n+import javax.ws.rs.core.Response;\n+\n+import io.helidon.webserver.cors.CORSSupport;\n+import io.helidon.webserver.cors.CrossOriginConfig;\n+\n+/**\n+ * MP implementation of {@link CORSSupport}.\n+ */\n+class CORSSupportMP extends CORSSupport {\n+\n+    /**\n+     *\n+     * @return a new builder of CORSSupportMP\n+     */\n+    public static Builder builder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjIzMDE4OnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOriginAutoDiscoverable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxNDozNFrOGHGVhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxNDozNFrOGHGVhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5NzAzMA==", "bodyText": "Please add @ConstrainedTo(RuntimeType.SERVER)", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410097030", "createdAt": "2020-04-17T09:14:34Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOriginAutoDiscoverable.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.microprofile.cors;\n+\n+import javax.ws.rs.core.FeatureContext;\n+\n+import org.glassfish.jersey.internal.spi.AutoDiscoverable;\n+\n+/**\n+ * Class CrossOriginAutoDiscoverable.\n+ */\n+public class CrossOriginAutoDiscoverable implements AutoDiscoverable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjIzNjAzOnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOriginAutoDiscoverable.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxNjoxOFrOGHGZXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToxNjoxOFrOGHGZXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDA5ODAxMw==", "bodyText": "Please update the javadoc to clearly state this is for Jersey autodiscoverable (as it should not be used directly by anybody)", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410098013", "createdAt": "2020-04-17T09:16:18Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOriginAutoDiscoverable.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.microprofile.cors;\n+\n+import javax.ws.rs.core.FeatureContext;\n+\n+import org.glassfish.jersey.internal.spi.AutoDiscoverable;\n+\n+/**\n+ * Class CrossOriginAutoDiscoverable.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI1NTcxOnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/test/resources/META-INF/microprofile-config.properties", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyMjo1MlrOGHGmjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTowNzowMlrOGHR01w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMTM4OQ==", "bodyText": "In MP - shouldn't we map this to resource class and resource method?\nMaybe the approach of fully qualified classname + method name + CORS parameters would be easier for MP users?\nSuch as:\nio.helidon.microprofile.cors.CrossOriginTest.CorsResource2.options.value=http://foo.bar,http://bar.foo\nio.helidon.microprofile.cors.CrossOriginTest.CorsResource2.options.allowHeaders=X-foo,X-bar\nio.helidon.microprofile.cors.CrossOriginTest.CorsResource2.options.allowMethods=DELETE,PUT\nio.helidon.microprofile.cors.CrossOriginTest.CorsResource2.options.allowCredentials=true\nio.helidon.microprofile.cors.CrossOriginTest.CorsResource2.options.maxAge=-1", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410101389", "createdAt": "2020-04-17T09:22:52Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/test/resources/META-INF/microprofile-config.properties", "diffHunk": "@@ -0,0 +1,18 @@\n+#\n+# Copyright (c) 2019, 2020 Oracle and/or its affiliates.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+cors.paths.0.path-prefix=/cors3", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI4NTI3MQ==", "bodyText": "The existing format has several advantages:\n\nMuch less verbose.\nImmune to refactoring of the code.\nSupports use cases that the alternative does not. (see below)\nMatches more closely to the mental model for the person setting up the configuration.\n\nThe existing format allows path expressions for the path. This lets users easily configure multiple related endpoints in one CORS setting, including using a single entry for the entire app (which seems to be what's often done in the wild).\nAlso, the alternative described here does not allow for one resource to have multiple endpoints at different paths with the same HTTP method. To support that the alternative format would have to also include either the Java method name or the URI path. In that case why not just use path expressions as in the existing format?\nPaths are likely to be more stable than implementation packages and class names because paths are used externally; code is subject to refactoring.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410285271", "createdAt": "2020-04-17T15:07:02Z", "author": {"login": "tjquinno"}, "path": "microprofile/cors/src/test/resources/META-INF/microprofile-config.properties", "diffHunk": "@@ -0,0 +1,18 @@\n+#\n+# Copyright (c) 2019, 2020 Oracle and/or its affiliates.\n+#\n+# Licensed under the Apache License, Version 2.0 (the \"License\");\n+# you may not use this file except in compliance with the License.\n+# You may obtain a copy of the License at\n+#\n+#     http://www.apache.org/licenses/LICENSE-2.0\n+#\n+# Unless required by applicable law or agreed to in writing, software\n+# distributed under the License is distributed on an \"AS IS\" BASIS,\n+# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+# See the License for the specific language governing permissions and\n+# limitations under the License.\n+#\n+cors.paths.0.path-prefix=/cors3", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMTM4OQ=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI1OTkyOnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Aggregator.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyMzo1MlrOGHGpDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMjowNDowMVrOGHLQtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMjAyOA==", "bodyText": "Class is package local, public methods should not exist here", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410102028", "createdAt": "2020-04-17T09:23:52Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Aggregator.java", "diffHunk": "@@ -0,0 +1,307 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import io.helidon.config.Config;\n+import io.helidon.config.ConfigValue;\n+import io.helidon.webserver.PathMatcher;\n+\n+import static io.helidon.webserver.cors.CORSSupportHelper.normalize;\n+\n+/**\n+ * Collects CORS set-up information from various sources and looks up the relevant CORS information given a request's path.\n+ * <p>\n+ *    The caller can build up the cross-config information over multiple invocations of the exposed methods. The behavior is that\n+ *    of a {@link LinkedHashMap}:\n+ *    <ul>\n+ *        <li>when <em>storing</em> cross-config information, the <em>latest</em> invocation that specifies the same path\n+ *        expression overwrites any preceding settings for the same path expression, and</li>\n+ *        <li>when <em>matching</em> against a request's path, the code checks the path matchers <em>in the order\n+ *        they were added</em> to the aggregator, whether by {@link #mappedConfig} or {@link #addCrossOrigin} or the {@link Setter}\n+ *        methods.\n+ *    </ul>\n+ * </p>\n+ * <p>\n+ *     The {@code Setter} methods affect the so-called \"pathless\" entry. Those methods have no explicit path, so we record\n+ *     their settings in an entry with path expression {@value #PATHLESS_KEY} which matches everything.\n+ * </p>\n+ * <p>\n+ *     If the developer uses the {@link #mappedConfig} or {@link #addCrossOrigin} methods <em>along with</em> the {@code Setter}\n+ *     methods, the results are predictable but might be confusing. The {@code config} and {@code addCrossOrigin} methods\n+ *     <em>overwrite</em> any entry with the same path expression, whereas the {@code Setter} methods <em>update</em> an existing\n+ *     entry with path {@value #PATHLESS_KEY}, creating one if needed. So, if the config or an {@code addCrossOrigin}\n+ *     invocation sets values for that same path expression then results can be surprising.\n+ *     path\n+ * </p>\n+ *\n+ */\n+class Aggregator implements Setter<Aggregator> {\n+\n+    // Key value for the map corresponding to the cross-origin config managed by the {@link Setter} methods\n+    static final String PATHLESS_KEY = \"{+}\";\n+\n+    // Records paths and configs added via addCrossOriginConfig\n+    private final Map<String, CrossOriginConfigMatchable> crossOriginConfigMatchables = new LinkedHashMap<>();\n+\n+    private boolean isEnabled = true;\n+\n+    /**\n+     * Factory method.\n+     *\n+     * @return new CrossOriginConfigAggregatpr\n+     */\n+    static Aggregator create() {\n+        return new Aggregator();\n+    }\n+\n+    private Aggregator() {\n+    }\n+\n+    /**\n+     * Reports whether the sources of CORS information have left CORS enabled or not. If there has been an explicit setting,\n+     * use the most recent. Otherwise\n+     *\n+     * @return if CORS processing should be done\n+     */\n+    public boolean isEnabled() {\n+        return isEnabled;\n+    }\n+\n+    /**\n+     * Add cross-origin information from a {@link Config} node.\n+     *\n+     * @param config {@code Config} node containing\n+     * @return updated builder\n+     */\n+    public Aggregator mappedConfig(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE3NzcxOA==", "bodyText": "I have changed the ones I can. Some are required by an interface and are therefore remain public.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410177718", "createdAt": "2020-04-17T12:04:01Z", "author": {"login": "tjquinno"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Aggregator.java", "diffHunk": "@@ -0,0 +1,307 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import io.helidon.config.Config;\n+import io.helidon.config.ConfigValue;\n+import io.helidon.webserver.PathMatcher;\n+\n+import static io.helidon.webserver.cors.CORSSupportHelper.normalize;\n+\n+/**\n+ * Collects CORS set-up information from various sources and looks up the relevant CORS information given a request's path.\n+ * <p>\n+ *    The caller can build up the cross-config information over multiple invocations of the exposed methods. The behavior is that\n+ *    of a {@link LinkedHashMap}:\n+ *    <ul>\n+ *        <li>when <em>storing</em> cross-config information, the <em>latest</em> invocation that specifies the same path\n+ *        expression overwrites any preceding settings for the same path expression, and</li>\n+ *        <li>when <em>matching</em> against a request's path, the code checks the path matchers <em>in the order\n+ *        they were added</em> to the aggregator, whether by {@link #mappedConfig} or {@link #addCrossOrigin} or the {@link Setter}\n+ *        methods.\n+ *    </ul>\n+ * </p>\n+ * <p>\n+ *     The {@code Setter} methods affect the so-called \"pathless\" entry. Those methods have no explicit path, so we record\n+ *     their settings in an entry with path expression {@value #PATHLESS_KEY} which matches everything.\n+ * </p>\n+ * <p>\n+ *     If the developer uses the {@link #mappedConfig} or {@link #addCrossOrigin} methods <em>along with</em> the {@code Setter}\n+ *     methods, the results are predictable but might be confusing. The {@code config} and {@code addCrossOrigin} methods\n+ *     <em>overwrite</em> any entry with the same path expression, whereas the {@code Setter} methods <em>update</em> an existing\n+ *     entry with path {@value #PATHLESS_KEY}, creating one if needed. So, if the config or an {@code addCrossOrigin}\n+ *     invocation sets values for that same path expression then results can be surprising.\n+ *     path\n+ * </p>\n+ *\n+ */\n+class Aggregator implements Setter<Aggregator> {\n+\n+    // Key value for the map corresponding to the cross-origin config managed by the {@link Setter} methods\n+    static final String PATHLESS_KEY = \"{+}\";\n+\n+    // Records paths and configs added via addCrossOriginConfig\n+    private final Map<String, CrossOriginConfigMatchable> crossOriginConfigMatchables = new LinkedHashMap<>();\n+\n+    private boolean isEnabled = true;\n+\n+    /**\n+     * Factory method.\n+     *\n+     * @return new CrossOriginConfigAggregatpr\n+     */\n+    static Aggregator create() {\n+        return new Aggregator();\n+    }\n+\n+    private Aggregator() {\n+    }\n+\n+    /**\n+     * Reports whether the sources of CORS information have left CORS enabled or not. If there has been an explicit setting,\n+     * use the most recent. Otherwise\n+     *\n+     * @return if CORS processing should be done\n+     */\n+    public boolean isEnabled() {\n+        return isEnabled;\n+    }\n+\n+    /**\n+     * Add cross-origin information from a {@link Config} node.\n+     *\n+     * @param config {@code Config} node containing\n+     * @return updated builder\n+     */\n+    public Aggregator mappedConfig(Config config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMjAyOA=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI2NDQ0OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Setter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNTowN1rOGHGr0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNTowN1rOGHGr0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMjczNg==", "bodyText": "Can you please rename to CorsSetter? Even though the class is not public, this is a bit too generic name.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410102736", "createdAt": "2020-04-17T09:25:07Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Setter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+/**\n+ * Defines common behavior between {@code CrossOriginConfig} and {@link CORSSupport.Builder} for assiging CORS-related\n+ * attributes.\n+ *\n+ * @param <T> the type of the implementing class so the fluid methods can return the correct type\n+ */\n+interface Setter<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI2NTY3OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Setter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNToyMlrOGHGsgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNToyMlrOGHGsgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMjkxNQ==", "bodyText": "typo: assiging should be assigning", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410102915", "createdAt": "2020-04-17T09:25:22Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/Setter.java", "diffHunk": "@@ -0,0 +1,82 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+/**\n+ * Defines common behavior between {@code CrossOriginConfig} and {@link CORSSupport.Builder} for assiging CORS-related", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI3MTY3OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CORSSupport.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNzoxMlrOGHGwVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOToyNzoxMlrOGHGwVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwMzg5NQ==", "bodyText": "As in MP, please rename to camel case: CorsSupport\nPlease do so for CorsSupportHelper, CorsSupportSe, SeReqeustAdapter, SeResponseAdapter", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410103895", "createdAt": "2020-04-17T09:27:12Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CORSSupport.java", "diffHunk": "@@ -0,0 +1,337 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.List;\n+import java.util.Optional;\n+import java.util.function.Supplier;\n+\n+import io.helidon.config.Config;\n+import io.helidon.webserver.Handler;\n+import io.helidon.webserver.Routing;\n+import io.helidon.webserver.ServerRequest;\n+import io.helidon.webserver.ServerResponse;\n+import io.helidon.webserver.Service;\n+\n+/**\n+ * A Helidon service and handler implementation that implements CORS, for both the application and for built-in Helidon\n+ * services (such as OpenAPI and metrics).\n+ * <p>\n+ *     The caller can set up the {@code CORSSupport} in a combination of these ways:\n+ * </p>\n+ *     <ul>\n+ *         <li>from a {@link Config} node supplied programmatically,</li>\n+ *         <li>from one or more {@link CrossOriginConfig} objects supplied programmatically, each associated with a path to which\n+ *         it applies, and</li>\n+ *         <li>by setting individual CORS-related attributes on the {@link Builder} (which affects the CORS behavior for the\n+ *         {@value Aggregator#PATHLESS_KEY} path).</li>\n+ *     </ul>\n+ * <p>\n+ *     See the {@link Builder#build} method for how the builder resolves conflicts among these sources.\n+ * </p>\n+ * <p>\n+ *     If none of these sources is used, the {@code CORSSupport} applies defaults as described for\n+ *     {@link CrossOriginConfig}.\n+ * </p>\n+ *\n+ */\n+public abstract class CORSSupport implements Service, Handler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI4MjU3OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTozMDoxNlrOGHG3Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzoyMDoyMlrOGHNpxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwNTYxOA==", "bodyText": "Please do not add factory methods to builders themself.\nEither do CrossOriginConfig.builder(CrossOriginConfig config) or add an instance method config(CrossOriginConfig)", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410105618", "createdAt": "2020-04-17T09:30:16Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 219}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNjkwMA==", "bodyText": "See below", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410216900", "createdAt": "2020-04-17T13:20:22Z", "author": {"login": "tjquinno"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwNTYxOA=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 219}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjI4NzU2OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTozMTozM1rOGHG6OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzoyMDowNVrOGHNpIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwNjQyNA==", "bodyText": "Do not add static factory methods to builders.\nPlease move line 238 to the static builder method on CrossOriginConfig", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410106424", "createdAt": "2020-04-17T09:31:33Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {\n+            return new Builder()\n+                    .pathPrefix(original.pathPrefix)\n+                    .enabled(original.enabled)\n+                    .allowCredentials(original.allowCredentials)\n+                    .allowHeaders(original.allowHeaders)\n+                    .allowMethods(original.allowMethods)\n+                    .allowOrigins(original.allowOrigins)\n+                    .exposeHeaders(original.exposeHeaders)\n+                    .maxAge(original.maxAge);\n+        }\n+\n+        /**\n+         * Creates a new {@code Builder}instance from the specified configuration.\n+         *\n+         * @param config node containing cross-origin information\n+         * @return new {@code Builder} initialized from the config\n+         */\n+        public static Builder from(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 237}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNjczOA==", "bodyText": "See below.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410216738", "createdAt": "2020-04-17T13:20:05Z", "author": {"login": "tjquinno"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {\n+            return new Builder()\n+                    .pathPrefix(original.pathPrefix)\n+                    .enabled(original.enabled)\n+                    .allowCredentials(original.allowCredentials)\n+                    .allowHeaders(original.allowHeaders)\n+                    .allowMethods(original.allowMethods)\n+                    .allowOrigins(original.allowOrigins)\n+                    .exposeHeaders(original.exposeHeaders)\n+                    .maxAge(original.maxAge);\n+        }\n+\n+        /**\n+         * Creates a new {@code Builder}instance from the specified configuration.\n+         *\n+         * @param config node containing cross-origin information\n+         * @return new {@code Builder} initialized from the config\n+         */\n+        public static Builder from(Config config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEwNjQyNA=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 237}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM0NjU3OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo0OToxMlrOGHHf6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMzoxODoyNVrOGHNlVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNjA3NQ==", "bodyText": "In Helidon, when a method accepts config, it should be called config. Also it should update values already configured on the builder - this method just ignores everything already configured and returns a brand new builder.\nThis is inconsistent with the builder pattern we use, where all builder methods mutate the state of the builder.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410116075", "createdAt": "2020-04-17T09:49:12Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {\n+            return new Builder()\n+                    .pathPrefix(original.pathPrefix)\n+                    .enabled(original.enabled)\n+                    .allowCredentials(original.allowCredentials)\n+                    .allowHeaders(original.allowHeaders)\n+                    .allowMethods(original.allowMethods)\n+                    .allowOrigins(original.allowOrigins)\n+                    .exposeHeaders(original.exposeHeaders)\n+                    .maxAge(original.maxAge);\n+        }\n+\n+        /**\n+         * Creates a new {@code Builder}instance from the specified configuration.\n+         *\n+         * @param config node containing cross-origin information\n+         * @return new {@code Builder} initialized from the config\n+         */\n+        public static Builder from(Config config) {\n+            return Loader.Basic.builder(config);\n+        }\n+\n+        @Override\n+        public Builder apply(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 242}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDIxNTc2Ng==", "bodyText": "I'm fully aware of the pattern but incompletely cleaned up some earlier work. I have revised the class so I think it complies and is usable. CrossOriginConfig has:\n// builder factories\npublic static Builder builder()\npublic static Builder builder(Config config)\npublic static Builder builder(CrossOriginConfig original)\n\n// convenience instance factory\npublic static CrossOriginConfig build\n\nThe last method is very convenient for supporting someConfig.as(CrossOriginConfig::build).\nNo code currently needs a CrossOriginConfig.Builder#config(Config) method, but if the need arises it can delegate to Loader.Basic#builder(this, corsConfig).", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410215766", "createdAt": "2020-04-17T13:18:25Z", "author": {"login": "tjquinno"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {\n+            return new Builder()\n+                    .pathPrefix(original.pathPrefix)\n+                    .enabled(original.enabled)\n+                    .allowCredentials(original.allowCredentials)\n+                    .allowHeaders(original.allowHeaders)\n+                    .allowMethods(original.allowMethods)\n+                    .allowOrigins(original.allowOrigins)\n+                    .exposeHeaders(original.exposeHeaders)\n+                    .maxAge(original.maxAge);\n+        }\n+\n+        /**\n+         * Creates a new {@code Builder}instance from the specified configuration.\n+         *\n+         * @param config node containing cross-origin information\n+         * @return new {@code Builder} initialized from the config\n+         */\n+        public static Builder from(Config config) {\n+            return Loader.Basic.builder(config);\n+        }\n+\n+        @Override\n+        public Builder apply(Config config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNjA3NQ=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 242}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM1MDg4OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1MDoyNlrOGHHijA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1MDoyNlrOGHHijA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNjc0OA==", "bodyText": "Whenever time units are used and are not as a parameter, please name the method accordingly (e.g. maxAgeSeconds or maxAgeMillis). You can also add another method that accepts a time unit.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410116748", "createdAt": "2020-04-17T09:50:26Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/CrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,308 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.webserver.cors;\n+\n+import java.util.Arrays;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.Aggregator.PATHLESS_KEY;\n+\n+/**\n+ * Represents information about cross origin request sharing.\n+ *\n+ * Applications can create instance in two ways:\n+ * <ul>\n+ *     <li>using a {@code Builder} explicitly\n+ *     <p>\n+ *     Obtain a suitable builder by:\n+ *     </p>\n+ *     <ul>\n+ *         <li>explicitly getting a builder using {@link #builder()},</li>\n+ *         <li>invoking the static {@link Builder#from} method and\n+ *         passing an existing instance of {@code CrossOriginConfig}; the resulting {@code Builder} is\n+ *         intialized using the configuration node provided, or</li>\n+ *         <li>obtaining a {@link Config} instance and invoking {@code Config.as}, passing {@code Builder#from}</li>\n+ *     </ul>\n+ *     and then invoke methods on the builder, finally invoking the builder's {@code build} method to create the instance.\n+ *     <li>invoking the static {@link #from} method, passing a config node containing the cross-origin information to be\n+ *     converted.\n+ *     </li>\n+ * </ul>\n+ *\n+ * @see MappedCrossOriginConfig\n+ *\n+ */\n+public class CrossOriginConfig {\n+\n+    /**\n+     * Key for the node within the CORS config that contains the list of path information.\n+     */\n+    public static final String CORS_PATHS_CONFIG_KEY = \"paths\";\n+\n+    /**\n+     * Header Access-Control-Allow-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"Access-Control-Allow-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Methods.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"Access-Control-Allow-Methods\";\n+    /**\n+     * Header Access-Control-Allow-Credentials.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"Access-Control-Allow-Credentials\";\n+    /**\n+     * Header Access-Control-Max-Age.\n+     */\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"Access-Control-Max-Age\";\n+    /**\n+     * Header Access-Control-Expose-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_EXPOSE_HEADERS = \"Access-Control-Expose-Headers\";\n+    /**\n+     * Header Access-Control-Allow-Origin.\n+     */\n+    public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"Access-Control-Allow-Origin\";\n+    /**\n+     * Header Access-Control-Request-Headers.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_HEADERS = \"Access-Control-Request-Headers\";\n+    /**\n+     * Header Access-Control-Request-Method.\n+     */\n+    public static final String ACCESS_CONTROL_REQUEST_METHOD = \"Access-Control-Request-Method\";\n+\n+    /**\n+     * Default cache expiration in seconds.\n+     */\n+    public static final long DEFAULT_AGE = 3600;\n+\n+    private final String pathPrefix;\n+    private final boolean enabled;\n+    private final String[] allowOrigins;\n+    private final String[] allowHeaders;\n+    private final String[] exposeHeaders;\n+    private final String[] allowMethods;\n+    private final boolean allowCredentials;\n+    private final long maxAge;\n+\n+    private CrossOriginConfig(Builder builder) {\n+        this.pathPrefix = builder.pathPrefix;\n+        this.enabled = builder.enabled;\n+        this.allowOrigins = builder.origins;\n+        this.allowHeaders = builder.allowHeaders;\n+        this.exposeHeaders = builder.exposeHeaders;\n+        this.allowMethods = builder.allowMethods;\n+        this.allowCredentials = builder.allowCredentials;\n+        this.maxAge = builder.maxAge;\n+    }\n+\n+    /**\n+     * @return a new builder for basic cross origin config\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code CrossOriginConfig} instance using the provided config node.\n+     *\n+     * @param config node containing cross-origin information\n+     * @return new {@code Basic} instance based on the configuration\n+     */\n+    public static CrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    /**\n+     * @return the configured path prefix; defaults to a \"match-everything\" pattern\n+     */\n+    public String pathPrefix() {\n+        return pathPrefix;\n+    }\n+\n+    /**\n+     * @return whether this cross-origin config is enabled\n+     */\n+    public boolean isEnabled() {\n+        return enabled;\n+    }\n+\n+    /**\n+     * @return the allowed origins\n+     */\n+    public String[] allowOrigins() {\n+        return copyOf(allowOrigins);\n+    }\n+\n+    /**\n+     * @return the allowed headers\n+     */\n+    public String[] allowHeaders() {\n+        return copyOf(allowHeaders);\n+    }\n+\n+    /**\n+     * @return headers OK to expose in responses\n+     */\n+    public String[] exposeHeaders() {\n+        return copyOf(exposeHeaders);\n+    }\n+\n+    /**\n+     * @return allowed methods\n+     */\n+    public String[] allowMethods() {\n+        return copyOf(allowMethods);\n+    }\n+\n+    /**\n+     * @return allowed credentials\n+     */\n+    public boolean allowCredentials() {\n+        return allowCredentials;\n+    }\n+\n+    /**\n+     * @return maximum age\n+     */\n+    public long maxAge() {\n+        return maxAge;\n+    }\n+\n+    private static String[] copyOf(String[] strings) {\n+        return strings != null ? Arrays.copyOf(strings, strings.length) : new String[0];\n+    }\n+\n+    /**\n+     * Builder for {@link CrossOriginConfig}.\n+     */\n+    public static class Builder implements Setter<Builder>, io.helidon.common.Builder<CrossOriginConfig>,\n+            Function<Config, Builder> {\n+\n+        static final String[] ALLOW_ALL = {\"*\"};\n+\n+        private String pathPrefix = PATHLESS_KEY; // not typically used except when inside a MappedCrossOriginConfig\n+        private boolean enabled = true;\n+        private String[] origins = ALLOW_ALL;\n+        private String[] allowHeaders = ALLOW_ALL;\n+        private String[] exposeHeaders;\n+        private String[] allowMethods = ALLOW_ALL;\n+        private boolean allowCredentials;\n+        private long maxAge = DEFAULT_AGE;\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new builder based on the values in an existing {@code CrossOriginConfig} object.\n+         *\n+         * @param original the existing cross-origin config object\n+         * @return new Builder initialized from the existing object's settings\n+         */\n+        public static Builder from(CrossOriginConfig original) {\n+            return new Builder()\n+                    .pathPrefix(original.pathPrefix)\n+                    .enabled(original.enabled)\n+                    .allowCredentials(original.allowCredentials)\n+                    .allowHeaders(original.allowHeaders)\n+                    .allowMethods(original.allowMethods)\n+                    .allowOrigins(original.allowOrigins)\n+                    .exposeHeaders(original.exposeHeaders)\n+                    .maxAge(original.maxAge);\n+        }\n+\n+        /**\n+         * Creates a new {@code Builder}instance from the specified configuration.\n+         *\n+         * @param config node containing cross-origin information\n+         * @return new {@code Builder} initialized from the config\n+         */\n+        public static Builder from(Config config) {\n+            return Loader.Basic.builder(config);\n+        }\n+\n+        @Override\n+        public Builder apply(Config config) {\n+            return from(config);\n+        }\n+\n+        /**\n+         * Updates the path prefix for this cross-origin config.\n+         *\n+         * @param pathPrefix new path prefix\n+         * @return updated builder\n+         */\n+        public Builder pathPrefix(String pathPrefix) {\n+            this.pathPrefix = pathPrefix;\n+            return this;\n+        }\n+\n+        String pathPrefix() {\n+            return pathPrefix;\n+        }\n+\n+        @Override\n+        public Builder enabled(boolean enabled) {\n+            this.enabled = enabled;\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder allowOrigins(String... origins) {\n+            this.origins = copyOf(origins);\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder allowHeaders(String... allowHeaders) {\n+            this.allowHeaders = copyOf(allowHeaders);\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder exposeHeaders(String... exposeHeaders) {\n+            this.exposeHeaders = copyOf(exposeHeaders);\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder allowMethods(String... allowMethods) {\n+            this.allowMethods = copyOf(allowMethods);\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder allowCredentials(boolean allowCredentials) {\n+            this.allowCredentials = allowCredentials;\n+            return this;\n+        }\n+\n+        @Override\n+        public Builder maxAge(long maxAge) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 298}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM1MzAwOnYy", "diffSide": "RIGHT", "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOrigin.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1MTowMVrOGHHjzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1MTowMVrOGHHjzg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExNzA3MA==", "bodyText": "Whenever time units are used and are not as a parameter, please name the method accordingly (e.g. maxAgeSeconds or maxAgeMillis). You can also add another method that accepts a time unit.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410117070", "createdAt": "2020-04-17T09:51:01Z", "author": {"login": "tomas-langer"}, "path": "microprofile/cors/src/main/java/io/helidon/microprofile/cors/CrossOrigin.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package io.helidon.microprofile.cors;\n+\n+import java.lang.annotation.Documented;\n+import java.lang.annotation.Retention;\n+import java.lang.annotation.Target;\n+\n+import static io.helidon.webserver.cors.CrossOriginConfig.DEFAULT_AGE;\n+import static java.lang.annotation.ElementType.METHOD;\n+import static java.lang.annotation.RetentionPolicy.RUNTIME;\n+\n+/**\n+ * CrossOrigin annotation.\n+ */\n+@Target(METHOD)\n+@Retention(RUNTIME)\n+@Documented\n+public @interface CrossOrigin {\n+\n+    /**\n+     * A list of origins that are allowed such as {@code \"http://foo.com\"} or\n+     * {@code \"*\"} to allow all origins. Corresponds to header {@code\n+     * Access-Control-Allow-Origin}.\n+     *\n+     * @return Allowed origins.\n+     */\n+    String[] value() default {\"*\"};\n+\n+    /**\n+     * A list of request headers that are allowed or {@code \"*\"} to allow all headers.\n+     * Corresponds to {@code Access-Control-Allow-Headers}.\n+     *\n+     * @return Allowed headers.\n+     */\n+    String[] allowHeaders() default {\"*\"};\n+\n+    /**\n+     * A list of response headers allowed for clients other than the \"standard\"\n+     * ones. Corresponds to {@code Access-Control-Expose-Headers}.\n+     *\n+     * @return Exposed headers.\n+     */\n+    String[] exposeHeaders() default {};\n+\n+    /**\n+     * A list of supported HTTP request methods. In response to pre-flight\n+     * requests. Corresponds to {@code Access-Control-Allow-Methods}.\n+     *\n+     * @return Allowed methods.\n+     */\n+    String[] allowMethods() default {\"*\"};\n+\n+    /**\n+     * Whether the client can send cookies or credentials. Corresponds to {@code\n+     * Access-Control-Allow-Credentials}.\n+     *\n+     * @return Allowed credentials.\n+     */\n+    boolean allowCredentials() default false;\n+\n+    /**\n+     * Pre-flight response duration in seconds. After time expires, a new pre-flight\n+     * request is required. Corresponds to {@code Access-Control-Max-Age}.\n+     *\n+     * @return Max age.\n+     */\n+    long maxAge() default DEFAULT_AGE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM2MDY4OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1MzoxNFrOGHHovA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1NDowOFrOGHHqgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExODMzMg==", "bodyText": "This does not seem to be a method relevant to the name of the class.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410118332", "createdAt": "2020-04-17T09:53:14Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.logging.Level;\n+\n+import io.helidon.common.http.Http;\n+import io.helidon.webserver.cors.CORSSupport.RequestAdapter;\n+import io.helidon.webserver.cors.CORSSupportHelper.RequestType;\n+\n+import static io.helidon.common.http.Http.Header.HOST;\n+import static io.helidon.common.http.Http.Header.ORIGIN;\n+import static io.helidon.webserver.cors.CORSSupportHelper.LOGGER;\n+import static io.helidon.webserver.cors.CrossOriginConfig.ACCESS_CONTROL_REQUEST_METHOD;\n+\n+class LogHelper {\n+\n+    static final Level DECISION_LEVEL = Level.FINE;\n+\n+    private LogHelper() {\n+    }\n+\n+    /**\n+     * Collects headers for assignment to a request or response and logging during assignment.\n+     */\n+    static class Headers {\n+        private final List<Map.Entry<String, Object>> headers = new ArrayList<>();\n+        private final List<String> notes = LOGGER.isLoggable(DECISION_LEVEL) ? new ArrayList<>() : null;\n+\n+        Headers add(String key, Object value) {\n+            headers.add(new AbstractMap.SimpleEntry<>(key, value));\n+            return this;\n+        }\n+\n+        Headers add(String key, Object value, String note) {\n+            add(key, value);\n+            if (notes != null) {\n+                notes.add(note);\n+            }\n+            return this;\n+        }\n+\n+        void set(BiConsumer<String, Object> consumer, String note) {\n+            headers.forEach(entry -> consumer.accept(entry.getKey(), entry.getValue()));\n+            LOGGER.log(DECISION_LEVEL, () -> note + \": \" + headers + (notes == null ? \"\" : notes));\n+        }\n+    }\n+\n+    static <T> boolean isRequestTypeNormal(boolean result, RequestAdapter<T> requestAdapter, Optional<String> originOpt,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExODc4NQ==", "bodyText": "As it is only used to log information, the return type should be void and maybe rename it to something log relevant?", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410118785", "createdAt": "2020-04-17T09:54:08Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.logging.Level;\n+\n+import io.helidon.common.http.Http;\n+import io.helidon.webserver.cors.CORSSupport.RequestAdapter;\n+import io.helidon.webserver.cors.CORSSupportHelper.RequestType;\n+\n+import static io.helidon.common.http.Http.Header.HOST;\n+import static io.helidon.common.http.Http.Header.ORIGIN;\n+import static io.helidon.webserver.cors.CORSSupportHelper.LOGGER;\n+import static io.helidon.webserver.cors.CrossOriginConfig.ACCESS_CONTROL_REQUEST_METHOD;\n+\n+class LogHelper {\n+\n+    static final Level DECISION_LEVEL = Level.FINE;\n+\n+    private LogHelper() {\n+    }\n+\n+    /**\n+     * Collects headers for assignment to a request or response and logging during assignment.\n+     */\n+    static class Headers {\n+        private final List<Map.Entry<String, Object>> headers = new ArrayList<>();\n+        private final List<String> notes = LOGGER.isLoggable(DECISION_LEVEL) ? new ArrayList<>() : null;\n+\n+        Headers add(String key, Object value) {\n+            headers.add(new AbstractMap.SimpleEntry<>(key, value));\n+            return this;\n+        }\n+\n+        Headers add(String key, Object value, String note) {\n+            add(key, value);\n+            if (notes != null) {\n+                notes.add(note);\n+            }\n+            return this;\n+        }\n+\n+        void set(BiConsumer<String, Object> consumer, String note) {\n+            headers.forEach(entry -> consumer.accept(entry.getKey(), entry.getValue()));\n+            LOGGER.log(DECISION_LEVEL, () -> note + \": \" + headers + (notes == null ? \"\" : notes));\n+        }\n+    }\n+\n+    static <T> boolean isRequestTypeNormal(boolean result, RequestAdapter<T> requestAdapter, Optional<String> originOpt,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExODMzMg=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM2ODkwOnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1NjowM1rOGHHuMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTozODo0MVrOGHTBHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExOTczMA==", "bodyText": "same as with previous method - void return type and name it with log in the name.\nAlso if this is all about logging, maybe checking that the log level is relevant would be good, before doing all the work (same for all methods in this class), as the first thing in every method:\nif (!LOGGER.isLoggable(DECISION_LEVEL)) {\n     return;\n}", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410119730", "createdAt": "2020-04-17T09:56:03Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.logging.Level;\n+\n+import io.helidon.common.http.Http;\n+import io.helidon.webserver.cors.CORSSupport.RequestAdapter;\n+import io.helidon.webserver.cors.CORSSupportHelper.RequestType;\n+\n+import static io.helidon.common.http.Http.Header.HOST;\n+import static io.helidon.common.http.Http.Header.ORIGIN;\n+import static io.helidon.webserver.cors.CORSSupportHelper.LOGGER;\n+import static io.helidon.webserver.cors.CrossOriginConfig.ACCESS_CONTROL_REQUEST_METHOD;\n+\n+class LogHelper {\n+\n+    static final Level DECISION_LEVEL = Level.FINE;\n+\n+    private LogHelper() {\n+    }\n+\n+    /**\n+     * Collects headers for assignment to a request or response and logging during assignment.\n+     */\n+    static class Headers {\n+        private final List<Map.Entry<String, Object>> headers = new ArrayList<>();\n+        private final List<String> notes = LOGGER.isLoggable(DECISION_LEVEL) ? new ArrayList<>() : null;\n+\n+        Headers add(String key, Object value) {\n+            headers.add(new AbstractMap.SimpleEntry<>(key, value));\n+            return this;\n+        }\n+\n+        Headers add(String key, Object value, String note) {\n+            add(key, value);\n+            if (notes != null) {\n+                notes.add(note);\n+            }\n+            return this;\n+        }\n+\n+        void set(BiConsumer<String, Object> consumer, String note) {\n+            headers.forEach(entry -> consumer.accept(entry.getKey(), entry.getValue()));\n+            LOGGER.log(DECISION_LEVEL, () -> note + \": \" + headers + (notes == null ? \"\" : notes));\n+        }\n+    }\n+\n+    static <T> boolean isRequestTypeNormal(boolean result, RequestAdapter<T> requestAdapter, Optional<String> originOpt,\n+            Optional<String> hostOpt) {\n+        // If no origin header or same as host, then just normal\n+\n+        List<String> reasonsWhyNormal = new ArrayList<>();\n+        List<String> factorsWhyCrossHost = new ArrayList<>();\n+\n+        if (originOpt.isEmpty()) {\n+            reasonsWhyNormal.add(\"header \" + ORIGIN + \" is absent\");\n+        } else {\n+            factorsWhyCrossHost.add(String.format(\"header %s is present (%s)\", ORIGIN, originOpt.get()));\n+        }\n+\n+        if (hostOpt.isEmpty()) {\n+            reasonsWhyNormal.add(\"header \" + HOST + \" is absent\");\n+        } else {\n+            factorsWhyCrossHost.add(String.format(\"header %s is present (%s)\", HOST, hostOpt.get()));\n+        }\n+\n+        if (hostOpt.isPresent() && originOpt.isPresent()) {\n+            String partOfOriginMatchingHost = \"://\" + hostOpt.get();\n+            if (originOpt.get()\n+                    .contains(partOfOriginMatchingHost)) {\n+                reasonsWhyNormal.add(String.format(\"header %s '%s' matches header %s '%s'; not cross-host\", ORIGIN,\n+                        originOpt.get(), HOST, hostOpt.get()));\n+            } else {\n+                factorsWhyCrossHost.add(String.format(\"header %s (%s) does not match header %s %s; cross-host\", ORIGIN,\n+                        originOpt.get(), HOST, hostOpt.get()));\n+            }\n+        }\n+\n+        if (result) {\n+            LOGGER.log(LogHelper.DECISION_LEVEL,\n+                    () -> String.format(\"Request %s is not cross-host: %s\", requestAdapter, reasonsWhyNormal));\n+        } else {\n+            LOGGER.log(LogHelper.DECISION_LEVEL,\n+                    () -> String.format(\"Request %s is cross-host: %s\", requestAdapter, factorsWhyCrossHost));\n+        }\n+        return result;\n+    }\n+\n+    static <T> RequestType inferCORSRequestType(RequestType result, RequestAdapter<T> requestAdapter, String methodName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 110}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDMwNDc5OQ==", "bodyText": "For isRequestTypeNormal and inferCORSRequestType the calling code had already checked whether the logger was enabled at a fine enough level (and also checked a separate boolean as well). But to be more obvious I've revised both to pass the other boolean as an additional argument and then do the check inside the two methods.\n(I had originally planned to use the logging methods to compute the values and (if enabled) do the logging. I chose to compute the value first in the caller for efficiency and then do the logging separately. I have set the return types to void and renamed the methods.)", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410304799", "createdAt": "2020-04-17T15:38:41Z", "author": {"login": "tjquinno"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/LogHelper.java", "diffHunk": "@@ -0,0 +1,133 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.logging.Level;\n+\n+import io.helidon.common.http.Http;\n+import io.helidon.webserver.cors.CORSSupport.RequestAdapter;\n+import io.helidon.webserver.cors.CORSSupportHelper.RequestType;\n+\n+import static io.helidon.common.http.Http.Header.HOST;\n+import static io.helidon.common.http.Http.Header.ORIGIN;\n+import static io.helidon.webserver.cors.CORSSupportHelper.LOGGER;\n+import static io.helidon.webserver.cors.CrossOriginConfig.ACCESS_CONTROL_REQUEST_METHOD;\n+\n+class LogHelper {\n+\n+    static final Level DECISION_LEVEL = Level.FINE;\n+\n+    private LogHelper() {\n+    }\n+\n+    /**\n+     * Collects headers for assignment to a request or response and logging during assignment.\n+     */\n+    static class Headers {\n+        private final List<Map.Entry<String, Object>> headers = new ArrayList<>();\n+        private final List<String> notes = LOGGER.isLoggable(DECISION_LEVEL) ? new ArrayList<>() : null;\n+\n+        Headers add(String key, Object value) {\n+            headers.add(new AbstractMap.SimpleEntry<>(key, value));\n+            return this;\n+        }\n+\n+        Headers add(String key, Object value, String note) {\n+            add(key, value);\n+            if (notes != null) {\n+                notes.add(note);\n+            }\n+            return this;\n+        }\n+\n+        void set(BiConsumer<String, Object> consumer, String note) {\n+            headers.forEach(entry -> consumer.accept(entry.getKey(), entry.getValue()));\n+            LOGGER.log(DECISION_LEVEL, () -> note + \": \" + headers + (notes == null ? \"\" : notes));\n+        }\n+    }\n+\n+    static <T> boolean isRequestTypeNormal(boolean result, RequestAdapter<T> requestAdapter, Optional<String> originOpt,\n+            Optional<String> hostOpt) {\n+        // If no origin header or same as host, then just normal\n+\n+        List<String> reasonsWhyNormal = new ArrayList<>();\n+        List<String> factorsWhyCrossHost = new ArrayList<>();\n+\n+        if (originOpt.isEmpty()) {\n+            reasonsWhyNormal.add(\"header \" + ORIGIN + \" is absent\");\n+        } else {\n+            factorsWhyCrossHost.add(String.format(\"header %s is present (%s)\", ORIGIN, originOpt.get()));\n+        }\n+\n+        if (hostOpt.isEmpty()) {\n+            reasonsWhyNormal.add(\"header \" + HOST + \" is absent\");\n+        } else {\n+            factorsWhyCrossHost.add(String.format(\"header %s is present (%s)\", HOST, hostOpt.get()));\n+        }\n+\n+        if (hostOpt.isPresent() && originOpt.isPresent()) {\n+            String partOfOriginMatchingHost = \"://\" + hostOpt.get();\n+            if (originOpt.get()\n+                    .contains(partOfOriginMatchingHost)) {\n+                reasonsWhyNormal.add(String.format(\"header %s '%s' matches header %s '%s'; not cross-host\", ORIGIN,\n+                        originOpt.get(), HOST, hostOpt.get()));\n+            } else {\n+                factorsWhyCrossHost.add(String.format(\"header %s (%s) does not match header %s %s; cross-host\", ORIGIN,\n+                        originOpt.get(), HOST, hostOpt.get()));\n+            }\n+        }\n+\n+        if (result) {\n+            LOGGER.log(LogHelper.DECISION_LEVEL,\n+                    () -> String.format(\"Request %s is not cross-host: %s\", requestAdapter, reasonsWhyNormal));\n+        } else {\n+            LOGGER.log(LogHelper.DECISION_LEVEL,\n+                    () -> String.format(\"Request %s is cross-host: %s\", requestAdapter, factorsWhyCrossHost));\n+        }\n+        return result;\n+    }\n+\n+    static <T> RequestType inferCORSRequestType(RequestType result, RequestAdapter<T> requestAdapter, String methodName,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExOTczMA=="}, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM3MTQwOnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/MappedCrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1Njo1NFrOGHHv8w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1Njo1NFrOGHHv8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyMDE3OQ==", "bodyText": "Same as above - do not put static factory methods to Builder classes", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410120179", "createdAt": "2020-04-17T09:56:54Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/MappedCrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.CORSSupportHelper.normalize;\n+\n+/**\n+ * Cross-origin {@link CrossOriginConfig} instances linked to paths, plus an {@code enabled} setting. Most developers will not\n+ * need to use this directly from their applications.\n+ */\n+public class MappedCrossOriginConfig implements Iterable<Map.Entry<String, CrossOriginConfig>> {\n+\n+    private boolean isEnabled = true;\n+\n+    private final Map<String, Buildable> buildables;\n+\n+    /**\n+     * Holds both a builder for and, later, the built {@code CrossOriginConfig} instances each of which are mapped to\n+     * a path expression.\n+     */\n+    private static class Buildable {\n+        private final CrossOriginConfig.Builder builder;\n+        private CrossOriginConfig crossOriginConfig;\n+\n+        Buildable(CrossOriginConfig.Builder builder) {\n+            this.builder = builder;\n+        }\n+\n+        /**\n+         * Returns the instance, building it if needed.\n+         *\n+         * @return the built instance\n+         */\n+        CrossOriginConfig get() {\n+            if (crossOriginConfig == null) {\n+                crossOriginConfig = builder.build();\n+            }\n+           return crossOriginConfig;\n+        }\n+    }\n+\n+    private MappedCrossOriginConfig(Builder builder) {\n+        this.isEnabled = builder.enabledOpt.orElse(true);\n+        buildables = builder.builders;\n+\n+        // Force building to prevent any changes to the underlying builders that could cause surprising behavior later.\n+        buildables.forEach((path, b) -> b.get());\n+    }\n+\n+    /**\n+     * Returns a new builder for creating a {@code CrossOriginConfig.Mapped} instance.\n+     *\n+     * @return the new builder\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code Mapped} instance using the provided configuration.\n+     *\n+     * @param config node containing {@code Mapped} cross-origin information\n+     * @return new {@code Mapped} instance based on the config\n+     */\n+    public static MappedCrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    @Override\n+    public Iterator<Map.Entry<String, CrossOriginConfig>> iterator() {\n+        return new Iterator<>() {\n+\n+            private final Iterator<Map.Entry<String, Buildable>> it = buildables.entrySet().iterator();\n+\n+            @Override\n+            public boolean hasNext() {\n+                return it.hasNext();\n+            }\n+\n+            @Override\n+            public Map.Entry<String, CrossOriginConfig> next() {\n+                Map.Entry<String, Buildable> next = it.next();\n+                return new AbstractMap.SimpleEntry<>(next.getKey(), next.getValue().get());\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Invokes the specified consumer for each entry in the mapped CORS config.\n+     * @param consumer accepts the path and the {@code CrossOriginConfig} for processing\n+     */\n+    public void forEach(BiConsumer<String, CrossOriginConfig> consumer) {\n+        buildables.forEach((path, buildable) -> consumer.accept(path, buildable.get()));\n+    }\n+\n+    /**\n+     * Finds the {@code CrossOriginConfig} associated with the given path expression, if any.\n+     *\n+     * @param pathExpr path expression to match on\n+     * @return {@code Optional} of the corresponding basic cross-origin information\n+     */\n+    public CrossOriginConfig get(String pathExpr) {\n+        Buildable b = buildables.get(normalize(pathExpr));\n+        return b == null ? null : b.get();\n+    }\n+\n+    /**\n+     * Reports whether this instance is enabled.\n+     * @return current enabled state\n+     */\n+    public boolean isEnabled() {\n+        return isEnabled;\n+    }\n+\n+    /**\n+     * Fluent builder for {@code Mapped} cross-origin config.\n+     */\n+    public static class Builder implements io.helidon.common.Builder<MappedCrossOriginConfig>, Function<Config, Builder> {\n+\n+        private Optional<Boolean> enabledOpt = Optional.empty();\n+        private final Map<String, Buildable> builders = new HashMap<>();\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new {@code Mapped.Builder} instance using the provided configuration.\n+         *\n+         * @param config node containing {@code Mapped} cross-origin information\n+         * @return new {@code Mapped.Builder} based on the config\n+         */\n+        public static Builder from(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 156}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NjM3MjQ5OnYy", "diffSide": "RIGHT", "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/MappedCrossOriginConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1NzoxN1rOGHHwsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo1NzoxN1rOGHHwsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDEyMDM3MQ==", "bodyText": "And do not return new builder instances from instance methods.", "url": "https://github.com/oracle/helidon/pull/1633#discussion_r410120371", "createdAt": "2020-04-17T09:57:17Z", "author": {"login": "tomas-langer"}, "path": "webserver/cors/src/main/java/io/helidon/webserver/cors/MappedCrossOriginConfig.java", "diffHunk": "@@ -0,0 +1,194 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ *\n+ */\n+package io.helidon.webserver.cors;\n+\n+import java.util.AbstractMap;\n+import java.util.HashMap;\n+import java.util.Iterator;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.function.BiConsumer;\n+import java.util.function.Function;\n+\n+import io.helidon.config.Config;\n+\n+import static io.helidon.webserver.cors.CORSSupportHelper.normalize;\n+\n+/**\n+ * Cross-origin {@link CrossOriginConfig} instances linked to paths, plus an {@code enabled} setting. Most developers will not\n+ * need to use this directly from their applications.\n+ */\n+public class MappedCrossOriginConfig implements Iterable<Map.Entry<String, CrossOriginConfig>> {\n+\n+    private boolean isEnabled = true;\n+\n+    private final Map<String, Buildable> buildables;\n+\n+    /**\n+     * Holds both a builder for and, later, the built {@code CrossOriginConfig} instances each of which are mapped to\n+     * a path expression.\n+     */\n+    private static class Buildable {\n+        private final CrossOriginConfig.Builder builder;\n+        private CrossOriginConfig crossOriginConfig;\n+\n+        Buildable(CrossOriginConfig.Builder builder) {\n+            this.builder = builder;\n+        }\n+\n+        /**\n+         * Returns the instance, building it if needed.\n+         *\n+         * @return the built instance\n+         */\n+        CrossOriginConfig get() {\n+            if (crossOriginConfig == null) {\n+                crossOriginConfig = builder.build();\n+            }\n+           return crossOriginConfig;\n+        }\n+    }\n+\n+    private MappedCrossOriginConfig(Builder builder) {\n+        this.isEnabled = builder.enabledOpt.orElse(true);\n+        buildables = builder.builders;\n+\n+        // Force building to prevent any changes to the underlying builders that could cause surprising behavior later.\n+        buildables.forEach((path, b) -> b.get());\n+    }\n+\n+    /**\n+     * Returns a new builder for creating a {@code CrossOriginConfig.Mapped} instance.\n+     *\n+     * @return the new builder\n+     */\n+    public static Builder builder() {\n+        return new Builder();\n+    }\n+\n+    /**\n+     * Creates a new {@code Mapped} instance using the provided configuration.\n+     *\n+     * @param config node containing {@code Mapped} cross-origin information\n+     * @return new {@code Mapped} instance based on the config\n+     */\n+    public static MappedCrossOriginConfig from(Config config) {\n+        return Builder.from(config).build();\n+    }\n+\n+    @Override\n+    public Iterator<Map.Entry<String, CrossOriginConfig>> iterator() {\n+        return new Iterator<>() {\n+\n+            private final Iterator<Map.Entry<String, Buildable>> it = buildables.entrySet().iterator();\n+\n+            @Override\n+            public boolean hasNext() {\n+                return it.hasNext();\n+            }\n+\n+            @Override\n+            public Map.Entry<String, CrossOriginConfig> next() {\n+                Map.Entry<String, Buildable> next = it.next();\n+                return new AbstractMap.SimpleEntry<>(next.getKey(), next.getValue().get());\n+            }\n+        };\n+    }\n+\n+    /**\n+     * Invokes the specified consumer for each entry in the mapped CORS config.\n+     * @param consumer accepts the path and the {@code CrossOriginConfig} for processing\n+     */\n+    public void forEach(BiConsumer<String, CrossOriginConfig> consumer) {\n+        buildables.forEach((path, buildable) -> consumer.accept(path, buildable.get()));\n+    }\n+\n+    /**\n+     * Finds the {@code CrossOriginConfig} associated with the given path expression, if any.\n+     *\n+     * @param pathExpr path expression to match on\n+     * @return {@code Optional} of the corresponding basic cross-origin information\n+     */\n+    public CrossOriginConfig get(String pathExpr) {\n+        Buildable b = buildables.get(normalize(pathExpr));\n+        return b == null ? null : b.get();\n+    }\n+\n+    /**\n+     * Reports whether this instance is enabled.\n+     * @return current enabled state\n+     */\n+    public boolean isEnabled() {\n+        return isEnabled;\n+    }\n+\n+    /**\n+     * Fluent builder for {@code Mapped} cross-origin config.\n+     */\n+    public static class Builder implements io.helidon.common.Builder<MappedCrossOriginConfig>, Function<Config, Builder> {\n+\n+        private Optional<Boolean> enabledOpt = Optional.empty();\n+        private final Map<String, Buildable> builders = new HashMap<>();\n+\n+        private Builder() {\n+        }\n+\n+        /**\n+         * Creates a new {@code Mapped.Builder} instance using the provided configuration.\n+         *\n+         * @param config node containing {@code Mapped} cross-origin information\n+         * @return new {@code Mapped.Builder} based on the config\n+         */\n+        public static Builder from(Config config) {\n+            return Loader.Mapped.builder(config);\n+        }\n+\n+        @Override\n+        public MappedCrossOriginConfig build() {\n+            return new MappedCrossOriginConfig(this);\n+        }\n+\n+\n+        @Override\n+        public Builder apply(Config config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e0d148d8cdeabe8c426b1c268ae40ce7e073da2f"}, "originalPosition": 167}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 626, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}