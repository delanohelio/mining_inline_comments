{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MDQ3MDQ1", "number": 1796, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzoxMzoxN1rOD8kw2A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODozNFrOD9BVCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODQzNDgwOnYy", "diffSide": "RIGHT", "path": "media/jsonb/common/src/main/java/io/helidon/media/jsonb/common/JsonbBodyWriter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxNzoxMzoxN1rOGVmUUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyNzozMlrOGWUVjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwMTA3Mg==", "bodyText": "Is this actually required ?", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425301072", "createdAt": "2020-05-14T17:13:17Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonb/common/src/main/java/io/helidon/media/jsonb/common/JsonbBodyWriter.java", "diffHunk": "@@ -48,6 +49,13 @@ private JsonbBodyWriter(Jsonb jsonb) {\n     public boolean accept(GenericType<?> type,\n             MessageBodyWriterContext context) {\n \n+        // We are excluding the following types from support:\n+        // 1. any char sequence\n+        // 2. Flow.Publisher - that can only be supported by streaming media\n+        if (Flow.Publisher.class.isAssignableFrom(type.rawType())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzNTgxNQ==", "bodyText": "Yes, because otherwise when you have JSON-B registered, you do not get an error, if you do  response.send(Publisher<Pojo>)\nYou should get appropriate error telling you there is no registered writer, but JSON-B just processes it", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425635815", "createdAt": "2020-05-15T08:07:56Z", "author": {"login": "tomas-langer"}, "path": "media/jsonb/common/src/main/java/io/helidon/media/jsonb/common/JsonbBodyWriter.java", "diffHunk": "@@ -48,6 +49,13 @@ private JsonbBodyWriter(Jsonb jsonb) {\n     public boolean accept(GenericType<?> type,\n             MessageBodyWriterContext context) {\n \n+        // We are excluding the following types from support:\n+        // 1. any char sequence\n+        // 2. Flow.Publisher - that can only be supported by streaming media\n+        if (Flow.Publisher.class.isAssignableFrom(type.rawType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwMTA3Mg=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1Mzk4MA==", "bodyText": "This is something that we should solve for all non stream readers and writers.\nreponse.send(Publisher<Pojo>) is really not supported, instead it should be `response.send(Publisher, Pojo.class).\nI.e, MessageBodyWriterContext.marshall and MessageBodyReader.Context.unmarshall should reject the Flow.Puslisher type.\nCan you update these two methods and throw a proper exception (maybe IllegalArgumentException) ?", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r426053980", "createdAt": "2020-05-15T21:24:23Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonb/common/src/main/java/io/helidon/media/jsonb/common/JsonbBodyWriter.java", "diffHunk": "@@ -48,6 +49,13 @@ private JsonbBodyWriter(Jsonb jsonb) {\n     public boolean accept(GenericType<?> type,\n             MessageBodyWriterContext context) {\n \n+        // We are excluding the following types from support:\n+        // 1. any char sequence\n+        // 2. Flow.Publisher - that can only be supported by streaming media\n+        if (Flow.Publisher.class.isAssignableFrom(type.rawType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwMTA3Mg=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTA1Mw==", "bodyText": "I will look for the place we check for byte[] and update it", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r426055053", "createdAt": "2020-05-15T21:27:32Z", "author": {"login": "tomas-langer"}, "path": "media/jsonb/common/src/main/java/io/helidon/media/jsonb/common/JsonbBodyWriter.java", "diffHunk": "@@ -48,6 +49,13 @@ private JsonbBodyWriter(Jsonb jsonb) {\n     public boolean accept(GenericType<?> type,\n             MessageBodyWriterContext context) {\n \n+        // We are excluding the following types from support:\n+        // 1. any char sequence\n+        // 2. Flow.Publisher - that can only be supported by streaming media\n+        if (Flow.Publisher.class.isAssignableFrom(type.rawType())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMwMTA3Mg=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODYyNjE5OnYy", "diffSide": "RIGHT", "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODowNDo1OVrOGVoSFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQwODo1ODo1N1rOGWt09Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMzI3MQ==", "bodyText": "@danielkec FYI. Can this be done better ? Is there something we can add in Multi to support this ?", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425333271", "createdAt": "2020-05-14T18:04:59Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.media.jsonp.common;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.Flow.Publisher;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.json.JsonStructure;\n+import javax.json.JsonWriterFactory;\n+\n+import io.helidon.common.GenericType;\n+import io.helidon.common.http.DataChunk;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.reactive.Multi;\n+import io.helidon.common.reactive.Single;\n+import io.helidon.media.common.MessageBodyStreamWriter;\n+import io.helidon.media.common.MessageBodyWriterContext;\n+import io.helidon.media.jsonp.common.JsonpBodyWriter.JsonStructureToChunks;\n+\n+/**\n+ * Message body writer for {@link javax.json.JsonStructure} sub-classes (JSON-P).\n+ */\n+public class JsonpBodyStreamWriter implements MessageBodyStreamWriter<JsonStructure> {\n+    private static final byte[] ARRAY_JSON_END_BYTES = \"]\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] ARRAY_JSON_BEGIN_BYTES = \"[\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] COMMA_BYTES = \",\".getBytes(StandardCharsets.UTF_8);\n+\n+    private final JsonWriterFactory jsonWriterFactory;\n+\n+    JsonpBodyStreamWriter(JsonWriterFactory jsonWriterFactory) {\n+        this.jsonWriterFactory = jsonWriterFactory;\n+    }\n+\n+    @Override\n+    public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n+        return JsonStructure.class.isAssignableFrom(type.rawType());\n+    }\n+\n+    @Override\n+    public Publisher<DataChunk> write(Publisher<JsonStructure> publisher,\n+                                      GenericType<? extends JsonStructure> type,\n+                                      MessageBodyWriterContext context) {\n+\n+        MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n+        context.contentType(contentType);\n+\n+        // we do not have join operator\n+        AtomicBoolean first = new AtomicBoolean(true);\n+\n+        JsonStructureToChunks jsonToChunks = new JsonStructureToChunks(jsonWriterFactory,\n+                                                                       context.charset());\n+\n+        // we also do not have an append operator\n+        Multi<DataChunk> stream = Multi.concat(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY5OTQ3Mw==", "bodyText": "Now we do #1806", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425699473", "createdAt": "2020-05-15T10:05:19Z", "author": {"login": "danielkec"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.media.jsonp.common;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.Flow.Publisher;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.json.JsonStructure;\n+import javax.json.JsonWriterFactory;\n+\n+import io.helidon.common.GenericType;\n+import io.helidon.common.http.DataChunk;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.reactive.Multi;\n+import io.helidon.common.reactive.Single;\n+import io.helidon.media.common.MessageBodyStreamWriter;\n+import io.helidon.media.common.MessageBodyWriterContext;\n+import io.helidon.media.jsonp.common.JsonpBodyWriter.JsonStructureToChunks;\n+\n+/**\n+ * Message body writer for {@link javax.json.JsonStructure} sub-classes (JSON-P).\n+ */\n+public class JsonpBodyStreamWriter implements MessageBodyStreamWriter<JsonStructure> {\n+    private static final byte[] ARRAY_JSON_END_BYTES = \"]\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] ARRAY_JSON_BEGIN_BYTES = \"[\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] COMMA_BYTES = \",\".getBytes(StandardCharsets.UTF_8);\n+\n+    private final JsonWriterFactory jsonWriterFactory;\n+\n+    JsonpBodyStreamWriter(JsonWriterFactory jsonWriterFactory) {\n+        this.jsonWriterFactory = jsonWriterFactory;\n+    }\n+\n+    @Override\n+    public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n+        return JsonStructure.class.isAssignableFrom(type.rawType());\n+    }\n+\n+    @Override\n+    public Publisher<DataChunk> write(Publisher<JsonStructure> publisher,\n+                                      GenericType<? extends JsonStructure> type,\n+                                      MessageBodyWriterContext context) {\n+\n+        MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n+        context.contentType(contentType);\n+\n+        // we do not have join operator\n+        AtomicBoolean first = new AtomicBoolean(true);\n+\n+        JsonStructureToChunks jsonToChunks = new JsonStructureToChunks(jsonWriterFactory,\n+                                                                       context.charset());\n+\n+        // we also do not have an append operator\n+        Multi<DataChunk> stream = Multi.concat(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMzI3MQ=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA0OTg1Nw==", "bodyText": "@tomas-langer Can you update the corresponding code to leverage #1806", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r426049857", "createdAt": "2020-05-15T21:13:37Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.media.jsonp.common;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.Flow.Publisher;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.json.JsonStructure;\n+import javax.json.JsonWriterFactory;\n+\n+import io.helidon.common.GenericType;\n+import io.helidon.common.http.DataChunk;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.reactive.Multi;\n+import io.helidon.common.reactive.Single;\n+import io.helidon.media.common.MessageBodyStreamWriter;\n+import io.helidon.media.common.MessageBodyWriterContext;\n+import io.helidon.media.jsonp.common.JsonpBodyWriter.JsonStructureToChunks;\n+\n+/**\n+ * Message body writer for {@link javax.json.JsonStructure} sub-classes (JSON-P).\n+ */\n+public class JsonpBodyStreamWriter implements MessageBodyStreamWriter<JsonStructure> {\n+    private static final byte[] ARRAY_JSON_END_BYTES = \"]\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] ARRAY_JSON_BEGIN_BYTES = \"[\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] COMMA_BYTES = \",\".getBytes(StandardCharsets.UTF_8);\n+\n+    private final JsonWriterFactory jsonWriterFactory;\n+\n+    JsonpBodyStreamWriter(JsonWriterFactory jsonWriterFactory) {\n+        this.jsonWriterFactory = jsonWriterFactory;\n+    }\n+\n+    @Override\n+    public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n+        return JsonStructure.class.isAssignableFrom(type.rawType());\n+    }\n+\n+    @Override\n+    public Publisher<DataChunk> write(Publisher<JsonStructure> publisher,\n+                                      GenericType<? extends JsonStructure> type,\n+                                      MessageBodyWriterContext context) {\n+\n+        MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n+        context.contentType(contentType);\n+\n+        // we do not have join operator\n+        AtomicBoolean first = new AtomicBoolean(true);\n+\n+        JsonStructureToChunks jsonToChunks = new JsonStructureToChunks(jsonWriterFactory,\n+                                                                       context.charset());\n+\n+        // we also do not have an append operator\n+        Multi<DataChunk> stream = Multi.concat(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMzI3MQ=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjQ3MjY5Mw==", "bodyText": "Done", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r426472693", "createdAt": "2020-05-18T08:58:57Z", "author": {"login": "tomas-langer"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.media.jsonp.common;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.Flow.Publisher;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.json.JsonStructure;\n+import javax.json.JsonWriterFactory;\n+\n+import io.helidon.common.GenericType;\n+import io.helidon.common.http.DataChunk;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.reactive.Multi;\n+import io.helidon.common.reactive.Single;\n+import io.helidon.media.common.MessageBodyStreamWriter;\n+import io.helidon.media.common.MessageBodyWriterContext;\n+import io.helidon.media.jsonp.common.JsonpBodyWriter.JsonStructureToChunks;\n+\n+/**\n+ * Message body writer for {@link javax.json.JsonStructure} sub-classes (JSON-P).\n+ */\n+public class JsonpBodyStreamWriter implements MessageBodyStreamWriter<JsonStructure> {\n+    private static final byte[] ARRAY_JSON_END_BYTES = \"]\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] ARRAY_JSON_BEGIN_BYTES = \"[\".getBytes(StandardCharsets.UTF_8);\n+    private static final byte[] COMMA_BYTES = \",\".getBytes(StandardCharsets.UTF_8);\n+\n+    private final JsonWriterFactory jsonWriterFactory;\n+\n+    JsonpBodyStreamWriter(JsonWriterFactory jsonWriterFactory) {\n+        this.jsonWriterFactory = jsonWriterFactory;\n+    }\n+\n+    @Override\n+    public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n+        return JsonStructure.class.isAssignableFrom(type.rawType());\n+    }\n+\n+    @Override\n+    public Publisher<DataChunk> write(Publisher<JsonStructure> publisher,\n+                                      GenericType<? extends JsonStructure> type,\n+                                      MessageBodyWriterContext context) {\n+\n+        MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n+        context.contentType(contentType);\n+\n+        // we do not have join operator\n+        AtomicBoolean first = new AtomicBoolean(true);\n+\n+        JsonStructureToChunks jsonToChunks = new JsonStructureToChunks(jsonWriterFactory,\n+                                                                       context.charset());\n+\n+        // we also do not have an append operator\n+        Multi<DataChunk> stream = Multi.concat(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzMzI3MQ=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODYzNzczOnYy", "diffSide": "RIGHT", "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyWriter.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODowODoxNlrOGVoZpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODoxNToyN1rOGV6-eQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTIwNw==", "bodyText": "I under what you are doing here, but if we do this we need to do this for all the places where there is similar code. i.e  jsonb, jackson.", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425335207", "createdAt": "2020-05-14T18:08:16Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyWriter.java", "diffHunk": "@@ -50,15 +49,14 @@ public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n \n     @Override\n     public Publisher<DataChunk> write(Single<JsonStructure> content, GenericType<? extends JsonStructure> type,\n-            MessageBodyWriterContext context) {\n+                                      MessageBodyWriterContext context) {\n \n         MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n         context.contentType(contentType);\n-        return content.flatMap(new JsonStructureToChunks(jsonWriterFactory, context.charset()));\n+        return content.map(new JsonStructureToChunks(jsonWriterFactory, context.charset()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzOTA5Nw==", "bodyText": "this is not a different functionality - it still works the same, I am just skipping going from an immediate value to publisher, as that created an unnecessary flatMap operation.\nAlso when I need to process records one by one, the intermediate publisher would cause trouble (as if it had more than one chunk per JsonObject, I would insert two commas there).\nWe should revisit it when implementing the stream writers for JSON-B and for Jackson", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425639097", "createdAt": "2020-05-15T08:14:37Z", "author": {"login": "tomas-langer"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyWriter.java", "diffHunk": "@@ -50,15 +49,14 @@ public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n \n     @Override\n     public Publisher<DataChunk> write(Single<JsonStructure> content, GenericType<? extends JsonStructure> type,\n-            MessageBodyWriterContext context) {\n+                                      MessageBodyWriterContext context) {\n \n         MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n         context.contentType(contentType);\n-        return content.flatMap(new JsonStructureToChunks(jsonWriterFactory, context.charset()));\n+        return content.map(new JsonStructureToChunks(jsonWriterFactory, context.charset()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTIwNw=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzOTU0NQ==", "bodyText": "will add a reference to those issues", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425639545", "createdAt": "2020-05-15T08:15:27Z", "author": {"login": "tomas-langer"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyWriter.java", "diffHunk": "@@ -50,15 +49,14 @@ public boolean accept(GenericType<?> type, MessageBodyWriterContext context) {\n \n     @Override\n     public Publisher<DataChunk> write(Single<JsonStructure> content, GenericType<? extends JsonStructure> type,\n-            MessageBodyWriterContext context) {\n+                                      MessageBodyWriterContext context) {\n \n         MediaType contentType = context.findAccepted(MediaType.JSON_PREDICATE, MediaType.APPLICATION_JSON);\n         context.contentType(contentType);\n-        return content.flatMap(new JsonStructureToChunks(jsonWriterFactory, context.charset()));\n+        return content.map(new JsonStructureToChunks(jsonWriterFactory, context.charset()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTIwNw=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY0ODY0MjQ1OnYy", "diffSide": "RIGHT", "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpSupport.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQxODowOTo0NlrOGVoctg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODowNDoxOVrOGV6oxg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTk5MA==", "bodyText": "The newXXX static methods have been removed. Let's remove it.", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425335990", "createdAt": "2020-05-14T18:09:46Z", "author": {"login": "romain-grecourt"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpSupport.java", "diffHunk": "@@ -61,6 +62,19 @@ public JsonpBodyWriter newWriter() {\n         return new JsonpBodyWriter(jsonWriterFactory);\n     }\n \n+    /**\n+     * Create a new JSON-P stream writer.\n+     * <p>\n+     * This stream writer supports {@link java.util.concurrent.Flow.Publisher publishers}\n+     * of {@link javax.json.JsonStructure} (such as {@link javax.json.JsonObject})\n+     * , writing them as an array of JSONs.\n+     *\n+     * @return JSON processing stream writer.\n+     */\n+    public JsonpBodyStreamWriter newStreamWriter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYzMzk5MA==", "bodyText": "Actually these newXXX methods are not yet removed in this version. I didn't commit these changes yet. So I think it is OK to leave it as it is.", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r425633990", "createdAt": "2020-05-15T08:04:19Z", "author": {"login": "Verdent"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpSupport.java", "diffHunk": "@@ -61,6 +62,19 @@ public JsonpBodyWriter newWriter() {\n         return new JsonpBodyWriter(jsonWriterFactory);\n     }\n \n+    /**\n+     * Create a new JSON-P stream writer.\n+     * <p>\n+     * This stream writer supports {@link java.util.concurrent.Flow.Publisher publishers}\n+     * of {@link javax.json.JsonStructure} (such as {@link javax.json.JsonObject})\n+     * , writing them as an array of JSONs.\n+     *\n+     * @return JSON processing stream writer.\n+     */\n+    public JsonpBodyStreamWriter newStreamWriter() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTMzNTk5MA=="}, "originalCommit": {"oid": "c41fdca1b88098ef8ee49f274c990001c8c1b30a"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY1MzExNDk3OnYy", "diffSide": "RIGHT", "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODozNFrOGWUXDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMToyODozNFrOGWUXDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA1NTQzNg==", "bodyText": "Add a unit test.", "url": "https://github.com/oracle/helidon/pull/1796#discussion_r426055436", "createdAt": "2020-05-15T21:28:34Z", "author": {"login": "tomas-langer"}, "path": "media/jsonp/common/src/main/java/io/helidon/media/jsonp/common/JsonpBodyStreamWriter.java", "diffHunk": "@@ -0,0 +1,88 @@\n+/*\n+ * Copyright (c) 2020 Oracle and/or its affiliates.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package io.helidon.media.jsonp.common;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.concurrent.Flow.Publisher;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import javax.json.JsonStructure;\n+import javax.json.JsonWriterFactory;\n+\n+import io.helidon.common.GenericType;\n+import io.helidon.common.http.DataChunk;\n+import io.helidon.common.http.MediaType;\n+import io.helidon.common.reactive.Multi;\n+import io.helidon.common.reactive.Single;\n+import io.helidon.media.common.MessageBodyStreamWriter;\n+import io.helidon.media.common.MessageBodyWriterContext;\n+import io.helidon.media.jsonp.common.JsonpBodyWriter.JsonStructureToChunks;\n+\n+/**\n+ * Message body writer for {@link javax.json.JsonStructure} sub-classes (JSON-P).\n+ */\n+public class JsonpBodyStreamWriter implements MessageBodyStreamWriter<JsonStructure> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8ac088efb21c19dbecb7b84ce3f40ba01499218"}, "originalPosition": 37}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 690, "cost": 1, "resetAt": "2021-11-13T12:10:21Z"}}}