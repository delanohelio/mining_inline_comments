{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMzcwNDk5", "number": 1295, "title": "JWT-Auth for native-image.", "bodyText": "Signed-off-by: Tomas Langer tomas.langer@oracle.com", "createdAt": "2020-01-13T23:23:05Z", "url": "https://github.com/oracle/helidon/pull/1295", "merged": true, "mergeCommit": {"oid": "3924c587b31cc3df8e3e9f3b0ec0fac1cbe2ff7e"}, "closed": true, "closedAt": "2020-01-16T13:03:59Z", "author": {"login": "tomas-langer"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6E9n8ABqjI5NDUxNDI2MDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb65IedgFqTM0Mzg3MDMwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e125499a8be31b6b0136ae93f84e97e7797fa25b", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/e125499a8be31b6b0136ae93f84e97e7797fa25b", "committedDate": "2020-01-13T23:22:21Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "62933e855c355d55a3f996be4bb785a801dfb214", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/62933e855c355d55a3f996be4bb785a801dfb214", "committedDate": "2020-01-13T23:29:04Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "62933e855c355d55a3f996be4bb785a801dfb214", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/62933e855c355d55a3f996be4bb785a801dfb214", "committedDate": "2020-01-13T23:29:04Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "50c59429a369b21a1396bddc2b1442d78eacfd8b", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/50c59429a369b21a1396bddc2b1442d78eacfd8b", "committedDate": "2020-01-14T00:15:30Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNDE2MjM5", "url": "https://github.com/oracle/helidon/pull/1295#pullrequestreview-342416239", "createdAt": "2020-01-14T10:08:29Z", "commit": {"oid": "50c59429a369b21a1396bddc2b1442d78eacfd8b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxMDowODoyOVrOFdSHWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxMDowODoyOVrOFdSHWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjI0OTgxOQ==", "bodyText": "subjectMappingProvider.isEmpty()", "url": "https://github.com/oracle/helidon/pull/1295#discussion_r366249819", "createdAt": "2020-01-14T10:08:29Z", "author": {"login": "danielkec"}, "path": "security/security/src/main/java/io/helidon/security/Security.java", "diffHunk": "@@ -1100,10 +1108,47 @@ private boolean notReservedProviderKey(Config config) {\n \n         /**\n          * Check whether any provider is configured.\n+         * @param providerClass type of provider of interest (can be {@link io.helidon.security.spi.AuthenticationProvider} and\n+         *                      other interfaces implementing {@link io.helidon.security.spi.SecurityProvider})\n          * @return {@code true} if no provider is configured, {@code false} if there is at least one provider configured\n          */\n-        public boolean noProvider() {\n+        public boolean noProvider(Class<? extends SecurityProvider> providerClass) {\n+            if (providerClass.equals(AuthenticationProvider.class)) {\n+                return atnProviders.isEmpty();\n+            }\n+            if (providerClass.equals(AuthorizationProvider.class)) {\n+                return atzProviders.isEmpty();\n+            }\n+            if (providerClass.equals(OutboundSecurityProvider.class)) {\n+                return outboundProviders.isEmpty();\n+            }\n+            if (providerClass.equals(AuditProvider.class)) {\n+                return auditProviders.isEmpty();\n+            }\n+            if (providerClass.equals(SubjectMappingProvider.class)) {\n+                return subjectMappingProvider == null;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50c59429a369b21a1396bddc2b1442d78eacfd8b"}, "originalPosition": 87}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50c59429a369b21a1396bddc2b1442d78eacfd8b", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/50c59429a369b21a1396bddc2b1442d78eacfd8b", "committedDate": "2020-01-14T00:15:30Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "a00c9c1dc05ec56bb6d50acc2a0a23e65e3a170e", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/a00c9c1dc05ec56bb6d50acc2a0a23e65e3a170e", "committedDate": "2020-01-14T11:03:21Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a00c9c1dc05ec56bb6d50acc2a0a23e65e3a170e", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/a00c9c1dc05ec56bb6d50acc2a0a23e65e3a170e", "committedDate": "2020-01-14T11:03:21Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "5b2e212cd817820d82dae561c578b0a75a9498ec", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/5b2e212cd817820d82dae561c578b0a75a9498ec", "committedDate": "2020-01-14T16:24:23Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b2e212cd817820d82dae561c578b0a75a9498ec", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/5b2e212cd817820d82dae561c578b0a75a9498ec", "committedDate": "2020-01-14T16:24:23Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "0632e63009c51d6d8d88923cf1066adbec6f949e", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/0632e63009c51d6d8d88923cf1066adbec6f949e", "committedDate": "2020-01-14T16:36:48Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0632e63009c51d6d8d88923cf1066adbec6f949e", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/0632e63009c51d6d8d88923cf1066adbec6f949e", "committedDate": "2020-01-14T16:36:48Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "35390f69a0c6b5fe37deb6116d08048c59984d40", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/35390f69a0c6b5fe37deb6116d08048c59984d40", "committedDate": "2020-01-14T17:03:04Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35390f69a0c6b5fe37deb6116d08048c59984d40", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/35390f69a0c6b5fe37deb6116d08048c59984d40", "committedDate": "2020-01-14T17:03:04Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "9374909646291cf025c8be112592c193eb9d46ba", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/9374909646291cf025c8be112592c193eb9d46ba", "committedDate": "2020-01-16T10:45:37Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODQ0Njk1", "url": "https://github.com/oracle/helidon/pull/1295#pullrequestreview-343844695", "createdAt": "2020-01-16T11:26:32Z", "commit": {"oid": "9374909646291cf025c8be112592c193eb9d46ba"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMToyNjozMlrOFeWRWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMToyNzo1MVrOFeWTlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2NjQ5MA==", "bodyText": "I would say, that this check should be right after obtaining security. That mean somewhere around line 171.", "url": "https://github.com/oracle/helidon/pull/1295#discussion_r367366490", "createdAt": "2020-01-16T11:26:32Z", "author": {"login": "Verdent"}, "path": "microprofile/jwt-auth/src/main/java/io/helidon/microprofile/jwt/auth/JwtAuthCdiExtension.java", "diffHunk": "@@ -139,13 +150,47 @@ public void registerClaimProducers(@Observes AfterBeanDiscovery abd, BeanManager\n      *\n      * @param add event from CDI container\n      */\n-    public void validate(@Observes AfterDeploymentValidation add) {\n+    void validate(@Observes AfterDeploymentValidation add) {\n         qualifiers.forEach(q -> {\n             ClaimLiteral claimLiteral = q.getQualifier();\n             validate(claimLiteral);\n         });\n     }\n \n+    void configured(@Observes @RuntimeStart Config config) {\n+        this.config = config;\n+    }\n+\n+    void registerProvider(@Observes\n+                          @Initialized(ApplicationScoped.class)\n+                          @Priority(PLATFORM_BEFORE + 5) Object event,\n+                          BeanManager bm) {\n+        // I need the JAX-RS extension and the Security extension\n+        JaxRsCdiExtension jaxrs = bm.getExtension(JaxRsCdiExtension.class);\n+        SecurityCdiExtension security = bm.getExtension(SecurityCdiExtension.class);\n+\n+        boolean notNeeded = jaxrs.applicationsToRun()\n+                .stream()\n+                .map(JaxRsApplication::applicationClass)\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)\n+                .map(clazz -> clazz.getAnnotation(LoginConfig.class))\n+                .filter(Objects::nonNull)\n+                .map(LoginConfig::authMethod)\n+                .noneMatch(\"MP-JWT\"::equals);\n+\n+        if (notNeeded) {\n+            return;\n+        }\n+\n+        if (security.securityBuilder().hasProvider(\"mp-jwt-auth\")) {\n+            return;\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9374909646291cf025c8be112592c193eb9d46ba"}, "originalPosition": 115}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM2NzA2Mw==", "bodyText": "\"mp-jwt-auth\" should be as constant.", "url": "https://github.com/oracle/helidon/pull/1295#discussion_r367367063", "createdAt": "2020-01-16T11:27:51Z", "author": {"login": "Verdent"}, "path": "microprofile/jwt-auth/src/main/java/io/helidon/microprofile/jwt/auth/JwtAuthCdiExtension.java", "diffHunk": "@@ -139,13 +150,47 @@ public void registerClaimProducers(@Observes AfterBeanDiscovery abd, BeanManager\n      *\n      * @param add event from CDI container\n      */\n-    public void validate(@Observes AfterDeploymentValidation add) {\n+    void validate(@Observes AfterDeploymentValidation add) {\n         qualifiers.forEach(q -> {\n             ClaimLiteral claimLiteral = q.getQualifier();\n             validate(claimLiteral);\n         });\n     }\n \n+    void configured(@Observes @RuntimeStart Config config) {\n+        this.config = config;\n+    }\n+\n+    void registerProvider(@Observes\n+                          @Initialized(ApplicationScoped.class)\n+                          @Priority(PLATFORM_BEFORE + 5) Object event,\n+                          BeanManager bm) {\n+        // I need the JAX-RS extension and the Security extension\n+        JaxRsCdiExtension jaxrs = bm.getExtension(JaxRsCdiExtension.class);\n+        SecurityCdiExtension security = bm.getExtension(SecurityCdiExtension.class);\n+\n+        boolean notNeeded = jaxrs.applicationsToRun()\n+                .stream()\n+                .map(JaxRsApplication::applicationClass)\n+                .filter(Optional::isPresent)\n+                .map(Optional::get)\n+                .map(clazz -> clazz.getAnnotation(LoginConfig.class))\n+                .filter(Objects::nonNull)\n+                .map(LoginConfig::authMethod)\n+                .noneMatch(\"MP-JWT\"::equals);\n+\n+        if (notNeeded) {\n+            return;\n+        }\n+\n+        if (security.securityBuilder().hasProvider(\"mp-jwt-auth\")) {\n+            return;\n+        }\n+\n+        security.securityBuilder()\n+                .addProvider(JwtAuthProvider.create(config), \"mp-jwt-auth\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9374909646291cf025c8be112592c193eb9d46ba"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b77a7590dd9e669ac7ff15df0937e3e95ddb8921", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/b77a7590dd9e669ac7ff15df0937e3e95ddb8921", "committedDate": "2020-01-16T11:39:13Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9374909646291cf025c8be112592c193eb9d46ba", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/9374909646291cf025c8be112592c193eb9d46ba", "committedDate": "2020-01-16T10:45:37Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}, "afterCommit": {"oid": "b77a7590dd9e669ac7ff15df0937e3e95ddb8921", "author": {"user": {"login": "tomas-langer", "name": "Tomas Langer"}}, "url": "https://github.com/oracle/helidon/commit/b77a7590dd9e669ac7ff15df0937e3e95ddb8921", "committedDate": "2020-01-16T11:39:13Z", "message": "JWT-Auth for native-image.\n\nSigned-off-by: Tomas Langer <tomas.langer@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODcwMzA4", "url": "https://github.com/oracle/helidon/pull/1295#pullrequestreview-343870308", "createdAt": "2020-01-16T12:16:23Z", "commit": {"oid": "b77a7590dd9e669ac7ff15df0937e3e95ddb8921"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 882, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}