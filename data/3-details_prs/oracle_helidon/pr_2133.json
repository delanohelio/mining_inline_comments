{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzkxNDkz", "number": 2133, "title": "Buffer single-byte writes in MultiFromOutputStream for better performance", "bodyText": "Avoid publishing single-byte arrays whenever possible. Every single-byte write is cached until either the buffer is full or a multi-byte write is requested. Multi-byte writes (arrays) are never cached and always published immediately. Manual flushes still permitted as before. See #1833 for a discussion.", "createdAt": "2020-07-06T13:53:52Z", "url": "https://github.com/oracle/helidon/pull/2133", "merged": true, "mergeCommit": {"oid": "7a9a2ae9cd6fd43cdba2c38806b3772286d462e3"}, "closed": true, "closedAt": "2020-07-09T14:26:45Z", "author": {"login": "spericas"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcwpkgpAH2gAyNDQ0NzkxNDkzOjE4M2MzMDUxZjlhNmQ2Nzc1ZTJlNTA3ZWE1NDY3MzQyNTUzYmYxNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczAZLJgFqTQ0NTEwMTgzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "183c3051f9a6d6775e2e507ea5467342553bf159", "author": {"user": {"login": "spericas", "name": "Santiago Pericasgeertsen"}}, "url": "https://github.com/oracle/helidon/commit/183c3051f9a6d6775e2e507ea5467342553bf159", "committedDate": "2020-07-01T12:40:26Z", "message": "Enhanced implementation of MultiFromOutputStream to buffer bytes when written one at a time to avoid publishing single-byte data chunks. The logic remains the same for byte array writes. Some new tests.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "698b69d726f8203fb032eb074e704c70828bada3", "author": {"user": {"login": "spericas", "name": "Santiago Pericasgeertsen"}}, "url": "https://github.com/oracle/helidon/commit/698b69d726f8203fb032eb074e704c70828bada3", "committedDate": "2020-07-06T13:25:20Z", "message": "Merge branch 'master' into streaming-writes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33dcac3f383034b129f9b9e96ed4f0318ec08e0b", "author": {"user": {"login": "spericas", "name": "Santiago Pericasgeertsen"}}, "url": "https://github.com/oracle/helidon/commit/33dcac3f383034b129f9b9e96ed4f0318ec08e0b", "committedDate": "2020-07-06T13:49:42Z", "message": "Improved comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDc2ODcx", "url": "https://github.com/oracle/helidon/pull/2133#pullrequestreview-444476871", "createdAt": "2020-07-08T07:25:04Z", "commit": {"oid": "33dcac3f383034b129f9b9e96ed4f0318ec08e0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzoyNTowNFrOGubX6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzoyNTowNFrOGubX6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTMzNjE2OA==", "bodyText": "publisher.write(0);         // first\nsubscriber.assertEmpty();\npublisher.flush();             // second\nsubscriber.assertItemCount(2);", "url": "https://github.com/oracle/helidon/pull/2133#discussion_r451336168", "createdAt": "2020-07-08T07:25:04Z", "author": {"login": "danielkec"}, "path": "common/reactive/src/test/java/io/helidon/common/reactive/MultiFromOutputStreamTest.java", "diffHunk": "@@ -167,6 +167,37 @@ public void onNext(ByteBuffer item) {\n         publisher.close();\n     }\n \n+    @Test\n+    void testByteAtTimeBuffer() throws IOException {\n+        MultiFromOutputStream publisher = IoMulti.createOutputStream();\n+        TestSubscriber<ByteBuffer> subscriber = new TestSubscriber<>();\n+        publisher.subscribe(subscriber);\n+        subscriber.requestMax();\n+        publisher.write(0);\n+        publisher.write(0);\n+        publisher.write(0);         // first\n+        publisher.flush();             // second\n+        long size = subscriber.getItems().stream().count();\n+        assertThat(size, is(equalTo(2L)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33dcac3f383034b129f9b9e96ed4f0318ec08e0b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NDk0MDQ0", "url": "https://github.com/oracle/helidon/pull/2133#pullrequestreview-444494044", "createdAt": "2020-07-08T07:49:59Z", "commit": {"oid": "33dcac3f383034b129f9b9e96ed4f0318ec08e0b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzo0OTo1OVrOGucNQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzo0OTo1OVrOGucNQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM0OTgyNw==", "bodyText": "subscriber.requestMax();\n        publisher.write(0);                  // first\n        subscriber.assertEmpty();\n        publisher.write(new byte[] { 0 });   // second\n        subscriber.assertItemCount(2);\n        publisher.write(0);\n        publisher.write(0);                  // third\n        subscriber.assertItemCount(2);\n        publisher.write(new byte[] { 0 });   // fourth\n        subscriber.assertItemCount(4);\n        publisher.write(0);                  // fifth\n        subscriber.assertItemCount(4);\n        publisher.close();\n        subscriber.assertItemCount(5).assertComplete();", "url": "https://github.com/oracle/helidon/pull/2133#discussion_r451349827", "createdAt": "2020-07-08T07:49:59Z", "author": {"login": "danielkec"}, "path": "common/reactive/src/test/java/io/helidon/common/reactive/MultiFromOutputStreamTest.java", "diffHunk": "@@ -167,6 +167,37 @@ public void onNext(ByteBuffer item) {\n         publisher.close();\n     }\n \n+    @Test\n+    void testByteAtTimeBuffer() throws IOException {\n+        MultiFromOutputStream publisher = IoMulti.createOutputStream();\n+        TestSubscriber<ByteBuffer> subscriber = new TestSubscriber<>();\n+        publisher.subscribe(subscriber);\n+        subscriber.requestMax();\n+        publisher.write(0);\n+        publisher.write(0);\n+        publisher.write(0);         // first\n+        publisher.flush();             // second\n+        long size = subscriber.getItems().stream().count();\n+        assertThat(size, is(equalTo(2L)));\n+    }\n+\n+    @Test\n+    void testByteAtTimeBufferArray() throws IOException {\n+        MultiFromOutputStream publisher = IoMulti.createOutputStream();\n+        TestSubscriber<ByteBuffer> subscriber = new TestSubscriber<>();\n+        publisher.subscribe(subscriber);\n+        subscriber.requestMax();\n+        publisher.write(0);                // first\n+        publisher.write(new byte[] { 0 });    // second\n+        publisher.write(0);\n+        publisher.write(0);                // third\n+        publisher.write(new byte[] { 0 });    // fourth\n+        publisher.write(0);                // fifth\n+        publisher.close();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33dcac3f383034b129f9b9e96ed4f0318ec08e0b"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ac63f781cd777d8f5f7580d3db15617e45ce72", "author": {"user": {"login": "spericas", "name": "Santiago Pericasgeertsen"}}, "url": "https://github.com/oracle/helidon/commit/15ac63f781cd777d8f5f7580d3db15617e45ce72", "committedDate": "2020-07-08T19:29:31Z", "message": "Improvements to unit tests.\n\nSigned-off-by: Santiago Pericasgeertsen <santiago.pericasgeertsen@oracle.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MTAxODM2", "url": "https://github.com/oracle/helidon/pull/2133#pullrequestreview-445101836", "createdAt": "2020-07-08T20:23:43Z", "commit": {"oid": "15ac63f781cd777d8f5f7580d3db15617e45ce72"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 503, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}