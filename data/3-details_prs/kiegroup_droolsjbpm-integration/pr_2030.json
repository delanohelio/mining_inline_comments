{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNzQwMzk4", "number": 2030, "title": "Fix Springboot Swagger tests", "bodyText": "Depends on droolsjbpm-build-bootstrap#1199\nAfter enabling Swagger capability for integration testing of kie server at Springboot, some modifications are needed:\n\n\nSwagger UI is exposed in a different endpoint:\n[context]/api-docs?url=[context]/swagger.json\nso it's needed to make the test compatible for both endpoints\n\n\nSwagger cxf libraries have to be added to the kie-server-spring-boot-integ-tests-sample project  as well as the Swagger UI.\n\n\nNotice that due to a bug at swagger-jaxrs in latest versions (No message body writer has been found, when retrieving json files), this dependency must to be downgraded to 1.5.15, as current documentation recommends. This has also been modified at kie-server-spring-boot-sample module.\n\n\nWebSecurityConfig for kie-server-spring-boot-integ-tests-sample project has to permit all Swagger elements without authentication\n\n\nAdded swagger.properties containing the same title that it's expected in the tests", "createdAt": "2020-02-27T09:52:17Z", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030", "merged": true, "mergeCommit": {"oid": "8377c8b4a24953d04db6424589ebe67880ecb0ac"}, "closed": true, "closedAt": "2020-03-06T09:43:59Z", "author": {"login": "gmunozfe"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIdD_egFqTM2NTc1OTE0MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK86GCgFqTM3MDE5NDMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzU5MTQx", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#pullrequestreview-365759141", "createdAt": "2020-02-27T15:29:02Z", "commit": {"oid": "93e6705d7df82863f8a5b6dcab0ee5decdaef7d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToyOTowNVrOFvV50Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNToyOTowNVrOFvV50Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4NjI1Nw==", "bodyText": "Have you consider using some dependency which is declared in kie-parent, like https://github.com/kiegroup/droolsjbpm-build-bootstrap/blob/master/pom.xml#L2386-L2390 ?\nIf specifically this dependency needs to be used, can you please define it in kie-parent?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385186257", "createdAt": "2020-02-27T15:29:05Z", "author": {"login": "sutaakar"}, "path": "kie-spring-boot/kie-spring-boot-samples/kie-server-spring-boot-integ-tests-sample/pom.xml", "diffHunk": "@@ -15,6 +15,27 @@\n     <start-class>org.kie.server.springboot.samples.KieServerIntegrationTestsApplication</start-class>\n   </properties>\n \n+  <dependencyManagement>\n+    <dependencies>      \n+      <dependency>\n+        <groupId>org.webjars</groupId>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e6705d7df82863f8a5b6dcab0ee5decdaef7d1"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NzYxMzAw", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#pullrequestreview-365761300", "createdAt": "2020-02-27T15:31:30Z", "commit": {"oid": "93e6705d7df82863f8a5b6dcab0ee5decdaef7d1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNTozMTozMFrOFvWAZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxNTozMTozMFrOFvWAZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTE4Nzk0MQ==", "bodyText": "Can you please move the version declaration to one location which can be inherited here and in kie-server-spring-boot-sample? So there will be a single source of the version declaration.", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385187941", "createdAt": "2020-02-27T15:31:30Z", "author": {"login": "sutaakar"}, "path": "kie-spring-boot/kie-spring-boot-samples/kie-server-spring-boot-integ-tests-sample/pom.xml", "diffHunk": "@@ -15,6 +15,27 @@\n     <start-class>org.kie.server.springboot.samples.KieServerIntegrationTestsApplication</start-class>\n   </properties>\n \n+  <dependencyManagement>\n+    <dependencies>      \n+      <dependency>\n+        <groupId>org.webjars</groupId>\n+        <artifactId>swagger-ui</artifactId>\n+        <version>2.2.10</version>\n+      </dependency>\n+      <dependency>\n+        <groupId>org.apache.cxf</groupId>\n+        <artifactId>cxf-rt-rs-service-description-swagger</artifactId>\n+        <version>${version.org.apache.cxf}</version>\n+      </dependency>\n+      <!-- Notice that higher versions like 1.5.20 contain a bug (No message body writer has been found) so downgraded to 1.5.15 -->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "93e6705d7df82863f8a5b6dcab0ee5decdaef7d1"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "93e6705d7df82863f8a5b6dcab0ee5decdaef7d1", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/93e6705d7df82863f8a5b6dcab0ee5decdaef7d1", "committedDate": "2020-02-27T07:32:34Z", "message": "Fix Springboot Swagger tests"}, "afterCommit": {"oid": "1e42819a63b01b723e7f58428c6ed64700915a85", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/1e42819a63b01b723e7f58428c6ed64700915a85", "committedDate": "2020-02-27T17:05:27Z", "message": "Fix Springboot Swagger tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e42819a63b01b723e7f58428c6ed64700915a85", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/1e42819a63b01b723e7f58428c6ed64700915a85", "committedDate": "2020-02-27T17:05:27Z", "message": "Fix Springboot Swagger tests"}, "afterCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959", "committedDate": "2020-02-27T23:32:31Z", "message": "Fix Springboot Swagger tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2MzU2NDc0", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#pullrequestreview-366356474", "createdAt": "2020-02-28T12:16:28Z", "commit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMjoxNjoyOVrOFvzEwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMjoyNzowOVrOFvzUvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2NDE5Mg==", "bodyText": "Can you please remove this line from assertResponse and place it for example directly to test methods?\nIt is a side effect and is unrelated to meaning of assertResponse method - according to its name I would expect it just to check response, not setting some method variable.", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385664192", "createdAt": "2020-02-28T12:16:29Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-all/src/test/java/org/kie/server/integrationtests/swagger/SwaggerIntegrationTest.java", "diffHunk": "@@ -53,39 +57,49 @@ public static void closeHttpClient() {\n \n     @Test\n     public void testSwaggerDocs() throws Exception {\n-        String html = invokeGet(getContextRoot()+\"docs/\");\n+        Response response = invokeGet(getContextRoot(3)+\"docs/\");\n         \n-        assertThat(Jsoup.parse(html).title()).isEqualTo(\"Execution Server Documentation\");\n+        if (response.getStatus()!=200) {\n+            //Springboot Swagger Docs is located in other URL\n+            response = invokeGet(getContextRoot(1)+\"api-docs?url=\"+getContextRoot(1)+\"swagger.json\");\n+        }\n+\n+        assertResponse(response);\n+        assertThat(Jsoup.parse(responseStr).title()).isIn(\"Execution Server Documentation\", \"Swagger UI\");\n     }\n \n     @Test\n     @SuppressWarnings(\"unchecked\")\n     public void testSwaggerJson() throws Exception {\n-        String responseStr = invokeGet(getContextRoot()+\"services/rest/server/swagger.json\");\n-        \n+        Response response = invokeGet(TestConfig.getKieServerHttpUrl()+\"/swagger.json\");\n+        assertResponse(response);\n+\n         ObjectMapper om = new ObjectMapper();\n         HashMap<String, Object> hm = (HashMap<String, Object>) om.readValue(responseStr, HashMap.class);\n         assertNotNull(hm.get(\"swagger\"));\n         assertNotNull(hm.get(\"info\"));\n         assertEquals(\"KIE Server\", ((HashMap<String, Object>) hm.get(\"info\")).get(\"title\"));\n      }\n \n-    protected String getContextRoot() {\n-        //Navigate to parent path 3 times to get context root\n+    protected String getContextRoot(int foldersUp) {\n+        //Navigate to parent path N folders up to get context root\n         String url = TestConfig.getKieServerHttpUrl();\n         int pos = url.length();\n-        for (int i = 0; i < 3; i++) {\n+        for (int i = 0; i < foldersUp; i++) {\n             pos = url.lastIndexOf('/', pos - 1);\n         }\n         return url.substring(0, pos + 1);\n     }\n \n-    protected String invokeGet(String docsUri) {\n+    protected Response invokeGet(String docsUri) {\n+        logger.info(\"[GET] \" + docsUri);\n         WebTarget clientRequest = httpClient.target(docsUri);\n-        Response response = clientRequest.request().get();\n+        return clientRequest.request().get();\n+    }\n \n+    private void assertResponse(Response response) {\n         assertEquals(200, response.getStatus());\n         assertNotNull(response.getEntity());\n-        return response.readEntity(String.class);\n+        responseStr = response.readEntity(String.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2ODAwNg==", "bodyText": "Can you please close the response in the end of test?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385668006", "createdAt": "2020-02-28T12:26:25Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-all/src/test/java/org/kie/server/integrationtests/swagger/SwaggerIntegrationTest.java", "diffHunk": "@@ -53,39 +57,49 @@ public static void closeHttpClient() {\n \n     @Test\n     public void testSwaggerDocs() throws Exception {\n-        String html = invokeGet(getContextRoot()+\"docs/\");\n+        Response response = invokeGet(getContextRoot(3)+\"docs/\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2ODEwNw==", "bodyText": "Same as above.", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385668107", "createdAt": "2020-02-28T12:26:39Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-all/src/test/java/org/kie/server/integrationtests/swagger/SwaggerIntegrationTest.java", "diffHunk": "@@ -53,39 +57,49 @@ public static void closeHttpClient() {\n \n     @Test\n     public void testSwaggerDocs() throws Exception {\n-        String html = invokeGet(getContextRoot()+\"docs/\");\n+        Response response = invokeGet(getContextRoot(3)+\"docs/\");\n         \n-        assertThat(Jsoup.parse(html).title()).isEqualTo(\"Execution Server Documentation\");\n+        if (response.getStatus()!=200) {\n+            //Springboot Swagger Docs is located in other URL\n+            response = invokeGet(getContextRoot(1)+\"api-docs?url=\"+getContextRoot(1)+\"swagger.json\");\n+        }\n+\n+        assertResponse(response);\n+        assertThat(Jsoup.parse(responseStr).title()).isIn(\"Execution Server Documentation\", \"Swagger UI\");\n     }\n \n     @Test\n     @SuppressWarnings(\"unchecked\")\n     public void testSwaggerJson() throws Exception {\n-        String responseStr = invokeGet(getContextRoot()+\"services/rest/server/swagger.json\");\n-        \n+        Response response = invokeGet(TestConfig.getKieServerHttpUrl()+\"/swagger.json\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTY2ODI4Nw==", "bodyText": "Can you please change the log level to debug?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#discussion_r385668287", "createdAt": "2020-02-28T12:27:09Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-all/src/test/java/org/kie/server/integrationtests/swagger/SwaggerIntegrationTest.java", "diffHunk": "@@ -53,39 +57,49 @@ public static void closeHttpClient() {\n \n     @Test\n     public void testSwaggerDocs() throws Exception {\n-        String html = invokeGet(getContextRoot()+\"docs/\");\n+        Response response = invokeGet(getContextRoot(3)+\"docs/\");\n         \n-        assertThat(Jsoup.parse(html).title()).isEqualTo(\"Execution Server Documentation\");\n+        if (response.getStatus()!=200) {\n+            //Springboot Swagger Docs is located in other URL\n+            response = invokeGet(getContextRoot(1)+\"api-docs?url=\"+getContextRoot(1)+\"swagger.json\");\n+        }\n+\n+        assertResponse(response);\n+        assertThat(Jsoup.parse(responseStr).title()).isIn(\"Execution Server Documentation\", \"Swagger UI\");\n     }\n \n     @Test\n     @SuppressWarnings(\"unchecked\")\n     public void testSwaggerJson() throws Exception {\n-        String responseStr = invokeGet(getContextRoot()+\"services/rest/server/swagger.json\");\n-        \n+        Response response = invokeGet(TestConfig.getKieServerHttpUrl()+\"/swagger.json\");\n+        assertResponse(response);\n+\n         ObjectMapper om = new ObjectMapper();\n         HashMap<String, Object> hm = (HashMap<String, Object>) om.readValue(responseStr, HashMap.class);\n         assertNotNull(hm.get(\"swagger\"));\n         assertNotNull(hm.get(\"info\"));\n         assertEquals(\"KIE Server\", ((HashMap<String, Object>) hm.get(\"info\")).get(\"title\"));\n      }\n \n-    protected String getContextRoot() {\n-        //Navigate to parent path 3 times to get context root\n+    protected String getContextRoot(int foldersUp) {\n+        //Navigate to parent path N folders up to get context root\n         String url = TestConfig.getKieServerHttpUrl();\n         int pos = url.length();\n-        for (int i = 0; i < 3; i++) {\n+        for (int i = 0; i < foldersUp; i++) {\n             pos = url.lastIndexOf('/', pos - 1);\n         }\n         return url.substring(0, pos + 1);\n     }\n \n-    protected String invokeGet(String docsUri) {\n+    protected Response invokeGet(String docsUri) {\n+        logger.info(\"[GET] \" + docsUri);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a6940ac5dd64886339a5492c538b017d1f6cb41", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/8a6940ac5dd64886339a5492c538b017d1f6cb41", "committedDate": "2020-03-04T08:02:03Z", "message": "Fix Springboot Swagger tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/bf5d9c2d298a85ae51aca5c4fb2618ca4e3e7959", "committedDate": "2020-02-27T23:32:31Z", "message": "Fix Springboot Swagger tests"}, "afterCommit": {"oid": "8a6940ac5dd64886339a5492c538b017d1f6cb41", "author": {"user": {"login": "gmunozfe", "name": "Gonzalo Mu\u00f1oz"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/8a6940ac5dd64886339a5492c538b017d1f6cb41", "committedDate": "2020-03-04T08:02:03Z", "message": "Fix Springboot Swagger tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4NTgwMjM4", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#pullrequestreview-368580238", "createdAt": "2020-03-04T08:27:13Z", "commit": {"oid": "8a6940ac5dd64886339a5492c538b017d1f6cb41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTk0MzI1", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2030#pullrequestreview-370194325", "createdAt": "2020-03-06T09:43:05Z", "commit": {"oid": "8a6940ac5dd64886339a5492c538b017d1f6cb41"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1359, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}