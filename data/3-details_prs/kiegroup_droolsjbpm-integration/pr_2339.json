{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1ODA2MTk2", "number": 2339, "title": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension", "bodyText": "Using new addProcessListener API to register the processEventListener\nJIRA:\nJBPM-9504\nreferenced Pull Requests:\nkiegroup/droolsjbpm-knowledge#489\nkiegroup/jbpm#1818", "createdAt": "2020-12-10T09:54:15Z", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339", "merged": true, "mergeCommit": {"oid": "c79fd70b36695dff6765bf7bba6bf8ad9162f883"}, "closed": true, "closedAt": "2020-12-15T10:37:50Z", "author": {"login": "fjtirado"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkwUlRABqjQwOTQyMDE0ODI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdlItX5ABqjQxMDA1OTM2Njc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e52f08a04534e2479882d1a80f047f7a1deed47f", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/e52f08a04534e2479882d1a80f047f7a1deed47f", "committedDate": "2020-12-10T09:53:10Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}, "afterCommit": {"oid": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "committedDate": "2020-12-10T09:56:16Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MDI3NTg4", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#pullrequestreview-549027588", "createdAt": "2020-12-10T09:59:08Z", "commit": {"oid": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOTo1OTowOFrOIDA6GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQwOTo1OTowOFrOIDA6GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDAzMTUxMw==", "bodyText": "just set this as debug. We don't really care about this.", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540031513", "createdAt": "2020-12-10T09:59:08Z", "author": {"login": "elguardian"}, "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java", "diffHunk": "@@ -248,8 +248,13 @@ public void onDeploy(DeploymentEvent event) {\n \n     @Override\n     public void onUnDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .removeEventListener(this);\n+        try {\n+            event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n+                    .removeEventListener(this);\n+        } catch (Exception ex) {\n+            // it is very likely that Runtime Manager is already closed at this stage\n+            logger.info(\"ProcessEventListener cannot be removed. {}\", ex.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4"}, "originalPosition": 11}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/f6cc81aeb6358f8109386ab59cede93cf76ba9c4", "committedDate": "2020-12-10T09:56:16Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}, "afterCommit": {"oid": "342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "committedDate": "2020-12-10T10:00:45Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/342d62d6ca439c1f0c0cf828d7ef5ed4cb0cc747", "committedDate": "2020-12-10T10:00:45Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}, "afterCommit": {"oid": "c72f4f0b18e07f86a2751423d8be0e4b492859db", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/c72f4f0b18e07f86a2751423d8be0e4b492859db", "committedDate": "2020-12-10T11:59:16Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c72f4f0b18e07f86a2751423d8be0e4b492859db", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/c72f4f0b18e07f86a2751423d8be0e4b492859db", "committedDate": "2020-12-10T11:59:16Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}, "afterCommit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/a4387dddb0986c1078ec751898900f63fa092528", "committedDate": "2020-12-10T12:07:45Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTM2MzMw", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#pullrequestreview-549936330", "createdAt": "2020-12-11T09:34:03Z", "commit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5OTc2OTEz", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#pullrequestreview-549976913", "createdAt": "2020-12-11T10:28:41Z", "commit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMDoyODo0MVrOIDypGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQxMDozNzo1OFrOIDy_aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg0NjM2Mg==", "bodyText": "Just curious - if we are now not removing the listeners, shouldn't we try to avoid adding listener twice in case of a new onDeploy event?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540846362", "createdAt": "2020-12-11T10:28:41Z", "author": {"login": "afalhambra"}, "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/main/java/org/kie/server/services/jbpm/kafka/KafkaServerExtension.java", "diffHunk": "@@ -241,15 +242,13 @@ public void destroy(KieServerImpl kieServer, KieServerRegistry registry) {\n \n     @Override\n     public void onDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .addEventListener(this);\n+        ((InternalRegisterableItemsFactory) ((InternalRuntimeManager) event.getDeployedUnit().getRuntimeManager())\n+                .getEnvironment().getRegisterableItemsFactory()).addProcessListener(this);\n         updateRegistration(event, this::updateTopics);\n     }\n \n     @Override\n     public void onUnDeploy(DeploymentEvent event) {\n-        event.getDeployedUnit().getRuntimeManager().getRuntimeEngine(ProcessInstanceIdContext.get()).getKieSession()\n-                .removeEventListener(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDg1MjA3Mg==", "bodyText": "you can just use only forEach, but no need to change anything here\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    itemsFactory.getProcessEventListeners(runtimeEngine).stream().forEach(l -> l.onMessage(new MessageEventImpl(\n          \n          \n            \n                    itemsFactory.getProcessEventListeners(runtimeEngine).forEach(l -> l.onMessage(new MessageEventImpl(", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#discussion_r540852072", "createdAt": "2020-12-11T10:37:58Z", "author": {"login": "afalhambra"}, "path": "kie-server-parent/kie-server-services/kie-server-services-kafka/src/test/java/org/kie/server/services/jbpm/kafka/KafkaServerExtensionProducerTest.java", "diffHunk": "@@ -129,7 +131,9 @@ public void close() {\n     @Test \n     public void testMessageSent() throws IOException, ParseException {\n         extension.onDeploy(new DeploymentEvent(\"MyDeploy1\", deployedUnit));\n-        extension.onMessage(new MessageEventImpl(pInstance, runtime, nInstance, \"MyMessage\", \"Javierito\"));\n+        itemsFactory.getProcessEventListeners(runtimeEngine).stream().forEach(l -> l.onMessage(new MessageEventImpl(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528"}, "originalPosition": 68}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUwMTM2Mjk5", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2339#pullrequestreview-550136299", "createdAt": "2020-12-11T14:18:53Z", "commit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "committedDate": "2020-12-11T14:19:43Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4387dddb0986c1078ec751898900f63fa092528", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/a4387dddb0986c1078ec751898900f63fa092528", "committedDate": "2020-12-10T12:07:45Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}, "afterCommit": {"oid": "cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "author": {"user": {"login": "fjtirado", "name": "Francisco Javier Tirado Sarti"}}, "url": "https://github.com/kiegroup/droolsjbpm-integration/commit/cc2cec1f7221f25efbc6ee0d0ddaef5a806be118", "committedDate": "2020-12-11T14:19:43Z", "message": "[JBPM-9504] Exception on unDeploy at KafkaServerExtension\n\nExisting code did not contemplate the possibility that the removal\nof the process listener might fail when runtimeengine has been already\nclosed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1137, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}