{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NzE3NDE3", "number": 2019, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxOTo0MzozNFrODg1CIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxOTo0NDoxNVrODg1DEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzQ5OTIyOnYy", "diffSide": "RIGHT", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxOTo0MzozNFrOFrP8Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNzo1MDozOFrOFrd86g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw==", "bodyText": "I usually have problem with embedded maven not showing error messages.\nCan this --quiet worsen the situation?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r380894263", "createdAt": "2020-02-18T19:43:34Z", "author": {"login": "lucamolteni"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -61,24 +62,19 @@ public static void buildAndDeployMavenProjectFromResource(String resourcePath) {\n     }\n \n     public static void buildAndDeployMavenProject(String basedir) {\n-        // need to backup (and later restore) the current class loader, because the Maven/Plexus does some classloader\n-        // magic which then results in CNFE in RestEasy client\n         // run the Maven build which will create the kjar. The kjar is then either installed or deployed to local and\n         // remote repo\n         logger.debug(\"Building and deploying Maven project from basedir '{}'.\", basedir);\n-        ClassLoader classLoaderBak = Thread.currentThread().getContextClassLoader();\n-        System.setProperty(\"maven.multiModuleProjectDirectory\", basedir); // required by MavenCli 3.3.0+\n-        MavenCli cli = new MavenCli();\n         List<String> mvnArgs;\n         if (TestConfig.isLocalServer()) {\n             // just install into local repository when running the local server. Deploying to remote repo will fail\n             // if the repo does not exist.\n \n             // wrapping explicitly in ArrayList as we may need to update the list later (and Arrays.toList() returns\n             // just read-only list)\n-            mvnArgs = new ArrayList<String>(Arrays.asList(\"-B\", \"clean\", \"install\"));\n+            mvnArgs = new ArrayList<>(Arrays.asList(\"mvn\", \"--quiet\", \"clean\", \"install\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTExNDg3MA==", "bodyText": "The errors should be still shown. From the maven help:\n-q,--quiet                             Quiet output - only show errors\nI have tried that manually, the error is shown if any error happens.", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381114870", "createdAt": "2020-02-19T07:25:18Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -61,24 +62,19 @@ public static void buildAndDeployMavenProjectFromResource(String resourcePath) {\n     }\n \n     public static void buildAndDeployMavenProject(String basedir) {\n-        // need to backup (and later restore) the current class loader, because the Maven/Plexus does some classloader\n-        // magic which then results in CNFE in RestEasy client\n         // run the Maven build which will create the kjar. The kjar is then either installed or deployed to local and\n         // remote repo\n         logger.debug(\"Building and deploying Maven project from basedir '{}'.\", basedir);\n-        ClassLoader classLoaderBak = Thread.currentThread().getContextClassLoader();\n-        System.setProperty(\"maven.multiModuleProjectDirectory\", basedir); // required by MavenCli 3.3.0+\n-        MavenCli cli = new MavenCli();\n         List<String> mvnArgs;\n         if (TestConfig.isLocalServer()) {\n             // just install into local repository when running the local server. Deploying to remote repo will fail\n             // if the repo does not exist.\n \n             // wrapping explicitly in ArrayList as we may need to update the list later (and Arrays.toList() returns\n             // just read-only list)\n-            mvnArgs = new ArrayList<String>(Arrays.asList(\"-B\", \"clean\", \"install\"));\n+            mvnArgs = new ArrayList<>(Arrays.asList(\"mvn\", \"--quiet\", \"clean\", \"install\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw=="}, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMzgxOA==", "bodyText": "Ok perfect", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381123818", "createdAt": "2020-02-19T07:50:38Z", "author": {"login": "lucamolteni"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -61,24 +62,19 @@ public static void buildAndDeployMavenProjectFromResource(String resourcePath) {\n     }\n \n     public static void buildAndDeployMavenProject(String basedir) {\n-        // need to backup (and later restore) the current class loader, because the Maven/Plexus does some classloader\n-        // magic which then results in CNFE in RestEasy client\n         // run the Maven build which will create the kjar. The kjar is then either installed or deployed to local and\n         // remote repo\n         logger.debug(\"Building and deploying Maven project from basedir '{}'.\", basedir);\n-        ClassLoader classLoaderBak = Thread.currentThread().getContextClassLoader();\n-        System.setProperty(\"maven.multiModuleProjectDirectory\", basedir); // required by MavenCli 3.3.0+\n-        MavenCli cli = new MavenCli();\n         List<String> mvnArgs;\n         if (TestConfig.isLocalServer()) {\n             // just install into local repository when running the local server. Deploying to remote repo will fail\n             // if the repo does not exist.\n \n             // wrapping explicitly in ArrayList as we may need to update the list later (and Arrays.toList() returns\n             // just read-only list)\n-            mvnArgs = new ArrayList<String>(Arrays.asList(\"-B\", \"clean\", \"install\"));\n+            mvnArgs = new ArrayList<>(Arrays.asList(\"mvn\", \"--quiet\", \"clean\", \"install\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDI2Mw=="}, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM1NzUwMTYwOnYy", "diffSide": "RIGHT", "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxOTo0NDoxNVrOFrP9pQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQwNzo1MDoyOFrOFrd8tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ==", "bodyText": "We need some better error messages here. This one is too generic and when it occured to me I had to debug to discover the real cause", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r380894629", "createdAt": "2020-02-18T19:44:15Z", "author": {"login": "lucamolteni"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -87,13 +83,15 @@ public static void buildAndDeployMavenProject(String basedir) {\n             mvnArgs.add(\"-s\");\n             mvnArgs.add(kjarsBuildSettingsXml);\n         }\n-        int mvnRunResult = cli.doMain(mvnArgs.toArray(new String[mvnArgs.size()]), basedir, System.out, System.err);\n \n-        Thread.currentThread().setContextClassLoader(classLoaderBak);\n+        // Execute the Maven build using installed Maven binary\n+        try (ProcessExecutor executor = new ProcessExecutor()) {\n+            String command = mvnArgs.stream().collect(Collectors.joining(\" \"));\n+            boolean executionSuccessful = executor.executeProcessCommand(command, Paths.get(basedir));\n \n-        if (mvnRunResult != 0) {\n-            throw new RuntimeException(\"Error while building Maven project from basedir \" + basedir +\n-                    \". Return code=\" + mvnRunResult);\n+            if (!executionSuccessful) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTExNzAwNA==", "bodyText": "Ideally the real issue should be visible from the invoked process log - any error should be shown there.\nHere in the code we can get just process exit value, that won't tell us much.\nIf it is not enough I can adjust the code to print complete process log (not just error) in case maven build fails. What do you think about it?", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381117004", "createdAt": "2020-02-19T07:31:34Z", "author": {"login": "sutaakar"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -87,13 +83,15 @@ public static void buildAndDeployMavenProject(String basedir) {\n             mvnArgs.add(\"-s\");\n             mvnArgs.add(kjarsBuildSettingsXml);\n         }\n-        int mvnRunResult = cli.doMain(mvnArgs.toArray(new String[mvnArgs.size()]), basedir, System.out, System.err);\n \n-        Thread.currentThread().setContextClassLoader(classLoaderBak);\n+        // Execute the Maven build using installed Maven binary\n+        try (ProcessExecutor executor = new ProcessExecutor()) {\n+            String command = mvnArgs.stream().collect(Collectors.joining(\" \"));\n+            boolean executionSuccessful = executor.executeProcessCommand(command, Paths.get(basedir));\n \n-        if (mvnRunResult != 0) {\n-            throw new RuntimeException(\"Error while building Maven project from basedir \" + basedir +\n-                    \". Return code=\" + mvnRunResult);\n+            if (!executionSuccessful) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ=="}, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTEyMzc2NA==", "bodyText": "If the errors are shown before it's fine, we don't need to print the log again. Thanks", "url": "https://github.com/kiegroup/droolsjbpm-integration/pull/2019#discussion_r381123764", "createdAt": "2020-02-19T07:50:28Z", "author": {"login": "lucamolteni"}, "path": "kie-server-parent/kie-server-tests/kie-server-integ-tests-common/src/main/java/org/kie/server/integrationtests/shared/KieServerDeployer.java", "diffHunk": "@@ -87,13 +83,15 @@ public static void buildAndDeployMavenProject(String basedir) {\n             mvnArgs.add(\"-s\");\n             mvnArgs.add(kjarsBuildSettingsXml);\n         }\n-        int mvnRunResult = cli.doMain(mvnArgs.toArray(new String[mvnArgs.size()]), basedir, System.out, System.err);\n \n-        Thread.currentThread().setContextClassLoader(classLoaderBak);\n+        // Execute the Maven build using installed Maven binary\n+        try (ProcessExecutor executor = new ProcessExecutor()) {\n+            String command = mvnArgs.stream().collect(Collectors.joining(\" \"));\n+            boolean executionSuccessful = executor.executeProcessCommand(command, Paths.get(basedir));\n \n-        if (mvnRunResult != 0) {\n-            throw new RuntimeException(\"Error while building Maven project from basedir \" + basedir +\n-                    \". Return code=\" + mvnRunResult);\n+            if (!executionSuccessful) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDg5NDYyOQ=="}, "originalCommit": {"oid": "a896828bc15f6f45045a4f629ad5ee211dccf01f"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2090, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}