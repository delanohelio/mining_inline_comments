{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NTg2ODY4", "number": 2317, "title": "Check unpack200 and warn the user on JDK14+", "bodyText": "Yesterday I was helping a relative to install NetBeans. He was mostly interested in Python support. However when we downloaded the ZIP and installed the support without errors, code in editor was still without syntax highlighting. I'd already seen such situation, so I soon realized why. Python support cannot be installed on JDK14 due to missing unpack200.\nHowever the problem isn't easy to find and we shall not let poor NetBeans users to face such silent errors. Here is my PR that detects presence of .pack.gz files in an NBM and fails its validation.\nThe second part of the PR shall add a UI to allow one to select unpack200 from another JDK.", "createdAt": "2020-08-17T05:22:21Z", "url": "https://github.com/apache/netbeans/pull/2317", "merged": true, "mergeCommit": {"oid": "436ca486890d62e6020f45f0ed52c25193132ac0"}, "closed": true, "closedAt": "2020-09-09T14:08:20Z", "author": {"login": "jtulach"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBS6ZRAH2gAyNDY4NTg2ODY4OmY2ZjI0NTVkNDllODEzZDE4NjMxOGRkZjNhZmU2Zjk1NTdjOWViNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHDSG-AH2gAyNDY4NTg2ODY4OjgwYTZkNzFhZGQ4ZmRhZGZiYWQwMjE3OTExNzA5NWNiNzVjMDUyMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6f2455d49e813d186318ddf3afe6f9557c9eb61", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/f6f2455d49e813d186318ddf3afe6f9557c9eb61", "committedDate": "2020-08-22T05:53:14Z", "message": "Warn the user early if an NBM file requires unpack200 and it is not present"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a9dcf44725087c9f03b6413f27d8b3f63e74c101", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/a9dcf44725087c9f03b6413f27d8b3f63e74c101", "committedDate": "2020-08-17T05:15:33Z", "message": "Warn the user early if an NBM file requires pack200 and it is not present"}, "afterCommit": {"oid": "f6f2455d49e813d186318ddf3afe6f9557c9eb61", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/f6f2455d49e813d186318ddf3afe6f9557c9eb61", "committedDate": "2020-08-22T05:53:14Z", "message": "Warn the user early if an NBM file requires unpack200 and it is not present"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d104e7fd38884b02ef5a9b2acb4bbbe02898d68b", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/d104e7fd38884b02ef5a9b2acb4bbbe02898d68b", "committedDate": "2020-08-22T07:28:00Z", "message": "Show file chooser and allow selection of unpack200"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "473d4616db51d5439d5192fc385b735414582477", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/473d4616db51d5439d5192fc385b735414582477", "committedDate": "2020-08-23T06:02:45Z", "message": "Search for unpack200 in sibling JDKs. Repeat the validation once unpack200 is choosen. Use the value in Upgrader."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe", "committedDate": "2020-08-23T06:44:09Z", "message": "Defining the unpack200 API in autoupdate.services module"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NDUxMjMw", "url": "https://github.com/apache/netbeans/pull/2317#pullrequestreview-478451230", "createdAt": "2020-08-31T09:19:59Z", "commit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5OTc0MjM2", "url": "https://github.com/apache/netbeans/pull/2317#pullrequestreview-479974236", "createdAt": "2020-09-01T17:38:57Z", "commit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNzozODo1N1rOHLBXkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNzo1NTo1MlrOHLB91g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMxODgwMg==", "bodyText": "What is the meaning of this path?\nFor me this would be more readable:\nFile uiConfig = new File(clusterRoot, \"config/Preferences/org/netbeans/modules/autoupdate/services.properties\");", "url": "https://github.com/apache/netbeans/pull/2317#discussion_r481318802", "createdAt": "2020-09-01T17:38:57Z", "author": {"login": "matthiasblaesing"}, "path": "platform/autoupdate.services/libsrc/org/netbeans/updater/ModuleUpdater.java", "diffHunk": "@@ -579,6 +579,34 @@ private boolean unpack200(File src, File dest) {\n         return result == 0;\n     }\n \n+    private File findUnpack200Executable(String unpack200) {\n+        File unpack200Executable = new File(new File(System.getProperty(\"java.home\"), \"bin\"), unpack200);\n+        if (!unpack200Executable.canExecute()) {\n+            for (File clusterRoot : UpdateTracking.clusters(true)) {\n+                File uiConfig = new File(new File(new File(new File(new File(new File(new File(\n+                        clusterRoot, \"config\"), \"Preferences\"), \"org\"), \"netbeans\"), \"modules\"), // NOI18N\n+                        \"autoupdate\"), \"services.properties\"); // NOI18N", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyMTI1MA==", "bodyText": "Maybe at some point in the future (no I don't want to wait for that moment), we might be able to ship a pack200 implementation (if I read the discussion on apache-legal correctly pure GPLv2-CPE might ok, the problem was, that the JDK is a mix of GPLv2 and GPLv2-CPE). If we can ship an implementation, would it make sense to do the decompression in process? For tar, zip and maybe other compression formats I would not consider to call the CLI version.", "url": "https://github.com/apache/netbeans/pull/2317#discussion_r481321250", "createdAt": "2020-09-01T17:43:12Z", "author": {"login": "matthiasblaesing"}, "path": "platform/autoupdate.services/src/org/netbeans/api/autoupdate/OperationContainer.java", "diffHunk": "@@ -352,6 +353,17 @@ public void removeAll() {\n         impl.removeAll ();\n     }\n     \n+    /** Specifies location of unpack200 executable. {@code unpack200} has been\n+     * removed from JDK 14. As such it is not possible to unpack older NBM\n+     * files without providing alternative JDK implementation of this file.\n+     *\n+     * @param executable path to the executable\n+     * @since 1.65\n+     */\n+    public final void setUnpack200(File executable) {\n+        this.impl.setUnpack200(executable);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyNTUwOA==", "bodyText": "This code path will not be hit when the download happens from a trusted source (See Plugin Configuration -> Settings -> Update Center Customizer -> \"Trust update center fully and allow automatic installations\").\nThe determination whether pack200 is required could be done seperatedly from the codesigner extraction. We are not on a hotpath, so scanning the ZIP/JAR/NBM twice should be ok IMHO.", "url": "https://github.com/apache/netbeans/pull/2317#discussion_r481325508", "createdAt": "2020-09-01T17:50:27Z", "author": {"login": "matthiasblaesing"}, "path": "platform/autoupdate.services/src/org/netbeans/modules/autoupdate/services/InstallSupportImpl.java", "diffHunk": "@@ -1121,7 +1121,22 @@ private int verifyNbm (UpdateElement el, File nbmFile, ProgressHandle progress,\n \n             if(res == null) {\n                 try {\n-                    Collection<CodeSigner> nbmCerts = Utilities.getNbmCertificates(nbmFile);\n+                    List<String> pack200Entries = new ArrayList<>();\n+                    Collection<CodeSigner> nbmCerts = Utilities.getNbmCertificates(nbmFile, pack200Entries);\n+                    if (!pack200Entries.isEmpty()) {\n+                        OperationContainer<InstallSupport> operationContainer = support.getContainer();\n+                        OperationContainerImpl ocImpl = Trampoline.API.impl(operationContainer);\n+                        File unpack200 = ocImpl.getUnpack200();\n+                        if (unpack200 == null || !unpack200.canExecute()) {\n+                            StringBuilder sb = new StringBuilder();\n+                            for (String entry : pack200Entries) {\n+                                sb.append(\"\\n\").append(entry);\n+                            }\n+                            throw new OperationException(OperationException.ERROR_TYPE.MISSING_UNPACK200,\n+                                NbBundle.getMessage(InstallSupportImpl.class, \"InstallSupportImpl_Validate_MissingUnpack200\", nbmFile, sb.toString()) // NOI18N\n+                            );\n+                        }\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyODAzMA==", "bodyText": "This looks strange to me. I have never seen a break without a loop (is this java style goto)? Can java.home even be unset? I admit I don't know what jlink and/or graal static image returns here.", "url": "https://github.com/apache/netbeans/pull/2317#discussion_r481328030", "createdAt": "2020-09-01T17:54:53Z", "author": {"login": "matthiasblaesing"}, "path": "platform/autoupdate.services/src/org/netbeans/modules/autoupdate/services/OperationContainerImpl.java", "diffHunk": "@@ -530,4 +532,33 @@ public OperationType getType () {\n     }\n     private OperationType type;\n     private OperationContainer delegate;\n+\n+    /**\n+     * @return the unpack200 executable or {@code null}\n+     */\n+    public final File getUnpack200() {\n+        NO_PACK: if (unpack200 == null) {\n+            final String jreHome = System.getProperty(\"java.home\"); // NOI18N\n+            if (jreHome == null) {\n+                break NO_PACK;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTMyODU5OA==", "bodyText": "I wrote it above. I'm not sure whether this mix of return (return via return statement and return via method parameter) is worth the saved file scanning.", "url": "https://github.com/apache/netbeans/pull/2317#discussion_r481328598", "createdAt": "2020-09-01T17:55:52Z", "author": {"login": "matthiasblaesing"}, "path": "platform/autoupdate.services/src/org/netbeans/modules/autoupdate/services/Utilities.java", "diffHunk": "@@ -289,13 +289,15 @@ private static int mapVerificationResultToInt(String input) {\n      * Get the certpaths that were used to sign the NBM content.\n      *\n      * @param nbmFile\n+     * @param pack200Entries list of strings to add any entries in the NBM file\n+     *   that end with {@code .pack.gz} extension and may require pack200 tool\n      * @return collection of CodeSigners, that were used to sign the non-signature\n      * entries of the NBM\n      * @throws IOException\n      * @throws SecurityException if JAR was tampered with or if the certificate\n      *         chains are not consistent\n      */\n-    public static Collection<CodeSigner> getNbmCertificates (File nbmFile) throws IOException, SecurityException {\n+    public static Collection<CodeSigner> getNbmCertificates (File nbmFile, List<String> pack200Entries) throws IOException, SecurityException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2f5b93b5d53cfddd49b1a92ca94f9904e43c5afe"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80a6d71add8fdadfbad02179117095cb75c05207", "author": {"user": null}, "url": "https://github.com/apache/netbeans/commit/80a6d71add8fdadfbad02179117095cb75c05207", "committedDate": "2020-09-09T03:04:12Z", "message": "Scanning for pack200 entries is an independent check"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3989, "cost": 1, "resetAt": "2021-10-28T18:00:02Z"}}}