{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NjI4MDgy", "number": 2139, "title": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is s off-screen.", "bodyText": "(sorry, hit ENTER prematurely)\nThis tries to fix NETBEANS-2082, and older Bugzilla-270972 while retaining fix for Bugzilla-270172.\nThe original fix attempted to provide hint to the Editor infrastructure, to save caret position when the fold was collapsed, so it could scroll back the caret into the view, when the caret went off the screen as a result of the view hierarchy redraw.\nBut there were two issues:\n\nthe instruction to forceUpdate was sent on every fold change, not just the initial one (e.g. on fold expand, too).  This is fixed in FoldViewFactory.java.\nAnd even though it was meant as an instruction to maintain the caret visible, the scroll code triggered even though the caret was already off the screen when the folding happened. This is now checked in EditorCaret.java.\n\nI retained a few additional LOGs.", "createdAt": "2020-05-15T14:34:29Z", "url": "https://github.com/apache/netbeans/pull/2139", "merged": true, "mergeCommit": {"oid": "563a63826f0f80c9daabc861c8d520315b58c2e4"}, "closed": true, "closedAt": "2020-05-18T15:08:03Z", "author": {"login": "sdedic"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchpah0AFqTQxMjk4Nzk4Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABciF0ALABqjMzNDQyNTc4Mjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyOTg3OTgz", "url": "https://github.com/apache/netbeans/pull/2139#pullrequestreview-412987983", "createdAt": "2020-05-15T21:51:14Z", "commit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMTo1MToxNFrOGWUzoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQyMTo1MjozNFrOGWU1Kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2Mjc1Mg==", "bodyText": "Should this variable perhaps be called \"changeToCollapsed\" rather than \"changedToCollapsed\"?\nAlso, why keep this variable at all--why not just do \"collapsedFoldEncountered = true\" instead?", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426062752", "createdAt": "2020-05-15T21:51:14Z", "author": {"login": "eirikbakke"}, "path": "ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java", "diffHunk": "@@ -260,24 +260,25 @@ public void finishCreation() {\n \n     @Override\n     public void foldHierarchyChanged(FoldHierarchyEvent evt) {\n-        if (!collapsedFoldEncountered) {\n-            // Check if any collapsed fold was added or a collapsed/expanded state changed\n-            for (int i = evt.getAddedFoldCount() - 1; i >= 0; i--) {\n-                if (evt.getAddedFold(i).isCollapsed()) {\n-                    collapsedFoldEncountered = true;\n-                    break;\n-                }\n+        boolean collapsedAdded = false;\n+        boolean changedToCollapsed = false;\n+        // Check if any collapsed fold was added or a collapsed/expanded state changed\n+        for (int i = evt.getAddedFoldCount() - 1; i >= 0; i--) {\n+            if (evt.getAddedFold(i).isCollapsed()) {\n+                collapsedAdded = true;\n+                break;\n             }\n-            if (!collapsedFoldEncountered) {\n-                for (int i = evt.getFoldStateChangeCount() - 1; i >= 0; i--) {\n-                    FoldStateChange foldStateChange = evt.getFoldStateChange(i);\n-                    if (foldStateChange.isCollapsedChanged() && foldStateChange.getFold().isCollapsed()) {\n-                        collapsedFoldEncountered = true;\n-                        break;\n-                    }\n+        }\n+        if (!collapsedAdded) {\n+            for (int i = evt.getFoldStateChangeCount() - 1; i >= 0; i--) {\n+                FoldStateChange foldStateChange = evt.getFoldStateChange(i);\n+                if (foldStateChange.isCollapsedChanged() && foldStateChange.getFold().isCollapsed()) {\n+                    changedToCollapsed = true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjA2MzE0Ng==", "bodyText": "Would be good to add a comment here referencing the bug that is fixed by doing updateRetainsVisibleOnce only in the collapsedAdded case, and why this fixes the bug.", "url": "https://github.com/apache/netbeans/pull/2139#discussion_r426063146", "createdAt": "2020-05-15T21:52:34Z", "author": {"login": "eirikbakke"}, "path": "ide/editor.fold.nbui/src/org/netbeans/modules/editor/fold/ui/FoldViewFactory.java", "diffHunk": "@@ -289,7 +290,9 @@ public void foldHierarchyChanged(FoldHierarchyEvent evt) {\n                 ViewUtils.log(CHANGE_LOG, \"CHANGE in FoldViewFactory: <\" + // NOI18N\n                         startOffset + \",\" + endOffset + \">\\n\"); // NOI18N\n             }\n-            comp.putClientProperty(\"editorcaret.updateRetainsVisibleOnce\", Boolean.TRUE);\n+            if (collapsedAdded) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMDUwMzc5", "url": "https://github.com/apache/netbeans/pull/2139#pullrequestreview-413050379", "createdAt": "2020-05-16T05:45:47Z", "commit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTI4Mjg5", "url": "https://github.com/apache/netbeans/pull/2139#pullrequestreview-413128289", "createdAt": "2020-05-17T05:28:36Z", "commit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150a06b191e5f84666080b0168517c30c6b85a61", "author": {"user": {"login": "sdedic", "name": "Svatopluk Dedic"}}, "url": "https://github.com/apache/netbeans/commit/150a06b191e5f84666080b0168517c30c6b85a61", "committedDate": "2020-05-17T07:05:32Z", "message": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is off-screen."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04", "author": {"user": {"login": "sdedic", "name": "Svatopluk Dedic"}}, "url": "https://github.com/apache/netbeans/commit/39f56ef4b49b26bb77d3c0b7ab3a025aa4f6df04", "committedDate": "2020-05-15T14:23:12Z", "message": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is off-screen."}, "afterCommit": {"oid": "150a06b191e5f84666080b0168517c30c6b85a61", "author": {"user": {"login": "sdedic", "name": "Svatopluk Dedic"}}, "url": "https://github.com/apache/netbeans/commit/150a06b191e5f84666080b0168517c30c6b85a61", "committedDate": "2020-05-17T07:05:32Z", "message": "NETBEANS-2082: do not scroll to caret after fold collapse, if caret is off-screen."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4977, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}