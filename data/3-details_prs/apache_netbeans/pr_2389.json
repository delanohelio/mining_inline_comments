{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzA2NTgx", "number": 2389, "title": "Find Usages for LSP languages - both client and (Java) server.", "bodyText": "", "createdAt": "2020-09-22T05:52:02Z", "url": "https://github.com/apache/netbeans/pull/2389", "merged": true, "mergeCommit": {"oid": "8d221521d7ea8346a0508248844d892d61689aff"}, "closed": true, "closedAt": "2020-10-15T04:34:18Z", "author": {"login": "jlahoda"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLRdH-AH2gAyNDkwNzA2NTgxOjQ3MzdmMmNkMTI3ODkxODFmZDI3MDNhYmZkZmMyMmUzNGNiY2FlYWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSiql7AH2gAyNDkwNzA2NTgxOjI2NDY3MzBjMzk1MjY5MDJkYzM4ODZiN2IyOTJiNjU1YWFjZDI0NGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4737f2cd12789181fd2703abfdfc22e34cbcaead", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/4737f2cd12789181fd2703abfdfc22e34cbcaead", "committedDate": "2020-09-22T05:50:36Z", "message": "Find Usages for LSP languages - both client and (Java) server."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3MDg5MTM0", "url": "https://github.com/apache/netbeans/pull/2389#pullrequestreview-497089134", "createdAt": "2020-09-27T15:25:27Z", "commit": {"oid": "4737f2cd12789181fd2703abfdfc22e34cbcaead"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNToyNToyN1rOHYoCuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yN1QxNToyNToyN1rOHYoCuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTU4MzkyOA==", "bodyText": "I'm not familiar with the refactoring API, but my reading of the Javadoc is, that:\n\npreCheck\nprepare\ncheckParameters\nfastCheckParameters\n\ndo not raise exceptions, but return \"Problem\" instances. The way they are invoked here, the return value is ignored. Not sure whether this is intenential, but it looks wrong.\nMy reading of\nhttp://bits.netbeans.org/dev/javadoc/org-netbeans-modules-refactoring-api/org/netbeans/modules/refactoring/api/AbstractRefactoring.html#fastCheckParameters--\nis, that the call to checkParameters should do a superset of checks to fastCheckParameters. So if checkParameters is invoked, I would expect the call to fastCheckParameters to be superfluous.", "url": "https://github.com/apache/netbeans/pull/2389#discussion_r495583928", "createdAt": "2020-09-27T15:25:27Z", "author": {"login": "matthiasblaesing"}, "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/text/TextDocumentServiceImpl.java", "diffHunk": "@@ -591,16 +588,69 @@ public static String html2MD(String html) {\n                                                   createPosition(thisFileLineMap[0], end))));\n             }\n         }\n-        return CompletableFuture.completedFuture(result);\n+        return CompletableFuture.completedFuture(Either.forLeft(result));\n     }\n \n     @Override\n-    public CompletableFuture<List<? extends Location>> references(ReferenceParams arg0) {\n-        throw new UnsupportedOperationException(\"Not supported yet.\");\n+    public CompletableFuture<List<? extends Location>> references(ReferenceParams params) {\n+        AtomicBoolean cancel = new AtomicBoolean();\n+        Runnable[] cancelCallback = new Runnable[1];\n+        CompletableFuture<List<? extends Location>> result = new CompletableFuture<List<? extends Location>>() {\n+            @Override\n+            public boolean cancel(boolean mayInterruptIfRunning) {\n+                cancel.set(mayInterruptIfRunning);\n+                if (cancelCallback[0] != null) {\n+                    cancelCallback[0].run();\n+                }\n+                return super.cancel(mayInterruptIfRunning);\n+            }\n+        };\n+        WORKER.post(() -> {\n+            JavaSource js = getSource(params.getTextDocument().getUri());\n+            try {\n+                WhereUsedQuery[] query = new WhereUsedQuery[1];\n+                js.runUserActionTask(cc -> {\n+                    cc.toPhase(JavaSource.Phase.RESOLVED);\n+                    if (cancel.get()) return ;\n+                    Document doc = cc.getSnapshot().getSource().getDocument(true);\n+                    TreePath path = cc.getTreeUtilities().pathFor(getOffset(doc, params.getPosition()));\n+                    query[0] = new WhereUsedQuery(Lookups.singleton(TreePathHandle.create(path, cc)));\n+                }, true);\n+                if (cancel.get()) return ;\n+                cancelCallback[0] = () -> query[0].cancelRequest();\n+                RefactoringSession refactoring = RefactoringSession.create(\"FindUsages\");\n+                query[0].fastCheckParameters();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4737f2cd12789181fd2703abfdfc22e34cbcaead"}, "originalPosition": 162}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "929a263210b03fad2b87a4a39036e9728fcc9a74", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/929a263210b03fad2b87a4a39036e9728fcc9a74", "committedDate": "2020-10-02T04:58:53Z", "message": "Handling Problems during Find Usages computation; including Find Usages action in editor popup for typescript and C/C++."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cbee40fe4e6b62220871b62d975e18e34d3cba7", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/4cbee40fe4e6b62220871b62d975e18e34d3cba7", "committedDate": "2020-10-02T05:16:48Z", "message": "Proper null handling."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNDM2NDU2", "url": "https://github.com/apache/netbeans/pull/2389#pullrequestreview-501436456", "createdAt": "2020-10-02T20:44:25Z", "commit": {"oid": "4cbee40fe4e6b62220871b62d975e18e34d3cba7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "737d80b27e5596c57c00710884ea1340eee2c15f", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/737d80b27e5596c57c00710884ea1340eee2c15f", "committedDate": "2020-10-03T06:05:01Z", "message": "Handling include declaration in Java LSP find usages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1NDQ3MTMx", "url": "https://github.com/apache/netbeans/pull/2389#pullrequestreview-505447131", "createdAt": "2020-10-09T08:03:17Z", "commit": {"oid": "737d80b27e5596c57c00710884ea1340eee2c15f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODowMzoxOFrOHe_SeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOVQwODowMzoxOFrOHe_SeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjI1NjI0OA==", "bodyText": "There are similar changes on my java LSP debugging branch. Feel free to integrate soon. I will resolve the merge conflicts next week then.", "url": "https://github.com/apache/netbeans/pull/2389#discussion_r502256248", "createdAt": "2020-10-09T08:03:18Z", "author": {"login": "JaroslavTulach"}, "path": "ide/lsp.client/nbproject/project.properties", "diffHunk": "@@ -18,10 +18,10 @@\n javac.source=1.8\n javac.compilerargs=-Xlint -Xlint:-serial\n javadoc.arch=${basedir}/arch.xml\n-release.external/org.eclipse.lsp4j-0.8.1-p1.jar=modules/ext/org.eclipse.lsp4j-0.8.1-p1.jar\n-release.external/org.eclipse.lsp4j.generator-0.8.1.jar=modules/ext/org.eclipse.lsp4j.generator-0.8.1.jar\n-release.external/org.eclipse.lsp4j.jsonrpc-0.8.1.jar=modules/ext/org.eclipse.lsp4j.jsonrpc-0.8.1.jar\n-release.external/org.eclipse.xtend.lib-2.18.0.jar=modules/ext/org.eclipse.xtend.lib-2.18.0.jar\n-release.external/org.eclipse.xtend.lib.macro-2.18.0.jar=modules/ext/org.eclipse.xtend.lib.macro-2.18.0.jar\n-release.external/org.eclipse.xtext.xbase.lib-2.18.0.jar=modules/ext/org.eclipse.xtext.xbase.lib-2.18.0.jar\n+release.external/org.eclipse.lsp4j-0.9.0.jar=modules/ext/org.eclipse.lsp4j-0.9.0.jar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "737d80b27e5596c57c00710884ea1340eee2c15f"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91d9ad681332c41b9b87f1511c8b46dba286eefd", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/91d9ad681332c41b9b87f1511c8b46dba286eefd", "committedDate": "2020-10-13T19:01:40Z", "message": "Merging master into refactoring1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "737b2aae2c294d40ef91be13e45b7755d0ff780d", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/737b2aae2c294d40ef91be13e45b7755d0ff780d", "committedDate": "2020-10-14T19:25:34Z", "message": "Fixing dependencies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2646730c39526902dc3886b7b292b655aacd244e", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/2646730c39526902dc3886b7b292b655aacd244e", "committedDate": "2020-10-14T19:51:10Z", "message": "More dependency fixes."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4822, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}