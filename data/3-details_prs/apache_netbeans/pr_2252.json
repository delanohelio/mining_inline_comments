{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MDQ5NDgz", "number": 2252, "title": "Speeding up build, fixing some dependencies as needed.", "bodyText": "Currently, even incremental build is fairly slow. This is an attempt to improve the speed of the build - it reduces the build time by about 4 minutes on my computer, from ~16mins to ~12mins for a full build and ~10mins to 6mins for an incremental build (which is still a lot, of course).\nThe basic idea is simple: currently, when doing a build, we build every cluster separately in an ant instance. And every module has (generated) target like \"all-java.source.base\" depends=\"all-openide.util.lookup,...\". Note that the module depends directly on modules from different clusters. So, when building the \"java\" cluster, we also do a build of \"all-openide.util.lookup\", even if we have already built the \"platform\" cluster. This, of course, does only a timestamp check, but takes some time anyway. And we do this for every cluster, and many more modules, accumulating to a significant chunk of time.\nThe proposed solution is to generate the dependencies so that \"all-\" depends on a target that ensures all needed clusters are built, and on all- targets for modules from the current cluster. This avoids the unnecessary timestamp checks and improves build time. The code was actually expected to mostly work like this, but there was a small coding mistake, which prevented it from doing that.\nSadly, the current repository contains several cases where modules have dependencies on modules from other clusters, but there is no sensible dependency between the clusters. Namely:\n-extide/gradle depends on java/java.platform, but \"java\" depends on \"extide\", so this is a dependency in the wrong direction. I have moved gradle to the java cluster for the purpose of this patch.\n-java/debugger.jpda.trufflenode depends on webcommon/javascript.nodejs, but the \"java\" cluster does not depend on the \"webcommon\" cluster. I made \"java\" cluster depend on \"webcommon\" for the purpose of this patch.\n-nb/ko4j.debugging depends on java/maven, but the \"nb\" cluster does not (and should not) depend on the \"java\" cluster. I've moved the ko4j.debugging module into the \"java\" cluster for the purposed of this patch.\nI'd be happy to resolve the issues in other ways, as desired, but it would be awesome if we could speed up the build and make our dependencies cleaner!", "createdAt": "2020-07-13T05:48:49Z", "url": "https://github.com/apache/netbeans/pull/2252", "merged": true, "mergeCommit": {"oid": "d4a084fb37047dea646bbe8ee314be898c7da219"}, "closed": true, "closedAt": "2020-07-20T10:32:17Z", "author": {"login": "jlahoda"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxZfCdAH2gAyNDQ4MDQ5NDgzOjZiOWU4ODE2YzM4MmVhNTUyOTE0Mzc0MjhhZmYyMDcwNGI5Nzk5ZTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1YhHvAH2gAyNDQ4MDQ5NDgzOmY5YTA1MGRmOWNjM2ZlYTAzNzIwYWM5N2VlNWQ1OWQzYjJjYjliYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6b9e8816c382ea55291437428aff20704b9799e5", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/6b9e8816c382ea55291437428aff20704b9799e5", "committedDate": "2020-07-03T20:29:54Z", "message": "Speeding up the build by expressing module dependencies in ant targets more carefully."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9587ea70f8a3e1196ec65f6b6dfb0ed6dbb5769", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/f9587ea70f8a3e1196ec65f6b6dfb0ed6dbb5769", "committedDate": "2020-07-04T03:40:05Z", "message": "Fixing build."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4efffcdfd08fcf2845cac76e3988e81ffc2f910e", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/4efffcdfd08fcf2845cac76e3988e81ffc2f910e", "committedDate": "2020-07-11T17:24:42Z", "message": "Correcting locations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca059af2c0f883119c9db06fc65f1352df02ac62", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/ca059af2c0f883119c9db06fc65f1352df02ac62", "committedDate": "2020-07-12T07:28:44Z", "message": "Modules in the nb cluster cannot depend on modules in java cluster - moving ko4j.debugging to the java cluster."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MDAwMDQ4", "url": "https://github.com/apache/netbeans/pull/2252#pullrequestreview-447000048", "createdAt": "2020-07-13T06:02:10Z", "commit": {"oid": "6b9e8816c382ea55291437428aff20704b9799e5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNjowMjoxMVrOGwceKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QwNjowMjoxMVrOGwceKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzQ1MTMwNA==", "bodyText": "I see, this is the fix then.", "url": "https://github.com/apache/netbeans/pull/2252#discussion_r453451304", "createdAt": "2020-07-13T06:02:11Z", "author": {"login": "JaroslavTulach"}, "path": "nbbuild/antsrc/org/netbeans/nbbuild/InsertModuleAllTargets.java", "diffHunk": "@@ -136,8 +136,29 @@ public void setUseClusters(boolean b) {\n                     continue;\n                 }\n                 String[] prereqsAsCnb = entry.getBuildPrerequisites();\n-                StringBuffer namedDeps = new StringBuffer(\"init\");\n-                String myCluster = clustersOfModules.get(path);\n+                StringBuilder namedDeps = new StringBuilder(\"init\");\n+                String myCluster = clustersOfModules.get(entry.getNetbeansOrgId());\n+                if (myCluster != null) {\n+                    String clusterDep = \"all-cluster-\" + myCluster;\n+                    if (!prj.getTargets().keySet().contains(clusterDep)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b9e8816c382ea55291437428aff20704b9799e5"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d428bd714b62e55425d92ac52bc1cea02749698", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/7d428bd714b62e55425d92ac52bc1cea02749698", "committedDate": "2020-07-16T05:11:29Z", "message": "Moving Gradle back to extide, as its dependency on java.platform has been removed in master."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf038b68e067a86e16b27860bcce3c3c39aee9ce", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/bf038b68e067a86e16b27860bcce3c3c39aee9ce", "committedDate": "2020-07-16T05:11:33Z", "message": "Merge branch 'master' into fix-build-dependencies-for-speedup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a050df9cc3fea03720ac97ee5d59d3b2cb9bad", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/f9a050df9cc3fea03720ac97ee5d59d3b2cb9bad", "committedDate": "2020-07-16T05:37:58Z", "message": "Correcting module names."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4890, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}