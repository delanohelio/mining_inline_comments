{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwOTkzMTgz", "number": 2600, "title": "First attempt add LSP-based rename refactoring to the Java LSP Server and the LSP Client.", "bodyText": "", "createdAt": "2020-12-16T08:42:11Z", "url": "https://github.com/apache/netbeans/pull/2600", "merged": true, "mergeCommit": {"oid": "6f2ac3dfa872c071ab2dccbef52c2bab64b07d91"}, "closed": true, "closedAt": "2021-01-06T07:38:49Z", "author": {"login": "jlahoda"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjgbMbgH2gAyNTQwOTkzMTgzOjQ3ZTg0MDQ0YzE4NTc2MzYzY2FlMTM2NWZlMTIxN2U3YzhhODRmNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtRl86AH2gAyNTQwOTkzMTgzOjU5ODc5NzcyYWZjZDdjNThiOTc4YmQwYTE3YWJlNjQ3MmM3MWJlNWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "47e84044c18576363cae1365fe1217e7c8a84f49", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/47e84044c18576363cae1365fe1217e7c8a84f49", "committedDate": "2020-12-06T12:51:15Z", "message": "First attempt add LSP-based rename refactoring to the Java LSP Server and the LSP Client."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "597cb031cda6a2cf6a1c7edfa0c5fcd8570b7cfe", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/597cb031cda6a2cf6a1c7edfa0c5fcd8570b7cfe", "committedDate": "2020-12-06T15:58:01Z", "message": "Fixing import order."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfec095ac978aab8162b7b2c46614cadf3b33b15", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/dfec095ac978aab8162b7b2c46614cadf3b33b15", "committedDate": "2020-12-06T19:03:13Z", "message": "Merging master into the lsp-rename-refactoring branch."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7250544ceea9da133a1e6be4ca890c7a6780e838", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/7250544ceea9da133a1e6be4ca890c7a6780e838", "committedDate": "2020-12-06T20:30:22Z", "message": "Fixing import."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70d2d3dafa787f35998e24e0a5ddbfed82a2ec10", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/70d2d3dafa787f35998e24e0a5ddbfed82a2ec10", "committedDate": "2020-12-08T06:30:10Z", "message": "Resolving RAT problems."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe8132f7844b2c042165fb55837268b7df1141e4", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/fe8132f7844b2c042165fb55837268b7df1141e4", "committedDate": "2020-12-16T07:16:09Z", "message": "Merging master into lsp-rename-refactoring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c865767568f091041c03d511757a533099d4427", "author": {"user": {"login": "matthiasblaesing", "name": "Matthias Bl\u00e4sing"}}, "url": "https://github.com/apache/netbeans/commit/4c865767568f091041c03d511757a533099d4427", "committedDate": "2020-12-26T16:30:07Z", "message": "Merge branch 'master' into pr-2600"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52feaf755c926ee8af6a56993580c15b85df5397", "author": {"user": {"login": "matthiasblaesing", "name": "Matthias Bl\u00e4sing"}}, "url": "https://github.com/apache/netbeans/commit/52feaf755c926ee8af6a56993580c15b85df5397", "committedDate": "2020-12-27T17:15:12Z", "message": "Implement cancelability for refactorings\n\nPrimary aim of this change is to be able to cancel dialog from\nrefactoring, without raising UnsupportedOperationException."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26487ddd3a7285fbbcd25eb8c624536af016870b", "author": {"user": {"login": "matthiasblaesing", "name": "Matthias Bl\u00e4sing"}}, "url": "https://github.com/apache/netbeans/commit/26487ddd3a7285fbbcd25eb8c624536af016870b", "committedDate": "2020-12-27T17:15:12Z", "message": "Register rename action into the popup menu"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1618fb4bfd9c5c8060b5ea4d2b6e065e5824671f", "author": {"user": {"login": "matthiasblaesing", "name": "Matthias Bl\u00e4sing"}}, "url": "https://github.com/apache/netbeans/commit/1618fb4bfd9c5c8060b5ea4d2b6e065e5824671f", "committedDate": "2020-12-27T17:15:13Z", "message": "Ensure TokenSequence is accessed under document lock"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1449154d58d33f0a9023f8f819ee7b5c2c672118", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/1449154d58d33f0a9023f8f819ee7b5c2c672118", "committedDate": "2020-12-29T19:58:40Z", "message": "Merge changes done by matthiasblaesing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxOTk5MjUy", "url": "https://github.com/apache/netbeans/pull/2600#pullrequestreview-561999252", "createdAt": "2021-01-05T17:45:38Z", "commit": {"oid": "1449154d58d33f0a9023f8f819ee7b5c2c672118"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNzo0NTozOFrOIOg8Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNzo0NjoxM1rOIOg9rg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MDcxNQ==", "bodyText": "What is Set<TextDocumentServiceImpl> ALL_INSTANCES good for? It is only used from static void refreshAllEditors() that seems to be unused.", "url": "https://github.com/apache/netbeans/pull/2600#discussion_r552090715", "createdAt": "2021-01-05T17:45:38Z", "author": {"login": "dbalek"}, "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java", "diffHunk": "@@ -192,12 +205,14 @@\n \n     private static final RequestProcessor BACKGROUND_TASKS = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n     private static final RequestProcessor WORKER = new RequestProcessor(TextDocumentServiceImpl.class.getName(), 1, false, false);\n+    private static final Set<TextDocumentServiceImpl> ALL_INSTANCES = Collections.newSetFromMap(new WeakHashMap<>());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1449154d58d33f0a9023f8f819ee7b5c2c672118"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjA5MTA1NA==", "bodyText": "Seems to be unused.", "url": "https://github.com/apache/netbeans/pull/2600#discussion_r552091054", "createdAt": "2021-01-05T17:46:13Z", "author": {"login": "dbalek"}, "path": "java/java.lsp.server/src/org/netbeans/modules/java/lsp/server/protocol/TextDocumentServiceImpl.java", "diffHunk": "@@ -1410,20 +1556,37 @@ public static int getOffset(Document doc, Position pos) {\n             file[0] = wc.getFileObject();\n             lm[0] = wc.getCompilationUnit().getLineMap();\n         });\n+        return fileModifications(changes, file[0], lm[0]);\n+    }\n+    \n+    private static List<TextEdit> fileModifications(ModificationResult changes, FileObject file, LineMap lm) {\n         //TODO: full, correct and safe edit production:\n-        List<? extends ModificationResult.Difference> diffs = changes.getDifferences(file[0]);\n+        List<? extends ModificationResult.Difference> diffs = changes.getDifferences(file);\n         if (diffs == null) {\n             return Collections.emptyList();\n         }\n         List<TextEdit> edits = new ArrayList<>();\n+        IntFunction<Position> offset2Position = lm != null ? pos -> Utils.createPosition(lm, pos)\n+                                                           : pos -> Utils.createPosition(file, pos);\n+                                            \n         for (ModificationResult.Difference diff : diffs) {\n             String newText = diff.getNewText();\n-            edits.add(new TextEdit(new Range(Utils.createPosition(lm[0], diff.getStartPosition().getOffset()),\n-                                             Utils.createPosition(lm[0], diff.getEndPosition().getOffset())),\n+            edits.add(new TextEdit(new Range(offset2Position.apply(diff.getStartPosition().getOffset()),\n+                                             offset2Position.apply(diff.getEndPosition().getOffset())),\n                                    newText != null ? newText : \"\"));\n         }\n         return edits;\n     }\n+    \n+    static void refreshAllEditors() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1449154d58d33f0a9023f8f819ee7b5c2c672118"}, "originalPosition": 300}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59879772afcd7c58b978bd0a17abe6472c71be5c", "author": {"user": {"login": "jlahoda", "name": "Jan Lahoda"}}, "url": "https://github.com/apache/netbeans/commit/59879772afcd7c58b978bd0a17abe6472c71be5c", "committedDate": "2021-01-05T21:13:40Z", "message": "Removing unnecessary code."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 409, "cost": 1, "resetAt": "2021-10-28T17:48:14Z"}}}