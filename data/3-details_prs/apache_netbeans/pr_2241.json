{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MTYzNTIy", "number": 2241, "title": "[NETBEANS-4503] Code completion does not work in functions declared inside methods", "bodyText": "https://issues.apache.org/jira/browse/NETBEANS-4503\n1st commit\nNested functions are in a Method/FunctionScope.\nHowever, they are added as elements of a NamespaceScope.\ni.e. Method/FunctionScope doesn't have nested FunctionScopes. NamespaceScope has them.\nSo, (not return the child result simply,) check whether the child result contains the parent result in the VariableScopeFinder.findWrapper().\n2nd commit\nUnit test(testNb4503_01()) failed on GitHub Actions after I pushed the first commit.\nHowever, It passed on my local pc.\nAfter I've tried some things, I've somehow reproduced it.\n    public void testNb4503_01() throws Exception {\n        Thread.sleep(1000); // added this, then reproduced\n        testNb4503(\"            $e->^test(); // test1\");\n    }\nUnfortunately, if I set a breakpoint, I couldn't reproduce it. Just used println() to investigate the cause.\nThe cause:\nA cached Source instance may be removed after elements are indexed.\nSo, the test file is scanned again when the test is run. If there are elements for LazyBuild, we may not be able to get the correct result.\nTo avoiding that, after elements are scanned lazily, find the scope again.", "createdAt": "2020-07-07T05:30:05Z", "url": "https://github.com/apache/netbeans/pull/2241", "merged": true, "mergeCommit": {"oid": "8a9c63d3686fe707a5c2a6d325fdbaf223e133aa"}, "closed": true, "closedAt": "2020-07-07T12:34:44Z", "author": {"login": "junichi11"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcybWTzAH2gAyNDQ1MTYzNTIyOjhlNWE0YTZiY2M1MDhiNDcyMGI3OWZjMDFhMDZmNmYyYmJhMDg5Y2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyivVPABqjM1MTk2MDUyMDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e5a4a6bcc508b4720b79fc01a06f6f2bba089cd", "author": {"user": {"login": "junichi11", "name": "Junichi Yamamoto"}}, "url": "https://github.com/apache/netbeans/commit/8e5a4a6bcc508b4720b79fc01a06f6f2bba089cd", "committedDate": "2020-07-07T01:14:06Z", "message": "[NETBEANS-4503] Code completion does not work in functions declared inside methods\n\nNested functions are in a Method/FunctionScope.\nHowever, they are added as elements of a NamespaceScope.\ni.e. Method/FunctionScope doesn't have nested FunctionScopes. NamespaceScope has them.\nSo, (not return the child result simply,) check whether the child result contains the parent result in the `VariableScopeFinder.findWrapper()`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjQ0OTk0", "url": "https://github.com/apache/netbeans/pull/2241#pullrequestreview-443644994", "createdAt": "2020-07-07T07:50:45Z", "commit": {"oid": "117cdec493f2a6685c94c9635eb8b54e5f1d8f0b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzo1MDo0NVrOGtzAJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwNzo1MjoxN1rOGtzDPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDcyNQ==", "bodyText": "Maybe better compareAndSet()?", "url": "https://github.com/apache/netbeans/pull/2241#discussion_r450674725", "createdAt": "2020-07-07T07:50:45Z", "author": {"login": "tmysik"}, "path": "php/php.editor/src/org/netbeans/modules/php/editor/model/VariableScopeFinder.java", "diffHunk": "@@ -45,10 +51,22 @@ public VariableScope find(final Scope scope, final int offset, final ScopeRangeA\n     }\n \n     public VariableScope find(final List<? extends ModelElement> elements, final int offset, final ScopeRangeAcceptor scopeRangeAcceptor) {\n-        return findWrapper(elements, offset, scopeRangeAcceptor).getVariableScope();\n+        AtomicBoolean isLazilyScanned = new AtomicBoolean(false);\n+        VariableScope variableScope = findWrapper(elements, offset, scopeRangeAcceptor, isLazilyScanned).getVariableScope();\n+        if (isLazilyScanned.get()) {\n+            // some scopes may be added new elements when LazyBuild elements are scanned.\n+            // so, find again.\n+            // e.g. Source instances are cached as weak references.\n+            // so, ParserResult may not be the same instance even if the FileObject is the same.\n+            // it means that new Model and new ModelVisitor are created again. in such case, LazyBuild elements may not be scanned yet.\n+            LOGGER.log(Level.FINE, \"(LazyBuild)Scope is scanned.\"); // NOI18N\n+            isLazilyScanned.set(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "117cdec493f2a6685c94c9635eb8b54e5f1d8f0b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NTE0OQ==", "bodyText": "Ha, it is running in just one thread, right? In such a case, not needed, of course.", "url": "https://github.com/apache/netbeans/pull/2241#discussion_r450675149", "createdAt": "2020-07-07T07:51:32Z", "author": {"login": "tmysik"}, "path": "php/php.editor/src/org/netbeans/modules/php/editor/model/VariableScopeFinder.java", "diffHunk": "@@ -45,10 +51,22 @@ public VariableScope find(final Scope scope, final int offset, final ScopeRangeA\n     }\n \n     public VariableScope find(final List<? extends ModelElement> elements, final int offset, final ScopeRangeAcceptor scopeRangeAcceptor) {\n-        return findWrapper(elements, offset, scopeRangeAcceptor).getVariableScope();\n+        AtomicBoolean isLazilyScanned = new AtomicBoolean(false);\n+        VariableScope variableScope = findWrapper(elements, offset, scopeRangeAcceptor, isLazilyScanned).getVariableScope();\n+        if (isLazilyScanned.get()) {\n+            // some scopes may be added new elements when LazyBuild elements are scanned.\n+            // so, find again.\n+            // e.g. Source instances are cached as weak references.\n+            // so, ParserResult may not be the same instance even if the FileObject is the same.\n+            // it means that new Model and new ModelVisitor are created again. in such case, LazyBuild elements may not be scanned yet.\n+            LOGGER.log(Level.FINE, \"(LazyBuild)Scope is scanned.\"); // NOI18N\n+            isLazilyScanned.set(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NDcyNQ=="}, "originalCommit": {"oid": "117cdec493f2a6685c94c9635eb8b54e5f1d8f0b"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY3NTUxNw==", "bodyText": "Missing @Nullable?", "url": "https://github.com/apache/netbeans/pull/2241#discussion_r450675517", "createdAt": "2020-07-07T07:52:17Z", "author": {"login": "tmysik"}, "path": "php/php.editor/src/org/netbeans/modules/php/editor/model/VariableScopeFinder.java", "diffHunk": "@@ -45,10 +51,22 @@ public VariableScope find(final Scope scope, final int offset, final ScopeRangeA\n     }\n \n     public VariableScope find(final List<? extends ModelElement> elements, final int offset, final ScopeRangeAcceptor scopeRangeAcceptor) {\n-        return findWrapper(elements, offset, scopeRangeAcceptor).getVariableScope();\n+        AtomicBoolean isLazilyScanned = new AtomicBoolean(false);\n+        VariableScope variableScope = findWrapper(elements, offset, scopeRangeAcceptor, isLazilyScanned).getVariableScope();\n+        if (isLazilyScanned.get()) {\n+            // some scopes may be added new elements when LazyBuild elements are scanned.\n+            // so, find again.\n+            // e.g. Source instances are cached as weak references.\n+            // so, ParserResult may not be the same instance even if the FileObject is the same.\n+            // it means that new Model and new ModelVisitor are created again. in such case, LazyBuild elements may not be scanned yet.\n+            LOGGER.log(Level.FINE, \"(LazyBuild)Scope is scanned.\"); // NOI18N\n+            isLazilyScanned.set(false);\n+            variableScope = findWrapper(elements, offset, scopeRangeAcceptor, isLazilyScanned).getVariableScope();\n+        }\n+        return variableScope;\n     }\n \n-    private VariableScopeWrapper findWrapper(final List<? extends ModelElement> elements, final int offset, final ScopeRangeAcceptor scopeRangeAcceptor) {\n+    private VariableScopeWrapper findWrapper(final List<? extends ModelElement> elements, final int offset, final ScopeRangeAcceptor scopeRangeAcceptor, final AtomicBoolean isLazilyScanned) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "117cdec493f2a6685c94c9635eb8b54e5f1d8f0b"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fa8489abf12899ad57e22bf1d586d645c25f3cb", "author": {"user": {"login": "junichi11", "name": "Junichi Yamamoto"}}, "url": "https://github.com/apache/netbeans/commit/9fa8489abf12899ad57e22bf1d586d645c25f3cb", "committedDate": "2020-07-07T09:50:09Z", "message": "Find a VariableScope again if an unscanned scope is scanned"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "117cdec493f2a6685c94c9635eb8b54e5f1d8f0b", "author": {"user": {"login": "junichi11", "name": "Junichi Yamamoto"}}, "url": "https://github.com/apache/netbeans/commit/117cdec493f2a6685c94c9635eb8b54e5f1d8f0b", "committedDate": "2020-07-07T01:15:46Z", "message": "Find a VariableScope again if an unscanned scope is scanned"}, "afterCommit": {"oid": "9fa8489abf12899ad57e22bf1d586d645c25f3cb", "author": {"user": {"login": "junichi11", "name": "Junichi Yamamoto"}}, "url": "https://github.com/apache/netbeans/commit/9fa8489abf12899ad57e22bf1d586d645c25f3cb", "committedDate": "2020-07-07T09:50:09Z", "message": "Find a VariableScope again if an unscanned scope is scanned"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4874, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}