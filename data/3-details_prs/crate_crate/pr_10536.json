{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MTkzODE5", "number": 10536, "title": "Account for memory used and adapt size in insert-from-query operations", "bodyText": "Summary of the changes / Why this improves CrateDB\nFollow up to 9aae2a0\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error.\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-09-15T10:20:23Z", "url": "https://github.com/crate/crate/pull/10536", "merged": true, "mergeCommit": {"oid": "33ea14c69a209fc231c0d042f62e8595669c493f"}, "closed": true, "closedAt": "2020-09-16T13:55:57Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJIZPlABqjM3Njg1NTIxMDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJcRVpABqjM3NzMxNTYwMTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "01d6295d5a3a28ea8c3df9c54b871b10fc0b0712", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/01d6295d5a3a28ea8c3df9c54b871b10fc0b0712", "committedDate": "2020-09-15T10:20:03Z", "message": "Account for memory used and adapt size in insert-from-query operations\n\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\n\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error."}, "afterCommit": {"oid": "211bfa0aab194e4b872c258ad4b5ac60f70580ce", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/211bfa0aab194e4b872c258ad4b5ac60f70580ce", "committedDate": "2020-09-15T14:09:12Z", "message": "Account for memory used and adapt size in insert-from-query operations\n\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\n\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Mzc2MjAy", "url": "https://github.com/crate/crate/pull/10536#pullrequestreview-489376202", "createdAt": "2020-09-16T08:07:38Z", "commit": {"oid": "211bfa0aab194e4b872c258ad4b5ac60f70580ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Mzc4MDcx", "url": "https://github.com/crate/crate/pull/10536#pullrequestreview-489378071", "createdAt": "2020-09-16T08:10:03Z", "commit": {"oid": "211bfa0aab194e4b872c258ad4b5ac60f70580ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODoxMDowM1rOHSlO9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwODoxMDowM1rOHSlO9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI0NjQ1NQ==", "bodyText": "\ud83d\udc4d I think doing the free mem accounting not on every batch iterator was also some issue to come into play or?", "url": "https://github.com/crate/crate/pull/10536#discussion_r489246455", "createdAt": "2020-09-16T08:10:03Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/execution/engine/indexing/ShardingUpsertExecutor.java", "diffHunk": "@@ -252,6 +254,7 @@ private boolean shouldPauseOnPartitionCreation(ShardedRequests<ShardUpsertReques\n \n     @Override\n     public CompletableFuture<? extends Iterable<Row>> apply(BatchIterator<Row> batchIterator) {\n+        var isUsedBytesOverThreshold = new IsUsedBytesOverThreshold(queryCircuitBreaker);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "211bfa0aab194e4b872c258ad4b5ac60f70580ce"}, "originalPosition": 47}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "211bfa0aab194e4b872c258ad4b5ac60f70580ce", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/211bfa0aab194e4b872c258ad4b5ac60f70580ce", "committedDate": "2020-09-15T14:09:12Z", "message": "Account for memory used and adapt size in insert-from-query operations\n\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\n\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error."}, "afterCommit": {"oid": "988dc7a37c8e33762f45ec9923040a02282632e7", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/988dc7a37c8e33762f45ec9923040a02282632e7", "committedDate": "2020-09-16T13:05:28Z", "message": "fixup! Account for memory used and adapt size in insert-from-query operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NjEyNjgx", "url": "https://github.com/crate/crate/pull/10536#pullrequestreview-489612681", "createdAt": "2020-09-16T13:16:07Z", "commit": {"oid": "988dc7a37c8e33762f45ec9923040a02282632e7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d88fcab909895a7399f304248d531948a0d0761f", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/d88fcab909895a7399f304248d531948a0d0761f", "committedDate": "2020-09-16T13:18:41Z", "message": "Account for memory used and adapt size in insert-from-query operations\n\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\n\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "988dc7a37c8e33762f45ec9923040a02282632e7", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/988dc7a37c8e33762f45ec9923040a02282632e7", "committedDate": "2020-09-16T13:05:28Z", "message": "fixup! Account for memory used and adapt size in insert-from-query operations"}, "afterCommit": {"oid": "d88fcab909895a7399f304248d531948a0d0761f", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/d88fcab909895a7399f304248d531948a0d0761f", "committedDate": "2020-09-16T13:18:41Z", "message": "Account for memory used and adapt size in insert-from-query operations\n\nThis changes the insert-from-query logic to take the free memory of the\nquery circuit breaker into consideration when computing the\nbytes-per-bulk-requests size.\n\nIt also accounts for the max-bytes up-front before it starts reading the\ndata into memory. That should protect against cases where many\nconcurrent insert-from-query operations would try to load data into\nmemory that cannot possibly fit - leading to high GC pressure and maybe\neven an OOM error."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3761, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}