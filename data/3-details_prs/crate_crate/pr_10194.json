{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2NzU5OTkw", "number": 10194, "title": "Add recursive deletes for BlobContainers and fix Snapshot Deletion", "bodyText": "This improves the snapshot deletion process making sure all files are removed when a snapshot is deleted. The problem was discovered while porting over elastic/elasticsearch#43281.\nIt is based on the following steps:\n\nAdd recursive deletes based on elastic/elasticsearch#43281 implementing blobContainer.delete() to simplify the deletion process.\nAdding assertions for the Snapshot tests to make sure all files are removed.\nAdapt the relevant parts of the BlobStoreRepository according to the state of elastic/elasticsearch#46250.\n\nSummary of the changes / Why this improves CrateDB\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-07-09T10:10:15Z", "url": "https://github.com/crate/crate/pull/10194", "merged": true, "mergeCommit": {"oid": "1466d42922b49fd80ea36aa1fa5f0a2721973286"}, "closed": true, "closedAt": "2020-07-09T15:34:23Z", "author": {"login": "mkleen"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczNd3-gBqjM1MjkyOTAzNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczQVKcgH2gAyNDQ2NzU5OTkwOmIzZjllNzg3MjI1ZWUyYjYzNjViNjg1M2ViNWQ4ODhjZmRjOGM0NWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bed41db007ea263830fbc8a96b6a525e4ae16581", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/bed41db007ea263830fbc8a96b6a525e4ae16581", "committedDate": "2020-07-09T11:23:39Z", "message": "Simplify BlobStoreRepository"}, "afterCommit": {"oid": "c6c50037c81981ce63ce8b959c4977cca648b2ae", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/c6c50037c81981ce63ce8b959c4977cca648b2ae", "committedDate": "2020-07-09T11:37:21Z", "message": "Add recursive deletes for BlobContainers\n\nBackport of https://github.com/elastic/elasticsearch/pull/43281"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a23978f68572186f6593494d0c63e3c8fc01ea9d", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/a23978f68572186f6593494d0c63e3c8fc01ea9d", "committedDate": "2020-07-09T12:56:15Z", "message": "Remove unused code from BlobStoreRepository"}, "afterCommit": {"oid": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "committedDate": "2020-07-09T13:03:10Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjAwNzYy", "url": "https://github.com/crate/crate/pull/10194#pullrequestreview-445600762", "createdAt": "2020-07-09T13:12:47Z", "commit": {"oid": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzoxMjo0OFrOGvQfXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzoxMjo0OFrOGvQfXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIwNjQzMA==", "bodyText": "This was the part which had to be adapted for correct deletions.", "url": "https://github.com/crate/crate/pull/10194#discussion_r452206430", "createdAt": "2020-07-09T13:12:48Z", "author": {"login": "mkleen"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -927,24 +930,7 @@ long readSnapshotIndexLatestBlob() throws IOException {\n     }\n \n     private long listBlobsToGetLatestIndexId() throws IOException {\n-        Map<String, BlobMetadata> blobs = blobContainer().listBlobsByPrefix(INDEX_FILE_PREFIX);\n-        long latest = RepositoryData.EMPTY_REPO_GEN;\n-        if (blobs.isEmpty()) {\n-            // no snapshot index blobs have been written yet\n-            return latest;\n-        }\n-        for (final BlobMetadata blobMetadata : blobs.values()) {\n-            final String blobName = blobMetadata.name();\n-            try {\n-                final long curr = Long.parseLong(blobName.substring(INDEX_FILE_PREFIX.length()));\n-                latest = Math.max(latest, curr);\n-            } catch (NumberFormatException nfe) {\n-                // the index- blob wasn't of the format index-N where N is a number,\n-                // no idea what this blob is but it doesn't belong in the repository!\n-                LOGGER.debug(\"[{}] Unknown blob in the repository: {}\", metadata.name(), blobName);\n-            }\n-        }\n-        return latest;\n+        return latestGeneration(blobContainer().listBlobsByPrefix(INDEX_FILE_PREFIX).keySet());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a"}, "originalPosition": 75}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/915fcc8434f21be9ffb1c3e9540ec7e294f7697a", "committedDate": "2020-07-09T13:03:10Z", "message": "Remove unused code from BlobStoreRepository"}, "afterCommit": {"oid": "542927a0036b0ef2d399abff3179634f7a150268", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/542927a0036b0ef2d399abff3179634f7a150268", "committedDate": "2020-07-09T13:15:15Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjA5NzE2", "url": "https://github.com/crate/crate/pull/10194#pullrequestreview-445609716", "createdAt": "2020-07-09T13:23:01Z", "commit": {"oid": "542927a0036b0ef2d399abff3179634f7a150268"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzoyMzowMVrOGvQ6XQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMzoyMzowMVrOGvQ6XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIxMzM0MQ==", "bodyText": "Should the client be closed eventually, or is that not necessary?", "url": "https://github.com/crate/crate/pull/10194#discussion_r452213341", "createdAt": "2020-07-09T13:23:01Z", "author": {"login": "mfussenegger"}, "path": "blackbox/test_s3.py", "diffHunk": "@@ -103,6 +107,11 @@ def tearDownClass(cls):\n         crate_node.stop()\n \n     def test_copy_to_s3_copy_from_s3_roundtrip(self):\n+        client = Minio('127.0.0.1:9000',", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "542927a0036b0ef2d399abff3179634f7a150268"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjQ0NTA0", "url": "https://github.com/crate/crate/pull/10194#pullrequestreview-445644504", "createdAt": "2020-07-09T14:00:01Z", "commit": {"oid": "0826dd7249e9549a5208b1a77f4e6b7b6444f97a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDowMDowMVrOGvSftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDowMDowMVrOGvSftA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjIzOTI4NA==", "bodyText": "Maybe clarify that this affected Azure repositories? Or was it also the case for S3?", "url": "https://github.com/crate/crate/pull/10194#discussion_r452239284", "createdAt": "2020-07-09T14:00:01Z", "author": {"login": "mfussenegger"}, "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -268,5 +268,8 @@ Performance improvements\n Fixes\n =====\n \n+- Fixed an issue where :ref:`drop snapshots <ref-drop-snapshot>` would not\n+  delete all the related data.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0826dd7249e9549a5208b1a77f4e6b7b6444f97a"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc6605a7fd657c5fca8931363684b8485586bd1a", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/cc6605a7fd657c5fca8931363684b8485586bd1a", "committedDate": "2020-07-09T14:00:04Z", "message": "Use minio constants everywhere"}, "afterCommit": {"oid": "18fa7e67ad1b1b247b461177feac0ba0768c2251", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/18fa7e67ad1b1b247b461177feac0ba0768c2251", "committedDate": "2020-07-09T14:12:40Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "18fa7e67ad1b1b247b461177feac0ba0768c2251", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/18fa7e67ad1b1b247b461177feac0ba0768c2251", "committedDate": "2020-07-09T14:12:40Z", "message": "Remove unused code from BlobStoreRepository"}, "afterCommit": {"oid": "83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "committedDate": "2020-07-09T14:16:01Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/83b90f275eb1d85d7acaae9e5aba8e9df0e62035", "committedDate": "2020-07-09T14:16:01Z", "message": "Remove unused code from BlobStoreRepository"}, "afterCommit": {"oid": "143c92c53bc5b3b84a88f00c83057e56b13e1242", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/143c92c53bc5b3b84a88f00c83057e56b13e1242", "committedDate": "2020-07-09T14:17:02Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1ad0c0af482cef39b6f18f259337352d4e62d6", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/2b1ad0c0af482cef39b6f18f259337352d4e62d6", "committedDate": "2020-07-09T14:19:18Z", "message": "Add recursive deletes for BlobContainers and fix Snapshot Deletion\n\nBackport of https://github.com/elastic/elasticsearch/pull/43281\nThis fixes the snapshot deletion on azure where files would not\nhave been deleted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "committedDate": "2020-07-09T14:21:22Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "143c92c53bc5b3b84a88f00c83057e56b13e1242", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/143c92c53bc5b3b84a88f00c83057e56b13e1242", "committedDate": "2020-07-09T14:17:02Z", "message": "Remove unused code from BlobStoreRepository"}, "afterCommit": {"oid": "b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/b6870cfc71e9e4b6ec05246ca55a43c51dd5b24f", "committedDate": "2020-07-09T14:21:22Z", "message": "Remove unused code from BlobStoreRepository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3f9e787225ee2b6365b6853eb5d888cfdc8c45d", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/b3f9e787225ee2b6365b6853eb5d888cfdc8c45d", "committedDate": "2020-07-09T14:57:49Z", "message": "Merge branch 'master' into mkleen/fix_deletes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3184, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}