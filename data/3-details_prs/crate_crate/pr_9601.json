{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MDU4MjIz", "number": 9601, "title": "Add returning clause for insert to grammar and parser", "bodyText": "Summary of the changes / Why this improves CrateDB\nThis adds the RETURNING clause for INSERT to the grammar and the parser.\nChecklist\n\n User relevant changes are recorded in CHANGES.txt\n Touched code is covered by tests\n Documentation has been updated if necessary\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-01-30T12:54:35Z", "url": "https://github.com/crate/crate/pull/9601", "merged": true, "mergeCommit": {"oid": "e8011231e01e55991867557aed33c45bf67eb5dd"}, "closed": true, "closedAt": "2020-02-03T16:05:50Z", "author": {"login": "mkleen"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_emWgABqjI5OTQzNzcwMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAuugpgBqjMwMDI2NzA0NDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98adae2a749f76ba14f59cdb901ef33c64e017ae", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/98adae2a749f76ba14f59cdb901ef33c64e017ae", "committedDate": "2020-01-30T17:48:08Z", "message": "Add insert to sqlformatter and teststatementbuilder"}, "afterCommit": {"oid": "80c97d77ec14300b936d4c12c046a5da803eb84d", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/80c97d77ec14300b936d4c12c046a5da803eb84d", "committedDate": "2020-01-30T18:10:49Z", "message": "Add insert to sqlformatter and teststatementbuilder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzUzMzgz", "url": "https://github.com/crate/crate/pull/9601#pullrequestreview-351353383", "createdAt": "2020-01-31T08:32:58Z", "commit": {"oid": "80c97d77ec14300b936d4c12c046a5da803eb84d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwODozMjo1OFrOFkEWlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwODozMjo1OFrOFkEWlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzM2NDM3Mw==", "bodyText": "Could Insert and InsertFromSubquery merged into one class ?  Looks like everywhere InsertFromSubquery is used.", "url": "https://github.com/crate/crate/pull/9601#discussion_r373364373", "createdAt": "2020-01-31T08:32:58Z", "author": {"login": "mkleen"}, "path": "sql-parser/src/main/java/io/crate/sql/tree/Insert.java", "diffHunk": "@@ -31,11 +31,16 @@\n     protected final Table<T> table;\n     private final DuplicateKeyContext<T> duplicateKeyContext;\n     protected final List<String> columns;\n+    protected final List<SelectItem> returning;\n \n-    Insert(Table<T> table, List<String> columns, DuplicateKeyContext<T> duplicateKeyContext) {\n+    Insert(Table<T> table,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80c97d77ec14300b936d4c12c046a5da803eb84d"}, "originalPosition": 7}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "80c97d77ec14300b936d4c12c046a5da803eb84d", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/80c97d77ec14300b936d4c12c046a5da803eb84d", "committedDate": "2020-01-30T18:10:49Z", "message": "Add insert to sqlformatter and teststatementbuilder"}, "afterCommit": {"oid": "f020bb3113557a4d5b16f6386e32b9d001948eb6", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/f020bb3113557a4d5b16f6386e32b9d001948eb6", "committedDate": "2020-01-31T08:35:50Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f020bb3113557a4d5b16f6386e32b9d001948eb6", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/f020bb3113557a4d5b16f6386e32b9d001948eb6", "committedDate": "2020-01-31T08:35:50Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "committedDate": "2020-01-31T15:12:05Z", "message": "Remove InsertFromSubquery"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/aea04f5cb0c2f5fadefd0ca8c9e77091cb686872", "committedDate": "2020-01-31T15:12:05Z", "message": "Remove InsertFromSubquery"}, "afterCommit": {"oid": "e0c710f303a2d28b8888c29e2db2e795e8b12f73", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/e0c710f303a2d28b8888c29e2db2e795e8b12f73", "committedDate": "2020-01-31T15:17:16Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e0c710f303a2d28b8888c29e2db2e795e8b12f73", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/e0c710f303a2d28b8888c29e2db2e795e8b12f73", "committedDate": "2020-01-31T15:17:16Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "ed66293237238e4f29aea017d24e75a4a2de910c", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/ed66293237238e4f29aea017d24e75a4a2de910c", "committedDate": "2020-01-31T15:28:16Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed66293237238e4f29aea017d24e75a4a2de910c", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/ed66293237238e4f29aea017d24e75a4a2de910c", "committedDate": "2020-01-31T15:28:16Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "774166eaae9e4d232804be7879ed08145bdf1500", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/774166eaae9e4d232804be7879ed08145bdf1500", "committedDate": "2020-01-31T15:31:57Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "774166eaae9e4d232804be7879ed08145bdf1500", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/774166eaae9e4d232804be7879ed08145bdf1500", "committedDate": "2020-01-31T15:31:57Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "4bbba73933a795ced2350452b90a17654ee30e88", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/4bbba73933a795ced2350452b90a17654ee30e88", "committedDate": "2020-02-01T02:49:09Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4bbba73933a795ced2350452b90a17654ee30e88", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/4bbba73933a795ced2350452b90a17654ee30e88", "committedDate": "2020-02-01T02:49:09Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "87a1a1355fbc2d5c2d98e472a262257a0e47906c", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/87a1a1355fbc2d5c2d98e472a262257a0e47906c", "committedDate": "2020-02-01T02:52:46Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87a1a1355fbc2d5c2d98e472a262257a0e47906c", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/87a1a1355fbc2d5c2d98e472a262257a0e47906c", "committedDate": "2020-02-01T02:52:46Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "5b8e4eca2de88b426585e4016a157e2019be05fe", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/5b8e4eca2de88b426585e4016a157e2019be05fe", "committedDate": "2020-02-01T02:54:49Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5b8e4eca2de88b426585e4016a157e2019be05fe", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/5b8e4eca2de88b426585e4016a157e2019be05fe", "committedDate": "2020-02-01T02:54:49Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "8414f06a897ed08ea0a564b7b94ee69f79e1b323", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/8414f06a897ed08ea0a564b7b94ee69f79e1b323", "committedDate": "2020-02-02T03:27:10Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8414f06a897ed08ea0a564b7b94ee69f79e1b323", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/8414f06a897ed08ea0a564b7b94ee69f79e1b323", "committedDate": "2020-02-02T03:27:10Z", "message": "Add returning clause for insert to grammar and parser"}, "afterCommit": {"oid": "a29d155350f59b4f0fea0583167adef0a012a134", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/a29d155350f59b4f0fea0583167adef0a012a134", "committedDate": "2020-02-03T05:50:49Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTM2MDk2", "url": "https://github.com/crate/crate/pull/9601#pullrequestreview-352136096", "createdAt": "2020-02-03T10:00:27Z", "commit": {"oid": "a29d155350f59b4f0fea0583167adef0a012a134"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDowMDoyN1rOFkr4Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDowMDoyN1rOFkr4Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAxMTk5NQ==", "bodyText": "minor note: maybe instead of going with the returning rule, we can better introduce the selectItems rule that we can re-use in few places. Then we would avoid this special handling of the rule context, namely getReturningItems, and can reuse visitCollection without null checks, etc.  imho, going for the more common selectItems denominator gives a bit more beneficial.\notherwise, lgtm", "url": "https://github.com/crate/crate/pull/9601#discussion_r374011995", "createdAt": "2020-02-03T10:00:27Z", "author": {"login": "kovrus"}, "path": "sql-parser/src/main/antlr/SqlBase.g4", "diffHunk": "@@ -139,6 +140,10 @@ where\n     : WHERE condition=booleanExpression\n     ;\n \n+returning\n+    : RETURNING selectItem (',' selectItem)*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a29d155350f59b4f0fea0583167adef0a012a134"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTYyNjM1", "url": "https://github.com/crate/crate/pull/9601#pullrequestreview-352162635", "createdAt": "2020-02-03T10:44:04Z", "commit": {"oid": "a29d155350f59b4f0fea0583167adef0a012a134"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDo0NDowNFrOFktI_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMDo0NDowNFrOFktI_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDAzMjYzOA==", "bodyText": "The indentation here looks way off?", "url": "https://github.com/crate/crate/pull/9601#discussion_r374032638", "createdAt": "2020-02-03T10:44:04Z", "author": {"login": "mfussenegger"}, "path": "sql-parser/src/main/antlr/SqlBase.g4", "diffHunk": "@@ -40,7 +40,7 @@ statement\n     | UPDATE aliasedRelation\n         SET assignment (',' assignment)*\n         where?\n-        (RETURNING selectItem (',' selectItem)*)?      \t\t\t\t\t\t\t\t\t\t\t\t\t \t   #update\n+        returning?      \t\t\t\t\t\t\t\t                             #update", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a29d155350f59b4f0fea0583167adef0a012a134"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTk2NzYx", "url": "https://github.com/crate/crate/pull/9601#pullrequestreview-352196761", "createdAt": "2020-02-03T11:46:49Z", "commit": {"oid": "f419c19cb646b2f03ebd9dd3393a6a3c7419d6c4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "committedDate": "2020-02-03T15:29:32Z", "message": "Add returning clause for insert to grammar and parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f419c19cb646b2f03ebd9dd3393a6a3c7419d6c4", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/f419c19cb646b2f03ebd9dd3393a6a3c7419d6c4", "committedDate": "2020-02-03T11:27:23Z", "message": "Reformat grammar"}, "afterCommit": {"oid": "c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/c6b8e8dce43a15ce72c0c1b49fe5f717e109af32", "committedDate": "2020-02-03T15:29:32Z", "message": "Add returning clause for insert to grammar and parser"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3966, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}