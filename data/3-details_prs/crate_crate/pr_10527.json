{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2NDM0Mzcz", "number": 10527, "title": "Also pause insert-from-query on high memory usage", "bodyText": "Summary of the changes / Why this improves CrateDB\nWe added a byte-threshold to the partitioning, which leads to smaller\nindividual bulk requests, but it still allowed concurrent execution\nwhich can lead to many smaller bulk requests being held in memory for a\nlong time.\nThis adds the byte-threshold rule also to the pause check, to pause\nreading more data if a lot of memory is occupied.\nThis is based on some heap dumps from nodes which crashed due to OOM\nwhere a large chunk of memory was used up by response handlers.\nThis also lowers the allowed heap percentage that the bulk requests may\ntake (from 30% to 20%) and adds a second static max size (100MB)\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-09-14T08:19:20Z", "url": "https://github.com/crate/crate/pull/10527", "merged": true, "mergeCommit": {"oid": "9aae2a0534c7e89b6e7de5d81c6455cddb1938dd"}, "closed": true, "closedAt": "2020-09-14T13:00:57Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIvHy-gH2gAyNDg2NDM0MzczOjAwMmMxOGYxMThiNWM3ZGJlZTcwNDEyYTQ2YTQ4NGQ4YTNkNjhkYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIwuXbgFqTQ4NzYyNTY1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/002c18f118b5c7dbee70412a46a484d8a3d68da7", "committedDate": "2020-09-14T08:42:41Z", "message": "Also pause insert-from-query on high memory usage\n\nWe added a byte-threshold to the partitioning, which leads to smaller\nindividual bulk requests, but it still allowed concurrent execution\nwhich can lead to many smaller bulk requests being held in memory for a\nlong time.\n\nThis adds the byte-threshold rule also to the pause check, to pause\nreading more data if a lot of memory is occupied.\n\nThis is based on some heap dumps from nodes which crashed due to OOM\nwhere a large chunk of memory was used up by response handlers.\n\nThis also lowers the allowed heap percentage that the bulk requests may\ntake (from 30% to 20%) and adds a second static max size (100MB)"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0d85f811087eb5cbf8000075e3cf6144ff8324a6", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0d85f811087eb5cbf8000075e3cf6144ff8324a6", "committedDate": "2020-09-14T08:17:59Z", "message": "Also pause insert-from-query on high memory usage\n\nWe added a byte-threshold to the partitioning, which leads to smaller\nindividual bulk requests, but it still allowed concurrent execution\nwhich can lead to many smaller bulk requests being held in memory for a\nlong time.\n\nThis adds the byte-threshold rule also to the pause check, to pause\nreading more data if a lot of memory is occupied.\n\nThis is based on some heap dumps from nodes which crashed due to OOM\nwhere a large chunk of memory was used up by response handlers.\n\nThis also lowers the allowed heap percentage that the bulk requests may\ntake (from 30% to 20%) and adds a second static max size (100MB)"}, "afterCommit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/002c18f118b5c7dbee70412a46a484d8a3d68da7", "committedDate": "2020-09-14T08:42:41Z", "message": "Also pause insert-from-query on high memory usage\n\nWe added a byte-threshold to the partitioning, which leads to smaller\nindividual bulk requests, but it still allowed concurrent execution\nwhich can lead to many smaller bulk requests being held in memory for a\nlong time.\n\nThis adds the byte-threshold rule also to the pause check, to pause\nreading more data if a lot of memory is occupied.\n\nThis is based on some heap dumps from nodes which crashed due to OOM\nwhere a large chunk of memory was used up by response handlers.\n\nThis also lowers the allowed heap percentage that the bulk requests may\ntake (from 30% to 20%) and adds a second static max size (100MB)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NTU0NTIy", "url": "https://github.com/crate/crate/pull/10527#pullrequestreview-487554522", "createdAt": "2020-09-14T08:59:30Z", "commit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1OTozMFrOHRKYmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQwODo1OTozMFrOHRKYmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzc1Nzk3OQ==", "bodyText": "Not sure about this. The additional 20% or at most 100MB rule is not strictly necessary.\nBut taking up several GB for bulk requests seems too much.\nOr maybe the 20% is still too aggressive and we should go with something like 5% or 10%:\nWith 10%\n128.0 GB   \u2192 12800 MB\n16.0 GB    \u2192  1600 MB\n 8.0 GB    \u2192   800 MB\n 2.0 GB    \u2192   200 MB\n 0.5 GB    \u2192    50 MB\n\nWith 5%\n128.0 GB    \u2192  6400 MB\n 16.0 GB    \u2192   800 MB\n  8.0 GB    \u2192   400 MB\n  2.0 GB    \u2192   100 MB\n  0.5 GB    \u2192    25 MB", "url": "https://github.com/crate/crate/pull/10527#discussion_r487757979", "createdAt": "2020-09-14T08:59:30Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/indexing/ShardingUpsertExecutor.java", "diffHunk": "@@ -351,7 +358,18 @@ private void maybeSetInterrupt(@Nullable Exception failure) {\n \n         @Override\n         public final boolean test(ShardedRequests<?, ?> shardedRequests) {\n-            return shardedRequests.usedMemoryEstimate() > maxBytesUsableByShardedRequests;\n+            long usedMemoryEstimate = shardedRequests.ramBytesUsed();\n+            boolean requestsTooBig = usedMemoryEstimate > maxBytesUsableByShardedRequests\n+                || usedMemoryEstimate > MAX_MEMORY_PER_REQUEST_IN_BYTES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7"}, "originalPosition": 107}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjA4OTMy", "url": "https://github.com/crate/crate/pull/10527#pullrequestreview-487608932", "createdAt": "2020-09-14T10:10:29Z", "commit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjI1NjUy", "url": "https://github.com/crate/crate/pull/10527#pullrequestreview-487625652", "createdAt": "2020-09-14T10:34:43Z", "commit": {"oid": "002c18f118b5c7dbee70412a46a484d8a3d68da7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3758, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}