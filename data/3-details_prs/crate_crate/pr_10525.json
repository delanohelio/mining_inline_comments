{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1MDc4MzU0", "number": 10525, "title": "Do not close index searchers outside of the CollectTask.", "bodyText": "Summary of the changes / Why this improves CrateDB\nIn the doc values group by and aggregation optimizations\n(GroupByOptimizedIterator, DocValuesGroupByOptimizedIterator,\nDocValuesAggregates) index searchers are added explicitly to the\ncollect task and their closing, in case of failure, is managed as\nwell by the above-mentioned classes. That is redundant. The collect\ntask manages closing of the added index searcher itself. See\nCollectTask#innerKill or CollectTask#close/innerClose.\nCollectTask index searchers closing test case.\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-09-11T13:32:41Z", "url": "https://github.com/crate/crate/pull/10525", "merged": true, "mergeCommit": {"oid": "49999194ef6ab5aa2d7bae3b61e15eae6d00ed4b"}, "closed": true, "closedAt": "2020-09-11T14:45:33Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdH1bw8AH2gAyNDg1MDc4MzU0Ojg2ZTI1ZjgyN2JiZGY5M2Q1NzkwNDgyNmUyNjBkMTU3Y2YwZDI5ZGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdH2TNxAFqTQ4Njg1ODk5OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/86e25f827bbdf93d57904826e260d157cf0d29df", "committedDate": "2020-09-11T13:30:00Z", "message": "Do not close index searchers outside the CollectTask.\n\nIn the doc values group by and aggregation optimizations\n(GroupByOptimizedIterator, DocValuesGroupByOptimizedIterator,\nDocValuesAggregates) index searchers are added explicitly to the\ncollect task and their closing, in case of failure, is managed as\nwell by the above-mentioned classes. That is redundant. The collect\ntask manages closing of the added index searcher itself. See\n`CollectTask#innerKill` or `CollectTask#close/innerClose`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODI2Mjg2", "url": "https://github.com/crate/crate/pull/10525#pullrequestreview-486826286", "createdAt": "2020-09-11T13:53:10Z", "commit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxMFrOHQfy4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxMFrOHQfy4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ==", "bodyText": "I think the indexService() call could fail, in which case the searcher wouldn't be released because it hasn't been added to the collectTask yet.\nMakes me wonder if we should remove the lazy indexService initialization within SharedShardContext and do it eagerly. Then it couldn't fail here anymore.", "url": "https://github.com/crate/crate/pull/10525#discussion_r487060195", "createdAt": "2020-09-11T13:53:10Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "diffHunk": "@@ -100,42 +100,37 @@\n         ShardId shardId = indexShard.shardId();\n         SharedShardContext shardContext = collectTask.sharedShardContexts().getOrCreateContext(shardId);\n         Searcher searcher = shardContext.acquireSearcher(LuceneShardCollectorProvider.formatSource(phase));\n-        try {\n-            QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();\n-            collectTask.addSearcher(shardContext.readerId(), searcher);\n-            LuceneQueryBuilder.Context queryContext = luceneQueryBuilder.convert(\n-                phase.where(),\n-                collectTask.txnCtx(),\n-                indexShard.mapperService(),\n-                indexShard.shardId().getIndexName(),\n-                queryShardContext,\n-                table,\n-                shardContext.indexService().cache()\n-            );\n+        QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2ODU4OTk4", "url": "https://github.com/crate/crate/pull/10525#pullrequestreview-486858998", "createdAt": "2020-09-11T14:30:34Z", "commit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3755, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}