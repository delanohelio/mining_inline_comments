{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1NDYyODM3", "number": 10457, "title": "Fix sys.health.health state for partitions", "bodyText": "Use the number_of_shards setting of a partition instead of the partitioned table.\nThey could differ through the possibility of changing only the shards for future partitions.\nIf the value for the table is greater then the value of the  partition itself, using the tables value will result in missing shards and thus a RED health.\nThe first commit will fix the returned value of  sys.health.partition_ident for non-partitioned tables. As document, it should be NULL and not an empty string.", "createdAt": "2020-08-28T15:10:20Z", "url": "https://github.com/crate/crate/pull/10457", "merged": true, "mergeCommit": {"oid": "b2cf64ab6148910bde5a95e9ff20d35865451713"}, "closed": true, "closedAt": "2020-08-29T12:53:34Z", "author": {"login": "seut"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDWfK9ABqjM3MDQzODE5MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDoAsTABqjM3MDY0MjgzMDc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e57bc3e7c917637d4e0721513cae90806c3e2070", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/e57bc3e7c917637d4e0721513cae90806c3e2070", "committedDate": "2020-08-28T15:08:20Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the \npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}, "afterCommit": {"oid": "ff4909bddec1911f2494689eba3b3f44369722e5", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/ff4909bddec1911f2494689eba3b3f44369722e5", "committedDate": "2020-08-28T15:10:23Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the \npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff4909bddec1911f2494689eba3b3f44369722e5", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/ff4909bddec1911f2494689eba3b3f44369722e5", "committedDate": "2020-08-28T15:10:23Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the \npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}, "afterCommit": {"oid": "3419d25c22c6d511215b99755cedbe1b3b6ea638", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/3419d25c22c6d511215b99755cedbe1b3b6ea638", "committedDate": "2020-08-28T15:28:26Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3419d25c22c6d511215b99755cedbe1b3b6ea638", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/3419d25c22c6d511215b99755cedbe1b3b6ea638", "committedDate": "2020-08-28T15:28:26Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}, "afterCommit": {"oid": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "committedDate": "2020-08-28T15:57:49Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3ODQ1NTE5", "url": "https://github.com/crate/crate/pull/10457#pullrequestreview-477845519", "createdAt": "2020-08-28T15:58:04Z", "commit": {"oid": "3419d25c22c6d511215b99755cedbe1b3b6ea638"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNTo1ODowNFrOHJL6bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yOFQxNjowMTo1NVrOHJMCtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NDQxNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var partitionIndexName = IndexParts.toIndexName(\n          \n          \n            \n                            new RelationName(ident.tableSchema, ident.tableName),\n          \n          \n            \n                            ident.partitionIdent\n          \n          \n            \n                        );\n          \n          \n            \n                        var partitionIndexName = IndexParts.toIndexName(\n          \n          \n            \n                            ident.tableSchema,\n          \n          \n            \n                            ident.tableName,\n          \n          \n            \n                            ident.partitionIdent\n          \n          \n            \n                        );\n          \n      \n    \n    \n  \n\nThere is an overload that takes schema and name directly - avoids the RelationName construction and some indirection.", "url": "https://github.com/crate/crate/pull/10457#discussion_r479394415", "createdAt": "2020-08-28T15:58:04Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3419d25c22c6d511215b99755cedbe1b3b6ea638"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NTY4OA==", "bodyText": "I think it's legitimate for the indexMetaData to be absent if the partition is deleted concurrently. We should probably return null if indexMetaData is null - similar to how we handle the RelationUnknown case.", "url": "https://github.com/crate/crate/pull/10457#discussion_r479395688", "createdAt": "2020-08-28T16:00:29Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );\n+            var indexMetaData = clusterService.state().getMetadata().index(partitionIndexName);\n+            assert indexMetaData != null : \"index meta data for partition \" + partitionIndexName + \" not found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTM5NjUzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        var partitionInfo = PartitionInfos.createPartitionInfo(\n          \n          \n            \n                            partitionIndexName,\n          \n          \n            \n                            indexMetaData\n          \n          \n            \n                        );\n          \n          \n            \n                        assert partitionInfo != null : \"cannot resolve partition info for \" + partitionIndexName;\n          \n          \n            \n                        shardsCount = partitionInfo.numberOfShards();\n          \n          \n            \n                        shardsCount = indexMetadata.getNumberOfShards();\n          \n      \n    \n    \n  \n\nNo need to go through the PartitionInfo  to access the shard count.", "url": "https://github.com/crate/crate/pull/10457#discussion_r479396535", "createdAt": "2020-08-28T16:01:55Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/metadata/sys/TableHealthService.java", "diffHunk": "@@ -165,7 +167,23 @@ private TableHealth tableHealthFromEntry(Map.Entry<TablePartitionIdent, ShardsIn\n         } catch (RelationUnknown e) {\n             return null;\n         }\n-        return calculateHealth(ident, shardsInfo, tableInfo.numberOfShards());\n+        int shardsCount = tableInfo.numberOfShards();\n+        if (ident.partitionIdent != null) {\n+            var partitionIndexName = IndexParts.toIndexName(\n+                new RelationName(ident.tableSchema, ident.tableName),\n+                ident.partitionIdent\n+            );\n+            var indexMetaData = clusterService.state().getMetadata().index(partitionIndexName);\n+            assert indexMetaData != null : \"index meta data for partition \" + partitionIndexName + \" not found\";\n+            var partitionInfo = PartitionInfos.createPartitionInfo(\n+                partitionIndexName,\n+                indexMetaData\n+            );\n+            assert partitionInfo != null : \"cannot resolve partition info for \" + partitionIndexName;\n+            shardsCount = partitionInfo.numberOfShards();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/eacf04b8800b7e30edb5d67b3ee1df655750d7a0", "committedDate": "2020-08-28T15:57:49Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}, "afterCommit": {"oid": "104cc34e4f49c1fd9cc09f91a6000d451a8df182", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/104cc34e4f49c1fd9cc09f91a6000d451a8df182", "committedDate": "2020-08-28T16:30:45Z", "message": "fixup! Fix sys.health.health state for partitions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc3OTQyNjAz", "url": "https://github.com/crate/crate/pull/10457#pullrequestreview-477942603", "createdAt": "2020-08-28T18:29:08Z", "commit": {"oid": "104cc34e4f49c1fd9cc09f91a6000d451a8df182"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ab5a592abdd8c99e6bbb1b62deed7c68aaa5a7", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/b9ab5a592abdd8c99e6bbb1b62deed7c68aaa5a7", "committedDate": "2020-08-29T11:35:18Z", "message": "Fix value of sys.health.partition_ident\n\nAs documented, a NULL should be returned instead of an empty string\nfor non-partitioned tables."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1e006ace0c2829e00b1383a13307a05ec558fd2", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/d1e006ace0c2829e00b1383a13307a05ec558fd2", "committedDate": "2020-08-29T11:35:19Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "104cc34e4f49c1fd9cc09f91a6000d451a8df182", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/104cc34e4f49c1fd9cc09f91a6000d451a8df182", "committedDate": "2020-08-28T16:30:45Z", "message": "fixup! Fix sys.health.health state for partitions"}, "afterCommit": {"oid": "d1e006ace0c2829e00b1383a13307a05ec558fd2", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/d1e006ace0c2829e00b1383a13307a05ec558fd2", "committedDate": "2020-08-29T11:35:19Z", "message": "Fix sys.health.health state for partitions\n\nUse the `number_of_shards` setting of a partition instead of the\npartitioned table.\nThey could differ through the possibility of changing only the shards for\nfuture partitions.\nIf the value for the table is greater then the value of the\npartition itself, using the tables value will result in missing shards\nand thus a `RED` health."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3038, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}