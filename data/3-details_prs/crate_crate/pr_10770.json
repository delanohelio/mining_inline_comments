{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5OTc5MDQ4", "number": 10770, "title": "Added ``rank`` window function", "bodyText": "Summary of the changes / Why this improves CrateDB\nThis PR adds the window function rank as described in #10507\nI've implemented it as a map, rather than just tracking the last viewed row as the latter behaviour would return behaviour like this:\n cr> SELECT\n    ...   col1,\n    ...   RANK() OVER () as rank\n    ... FROM (VALUES\n    ...      ('A'),\n    ...      ('A'),\n    ...      ('B'),\n    ...      ('C'),\n    ...      ('A'),\n    ...      ('D'))\n    ... as t (col1);\n    +------+------+\n    | col1 | rank |\n    +------+------+\n    | A    |    1 |\n    | A    |    1 |\n    | B    |    3 |\n    | C    |    4 |\n    | A    |    5 |\n    | D    |    6 |\n    +------+------+\n    SELECT 6 rows in set (... sec)\n\nWhich i'm not sure is entirely accurate, but I will verify the postgres behaviour before requesting a review.\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-11-12T15:51:52Z", "url": "https://github.com/crate/crate/pull/10770", "merged": true, "mergeCommit": {"oid": "36dc3f26f96fe4041f398c2b10cf224841f2a07a"}, "closed": true, "closedAt": "2020-11-17T22:20:48Z", "author": {"login": "autophagy"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdb4BPpAFqTUyOTQzOTgwNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABddgVcAgBqjQwMDc1OTQ1NDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5NDM5ODA2", "url": "https://github.com/crate/crate/pull/10770#pullrequestreview-529439806", "createdAt": "2020-11-12T19:49:02Z", "commit": {"oid": "f8f2d9e700ec19dacfd262a6581fead0566ea0ce"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo0OTowMlrOHyLeZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxOTo0OTowMlrOHyLeZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjM3ODg1Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Within each partition, the rank of the first row is 1. Subsequent identical\n          \n          \n            \n            Within each partition, the rank of the first row is `1`. Subsequent identical", "url": "https://github.com/crate/crate/pull/10770#discussion_r522378853", "createdAt": "2020-11-12T19:49:02Z", "author": {"login": "norosa"}, "path": "docs/general/builtins/window-functions.rst", "diffHunk": "@@ -607,6 +607,55 @@ Example::\n    +---------+------+--------+-------------+\n    SELECT 5 rows in set (... sec)\n \n+\n+.. _window-function-rank:\n+\n+``rank()``\n+----------\n+\n+.. note::\n+\n+    The ``rank`` window function is an :ref:`enterprise feature\n+    <enterprise-features>`.\n+\n+Synopsis\n+........\n+\n+::\n+\n+    rank()\n+\n+Returns the rank of every row within a partition of a result set.\n+\n+Within each partition, the rank of the first row is 1. Subsequent identical", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8f2d9e700ec19dacfd262a6581fead0566ea0ce"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1505554c6afb3f999514903092ae63bcb092bdd8", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/1505554c6afb3f999514903092ae63bcb092bdd8", "committedDate": "2020-11-17T09:14:03Z", "message": "fixup! fixup! fixup! Added ``rank`` window function"}, "afterCommit": {"oid": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/b10d6b1e8202e13f0681e0bd9418a744b7e03b56", "committedDate": "2020-11-17T09:18:13Z", "message": "Added ``rank`` window function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTcxMDA0", "url": "https://github.com/crate/crate/pull/10770#pullrequestreview-532171004", "createdAt": "2020-11-17T09:28:04Z", "commit": {"oid": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOToyODowNFrOH0rzbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOTozOTozOVrOH0sShQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAwNTY3Ng==", "bodyText": "Could these be int to avoid boxing?", "url": "https://github.com/crate/crate/pull/10770#discussion_r525005676", "createdAt": "2020-11-17T09:28:04Z", "author": {"login": "mfussenegger"}, "path": "enterprise/functions/src/main/java/io/crate/window/RankFunctions.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * This file is part of a module with proprietary Enterprise Features.\n+ *\n+ * Licensed to Crate.io Inc. (\"Crate.io\") under one or more contributor\n+ * license agreements.  See the NOTICE file distributed with this work for\n+ * additional information regarding copyright ownership.\n+ *\n+ * Unauthorized copying of this file, via any medium is strictly prohibited.\n+ *\n+ * To use this file, Crate.io must have given you permission to enable and\n+ * use such Enterprise Features and you must have a valid Enterprise or\n+ * Subscription Agreement with Crate.io.  If you enable or use the Enterprise\n+ * Features, you represent and warrant that you have a valid Enterprise or\n+ * Subscription Agreement with Crate.io.  Your use of the Enterprise Features\n+ * if governed by the terms and conditions of your Enterprise or Subscription\n+ * Agreement with Crate.io.\n+ */\n+\n+package io.crate.window;\n+\n+import io.crate.data.Input;\n+import io.crate.data.Row;\n+import io.crate.execution.engine.collect.CollectExpression;\n+import io.crate.execution.engine.window.WindowFrameState;\n+import io.crate.execution.engine.window.WindowFunction;\n+import io.crate.metadata.functions.Signature;\n+import io.crate.module.EnterpriseFunctionsModule;\n+import io.crate.types.DataTypes;\n+\n+import java.util.List;\n+\n+\n+public class RankFunctions implements WindowFunction {\n+\n+    private static final String RANK_NAME = \"rank\";\n+\n+    private final Signature signature;\n+    private final Signature boundSignature;\n+    private Integer seenLastUpperBound;\n+    private Integer rank;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTAxMzYzNw==", "bodyText": "Do you think it would help users if we used some more realistic data set to also illustrate a common use case for the rank function?\nFor example, in https://www.sqltutorial.org/sql-window-functions/sql-rank/ they rank the salary.", "url": "https://github.com/crate/crate/pull/10770#discussion_r525013637", "createdAt": "2020-11-17T09:39:39Z", "author": {"login": "mfussenegger"}, "path": "docs/general/builtins/window-functions.rst", "diffHunk": "@@ -607,6 +607,56 @@ Example::\n    +---------+------+--------+-------------+\n    SELECT 5 rows in set (... sec)\n \n+\n+.. _window-function-rank:\n+\n+``rank()``\n+----------\n+\n+.. note::\n+\n+    The ``rank`` window function is an :ref:`enterprise feature\n+    <enterprise-features>`.\n+\n+Synopsis\n+........\n+\n+::\n+\n+    rank()\n+\n+Returns the rank of every row within a partition of a result set.\n+\n+Within each partition, the rank of the first row is ``1``. Subsequent tied\n+rows are given the same rank, and the potential rank of the next row\n+is incremented. Because of this, ranks may not be sequential.\n+\n+Example::\n+\n+    cr> SELECT\n+    ...   col1,\n+    ...   col2,\n+    ...   RANK() OVER (ORDER BY col1) as rank\n+    ... FROM (VALUES", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b10d6b1e8202e13f0681e0bd9418a744b7e03b56"}, "originalPosition": 34}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b063cc48f70c7504b154fe73359dbf3a56a7b04a", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/b063cc48f70c7504b154fe73359dbf3a56a7b04a", "committedDate": "2020-11-17T09:57:39Z", "message": "fixup! Added ``rank`` window function"}, "afterCommit": {"oid": "7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "committedDate": "2020-11-17T13:29:42Z", "message": "Added ``rank`` window function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/7c0786258a9dd696a7a9705d11a9b1bd68c3302c", "committedDate": "2020-11-17T13:29:42Z", "message": "Added ``rank`` window function"}, "afterCommit": {"oid": "eaef0ec065ab5e085593888be0976e0662dc8258", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/eaef0ec065ab5e085593888be0976e0662dc8258", "committedDate": "2020-11-17T15:19:39Z", "message": "Added ``rank`` window function"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "committedDate": "2020-11-17T21:20:32Z", "message": "Added ``rank`` window function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eaef0ec065ab5e085593888be0976e0662dc8258", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/eaef0ec065ab5e085593888be0976e0662dc8258", "committedDate": "2020-11-17T15:19:39Z", "message": "Added ``rank`` window function"}, "afterCommit": {"oid": "1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "author": {"user": {"login": "autophagy", "name": "Mika"}}, "url": "https://github.com/crate/crate/commit/1ae65229a2f1c4e4e22f2ae31cda489f0a775bbd", "committedDate": "2020-11-17T21:20:32Z", "message": "Added ``rank`` window function"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3628, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}