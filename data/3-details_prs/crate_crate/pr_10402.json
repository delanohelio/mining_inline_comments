{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMTU3Mzg3", "number": 10402, "title": "Account for memory usage in doc values aggregators.", "bodyText": "Summary of the changes / Why this improves CrateDB\nSee commits.\nIt should supersede #10396\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-08-19T13:15:43Z", "url": "https://github.com/crate/crate/pull/10402", "merged": true, "mergeCommit": {"oid": "1f2a3199db4c40f1760ff9e7c2a1d4358a48d014"}, "closed": true, "closedAt": "2020-08-20T13:18:38Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAbi_7AFqTQ3MDQ1MTYxNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAvBt9gBqjM2NzQ5MjIzODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNDUxNjE1", "url": "https://github.com/crate/crate/pull/10402#pullrequestreview-470451615", "createdAt": "2020-08-19T13:22:54Z", "commit": {"oid": "de029aeacc686a4b8c3656764ff247e79ca12c79"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3508e2ae1d1d64b7d7d67db27b74903700eb1aad", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/3508e2ae1d1d64b7d7d67db27b74903700eb1aad", "committedDate": "2020-08-19T13:56:45Z", "message": "Extend DocValueAggregator methods with the RamAccounting parameter.\n\nSome aggregation functions, e.g. array_agg or collect_set,\nmay require a significant amount of memory, therefore, we have to\naccount it."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "de029aeacc686a4b8c3656764ff247e79ca12c79", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/de029aeacc686a4b8c3656764ff247e79ca12c79", "committedDate": "2020-08-19T13:13:54Z", "message": "WIP: Account for memory usage in doc values aggregators."}, "afterCommit": {"oid": "97e90192158ffa5f0c5021487e8113c470f61503", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/97e90192158ffa5f0c5021487e8113c470f61503", "committedDate": "2020-08-19T13:56:45Z", "message": "Account for memory usage in doc values aggregator implementations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNTA1MzU1", "url": "https://github.com/crate/crate/pull/10402#pullrequestreview-470505355", "createdAt": "2020-08-19T14:18:50Z", "commit": {"oid": "97e90192158ffa5f0c5021487e8113c470f61503"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDoxODo1MFrOHDJnJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNDoxODo1MFrOHDJnJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzA2NTI1NA==", "bodyText": "Shouldn't we do this in apply instead, to account the used bytes earlier? Or does that make the abstractions more complex?", "url": "https://github.com/crate/crate/pull/10402#discussion_r473065254", "createdAt": "2020-08-19T14:18:50Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/aggregation/impl/ArbitraryAggregation.java", "diffHunk": "@@ -198,21 +203,26 @@ public Object partialResult(RamAccounting ramAccounting, MutableObject state) {\n     private static class ArbitraryNumericDocValueAggregator extends SortedNumericDocValueAggregator<MutableObject> {\n \n         private final DataType<?> columnDataType;\n+        private final SizeEstimator<Object> sizeEstimator;\n \n         public ArbitraryNumericDocValueAggregator(\n             String columnName,\n             DataType<?> columnDataType,\n+            SizeEstimator<Object> sizeEstimator,\n             CheckedBiConsumer<SortedNumericDocValues, MutableObject, IOException> docValuesConsumer\n         ) {\n-            super(columnName, MutableObject::new, docValuesConsumer);\n+            super(columnName, (ramAccounting) -> new MutableObject(), docValuesConsumer);\n             this.columnDataType = columnDataType;\n+            this.sizeEstimator = sizeEstimator;\n         }\n \n         @Nullable\n         @Override\n         public Object partialResult(RamAccounting ramAccounting, MutableObject state) {\n             if (state.hasValue()) {\n-                return columnDataType.sanitizeValue(state.value());\n+                var partialResult = columnDataType.sanitizeValue(state.value());\n+                ramAccounting.addBytes(sizeEstimator.estimateSize(partialResult));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97e90192158ffa5f0c5021487e8113c470f61503"}, "originalPosition": 68}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69982dd4d731460fedc2f6b816b670a39e0961d6", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/69982dd4d731460fedc2f6b816b670a39e0961d6", "committedDate": "2020-08-20T08:51:55Z", "message": "fixup! Account for memory usage in doc values aggregator implementations."}, "afterCommit": {"oid": "dca36317852bfdde29150acb23d19068916f961b", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/dca36317852bfdde29150acb23d19068916f961b", "committedDate": "2020-08-20T09:04:21Z", "message": "fixup! Account for memory usage in doc values aggregator implementations."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxNDM4NTEz", "url": "https://github.com/crate/crate/pull/10402#pullrequestreview-471438513", "createdAt": "2020-08-20T09:53:27Z", "commit": {"oid": "dca36317852bfdde29150acb23d19068916f961b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dca36317852bfdde29150acb23d19068916f961b", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/dca36317852bfdde29150acb23d19068916f961b", "committedDate": "2020-08-20T09:04:21Z", "message": "fixup! Account for memory usage in doc values aggregator implementations."}, "afterCommit": {"oid": "140418053d1659865ffe0b7ca0de8ea24a1e7c04", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/140418053d1659865ffe0b7ca0de8ea24a1e7c04", "committedDate": "2020-08-20T09:55:49Z", "message": "Account for memory usage in doc values aggregator implementations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab45a2fb96767c0e3e026557d7820ba38300227", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/bab45a2fb96767c0e3e026557d7820ba38300227", "committedDate": "2020-08-20T12:04:30Z", "message": "Account for memory usage in doc values aggregator implementations."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "140418053d1659865ffe0b7ca0de8ea24a1e7c04", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/140418053d1659865ffe0b7ca0de8ea24a1e7c04", "committedDate": "2020-08-20T09:55:49Z", "message": "Account for memory usage in doc values aggregator implementations."}, "afterCommit": {"oid": "bab45a2fb96767c0e3e026557d7820ba38300227", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/bab45a2fb96767c0e3e026557d7820ba38300227", "committedDate": "2020-08-20T12:04:30Z", "message": "Account for memory usage in doc values aggregator implementations."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3212, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}