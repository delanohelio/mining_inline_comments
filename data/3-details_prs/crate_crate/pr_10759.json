{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4NTQ0OTA0", "number": 10759, "title": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY ", "bodyText": "Fixes a regression introduced in 4.3 when regexp_matches\nwas converted into a table function\n(8ad9ecf).\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement.", "createdAt": "2020-11-10T14:52:11Z", "url": "https://github.com/crate/crate/pull/10759", "merged": true, "mergeCommit": {"oid": "94a23beb1c8df7c548c9fcfd6c703065136c9025"}, "closed": true, "closedAt": "2020-11-11T10:51:46Z", "author": {"login": "seut"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbL2tNABqjM5Nzk3ODcyNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbbRM8gBqjM5ODMxNDM5MjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "35c86e7788253a49ced6fb7a156fe23cd721fea0", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/35c86e7788253a49ced6fb7a156fe23cd721fea0", "committedDate": "2020-11-10T14:47:27Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}, "afterCommit": {"oid": "3256ead051616ae1157430cbc7dc54664539210a", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/3256ead051616ae1157430cbc7dc54664539210a", "committedDate": "2020-11-10T16:21:43Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MzgzODU1", "url": "https://github.com/crate/crate/pull/10759#pullrequestreview-527383855", "createdAt": "2020-11-10T16:29:32Z", "commit": {"oid": "3256ead051616ae1157430cbc7dc54664539210a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyOTozMlrOHwk70Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjoyOTozMlrOHwk70Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY5ODgzMw==", "bodyText": "I don't really understand why we have the special case for subscript functions. Shouldn't we be able to support all kinds of functions if subscripts work - or why are they special?", "url": "https://github.com/crate/crate/pull/10759#discussion_r520698833", "createdAt": "2020-11-10T16:29:32Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/analyze/validator/GroupBySymbolValidator.java", "diffHunk": "@@ -34,23 +36,26 @@\n     private static final InnerValidator INNER_VALIDATOR = new InnerValidator();\n \n     public static void validate(Symbol symbol) throws IllegalArgumentException, UnsupportedOperationException {\n-        symbol.accept(INNER_VALIDATOR, \"Cannot GROUP BY '%s': invalid data type '%s'\");\n+        symbol.accept(INNER_VALIDATOR, false);\n     }\n \n-    private static class InnerValidator extends SymbolVisitor<String, Void> {\n+    private static class InnerValidator extends SymbolVisitor<Boolean, Void> {\n \n         @Override\n-        public Void visitFunction(Function function, String errorMsgTemplate) {\n+        public Void visitFunction(Function function, Boolean insideSubscriptFunction) {\n             switch (function.type()) {\n                 case SCALAR:\n                     for (Symbol argument : function.arguments()) {\n-                        argument.accept(this, errorMsgTemplate);\n+                        argument.accept(this, function.name().equals(SubscriptFunction.NAME));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3256ead051616ae1157430cbc7dc54664539210a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3OTgzMDEz", "url": "https://github.com/crate/crate/pull/10759#pullrequestreview-527983013", "createdAt": "2020-11-11T09:03:02Z", "commit": {"oid": "24d7c1f76466a1bde45cd485fb35ba20c8be91f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowMzowM1rOHxEQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQwOTowMzowM1rOHxEQCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTIxMTkxMw==", "bodyText": "Should we also add a logical planner test for this case? Otherwise the new ProjectSet creation change is not tested, or am I missing something?", "url": "https://github.com/crate/crate/pull/10759#discussion_r521211913", "createdAt": "2020-11-11T09:03:03Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/analyze/SelectStatementAnalyzerTest.java", "diffHunk": "@@ -2604,4 +2614,12 @@ public void test_match_with_geo_shape_is_streamed_as_text_type_to_4_1_8_nodes()\n         Function serializedTo41 = new Function(in);\n         assertThat(serializedTo41.info().ident().argumentTypes().get(1), is(DataTypes.STRING));\n     }\n+\n+    @Test\n+    public void test_table_function_wrapped_inside_scalar_can_be_used_inside_group_by() {\n+        var executor = SQLExecutor.builder(clusterService)\n+            .build();\n+        AnalyzedRelation rel = executor.analyze(\"select regexp_matches('foo', '.*')[1] from sys.cluster group by 1\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24d7c1f76466a1bde45cd485fb35ba20c8be91f7"}, "originalPosition": 104}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MDEwNTM1", "url": "https://github.com/crate/crate/pull/10759#pullrequestreview-528010535", "createdAt": "2020-11-11T09:39:26Z", "commit": {"oid": "52b6bcdec7ed7203e35bfe33dec79279af76a10c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52b6bcdec7ed7203e35bfe33dec79279af76a10c", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/52b6bcdec7ed7203e35bfe33dec79279af76a10c", "committedDate": "2020-11-11T09:37:33Z", "message": "fixup! Fix usage of regexp_matches wrapped inside subscript as GROUB BY"}, "afterCommit": {"oid": "773ff63bfefbb2bdebabd9c54d33583ab10e91de", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/773ff63bfefbb2bdebabd9c54d33583ab10e91de", "committedDate": "2020-11-11T09:56:25Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71af41d94bc7470d08cbd7855482179ec887343d", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/71af41d94bc7470d08cbd7855482179ec887343d", "committedDate": "2020-11-11T10:19:17Z", "message": "Fix validation of GROUP BY expressions when wrapped inside an alias\n\nIf a column aliased is used inside the GROUP BY symbols the validation\ndid not worked as `AliasedSymbol`s were not processed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498031f6e500f23fcc85641d0239f205556a73e6", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/498031f6e500f23fcc85641d0239f205556a73e6", "committedDate": "2020-11-11T10:19:17Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "773ff63bfefbb2bdebabd9c54d33583ab10e91de", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/773ff63bfefbb2bdebabd9c54d33583ab10e91de", "committedDate": "2020-11-11T09:56:25Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}, "afterCommit": {"oid": "498031f6e500f23fcc85641d0239f205556a73e6", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/498031f6e500f23fcc85641d0239f205556a73e6", "committedDate": "2020-11-11T10:19:17Z", "message": "Fix usage of regexp_matches wrapped inside subscript as GROUB BY\n\nFixes a regression introduced in 4.3 when ``regexp_matches``\nwas converted into a table function\n(https://github.com/crate/crate/commit/8ad9ecf201af3ef796d1d064bd7728444e57d1c8).\n\nThis also fixes the broken AdminUI->Monitoring tab as it uses such a statement."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3620, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}