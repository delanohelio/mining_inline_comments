{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3MjMyNjEw", "number": 10365, "title": "Merge task prepare and start", "bodyText": "Summary of the changes / Why this improves CrateDB\nMerge task prepare and start\nThere is no benefit distinguishing between the two. The opposite is the\ncase, it adds one more explicit state to reason about.\nPart of the motivation is to make the BatchIterator construction async.\nThat should allow us to use awaitShardSearchActive from\nelastic/elasticsearch@f23ed61\nDon't manage inner tasks in a map, but keep original list\nAvoids some copy/allocation operations. The downside is that the Task\ninstances are kept referenced until the last task finishes.\nSince most tasks are chained and operate as a lazy pipeline, most of\nthem likely finishes at a similar time anyway.\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-08-13T08:29:08Z", "url": "https://github.com/crate/crate/pull/10365", "merged": true, "mergeCommit": {"oid": "bbbb572b6e4c43f740907f257c91f0223a27893e"}, "closed": true, "closedAt": "2020-08-13T14:37:14Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-cVMugBqjM2NTExNTA4NjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-ghYygH2gAyNDY3MjMyNjEwOjNiNTQyOGY3NDU3Njg1MzYwMDVjOTExNGYyMWZjYzNmOTFmMjg3MzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "080a3cff2bf5a3794244a9e7541a3934a50ef450", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/080a3cff2bf5a3794244a9e7541a3934a50ef450", "committedDate": "2020-08-13T08:26:05Z", "message": "Don't manage inner tasks in a map, but keep original list\n\nAvoids some copy/allocation operations. The downside is that the Task\ninstances are kept referenced until the last task finishes.\n\nSince most tasks are chained and operate as a lazy pipeline, most of\nthem likely finishes at a similar time anyway."}, "afterCommit": {"oid": "749687dc84bb352cac0e171725a7a3f5c108ea93", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/749687dc84bb352cac0e171725a7a3f5c108ea93", "committedDate": "2020-08-13T09:09:43Z", "message": "Don't manage inner tasks in a map, but keep original list\n\nAvoids some copy/allocation operations. The downside is that the Task\ninstances are kept referenced until the last task finishes.\n\nSince most tasks are chained and operate as a lazy pipeline, most of\nthem likely finishes at a similar time anyway."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6788cc9203c48f8fadd4acbb3f21b6170319556b", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/6788cc9203c48f8fadd4acbb3f21b6170319556b", "committedDate": "2020-08-13T11:24:21Z", "message": "Don't manage inner tasks in a map, but keep original list\n\nAvoids some copy/allocation operations. The downside is that the Task\ninstances are kept referenced until the last task finishes.\n\nSince most tasks are chained and operate as a lazy pipeline, most of\nthem likely finishes at a similar time anyway."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/4affa7f408cd98ba9491f8a2f6be99a0998e68f2", "committedDate": "2020-08-13T11:24:32Z", "message": "Merge task prepare and start\n\nThere is no benefit distinguishing between the two. The opposite is the\ncase, it adds one more explicit state to reason about.\n\nPart of the motivation is to make the BatchIterator construction async.\nThat should allow us to use `awaitShardSearchActive` from\n\n  https://github.com/elastic/elasticsearch/commit/f23ed6188db864b1ea1062e5d44bdf5654b2aa3c"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "749687dc84bb352cac0e171725a7a3f5c108ea93", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/749687dc84bb352cac0e171725a7a3f5c108ea93", "committedDate": "2020-08-13T09:09:43Z", "message": "Don't manage inner tasks in a map, but keep original list\n\nAvoids some copy/allocation operations. The downside is that the Task\ninstances are kept referenced until the last task finishes.\n\nSince most tasks are chained and operate as a lazy pipeline, most of\nthem likely finishes at a similar time anyway."}, "afterCommit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/4affa7f408cd98ba9491f8a2f6be99a0998e68f2", "committedDate": "2020-08-13T11:24:32Z", "message": "Merge task prepare and start\n\nThere is no benefit distinguishing between the two. The opposite is the\ncase, it adds one more explicit state to reason about.\n\nPart of the motivation is to make the BatchIterator construction async.\nThat should allow us to use `awaitShardSearchActive` from\n\n  https://github.com/elastic/elasticsearch/commit/f23ed6188db864b1ea1062e5d44bdf5654b2aa3c"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NjczOTI5", "url": "https://github.com/crate/crate/pull/10365#pullrequestreview-466673929", "createdAt": "2020-08-13T11:27:46Z", "commit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMToyNzo0NlrOHAHYdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxMToyNzo0NlrOHAHYdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTg4Mjk5Ng==", "bodyText": "Although this changes the alorithm from a O(1) of the map lookup to a O(n), n is usually 2 or 3, so it's likely faster than the O(1) of the map was.", "url": "https://github.com/crate/crate/pull/10365#discussion_r469882996", "createdAt": "2020-08-13T11:27:46Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/jobs/RootTask.java", "diffHunk": "@@ -219,9 +196,14 @@ public void start() throws Throwable {\n     }\n \n     @Nullable\n+    @SuppressWarnings(\"unchecked\")\n     public <T extends Task> T getTaskOrNull(int phaseId) {\n-        //noinspection unchecked\n-        return (T) tasksByPhaseId.get(phaseId);\n+        for (Task task : orderedTasks) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2"}, "originalPosition": 152}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzM5NTkz", "url": "https://github.com/crate/crate/pull/10365#pullrequestreview-466739593", "createdAt": "2020-08-13T13:04:00Z", "commit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2NzU4MTY1", "url": "https://github.com/crate/crate/pull/10365#pullrequestreview-466758165", "createdAt": "2020-08-13T13:25:51Z", "commit": {"oid": "4affa7f408cd98ba9491f8a2f6be99a0998e68f2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afeb7eff3b743ae484ac115d29055991e56fb5a5", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/afeb7eff3b743ae484ac115d29055991e56fb5a5", "committedDate": "2020-08-13T13:28:13Z", "message": "Merge branch 'master' into j/tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b5428f745768536005c9114f21fcc3f91f28733", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/3b5428f745768536005c9114f21fcc3f91f28733", "committedDate": "2020-08-13T14:02:49Z", "message": "Merge branch 'master' into j/tasks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3123, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}