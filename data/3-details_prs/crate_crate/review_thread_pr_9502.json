{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMDAxODM2", "number": 9502, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTo0ODowM1rODXfqTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMToyNzoxMVrODYyiqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTYyNTc1OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTo0ODowM1rOFc0aDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTo0ODowM1rOFc0aDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2MzA4NQ==", "bodyText": "I am not really happy with this solution, it smells like MultiActionListener in a bad way. but it is still better than moving 8 lambdas around. Any good idea here ? Could be of course also just an interface with 2 implementation for each result type.", "url": "https://github.com/crate/crate/pull/9502#discussion_r365763085", "createdAt": "2020-01-13T11:48:03Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "diffHunk": "@@ -155,12 +160,78 @@ private static String getLocalNodeId(ClusterService clusterService) {\n         return nodeId;\n     }\n \n-    private static long processShardResponse(ShardResponse shardResponse) {\n+    private static List<Object[]> intialResultRows() {\n+        return new ArrayList<>();\n+    }\n+\n+    private static long initialRowCount() {\n+        return 0L;\n+    }\n+\n+    private static long processRowCount(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::successRowCount);\n+    }\n+\n+    private static long combineRowCounts(long a, long b) {\n+        return a + b;\n+    }\n+\n+    private static Iterable<Row> finishRowCount(Long rowCount) {\n+        return Collections.singletonList(new Row1(rowCount == null ? 0L : rowCount));\n+    }\n+\n+    private static List<Object[]> combineResultRows(List<Object[]> a, List<Object[]> b) {\n+        var result = new ArrayList<Object[]>();\n+        result.addAll(a);\n+        result.addAll(b);\n+        return result;\n+    }\n+\n+    private static Iterable<Row> finishResultRows(List<Object[]> result) {\n+        return Lists2.map(result, RowN::new);\n+    }\n+\n+    private static List<Object[]> processResulRows(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::getResultRows);\n+    }\n+\n+    private static <A> A processResponse(ShardResponse shardResponse, Function<ShardResponse, A> f) {\n         Exception failure = shardResponse.failure();\n         if (failure != null) {\n             Throwables.throwIfUnchecked(failure);\n             throw new RuntimeException(failure);\n         }\n-        return shardResponse.successRowCount();\n+        return f.apply(shardResponse);\n+    }\n+\n+    public static final ResultProcessing<Long> ROW_COUNT_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.initialRowCount(),\n+        ShardDMLExecutor::processRowCount,\n+        ShardDMLExecutor::combineRowCounts,\n+        ShardDMLExecutor::finishRowCount\n+    );\n+\n+    public static final ResultProcessing<List<Object[]>> RESULT_ROW_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.intialResultRows(),\n+        ShardDMLExecutor::processResulRows,\n+        ShardDMLExecutor::combineResultRows,\n+        ShardDMLExecutor::finishResultRows\n+    );\n+\n+    public static class ResultProcessing<Result> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb5aecb8d7a030aeb8a13bc34ae0e47c2ae0c1f"}, "originalPosition": 169}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTYzNDAxOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMTo1MToyM1rOFc0e5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMjo1OTowNVrOFc2DMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2NDMyNQ==", "bodyText": "I don't like it, to return a value of a super class when the current value is null. One solution would be to not extend from DMLProjection and just handle the return types accordingly here.", "url": "https://github.com/crate/crate/pull/9502#discussion_r365764325", "createdAt": "2020-01-13T11:51:23Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "diffHunk": "@@ -118,6 +136,14 @@ public ProjectionType projectionType() {\n         return visitor.visitUpdateProjection(this, context);\n     }\n \n+    @Override\n+    public List<? extends Symbol> outputs() {\n+        if (output == null) {\n+            return super.outputs();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb5aecb8d7a030aeb8a13bc34ae0e47c2ae0c1f"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MDAwMA==", "bodyText": "+1 for not extending DMLProjection", "url": "https://github.com/crate/crate/pull/9502#discussion_r365790000", "createdAt": "2020-01-13T12:59:05Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "diffHunk": "@@ -118,6 +136,14 @@ public ProjectionType projectionType() {\n         return visitor.visitUpdateProjection(this, context);\n     }\n \n+    @Override\n+    public List<? extends Symbol> outputs() {\n+        if (output == null) {\n+            return super.outputs();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2NDMyNQ=="}, "originalCommit": {"oid": "ffb5aecb8d7a030aeb8a13bc34ae0e47c2ae0c1f"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTY2OTUxOnYy", "diffSide": "LEFT", "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMjowNjozMVrOFc00mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMjowNjozMVrOFc00mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc2OTg4MQ==", "bodyText": "My bad, stupid copy paste bug from my last pr.", "url": "https://github.com/crate/crate/pull/9502#discussion_r365769881", "createdAt": "2020-01-13T12:06:31Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "diffHunk": "@@ -82,11 +93,18 @@ public UpdateProjection(StreamInput in) throws IOException {\n         if (allOn4_1) {\n             int returnValuesSize = in.readVInt();\n             if (returnValuesSize > 0) {\n-                returnValues = new Symbol[assignmentsSize];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb5aecb8d7a030aeb8a13bc34ae0e47c2ae0c1f"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTgxMDg4OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzowMTozNVrOFc2HPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzowMTozNVrOFc2HPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MTAzOA==", "bodyText": "In most cases we put the responsibility to built the InputColumn symbols to who-ever is creating the projection and then add an assertion that the symbols in the arguments must not contain Field/Reference. See FilterProjection for an example.", "url": "https://github.com/crate/crate/pull/9502#discussion_r365791038", "createdAt": "2020-01-13T13:01:35Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/dsl/projection/UpdateProjection.java", "diffHunk": "@@ -48,14 +53,20 @@ public UpdateProjection(Symbol uidSymbol,\n                             Symbol[] assignments,\n                             Version version,\n                             @Nullable Symbol[] returnValues,\n+                            @Nullable Field[] output,\n                             @Nullable Long requiredVersion) {\n         super(uidSymbol);\n         this.assignmentsColumns = assignmentsColumns;\n         this.assignments = assignments;\n         this.allOn4_1 = version.onOrAfter(Version.V_4_1_0);\n         this.returnValues = returnValues;\n+        if (output != null) {\n+            this.output = new Symbol[output.length];\n+            for (int i = 0; i < output.length; i++) {\n+                this.output[i] = (new InputColumn(i, output[i].valueType()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada60739fb425e5470fc794c8f39f15aa3b017a8"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI1OTgxNjQxOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzowMzo0OFrOFc2KlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzoxNjo0OFrOFc2gcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MTg5Mw==", "bodyText": "This looks very much like a java.util.stream.Collector, could we maybe utilize something there?", "url": "https://github.com/crate/crate/pull/9502#discussion_r365791893", "createdAt": "2020-01-13T13:03:48Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "diffHunk": "@@ -155,12 +160,78 @@ private static String getLocalNodeId(ClusterService clusterService) {\n         return nodeId;\n     }\n \n-    private static long processShardResponse(ShardResponse shardResponse) {\n+    private static List<Object[]> intialResultRows() {\n+        return new ArrayList<>();\n+    }\n+\n+    private static long initialRowCount() {\n+        return 0L;\n+    }\n+\n+    private static long processRowCount(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::successRowCount);\n+    }\n+\n+    private static long combineRowCounts(long a, long b) {\n+        return a + b;\n+    }\n+\n+    private static Iterable<Row> finishRowCount(Long rowCount) {\n+        return Collections.singletonList(new Row1(rowCount == null ? 0L : rowCount));\n+    }\n+\n+    private static List<Object[]> combineResultRows(List<Object[]> a, List<Object[]> b) {\n+        var result = new ArrayList<Object[]>();\n+        result.addAll(a);\n+        result.addAll(b);\n+        return result;\n+    }\n+\n+    private static Iterable<Row> finishResultRows(List<Object[]> result) {\n+        return Lists2.map(result, RowN::new);\n+    }\n+\n+    private static List<Object[]> processResulRows(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::getResultRows);\n+    }\n+\n+    private static <A> A processResponse(ShardResponse shardResponse, Function<ShardResponse, A> f) {\n         Exception failure = shardResponse.failure();\n         if (failure != null) {\n             Throwables.throwIfUnchecked(failure);\n             throw new RuntimeException(failure);\n         }\n-        return shardResponse.successRowCount();\n+        return f.apply(shardResponse);\n+    }\n+\n+    public static final ResultProcessing<Long> ROW_COUNT_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.initialRowCount(),\n+        ShardDMLExecutor::processRowCount,\n+        ShardDMLExecutor::combineRowCounts,\n+        ShardDMLExecutor::finishRowCount\n+    );\n+\n+    public static final ResultProcessing<List<Object[]>> RESULT_ROW_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.intialResultRows(),\n+        ShardDMLExecutor::processResulRows,\n+        ShardDMLExecutor::combineResultRows,\n+        ShardDMLExecutor::finishResultRows\n+    );\n+\n+    public static class ResultProcessing<Result> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ada60739fb425e5470fc794c8f39f15aa3b017a8"}, "originalPosition": 169}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5NzQ5MQ==", "bodyText": "Great hint \ud83d\udc4d", "url": "https://github.com/crate/crate/pull/9502#discussion_r365797491", "createdAt": "2020-01-13T13:16:48Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "diffHunk": "@@ -155,12 +160,78 @@ private static String getLocalNodeId(ClusterService clusterService) {\n         return nodeId;\n     }\n \n-    private static long processShardResponse(ShardResponse shardResponse) {\n+    private static List<Object[]> intialResultRows() {\n+        return new ArrayList<>();\n+    }\n+\n+    private static long initialRowCount() {\n+        return 0L;\n+    }\n+\n+    private static long processRowCount(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::successRowCount);\n+    }\n+\n+    private static long combineRowCounts(long a, long b) {\n+        return a + b;\n+    }\n+\n+    private static Iterable<Row> finishRowCount(Long rowCount) {\n+        return Collections.singletonList(new Row1(rowCount == null ? 0L : rowCount));\n+    }\n+\n+    private static List<Object[]> combineResultRows(List<Object[]> a, List<Object[]> b) {\n+        var result = new ArrayList<Object[]>();\n+        result.addAll(a);\n+        result.addAll(b);\n+        return result;\n+    }\n+\n+    private static Iterable<Row> finishResultRows(List<Object[]> result) {\n+        return Lists2.map(result, RowN::new);\n+    }\n+\n+    private static List<Object[]> processResulRows(ShardResponse shardResponse) {\n+        return processResponse(shardResponse, ShardResponse::getResultRows);\n+    }\n+\n+    private static <A> A processResponse(ShardResponse shardResponse, Function<ShardResponse, A> f) {\n         Exception failure = shardResponse.failure();\n         if (failure != null) {\n             Throwables.throwIfUnchecked(failure);\n             throw new RuntimeException(failure);\n         }\n-        return shardResponse.successRowCount();\n+        return f.apply(shardResponse);\n+    }\n+\n+    public static final ResultProcessing<Long> ROW_COUNT_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.initialRowCount(),\n+        ShardDMLExecutor::processRowCount,\n+        ShardDMLExecutor::combineRowCounts,\n+        ShardDMLExecutor::finishRowCount\n+    );\n+\n+    public static final ResultProcessing<List<Object[]>> RESULT_ROW_PROCESSING = new ResultProcessing<>(\n+        ShardDMLExecutor.intialResultRows(),\n+        ShardDMLExecutor::processResulRows,\n+        ShardDMLExecutor::combineResultRows,\n+        ShardDMLExecutor::finishResultRows\n+    );\n+\n+    public static class ResultProcessing<Result> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MTg5Mw=="}, "originalCommit": {"oid": "ada60739fb425e5470fc794c8f39f15aa3b017a8"}, "originalPosition": 169}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjkxMTY5OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozOTozMVrOFezenw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTozOTozMVrOFezenw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NTAyMw==", "bodyText": "I think it would be possible to use CollectionBucket here to avoid the copy operation.", "url": "https://github.com/crate/crate/pull/9502#discussion_r367845023", "createdAt": "2020-01-17T09:39:31Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/engine/indexing/ShardDMLExecutor.java", "diffHunk": "@@ -155,12 +166,41 @@ private static String getLocalNodeId(ClusterService clusterService) {\n         return nodeId;\n     }\n \n-    private static long processShardResponse(ShardResponse shardResponse) {\n+    private static <A> A processResponse(ShardResponse shardResponse, Function<ShardResponse, A> f) {\n         Exception failure = shardResponse.failure();\n         if (failure != null) {\n             Throwables.throwIfUnchecked(failure);\n             throw new RuntimeException(failure);\n         }\n-        return shardResponse.successRowCount();\n+        return f.apply(shardResponse);\n+    }\n+\n+    private static Long toRowCount(ShardResponse shardResponse) {\n+        return Long.valueOf(processResponse(shardResponse, ShardResponse::successRowCount));\n+    }\n+\n+    private static List<Object[]> toResultRows(ShardResponse shardResponse) {\n+        List<Object[]> result = processResponse(shardResponse, ShardResponse::getResultRows);\n+        return result == null ? List.of() : result;\n     }\n+\n+    public static final Collector<ShardResponse, long[], Iterable<Row>> ROW_COUNT_COLLECTOR = Collector.of(\n+        () -> new long[]{0L},\n+        (a, b) -> a[0] += toRowCount(b),\n+        (a, b) -> {\n+            a[0] += b[0];\n+            return a;\n+        },\n+        a -> List.of(new Row1(a[0]))\n+    );\n+\n+    public static final Collector<ShardResponse, List<Object[]>, Iterable<Row>> RESULT_ROW_COLLECTOR = Collector.of(\n+        ArrayList::new,\n+        (a, b) -> a.addAll(toResultRows(b)),\n+        (a, b) -> {\n+            a.addAll(b);\n+            return a;\n+        },\n+        a -> Lists2.map(a, RowN::new)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4133de61bb48c67288ff4ea89ed995c79963fa64"}, "originalPosition": 164}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MjkxNjgzOnYy", "diffSide": "RIGHT", "path": "sql/src/test/java/io/crate/integrationtests/UpdateIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0MToyNlrOFezh5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QwOTo0MToyNlrOFezh5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg0NTg2MA==", "bodyText": "Maybe we could also add _seq_no or so to the RETURNING clause here. As that is one of the use cases we want to enable", "url": "https://github.com/crate/crate/pull/9502#discussion_r367845860", "createdAt": "2020-01-17T09:41:26Z", "author": {"login": "mfussenegger"}, "path": "sql/src/test/java/io/crate/integrationtests/UpdateIntegrationTest.java", "diffHunk": "@@ -943,4 +944,52 @@ public void test_update_by_id_where_no_row_is_matching() throws Exception {\n         assertThat(response.cols()[0], is(\"id\"));\n         assertThat(response.rowCount(), is(0L));\n     }\n+\n+    @Test\n+    public void test_update_by_query_returning_single_field_with_outputputname() throws Exception {\n+        execute(\"create table test (id int primary key, message string) clustered into 2 shards\");\n+        execute(\"insert into test values(1, 'msg');\");\n+        assertEquals(1, response.rowCount());\n+        refresh();\n+\n+        execute(\"update test set message='updated' where message='msg' returning message as message_renamed\");\n+\n+        assertThat((response.rowCount()), is(1L));\n+        assertThat((response.cols()[0]), is(\"message_renamed\"));\n+        assertThat(response.rows()[0][0], is(\"updated\"));\n+    }\n+\n+\n+    @Test\n+    public void test_update_by_query_with_subquery_returning_multiple_fields() throws Exception {\n+        execute(\"create table test (id int primary key, message string) clustered into 2 shards\");\n+        execute(\"insert into test values(1, 'msg');\");\n+        assertEquals(1, response.rowCount());\n+        refresh();\n+\n+        execute(\"update test set message='updated' where message= (select 'msg') returning id, message\");\n+\n+        assertThat((response.rowCount()), is(1L));\n+        assertThat((response.cols()[0]), is(\"id\"));\n+        assertThat((response.cols()[1]), is(\"message\"));\n+        assertThat(response.rows()[0][0], is(1));\n+        assertThat(response.rows()[0][1], is(\"updated\"));\n+\n+    }\n+\n+    @Test\n+    public void test_update_by_query_returning_multiple_results() throws Exception {\n+        execute(\"create table test (id int primary key, x int, message string) clustered into 2 shards\");\n+        execute(\"insert into test values(1, 1, 'msg');\");\n+        execute(\"insert into test values(2, 1, 'msg');\");\n+        assertEquals(1, response.rowCount());\n+        refresh();\n+\n+        execute(\"update test set message='updated' where message='msg' and x > 0 returning message as message_renamed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4133de61bb48c67288ff4ea89ed995c79963fa64"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3MzIwNDg4OnYy", "diffSide": "RIGHT", "path": "sql/src/test/java/io/crate/integrationtests/UpdateIntegrationTest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMToyNzoxMVrOFe2SOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMTozNToxNFrOFe2dmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg5MTAwMw==", "bodyText": "Shouldn't this be > 0, as _seq_no starts out at 0 initially?", "url": "https://github.com/crate/crate/pull/9502#discussion_r367891003", "createdAt": "2020-01-17T11:27:11Z", "author": {"login": "mfussenegger"}, "path": "sql/src/test/java/io/crate/integrationtests/UpdateIntegrationTest.java", "diffHunk": "@@ -985,11 +985,20 @@ public void test_update_by_query_returning_multiple_results() throws Exception {\n         assertEquals(1, response.rowCount());\n         refresh();\n \n-        execute(\"update test set message='updated' where message='msg' and x > 0 returning message as message_renamed\");\n+        execute(\"update test set message='updated' where message='msg' and x > 0 \" +\n+                \"returning _docid, _seq_no as seq, message as message_renamed\");\n \n-        assertThat((response.rowCount()), is(2L ));\n-        assertThat((response.cols()[0]), is(\"message_renamed\"));\n-        assertThat(response.rows()[0][0], is(\"updated\"));\n-        assertThat(response.rows()[1][0], is(\"updated\"));\n+        assertThat((response.rowCount()), is(2L));\n+        assertThat((response.cols()[0]), is(\"_docid\"));\n+        assertThat((response.cols()[1]), is(\"seq\"));\n+        assertThat((response.cols()[2]), is(\"message_renamed\"));\n+\n+        assertThat(response.rows()[0][0], is(0));\n+        assertThat(response.rows()[0][1], is(0L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b39d14915c5259eac9875afbd6c6db0adcaa7e4"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg5MzkxMw==", "bodyText": "Good point and nice catch. The return values are actually generated before, the seq_no is incremented which is wrong. This is needs to be fixed. Thank you!", "url": "https://github.com/crate/crate/pull/9502#discussion_r367893913", "createdAt": "2020-01-17T11:35:14Z", "author": {"login": "mkleen"}, "path": "sql/src/test/java/io/crate/integrationtests/UpdateIntegrationTest.java", "diffHunk": "@@ -985,11 +985,20 @@ public void test_update_by_query_returning_multiple_results() throws Exception {\n         assertEquals(1, response.rowCount());\n         refresh();\n \n-        execute(\"update test set message='updated' where message='msg' and x > 0 returning message as message_renamed\");\n+        execute(\"update test set message='updated' where message='msg' and x > 0 \" +\n+                \"returning _docid, _seq_no as seq, message as message_renamed\");\n \n-        assertThat((response.rowCount()), is(2L ));\n-        assertThat((response.cols()[0]), is(\"message_renamed\"));\n-        assertThat(response.rows()[0][0], is(\"updated\"));\n-        assertThat(response.rows()[1][0], is(\"updated\"));\n+        assertThat((response.rowCount()), is(2L));\n+        assertThat((response.cols()[0]), is(\"_docid\"));\n+        assertThat((response.cols()[1]), is(\"seq\"));\n+        assertThat((response.cols()[2]), is(\"message_renamed\"));\n+\n+        assertThat(response.rows()[0][0], is(0));\n+        assertThat(response.rows()[0][1], is(0L));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Nzg5MTAwMw=="}, "originalCommit": {"oid": "0b39d14915c5259eac9875afbd6c6db0adcaa7e4"}, "originalPosition": 18}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1104, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}