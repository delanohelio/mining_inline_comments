{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNDkwOTc2", "number": 10070, "title": "Convert arithmetic scalars to new signature registry", "bodyText": "Summary of the changes / Why this improves CrateDB\nBy using signature matching of arithmetic scalars, arithmetic data type\nselection is based on precedence and thus fixes existing issues for\nfloating point arithmetics.\nOperations on non-floating point column types with a floating point\nliteral will result in a floating point result now.\nFixes #9652\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-06-10T14:21:47Z", "url": "https://github.com/crate/crate/pull/10070", "merged": true, "mergeCommit": {"oid": "3f82d992ffc9c1b28c4414ba9ebee5820f329393"}, "closed": true, "closedAt": "2020-06-10T15:54:33Z", "author": {"login": "seut"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp6aqyAH2gAyNDMyNDkwOTc2OjZlNTkwMTIwMzVlMzUzM2QyODYwYjRhM2JmY2VjNWJkY2U3YjBlYmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp8vJtgFqTQyODI1ODI5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/6e59012035e3533d2860b4a3bfcec5bdce7b0ebd", "committedDate": "2020-06-10T14:20:36Z", "message": "Convert arithmetic scalars to new signature registry\n\nBy using signature matching of arithmetic scalars, arithmetic data type\nselection is based on precedence and thus fixes existing issues for\nfloating point arithmetics.\nOperations on non-floating point column types with a floating point\nliteral will result in a floating point result now.\n\nFixes #9652"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTA2MTE1", "url": "https://github.com/crate/crate/pull/10070#pullrequestreview-428106115", "createdAt": "2020-06-10T14:23:00Z", "commit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoyMzowMFrOGh3SRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDoyMzowMFrOGh3SRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE2MTk4OA==", "bodyText": "checkstyle forced me to add this weird indention, don't know why :(", "url": "https://github.com/crate/crate/pull/10070#discussion_r438161988", "createdAt": "2020-06-10T14:23:00Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/expression/scalar/arithmetic/ArithmeticFunctions.java", "diffHunk": "@@ -64,158 +44,130 @@\n         public static final String MOD = \"mod\";\n     }\n \n-    public static void register(ScalarFunctionModule module) {\n-        module.register(Names.ADD, new ArithmeticFunctionResolver(\n-            Names.ADD,\n-            \"+\",\n+    private enum Operations {\n+        ADD(\n             FunctionInfo.DETERMINISTIC_AND_COMPARISON_REPLACEMENT,\n             Math::addExact,\n             Double::sum,\n             Math::addExact,\n             Float::sum\n-        ));\n-        module.register(Names.SUBTRACT, new ArithmeticFunctionResolver(\n-            Names.SUBTRACT,\n-            \"-\",\n+        ),\n+        SUBTRACT(\n             FunctionInfo.DETERMINISTIC_ONLY,\n             Math::subtractExact,\n-            (arg0, arg1) -> arg0 - arg1,\n+                (arg0, arg1) -> arg0 - arg1,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd"}, "originalPosition": 64}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTQxODk0", "url": "https://github.com/crate/crate/pull/10070#pullrequestreview-428141894", "createdAt": "2020-06-10T14:56:30Z", "commit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNDo1NjozMFrOGh47TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNTowNjoyOVrOGh5Xqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE4ODg3Nw==", "bodyText": "do we still need to check whether the intersecting from and to type parameters are compatible or the size check would be enough?", "url": "https://github.com/crate/crate/pull/10070#discussion_r438188877", "createdAt": "2020-06-10T14:56:30Z", "author": {"login": "kovrus"}, "path": "server/src/main/java/io/crate/types/TypeCompatibility.java", "diffHunk": "@@ -92,6 +92,9 @@\n         List<DataType<?>> toTypeParameters = toType.getTypeParameters();\n \n         if (fromTypeParameters.size() != toTypeParameters.size()) {\n+            if (fromType.id() == ObjectType.ID && toType.id() == ObjectType.ID) {\n+                return fromTypeParameters.size() > toTypeParameters.size() ? fromType : toType;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODE5NjEzOQ==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/crate/crate/pull/10070#discussion_r438196139", "createdAt": "2020-06-10T15:06:29Z", "author": {"login": "kovrus"}, "path": "server/src/test/java/io/crate/analyze/CreateAlterTableStatementAnalyzerTest.java", "diffHunk": "@@ -1027,7 +1027,7 @@ public void testCreateTableGeneratedColumnWithCast() {\n         Map<String, String> generatedColumnsMapping = (Map<String, String>) metaMapping.get(\"generated_columns\");\n         assertThat(\n             generatedColumnsMapping.get(\"day\"),\n-            is(\"_cast((_cast(ts, 'bigint') + 1::bigint), 'timestamp with time zone')\"));\n+            is(\"(ts + 1::bigint)\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e59012035e3533d2860b4a3bfcec5bdce7b0ebd"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be67de2d065da8c9639a2b59e4a92960857f6b1a", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/be67de2d065da8c9639a2b59e4a92960857f6b1a", "committedDate": "2020-06-10T15:23:57Z", "message": "Merge branch 'master' into s/arithmetic-functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MjU4Mjk3", "url": "https://github.com/crate/crate/pull/10070#pullrequestreview-428258297", "createdAt": "2020-06-10T17:02:47Z", "commit": {"oid": "be67de2d065da8c9639a2b59e4a92960857f6b1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNzowMjo0N1rOGh-UNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxNzowMjo0N1rOGh-UNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODI3NzE3NA==", "bodyText": "Could we move this to the changes?  We're not going to backport it.", "url": "https://github.com/crate/crate/pull/10070#discussion_r438277174", "createdAt": "2020-06-10T17:02:47Z", "author": {"login": "mfussenegger"}, "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -218,4 +218,6 @@ Performance improvements\n Fixes\n =====\n \n-None\n+- Fixed arithmetics containing a non-floating numeric column type and a", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be67de2d065da8c9639a2b59e4a92960857f6b1a"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3262, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}