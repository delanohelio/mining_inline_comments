{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MjE0Nzc3", "number": 9808, "title": "Refactor UDF scalars to use new function registry.", "bodyText": "Summary of the changes / Why this improves CrateDB\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-03-26T14:44:36Z", "url": "https://github.com/crate/crate/pull/9808", "merged": true, "mergeCommit": {"oid": "d3b834f96a354b7b05049f29dabf402133059e67"}, "closed": true, "closedAt": "2020-03-27T10:27:34Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRdae1ABqjMxNjg2NDYxNzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRtp-LABqjMxNzE2OTg0NTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4c4b6ebfd5885240b65bbd6fd13317609045be79", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/4c4b6ebfd5885240b65bbd6fd13317609045be79", "committedDate": "2020-03-26T14:43:13Z", "message": "Refactor UDF scalars to use new function registry."}, "afterCommit": {"oid": "95b171a8512dfaed49473ec536308e77ba79edfd", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/95b171a8512dfaed49473ec536308e77ba79edfd", "committedDate": "2020-03-26T14:58:23Z", "message": "Refactor UDF scalars to use new function registry."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "95b171a8512dfaed49473ec536308e77ba79edfd", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/95b171a8512dfaed49473ec536308e77ba79edfd", "committedDate": "2020-03-26T14:58:23Z", "message": "Refactor UDF scalars to use new function registry."}, "afterCommit": {"oid": "15cc833f76342cac920b7e688cbd1cc84271bf98", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/15cc833f76342cac920b7e688cbd1cc84271bf98", "committedDate": "2020-03-26T21:06:07Z", "message": "Refactor UDF scalars to use new function registry."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNjg5MzMz", "url": "https://github.com/crate/crate/pull/9808#pullrequestreview-382689333", "createdAt": "2020-03-27T09:17:40Z", "commit": {"oid": "15cc833f76342cac920b7e688cbd1cc84271bf98"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToxNzo0MFrOF8o3cg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QwOToyMzowOFrOF8pDsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEyODQzNA==", "bodyText": "I'd prefer using this style for improved readability, but maybe thats more a personal preference:\nList<FuncResolver> resolvers = implementations.computeIfAbsent(functionName, new ArrayList<>());\nresolvers.add(udfService.buildFunctionResolver(udf));", "url": "https://github.com/crate/crate/pull/9808#discussion_r399128434", "createdAt": "2020-03-27T09:17:40Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/udf/UserDefinedFunctionService.java", "diffHunk": "@@ -195,22 +199,49 @@ UserDefinedFunctionsMetaData removeFunction(@Nullable UserDefinedFunctionsMetaDa\n         }\n     }\n \n-    public void updateImplementations(String schema, Stream<UserDefinedFunctionMetaData> userDefinedFunctions) {\n-        functions.registerUdfResolversForSchema(schema, constructScalarInstances(userDefinedFunctions));\n-    }\n \n-    private Map<FunctionIdent, FunctionImplementation> constructScalarInstances(Stream<UserDefinedFunctionMetaData> functions) {\n-        Iterator<UserDefinedFunctionMetaData> it = functions.iterator();\n-        Map<FunctionIdent, FunctionImplementation> implementationsByIdent = new HashMap<>();\n+    public void updateImplementations(String schema, Stream<UserDefinedFunctionMetaData> userDefinedFunctions) {\n+        final Map<FunctionName, List<FuncResolver>> implementations = new HashMap<>();\n+        Iterator<UserDefinedFunctionMetaData> it = userDefinedFunctions.iterator();\n         while (it.hasNext()) {\n-            UserDefinedFunctionMetaData udfMetaData = it.next();\n-            try {\n-                Scalar scalar = getLanguage(udfMetaData.language()).createFunctionImplementation(udfMetaData);\n-                implementationsByIdent.put(scalar.info().ident(), scalar);\n-            } catch (ScriptException | IllegalArgumentException e) {\n-                LOGGER.warn(\"Can't create user defined function: \" + udfMetaData.specificName(), e);\n+            UserDefinedFunctionMetaData udf = it.next();\n+            FuncResolver resolver = buildFunctionResolver(udf);\n+            if (resolver == null) {\n+                continue;\n             }\n+            implementations.compute(\n+                new FunctionName(udf.schema(), udf.name()),\n+                (key, resolvers) -> {\n+                    if (resolvers == null) {\n+                        resolvers = new ArrayList<>();\n+                    }\n+                    resolvers.add(resolver);\n+                    return resolvers;\n+                });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc833f76342cac920b7e688cbd1cc84271bf98"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTEzMTU3MA==", "bodyText": "I thinks this is fine, but a comment here would be helpful.", "url": "https://github.com/crate/crate/pull/9808#discussion_r399131570", "createdAt": "2020-03-27T09:23:08Z", "author": {"login": "seut"}, "path": "sql/src/test/java/io/crate/integrationtests/SQLTransportIntegrationTest.java", "diffHunk": "@@ -610,7 +612,9 @@ public void assertFunctionIsDeletedOnAll(String schema, String name, List<DataTy\n             Iterable<Functions> functions = internalCluster().getInstances(Functions.class);\n             for (Functions function : functions) {\n                 FunctionImplementation func = function.getQualified(new FunctionIdent(schema, name, argTypes));\n-                assertThat(func, Matchers.nullValue());\n+                if (func != null) {\n+                    assertThat(func.info().ident().argumentTypes(), not(contains(argTypes)));\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15cc833f76342cac920b7e688cbd1cc84271bf98"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNzE0NDQ2", "url": "https://github.com/crate/crate/pull/9808#pullrequestreview-382714446", "createdAt": "2020-03-27T09:53:35Z", "commit": {"oid": "f7b4b9ad4e5c20952cd88debc8c28bf373e9657f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73d0cd763a4c5538f71a2794e3505607bdfab3ce", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/73d0cd763a4c5538f71a2794e3505607bdfab3ce", "committedDate": "2020-03-27T09:54:11Z", "message": "Refactor UDF scalars to use new function registry."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7b4b9ad4e5c20952cd88debc8c28bf373e9657f", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/f7b4b9ad4e5c20952cd88debc8c28bf373e9657f", "committedDate": "2020-03-27T09:48:56Z", "message": "fixup! Refactor UDF scalars to use new function registry."}, "afterCommit": {"oid": "73d0cd763a4c5538f71a2794e3505607bdfab3ce", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/73d0cd763a4c5538f71a2794e3505607bdfab3ce", "committedDate": "2020-03-27T09:54:11Z", "message": "Refactor UDF scalars to use new function registry."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3452, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}