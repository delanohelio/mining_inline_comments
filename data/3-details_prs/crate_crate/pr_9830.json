{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NzMyMTMz", "number": 9830, "title": "Use BlockBasedRamAccounting for nested loop & hash join", "bodyText": "Summary of the changes / Why this improves CrateDB\nUsing\ngit bisect run cr8 run-crate . \\\n  -- run-spec $HOME/dev/crate/crate-benchmarks/specs/joins.toml '{node.http_url}' --fail-if '{runtime_stats.mean} > 20'\n\nPointed to d6f959c\nas the cause for a performance regression. Turns out that using\nConcurrentRamAccounting directly per row is expensive.\n# Results (server side duration in ms)\nV1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\nV2: 4.2.0-21a155bf0387798958bf6eaf2c27585784cea62f\n\nQ: select * from articles CROSS JOIN colors limit 1 offset 10000\nC: 1\n| Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n|   V1    |       61.793 \u00b1   10.154 |     39.975 |     60.937 |     63.207 |    176.193 |\n|   V2    |       13.667 \u00b1    8.858 |     10.774 |     12.397 |     13.342 |    133.641 |\nmean:   - 127.55%\nmedian: - 132.38%\nLikely significant\n\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-03-30T15:37:42Z", "url": "https://github.com/crate/crate/pull/9830", "merged": true, "mergeCommit": {"oid": "f4d143f4e615f9247a02aa36ac237c320528d58a"}, "closed": true, "closedAt": "2020-03-31T10:19:42Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcSwYZygFqTM4Mzk4MjMzNQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcS_6e4gBqjMxODI0NDk5ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTgyMzM1", "url": "https://github.com/crate/crate/pull/9830#pullrequestreview-383982335", "createdAt": "2020-03-30T15:38:48Z", "commit": {"oid": "6aeab12859cd4839c406de1a06d721ea6402864c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTozODo0OVrOF9v38g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTozODo0OVrOF9v38g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTgyNg==", "bodyText": "Not sure why there was a special exception for blockNestedLoop. To me it seems like there is also a single thread that uses the ramAccounting instance.", "url": "https://github.com/crate/crate/pull/9830#discussion_r400291826", "createdAt": "2020-03-30T15:38:49Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/jobs/JobSetup.java", "diffHunk": "@@ -883,7 +883,7 @@ public Boolean visitNestedLoopPhase(NestedLoopPhase phase, Context context) {\n                 joinCondition,\n                 phase.joinType(),\n                 breaker(),\n-                phase.blockNestedLoop ? ramAccounting : ramAccountingOfOperation,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6aeab12859cd4839c406de1a06d721ea6402864c"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0d2624c739a8e456db99e53891416196c06c7f4", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/a0d2624c739a8e456db99e53891416196c06c7f4", "committedDate": "2020-03-30T16:48:40Z", "message": "Use BlockBasedRamAccounting for HashJoin operation"}, "afterCommit": {"oid": "db9499f557e3574d8a58aa295f5cae76d43986b0", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/db9499f557e3574d8a58aa295f5cae76d43986b0", "committedDate": "2020-03-30T16:56:13Z", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db9499f557e3574d8a58aa295f5cae76d43986b0", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/db9499f557e3574d8a58aa295f5cae76d43986b0", "committedDate": "2020-03-30T16:56:13Z", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%"}, "afterCommit": {"oid": "abe0e8e94a954a524ee5d963b4918710319fd7a1", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/abe0e8e94a954a524ee5d963b4918710319fd7a1", "committedDate": "2020-03-30T17:00:00Z", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NTE1NjAw", "url": "https://github.com/crate/crate/pull/9830#pullrequestreview-384515600", "createdAt": "2020-03-31T08:36:20Z", "commit": {"oid": "abe0e8e94a954a524ee5d963b4918710319fd7a1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODozNjoyMFrOF-LDjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwODozNjoyMFrOF-LDjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczNzE2Ng==", "bodyText": "Maybe it was just a mistake by me? I agree that only 1 thread will use it concurrently.", "url": "https://github.com/crate/crate/pull/9830#discussion_r400737166", "createdAt": "2020-03-31T08:36:20Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/execution/jobs/JobSetup.java", "diffHunk": "@@ -883,7 +883,7 @@ public Boolean visitNestedLoopPhase(NestedLoopPhase phase, Context context) {\n                 joinCondition,\n                 phase.joinType(),\n                 breaker(),\n-                phase.blockNestedLoop ? ramAccounting : ramAccountingOfOperation,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI5MTgyNg=="}, "originalCommit": {"oid": "6aeab12859cd4839c406de1a06d721ea6402864c"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f89cfc07ae851592635f15ca9d921c49dca4c26", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/2f89cfc07ae851592635f15ca9d921c49dca4c26", "committedDate": "2020-03-31T09:44:28Z", "message": "Use BlockBasedRamAccounting for nested loop\n\nUsing `ConcurrentRamAccounting` per row is expensive:\n\n    # Results (server side duration in ms)\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-21a155bf0387798958bf6eaf2c27585784cea62f\n\n    Q: select * from articles CROSS JOIN colors limit 1 offset 10000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |       61.793 \u00b1   10.154 |     39.975 |     60.937 |     63.207 |    176.193 |\n    |   V2    |       13.667 \u00b1    8.858 |     10.774 |     12.397 |     13.342 |    133.641 |\n    mean:   - 127.55%\n    median: - 132.38%\n    Likely significant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "committedDate": "2020-03-31T09:44:28Z", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "52dd1f69cef75b26244db8420282e8b7096913bc", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/52dd1f69cef75b26244db8420282e8b7096913bc", "committedDate": "2020-03-31T08:38:57Z", "message": "Merge branch 'master' into j/nl-ram-accounting"}, "afterCommit": {"oid": "48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/48ffbaaa8acd5cb4265049d96b4dc8d7dd08c4c4", "committedDate": "2020-03-31T09:44:28Z", "message": "Use BlockBasedRamAccounting for HashJoin operation\n\n    V1: 4.2.0-ac8af037f046b1a7c8a8167dea4d6381348e1c8a\n    V2: 4.2.0-a0d2624c739a8e456db99e53891416196c06c7f4\n\n    Q: select * from articles inner join colors on articles.id = colors.id order by articles.id limit 1000\n    C: 1\n    | Version |         Mean \u00b1    Stdev |        Min |     Median |         Q3 |        Max |\n    |   V1    |      129.933 \u00b1   26.256 |     91.958 |    125.718 |    128.930 |    347.124 |\n    |   V2    |      100.603 \u00b1   31.283 |     63.374 |     94.106 |     99.388 |    422.406 |\n    mean:   -  25.45%\n    median: -  28.76%"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3465, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}