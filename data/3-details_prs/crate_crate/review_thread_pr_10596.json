{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyOTc5MjU2", "number": 10596, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NToxMlrOEnbBIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NTo0M1rOEnbBxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NzcyNTc4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NToxMlrOHYAR5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NToxMlrOHYAR5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjQ1Mg==", "bodyText": "The transport and request is new in 4.3 and wasn't present in 4.2 so the check here can be removed.\nThere is logic in place to avoid using the transport if not all nodes are on 4.3", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932452", "createdAt": "2020-09-25T11:45:12Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NzcyNzQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NTo0M1rOHYAS3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMjoyODoxNlrOHYBi4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjcwMQ==", "bodyText": "There is no production code call-site where phase1 is set to true, is that intentional?", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932701", "createdAt": "2020-09-25T11:45:43Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n+                phase1 = in.readBoolean();\n+            } else {\n+                phase1 = false;\n+            }\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n-        public ShardRequest(ShardId shardId, ClusterBlock clusterBlock) {\n+        public ShardRequest(ShardId shardId, boolean phase1, ClusterBlock clusterBlock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDk1MzE4NA==", "bodyText": "seems like https://github.com/crate/crate/pull/10596/files/5ae6cb27d9b7c7c64180229942ca21d11c310741#diff-191de78233c863150a9abf36a805ea7cL555 had to be done in two steps, first sending requests with phase1 and once the (persisted) local checkpoint is advanced we send another request with phase1 false. See https://github.com/elastic/elasticsearch/pull/43205/files#diff-6f976d9c43872a6dcd26e027a1667aaaR396-R411\nI'll update it then", "url": "https://github.com/crate/crate/pull/10596#discussion_r494953184", "createdAt": "2020-09-25T12:28:16Z", "author": {"login": "kovrus"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n+                phase1 = in.readBoolean();\n+            } else {\n+                phase1 = false;\n+            }\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n-        public ShardRequest(ShardId shardId, ClusterBlock clusterBlock) {\n+        public ShardRequest(ShardId shardId, boolean phase1, ClusterBlock clusterBlock) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjcwMQ=="}, "originalCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "originalPosition": 64}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1023, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}