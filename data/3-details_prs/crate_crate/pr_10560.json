{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMjMyMDY2", "number": 10560, "title": "Ensure searchers are always closed", "bodyText": "Summary of the changes / Why this improves CrateDB\nkill/start had race conditions due to the change of createIterator being async.\naddSearcher could also be called after a kill in which case it might add searchers which are never released.\nThe changes in this PR should fix both these issues\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-09-21T11:39:12Z", "url": "https://github.com/crate/crate/pull/10560", "merged": true, "mergeCommit": {"oid": "1690fed9daf694e4a30142b0fa914cd9b4fa3643"}, "closed": true, "closedAt": "2020-09-29T10:41:31Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNPe91gBqjM4MTMzMzk1Mzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNlRixABqjM4MTg2Mzk3NzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7b0d192ead7f043b330531cd9a52e866bda56b8f", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/7b0d192ead7f043b330531cd9a52e866bda56b8f", "committedDate": "2020-09-21T11:38:50Z", "message": "fixup! WIP"}, "afterCommit": {"oid": "0129151634e5276e0e45672fcb7ce18e8b8de240", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0129151634e5276e0e45672fcb7ce18e8b8de240", "committedDate": "2020-09-28T08:40:31Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0129151634e5276e0e45672fcb7ce18e8b8de240", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0129151634e5276e0e45672fcb7ce18e8b8de240", "committedDate": "2020-09-28T08:40:31Z", "message": "Ensure searchers are always closed"}, "afterCommit": {"oid": "c03518256ef7c61ba0c4194501b3a741d7b0e615", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/c03518256ef7c61ba0c4194501b3a741d7b0e615", "committedDate": "2020-09-28T08:54:56Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c03518256ef7c61ba0c4194501b3a741d7b0e615", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/c03518256ef7c61ba0c4194501b3a741d7b0e615", "committedDate": "2020-09-28T08:54:56Z", "message": "Ensure searchers are always closed"}, "afterCommit": {"oid": "89c5715bac0ae624acc8b85378d1a50654609055", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/89c5715bac0ae624acc8b85378d1a50654609055", "committedDate": "2020-09-28T09:03:32Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89c5715bac0ae624acc8b85378d1a50654609055", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/89c5715bac0ae624acc8b85378d1a50654609055", "committedDate": "2020-09-28T09:03:32Z", "message": "Ensure searchers are always closed"}, "afterCommit": {"oid": "02fdd142c367fc3345b6b642bac79266abd4f022", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/02fdd142c367fc3345b6b642bac79266abd4f022", "committedDate": "2020-09-28T09:22:21Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a06d6fdda3493917bbe1e7f74b9d5777c6d22ce7", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/a06d6fdda3493917bbe1e7f74b9d5777c6d22ce7", "committedDate": "2020-09-28T13:49:33Z", "message": "WIP"}, "afterCommit": {"oid": "98990383bc1133ef7011acb126ae1d7a2a2e3a1e", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/98990383bc1133ef7011acb126ae1d7a2a2e3a1e", "committedDate": "2020-09-28T14:10:19Z", "message": "WIP"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "98990383bc1133ef7011acb126ae1d7a2a2e3a1e", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/98990383bc1133ef7011acb126ae1d7a2a2e3a1e", "committedDate": "2020-09-28T14:10:19Z", "message": "WIP"}, "afterCommit": {"oid": "989c608f84b60be7aada9111e3c5874bc459e8db", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/989c608f84b60be7aada9111e3c5874bc459e8db", "committedDate": "2020-09-28T14:28:08Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "989c608f84b60be7aada9111e3c5874bc459e8db", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/989c608f84b60be7aada9111e3c5874bc459e8db", "committedDate": "2020-09-28T14:28:08Z", "message": "Ensure searchers are always closed"}, "afterCommit": {"oid": "dd95d6925152f214fba9d086ddb65332e8f4f4ae", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/dd95d6925152f214fba9d086ddb65332e8f4f4ae", "committedDate": "2020-09-28T14:29:54Z", "message": "Ensure searchers are always closed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NTc3NTEz", "url": "https://github.com/crate/crate/pull/10560#pullrequestreview-497577513", "createdAt": "2020-09-28T14:35:43Z", "commit": {"oid": "dd95d6925152f214fba9d086ddb65332e8f4f4ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDozNTo0M1rOHZAsBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxNDozNTo0M1rOHZAsBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTk4NzcxNg==", "bodyText": "Replaced this with multiple test_kill_after_start variants - see further below", "url": "https://github.com/crate/crate/pull/10560#discussion_r495987716", "createdAt": "2020-09-28T14:35:43Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/execution/engine/collect/CollectTaskTest.java", "diffHunk": "@@ -94,58 +115,10 @@ public void testAddingSameContextTwice() throws Exception {\n             assertFalse(true); // second addContext call should have raised an exception\n         } catch (IllegalArgumentException e) {\n             verify(mock1, times(1)).close();\n-            verify(mock2, times(1)).close();\n+            verify(mock2, times(0)).close(); // would be closed via `kill` on the context\n         }\n     }\n \n-    @Test\n-    public void testInnerCloseClosesSearchContexts() throws Exception {\n-        RefCountedItem mock1 = mock(RefCountedItem.class);\n-        RefCountedItem mock2 = mock(RefCountedItem.class);\n-\n-        collectTask.addSearcher(1, mock1);\n-        collectTask.addSearcher(2, mock2);\n-\n-        collectTask.innerClose();\n-\n-        verify(mock1, times(1)).close();\n-        verify(mock2, times(1)).close();\n-    }\n-\n-    @Test\n-    public void testKillOnJobCollectContextPropagatesToCrateCollectors() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd95d6925152f214fba9d086ddb65332e8f4f4ae"}, "originalPosition": 131}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7eb07d1e3c58c297c23cdd79c3fc714351e46ce1", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/7eb07d1e3c58c297c23cdd79c3fc714351e46ce1", "committedDate": "2020-09-28T15:35:55Z", "message": "fixup! Ensure searchers are always closed"}, "afterCommit": {"oid": "2d53eb8fb7bb37ece300f10a5467d744fa3dd28e", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/2d53eb8fb7bb37ece300f10a5467d744fa3dd28e", "committedDate": "2020-09-28T15:43:30Z", "message": "fixup! Ensure searchers are always closed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4Mjk0NDU5", "url": "https://github.com/crate/crate/pull/10560#pullrequestreview-498294459", "createdAt": "2020-09-29T09:44:20Z", "commit": {"oid": "2d53eb8fb7bb37ece300f10a5467d744fa3dd28e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOTo0NDoyMFrOHZlFKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwOTo1MDo1NVrOHZlVpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4Mzk3Ng==", "bodyText": "shouldn't this be volatile as it may be read and written from different threads?", "url": "https://github.com/crate/crate/pull/10560#discussion_r496583976", "createdAt": "2020-09-29T09:44:20Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/execution/engine/collect/CollectTask.java", "diffHunk": "@@ -60,16 +64,20 @@\n     private final SharedShardContexts sharedShardContexts;\n \n     private final IntObjectHashMap<RefCountedItem<? extends IndexSearcher>> searchers = new IntObjectHashMap<>();\n-    private final Object subContextLock = new Object();\n     private final RowConsumer consumer;\n     private final int ramAccountingBlockSizeInBytes;\n+\n+    @GuardedBy(\"searchers\")\n     private final ArrayList<MemoryManager> memoryManagers = new ArrayList<>();\n     private final Version minNodeVersion;\n+    private final CompletableFuture<Void> consumerCompleted;\n+    private final CompletableFuture<BatchIterator<Row>> batchIterator = new CompletableFuture<>();\n+    private final AtomicBoolean started = new AtomicBoolean(false);\n \n-    private BatchIterator<Row> batchIterator = null;\n+    private boolean releasedResources = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d53eb8fb7bb37ece300f10a5467d744fa3dd28e"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjU4ODE5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // the atomicBoolean call is not enough, because without syncronization\n          \n          \n            \n                    // an atomicBoolean call would not be enough, because without syncronization", "url": "https://github.com/crate/crate/pull/10560#discussion_r496588197", "createdAt": "2020-09-29T09:50:55Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/execution/engine/collect/CollectTask.java", "diffHunk": "@@ -212,10 +261,24 @@ static String threadPoolName(CollectPhase phase, boolean involvedIO) {\n \n     public MemoryManager memoryManager() {\n         MemoryManager memoryManager = memoryManagerFactory.apply(ramAccounting);\n-        synchronized (memoryManagers) {\n-            memoryManagers.add(memoryManager);\n+        // the atomicBoolean call is not enough, because without syncronization", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2d53eb8fb7bb37ece300f10a5467d744fa3dd28e"}, "originalPosition": 269}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174590f0ccd968684fef26f996e1618b8eb12d80", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/174590f0ccd968684fef26f996e1618b8eb12d80", "committedDate": "2020-09-29T10:03:45Z", "message": "Ensure searchers are always closed"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2d53eb8fb7bb37ece300f10a5467d744fa3dd28e", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/2d53eb8fb7bb37ece300f10a5467d744fa3dd28e", "committedDate": "2020-09-28T15:43:30Z", "message": "fixup! Ensure searchers are always closed"}, "afterCommit": {"oid": "174590f0ccd968684fef26f996e1618b8eb12d80", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/174590f0ccd968684fef26f996e1618b8eb12d80", "committedDate": "2020-09-29T10:03:45Z", "message": "Ensure searchers are always closed"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3772, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}