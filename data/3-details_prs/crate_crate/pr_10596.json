{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyOTc5MjU2", "number": 10596, "title": "Port over TransportVerifyShardBeforeCloseActionTests and missing \"advance checkpoints only after persisting ops\" logic in TransportVerifyShardBeforeCloseActionT", "bodyText": "Summary of the changes / Why this improves CrateDB\nSee commits.\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-09-25T10:24:13Z", "url": "https://github.com/crate/crate/pull/10596", "merged": true, "mergeCommit": {"oid": "258b015b569f6be146d865b70e8d2af5008ebb11"}, "closed": true, "closedAt": "2020-09-28T09:07:52Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMTMJ-ABqjM4MDcwNzI2NjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNPX-kgBqjM4MTMzMDc2MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1ce3ef57ae10d04e2d0622edcb9bb17ec7354ac4", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/1ce3ef57ae10d04e2d0622edcb9bb17ec7354ac4", "committedDate": "2020-09-25T10:23:15Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}, "afterCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/5ae6cb27d9b7c7c64180229942ca21d11c310741", "committedDate": "2020-09-25T10:25:38Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2MzQ2MTE1", "url": "https://github.com/crate/crate/pull/10596#pullrequestreview-496346115", "createdAt": "2020-09-25T11:45:12Z", "commit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NToxMlrOHYAR5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxMTo0NTo0M1rOHYAS3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjQ1Mg==", "bodyText": "The transport and request is new in 4.3 and wasn't present in 4.2 so the check here can be removed.\nThere is logic in place to avoid using the transport if not all nodes are on 4.3", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932452", "createdAt": "2020-09-25T11:45:12Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDkzMjcwMQ==", "bodyText": "There is no production code call-site where phase1 is set to true, is that intentional?", "url": "https://github.com/crate/crate/pull/10596#discussion_r494932701", "createdAt": "2020-09-25T11:45:43Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/close/TransportVerifyShardBeforeCloseAction.java", "diffHunk": "@@ -151,21 +162,32 @@ public void markShardCopyAsStaleIfNeeded(ShardId shardId, String allocationId, A\n     public static class ShardRequest extends ReplicationRequest<ShardRequest> {\n \n         private final ClusterBlock clusterBlock;\n+        private final boolean phase1;\n \n         ShardRequest(StreamInput in) throws IOException {\n             super(in);\n+            if (in.getVersion().onOrAfter(Version.V_4_3_0)) {\n+                phase1 = in.readBoolean();\n+            } else {\n+                phase1 = false;\n+            }\n             this.clusterBlock = new ClusterBlock(in);\n         }\n \n-        public ShardRequest(ShardId shardId, ClusterBlock clusterBlock) {\n+        public ShardRequest(ShardId shardId, boolean phase1, ClusterBlock clusterBlock) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741"}, "originalPosition": 64}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ae6cb27d9b7c7c64180229942ca21d11c310741", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/5ae6cb27d9b7c7c64180229942ca21d11c310741", "committedDate": "2020-09-25T10:25:38Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}, "afterCommit": {"oid": "178601049ae5d9e3a61d207c4234c1b3cb099425", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/178601049ae5d9e3a61d207c4234c1b3cb099425", "committedDate": "2020-09-25T12:34:30Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "917634db8f80374feee2d34af49a0683f682ee35", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/917634db8f80374feee2d34af49a0683f682ee35", "committedDate": "2020-09-25T12:47:41Z", "message": "fixup! fixup! Reflect advance checkpoints only after persisting ops in TransportVerifyShardBeforeCloseAction"}, "afterCommit": {"oid": "199aca0f1adc35f456422280df22eadc84c655a1", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/199aca0f1adc35f456422280df22eadc84c655a1", "committedDate": "2020-09-25T14:37:40Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NTIxMDQ1", "url": "https://github.com/crate/crate/pull/10596#pullrequestreview-496521045", "createdAt": "2020-09-25T15:21:29Z", "commit": {"oid": "199aca0f1adc35f456422280df22eadc84c655a1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "199aca0f1adc35f456422280df22eadc84c655a1", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/199aca0f1adc35f456422280df22eadc84c655a1", "committedDate": "2020-09-25T14:37:40Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}, "afterCommit": {"oid": "40efd99820eaa470e4dd67f18bc4a374a793504f", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/40efd99820eaa470e4dd67f18bc4a374a793504f", "committedDate": "2020-09-26T11:47:39Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01c5e4d1f353416accad7af03ff741c77ec853f0", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/01c5e4d1f353416accad7af03ff741c77ec853f0", "committedDate": "2020-09-28T08:32:49Z", "message": "Reflect advance checkpoints only after persisting ops in TransportVerifyShardBeforeCloseAction\n\nhttps://github.com/crate/crate/pull/9309/ ports over https://github.com/elastic/elasticsearch/pull/43205\nbut at that point TransportVerifyShardBeforeCloseAction was not present\nin our code base."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f232196ff4021ee13457589e79aaabd6af15cee6", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/f232196ff4021ee13457589e79aaabd6af15cee6", "committedDate": "2020-09-28T08:32:49Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb9bccf098000b137edd14d89934e775927a87d0", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/fb9bccf098000b137edd14d89934e775927a87d0", "committedDate": "2020-09-26T12:23:02Z", "message": "Merge branch 'master' into r/verify-shard-before-close"}, "afterCommit": {"oid": "f232196ff4021ee13457589e79aaabd6af15cee6", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/f232196ff4021ee13457589e79aaabd6af15cee6", "committedDate": "2020-09-28T08:32:49Z", "message": "Port over TransportVerifyShardBeforeCloseActionTests.\n\nES state: 704317da71c"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3780, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}