{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTQ4NzU2", "number": 9575, "title": "Improve BwC for returning clause for update", "bodyText": "Summary of the changes / Why this improves CrateDB\nThis introduces a version check for the returning clause for update in the planner. It also removes all allOn4_2 version flags from upsert related classes and uses the version from the stream directly as @seut suggested #9434 (comment). This pr will also  fixes the flaky RollingUpgradeTest in crate-qa against current master.\nRelated BwC test can be found here crate/crate-qa#131\nChecklist\n\n User relevant changes are recorded in CHANGES.txt\n Touched code is covered by tests\n Documentation has been updated if necessary\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-01-28T10:58:13Z", "url": "https://github.com/crate/crate/pull/9575", "merged": true, "mergeCommit": {"oid": "a706fe3ad08eb73e7b4b43cf737d7236b7fba03e"}, "closed": true, "closedAt": "2020-01-29T15:52:51Z", "author": {"login": "mkleen"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-vU_dABqjI5ODUxOTM2MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_HjxdAH2gAyMzY3OTQ4NzU2OmJiNDAyYzZjYWFmMzY1NjRhMmJjZTc1N2I3MDcyZmRlMzZiNjM1MzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd5478dde1ee0fb7a19ed2bec9457faf1da20684", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/dd5478dde1ee0fb7a19ed2bec9457faf1da20684", "committedDate": "2020-01-28T10:57:02Z", "message": "Remove allOn4_2 version flag from Upsert related classes"}, "afterCommit": {"oid": "80234c3e2978572a26989f158563217b73f317b7", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/80234c3e2978572a26989f158563217b73f317b7", "committedDate": "2020-01-28T11:06:13Z", "message": "Remove allOn4_2 version flag from Upsert related classes"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "40e3b990a5a7eeff001ed00874c167f08154ce0b", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/40e3b990a5a7eeff001ed00874c167f08154ce0b", "committedDate": "2020-01-28T15:38:56Z", "message": "Make sure clusterservice gets closed in testcase"}, "afterCommit": {"oid": "16e2bd4f13587306578fffdc5790729fe235c2d9", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/16e2bd4f13587306578fffdc5790729fe235c2d9", "committedDate": "2020-01-29T07:29:26Z", "message": "Add test for node compatibility for returning clause"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDQ2Mzc1", "url": "https://github.com/crate/crate/pull/9575#pullrequestreview-350046375", "createdAt": "2020-01-29T11:46:42Z", "commit": {"oid": "bfcded18b84b1fd173500aa3bc86b47972477be3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTo0Njo0MlrOFjFnnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTo0Njo0MlrOFjFnnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzNjU0MA==", "bodyText": "Which version are we aiming here ? 4.2 or something like 4.1.x ?", "url": "https://github.com/crate/crate/pull/9575#discussion_r372336540", "createdAt": "2020-01-29T11:46:42Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcded18b84b1fd173500aa3bc86b47972477be3"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "72e6b653cfd0d038a5c7f901d6f3b2d641352a33", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/72e6b653cfd0d038a5c7f901d6f3b2d641352a33", "committedDate": "2020-01-29T12:05:08Z", "message": "Remove uneeded ctor call"}, "afterCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "committedDate": "2020-01-29T12:07:45Z", "message": "Add test for node compatibility for returning clause"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDk3OTY4", "url": "https://github.com/crate/crate/pull/9575#pullrequestreview-350097968", "createdAt": "2020-01-29T13:19:39Z", "commit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxOTozOVrOFjIDtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoyMDoyNVrOFjIFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg==", "bodyText": "Maybe also inline this, I think there is only a single use.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376502", "createdAt": "2020-01-29T13:19:39Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "diffHunk": "@@ -225,6 +213,8 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         sessionSettings.writeTo(out);\n \n+        boolean allOn4_2 = out.getVersion().onOrAfter(Version.V_4_2_0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3Njg3MA==", "bodyText": "Could merge this into the previous if condition.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376870", "createdAt": "2020-01-29T13:20:25Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a24417a70dc6634112a423d814701ebfdc4d1118", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/a24417a70dc6634112a423d814701ebfdc4d1118", "committedDate": "2020-01-29T14:46:59Z", "message": "Improve bwc for returning clause for update\n\nThis change simplifies the serialisation for upsert-related\nclasses and makes it less error prone. It also adds a\nspecific version check for all nodes in the cluster when\na returning clause occurs in an update query."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/83f8c3b0497aa030fc18d7124ea39e77a0a881f4", "committedDate": "2020-01-29T12:07:45Z", "message": "Add test for node compatibility for returning clause"}, "afterCommit": {"oid": "a24417a70dc6634112a423d814701ebfdc4d1118", "author": {"user": {"login": "mkleen", "name": "Michael Kleen"}}, "url": "https://github.com/crate/crate/commit/a24417a70dc6634112a423d814701ebfdc4d1118", "committedDate": "2020-01-29T14:46:59Z", "message": "Improve bwc for returning clause for update\n\nThis change simplifies the serialisation for upsert-related\nclasses and makes it less error prone. It also adds a\nspecific version check for all nodes in the cluster when\na returning clause occurs in an update query."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTc2NjA5", "url": "https://github.com/crate/crate/pull/9575#pullrequestreview-350176609", "createdAt": "2020-01-29T15:05:41Z", "commit": {"oid": "a24417a70dc6634112a423d814701ebfdc4d1118"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb402c6caaf36564a2bce757b7072fde36b63530", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/bb402c6caaf36564a2bce757b7072fde36b63530", "committedDate": "2020-01-29T15:20:34Z", "message": "Merge branch 'master' into mkleen/remove_version_flag"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3951, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}