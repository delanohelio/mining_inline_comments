{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyMzM2ODI4", "number": 10067, "title": "Apply offset on optimized SELECT DISTINCT queries", "bodyText": "Summary of the changes / Why this improves CrateDB\nThe offset was ignored, leading to incorrect results when the distinct\nresult-set had fewer items than (limit + offset)\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-06-10T09:43:25Z", "url": "https://github.com/crate/crate/pull/10067", "merged": true, "mergeCommit": {"oid": "c193f5511fe0e938af8aa9bcf6bc67323002af3a"}, "closed": true, "closedAt": "2020-06-10T20:47:09Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcp2ggCgBqjM0Mjg4MTczMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp9bYxABqjM0MzA4MDUwNjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff46bda088d275cc944022d02a42aceb2ffdf46c", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/ff46bda088d275cc944022d02a42aceb2ffdf46c", "committedDate": "2020-06-10T09:41:35Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "8df34b1b24c5b72ab7532b94e2e94d57578f54b2", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/8df34b1b24c5b72ab7532b94e2e94d57578f54b2", "committedDate": "2020-06-10T09:47:12Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3ODk0MjQw", "url": "https://github.com/crate/crate/pull/10067#pullrequestreview-427894240", "createdAt": "2020-06-10T09:49:44Z", "commit": {"oid": "8df34b1b24c5b72ab7532b94e2e94d57578f54b2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTo0OTo0NFrOGhteiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQwOTo0OTo0NFrOGhteiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODAwMTI4OQ==", "bodyText": "testSelectCountStarIsOptimizedInsideRelations failed with:\njava.lang.AssertionError: \nExpected: a value less than or equal to <8388608L>\n     but: <24224152L> was greater than <8388608L>\n\tat __randomizedtesting.SeedInfo.seed([A1199D5560FEB506:3485992BF20EF71E]:0)\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:6)\n\tat io.crate.testing.MemoryLimits.assertMaxBytesAllocated(MemoryLimits.java:46)\n\tat io.crate.planner.operators.LogicalPlannerTest.plan(LogicalPlannerTest.java:69)\n\tat io.crate.planner.operators.LogicalPlannerTest.testSelectCountStarIsOptimizedInsideRelations(LogicalPlannerTest.java:221)\n\nNot sure why this increased in that particular case, because that isn't even affected by the other changes in this PR. Will follow up on this separately.", "url": "https://github.com/crate/crate/pull/10067#discussion_r438001289", "createdAt": "2020-06-10T09:49:44Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/planner/operators/LogicalPlannerTest.java", "diffHunk": "@@ -66,7 +66,7 @@ public void prepare() throws IOException {\n     }\n \n     private LogicalPlan plan(String statement) {\n-        return assertMaxBytesAllocated(ByteSizeUnit.MB.toBytes(8), () -> sqlExecutor.logicalPlan(statement));\n+        return assertMaxBytesAllocated(ByteSizeUnit.MB.toBytes(25), () -> sqlExecutor.logicalPlan(statement));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8df34b1b24c5b72ab7532b94e2e94d57578f54b2"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8df34b1b24c5b72ab7532b94e2e94d57578f54b2", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/8df34b1b24c5b72ab7532b94e2e94d57578f54b2", "committedDate": "2020-06-10T09:47:12Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "667a9188e43dd2999affbc9980a2017229e1f9f8", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/667a9188e43dd2999affbc9980a2017229e1f9f8", "committedDate": "2020-06-10T11:46:27Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "667a9188e43dd2999affbc9980a2017229e1f9f8", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/667a9188e43dd2999affbc9980a2017229e1f9f8", "committedDate": "2020-06-10T11:46:27Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "5c347dd6c52bf90350ce93af925ced5b2ef94dec", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/5c347dd6c52bf90350ce93af925ced5b2ef94dec", "committedDate": "2020-06-10T12:08:59Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5c347dd6c52bf90350ce93af925ced5b2ef94dec", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/5c347dd6c52bf90350ce93af925ced5b2ef94dec", "committedDate": "2020-06-10T12:08:59Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "128c1b6b0b503c9e2097fee50370771f0bf47715", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/128c1b6b0b503c9e2097fee50370771f0bf47715", "committedDate": "2020-06-10T12:15:41Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3OTk2MjI4", "url": "https://github.com/crate/crate/pull/10067#pullrequestreview-427996228", "createdAt": "2020-06-10T12:22:23Z", "commit": {"oid": "128c1b6b0b503c9e2097fee50370771f0bf47715"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoyMjoyM1rOGhyObw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xMFQxMjoyMjoyM1rOGhyObw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzODA3OTA4Nw==", "bodyText": "shouldn't be limit = limit + offset here also?", "url": "https://github.com/crate/crate/pull/10067#discussion_r438079087", "createdAt": "2020-06-10T12:22:23Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/planner/operators/TopNDistinct.java", "diffHunk": "@@ -101,31 +105,50 @@ public ExecutionPlan build(PlannerContext plannerContext,\n                 subQueryResults\n             )\n         );\n+        int offset = DataTypes.INTEGER.value(\n+            evaluate(\n+                plannerContext.transactionContext(),\n+                plannerContext.functions(),\n+                this.offset,\n+                params,\n+                subQueryResults\n+            )\n+        );\n         var inputColOutputs = InputColumn.mapToInputColumns(outputs);\n         executionPlan.addProjection(\n             new TopNDistinctProjection(\n-                limit,\n+                limit + offset,\n                 inputColOutputs,\n                 source.preferShardProjections() ? RowGranularity.SHARD : RowGranularity.CLUSTER\n             )\n         );\n         boolean onHandler = ExecutionPhases.executesOnHandler(\n             plannerContext.handlerNode(), executionPlan.resultDescription().nodeIds());\n-        if (!onHandler) {\n-            executionPlan = Merge.ensureOnHandler(executionPlan, plannerContext);\n-            executionPlan.addProjection(\n-                new TopNDistinctProjection(limit, inputColOutputs, RowGranularity.CLUSTER));\n-        } else if (source.preferShardProjections()) {\n-            executionPlan.addProjection(\n-                new TopNDistinctProjection(limit, inputColOutputs, RowGranularity.CLUSTER));\n+        if (!onHandler || source.preferShardProjections()) {\n+            if (!onHandler) {\n+                executionPlan = Merge.ensureOnHandler(executionPlan, plannerContext);\n+            }\n+            TopNDistinctProjection topNDistinct = new TopNDistinctProjection(\n+                limit + offset,\n+                inputColOutputs,\n+                RowGranularity.CLUSTER\n+            );\n+            executionPlan.addProjection(topNDistinct);\n+            if (offset > 0) {\n+                // TopNDistinctProjection outputs a distinct result-set,\n+                // That allows us to use the TopNProjection to apply the offset\n+                executionPlan.addProjection(\n+                    new TopNProjection(limit, offset, Symbols.typeView(topNDistinct.outputs()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "128c1b6b0b503c9e2097fee50370771f0bf47715"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDAwNjkz", "url": "https://github.com/crate/crate/pull/10067#pullrequestreview-428000693", "createdAt": "2020-06-10T12:28:04Z", "commit": {"oid": "128c1b6b0b503c9e2097fee50370771f0bf47715"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MTI1OTA5", "url": "https://github.com/crate/crate/pull/10067#pullrequestreview-428125909", "createdAt": "2020-06-10T14:40:52Z", "commit": {"oid": "5bd2065aeef3f163bb673b4062d8782aa442aa05"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5bd2065aeef3f163bb673b4062d8782aa442aa05", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/5bd2065aeef3f163bb673b4062d8782aa442aa05", "committedDate": "2020-06-10T14:37:53Z", "message": "fixup! Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "0c20ecc7f47479500ebe2410bc76e379741be81b", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0c20ecc7f47479500ebe2410bc76e379741be81b", "committedDate": "2020-06-10T14:52:39Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0c20ecc7f47479500ebe2410bc76e379741be81b", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0c20ecc7f47479500ebe2410bc76e379741be81b", "committedDate": "2020-06-10T14:52:39Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "7a9a0d73963256caca3409495247408e6ff91416", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/7a9a0d73963256caca3409495247408e6ff91416", "committedDate": "2020-06-10T15:42:56Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973da62c2ce7bd57d4af60b260255756c157b436", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/973da62c2ce7bd57d4af60b260255756c157b436", "committedDate": "2020-06-10T17:50:48Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a9a0d73963256caca3409495247408e6ff91416", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/7a9a0d73963256caca3409495247408e6ff91416", "committedDate": "2020-06-10T15:42:56Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}, "afterCommit": {"oid": "973da62c2ce7bd57d4af60b260255756c157b436", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/973da62c2ce7bd57d4af60b260255756c157b436", "committedDate": "2020-06-10T17:50:48Z", "message": "Apply offset on optimized SELECT DISTINCT queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3260, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}