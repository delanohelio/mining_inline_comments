{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3OTQ4NzU2", "number": 9575, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTo0Njo0MlrODbiyrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoyMDoyNVrODbkXBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjA4MTcyOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTo0Njo0MlrOFjFnnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxODozMFrOFjIBiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzNjU0MA==", "bodyText": "Which version are we aiming here ? 4.2 or something like 4.1.x ?", "url": "https://github.com/crate/crate/pull/9575#discussion_r372336540", "createdAt": "2020-01-29T11:46:42Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcded18b84b1fd173500aa3bc86b47972477be3"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NTk0NA==", "bodyText": "4.2 \ud83d\udc4d", "url": "https://github.com/crate/crate/pull/9575#discussion_r372375944", "createdAt": "2020-01-29T13:18:30Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMzNjU0MA=="}, "originalCommit": {"oid": "bfcded18b84b1fd173500aa3bc86b47972477be3"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMzNjE3OnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoxOTozOVrOFjIDtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoyNDoxOVrOFjIMHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg==", "bodyText": "Maybe also inline this, I think there is only a single use.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376502", "createdAt": "2020-01-29T13:19:39Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "diffHunk": "@@ -225,6 +213,8 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         sessionSettings.writeTo(out);\n \n+        boolean allOn4_2 = out.getVersion().onOrAfter(Version.V_4_2_0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3Nzg3Mw==", "bodyText": "It is used for the serialization of all the items.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372377873", "createdAt": "2020-01-29T13:22:33Z", "author": {"login": "mkleen"}, "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "diffHunk": "@@ -225,6 +213,8 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         sessionSettings.writeTo(out);\n \n+        boolean allOn4_2 = out.getVersion().onOrAfter(Version.V_4_2_0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg=="}, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3ODY1NQ==", "bodyText": "Ah right, I missed that.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372378655", "createdAt": "2020-01-29T13:24:19Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/execution/dml/upsert/ShardUpsertRequest.java", "diffHunk": "@@ -225,6 +213,8 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         sessionSettings.writeTo(out);\n \n+        boolean allOn4_2 = out.getVersion().onOrAfter(Version.V_4_2_0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3NjUwMg=="}, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMwMjMzODYzOnYy", "diffSide": "RIGHT", "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoyMDoyNVrOFjIFJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMzoyMDoyNVrOFjIFJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjM3Njg3MA==", "bodyText": "Could merge this into the previous if condition.", "url": "https://github.com/crate/crate/pull/9575#discussion_r372376870", "createdAt": "2020-01-29T13:20:25Z", "author": {"login": "mfussenegger"}, "path": "sql/src/main/java/io/crate/planner/consumer/UpdatePlanner.java", "diffHunk": "@@ -82,14 +83,25 @@\n \n public final class UpdatePlanner {\n \n+    public static final String RETURNING_VERSION_ERROR_MSG =\n+        \"Returning clause for Update is only supported when all nodes in the cluster running at least version 4.2.0\";\n+\n     private UpdatePlanner() {\n     }\n \n     public static Plan plan(AnalyzedUpdateStatement update,\n                             Functions functions,\n                             PlannerContext plannerCtx,\n                             SubqueryPlanner subqueryPlanner) {\n+\n+        if (!update.returnValues().isEmpty()) {\n+            if (!plannerCtx.clusterState().getNodes().getMinNodeVersion().onOrAfter(Version.V_4_2_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83f8c3b0497aa030fc18d7124ea39e77a0a881f4"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1148, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}