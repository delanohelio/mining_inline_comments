{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNjA4OTgw", "number": 10708, "title": "Add support for PK lookup if additional filters are combined by AND", "bodyText": "If filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\nCloses #10298.", "createdAt": "2020-10-27T09:37:14Z", "url": "https://github.com/crate/crate/pull/10708", "merged": true, "mergeCommit": {"oid": "ab5e0a4a74e4b841661333f6aa1e8f79e6737c5c"}, "closed": true, "closedAt": "2020-11-02T15:51:08Z", "author": {"login": "seut"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXUXv2ABqjM5MzcxMzM5NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYmG40AH2gAyNTEwNjA4OTgwOmMxYTljODA5N2QzMTI0NzNkYjY0NWZmMWUxNDllYTk0MmZlZDIwNGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "87608bcc3682e15f6a05fa654e29c334db29f1aa", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/87608bcc3682e15f6a05fa654e29c334db29f1aa", "committedDate": "2020-10-27T11:24:09Z", "message": "fixup! Add support for PK lookup if additional filters are combined by AND"}, "afterCommit": {"oid": "3b50f690cf5127756ea20201ff4aaffe38b15d9a", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/3b50f690cf5127756ea20201ff4aaffe38b15d9a", "committedDate": "2020-10-29T16:01:21Z", "message": "Add support for PK lookup if additional filters are combined by AND\n\nIf filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\n\nCloses #10298."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3b50f690cf5127756ea20201ff4aaffe38b15d9a", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/3b50f690cf5127756ea20201ff4aaffe38b15d9a", "committedDate": "2020-10-29T16:01:21Z", "message": "Add support for PK lookup if additional filters are combined by AND\n\nIf filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\n\nCloses #10298."}, "afterCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/514fe793e8d32e6d23292bcb768f35f925509d75", "committedDate": "2020-10-29T16:27:45Z", "message": "Add support for PK lookup if additional filters are combined by AND\n\nIf filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\n\nCloses #10298."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNDM4Mzgw", "url": "https://github.com/crate/crate/pull/10708#pullrequestreview-520438380", "createdAt": "2020-10-30T07:54:01Z", "commit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzo1NDowMVrOHrEYWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODoxNDoyOVrOHrE6SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyMjU4NA==", "bodyText": "This isn't streamed and looking at the usages I think being able to change the granularity is currently also not really necessary?", "url": "https://github.com/crate/crate/pull/10708#discussion_r514922584", "createdAt": "2020-10-30T07:54:01Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/dsl/projection/EvalProjection.java", "diffHunk": "@@ -41,6 +42,7 @@\n public class EvalProjection extends Projection {\n \n     private final List<Symbol> outputs;\n+    private RowGranularity requiredGranularity = RowGranularity.CLUSTER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyNjAxNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    List<Symbol> boundOutputs = Lists2.map(\n          \n          \n            \n                        outputs, s -> SubQueryAndParamBinder.convert(s, params, subQueryResults));\n          \n          \n            \n                    var boundQuery = SubQueryAndParamBinder.convert(query, params, subQueryResults);\n          \n          \n            \n                    var binder = new SubQueryAndParamBinder(params, subQueryResults);\n          \n          \n            \n                    List<Symbol> boundOutputs = Lists2.map(outputs, binder)\n          \n          \n            \n                    var boundQuery = binder.convert(query);\n          \n      \n    \n    \n  \n\nAvoids creating 2 SubQueryAndParamBinder instances", "url": "https://github.com/crate/crate/pull/10708#discussion_r514926016", "createdAt": "2020-10-30T08:02:11Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/planner/operators/Get.java", "diffHunk": "@@ -135,20 +147,55 @@ public ExecutionPlan build(PlannerContext plannerContext,\n                 .orElse(SequenceNumbers.UNASSIGNED_PRIMARY_TERM);\n             pkAndVersions.add(new PKAndVersion(id, version, sequenceNumber, primaryTerm));\n         }\n-        return new Collect(\n+\n+        var docKeyColumns = new ArrayList<>(docTableInfo.primaryKey());\n+        docKeyColumns.addAll(docTableInfo.partitionedBy());\n+        docKeyColumns.add(docTableInfo.clusteredBy());\n+        docKeyColumns.add(DocSysColumns.VERSION);\n+        docKeyColumns.add(DocSysColumns.SEQ_NO);\n+        docKeyColumns.add(DocSysColumns.PRIMARY_TERM);\n+\n+        List<Symbol> boundOutputs = Lists2.map(\n+            outputs, s -> SubQueryAndParamBinder.convert(s, params, subQueryResults));\n+        var boundQuery = SubQueryAndParamBinder.convert(query, params, subQueryResults);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyNjI4Mw==", "bodyText": "In which case can ref.ident().tableIdent().equals(tableRelation.relationName()) be false here?", "url": "https://github.com/crate/crate/pull/10708#discussion_r514926283", "createdAt": "2020-10-30T08:02:50Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/planner/operators/Get.java", "diffHunk": "@@ -135,20 +147,55 @@ public ExecutionPlan build(PlannerContext plannerContext,\n                 .orElse(SequenceNumbers.UNASSIGNED_PRIMARY_TERM);\n             pkAndVersions.add(new PKAndVersion(id, version, sequenceNumber, primaryTerm));\n         }\n-        return new Collect(\n+\n+        var docKeyColumns = new ArrayList<>(docTableInfo.primaryKey());\n+        docKeyColumns.addAll(docTableInfo.partitionedBy());\n+        docKeyColumns.add(docTableInfo.clusteredBy());\n+        docKeyColumns.add(DocSysColumns.VERSION);\n+        docKeyColumns.add(DocSysColumns.SEQ_NO);\n+        docKeyColumns.add(DocSysColumns.PRIMARY_TERM);\n+\n+        List<Symbol> boundOutputs = Lists2.map(\n+            outputs, s -> SubQueryAndParamBinder.convert(s, params, subQueryResults));\n+        var boundQuery = SubQueryAndParamBinder.convert(query, params, subQueryResults);\n+\n+        var toCollect = new LinkedHashSet<>(boundOutputs);\n+        Consumer<Reference> addRefIfMatch = ref -> {\n+            if (ref.ident().tableIdent().equals(tableRelation.relationName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyODQ4NQ==", "bodyText": "I also don't quite understand why this check is necessary. toCollect is a set, so duplicates won't be added anyways?\nIs this under the assumption that the symbol might not be needed because it is only used in the docKeys part? I'm not sure if that assertion is safe. Couldn't the query still use columns from docKeyColumns ?", "url": "https://github.com/crate/crate/pull/10708#discussion_r514928485", "createdAt": "2020-10-30T08:08:05Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/planner/operators/Get.java", "diffHunk": "@@ -135,20 +147,55 @@ public ExecutionPlan build(PlannerContext plannerContext,\n                 .orElse(SequenceNumbers.UNASSIGNED_PRIMARY_TERM);\n             pkAndVersions.add(new PKAndVersion(id, version, sequenceNumber, primaryTerm));\n         }\n-        return new Collect(\n+\n+        var docKeyColumns = new ArrayList<>(docTableInfo.primaryKey());\n+        docKeyColumns.addAll(docTableInfo.partitionedBy());\n+        docKeyColumns.add(docTableInfo.clusteredBy());\n+        docKeyColumns.add(DocSysColumns.VERSION);\n+        docKeyColumns.add(DocSysColumns.SEQ_NO);\n+        docKeyColumns.add(DocSysColumns.PRIMARY_TERM);\n+\n+        List<Symbol> boundOutputs = Lists2.map(\n+            outputs, s -> SubQueryAndParamBinder.convert(s, params, subQueryResults));\n+        var boundQuery = SubQueryAndParamBinder.convert(query, params, subQueryResults);\n+\n+        var toCollect = new LinkedHashSet<>(boundOutputs);\n+        Consumer<Reference> addRefIfMatch = ref -> {\n+            if (ref.ident().tableIdent().equals(tableRelation.relationName())\n+                && docKeyColumns.contains(ref.column()) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 81}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkyOTg1MA==", "bodyText": "Would it be possible to use the existing SymbolVisitors.any or Symbols.containsColumn  for this?", "url": "https://github.com/crate/crate/pull/10708#discussion_r514929850", "createdAt": "2020-10-30T08:11:19Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/planner/statement/DeletePlanner.java", "diffHunk": "@@ -193,4 +203,32 @@ private static ExecutionPlan deleteByQuery(DocTableRelation table, PlannerContex\n         Collect collect = new Collect(collectPhase, TopN.NO_LIMIT, 0, 1, 1, null);\n         return Merge.ensureOnHandler(collect, context, Collections.singletonList(MergeCountProjection.INSTANCE));\n     }\n+\n+    private static class NonPartitionReferenceDetector extends SymbolVisitor<List<Reference>, Boolean> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMDU4Mw==", "bodyText": "Isn't this already tested in testUpdateUsingSeqNoRequiresPk (UpdatePlannerTest) ?", "url": "https://github.com/crate/crate/pull/10708#discussion_r514930583", "createdAt": "2020-10-30T08:12:55Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/SeqNoBasedOCCIntegrationTest.java", "diffHunk": "@@ -126,4 +126,26 @@ public void testSelectWhereSeqNoAndPTWithoutPrimaryKey() throws Exception {\n                                 HttpResponseStatus.BAD_REQUEST,\n                                 4000));\n     }\n+\n+    @Test\n+    public void test_update_where_id_and_seq_missing_primary_term() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzMTI3Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    execute(\"select id from t1 where id = 1 and x = 2\");\n          \n          \n            \n                    assertThat(response.rowCount(), is(0L));\n          \n          \n            \n                    execute(\"select id from t1 where id = 1 and x = 2\");\n          \n          \n            \n                    assertThat(response.rowCount(), is(0L));\n          \n          \n            \n            \n          \n          \n            \n                    execute(\"select id from t1 where id = 1 and x = 1\");\n          \n          \n            \n                    assertThat(response.rowCount(), is(1L));\n          \n      \n    \n    \n  \n\nTo have the \"pk lookup matches and query matches\" part covered too.", "url": "https://github.com/crate/crate/pull/10708#discussion_r514931273", "createdAt": "2020-10-30T08:14:29Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/WherePKIntegrationTest.java", "diffHunk": "@@ -304,7 +304,14 @@ public void testDeleteByQueryCommaRouting() throws Exception {\n \n         execute(\"select * from explicit_routing\");\n         assertThat(response.rowCount(), is(2L));\n+    }\n \n+    @Test\n+    public void test_select_where_pk_and_additional_filter() {\n+        execute(\"create table t1 (id int primary key, x int) with (refresh_interval=0)\");\n+        execute(\"insert into t1 (id, x) values (1, 1)\");\n+        execute(\"select id from t1 where id = 1 and x = 2\");\n+        assertThat(response.rowCount(), is(0L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "514fe793e8d32e6d23292bcb768f35f925509d75"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDAyMzE4", "url": "https://github.com/crate/crate/pull/10708#pullrequestreview-521402318", "createdAt": "2020-11-02T08:07:39Z", "commit": {"oid": "eda372b47d75ef09fb7018cf6ff771c1147b5bb4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODowNzo0MFrOHr5vKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODowNzo0MFrOHr5vKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5Njc3OA==", "bodyText": "Isn't this the same as org.junit.jupiter.api.Assertions.assertThrows ?", "url": "https://github.com/crate/crate/pull/10708#discussion_r515796778", "createdAt": "2020-11-02T08:07:40Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/testing/Asserts.java", "diffHunk": "@@ -40,4 +42,14 @@ public static void assertThrows(Executable executable, Matcher<? super Throwable\n             assertThat(t, matcher);\n         }\n     }\n+\n+    public static void assertThrows(Executable executable, Class<? extends Throwable> type, String subString) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eda372b47d75ef09fb7018cf6ff771c1147b5bb4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "770bd3dcc253017a6738b44500d38eb32a049014", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/770bd3dcc253017a6738b44500d38eb32a049014", "committedDate": "2020-11-02T08:49:26Z", "message": "Add support for PK lookup if additional filters are combined by AND\n\nIf filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\n\nCloses #10298."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eda372b47d75ef09fb7018cf6ff771c1147b5bb4", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/eda372b47d75ef09fb7018cf6ff771c1147b5bb4", "committedDate": "2020-10-30T16:32:37Z", "message": "fixup! Add support for PK lookup if additional filters are combined by AND"}, "afterCommit": {"oid": "770bd3dcc253017a6738b44500d38eb32a049014", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/770bd3dcc253017a6738b44500d38eb32a049014", "committedDate": "2020-11-02T08:49:26Z", "message": "Add support for PK lookup if additional filters are combined by AND\n\nIf filters are combined by AND operators in addition to filters\non primary key columns, the optimized PK lookup plan is used now.\n\nCloses #10298."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1a9c8097d312473db645ff1e149ea942fed204b", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/c1a9c8097d312473db645ff1e149ea942fed204b", "committedDate": "2020-11-02T15:15:20Z", "message": "Merge branch 'master' into s/pk-filter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3736, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}