{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4ODg1OTAw", "number": 10384, "title": "Add doc-values aggregators for the arbitrary aggregation.", "bodyText": "Summary of the changes / Why this improves CrateDB\nIt improves the performance of the global standard deviation aggregations.\nSee #10048 for more information.\nWithout doc-values aggregators:\n# Running setUp\n# Running benchmark\n\n## Running Query:\n   Name: global arbitrary on long\n   Statement:\n     select arbitrary(duration) from uservisits\n   Concurrency: 1\n   Iterations: 2000\n100%| 2000/2000 [01:31<00:00, 21.86 requests/s]\nRuntime (in ms):\n    mean:    44.726 \u00b1 1.202\n    min/max: 34.335 \u2192 772.710\nPercentile:\n    50:   40.981 \u00b1 27.433 (stdev)\n    95:   56.560\n    99.9: 369.586\n\n## Running Query:\n   Name: global arbitrary on float\n   Statement:\n     select arbitrary(\"adRevenue\") from uservisits\n   Concurrency: 1\n   Iterations: 2000\n100%| 2000/2000 [02:35<00:00, 12.86 requests/s]\nRuntime (in ms):\n    mean:    74.985 \u00b1 1.459\n    min/max: 41.575 \u2192 323.320\nPercentile:\n    50:   66.986 \u00b1 33.282 (stdev)\n    95:   137.141\n    99.9: 321.631\n# Running tearDown\n\nWith doc-values aggregators:\n# Running setUp\n# Running benchmark\n\n## Running Query:\n   Name: global arbitrary on long\n   Statement:\n     select arbitrary(duration) from uservisits\n   Concurrency: 1\n   Iterations: 2000\n100%| 2000/2000 [00:27<00:00, 72.97 requests/s]\nRuntime (in ms):\n    mean:    10.257 \u00b1 0.466\n    min/max: 4.806 \u2192 195.278\nPercentile:\n    50:   8.069 \u00b1 10.635 (stdev)\n    95:   18.638\n    99.9: 133.295\n\n## Running Query:\n   Name: global arbitrary on float\n   Statement:\n     select arbitrary(\"adRevenue\") from uservisits\n   Concurrency: 1\n   Iterations: 2000\n100%| 2000/2000 [00:35<00:00, 56.06 requests/s]\nRuntime (in ms):\n    mean:    14.503 \u00b1 0.788\n    min/max: 6.206 \u2192 438.253\nPercentile:\n    50:   12.200 \u00b1 17.986 (stdev)\n    95:   22.720\n    99.9: 167.751\n\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-08-17T14:57:38Z", "url": "https://github.com/crate/crate/pull/10384", "merged": true, "mergeCommit": {"oid": "8895420ba1a8f5596ceeaecc6adfa57ddf94cbdb"}, "closed": true, "closedAt": "2020-08-18T11:39:09Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_0DWZABqjM2NjIzODI4MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAD7P-AH2gAyNDY4ODg1OTAwOjNkNGRmZTVhMDg3MmZhNzkxMzBiZDk4MGFjN2U1YjJhOTM0YTY4ZTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dda0b3d0e06e0e2f6610ec566d0c8ebe3fb49379", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/dda0b3d0e06e0e2f6610ec566d0c8ebe3fb49379", "committedDate": "2020-08-17T14:50:11Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}, "afterCommit": {"oid": "99a35442de74f665b6fce6937303ae24e4675e8c", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/99a35442de74f665b6fce6937303ae24e4675e8c", "committedDate": "2020-08-17T15:21:47Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99a35442de74f665b6fce6937303ae24e4675e8c", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/99a35442de74f665b6fce6937303ae24e4675e8c", "committedDate": "2020-08-17T15:21:47Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}, "afterCommit": {"oid": "599f3285af5546829d386f68df6f1d8147613583", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/599f3285af5546829d386f68df6f1d8147613583", "committedDate": "2020-08-17T15:36:20Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "599f3285af5546829d386f68df6f1d8147613583", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/599f3285af5546829d386f68df6f1d8147613583", "committedDate": "2020-08-17T15:36:20Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}, "afterCommit": {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/24950717d34dd3dc0d49651dbff77e9041a1f60d", "committedDate": "2020-08-17T15:37:07Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MDQyOTIy", "url": "https://github.com/crate/crate/pull/10384#pullrequestreview-469042922", "createdAt": "2020-08-18T07:02:46Z", "commit": {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowMjo0NlrOHCGAqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwNzowMjo0NlrOHCGAqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTk1NzY3Mw==", "bodyText": "I think we could use the value directly without the wrapper in this case. There is no primitive type involved, so it doesn't avoid boxing. Or am I missing something?", "url": "https://github.com/crate/crate/pull/10384#discussion_r471957673", "createdAt": "2020-08-18T07:02:46Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/aggregation/impl/ArbitraryAggregation.java", "diffHunk": "@@ -108,4 +125,97 @@ public Object reduce(RamAccounting ramAccounting, Object state1, Object state2)\n     public Object terminatePartial(RamAccounting ramAccounting, Object state) {\n         return state;\n     }\n+\n+    @Nullable\n+    @Override\n+    public DocValueAggregator<?> getDocValueAggregator(List<DataType<?>> argumentTypes,\n+                                                       List<MappedFieldType> fieldTypes) {\n+        var dataType = argumentTypes.get(0);\n+        switch (dataType.id()) {\n+            case ByteType.ID:\n+            case ShortType.ID:\n+            case IntegerType.ID:\n+            case LongType.ID:\n+            case TimestampType.ID_WITH_TZ:\n+            case TimestampType.ID_WITHOUT_TZ:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            state.setValue(values.nextValue());\n+                        }\n+                    }\n+                );\n+            case FloatType.ID:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            var value = NumericUtils.sortableIntToFloat((int) values.nextValue());\n+                            state.setValue(value);\n+                        }\n+                    }\n+                );\n+            case DoubleType.ID:\n+                return new ArbitraryNumericDocValueAggregator(\n+                    fieldTypes.get(0).name(),\n+                    dataType,\n+                    (values, state) -> {\n+                        if (!state.hasValue()) {\n+                            var value = NumericUtils.sortableLongToDouble(values.nextValue());\n+                            state.setValue(value);\n+                        }\n+                    }\n+                );\n+            case IpType.ID:\n+            case StringType.ID:\n+                return new BinaryDocValueAggregator<>(\n+                    fieldTypes.get(0).name(),\n+                    MutableObject::new,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d"}, "originalPosition": 85}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTI3Mzg0", "url": "https://github.com/crate/crate/pull/10384#pullrequestreview-469127384", "createdAt": "2020-08-18T08:57:12Z", "commit": {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9acf7dc0adbd40d5167a25d8ff93e60265146adf", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/9acf7dc0adbd40d5167a25d8ff93e60265146adf", "committedDate": "2020-08-18T09:13:34Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "24950717d34dd3dc0d49651dbff77e9041a1f60d", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/24950717d34dd3dc0d49651dbff77e9041a1f60d", "committedDate": "2020-08-17T15:37:07Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}, "afterCommit": {"oid": "9acf7dc0adbd40d5167a25d8ff93e60265146adf", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/9acf7dc0adbd40d5167a25d8ff93e60265146adf", "committedDate": "2020-08-18T09:13:34Z", "message": "Add doc-values aggregators for the arbitrary aggregation.\n\nIt improves the performance of the global standard deviation aggregations.\nSee https://github.com/crate/crate/pull/10048 for more information."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d4dfe5a0872fa79130bd980ac7e5b2a934a68e8", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/3d4dfe5a0872fa79130bd980ac7e5b2a934a68e8", "committedDate": "2020-08-18T09:51:40Z", "message": "Merge branch 'master' into r/doc-values-agg-arbitrary"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3134, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}