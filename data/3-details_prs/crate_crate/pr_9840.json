{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MDQ5MTM4", "number": 9840, "title": "Refactor array_agg, string_agg and count functions to use new function registry.", "bodyText": "Summary of the changes / Why this improves CrateDB\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-04-01T14:56:36Z", "url": "https://github.com/crate/crate/pull/9840", "merged": true, "mergeCommit": {"oid": "547eeda78fb02adeaa8a2c24adfd9742f5eabeec"}, "closed": true, "closedAt": "2020-04-02T13:18:25Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcToXvxgH2gAyMzk3MDQ5MTM4OmQwNWY1NTE1Njg3ZGY1MDU1YzA3NWZlZTVhNGI2OWZkNWQ2ZGEwZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTrtlUgH2gAyMzk3MDQ5MTM4OjA3ZGE3OGZjYzIwY2RlMzcxYmE0MGU2ZGQ0N2VmMGM4YzU1ODhlZDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d05f5515687df5055c075fee5a4b69fd5d6da0f0", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/d05f5515687df5055c075fee5a4b69fd5d6da0f0", "committedDate": "2020-04-02T08:52:47Z", "message": "Refactor count function to use new function registry."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82841407468d5f4d8accc0165717d1bbe712ed42", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/82841407468d5f4d8accc0165717d1bbe712ed42", "committedDate": "2020-04-02T08:52:47Z", "message": "Refactor array_agg function to use new function registry."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/b8f9230c347bedbb3170ffa8b07828d78d481a1b", "committedDate": "2020-04-02T08:52:54Z", "message": "Refactor string_agg function to use new function registry."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "99bfb1bc012330a5c35ed6259b9f25a5c2ac5166", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/99bfb1bc012330a5c35ed6259b9f25a5c2ac5166", "committedDate": "2020-04-01T14:54:02Z", "message": "Refactor count function to use new function registry."}, "afterCommit": {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/b8f9230c347bedbb3170ffa8b07828d78d481a1b", "committedDate": "2020-04-02T08:52:54Z", "message": "Refactor string_agg function to use new function registry."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2Mjk4Mzgx", "url": "https://github.com/crate/crate/pull/9840#pullrequestreview-386298381", "createdAt": "2020-04-02T10:30:33Z", "commit": {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDozMDozM1rOF_lEdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxMDozNToyOFrOF_lP1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxMTk1OA==", "bodyText": "Maybe worth creating builder shortcuts like Signature.scalar() also for aggregates? I think this really improves readability. Also note the signature.withTypeVariableContraints() builder.", "url": "https://github.com/crate/crate/pull/9840#discussion_r402211958", "createdAt": "2020-04-02T10:30:33Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/execution/engine/aggregation/impl/ArrayAgg.java", "diffHunk": "@@ -42,19 +40,24 @@\n import java.util.ArrayList;\n import java.util.List;\n \n+import static io.crate.metadata.functions.TypeVariableConstraint.typeVariable;\n+import static io.crate.types.TypeSignature.parseTypeSignature;\n+\n public final class ArrayAgg extends AggregationFunction<List<Object>, List<Object>> {\n \n     public static final String NAME = \"array_agg\";\n \n     public static void register(AggregationImplModule module) {\n-        module.register(NAME, new BaseFunctionResolver(FuncParams.SINGLE_ANY) {\n-\n-            @Override\n-            public FunctionImplementation getForTypes(List<DataType> types) throws IllegalArgumentException {\n-                var type = types.get(0);\n-                return new ArrayAgg(type);\n-            }\n-        });\n+        module.register(\n+            Signature.builder()\n+                .name(NAME)\n+                .kind(FunctionInfo.Type.AGGREGATE)\n+                .argumentTypes(parseTypeSignature(\"E\"))\n+                .typeVariableConstraints(typeVariable(\"E\"))\n+                .returnType(parseTypeSignature(\"array(E)\"))\n+                .build(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjIxNDg2OQ==", "bodyText": "Can we mark the old register methods as deprecated?", "url": "https://github.com/crate/crate/pull/9840#discussion_r402214869", "createdAt": "2020-04-02T10:35:28Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/AbstractFunctionModule.java", "diffHunk": "@@ -57,6 +61,13 @@ public void register(FunctionName qualifiedName, FunctionResolver functionResolv\n         resolver.put(qualifiedName, functionResolver);\n     }\n \n+    public void register(Signature signature, Function<List<DataType>, FunctionImplementation> factory) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8f9230c347bedbb3170ffa8b07828d78d481a1b"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a317e2adc78330713aa5c63bae816d8307d33976", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/a317e2adc78330713aa5c63bae816d8307d33976", "committedDate": "2020-04-02T10:56:00Z", "message": "Add a shortcut for building aggregate function signatures."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg2MzgwOTA0", "url": "https://github.com/crate/crate/pull/9840#pullrequestreview-386380904", "createdAt": "2020-04-02T12:34:58Z", "commit": {"oid": "a317e2adc78330713aa5c63bae816d8307d33976"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07da78fcc20cde371ba40e6dd47ef0c8c5588ed2", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/07da78fcc20cde371ba40e6dd47ef0c8c5588ed2", "committedDate": "2020-04-02T12:46:21Z", "message": "Merge branch 'master' into r/count-agg"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3489, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}