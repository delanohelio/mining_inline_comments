{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwNzczOTc2", "number": 10566, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0NzoyM1rOEl-_vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1MDowMlrOEl_EMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY0ODkzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0NzoyM1rOHVwJ-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwOToxMDoyN1rOHVxBug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MTEzMQ==", "bodyText": "Is the UseJdbc(1) required here?", "url": "https://github.com/crate/crate/pull/10566#discussion_r492571131", "createdAt": "2020-09-22T08:47:23Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "diffHunk": "@@ -40,6 +45,160 @@ public void prepareClosedTable() {\n         execute(\"alter table t close\");\n     }\n \n+    @UseJdbc(1)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a97f20cfb8ec2d831d29c0c9b24905771483b86"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU4NTQwMg==", "bodyText": "it is not needed, I used the wrong crate error code + HTTP code, so the assertion worked only for the pg but not for HTTP case.", "url": "https://github.com/crate/crate/pull/10566#discussion_r492585402", "createdAt": "2020-09-22T09:10:27Z", "author": {"login": "kovrus"}, "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "diffHunk": "@@ -40,6 +45,160 @@ public void prepareClosedTable() {\n         execute(\"alter table t close\");\n     }\n \n+    @UseJdbc(1)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MTEzMQ=="}, "originalCommit": {"oid": "0a97f20cfb8ec2d831d29c0c9b24905771483b86"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY1ODA2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTozMFrOHVwPNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTozMFrOHVwPNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MjQ3MA==", "bodyText": "Might be worth changing this to a single bulk insert with between(10, 20) to speed up the test case a bit.", "url": "https://github.com/crate/crate/pull/10566#discussion_r492572470", "createdAt": "2020-09-22T08:49:30Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "diffHunk": "@@ -40,6 +45,160 @@ public void prepareClosedTable() {\n         execute(\"alter table t close\");\n     }\n \n+    @UseJdbc(1)\n+    @Test\n+    public void test_open_missing_table() {\n+        assertThrows(\n+            () -> execute(\"alter table test open\"),\n+            isSQLError(\n+                is(\"Relation 'test' unknown\"),\n+                UNDEFINED_TABLE,\n+                BAD_REQUEST,\n+                4007\n+            )\n+        );\n+    }\n+\n+    @Test\n+    public void test_open_already_opened_index() {\n+        execute(\"alter table t open\");\n+        execute(\"alter table t open\");\n+    }\n+\n+    @Test\n+    public void test_simple_close_open_with_records() {\n+        execute(\"alter table t open\");\n+        execute(\"insert into t values (1), (2)\");\n+        refresh();\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+\n+        execute(\"alter table t close\");\n+        execute(\"alter table t open\");\n+        ensureGreen();\n+\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+    }\n+\n+    @Test\n+    public void test_get_translog_stats_after_close_and_open_table() throws Exception {\n+        execute(\"create table test (x int ) with (number_of_replicas = 0) \");\n+        long numberOfDocs = randomIntBetween(0, 50);\n+        long uncommittedOps = 0;\n+        for (long i = 0; i < numberOfDocs; i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+            if (rarely()) {\n+                execute(\"optimize table test with (flush = true)\");\n+                uncommittedOps = 0;\n+            } else {\n+                uncommittedOps += 1;\n+            }\n+        }\n+        final long uncommittedTranslogOps = uncommittedOps;\n+        assertBusy(() -> {\n+            execute(\n+                \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+                \"from sys.shards \" +\n+                \"where table_name = 'test' and primary = true \" +\n+                \"group by table_name, primary\");\n+            assertThat(response.rowCount(), greaterThan(0L));\n+            assertThat(response.rows()[0][0], is(numberOfDocs));\n+            assertThat(response.rows()[0][1], is(uncommittedTranslogOps));\n+        });\n+\n+        execute(\"alter table test close\");\n+        execute(\"alter table test open\");\n+        ensureYellow();\n+\n+        execute(\n+            \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+            \"from sys.shards \" +\n+            \"where table_name = 'test' and primary = true \" +\n+            \"group by table_name, primary\");\n+        assertThat(response.rowCount(), greaterThan(0L));\n+        assertThat(response.rows()[0][0], is(numberOfDocs));\n+        assertThat(response.rows()[0][1], is(0L));\n+    }\n+\n+    @Test\n+    public void test_open_close_is_not_blocked_with_read_and_write_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a97f20cfb8ec2d831d29c0c9b24905771483b86"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY1OTQ4OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTo1MlrOHVwQCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo0OTo1MlrOHVwQCw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MjY4Mw==", "bodyText": "same here", "url": "https://github.com/crate/crate/pull/10566#discussion_r492572683", "createdAt": "2020-09-22T08:49:52Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "diffHunk": "@@ -40,6 +45,160 @@ public void prepareClosedTable() {\n         execute(\"alter table t close\");\n     }\n \n+    @UseJdbc(1)\n+    @Test\n+    public void test_open_missing_table() {\n+        assertThrows(\n+            () -> execute(\"alter table test open\"),\n+            isSQLError(\n+                is(\"Relation 'test' unknown\"),\n+                UNDEFINED_TABLE,\n+                BAD_REQUEST,\n+                4007\n+            )\n+        );\n+    }\n+\n+    @Test\n+    public void test_open_already_opened_index() {\n+        execute(\"alter table t open\");\n+        execute(\"alter table t open\");\n+    }\n+\n+    @Test\n+    public void test_simple_close_open_with_records() {\n+        execute(\"alter table t open\");\n+        execute(\"insert into t values (1), (2)\");\n+        refresh();\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+\n+        execute(\"alter table t close\");\n+        execute(\"alter table t open\");\n+        ensureGreen();\n+\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+    }\n+\n+    @Test\n+    public void test_get_translog_stats_after_close_and_open_table() throws Exception {\n+        execute(\"create table test (x int ) with (number_of_replicas = 0) \");\n+        long numberOfDocs = randomIntBetween(0, 50);\n+        long uncommittedOps = 0;\n+        for (long i = 0; i < numberOfDocs; i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+            if (rarely()) {\n+                execute(\"optimize table test with (flush = true)\");\n+                uncommittedOps = 0;\n+            } else {\n+                uncommittedOps += 1;\n+            }\n+        }\n+        final long uncommittedTranslogOps = uncommittedOps;\n+        assertBusy(() -> {\n+            execute(\n+                \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+                \"from sys.shards \" +\n+                \"where table_name = 'test' and primary = true \" +\n+                \"group by table_name, primary\");\n+            assertThat(response.rowCount(), greaterThan(0L));\n+            assertThat(response.rows()[0][0], is(numberOfDocs));\n+            assertThat(response.rows()[0][1], is(uncommittedTranslogOps));\n+        });\n+\n+        execute(\"alter table test close\");\n+        execute(\"alter table test open\");\n+        ensureYellow();\n+\n+        execute(\n+            \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+            \"from sys.shards \" +\n+            \"where table_name = 'test' and primary = true \" +\n+            \"group by table_name, primary\");\n+        assertThat(response.rowCount(), greaterThan(0L));\n+        assertThat(response.rows()[0][0], is(numberOfDocs));\n+        assertThat(response.rows()[0][1], is(0L));\n+    }\n+\n+    @Test\n+    public void test_open_close_is_not_blocked_with_read_and_write_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }\n+        refresh();\n+\n+        for (String blockSetting : List.of(\"blocks.read\", \"blocks.write\")) {\n+            try {\n+                execute(\"alter table test set (\\\"\" + blockSetting + \"\\\" = true)\");\n+\n+                // Closing an index is not blocked\n+                execute(\"alter table test close\");\n+                assertThat(isClosed(\"test\"), is(true));\n+\n+                // Opening an index is not blocked\n+                execute(\"alter table test open\");\n+                ensureYellow();\n+                assertThat(isClosed(\"test\"), is(false));\n+            } finally {\n+                execute(\"alter table test reset (\\\"\" + blockSetting + \"\\\")\");\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void test_close_is_blocked_with_read_only_and_metadata_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a97f20cfb8ec2d831d29c0c9b24905771483b86"}, "originalPosition": 131}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MjY2MDMyOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1MDowMlrOHVwQiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwODo1MDowMlrOHVwQiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjU3MjgwOQ==", "bodyText": "and here", "url": "https://github.com/crate/crate/pull/10566#discussion_r492572809", "createdAt": "2020-09-22T08:50:02Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/integrationtests/OpenCloseTableIntegrationTest.java", "diffHunk": "@@ -40,6 +45,160 @@ public void prepareClosedTable() {\n         execute(\"alter table t close\");\n     }\n \n+    @UseJdbc(1)\n+    @Test\n+    public void test_open_missing_table() {\n+        assertThrows(\n+            () -> execute(\"alter table test open\"),\n+            isSQLError(\n+                is(\"Relation 'test' unknown\"),\n+                UNDEFINED_TABLE,\n+                BAD_REQUEST,\n+                4007\n+            )\n+        );\n+    }\n+\n+    @Test\n+    public void test_open_already_opened_index() {\n+        execute(\"alter table t open\");\n+        execute(\"alter table t open\");\n+    }\n+\n+    @Test\n+    public void test_simple_close_open_with_records() {\n+        execute(\"alter table t open\");\n+        execute(\"insert into t values (1), (2)\");\n+        refresh();\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+\n+        execute(\"alter table t close\");\n+        execute(\"alter table t open\");\n+        ensureGreen();\n+\n+        execute(\"select * from t\");\n+        assertThat(response.rowCount(), is(2L));\n+    }\n+\n+    @Test\n+    public void test_get_translog_stats_after_close_and_open_table() throws Exception {\n+        execute(\"create table test (x int ) with (number_of_replicas = 0) \");\n+        long numberOfDocs = randomIntBetween(0, 50);\n+        long uncommittedOps = 0;\n+        for (long i = 0; i < numberOfDocs; i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+            if (rarely()) {\n+                execute(\"optimize table test with (flush = true)\");\n+                uncommittedOps = 0;\n+            } else {\n+                uncommittedOps += 1;\n+            }\n+        }\n+        final long uncommittedTranslogOps = uncommittedOps;\n+        assertBusy(() -> {\n+            execute(\n+                \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+                \"from sys.shards \" +\n+                \"where table_name = 'test' and primary = true \" +\n+                \"group by table_name, primary\");\n+            assertThat(response.rowCount(), greaterThan(0L));\n+            assertThat(response.rows()[0][0], is(numberOfDocs));\n+            assertThat(response.rows()[0][1], is(uncommittedTranslogOps));\n+        });\n+\n+        execute(\"alter table test close\");\n+        execute(\"alter table test open\");\n+        ensureYellow();\n+\n+        execute(\n+            \"select sum(translog_stats['number_of_operations']), sum(translog_stats['uncommitted_operations']) \" +\n+            \"from sys.shards \" +\n+            \"where table_name = 'test' and primary = true \" +\n+            \"group by table_name, primary\");\n+        assertThat(response.rowCount(), greaterThan(0L));\n+        assertThat(response.rows()[0][0], is(numberOfDocs));\n+        assertThat(response.rows()[0][1], is(0L));\n+    }\n+\n+    @Test\n+    public void test_open_close_is_not_blocked_with_read_and_write_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }\n+        refresh();\n+\n+        for (String blockSetting : List.of(\"blocks.read\", \"blocks.write\")) {\n+            try {\n+                execute(\"alter table test set (\\\"\" + blockSetting + \"\\\" = true)\");\n+\n+                // Closing an index is not blocked\n+                execute(\"alter table test close\");\n+                assertThat(isClosed(\"test\"), is(true));\n+\n+                // Opening an index is not blocked\n+                execute(\"alter table test open\");\n+                ensureYellow();\n+                assertThat(isClosed(\"test\"), is(false));\n+            } finally {\n+                execute(\"alter table test reset (\\\"\" + blockSetting + \"\\\")\");\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void test_close_is_blocked_with_read_only_and_metadata_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }\n+        refresh();\n+\n+        for (String blockSetting : List.of(\"blocks.read_only\", \"blocks.metadata\")) {\n+            try {\n+                execute(\"alter table test set (\\\"\" + blockSetting + \"\\\" = true)\");\n+                execute(\"alter table test close\");\n+            } catch (Exception e) {\n+                assertThat(isClosed(\"test\"), is(false));\n+            } finally {\n+                execute(\"alter table test reset (\\\"\" + blockSetting + \"\\\")\");\n+            }\n+        }\n+    }\n+\n+    @Test\n+    public void test_open_is_blocked_with_read_and_write_blocks_enabled() {\n+        execute(\"create table test (x int) with (number_of_replicas = 0) \");\n+        for (int i = 0; i < between(10, 20); i++) {\n+            execute(\"insert into test values (?)\", new Object[]{i});\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a97f20cfb8ec2d831d29c0c9b24905771483b86"}, "originalPosition": 151}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1020, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}