{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg1MDc4MzU0", "number": 10525, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxMFrOEijYXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxMFrOEijYXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0NjY2NzE3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxMzo1MzoxMFrOHQfy4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMVQxNDozMDoxOVrOHQhPuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ==", "bodyText": "I think the indexService() call could fail, in which case the searcher wouldn't be released because it hasn't been added to the collectTask yet.\nMakes me wonder if we should remove the lazy indexService initialization within SharedShardContext and do it eagerly. Then it couldn't fail here anymore.", "url": "https://github.com/crate/crate/pull/10525#discussion_r487060195", "createdAt": "2020-09-11T13:53:10Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "diffHunk": "@@ -100,42 +100,37 @@\n         ShardId shardId = indexShard.shardId();\n         SharedShardContext shardContext = collectTask.sharedShardContexts().getOrCreateContext(shardId);\n         Searcher searcher = shardContext.acquireSearcher(LuceneShardCollectorProvider.formatSource(phase));\n-        try {\n-            QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();\n-            collectTask.addSearcher(shardContext.readerId(), searcher);\n-            LuceneQueryBuilder.Context queryContext = luceneQueryBuilder.convert(\n-                phase.where(),\n-                collectTask.txnCtx(),\n-                indexShard.mapperService(),\n-                indexShard.shardId().getIndexName(),\n-                queryShardContext,\n-                table,\n-                shardContext.indexService().cache()\n-            );\n+        QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA3NjQ4MA==", "bodyText": "Engine.Searcher searcher = sharedShardContext.acquireSearcher(formatSource(collectPhase));\n        QueryShardContext queryShardContext = sharedShardContext.indexService().newQueryShardContext();\n\nacquireSearcher call here preseeds the indexService() call and acquireSearcher calls indexShard() that call indexService(), so if indexService() fails the searcher won't even be created, right?", "url": "https://github.com/crate/crate/pull/10525#discussion_r487076480", "createdAt": "2020-09-11T14:18:32Z", "author": {"login": "kovrus"}, "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "diffHunk": "@@ -100,42 +100,37 @@\n         ShardId shardId = indexShard.shardId();\n         SharedShardContext shardContext = collectTask.sharedShardContexts().getOrCreateContext(shardId);\n         Searcher searcher = shardContext.acquireSearcher(LuceneShardCollectorProvider.formatSource(phase));\n-        try {\n-            QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();\n-            collectTask.addSearcher(shardContext.readerId(), searcher);\n-            LuceneQueryBuilder.Context queryContext = luceneQueryBuilder.convert(\n-                phase.where(),\n-                collectTask.txnCtx(),\n-                indexShard.mapperService(),\n-                indexShard.shardId().getIndexName(),\n-                queryShardContext,\n-                table,\n-                shardContext.indexService().cache()\n-            );\n+        QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ=="}, "originalCommit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA4Mzk2MA==", "bodyText": "Ah you're right \ud83d\udc4d", "url": "https://github.com/crate/crate/pull/10525#discussion_r487083960", "createdAt": "2020-09-11T14:30:19Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/execution/engine/collect/DocValuesAggregates.java", "diffHunk": "@@ -100,42 +100,37 @@\n         ShardId shardId = indexShard.shardId();\n         SharedShardContext shardContext = collectTask.sharedShardContexts().getOrCreateContext(shardId);\n         Searcher searcher = shardContext.acquireSearcher(LuceneShardCollectorProvider.formatSource(phase));\n-        try {\n-            QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();\n-            collectTask.addSearcher(shardContext.readerId(), searcher);\n-            LuceneQueryBuilder.Context queryContext = luceneQueryBuilder.convert(\n-                phase.where(),\n-                collectTask.txnCtx(),\n-                indexShard.mapperService(),\n-                indexShard.shardId().getIndexName(),\n-                queryShardContext,\n-                table,\n-                shardContext.indexService().cache()\n-            );\n+        QueryShardContext queryShardContext = shardContext.indexService().newQueryShardContext();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzA2MDE5NQ=="}, "originalCommit": {"oid": "86e25f827bbdf93d57904826e260d157cf0d29df"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1003, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}