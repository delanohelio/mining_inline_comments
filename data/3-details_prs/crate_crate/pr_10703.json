{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5ODkzOTQ0", "number": 10703, "title": "Allow super users to drop corrupted tables", "bodyText": "Summary of the changes / Why this improves CrateDB\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\nThat currently causes a lot of queries to fail. For example\ninformation_schema.tables cannot be queried anymore because it attempts\nto load all the tables.\nThis adds an escape hatch for super users to that tables which are bad can\nbe deleted.\nFollow up actions\n\n\n Tighten the CREATE and ALTER table logic to prevent tables from becoming\ninvalid. For example by attempting to parse the new metadata into a\nDocTableInfo before the cluster state update is finished.\n\u2192 #10706\n\n\n Allow to query information_schema.tables & others if a table cannot be parsed?\n\n\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-10-26T09:24:49Z", "url": "https://github.com/crate/crate/pull/10703", "merged": true, "mergeCommit": {"oid": "9e691f1910844fbfd26e2b57539a00012a32ef96"}, "closed": true, "closedAt": "2020-10-27T09:29:00Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWRDE9gBqjM5MTk3NDU2MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWlIBSgFqTUxNzQ1MTUzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0208f8a2d2ea46c09fa8e1ff7ae3a779a81b7434", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/0208f8a2d2ea46c09fa8e1ff7ae3a779a81b7434", "committedDate": "2020-10-26T09:22:37Z", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted."}, "afterCommit": {"oid": "84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "committedDate": "2020-10-26T09:35:01Z", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/8ad545b18c41ef88575d544e955a6b736c5c3665", "committedDate": "2020-10-27T08:12:33Z", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/84a7248e167a20ac3f4d2fdc61b5ada5df7b475a", "committedDate": "2020-10-26T09:35:01Z", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted."}, "afterCommit": {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/8ad545b18c41ef88575d544e955a6b736c5c3665", "committedDate": "2020-10-27T08:12:33Z", "message": "Allow super users to drop corrupted tables\n\nDue to bugs in other places it may be possible to have tables in the\ncluster that contain a schema which cannot be parsed anymore.\n\nThat currently causes a lot of queries to fail. For example\n`information_schema.tables` cannot be queried anymore because it\nattempts to load all the tables.\n\nThis adds an escape hatch for super users to that tables which are bad\ncan be deleted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE3NDUxNTM0", "url": "https://github.com/crate/crate/pull/10703#pullrequestreview-517451534", "createdAt": "2020-10-27T08:32:32Z", "commit": {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODozMjozMlrOHowdOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QwODozMjozMlrOHowdOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5OTAwMA==", "bodyText": "I'd turn this into debug as I think this is not relevant for the user. The table is dropped afterwards anyway so its not possible to do anything after seeing this log. Any other reason why informing the user is helpful here?", "url": "https://github.com/crate/crate/pull/10703#discussion_r512499000", "createdAt": "2020-10-27T08:32:32Z", "author": {"login": "seut"}, "path": "server/src/main/java/io/crate/analyze/DropTableAnalyzer.java", "diffHunk": "@@ -63,16 +70,35 @@\n                                                                boolean dropIfExists,\n                                                                SessionContext sessionContext) {\n         T tableInfo;\n+        RelationName tableName;\n+        boolean maybeCorrupt = false;\n         try {\n             //noinspection unchecked\n             tableInfo = (T) schemas.resolveTableInfo(name, Operation.DROP, sessionContext.sessionUser(), sessionContext.searchPath());\n+            tableName = tableInfo.ident();\n         } catch (SchemaUnknownException | RelationUnknown e) {\n             if (dropIfExists) {\n                 tableInfo = null;\n+                tableName = RelationName.of(name, sessionContext.searchPath().currentSchema());\n             } else {\n                 throw e;\n             }\n+        } catch (OperationOnInaccessibleRelationException e) {\n+            throw e;\n+        } catch (Throwable t) {\n+            if (!sessionContext.sessionUser().isSuperUser()) {\n+                throw t;\n+            }\n+            tableInfo = null;\n+            maybeCorrupt = true;\n+            tableName = RelationName.of(name, sessionContext.searchPath().currentSchema());\n+            LOGGER.info(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ad545b18c41ef88575d544e955a6b736c5c3665"}, "originalPosition": 56}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3728, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}