{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1MDQ2ODUy", "number": 9540, "title": "Add encode and decode string functions", "bodyText": "Summary of the changes / Why this improves CrateDB\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\nClose #9539\nChecklist\n\n User relevant changes are recorded in CHANGES.txt\n Touched code is covered by tests\n Documentation has been updated if necessary\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-01-21T00:30:50Z", "url": "https://github.com/crate/crate/pull/9540", "merged": true, "mergeCommit": {"oid": "b99231e0b8f8fd88c87544972ad6111e0f941c9d"}, "closed": true, "closedAt": "2020-01-28T11:00:24Z", "author": {"login": "scampi"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8WEbaABqjI5NjQ1MDY0MTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-hwuHgBqjI5ODMwNjQ4MzM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bd8164fa9a78a470c2c3df365018512dff5c5d80", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/bd8164fa9a78a470c2c3df365018512dff5c5d80", "committedDate": "2020-01-21T00:31:25Z", "message": "Merge branch 'master' into issue-9539"}, "afterCommit": {"oid": "0aa120fb32a65ba4605e9baaaefdcf57a117c3d9", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/0aa120fb32a65ba4605e9baaaefdcf57a117c3d9", "committedDate": "2020-01-21T00:32:56Z", "message": "Add encode and decode string functions\n\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\n\nClose #9539"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0aa120fb32a65ba4605e9baaaefdcf57a117c3d9", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/0aa120fb32a65ba4605e9baaaefdcf57a117c3d9", "committedDate": "2020-01-21T00:32:56Z", "message": "Add encode and decode string functions\n\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\n\nClose #9539"}, "afterCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/1b9d0fb86939648c355d5f2a293cad24d9206445", "committedDate": "2020-01-21T08:58:16Z", "message": "Add encode and decode string functions\n\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\n\nClose #9539\n\nUpdate changes.txt file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1ODMyNDg3", "url": "https://github.com/crate/crate/pull/9540#pullrequestreview-345832487", "createdAt": "2020-01-21T12:14:10Z", "commit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjoxNDoxMFrOFf36fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo0NzowNVrOFf4vhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2NjI3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Returns a string with the leasing hexadecimal flag removed.\n          \n          \n            \n                 * Returns a string with the leading hexadecimal flag removed.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368966271", "createdAt": "2020-01-21T12:14:10Z", "author": {"login": "seut"}, "path": "blob/src/main/java/io/crate/common/Hex.java", "diffHunk": "@@ -33,6 +38,37 @@\n      */\n     private static final char[] DIGITS_UPPER = {'0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F'};\n \n+    /**\n+     * Returns true if the argument is in the \"bytea\" hex format.\n+     */\n+    public static boolean isHexFormat(String data) {\n+        return data.startsWith(HEX_FLAG);\n+    }\n+\n+    /**\n+     * Returns a string with the leasing hexadecimal flag removed.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk2ODA5MA==", "bodyText": "We should move this class and the existing Hex one into the shared subproject, this new class is not used inside blob at all and it contains generic logic anyway.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368968090", "createdAt": "2020-01-21T12:18:41Z", "author": {"login": "seut"}, "path": "blob/src/main/java/io/crate/common/Octal.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.common;\n+\n+import java.util.Arrays;\n+import java.util.Locale;\n+\n+/**\n+ * Encodes and decodes binary strings into the \"bytea\" escape format.\n+ * Unprintable bytes, outside of the 32..126 range are represented with an octal number \"\\nnn\", and backslashes\n+ * are doubled.\n+ */\n+public class Octal {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3Mzk1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Add encode and decode string functions.\n          \n          \n            \n            - Added the :ref:`encode` and :ref:`decode` string functions.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368973958", "createdAt": "2020-01-21T12:32:56Z", "author": {"login": "seut"}, "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -52,7 +52,7 @@ None\n Changes\n =======\n \n-None\n+- Add encode and decode string functions.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3NjI5Mg==", "bodyText": "All examples which uses the cr> prefix are executed and tested when running our itest  gradle task.\nI think this will fail as the output SELECT 1 row in set (... sec) is missing.\nAnother minor: all lines should be intended by 4 spaces.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368976292", "createdAt": "2020-01-21T12:38:50Z", "author": {"login": "seut"}, "path": "docs/general/builtins/scalar.rst", "diffHunk": "@@ -508,6 +508,49 @@ Example::\n    In both cases, the scalar functions lpad and rpad, do now accept a len\n    greater than 50000.\n \n+.. _scalar-encode:\n+\n+``encode(bytea, format)``\n+-------------------------\n+\n+Encode takes a binary string in hex format and returns a textual representation\n+into the specified format. Supported formats are base64, hex, and escape. The\n+escape format represents unprintable characters with an octal sequence `\\nnn`.\n+\n+Synopsis::\n+\n+    encode(string1, format)\n+\n+Example::\n+\n+   cr> select encode(E'123\\b\\t56', 'base64');\n+   +----------------------------------------+\n+   | select encode(E'123\\b\\t56', 'base64'); |\n+   +----------------------------------------+\n+   | MTIzCAk1Ng==                           |\n+   +----------------------------------------+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3NjQxMQ==", "bodyText": "Same issues here as well.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368976411", "createdAt": "2020-01-21T12:39:09Z", "author": {"login": "seut"}, "path": "docs/general/builtins/scalar.rst", "diffHunk": "@@ -508,6 +508,49 @@ Example::\n    In both cases, the scalar functions lpad and rpad, do now accept a len\n    greater than 50000.\n \n+.. _scalar-encode:\n+\n+``encode(bytea, format)``\n+-------------------------\n+\n+Encode takes a binary string in hex format and returns a textual representation\n+into the specified format. Supported formats are base64, hex, and escape. The\n+escape format represents unprintable characters with an octal sequence `\\nnn`.\n+\n+Synopsis::\n+\n+    encode(string1, format)\n+\n+Example::\n+\n+   cr> select encode(E'123\\b\\t56', 'base64');\n+   +----------------------------------------+\n+   | select encode(E'123\\b\\t56', 'base64'); |\n+   +----------------------------------------+\n+   | MTIzCAk1Ng==                           |\n+   +----------------------------------------+\n+\n+.. _scalar-decode:\n+\n+``decode(text, format)``\n+-------------------------\n+\n+Decodes text encoded in the given format, which are listed in the `encode`\n+documentation. Returns a binary string in the hex format.\n+\n+Synopsis::\n+\n+    decode(text1, format)\n+\n+Example::\n+\n+   cr> select decode('T\\214', 'escape');\n+   +-----------------------------------+\n+   | select decode('T\\214', 'escape'); |\n+   +-----------------------------------+\n+   | \\x548c                            |\n+   +-----------------------------------+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3NzYwNw==", "bodyText": "By defining a encode and decode function to the Format enum itself, this switch statement can be eliminated which improves performance.\nAlso the error handling should be improved, like e.g. catching the not-found enum.valueOf exception and turn it into a user friendly \"Format 'foo' not supported\" exception.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368977607", "createdAt": "2020-01-21T12:41:52Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/scalar/string/EncodeDecodeFunction.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.common.Hex;\n+import io.crate.common.Octal;\n+import io.crate.expression.scalar.ScalarFunctionModule;\n+import io.crate.expression.scalar.arithmetic.BinaryScalar;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.types.DataTypes;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Base64;\n+import java.util.Locale;\n+import java.util.function.BinaryOperator;\n+\n+public class EncodeDecodeFunction {\n+\n+    public static void register(ScalarFunctionModule module) {\n+        module.register(new BinaryScalar<>(new Encode(), \"encode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+        module.register(new BinaryScalar<>(new Decode(), \"decode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+    }\n+\n+    /**\n+     * Takes a binary data of \"bytea\" type and encodes it into the given output format.\n+     */\n+    private static class Encode implements BinaryOperator<String> {\n+\n+        @Override\n+        public String apply(String bytea, String format) {\n+            switch (Format.valueOf(format.toUpperCase(Locale.ROOT))) {\n+                case BASE64:\n+                    final byte[] text;\n+                    if (Hex.isHexFormat(bytea)) {\n+                        text = Hex.decodeHex(Hex.stripHexFormatFlag(bytea));\n+                    } else {\n+                        text = Octal.decode(bytea);\n+                    }\n+                    return Base64.getEncoder().encodeToString(text);\n+                case HEX:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        // the input is already in hex format\n+                        return Hex.validateHex(Hex.stripHexFormatFlag(bytea));\n+                    }\n+                    return Hex.encodeHexString(Octal.decode(bytea));\n+                case ESCAPE:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        return Octal.encode(Hex.decodeHex(Hex.stripHexFormatFlag(bytea)));\n+                    }\n+                    return Octal.encode(bytea.getBytes(StandardCharsets.UTF_8));\n+                default:\n+                    // should not happen\n+                    throw new RuntimeException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3ODIyOQ==", "bodyText": "I think using string concatenation is faster and cheaper here than using the string format.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368978229", "createdAt": "2020-01-21T12:43:24Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/scalar/string/EncodeDecodeFunction.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.common.Hex;\n+import io.crate.common.Octal;\n+import io.crate.expression.scalar.ScalarFunctionModule;\n+import io.crate.expression.scalar.arithmetic.BinaryScalar;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.types.DataTypes;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Base64;\n+import java.util.Locale;\n+import java.util.function.BinaryOperator;\n+\n+public class EncodeDecodeFunction {\n+\n+    public static void register(ScalarFunctionModule module) {\n+        module.register(new BinaryScalar<>(new Encode(), \"encode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+        module.register(new BinaryScalar<>(new Decode(), \"decode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+    }\n+\n+    /**\n+     * Takes a binary data of \"bytea\" type and encodes it into the given output format.\n+     */\n+    private static class Encode implements BinaryOperator<String> {\n+\n+        @Override\n+        public String apply(String bytea, String format) {\n+            switch (Format.valueOf(format.toUpperCase(Locale.ROOT))) {\n+                case BASE64:\n+                    final byte[] text;\n+                    if (Hex.isHexFormat(bytea)) {\n+                        text = Hex.decodeHex(Hex.stripHexFormatFlag(bytea));\n+                    } else {\n+                        text = Octal.decode(bytea);\n+                    }\n+                    return Base64.getEncoder().encodeToString(text);\n+                case HEX:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        // the input is already in hex format\n+                        return Hex.validateHex(Hex.stripHexFormatFlag(bytea));\n+                    }\n+                    return Hex.encodeHexString(Octal.decode(bytea));\n+                case ESCAPE:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        return Octal.encode(Hex.decodeHex(Hex.stripHexFormatFlag(bytea)));\n+                    }\n+                    return Octal.encode(bytea.getBytes(StandardCharsets.UTF_8));\n+                default:\n+                    // should not happen\n+                    throw new RuntimeException();\n+            }\n+        }\n+\n+    }\n+\n+    /**\n+     * Takes a string encoded into the given format and returns its hexadecimal representation.\n+     */\n+    private static class Decode implements BinaryOperator<String> {\n+\n+        @Override\n+        public String apply(String text, String format) {\n+            final byte[] value;\n+\n+            switch (Format.valueOf(format.toUpperCase(Locale.ROOT))) {\n+                case BASE64:\n+                    value = Base64.getDecoder().decode(text.getBytes(StandardCharsets.UTF_8));\n+                    break;\n+                case HEX:\n+                    // text is already in hex format\n+                    return String.format(Locale.ROOT, \"%s%s\", Hex.HEX_FLAG, Hex.validateHex(text));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3ODQxMA==", "bodyText": "Also here, string concatenation should be faster and cheaper.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368978410", "createdAt": "2020-01-21T12:43:50Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/scalar/string/EncodeDecodeFunction.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.common.Hex;\n+import io.crate.common.Octal;\n+import io.crate.expression.scalar.ScalarFunctionModule;\n+import io.crate.expression.scalar.arithmetic.BinaryScalar;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.types.DataTypes;\n+\n+import java.nio.charset.StandardCharsets;\n+import java.util.Base64;\n+import java.util.Locale;\n+import java.util.function.BinaryOperator;\n+\n+public class EncodeDecodeFunction {\n+\n+    public static void register(ScalarFunctionModule module) {\n+        module.register(new BinaryScalar<>(new Encode(), \"encode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+        module.register(new BinaryScalar<>(new Decode(), \"decode\", DataTypes.STRING, FunctionInfo.DETERMINISTIC_ONLY));\n+    }\n+\n+    /**\n+     * Takes a binary data of \"bytea\" type and encodes it into the given output format.\n+     */\n+    private static class Encode implements BinaryOperator<String> {\n+\n+        @Override\n+        public String apply(String bytea, String format) {\n+            switch (Format.valueOf(format.toUpperCase(Locale.ROOT))) {\n+                case BASE64:\n+                    final byte[] text;\n+                    if (Hex.isHexFormat(bytea)) {\n+                        text = Hex.decodeHex(Hex.stripHexFormatFlag(bytea));\n+                    } else {\n+                        text = Octal.decode(bytea);\n+                    }\n+                    return Base64.getEncoder().encodeToString(text);\n+                case HEX:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        // the input is already in hex format\n+                        return Hex.validateHex(Hex.stripHexFormatFlag(bytea));\n+                    }\n+                    return Hex.encodeHexString(Octal.decode(bytea));\n+                case ESCAPE:\n+                    if (Hex.isHexFormat(bytea)) {\n+                        return Octal.encode(Hex.decodeHex(Hex.stripHexFormatFlag(bytea)));\n+                    }\n+                    return Octal.encode(bytea.getBytes(StandardCharsets.UTF_8));\n+                default:\n+                    // should not happen\n+                    throw new RuntimeException();\n+            }\n+        }\n+\n+    }\n+\n+    /**\n+     * Takes a string encoded into the given format and returns its hexadecimal representation.\n+     */\n+    private static class Decode implements BinaryOperator<String> {\n+\n+        @Override\n+        public String apply(String text, String format) {\n+            final byte[] value;\n+\n+            switch (Format.valueOf(format.toUpperCase(Locale.ROOT))) {\n+                case BASE64:\n+                    value = Base64.getDecoder().decode(text.getBytes(StandardCharsets.UTF_8));\n+                    break;\n+                case HEX:\n+                    // text is already in hex format\n+                    return String.format(Locale.ROOT, \"%s%s\", Hex.HEX_FLAG, Hex.validateHex(text));\n+                case ESCAPE:\n+                    value = Octal.decode(text);\n+                    break;\n+                default:\n+                    // should not happen\n+                    throw new RuntimeException();\n+            }\n+            assert value != null;\n+            return String.format(Locale.ROOT, \"%s%s\", Hex.HEX_FLAG, Hex.encodeHexString(value));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3ODY4OQ==", "bodyText": "I suggest to use the expectedException rule everywhere inside this suite to also test for a user-friendly error message.", "url": "https://github.com/crate/crate/pull/9540#discussion_r368978689", "createdAt": "2020-01-21T12:44:35Z", "author": {"login": "seut"}, "path": "sql/src/test/java/io/crate/expression/scalar/string/EncodeDecodeFunctionTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.expression.scalar.AbstractScalarFunctionsTest;\n+import io.crate.expression.symbol.Literal;\n+import io.crate.types.DataTypes;\n+import org.junit.Test;\n+\n+public class EncodeDecodeFunctionTest extends AbstractScalarFunctionsTest {\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToBase64() {\n+        assertEvaluate(\"encode('\\\\xfh', 'base64')\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTQ1Mg==", "bodyText": "please use expectedException rule here instead (don't use System.out anyway, it will bypass any logging/output suppression inside the test runner)", "url": "https://github.com/crate/crate/pull/9540#discussion_r368979452", "createdAt": "2020-01-21T12:46:13Z", "author": {"login": "seut"}, "path": "sql/src/test/java/io/crate/expression/scalar/string/EncodeDecodeFunctionTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.expression.scalar.AbstractScalarFunctionsTest;\n+import io.crate.expression.symbol.Literal;\n+import io.crate.types.DataTypes;\n+import org.junit.Test;\n+\n+public class EncodeDecodeFunctionTest extends AbstractScalarFunctionsTest {\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToBase64() {\n+        assertEvaluate(\"encode('\\\\xfh', 'base64')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToHex() {\n+        assertEvaluate(\"encode('\\\\xfh', 'hex')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToEscape() {\n+        assertEvaluate(\"encode('\\\\xfh', 'escape')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryDecodeFromHex1() {\n+        assertEvaluate(\"decode('\\\\xff', 'hex')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryDecodeFromHex2() {\n+        assertEvaluate(\"decode('ffa', 'hex')\", null);\n+    }\n+\n+    @Test\n+    public void testUnknownFormat() {\n+        try {\n+            assertEvaluate(\"encode('\\\\xff', 'bad')\", null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTg0NA==", "bodyText": "I think we should add a encode/decode test for NULL values", "url": "https://github.com/crate/crate/pull/9540#discussion_r368979844", "createdAt": "2020-01-21T12:47:05Z", "author": {"login": "seut"}, "path": "sql/src/test/java/io/crate/expression/scalar/string/EncodeDecodeFunctionTest.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.scalar.string;\n+\n+import io.crate.expression.scalar.AbstractScalarFunctionsTest;\n+import io.crate.expression.symbol.Literal;\n+import io.crate.types.DataTypes;\n+import org.junit.Test;\n+\n+public class EncodeDecodeFunctionTest extends AbstractScalarFunctionsTest {\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToBase64() {\n+        assertEvaluate(\"encode('\\\\xfh', 'base64')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToHex() {\n+        assertEvaluate(\"encode('\\\\xfh', 'hex')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryEncodeToEscape() {\n+        assertEvaluate(\"encode('\\\\xfh', 'escape')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryDecodeFromHex1() {\n+        assertEvaluate(\"decode('\\\\xff', 'hex')\", null);\n+    }\n+\n+    @Test(expected = IllegalStateException.class)\n+    public void testInvalidBinaryDecodeFromHex2() {\n+        assertEvaluate(\"decode('ffa', 'hex')\", null);\n+    }\n+\n+    @Test\n+    public void testUnknownFormat() {\n+        try {\n+            assertEvaluate(\"encode('\\\\xff', 'bad')\", null);\n+            fail(\"Should fail on unknown format\");\n+        } catch (IllegalArgumentException e) {\n+            System.out.println(\"e = \" + e);\n+        }\n+        try {\n+            assertEvaluate(\"decode('FA==', 'bad')\", null);\n+            fail(\"Should fail on unknown format\");\n+        } catch (IllegalArgumentException e) {\n+            System.out.println(\"e = \" + e);\n+        }\n+    }\n+\n+    @Test\n+    public void testEncodeFuncBase64() {\n+        // input in hex format\n+        final Literal<Object> name = Literal.of(DataTypes.STRING, \"\\\\x3132330001\");\n+        assertEvaluate(\"encode('\\\\x3132330001', 'base64')\", \"MTIzAAE=\");\n+        assertEvaluate(\"encode(name, 'Base64')\", \"MTIzAAE=\", name);\n+        // input in escape format\n+        assertEvaluate(\"encode('123\\\\000\\\\001', 'base64')\", \"MTIzAAE=\");\n+        assertEvaluate(\"encode('123', 'base64')\", \"MTIz\");\n+    }\n+\n+    @Test\n+    public void testDecodeFuncBase64() {\n+        final Literal<Object> name = Literal.of(DataTypes.STRING, \"MTIzAAE=\");\n+        assertEvaluate(\"decode('MTIzAAE=', 'base64')\", \"\\\\x3132330001\");\n+        assertEvaluate(\"decode('MTIzAAE=', 'BASE64')\", \"\\\\x3132330001\");\n+        assertEvaluate(\"decode(name, 'base64')\", \"\\\\x3132330001\", name);\n+    }\n+\n+    @Test\n+    public void testEncodeFuncHex() {\n+        assertEvaluate(\"encode('\\\\x3132330001', 'hex')\", \"3132330001\");\n+        assertEvaluate(\"encode('123\\\\000\\\\001', 'hex')\", \"3132330001\");\n+    }\n+\n+    @Test\n+    public void testDecodeFuncHex() {\n+        assertEvaluate(\"decode('3132330001', 'hex')\", \"\\\\x3132330001\");\n+    }\n+\n+    @Test\n+    public void testEncodeEmpties() {\n+        assertEvaluate(\"encode('', 'base64')\", \"\");\n+        assertEvaluate(\"encode('', 'hex')\", \"\");\n+        assertEvaluate(\"encode('', 'escape')\", \"\");\n+    }\n+\n+    @Test\n+    public void testEncodeFuncEscape() {\n+        assertEvaluate(\"encode('a\\bb\\\\c', 'escape')\", \"a\\\\010b\\\\\\\\c\");\n+        assertEvaluate(\"encode('\\\\x6108625c63', 'escape')\", \"a\\\\010b\\\\\\\\c\");\n+    }\n+\n+    @Test\n+    public void testDecodeFuncEscape() {\n+        assertEvaluate(\"decode('a\\\\010b\\\\\\\\c', 'escape')\", \"\\\\x6108625c63\");\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b9d0fb86939648c355d5f2a293cad24d9206445"}, "originalPosition": 120}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cc89d969b14d6f42b13f4f283564272fbe3130a8", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/cc89d969b14d6f42b13f4f283564272fbe3130a8", "committedDate": "2020-01-22T19:50:45Z", "message": "Merge branch 'master' into issue-9539"}, "afterCommit": {"oid": "dfb374fcfa6d36f5d61a13fe1c7944fb3b5ba3ff", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/dfb374fcfa6d36f5d61a13fe1c7944fb3b5ba3ff", "committedDate": "2020-01-22T19:57:59Z", "message": "Fix documentation examples of decode/encode"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2b5c68c90702fee765631be5489c4ba0a634310c", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/2b5c68c90702fee765631be5489c4ba0a634310c", "committedDate": "2020-01-23T17:56:39Z", "message": "fix references to encode/decode in release notes"}, "afterCommit": {"oid": "1c714181ea5605ddf52c98f36941f82e6cad79a1", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/1c714181ea5605ddf52c98f36941f82e6cad79a1", "committedDate": "2020-01-23T20:28:18Z", "message": "Clarify the decoding of bytea strings in the hex escape format"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ddd2cda13cda2a2d9ab05bb2e563d2a06fd9827", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/9ddd2cda13cda2a2d9ab05bb2e563d2a06fd9827", "committedDate": "2020-01-23T21:40:46Z", "message": "Fix handling of the Enum#valueOf exception which swallowed unrelated exceptions"}, "afterCommit": {"oid": "5794deaf824534e8d9d38fda3254e7da90c1f787", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/5794deaf824534e8d9d38fda3254e7da90c1f787", "committedDate": "2020-01-24T13:11:26Z", "message": "Fix handling of the Enum#valueOf exception which swallowed unrelated exceptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NjYxNzU3", "url": "https://github.com/crate/crate/pull/9540#pullrequestreview-348661757", "createdAt": "2020-01-27T13:31:28Z", "commit": {"oid": "5794deaf824534e8d9d38fda3254e7da90c1f787"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMToyOFrOFiCsqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxMzozMToyOFrOFiCsqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTI0MDEwNw==", "bodyText": "minor nitpick: new changes should be put in top in the related sections. also we use a 80 char line limit in rst files.", "url": "https://github.com/crate/crate/pull/9540#discussion_r371240107", "createdAt": "2020-01-27T13:31:28Z", "author": {"login": "seut"}, "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -58,6 +58,8 @@ Changes\n - Introduced new optional ``RETURNING`` clause for :ref:`Update <ref-update>` to\n   return specified values from each row updated.\n \n+- Added the :ref:`encode(bytea, format) <scalar-encode>` and :ref:`decode(text, format) <scalar-decode>` string functions.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5794deaf824534e8d9d38fda3254e7da90c1f787"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ec5ffdc3859bbec90f27469a0363fc338b8adcb", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/4ec5ffdc3859bbec90f27469a0363fc338b8adcb", "committedDate": "2020-01-27T19:15:08Z", "message": "Add encode and decode string functions\n\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\n\nClose #9539\n\nUpdate changes.txt file\n\nUpdate blob/src/main/java/io/crate/common/Hex.java\n\nCo-Authored-By: Sebastian Utz <su@rtme.net>\n\nUpdate docs/appendices/release-notes/unreleased.rst\n\nCo-Authored-By: Sebastian Utz <su@rtme.net>\n\nImprove error messages\n\nUse string concatenation\n\nAdd encode/decode methods to the Format enum and improve error message on unknown format\n\nAdd tests for null inputs to the encode/decode functions\n\nMove Hex/Octal classes to the shared project\n\nFix documentation examples of decode/encode\n\nFix references to encode/decode in release notes\n\nClarify the decoding of bytea strings in the hex escape format\n\nFix handling of the Enum#valueOf exception which swallowed unrelated exceptions\n\nFormat the new change in the changelog"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5794deaf824534e8d9d38fda3254e7da90c1f787", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/5794deaf824534e8d9d38fda3254e7da90c1f787", "committedDate": "2020-01-24T13:11:26Z", "message": "Fix handling of the Enum#valueOf exception which swallowed unrelated exceptions"}, "afterCommit": {"oid": "4ec5ffdc3859bbec90f27469a0363fc338b8adcb", "author": {"user": {"login": "scampi", "name": "St\u00e9phane Campinas"}}, "url": "https://github.com/crate/crate/commit/4ec5ffdc3859bbec90f27469a0363fc338b8adcb", "committedDate": "2020-01-27T19:15:08Z", "message": "Add encode and decode string functions\n\nEncode takes a binary string in hex format and returns a textual\nrepresentation into the specified format.\nDecode does the opposit and returns the string into hex format.\n\nClose #9539\n\nUpdate changes.txt file\n\nUpdate blob/src/main/java/io/crate/common/Hex.java\n\nCo-Authored-By: Sebastian Utz <su@rtme.net>\n\nUpdate docs/appendices/release-notes/unreleased.rst\n\nCo-Authored-By: Sebastian Utz <su@rtme.net>\n\nImprove error messages\n\nUse string concatenation\n\nAdd encode/decode methods to the Format enum and improve error message on unknown format\n\nAdd tests for null inputs to the encode/decode functions\n\nMove Hex/Octal classes to the shared project\n\nFix documentation examples of decode/encode\n\nFix references to encode/decode in release notes\n\nClarify the decoding of bytea strings in the hex escape format\n\nFix handling of the Enum#valueOf exception which swallowed unrelated exceptions\n\nFormat the new change in the changelog"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3929, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}