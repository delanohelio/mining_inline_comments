{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzMDg3MzU5", "number": 10598, "title": "Fix integer overflow at the reservoir sampling", "bodyText": "As the Reservoir sampling implementation is shared across shards and partitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that the defined maximum samples to the list (this limit is also in the integer range and such supporting sample sizes > integer is not needed).\nThe integer overflow results in bypassing the maximum samples boundary and can lead to node crashes due to OutOfMemory exceptions.", "createdAt": "2020-09-25T13:47:54Z", "url": "https://github.com/crate/crate/pull/10598", "merged": true, "mergeCommit": {"oid": "f0d30d3d61979d74a7eaa36c0d0f4d7402632edc"}, "closed": true, "closedAt": "2020-09-28T08:18:43Z", "author": {"login": "seut"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMWPSQABqjM4MDc4MzcwMjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNOsCEgBqjM4MTMxMTE2NTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "522846783ef0af832a680e574f9f4d1de119698d", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/522846783ef0af832a680e574f9f4d1de119698d", "committedDate": "2020-09-25T13:47:05Z", "message": "Fix integer overflow at the reservoir sampling\n\nAs the Reservoir sampling implementation is shared across shards and\npartitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that\nthe defined maximum samples to the list (this limit is also in the\ninteger range and such supporting sample sizes > integer is not needed).\n\nThe integer overflow results in bypassing the maximum samples boundary\nand can lead to node crashes due to OutOfMemory exceptions."}, "afterCommit": {"oid": "17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7", "committedDate": "2020-09-25T13:58:34Z", "message": "Fix integer overflow at the reservoir sampling\n\nAs the Reservoir sampling implementation is shared across shards and\npartitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that\nthe defined maximum samples to the list (this limit is also in the\ninteger range and such supporting sample sizes > integer is not needed).\n\nThe integer overflow results in bypassing the maximum samples boundary\nand can lead to node crashes due to OutOfMemory exceptions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NDUwMzcw", "url": "https://github.com/crate/crate/pull/10598#pullrequestreview-496450370", "createdAt": "2020-09-25T14:04:24Z", "commit": {"oid": "17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDowNDoyNFrOHYFCtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNVQxNDowNDoyNFrOHYFCtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTAxMDQ4NQ==", "bodyText": "I think I'd just make itemsSeen package private to avoid the reflection, but no strong opinion.", "url": "https://github.com/crate/crate/pull/10598#discussion_r495010485", "createdAt": "2020-09-25T14:04:24Z", "author": {"login": "mfussenegger"}, "path": "server/src/test/java/io/crate/statistics/ReservoirTest.java", "diffHunk": "@@ -40,4 +42,18 @@ public void test_sampling() {\n         }\n         assertThat(samples.samples(), contains(83, 50, 13, 18, 38));\n     }\n+\n+    @Test\n+    public void test_reservoir_is_protected_against_integer_overflow() throws Exception {\n+        Random random = new Random(42);\n+\n+        Reservoir<Long> samples = new Reservoir<>(5, random);\n+        Field f1 = samples.getClass().getDeclaredField(\"itemsSeen\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17fb5a0bbc15f05952dcb2e540ffa9f2e4fbeaa7"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk2NDY4ODU3", "url": "https://github.com/crate/crate/pull/10598#pullrequestreview-496468857", "createdAt": "2020-09-25T14:21:33Z", "commit": {"oid": "f2fa4a7e4a44f04a0327d24e86718e9d169292d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cddfa35543f049d501ad89fa57d108347e441732", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/cddfa35543f049d501ad89fa57d108347e441732", "committedDate": "2020-09-25T16:20:51Z", "message": "Merge branch 'master' into s/reservoir-fix"}, "afterCommit": {"oid": "64e50938c14de1ea3dca5036d125718d92a8878a", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/64e50938c14de1ea3dca5036d125718d92a8878a", "committedDate": "2020-09-25T17:24:47Z", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c1daa6b79e011057e8d206dbce471aaaa5e883f", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/8c1daa6b79e011057e8d206dbce471aaaa5e883f", "committedDate": "2020-09-28T07:44:52Z", "message": "Fix integer overflow at the reservoir sampling\n\nAs the Reservoir sampling implementation is shared across shards and\npartitions, it may process more documents than an integer value can hold.\nIt must be protected against integer overflows to not add more that\nthe defined maximum samples to the list (this limit is also in the\ninteger range and such supporting sample sizes > integer is not needed).\n\nThe integer overflow results in bypassing the maximum samples boundary\nand can lead to node crashes due to OutOfMemory exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "committedDate": "2020-09-28T07:44:52Z", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "64e50938c14de1ea3dca5036d125718d92a8878a", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/64e50938c14de1ea3dca5036d125718d92a8878a", "committedDate": "2020-09-25T17:24:47Z", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached."}, "afterCommit": {"oid": "90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "author": {"user": {"login": "seut", "name": "Sebastian Utz"}}, "url": "https://github.com/crate/crate/commit/90095a20a1e7755d81a9d37122e16aa0ab0a81bb", "committedDate": "2020-09-28T07:44:52Z", "message": "Stop sampling docs when maximum sample size is reached\n\nThe reservoir sampler can only consumer up to Integer.MAX_VALUE\ndocuments, so we can safely early terminate the collect once reached."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3785, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}