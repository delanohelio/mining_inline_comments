{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDk3OTIy", "number": 9500, "title": "Add a pg_get_keywords table function", "bodyText": "Summary of the changes / Why this improves CrateDB\nFor better compatibility with PostgreSQL.\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when getSQLKeywords on DatabaseMetaData is called.\nWe could also use the information in crash or the admin-ui for keyword\nhighlighting and completion.\nChecklist\n\n User relevant changes are recorded in CHANGES.txt\n Touched code is covered by tests\n Documentation has been updated if necessary\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-01-10T15:20:55Z", "url": "https://github.com/crate/crate/pull/9500", "merged": true, "mergeCommit": {"oid": "d6941a76103b8d5e35a1637de71073c767e0fd57"}, "closed": true, "closedAt": "2020-01-13T14:33:39Z", "author": {"login": "mfussenegger"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4-W5sgH2gAyMzYxNDk3OTIyOmEwNzAwMWJkYThmZmZjNGY0ZTE3YTNkYTc1NzNlYjc4NDAxZjNmZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb58xBuAFqTM0MTg1OTE4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a07001bda8fffc4f4e17a3da7573eb78401f3ff2", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/a07001bda8fffc4f4e17a3da7573eb78401f3ff2", "committedDate": "2020-01-10T13:13:49Z", "message": "Support table functions with schema in the parser"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d868f5ba3c8ff7fe522b78ce20d9cda1ce886786", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/d868f5ba3c8ff7fe522b78ce20d9cda1ce886786", "committedDate": "2020-01-10T15:17:04Z", "message": "WIP: Add a pg_get_keywords table function"}, "afterCommit": {"oid": "d0954dda89a12f87cc608e6a5c8dd51850f6c3be", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/d0954dda89a12f87cc608e6a5c8dd51850f6c3be", "committedDate": "2020-01-10T21:14:12Z", "message": "WIP: Add a pg_get_keywords table function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d0954dda89a12f87cc608e6a5c8dd51850f6c3be", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/d0954dda89a12f87cc608e6a5c8dd51850f6c3be", "committedDate": "2020-01-10T21:14:12Z", "message": "WIP: Add a pg_get_keywords table function"}, "afterCommit": {"oid": "b03ed9c811de92d28cd250369f73fa8c1d62b1ac", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/b03ed9c811de92d28cd250369f73fa8c1d62b1ac", "committedDate": "2020-01-13T09:54:18Z", "message": "Add a pg_get_keywords table function"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b03ed9c811de92d28cd250369f73fa8c1d62b1ac", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/b03ed9c811de92d28cd250369f73fa8c1d62b1ac", "committedDate": "2020-01-13T09:54:18Z", "message": "Add a pg_get_keywords table function"}, "afterCommit": {"oid": "314060da1cc3b0ae442fa9a7bf44316f377feafc", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/314060da1cc3b0ae442fa9a7bf44316f377feafc", "committedDate": "2020-01-13T09:57:17Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "314060da1cc3b0ae442fa9a7bf44316f377feafc", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/314060da1cc3b0ae442fa9a7bf44316f377feafc", "committedDate": "2020-01-13T09:57:17Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}, "afterCommit": {"oid": "4a7f646e7282ba80d465abd4a589f555a9baadc9", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/4a7f646e7282ba80d465abd4a589f555a9baadc9", "committedDate": "2020-01-13T10:16:07Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODI4MDM2", "url": "https://github.com/crate/crate/pull/9500#pullrequestreview-341828036", "createdAt": "2020-01-13T13:04:31Z", "commit": {"oid": "4a7f646e7282ba80d465abd4a589f555a9baadc9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzowNDozMVrOFc2L0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMzowNDozMVrOFc2L0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTc5MjIxMA==", "bodyText": "wouldn't it make sense to store this map result into a static var?", "url": "https://github.com/crate/crate/pull/9500#discussion_r365792210", "createdAt": "2020-01-13T13:04:31Z", "author": {"login": "seut"}, "path": "sql/src/main/java/io/crate/expression/tablefunctions/PgGetKeywordsFunction.java", "diffHunk": "@@ -0,0 +1,137 @@\n+/*\n+ * Licensed to Crate under one or more contributor license agreements.\n+ * See the NOTICE file distributed with this work for additional\n+ * information regarding copyright ownership.  Crate licenses this file\n+ * to you under the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.  You may\n+ * obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or\n+ * implied.  See the License for the specific language governing\n+ * permissions and limitations under the License.\n+ *\n+ * However, if you have executed another commercial license agreement\n+ * with Crate these terms will supersede the license and you may use the\n+ * software solely pursuant to the terms of the relevant commercial\n+ * agreement.\n+ */\n+\n+package io.crate.expression.tablefunctions;\n+\n+import io.crate.action.sql.SessionContext;\n+import io.crate.analyze.WhereClause;\n+import io.crate.data.Input;\n+import io.crate.data.Row;\n+import io.crate.data.RowN;\n+import io.crate.metadata.BaseFunctionResolver;\n+import io.crate.metadata.ColumnIdent;\n+import io.crate.metadata.FunctionIdent;\n+import io.crate.metadata.FunctionImplementation;\n+import io.crate.metadata.FunctionInfo;\n+import io.crate.metadata.FunctionName;\n+import io.crate.metadata.Reference;\n+import io.crate.metadata.ReferenceIdent;\n+import io.crate.metadata.RelationName;\n+import io.crate.metadata.Routing;\n+import io.crate.metadata.RoutingProvider;\n+import io.crate.metadata.RowGranularity;\n+import io.crate.metadata.TransactionContext;\n+import io.crate.metadata.functions.params.FuncParams;\n+import io.crate.metadata.pgcatalog.PgCatalogSchemaInfo;\n+import io.crate.metadata.table.StaticTableInfo;\n+import io.crate.metadata.table.TableInfo;\n+import io.crate.metadata.tablefunctions.TableFunctionImplementation;\n+import io.crate.sql.Identifiers;\n+import io.crate.types.DataType;\n+import io.crate.types.DataTypes;\n+import io.crate.types.ObjectType;\n+import org.elasticsearch.cluster.ClusterState;\n+\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Locale;\n+\n+public final class PgGetKeywordsFunction extends TableFunctionImplementation<List<Object>> {\n+\n+    public static final String NAME = \"pg_get_keywords\";\n+    private static final FunctionName FUNCTION_NAME = new FunctionName(PgCatalogSchemaInfo.NAME, NAME);\n+    private static final RelationName REL_NAME = new RelationName(PgCatalogSchemaInfo.NAME, NAME);\n+    private static final PgGetKeywordsFunction INSTANCE = new PgGetKeywordsFunction();\n+    private final FunctionInfo info;\n+\n+    public static void register(TableFunctionModule module) {\n+        module.register(\n+            FUNCTION_NAME,\n+            new BaseFunctionResolver(FuncParams.NONE) {\n+\n+                @Override\n+                public FunctionImplementation getForTypes(List<DataType> argTypes) throws IllegalArgumentException {\n+                    assert argTypes.isEmpty() : \"argument types for pg_get_keywords must be empty due to FuncParams definition\";\n+                    return PgGetKeywordsFunction.INSTANCE;\n+                }\n+            }\n+        );\n+    }\n+\n+    static class Columns {\n+        static final ColumnIdent WORD = new ColumnIdent(\"word\");\n+        static final ColumnIdent CATCODE = new ColumnIdent(\"catcode\");\n+        static final ColumnIdent CATDESC = new ColumnIdent(\"catdesc\");\n+    }\n+\n+    public PgGetKeywordsFunction() {\n+        info = new FunctionInfo(\n+            new FunctionIdent(FUNCTION_NAME, List.of()),\n+            ObjectType.untyped(),\n+            FunctionInfo.Type.TABLE\n+        );\n+    }\n+\n+    @Override\n+    public TableInfo createTableInfo() {\n+        LinkedHashMap<ColumnIdent, Reference> columnMap = new LinkedHashMap<>();\n+        columnMap.put(\n+            Columns.WORD,\n+            new Reference(new ReferenceIdent(REL_NAME, Columns.WORD), RowGranularity.DOC, DataTypes.STRING, 0, null)\n+        );\n+        columnMap.put(\n+            Columns.CATCODE,\n+            new Reference(new ReferenceIdent(REL_NAME, Columns.CATCODE), RowGranularity.DOC, DataTypes.STRING, 1, null)\n+        );\n+        columnMap.put(\n+            Columns.CATDESC,\n+            new Reference(new ReferenceIdent(REL_NAME, Columns.CATDESC), RowGranularity.DOC, DataTypes.STRING, 2, null)\n+        );\n+        return new StaticTableInfo<>(REL_NAME, columnMap, columnMap.values(), List.of()) {\n+\n+            @Override\n+            public Routing getRouting(ClusterState state,\n+                                      RoutingProvider routingProvider,\n+                                      WhereClause whereClause,\n+                                      RoutingProvider.ShardSelection shardSelection,\n+                                      SessionContext sessionContext) {\n+                return Routing.forTableOnSingleNode(REL_NAME, state.getNodes().getLocalNodeId());\n+            }\n+        };\n+    }\n+\n+    @Override\n+    public Iterable<Row> evaluate(TransactionContext txnCtx, Input<List<Object>>... args) {\n+        return () -> Identifiers.KEYWORDS.stream()\n+            .map(keyword -> (Row) new RowN(\n+                keyword.getWord().toLowerCase(Locale.ENGLISH),\n+                keyword.isReserved() ? \"R\" : \"U\",\n+                keyword.isReserved() ? \"reserved\" : \"unreserved\"\n+            ))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a7f646e7282ba80d465abd4a589f555a9baadc9"}, "originalPosition": 129}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02ae07d742cd812ed8c0f078eb276d8f85bc034a", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/02ae07d742cd812ed8c0f078eb276d8f85bc034a", "committedDate": "2020-01-13T13:51:50Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4a7f646e7282ba80d465abd4a589f555a9baadc9", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/4a7f646e7282ba80d465abd4a589f555a9baadc9", "committedDate": "2020-01-13T10:16:07Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}, "afterCommit": {"oid": "02ae07d742cd812ed8c0f078eb276d8f85bc034a", "author": {"user": {"login": "mfussenegger", "name": "Mathias Fu\u00dfenegger"}}, "url": "https://github.com/crate/crate/commit/02ae07d742cd812ed8c0f078eb276d8f85bc034a", "committedDate": "2020-01-13T13:51:50Z", "message": "Add a pg_get_keywords table function\n\nFor better compatibility with PostgreSQL.\n\nThe function is used in the PostgreSQL JDBC client in a query that is\ninvoked when `getSQLKeywords` on `DatabaseMetaData` is called.\n\nWe could also use the information in `crash` or the admin-ui for keyword\nhighlighting and completion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODU5MTgx", "url": "https://github.com/crate/crate/pull/9500#pullrequestreview-341859181", "createdAt": "2020-01-13T13:56:28Z", "commit": {"oid": "02ae07d742cd812ed8c0f078eb276d8f85bc034a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3895, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}