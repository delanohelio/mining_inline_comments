{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwNzQ2MjA4", "number": 10711, "title": "Fix functions resolution for text types with different limit lengths.", "bodyText": "Summary of the changes / Why this improves CrateDB\nThe function with signatures like func(E, E) would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\nIf both text types use length limit, then the common type\nwill be the text type with the highest length limit.\nIf either of text types is unbound, then the common type\nwill be the unbound text type.\n\nChecklist\n\n Added an entry in CHANGES.txt for user facing changes\n Updated documentation & sql_features table for user facing changes\n Touched code is covered by tests\n CLA is signed\n This does not contain breaking changes, or if it does:\n\nIt is released within a major release\nIt is recorded in CHANGES.txt\nIt was marked as deprecated in an earlier release if possible\nYou've thought about the consequences and other components are adapted\n(E.g. AdminUI)", "createdAt": "2020-10-27T13:17:32Z", "url": "https://github.com/crate/crate/pull/10711", "merged": true, "mergeCommit": {"oid": "0312972713071214ee27af408989a32f6cb58fe1"}, "closed": true, "closedAt": "2020-10-28T12:22:58Z", "author": {"login": "kovrus"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWpRvJgBqjM5MjYwMjY3NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW8IsRAH2gAyNTEwNzQ2MjA4OmJlNWMxZGViNjY3Zjc1ZDExODJiNTk4NGI0ZjIwMjY0MzgwMzJlMmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a784ec829812f7b473f6894e36fddb802895015", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/9a784ec829812f7b473f6894e36fddb802895015", "committedDate": "2020-10-27T13:08:43Z", "message": "Fix functions resolution for text types with different limit lengths."}, "afterCommit": {"oid": "35d83ed83aaacfe26b89e06ce922854c0bb229bd", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/35d83ed83aaacfe26b89e06ce922854c0bb229bd", "committedDate": "2020-10-27T13:43:22Z", "message": "Fix functions resolution for text types with different limit lengths.\n\nThe function with signatures like `func(E, E)` would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\n1. If both text types use length limit, then the common type\nwill be the text type with the lowest lenght limit.\n2. If either of text types is unbound, then the common type\nwill be the unbound text type."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5eb838891b4cfe075cb9283caa7dc81016ad5899", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/5eb838891b4cfe075cb9283caa7dc81016ad5899", "committedDate": "2020-10-28T09:06:20Z", "message": "fixup! Fix functions resolution for text types with different limit lengths."}, "afterCommit": {"oid": "ec2b5820a4ff4730f8cc7d501a05673eaf334922", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/ec2b5820a4ff4730f8cc7d501a05673eaf334922", "committedDate": "2020-10-28T09:08:28Z", "message": "fixup! Fix functions resolution for text types with different limit lengths."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDUzNjU0", "url": "https://github.com/crate/crate/pull/10711#pullrequestreview-518453654", "createdAt": "2020-10-28T09:12:37Z", "commit": {"oid": "ec2b5820a4ff4730f8cc7d501a05673eaf334922"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOToxMjozN1rOHpgZ7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOToxMzoyNlrOHpgbww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4NDU5MA==", "bodyText": "Not sure if these additional tests here adds something here compared to the new signature binder and type tests. Also no strong opinion here..", "url": "https://github.com/crate/crate/pull/10711#discussion_r513284590", "createdAt": "2020-10-28T09:12:37Z", "author": {"login": "seut"}, "path": "server/src/test/java/io/crate/analyze/expressions/ExpressionAnalyzerTest.java", "diffHunk": "@@ -360,4 +364,26 @@ public void test_partial_quoted_subscript() {\n         symbol = executor.asSymbol(\"nested_obj.\\\"myObj['x']\\\"['AbC']\");\n         assertThat(symbol, isReference(\"myObj['x']['AbC']\"));\n     }\n+\n+    @Test\n+    public void test_resolve_eq_function_for_text_types_with_length_limit_and_unbound() throws IOException {\n+        var e = SQLExecutor.builder(clusterService)\n+            .addTable(\"create table tbl (str varchar(3))\")\n+            .build();\n+        var eq = (Function) e.asSymbol(\"tbl.str = 'abc'\");\n+        assertThat(\n+            Lists2.map(eq.arguments(), Symbol::valueType),\n+            contains(DataTypes.STRING, DataTypes.STRING));\n+    }\n+\n+    @Test\n+    public void test_resolve_eq_function_for_text_types_with_different_limit_length() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec2b5820a4ff4730f8cc7d501a05673eaf334922"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzI4NTA1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            - Fixed an issue that would prevent functions resolution for the arguments\n          \n          \n            \n            - Fixed an issue that would prevent function resolution for arguments", "url": "https://github.com/crate/crate/pull/10711#discussion_r513285059", "createdAt": "2020-10-28T09:13:26Z", "author": {"login": "seut"}, "path": "docs/appendices/release-notes/unreleased.rst", "diffHunk": "@@ -60,6 +60,13 @@ Changes\n Fixes\n =====\n \n+- Fixed an issue that would prevent functions resolution for the arguments", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ec2b5820a4ff4730f8cc7d501a05673eaf334922"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NDg1NzYx", "url": "https://github.com/crate/crate/pull/10711#pullrequestreview-518485761", "createdAt": "2020-10-28T09:50:14Z", "commit": {"oid": "163939d47fe562748f54131b6ed63eabb853aeff"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo1MDoxNVrOHph6iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQwOTo1MDoxNVrOHph6iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzMwOTMyMw==", "bodyText": "It would also be possible to return the instance with the higher length to avoid creating a new one.\nI doubt it has any significant impact, but the logic wouldn't really be more complicated either.", "url": "https://github.com/crate/crate/pull/10711#discussion_r513309323", "createdAt": "2020-10-28T09:50:15Z", "author": {"login": "mfussenegger"}, "path": "server/src/main/java/io/crate/types/TypeCompatibility.java", "diffHunk": "@@ -94,8 +94,20 @@\n         if (fromTypeParameters.size() != toTypeParameters.size()) {\n             if (fromType.id() == ObjectType.ID && toType.id() == ObjectType.ID) {\n                 return fromTypeParameters.size() > toTypeParameters.size() ? fromType : toType;\n+            } else if (fromType.id() == StringType.ID && toType.id() == StringType.ID) {\n+                if (((StringType) fromType).unbound() || ((StringType) toType).unbound()) {\n+                    return StringType.INSTANCE;\n+                }\n             }\n             return null;\n+        } else {\n+            if (fromType.id() == StringType.ID && toType.id() == StringType.ID) {\n+                var highestLengthLimit = Math.max(\n+                    ((StringType) fromType).lengthLimit(),\n+                    ((StringType) toType).lengthLimit()\n+                );\n+                return StringType.of(highestLengthLimit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "163939d47fe562748f54131b6ed63eabb853aeff"}, "originalPosition": 16}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "163939d47fe562748f54131b6ed63eabb853aeff", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/163939d47fe562748f54131b6ed63eabb853aeff", "committedDate": "2020-10-28T09:15:54Z", "message": "fixup! fixup! Fix functions resolution for text types with different limit lengths."}, "afterCommit": {"oid": "245b7efc2cfede17555c7ab71568b77bd2952690", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/245b7efc2cfede17555c7ab71568b77bd2952690", "committedDate": "2020-10-28T09:57:59Z", "message": "Fix functions resolution for text types with different limit lengths.\n\nThe function with signatures like `func(E, E)` would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\n1. If both text types use length limit, then the common type\nwill be the text type with the highest lenght limit.\n2. If either of text types is unbound, then the common type\nwill be the unbound text type."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85b64582b8a4aa2daf9188199c5aece76de46ab1", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/85b64582b8a4aa2daf9188199c5aece76de46ab1", "committedDate": "2020-10-28T11:12:35Z", "message": "Fix functions resolution for text types with different limit lengths.\n\nThe function with signatures like `func(E, E)` would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\n1. If both text types use length limit, then the common type\nwill be the text type with the highest lenght limit.\n2. If either of text types is unbound, then the common type\nwill be the unbound text type."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "245b7efc2cfede17555c7ab71568b77bd2952690", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/245b7efc2cfede17555c7ab71568b77bd2952690", "committedDate": "2020-10-28T09:57:59Z", "message": "Fix functions resolution for text types with different limit lengths.\n\nThe function with signatures like `func(E, E)` would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\n1. If both text types use length limit, then the common type\nwill be the text type with the highest lenght limit.\n2. If either of text types is unbound, then the common type\nwill be the unbound text type."}, "afterCommit": {"oid": "85b64582b8a4aa2daf9188199c5aece76de46ab1", "author": {"user": {"login": "kovrus", "name": "Ruslan Kovalov"}}, "url": "https://github.com/crate/crate/commit/85b64582b8a4aa2daf9188199c5aece76de46ab1", "committedDate": "2020-10-28T11:12:35Z", "message": "Fix functions resolution for text types with different limit lengths.\n\nThe function with signatures like `func(E, E)` would fail to\nbind arguments of type text if they have different limit lengths.\nThis change fixes the inference of the common text type for provided\ntext arguments by following two rules:\n\n1. If both text types use length limit, then the common type\nwill be the text type with the highest lenght limit.\n2. If either of text types is unbound, then the common type\nwill be the unbound text type."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be5c1deb667f75d1182b5984b4f2026438032e2c", "author": {"user": {"login": "mergify[bot]", "name": null}}, "url": "https://github.com/crate/crate/commit/be5c1deb667f75d1182b5984b4f2026438032e2c", "committedDate": "2020-10-28T11:47:22Z", "message": "Merge branch 'master' into r/fix-text-limit-functions-resolution"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3740, "cost": 1, "resetAt": "2021-11-01T13:51:04Z"}}}