{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxODQxMDI5", "number": 3180, "title": "TRUNK-5146: Use Java streams in UserServiceImpl#checkPrivileges(User)", "bodyText": "https://issues.openmrs.org/browse/TRUNK-5146\nin this ticket , created a subclass checkSuperUserRole and modified it whith checkPrivilege. Added some tests for that\ncc @ibacher\n\n\n\nDescription of what I changed\n\n\nIssue I worked on\n\n\n\n\nsee https://issues.openmrs.org/browse/TRUNK-\nChecklist: I completed these to help reviewers :)\n\n\n\n\n My pull request only contains ONE single commit\n(the number above, next to the 'Commits' tab is 1).\nNo? -> read here on how to squash multiple commits into one\n\n\n My IDE is configured to follow the code style of this project.\nNo? Unsure? -> configure your IDE, format the code and add the changes with git add . && git commit --amend\n\n\n I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\nNo? -> write tests and add them to this commit git add . && git commit --amend\n\n\n I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\nNo? -> execute above command\n\n\n All new and existing tests passed.\nNo? -> figure out why and add the fix to your commit. It is your responsibility to make sure your code works.\n\n\n My pull request is based on the latest changes of the master branch.\nNo? Unsure? -> execute command git pull --rebase upstream master", "createdAt": "2020-04-10T09:48:22Z", "url": "https://github.com/openmrs/openmrs-core/pull/3180", "merged": true, "mergeCommit": {"oid": "b1c8d5be60b18498fa47b221cc59a785852ee8c0"}, "closed": true, "closedAt": "2020-04-16T19:13:46Z", "author": {"login": "sherrif10"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWRC5bAFqTM5MTQzOTUyNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYRamHAH2gAyNDAxODQxMDI5OjNlNzU0NzdhOTgwZjQ0NGI1MDczMTU2NGU4ZGJlNGU5NGRmYWQ4YzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDM5NTI3", "url": "https://github.com/openmrs/openmrs-core/pull/3180#pullrequestreview-391439527", "createdAt": "2020-04-10T13:23:58Z", "commit": {"oid": "0decca00bffe2f508b9b79415a95f50d613edca0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoyMzo1OFrOGD6YRg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoyMzo1OFrOGD6YRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1NTM5OA==", "bodyText": "This is the cause of the error. This line should be User.you.must.have.privileges (note the \"s\" on the end).", "url": "https://github.com/openmrs/openmrs-core/pull/3180#discussion_r406755398", "createdAt": "2020-04-10T13:23:58Z", "author": {"login": "ibacher"}, "path": "api/src/main/resources/messages.properties", "diffHunk": "@@ -2177,6 +2177,7 @@ User.creating.already.exists=The user {0} already exists, it could therefore not\n User.setPersonId=You need to call setPerson(Person)\n User.you.must.have.privilege=You must have privilege '{0}' in order to assign it.\n User.you.must.have.role=You must have the role '{0}' in order to assign it.\n+User.you.must.have.privilege=User you must have the following privileges in order to assign them: {0}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0decca00bffe2f508b9b79415a95f50d613edca0"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDcwMzg2", "url": "https://github.com/openmrs/openmrs-core/pull/3180#pullrequestreview-391470386", "createdAt": "2020-04-10T14:26:16Z", "commit": {"oid": "bfcef4fff7229abd704ed694afc5047167b51fcb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNDoyNjoxNlrOGD7-NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNDoyNzo1OFrOGD8BLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc4MTQ5Mg==", "bodyText": "Could you un-indent these lines here by one tab?", "url": "https://github.com/openmrs/openmrs-core/pull/3180#discussion_r406781492", "createdAt": "2020-04-10T14:26:16Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/api/UserServiceTest.java", "diffHunk": "@@ -280,7 +282,43 @@ public void createUser_shouldNotAllowSystemIdEqualsUsernameWithLuhnCheckDigit()\n \t\t\t\t\t\tnewUser.getSystemId()));\n \t\tuserService.createUser(newUser, SOME_VALID_PASSWORD);\n \t}\n-\n+\t@Test\n+\tpublic void createUser_shouldNotAllowCreatingUserWithPrivilegeCurrentUserDoesNotHave() throws IllegalAccessException {\n+\t\t//setup the currently logged in user\n+\t\t\t\tUser currentUser = new User();\n+\t\t\t\tRole userRole = new Role(\"User Adder\");\n+\t\t\t\tuserRole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\tuserRole.addPrivilege(new Privilege(\"Add Users\"));\n+\t\t\t\tcurrentUser.addRole(userRole);\n+\t\t\t\t// setup our expected exception\n+\t\t\t\t// we expect this to fail because the currently logged-in user lacks a privilege to be\n+\t\t\t\t// assigned to the new user\n+\t\t\t\texpectedException.expect(APIException.class);\n+\t\t\t\texpectedException.expectMessage(\"You must have privilege {0} in order to assign it\");\n+\t\t\t\t// set current user to the user defined above\n+\t\t\t\twithCurrentUserAs(currentUser, () -> {\n+\t\t\t\t\t// create a role to assign to the new user\n+\t\t\t\t\tRole role = new Role();\n+\t\t\t\t\trole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\t\trole.addPrivilege(new Privilege(\"Custom Privilege\"));// add a privilege to the role\n+\n+\t\t\t\t\t// create our new user object with the required fields\n+\t\t\t\t\tUser u = new User();\n+\t\t\t\t\tu.setPerson(new Person());\n+\t\t\t\t\t// assign the specified role to the user\n+\t\t\t\t\tu.addName(new PersonName(\"Benjamin\", \"A\", \"Wolfe\"));\n+\t\t\t\t\tu.setUsername(\"bwolfe\");\n+\t\t\t\t\tu.getPerson().setGender(\"M\");\n+\t\t\t\t\tu.addRole(role);\n+\t\t\t\t\t// here we expect the exception to be thrown\n+\t\t\t\t\tuserService.createUser(u, \"Openmr5xy\");\n+\t\t\t\t});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcef4fff7229abd704ed694afc5047167b51fcb"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc4MTgzMg==", "bodyText": "The comment here should be above the line it comments on", "url": "https://github.com/openmrs/openmrs-core/pull/3180#discussion_r406781832", "createdAt": "2020-04-10T14:27:04Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/api/UserServiceTest.java", "diffHunk": "@@ -280,7 +282,43 @@ public void createUser_shouldNotAllowSystemIdEqualsUsernameWithLuhnCheckDigit()\n \t\t\t\t\t\tnewUser.getSystemId()));\n \t\tuserService.createUser(newUser, SOME_VALID_PASSWORD);\n \t}\n-\n+\t@Test\n+\tpublic void createUser_shouldNotAllowCreatingUserWithPrivilegeCurrentUserDoesNotHave() throws IllegalAccessException {\n+\t\t//setup the currently logged in user\n+\t\t\t\tUser currentUser = new User();\n+\t\t\t\tRole userRole = new Role(\"User Adder\");\n+\t\t\t\tuserRole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\tuserRole.addPrivilege(new Privilege(\"Add Users\"));\n+\t\t\t\tcurrentUser.addRole(userRole);\n+\t\t\t\t// setup our expected exception\n+\t\t\t\t// we expect this to fail because the currently logged-in user lacks a privilege to be\n+\t\t\t\t// assigned to the new user\n+\t\t\t\texpectedException.expect(APIException.class);\n+\t\t\t\texpectedException.expectMessage(\"You must have privilege {0} in order to assign it\");\n+\t\t\t\t// set current user to the user defined above\n+\t\t\t\twithCurrentUserAs(currentUser, () -> {\n+\t\t\t\t\t// create a role to assign to the new user\n+\t\t\t\t\tRole role = new Role();\n+\t\t\t\t\trole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\t\trole.addPrivilege(new Privilege(\"Custom Privilege\"));// add a privilege to the role", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcef4fff7229abd704ed694afc5047167b51fcb"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc4MjI1NA==", "bodyText": "The body here should look identical to the above test except that we should assign two privileges to role and we should expect the User you must have the following privileges in order to assign them: {0} message.", "url": "https://github.com/openmrs/openmrs-core/pull/3180#discussion_r406782254", "createdAt": "2020-04-10T14:27:58Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/api/UserServiceTest.java", "diffHunk": "@@ -280,7 +282,43 @@ public void createUser_shouldNotAllowSystemIdEqualsUsernameWithLuhnCheckDigit()\n \t\t\t\t\t\tnewUser.getSystemId()));\n \t\tuserService.createUser(newUser, SOME_VALID_PASSWORD);\n \t}\n-\n+\t@Test\n+\tpublic void createUser_shouldNotAllowCreatingUserWithPrivilegeCurrentUserDoesNotHave() throws IllegalAccessException {\n+\t\t//setup the currently logged in user\n+\t\t\t\tUser currentUser = new User();\n+\t\t\t\tRole userRole = new Role(\"User Adder\");\n+\t\t\t\tuserRole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\tuserRole.addPrivilege(new Privilege(\"Add Users\"));\n+\t\t\t\tcurrentUser.addRole(userRole);\n+\t\t\t\t// setup our expected exception\n+\t\t\t\t// we expect this to fail because the currently logged-in user lacks a privilege to be\n+\t\t\t\t// assigned to the new user\n+\t\t\t\texpectedException.expect(APIException.class);\n+\t\t\t\texpectedException.expectMessage(\"You must have privilege {0} in order to assign it\");\n+\t\t\t\t// set current user to the user defined above\n+\t\t\t\twithCurrentUserAs(currentUser, () -> {\n+\t\t\t\t\t// create a role to assign to the new user\n+\t\t\t\t\tRole role = new Role();\n+\t\t\t\t\trole.setRole(RoleConstants.AUTHENTICATED);\n+\t\t\t\t\trole.addPrivilege(new Privilege(\"Custom Privilege\"));// add a privilege to the role\n+\n+\t\t\t\t\t// create our new user object with the required fields\n+\t\t\t\t\tUser u = new User();\n+\t\t\t\t\tu.setPerson(new Person());\n+\t\t\t\t\t// assign the specified role to the user\n+\t\t\t\t\tu.addName(new PersonName(\"Benjamin\", \"A\", \"Wolfe\"));\n+\t\t\t\t\tu.setUsername(\"bwolfe\");\n+\t\t\t\t\tu.getPerson().setGender(\"M\");\n+\t\t\t\t\tu.addRole(role);\n+\t\t\t\t\t// here we expect the exception to be thrown\n+\t\t\t\t\tuserService.createUser(u, \"Openmr5xy\");\n+\t\t\t\t});\n+\t}\n+\t\t\t\t\n+\t@Test\n+\tpublic void createUser_shouldNotAllowAssigningSuperUserRoleIfCurrentUserDoesnotHaveAssignSystemDeveloperPrivileges() throws IllegalAccessException {\n+\t\t\t\t", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfcef4fff7229abd704ed694afc5047167b51fcb"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NzYwNzA1", "url": "https://github.com/openmrs/openmrs-core/pull/3180#pullrequestreview-394760705", "createdAt": "2020-04-16T15:40:06Z", "commit": {"oid": "1be3b614424dcb341dfb7b1b101fa8980dedbbd1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0MDowNlrOGGrdhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxNTo0MDowNlrOGGrdhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTY1NjcwOA==", "bodyText": "This commit does way too much, which is why the test fails.\n\nThe point of wrapping things in the withCurrentUserAs() function is that this enables us to set the current executing user to a particular user. By default, the executing user for these tests is \"admin\", so this test won't fail as expected.\nThe call to role.hasPrivilege(PrivilegeConstants.ASSIGN_SYSTEM_DEVELOPER_ROLE); doesn't do anything at all. Or rather, it checks to see if the role has that privilege but by itself, that won't throw the error we're expecting, which happens in the checkSuperUserPrivilege() code.\n\nMy advice would be to undo this last commit and make a much simpler commit that simply changes this line:\nexpectedException.expectMessage(\"User you must have the following privileges in order to assign them: {0}\"); \nTo this:\nexpectedException.expectMessage(\"You must have the role {0} in order to assign it\"); \nYou can undo the last commit by running: git reset --hard HEAD~1.", "url": "https://github.com/openmrs/openmrs-core/pull/3180#discussion_r409656708", "createdAt": "2020-04-16T15:40:06Z", "author": {"login": "ibacher"}, "path": "api/src/test/java/org/openmrs/api/UserServiceTest.java", "diffHunk": "@@ -353,7 +350,7 @@ public void createUser_shouldNotAllowAssigningSuperUserRoleIfCurrentUserDoesnotH\n \t\t\tu.addRole(role);\n \t\t\t// here we expect the exception to be thrown\n \t\t\tuserService.createUser(u, \"Openmr5xy\");\n-\t\t});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1be3b614424dcb341dfb7b1b101fa8980dedbbd1"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0ODkxMDA2", "url": "https://github.com/openmrs/openmrs-core/pull/3180#pullrequestreview-394891006", "createdAt": "2020-04-16T18:24:02Z", "commit": {"oid": "e68a551dc47c4f8afcf25ff678bd7de831fef5fc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e75477a980f444b50731564e8dbe4e94dfad8c4", "author": {"user": {"login": "sherrif10", "name": "MAGEMBE SHARIF"}}, "url": "https://github.com/openmrs/openmrs-core/commit/3e75477a980f444b50731564e8dbe4e94dfad8c4", "committedDate": "2020-04-16T18:57:42Z", "message": "User java Streams for userServiceImpl"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4760, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}