{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMzMTA5ODU4", "number": 3241, "title": "TRUNK-5746: Refactor getSimilar to use Lucene for 3 names", "bodyText": "Description of what I changed\nThis PR is a successor of #3152 now targeting the 3 names component as well.  Please have a look to is before starting the review.\nA discussion emerges in in case you need more details regarding the implementation strategy: https://talk.openmrs.org/t/soundex-search-in-lucenequeries/26068/37?u=fruether\n@ibacher In case you start testing may use this PR since it as well contains the 3-names search functionality.\nIssue I worked on\n\n\n\n\nsee https://issues.openmrs.org/browse/TRUNK-5746\nChecklist: I completed these to help reviewers :)\n\n\n\n\n My IDE is configured to follow the code style of this project.\nNo? Unsure? -> configure your IDE, format the code and add the changes with git add . && git commit --amend\n\n\n I have added tests to cover my changes. (If you refactored\nexisting code that was well tested you do not have to add tests)\nNo? -> write tests and add them to this commit git add . && git commit --amend\n\n\n I ran mvn clean package right before creating this pull request and\nadded all formatting changes to my commit.\nNo? -> execute above command\n\n\n All new and existing tests passed.\nNo? -> figure out why and add the fix to your commit. It is your responsibility to make sure your code works.\n\n\n My pull request is based on the latest changes of the master branch.\nNo? Unsure? -> execute command git pull --rebase upstream master", "createdAt": "2020-06-11T14:15:00Z", "url": "https://github.com/openmrs/openmrs-core/pull/3241", "merged": true, "mergeCommit": {"oid": "45c3d7c7291c31def139f2cfb2b2b786cec833e2"}, "closed": true, "closedAt": "2020-10-06T16:12:58Z", "author": {"login": "fruether"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3hm_FABqjM1Nzc2MTI4MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNF94ZABqjM4MTIwMjUyNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c691f08b039c694b3d01d0cbc7b1273c6b6724cb", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/c691f08b039c694b3d01d0cbc7b1273c6b6724cb", "committedDate": "2020-07-22T21:19:04Z", "message": "Merge"}, "afterCommit": {"oid": "8a9397475754d0460d11ee7fd286bc265c8ae9ae", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/8a9397475754d0460d11ee7fd286bc265c8ae9ae", "committedDate": "2020-07-22T21:20:49Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a9397475754d0460d11ee7fd286bc265c8ae9ae", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/8a9397475754d0460d11ee7fd286bc265c8ae9ae", "committedDate": "2020-07-22T21:20:49Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "db4dabeeb73f3f09df7160fdebac24ba7ba76368", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/db4dabeeb73f3f09df7160fdebac24ba7ba76368", "committedDate": "2020-07-22T21:25:51Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "db4dabeeb73f3f09df7160fdebac24ba7ba76368", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/db4dabeeb73f3f09df7160fdebac24ba7ba76368", "committedDate": "2020-07-22T21:25:51Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "1e661cfb2ad49ab30f364e994ca238a98872b6d1", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/1e661cfb2ad49ab30f364e994ca238a98872b6d1", "committedDate": "2020-07-22T21:28:50Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e661cfb2ad49ab30f364e994ca238a98872b6d1", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/1e661cfb2ad49ab30f364e994ca238a98872b6d1", "committedDate": "2020-07-22T21:28:50Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/406a5a36094181617a2a080b16411c06ad0f20ba", "committedDate": "2020-07-22T21:31:08Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzAwNDk3", "url": "https://github.com/openmrs/openmrs-core/pull/3241#pullrequestreview-453700497", "createdAt": "2020-07-22T21:31:42Z", "commit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTozMTo0M1rOG10-4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQyMTozMTo0M1rOG10-4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTA5NTc3Nw==", "bodyText": "Must have happened by git pull rebase....", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r459095777", "createdAt": "2020-07-22T21:31:43Z", "author": {"login": "fruether"}, "path": ".github/workflows/stale.yml", "diffHunk": "@@ -12,7 +12,6 @@ jobs:\n         repo-token: ${{ secrets.GITHUB_TOKEN }}\n         days-before-stale: 150\n         days-before-close: 30\n-        debug-only: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MzkyNjY0", "url": "https://github.com/openmrs/openmrs-core/pull/3241#pullrequestreview-459392664", "createdAt": "2020-07-31T18:56:32Z", "commit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxODo1NjozMlrOG6Sw1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxODo1NjozMlrOG6Sw1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2Mzc3ODAwNg==", "bodyText": "It seems to me we should at least run LuceneQuery.escapeQuery() on these parameters. But is there a way we could do this more cleanly, i.e., by passing these as paramters instead of a string replace operation?\nIf not, we should at least have this query stored as a constant string since we really just need to do some replacements right before it's executed.", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r463778006", "createdAt": "2020-07-31T18:56:32Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java", "diffHunk": "@@ -112,6 +112,28 @@ public PersonLuceneQuery(SessionFactory sessionFactory) {\n \t * @param gender the gender of the person to search  \n \t * @return the LuceneQuery that returns Persons with a soundex representation of the firstName and other defined search criteria\n \t */\n+\tpublic LuceneQuery<PersonName> getSoundexPersonNameSearchOnThreeNames(String n1, String n2, String n3,  Integer birthyear, boolean includeVoided, String gender) {\n+\t\tString threeNameQuery = \"\";\n+\t\tString givenNameMatchCondition = \"(givenNameSoundex:n1^6 OR givenNameSoundex:n2^2 OR givenNameSoundex:n3)\";\n+\t\tString middleNameMatchCondition = \"(middleNameSoundex:n1^2 OR middleNameSoundex:n2^6 OR middleNameSoundex:n3^1)\";\n+\t\tString familyNameMatchCondition = \"(familyNameSoundex:n1^1 OR familyNameSoundex:n2^2 OR familyNameSoundex:n3^6)\";\n+\t\tString familyName2MatchCondition = \"(familyName2Soundex:n1^1 OR familyName2Soundex:n2^2 OR familyName2Soundex:n3^6)\";\n+\t\t\n+\t\tthreeNameQuery = givenNameMatchCondition+ \" OR \" + middleNameMatchCondition + \" OR \" + familyNameMatchCondition + \" OR \" + familyName2MatchCondition;\n+ \t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba"}, "originalPosition": 12}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "406a5a36094181617a2a080b16411c06ad0f20ba", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/406a5a36094181617a2a080b16411c06ad0f20ba", "committedDate": "2020-07-22T21:31:08Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "f755017582ff3757441af981a265804635241793", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/f755017582ff3757441af981a265804635241793", "committedDate": "2020-08-15T15:25:22Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0OTkyMzY5", "url": "https://github.com/openmrs/openmrs-core/pull/3241#pullrequestreview-484992369", "createdAt": "2020-09-09T13:12:09Z", "commit": {"oid": "f755017582ff3757441af981a265804635241793"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoxMjowOVrOHPGoug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxMzoxNTowOFrOHPGwhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTU5OTQxOA==", "bodyText": "The calls to replace() here are redundant aren't they? I.e., we already did this substitution above.", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485599418", "createdAt": "2020-09-09T13:12:09Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/api/db/hibernate/PersonLuceneQuery.java", "diffHunk": "@@ -112,6 +117,26 @@ public PersonLuceneQuery(SessionFactory sessionFactory) {\n \t * @param gender the gender of the person to search  \n \t * @return the LuceneQuery that returns Persons with a soundex representation of the firstName and other defined search criteria\n \t */\n+\tpublic LuceneQuery<PersonName> getSoundexPersonNameSearchOnThreeNames(String n1, String n2, String n3,  Integer birthyear, boolean includeVoided, String gender) {\n+\t\t\n+\t\tString threeNameQuery =  THREE_NAME_QUERY.replace(\"n1\", LuceneQuery.escapeQuery(n1))\n+\t\t\t.replace(\"n2\", LuceneQuery.escapeQuery(n2))\n+\t\t\t.replace(\"n3\", LuceneQuery.escapeQuery(n3));\n+\t\t\n+\t\tthreeNameQuery = \"(\" +  threeNameQuery.replace(\"n1\", n1).replace(\"n2\", n2).replace(\"n3\", n3) + \")\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f755017582ff3757441af981a265804635241793"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTYwMTQxNA==", "bodyText": "Some comments on this function now:\n\nWe seem to have eliminated the need for the result variable at all, so that should probably be removed.\nThe line StringBuilder q = ... should be moved to the final else block, since that's the only place it's necessary.\nEither the final else block should be removed or everything after the end of the final else block should be added into the final else block as that common logic only applies when we continue to support a case for multiple names.", "url": "https://github.com/openmrs/openmrs-core/pull/3241#discussion_r485601414", "createdAt": "2020-09-09T13:15:08Z", "author": {"login": "ibacher"}, "path": "api/src/main/java/org/openmrs/api/db/hibernate/HibernatePersonDAO.java", "diffHunk": "@@ -202,23 +226,7 @@ public void setSessionFactory(SessionFactory sessionFactory) {\n \t\t} else if (names.length == 2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f755017582ff3757441af981a265804635241793"}, "originalPosition": 32}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "308c78107b7d6547b2f02bfe8405ff59eee5cd61", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/308c78107b7d6547b2f02bfe8405ff59eee5cd61", "committedDate": "2020-09-09T17:01:05Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "4d349ab6acd3f1c04e25594a218096ba0d78af06", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/4d349ab6acd3f1c04e25594a218096ba0d78af06", "committedDate": "2020-09-09T17:26:46Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8a48486ab62db0b5533f16cbc59d29279e43ed1f", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/8a48486ab62db0b5533f16cbc59d29279e43ed1f", "committedDate": "2020-09-13T15:13:29Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "fda2484b8b244560fdbfcbca4328e6566ecb5646", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/fda2484b8b244560fdbfcbca4328e6566ecb5646", "committedDate": "2020-09-13T15:14:08Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fda2484b8b244560fdbfcbca4328e6566ecb5646", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/fda2484b8b244560fdbfcbca4328e6566ecb5646", "committedDate": "2020-09-13T15:14:08Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "d32c9ace466cd916d14c9547418e785bf6952251", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/d32c9ace466cd916d14c9547418e785bf6952251", "committedDate": "2020-09-27T21:28:46Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93e61338799277c351e92409a5cc5dd1233e31ee", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/93e61338799277c351e92409a5cc5dd1233e31ee", "committedDate": "2020-09-27T21:33:42Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05cf25188dba0c0d3e2e69664f7fbe1230fda032", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/05cf25188dba0c0d3e2e69664f7fbe1230fda032", "committedDate": "2020-09-27T21:35:07Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d32c9ace466cd916d14c9547418e785bf6952251", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/d32c9ace466cd916d14c9547418e785bf6952251", "committedDate": "2020-09-27T21:28:46Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}, "afterCommit": {"oid": "05cf25188dba0c0d3e2e69664f7fbe1230fda032", "author": {"user": null}, "url": "https://github.com/openmrs/openmrs-core/commit/05cf25188dba0c0d3e2e69664f7fbe1230fda032", "committedDate": "2020-09-27T21:35:07Z", "message": "TRUNK-5746 - Refactor getSimilar to use Lucene for 3 names"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4857, "cost": 1, "resetAt": "2021-11-01T15:33:45Z"}}}