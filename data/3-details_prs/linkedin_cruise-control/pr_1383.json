{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4MTgzMjQx", "number": 1383, "title": "Ensure that topology distribution goals compute balance constraints properly", "bodyText": "Ensure that RackAwareDistributionGoal, TopicReplicaDistributionGoal, ReplicaDistributionGoal, LeaderReplicaDistributionGoal do not include brokers excluded for replica moves while computing balance constraints.\nFix incorrect numOfflineTopicReplicasInB1 within rebalanceByMovingReplicasIn of TopicReplicaDistributionGoal.\nUpdate the following dead configs, which are not supported after #985 in cruisecontrol.properties:\n\n  broker.failure.exclude.recently.demoted.brokers=true\n  broker.failure.exclude.recently.removed.brokers=true\n  goal.violation.exclude.recently.demoted.brokers=true\n  goal.violation.exclude.recently.removed.brokers=true\n\nThis PR resolves #1382.\n--\nSelected evaluations on a cluster with 10 brokers with 3 brokers permanently marked as excluded -- i.e. preferred controllers of LinkedIn Kafka -- please note standard deviations (lower is better) and averages (closer to average is better).\n\nWith ReplicaDistributionGoal:\nExisting approach (std: 163.3 and avg: 260.18 -- considers all brokers):\n\nLEADERS/REPLICAS\n97/291\n129/387\n0/0\n132/284\n148/387\n129/352\n69/387\n129/387\n121/387\n0/0\n0/0\n\nNew approach (std: 13 and avg: 357.7 -- considers only brokers that are not excluded):\nLEADERS/REPLICAS\n111/364\n125/364\n0/0\n148/325\n141/364\n129/352\n63/364\n119/364\n118/365\n0/0\n0/0\n\n\nWith LeaderReplicaDistributionGoal:\nExisting approach (std: 55 and avg: 86.7 -- considers all brokers):\n\nLEADERS/REPLICAS\n95/387\n124/387\n0/0\n113/188\n148/387\n129/352\n95/387\n129/387\n121/387\n0/0\n0/0\n\nNew approach (std: 6.57 and avg: 119.2 -- considers only brokers that are not excluded):\nLEADERS/REPLICAS\n114/387\n121/387\n0/0\n112/188\n126/387\n124/352\n108/387\n127/387\n122/387\n0/0\n0/0\n\n\nWith TopicReplicaDistributionGoal:\nExisting approach (std: 3.85  and avg: 5  -- considers all brokers):\nNew approach (std: 2.67 and avg: 6.8 -- considers only brokers that are not excluded):", "createdAt": "2020-11-10T03:33:43Z", "url": "https://github.com/linkedin/cruise-control/pull/1383", "merged": true, "mergeCommit": {"oid": "0e273c066a3d01589a0e189eda9b25aa04485ed0"}, "closed": true, "closedAt": "2020-11-11T04:34:40Z", "author": {"login": "efeg"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbAyWPgH2gAyNTE4MTgzMjQxOjk0YWFmZTJiZjU3YjY5ZjdiOGFhNjlmZTI5Y2FkZTgzYTgxMmUwMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbU9XPgFqTUyNzgyNzEzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "94aafe2bf57b69f7b8aa69fe29cade83a812e030", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/94aafe2bf57b69f7b8aa69fe29cade83a812e030", "committedDate": "2020-11-10T03:28:11Z", "message": "Ensure that topology distribution goals compute balance constraints properly.\n* Ensure that RackAwareDistributionGoal, TopicReplicaDistributionGoal, ReplicaDistributionGoal, LeaderReplicaDistributionGoal do not include brokers excluded for replica moves while computing balance constraints.\n* Fix incorect numOfflineTopicReplicasInB1 within rebalanceByMovingReplicasIn of TopicReplicaDistributionGoal.\n* Update the following dead configs, which are not supported after in cruisecontrol.properties in https://github.com/linkedin/cruise-control/pull/985\n  broker.failure.exclude.recently.demoted.brokers=true\n  broker.failure.exclude.recently.removed.brokers=true\n  goal.violation.exclude.recently.demoted.brokers=true\n  goal.violation.exclude.recently.removed.brokers=true"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjkxMDY5", "url": "https://github.com/linkedin/cruise-control/pull/1383#pullrequestreview-527691069", "createdAt": "2020-11-10T23:31:04Z", "commit": {"oid": "94aafe2bf57b69f7b8aa69fe29cade83a812e030"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzozMTowNFrOHwzsBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMzo0NzoxMlrOHw0DEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0MDU1MQ==", "bodyText": "Nit: Consider making it more memory efficient.\ntopicsToRebalance = new HashSet<>(clusterModel.selfHealingEligibleReplicas().size())", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r520940551", "createdAt": "2020-11-10T23:31:04Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/GoalUtils.java", "diffHunk": "@@ -389,6 +389,62 @@ public static String replicaSortName(Goal goal, boolean reverse, boolean leaderO\n     return String.format(\"%s%s%s\", goal.name(), reverse ? \"-REVERSE\" : \"\", leaderOnly ? \"-LEADER\" : \"\");\n   }\n \n+\n+  /**\n+   * Get the set of topics to rebalance for a soft goal.\n+   *\n+   * @param clusterModel The state of the cluster.\n+   * @param excludedTopics The topics to exclude from rebalance.\n+   * @return Topics of self-healing eligible replicas if the given cluster model has any, all topics except the given\n+   * excluded topics otherwise.\n+   */\n+  public static Set<String> topicsToRebalance(ClusterModel clusterModel, Set<String> excludedTopics) {\n+    Set<String> topicsToRebalance;\n+    if (!clusterModel.selfHealingEligibleReplicas().isEmpty()) {\n+      topicsToRebalance = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94aafe2bf57b69f7b8aa69fe29cade83a812e030"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDk0NjQ0OA==", "bodyText": "Maybe I am missing something here. when isExcludedForReplicaMove(sourceBroker) == true, we might return ACCEPT  to allow a INTER_BROKER_REPLICA_MOVEMENT  action? Intuitively, It feels strange. Shouldn't it be that if the source broker is excluded for replica move, we reject this INTER_BROKER_REPLICA_MOVEMENT action?\nPlease consider adding some comments here for clarification.", "url": "https://github.com/linkedin/cruise-control/pull/1383#discussion_r520946448", "createdAt": "2020-11-10T23:47:12Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/ReplicaDistributionGoal.java", "diffHunk": "@@ -93,7 +95,8 @@ public ActionAcceptance actionAcceptance(BalancingAction action, ClusterModel cl\n \n         //Check that destination and source would not become unbalanced.\n         return (isReplicaCountUnderBalanceUpperLimitAfterChange(destinationBroker, destinationBroker.replicas().size(), ADD)\n-               && isReplicaCountAboveBalanceLowerLimitAfterChange(sourceBroker, sourceBroker.replicas().size(), REMOVE))\n+               && (isExcludedForReplicaMove(sourceBroker)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94aafe2bf57b69f7b8aa69fe29cade83a812e030"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14a6bd7d8e689a185368054429da1fce7c6846b8", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/14a6bd7d8e689a185368054429da1fce7c6846b8", "committedDate": "2020-11-11T02:53:47Z", "message": "Address the feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3ODI3MTM2", "url": "https://github.com/linkedin/cruise-control/pull/1383#pullrequestreview-527827136", "createdAt": "2020-11-11T02:58:19Z", "commit": {"oid": "14a6bd7d8e689a185368054429da1fce7c6846b8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 104, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}