{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI2MDkzMzYy", "number": 1400, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjowNjoyNFrOE9CFaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDoyOTo0OFrOE9DxtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDMyNzQ1OnYy", "diffSide": "RIGHT", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjowNjoyNFrOH5gWaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjowNjoyNFrOH5gWaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2MDkwNA==", "bodyText": "Nit: shouldn't the type be int since getInt is used? I know that casting an int to long is safe. Just wondering is it intentional?", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530060904", "createdAt": "2020-11-25T02:06:24Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "diffHunk": "@@ -287,6 +287,23 @@ void sanityCheckConcurrency() {\n     }\n   }\n \n+  /**\n+   * Sanity check to ensure that\n+   * <ul>\n+   *   <li>{@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG} <=\n+   *   {@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG}</li>\n+   * </ul>\n+   */\n+  private void sanityCheckBalancingConstraints() {\n+    long topicReplicaBalanceMinGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dadc13c84e6ac4ddb7c639afc547facf691f15a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDM4NTA2OnYy", "diffSide": "RIGHT", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/TopicReplicaDistributionGoal.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwMjozNDoxMlrOH5g3Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDoxNzozOVrOH5inTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2OTMyNw==", "bodyText": "Shouldn't it be (swapping maxLimit and minLimit):\nmaxLimit = Math.max(0, (int) (Math.floor(average) - _balancingConstraint.topicReplicaBalanceMinGap()));\nminLimit = Math.max(0, (int) (Math.floor(average) - _balancingConstraint.topicReplicaBalanceMaxGap()));\n\nIn the above way, maxLimit >= minLimit. Otherwise, it would be the other way (maxLimit <= minLimit), and the below return statement will always return minLimit\nreturn Math.max(minLimit, Math.min(computedLimit, maxLimit));", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530069327", "createdAt": "2020-11-25T02:34:12Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/TopicReplicaDistributionGoal.java", "diffHunk": "@@ -103,15 +104,40 @@ private double balancePercentageWithMargin(OptimizationOptions optimizationOptio\n     return (balancePercentage - 1) * BALANCE_MARGIN;\n   }\n \n+  /**\n+   * Ensure that the given balance limit falls into min/max limits determined by min/max gaps for topic replica balance.\n+   * If the computed balance limit is out of these gap-based limits, use the relevant max/min gap-based balance limit.\n+   *\n+   * @see com.linkedin.kafka.cruisecontrol.config.constants.AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_DOC\n+   * @see com.linkedin.kafka.cruisecontrol.config.constants.AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MAX_GAP_DOC\n+   *\n+   * @param computedLimit Computed balance upper or lower limit\n+   * @param average Average topic replicas on broker.\n+   * @return A balance limit that falls into [minGap, maxGap] for topic replica balance.\n+   */\n+  private int gapBasedBalanceLimit(int computedLimit, double average, boolean isLowerLimit) {\n+    int minLimit;\n+    int maxLimit;\n+    if (isLowerLimit) {\n+      minLimit = Math.max(0, (int) (Math.floor(average) - _balancingConstraint.topicReplicaBalanceMinGap()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dadc13c84e6ac4ddb7c639afc547facf691f15a"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA5Nzk5OA==", "bodyText": "Absolutely -- great catch!", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530097998", "createdAt": "2020-11-25T04:17:39Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/TopicReplicaDistributionGoal.java", "diffHunk": "@@ -103,15 +104,40 @@ private double balancePercentageWithMargin(OptimizationOptions optimizationOptio\n     return (balancePercentage - 1) * BALANCE_MARGIN;\n   }\n \n+  /**\n+   * Ensure that the given balance limit falls into min/max limits determined by min/max gaps for topic replica balance.\n+   * If the computed balance limit is out of these gap-based limits, use the relevant max/min gap-based balance limit.\n+   *\n+   * @see com.linkedin.kafka.cruisecontrol.config.constants.AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_DOC\n+   * @see com.linkedin.kafka.cruisecontrol.config.constants.AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MAX_GAP_DOC\n+   *\n+   * @param computedLimit Computed balance upper or lower limit\n+   * @param average Average topic replicas on broker.\n+   * @return A balance limit that falls into [minGap, maxGap] for topic replica balance.\n+   */\n+  private int gapBasedBalanceLimit(int computedLimit, double average, boolean isLowerLimit) {\n+    int minLimit;\n+    int maxLimit;\n+    if (isLowerLimit) {\n+      minLimit = Math.max(0, (int) (Math.floor(average) - _balancingConstraint.topicReplicaBalanceMinGap()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDA2OTMyNw=="}, "originalCommit": {"oid": "9dadc13c84e6ac4ddb7c639afc547facf691f15a"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMyNDYwNDY5OnYy", "diffSide": "RIGHT", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQwNDoyOTo0OFrOH5izfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNzoyMDo0M1rOH59P2A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTExOA==", "bodyText": "Should we allow topicReplicaBalanceMinGap  == topicReplicaBalanceMaxGap? In this case, the computedLimit is essentially ignored in the gapBasedBalanceLimit method since the return value of this method does not depend on computedLimit", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530101118", "createdAt": "2020-11-25T04:29:48Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "diffHunk": "@@ -287,6 +287,23 @@ void sanityCheckConcurrency() {\n     }\n   }\n \n+  /**\n+   * Sanity check to ensure that\n+   * <ul>\n+   *   <li>{@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG} <=\n+   *   {@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG}</li>\n+   * </ul>\n+   */\n+  private void sanityCheckBalancingConstraints() {\n+    int topicReplicaBalanceMinGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG);\n+    int topicReplicaBalanceMaxGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MAX_GAP_CONFIG);\n+    if (topicReplicaBalanceMinGap > topicReplicaBalanceMaxGap) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3733ee7d20e452b356fbe63b74769619e2ffa381"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUzMjUyMw==", "bodyText": "We intentionally allow equality of min/max gaps.\nAs per their discretion, this enables users to configure their goal such that each topic has deterministic limits on each broker that is independent of the percentage-based computedLimit.", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530532523", "createdAt": "2020-11-25T17:17:42Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "diffHunk": "@@ -287,6 +287,23 @@ void sanityCheckConcurrency() {\n     }\n   }\n \n+  /**\n+   * Sanity check to ensure that\n+   * <ul>\n+   *   <li>{@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG} <=\n+   *   {@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG}</li>\n+   * </ul>\n+   */\n+  private void sanityCheckBalancingConstraints() {\n+    int topicReplicaBalanceMinGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG);\n+    int topicReplicaBalanceMaxGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MAX_GAP_CONFIG);\n+    if (topicReplicaBalanceMinGap > topicReplicaBalanceMaxGap) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTExOA=="}, "originalCommit": {"oid": "3733ee7d20e452b356fbe63b74769619e2ffa381"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDUzNDM2MA==", "bodyText": "ok", "url": "https://github.com/linkedin/cruise-control/pull/1400#discussion_r530534360", "createdAt": "2020-11-25T17:20:43Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/config/KafkaCruiseControlConfig.java", "diffHunk": "@@ -287,6 +287,23 @@ void sanityCheckConcurrency() {\n     }\n   }\n \n+  /**\n+   * Sanity check to ensure that\n+   * <ul>\n+   *   <li>{@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG} <=\n+   *   {@link AnalyzerConfig#TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG}</li>\n+   * </ul>\n+   */\n+  private void sanityCheckBalancingConstraints() {\n+    int topicReplicaBalanceMinGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MIN_GAP_CONFIG);\n+    int topicReplicaBalanceMaxGap = getInt(AnalyzerConfig.TOPIC_REPLICA_COUNT_BALANCE_MAX_GAP_CONFIG);\n+    if (topicReplicaBalanceMinGap > topicReplicaBalanceMaxGap) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDEwMTExOA=="}, "originalCommit": {"oid": "3733ee7d20e452b356fbe63b74769619e2ffa381"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 741, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}