{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1MTQyODk0", "number": 1358, "title": "Check whether a cluster is using JBOD when populate_disk_info is true", "bodyText": "This PR resolves #1353\nNotes for reviewers:\nThe implementation is based on the assumption that if a Broker has multiple Disks, it must be using JBOD. Please correct me if this assumption is incorrect. Thanks!", "createdAt": "2020-10-16T23:14:28Z", "url": "https://github.com/linkedin/cruise-control/pull/1358", "merged": true, "mergeCommit": {"oid": "f578b311c08024d72c535298771e9e8310bfbe52"}, "closed": true, "closedAt": "2020-10-17T07:42:26Z", "author": {"login": "Lincong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTOupUgH2gAyNTA1MTQyODk0OmNiMWVkNzhhNjUwYzE0MWNjYWUzZTI0ZDE3MWI5ZGIzYzMzMThjNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTUmm2AFqTUxMDk1MzgwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cb1ed78a650c141ccae3e24d171b9db3c3318c58", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/cb1ed78a650c141ccae3e24d171b9db3c3318c58", "committedDate": "2020-10-16T23:11:25Z", "message": "Check whether a cluster is using JBOD when populate_disk_info is true"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/5ccd70883c090551a6f4f35c20342052ed993b39", "committedDate": "2020-10-16T23:19:45Z", "message": "Removed an unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODU3MDg1", "url": "https://github.com/linkedin/cruise-control/pull/1358#pullrequestreview-510857085", "createdAt": "2020-10-17T00:33:17Z", "commit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMDozMzoxN1rOHjS6VA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMDo1MzowMlrOHjTDww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MjA1Mg==", "bodyText": "Can we add a JavaDoc?\nNit: _diskByLogdir.size() > 1 -> !_diskByLogdir.isEmpty()", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506772052", "createdAt": "2020-10-17T00:33:17Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/model/Broker.java", "diffHunk": "@@ -202,6 +202,10 @@ public boolean isAlive() {\n     return _state != State.DEAD;\n   }\n \n+  public boolean isUsingJBOD() {\n+    return _diskByLogdir.size() > 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzA0MA==", "bodyText": "Can we avoid checking _populateDiskInfo here again -- i.e. can't we do the following?\n} else if (!isClusterUsingJBOD()) {\n   ...\n}", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506773040", "createdAt": "2020-10-17T00:40:57Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3MzE3NQ==", "bodyText": "Nit: extra space.", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506773175", "createdAt": "2020-10-17T00:42:04Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");\n+    }\n+\n     if (_start != DEFAULT_START_TIME_FOR_CLUSTER_MODEL) {\n       return clusterModel(_modelCompletenessRequirements.minMonitoredPartitionsPercentage()).brokerStats(_kafkaCruiseControl.config());\n     } else {\n       return clusterModelFromEarliest().brokerStats(_kafkaCruiseControl.config());\n     }\n   }\n \n+  private boolean isClusterUsingJBOD() throws Exception {\n+    ClusterModel clusterModel = _kafkaCruiseControl.loadMonitor().clusterCapacity();\n+    // If and only if all brokers in the cluster are using JBOD, the cluster is considered to be using JBOD\n+    for (Broker broker : clusterModel.brokers()) {\n+      if (!broker.isUsingJBOD()) {\n+        return false;\n+      }\n+    }\n+    return true;\n+  }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NDE3OA==", "bodyText": "Can we refrain from (1) using hardcoded parameter names and (2) emphasis via capitalization -- i.e. maybe we can use something like:\nthrow new UserRequestException(String.format(\"Cannot set %s=true for non-JBOD Kafka clusters.\", POPULATE_DISK_INFO_PARAM));", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506774178", "createdAt": "2020-10-17T00:50:21Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc3NDQ2Nw==", "bodyText": "Nit: This seems like a good candidate to replace with stream API for conciseness:\nreturn clusterModel.brokers().stream().allMatch(Broker::isUsingJBOD);", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506774467", "createdAt": "2020-10-17T00:53:02Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -64,13 +66,29 @@ protected BrokerStats getResult() throws Exception {\n         return cachedBrokerStats;\n       }\n     }\n+    if (_populateDiskInfo && !isClusterUsingJBOD()) {\n+      throw new UserRequestException(\"populate_disk_info = true when Kafka cluster is NOT using JBOD\");\n+    }\n+\n     if (_start != DEFAULT_START_TIME_FOR_CLUSTER_MODEL) {\n       return clusterModel(_modelCompletenessRequirements.minMonitoredPartitionsPercentage()).brokerStats(_kafkaCruiseControl.config());\n     } else {\n       return clusterModelFromEarliest().brokerStats(_kafkaCruiseControl.config());\n     }\n   }\n \n+  private boolean isClusterUsingJBOD() throws Exception {\n+    ClusterModel clusterModel = _kafkaCruiseControl.loadMonitor().clusterCapacity();\n+    // If and only if all brokers in the cluster are using JBOD, the cluster is considered to be using JBOD\n+    for (Broker broker : clusterModel.brokers()) {\n+      if (!broker.isUsingJBOD()) {\n+        return false;\n+      }\n+    }\n+    return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ccd70883c090551a6f4f35c20342052ed993b39"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77298fb257dbc9c34a161667ec1edd1135e72116", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/77298fb257dbc9c34a161667ec1edd1135e72116", "committedDate": "2020-10-17T02:14:02Z", "message": "Fixed open issues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwODY3NzI3", "url": "https://github.com/linkedin/cruise-control/pull/1358#pullrequestreview-510867727", "createdAt": "2020-10-17T02:43:57Z", "commit": {"oid": "77298fb257dbc9c34a161667ec1edd1135e72116"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMjo0Mzo1OFrOHjTr6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xN1QwMjo0Mzo1OFrOHjTr6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjc4NDc0Nw==", "bodyText": "Nit: Maybe we can avoid having the boilerplate ParameterUtils.XXX if we static import just the POPULATE_DISK_INFO_PARAM.\nimport static com.linkedin.kafka.cruisecontrol.servlet.parameters.ParameterUtils.POPULATE_DISK_INFO_PARAM;", "url": "https://github.com/linkedin/cruise-control/pull/1358#discussion_r506784747", "createdAt": "2020-10-17T02:43:58Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/servlet/handler/async/runnable/LoadRunnable.java", "diffHunk": "@@ -7,9 +7,12 @@\n import com.linkedin.kafka.cruisecontrol.KafkaCruiseControl;\n import com.linkedin.kafka.cruisecontrol.async.progress.OperationProgress;\n import com.linkedin.kafka.cruisecontrol.exception.KafkaCruiseControlException;\n+import com.linkedin.kafka.cruisecontrol.model.Broker;\n import com.linkedin.kafka.cruisecontrol.model.ClusterModel;\n import com.linkedin.kafka.cruisecontrol.monitor.ModelCompletenessRequirements;\n+import com.linkedin.kafka.cruisecontrol.servlet.UserRequestException;\n import com.linkedin.kafka.cruisecontrol.servlet.parameters.ClusterLoadParameters;\n+import com.linkedin.kafka.cruisecontrol.servlet.parameters.ParameterUtils;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77298fb257dbc9c34a161667ec1edd1135e72116"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faf423b65c4b7914713c916aa0695c12d2dce736", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/faf423b65c4b7914713c916aa0695c12d2dce736", "committedDate": "2020-10-17T03:02:42Z", "message": "Use static import for POPULATE_DISK_INFO_PARAM"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwOTUzODA2", "url": "https://github.com/linkedin/cruise-control/pull/1358#pullrequestreview-510953806", "createdAt": "2020-10-17T06:02:04Z", "commit": {"oid": "faf423b65c4b7914713c916aa0695c12d2dce736"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 85, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}