{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMTkyMjYx", "number": 1410, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMzo1MzoxNFrOFAnLjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMzo1MzoxNFrOFAnLjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MTg2MjUyOnYy", "diffSide": "RIGHT", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwMzo1MzoxNFrOH-_q9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNVQwMTo0ODoyN1rOH_oBOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjk1MQ==", "bodyText": "Fetching metadata to update this might be expensive. I wonder if we can use the metadata that is periodically updated within PartitionMetricSampleAggregatorCleaner for updating this sensor?\nIt is ok for it to be stale for a couple seconds as long is it keeps the metadata fetches at minimum.", "url": "https://github.com/linkedin/cruise-control/pull/1410#discussion_r535816951", "createdAt": "2020-12-04T03:53:14Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "diffHunk": "@@ -703,6 +706,14 @@ private int numPartitionsWithExtrapolations() {\n     return _latestStateUpdateMs + _monitorStateUpdateTimeoutMs > _time.milliseconds() ? _numPartitionsWithExtrapolations : -1;\n   }\n \n+  private int numTopics() {\n+    // Get topic count from the metadata cache in metadata client first. If it's 0 that means the metadata cache has not\n+    // bootstrapped yet. In this case, refresh the metadata cache and get topic count. In other words, refreshing\n+    // metadata cache only when it is necessary.\n+    int topicCount = _metadataClient.metadata().fetch().topics().size();\n+    return topicCount == 0 ? _metadataClient.refreshMetadata().cluster().topics().size() : topicCount;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cff851d14b7ae376323104414a7f7805e03b260"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxODU2MA==", "bodyText": "In this implementation, the numTopics method will fetch metadata at most once when the metadata cache has not finished bootstrapping. Once the metadata cache has something, it will never return an empty set of topics (topicCount == 0).\nThe _metadataClient which has the metadata cache is also used by other methods as well. For example, getMonitoredPartitionsPercentage", "url": "https://github.com/linkedin/cruise-control/pull/1410#discussion_r535818560", "createdAt": "2020-12-04T03:58:26Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "diffHunk": "@@ -703,6 +706,14 @@ private int numPartitionsWithExtrapolations() {\n     return _latestStateUpdateMs + _monitorStateUpdateTimeoutMs > _time.milliseconds() ? _numPartitionsWithExtrapolations : -1;\n   }\n \n+  private int numTopics() {\n+    // Get topic count from the metadata cache in metadata client first. If it's 0 that means the metadata cache has not\n+    // bootstrapped yet. In this case, refresh the metadata cache and get topic count. In other words, refreshing\n+    // metadata cache only when it is necessary.\n+    int topicCount = _metadataClient.metadata().fetch().topics().size();\n+    return topicCount == 0 ? _metadataClient.refreshMetadata().cluster().topics().size() : topicCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjk1MQ=="}, "originalCommit": {"oid": "2cff851d14b7ae376323104414a7f7805e03b260"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMxNzM2Ng==", "bodyText": "Thanks for the clarification.\nDoes 0 topic count always imply that the that the metadata cache has not bootstrapped -- i.e. however unlikely, if the cluster indeed has no topics, wouldn't this approach keep refreshing metadata?\nI am curious what you think about simply returning _metadataClient.metadata().fetch().topics().size() rather than having the extra logic to handle the one time bootstrapping scenario. We know that PartitionMetricSampleAggregatorCleaner starts refreshing metadata instantaneously upon startup, so the topic count can only be reported as 0 during the bootstrapping for a brief period of time.", "url": "https://github.com/linkedin/cruise-control/pull/1410#discussion_r536317366", "createdAt": "2020-12-04T19:08:34Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "diffHunk": "@@ -703,6 +706,14 @@ private int numPartitionsWithExtrapolations() {\n     return _latestStateUpdateMs + _monitorStateUpdateTimeoutMs > _time.milliseconds() ? _numPartitionsWithExtrapolations : -1;\n   }\n \n+  private int numTopics() {\n+    // Get topic count from the metadata cache in metadata client first. If it's 0 that means the metadata cache has not\n+    // bootstrapped yet. In this case, refresh the metadata cache and get topic count. In other words, refreshing\n+    // metadata cache only when it is necessary.\n+    int topicCount = _metadataClient.metadata().fetch().topics().size();\n+    return topicCount == 0 ? _metadataClient.refreshMetadata().cluster().topics().size() : topicCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjk1MQ=="}, "originalCommit": {"oid": "2cff851d14b7ae376323104414a7f7805e03b260"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ0OTQ0OA==", "bodyText": "Thanks for your comment.\nIn my implementation, I tried to minimize the occurrences of returning 0 since we are using Gauge as the sensor and a 0 value is a sudden drop in the plotted metrics line.\nIf the cluster has no topic, such a cluster is very likely to be OK with CC fetching metadata once every minute. In other words, the zero-topic clusters should be extremely rare, and even though they do exist, they are extremely unlikely to be sensitive to the overhead of fetching metadata since there should be little load on them anyway.", "url": "https://github.com/linkedin/cruise-control/pull/1410#discussion_r536449448", "createdAt": "2020-12-04T23:49:40Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "diffHunk": "@@ -703,6 +706,14 @@ private int numPartitionsWithExtrapolations() {\n     return _latestStateUpdateMs + _monitorStateUpdateTimeoutMs > _time.milliseconds() ? _numPartitionsWithExtrapolations : -1;\n   }\n \n+  private int numTopics() {\n+    // Get topic count from the metadata cache in metadata client first. If it's 0 that means the metadata cache has not\n+    // bootstrapped yet. In this case, refresh the metadata cache and get topic count. In other words, refreshing\n+    // metadata cache only when it is necessary.\n+    int topicCount = _metadataClient.metadata().fetch().topics().size();\n+    return topicCount == 0 ? _metadataClient.refreshMetadata().cluster().topics().size() : topicCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjk1MQ=="}, "originalCommit": {"oid": "2cff851d14b7ae376323104414a7f7805e03b260"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjQ3ODAwOQ==", "bodyText": "Discussed offline and I will change it to always fetch from the metadata cache in the admin client.", "url": "https://github.com/linkedin/cruise-control/pull/1410#discussion_r536478009", "createdAt": "2020-12-05T01:48:27Z", "author": {"login": "Lincong"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/monitor/LoadMonitor.java", "diffHunk": "@@ -703,6 +706,14 @@ private int numPartitionsWithExtrapolations() {\n     return _latestStateUpdateMs + _monitorStateUpdateTimeoutMs > _time.milliseconds() ? _numPartitionsWithExtrapolations : -1;\n   }\n \n+  private int numTopics() {\n+    // Get topic count from the metadata cache in metadata client first. If it's 0 that means the metadata cache has not\n+    // bootstrapped yet. In this case, refresh the metadata cache and get topic count. In other words, refreshing\n+    // metadata cache only when it is necessary.\n+    int topicCount = _metadataClient.metadata().fetch().topics().size();\n+    return topicCount == 0 ? _metadataClient.refreshMetadata().cluster().topics().size() : topicCount;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTgxNjk1MQ=="}, "originalCommit": {"oid": "2cff851d14b7ae376323104414a7f7805e03b260"}, "originalPosition": 38}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 750, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}