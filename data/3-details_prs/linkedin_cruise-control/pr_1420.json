{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM1NjE2MTUy", "number": 1420, "title": "Relax low resource utlization upper limit for resource distribution goals", "bodyText": "This PR resolves #1416.", "createdAt": "2020-12-10T03:47:04Z", "url": "https://github.com/linkedin/cruise-control/pull/1420", "merged": true, "mergeCommit": {"oid": "5fd2f006b0db925bd3558d41fff36406959f0655"}, "closed": true, "closedAt": "2020-12-11T00:42:26Z", "author": {"login": "Lincong"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdk7y1dAFqTU0OTY4NzIwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk873SAH2gAyNTM1NjE2MTUyOjk0MmY1YWQ1YTc2NmJkZDJhYmQ4MGNmNGNkNjYzMjUxNWQ4NjUyZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5Njg3MjA5", "url": "https://github.com/linkedin/cruise-control/pull/1420#pullrequestreview-549687209", "createdAt": "2020-12-10T23:14:57Z", "commit": {"oid": "f261928c0126cbf7dbe2d63ab14ca474ca1b9e31"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNDo1N1rOIDh0JQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQyMzoxNzoyNFrOIDh4Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MDY2MQ==", "bodyText": "This looks incorrect to me.\nShouldn't we pick the maximum between the following:\n\nbalancingConstraint.lowUtilizationThreshold(resource) * balanceMargin and\navgUtilizationPercentage * (1 + balancePercentageWithMargin)", "url": "https://github.com/linkedin/cruise-control/pull/1420#discussion_r540570661", "createdAt": "2020-12-10T23:14:57Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/GoalUtils.java", "diffHunk": "@@ -530,7 +530,10 @@ public static double computeResourceUtilizationBalanceThreshold(double avgUtiliz\n \n     } else {\n       if (isLowUtilization) {\n-        return balancingConstraint.lowUtilizationThreshold(resource) * balanceMargin;\n+        double resourceBalanceUtilizationUpperLimit =\n+            Math.max(balancingConstraint.resourceBalancePercentage(resource) * avgUtilizationPercentage,\n+                     balancingConstraint.lowUtilizationThreshold(resource));\n+        return resourceBalanceUtilizationUpperLimit * balanceMargin;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f261928c0126cbf7dbe2d63ab14ca474ca1b9e31"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDU3MTcxMA==", "bodyText": "Nit: Bad indentation", "url": "https://github.com/linkedin/cruise-control/pull/1420#discussion_r540571710", "createdAt": "2020-12-10T23:17:24Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/GoalUtilsTest.java", "diffHunk": "@@ -13,34 +13,51 @@\n public class GoalUtilsTest {\n \n   private static final double AVG_UTILIZATION_PERCENTAGE = 0.3;\n-  private static final double RESOURCE_BALANCE_THRESHOLD = 1.3;\n+  private static final double DEFAULT_RESOURCE_BALANCE_THRESHOLD = 1.3;\n   private static final double GOAL_VIOLATION_DISTRIBUTION_THRESHOLD_MULTIPLIER = 1.2;\n \n   @Test\n   public void testComputeResourceUtilizationBalanceThreshold() {\n     Resource resource = Resource.CPU;\n \n-    // Verify 1: Low utilization and compute balance threshold lower bound\n+    // Verify case 1: Low utilization and compute balance threshold lower bound\n     verifyComputingResourceUtilizationBalanceThreshold(resource, true, 0.4, 0.0);\n \n-    // Verify 2: Low utilization and compute balance threshold upper bound\n+    // Verify case 2: Low utilization and compute balance threshold upper bound\n     verifyComputingResourceUtilizationBalanceThreshold(resource, false, 0.4, 0.4 * ResourceDistributionGoal.BALANCE_MARGIN);\n \n-    // Verify 3: Not low utilization and compute balance threshold lower bound\n+    // Verify case 3: Low utilization. But the average utilization percentage * resource balance threshold > low resource utilization percentage\n+    double resourceBalanceThreshold = 1.6;\n+    double expectedComputedBalanceUpperLimit = resourceBalanceThreshold * AVG_UTILIZATION_PERCENTAGE * ResourceDistributionGoal.BALANCE_MARGIN;\n+    verifyComputingResourceUtilizationBalanceThreshold(resource, false, 0.4, expectedComputedBalanceUpperLimit, resourceBalanceThreshold);\n+\n+    // Verify case 4: Not low utilization and compute balance threshold lower bound\n     verifyComputingResourceUtilizationBalanceThreshold(resource, true, 0.2, 0.3 * (1 - ((1.3 * 1.2) - 1) * ResourceDistributionGoal.BALANCE_MARGIN));\n \n-    // Verify 4: Not low utilization and compute balance threshold upper bound\n+    // Verify case 5: Not low utilization and compute balance threshold upper bound\n     verifyComputingResourceUtilizationBalanceThreshold(resource, false, 0.2, 0.3 * (1 + ((1.3 * 1.2) - 1) * ResourceDistributionGoal.BALANCE_MARGIN));\n   }\n \n+  private void verifyComputingResourceUtilizationBalanceThreshold(Resource resource,\n+      boolean isLowerThreshold,\n+      double lowUtilizationThreshold,\n+      double expectedComputedBalanceThreshold) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f261928c0126cbf7dbe2d63ab14ca474ca1b9e31"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e4bab1cf71adfa56fa735eefdc5d114fdc0dd8b", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/8e4bab1cf71adfa56fa735eefdc5d114fdc0dd8b", "committedDate": "2020-12-11T00:09:23Z", "message": "Relax low resource utlization upper limit for resource distribution goals"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41063c3d62bb3170273891f980c6977bcf6e7ae6", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/41063c3d62bb3170273891f980c6977bcf6e7ae6", "committedDate": "2020-12-11T00:09:23Z", "message": "Fix PR issues"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16f8fdf223d1925e552c0ff260aeb35d3d269c15", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/16f8fdf223d1925e552c0ff260aeb35d3d269c15", "committedDate": "2020-12-11T00:09:23Z", "message": "Small adjustment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f261928c0126cbf7dbe2d63ab14ca474ca1b9e31", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/f261928c0126cbf7dbe2d63ab14ca474ca1b9e31", "committedDate": "2020-12-10T03:45:27Z", "message": "Relax low resource utlization upper limit for resource distribution goals"}, "afterCommit": {"oid": "16f8fdf223d1925e552c0ff260aeb35d3d269c15", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/16f8fdf223d1925e552c0ff260aeb35d3d269c15", "committedDate": "2020-12-11T00:09:23Z", "message": "Small adjustment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5NzE3NDEx", "url": "https://github.com/linkedin/cruise-control/pull/1420#pullrequestreview-549717411", "createdAt": "2020-12-11T00:28:15Z", "commit": {"oid": "16f8fdf223d1925e552c0ff260aeb35d3d269c15"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDoyODoxNVrOIDjpog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMVQwMDoyODoxNVrOIDjpog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDYwMDczOA==", "bodyText": "Nit: (not introduced in this patch): Bad indentation\n    double computedBalanceThreshold = GoalUtils.computeResourceUtilizationBalanceThreshold(AVG_UTILIZATION_PERCENTAGE,\n                                                                                           resource,\n                                                                                           mockBalanceConstraint, \n                                                                                           true,\n                                                                                           ResourceDistributionGoal.BALANCE_MARGIN,\n                                                                                           isLowerThreshold);", "url": "https://github.com/linkedin/cruise-control/pull/1420#discussion_r540600738", "createdAt": "2020-12-11T00:28:15Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/analyzer/goals/GoalUtilsTest.java", "diffHunk": "@@ -40,7 +46,7 @@ private void verifyComputingResourceUtilizationBalanceThreshold(Resource resourc\n \n     BalancingConstraint mockBalanceConstraint = EasyMock.mock(BalancingConstraint.class);\n     EasyMock.expect(mockBalanceConstraint.lowUtilizationThreshold(resource)).andReturn(lowUtilizationThreshold).anyTimes();\n-    EasyMock.expect(mockBalanceConstraint.resourceBalancePercentage(resource)).andReturn(RESOURCE_BALANCE_THRESHOLD).anyTimes();\n+    EasyMock.expect(mockBalanceConstraint.resourceBalancePercentage(resource)).andReturn(DEFAULT_RESOURCE_BALANCE_THRESHOLD).anyTimes();\n     EasyMock.expect(mockBalanceConstraint.goalViolationDistributionThresholdMultiplier()).\n         andReturn(GOAL_VIOLATION_DISTRIBUTION_THRESHOLD_MULTIPLIER).anyTimes();\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16f8fdf223d1925e552c0ff260aeb35d3d269c15"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "942f5ad5a766bdd2abd80cf4cd6632515d8652eb", "author": {"user": {"login": "Lincong", "name": "Lincong Li"}}, "url": "https://github.com/linkedin/cruise-control/commit/942f5ad5a766bdd2abd80cf4cd6632515d8652eb", "committedDate": "2020-12-11T00:38:12Z", "message": "Fix indentation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 133, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}