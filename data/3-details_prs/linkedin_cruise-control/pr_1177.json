{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODUxOTE1", "number": 1177, "title": "Further tune slow broker finder sensitivity", "bodyText": "Addresses the issue #1176  and #1178", "createdAt": "2020-04-17T00:04:57Z", "url": "https://github.com/linkedin/cruise-control/pull/1177", "merged": true, "mergeCommit": {"oid": "a9d28009a36883229782c97c1b91ab394ac7a263"}, "closed": true, "closedAt": "2020-04-21T04:41:21Z", "author": {"login": "kidkun"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYVwKwgH2gAyNDA0ODUxOTE1OjQ2MzIyMjI2NjYwMDdkZTc2ODk3ODUwZjM3MWU2OTRjZDA0ZWM0OWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZqv6UAH2gAyNDA0ODUxOTE1OjE0ZTUzOGVmMDcxYjcxMjlkZjQ0ODM1NjQ4YTY0NDZkMTE5ZWRjZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4632222666007de76897850f371e694cd04ec49a", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/4632222666007de76897850f371e694cd04ec49a", "committedDate": "2020-04-17T00:00:53Z", "message": "Further tune slow broker finder sensitivity,."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NzExNTY1", "url": "https://github.com/linkedin/cruise-control/pull/1177#pullrequestreview-395711565", "createdAt": "2020-04-17T19:17:33Z", "commit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxOToxNzozM1rOGHaKsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxOTozNDo0MFrOGHapAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyMTkzOA==", "bodyText": "It is not clear what these hardcoded magic numbers refer to or the purpose of this operation.\nCan we clarify both?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410421938", "createdAt": "2020-04-17T19:17:33Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/AnomalyDetectorTestUtils.java", "diffHunk": "@@ -42,16 +42,23 @@ private AnomalyDetectorTestUtils() {\n   /**\n    * Create history load for broker.\n    * @param metricValueById A set of metrics with corresponding load value.\n+   * @param metricVarianceById A set of metrics with corresponding load variance.\n    * @param numWindows  Number of windows to populate.\n    * @param broker The subject broker.\n    * @return The load for the broker.\n    */\n-  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById, int numWindows, BrokerEntity broker) {\n+  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById,\n+                                                                         Map<Short, Double> metricVarianceById,\n+                                                                         int numWindows,\n+                                                                         BrokerEntity broker) {\n+    Random random = new Random();\n     Map<Short, MetricValues> valuesByMetricId = new HashMap<>();\n     for (Map.Entry<Short, Double> entry : metricValueById.entrySet()) {\n       MetricValues historicalMetricValues = new MetricValues(numWindows);\n       double[] values = new double[numWindows];\n-      Arrays.fill(values, entry.getValue());\n+      for (int i = 0; i < numWindows; i++) {\n+        values[i] = entry.getValue() + (random.nextInt(201) - 100) * metricVarianceById.get(entry.getKey()) / 100;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyNDYwOQ==", "bodyText": "In general, using new Random() without a seed value should be avoided in unit tests.\nThis can lead to test failures that are not reproducible due to randomness.", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410424609", "createdAt": "2020-04-17T19:23:29Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/AnomalyDetectorTestUtils.java", "diffHunk": "@@ -42,16 +42,23 @@ private AnomalyDetectorTestUtils() {\n   /**\n    * Create history load for broker.\n    * @param metricValueById A set of metrics with corresponding load value.\n+   * @param metricVarianceById A set of metrics with corresponding load variance.\n    * @param numWindows  Number of windows to populate.\n    * @param broker The subject broker.\n    * @return The load for the broker.\n    */\n-  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById, int numWindows, BrokerEntity broker) {\n+  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById,\n+                                                                         Map<Short, Double> metricVarianceById,\n+                                                                         int numWindows,\n+                                                                         BrokerEntity broker) {\n+    Random random = new Random();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyNjQ5Mg==", "bodyText": "Are we testing with non-zero variance in any of our tests?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410426492", "createdAt": "2020-04-17T19:27:34Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/KafkaMetricAnomalyFinderTest.java", "diffHunk": "@@ -51,7 +51,7 @@ public void testMetricAnomaliesWithNullArguments() {\n   public void testMetricAnomalies() {\n     MetricAnomalyFinder<BrokerEntity> anomalyFinder = createKafkaMetricAnomalyFinder();\n     Map<BrokerEntity, ValuesAndExtrapolations> history =\n-        createHistory(Collections.singletonMap(METRIC_ID, 20.0), 20, BROKER_ENTITIES.get(0));\n+        createHistory(Collections.singletonMap(METRIC_ID, 20.0), Collections.singletonMap(METRIC_ID, 0.0), 20, BROKER_ENTITIES.get(0));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyNzgwOQ==", "bodyText": "The term variance refers to the square of the standard deviation.\nDoes this variable refer to variance or something else?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410427809", "createdAt": "2020-04-17T19:30:28Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/AnomalyDetectorTestUtils.java", "diffHunk": "@@ -42,16 +42,23 @@ private AnomalyDetectorTestUtils() {\n   /**\n    * Create history load for broker.\n    * @param metricValueById A set of metrics with corresponding load value.\n+   * @param metricVarianceById A set of metrics with corresponding load variance.\n    * @param numWindows  Number of windows to populate.\n    * @param broker The subject broker.\n    * @return The load for the broker.\n    */\n-  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById, int numWindows, BrokerEntity broker) {\n+  public static Map<BrokerEntity, ValuesAndExtrapolations> createHistory(Map<Short, Double> metricValueById,\n+                                                                         Map<Short, Double> metricVarianceById,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyODcwMw==", "bodyText": "What is variance percentile? Can we rename it to better represent what it refers to?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410428703", "createdAt": "2020-04-17T19:32:26Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinderTest.java", "diffHunk": "@@ -25,21 +25,28 @@\n \n \n public class SlowBrokerFinderTest {\n-  private final static double NORMAL_BYTES_IN_RATE = 1024.0 * 1024.0;\n-  private final static double SMALL_BYTES_IN_RATE = 1024.0;\n+  private final static double NORMAL_BYTES_IN_RATE = 4096;\n+  private final static double BYTE_IN_RATE_VARIANCE_PERCENTILE = 0.1;\n   private final static double NORMAL_LOG_FLUSH_TIME_MS = 100.0;\n+  private final static double LOG_FLUSH_TIME_MS_VARIANCE_PERCENTILE = 0.25;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDQyOTY5Ng==", "bodyText": "This test contains several hardcoded values, whose meanings are hard to infer. Is it possible to move them to static variables with clear names?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r410429696", "createdAt": "2020-04-17T19:34:40Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/SlowBrokerFinderTest.java", "diffHunk": "@@ -49,21 +56,28 @@ public void testDetectingSlowBrokerFromHistory() {\n \n   /**\n    * Test slow broker finder can detect broker which has consistently abnormally high metric in the cluster.\n+   * The metric values used in test case is extracted from one incident we encountered in production.\n    */\n   @Test\n   public void testDetectingSlowBrokerFromPeer() {\n     SlowBrokerFinder slowBrokerFinder = createSlowBrokerFinder();\n     Map<BrokerEntity, ValuesAndExtrapolations> currentMetrics = new HashMap<>(BROKER_ENTITIES.size());\n     Map<BrokerEntity, ValuesAndExtrapolations> history = new HashMap<>(BROKER_ENTITIES.size());\n-    currentMetrics.putAll(createCurrentMetrics(populateMetricValues(NORMAL_BYTES_IN_RATE, NORMAL_BYTES_IN_RATE, NORMAL_LOG_FLUSH_TIME_MS * 11),\n-                          11, BROKER_ENTITIES.get(0)));\n-    history.putAll(createHistory(populateMetricValues(NORMAL_BYTES_IN_RATE, NORMAL_BYTES_IN_RATE, NORMAL_LOG_FLUSH_TIME_MS * 11),\n-                   10, BROKER_ENTITIES.get(0)));\n+    currentMetrics.putAll(createCurrentMetrics(populateMetricValues(NORMAL_BYTES_IN_RATE, NORMAL_BYTES_IN_RATE, NORMAL_LOG_FLUSH_TIME_MS * 4),\n+                                               11, BROKER_ENTITIES.get(0)));\n+    history.putAll(createHistory(populateMetricValues(NORMAL_BYTES_IN_RATE, NORMAL_BYTES_IN_RATE, NORMAL_LOG_FLUSH_TIME_MS * 4),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4632222666007de76897850f371e694cd04ec49a"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9230fd615a577ce9989e8438d3c6f53b5d3f501", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/a9230fd615a577ce9989e8438d3c6f53b5d3f501", "committedDate": "2020-04-20T20:28:46Z", "message": "Piggyback a fix for topic RF anomaly."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df488868a490c54865a8f8802d647ce5ebe3ac84", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/df488868a490c54865a8f8802d647ce5ebe3ac84", "committedDate": "2020-04-20T21:08:38Z", "message": "Address the feedback."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2OTEzNTkx", "url": "https://github.com/linkedin/cruise-control/pull/1177#pullrequestreview-396913591", "createdAt": "2020-04-21T00:45:49Z", "commit": {"oid": "df488868a490c54865a8f8802d647ce5ebe3ac84"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDo0NTo0OVrOGItiJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwMDo1MzoyNlrOGItsIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4NzgxNQ==", "bodyText": "Nit (Also applies to fixable : above): The space before the colon should be dropped.", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r411787815", "createdAt": "2020-04-21T00:45:49Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/detector/TopicReplicationFactorAnomaly.java", "diffHunk": "@@ -93,7 +93,8 @@ public String toString() {\n       .append(\" : {fixable : [\");\n     StringJoiner joiner = new StringJoiner(\",\");\n     _topicsWithBadReplicationFactorByFixability.getOrDefault(true, Collections.emptySet()).forEach(joiner::add);\n-    sb.append(joiner.toString());\n+    sb.append(joiner.toString())\n+      .append(\"], unfixable : [\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df488868a490c54865a8f8802d647ce5ebe3ac84"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc4ODE1OA==", "bodyText": "Nit: metric metric value -- has x2 metric.\n-- Also should we refer to this as metricFluctuationById and describe what it fluctuates (i.e. it fluctuates each member of metricValueById by a uniformly distributed value in [-metricFluctuationById, metricFluctuationById])?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r411788158", "createdAt": "2020-04-21T00:46:46Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/AnomalyDetectorTestUtils.java", "diffHunk": "@@ -42,16 +42,25 @@ private AnomalyDetectorTestUtils() {\n   /**\n    * Create history load for broker.\n    * @param metricValueById A set of metrics with corresponding load value.\n+   * @param metricVarianceById A set of metrics with corresponding load variance. The variance here refers to the maximal\n+   *                           fluctuation of metric metric value.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df488868a490c54865a8f8802d647ce5ebe3ac84"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTc5MDM3MA==", "bodyText": "According to the code, doesn't this value represent the half of the maximum fluctuation?", "url": "https://github.com/linkedin/cruise-control/pull/1177#discussion_r411790370", "createdAt": "2020-04-21T00:53:26Z", "author": {"login": "efeg"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/detector/AnomalyDetectorTestUtils.java", "diffHunk": "@@ -42,16 +42,25 @@ private AnomalyDetectorTestUtils() {\n   /**\n    * Create history load for broker.\n    * @param metricValueById A set of metrics with corresponding load value.\n+   * @param metricVarianceById A set of metrics with corresponding load variance. The variance here refers to the maximal\n+   *                           fluctuation of metric metric value.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df488868a490c54865a8f8802d647ce5ebe3ac84"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14e538ef071b7129df44835648a6446d119edcd0", "author": {"user": null}, "url": "https://github.com/linkedin/cruise-control/commit/14e538ef071b7129df44835648a6446d119edcd0", "committedDate": "2020-04-21T03:02:32Z", "message": "Address the feedback."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 210, "cost": 1, "resetAt": "2021-11-01T16:19:10Z"}}}