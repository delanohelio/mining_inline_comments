{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwOTg1NzQw", "number": 1184, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjozNzowOVrOD304qQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDoxNzo0M1rOD4eT2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU5ODY0NzQ1OnYy", "diffSide": "RIGHT", "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlannerTest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQyMjozNzowOVrOGOThIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxNTo1MzoyM1rOGSFLJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1MzAyNw==", "bodyText": "Note: We didn't need to change the PrioritizeLargeReplicaRebalance strategy tests after making this change, because of: #1183 (comment).", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r417653027", "createdAt": "2020-04-29T22:37:09Z", "author": {"login": "matthinograb"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlannerTest.java", "diffHunk": "@@ -62,7 +62,7 @@\n       new ExecutionProposal(new TopicPartition(TOPIC1, 3), 0, _r3, Arrays.asList(_r3, _r2), Arrays.asList(_r2, _r3));\n \n   private final ExecutionProposal _partitionMovement1 =\n-      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 4, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));\n+      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 1, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTEwNjQ3NQ==", "bodyText": "Is there any specific reason we want to change the test case here?\nI just test locally, with the bug fix, If we do not change the test, it can still pass.", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r421106475", "createdAt": "2020-05-06T21:34:48Z", "author": {"login": "kidkun"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlannerTest.java", "diffHunk": "@@ -62,7 +62,7 @@\n       new ExecutionProposal(new TopicPartition(TOPIC1, 3), 0, _r3, Arrays.asList(_r3, _r2), Arrays.asList(_r2, _r3));\n \n   private final ExecutionProposal _partitionMovement1 =\n-      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 4, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));\n+      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 1, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1MzAyNw=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTYxMjMyNQ==", "bodyText": "The test cases were missing the \"equal partition size\" case, which caused the original bug. Adding this test case proves that the fix is working as expected, and it should help to prevent future regressions (if the chaining breaks in the future).", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r421612325", "createdAt": "2020-05-07T15:53:23Z", "author": {"login": "matthinograb"}, "path": "cruise-control/src/test/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlannerTest.java", "diffHunk": "@@ -62,7 +62,7 @@\n       new ExecutionProposal(new TopicPartition(TOPIC1, 3), 0, _r3, Arrays.asList(_r3, _r2), Arrays.asList(_r2, _r3));\n \n   private final ExecutionProposal _partitionMovement1 =\n-      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 4, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));\n+      new ExecutionProposal(new TopicPartition(TOPIC2, 0), 1, _r0, Arrays.asList(_r0, _r2), Arrays.asList(_r2, _r1));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzY1MzAyNw=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYwNTQzNDUxOnYy", "diffSide": "RIGHT", "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQyMDoxNzo0M1rOGPUmyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMToyNzoyMFrOGUeYbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxOTQzNQ==", "bodyText": "Would this alliviate the issue described in #1167 (comment) ? @efeg can you please comment?", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r418719435", "createdAt": "2020-05-01T20:17:43Z", "author": {"login": "amuraru"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "diffHunk": "@@ -315,6 +317,13 @@ private void maybeAddLeaderChangeTasks(Collection<ExecutionProposal> proposals,\n                                                                 Set<TopicPartition> inProgressPartitions) {\n     LOG.trace(\"Getting inter-broker replica movement tasks for brokers with concurrency {}\", readyBrokers);\n     List<ExecutionTask> executableReplicaMovements = new ArrayList<>();\n+\n+    // Kafka doesn't allow new replica movements if there is an ongoing rebalance\n+    if (!inProgressPartitions.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA5OTE4Ng==", "bodyText": "I do not think this check should be added.\nThe way CC submit tasks is in batch. we select a set of tasks based on the concurrency requirement and submit them in batch, later we check the finish status and select more tasks to current ongoing tasks(as long as we do not violate concurrency requirement) and submit in second batch.", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r421099186", "createdAt": "2020-05-06T21:19:38Z", "author": {"login": "kidkun"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "diffHunk": "@@ -315,6 +317,13 @@ private void maybeAddLeaderChangeTasks(Collection<ExecutionProposal> proposals,\n                                                                 Set<TopicPartition> inProgressPartitions) {\n     LOG.trace(\"Getting inter-broker replica movement tasks for brokers with concurrency {}\", readyBrokers);\n     List<ExecutionTask> executableReplicaMovements = new ArrayList<>();\n+\n+    // Kafka doesn't allow new replica movements if there is an ongoing rebalance\n+    if (!inProgressPartitions.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxOTQzNQ=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzQ1MTQzMA==", "bodyText": "From my understanding, Kafka cannot start a new rebalance while a current one is in progress. So we don't need to create a second batch, if the first batch isn't completed yet.\nBut I'll remove this line, since it isn't related to the referenced issue -- and isn't important for the bugfix.", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r423451430", "createdAt": "2020-05-12T04:14:53Z", "author": {"login": "matthinograb"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "diffHunk": "@@ -315,6 +317,13 @@ private void maybeAddLeaderChangeTasks(Collection<ExecutionProposal> proposals,\n                                                                 Set<TopicPartition> inProgressPartitions) {\n     LOG.trace(\"Getting inter-broker replica movement tasks for brokers with concurrency {}\", readyBrokers);\n     List<ExecutionTask> executableReplicaMovements = new ArrayList<>();\n+\n+    // Kafka doesn't allow new replica movements if there is an ongoing rebalance\n+    if (!inProgressPartitions.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxOTQzNQ=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEwODQ0MA==", "bodyText": "Kafka can accept new task while there is ongoing task and that CC use that to ensure the task are always executed in desired concurrency.", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r424108440", "createdAt": "2020-05-13T00:31:48Z", "author": {"login": "kidkun"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "diffHunk": "@@ -315,6 +317,13 @@ private void maybeAddLeaderChangeTasks(Collection<ExecutionProposal> proposals,\n                                                                 Set<TopicPartition> inProgressPartitions) {\n     LOG.trace(\"Getting inter-broker replica movement tasks for brokers with concurrency {}\", readyBrokers);\n     List<ExecutionTask> executableReplicaMovements = new ArrayList<>();\n+\n+    // Kafka doesn't allow new replica movements if there is an ongoing rebalance\n+    if (!inProgressPartitions.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxOTQzNQ=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyMjQ3OQ==", "bodyText": "@matthinograb\nJust wanted to chime in to give a little more context on @kidkun 's explanation.\nStarting a new rebalance while a current one is in progress requires the workaround patch described in #1167 (comment) -- i.e. it is indeed not supported in Apache Kafka out of the box.\nHope it helps!", "url": "https://github.com/linkedin/cruise-control/pull/1184#discussion_r424122479", "createdAt": "2020-05-13T01:27:20Z", "author": {"login": "efeg"}, "path": "cruise-control/src/main/java/com/linkedin/kafka/cruisecontrol/executor/ExecutionTaskPlanner.java", "diffHunk": "@@ -315,6 +317,13 @@ private void maybeAddLeaderChangeTasks(Collection<ExecutionProposal> proposals,\n                                                                 Set<TopicPartition> inProgressPartitions) {\n     LOG.trace(\"Getting inter-broker replica movement tasks for brokers with concurrency {}\", readyBrokers);\n     List<ExecutionTask> executableReplicaMovements = new ArrayList<>();\n+\n+    // Kafka doesn't allow new replica movements if there is an ongoing rebalance\n+    if (!inProgressPartitions.isEmpty()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODcxOTQzNQ=="}, "originalCommit": {"oid": "0e95545b7fb3117f140ac12a8e24e9acd3323568"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 827, "cost": 1, "resetAt": "2021-11-12T20:44:06Z"}}}