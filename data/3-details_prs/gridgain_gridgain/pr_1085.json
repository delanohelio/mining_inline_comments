{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1ODkwNzE2", "number": 1085, "title": "GG-25705: Add kill query action.", "bodyText": "", "createdAt": "2020-04-20T07:54:15Z", "url": "https://github.com/gridgain/gridgain/pull/1085", "merged": true, "mergeCommit": {"oid": "300718ffed970580284e977e3886a44e568d687e"}, "closed": true, "closedAt": "2020-04-22T16:30:30Z", "author": {"login": "somjik-api"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZaTiwAH2gAyNDA1ODkwNzE2OmQ4NDdjZDI3Y2JiMDUxZDQ5ZWMwZjFiNDUyMWNmNDg2YTU0ZWFjNmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaKzaNgH2gAyNDA1ODkwNzE2OjExODI4MTFkNmVlYzc1ODk1NTY0N2NiMGJjOGU4N2E1NDcyZmZmY2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/d847cd27cbb051d49ec0f1b4521cf486a54eac6e", "committedDate": "2020-04-20T07:53:04Z", "message": "GG-25705: Add kill query action."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MjY0MTMw", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-396264130", "createdAt": "2020-04-20T08:57:53Z", "commit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODo1Nzo1M1rOGIKRcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODo1Nzo1M1rOGIKRcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDA5Ng==", "bodyText": "Can we receive SQL injections here?", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411210096", "createdAt": "2020-04-20T08:57:53Z", "author": {"login": "nva"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,27 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n+        return ctx.closure().callLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MjcyMDMy", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-396272032", "createdAt": "2020-04-20T09:08:32Z", "commit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwOTowODozM1rOGIKs6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwOTowODozM1rOGIKs6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxNzEyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                /** ID. */\n          \n          \n            \n                /** Query ID from request. */", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411217129", "createdAt": "2020-04-20T09:08:33Z", "author": {"login": "nva"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/dto/action/query/RunningQuery.java", "diffHunk": "@@ -23,9 +23,12 @@\n  * Descriptor of running query.\n  */\n public class RunningQuery {\n-    /** */\n+    /** ID. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NDI1NDU3", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-396425457", "createdAt": "2020-04-20T12:55:20Z", "commit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjo1NToyMFrOGITCdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjo1NzozOVrOGITIkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1MzcxNw==", "bodyText": "I don't think we should care too much about this here. If the user has access to killing queries, she probably can execute them as well.", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411353717", "createdAt": "2020-04-20T12:55:20Z", "author": {"login": "dmekhanikov"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,27 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n+        return ctx.closure().callLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIxMDA5Ng=="}, "originalCommit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NDI1Mg==", "bodyText": "Is the result going to be used the frontend?", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411354252", "createdAt": "2020-04-20T12:56:08Z", "author": {"login": "dmekhanikov"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,27 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<QueryResult> kill(String globalQryId) {\n+        return ctx.closure().callLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\");\n+\n+            try (\n+                FieldsQueryCursor<List<?>> cur = qryProc.querySqlFields(qryFields, true);\n+                CursorHolder cursorHolder = new CursorHolder(cur)\n+            ) {\n+                QueryResult res = fetchSqlQueryResult(cursorHolder, 1);\n+\n+                res.setResultNodeId(ctx.localNodeId().toString());\n+\n+                return res;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NTI4Mw==", "bodyText": "Please add a test that kill a query started from Ignite directly without using GGCC API.", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411355283", "createdAt": "2020-04-20T12:57:39Z", "author": {"login": "dmekhanikov"}, "path": "modules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java", "diffHunk": "@@ -388,6 +391,62 @@ public void shouldCancelLongQuery() {\n         );\n     }\n \n+    /**\n+     * 1. Execute a query with sleep function.\n+     * 2. Send kill query action with global query id for a query from 1.\n+     * 3. Assert that action was completed and no one running queries exists in a cluster.\n+     */\n+    @Test\n+    public void shouldKillRunningQuery() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d847cd27cbb051d49ec0f1b4521cf486a54eac6e"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/6dcbd7bc9b76d2b77314e6459773cb8ce076baa9", "committedDate": "2020-04-20T15:54:28Z", "message": "GG-25075: Review fixes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjMyNjQ2", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-396632646", "createdAt": "2020-04-20T16:47:28Z", "commit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo0NzoyOVrOGId7Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNjo0NzoyOVrOGId7Ww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTUzMjEyMw==", "bodyText": "Should we have checks features that \"KILL QUERY\" is supported by node?", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r411532123", "createdAt": "2020-04-20T16:47:29Z", "author": {"login": "akuznetsov-gridgain"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,19 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3Mjg5MzA4", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-397289308", "createdAt": "2020-04-21T12:41:32Z", "commit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMjo0MTozMlrOGJDmtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMjo0MTozMlrOGJDmtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjE0OTQyOQ==", "bodyText": "May be it make sense to introduce base class for ActionsControllers?\nAnd declare protected method \"safeExecute(lambda)\" that will accept function to execute?", "url": "https://github.com/gridgain/gridgain/pull/1085#discussion_r412149429", "createdAt": "2020-04-21T12:41:32Z", "author": {"login": "akuznetsov-gridgain"}, "path": "modules/management-console-agent/src/main/java/org/apache/ignite/internal/agent/action/controller/QueryActionsController.java", "diffHunk": "@@ -89,6 +89,19 @@ public QueryActionsController(GridKernalContext ctx) {\n         return new IgniteFinishedFutureImpl<>();\n     }\n \n+    /**\n+     * @param globalQryId Global query id.\n+     * @return Kill query result.\n+     */\n+    public IgniteInternalFuture<?> kill(String globalQryId) {\n+        return ctx.closure().runLocalSafe(() -> {\n+            SqlFieldsQuery qryFields = new SqlFieldsQuery(\"KILL QUERY '\" + globalQryId + \"';\")\n+                .setLazy(false);\n+\n+            qryProc.querySqlFields(qryFields, true).close();\n+        }, MANAGEMENT_POOL);\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTE2MTU3", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-397916157", "createdAt": "2020-04-22T07:31:19Z", "commit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4MzIwOTkx", "url": "https://github.com/gridgain/gridgain/pull/1085#pullrequestreview-398320991", "createdAt": "2020-04-22T15:39:28Z", "commit": {"oid": "6dcbd7bc9b76d2b77314e6459773cb8ce076baa9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d82cf168c183e38f54126382862dec02356799dd", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/d82cf168c183e38f54126382862dec02356799dd", "committedDate": "2020-04-22T16:21:42Z", "message": "Merge remote-tracking branch 'origin/8.7-master' into gg-25705\n\n# Conflicts:\n#\tmodules/management-console-agent/src/test/java/org/apache/ignite/internal/agent/action/controller/QueryActionsControllerTest.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1182811d6eec758955647cb0bc8e87a5472fffcc", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/1182811d6eec758955647cb0bc8e87a5472fffcc", "committedDate": "2020-04-22T16:23:19Z", "message": "GG-25705: Remove instant closing kill query cursor."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4330, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}