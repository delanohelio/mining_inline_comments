{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1NDUwMTI1", "number": 1288, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMToxNTowN1rOEM2aZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyNzo1NVrOEOtfkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxOTA5ODYzOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/ChangeTopologyWatcher.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMToxNTowN1rOGvMnqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxMToxNTowN1rOGvMnqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjE0MzAxOQ==", "bodyText": "I believe it is better not to add second method here. You can rename onEvent -> triggerBaselineUpdate and class ChangeTopologyWatcher to something like BaselineTopologyUpdater.\nAnd then registration of events(EVT_NODE_FAILED, EVT_NODE_LEFT, EVT_NODE_JOINED) should be modified according to using triggerBaselineUpdate(long topologyVersion)", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r452143019", "createdAt": "2020-07-09T11:15:07Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/ChangeTopologyWatcher.java", "diffHunk": "@@ -99,17 +99,26 @@ public ChangeTopologyWatcher(GridKernalContext ctx) {\n         if (discoEvt.eventNode().isClient() || discoEvt.eventNode().isDaemon())\n             return;\n \n-        synchronized (this) {\n-            lastBaselineData = lastBaselineData.next(discoEvt.topologyVersion());\n+        triggerBaselineUpdate(discoEvt.topologyVersion());\n+    }\n \n-            if (isLocalNodeCoordinator(discoveryMgr)) {\n-                exchangeManager.affinityReadyFuture(new AffinityTopologyVersion(discoEvt.topologyVersion()))\n+    /**\n+     * Schedule update of the baseline topology\n+     * @param topologyVersion version of topology\n+     */\n+    public synchronized void triggerBaselineUpdate(long topologyVersion) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4bc96442a8e48232856718d6d042686e3c855a6"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODU5Mzk1OnYy", "diffSide": "RIGHT", "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cluster/BaselineAutoAdjustTest.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyNTowM1rOGyApdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyNTowM1rOGyApdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5MjU5OQ==", "bodyText": "You can add awaitPartitionMapExchange() after startGrid(1); then you can check ignite0.cluster().nodes().size() without waitForCondition. Also you must check  that currentBaselineTopology().size() equal to 1 before auto-adjust enabled.", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r455092599", "createdAt": "2020-07-15T14:25:03Z", "author": {"login": "akalash"}, "path": "modules/core/src/test/java/org/apache/ignite/internal/processors/cluster/BaselineAutoAdjustTest.java", "diffHunk": "@@ -585,6 +586,39 @@ public void shouldJoinFailedBecauseCoordinatorIsInMemoryNodeAndEnabledAutoAdjust\n         }\n     }\n \n+    /**\n+     * Test that node joins baseline topology after enabling auto adjust.\n+     *\n+     * Description:\n+     * Start first node and set baseline auto adjust timeout to 100ms. Disable auto adjust and activate cluster.\n+     * Start another node and wait until it joins cluster. Enable auto adjust and check that node is in\n+     * baseline topology.\n+     *\n+     * @throws Exception If failed.\n+     */\n+    @Test\n+    public void testJoinBltExistingNode() throws Exception {\n+        IgniteEx ignite0 = startGrid(0);\n+\n+        ignite0.cluster().baselineAutoAdjustTimeout(100);\n+\n+        ignite0.cluster().baselineAutoAdjustEnabled(false);\n+\n+        ignite0.cluster().active(true);\n+\n+        startGrid(1);\n+\n+        assertTrue(GridTestUtils.waitForCondition(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deea9cdcfc006f59d928afa42ad3b37f5a1c96e7"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzODYwODgxOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/BaselineTopologyUpdater.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyNzo1NVrOGyAyjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDoyNzo1NVrOGyAyjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA5NDkyNQ==", "bodyText": "Do you add separate 'if' consciously or by mistake? ('if' which is above has the same return value)", "url": "https://github.com/gridgain/gridgain/pull/1288#discussion_r455094925", "createdAt": "2020-07-15T14:27:55Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cluster/baseline/autoadjust/BaselineTopologyUpdater.java", "diffHunk": "@@ -152,6 +150,9 @@ public BaselineAutoAdjustStatus getStatus() {\n             if (lastBaselineData.isAdjusted())\n                 return BaselineAutoAdjustStatus.notScheduled();\n \n+            if (baselineAutoAdjustScheduler.isExecutionExpired(lastBaselineData))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deea9cdcfc006f59d928afa42ad3b37f5a1c96e7"}, "originalPosition": 94}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3347, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}