{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTk3NDU1", "number": 1338, "title": "GG-30394 False start of cacheGrpStates initialization(in CheckpointEntry)", "bodyText": "", "createdAt": "2020-08-03T14:03:55Z", "url": "https://github.com/gridgain/gridgain/pull/1338", "merged": true, "mergeCommit": {"oid": "972dd7298bdc1105198aa6bb212308f207b5e91d"}, "closed": true, "closedAt": "2020-08-06T10:52:55Z", "author": {"login": "ibessonov"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7Sh_fAH2gAyNDYyMTk3NDU1OmM2YWUxMzhlOTkyZjcwMjIyYWVjNDc1NzJlMDRjNGFkNTViYzUzN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8MpbbgH2gAyNDYyMTk3NDU1OmZkYzk3ZDQ5MzhkZGMwZTRhZDU5MTU1Yzk0Y2ZjMDVkMGViNzM1Zjk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6ae138e992f70222aec47572e04c4ad55bc537e", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/c6ae138e992f70222aec47572e04c4ad55bc537e", "committedDate": "2020-08-03T14:03:02Z", "message": "GG-30394 Prototype solution without test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f88a371a0997ac283df54635e4f9c3d991d5191", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/2f88a371a0997ac283df54635e4f9c3d991d5191", "committedDate": "2020-08-03T14:10:43Z", "message": "GG-30394 Assertion instead of check."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c3072f24745d2c74173e03e6c13e7bc17970130", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/9c3072f24745d2c74173e03e6c13e7bc17970130", "committedDate": "2020-08-04T06:02:03Z", "message": "GG-30394 Other fix that won't mess with soft references."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd668c6e20a96e6b6085809065d06e6e9f4bf52d", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/dd668c6e20a96e6b6085809065d06e6e9f4bf52d", "committedDate": "2020-08-04T06:05:15Z", "message": "GG-30394 First fix rolled back."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/b5a94d32892c101a5b64a979d1e218e39e7a2ba3", "committedDate": "2020-08-04T08:51:14Z", "message": "GG-30394 \"hasSpace\" removed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODAxMTMx", "url": "https://github.com/gridgain/gridgain/pull/1338#pullrequestreview-460801131", "createdAt": "2020-08-04T13:15:48Z", "commit": {"oid": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzoxNTo0OFrOG7f4ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxMzoxODoxM1rOG7f-rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MTU3MQ==", "bodyText": "to avoid mistakes in further refactoring, I suggest splitting this method into two with the following signature:\n\nvoid addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates)\nvoid addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CheckpointEntry.GroupState> cacheGrpStates)\n\nAnd extract following code to extra method:\nif (!earliestCp.containsKey(grpPartKey))\n         earliestCp.put(grpPartKey, entry);\n\nbecause if tomorrow somebody changes the condition there are no guarantees that they do it in both places.", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465041571", "createdAt": "2020-08-04T13:15:48Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -240,21 +242,38 @@ public CheckpointEntry lastCheckpointMarkingAsInapplicable(Integer grpId) {\n      * Add last checkpoint to map of the earliest checkpoints.\n      *\n      * @param entry Checkpoint entry.\n+     * @param cacheGrpStates\n      */\n-    private void addCpToEarliestCpMap(CheckpointEntry entry) {\n+    private void addCpToEarliestCpMap(CheckpointEntry entry, Map<Integer, CacheState> cacheGrpStates) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTA0MzExOQ==", "bodyText": "I believe it makes sense to add some comment why using cacheGrpStates from entry is a bad idea(to prevent further mistakes)", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r465043119", "createdAt": "2020-08-04T13:18:13Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -174,9 +175,10 @@ public WALPointer firstCheckpointPointer() {\n      * is not finished yet.\n      *\n      * @param entry Entry to add.\n+     * @param cacheGrpStates", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5a94d32892c101a5b64a979d1e218e39e7a2ba3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/3103a1af9fc0bcc24c64f51f9d84dc2270b2caa9", "committedDate": "2020-08-05T06:20:31Z", "message": "GG-30394 Review remarks addressed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9", "committedDate": "2020-08-06T07:30:59Z", "message": "GG-30394 Missing exception thrown."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyMzQ3NTE1", "url": "https://github.com/gridgain/gridgain/pull/1338#pullrequestreview-462347515", "createdAt": "2020-08-06T09:14:26Z", "commit": {"oid": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOToxNDoyNlrOG8qWyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQwOToxNjoyOFrOG8qfvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2MTcwNg==", "bodyText": "As I understand you can skip the assignment of initEx here, because if you just throw an exception from here, initEx will be assignmented in the catch block.", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466261706", "createdAt": "2020-08-06T09:14:26Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointEntry.java", "diffHunk": "@@ -356,9 +356,12 @@ private void initIfNeeded(\n \n                         grpStates = remap(stateRec);\n                     }\n-                    else\n+                    else {\n                         initEx = new IgniteCheckedException(\n                             \"Failed to find checkpoint record at the given WAL pointer: \" + ptr);\n+\n+                        throw initEx;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjI2Mzk5OA==", "bodyText": "You can use variable 'states' here because entry.groupState(cctx) was called in this method a little earlier.", "url": "https://github.com/gridgain/gridgain/pull/1338#discussion_r466263998", "createdAt": "2020-08-06T09:16:28Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/checkpoint/CheckpointHistory.java", "diffHunk": "@@ -211,7 +213,7 @@ private void updateEarliestCpMap(CheckpointEntry entry) {\n                     iter.remove();\n             }\n \n-            addCpToEarliestCpMap(entry);\n+            addCpGroupStatesToEarliestCpMap(entry, entry.groupState(cctx));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80ea7f13e610f1f7bf56f2b08cafdfcc5c57ada9"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "author": {"user": {"login": "ibessonov", "name": "ibessonov"}}, "url": "https://github.com/gridgain/gridgain/commit/fdc97d4938ddc0e4ad59155c94cfc05d0eb735f9", "committedDate": "2020-08-06T09:45:39Z", "message": "GG-30394 Review remarks addressed."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 53, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}