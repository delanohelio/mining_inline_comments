{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2MTU5MDY3", "number": 1291, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoxOTo0OFrOERBUZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjowNTo0OFrOEXLhjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjgyODUyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheOffheapManagerImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoxOTo0OFrOG1f2Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjoxOTo0OFrOG1f2Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc0OTQ5NQ==", "bodyText": "True -> true, .m -> ,", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458749495", "createdAt": "2020-07-22T12:19:48Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/IgniteCacheOffheapManagerImpl.java", "diffHunk": "@@ -3159,6 +3231,14 @@ public boolean found() {\n         }\n     }\n \n+    /**\n+     * @param cctx Cache context.\n+     * @return {@code True} if Incremental DR enabled for cache.m {@code false} otherwise.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 206}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Mjg5ODE2OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozOTo1OFrOG1giOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjozOTo1OFrOG1giOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2MDc2Mw==", "bodyText": "updateCntr is ignored", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458760763", "createdAt": "2020-07-22T12:39:58Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "diffHunk": "@@ -50,7 +50,7 @@ public GridCacheVersionEx() {\n      * @param dataCenterId Data center ID.\n      * @param drVer DR version.\n      */\n-    public GridCacheVersionEx(int topVer, long order, int nodeOrder, byte dataCenterId,\n+    public GridCacheVersionEx(int topVer, long order, int nodeOrder, byte dataCenterId, long updateCntr,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjkxMDg2OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/UpdateLogRow.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0MzozOVrOG1gqJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0MzozOVrOG1gqJQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2Mjc4OQ==", "bodyText": "misleading comment", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458762789", "createdAt": "2020-07-22T12:43:39Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/UpdateLogRow.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.processors.cache.CacheGroupContext;\n+import org.apache.ignite.internal.processors.cache.CacheObject;\n+import org.apache.ignite.internal.processors.cache.KeyCacheObject;\n+import org.apache.ignite.internal.processors.cache.persistence.CacheDataRowAdapter;\n+import org.apache.ignite.internal.processors.cache.version.GridCacheVersion;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+\n+/**\n+ *\n+ */\n+public class UpdateLogRow {\n+    /** Cache ID. */\n+    @GridToStringInclude\n+    public int cacheId;\n+\n+    /** Expire time. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MjkyMzA3OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/UpdateLogRow.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0Njo1MFrOG1gxqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0Njo1MFrOG1gxqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDcxMg==", "bodyText": "Why do you make it public?", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458764712", "createdAt": "2020-07-22T12:46:50Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/UpdateLogRow.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.processors.cache.CacheGroupContext;\n+import org.apache.ignite.internal.processors.cache.CacheObject;\n+import org.apache.ignite.internal.processors.cache.KeyCacheObject;\n+import org.apache.ignite.internal.processors.cache.persistence.CacheDataRowAdapter;\n+import org.apache.ignite.internal.processors.cache.version.GridCacheVersion;\n+import org.apache.ignite.internal.util.tostring.GridToStringInclude;\n+import org.apache.ignite.internal.util.typedef.internal.S;\n+\n+/**\n+ *\n+ */\n+public class UpdateLogRow {\n+    /** Cache ID. */\n+    @GridToStringInclude\n+    public int cacheId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzE3MDIxOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMzo0NzowOVrOG1jMYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMzo0NzowOVrOG1jMYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwNDMyMQ==", "bodyText": "@Override public void store(\n        long dstPageAddr,\n        int dstIdx,\n        BPlusIO<UpdateLogRow> srcIo,\n        long srcPageAddr,\n        int srcIdx\n    ) throws IgniteCheckedException {", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458804321", "createdAt": "2020-07-22T13:47:09Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusInnerIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogInnerIO extends BPlusInnerIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param canGetRow If we can get full row from this page.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogInnerIO(int type, int ver, boolean canGetRow, int itemSize) {\n+        super(type, ver, canGetRow, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr > 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,\n+        int dstIdx,\n+        BPlusIO<UpdateLogRow> srcIo,\n+        long srcPageAddr,\n+        int srcIdx) throws IgniteCheckedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzE5ODQ0OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMzo1MzoxOVrOG1jd5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMzo1MzoxOVrOG1jd5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgwODgwNw==", "bodyText": "It worth to place all update-log-tree-related classes under tree.updatelog package", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458808807", "createdAt": "2020-07-22T13:53:19Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusInnerIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogInnerIO extends BPlusInnerIO<UpdateLogRow> implements UpdateLogRowIO {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzM1ODUxOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyNzowMlrOG1lACg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNDoyNzowMlrOG1lACg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODgzMzkzMA==", "bodyText": "Looks like this code was copy-pasted from AbstractPendingEntryInnerIO without changes", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458833930", "createdAt": "2020-07-22T14:27:02Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusInnerIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogInnerIO extends BPlusInnerIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param canGetRow If we can get full row from this page.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogInnerIO(int type, int ver, boolean canGetRow, int itemSize) {\n+        super(type, ver, canGetRow, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr > 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,\n+        int dstIdx,\n+        BPlusIO<UpdateLogRow> srcIo,\n+        long srcPageAddr,\n+        int srcIdx) throws IgniteCheckedException {\n+        int dstOff = offset(dstIdx);\n+\n+        long link = ((PendingRowIO)srcIo).getLink(srcPageAddr, srcIdx);\n+        long expireTime = ((PendingRowIO)srcIo).getExpireTime(srcPageAddr, srcIdx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzY0MjEyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNToyNzo0MVrOG1nxoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNjoyNDoxMlrOG4UmqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3OTM5Mw==", "bodyText": "Could we reuse storeByOffset here? At the first glance it could cost us unnecessary object creation, but IMO JIT will inline it.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458879393", "createdAt": "2020-07-22T15:27:41Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusInnerIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogInnerIO extends BPlusInnerIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param canGetRow If we can get full row from this page.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogInnerIO(int type, int ver, boolean canGetRow, int itemSize) {\n+        super(type, ver, canGetRow, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr > 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,\n+        int dstIdx,\n+        BPlusIO<UpdateLogRow> srcIo,\n+        long srcPageAddr,\n+        int srcIdx) throws IgniteCheckedException {\n+        int dstOff = offset(dstIdx);\n+\n+        long link = ((PendingRowIO)srcIo).getLink(srcPageAddr, srcIdx);\n+        long expireTime = ((PendingRowIO)srcIo).getExpireTime(srcPageAddr, srcIdx);\n+\n+        PageUtils.putLong(dstPageAddr, dstOff, expireTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTcxMTAxNg==", "bodyText": "I think \"inlining\" in this particular case doesn't mentioned in JMM spec.\nWho will \"inline\" this in runtime? C1 or C2. Any proof?\nWhat if user disable C2  due to any reasons?", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r461711016", "createdAt": "2020-07-28T16:24:12Z", "author": {"login": "AMashenkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogInnerIO.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusInnerIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogInnerIO extends BPlusInnerIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param canGetRow If we can get full row from this page.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogInnerIO(int type, int ver, boolean canGetRow, int itemSize) {\n+        super(type, ver, canGetRow, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr > 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,\n+        int dstIdx,\n+        BPlusIO<UpdateLogRow> srcIo,\n+        long srcPageAddr,\n+        int srcIdx) throws IgniteCheckedException {\n+        int dstOff = offset(dstIdx);\n+\n+        long link = ((PendingRowIO)srcIo).getLink(srcPageAddr, srcIdx);\n+        long expireTime = ((PendingRowIO)srcIo).getExpireTime(srcPageAddr, srcIdx);\n+\n+        PageUtils.putLong(dstPageAddr, dstOff, expireTime);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg3OTM5Mw=="}, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzcwMjI3OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogLeafIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0MDo1OVrOG1oX2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0MDo1OVrOG1oX2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg4OTE3OA==", "bodyText": "It's not expire time", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458889178", "createdAt": "2020-07-22T15:40:59Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogLeafIO.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusLeafIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogLeafIO extends BPlusLeafIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogLeafIO(int type, int ver, int itemSize) {\n+        super(type, ver, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr != 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,\n+        int dstIdx,\n+        BPlusIO<UpdateLogRow> srcIo,\n+        long srcPageAddr,\n+        int srcIdx) throws IgniteCheckedException {\n+        int dstOff = offset(dstIdx);\n+\n+        long link = ((UpdateLogRowIO)srcIo).getLink(srcPageAddr, srcIdx);\n+        long expireTime = ((UpdateLogRowIO)srcIo).getUpdateCounter(srcPageAddr, srcIdx);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzcwNTA4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogLeafIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0MTo0MFrOG1oZoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0MTo0MFrOG1oZoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg4OTYzMw==", "bodyText": "please format this as noted above", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458889633", "createdAt": "2020-07-22T15:41:40Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/AbstractUpdateLogLeafIO.java", "diffHunk": "@@ -0,0 +1,96 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageUtils;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusLeafIO;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public abstract class AbstractUpdateLogLeafIO extends BPlusLeafIO<UpdateLogRow> implements UpdateLogRowIO {\n+    /**\n+     * @param type Page type.\n+     * @param ver Page format version.\n+     * @param itemSize Single item size on page.\n+     */\n+    AbstractUpdateLogLeafIO(int type, int ver, int itemSize) {\n+        super(type, ver, itemSize);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void storeByOffset(long pageAddr, int off, UpdateLogRow row) {\n+        assert row.link != 0;\n+        assert row.updateCntr != 0;\n+\n+        PageUtils.putLong(pageAddr, off, row.updateCntr);\n+        PageUtils.putLong(pageAddr, off + 8, row.link);\n+\n+        if (storeCacheId()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID;\n+\n+            PageUtils.putInt(pageAddr, off + 16, row.cacheId);\n+        }\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override public void store(long dstPageAddr,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2MzcyMjYyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/PartitionLogTree.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0NTozM1rOG1okYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo0NTozM1rOG1okYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg5MjM4Ng==", "bodyText": "assert cmp == 0 && row.link != 0 && io.getLink(pageAddr, idx) == row.link;", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458892386", "createdAt": "2020-07-22T15:45:33Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/tree/PartitionLogTree.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright 2019 GridGain Systems, Inc. and Contributors.\n+ *\n+ * Licensed under the GridGain Community Edition License (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     https://www.gridgain.com/products/software/community-edition/gridgain-community-edition-license\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package org.apache.ignite.internal.processors.cache.tree;\n+\n+import org.apache.ignite.IgniteCheckedException;\n+import org.apache.ignite.internal.pagemem.PageMemory;\n+import org.apache.ignite.internal.processors.cache.CacheGroupContext;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.BPlusTree;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.io.BPlusIO;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.reuse.ReuseList;\n+import org.apache.ignite.internal.processors.cache.persistence.tree.util.PageLockListener;\n+import org.apache.ignite.internal.util.typedef.internal.CU;\n+\n+/**\n+ *\n+ */\n+public class PartitionLogTree extends BPlusTree<UpdateLogRow, UpdateLogRow> {\n+    /** */\n+    public static final Object FULL_ROW = new Object();\n+\n+    /** */\n+    private final CacheGroupContext grp;\n+\n+    /**\n+     * @param grp Cache group.\n+     * @param name Tree name.\n+     * @param pageMem Page memory.\n+     * @param metaPageId Meta page ID.\n+     * @param reuseList Reuse list.\n+     * @param initNew Initialize new index.\n+     * @throws IgniteCheckedException If failed.\n+     */\n+    public PartitionLogTree(\n+        CacheGroupContext grp,\n+        String name,\n+        PageMemory pageMem,\n+        long metaPageId,\n+        ReuseList reuseList,\n+        boolean initNew,\n+        PageLockListener lockLsnr\n+    ) throws IgniteCheckedException {\n+        super(\n+            name,\n+            grp.groupId(),\n+            grp.name(),\n+            pageMem,\n+            grp.dataRegion().config().isPersistenceEnabled() ? grp.shared().wal() : null,\n+            grp.offheap().globalRemoveId(),\n+            metaPageId,\n+            reuseList,\n+            grp.sharedGroup() ? CacheIdAwareUpdateLogInnerIO.VERSIONS : UpdateLogInnerIO.VERSIONS,\n+            grp.sharedGroup() ? CacheIdAwareUpdateLogLeafIO.VERSIONS : UpdateLogLeafIO.VERSIONS,\n+            grp.shared().kernalContext().failure(),\n+            lockLsnr\n+        );\n+\n+        this.grp = grp;\n+\n+        assert !grp.dataRegion().config().isPersistenceEnabled() || grp.shared().database().checkpointLockIsHeldByThread();\n+\n+        initTree(initNew);\n+    }\n+\n+    /** {@inheritDoc} */\n+    @Override protected int compare(BPlusIO<UpdateLogRow> iox, long pageAddr, int idx, UpdateLogRow row) {\n+        UpdateLogRowIO io = (UpdateLogRowIO)iox;\n+\n+        int cmp;\n+\n+        if (grp.sharedGroup()) {\n+            assert row.cacheId != CU.UNDEFINED_CACHE_ID : \"Cache ID is not provided!\";\n+            assert io.getCacheId(pageAddr, idx) != CU.UNDEFINED_CACHE_ID : \"Cache ID is not stored!\";\n+\n+            cmp = Integer.compare(io.getCacheId(pageAddr, idx), row.cacheId);\n+\n+            if (cmp != 0)\n+                return cmp;\n+\n+            if (row.updateCntr == 0 && row.link == 0) {\n+                // A search row with a cache ID only is used as a cache bound.\n+                // The found position will be shifted until the exact cache bound is found;\n+                // See for details:\n+                // o.a.i.i.p.c.database.tree.BPlusTree.ForwardCursor.findLowerBound()\n+                // o.a.i.i.p.c.database.tree.BPlusTree.ForwardCursor.findUpperBound()\n+                return cmp;\n+            }\n+        }\n+\n+        long updCntr = io.getUpdateCounter(pageAddr, idx);\n+\n+        cmp = Long.compare(updCntr, row.updateCntr);\n+\n+        if (cmp == 0 && row.link != 0)\n+            assert io.getLink(pageAddr, idx) == row.link;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Mzc2ODMwOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/tree/io/PageIO.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo1NjowMFrOG1pBIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxNTo1NjowMFrOG1pBIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODg5OTc0Nw==", "bodyText": "h2ExtraInnerIOs is a constant now, hence it should be named with underscore", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r458899747", "createdAt": "2020-07-22T15:56:00Z", "author": {"login": "korlov42"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/tree/io/PageIO.java", "diffHunk": "@@ -109,16 +113,16 @@\n     public static final short MAX_PAYLOAD_SIZE = 2048;\n \n     /** */\n-    private static List<IOVersions<? extends BPlusInnerIO<?>>> h2ExtraInnerIOs = new ArrayList<>(MAX_PAYLOAD_SIZE);\n+    private static final List<IOVersions<? extends BPlusInnerIO<?>>> h2ExtraInnerIOs = new ArrayList<>(MAX_PAYLOAD_SIZE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8008e993853b75068d5eca703faa9cffa544b220"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNzMzOTcxOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/tree/io/PagePartitionMetaIO.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMTo0NDozMVrOG-0FSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzo0Mjo1OFrOG-4Y7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODIxOQ==", "bodyText": "So, these are io versions specific for GG, right?\nWas this discussed with Technical Decisions Approval team?", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468518219", "createdAt": "2020-08-11T11:44:31Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/tree/io/PagePartitionMetaIO.java", "diffHunk": "@@ -46,7 +46,8 @@\n     /** */\n     public static final IOVersions<PagePartitionMetaIO> VERSIONS = new IOVersions<>(\n         new PagePartitionMetaIO(1),\n-        new PagePartitionMetaIOV2(2)\n+        new PagePartitionMetaIOV2(2),\n+        new PagePartitionMetaIOV2(Short.toUnsignedInt((short)-1)) // Prevent partition usage on old versions after upgrade.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4ODc4Mg==", "bodyText": "Sure, we discussed this with Alex Goncharuk and concluded\nas we can't reserve version number in Ignite, then we will use negative versions in GG CE.\nThis looks a bit tricky due to lack of PageIO's flexibility.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468588782", "createdAt": "2020-08-11T13:42:58Z", "author": {"login": "AMashenkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/tree/io/PagePartitionMetaIO.java", "diffHunk": "@@ -46,7 +46,8 @@\n     /** */\n     public static final IOVersions<PagePartitionMetaIO> VERSIONS = new IOVersions<>(\n         new PagePartitionMetaIO(1),\n-        new PagePartitionMetaIOV2(2)\n+        new PagePartitionMetaIOV2(2),\n+        new PagePartitionMetaIOV2(Short.toUnsignedInt((short)-1)) // Prevent partition usage on old versions after upgrade.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODIxOQ=="}, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNzM0MjQ4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheOffheapManager.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMTo0NToxMlrOG-0G3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMzo0MzozOFrOG-4arA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODYyMg==", "bodyText": "You upgrade to version 3 using V2 class, is that ok? Also, space after ) is redundant.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468518622", "createdAt": "2020-08-11T11:45:12Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheOffheapManager.java", "diffHunk": "@@ -2031,53 +2077,55 @@ private Metas getOrAllocatePartitionMetas() throws IgniteCheckedException {\n \n                         int pageVer = PagePartitionMetaIO.getVersion(pageAddr);\n \n-                        if (pageVer < 2) {\n-                            assert pageVer == 1;\n-\n+                        if (pageVer < 3) {\n                             if (log.isDebugEnabled())\n                                 log.info(\"Upgrade partition meta page version: [part=\" + partId +\n-                                    \", grpId=\" + grpId + \", oldVer=\" + pageVer +\n-                                    \", newVer=\" + io.getVersion()\n+                                        \", grpId=\" + grpId + \", oldVer=\" + pageVer +\n+                                        \", newVer=\" + io.getVersion()\n                                 );\n \n                             io = PagePartitionMetaIO.VERSIONS.latest();\n \n-                            ((PagePartitionMetaIOV2)io).upgradePage(pageAddr);\n+                            assert io.getVersion() == Short.toUnsignedInt((short)-1);\n+\n+                            ((PagePartitionMetaIOV2) io).upgradePage(pageAddr, pageVer);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 199}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU4OTIyOA==", "bodyText": "Got it.\nI'll create a separate class for new version.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468589228", "createdAt": "2020-08-11T13:43:38Z", "author": {"login": "AMashenkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/persistence/GridCacheOffheapManager.java", "diffHunk": "@@ -2031,53 +2077,55 @@ private Metas getOrAllocatePartitionMetas() throws IgniteCheckedException {\n \n                         int pageVer = PagePartitionMetaIO.getVersion(pageAddr);\n \n-                        if (pageVer < 2) {\n-                            assert pageVer == 1;\n-\n+                        if (pageVer < 3) {\n                             if (log.isDebugEnabled())\n                                 log.info(\"Upgrade partition meta page version: [part=\" + partId +\n-                                    \", grpId=\" + grpId + \", oldVer=\" + pageVer +\n-                                    \", newVer=\" + io.getVersion()\n+                                        \", grpId=\" + grpId + \", oldVer=\" + pageVer +\n+                                        \", newVer=\" + io.getVersion()\n                                 );\n \n                             io = PagePartitionMetaIO.VERSIONS.latest();\n \n-                            ((PagePartitionMetaIOV2)io).upgradePage(pageAddr);\n+                            assert io.getVersion() == Short.toUnsignedInt((short)-1);\n+\n+                            ((PagePartitionMetaIOV2) io).upgradePage(pageAddr, pageVer);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUxODYyMg=="}, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 199}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkyNzQxNTE4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMVQxMjowNTo0OFrOG-0x0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQwNjoxNDoyNlrOG_TKpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUyOTYxNw==", "bodyText": "Hate to say this but I believe that new version of object won't be deserialized properly on old nodes when RU enabled.\nIt'll try to read field \"drVer\" but \"updateCounter\" is found. \"u\" goes after \"d\" in alphabet, so reader will assume that \"drVer\" field is removed and will nullify it. Have you tested it? Am I wrong?\nWe need to make sure that this code is 100% safe.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468529617", "createdAt": "2020-08-11T12:05:48Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "diffHunk": "@@ -105,7 +107,7 @@ public GridCacheVersionEx(int topVer, int nodeOrderDrId, long order, GridCacheVe\n         }\n \n         switch (writer.state()) {\n-            case 3:\n+            case 4:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODU5MzYzNg==", "bodyText": "Sounds sad. I believe it is safe to add new fields.\nI'll check this.", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r468593636", "createdAt": "2020-08-11T13:49:38Z", "author": {"login": "AMashenkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "diffHunk": "@@ -105,7 +107,7 @@ public GridCacheVersionEx(int topVer, int nodeOrderDrId, long order, GridCacheVe\n         }\n \n         switch (writer.state()) {\n-            case 3:\n+            case 4:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUyOTYxNw=="}, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTAyNzQ5Mg==", "bodyText": "Cool, now it works for sure!", "url": "https://github.com/gridgain/gridgain/pull/1291#discussion_r469027492", "createdAt": "2020-08-12T06:14:26Z", "author": {"login": "ibessonov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/cache/version/GridCacheVersionEx.java", "diffHunk": "@@ -105,7 +107,7 @@ public GridCacheVersionEx(int topVer, int nodeOrderDrId, long order, GridCacheVe\n         }\n \n         switch (writer.state()) {\n-            case 3:\n+            case 4:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2ODUyOTYxNw=="}, "originalCommit": {"oid": "2074b98352a3c2ee9d2d07de6b7bc314a14df297"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3350, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}