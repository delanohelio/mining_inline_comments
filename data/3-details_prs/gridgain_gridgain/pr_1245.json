{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NzEzNzgz", "number": 1245, "title": "GG-29781 Get rid of release pinned page AssertionError in case of hug\u2026", "bodyText": "\u2026e rebuild index workers are in progress.", "createdAt": "2020-06-17T09:11:22Z", "url": "https://github.com/gridgain/gridgain/pull/1245", "merged": true, "mergeCommit": {"oid": "3b19600144d2b3a9c0da426fd2e18dc0cedb1f1d"}, "closed": true, "closedAt": "2020-07-03T08:19:12Z", "author": {"login": "tkalkirill"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrcjTuAH2gAyNDM1NzEzNzgzOjQ4N2ZlZDU3NDMwMmE2MTg5NTg4MDlhMjIyNjQxNTI2MWM0YmZkMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwXev9gH2gAyNDM1NzEzNzgzOjQ2NDg4NDcyNGQ2NTJhOWY5NTIwNzhkMjJmZTk5MWRhNTIxNTlhOWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "487fed574302a618958809a2226415261c4bfd1e", "author": {"user": {"login": "zstan", "name": "Evgeniy Stanilovskiy"}}, "url": "https://github.com/gridgain/gridgain/commit/487fed574302a618958809a2226415261c4bfd1e", "committedDate": "2020-06-15T08:40:44Z", "message": "GG-29781 Get rid of release pinned page AssertionError in case of huge rebuild index workers are in progress."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19", "author": {"user": {"login": "zstan", "name": "Evgeniy Stanilovskiy"}}, "url": "https://github.com/gridgain/gridgain/commit/7cab66a879eb9d27aff10a62b47526deed0c8a19", "committedDate": "2020-06-17T10:05:21Z", "message": "fix for StopNodeOnRebuildIndexFailureTest"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMzgzOTI0", "url": "https://github.com/gridgain/gridgain/pull/1245#pullrequestreview-432383924", "createdAt": "2020-06-17T13:10:54Z", "commit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzoxMDo1NFrOGlE_jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzozNjoxOFrOGlGE7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzMjMwMQ==", "bodyText": "Before flag was allowed to stop rebuild index only for a single cache group, now it turns out to all be stopped.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r441532301", "createdAt": "2020-06-17T13:10:54Z", "author": {"login": "tkalkirill"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCachePartitionWorker.java", "diffHunk": "@@ -56,10 +55,7 @@\n     private final GridCacheContext cctx;\n \n     /** Stop flag between all workers for one cache. */\n-    private final AtomicBoolean stop;\n-\n-    /** Cancellation token between all workers for all caches. */\n-    private final SchemaIndexOperationCancellationToken cancel;\n+    private static volatile boolean stop;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1MDA2MQ==", "bodyText": "Instead of a collection, you can use buildIdxCompoundFut to call cancel.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r441550061", "createdAt": "2020-06-17T13:36:18Z", "author": {"login": "tkalkirill"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCacheVisitorImpl.java", "diffHunk": "@@ -51,15 +52,15 @@\n     /** Cache context. */\n     private final GridCacheContext cctx;\n \n-    /** Cancellation token. */\n-    private final SchemaIndexOperationCancellationToken cancel;\n-\n     /** Future for create/rebuild index. */\n     protected final GridFutureAdapter<Void> buildIdxFut;\n \n     /** Logger. */\n     private IgniteLogger log;\n \n+    /** Index processing workers. */\n+    private List<GridWorker> idxWorkers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b0f29b01ebdbe997e1d3f00acba42ba660ebe90", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/1b0f29b01ebdbe997e1d3f00acba42ba660ebe90", "committedDate": "2020-06-19T14:04:36Z", "message": "Merge branch 'master' into gg-29781"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5519b2b6391223224f4d305e17951f5417644f56", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/5519b2b6391223224f4d305e17951f5417644f56", "committedDate": "2020-06-19T14:12:03Z", "message": "GG-29781 WIP revert to master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03", "committedDate": "2020-06-23T05:54:30Z", "message": "GG-29781 WIP impl cancel with wait finish opepration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM2MTU2NDg3", "url": "https://github.com/gridgain/gridgain/pull/1245#pullrequestreview-436156487", "createdAt": "2020-06-23T21:04:00Z", "commit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTowNDowMFrOGn6lbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMToxOTowMVrOGn7Bpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNzUwMA==", "bodyText": "Why are we waiting only 2 seconds? As I understand we should wait until future completed.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444507500", "createdAt": "2020-06-23T21:04:00Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            IgniteInternalFuture<?> opFut = cancelToken.operationFuture();\n+\n+            if (nonNull(opFut)) {\n+                try {\n+                    opFut.get(2_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNzgxMQ==", "bodyText": "Add logs here.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444507811", "createdAt": "2020-06-23T21:04:41Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            IgniteInternalFuture<?> opFut = cancelToken.operationFuture();\n+\n+            if (nonNull(opFut)) {\n+                try {\n+                    opFut.get(2_000);\n+                }\n+                catch (IgniteCheckedException ignore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxMjAzMw==", "bodyText": "So far this code seems at less strange.\nWe a have an instance of cancelToken, which stored a future internally. But why you get it out, need to wait it internal of cancel. Because if operation is canceled means the future in completed.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444512033", "createdAt": "2020-06-23T21:13:14Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxNDcyNw==", "bodyText": "This future and token look like parts of one thing.\nYou need to implement an object which was a future and token simultaneously, because current variant look ugly and unclear.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444514727", "createdAt": "2020-06-23T21:19:01Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java", "diffHunk": "@@ -1688,11 +1688,14 @@ public void processSchemaOperationLocal(SchemaAbstractOperation op, QueryTypeDes\n                             }\n                         }\n                     };\n+\n+                    cancelTok.operationFuture(createIdxFut);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e73d9fcc5cf6c56b102f5687bef66a60446375cb", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/e73d9fcc5cf6c56b102f5687bef66a60446375cb", "committedDate": "2020-06-25T07:21:03Z", "message": "Merge branch 'master' into gg-29781"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e428a70c13d5e7c7106ffe5562b23d47f284bb5e", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/e428a70c13d5e7c7106ffe5562b23d47f284bb5e", "committedDate": "2020-06-25T08:51:56Z", "message": "GG-29781 WIP after msk review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/11d03b8742e944ba229bd1dfb2d7791722596e70", "committedDate": "2020-06-26T16:40:48Z", "message": "GG-29781 WIP fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NTcyNDMx", "url": "https://github.com/gridgain/gridgain/pull/1245#pullrequestreview-438572431", "createdAt": "2020-06-26T20:22:08Z", "commit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyMjowOFrOGptoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyMjowOFrOGptoZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQyMg==", "bodyText": "I think when you use isDebugEnable() need printing via debug(...).\nBut here warning will be better.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r446392422", "createdAt": "2020-06-26T20:22:08Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +178,17 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            try {\n+                fut.get();\n+            }\n+            catch (IgniteCheckedException e) {\n+                if (log.isDebugEnabled())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "originalPosition": 18}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODQ3ODQ1", "url": "https://github.com/gridgain/gridgain/pull/1245#pullrequestreview-439847845", "createdAt": "2020-06-30T09:41:34Z", "commit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo0MTozNFrOGq0dRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo0MTozNFrOGq0dRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1MjgzNg==", "bodyText": "Do you have any guarantees that this future will finish eventually? I just afraid that this line can lead to the hung of the node.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r447552836", "createdAt": "2020-06-30T09:41:34Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +178,17 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            try {\n+                fut.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "464884724d652a9f952078d22fe991da52159a9b", "author": {"user": null}, "url": "https://github.com/gridgain/gridgain/commit/464884724d652a9f952078d22fe991da52159a9b", "committedDate": "2020-06-30T15:35:51Z", "message": "GG-29781 wip add timeout"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4085, "cost": 1, "resetAt": "2021-11-01T14:51:55Z"}}}