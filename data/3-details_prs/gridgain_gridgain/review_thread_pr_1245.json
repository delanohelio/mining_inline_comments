{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NzEzNzgz", "number": 1245, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzoxMDo1NFrOEGV7rA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo0MTozNFrOEKBMdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDg2MjUyOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCachePartitionWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzoxMDo1NFrOGlE_jQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzoxMDo1NFrOGlE_jQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUzMjMwMQ==", "bodyText": "Before flag was allowed to stop rebuild index only for a single cache group, now it turns out to all be stopped.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r441532301", "createdAt": "2020-06-17T13:10:54Z", "author": {"login": "tkalkirill"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCachePartitionWorker.java", "diffHunk": "@@ -56,10 +55,7 @@\n     private final GridCacheContext cctx;\n \n     /** Stop flag between all workers for one cache. */\n-    private final AtomicBoolean stop;\n-\n-    /** Cancellation token between all workers for all caches. */\n-    private final SchemaIndexOperationCancellationToken cancel;\n+    private static volatile boolean stop;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19"}, "originalPosition": 16}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDk3MTU1OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCacheVisitorImpl.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzozNjoxOFrOGlGE7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzozNjoxOFrOGlGE7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTU1MDA2MQ==", "bodyText": "Instead of a collection, you can use buildIdxCompoundFut to call cancel.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r441550061", "createdAt": "2020-06-17T13:36:18Z", "author": {"login": "tkalkirill"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaIndexCacheVisitorImpl.java", "diffHunk": "@@ -51,15 +52,15 @@\n     /** Cache context. */\n     private final GridCacheContext cctx;\n \n-    /** Cancellation token. */\n-    private final SchemaIndexOperationCancellationToken cancel;\n-\n     /** Future for create/rebuild index. */\n     protected final GridFutureAdapter<Void> buildIdxFut;\n \n     /** Logger. */\n     private IgniteLogger log;\n \n+    /** Index processing workers. */\n+    private List<GridWorker> idxWorkers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cab66a879eb9d27aff10a62b47526deed0c8a19"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTY0NjI2OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTowNDowMFrOGn6lbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTowNDowMFrOGn6lbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNzUwMA==", "bodyText": "Why are we waiting only 2 seconds? As I understand we should wait until future completed.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444507500", "createdAt": "2020-06-23T21:04:00Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            IgniteInternalFuture<?> opFut = cancelToken.operationFuture();\n+\n+            if (nonNull(opFut)) {\n+                try {\n+                    opFut.get(2_000);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTY0ODM0OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTowNDo0MVrOGn6mow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMTowNDo0MVrOGn6mow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUwNzgxMQ==", "bodyText": "Add logs here.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444507811", "createdAt": "2020-06-23T21:04:41Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            IgniteInternalFuture<?> opFut = cancelToken.operationFuture();\n+\n+            if (nonNull(opFut)) {\n+                try {\n+                    opFut.get(2_000);\n+                }\n+                catch (IgniteCheckedException ignore) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTY3NTMzOnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMToxMzoxNFrOGn63IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMToxMzoxNFrOGn63IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxMjAzMw==", "bodyText": "So far this code seems at less strange.\nWe a have an instance of cancelToken, which stored a future internally. But why you get it out, need to wait it internal of cancel. Because if operation is canceled means the future in completed.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444512033", "createdAt": "2020-06-23T21:13:14Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +180,19 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2OTY5MjQ5OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMToxOTowMVrOGn7Bpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QyMToxOTowMVrOGn7Bpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDUxNDcyNw==", "bodyText": "This future and token look like parts of one thing.\nYou need to implement an object which was a future and token simultaneously, because current variant look ugly and unclear.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r444514727", "createdAt": "2020-06-23T21:19:01Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/GridQueryProcessor.java", "diffHunk": "@@ -1688,11 +1688,14 @@ public void processSchemaOperationLocal(SchemaAbstractOperation op, QueryTypeDes\n                             }\n                         }\n                     };\n+\n+                    cancelTok.operationFuture(createIdxFut);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a8be65ad5205d7f217a5e0bb7c11ffffd57ba03"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4MTQwMzM5OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyMjowOFrOGptoZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQyMDoyMjowOFrOGptoZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjM5MjQyMg==", "bodyText": "I think when you use isDebugEnable() need printing via debug(...).\nBut here warning will be better.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r446392422", "createdAt": "2020-06-26T20:22:08Z", "author": {"login": "vldpyatkov"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +178,17 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            try {\n+                fut.get();\n+            }\n+            catch (IgniteCheckedException e) {\n+                if (log.isDebugEnabled())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc4OTQwNzg4OnYy", "diffSide": "RIGHT", "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo0MTozNFrOGq0dRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwOTo0MTozNFrOGq0dRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzU1MjgzNg==", "bodyText": "Do you have any guarantees that this future will finish eventually? I just afraid that this line can lead to the hung of the node.", "url": "https://github.com/gridgain/gridgain/pull/1245#discussion_r447552836", "createdAt": "2020-06-30T09:41:34Z", "author": {"login": "akalash"}, "path": "modules/core/src/main/java/org/apache/ignite/internal/processors/query/schema/SchemaOperationWorker.java", "diffHunk": "@@ -177,8 +178,17 @@ public boolean cacheRegistered() {\n      * Cancel operation.\n      */\n     @Override public void cancel() {\n-        if (cancelToken.cancel())\n+        if (cancelToken.cancel()) {\n+            try {\n+                fut.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11d03b8742e944ba229bd1dfb2d7791722596e70"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3334, "cost": 1, "resetAt": "2021-11-12T20:28:25Z"}}}