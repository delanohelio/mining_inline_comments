{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMjg5MjIz", "number": 7589, "title": "Adding GO_AGENT_RESOURCES as environment variable", "bodyText": "The issue fixes upstream GoCD #7575 issue by serializing the agent resources to an environment variable. Note I have signed the CLA.\nIssue: #7575\nDescription:\nWe think that adding a GO_AGENT_RESOURCES environment variable with a comma-separated or JSON/YAML list of assigned agent resources would help in continuous delivery situations where the DevOps people want to get smart/fancy about how pipelines execute. In our case it unblocks using more agents for CM with Ansible.", "createdAt": "2020-01-13T19:45:34Z", "url": "https://github.com/gocd/gocd/pull/7589", "merged": true, "mergeCommit": {"oid": "e71c379f4b1c842a02205b88a94271ca7856b3df"}, "closed": true, "closedAt": "2020-01-16T09:00:14Z", "author": {"login": "Antauri"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6BsB4AH2gAyMzYyMjg5MjIzOmEzNzlhMTRlNTMyMjRjMWIxYmQ0YzgxZTFhMWFjM2MzZDY5NTU3ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb60t8bgH2gAyMzYyMjg5MjIzOmIxMjc0OTNlMTA1ZjFiMzQ1ZGUwZDMyOGUwNWE4NDBkMDJiZmJkMmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a379a14e53224c1b1bd4c81e1a1ac3c3d69557e9", "author": {"user": {"login": "Antauri", "name": "Zamfir Catalin Alexandru"}}, "url": "https://github.com/gocd/gocd/commit/a379a14e53224c1b1bd4c81e1a1ac3c3d69557e9", "committedDate": "2020-01-13T19:40:32Z", "message": "Adding GO_AGENT_RESOURCES as environment variable\n\nThe issue fixes upstream GoCD #7575 issue by serializing the agent resources to an environment variable."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4af20980e94c848c22df215824294e36da40b5a", "author": {"user": null}, "url": "https://github.com/gocd/gocd/commit/e4af20980e94c848c22df215824294e36da40b5a", "committedDate": "2020-01-15T20:24:14Z", "message": "Moved logic for GO_AGENT_RESOURCES in the BuildAssignmentService and enhanced the existing scaffolding tests around secrets/environment with the check for the agent resources environment variable;"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNjkxMjcy", "url": "https://github.com/gocd/gocd/pull/7589#pullrequestreview-343691272", "createdAt": "2020-01-16T06:13:16Z", "commit": {"oid": "e4af20980e94c848c22df215824294e36da40b5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwNjoxMzoxNlrOFeO8zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwNjoxMzoxNlrOFeO8zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzI0NjU0MA==", "bodyText": "How about we don't set the property if the agent doesn't have any resources set on it.", "url": "https://github.com/gocd/gocd/pull/7589#discussion_r367246540", "createdAt": "2020-01-16T06:13:16Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java", "diffHunk": "@@ -291,6 +292,10 @@ private Work createWork(final AgentInstance agent, final JobPlan job) {\n \n                     final EnvironmentVariableContext environmentVariableContext = buildEnvVarContext(job.getIdentifier().getPipelineName());\n \n+                    // Agent may have a NULL \"resources\" so we check and set an empty default here so that tests pass\n+                    String agentResourcesAsCsv = agent.getResourceConfigs() == null ? \"\" : agent.getResourceConfigs().getCommaSeparatedResourceNames();\n+                    environmentVariableContext.setProperty(GO_AGENT_RESOURCES, agentResourcesAsCsv, false);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4af20980e94c848c22df215824294e36da40b5a"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b127493e105f1b345de0d328e05a840d02bfbd2a", "author": {"user": {"login": "Antauri", "name": "Zamfir Catalin Alexandru"}}, "url": "https://github.com/gocd/gocd/commit/b127493e105f1b345de0d328e05a840d02bfbd2a", "committedDate": "2020-01-16T07:07:47Z", "message": "Don't add GO_AGENT_RESOURCES on null resources\n\nIt may happen (and we learned from running the fast-unit tests) that the ResourceConfigs on the agent are null. That means basically there are no defined resources on that agent. Instead of putting an \"empty string\" it's better if we only define this env. var. only if there's something to populate it. It actually would server users better as they can test for existence of certain variables instead of getting empty strings (and in case of non-existence they can default to a pre-set variable, like in Ansible's default () method)."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1981, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}