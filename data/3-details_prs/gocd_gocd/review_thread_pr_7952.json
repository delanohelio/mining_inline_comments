{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk3MjU4MTU0", "number": 7952, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMzo0NDoyM1rODuMoiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMzo0NDoyM1rODuMoiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5NzY4MDcyOnYy", "diffSide": "RIGHT", "path": "server/src/test-fast/java/com/thoughtworks/go/server/controller/AgentRegistrationControllerTest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwMzo0NDoyM1rOGAEIHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNzo0NjozMlrOGAgp3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMDc5OQ==", "bodyText": "@maheshp Is this line necessary? Looking at its impl, it doesn't seem to have any special side effects that were obvious to me. It doesn't appear to hit any critical paths under test. Its return value is not used.\nAlso, when commenting out, the test still passes.", "url": "https://github.com/gocd/gocd/pull/7952#discussion_r402720799", "createdAt": "2020-04-03T03:44:23Z", "author": {"login": "marques-work"}, "path": "server/src/test-fast/java/com/thoughtworks/go/server/controller/AgentRegistrationControllerTest.java", "diffHunk": "@@ -383,6 +383,28 @@ public void shouldAutoRegisterElasticAgent() {\n         verify(agentService).requestRegistration(ElasticAgentRuntimeInfo.fromServer(agentRuntimeInfo, elasticAgentId, elasticPluginId));\n     }\n \n+    @Test\n+    public void shouldNotRelyOnAutoRegisterKeyForRegisteringElasticAgents() {\n+        String uuid = \"elastic-uuid\";\n+        String autoRegisterKey = \"auto_register_key\";\n+\n+        final ServerConfig serverConfig = mockedServerConfig(\"token-generation-key\", autoRegisterKey);\n+        final String token = token(uuid, serverConfig.getTokenGenerationKey());\n+\n+        when(agentService.isRegistered(uuid)).thenReturn(false);\n+        when(goConfigService.serverConfig()).thenReturn(serverConfig);\n+        when(agentService.createAgentUsername(uuid, request.getRemoteAddr(), \"host\")).thenReturn(new Username(\"some-agent-login-name\"));\n+        when(ephemeralAutoRegisterKeyService.validateAndRevoke(any())).thenReturn(false);\n+\n+        String elasticAgentId = \"elastic-agent-id\";\n+        String elasticPluginId = \"elastic-plugin-id\";\n+        AgentRuntimeInfo.fromServer(new Agent(uuid, \"host\", request.getRemoteAddr()), false, \"location\", 233232L, \"osx\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f012adfac5bd78cf236d10dfee5e20ef5169fea7"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE4ODE4OQ==", "bodyText": "Yes, it's redundant. I have changed it.", "url": "https://github.com/gocd/gocd/pull/7952#discussion_r403188189", "createdAt": "2020-04-03T17:46:32Z", "author": {"login": "maheshp"}, "path": "server/src/test-fast/java/com/thoughtworks/go/server/controller/AgentRegistrationControllerTest.java", "diffHunk": "@@ -383,6 +383,28 @@ public void shouldAutoRegisterElasticAgent() {\n         verify(agentService).requestRegistration(ElasticAgentRuntimeInfo.fromServer(agentRuntimeInfo, elasticAgentId, elasticPluginId));\n     }\n \n+    @Test\n+    public void shouldNotRelyOnAutoRegisterKeyForRegisteringElasticAgents() {\n+        String uuid = \"elastic-uuid\";\n+        String autoRegisterKey = \"auto_register_key\";\n+\n+        final ServerConfig serverConfig = mockedServerConfig(\"token-generation-key\", autoRegisterKey);\n+        final String token = token(uuid, serverConfig.getTokenGenerationKey());\n+\n+        when(agentService.isRegistered(uuid)).thenReturn(false);\n+        when(goConfigService.serverConfig()).thenReturn(serverConfig);\n+        when(agentService.createAgentUsername(uuid, request.getRemoteAddr(), \"host\")).thenReturn(new Username(\"some-agent-login-name\"));\n+        when(ephemeralAutoRegisterKeyService.validateAndRevoke(any())).thenReturn(false);\n+\n+        String elasticAgentId = \"elastic-agent-id\";\n+        String elasticPluginId = \"elastic-plugin-id\";\n+        AgentRuntimeInfo.fromServer(new Agent(uuid, \"host\", request.getRemoteAddr()), false, \"location\", 233232L, \"osx\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjcyMDc5OQ=="}, "originalCommit": {"oid": "f012adfac5bd78cf236d10dfee5e20ef5169fea7"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2699, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}