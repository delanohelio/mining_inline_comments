{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwMjc3Nzk4", "number": 7697, "title": "Applied rules after a successful config repo parse", "bodyText": "Issue: #7605\nDescription:\n\nThe PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\nIn case of pre-flight api where no config-repo id is specified, the check is skipped.\n\nPreview:", "createdAt": "2020-02-03T11:52:26Z", "url": "https://github.com/gocd/gocd/pull/7697", "merged": true, "mergeCommit": {"oid": "60c1bf811d45cd60a81e3939f38b127ce82c3eb5"}, "closed": true, "closedAt": "2020-02-05T11:23:59Z", "author": {"login": "kritika-singh3"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcA5ddfgBqjMwMDQ2Mzc1MTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBPvQeAH2gAyMzcwMjc3Nzk4OjE4NTlmMDJmMjcyNDA5MWZlNGY3MzM4NjNhMDk4OWNhYzgwOWNjZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "196d7c1d39ccfb201affc4af9dc8a001c049f7d7", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/196d7c1d39ccfb201affc4af9dc8a001c049f7d7", "committedDate": "2020-02-03T11:48:30Z", "message": "Applied rules after a successful config repo parse\n\n - The PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\n - In case of pre-flight api where no config-repo id is specified, the check is skipped."}, "afterCommit": {"oid": "70c7cbbb3c4bf86dcfca0cf1298e75ce82111c6e", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/70c7cbbb3c4bf86dcfca0cf1298e75ce82111c6e", "committedDate": "2020-02-04T04:02:38Z", "message": "Applied rules after a successful config repo parse\n\n - The PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\n - In case of pre-flight api where no config-repo id is specified, the check is skipped."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyNzk0MTE3", "url": "https://github.com/gocd/gocd/pull/7697#pullrequestreview-352794117", "createdAt": "2020-02-04T08:30:27Z", "commit": {"oid": "9c85244b440c35f58f435a38b8eb17247614b97d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODozMDoyOFrOFlLlGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQwODozMDoyOFrOFlLlGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDUzMTM1Mw==", "bodyText": "@kritika-singh3 @arvindsv @adityasood\nPipeline reference rule defined on a config repository is not applicable for the pipelines coming from the same repository.\nDescription:\nFor the following rule:\n<allow action=\"refer\" type=\"pipeline\">up42</pipeline>\nFollowing partials are coming from config repository:\n\npipeline1 (which has a pipeline-dependency up42)\npipeline2 (which has a pipeline-dependency pipeline1)\n\nEven though, there is no explicit allow permission mentioned for pipeline1 pipeline dependency, it is allowed because both the pipelines are defined in the same repository.\nNote: We need to mention this behavior on our docs explicitly.", "url": "https://github.com/gocd/gocd/pull/7697#discussion_r374531353", "createdAt": "2020-02-04T08:30:28Z", "author": {"login": "GaneshSPatil"}, "path": "server/src/main/java/com/thoughtworks/go/config/update/PartialConfigUpdateCommand.java", "diffHunk": "@@ -58,4 +75,44 @@ public CruiseConfig update(CruiseConfig cruiseConfig) {\n         }\n         return cruiseConfig;\n     }\n+\n+    private boolean validateEntityForRules(PartialConfig partialConfig) {\n+        //preflight check\n+        if (configRepoConfig == null) {\n+            return true;\n+        }\n+\n+        if (configRepoConfig.getRules().isEmpty()) {\n+            throw new InvalidPartialConfigException(partialConfig, \"Configurations can not be merged as no rules are defined.\");\n+        }\n+\n+        partialConfig.getEnvironments().stream()\n+                .filter(env -> !configRepoConfig.canRefer(ENVIRONMENT.getEntityType(), env.name().toString()))\n+                .forEach(envThatCanNotBeReferred -> {\n+                    envThatCanNotBeReferred.addError(ENVIRONMENT.getType(), format(\"Cannot refer environment: '%s' from the config repository.\", envThatCanNotBeReferred.name()));\n+                });\n+\n+        partialConfig.getGroups().stream()\n+                .filter(pipelineGrp -> !configRepoConfig.canRefer(PIPELINE_GROUP.getEntityType(), pipelineGrp.getGroup()))\n+                .forEach(pipelineGrpThatCannotBeReferred -> {\n+                    pipelineGrpThatCannotBeReferred.addError(PIPELINE_GROUP.getType(), format(\"Cannot refer pipeline group: '%s' from the config repository.\", pipelineGrpThatCannotBeReferred.getGroup()));\n+                });\n+\n+        List<DependencyMaterialConfig> dependencyMaterialConfigs = new ArrayList<>();\n+        partialConfig.getGroups().forEach((pipelineGrp) -> {\n+            pipelineGrp.forEach((pipelineConfig) -> dependencyMaterialConfigs.addAll(pipelineConfig.dependencyMaterialConfigs()));\n+        });\n+        dependencyMaterialConfigs.stream()\n+                .filter(dependencyMaterialConfig -> !doesPipelineExistInPartialConfig(partialConfig, dependencyMaterialConfig.getPipelineName()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c85244b440c35f58f435a38b8eb17247614b97d"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb9474f9641a31c6fb4ad4e9429906cde1be35dd", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/fb9474f9641a31c6fb4ad4e9429906cde1be35dd", "committedDate": "2020-02-04T09:53:01Z", "message": "Applied rules after a successful config repo parse\n\n - The PartialConfig is validated against the rules defined in the config repo while updating the config in the PartialConfigUpdateCommand.\n - In case of pre-flight api where no config-repo id is specified, the check is skipped."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe6175dd41778e8355e36db16324df8de382a9e", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/efe6175dd41778e8355e36db16324df8de382a9e", "committedDate": "2020-02-04T09:53:01Z", "message": "Fix tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c85244b440c35f58f435a38b8eb17247614b97d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/9c85244b440c35f58f435a38b8eb17247614b97d", "committedDate": "2020-02-04T05:37:25Z", "message": "Fix tests"}, "afterCommit": {"oid": "5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "committedDate": "2020-02-04T09:53:01Z", "message": "Update error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/5dcc88618f80d43cfd3369cab2fdc7abeb49d14a", "committedDate": "2020-02-04T09:53:01Z", "message": "Update error message"}, "afterCommit": {"oid": "6da558c603d05928403a4e0c81399f1c8ad35134", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/6da558c603d05928403a4e0c81399f1c8ad35134", "committedDate": "2020-02-04T09:59:16Z", "message": "Update error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6da558c603d05928403a4e0c81399f1c8ad35134", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/6da558c603d05928403a4e0c81399f1c8ad35134", "committedDate": "2020-02-04T09:59:16Z", "message": "Update error message"}, "afterCommit": {"oid": "d9d19430f097cbd3f4f451d5742131a46937e416", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d9d19430f097cbd3f4f451d5742131a46937e416", "committedDate": "2020-02-04T10:37:12Z", "message": "Update error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "committedDate": "2020-02-04T11:40:42Z", "message": "Update error message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9d19430f097cbd3f4f451d5742131a46937e416", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d9d19430f097cbd3f4f451d5742131a46937e416", "committedDate": "2020-02-04T10:37:12Z", "message": "Update error message"}, "afterCommit": {"oid": "b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/b10c3532ce91c8ae49c593d52ca92b77cc7b5e18", "committedDate": "2020-02-04T11:40:42Z", "message": "Update error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58ff9b52b50a1e37fed31833970e02d0717243d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/a58ff9b52b50a1e37fed31833970e02d0717243d", "committedDate": "2020-02-05T05:36:48Z", "message": "move the error msg generation to EntityType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1859f02f2724091fe4f733863a0989cac809ccf1", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/1859f02f2724091fe4f733863a0989cac809ccf1", "committedDate": "2020-02-05T06:00:12Z", "message": "Update GoConfigInvalidMergeException getMessage builder to referentiate between rule validation errors and config validation errors"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1952, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}