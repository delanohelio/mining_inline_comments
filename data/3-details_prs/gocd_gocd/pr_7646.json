{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NzM5OTY0", "number": 7646, "title": "Add support for multiple databases ", "bodyText": "Quick spike to demonstrate support for multiple DBs. Currently only briefly tested with H2, PG, and MySQL (mariadb may work, but haven't tested it)\ntl;dr;\n\nModify the file development-utility/development-server/build.gradle to change the dependency :db-support:db-support-{mysql,postgresql,h2} to point to a DB of your choice\nIf using PG or mysql, create the file config/db.properties\n# For postgresql\n#db.driver=org.postgresql.Driver\n#db.url=jdbc:postgresql://localhost:5432/go\n#db.user=ketan\n\n# for MySQL\ndb.driver=com.mysql.cj.jdbc.Driver\ndb.url=jdbc:mysql://localhost:3306/go\ndb.user=root\n\n# for H2, it should be possible to point to an external DB, but haven't tested it yet.\n\nIf using MySQL, turn off identifier case sensitivity. See this doc. This is required because some of the HQL and mybatis queries use table and column names in a case sensitive manner :-(\n\n\nThe long version\nThe original Database seemed to be doing quite some DB specific operations (startup/shutdown/backup), and some operations that should not have been DB specific (upgrade, for e.g.)\nThe new implementation:\n\nmoves the DB migrations into a separate DatabaseMigrator class that performs migrations on @PostConstruct. This is similar to the earlier implementation that called Database#upgrade except that the migration is now managed using liquibase.\nProvides for DB specific operations (like backup and queryextensions), is still delegated to the DB specific implementation. See the Database and ConnectionManager class. The ConnectionManager class loads up a DB specific BackupProcessor and QueryExtensions class. It is still to be determined how to package/distribute these DB specific implementations, a quick way would be to package a fatjar/uberjar containing the BackupProcessor, QueryExtensions class along with the DB driver classes.", "createdAt": "2020-01-20T09:48:00Z", "url": "https://github.com/gocd/gocd/pull/7646", "merged": true, "mergeCommit": {"oid": "e3b237180ca004e32c3e4c8c6d0ed3783b617cb0"}, "closed": true, "closedAt": "2020-06-12T03:39:45Z", "author": {"login": "ketan"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8fSwqABqjI5NjU4MTAxNjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcqab5LABqjM0MzY3NzQ1MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8b1498de00dab12e944e64ef12df71872e9ace2", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/a8b1498de00dab12e944e64ef12df71872e9ace2", "committedDate": "2020-01-20T09:45:41Z", "message": "Add support for multiple databases"}, "afterCommit": {"oid": "1f569ac54a29598d3b7bfb68446b971362dcd9d2", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/1f569ac54a29598d3b7bfb68446b971362dcd9d2", "committedDate": "2020-01-21T11:17:48Z", "message": "Add support for multiple database"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73eadafc991553690565e8b81fc5399219f06077", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/73eadafc991553690565e8b81fc5399219f06077", "committedDate": "2020-01-27T03:55:36Z", "message": "Perform migration before returning a datasource."}, "afterCommit": {"oid": "d3da673852d29248d81d0efca269f2a130ab6707", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/d3da673852d29248d81d0efca269f2a130ab6707", "committedDate": "2020-02-19T10:08:00Z", "message": "Perform migration before returning a datasource."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81e2a3831cfd5e477db47c0bec1578dfffb6bc2e", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/81e2a3831cfd5e477db47c0bec1578dfffb6bc2e", "committedDate": "2020-03-03T05:26:22Z", "message": "Fix trigger\n\nThere are no gurantees that the \"cached\" statement works. It is best to\ncreate a new statement on every trigger invocation."}, "afterCommit": {"oid": "7016bf1025c7220cee571e61299881acdcdfb002", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/7016bf1025c7220cee571e61299881acdcdfb002", "committedDate": "2020-03-03T05:27:00Z", "message": "Fix trigger\n\nThere are no gurantees that the \"cached\" statement works. It is best to\ncreate a new statement on every trigger invocation."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a111bc7adb934721543d40d080ce0552d352b8ea", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/a111bc7adb934721543d40d080ce0552d352b8ea", "committedDate": "2020-03-04T07:43:55Z", "message": "Remove mariadb references.\n\nThis is a bit more work than I had anticipated."}, "afterCommit": {"oid": "37c27da609c922371c8aa5b9d7f55ec1aaf4132a", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/37c27da609c922371c8aa5b9d7f55ec1aaf4132a", "committedDate": "2020-03-04T07:45:38Z", "message": "Remove mariadb references.\n\nThis is a bit more work than I had anticipated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "37c27da609c922371c8aa5b9d7f55ec1aaf4132a", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/37c27da609c922371c8aa5b9d7f55ec1aaf4132a", "committedDate": "2020-03-04T07:45:38Z", "message": "Remove mariadb references.\n\nThis is a bit more work than I had anticipated."}, "afterCommit": {"oid": "b175e1b4e4cc7491539d138a8de0027e9795ec25", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/b175e1b4e4cc7491539d138a8de0027e9795ec25", "committedDate": "2020-03-04T08:01:17Z", "message": "Remove mariadb references.\n\nThis is a bit more work than I had anticipated."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b175e1b4e4cc7491539d138a8de0027e9795ec25", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/b175e1b4e4cc7491539d138a8de0027e9795ec25", "committedDate": "2020-03-04T08:01:17Z", "message": "Remove mariadb references.\n\nThis is a bit more work than I had anticipated."}, "afterCommit": {"oid": "47eec18af6619c2792ef7aae637ca3a8fb3ddcca", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/47eec18af6619c2792ef7aae637ca3a8fb3ddcca", "committedDate": "2020-03-04T10:38:51Z", "message": "Disable jacoco"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "47eec18af6619c2792ef7aae637ca3a8fb3ddcca", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/47eec18af6619c2792ef7aae637ca3a8fb3ddcca", "committedDate": "2020-03-04T10:38:51Z", "message": "Disable jacoco"}, "afterCommit": {"oid": "c2bfc823194d84ed1bf83863b3961ec13ca540b9", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/c2bfc823194d84ed1bf83863b3961ec13ca540b9", "committedDate": "2020-03-04T11:41:30Z", "message": "Disable jacoco"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2bfc823194d84ed1bf83863b3961ec13ca540b9", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/c2bfc823194d84ed1bf83863b3961ec13ca540b9", "committedDate": "2020-03-04T11:41:30Z", "message": "Disable jacoco"}, "afterCommit": {"oid": "beca5388845d2a0b13a85f4b69e1a64c9969844f", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/beca5388845d2a0b13a85f4b69e1a64c9969844f", "committedDate": "2020-03-05T07:16:20Z", "message": "Disable jacoco"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "beca5388845d2a0b13a85f4b69e1a64c9969844f", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/beca5388845d2a0b13a85f4b69e1a64c9969844f", "committedDate": "2020-03-05T07:16:20Z", "message": "Disable jacoco"}, "afterCommit": {"oid": "c29b89d8615ba4830deac32aca9f1bdc43fcb0d5", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/c29b89d8615ba4830deac32aca9f1bdc43fcb0d5", "committedDate": "2020-03-05T12:33:57Z", "message": "Remove useless system service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c29b89d8615ba4830deac32aca9f1bdc43fcb0d5", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/c29b89d8615ba4830deac32aca9f1bdc43fcb0d5", "committedDate": "2020-03-05T12:33:57Z", "message": "Remove useless system service."}, "afterCommit": {"oid": "3114e13dbdb50b9a9748bf2d88e6835b796e5849", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/3114e13dbdb50b9a9748bf2d88e6835b796e5849", "committedDate": "2020-03-05T13:12:22Z", "message": "Remove useless system service."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3114e13dbdb50b9a9748bf2d88e6835b796e5849", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/3114e13dbdb50b9a9748bf2d88e6835b796e5849", "committedDate": "2020-03-05T13:12:22Z", "message": "Remove useless system service."}, "afterCommit": {"oid": "772f1dc4e941a877775439758a85378151311181", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/772f1dc4e941a877775439758a85378151311181", "committedDate": "2020-03-05T13:57:10Z", "message": "Disable jacoco"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "772f1dc4e941a877775439758a85378151311181", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/772f1dc4e941a877775439758a85378151311181", "committedDate": "2020-03-05T13:57:10Z", "message": "Disable jacoco"}, "afterCommit": {"oid": "0e897348b7432c1166e6cdfa181b70c5d78255ab", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/0e897348b7432c1166e6cdfa181b70c5d78255ab", "committedDate": "2020-03-11T06:44:59Z", "message": "Do not boot up if dbdeploy's `changelog` table is present."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0e897348b7432c1166e6cdfa181b70c5d78255ab", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/0e897348b7432c1166e6cdfa181b70c5d78255ab", "committedDate": "2020-03-11T06:44:59Z", "message": "Do not boot up if dbdeploy's `changelog` table is present."}, "afterCommit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/27b2a9f4d3e93131cdff800460d437cf63b91dec", "committedDate": "2020-05-07T07:51:08Z", "message": "Do not boot up if dbdeploy's `changelog` table is present."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTA5MzQy", "url": "https://github.com/gocd/gocd/pull/7646#pullrequestreview-415909342", "createdAt": "2020-05-21T06:30:39Z", "commit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNjozMDozOVrOGYnv4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwNjozMDozOVrOGYnv4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODQ3MDI0Mw==", "bodyText": "Fix test!", "url": "https://github.com/gocd/gocd/pull/7646#discussion_r428470243", "createdAt": "2020-05-21T06:30:39Z", "author": {"login": "GaneshSPatil"}, "path": "db-support/db-support-base/src/test/java/com/thoughtworks/go/db/ConnectionManagerTest.java", "diffHunk": "@@ -13,8 +13,14 @@\n  * See the License for the specific language governing permissions and\n  * limitations under the License.\n  */\n-package com.thoughtworks.go.server.database;\n \n-public interface Migration {\n-    void migrate();\n+package com.thoughtworks.go.db;\n+\n+import org.junit.jupiter.api.Test;\n+\n+class ConnectionManagerTest {\n+    @Test\n+    void foo() {\n+\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTc2NjA5", "url": "https://github.com/gocd/gocd/pull/7646#pullrequestreview-415976609", "createdAt": "2020-05-21T08:41:56Z", "commit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODo0MTo1NlrOGYq_Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODo0MTo1NlrOGYq_Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyMzM1OQ==", "bodyText": "rename UpdateLastTransitionedTim to UpdateLastTransitionedTime", "url": "https://github.com/gocd/gocd/pull/7646#discussion_r428523359", "createdAt": "2020-05-21T08:41:56Z", "author": {"login": "GaneshSPatil"}, "path": "db-support/db-support-h2/src/main/java/com/thoughtworks/go/server/database/h2/UpdateLastTransitionedTim.java", "diffHunk": "@@ -22,28 +23,24 @@\n import java.sql.SQLException;\n import java.sql.Timestamp;\n \n-/**\n- * @understands\n- */\n-public class Migration_230007 implements Trigger {\n+public class UpdateLastTransitionedTim implements Trigger {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec"}, "originalPosition": 18}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27b2a9f4d3e93131cdff800460d437cf63b91dec", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/27b2a9f4d3e93131cdff800460d437cf63b91dec", "committedDate": "2020-05-07T07:51:08Z", "message": "Do not boot up if dbdeploy's `changelog` table is present."}, "afterCommit": {"oid": "d1616b98690a0077c071815f357a0567192685f5", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/d1616b98690a0077c071815f357a0567192685f5", "committedDate": "2020-05-21T09:41:44Z", "message": "Fail starting up server when postgresqldb.properties exists"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9d1773992e0a31ac09ad8f8754a55a09fe8109f", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/d9d1773992e0a31ac09ad8f8754a55a09fe8109f", "committedDate": "2020-06-05T00:48:32Z", "message": "Add missing indexes"}, "afterCommit": {"oid": "2f45ad614d2e69dc6230cefdf9aa2639f7afdb34", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/2f45ad614d2e69dc6230cefdf9aa2639f7afdb34", "committedDate": "2020-06-05T03:58:04Z", "message": "Add missing indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a064a0887dab24bf67de610c46159234cd013f39", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/a064a0887dab24bf67de610c46159234cd013f39", "committedDate": "2020-06-12T03:38:30Z", "message": "Add support for multiple databases\n\n* Remove h2 deltas and H2 dependency on server module.\n* Package all DB driver modules into the server war.\n* Lazily discover and load backup and query extensions depending on the\n  DB type."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc603d31733e33579df9e655bf98bdbc176c2027", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/fc603d31733e33579df9e655bf98bdbc176c2027", "committedDate": "2020-06-12T03:38:30Z", "message": "Disable jacoco"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cb5748170bdb160ce6ee547b7cdbd721f82dfa1", "author": {"user": {"login": "ketan", "name": "Ketan Padegaonkar"}}, "url": "https://github.com/gocd/gocd/commit/6cb5748170bdb160ce6ee547b7cdbd721f82dfa1", "committedDate": "2020-06-12T03:38:30Z", "message": "Do not boot up if dbdeploy's `changelog` table is present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e7c14e679ef188ad620eebd1fad1c6982e75844", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/2e7c14e679ef188ad620eebd1fad1c6982e75844", "committedDate": "2020-06-12T03:38:30Z", "message": "Remove unused test file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c41cc09870550e3faea43f226089ab8824895429", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/c41cc09870550e3faea43f226089ab8824895429", "committedDate": "2020-06-12T03:38:30Z", "message": "Rename UpdateLastTransitionedTim to UpdateLastTransitionedTime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad8cf8221cdcfdab40cd739a1e53a47cb9d52834", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/ad8cf8221cdcfdab40cd739a1e53a47cb9d52834", "committedDate": "2020-06-12T03:38:30Z", "message": "Fail starting up server when postgresqldb.properties exists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5fad89c55cf9c70ef14c4c57fb4c97a43bd0e64d", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/5fad89c55cf9c70ef14c4c57fb4c97a43bd0e64d", "committedDate": "2020-06-12T03:38:31Z", "message": "Add missing indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a07e8e74c59ccc49f7eec9a8e42681eb43e12f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/35a07e8e74c59ccc49f7eec9a8e42681eb43e12f", "committedDate": "2020-06-12T03:38:31Z", "message": "Postgres does not support the combination of IN and ANY.\n - so updated the postgres query to use = instead of IN. also refactored a bit so that there is only one if case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7e1150932e46bac886c68dc7562262a4ec3e16f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c7e1150932e46bac886c68dc7562262a4ec3e16f", "committedDate": "2020-06-12T03:38:31Z", "message": "correct the version of jar expected to be present"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6c207ecb55f01991bc5f9ff0ba80325941a02b2a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/6c207ecb55f01991bc5f9ff0ba80325941a02b2a", "committedDate": "2020-06-05T07:30:59Z", "message": "correct the version of jar expected to be present"}, "afterCommit": {"oid": "c7e1150932e46bac886c68dc7562262a4ec3e16f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c7e1150932e46bac886c68dc7562262a4ec3e16f", "committedDate": "2020-06-12T03:38:31Z", "message": "correct the version of jar expected to be present"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1993, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}