{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxMzQ4NjM1", "number": 8644, "title": "Delete plugin settings on a successful migration of the plugin settings to cluster profile. (#8643)", "bodyText": "Issue: #8643\nDescription:\n\nDo not delete the plugin settings when the migrate-config call fails.\nDo not delete the plugin settings when the elastic agent plugin implements\nelastic agent extension v4, which relies on plugin settings.\nDelete the plugin settings when the plugin successfully migrates the\nplugin settings to cluster profile and the plugin implements elastic\nagent extension v5 or above, which does not rely on plugin settings.", "createdAt": "2020-10-12T06:42:51Z", "url": "https://github.com/gocd/gocd/pull/8644", "merged": true, "mergeCommit": {"oid": "824af72348c91797d72d73a5614a2e7c191a14e2"}, "closed": true, "closedAt": "2020-10-15T03:06:54Z", "author": {"login": "GaneshSPatil"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdRuKi9AH2gAyNTAxMzQ4NjM1OmY2ZWMwMDQ2NjFjOTI5YzY2NDZlZDY3MTA4M2ExODY5OWE1MDE0MzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdRxW2JgFqTUwNjQ5MjE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f6ec004661c929c6646ed671083a18699a501431", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/f6ec004661c929c6646ed671083a18699a501431", "committedDate": "2020-10-12T06:41:06Z", "message": "Delete plugin settings on a successful migration of the plugin settings to cluster profile. (#8643)\n\n* Do not delete the plugin settings when the migrate-config call fails.\n* Do not delete the plugin settings when the elastic agent plugin implements\n  elastic agent extension v4, which relies on plugin settings.\n* Delete the plugin settings when the plugin successfully migrates the\n  plugin settings to cluster profile and the plugin implements elastic\n  agent extension v5 or above, which does not rely on plugin settings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2Mzk1NjU2", "url": "https://github.com/gocd/gocd/pull/8644#pullrequestreview-506395656", "createdAt": "2020-10-12T08:21:22Z", "commit": {"oid": "f6ec004661c929c6646ed671083a18699a501431"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwODoyMToyMlrOHfz_GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQwODozMTo1MVrOHf0ZVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzExOTY0MQ==", "bodyText": "Done migrating elastic agent configurations for plugin with id: '{}'", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503119641", "createdAt": "2020-10-12T08:21:22Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentInformationMigratorImpl.java", "diffHunk": "@@ -68,12 +73,29 @@ private boolean migrate(GoPluginDescriptor pluginDescriptor) {\n             return true;\n         }\n \n+        LOG.debug(\"Migrating elastic agent information for {} plugin\", pluginId);\n         Plugin plugin = pluginSqlMapDao.findPlugin(pluginId);\n         String pluginConfiguration = plugin.getConfiguration();\n         HashMap<String, String> pluginSettings = (pluginConfiguration == null) ? new HashMap<>() : JsonHelper.fromJson(pluginConfiguration, HashMap.class);\n         ReplaceElasticAgentInformationCommand command = new ReplaceElasticAgentInformationCommand(clusterProfilesService, elasticProfileService, elasticAgentExtension, pluginDescriptor, pluginSettings);\n \n-        return update(command, pluginDescriptor);\n+        boolean updated = update(command, pluginDescriptor);\n+\n+        if (updated) {\n+            LOG.debug(\"Done Migrating elastic agent information for {} plugin\", pluginId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6ec004661c929c6646ed671083a18699a501431"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyMzY3MQ==", "bodyText": "Probably this should be logged as error in the update  method catch block.", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503123671", "createdAt": "2020-10-12T08:27:42Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentInformationMigratorImpl.java", "diffHunk": "@@ -68,12 +73,29 @@ private boolean migrate(GoPluginDescriptor pluginDescriptor) {\n             return true;\n         }\n \n+        LOG.debug(\"Migrating elastic agent information for {} plugin\", pluginId);\n         Plugin plugin = pluginSqlMapDao.findPlugin(pluginId);\n         String pluginConfiguration = plugin.getConfiguration();\n         HashMap<String, String> pluginSettings = (pluginConfiguration == null) ? new HashMap<>() : JsonHelper.fromJson(pluginConfiguration, HashMap.class);\n         ReplaceElasticAgentInformationCommand command = new ReplaceElasticAgentInformationCommand(clusterProfilesService, elasticProfileService, elasticAgentExtension, pluginDescriptor, pluginSettings);\n \n-        return update(command, pluginDescriptor);\n+        boolean updated = update(command, pluginDescriptor);\n+\n+        if (updated) {\n+            LOG.debug(\"Done Migrating elastic agent information for {} plugin\", pluginId);\n+\n+            // all the plugins implementing elastic agent extension v5, does not use plugin settings and hence delete them after successful migration\n+            if (!pluginManager.resolveExtensionVersion(pluginId, ELASTIC_AGENT_EXTENSION, ElasticAgentExtension.SUPPORTED_VERSIONS).equals(ElasticAgentExtensionV4.VERSION)) {\n+                LOG.debug(\"Deleting stale plugin settings for {} plugin, after successful plugin config migration\", pluginId);\n+                pluginSqlMapDao.deletePluginIfExists(pluginId);\n+            } else {\n+                LOG.debug(\"Skip deleting plugin settings for {} plugin, as the plugin implements elastic agent v4 extension which uses plugin settings\", pluginId);\n+            }\n+        } else {\n+            LOG.debug(\"Failed migrating elastic agent information for {} plugin\", pluginId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6ec004661c929c6646ed671083a18699a501431"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzEyNjM1Nw==", "bodyText": "Couldn't we just do sessionFactory.getCurrentSession().delete(plugin);", "url": "https://github.com/gocd/gocd/pull/8644#discussion_r503126357", "createdAt": "2020-10-12T08:31:51Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/dao/PluginSqlMapDao.java", "diffHunk": "@@ -113,4 +113,23 @@ protected void doInTransactionWithoutResult(TransactionStatus status) {\n             }\n         });\n     }\n+\n+    @Override\n+    public void deletePluginIfExists(String pluginId) {\n+        String cacheKey = cacheKeyForPluginSettings(pluginId);\n+        Plugin plugin = this.findPlugin(pluginId);\n+\n+        if (plugin instanceof NullPlugin) {\n+            return;\n+        }\n+\n+        synchronized (cacheKey) {\n+            transactionTemplate.execute((TransactionCallback) transactionStatus -> sessionFactory.getCurrentSession()\n+                    .createQuery(String.format(\"delete from %s where pluginId=:pluginId\", Plugin.class.getSimpleName()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6ec004661c929c6646ed671083a18699a501431"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cb4f9e8725c1cca250516e87ce86b23b766d466", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/4cb4f9e8725c1cca250516e87ce86b23b766d466", "committedDate": "2020-10-12T10:20:48Z", "message": "Fix comments\n\n* Improve debug logs.\n* Print error log under catch block, when the migrate config plugin call fails.\n* Use 'sessionFactory.getCurrentSession().delete' instead of hbl query.\n* Implement double check for the synchronized block."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4d36c420f09e12ddee631099e2f071688f9d8ceb", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/4d36c420f09e12ddee631099e2f071688f9d8ceb", "committedDate": "2020-10-12T10:10:42Z", "message": "Fix comments"}, "afterCommit": {"oid": "4cb4f9e8725c1cca250516e87ce86b23b766d466", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/4cb4f9e8725c1cca250516e87ce86b23b766d466", "committedDate": "2020-10-12T10:20:48Z", "message": "Fix comments\n\n* Improve debug logs.\n* Print error log under catch block, when the migrate config plugin call fails.\n* Use 'sessionFactory.getCurrentSession().delete' instead of hbl query.\n* Implement double check for the synchronized block."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA2NDkyMTYw", "url": "https://github.com/gocd/gocd/pull/8644#pullrequestreview-506492160", "createdAt": "2020-10-12T10:24:15Z", "commit": {"oid": "4cb4f9e8725c1cca250516e87ce86b23b766d466"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1797, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}