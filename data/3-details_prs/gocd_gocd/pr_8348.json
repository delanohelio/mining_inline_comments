{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNzk2OTQw", "number": 8348, "title": "Added few internal materials API", "bodyText": "Issue: #8331\nDescription:\n\nadded the usages API for a given fingerprint\nadded call to showcase materials with their latest modifications (would not contain dependency materials as per this comment )", "createdAt": "2020-07-17T05:35:28Z", "url": "https://github.com/gocd/gocd/pull/8348", "merged": true, "mergeCommit": {"oid": "8ed7b2386727d3115bf125a63b72ea994029b389"}, "closed": true, "closedAt": "2020-08-05T04:22:23Z", "author": {"login": "kritika-singh3"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1tF_CAFqTQ1MDM4MzkxNw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7y68bgBqjM2MjI4Nzg4MzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwMzgzOTE3", "url": "https://github.com/gocd/gocd/pull/8348#pullrequestreview-450383917", "createdAt": "2020-07-17T05:36:19Z", "commit": {"oid": "c8e629234e4296a7f75c87673dd10fbe4ad79f79"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozNjoxOVrOGzF83A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwNTozNjoxOVrOGzF83A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjIyODA2MA==", "bodyText": "If this can be improved, please let me know.", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r456228060", "createdAt": "2020-07-17T05:36:19Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/resources/com/thoughtworks/go/server/dao/maps/Material.xml", "diffHunk": "@@ -0,0 +1,167 @@\n+<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n+<!--\n+  ~ Copyright 2020 ThoughtWorks, Inc.\n+  ~\n+  ~ Licensed under the Apache License, Version 2.0 (the \"License\");\n+  ~ you may not use this file except in compliance with the License.\n+  ~ You may obtain a copy of the License at\n+  ~\n+  ~     http://www.apache.org/licenses/LICENSE-2.0\n+  ~\n+  ~ Unless required by applicable law or agreed to in writing, software\n+  ~ distributed under the License is distributed on an \"AS IS\" BASIS,\n+  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+  ~ See the License for the specific language governing permissions and\n+  ~ limitations under the License.\n+  -->\n+<!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\">\n+<mapper namespace=\"Material\">\n+  <resultMap id=\"hg-material-map\" type=\"com.thoughtworks.go.domain.materials.mercurial.HgMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"url\" property=\"url\"/>\n+    <result column=\"username\" property=\"username\"/>\n+    <result column=\"branch\" property=\"branch\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"svn-material-map\" type=\"com.thoughtworks.go.domain.materials.svn.SvnMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"url\" property=\"url\"/>\n+    <result column=\"checkExternals\" property=\"checkExternals\"/>\n+    <result column=\"username\" property=\"username\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"git-material-map\" type=\"com.thoughtworks.go.domain.materials.git.GitMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"url\" property=\"url\"/>\n+    <result column=\"username\" property=\"username\"/>\n+    <result column=\"branch\" property=\"branch\"/>\n+    <result column=\"submoduleFolder\" property=\"submoduleFolder\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"p4-material-map\" type=\"com.thoughtworks.go.domain.materials.perforce.P4MaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"username\" property=\"username\"/>\n+    <result column=\"url\" property=\"url\"/>\n+    <result column=\"view\" property=\"view\"/>\n+    <result column=\"useTickets\" property=\"useTickets\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"dependency-material-map\"\n+             type=\"com.thoughtworks.go.domain.materials.dependency.DependencyMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"pipelineName\" property=\"pipelineName\"/>\n+    <result column=\"stageName\" property=\"stageName\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"tfs-material-map\" type=\"com.thoughtworks.go.domain.materials.tfs.TfsMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"url\" property=\"url\"/>\n+    <result column=\"username\" property=\"username\"/>\n+    <result column=\"projectPath\" property=\"projectPath\"/>\n+    <result column=\"domain\" property=\"domain\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"testing-material-map\" type=\"com.thoughtworks.go.domain.materials.TestingMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"url\" property=\"url\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"package-material-map\"\n+             type=\"com.thoughtworks.go.domain.materials.packagematerial.PackageMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"configuration\" property=\"configuration\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"plugin-material-map\" type=\"com.thoughtworks.go.domain.materials.scm.PluggableSCMMaterialInstance\">\n+    <result column=\"flyweightName\" property=\"flyweightName\"/>\n+    <result column=\"fingerprint\" property=\"fingerprint\"/>\n+    <result column=\"additionaldata\" property=\"additionalData\"/>\n+    <result column=\"configuration\" property=\"configuration\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"modification-map\" type=\"com.thoughtworks.go.domain.materials.Modification\">\n+    <id column=\"mod_id\"/>\n+    <result column=\"mod_revision\" property=\"revision\"/>\n+    <result column=\"mod_comment\" property=\"comment\"/>\n+    <result column=\"mod_emailaddress\" property=\"emailAddress\"/>\n+    <result column=\"mod_modifiedtime\" property=\"modifiedTime\" javaType=\"date\" jdbcType=\"TIMESTAMP\"/>\n+    <result column=\"mod_username\" property=\"userName\"/>\n+    <result column=\"mod_pipelinelabel\" property=\"pipelineLabel\"/>\n+    <result column=\"mod_pipelineid\" property=\"pipelineId\" jdbcType=\"BIGINT\"/>\n+    <result column=\"mod_additionaldata\" property=\"additionalData\"/>\n+    <collection property=\"materialInstance\" resultMap=\"material-instance-map\"/>\n+  </resultMap>\n+\n+  <resultMap id=\"material-instance-map\" type=\"com.thoughtworks.go.domain.MaterialInstance\">\n+    <id column=\"id\"/>\n+    <discriminator javaType=\"java.lang.String\" column=\"type\">\n+      <case value=\"HgMaterial\" resultMap=\"hg-material-map\"/>\n+      <case value=\"SvnMaterial\" resultMap=\"svn-material-map\"/>\n+      <case value=\"GitMaterial\" resultMap=\"git-material-map\"/>\n+      <case value=\"P4Material\" resultMap=\"p4-material-map\"/>\n+      <case value=\"DependencyMaterial\" resultMap=\"dependency-material-map\"/>\n+      <case value=\"TfsMaterial\" resultMap=\"tfs-material-map\"/>\n+      <case value=\"TestingMaterial\" resultMap=\"testing-material-map\"/>\n+      <case value=\"PackageMaterialInstance\" resultMap=\"package-material-map\"/>\n+      <case value=\"PluggableSCMMaterialInstance\" resultMap=\"plugin-material-map\"/>\n+    </discriminator>\n+  </resultMap>\n+\n+  <select id=\"materialWithModifications\" resultMap=\"modification-map\">\n+    SELECT materials.id                AS id\n+         , materials.type\n+         , materials.url\n+         , materials.username\n+         , materials.checkexternals\n+         , materials.pipelinename\n+         , materials.stagename\n+         , materials.view\n+         , materials.branch\n+         , materials.submodulefolder\n+         , materials.usetickets\n+         , materials.fingerprint\n+         , materials.flyweightName\n+         , materials.projectpath\n+         , materials.domain\n+         , materials.configuration\n+         , materials.additionaldata\n+\n+         , modification.id             AS mod_id\n+         , modification.username       AS mod_username\n+         , modification.comment        AS mod_comment\n+         , modification.emailaddress   AS mod_emailaddress\n+         , modification.revision       AS mod_revision\n+         , modification.modifiedtime   AS mod_modifiedtime\n+         , modification.fromexternal   AS mod_fromexternal\n+         , modification.pipelinelabel  AS mod_pipelinelabel\n+         , modification.pipelineid     AS mod_pipelineid\n+         , modification.additionaldata AS mod_additionaldata\n+    FROM materials\n+           INNER JOIN\n+         (\n+           SELECT *\n+           FROM (\n+                  SELECT ROW_NUMBER() OVER (PARTITION BY materialid ORDER BY id DESC) AS row_num, *\n+                  FROM modifications\n+                  ORDER BY materialid, row_num\n+                ) mod\n+           WHERE mod.row_num &lt;= #{count}\n+         ) modification ON modification.materialid = materials.id\n+  </select>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c8e629234e4296a7f75c87673dd10fbe4ad79f79"}, "originalPosition": 166}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c8e629234e4296a7f75c87673dd10fbe4ad79f79", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c8e629234e4296a7f75c87673dd10fbe4ad79f79", "committedDate": "2020-07-17T05:33:57Z", "message": "Added representers and tests"}, "afterCommit": {"oid": "e5d05feb6706d3167f602492f06e2b4ac73be4ae", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/e5d05feb6706d3167f602492f06e2b4ac73be4ae", "committedDate": "2020-07-20T07:58:10Z", "message": "Added representers and tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5d05feb6706d3167f602492f06e2b4ac73be4ae", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/e5d05feb6706d3167f602492f06e2b4ac73be4ae", "committedDate": "2020-07-20T07:58:10Z", "message": "Added representers and tests"}, "afterCommit": {"oid": "72ff37c6d789ddcc8a46fc94e49c351153adfc2b", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/72ff37c6d789ddcc8a46fc94e49c351153adfc2b", "committedDate": "2020-07-20T09:40:15Z", "message": "Added representers and tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed1989caa53a372d252a45d864edc2b19e087cea", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/ed1989caa53a372d252a45d864edc2b19e087cea", "committedDate": "2020-07-20T12:26:17Z", "message": "Add auto_update to Package and SCM representers"}, "afterCommit": {"oid": "115041b0fe2dd2b39ed9b4b87c1d9fac74ca058a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/115041b0fe2dd2b39ed9b4b87c1d9fac74ca058a", "committedDate": "2020-07-22T06:36:39Z", "message": "Add auto_update to Package and SCM representers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "115041b0fe2dd2b39ed9b4b87c1d9fac74ca058a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/115041b0fe2dd2b39ed9b4b87c1d9fac74ca058a", "committedDate": "2020-07-22T06:36:39Z", "message": "Add auto_update to Package and SCM representers"}, "afterCommit": {"oid": "281b23f63aeb7f3dc0722cde711ee82bd6d96869", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/281b23f63aeb7f3dc0722cde711ee82bd6d96869", "committedDate": "2020-07-29T10:51:42Z", "message": "Add auto_update to Package and SCM representers"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "281b23f63aeb7f3dc0722cde711ee82bd6d96869", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/281b23f63aeb7f3dc0722cde711ee82bd6d96869", "committedDate": "2020-07-29T10:51:42Z", "message": "Add auto_update to Package and SCM representers"}, "afterCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/26a6c6a9920b9da5255083b6feca79aae4aeea5f", "committedDate": "2020-07-30T06:08:36Z", "message": "In a bid to move away from ibatis - migrated the sql to use hibernate to fetch the details\n - modified the query\n - moved the test - they passed without any changes required"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NzY1NDMw", "url": "https://github.com/gocd/gocd/pull/8348#pullrequestreview-458765430", "createdAt": "2020-07-30T21:21:26Z", "commit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMToyMToyN1rOG50RCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMTozNjo1M1rOG50tGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3ODM0Ng==", "bodyText": "Probably rename to getLatestModificationForEachMaterial() ?", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r463278346", "createdAt": "2020-07-30T21:21:27Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/persistence/MaterialRepository.java", "diffHunk": "@@ -1025,4 +1025,19 @@ public File folderFor(Material material) {\n         MaterialInstance materialInstance = this.findOrCreateFrom(material);\n         return new File(new File(\"pipelines\", \"flyweight\"), materialInstance.getFlyweightName());\n     }\n+\n+    public List<Modification> getModificationWithMaterial() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3OTI2MQ==", "bodyText": "We should run this query on larger database and check the performance, also run EXPLAIN ANALYZE on PostgreSQL", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r463279261", "createdAt": "2020-07-30T21:23:26Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/persistence/MaterialRepository.java", "diffHunk": "@@ -1025,4 +1025,19 @@ public File folderFor(Material material) {\n         MaterialInstance materialInstance = this.findOrCreateFrom(material);\n         return new File(new File(\"pipelines\", \"flyweight\"), materialInstance.getFlyweightName());\n     }\n+\n+    public List<Modification> getModificationWithMaterial() {\n+        String queryString = \"SELECT mods.* \" +\n+                \"FROM (\" +\n+                \"   SELECT MAX(id) OVER (PARTITION BY materialid) as max_id, * \" +\n+                \"   FROM modifications \" +\n+                \") mods \" +\n+                \"JOIN materials m ON mods.materialid=m.id \" +\n+                \"WHERE mods.id=mods.max_id;\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI3OTc3Nw==", "bodyText": "Rename method as earlier comment?", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r463279777", "createdAt": "2020-07-30T21:24:30Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/MaterialService.java", "diffHunk": "@@ -160,4 +160,16 @@ private void resolveSecretParams(Material material) {\n     Class<? extends Material> getMaterialClass(Material material) {\n         return material.getClass();\n     }\n+\n+    public Map<String, Modification> getModificationWithMaterial() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4MTk1OQ==", "bodyText": "Why do we need to create a new Modification object and set a null MaterialInstance?", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r463281959", "createdAt": "2020-07-30T21:29:08Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/MaterialService.java", "diffHunk": "@@ -160,4 +160,16 @@ private void resolveSecretParams(Material material) {\n     Class<? extends Material> getMaterialClass(Material material) {\n         return material.getClass();\n     }\n+\n+    public Map<String, Modification> getModificationWithMaterial() {\n+        List<Modification> modifications = materialRepository.getModificationWithMaterial();\n+        Map<String, Modification> materialAndModifications = new HashMap<>();\n+        modifications.forEach((mod) -> {\n+            String fingerprint = mod.getMaterialInstance().getFingerprint();\n+            Modification modification = new Modification(mod);\n+            modification.setMaterialInstance(null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI4NTUyOA==", "bodyText": "Since we testing the behavior of fetching the latest modification, our setup should ensure that we have more than 1 modification for a material.", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r463285528", "createdAt": "2020-07-30T21:36:53Z", "author": {"login": "maheshp"}, "path": "server/src/test-integration/java/com/thoughtworks/go/server/persistence/MaterialRepositoryIntegrationTest.java", "diffHunk": "@@ -1316,6 +1320,162 @@ public Object doInTransaction(TransactionStatus status) {\n         assertThat(repo.getTotalModificationsFor(materialInstance), is(new Long(count + 1)));\n     }\n \n+    @Test\n+    public void shouldFetchModificationsWithMaterial() {\n+        MaterialRevisions materialRevisions = new MaterialRevisions();\n+        SvnMaterial material = MaterialsMother.svnMaterial(\"http://username:password@localhost\");\n+        List<Modification> modificationList = getModifications(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f"}, "originalPosition": 27}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "26a6c6a9920b9da5255083b6feca79aae4aeea5f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/26a6c6a9920b9da5255083b6feca79aae4aeea5f", "committedDate": "2020-07-30T06:08:36Z", "message": "In a bid to move away from ibatis - migrated the sql to use hibernate to fetch the details\n - modified the query\n - moved the test - they passed without any changes required"}, "afterCommit": {"oid": "d648bf42cb17ebe997a35602f0eb655b239b1a8a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d648bf42cb17ebe997a35602f0eb655b239b1a8a", "committedDate": "2020-07-31T04:14:46Z", "message": "Changes:\n - renamed the methods in service and repository\n - updated the tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d648bf42cb17ebe997a35602f0eb655b239b1a8a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d648bf42cb17ebe997a35602f0eb655b239b1a8a", "committedDate": "2020-07-31T04:14:46Z", "message": "Changes:\n - renamed the methods in service and repository\n - updated the tests"}, "afterCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/653913966756d1f8b73fb93d8d2d925dda82de5f", "committedDate": "2020-08-04T03:19:20Z", "message": "Changes:\n - renamed the methods in service and repository\n - updated the tests\n - used stream() to convert list to hash in material service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTczMzE1", "url": "https://github.com/gocd/gocd/pull/8348#pullrequestreview-460973315", "createdAt": "2020-08-04T16:23:45Z", "commit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNjoyMzo0NVrOG7n-4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNjo1MToxN1rOG7pA0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE3NDI0MQ==", "bodyText": "@kritika-singh3 I am just wondering if we need to serialize all the attributes for a material. Since this API is used only on the Materials SPA should we consider serializing only the required attributes.", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r465174241", "createdAt": "2020-08-04T16:23:45Z", "author": {"login": "maheshp"}, "path": "api/api-internal-materials-v1/src/main/java/com/thoughtworks/go/apiv1/internalmaterials/representers/materials/ScmMaterialRepresenter.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+package com.thoughtworks.go.apiv1.internalmaterials.representers.materials;\n+\n+import com.thoughtworks.go.api.base.OutputWriter;\n+import com.thoughtworks.go.config.materials.ScmMaterialConfig;\n+import com.thoughtworks.go.config.materials.perforce.P4MaterialConfig;\n+\n+import java.util.function.Consumer;\n+\n+public abstract class ScmMaterialRepresenter<T extends ScmMaterialConfig> implements MaterialRepresenter<T> {\n+    @Override\n+    public Consumer<OutputWriter> toJSON(T scmMaterialConfig) {\n+        return jsonWriter -> {\n+            if (!(scmMaterialConfig instanceof P4MaterialConfig)) {\n+                jsonWriter.add(\"url\", scmMaterialConfig.getUrl());\n+            }\n+            jsonWriter.add(\"destination\", scmMaterialConfig.getFolder());\n+\n+            if (scmMaterialConfig.filter().isEmpty()) {\n+                jsonWriter.renderNull(\"filter\");\n+            } else {\n+                jsonWriter.addChild(\"filter\", FilterRepresenter.toJSON(scmMaterialConfig.filter()));\n+            }\n+            jsonWriter.add(\"invert_filter\", scmMaterialConfig.isInvertFilter());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4OTc3MQ==", "bodyText": "Do we need these changes now?", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r465189771", "createdAt": "2020-08-04T16:49:10Z", "author": {"login": "maheshp"}, "path": "domain/src/main/java/com/thoughtworks/go/domain/materials/Modification.java", "diffHunk": "@@ -413,4 +413,9 @@ public static Revision oldestRevision(Modifications modifications) {\n     public String getAdditionalData() {\n         return additionalData;\n     }\n+\n+    // used in ibatis\n+    public void setPipelineId(Long pipelineId) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE4OTgxMQ==", "bodyText": "Do we need these changes now?", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r465189811", "createdAt": "2020-08-04T16:49:14Z", "author": {"login": "maheshp"}, "path": "domain/src/main/java/com/thoughtworks/go/domain/MaterialInstance.java", "diffHunk": "@@ -151,4 +151,20 @@ public String getUrl() {\n     public String getUsername() {\n         return username;\n     }\n+\n+    public String getView() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTE5MTEyMA==", "bodyText": "Can we have this under a separate class since its a different set of endpoints.", "url": "https://github.com/gocd/gocd/pull/8348#discussion_r465191120", "createdAt": "2020-08-04T16:51:17Z", "author": {"login": "maheshp"}, "path": "spark/spark-base/src/main/java/com/thoughtworks/go/spark/Routes.java", "diffHunk": "@@ -157,8 +157,14 @@ public static String name(String name) {\n \n     public static class MaterialConfig {\n         public static final String BASE = \"/api/config/materials\";\n+        public static final String INTERNAL_BASE = \"/api/internal/materials\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5517740adc8cdb8f25c593a68312ee88acb2a5c", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/a5517740adc8cdb8f25c593a68312ee88acb2a5c", "committedDate": "2020-08-05T03:28:04Z", "message": "Initial commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0cf64ded2d5ec39cca461d7eebfeca1028cba9a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d0cf64ded2d5ec39cca461d7eebfeca1028cba9a", "committedDate": "2020-08-05T03:28:05Z", "message": "Add usages API for a given fingerprint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54c012f53c9211d014e798c7ba7b255e7638ff8c", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/54c012f53c9211d014e798c7ba7b255e7638ff8c", "committedDate": "2020-08-05T03:28:05Z", "message": "Added a sql query which will fetch the materials with their latest {count} modifications  - this will be used on materials spa to showcase latest commit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b3338c42a1523b0c9b14d1add20028fd3d6796d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/8b3338c42a1523b0c9b14d1add20028fd3d6796d", "committedDate": "2020-08-05T03:28:05Z", "message": "Added representers and tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39e4c31346fcadea1358cbf971cb71310439f43f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/39e4c31346fcadea1358cbf971cb71310439f43f", "committedDate": "2020-08-05T03:28:05Z", "message": "Return an object instead of list\n - since we are only concerned with the latest modification, sending a list does not make sense. Hence, we are sending only an object. In case there are no modifications, render it as null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58af81e11d5af8e8e0f8f67496803f4a98975d7f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/58af81e11d5af8e8e0f8f67496803f4a98975d7f", "committedDate": "2020-08-05T03:28:05Z", "message": "Add auto_update to Package and SCM representers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd3586259092e4f85eee6069abc60882abce9d7d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/dd3586259092e4f85eee6069abc60882abce9d7d", "committedDate": "2020-08-05T03:28:05Z", "message": "In a bid to move away from ibatis - migrated the sql to use hibernate to fetch the details\n - modified the query\n - moved the test - they passed without any changes required"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed2458699f7f8cab3a6fccd0c7c69e6c127d9a0", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/6ed2458699f7f8cab3a6fccd0c7c69e6c127d9a0", "committedDate": "2020-08-05T03:28:06Z", "message": "Changes:\n - renamed the methods in service and repository\n - updated the tests\n - used stream() to convert list to hash in material service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1d6a257c797cd7e0a8c5adfa1a239f7a056eda5", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d1d6a257c797cd7e0a8c5adfa1a239f7a056eda5", "committedDate": "2020-08-05T03:45:58Z", "message": "Changes:\n - removed unnecessary material attributes.\n - also removed the error mapping - will add as needed\n - moved the routes into a separate inner class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "653913966756d1f8b73fb93d8d2d925dda82de5f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/653913966756d1f8b73fb93d8d2d925dda82de5f", "committedDate": "2020-08-04T03:19:20Z", "message": "Changes:\n - renamed the methods in service and repository\n - updated the tests\n - used stream() to convert list to hash in material service"}, "afterCommit": {"oid": "d1d6a257c797cd7e0a8c5adfa1a239f7a056eda5", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/d1d6a257c797cd7e0a8c5adfa1a239f7a056eda5", "committedDate": "2020-08-05T03:45:58Z", "message": "Changes:\n - removed unnecessary material attributes.\n - also removed the error mapping - will add as needed\n - moved the routes into a separate inner class"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1877, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}