{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzE3MTg1", "number": 8592, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNTo1NzowNlrOEpUxmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozMTozMlrOEwF26A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzY3NDQ5OnYy", "diffSide": "RIGHT", "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/config/Configuration.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNTo1NzowNlrOHa7eQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoxNzozN1rOHa_cng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk5OTQyNQ==", "bodyText": "Will there be case wherein we want to add secure fields and not resolve them?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r497999425", "createdAt": "2020-10-01T05:57:06Z", "author": {"login": "maheshp"}, "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/config/Configuration.java", "diffHunk": "@@ -158,10 +159,23 @@ public void addError(String fieldName, String message) {\n     }\n \n     public Map<String, String> getConfigurationAsMap(boolean addSecureFields) {\n+        return getConfigurationAsMap(addSecureFields, false);\n+    }\n+\n+\n+    /**\n+     * Returns the configuration values a map of key-value pair\n+     * @param addSecureFields should add secure fields\n+     * @param useResolvedValue should try to resolve any secret params found.\n+     * @throws UnresolvedSecretParamException if useResolvedValue is set to true and the secrets are not resolved\n+     * @return map of configs\n+     */\n+    public Map<String, String> getConfigurationAsMap(boolean addSecureFields, boolean useResolvedValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b09e0d6d4e9d27bb240fcd847ab906262bab330"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2NDU0Mg==", "bodyText": "Yes. When we are calling the plugins which does not support secrets as of yet.\nE.g. authorization, artifact.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498064542", "createdAt": "2020-10-01T08:17:37Z", "author": {"login": "kritika-singh3"}, "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/config/Configuration.java", "diffHunk": "@@ -158,10 +159,23 @@ public void addError(String fieldName, String message) {\n     }\n \n     public Map<String, String> getConfigurationAsMap(boolean addSecureFields) {\n+        return getConfigurationAsMap(addSecureFields, false);\n+    }\n+\n+\n+    /**\n+     * Returns the configuration values a map of key-value pair\n+     * @param addSecureFields should add secure fields\n+     * @param useResolvedValue should try to resolve any secret params found.\n+     * @throws UnresolvedSecretParamException if useResolvedValue is set to true and the secrets are not resolved\n+     * @return map of configs\n+     */\n+    public Map<String, String> getConfigurationAsMap(boolean addSecureFields, boolean useResolvedValue) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk5OTQyNQ=="}, "originalCommit": {"oid": "7b09e0d6d4e9d27bb240fcd847ab906262bab330"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzcyNDE1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNjoxOTozOFrOHa76-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODozODozOVrOHbAPgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwNjc3Ng==", "bodyText": "If secrets resolution for one of the cluster profile fails, the plugin would not get a ping for any of the clusters.\nHow do we notify users in cases of secret resolution failures?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498006776", "createdAt": "2020-10-01T06:19:38Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -134,14 +139,15 @@ public void heartbeat() {\n \n         for (PluginDescriptor descriptor : elasticAgentPluginRegistry.getPlugins()) {\n             List<ClusterProfile> clusterProfiles = clusterProfilesService.getPluginProfiles().findByPluginId(descriptor.id());\n+            resolveSecrets(clusterProfiles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA3NzU3MA==", "bodyText": "If secret resolution fails for any cluster profiles, the server ping call will not go for the remaining of the clusters. Also, we will not be able to notify the users about the agents for which the plugin has been deleted.\nWhile the error gets logged in server logs, do you think we should catch them nd display a server health message?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498077570", "createdAt": "2020-10-01T08:38:39Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -134,14 +139,15 @@ public void heartbeat() {\n \n         for (PluginDescriptor descriptor : elasticAgentPluginRegistry.getPlugins()) {\n             List<ClusterProfile> clusterProfiles = clusterProfilesService.getPluginProfiles().findByPluginId(descriptor.id());\n+            resolveSecrets(clusterProfiles);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwNjc3Ng=="}, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzczNjc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNjoyNDo0N1rOHa8CIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODoyNjowN1rOHa_w6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwODYwOA==", "bodyText": "In what cases would the clusterProfile be null, I am guessing for the Azure plugin. Can you please check?\nReturning false in these conditions might break things?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498008608", "createdAt": "2020-10-01T06:24:47Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA2OTczOQ==", "bodyText": "Yes, in case the GoCD server was upgraded and their were few scheduled jobs which now won't have a cluster profile.\nNo it would not. The check was preset earlier as well. Also, we do a job reload based on timer, which checks for the above scenario and cancels the job with a message. Hence, sending false won't break things.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498069739", "createdAt": "2020-10-01T08:26:07Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwODYwOA=="}, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 107}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzc0NTA4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNjoyODoxNVrOHa8HEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo1MTowOVrOHbAtUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwOTg3Mw==", "bodyText": "What happens when secret resolution fails and what should we do on failure?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498009873", "createdAt": "2020-10-01T06:28:15Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n             return false;\n         }\n \n+        resolveSecrets(clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4NTIwMw==", "bodyText": "The shouldAssignWork is called when a elastic agent registers with GoCD. In case, secret resolution fails, the agent will not be assigned any job nd will remain idle.\nWe can catch them nd ignore it.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498085203", "createdAt": "2020-10-01T08:51:09Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n             return false;\n         }\n \n+        resolveSecrets(clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwOTg3Mw=="}, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 111}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExNzc1NzgzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNjozMzozNFrOHa8OqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwODo1MzoyMlrOHbAygQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAxMTgxNg==", "bodyText": "How do we handle secret resolution failures?\nWe are removing the job from jobCreationTimeMap before secrets are resolved. Will there be any repercussions of secret resolution failures after removing it from the map.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498011816", "createdAt": "2020-10-01T06:33:34Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -311,9 +330,25 @@ public void jobCompleted(JobInstance job) {\n \n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-\n+        secretParamResolver.resolve(elasticProfile);\n+        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+        Map<String, String> clusterProfileConfiguration = emptyMap();\n+        if (clusterProfile != null) {\n+            secretParamResolver.resolve(clusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 168}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODA4NjUyOQ==", "bodyText": "This is called when a job gets completed. Secret resolution failure would mean that the plugin is not notified nd hence will not be able to delete the job. Also, the job plan related information in DB is also not deleted.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498086529", "createdAt": "2020-10-01T08:53:22Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -311,9 +330,25 @@ public void jobCompleted(JobInstance job) {\n \n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-\n+        secretParamResolver.resolve(elasticProfile);\n+        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+        Map<String, String> clusterProfileConfiguration = emptyMap();\n+        if (clusterProfile != null) {\n+            secretParamResolver.resolve(clusterProfile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAxMTgxNg=="}, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDA2MTkzOnYy", "diffSide": "RIGHT", "path": "api/api-secret-configs-v3/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowNjoyMVrOHePMeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowNjoyMVrOHePMeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODI4MQ==", "bodyText": "Change compile to implementation", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501468281", "createdAt": "2020-10-08T06:06:21Z", "author": {"login": "maheshp"}, "path": "api/api-secret-configs-v3/build.gradle", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2019 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: 'groovy'\n+\n+dependencies {\n+  compile project(':api:api-base')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDA2MjcyOnYy", "diffSide": "RIGHT", "path": "api/api-secret-configs-v3/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowNjozOVrOHePM4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowNjozOVrOHePM4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODM4Ng==", "bodyText": "Change testCompile to testImplementation", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501468386", "createdAt": "2020-10-08T06:06:39Z", "author": {"login": "maheshp"}, "path": "api/api-secret-configs-v3/build.gradle", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2019 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: 'groovy'\n+\n+dependencies {\n+  compile project(':api:api-base')\n+\n+  testCompile project(path: ':api:api-base', configuration: 'testOutput')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDA5ODAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjoyMToxOVrOHePhZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjoyMToxOVrOHePhZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MzYzNw==", "bodyText": "As discussed we need to add a server health message if secret resolution fails and log it as well.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501473637", "createdAt": "2020-10-08T06:21:19Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "diffHunk": "@@ -22,47 +22,59 @@\n import com.thoughtworks.go.listener.ConfigChangedListener;\n import com.thoughtworks.go.listener.EntityConfigChangedListener;\n import com.thoughtworks.go.plugin.access.elastic.ElasticAgentPluginRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import java.util.Map;\n+\n @Component\n public class ClusterProfilesChangedPluginNotifier extends EntityConfigChangedListener<ClusterProfile> implements ConfigChangedListener {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClusterProfilesChangedPluginNotifier.class);\n     private ClusterProfiles existingClusterProfiles;\n     private ElasticAgentPluginRegistry registry;\n+    private final SecretParamResolver secretParamResolver;\n     private GoConfigService goConfigService;\n \n     @Autowired\n-    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry) {\n+    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry, SecretParamResolver secretParamResolver) {\n         this.goConfigService = goConfigService;\n         this.existingClusterProfiles = goConfigService.getElasticConfig().getClusterProfiles();\n         this.registry = registry;\n+        this.secretParamResolver = secretParamResolver;\n         goConfigService.register(this);\n     }\n \n     @Override\n     public void onEntityConfigChange(ClusterProfile updatedClusterProfile) {\n+        LOGGER.debug(\"Resolving the updated cluster profile {} for secrets\", updatedClusterProfile);\n+        secretParamResolver.resolve(updatedClusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDEwMjE2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjoyMjo1OVrOHePjzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjoyMjo1OVrOHePjzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3NDI1Mg==", "bodyText": "Resolving secrets for updated cluster profile: {}", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501474252", "createdAt": "2020-10-08T06:22:59Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "diffHunk": "@@ -22,47 +22,59 @@\n import com.thoughtworks.go.listener.ConfigChangedListener;\n import com.thoughtworks.go.listener.EntityConfigChangedListener;\n import com.thoughtworks.go.plugin.access.elastic.ElasticAgentPluginRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import java.util.Map;\n+\n @Component\n public class ClusterProfilesChangedPluginNotifier extends EntityConfigChangedListener<ClusterProfile> implements ConfigChangedListener {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClusterProfilesChangedPluginNotifier.class);\n     private ClusterProfiles existingClusterProfiles;\n     private ElasticAgentPluginRegistry registry;\n+    private final SecretParamResolver secretParamResolver;\n     private GoConfigService goConfigService;\n \n     @Autowired\n-    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry) {\n+    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry, SecretParamResolver secretParamResolver) {\n         this.goConfigService = goConfigService;\n         this.existingClusterProfiles = goConfigService.getElasticConfig().getClusterProfiles();\n         this.registry = registry;\n+        this.secretParamResolver = secretParamResolver;\n         goConfigService.register(this);\n     }\n \n     @Override\n     public void onEntityConfigChange(ClusterProfile updatedClusterProfile) {\n+        LOGGER.debug(\"Resolving the updated cluster profile {} for secrets\", updatedClusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDE1NDQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjo0MzowNFrOHeQCxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODoxMDo0MVrOHeS1pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MjE4Mg==", "bodyText": "Guess we need to fail the job, not cancel. We fail in case of BuildAssignmentService as well.\nThe message needs to be update appropriately.\nYou will also need to add a message on the JobStatusTopic so that the JobStatusListener is called.\nAlso, I think the resolveSecrets methods should only resolve the secrets and not handle the errors. Let the callers handle exception and take necessary actions.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501482182", "createdAt": "2020-10-08T06:43:04Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -308,12 +323,73 @@ public void jobCompleted(JobInstance job) {\n \n         String pluginId = agentInstance.elasticAgentMetadata().elasticPluginId();\n         String elasticAgentId = agentInstance.elasticAgentMetadata().elasticAgentId();\n-\n+        JobIdentifier jobIdentifier = job.getIdentifier();\n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n+        try {\n+            secretParamResolver.resolve(elasticProfile);\n+            Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+            Map<String, String> clusterProfileConfiguration = emptyMap();\n+            if (clusterProfile != null) {\n+                secretParamResolver.resolve(clusterProfile);\n+                clusterProfileConfiguration = clusterProfile.getConfigurationAsMap(true, true);\n+            }\n+            elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, jobIdentifier, elasticProfileConfiguration, clusterProfileConfiguration);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"The job completion call to the plugin for the job identifier [%s] failed for secrets resolution: %s \", jobIdentifier.toString(), e.getMessage());\n+            ServerHealthState healthState = error(\"Failed to notify plugin\", description, general(scopeForJob(jobIdentifier)));\n+            healthState.setTimeout(Timeout.FIVE_MINUTES);\n+            serverHealthService.update(healthState);\n+            LOGGER.error(description);\n+        }\n+    }\n+\n+    private void logToJobConsole(JobIdentifier identifier, String message) {\n+        try {\n+            consoleService.appendToConsoleLog(identifier, message);\n+        } catch (IllegalArtifactLocationException | IOException e) {\n+            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n+        }\n+    }\n+\n+    private Predicate<JobPlan> isElasticAgent() {\n+        return JobPlan::requiresElasticAgent;\n+    }\n+\n+    private HealthStateScope scope(String pluginId) {\n+        return HealthStateScope.aboutPlugin(pluginId, \"missingPlugin\");\n+    }\n+\n+    @NotNull\n+    private HealthStateScope scopeForJob(JobIdentifier jobIdentifier) {\n+        return forJob(jobIdentifier.getPipelineName(), jobIdentifier.getStageName(), jobIdentifier.getBuildName());\n+    }\n+\n+    private boolean resolveSecrets(String pluginId, List<ClusterProfile> clusterProfiles) {\n+        try {\n+            for (ClusterProfile clusterProfile : clusterProfiles) {\n+                secretParamResolver.resolve(clusterProfile);\n+            }\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"Secrets resolution failed for cluster profile associated with plugin [%s]: %s \", pluginId, e.getMessage());\n+            serverHealthService.update(error(format(\"Ping failed for '%s' plugin\", pluginId), description, general(scope(pluginId))));\n+            LOGGER.error(description);\n+            return false;\n+        }\n+        return true;\n+    }\n \n-        elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, job.getIdentifier(), elasticProfileConfiguration, clusterProfileConfiguration);\n+    private boolean resolveSecrets(JobIdentifier jobIdentifier, ClusterProfile clusterProfile, ElasticProfile elasticProfile) {\n+        try {\n+            if (clusterProfile != null)\n+                secretParamResolver.resolve(clusterProfile);\n+            secretParamResolver.resolve(elasticProfile);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String cancellationMessage = format(\"\\nThis job was cancelled by GoCD. This job is configured to run on an elastic agent, but the associated elastic configurations failed for secrets resolution: %s\", e.getMessage());\n+            logToJobConsole(jobIdentifier, cancellationMessage);\n+            scheduleService.cancelJob(jobIdentifier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 324}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNzk3NA==", "bodyText": "You will also need to add a message on the JobStatusTopic so that the JobStatusListener is called.\n\nThis is taken care by the schedule service class. Done.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501527974", "createdAt": "2020-10-08T08:10:41Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -308,12 +323,73 @@ public void jobCompleted(JobInstance job) {\n \n         String pluginId = agentInstance.elasticAgentMetadata().elasticPluginId();\n         String elasticAgentId = agentInstance.elasticAgentMetadata().elasticAgentId();\n-\n+        JobIdentifier jobIdentifier = job.getIdentifier();\n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n+        try {\n+            secretParamResolver.resolve(elasticProfile);\n+            Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+            Map<String, String> clusterProfileConfiguration = emptyMap();\n+            if (clusterProfile != null) {\n+                secretParamResolver.resolve(clusterProfile);\n+                clusterProfileConfiguration = clusterProfile.getConfigurationAsMap(true, true);\n+            }\n+            elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, jobIdentifier, elasticProfileConfiguration, clusterProfileConfiguration);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"The job completion call to the plugin for the job identifier [%s] failed for secrets resolution: %s \", jobIdentifier.toString(), e.getMessage());\n+            ServerHealthState healthState = error(\"Failed to notify plugin\", description, general(scopeForJob(jobIdentifier)));\n+            healthState.setTimeout(Timeout.FIVE_MINUTES);\n+            serverHealthService.update(healthState);\n+            LOGGER.error(description);\n+        }\n+    }\n+\n+    private void logToJobConsole(JobIdentifier identifier, String message) {\n+        try {\n+            consoleService.appendToConsoleLog(identifier, message);\n+        } catch (IllegalArtifactLocationException | IOException e) {\n+            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n+        }\n+    }\n+\n+    private Predicate<JobPlan> isElasticAgent() {\n+        return JobPlan::requiresElasticAgent;\n+    }\n+\n+    private HealthStateScope scope(String pluginId) {\n+        return HealthStateScope.aboutPlugin(pluginId, \"missingPlugin\");\n+    }\n+\n+    @NotNull\n+    private HealthStateScope scopeForJob(JobIdentifier jobIdentifier) {\n+        return forJob(jobIdentifier.getPipelineName(), jobIdentifier.getStageName(), jobIdentifier.getBuildName());\n+    }\n+\n+    private boolean resolveSecrets(String pluginId, List<ClusterProfile> clusterProfiles) {\n+        try {\n+            for (ClusterProfile clusterProfile : clusterProfiles) {\n+                secretParamResolver.resolve(clusterProfile);\n+            }\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"Secrets resolution failed for cluster profile associated with plugin [%s]: %s \", pluginId, e.getMessage());\n+            serverHealthService.update(error(format(\"Ping failed for '%s' plugin\", pluginId), description, general(scope(pluginId))));\n+            LOGGER.error(description);\n+            return false;\n+        }\n+        return true;\n+    }\n \n-        elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, job.getIdentifier(), elasticProfileConfiguration, clusterProfileConfiguration);\n+    private boolean resolveSecrets(JobIdentifier jobIdentifier, ClusterProfile clusterProfile, ElasticProfile elasticProfile) {\n+        try {\n+            if (clusterProfile != null)\n+                secretParamResolver.resolve(clusterProfile);\n+            secretParamResolver.resolve(elasticProfile);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String cancellationMessage = format(\"\\nThis job was cancelled by GoCD. This job is configured to run on an elastic agent, but the associated elastic configurations failed for secrets resolution: %s\", e.getMessage());\n+            logToJobConsole(jobIdentifier, cancellationMessage);\n+            scheduleService.cancelJob(jobIdentifier);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MjE4Mg=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 324}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDIxNDExOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzowMzozNFrOHeQl7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODozMToxMVrOHeTmbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5MTE4Mw==", "bodyText": "It seems wrong for the shouldAssignWork method cancelling the job here. I think the caller of this method should handle the secret resolution exceptions and take necessary actions.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501491183", "createdAt": "2020-10-08T07:03:34Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -193,68 +201,70 @@ public void createAgentsFor(List<JobPlan> old, List<JobPlan> newPlan) {\n         jobsThatRequireAgent.addAll(Sets.difference(new HashSet<>(newPlan), new HashSet<>(old)));\n         jobsThatRequireAgent.addAll(starvingJobs);\n \n-        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(Collectors.toList());\n+        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(toList());\n //      messageTimeToLive is lesser than the starvation threshold to ensure there are no duplicate create agent message\n         long messageTimeToLive = goConfigService.elasticJobStarvationThreshold() - 10000;\n \n         for (JobPlan plan : plansThatRequireElasticAgent) {\n             jobCreationTimeMap.put(plan.getJobId(), timeProvider.currentTimeMillis());\n             ElasticProfile elasticProfile = plan.getElasticProfile();\n             ClusterProfile clusterProfile = plan.getClusterProfile();\n+            JobIdentifier jobIdentifier = plan.getIdentifier();\n             if (clusterProfile == null) {\n                 String cancellationMessage = \"\\nThis job was cancelled by GoCD. The version of your GoCD server requires elastic profiles to be associated with a cluster(required from Version 19.3.0). \" +\n                         \"This job is configured to run on an Elastic Agent, but the associated elastic profile does not have information about the cluster.  \\n\\n\" +\n                         \"The possible reason for the missing cluster information on the elastic profile could be, an upgrade of the GoCD server to a version >= 19.3.0 before the completion of the job.\\n\\n\" +\n                         \"A re-run of this job should fix this issue.\";\n-                logToJobConsole(plan.getIdentifier(), cancellationMessage);\n-                scheduleService.cancelJob(plan.getIdentifier());\n+                logToJobConsole(jobIdentifier, cancellationMessage);\n+                scheduleService.cancelJob(jobIdentifier);\n             } else if (elasticAgentPluginRegistry.has(clusterProfile.getPluginId())) {\n                 String environment = environmentConfigService.envForPipeline(plan.getPipelineName());\n-                createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, plan.getIdentifier()), messageTimeToLive);\n-                serverHealthService.removeByScope(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()));\n+                boolean secretsResolved = resolveSecrets(jobIdentifier, clusterProfile, elasticProfile);\n+                if (secretsResolved) {\n+                    createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, jobIdentifier), messageTimeToLive);\n+                    serverHealthService.removeByScope(scopeForJob(jobIdentifier));\n+                }\n             } else {\n-                String jobConfigIdentifier = plan.getIdentifier().jobConfigIdentifier().toString();\n+                String jobConfigIdentifier = jobIdentifier.jobConfigIdentifier().toString();\n                 String description = format(\"Plugin [%s] associated with %s is missing. Either the plugin is not \" +\n                         \"installed or could not be registered. Please check plugins tab \" +\n                         \"and server logs for more details.\", clusterProfile.getPluginId(), jobConfigIdentifier);\n-                serverHealthService.update(ServerHealthState.error(format(\"Unable to find agent for %s\",\n-                        jobConfigIdentifier), description, HealthStateType.general(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()))));\n+                serverHealthService.update(error(format(\"Unable to find agent for %s\",\n+                        jobConfigIdentifier), description, general(scopeForJob(jobIdentifier))));\n                 LOGGER.error(description);\n             }\n         }\n     }\n \n-    private void logToJobConsole(JobIdentifier identifier, String message) {\n-        try {\n-            consoleService.appendToConsoleLog(identifier, message);\n-        } catch (IllegalArtifactLocationException | IOException e) {\n-            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n-        }\n-    }\n-\n-    private Predicate<JobPlan> isElasticAgent() {\n-        return JobPlan::requiresElasticAgent;\n-    }\n-\n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+            return false;\n+        }\n \n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        boolean secretsResolved = resolveSecrets(identifier, clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUwNzk5Mw==", "bodyText": "I don't get it. If the service can cancel the job in the createAgent call, why can't it do so in shouldAssignWork?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501507993", "createdAt": "2020-10-08T07:36:34Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -193,68 +201,70 @@ public void createAgentsFor(List<JobPlan> old, List<JobPlan> newPlan) {\n         jobsThatRequireAgent.addAll(Sets.difference(new HashSet<>(newPlan), new HashSet<>(old)));\n         jobsThatRequireAgent.addAll(starvingJobs);\n \n-        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(Collectors.toList());\n+        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(toList());\n //      messageTimeToLive is lesser than the starvation threshold to ensure there are no duplicate create agent message\n         long messageTimeToLive = goConfigService.elasticJobStarvationThreshold() - 10000;\n \n         for (JobPlan plan : plansThatRequireElasticAgent) {\n             jobCreationTimeMap.put(plan.getJobId(), timeProvider.currentTimeMillis());\n             ElasticProfile elasticProfile = plan.getElasticProfile();\n             ClusterProfile clusterProfile = plan.getClusterProfile();\n+            JobIdentifier jobIdentifier = plan.getIdentifier();\n             if (clusterProfile == null) {\n                 String cancellationMessage = \"\\nThis job was cancelled by GoCD. The version of your GoCD server requires elastic profiles to be associated with a cluster(required from Version 19.3.0). \" +\n                         \"This job is configured to run on an Elastic Agent, but the associated elastic profile does not have information about the cluster.  \\n\\n\" +\n                         \"The possible reason for the missing cluster information on the elastic profile could be, an upgrade of the GoCD server to a version >= 19.3.0 before the completion of the job.\\n\\n\" +\n                         \"A re-run of this job should fix this issue.\";\n-                logToJobConsole(plan.getIdentifier(), cancellationMessage);\n-                scheduleService.cancelJob(plan.getIdentifier());\n+                logToJobConsole(jobIdentifier, cancellationMessage);\n+                scheduleService.cancelJob(jobIdentifier);\n             } else if (elasticAgentPluginRegistry.has(clusterProfile.getPluginId())) {\n                 String environment = environmentConfigService.envForPipeline(plan.getPipelineName());\n-                createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, plan.getIdentifier()), messageTimeToLive);\n-                serverHealthService.removeByScope(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()));\n+                boolean secretsResolved = resolveSecrets(jobIdentifier, clusterProfile, elasticProfile);\n+                if (secretsResolved) {\n+                    createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, jobIdentifier), messageTimeToLive);\n+                    serverHealthService.removeByScope(scopeForJob(jobIdentifier));\n+                }\n             } else {\n-                String jobConfigIdentifier = plan.getIdentifier().jobConfigIdentifier().toString();\n+                String jobConfigIdentifier = jobIdentifier.jobConfigIdentifier().toString();\n                 String description = format(\"Plugin [%s] associated with %s is missing. Either the plugin is not \" +\n                         \"installed or could not be registered. Please check plugins tab \" +\n                         \"and server logs for more details.\", clusterProfile.getPluginId(), jobConfigIdentifier);\n-                serverHealthService.update(ServerHealthState.error(format(\"Unable to find agent for %s\",\n-                        jobConfigIdentifier), description, HealthStateType.general(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()))));\n+                serverHealthService.update(error(format(\"Unable to find agent for %s\",\n+                        jobConfigIdentifier), description, general(scopeForJob(jobIdentifier))));\n                 LOGGER.error(description);\n             }\n         }\n     }\n \n-    private void logToJobConsole(JobIdentifier identifier, String message) {\n-        try {\n-            consoleService.appendToConsoleLog(identifier, message);\n-        } catch (IllegalArtifactLocationException | IOException e) {\n-            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n-        }\n-    }\n-\n-    private Predicate<JobPlan> isElasticAgent() {\n-        return JobPlan::requiresElasticAgent;\n-    }\n-\n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+            return false;\n+        }\n \n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        boolean secretsResolved = resolveSecrets(identifier, clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5MTE4Mw=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU0MDQ2MA==", "bodyText": "Hmmm, I think in both the cases I would have preferred the ElasticAgentPluginService not cancelling the job, the way create createAgent is implemented it makes it tough to make those changes.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501540460", "createdAt": "2020-10-08T08:31:11Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -193,68 +201,70 @@ public void createAgentsFor(List<JobPlan> old, List<JobPlan> newPlan) {\n         jobsThatRequireAgent.addAll(Sets.difference(new HashSet<>(newPlan), new HashSet<>(old)));\n         jobsThatRequireAgent.addAll(starvingJobs);\n \n-        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(Collectors.toList());\n+        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(toList());\n //      messageTimeToLive is lesser than the starvation threshold to ensure there are no duplicate create agent message\n         long messageTimeToLive = goConfigService.elasticJobStarvationThreshold() - 10000;\n \n         for (JobPlan plan : plansThatRequireElasticAgent) {\n             jobCreationTimeMap.put(plan.getJobId(), timeProvider.currentTimeMillis());\n             ElasticProfile elasticProfile = plan.getElasticProfile();\n             ClusterProfile clusterProfile = plan.getClusterProfile();\n+            JobIdentifier jobIdentifier = plan.getIdentifier();\n             if (clusterProfile == null) {\n                 String cancellationMessage = \"\\nThis job was cancelled by GoCD. The version of your GoCD server requires elastic profiles to be associated with a cluster(required from Version 19.3.0). \" +\n                         \"This job is configured to run on an Elastic Agent, but the associated elastic profile does not have information about the cluster.  \\n\\n\" +\n                         \"The possible reason for the missing cluster information on the elastic profile could be, an upgrade of the GoCD server to a version >= 19.3.0 before the completion of the job.\\n\\n\" +\n                         \"A re-run of this job should fix this issue.\";\n-                logToJobConsole(plan.getIdentifier(), cancellationMessage);\n-                scheduleService.cancelJob(plan.getIdentifier());\n+                logToJobConsole(jobIdentifier, cancellationMessage);\n+                scheduleService.cancelJob(jobIdentifier);\n             } else if (elasticAgentPluginRegistry.has(clusterProfile.getPluginId())) {\n                 String environment = environmentConfigService.envForPipeline(plan.getPipelineName());\n-                createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, plan.getIdentifier()), messageTimeToLive);\n-                serverHealthService.removeByScope(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()));\n+                boolean secretsResolved = resolveSecrets(jobIdentifier, clusterProfile, elasticProfile);\n+                if (secretsResolved) {\n+                    createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, jobIdentifier), messageTimeToLive);\n+                    serverHealthService.removeByScope(scopeForJob(jobIdentifier));\n+                }\n             } else {\n-                String jobConfigIdentifier = plan.getIdentifier().jobConfigIdentifier().toString();\n+                String jobConfigIdentifier = jobIdentifier.jobConfigIdentifier().toString();\n                 String description = format(\"Plugin [%s] associated with %s is missing. Either the plugin is not \" +\n                         \"installed or could not be registered. Please check plugins tab \" +\n                         \"and server logs for more details.\", clusterProfile.getPluginId(), jobConfigIdentifier);\n-                serverHealthService.update(ServerHealthState.error(format(\"Unable to find agent for %s\",\n-                        jobConfigIdentifier), description, HealthStateType.general(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()))));\n+                serverHealthService.update(error(format(\"Unable to find agent for %s\",\n+                        jobConfigIdentifier), description, general(scopeForJob(jobIdentifier))));\n                 LOGGER.error(description);\n             }\n         }\n     }\n \n-    private void logToJobConsole(JobIdentifier identifier, String message) {\n-        try {\n-            consoleService.appendToConsoleLog(identifier, message);\n-        } catch (IllegalArtifactLocationException | IOException e) {\n-            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n-        }\n-    }\n-\n-    private Predicate<JobPlan> isElasticAgent() {\n-        return JobPlan::requiresElasticAgent;\n-    }\n-\n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+            return false;\n+        }\n \n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        boolean secretsResolved = resolveSecrets(identifier, clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5MTE4Mw=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 184}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0MDI2ODU3OnYy", "diffSide": "RIGHT", "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzoyMDo1NFrOHeRHUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwODoxMjozNFrOHeS6Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5OTcyOQ==", "bodyText": "This should not be 422, it's not a user error.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501499729", "createdAt": "2020-10-08T07:20:54Z", "author": {"login": "maheshp"}, "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "diffHunk": "@@ -91,6 +93,9 @@ public ModelAndView pluginStatusReport(Request request, Response response) {\n         } catch (UnsupportedOperationException e) {\n             String message = String.format(\"Status Report for plugin with id: '%s' is not found.\", pluginId);\n             return errorPage(response, 404, \"Plugin Status Report\", message);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            LOGGER.error(e.getMessage(), e);\n+            return errorPage(response, 422, \"Plugin Status Report\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUwNDAzMQ==", "bodyText": "The exception can be raised due to a secret being configured for a non-existent secret config id. Which is a user error.\nIf not 422, then what? 500?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501504031", "createdAt": "2020-10-08T07:28:53Z", "author": {"login": "kritika-singh3"}, "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "diffHunk": "@@ -91,6 +93,9 @@ public ModelAndView pluginStatusReport(Request request, Response response) {\n         } catch (UnsupportedOperationException e) {\n             String message = String.format(\"Status Report for plugin with id: '%s' is not found.\", pluginId);\n             return errorPage(response, 404, \"Plugin Status Report\", message);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            LOGGER.error(e.getMessage(), e);\n+            return errorPage(response, 422, \"Plugin Status Report\", e.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5OTcyOQ=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyNzI4NQ==", "bodyText": "The exception can be raised due to a secret being configured for a non-existent secret config id. Which is a user error.\n\nThese would be user errors during config update right.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501527285", "createdAt": "2020-10-08T08:09:38Z", "author": {"login": "maheshp"}, "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "diffHunk": "@@ -91,6 +93,9 @@ public ModelAndView pluginStatusReport(Request request, Response response) {\n         } catch (UnsupportedOperationException e) {\n             String message = String.format(\"Status Report for plugin with id: '%s' is not found.\", pluginId);\n             return errorPage(response, 404, \"Plugin Status Report\", message);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            LOGGER.error(e.getMessage(), e);\n+            return errorPage(response, 422, \"Plugin Status Report\", e.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5OTcyOQ=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTUyOTA5MA==", "bodyText": "Yes but these are not caught during full config save.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501529090", "createdAt": "2020-10-08T08:12:34Z", "author": {"login": "kritika-singh3"}, "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "diffHunk": "@@ -91,6 +93,9 @@ public ModelAndView pluginStatusReport(Request request, Response response) {\n         } catch (UnsupportedOperationException e) {\n             String message = String.format(\"Status Report for plugin with id: '%s' is not found.\", pluginId);\n             return errorPage(response, 404, \"Plugin Status Report\", message);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            LOGGER.error(e.getMessage(), e);\n+            return errorPage(response, 422, \"Plugin Status Report\", e.getMessage());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5OTcyOQ=="}, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4ODYzMDgwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozMTozMlrOHlcJ0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozMTozMlrOHlcJ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyMDYyNA==", "bodyText": "This job was failed by GoCD. This job is configured to run on an elastic agent, there were errors while resolving secrets for the the associated elastic configurations.\nReasons: blah blah blah", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r509020624", "createdAt": "2020-10-21T06:31:32Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java", "diffHunk": "@@ -202,9 +202,18 @@ JobPlan findMatchingJob(AgentInstance agent) {\n             match = agent.firstMatching(filteredJobPlans);\n         } else {\n             for (JobPlan jobPlan : filteredJobPlans) {\n-                if (jobPlan.requiresElasticAgent() && elasticAgentPluginService.shouldAssignWork(agent.elasticAgentMetadata(), environmentConfigService.envForPipeline(jobPlan.getPipelineName()), jobPlan.getElasticProfile(), jobPlan.getClusterProfile(), jobPlan.getIdentifier())) {\n-                    match = jobPlan;\n-                    break;\n+                try {\n+                    if (jobPlan.requiresElasticAgent() && elasticAgentPluginService.shouldAssignWork(agent.elasticAgentMetadata(), environmentConfigService.envForPipeline(jobPlan.getPipelineName()), jobPlan.getElasticProfile(), jobPlan.getClusterProfile(), jobPlan.getIdentifier())) {\n+                        match = jobPlan;\n+                        break;\n+                    }\n+                } catch (RulesViolationException | SecretResolutionFailureException e) {\n+                    JobInstance instance = jobInstanceService.buildById(jobPlan.getJobId());\n+                    JobIdentifier jobIdentifier = jobPlan.getIdentifier();\n+                    String failureMessage = format(\"\\nThis job was failed by GoCD. This job is configured to run on an elastic agent, but the associated elastic configurations failed for secrets resolution: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0de943362b91b97c746558bcd66d4abd505db12"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2801, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}