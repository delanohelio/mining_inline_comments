{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MTk3MDA2", "number": 8558, "title": "Add support for secrets in package configurations", "bodyText": "Description: Added support to specify secrets in package configurations meaning both in package repository and the package.\n\nthe rules will be evaluated and resolved during\n\ncheck connection call\nwhile saving package configurations\nwhile checking for material update (if the package is used as a material in any pipeline)\n\n\nusers can specify the rules for a secret config using package_repository as entity\nthe secrets in packages will be validated based upon the rules for the package repository.", "createdAt": "2020-09-15T10:26:34Z", "url": "https://github.com/gocd/gocd/pull/8558", "merged": true, "mergeCommit": {"oid": "5224cab793f1fc77ed51523d667087b4c29ad7f4"}, "closed": true, "closedAt": "2020-09-18T11:30:31Z", "author": {"login": "kritika-singh3"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJZI9bAFqTQ4OTQyMzM4Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKDH0aABqjM3ODIwMDIxNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDIzMzg2", "url": "https://github.com/gocd/gocd/pull/8558#pullrequestreview-489423386", "createdAt": "2020-09-16T09:05:01Z", "commit": {"oid": "39539749221bad60568e7934783d5c565b2b7108"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTowNTowMVrOHSnZlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQwOTozMzoxMVrOHSog4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTI4MTk0Mg==", "bodyText": "The logic for hasSecretParams and getSecretParams is repeated across classes. Is it ok to move it to Configuration class?", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r489281942", "createdAt": "2020-09-16T09:05:01Z", "author": {"login": "maheshp"}, "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/packagerepository/PackageDefinition.java", "diffHunk": "@@ -326,4 +322,22 @@ public void ensureIdExists() {\n             setId(UUID.randomUUID().toString());\n         }\n     }\n+\n+    @Override\n+    public boolean hasSecretParams() {\n+        return this.getRepository().hasSecretParams()\n+                || this.getConfiguration()\n+                .stream()\n+                .anyMatch(ConfigurationProperty::hasSecretParams);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39539749221bad60568e7934783d5c565b2b7108"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTMwMDE5NA==", "bodyText": "Map<CaseInsensitiveString, StringBuilder> errors = new HashMap<>();", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r489300194", "createdAt": "2020-09-16T09:33:11Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/RulesService.java", "diffHunk": "@@ -136,24 +143,22 @@ private void addError(Map<CaseInsensitiveString, StringBuilder> pipelinesWithErr\n         pipelinesWithErrors.put(pipelineName, stringBuilder);\n     }\n \n-    @NotNull\n-    private HashMap<CaseInsensitiveString, StringBuilder> validate(SCM scmConfig) {\n-        String scmConfigName = scmConfig.getName();\n+    private String errorString(Map<CaseInsensitiveString, StringBuilder> errors) {\n+        return join(errors.values(), '\\n').trim();\n+    }\n+\n+    protected Map<CaseInsensitiveString, StringBuilder> validate(SecretParams secretParams, Class<? extends Validatable> entityClass, String entityName, String entityNameOrErrorMessagePrefix) {\n         HashMap<CaseInsensitiveString, StringBuilder> pipelinesWithErrors = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6f7e94fa8d5f121155f183ac4e50e56d11b1dd6"}, "originalPosition": 54}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2ec32e95b96313a91c38f763fa0bc0351e4750e1", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/2ec32e95b96313a91c38f763fa0bc0351e4750e1", "committedDate": "2020-09-16T03:53:42Z", "message": "Update secrets management spa to support package repository as entity type for rules"}, "afterCommit": {"oid": "60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "committedDate": "2020-09-16T09:59:55Z", "message": "Update secrets management spa to support package repository as entity type for rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/60ef3c990a9d57ecfb04ca20a27afa5f8924e25f", "committedDate": "2020-09-16T09:59:55Z", "message": "Update secrets management spa to support package repository as entity type for rules"}, "afterCommit": {"oid": "8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "committedDate": "2020-09-18T04:55:07Z", "message": "Update secrets management spa to support package repository as entity type for rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/8690aee2a3138e0305ffb9b4f9bba8d8603f4477", "committedDate": "2020-09-18T04:55:07Z", "message": "Update secrets management spa to support package repository as entity type for rules"}, "afterCommit": {"oid": "9594f440bde7f593432844b23d053c822c801284", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/9594f440bde7f593432844b23d053c822c801284", "committedDate": "2020-09-18T08:55:58Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException is raised while saving. If yes, then return 422 else 500\nSet error message on the modal itself for package operations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa82e7d41e2b12e633d24e6e7b84f9c64828ebf9", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/aa82e7d41e2b12e633d24e6e7b84f9c64828ebf9", "committedDate": "2020-09-18T09:42:32Z", "message": "Make PackageRepository, PackageDefinition and PackageMaterial SecretAware"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7887f858d2a78ac1f5bb5ca097f237024e9709af", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/7887f858d2a78ac1f5bb5ca097f237024e9709af", "committedDate": "2020-09-18T09:42:32Z", "message": "Support secrets for package materials\n - Validate secrets in package materials wrt to rules for `package_repository`\n - resolve rules for mdu and before sending the values to the plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07512a307cfe96078978f8028e7ad2ccf3dbd3fc", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/07512a307cfe96078978f8028e7ad2ccf3dbd3fc", "committedDate": "2020-09-18T09:42:32Z", "message": "Validate and resolve secrets for\n - check connection of package repo and package def\n - isValid call for package repo and package def"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7185cd1f9c0071079bea82949b203202911404e7", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/7185cd1f9c0071079bea82949b203202911404e7", "committedDate": "2020-09-18T09:42:32Z", "message": "Update secrets management spa to support package repository as entity type for rules"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9594f440bde7f593432844b23d053c822c801284", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/9594f440bde7f593432844b23d053c822c801284", "committedDate": "2020-09-18T08:55:58Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException is raised while saving. If yes, then return 422 else 500\nSet error message on the modal itself for package operations"}, "afterCommit": {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/7d81c34207343b8e7d68a98633f4c54ac42d5f44", "committedDate": "2020-09-18T09:42:32Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMzQyMTk5", "url": "https://github.com/gocd/gocd/pull/8558#pullrequestreview-491342199", "createdAt": "2020-09-18T10:29:42Z", "commit": {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDoyOTo0MlrOHUHXHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMDozMDozOVrOHUHY5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDE3NQ==", "bodyText": "Don't log this error.", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r490854175", "createdAt": "2020-09-18T10:29:42Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/materials/PackageDefinitionService.java", "diffHunk": "@@ -138,6 +145,9 @@ private void update(Username username, PackageDefinition packageDeinition, HttpL\n         } catch (Exception e) {\n             if (e instanceof GoConfigInvalidException && !result.hasMessage()) {\n                 result.unprocessableEntity(entityConfigValidationFailed(packageDeinition.getClass().getAnnotation(ConfigTag.class).value(), packageDeinition.getId(), e.getMessage()));\n+            } else if (e instanceof RulesViolationException || e instanceof SecretResolutionFailureException) {\n+                LOGGER.error(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDg1NDYyOA==", "bodyText": "Don't log this error.", "url": "https://github.com/gocd/gocd/pull/8558#discussion_r490854628", "createdAt": "2020-09-18T10:30:39Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/materials/PackageRepositoryService.java", "diffHunk": "@@ -173,6 +176,9 @@ private void update(Username username, HttpLocalizedOperationResult result, Enti\n         } catch (Exception e) {\n             if (e instanceof GoConfigInvalidException && !result.hasMessage()) {\n                 result.unprocessableEntity(entityConfigValidationFailed(repository.getClass().getAnnotation(ConfigTag.class).value(), repository.getId(), e.getMessage()));\n+            } else if (e instanceof RulesViolationException || e instanceof SecretResolutionFailureException) {\n+                LOGGER.error(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44"}, "originalPosition": 103}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7651f88fd8c76b9b34faf08e730bcae42ea811d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c7651f88fd8c76b9b34faf08e730bcae42ea811d", "committedDate": "2020-09-18T10:34:29Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d81c34207343b8e7d68a98633f4c54ac42d5f44", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/7d81c34207343b8e7d68a98633f4c54ac42d5f44", "committedDate": "2020-09-18T09:42:32Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations"}, "afterCommit": {"oid": "c7651f88fd8c76b9b34faf08e730bcae42ea811d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c7651f88fd8c76b9b34faf08e730bcae42ea811d", "committedDate": "2020-09-18T10:34:29Z", "message": "Don't send secrets in package material as part of build assignment\nResolve secrets for package material as part of build work\nFor Package Repo And Def operations, check if RulesViolationException or Secret resolution fails is raised while saving. If yes, then return 422 else 500\n - Same for check connection call as well\nSet error message on the modal itself for package operations"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1822, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}