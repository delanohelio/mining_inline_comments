{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNTc3NzI1", "number": 8599, "title": "Load GoCD configurations from config repositories on GoCD startup.", "bodyText": "Description:\nLoading the GoCD configurations from config repositories on GoCD startup  is required when the GoCD server has config repositories and the server is started in maintenance mode.\nWhen the server is started in maintenance mode, the MDU service will be disabled, and the config repository pipelines will never show up. This PR ensures to parse the existing cloned config repositories (from flyweight folder) on startup, making sure config repository pipelines are shown up on startup even in maintenance mode.\nSimilar conversation at: #5787\nUncovered Scenarios:\nFollowing are the scenarios where the config repository pipelines will not be parsed when server is in the maintenance mode:\n\nWhen the config repository is not available under flyweight directory (when material has never parsed).\nWhen a pipeline from one config repository depends on pipeline coming from another config repository; And the downstream pipeline config repository is parsed first.\nExample:\nLets say, config repo repo1 defines upstream pipeline and config repo repo2 defines downstream pipeline, and repo2 config repository is parsed before repo1. In such cases, the upstream pipeline coming from repo1 will not be shown on the UI.\n\nImplementation:\n\n\nAdd a config repo plugin load listener to initialize the GoCD configuration from the existing config repo material repository from flyweight folder.\n\n\nSkip initializing config repositories which are not available under flyweight folder (which are not cloned by GoCD yet).\n\n\nAlways return plugin post load hook result as success, even on config repo initialization failure due to errors (such as config validation / rules violations). As returning a failure response on plugin post load hook will mark plugin as invalid.", "createdAt": "2020-09-26T13:34:35Z", "url": "https://github.com/gocd/gocd/pull/8599", "merged": true, "mergeCommit": {"oid": "a7c529b061d71d049420c2fcc3893a75dffce828"}, "closed": true, "closedAt": "2020-10-05T03:05:15Z", "author": {"login": "GaneshSPatil"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNfJbEABqjM4MTcyMjQ2MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOKIkTgH2gAyNDkzNTc3NzI1OmRlOTJjMDY0OThhZjFkMDhmMDU2YjBjNTAzYjI5NWU3MGU1YWVkY2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9ddf5e62a4f9a482318be78d52916a7dbf8ea1f7", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/9ddf5e62a4f9a482318be78d52916a7dbf8ea1f7", "committedDate": "2020-09-29T02:52:59Z", "message": "Initialize config repositories only after cruise-config.xml is initialized and plugin is loaded.\n\nImplementation:\n\n* Implement ConfigChangedListener and PluginChangeListener as part\n  of ConfigRepositoryInitializer to listen to cruise-config.xml\n  initialized and plugin loaded events\n\n* Perform config repositories initialization only when all the\n  in use config repository plugins are loaded.\n\n* Make sure config repositories are initialized only once, even\n  when multiple config change event is called or the config repo\n  plugins are unloaded and loaded again.\n\nNeed:\n\nPlugins are loaded in a separate thread as that of the application\ninitializer. Hence, there is possibility of race condition, where,\nthe config repository initializer is called before the cruise-config\nis loaded, which possibly can cause config validation errors as\nentities coming from config repository may depend on/refer to entities\nfrom basic cruise-config.xml"}, "afterCommit": {"oid": "97fbc6ee749050a4b6a670f1abfdf5cd7f8ec170", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/97fbc6ee749050a4b6a670f1abfdf5cd7f8ec170", "committedDate": "2020-09-29T02:55:24Z", "message": "Initialize config repositories only after cruise-config.xml is initialized and plugin is loaded.\n\nImplementation:\n\n* Implement ConfigChangedListener and PluginChangeListener as part\n  of ConfigRepositoryInitializer to listen to cruise-config.xml\n  initialized and plugin loaded events\n\n* Perform config repositories initialization only when all the\n  in use config repository plugins are loaded.\n\n* Make sure config repositories are initialized only once, even\n  when multiple config change event is called or the config repo\n  plugins are unloaded and loaded again.\n\nNeed:\n\nPlugins are loaded in a separate thread as that of the application\ninitializer. Hence, there is possibility of race condition, where,\nthe config repository initializer is called before the cruise-config\nis loaded, which possibly can cause config validation errors as\nentities coming from config repository may depend on/refer to entities\nfrom basic cruise-config.xml"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk4MTIyNzYy", "url": "https://github.com/gocd/gocd/pull/8599#pullrequestreview-498122762", "createdAt": "2020-09-29T06:12:43Z", "commit": {"oid": "73fe5f07156a5b276d3754b5dca88559613ebd78"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNjoxMjo0M1rOHZcTKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNjoxMjo0M1rOHZcTKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0MDEwNQ==", "bodyText": "@GaneshSPatil with this check, in cases where multiple ConfigRepo plugins are used none of the repos will be parsed if a single plugin is missing. Guess this was not intended.", "url": "https://github.com/gocd/gocd/pull/8599#discussion_r496440105", "createdAt": "2020-09-29T06:12:43Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.thoughtworks.go.config.CruiseConfig;\n+import com.thoughtworks.go.config.GoConfigRepoConfigDataSource;\n+import com.thoughtworks.go.config.materials.MaterialConfigs;\n+import com.thoughtworks.go.config.materials.Materials;\n+import com.thoughtworks.go.config.remote.ConfigRepoConfig;\n+import com.thoughtworks.go.config.rules.RuleAwarePluginProfile;\n+import com.thoughtworks.go.domain.MaterialInstance;\n+import com.thoughtworks.go.domain.MaterialRevisions;\n+import com.thoughtworks.go.domain.materials.Material;\n+import com.thoughtworks.go.domain.materials.MaterialConfig;\n+import com.thoughtworks.go.domain.materials.Modification;\n+import com.thoughtworks.go.listener.ConfigChangedListener;\n+import com.thoughtworks.go.plugin.infra.PluginChangeListener;\n+import com.thoughtworks.go.plugin.infra.PluginManager;\n+import com.thoughtworks.go.plugin.infra.plugininfo.GoPluginDescriptor;\n+import com.thoughtworks.go.server.initializers.Initializer;\n+import com.thoughtworks.go.server.persistence.MaterialRepository;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.thoughtworks.go.plugin.domain.common.PluginConstants.CONFIG_REPO_EXTENSION;\n+\n+/**\n+ * @understands initializing config repositories. Loads the configurations from the last checked out modification on server startup.\n+ */\n+@Service\n+public class ConfigRepositoryInitializer implements ConfigChangedListener, PluginChangeListener, Initializer {\n+    private PluginManager pluginManager;\n+    private final ConfigRepoService configRepoService;\n+    private final MaterialRepository materialRepository;\n+    private final GoConfigRepoConfigDataSource goConfigRepoConfigDataSource;\n+    private GoConfigService goConfigService;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigRepositoryInitializer.class);\n+\n+    private boolean isConfigLoaded = false;\n+    private boolean hasConfigRepoInitializationCompleted = false;\n+    private List<String> loadedConfigRepoPlugins = new ArrayList<>();\n+\n+    @Autowired\n+    public ConfigRepositoryInitializer(PluginManager pluginManager, ConfigRepoService configRepoService, MaterialRepository materialRepository, GoConfigRepoConfigDataSource goConfigRepoConfigDataSource, GoConfigService goConfigService) {\n+        this.pluginManager = pluginManager;\n+        this.configRepoService = configRepoService;\n+        this.materialRepository = materialRepository;\n+        this.goConfigRepoConfigDataSource = goConfigRepoConfigDataSource;\n+        this.goConfigService = goConfigService;\n+\n+        this.pluginManager.addPluginChangeListener(this);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        this.goConfigService.register(this);\n+    }\n+\n+    @Override\n+    public void startDaemon() {\n+    }\n+\n+    @Override\n+    public void onConfigChange(CruiseConfig newCruiseConfig) {\n+        // mark config loaded only once!\n+        if (!this.isConfigLoaded) {\n+            this.isConfigLoaded = true;\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginLoaded(GoPluginDescriptor pluginDescriptor) {\n+        String pluginId = pluginDescriptor.id();\n+        boolean isConfigRepoPlugin = pluginManager.isPluginOfType(CONFIG_REPO_EXTENSION, pluginId);\n+\n+        if (isConfigRepoPlugin) {\n+            this.loadedConfigRepoPlugins.add(pluginId);\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginUnLoaded(GoPluginDescriptor pluginDescriptor) {\n+        //do nothing\n+    }\n+\n+    private void initializeConfigRepositories() {\n+        // return if config repositories have already been initialized.\n+        if (this.hasConfigRepoInitializationCompleted) {\n+            return;\n+        }\n+\n+        // do nothing if the cruise config is not loaded yet..\n+        if (!this.isConfigLoaded) {\n+            return;\n+        }\n+\n+        List<String> inUseConfigRepoPlugins = this.configRepoService.getConfigRepos().stream().map(RuleAwarePluginProfile::getPluginId).collect(Collectors.toList());\n+        if (this.loadedConfigRepoPlugins.containsAll(inUseConfigRepoPlugins)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73fe5f07156a5b276d3754b5dca88559613ebd78"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0e084e92d403c9cde40e7c6419a1930ec8916f6", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/d0e084e92d403c9cde40e7c6419a1930ec8916f6", "committedDate": "2020-09-30T06:30:05Z", "message": "Load GoCD configurations from config repositories on GoCD startup.\n\n* Add a config repo plugin load listener to initialize the GoCD\n  configuration from the existing config repo material repository\n  from flyweight folder.\n\n* Skip initializing config repositories which are not available\n  under flyweight folder (which are not cloned by GoCD yet).\n\n* Always return plugin post load hook result as success, even\n  on config repo initialization failure due to errors (such as\n  config validation / rules violations). As returning a failure\n  response on plugin post load hook will mark plugin as invalid."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17f74d41df8578d1e763ccbf8db37b4689e58a53", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/17f74d41df8578d1e763ccbf8db37b4689e58a53", "committedDate": "2020-09-30T06:30:05Z", "message": "Initialize config repositories only after cruise-config.xml is initialized and plugin is loaded.\n\nImplementation:\n\n* Implement ConfigChangedListener and PluginChangeListener as part\n  of ConfigRepositoryInitializer to listen to cruise-config.xml\n  initialized and plugin loaded events\n\n* Perform config repositories initialization only when all the\n  in use config repository plugins are loaded.\n\n* Make sure config repositories are initialized only once, even\n  when multiple config change event is called or the config repo\n  plugins are unloaded and loaded again.\n\nNeed:\n\nPlugins are loaded in a separate thread as that of the application\ninitializer. Hence, there is possibility of race condition, where,\nthe config repository initializer is called before the cruise-config\nis loaded, which possibly can cause config validation errors as\nentities coming from config repository may depend on/refer to entities\nfrom basic cruise-config.xml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2109cd801ad16f82090e38d4e1aaaaff541a212e", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/2109cd801ad16f82090e38d4e1aaaaff541a212e", "committedDate": "2020-09-30T06:30:05Z", "message": "Fix specs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b64a23f3ab8c58606ccd92c71ac40f4ba12420b", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/8b64a23f3ab8c58606ccd92c71ac40f4ba12420b", "committedDate": "2020-09-30T06:30:05Z", "message": "Initialize config repositories immediately when plugin is loaded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "153e558b912d2e5d1047b23f749f2633598d1b43", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/153e558b912d2e5d1047b23f749f2633598d1b43", "committedDate": "2020-09-30T06:34:31Z", "message": "Use queue"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ce6c141e01637f6c16f889e9622abebdddffd5a", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/5ce6c141e01637f6c16f889e9622abebdddffd5a", "committedDate": "2020-09-29T08:54:46Z", "message": "Initialize config repositories immediately when plugin is loaded"}, "afterCommit": {"oid": "153e558b912d2e5d1047b23f749f2633598d1b43", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/153e558b912d2e5d1047b23f749f2633598d1b43", "committedDate": "2020-09-30T06:34:31Z", "message": "Use queue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5Mjk4NjUz", "url": "https://github.com/gocd/gocd/pull/8599#pullrequestreview-499298653", "createdAt": "2020-09-30T10:38:10Z", "commit": {"oid": "153e558b912d2e5d1047b23f749f2633598d1b43"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDozODoxMVrOHaXiNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDozODoxMVrOHaXiNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQxMDYxNA==", "bodyText": "@GaneshSPatil can we register for ConfigChange in the constructor over the intitalize method. If we register in the intialize method, the config repos will most likely be parsed as part of the main thread and this will lead to increased startup time for GoCD instances with larger configs and multiple config repos. WDYT?", "url": "https://github.com/gocd/gocd/pull/8599#discussion_r497410614", "createdAt": "2020-09-30T10:38:11Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.thoughtworks.go.config.CruiseConfig;\n+import com.thoughtworks.go.config.GoConfigRepoConfigDataSource;\n+import com.thoughtworks.go.config.materials.MaterialConfigs;\n+import com.thoughtworks.go.config.materials.Materials;\n+import com.thoughtworks.go.config.remote.ConfigRepoConfig;\n+import com.thoughtworks.go.domain.MaterialInstance;\n+import com.thoughtworks.go.domain.MaterialRevisions;\n+import com.thoughtworks.go.domain.materials.Material;\n+import com.thoughtworks.go.domain.materials.MaterialConfig;\n+import com.thoughtworks.go.domain.materials.Modification;\n+import com.thoughtworks.go.listener.ConfigChangedListener;\n+import com.thoughtworks.go.plugin.infra.PluginChangeListener;\n+import com.thoughtworks.go.plugin.infra.PluginManager;\n+import com.thoughtworks.go.plugin.infra.plugininfo.GoPluginDescriptor;\n+import com.thoughtworks.go.server.initializers.Initializer;\n+import com.thoughtworks.go.server.persistence.MaterialRepository;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+import java.util.LinkedList;\n+\n+import static com.thoughtworks.go.plugin.domain.common.PluginConstants.CONFIG_REPO_EXTENSION;\n+\n+/**\n+ * @understands initializing config repositories. Loads the configurations from the last checked out modification on server startup.\n+ */\n+@Service\n+public class ConfigRepositoryInitializer implements ConfigChangedListener, PluginChangeListener, Initializer {\n+    private PluginManager pluginManager;\n+    private final ConfigRepoService configRepoService;\n+    private final MaterialRepository materialRepository;\n+    private final GoConfigRepoConfigDataSource goConfigRepoConfigDataSource;\n+    private GoConfigService goConfigService;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigRepositoryInitializer.class);\n+\n+    private boolean isConfigLoaded = false;\n+\n+    // list of config repo plugins which are loaded, but not yet processed. Once processed, these plugins will be removed from the list.\n+    private final LinkedList<String> pluginsQueue = new LinkedList<>();\n+\n+    @Autowired\n+    public ConfigRepositoryInitializer(PluginManager pluginManager, ConfigRepoService configRepoService, MaterialRepository materialRepository, GoConfigRepoConfigDataSource goConfigRepoConfigDataSource, GoConfigService goConfigService) {\n+        this.pluginManager = pluginManager;\n+        this.configRepoService = configRepoService;\n+        this.materialRepository = materialRepository;\n+        this.goConfigRepoConfigDataSource = goConfigRepoConfigDataSource;\n+        this.goConfigService = goConfigService;\n+\n+        this.pluginManager.addPluginChangeListener(this);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        this.goConfigService.register(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "153e558b912d2e5d1047b23f749f2633598d1b43"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de92c06498af1d08f056b0c503b295e70e5aedce", "author": {"user": {"login": "GaneshSPatil", "name": "Ganesh S Patil"}}, "url": "https://github.com/gocd/gocd/commit/de92c06498af1d08f056b0c503b295e70e5aedce", "committedDate": "2020-10-01T05:00:35Z", "message": "Fix comments\n\n* Move registering config change listener to constructor.\n* Log an error when config repository parsing fails.\n* Add a system property to initialize config repositories\n  on startup.\n  Based on the system property value, register the config\n  change and plugin load listeners."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1835, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}