{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NjM5NDc2", "number": 8610, "title": "Fix scm and package update", "bodyText": "Issue: #8542\nDescription: Update pipeline config on changes to to SCM, Package repo or package.", "createdAt": "2020-10-05T07:05:57Z", "url": "https://github.com/gocd/gocd/pull/8610", "merged": true, "mergeCommit": {"oid": "c44ed03b3c841cb9b7f6a4d654f134ed0d970bac"}, "closed": true, "closedAt": "2020-10-06T03:04:04Z", "author": {"login": "maheshp"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPfwMmAFqTUwMTg0MDQ0Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPhI8SAFqTUwMTkxNjQ2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODQwNDQz", "url": "https://github.com/gocd/gocd/pull/8610#pullrequestreview-501840443", "createdAt": "2020-10-05T08:45:48Z", "commit": {"oid": "203e37c08ba45832ee8fecc0b023b7dd0fc3f820"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo0NTo0OFrOHcTKdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo0NTo0OFrOHcTKdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQzNjE1MQ==", "bodyText": "The comparison check has been performed in the modifiedConfig.pipelinesAssociatedWithPackage method. Do we require it again.", "url": "https://github.com/gocd/gocd/pull/8610#discussion_r499436151", "createdAt": "2020-10-05T08:45:48Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/config/update/UpdatePackageConfigCommand.java", "diffHunk": "@@ -68,6 +75,17 @@ public boolean canContinue(CruiseConfig cruiseConfig) {\n         return isAuthorized() && isRepositoryPresent(cruiseConfig) && isIdSame() && isRequestFresh();\n     }\n \n+    private void updatePackageConfigurationOnAssociatedPipelines(CruiseConfig modifiedConfig) {\n+        List<PipelineConfig> pipelinesWithPackage = modifiedConfig.pipelinesAssociatedWithPackage(newPackage);\n+        pipelinesWithPackage.forEach(pipelineConfig -> {\n+            pipelineConfig.packageMaterialConfigs().forEach(packageMaterialConfig -> {\n+                if (packageMaterialConfig.getPackageId().equals(newPackage.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203e37c08ba45832ee8fecc0b023b7dd0fc3f820"}, "originalPosition": 45}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxODQwODIy", "url": "https://github.com/gocd/gocd/pull/8610#pullrequestreview-501840822", "createdAt": "2020-10-05T08:46:18Z", "commit": {"oid": "203e37c08ba45832ee8fecc0b023b7dd0fc3f820"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo0NjoxOVrOHcTLsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwODo0NjoxOVrOHcTLsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTQzNjQ2Ng==", "bodyText": "Same here: the check has performed in modifiedConfig.pipelinesAssociatedWithPackageRepository", "url": "https://github.com/gocd/gocd/pull/8610#discussion_r499436466", "createdAt": "2020-10-05T08:46:19Z", "author": {"login": "kritika-singh3"}, "path": "server/src/main/java/com/thoughtworks/go/config/update/UpdatePackageRepositoryCommand.java", "diffHunk": "@@ -50,16 +53,29 @@ public void update(CruiseConfig modifiedConfig) {\n         PackageRepositories repositories = modifiedConfig.getPackageRepositories();\n         repositories.replace(oldRepo, newRepo);\n         modifiedConfig.setPackageRepositories(repositories);\n+\n+        updatePackageRepositoryConfigurationOnAssociatedPipelines(modifiedConfig);\n     }\n \n     @Override\n     public boolean canContinue(CruiseConfig cruiseConfig) {\n         return super.canContinue(cruiseConfig) && isIdSame() && isRequestFresh();\n     }\n \n+    private void updatePackageRepositoryConfigurationOnAssociatedPipelines(CruiseConfig modifiedConfig) {\n+        List<PipelineConfig> pipelinesWithPackageRepo = modifiedConfig.pipelinesAssociatedWithPackageRepository(newRepo);\n+        pipelinesWithPackageRepo.forEach(pipelineConfig -> {\n+            pipelineConfig.packageMaterialConfigs().forEach(packageMaterialConfig -> {\n+                if (packageMaterialConfig.getPackageDefinition().getRepository().getId().equals(newRepo.getId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "203e37c08ba45832ee8fecc0b023b7dd0fc3f820"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f65386a49436e581efc3fffb4f0521f1b3a546ec", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/f65386a49436e581efc3fffb4f0521f1b3a546ec", "committedDate": "2020-10-05T09:30:38Z", "message": "Updated pipelines as part of SCM update #8542\n\n* For Pipelines with Pluggable SCM materials, any changes to the\n  global SCM configuration did not reflect on the SCM configuration\n  referred by pipeline. This commit updates the SCM configuration\n  on the pipeline on changes to the SCM."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48e07aed48dca75ddf2d13c753120f4ddab35690", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/48e07aed48dca75ddf2d13c753120f4ddab35690", "committedDate": "2020-10-05T09:30:46Z", "message": "Update pipelines as part of PackageRepo and Package update #8542\n\n* For pipelines with package materials, any changes to the package or\n  package repo did not reflect on the config referred by the pipleine.\n  This commit updates the package configs on the pipeline on changes\n  to the package/repo."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "203e37c08ba45832ee8fecc0b023b7dd0fc3f820", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/203e37c08ba45832ee8fecc0b023b7dd0fc3f820", "committedDate": "2020-10-05T06:59:52Z", "message": "Update pipelines as part of PackageRepo and Package update #8542\n\n* For pipelines with package materials, any changes to the package or\n  package repo did not reflect on the config referred by the pipleine.\n  This commit updates the package configs on the pipeline on changes\n  to the package/repo."}, "afterCommit": {"oid": "48e07aed48dca75ddf2d13c753120f4ddab35690", "author": {"user": {"login": "maheshp", "name": "Mahesh Panchaksharaiah"}}, "url": "https://github.com/gocd/gocd/commit/48e07aed48dca75ddf2d13c753120f4ddab35690", "committedDate": "2020-10-05T09:30:46Z", "message": "Update pipelines as part of PackageRepo and Package update #8542\n\n* For pipelines with package materials, any changes to the package or\n  package repo did not reflect on the config referred by the pipleine.\n  This commit updates the package configs on the pipeline on changes\n  to the package/repo."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTE2NDY4", "url": "https://github.com/gocd/gocd/pull/8610#pullrequestreview-501916468", "createdAt": "2020-10-05T10:22:45Z", "commit": {"oid": "48e07aed48dca75ddf2d13c753120f4ddab35690"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1840, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}