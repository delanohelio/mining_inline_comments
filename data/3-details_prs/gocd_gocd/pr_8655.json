{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNjg0MTg1", "number": 8655, "title": "Do not purge the config repo defined structures cache on polled fetch", "bodyText": "This fixes a UI flicker when a config repo widget is expanded. Previously, the\ndefined pipeline structure graph would quickly blank out, then reappear each time\nGoCD fetched config repo data on interval. This was caused by mithril redrawing\nan empty pipeline structures data cache (resulting in an empty graph with a loading\nmessage) followed only milliseconds later by a redraw when data was full again on\nfetch response. On most connections, even those that are relatively slow, this looks\nlike a UI \"glitch\" because it happens so quickly.\nEven though the caches were designed to not clear their contents on invalidate()\nprecisely to address this issue, it was happening anyway because a new cache object\nwas recreated on each fetch. This commit fixes this by persisting object caches over\nintervals for reuse. Data is still updated when it changes, but no longer flickers\nbecause the widget continues to display stale data while waiting for the API response\nuntil fresh data overwrites it upon response completion.\nHere's what I'm talking about (slowed down network so it can be seen on GIF, but imagine this happens much more quickly so it looks like a flash)", "createdAt": "2020-10-14T22:17:13Z", "url": "https://github.com/gocd/gocd/pull/8655", "merged": true, "mergeCommit": {"oid": "720a2fe626694cade5fccf55ef39d79dca6156f7"}, "closed": true, "closedAt": "2020-10-16T05:16:03Z", "author": {"login": "marques-work"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSkl9bgH2gAyNTAzNjg0MTg1OmJiYjM2ZWMxNDQ5MWVjMzcyNDNiZDQwY2Y5ZTNjNjY4MWU5NmJkYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS96WggFqTUwOTk4ODc1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbb36ec14491ec37243bd40cf9e3c6681e96bdb6", "author": {"user": {"login": "marques-work", "name": null}}, "url": "https://github.com/gocd/gocd/commit/bbb36ec14491ec37243bd40cf9e3c6681e96bdb6", "committedDate": "2020-10-14T22:05:55Z", "message": "Do not purge the config repo defined structures cache on polled fetch\n\nThis fixes a UI flicker when a config repo widget is expanded. Previously, the\ndefined pipeline structure graph would quickly blank out, then reappear each time\nGoCD fetched config repo data on interval. This was caused by mithril redrawing\nan empty pipeline structures data cache (resulting in an empty graph with a loading\nmessage) followed only milliseconds later by a redraw when data was full again on\nfetch response. On most connections, even those that are relatively slow, this looks\nlike a UI \"glitch\" because it happens so quickly.\n\nEven though the caches were designed to not clear their contents on `invalidate()`\nprecisely to address this issue, it was happening anyway because a new cache object\nwas recreated on each fetch. This commit fixes this by persisting object caches over\nintervals for reuse. Data is still updated when it changes, but no longer flickers\nbecause the widget continues to display stale data while waiting for the API response\nuntil fresh data overwrites it upon response completion."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4OTQyMDkw", "url": "https://github.com/gocd/gocd/pull/8655#pullrequestreview-508942090", "createdAt": "2020-10-15T05:15:00Z", "commit": {"oid": "bbb36ec14491ec37243bd40cf9e3c6681e96bdb6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNToxNTowMFrOHhxC9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQwNToxNTowMFrOHhxC9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTE2ODYyOQ==", "bodyText": "Adding another abstraction only because I like the idea of still allowing an explicit empty() if ever needed if subimplementations need to override markStale(). The data field is marked private and would be otherwise inaccessible in typescript.", "url": "https://github.com/gocd/gocd/pull/8655#discussion_r505168629", "createdAt": "2020-10-15T05:15:00Z", "author": {"login": "marques-work"}, "path": "server/src/main/webapp/WEB-INF/rails/webpack/models/base/cache.ts", "diffHunk": "@@ -88,10 +88,14 @@ export abstract class AbstractObjCache<T> implements ObjectCache<T> {\n   }\n \n   invalidate() {\n-    this.empty();\n+    this.markStale();\n     this.primed = false;\n   }\n \n+  protected markStale() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbb36ec14491ec37243bd40cf9e3c6681e96bdb6"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5OTg4NzUz", "url": "https://github.com/gocd/gocd/pull/8655#pullrequestreview-509988753", "createdAt": "2020-10-16T03:35:49Z", "commit": {"oid": "bbb36ec14491ec37243bd40cf9e3c6681e96bdb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1801, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}