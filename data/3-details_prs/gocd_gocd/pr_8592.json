{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkyMzE3MTg1", "number": 8592, "title": "Add secrets support elastic agent configurations", "bodyText": "Description:\nAdd support for secret params in elastic configurations (cluster profile and elastic agent profile).\nThe secrets will be resolved before sending the following plugin requests:\n\nvalidateClusterProfile\nvalidateElasticProfile\ncreateAgent\nserverPing\nshouldAssignWork\ngetPluginStatusReport\ngetClusterStatusReport\ngetAgentStatusReport\njobCompletion\nclusterProfilesChanged\n\nThe secret resolution will not be done before migrateConfig as the plugin settings need to be migrated to cluster profile as in i.e. without secret resolution.", "createdAt": "2020-09-24T09:36:28Z", "url": "https://github.com/gocd/gocd/pull/8592", "merged": true, "mergeCommit": {"oid": "75789b3bed09fbc43acf7848685a67ed8b0484d1"}, "closed": true, "closedAt": "2020-10-23T06:42:25Z", "author": {"login": "kritika-singh3"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOLyauAFqTUwMDAyNzAwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdVPJs2gH2gAyNDkyMzE3MTg1OjIxOTMwNzU2NTIzMDRjMzc2YTVlYjNjZGU5OTI2ODQ2NTA5M2ZhOWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwMDI3MDA4", "url": "https://github.com/gocd/gocd/pull/8592#pullrequestreview-500027008", "createdAt": "2020-10-01T05:57:06Z", "commit": {"oid": "7b09e0d6d4e9d27bb240fcd847ab906262bab330"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNTo1NzowNlrOHa7eQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQwNjozMzozNFrOHa8OqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzk5OTQyNQ==", "bodyText": "Will there be case wherein we want to add secure fields and not resolve them?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r497999425", "createdAt": "2020-10-01T05:57:06Z", "author": {"login": "maheshp"}, "path": "config/config-api/src/main/java/com/thoughtworks/go/domain/config/Configuration.java", "diffHunk": "@@ -158,10 +159,23 @@ public void addError(String fieldName, String message) {\n     }\n \n     public Map<String, String> getConfigurationAsMap(boolean addSecureFields) {\n+        return getConfigurationAsMap(addSecureFields, false);\n+    }\n+\n+\n+    /**\n+     * Returns the configuration values a map of key-value pair\n+     * @param addSecureFields should add secure fields\n+     * @param useResolvedValue should try to resolve any secret params found.\n+     * @throws UnresolvedSecretParamException if useResolvedValue is set to true and the secrets are not resolved\n+     * @return map of configs\n+     */\n+    public Map<String, String> getConfigurationAsMap(boolean addSecureFields, boolean useResolvedValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b09e0d6d4e9d27bb240fcd847ab906262bab330"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwNjc3Ng==", "bodyText": "If secrets resolution for one of the cluster profile fails, the plugin would not get a ping for any of the clusters.\nHow do we notify users in cases of secret resolution failures?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498006776", "createdAt": "2020-10-01T06:19:38Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -134,14 +139,15 @@ public void heartbeat() {\n \n         for (PluginDescriptor descriptor : elasticAgentPluginRegistry.getPlugins()) {\n             List<ClusterProfile> clusterProfiles = clusterProfilesService.getPluginProfiles().findByPluginId(descriptor.id());\n+            resolveSecrets(clusterProfiles);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwODYwOA==", "bodyText": "In what cases would the clusterProfile be null, I am guessing for the Azure plugin. Can you please check?\nReturning false in these conditions might break things?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498008608", "createdAt": "2020-10-01T06:24:47Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAwOTg3Mw==", "bodyText": "What happens when secret resolution fails and what should we do on failure?", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498009873", "createdAt": "2020-10-01T06:28:15Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -237,14 +244,15 @@ private void logToJobConsole(JobIdentifier identifier, String message) {\n     }\n \n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n-\n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n             return false;\n         }\n \n+        resolveSecrets(clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 111}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODAxMTgxNg==", "bodyText": "How do we handle secret resolution failures?\nWe are removing the job from jobCreationTimeMap before secrets are resolved. Will there be any repercussions of secret resolution failures after removing it from the map.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r498011816", "createdAt": "2020-10-01T06:33:34Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -311,9 +330,25 @@ public void jobCompleted(JobInstance job) {\n \n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-\n+        secretParamResolver.resolve(elasticProfile);\n+        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+        Map<String, String> clusterProfileConfiguration = emptyMap();\n+        if (clusterProfile != null) {\n+            secretParamResolver.resolve(clusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58dbf7e42e31c9d4a537ed970e47972bdf7f0344"}, "originalPosition": 168}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "356b37fa21296f146a5e5bbe2245b13c64e21c4e", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/356b37fa21296f146a5e5bbe2245b13c64e21c4e", "committedDate": "2020-09-24T09:31:55Z", "message": "Resolving secrets for `clusterProfileChanges`\n - secrets will be resolved for both original/older cluster profile and the updated/newer one"}, "afterCommit": {"oid": "4c45f5db78fa004a81e84fde5b6dcf12b35e1813", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/4c45f5db78fa004a81e84fde5b6dcf12b35e1813", "committedDate": "2020-10-06T04:34:34Z", "message": "Resolving secrets for `clusterProfileChanges`\n - secrets will be resolved for both original/older cluster profile and the updated/newer one"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9c0709677c437d6f91968d8c9e77695add27ddd2", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/9c0709677c437d6f91968d8c9e77695add27ddd2", "committedDate": "2020-10-06T10:00:54Z", "message": "Changes:\n - for createAgents and shouldAssign call: on secret failure - cancel the job. This is similar to wht we do for secret failure in pipelines\n - for job completed call - catch the rules related exception - add a server health message with a 5 minute timeout and log it\n - for heartbeat - catch the rules exception - add a server health message. This will get cleared up on a heartbeat call with the secrets fixed\n - for status reports - updated the controller to return 422 with the exception message"}, "afterCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/5e984a1d5a80eed9cf1fd5e77c025350866ea087", "committedDate": "2020-10-06T10:03:55Z", "message": "Changes:\n - for createAgents and shouldAssign call: on secret failure - cancel the job. This is similar to wht we do for secret failure in pipelines\n - for job completed call - catch the rules related exception - add a server health message with a 5 minute timeout and log it\n - for heartbeat - catch the rules exception - add a server health message. This will get cleared up on a heartbeat call with the secrets fixed\n - for status reports - updated the controller to return 422 with the exception message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NDUyNDAx", "url": "https://github.com/gocd/gocd/pull/8592#pullrequestreview-504452401", "createdAt": "2020-10-08T06:06:21Z", "commit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNjowNjoyMVrOHePMeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwNzoyMDo1NFrOHeRHUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODI4MQ==", "bodyText": "Change compile to implementation", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501468281", "createdAt": "2020-10-08T06:06:21Z", "author": {"login": "maheshp"}, "path": "api/api-secret-configs-v3/build.gradle", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2019 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: 'groovy'\n+\n+dependencies {\n+  compile project(':api:api-base')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ2ODM4Ng==", "bodyText": "Change testCompile to testImplementation", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501468386", "createdAt": "2020-10-08T06:06:39Z", "author": {"login": "maheshp"}, "path": "api/api-secret-configs-v3/build.gradle", "diffHunk": "@@ -0,0 +1,26 @@\n+/*\n+ * Copyright 2019 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+apply plugin: 'groovy'\n+\n+dependencies {\n+  compile project(':api:api-base')\n+\n+  testCompile project(path: ':api:api-base', configuration: 'testOutput')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3MzYzNw==", "bodyText": "As discussed we need to add a server health message if secret resolution fails and log it as well.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501473637", "createdAt": "2020-10-08T06:21:19Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "diffHunk": "@@ -22,47 +22,59 @@\n import com.thoughtworks.go.listener.ConfigChangedListener;\n import com.thoughtworks.go.listener.EntityConfigChangedListener;\n import com.thoughtworks.go.plugin.access.elastic.ElasticAgentPluginRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import java.util.Map;\n+\n @Component\n public class ClusterProfilesChangedPluginNotifier extends EntityConfigChangedListener<ClusterProfile> implements ConfigChangedListener {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClusterProfilesChangedPluginNotifier.class);\n     private ClusterProfiles existingClusterProfiles;\n     private ElasticAgentPluginRegistry registry;\n+    private final SecretParamResolver secretParamResolver;\n     private GoConfigService goConfigService;\n \n     @Autowired\n-    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry) {\n+    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry, SecretParamResolver secretParamResolver) {\n         this.goConfigService = goConfigService;\n         this.existingClusterProfiles = goConfigService.getElasticConfig().getClusterProfiles();\n         this.registry = registry;\n+        this.secretParamResolver = secretParamResolver;\n         goConfigService.register(this);\n     }\n \n     @Override\n     public void onEntityConfigChange(ClusterProfile updatedClusterProfile) {\n+        LOGGER.debug(\"Resolving the updated cluster profile {} for secrets\", updatedClusterProfile);\n+        secretParamResolver.resolve(updatedClusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ3NDI1Mg==", "bodyText": "Resolving secrets for updated cluster profile: {}", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501474252", "createdAt": "2020-10-08T06:22:59Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ClusterProfilesChangedPluginNotifier.java", "diffHunk": "@@ -22,47 +22,59 @@\n import com.thoughtworks.go.listener.ConfigChangedListener;\n import com.thoughtworks.go.listener.EntityConfigChangedListener;\n import com.thoughtworks.go.plugin.access.elastic.ElasticAgentPluginRegistry;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n import org.springframework.beans.factory.annotation.Autowired;\n import org.springframework.stereotype.Component;\n \n+import java.util.Map;\n+\n @Component\n public class ClusterProfilesChangedPluginNotifier extends EntityConfigChangedListener<ClusterProfile> implements ConfigChangedListener {\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ClusterProfilesChangedPluginNotifier.class);\n     private ClusterProfiles existingClusterProfiles;\n     private ElasticAgentPluginRegistry registry;\n+    private final SecretParamResolver secretParamResolver;\n     private GoConfigService goConfigService;\n \n     @Autowired\n-    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry) {\n+    public ClusterProfilesChangedPluginNotifier(GoConfigService goConfigService, ElasticAgentPluginRegistry registry, SecretParamResolver secretParamResolver) {\n         this.goConfigService = goConfigService;\n         this.existingClusterProfiles = goConfigService.getElasticConfig().getClusterProfiles();\n         this.registry = registry;\n+        this.secretParamResolver = secretParamResolver;\n         goConfigService.register(this);\n     }\n \n     @Override\n     public void onEntityConfigChange(ClusterProfile updatedClusterProfile) {\n+        LOGGER.debug(\"Resolving the updated cluster profile {} for secrets\", updatedClusterProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ4MjE4Mg==", "bodyText": "Guess we need to fail the job, not cancel. We fail in case of BuildAssignmentService as well.\nThe message needs to be update appropriately.\nYou will also need to add a message on the JobStatusTopic so that the JobStatusListener is called.\nAlso, I think the resolveSecrets methods should only resolve the secrets and not handle the errors. Let the callers handle exception and take necessary actions.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501482182", "createdAt": "2020-10-08T06:43:04Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -308,12 +323,73 @@ public void jobCompleted(JobInstance job) {\n \n         String pluginId = agentInstance.elasticAgentMetadata().elasticPluginId();\n         String elasticAgentId = agentInstance.elasticAgentMetadata().elasticAgentId();\n-\n+        JobIdentifier jobIdentifier = job.getIdentifier();\n         ElasticProfile elasticProfile = job.getPlan().getElasticProfile();\n         ClusterProfile clusterProfile = job.getPlan().getClusterProfile();\n-        Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true);\n-        Map<String, String> clusterProfileConfiguration = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n+        try {\n+            secretParamResolver.resolve(elasticProfile);\n+            Map<String, String> elasticProfileConfiguration = elasticProfile.getConfigurationAsMap(true, true);\n+            Map<String, String> clusterProfileConfiguration = emptyMap();\n+            if (clusterProfile != null) {\n+                secretParamResolver.resolve(clusterProfile);\n+                clusterProfileConfiguration = clusterProfile.getConfigurationAsMap(true, true);\n+            }\n+            elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, jobIdentifier, elasticProfileConfiguration, clusterProfileConfiguration);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"The job completion call to the plugin for the job identifier [%s] failed for secrets resolution: %s \", jobIdentifier.toString(), e.getMessage());\n+            ServerHealthState healthState = error(\"Failed to notify plugin\", description, general(scopeForJob(jobIdentifier)));\n+            healthState.setTimeout(Timeout.FIVE_MINUTES);\n+            serverHealthService.update(healthState);\n+            LOGGER.error(description);\n+        }\n+    }\n+\n+    private void logToJobConsole(JobIdentifier identifier, String message) {\n+        try {\n+            consoleService.appendToConsoleLog(identifier, message);\n+        } catch (IllegalArtifactLocationException | IOException e) {\n+            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n+        }\n+    }\n+\n+    private Predicate<JobPlan> isElasticAgent() {\n+        return JobPlan::requiresElasticAgent;\n+    }\n+\n+    private HealthStateScope scope(String pluginId) {\n+        return HealthStateScope.aboutPlugin(pluginId, \"missingPlugin\");\n+    }\n+\n+    @NotNull\n+    private HealthStateScope scopeForJob(JobIdentifier jobIdentifier) {\n+        return forJob(jobIdentifier.getPipelineName(), jobIdentifier.getStageName(), jobIdentifier.getBuildName());\n+    }\n+\n+    private boolean resolveSecrets(String pluginId, List<ClusterProfile> clusterProfiles) {\n+        try {\n+            for (ClusterProfile clusterProfile : clusterProfiles) {\n+                secretParamResolver.resolve(clusterProfile);\n+            }\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String description = format(\"Secrets resolution failed for cluster profile associated with plugin [%s]: %s \", pluginId, e.getMessage());\n+            serverHealthService.update(error(format(\"Ping failed for '%s' plugin\", pluginId), description, general(scope(pluginId))));\n+            LOGGER.error(description);\n+            return false;\n+        }\n+        return true;\n+    }\n \n-        elasticAgentPluginRegistry.reportJobCompletion(pluginId, elasticAgentId, job.getIdentifier(), elasticProfileConfiguration, clusterProfileConfiguration);\n+    private boolean resolveSecrets(JobIdentifier jobIdentifier, ClusterProfile clusterProfile, ElasticProfile elasticProfile) {\n+        try {\n+            if (clusterProfile != null)\n+                secretParamResolver.resolve(clusterProfile);\n+            secretParamResolver.resolve(elasticProfile);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            String cancellationMessage = format(\"\\nThis job was cancelled by GoCD. This job is configured to run on an elastic agent, but the associated elastic configurations failed for secrets resolution: %s\", e.getMessage());\n+            logToJobConsole(jobIdentifier, cancellationMessage);\n+            scheduleService.cancelJob(jobIdentifier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 324}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5MTE4Mw==", "bodyText": "It seems wrong for the shouldAssignWork method cancelling the job here. I think the caller of this method should handle the secret resolution exceptions and take necessary actions.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501491183", "createdAt": "2020-10-08T07:03:34Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ElasticAgentPluginService.java", "diffHunk": "@@ -193,68 +201,70 @@ public void createAgentsFor(List<JobPlan> old, List<JobPlan> newPlan) {\n         jobsThatRequireAgent.addAll(Sets.difference(new HashSet<>(newPlan), new HashSet<>(old)));\n         jobsThatRequireAgent.addAll(starvingJobs);\n \n-        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(Collectors.toList());\n+        List<JobPlan> plansThatRequireElasticAgent = jobsThatRequireAgent.stream().filter(isElasticAgent()).collect(toList());\n //      messageTimeToLive is lesser than the starvation threshold to ensure there are no duplicate create agent message\n         long messageTimeToLive = goConfigService.elasticJobStarvationThreshold() - 10000;\n \n         for (JobPlan plan : plansThatRequireElasticAgent) {\n             jobCreationTimeMap.put(plan.getJobId(), timeProvider.currentTimeMillis());\n             ElasticProfile elasticProfile = plan.getElasticProfile();\n             ClusterProfile clusterProfile = plan.getClusterProfile();\n+            JobIdentifier jobIdentifier = plan.getIdentifier();\n             if (clusterProfile == null) {\n                 String cancellationMessage = \"\\nThis job was cancelled by GoCD. The version of your GoCD server requires elastic profiles to be associated with a cluster(required from Version 19.3.0). \" +\n                         \"This job is configured to run on an Elastic Agent, but the associated elastic profile does not have information about the cluster.  \\n\\n\" +\n                         \"The possible reason for the missing cluster information on the elastic profile could be, an upgrade of the GoCD server to a version >= 19.3.0 before the completion of the job.\\n\\n\" +\n                         \"A re-run of this job should fix this issue.\";\n-                logToJobConsole(plan.getIdentifier(), cancellationMessage);\n-                scheduleService.cancelJob(plan.getIdentifier());\n+                logToJobConsole(jobIdentifier, cancellationMessage);\n+                scheduleService.cancelJob(jobIdentifier);\n             } else if (elasticAgentPluginRegistry.has(clusterProfile.getPluginId())) {\n                 String environment = environmentConfigService.envForPipeline(plan.getPipelineName());\n-                createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, plan.getIdentifier()), messageTimeToLive);\n-                serverHealthService.removeByScope(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()));\n+                boolean secretsResolved = resolveSecrets(jobIdentifier, clusterProfile, elasticProfile);\n+                if (secretsResolved) {\n+                    createAgentQueue.post(new CreateAgentMessage(ephemeralAutoRegisterKeyService.autoRegisterKey(), environment, elasticProfile, clusterProfile, jobIdentifier), messageTimeToLive);\n+                    serverHealthService.removeByScope(scopeForJob(jobIdentifier));\n+                }\n             } else {\n-                String jobConfigIdentifier = plan.getIdentifier().jobConfigIdentifier().toString();\n+                String jobConfigIdentifier = jobIdentifier.jobConfigIdentifier().toString();\n                 String description = format(\"Plugin [%s] associated with %s is missing. Either the plugin is not \" +\n                         \"installed or could not be registered. Please check plugins tab \" +\n                         \"and server logs for more details.\", clusterProfile.getPluginId(), jobConfigIdentifier);\n-                serverHealthService.update(ServerHealthState.error(format(\"Unable to find agent for %s\",\n-                        jobConfigIdentifier), description, HealthStateType.general(HealthStateScope.forJob(plan.getIdentifier().getPipelineName(), plan.getIdentifier().getStageName(), plan.getIdentifier().getBuildName()))));\n+                serverHealthService.update(error(format(\"Unable to find agent for %s\",\n+                        jobConfigIdentifier), description, general(scopeForJob(jobIdentifier))));\n                 LOGGER.error(description);\n             }\n         }\n     }\n \n-    private void logToJobConsole(JobIdentifier identifier, String message) {\n-        try {\n-            consoleService.appendToConsoleLog(identifier, message);\n-        } catch (IllegalArtifactLocationException | IOException e) {\n-            LOGGER.error(format(\"Failed to add message(%s) to the job(%s) console\", message, identifier), e);\n-        }\n-    }\n-\n-    private Predicate<JobPlan> isElasticAgent() {\n-        return JobPlan::requiresElasticAgent;\n-    }\n-\n     public boolean shouldAssignWork(ElasticAgentMetadata metadata, String environment, ElasticProfile elasticProfile, ClusterProfile clusterProfile, JobIdentifier identifier) {\n-        Map<String, String> clusterProfileProperties = clusterProfile != null ? clusterProfile.getConfigurationAsMap(true) : Collections.EMPTY_MAP;\n-        GoPluginDescriptor pluginDescriptor = pluginManager.getPluginDescriptorFor(metadata.elasticPluginId());\n-        Map<String, String> configuration = elasticProfile.getConfigurationAsMap(true);\n+        if (clusterProfile == null || !StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+            return false;\n+        }\n \n-        if (!StringUtils.equals(clusterProfile.getPluginId(), metadata.elasticPluginId())) {\n+        boolean secretsResolved = resolveSecrets(identifier, clusterProfile, elasticProfile);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTQ5OTcyOQ==", "bodyText": "This should not be 422, it's not a user error.", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r501499729", "createdAt": "2020-10-08T07:20:54Z", "author": {"login": "maheshp"}, "path": "spark/spark-spa/src/main/java/com/thoughtworks/go/spark/spa/StatusReportsController.java", "diffHunk": "@@ -91,6 +93,9 @@ public ModelAndView pluginStatusReport(Request request, Response response) {\n         } catch (UnsupportedOperationException e) {\n             String message = String.format(\"Status Report for plugin with id: '%s' is not found.\", pluginId);\n             return errorPage(response, 404, \"Plugin Status Report\", message);\n+        } catch (RulesViolationException | SecretResolutionFailureException e) {\n+            LOGGER.error(e.getMessage(), e);\n+            return errorPage(response, 422, \"Plugin Status Report\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087"}, "originalPosition": 15}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e984a1d5a80eed9cf1fd5e77c025350866ea087", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/5e984a1d5a80eed9cf1fd5e77c025350866ea087", "committedDate": "2020-10-06T10:03:55Z", "message": "Changes:\n - for createAgents and shouldAssign call: on secret failure - cancel the job. This is similar to wht we do for secret failure in pipelines\n - for job completed call - catch the rules related exception - add a server health message with a 5 minute timeout and log it\n - for heartbeat - catch the rules exception - add a server health message. This will get cleared up on a heartbeat call with the secrets fixed\n - for status reports - updated the controller to return 422 with the exception message"}, "afterCommit": {"oid": "f74ccc061beb3d3b35c43dbcd83311494ea9270a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/f74ccc061beb3d3b35c43dbcd83311494ea9270a", "committedDate": "2020-10-08T10:35:45Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f74ccc061beb3d3b35c43dbcd83311494ea9270a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/f74ccc061beb3d3b35c43dbcd83311494ea9270a", "committedDate": "2020-10-08T10:35:45Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message"}, "afterCommit": {"oid": "82f68251d6e8de06149ec9565ac4201b5cee04b1", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/82f68251d6e8de06149ec9565ac4201b5cee04b1", "committedDate": "2020-10-08T10:44:02Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message\n - Also send 500 instead of 422 for status controllers in case of error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "82f68251d6e8de06149ec9565ac4201b5cee04b1", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/82f68251d6e8de06149ec9565ac4201b5cee04b1", "committedDate": "2020-10-08T10:44:02Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message\n - Also send 500 instead of 422 for status controllers in case of error"}, "afterCommit": {"oid": "b1391ecb98e81ed0a7171fe92a42daa83d4e8ebd", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/b1391ecb98e81ed0a7171fe92a42daa83d4e8ebd", "committedDate": "2020-10-12T11:12:55Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message\n - Also send 500 instead of 422 for status controllers in case of error"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b1391ecb98e81ed0a7171fe92a42daa83d4e8ebd", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/b1391ecb98e81ed0a7171fe92a42daa83d4e8ebd", "committedDate": "2020-10-12T11:12:55Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message\n - Also send 500 instead of 422 for status controllers in case of error"}, "afterCommit": {"oid": "a0de943362b91b97c746558bcd66d4abd505db12", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/a0de943362b91b97c746558bcd66d4abd505db12", "committedDate": "2020-10-15T03:43:25Z", "message": "Update internal api to render autocomplete suggestion on secret config spa"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzMzQ0MjIz", "url": "https://github.com/gocd/gocd/pull/8592#pullrequestreview-513344223", "createdAt": "2020-10-21T06:31:32Z", "commit": {"oid": "a0de943362b91b97c746558bcd66d4abd505db12"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozMTozMlrOHlcJ0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQwNjozMTozMlrOHlcJ0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTAyMDYyNA==", "bodyText": "This job was failed by GoCD. This job is configured to run on an elastic agent, there were errors while resolving secrets for the the associated elastic configurations.\nReasons: blah blah blah", "url": "https://github.com/gocd/gocd/pull/8592#discussion_r509020624", "createdAt": "2020-10-21T06:31:32Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/BuildAssignmentService.java", "diffHunk": "@@ -202,9 +202,18 @@ JobPlan findMatchingJob(AgentInstance agent) {\n             match = agent.firstMatching(filteredJobPlans);\n         } else {\n             for (JobPlan jobPlan : filteredJobPlans) {\n-                if (jobPlan.requiresElasticAgent() && elasticAgentPluginService.shouldAssignWork(agent.elasticAgentMetadata(), environmentConfigService.envForPipeline(jobPlan.getPipelineName()), jobPlan.getElasticProfile(), jobPlan.getClusterProfile(), jobPlan.getIdentifier())) {\n-                    match = jobPlan;\n-                    break;\n+                try {\n+                    if (jobPlan.requiresElasticAgent() && elasticAgentPluginService.shouldAssignWork(agent.elasticAgentMetadata(), environmentConfigService.envForPipeline(jobPlan.getPipelineName()), jobPlan.getElasticProfile(), jobPlan.getClusterProfile(), jobPlan.getIdentifier())) {\n+                        match = jobPlan;\n+                        break;\n+                    }\n+                } catch (RulesViolationException | SecretResolutionFailureException e) {\n+                    JobInstance instance = jobInstanceService.buildById(jobPlan.getJobId());\n+                    JobIdentifier jobIdentifier = jobPlan.getIdentifier();\n+                    String failureMessage = format(\"\\nThis job was failed by GoCD. This job is configured to run on an elastic agent, but the associated elastic configurations failed for secrets resolution: %s\", e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a0de943362b91b97c746558bcd66d4abd505db12"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcc23fd6ff15837a152997ff910eb6ece567a238", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/bcc23fd6ff15837a152997ff910eb6ece567a238", "committedDate": "2020-10-23T03:39:30Z", "message": "Update:\n - SecretConfig to accept entity of type `cluster_profile`\n - Added method in RulesService to validate secret params in elastic configurations\n - Added method in SecretParamResolver to validate and resolve secret params in elastic configurations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0342c98cded347c2ca160e756c4989ce4ad45418", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/0342c98cded347c2ca160e756c4989ce4ad45418", "committedDate": "2020-10-23T03:39:30Z", "message": "Adding support for secrets in elastic configurations\n\n - Validating and resolving secrets related to cluster profile and elastic profile before sending the values to the plugin\n - All except `migrateConfig` and `clusterProfileChanged` - would attempt secret resolution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2793f5ac9006756e4cbc9a80018d4a1349dbbe5c", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/2793f5ac9006756e4cbc9a80018d4a1349dbbe5c", "committedDate": "2020-10-23T03:39:30Z", "message": "Upgrade secret configs api to v3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a684f8e1be55732e424b82ec20ff9b10089da79d", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/a684f8e1be55732e424b82ec20ff9b10089da79d", "committedDate": "2020-10-23T03:39:30Z", "message": "Update secret config spa to support cluster_profile as valid rule type\nAlso update the elastic page modals to show the errors from rules validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50147682887347c01fbf423a3694f12f3205ffc2", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/50147682887347c01fbf423a3694f12f3205ffc2", "committedDate": "2020-10-23T03:39:30Z", "message": "Resolving secrets for `clusterProfileChanges`\n - secrets will be resolved for both original/older cluster profile and the updated/newer one"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16b102f795808f2aa9da8a23986aec87e069840c", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/16b102f795808f2aa9da8a23986aec87e069840c", "committedDate": "2020-10-23T03:39:30Z", "message": "Changes:\n - for createAgents and shouldAssign call: on secret failure - cancel the job. This is similar to wht we do for secret failure in pipelines\n - for job completed call - catch the rules related exception - add a server health message with a 5 minute timeout and log it\n - for heartbeat - catch the rules exception - add a server health message. This will get cleared up on a heartbeat call with the secrets fixed\n - for status reports - updated the controller to return 422 with the exception message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b94bf04bd41918783f267f05ae00fa736de1c93", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/2b94bf04bd41918783f267f05ae00fa736de1c93", "committedDate": "2020-10-23T03:39:31Z", "message": "Changes:\n - Don't handle exception for shouldAssign in elastic service. Let build assignment service handle it\n - for create agent - fail the job rather than cancelling it. Also post a message on job status topic\n - same goes for shouldAssign as well\n - For cluster profile changed notification call to plugin: catch the exception and add a timeout based server health message\n - Also send 500 instead of 422 for status controllers in case of error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "184c7cbcfbeabe576f9851f9bff84978bd48a716", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/184c7cbcfbeabe576f9851f9bff84978bd48a716", "committedDate": "2020-10-23T03:39:31Z", "message": "Update internal api to render autocomplete suggestion on secret config spa"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0de943362b91b97c746558bcd66d4abd505db12", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/a0de943362b91b97c746558bcd66d4abd505db12", "committedDate": "2020-10-15T03:43:25Z", "message": "Update internal api to render autocomplete suggestion on secret config spa"}, "afterCommit": {"oid": "184c7cbcfbeabe576f9851f9bff84978bd48a716", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/184c7cbcfbeabe576f9851f9bff84978bd48a716", "committedDate": "2020-10-23T03:39:31Z", "message": "Update internal api to render autocomplete suggestion on secret config spa"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2193075652304c376a5eb3cde99268465093fa9f", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/2193075652304c376a5eb3cde99268465093fa9f", "committedDate": "2020-10-23T04:48:49Z", "message": "Update the console log message when a job is failed due to secret resolution failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1830, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}