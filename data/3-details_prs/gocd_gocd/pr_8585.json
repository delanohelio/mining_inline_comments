{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkxNTAzOTE5", "number": 8585, "title": "Use jobTimeout to cancel unassigned jobs", "bodyText": "Issue: #1926\nDescription:\n\nEarlier only the building jobs could be cancelled post a timeout set via jobTimeout property.\nNow, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing", "createdAt": "2020-09-23T04:11:39Z", "url": "https://github.com/gocd/gocd/pull/8585", "merged": true, "mergeCommit": {"oid": "adceb8d0ec49b8ff631ceb8951c3d655fb394a62"}, "closed": true, "closedAt": "2020-09-23T10:21:58Z", "author": {"login": "kritika-singh3"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLnGBwgBqjM3OTY1NjE1NDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLpgTyABqjM3OTcyNDczMjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e9edae737ff602dfdf395febbbe4f0c7bf95247c", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/e9edae737ff602dfdf395febbbe4f0c7bf95247c", "committedDate": "2020-09-23T03:23:23Z", "message": "Use jobTimeout to cancel unassigned jobs\n\n - Earlier only the building jobs could be cancelled post a timeout set via `jobTimeout` property.\n   Now, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing"}, "afterCommit": {"oid": "fa7f9f993b0e7b91fbcde25c037de0292c06c42a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/fa7f9f993b0e7b91fbcde25c037de0292c06c42a", "committedDate": "2020-09-23T07:03:06Z", "message": "Use jobTimeout to cancel unassigned jobs\n\n - Earlier only the building jobs could be cancelled post a timeout set via `jobTimeout` property.\n   Now, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0MzM0Nzg1", "url": "https://github.com/gocd/gocd/pull/8585#pullrequestreview-494334785", "createdAt": "2020-09-23T07:21:00Z", "commit": {"oid": "fa7f9f993b0e7b91fbcde25c037de0292c06c42a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzoyMTowMFrOHWZvMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QwNzoyMTowMFrOHWZvMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MzI1MjQwMA==", "bodyText": "Should we remove warning only if the jobScheduledMap has the identifier. Just wanted to make sure we do not clear out warnings added through jobLastActivityMap", "url": "https://github.com/gocd/gocd/pull/8585#discussion_r493252400", "createdAt": "2020-09-23T07:21:00Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConsoleActivityMonitor.java", "diffHunk": "@@ -124,6 +139,59 @@ private long jobTerminationThreshold(JobIdentifier jobIdentifier) {\n         return goConfigService.getUnresponsiveJobTerminationThreshold(jobIdentifier);\n     }\n \n+    private interface LogMessages {\n+        String consoleMessage(String difference);\n+\n+        String hungWarningMessage(String buildLocator, String namespacedJob, String difference);\n+    }\n+\n+    private LogMessages scheduledJobMessages() {\n+        return new LogMessages() {\n+            @Override\n+            public String consoleMessage(String difference) {\n+                return format(\"Go cancelled this job as it was not assigned an agent for more than %s minute(s)\", difference);\n+            }\n+\n+            @Override\n+            public String hungWarningMessage(String buildLocator, String namespacedJob, String difference) {\n+                return format(\"Job <a href='/go/tab/build/detail/%s'>%s</a> is currently running but was not assigned an agent in the last %s minute(s). This job may be hung.\", buildLocator, namespacedJob, difference);\n+            }\n+        };\n+    }\n+\n+    private LogMessages runningJobMessages() {\n+        return new LogMessages() {\n+            @Override\n+            public String consoleMessage(String difference) {\n+                return format(\"Go cancelled this job as it has not shown any console activity for more than %s minute(s)\", difference);\n+            }\n+\n+            @Override\n+            public String hungWarningMessage(String buildLocator, String namespacedJob, String difference) {\n+                return format(\"Job <a href='/go/tab/build/detail/%s'>%s</a> is currently running but has not shown any console activity in the last %s minute(s). This job may be hung.\", buildLocator, namespacedJob, difference);\n+            }\n+        };\n+    }\n+\n+    static final class ScheduledJobListener implements JobStatusListener {\n+        private final ConsoleActivityMonitor consoleActivityMonitor;\n+\n+        private ScheduledJobListener(ConsoleActivityMonitor consoleActivityMonitor) {\n+            this.consoleActivityMonitor = consoleActivityMonitor;\n+        }\n+\n+        @Override\n+        public void jobStatusChanged(JobInstance job) {\n+            JobIdentifier identifier = job.getIdentifier();\n+            if (job.getState().isScheduled()) {\n+                consoleActivityMonitor.jobScheduledMap.putIfAbsent(identifier, consoleActivityMonitor.timeProvider.currentTimeMillis());\n+            } else if (job.getState().isActiveOnAgent() || job.isCompleted()) {\n+                consoleActivityMonitor.jobScheduledMap.remove(identifier);\n+                consoleActivityMonitor.removeHungJobWarning(identifier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fa7f9f993b0e7b91fbcde25c037de0292c06c42a"}, "originalPosition": 184}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c073c7338046a145616e138580c6ba6b6555f8c5", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c073c7338046a145616e138580c6ba6b6555f8c5", "committedDate": "2020-09-23T09:51:38Z", "message": "Use jobTimeout to cancel unassigned jobs\n\n - Earlier only the building jobs could be cancelled post a timeout set via `jobTimeout` property.\n   Now, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa7f9f993b0e7b91fbcde25c037de0292c06c42a", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/fa7f9f993b0e7b91fbcde25c037de0292c06c42a", "committedDate": "2020-09-23T07:03:06Z", "message": "Use jobTimeout to cancel unassigned jobs\n\n - Earlier only the building jobs could be cancelled post a timeout set via `jobTimeout` property.\n   Now, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing"}, "afterCommit": {"oid": "c073c7338046a145616e138580c6ba6b6555f8c5", "author": {"user": {"login": "kritika-singh3", "name": "Kritika"}}, "url": "https://github.com/gocd/gocd/commit/c073c7338046a145616e138580c6ba6b6555f8c5", "committedDate": "2020-09-23T09:51:38Z", "message": "Use jobTimeout to cancel unassigned jobs\n\n - Earlier only the building jobs could be cancelled post a timeout set via `jobTimeout` property.\n   Now, using the same value, unassigned jobs will be cancelled.\n\nP.S. the original feature is still in place. This is additional feature over the existing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1824, "cost": 1, "resetAt": "2021-11-01T14:20:25Z"}}}