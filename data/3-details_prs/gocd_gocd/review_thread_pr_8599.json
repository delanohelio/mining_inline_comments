{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkzNTc3NzI1", "number": 8599, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNjoxMjo0M1rOEoYkCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDozODoxMVrOEo-LGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEwNzgwOTM5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNjoxMjo0M1rOHZcTKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOVQwNjo0OToyNFrOHZdPWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0MDEwNQ==", "bodyText": "@GaneshSPatil with this check, in cases where multiple ConfigRepo plugins are used none of the repos will be parsed if a single plugin is missing. Guess this was not intended.", "url": "https://github.com/gocd/gocd/pull/8599#discussion_r496440105", "createdAt": "2020-09-29T06:12:43Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.thoughtworks.go.config.CruiseConfig;\n+import com.thoughtworks.go.config.GoConfigRepoConfigDataSource;\n+import com.thoughtworks.go.config.materials.MaterialConfigs;\n+import com.thoughtworks.go.config.materials.Materials;\n+import com.thoughtworks.go.config.remote.ConfigRepoConfig;\n+import com.thoughtworks.go.config.rules.RuleAwarePluginProfile;\n+import com.thoughtworks.go.domain.MaterialInstance;\n+import com.thoughtworks.go.domain.MaterialRevisions;\n+import com.thoughtworks.go.domain.materials.Material;\n+import com.thoughtworks.go.domain.materials.MaterialConfig;\n+import com.thoughtworks.go.domain.materials.Modification;\n+import com.thoughtworks.go.listener.ConfigChangedListener;\n+import com.thoughtworks.go.plugin.infra.PluginChangeListener;\n+import com.thoughtworks.go.plugin.infra.PluginManager;\n+import com.thoughtworks.go.plugin.infra.plugininfo.GoPluginDescriptor;\n+import com.thoughtworks.go.server.initializers.Initializer;\n+import com.thoughtworks.go.server.persistence.MaterialRepository;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.thoughtworks.go.plugin.domain.common.PluginConstants.CONFIG_REPO_EXTENSION;\n+\n+/**\n+ * @understands initializing config repositories. Loads the configurations from the last checked out modification on server startup.\n+ */\n+@Service\n+public class ConfigRepositoryInitializer implements ConfigChangedListener, PluginChangeListener, Initializer {\n+    private PluginManager pluginManager;\n+    private final ConfigRepoService configRepoService;\n+    private final MaterialRepository materialRepository;\n+    private final GoConfigRepoConfigDataSource goConfigRepoConfigDataSource;\n+    private GoConfigService goConfigService;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigRepositoryInitializer.class);\n+\n+    private boolean isConfigLoaded = false;\n+    private boolean hasConfigRepoInitializationCompleted = false;\n+    private List<String> loadedConfigRepoPlugins = new ArrayList<>();\n+\n+    @Autowired\n+    public ConfigRepositoryInitializer(PluginManager pluginManager, ConfigRepoService configRepoService, MaterialRepository materialRepository, GoConfigRepoConfigDataSource goConfigRepoConfigDataSource, GoConfigService goConfigService) {\n+        this.pluginManager = pluginManager;\n+        this.configRepoService = configRepoService;\n+        this.materialRepository = materialRepository;\n+        this.goConfigRepoConfigDataSource = goConfigRepoConfigDataSource;\n+        this.goConfigService = goConfigService;\n+\n+        this.pluginManager.addPluginChangeListener(this);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        this.goConfigService.register(this);\n+    }\n+\n+    @Override\n+    public void startDaemon() {\n+    }\n+\n+    @Override\n+    public void onConfigChange(CruiseConfig newCruiseConfig) {\n+        // mark config loaded only once!\n+        if (!this.isConfigLoaded) {\n+            this.isConfigLoaded = true;\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginLoaded(GoPluginDescriptor pluginDescriptor) {\n+        String pluginId = pluginDescriptor.id();\n+        boolean isConfigRepoPlugin = pluginManager.isPluginOfType(CONFIG_REPO_EXTENSION, pluginId);\n+\n+        if (isConfigRepoPlugin) {\n+            this.loadedConfigRepoPlugins.add(pluginId);\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginUnLoaded(GoPluginDescriptor pluginDescriptor) {\n+        //do nothing\n+    }\n+\n+    private void initializeConfigRepositories() {\n+        // return if config repositories have already been initialized.\n+        if (this.hasConfigRepoInitializationCompleted) {\n+            return;\n+        }\n+\n+        // do nothing if the cruise config is not loaded yet..\n+        if (!this.isConfigLoaded) {\n+            return;\n+        }\n+\n+        List<String> inUseConfigRepoPlugins = this.configRepoService.getConfigRepos().stream().map(RuleAwarePluginProfile::getPluginId).collect(Collectors.toList());\n+        if (this.loadedConfigRepoPlugins.containsAll(inUseConfigRepoPlugins)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "73fe5f07156a5b276d3754b5dca88559613ebd78"}, "originalPosition": 121}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ1NTUxNA==", "bodyText": "@maheshp - yes, you're right. Will change this check to process the config repositories as and when plugins are laoded.", "url": "https://github.com/gocd/gocd/pull/8599#discussion_r496455514", "createdAt": "2020-09-29T06:49:24Z", "author": {"login": "GaneshSPatil"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "diffHunk": "@@ -0,0 +1,150 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.thoughtworks.go.config.CruiseConfig;\n+import com.thoughtworks.go.config.GoConfigRepoConfigDataSource;\n+import com.thoughtworks.go.config.materials.MaterialConfigs;\n+import com.thoughtworks.go.config.materials.Materials;\n+import com.thoughtworks.go.config.remote.ConfigRepoConfig;\n+import com.thoughtworks.go.config.rules.RuleAwarePluginProfile;\n+import com.thoughtworks.go.domain.MaterialInstance;\n+import com.thoughtworks.go.domain.MaterialRevisions;\n+import com.thoughtworks.go.domain.materials.Material;\n+import com.thoughtworks.go.domain.materials.MaterialConfig;\n+import com.thoughtworks.go.domain.materials.Modification;\n+import com.thoughtworks.go.listener.ConfigChangedListener;\n+import com.thoughtworks.go.plugin.infra.PluginChangeListener;\n+import com.thoughtworks.go.plugin.infra.PluginManager;\n+import com.thoughtworks.go.plugin.infra.plugininfo.GoPluginDescriptor;\n+import com.thoughtworks.go.server.initializers.Initializer;\n+import com.thoughtworks.go.server.persistence.MaterialRepository;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+import static com.thoughtworks.go.plugin.domain.common.PluginConstants.CONFIG_REPO_EXTENSION;\n+\n+/**\n+ * @understands initializing config repositories. Loads the configurations from the last checked out modification on server startup.\n+ */\n+@Service\n+public class ConfigRepositoryInitializer implements ConfigChangedListener, PluginChangeListener, Initializer {\n+    private PluginManager pluginManager;\n+    private final ConfigRepoService configRepoService;\n+    private final MaterialRepository materialRepository;\n+    private final GoConfigRepoConfigDataSource goConfigRepoConfigDataSource;\n+    private GoConfigService goConfigService;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigRepositoryInitializer.class);\n+\n+    private boolean isConfigLoaded = false;\n+    private boolean hasConfigRepoInitializationCompleted = false;\n+    private List<String> loadedConfigRepoPlugins = new ArrayList<>();\n+\n+    @Autowired\n+    public ConfigRepositoryInitializer(PluginManager pluginManager, ConfigRepoService configRepoService, MaterialRepository materialRepository, GoConfigRepoConfigDataSource goConfigRepoConfigDataSource, GoConfigService goConfigService) {\n+        this.pluginManager = pluginManager;\n+        this.configRepoService = configRepoService;\n+        this.materialRepository = materialRepository;\n+        this.goConfigRepoConfigDataSource = goConfigRepoConfigDataSource;\n+        this.goConfigService = goConfigService;\n+\n+        this.pluginManager.addPluginChangeListener(this);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        this.goConfigService.register(this);\n+    }\n+\n+    @Override\n+    public void startDaemon() {\n+    }\n+\n+    @Override\n+    public void onConfigChange(CruiseConfig newCruiseConfig) {\n+        // mark config loaded only once!\n+        if (!this.isConfigLoaded) {\n+            this.isConfigLoaded = true;\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginLoaded(GoPluginDescriptor pluginDescriptor) {\n+        String pluginId = pluginDescriptor.id();\n+        boolean isConfigRepoPlugin = pluginManager.isPluginOfType(CONFIG_REPO_EXTENSION, pluginId);\n+\n+        if (isConfigRepoPlugin) {\n+            this.loadedConfigRepoPlugins.add(pluginId);\n+            this.initializeConfigRepositories();\n+        }\n+    }\n+\n+    @Override\n+    public void pluginUnLoaded(GoPluginDescriptor pluginDescriptor) {\n+        //do nothing\n+    }\n+\n+    private void initializeConfigRepositories() {\n+        // return if config repositories have already been initialized.\n+        if (this.hasConfigRepoInitializationCompleted) {\n+            return;\n+        }\n+\n+        // do nothing if the cruise config is not loaded yet..\n+        if (!this.isConfigLoaded) {\n+            return;\n+        }\n+\n+        List<String> inUseConfigRepoPlugins = this.configRepoService.getConfigRepos().stream().map(RuleAwarePluginProfile::getPluginId).collect(Collectors.toList());\n+        if (this.loadedConfigRepoPlugins.containsAll(inUseConfigRepoPlugins)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NjQ0MDEwNQ=="}, "originalCommit": {"oid": "73fe5f07156a5b276d3754b5dca88559613ebd78"}, "originalPosition": 121}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzExMzk3MTQ3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDozODoxMVrOHaXiNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxMDozODoxMVrOHaXiNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NzQxMDYxNA==", "bodyText": "@GaneshSPatil can we register for ConfigChange in the constructor over the intitalize method. If we register in the intialize method, the config repos will most likely be parsed as part of the main thread and this will lead to increased startup time for GoCD instances with larger configs and multiple config repos. WDYT?", "url": "https://github.com/gocd/gocd/pull/8599#discussion_r497410614", "createdAt": "2020-09-30T10:38:11Z", "author": {"login": "maheshp"}, "path": "server/src/main/java/com/thoughtworks/go/server/service/ConfigRepositoryInitializer.java", "diffHunk": "@@ -0,0 +1,146 @@\n+/*\n+ * Copyright 2020 ThoughtWorks, Inc.\n+ *\n+ * Licensed under the Apache License, Version 2.0 (the \"License\");\n+ * you may not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing, software\n+ * distributed under the License is distributed on an \"AS IS\" BASIS,\n+ * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n+ * See the License for the specific language governing permissions and\n+ * limitations under the License.\n+ */\n+\n+package com.thoughtworks.go.server.service;\n+\n+import com.thoughtworks.go.config.CruiseConfig;\n+import com.thoughtworks.go.config.GoConfigRepoConfigDataSource;\n+import com.thoughtworks.go.config.materials.MaterialConfigs;\n+import com.thoughtworks.go.config.materials.Materials;\n+import com.thoughtworks.go.config.remote.ConfigRepoConfig;\n+import com.thoughtworks.go.domain.MaterialInstance;\n+import com.thoughtworks.go.domain.MaterialRevisions;\n+import com.thoughtworks.go.domain.materials.Material;\n+import com.thoughtworks.go.domain.materials.MaterialConfig;\n+import com.thoughtworks.go.domain.materials.Modification;\n+import com.thoughtworks.go.listener.ConfigChangedListener;\n+import com.thoughtworks.go.plugin.infra.PluginChangeListener;\n+import com.thoughtworks.go.plugin.infra.PluginManager;\n+import com.thoughtworks.go.plugin.infra.plugininfo.GoPluginDescriptor;\n+import com.thoughtworks.go.server.initializers.Initializer;\n+import com.thoughtworks.go.server.persistence.MaterialRepository;\n+import org.slf4j.Logger;\n+import org.slf4j.LoggerFactory;\n+import org.springframework.beans.factory.annotation.Autowired;\n+import org.springframework.stereotype.Service;\n+\n+import java.io.File;\n+import java.util.LinkedList;\n+\n+import static com.thoughtworks.go.plugin.domain.common.PluginConstants.CONFIG_REPO_EXTENSION;\n+\n+/**\n+ * @understands initializing config repositories. Loads the configurations from the last checked out modification on server startup.\n+ */\n+@Service\n+public class ConfigRepositoryInitializer implements ConfigChangedListener, PluginChangeListener, Initializer {\n+    private PluginManager pluginManager;\n+    private final ConfigRepoService configRepoService;\n+    private final MaterialRepository materialRepository;\n+    private final GoConfigRepoConfigDataSource goConfigRepoConfigDataSource;\n+    private GoConfigService goConfigService;\n+    private static final Logger LOGGER = LoggerFactory.getLogger(ConfigRepositoryInitializer.class);\n+\n+    private boolean isConfigLoaded = false;\n+\n+    // list of config repo plugins which are loaded, but not yet processed. Once processed, these plugins will be removed from the list.\n+    private final LinkedList<String> pluginsQueue = new LinkedList<>();\n+\n+    @Autowired\n+    public ConfigRepositoryInitializer(PluginManager pluginManager, ConfigRepoService configRepoService, MaterialRepository materialRepository, GoConfigRepoConfigDataSource goConfigRepoConfigDataSource, GoConfigService goConfigService) {\n+        this.pluginManager = pluginManager;\n+        this.configRepoService = configRepoService;\n+        this.materialRepository = materialRepository;\n+        this.goConfigRepoConfigDataSource = goConfigRepoConfigDataSource;\n+        this.goConfigService = goConfigService;\n+\n+        this.pluginManager.addPluginChangeListener(this);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        this.goConfigService.register(this);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "153e558b912d2e5d1047b23f749f2633598d1b43"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2806, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}