{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyNjEzOTEw", "number": 60640, "title": "Use the Index Access Control from the scroll search context", "bodyText": "When the RBACEngine authorizes scroll searches it sets the index access control to the very limiting IndicesAccessControl.ALLOW_NO_INDICES value. This change will set it to the value for the index access control that was produced during the authorization of the initial search that created the scroll, which is now stored in the scroll context.", "createdAt": "2020-08-04T08:30:00Z", "url": "https://github.com/elastic/elasticsearch/pull/60640", "merged": true, "mergeCommit": {"oid": "011773c8c2a662a011de659806bcf34596ba995e"}, "closed": true, "closedAt": "2020-08-05T10:53:39Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6GR4VgH2gAyNDYyNjEzOTEwOmEwYTYzMDQwOGJlMzg3OWQyMDhlYzBhMzFjZTc5YmQ4ZTI3ODNkYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc73zoJgH2gAyNDYyNjEzOTEwOmUyNDM5ODJkYTk3ZTM5YzFhZjMyODRkOGQ3ZjFkZDRkZGYxYjMwYWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a0a630408be3879d208ec0a31ce79bd8e2783dba", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0a630408be3879d208ec0a31ce79bd8e2783dba", "committedDate": "2020-07-30T21:12:39Z", "message": "Test is hard"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b8e32027f3170df5a3958e14a33064b6066fe65", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/8b8e32027f3170df5a3958e14a33064b6066fe65", "committedDate": "2020-08-01T21:27:54Z", "message": "vallidate only internal scrolls"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04925d9c27a7823c4adca6f480b03ba2ebd78127", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/04925d9c27a7823c4adca6f480b03ba2ebd78127", "committedDate": "2020-08-02T16:53:16Z", "message": "Yep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4303a564e6805596e44b1583d6eccbfc47f44fde", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/4303a564e6805596e44b1583d6eccbfc47f44fde", "committedDate": "2020-08-03T06:53:13Z", "message": "Only verify context on preQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fb7cf8e8c97d4f80d34cdaf2619e2bc62a18de6", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2fb7cf8e8c97d4f80d34cdaf2619e2bc62a18de6", "committedDate": "2020-08-03T07:44:52Z", "message": "Reuse scrolls even if empty"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "708feae205c8673ebaa557d815ec4ca7dc8aa3e4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/708feae205c8673ebaa557d815ec4ca7dc8aa3e4", "committedDate": "2020-08-03T11:20:20Z", "message": "assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efecc2271b52f18e985fd52c05cfbb7b773bcc36", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/efecc2271b52f18e985fd52c05cfbb7b773bcc36", "committedDate": "2020-08-03T11:21:55Z", "message": "Assert index access control on fetch phase too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02f8a3069e2729a0491ff16f85611a29f580b7b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/e02f8a3069e2729a0491ff16f85611a29f580b7b", "committedDate": "2020-08-04T08:08:18Z", "message": "Merge branch 'master' into index_access_control_on_scroll_search_thread_context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b964b83cfb56128ddf9a232f80a54baba8ce98b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b964b83cfb56128ddf9a232f80a54baba8ce98b", "committedDate": "2020-08-04T08:25:16Z", "message": "Add assert about scroll index access control"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c643a55c1392d07a1f49d894f807642cbd60b167", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/c643a55c1392d07a1f49d894f807642cbd60b167", "committedDate": "2020-08-04T08:39:28Z", "message": "Unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76bb773df5f220509a0082bf3af82d34eb7a3fcd", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/76bb773df5f220509a0082bf3af82d34eb7a3fcd", "committedDate": "2020-08-04T08:47:32Z", "message": "Unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1bc719bc3cc34f8933a58f9e35fab19c13e7f71", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1bc719bc3cc34f8933a58f9e35fab19c13e7f71", "committedDate": "2020-08-04T11:50:26Z", "message": "Fix unit tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwNzQ4MTQ4", "url": "https://github.com/elastic/elasticsearch/pull/60640#pullrequestreview-460748148", "createdAt": "2020-08-04T12:03:29Z", "commit": {"oid": "f1bc719bc3cc34f8933a58f9e35fab19c13e7f71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/86be3fb37f578648bb1c4f78ac5647a27c513db2", "committedDate": "2020-08-04T12:07:59Z", "message": "remove indicesAccessControl!=null assertion for internal searches"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzg1MTQ0", "url": "https://github.com/elastic/elasticsearch/pull/60640#pullrequestreview-461385144", "createdAt": "2020-08-05T06:51:01Z", "commit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNjo1MTowMVrOG78gpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNjo1MTowMVrOG78gpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMDU2Nw==", "bodyText": "Are there valid cases where searchContext.scrollContext() is null?", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465510567", "createdAt": "2020-08-05T06:51:01Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/SecuritySearchOperationListener.java", "diffHunk": "@@ -68,6 +77,39 @@ public void validateSearchContext(SearchContext searchContext, TransportRequest\n                 final String action = threadContext.getTransient(ORIGINATING_ACTION_KEY);\n                 ensureAuthenticatedUserIsSame(originalAuth, current, auditTrailService, searchContext.id(), action, request,\n                         AuditUtil.extractRequestId(threadContext), threadContext.getTransient(AUTHORIZATION_INFO_KEY));\n+                // piggyback on context validation to assert the DLS/FLS permissions on the thread context of the scroll search handler\n+                if (null == securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY)) {\n+                    // fill in the DLS and FLS permissions for the scroll search action from the scroll context\n+                    IndicesAccessControl scrollIndicesAccessControl =\n+                            searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+                    assert scrollIndicesAccessControl != null : \"scroll does not contain index access control\";\n+                    securityContext.getThreadContext().putTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY,\n+                            scrollIndicesAccessControl);\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onPreFetchPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    @Override\n+    public void onPreQueryPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    void ensureIndicesAccessControlForScrollThreadContext(SearchContext searchContext) {\n+        if (licenseState.isSecurityEnabled() && searchContext.scrollContext() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMzg4MDQy", "url": "https://github.com/elastic/elasticsearch/pull/60640#pullrequestreview-461388042", "createdAt": "2020-08-05T06:56:16Z", "commit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNjo1NjoxNlrOG78poQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQwNjo1NjoxNlrOG78poQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTUxMjg2NQ==", "bodyText": "If what we are after is identity equality, I'd personally prefer to have scrollIndicesAccessControl != threadIndicesAccessControl to help with clarity and perphaps more future proof.", "url": "https://github.com/elastic/elasticsearch/pull/60640#discussion_r465512865", "createdAt": "2020-08-05T06:56:16Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/SecuritySearchOperationListener.java", "diffHunk": "@@ -68,6 +77,39 @@ public void validateSearchContext(SearchContext searchContext, TransportRequest\n                 final String action = threadContext.getTransient(ORIGINATING_ACTION_KEY);\n                 ensureAuthenticatedUserIsSame(originalAuth, current, auditTrailService, searchContext.id(), action, request,\n                         AuditUtil.extractRequestId(threadContext), threadContext.getTransient(AUTHORIZATION_INFO_KEY));\n+                // piggyback on context validation to assert the DLS/FLS permissions on the thread context of the scroll search handler\n+                if (null == securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY)) {\n+                    // fill in the DLS and FLS permissions for the scroll search action from the scroll context\n+                    IndicesAccessControl scrollIndicesAccessControl =\n+                            searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+                    assert scrollIndicesAccessControl != null : \"scroll does not contain index access control\";\n+                    securityContext.getThreadContext().putTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY,\n+                            scrollIndicesAccessControl);\n+                }\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void onPreFetchPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    @Override\n+    public void onPreQueryPhase(SearchContext searchContext) {\n+        ensureIndicesAccessControlForScrollThreadContext(searchContext);\n+    }\n+\n+    void ensureIndicesAccessControlForScrollThreadContext(SearchContext searchContext) {\n+        if (licenseState.isSecurityEnabled() && searchContext.scrollContext() != null) {\n+            IndicesAccessControl scrollIndicesAccessControl =\n+                    searchContext.scrollContext().getFromContext(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+            IndicesAccessControl threadIndicesAccessControl =\n+                    securityContext.getThreadContext().getTransient(AuthorizationServiceField.INDICES_PERMISSIONS_KEY);\n+            if (false == scrollIndicesAccessControl.equals(threadIndicesAccessControl)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxNDUxNTQ0", "url": "https://github.com/elastic/elasticsearch/pull/60640#pullrequestreview-461451544", "createdAt": "2020-08-05T08:30:59Z", "commit": {"oid": "86be3fb37f578648bb1c4f78ac5647a27c513db2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67be17853737b634439be73cfa59637bafa3ab80", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/67be17853737b634439be73cfa59637bafa3ab80", "committedDate": "2020-08-05T09:28:10Z", "message": "equals -> !="}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e243982da97e39c1af3284d8d7f1dd4ddf1b30ae", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/e243982da97e39c1af3284d8d7f1dd4ddf1b30ae", "committedDate": "2020-08-05T09:28:47Z", "message": "Merge branch 'master' into index_access_control_on_scroll_search_thread_context"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3505, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}