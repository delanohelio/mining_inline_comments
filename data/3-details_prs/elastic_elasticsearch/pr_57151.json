{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMjUwNzI4", "number": 57151, "title": "Remove Mapper.updateFieldType()", "bodyText": "When we had multiple mapping types, an update to a field in one type had to be\npropagated to the same field in all other types. This was done using the\nMapper.updateFieldType() method, called at the end of a merge. However, now\nthat we only have a single type per index, this method is unnecessary and can\nbe removed.\nRelates to #41059\nBackport of #56986", "createdAt": "2020-05-26T14:43:28Z", "url": "https://github.com/elastic/elasticsearch/pull/57151", "merged": true, "mergeCommit": {"oid": "d6b79bcd95e9d051d8a67e166a578ac78c3eadd0"}, "closed": true, "closedAt": "2020-05-27T08:21:25Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclFqhXgH2gAyNDIzMjUwNzI4Ojc5ODJjZjdmM2VjZmFjNzMzNmY2NDVmYzQ3Zjc4MzZiZDMxNWFmYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclLSiYgFqTQxODY4MTcyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7982cf7f3ecfac7336f645fc47f7836bd315afb3", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7982cf7f3ecfac7336f645fc47f7836bd315afb3", "committedDate": "2020-05-26T14:37:15Z", "message": "Remove Mapper.updateFieldType() (#56986)\n\nWhen we had multiple mapping types, an update to a field in one type had to be\npropagated to the same field in all other types. This was done using the\nMapper.updateFieldType() method, called at the end of a merge. However, now\nthat we only have a single type per index, this method is unnecessary and can\nbe removed.\n\nRelates to #41059"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MzcyNzE4", "url": "https://github.com/elastic/elasticsearch/pull/57151#pullrequestreview-418372718", "createdAt": "2020-05-26T14:45:55Z", "commit": {"oid": "7982cf7f3ecfac7336f645fc47f7836bd315afb3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo0NTo1NlrOGahvtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNDo0NTo1NlrOGahvtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTA0Ng==", "bodyText": "This was testing dead code - we would never update a mapping against a separate type, because the update mappings code already ensures that all updates use the same type name.", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430469046", "createdAt": "2020-05-26T14:45:56Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DynamicMappingTests.java", "diffHunk": "@@ -436,106 +436,6 @@ public void testComplexArray() throws Exception {\n                 .endObject().endObject().endObject()), serialize(update));\n     }\n \n-    public void testReuseExistingMappings() throws IOException, Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7982cf7f3ecfac7336f645fc47f7836bd315afb3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "085ddb40790fec28975ba6ba35a2cc10c76fcf74", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/085ddb40790fec28975ba6ba35a2cc10c76fcf74", "committedDate": "2020-05-26T15:11:21Z", "message": "precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a317831b9d1d20c5efc4d564555e690497cc08cb", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a317831b9d1d20c5efc4d564555e690497cc08cb", "committedDate": "2020-05-26T16:03:23Z", "message": "aggregator test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NTE4Njg0", "url": "https://github.com/elastic/elasticsearch/pull/57151#pullrequestreview-418518684", "createdAt": "2020-05-26T17:25:43Z", "commit": {"oid": "a317831b9d1d20c5efc4d564555e690497cc08cb"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzoyNTo0M1rOGaormg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxNzozNjoyNVrOGapDgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4MjY4Mg==", "bodyText": "Same question here about whether this change is important.", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430582682", "createdAt": "2020-05-26T17:25:43Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -559,29 +547,16 @@ static void validateTypeName(String type) {\n         }\n         if (newMapper != null) {\n             this.mapper = newMapper;\n+            this.fieldTypes = fieldTypes;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a317831b9d1d20c5efc4d564555e690497cc08cb"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4Mzk0OA==", "bodyText": "I'm wondering if this change is important, where we no longer wrap in an unmodifiable map. If not we could restore it to make the PR more targeted/ precise.", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430583948", "createdAt": "2020-05-26T17:27:53Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -530,18 +530,6 @@ static void validateTypeName(String type) {\n         }\n         checkIndexSortCompatibility(indexSettings.getIndexSortConfig(), hasNested);\n \n-        if (newMapper != null) {\n-            DocumentMapper updatedDocumentMapper = newMapper.updateFieldType(fieldTypes.fullNameToFieldType);\n-            if (updatedDocumentMapper != newMapper) {\n-                // update both mappers and result\n-                newMapper = updatedDocumentMapper;\n-                results.put(updatedDocumentMapper.type(), updatedDocumentMapper);\n-            }\n-        }\n-\n-        // make structures immutable\n-        results = Collections.unmodifiableMap(results);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a317831b9d1d20c5efc4d564555e690497cc08cb"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDU4ODgwMQ==", "bodyText": "It would be good to match what we have on master (it's easier to reason about, and makes backport conflicts less likely). On master we've modified the test to focus on a single type -- we could apply the same change here.", "url": "https://github.com/elastic/elasticsearch/pull/57151#discussion_r430588801", "createdAt": "2020-05-26T17:36:25Z", "author": {"login": "jtibshirani"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DynamicMappingTests.java", "diffHunk": "@@ -436,106 +436,6 @@ public void testComplexArray() throws Exception {\n                 .endObject().endObject().endObject()), serialize(update));\n     }\n \n-    public void testReuseExistingMappings() throws IOException, Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDQ2OTA0Ng=="}, "originalCommit": {"oid": "7982cf7f3ecfac7336f645fc47f7836bd315afb3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f332d13c7af7243b19303b950f69eb72d0d69961", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f332d13c7af7243b19303b950f69eb72d0d69961", "committedDate": "2020-05-26T19:59:36Z", "message": "feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4NjgxNzI0", "url": "https://github.com/elastic/elasticsearch/pull/57151#pullrequestreview-418681724", "createdAt": "2020-05-26T21:10:29Z", "commit": {"oid": "f332d13c7af7243b19303b950f69eb72d0d69961"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4190, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}