{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MzE1MjQy", "number": 59428, "title": "Fix Snapshot not Starting in Partial Snapshot Corner Case", "bodyText": "We were not handling the case where during a partial snapshot all\nshards would enter a failed state right off the bat.\nCloses #59384\nMarking as non-issue since the bug wasn't released because it was caused by #56365.", "createdAt": "2020-07-13T15:05:20Z", "url": "https://github.com/elastic/elasticsearch/pull/59428", "merged": true, "mergeCommit": {"oid": "b61aa9da9deb509f9a85af6efb2c73229231fe12"}, "closed": true, "closedAt": "2020-07-13T16:07:11Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0i0K5AH2gAyNDQ4MzE1MjQyOmY3ZjY0YWIxNDYwZjdlZTRiOTc0MjI1MTM3NWYxM2YzYTBmMWE1Yzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0jgAjgFqTQ0NzM4MDEyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f7f64ab1460f7ee4b9742251375f13f3a0f1a5c8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7f64ab1460f7ee4b9742251375f13f3a0f1a5c8", "committedDate": "2020-07-13T15:03:54Z", "message": "Fix Snapshot not Starting in Partial Snapshot Corner Case\n\nWe were not handling the case where during a partial snaphshot all\nshards would enter a failed state right off the bat.\n\nCloses #59384"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48acf9694d7d238030e92f3f12f4975c0e550adf", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/48acf9694d7d238030e92f3f12f4975c0e550adf", "committedDate": "2020-07-13T15:12:00Z", "message": "cleaner fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzQ2NjE4", "url": "https://github.com/elastic/elasticsearch/pull/59428#pullrequestreview-447346618", "createdAt": "2020-07-13T15:14:34Z", "commit": {"oid": "48acf9694d7d238030e92f3f12f4975c0e550adf"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToxNDozNFrOGwtIdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxNToxNDozNFrOGwtIdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MzcyNDI3OQ==", "bodyText": "Also fixes yet another spot where we'd produce a snapshot with all shards in a final state but not a final state for the overall snapshot. I'll try to track down any remaining cases (I think this should've been the last one) if there are any and add an assertion to prevent this kind of bug going forward.", "url": "https://github.com/elastic/elasticsearch/pull/59428#discussion_r453724279", "createdAt": "2020-07-13T15:14:34Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -294,8 +294,8 @@ public ClusterState execute(ClusterState currentState) {\n                 }\n                 newEntry = new SnapshotsInProgress.Entry(\n                         new Snapshot(repositoryName, snapshotId), request.includeGlobalState(), request.partial(),\n-                        State.STARTED, indexIds, dataStreams, threadPool.absoluteTimeInMillis(), repositoryData.getGenId(), shards,\n-                        null, userMeta, version);\n+                        completed(shards.values()) ? State.SUCCESS : State.STARTED, indexIds, dataStreams,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48acf9694d7d238030e92f3f12f4975c0e550adf"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3MzgwMTI3", "url": "https://github.com/elastic/elasticsearch/pull/59428#pullrequestreview-447380127", "createdAt": "2020-07-13T15:51:47Z", "commit": {"oid": "48acf9694d7d238030e92f3f12f4975c0e550adf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4408, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}