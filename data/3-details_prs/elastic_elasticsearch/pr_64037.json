{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MTA4Mjk2", "number": 64037, "title": "Deprecate cert gen without a CA and add self-signed option", "bodyText": "Generating a CA on the fly is an attempt at workflow optimisation that was inherited from certgen. There are potential pitfalls with this approach. Overall it is recommended to separate the step of CA creation and mandate a CA to be specified when generating certificate.\nThis PR add a deprecation message if the cert command is used without specifying a CA. A follow up PR will throw error for this usage in 8.0.\nFor use case where we explicitly trust a certificate without needing a CA, e.g. SAML message signing, the PR adds a --self-signed option to the cert sub-command to generate self-signed certificate.\nRelates: #61884", "createdAt": "2020-10-22T08:20:22Z", "url": "https://github.com/elastic/elasticsearch/pull/64037", "merged": true, "mergeCommit": {"oid": "bdd99b250fe6e3db748df614dc3fe22e1c5281a0"}, "closed": true, "closedAt": "2020-11-29T21:46:03Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdU9eGAAH2gAyNTA4MTA4Mjk2OmNjNGYwMDRkNjIxMzUwNjIxMmQ0ZmMwNjdhY2U1OTdmMWUzZjliNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgMiuUAFqTUzOTAxMzEwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cc4f004d6213506212d4fc067ace597f1e3f9b41", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc4f004d6213506212d4fc067ace597f1e3f9b41", "committedDate": "2020-10-22T08:12:48Z", "message": "Deprecate cert genereation without specifying a CA"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716a7c1a987ed3bea64dcf72e225ec79c920b0b0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/716a7c1a987ed3bea64dcf72e225ec79c920b0b0", "committedDate": "2020-10-22T09:15:36Z", "message": "Doc update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91e66709810bfe2b02e40d25e09499cab20447c7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/91e66709810bfe2b02e40d25e09499cab20447c7", "committedDate": "2020-10-22T09:34:40Z", "message": "Update to use deprecated directive"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE1MTc1MzY5", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-515175369", "createdAt": "2020-10-22T22:57:44Z", "commit": {"oid": "91e66709810bfe2b02e40d25e09499cab20447c7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ae1906305089469fc00f1bd0e8ab9c4b9d72f26", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ae1906305089469fc00f1bd0e8ab9c4b9d72f26", "committedDate": "2020-10-30T00:13:42Z", "message": "Merge remote-tracking branch 'origin/master' into es-61884-certutil-cert-deprecate-no-ca"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efa9232965eca9e4e10d5d65806d576d6a8b3c2d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/efa9232965eca9e4e10d5d65806d576d6a8b3c2d", "committedDate": "2020-11-04T05:45:55Z", "message": "Add self-signed option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3558a2c98a22de37459b2c5b158bb1397abb00fd", "committedDate": "2020-11-04T12:04:40Z", "message": "Merge remote-tracking branch 'origin/master' into es-61884-certutil-cert-deprecate-no-ca"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMwMDIyMTYz", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-530022163", "createdAt": "2020-11-13T12:30:08Z", "commit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxMjozMDowOFrOHyshiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xM1QxNTo0OToyNlrOHyzpLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjkyMDMyOQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            You can also generate self-signed certificates with the `--self-signed` parameters.\n          \n          \n            \n            You can also generate self-signed certificates with the `--self-signed` parameter.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r522920329", "createdAt": "2020-11-13T12:30:08Z", "author": {"login": "jkakavas"}, "path": "docs/reference/commands/certutil.asciidoc", "diffHunk": "@@ -82,6 +82,12 @@ All certificates that are generated by this command are signed by a CA. You can\n provide your own CA with the `--ca` or `--ca-cert` parameters. Otherwise, the\n command automatically generates a new CA for you. For more information about\n generating a CA, see the <<certutil-ca,CA mode of this command>>.\n+You can also generate self-signed certificates with the `--self-signed` parameters.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyMzI5Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Generating certificates without specifying a CA certificate is deprecated.\n          \n          \n            \n            Generating certificates without specifying a CA certificate and key is deprecated.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523023293", "createdAt": "2020-11-13T15:28:04Z", "author": {"login": "jkakavas"}, "path": "docs/reference/commands/certutil.asciidoc", "diffHunk": "@@ -82,6 +82,12 @@ All certificates that are generated by this command are signed by a CA. You can\n provide your own CA with the `--ca` or `--ca-cert` parameters. Otherwise, the\n command automatically generates a new CA for you. For more information about\n generating a CA, see the <<certutil-ca,CA mode of this command>>.\n+You can also generate self-signed certificates with the `--self-signed` parameters.\n+\n+deprecated:[7.11.0]\n+Generating certificates without specifying a CA certificate is deprecated.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyMzQ3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `--ca` or `--ca-cert` parameters, unless the `--self-signed` option is specified.\n          \n          \n            \n            `--ca` or `--ca-cert` and `--ca-key` parameters, unless the `--self-signed` option is specified.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523023478", "createdAt": "2020-11-13T15:28:24Z", "author": {"login": "jkakavas"}, "path": "docs/reference/commands/certutil.asciidoc", "diffHunk": "@@ -82,6 +82,12 @@ All certificates that are generated by this command are signed by a CA. You can\n provide your own CA with the `--ca` or `--ca-cert` parameters. Otherwise, the\n command automatically generates a new CA for you. For more information about\n generating a CA, see the <<certutil-ca,CA mode of this command>>.\n+You can also generate self-signed certificates with the `--self-signed` parameters.\n+\n+deprecated:[7.11.0]\n+Generating certificates without specifying a CA certificate is deprecated.\n+Next major version will mandate a CA certificate to be provided with the\n+`--ca` or `--ca-cert` parameters, unless the `--self-signed` option is specified.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyNDg1MQ==", "bodyText": "The most important characteristic is that this is a signing certificate (used to sign SAML messages), not that it is a self-signed one. I'd suggest we revert this change", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523024851", "createdAt": "2020-11-13T15:30:29Z", "author": {"login": "jkakavas"}, "path": "x-pack/docs/en/security/authentication/saml-guide.asciidoc", "diffHunk": "@@ -505,11 +505,11 @@ support. Since PEM format is the most commonly supported format, the examples\n below will generate certificates in that format.\n \n Using the <<certutil,`elasticsearch-certutil` tool>>, you can generate a\n-signing certificate with the following command:\n+self-signed certificate with the following command:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyNjEzNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            bin/elasticsearch-certutil cert -self-signed -pem -days 1100 -name saml-sign -out saml-sign.zip\n          \n          \n            \n            bin/elasticsearch-certutil cert --self-signed --pem --days 1100 --name saml-sign --out saml-sign.zip", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523026135", "createdAt": "2020-11-13T15:32:28Z", "author": {"login": "jkakavas"}, "path": "x-pack/docs/en/security/authentication/saml-guide.asciidoc", "diffHunk": "@@ -505,11 +505,11 @@ support. Since PEM format is the most commonly supported format, the examples\n below will generate certificates in that format.\n \n Using the <<certutil,`elasticsearch-certutil` tool>>, you can generate a\n-signing certificate with the following command:\n+self-signed certificate with the following command:\n \n [source, sh]\n --------------------------------------------------\n-bin/elasticsearch-certutil cert -pem -days 1100 -name saml-sign -out saml-sign.zip\n+bin/elasticsearch-certutil cert -self-signed -pem -days 1100 -name saml-sign -out saml-sign.zip", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAyOTIyMQ==", "bodyText": "How about something like:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"    * The certificates can be self signed using the -self-signed command line option.\\n\" +\n          \n          \n            \n                        \"         Alternatively the tool can automatically generate a new CA for you, or you can \" +\n          \n          \n            \n                        \"         provide your own with the -ca or -ca-cert command line options.\";\n          \n          \n            \n            \"    * All certificates generated by this tool will be signed by a certificate authority (CA), unless\" +\n          \n          \n            \n                        \"    the --self-signed command line option is specified.\\n\" +\n          \n          \n            \n                        \"         The tool can automatically generate a new CA for you, or you can \" +\n          \n          \n            \n                        \"         provide your own with the -ca or -ca-cert command line options.\";\n          \n      \n    \n    \n  \n\nI think it reads better but I'll let Lisa tell us :)", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523029221", "createdAt": "2020-11-13T15:37:13Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -167,8 +167,9 @@ public static void main(String[] args) throws Exception {\n \n     static final String CA_EXPLANATION =\n         \"    * All certificates generated by this tool will be signed by a certificate authority (CA).\\n\" +\n-            \"    * The tool can automatically generate a new CA for you, or you can provide your own with the\\n\" +\n-            \"         -ca or -ca-cert command line options.\";\n+            \"    * The certificates can be self signed using the -self-signed command line option.\\n\" +\n+            \"         Alternatively the tool can automatically generate a new CA for you, or you can \" +\n+            \"         provide your own with the -ca or -ca-cert command line options.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNjk3NA==", "bodyText": "I also think we don't need to add a certificate entry too when we create a self-signed PKCS12, but did we check?", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r523036974", "createdAt": "2020-11-13T15:49:26Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -807,7 +819,8 @@ void generateAndWriteSignedCertificates(Path output, boolean writeZipFile, Optio\n                         } else {\n                             final String fileName = entryBase + \".p12\";\n                             outputStream.putNextEntry(new ZipEntry(fileName));\n-                            writePkcs12(fileName, outputStream, certificateInformation.name.originalName, pair, caInfo.certAndKey.cert,\n+                            writePkcs12(fileName, outputStream, certificateInformation.name.originalName, pair,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 77}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMDc1NzEz", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-523075713", "createdAt": "2020-11-04T06:38:52Z", "commit": {"oid": "efa9232965eca9e4e10d5d65806d576d6a8b3c2d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNjozODo1MlrOHtKv3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQwNjo0MDoyMlrOHtKx0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyNDA2Mw==", "bodyText": "I have a concern, which might not be a big deal, that some people will see this option and use it in places where they shouldn't.\nFor all TLS scenarios, we recommend having a separation between the CA and the node cert, and I think we want to keep recommending that.\nSo, are there words we can put here that discourage people from using it for TLS?", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r517124063", "createdAt": "2020-11-04T06:38:52Z", "author": {"login": "tvernum"}, "path": "docs/reference/commands/certutil.asciidoc", "diffHunk": "@@ -211,6 +217,9 @@ wish to password-protect your PEM keys, then do not specify\n `--pem`:: Generates certificates and keys in PEM format instead of PKCS#12. This\n parameter cannot be used with the `csr` parameter.\n \n+`--self-signed`:: Generates self-signed certificates. This parameter is only\n+applicable to the `cert` parameter.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa9232965eca9e4e10d5d65806d576d6a8b3c2d"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyNDI2Nw==", "bodyText": "I don't think this should change. It is a signing certificate, it just happens to also be self-signed.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r517124267", "createdAt": "2020-11-04T06:39:33Z", "author": {"login": "tvernum"}, "path": "x-pack/docs/en/security/authentication/saml-guide.asciidoc", "diffHunk": "@@ -505,11 +505,11 @@ support. Since PEM format is the most commonly supported format, the examples\n below will generate certificates in that format.\n \n Using the <<certutil,`elasticsearch-certutil` tool>>, you can generate a\n-signing certificate with the following command:\n+self-signed certificate with the following command:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa9232965eca9e4e10d5d65806d576d6a8b3c2d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzEyNDU2MA==", "bodyText": "This isn't strictly true anymore. Do we care?", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r517124560", "createdAt": "2020-11-04T06:40:22Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -167,8 +167,9 @@ public static void main(String[] args) throws Exception {\n \n     static final String CA_EXPLANATION =\n         \"    * All certificates generated by this tool will be signed by a certificate authority (CA).\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efa9232965eca9e4e10d5d65806d576d6a8b3c2d"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc271cfaf60092fe46f04380cb906eccb973dcc", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdc271cfaf60092fe46f04380cb906eccb973dcc", "committedDate": "2020-11-16T06:04:24Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b01ddf7ae233c511ea04573c1049e1822971e53", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b01ddf7ae233c511ea04573c1049e1822971e53", "committedDate": "2020-11-16T11:25:28Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e646bc1070c7fa25c659bedc77f8f150d2f78b77", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e646bc1070c7fa25c659bedc77f8f150d2f78b77", "committedDate": "2020-11-16T11:25:44Z", "message": "Merge remote-tracking branch 'origin/master' into es-61884-certutil-cert-deprecate-no-ca"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4121b56e2d557a448deb866d09a962a5da9f6c5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4121b56e2d557a448deb866d09a962a5da9f6c5", "committedDate": "2020-11-16T11:29:04Z", "message": "mintor comments tweak"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMyMTM5MTE4", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-532139118", "createdAt": "2020-11-17T08:50:12Z", "commit": {"oid": "f4121b56e2d557a448deb866d09a962a5da9f6c5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODo1MDoxMlrOH0qRvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODo1MjoyOFrOH0qYHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk4MDY3MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            terminal.println(\"      A CA certificate will become mandatory in next major release.\");\n          \n          \n            \n                            terminal.println(\"      A CA certificate will become mandatory in the next major release.\");", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r524980671", "createdAt": "2020-11-17T08:50:12Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -330,6 +331,9 @@ CAInfo getCAInfo(Terminal terminal, OptionSet options, Environment env) throws E\n             } else if (options.has(caCertPathSpec)) {\n                 return loadPemCA(terminal, options, env);\n             } else {\n+                terminal.println(\"Note: Generating certificates without providing a CA certificate is deprecated.\");\n+                terminal.println(\"      A CA certificate will become mandatory in next major release.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4121b56e2d557a448deb866d09a962a5da9f6c5"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk4MjMwMQ==", "bodyText": "My point was actually about the construction of the PKCS#12 bundle and whether or not it suffices to add a private key entry with the key and certificate, or if we also need to add a trusted certificate entry with the certificate too. I believe we don't and other tooling ( keytool, openssl ) seem to agree too :)", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r524982301", "createdAt": "2020-11-17T08:52:28Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -807,7 +819,8 @@ void generateAndWriteSignedCertificates(Path output, boolean writeZipFile, Optio\n                         } else {\n                             final String fileName = entryBase + \".p12\";\n                             outputStream.putNextEntry(new ZipEntry(fileName));\n-                            writePkcs12(fileName, outputStream, certificateInformation.name.originalName, pair, caInfo.certAndKey.cert,\n+                            writePkcs12(fileName, outputStream, certificateInformation.name.originalName, pair,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMzAzNjk3NA=="}, "originalCommit": {"oid": "3558a2c98a22de37459b2c5b158bb1397abb00fd"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae6ec18eabcce4252eb0b574674a6071b81e819b", "committedDate": "2020-11-18T04:15:59Z", "message": "Update x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java\n\nCo-authored-by: Ioannis Kakavas <ikakavas@protonmail.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjE3NTkx", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-533617591", "createdAt": "2020-11-18T16:18:02Z", "commit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNjoxODowMlrOH110CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNjoxODowMlrOH110CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIxODI0OQ==", "bodyText": "Should these have two dashes?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"      the -ca or -ca-cert command line options.\";\n          \n          \n            \n                        \"      the --ca or --ca-cert command line options.\";", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r526218249", "createdAt": "2020-11-18T16:18:02Z", "author": {"login": "lcawl"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -166,9 +166,10 @@ public static void main(String[] args) throws Exception {\n             \"      disable hostname verification in your SSL configuration.\";\n \n     static final String CA_EXPLANATION =\n-        \"    * All certificates generated by this tool will be signed by a certificate authority (CA).\\n\" +\n-            \"    * The tool can automatically generate a new CA for you, or you can provide your own with the\\n\" +\n-            \"         -ca or -ca-cert command line options.\";\n+        \"    * All certificates generated by this tool will be signed by a certificate authority (CA)\\n\" +\n+            \"      unless the --self-signed command line option is specified.\\n\" +\n+            \"      The tool can automatically generate a new CA for you, or you can provide your own with \" +\n+            \"      the -ca or -ca-cert command line options.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09694d360468ae84f9cf2a26bc6ba4680348a5fa", "author": {"user": {"login": "lcawl", "name": "Lisa Cawley"}}, "url": "https://github.com/elastic/elasticsearch/commit/09694d360468ae84f9cf2a26bc6ba4680348a5fa", "committedDate": "2020-11-18T16:20:34Z", "message": "[DOCS] Reformats deprecation details"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzNjIyNjQw", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-533622640", "createdAt": "2020-11-18T16:23:06Z", "commit": {"oid": "09694d360468ae84f9cf2a26bc6ba4680348a5fa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNjoyMzowNlrOH12DNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxNjoyMzowNlrOH12DNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjIyMjEzMw==", "bodyText": "deprecated:[7.11.0,\"Generating certificates without specifying a CA certificate and key is deprecated. In the next major version you must provide a CA certificate unless the --self-signed option is specified.\"]\n\nI've combined this information into a single paragraph so that it's (hopefully) clearer what's deprecated.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r526222133", "createdAt": "2020-11-18T16:23:06Z", "author": {"login": "lcawl"}, "path": "docs/reference/commands/certutil.asciidoc", "diffHunk": "@@ -73,15 +73,18 @@ directory name, you must also specify a file name in the `--name` command\n parameter or in the `filename` field in an input YAML file.\n \n You can optionally provide IP addresses or DNS names for each instance. If\n-neither IP addresses nor DNS names are specified, the Elastic stack products\n+neither IP addresses nor DNS names are specified, the Elastic Stack products\n cannot perform hostname verification and you might need to configure the\n `verification_mode` security setting to `certificate` only. For more information\n about this setting, see <<security-settings>>.\n \n-All certificates that are generated by this command are signed by a CA. You can\n-provide your own CA with the `--ca` or `--ca-cert` parameters. Otherwise, the\n-command automatically generates a new CA for you. For more information about\n-generating a CA, see the <<certutil-ca,CA mode of this command>>.\n+All certificates that are generated by this command are signed by a CA unless\n+the `--self-signed` parameter is specified. You can provide your own CA with the\n+`--ca` or `--ca-cert` and `--ca-key` parameters. Otherwise, the command automatically generates a new CA for you.\n+deprecated:[7.11.0,\"Generating certificates without specifying a CA certificate and key is deprecated. In the next major version you must provide a CA certificate unless the `--self-signed` option is specified.\"]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "09694d360468ae84f9cf2a26bc6ba4680348a5fa"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46987533d9b43d499e6197ac4ee99e1727699cda", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/46987533d9b43d499e6197ac4ee99e1727699cda", "committedDate": "2020-11-19T00:07:47Z", "message": "Update x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java\n\nCo-authored-by: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTMzMzE1MzMw", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-533315330", "createdAt": "2020-11-18T10:42:51Z", "commit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDo0Mjo1MVrOH1noNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQwNDowMDo1MlrOH2L4Cg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk4NTg0NA==", "bodyText": "Why would this take precedence rather than being an error?\nIf a user enters\ncertutil cert --ca foo.p12 --self-signed\n\nthat's contradictory, and I would expect it to be an error, but it actually would generate a self signed cert, and ignore the CA. That seems wrong to me.", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r525985844", "createdAt": "2020-11-18T10:42:51Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -645,9 +649,12 @@ void generateAndWriteCsrs(Path output, int keySize, Collection<CertificateInform\n \n     static class GenerateCertificateCommand extends CertificateCommand {\n \n+        OptionSpec<Void> selfSigned;\n+\n         GenerateCertificateCommand() {\n             super(\"generate X.509 certificates and keys\");\n             acceptCertificateGenerationOptions();\n+            selfSigned = parser.accepts(\"self-signed\", \"generate self signed certificates (takes precedence over the ca options)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU3OTcyMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                keyPair, null, null, true, days, null);\n          \n          \n            \n                                keyPair, null, null, false, days, null);\n          \n      \n    \n    \n  \n\nThe true means that this is a CA, but then --self-signed is just doing the same thing as certutil ca, but it should be generating a non ca, self-signed cert,", "url": "https://github.com/elastic/elasticsearch/pull/64037#discussion_r526579722", "createdAt": "2020-11-19T04:00:52Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java", "diffHunk": "@@ -818,17 +831,26 @@ void generateAndWriteSignedCertificates(Path output, boolean writeZipFile, Optio\n                 CertificateInformation certificateInformation = certs.iterator().next();\n                 CertificateAndKey pair = generateCertificateAndKey(certificateInformation, caInfo, keySize, days);\n                 fullyWriteFile(output, stream -> writePkcs12(output.getFileName().toString(), stream,\n-                    certificateInformation.name.originalName, pair, caInfo.certAndKey.cert, outputPassword, terminal));\n+                    certificateInformation.name.originalName, pair,\n+                    caInfo == null ? null : caInfo.certAndKey.cert, outputPassword, terminal));\n             }\n         }\n \n         private CertificateAndKey generateCertificateAndKey(CertificateInformation certificateInformation, CAInfo caInfo,\n                                                             int keySize, int days) throws Exception {\n             KeyPair keyPair = CertGenUtils.generateKeyPair(keySize);\n-            Certificate certificate = CertGenUtils.generateSignedCertificate(certificateInformation.name.x500Principal,\n-                getSubjectAlternativeNamesValue(certificateInformation.ipAddresses, certificateInformation.dnsNames,\n-                    certificateInformation.commonNames),\n-                keyPair, caInfo.certAndKey.cert, caInfo.certAndKey.key, days);\n+            Certificate certificate;\n+            if (caInfo != null) {\n+                certificate = CertGenUtils.generateSignedCertificate(certificateInformation.name.x500Principal,\n+                    getSubjectAlternativeNamesValue(certificateInformation.ipAddresses, certificateInformation.dnsNames,\n+                        certificateInformation.commonNames),\n+                    keyPair, caInfo.certAndKey.cert, caInfo.certAndKey.key, days);\n+            } else {\n+                certificate = CertGenUtils.generateSignedCertificate(certificateInformation.name.x500Principal,\n+                    getSubjectAlternativeNamesValue(certificateInformation.ipAddresses, certificateInformation.dnsNames,\n+                        certificateInformation.commonNames),\n+                    keyPair, null, null, true, days, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae6ec18eabcce4252eb0b574674a6071b81e819b"}, "originalPosition": 111}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59329edd7d7b0e0ecb96b72355dda919d936fca7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/59329edd7d7b0e0ecb96b72355dda919d936fca7", "committedDate": "2020-11-20T11:59:13Z", "message": "Update x-pack/plugin/security/cli/src/main/java/org/elasticsearch/xpack/security/cli/CertificateTool.java\n\nCo-authored-by: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55a7212b99f89c7700f632a5af016629423f7975", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/55a7212b99f89c7700f632a5af016629423f7975", "committedDate": "2020-11-20T12:12:24Z", "message": "Merge remote-tracking branch 'origin/master' into es-61884-certutil-cert-deprecate-no-ca"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3adf1cefb9511303c699184d1f46a2a2b877f118", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3adf1cefb9511303c699184d1f46a2a2b877f118", "committedDate": "2020-11-20T12:31:57Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5MDEzMTA2", "url": "https://github.com/elastic/elasticsearch/pull/64037#pullrequestreview-539013106", "createdAt": "2020-11-26T05:59:36Z", "commit": {"oid": "3adf1cefb9511303c699184d1f46a2a2b877f118"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1107, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}