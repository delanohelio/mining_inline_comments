{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg0NTIxMzA2", "number": 62261, "title": "Fix privilege requirement for CCS with Point In Time reader", "bodyText": "When target indices are remote only, CCS does not require user to have privileges on the local cluster. This PR ensure Point-In-Time reader follows the same pattern.\nRelates: #61827\n@dnhatn @jimczi", "createdAt": "2020-09-11T01:36:47Z", "url": "https://github.com/elastic/elasticsearch/pull/62261", "merged": true, "mergeCommit": {"oid": "4dd85a1e25367fb3401934f9a3ab25506a7ef364"}, "closed": true, "closedAt": "2020-09-21T03:40:28Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHrLTRAH2gAyNDg0NTIxMzA2OmNhNzU4OTlmYzkxNTM5OTIxMzczNDAwNjc1MTBkYWEzOTIyYTE4MDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ8xJEAH2gAyNDg0NTIxMzA2OjY3YTAzYTY5YTJlMGU4ZWFmMDI2MGM5ODE0NWIyZmY0ZDRlYWMwZmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ca75899fc9153992137340067510daa3922a1804", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca75899fc9153992137340067510daa3922a1804", "committedDate": "2020-09-11T01:32:58Z", "message": "Fix permission for CCS with PointInTime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0e2ace69f0c94ccfa67820eb2f8b377f6d23694", "committedDate": "2020-09-11T01:58:54Z", "message": "Merge remote-tracking branch 'origin/master' into pit-ccs-permission"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzMxNjM4", "url": "https://github.com/elastic/elasticsearch/pull/62261#pullrequestreview-487731638", "createdAt": "2020-09-14T13:05:07Z", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzowNTowN1rOHRSy1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzowNTowN1rOHRSy1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NTc2Ng==", "bodyText": "I would also exercise the condition that remote indices are wildcards (it could be a random)", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487895766", "createdAt": "2020-09-14T13:05:07Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();\n+        final String[] indices = new String[]{\n+            hasLocalIndices ? randomAlphaOfLength(5) : \"other_cluster:\" + randomAlphaOfLength(5),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzMxOTMz", "url": "https://github.com/elastic/elasticsearch/pull/62261#pullrequestreview-487731933", "createdAt": "2020-09-14T13:05:31Z", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzowNTozMVrOHRSztQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzowNTozMVrOHRSztQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg5NTk4OQ==", "bodyText": "set this to both values in a for-each.", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487895989", "createdAt": "2020-09-14T13:05:31Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NzM5NTk1", "url": "https://github.com/elastic/elasticsearch/pull/62261#pullrequestreview-487739595", "createdAt": "2020-09-14T13:14:07Z", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoxNDowN1rOHRTKLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMzoxNDowN1rOHRTKLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzkwMTc0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(ClosePointInTimeAction.NAME), eq(closePointInTimeRequest),\n          \n          \n            \n                    verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(indices:data/read/close_point_in_time), eq(closePointInTimeRequest),\n          \n      \n    \n    \n  \n\nIf you wanna be consistent with the previous test.", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r487901743", "createdAt": "2020-09-14T13:14:07Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/AuthorizationServiceTests.java", "diffHunk": "@@ -479,6 +484,46 @@ public void testRemoteIndicesOnlyWorkWithApplicableRequestTypes() throws IOExcep\n         verifyNoMoreInteractions(auditTrail);\n     }\n \n+    public void testUserWithNoRolesOpenPointInTimeWithRemoteIndices() {\n+        final boolean hasLocalIndices = randomBoolean();\n+        final String[] indices = new String[]{\n+            hasLocalIndices ? randomAlphaOfLength(5) : \"other_cluster:\" + randomAlphaOfLength(5),\n+            \"other_cluster:\" + randomAlphaOfLength(5)\n+        };\n+        final OpenPointInTimeRequest openPointInTimeRequest = new OpenPointInTimeRequest(\n+            indices, OpenPointInTimeRequest.DEFAULT_INDICES_OPTIONS, TimeValue.timeValueMinutes(randomLongBetween(1, 10)),\n+            randomAlphaOfLength(5), randomAlphaOfLength(5)\n+        );\n+        final Authentication authentication = createAuthentication(new User(\"test user\"));\n+        mockEmptyMetadata();\n+        final String requestId = AuditUtil.getOrGenerateRequestId(threadContext);\n+        if (hasLocalIndices) {\n+            assertThrowsAuthorizationException(\n+                () -> authorize(authentication, OpenPointInTimeAction.NAME, openPointInTimeRequest),\n+                \"indices:data/read/open_point_in_time\", \"test user\"\n+            );\n+            verify(auditTrail).accessDenied(eq(requestId), eq(authentication),\n+                                            eq(\"indices:data/read/open_point_in_time\"), eq(openPointInTimeRequest),\n+                                            authzInfoRoles(Role.EMPTY.names()));\n+        } else {\n+            authorize(authentication, OpenPointInTimeAction.NAME, openPointInTimeRequest);\n+            verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(OpenPointInTimeAction.NAME), eq(openPointInTimeRequest),\n+                                             authzInfoRoles(Role.EMPTY.names()));\n+        }\n+        verifyNoMoreInteractions(auditTrail);\n+    }\n+\n+    public void testUserWithNoRolesCanClosePointInTime() {\n+        final ClosePointInTimeRequest closePointInTimeRequest = new ClosePointInTimeRequest(randomAlphaOfLength(8));\n+        final Authentication authentication = createAuthentication(new User(\"test user\"));\n+        mockEmptyMetadata();\n+        final String requestId = AuditUtil.getOrGenerateRequestId(threadContext);\n+        authorize(authentication, ClosePointInTimeAction.NAME, closePointInTimeRequest);\n+        verify(auditTrail).accessGranted(eq(requestId), eq(authentication), eq(ClosePointInTimeAction.NAME), eq(closePointInTimeRequest),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODY2OTY2", "url": "https://github.com/elastic/elasticsearch/pull/62261#pullrequestreview-487866966", "createdAt": "2020-09-14T15:04:55Z", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTowNDo1NVrOHRZbWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxNTowNDo1NVrOHRZbWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODAwNDQ0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                  headers: { Authorization: \"Basic am9lOnMza3JpdA==\" }\n          \n          \n            \n                  headers: { Authorization: \"Basic cmVtb3RlOnMza3JpdA==\" }\n          \n      \n    \n    \n  \n\nNot only opening the PIT requires no privs on the local cluster but also using it (and closing), no?", "url": "https://github.com/elastic/elasticsearch/pull/62261#discussion_r488004440", "createdAt": "2020-09-14T15:04:55Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/qa/multi-cluster-search-security/src/test/resources/rest-api-spec/test/multi_cluster/80_point_in_time.yml", "diffHunk": "@@ -111,3 +111,39 @@ teardown:\n       close_point_in_time:\n         body:\n           id: \"$pit_id\"\n+\n+---\n+\"Point in time CCS with only remote indices requires no privileges on local cluster\":\n+\n+  - do:\n+      headers: { Authorization: \"Basic cmVtb3RlOnMza3JpdA==\" }\n+      open_point_in_time:\n+        index: \"my_*:point_in_time_index\"\n+        keep_alive: 5m\n+  - set: {id: pit_id}\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnMza3JpdA==\" }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3ODc0NjE3", "url": "https://github.com/elastic/elasticsearch/pull/62261#pullrequestreview-487874617", "createdAt": "2020-09-14T15:11:47Z", "commit": {"oid": "c0e2ace69f0c94ccfa67820eb2f8b377f6d23694"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "494863bf4a4423dda3e5ce5ff408b3feb2103f74", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/494863bf4a4423dda3e5ce5ff408b3feb2103f74", "committedDate": "2020-09-18T02:17:48Z", "message": "Merge remote-tracking branch 'origin/master' into pit-ccs-permission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c2f20cf39aac30f504990482f47e5470ed8435d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c2f20cf39aac30f504990482f47e5470ed8435d", "committedDate": "2020-09-18T02:33:47Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Albert Zaharovits <albert.zaharovits@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e056c3a8c6aa1d9c7e5c1988197b6454c190923", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e056c3a8c6aa1d9c7e5c1988197b6454c190923", "committedDate": "2020-09-18T02:34:03Z", "message": "Merge branch 'pit-ccs-permission' of github.com:ywangd/elasticsearch into pit-ccs-permission"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "635619c7d0970a588b7d5fb2a7a653076c05be1d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/635619c7d0970a588b7d5fb2a7a653076c05be1d", "committedDate": "2020-09-18T02:43:42Z", "message": "address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67a03a69a2e0e8eaf0260c98145b2ff4d4eac0fa", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/67a03a69a2e0e8eaf0260c98145b2ff4d4eac0fa", "committedDate": "2020-09-18T03:10:32Z", "message": "Fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4537, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}