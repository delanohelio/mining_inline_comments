{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2ODI2NTEw", "number": 60179, "title": "Clarify SourceLookup sharing across fetch subphases.", "bodyText": "The SourceLookup class provides access to the _source for a particular\ndocument, specified through SourceLookup#setSegmentAndDocument. Previously\nthe search context contained a single SourceLookup that was shared between\ndifferent fetch subphases. It was hard to reason about its state: is\nSourceLookup set to the expected document? Is the _source already loaded and\navailable?\nInstead of using a global source lookup, the fetch hit context now provides\naccess to a lookup that is set to load from the hit document.\nThis refactor closes #31000, since the same SourceLookup is no longer shared\nbetween the 'fetch _source phase' and script execution.", "createdAt": "2020-07-27T00:12:59Z", "url": "https://github.com/elastic/elasticsearch/pull/60179", "merged": true, "mergeCommit": {"oid": "9d283287c49577faad891b4263b9501dba1f0505"}, "closed": true, "closedAt": "2020-07-30T18:57:37Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc42pPxABqjM1ODc1NTIyNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6EOlBAFqTQ1ODY2NzQyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "68f142262bac52c12a8b8552599eb8abe1d5c753", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/68f142262bac52c12a8b8552599eb8abe1d5c753", "committedDate": "2020-07-26T23:46:16Z", "message": "Remove SearchContext#lookup."}, "afterCommit": {"oid": "394f30e84a06e0b93cb9fbece1dbdfd5f3c17f62", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/394f30e84a06e0b93cb9fbece1dbdfd5f3c17f62", "committedDate": "2020-07-27T00:25:35Z", "message": "Remove SearchContext#lookup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "394f30e84a06e0b93cb9fbece1dbdfd5f3c17f62", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/394f30e84a06e0b93cb9fbece1dbdfd5f3c17f62", "committedDate": "2020-07-27T00:25:35Z", "message": "Remove SearchContext#lookup."}, "afterCommit": {"oid": "58a7d728ec9d1be6db855c38fcd2dbcb12727301", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a7d728ec9d1be6db855c38fcd2dbcb12727301", "committedDate": "2020-07-27T00:52:10Z", "message": "Remove SearchContext#lookup."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58a7d728ec9d1be6db855c38fcd2dbcb12727301", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a7d728ec9d1be6db855c38fcd2dbcb12727301", "committedDate": "2020-07-27T00:52:10Z", "message": "Remove SearchContext#lookup."}, "afterCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/aca5233c1c80ab9d32187dad6ee7663ce63ceed3", "committedDate": "2020-07-27T02:02:23Z", "message": "Fix null pointer in FetchSourcePhaseTests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MDI1MTk1", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-456025195", "createdAt": "2020-07-27T18:19:12Z", "commit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODoxOToxM1rOG3uJUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODoxOToxM1rOG3uJUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MDkxMw==", "bodyText": "We set the root document's _source here, but when processing inner hits we didn't use it and instead reloaded the _source. So this is safe to remove for now.\nIn a follow-up PR, I will fix this to make sure the _source is loaded only once for the root doc + inner hits.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461080913", "createdAt": "2020-07-27T18:19:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/InnerHitsPhase.java", "diffHunk": "@@ -65,10 +65,6 @@ public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOExcept\n                 }\n                 innerHits.docIdsToLoad(docIdsToLoad, 0, docIdsToLoad.length);\n                 innerHits.setId(hit.getId());\n-                innerHits.lookup().source().setSource(context.lookup().source().internalSourceRef());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2MjU0MzQ4", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-456254348", "createdAt": "2020-07-28T02:11:41Z", "commit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoxMTo0MVrOG36AvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoxMTo0MVrOG36AvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3NTMyNQ==", "bodyText": "Do we always need to create SourceLookup object here?  What about cases where we don't need _source?  May be do a object creation lazily: the 1st time it is needed?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461275325", "createdAt": "2020-07-28T02:11:41Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2ODgwNjY0", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-456880664", "createdAt": "2020-07-28T18:03:15Z", "commit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODowMzoxNVrOG4YUIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODowMzoxNVrOG4YUIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MTgxMQ==", "bodyText": "Since this one happens at query time maybe we can keep using it? I think what you have here would cause two significant text aggs to load source twice.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461771811", "createdAt": "2020-07-28T18:03:15Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -154,13 +153,12 @@ protected Aggregator createInternal(SearchContext searchContext, Aggregator pare\n         private ObjectArray<DuplicateByteSequenceSpotter> dupSequenceSpotters;\n \n         SignificantTextCollectorSource(\n-            SourceLookup sourceLookup,\n             BigArrays bigArrays,\n             MappedFieldType fieldType,\n             String[] sourceFieldNames,\n             boolean filterDuplicateText\n         ) {\n-            this.sourceLookup = sourceLookup;\n+            this.sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6362be8560a319b9356a7a853cc04f7ade69cddf", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/6362be8560a319b9356a7a853cc04f7ade69cddf", "committedDate": "2020-07-28T18:09:09Z", "message": "Create new SourceLookup for SignificantTextAggregator."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "715e762194a306b1e6e32eee9ce2b7e7f4857f78", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/715e762194a306b1e6e32eee9ce2b7e7f4857f78", "committedDate": "2020-07-28T18:10:35Z", "message": "Store SourceLookup on HitContext and set the source when creating hits."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a17197e25f2a5c7044ba5b0b443b9a5e836197e", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a17197e25f2a5c7044ba5b0b443b9a5e836197e", "committedDate": "2020-07-28T18:10:42Z", "message": "In highlighting, access source through HitContext."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53bd27691389bf1ad813b971f00e5c22a65d792c", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/53bd27691389bf1ad813b971f00e5c22a65d792c", "committedDate": "2020-07-28T18:10:42Z", "message": "Stop saving parent _source before loading inner hits.\n\nThis saved _source actually never appears to be used."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTA4MDA2", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-456908006", "createdAt": "2020-07-28T18:41:28Z", "commit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MToyOFrOG4ZpIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MToyOFrOG4ZpIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ==", "bodyText": "Similar to @nik9000's comment, it looks like source will be loaded twice here for cases when a script needs to access  _source and when _source is requested for hits because we will have two different SourceLookup objects , for example for queries like this:\n{\n  \"_source\": true,\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"script_fields\": {\n    \"my_script\": {\n      \"script\": {\n        \"source\": \"params['_source']['my_field']\"\n      }\n    }\n  }\n}", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461793571", "createdAt": "2020-07-28T18:41:28Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9419b2be63532e6d994fc4a4dd51f54593e06d0e", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/9419b2be63532e6d994fc4a4dd51f54593e06d0e", "committedDate": "2020-07-28T19:22:14Z", "message": "Remove SearchContext#lookup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b730e9354d633be8f878e52e522a062755d539b", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b730e9354d633be8f878e52e522a062755d539b", "committedDate": "2020-07-28T19:22:17Z", "message": "Fix null pointer in FetchSourcePhaseTests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTIxNTg5", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-456921589", "createdAt": "2020-07-28T19:00:36Z", "commit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTowMDozNlrOG4aTbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo0MzoyOFrOG4b4BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNDM5OA==", "bodyText": "I think we should add a comment here about why we don't want to share the lookup in QueryShardContext.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461804398", "createdAt": "2020-07-28T19:00:36Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNTEyMg==", "bodyText": "I think we still need SourceLookup here both for significant text, and for the thing we talked about where I wanted SearchLookup on FieldMapper#lookup.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461805122", "createdAt": "2020-07-28T19:01:47Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMDE0OA==", "bodyText": "I do think this'll break the shared loading of _source in scripts at query time though. Each script calls this method to get its own fresh LeafSearchLookup and we sort of rely on them being able to share the loaded _source.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461830148", "createdAt": "2020-07-28T19:43:28Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ea74891e76253d91a9052c66fe7705fde11caa", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/22ea74891e76253d91a9052c66fe7705fde11caa", "committedDate": "2020-07-28T20:10:54Z", "message": "Restore shared SourceLookup to SearchLookup."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/174edb6584436f2f222e5ae7cadca9271027e14c", "committedDate": "2020-07-28T20:39:04Z", "message": "Add comments explaining source loading + sharing."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/aca5233c1c80ab9d32187dad6ee7663ce63ceed3", "committedDate": "2020-07-27T02:02:23Z", "message": "Fix null pointer in FetchSourcePhaseTests."}, "afterCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/174edb6584436f2f222e5ae7cadca9271027e14c", "committedDate": "2020-07-28T20:39:04Z", "message": "Add comments explaining source loading + sharing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3ODY0ODgz", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-457864883", "createdAt": "2020-07-29T20:18:06Z", "commit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoxODowNlrOG5ImfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoyNTo1MlrOG5I2kg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Mjk0MA==", "bodyText": "I wonder if we can still assign the context.lookup().source() with the current _source so that _script can share the source with other fetch sub-phase. That would only work for sub-phases that use a script and override hitExecute so the new FetchFieldsPhase would benefit from this hack ? We can then think how we could clenup the context for script in a follow up ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462562940", "createdAt": "2020-07-29T20:18:06Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -222,42 +221,60 @@ private int findRootDocumentIfNested(SearchContext context, LeafReaderContext su\n         return -1;\n     }\n \n-    private SearchHit createSearchHit(SearchContext context,\n-                                      FieldsVisitor fieldsVisitor,\n-                                      int docId,\n-                                      int subDocId,\n-                                      Map<String, Set<String>> storedToRequestedFields,\n-                                      LeafReaderContext subReaderContext) {\n+    /**\n+     * Resets the provided {@link FetchSubPhase.HitContext} with information on the current\n+     * document. This includes the following:\n+     *   - Adding an initial {@link SearchHit} instance.\n+     *   - Loading the document source and setting it on {@link SourceLookup}. This allows\n+     *     fetch subphases that use the hit context to access the preloaded source.\n+     */\n+    private void prepareHitContext(FetchSubPhase.HitContext hitContext,\n+                                   SearchContext context,\n+                                   FieldsVisitor fieldsVisitor,\n+                                   int docId,\n+                                   int subDocId,\n+                                   Map<String, Set<String>> storedToRequestedFields,\n+                                   LeafReaderContext subReaderContext) {\n         if (fieldsVisitor == null) {\n-            return new SearchHit(docId, null, null, null);\n-        }\n-        loadStoredFields(context.shardTarget(), subReaderContext, fieldsVisitor, subDocId);\n-        fieldsVisitor.postProcess(context.mapperService());\n-        SearchHit searchHit;\n-        if (fieldsVisitor.fields().isEmpty() == false) {\n-            Map<String, DocumentField> docFields = new HashMap<>();\n-            Map<String, DocumentField> metaFields = new HashMap<>();\n-            fillDocAndMetaFields(context, fieldsVisitor, storedToRequestedFields, docFields, metaFields);\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), docFields, metaFields);\n+            SearchHit hit = new SearchHit(docId, null, null, null);\n+            hitContext.reset(hit, subReaderContext, subDocId, context.searcher());\n         } else {\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), emptyMap(), emptyMap());\n-        }\n-        // Set _source if requested.\n-        SourceLookup sourceLookup = context.lookup().source();\n-        sourceLookup.setSegmentAndDocument(subReaderContext, subDocId);\n-        if (fieldsVisitor.source() != null) {\n-            sourceLookup.setSource(fieldsVisitor.source());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NjM0Ng==", "bodyText": "+1, that's something that we spotted sometime ago: #32818 (comment) and maybe #56210 but never implemented.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462566346", "createdAt": "2020-07-29T20:24:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/InnerHitsPhase.java", "diffHunk": "@@ -65,10 +65,6 @@ public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOExcept\n                 }\n                 innerHits.docIdsToLoad(docIdsToLoad, 0, docIdsToLoad.length);\n                 innerHits.setId(hit.getId());\n-                innerHits.lookup().source().setSource(context.lookup().source().internalSourceRef());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MDkxMw=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Njg5NQ==", "bodyText": "Maybe just pass the SourceLookup directly ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462566895", "createdAt": "2020-07-29T20:25:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceScoreOrderFragmentsBuilder.java", "diffHunk": "@@ -36,11 +35,10 @@\n public class SourceScoreOrderFragmentsBuilder extends ScoreOrderFragmentsBuilder {\n \n     private final MappedFieldType fieldType;\n-\n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceScoreOrderFragmentsBuilder(MappedFieldType fieldType,\n-                                            QueryShardContext context,\n+                                            FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NzA1OA==", "bodyText": "Same here ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462567058", "createdAt": "2020-07-29T20:25:52Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceSimpleFragmentsBuilder.java", "diffHunk": "@@ -21,21 +21,20 @@\n import org.apache.lucene.document.Field;\n import org.apache.lucene.document.TextField;\n import org.apache.lucene.index.IndexReader;\n-import org.apache.lucene.index.LeafReaderContext;\n import org.apache.lucene.search.vectorhighlight.BoundaryScanner;\n import org.elasticsearch.index.mapper.MappedFieldType;\n-import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.search.fetch.FetchSubPhase;\n import org.elasticsearch.search.lookup.SourceLookup;\n \n import java.io.IOException;\n import java.util.List;\n \n public class SourceSimpleFragmentsBuilder extends SimpleFragmentsBuilder {\n \n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceSimpleFragmentsBuilder(MappedFieldType fieldType,\n-                                        QueryShardContext context,\n+                                        FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e43c4e020f822c351346447aa84377a171c79185", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/e43c4e020f822c351346447aa84377a171c79185", "committedDate": "2020-07-29T20:51:06Z", "message": "Merge remote-tracking branch 'upstream/master' into source-lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99c6461815aff9326014093d6bb439a7c1608562", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/99c6461815aff9326014093d6bb439a7c1608562", "committedDate": "2020-07-29T21:01:14Z", "message": "Undo all changes to SearchLookup class.\n\nThey are not closely related to this PR and it's clearer to keep them separate."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ef525b7aa009f2df858f0ca3708efeee1d8d828", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ef525b7aa009f2df858f0ca3708efeee1d8d828", "committedDate": "2020-07-29T21:11:03Z", "message": "Avoid passing whole HitContext to the highlight fragments builders."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a61ce6cd1c8f1e292b37b018cc7424aab6041708", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a61ce6cd1c8f1e292b37b018cc7424aab6041708", "committedDate": "2020-07-29T21:48:01Z", "message": "Remove unnecessary method mock in AggregatorTestCase."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0b5d5f34a56c49b55f997d732124e948eaae460", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0b5d5f34a56c49b55f997d732124e948eaae460", "committedDate": "2020-07-29T22:33:02Z", "message": "Fix checkstyle violation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4888efc43699745ba1272a911b7bfac064bedba", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4888efc43699745ba1272a911b7bfac064bedba", "committedDate": "2020-07-30T16:46:33Z", "message": "Undo the change to SourceLookup sharing in SIgnificantTextAggregator."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjE2Mzk0", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-458616394", "createdAt": "2020-07-30T17:36:16Z", "commit": {"oid": "b4888efc43699745ba1272a911b7bfac064bedba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be6cfe6c11156379fc66fc1c0afab95ea940f61f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/be6cfe6c11156379fc66fc1c0afab95ea940f61f", "committedDate": "2020-07-30T18:11:24Z", "message": "Merge remote-tracking branch 'upstream/master' into source-lookup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NjY3NDI1", "url": "https://github.com/elastic/elasticsearch/pull/60179#pullrequestreview-458667425", "createdAt": "2020-07-30T18:49:14Z", "commit": {"oid": "be6cfe6c11156379fc66fc1c0afab95ea940f61f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4781, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}