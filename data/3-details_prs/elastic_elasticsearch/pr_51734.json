{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5NTM5NDUw", "number": 51734, "title": "Fix completeWith exception handling", "bodyText": "ActionListener.completeWith would catch exceptions from\nlistener.onResponse and deliver them to lister.onFailure, essentially\ndouble notifying the listener. Instead we now assert that listeners do\nnot throw when using ActionListener.completeWith.\nRelates #50886", "createdAt": "2020-01-31T11:33:36Z", "url": "https://github.com/elastic/elasticsearch/pull/51734", "merged": true, "mergeCommit": {"oid": "7470dcd951f35bdeb46368bdeb45a38775566d84"}, "closed": true, "closedAt": "2020-02-03T13:02:32Z", "author": {"login": "henningandersen"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_tDcjgH2gAyMzY5NTM5NDUwOmVmN2EyYjhlZDkwNzZhYzA4NTIyOTIwMjNlMzhiMGUwYzcxMzc2YjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_urAfAFqTM1MTQ4NTYwNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ef7a2b8ed9076ac0852292023e38b0e0c71376b4", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef7a2b8ed9076ac0852292023e38b0e0c71376b4", "committedDate": "2020-01-31T11:01:39Z", "message": "Fix completeWith exception handling\n\nActionListener.completeWith would catch exceptions from\nlistener.onResponse and deliver them to lister.onFailure, essentially\ndouble notifying the listener. Instead we now assert that listeners do\nnot throw when using ActionListener.completeWith.\n\nRelates #50886"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDg1NjA0", "url": "https://github.com/elastic/elasticsearch/pull/51734#pullrequestreview-351485604", "createdAt": "2020-01-31T12:54:25Z", "commit": {"oid": "ef7a2b8ed9076ac0852292023e38b0e0c71376b4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjo1NDoyNVrOFkKhUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxMjo1NDoyNVrOFkKhUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ2NTQyNw==", "bodyText": "I'm starting to wonder ... maybe (as the eventual goal of our efforts here, don't think it's possible right now), we should just make ActionListener an abstract class and enforce that nothing is thrown in onResponse and onFailure by simply making these lines call some protected innerOnResponse or so.\nIt seems just enforcing the not throwing in onComplete and map is simply a small part of the overall issue of enforcing the callbacks to handle their own exceptions and we could just dry things up that way?", "url": "https://github.com/elastic/elasticsearch/pull/51734#discussion_r373465427", "createdAt": "2020-01-31T12:54:25Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/ActionListener.java", "diffHunk": "@@ -315,12 +315,28 @@ protected void innerOnFailure(Exception e) {\n     /**\n      * Completes the given listener with the result from the provided supplier accordingly.\n      * This method is mainly used to complete a listener with a block of synchronous code.\n+     *\n+     * If the supplier fails, the listener's onFailure handler will be called.\n+     * It is the responsibility of {@code delegate} to handle its own exceptions inside `onResponse` and `onFailure`.\n      */\n     static <Response> void completeWith(ActionListener<Response> listener, CheckedSupplier<Response, ? extends Exception> supplier) {\n+        Response response;\n         try {\n-            listener.onResponse(supplier.get());\n+            response = supplier.get();\n         } catch (Exception e) {\n-            listener.onFailure(e);\n+            try {\n+                listener.onFailure(e);\n+            } catch (RuntimeException ex) {\n+                assert false : ex;\n+                throw ex;\n+            }\n+            return;\n+        }\n+        try {\n+            listener.onResponse(response);\n+        } catch (RuntimeException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ef7a2b8ed9076ac0852292023e38b0e0c71376b4"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2915, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}