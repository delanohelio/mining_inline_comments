{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MDk3MjU2", "number": 53453, "title": "Resolve anonymous roles and deduplicate roles during authentication", "bodyText": "Anonymous roles resolution and user role deduplication are now performed during authentication instead of authorization. The change ensures:\n\nIf anonymous access is enabled, user will be able to see the anonymous roles added in the roles field in the /_security/_authenticate response.\nAny duplication in user roles are removed and will not show in the above authenticate response.\nIn any other case, the response is unchanged.\n\nIt also introduces a behaviour change: the anonymous role resolution is now authentication node specific, while it was authorization node specific. Details can be found at #47195 (comment)\nNo doc changes. Doc update is tracked separatedly.\nResolves: #47195", "createdAt": "2020-03-12T08:06:36Z", "url": "https://github.com/elastic/elasticsearch/pull/53453", "merged": true, "mergeCommit": {"oid": "3fa765aafcf3f854c8dc085d20dfb45dae8623d7"}, "closed": true, "closedAt": "2020-04-30T01:53:22Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM3ajGgFqTM3MzM1NDU5MQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcch-OsAH2gAyMzg3MDk3MjU2OmM2M2M0OWZhYmExNzkwMGEyZjIzMjJjOTYwNmEzZjQ1MTg3OTQ4OWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMzU0NTkx", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-373354591", "createdAt": "2020-03-12T08:26:57Z", "commit": {"oid": "98a319d4c32b92faa66ab2af6480cd28b5317512"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoyNjo1N1rOF1VAyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQwODoyNjo1N1rOF1VAyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ==", "bodyText": "The tricky bits of this work are:\n\nXContent serialization is managed inside Authentication\nInformation about anonymous user is not available in Authentication.\n\nOne approach is to add an new anonymousRoles field to User class and populate it during authentication. But this has wide spread impact as the User object is serialised and sent everywhere. Also the anonymous access is by default off, so it does not seem to justify the wide spread change.\nSo the new logic is added here in RestAuthenticationAction, which can create the anonymous user object and inject its roles into the XContent object.", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r391463115", "createdAt": "2020-03-12T08:26:57Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/RestAuthenticateAction.java", "diffHunk": "@@ -65,7 +70,16 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 new RestBuilderListener<AuthenticateResponse>(channel) {\n             @Override\n             public RestResponse buildResponse(AuthenticateResponse authenticateResponse, XContentBuilder builder) throws Exception {\n-                authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                if (anonymousEnabled\n+                    && false == anonymousUser.equals(authenticateResponse.authentication().getUser())\n+                    && anonymousUser.roles().length != 0) {\n+                    builder.startObject();\n+                    authenticateResponse.authentication().toXContentFragment(builder);\n+                    builder.array(User.Fields.ANONYMOUS_ROLES.getPreferredName(), anonymousUser.roles());\n+                    builder.endObject();\n+                } else {\n+                    authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "98a319d4c32b92faa66ab2af6480cd28b5317512"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTQ0Mjk1", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-374144295", "createdAt": "2020-03-13T09:12:26Z", "commit": {"oid": "149c6f8a80b4ebb50d09a895e103f09f371b7f3d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOToxMjoyN1rOF18XHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMDozNzowMVrOF1-6DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEwNzgwNQ==", "bodyText": "I think I had a change of heart since #47195 (comment). I think that the fact that these are roles inherited by the anonymous user configuration is more important to the administrator and/or for troubleshooting than it is for the user themselves. As such, if I know/should know that anonymous access is enabled, I can make sense of the response ( as to why more roles are returned ) and if I don't, I probably just care about what roles I have more than why I have them.\nSimilar to why we don't return \"native_roles\": {xxx}, \"roles_from_role_mapping_based_on_groups\": {},  \"roles_from_role_mapping_based_on_username\": {},  \"roles_from_role_mapping_based_on_metadata\": {} , I believe we shouldn't be adding anonymous_roles here. The purpose of the API is to tell us which roles the user has, but not why they have them.", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392107805", "createdAt": "2020-03-13T09:12:27Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/RestAuthenticateAction.java", "diffHunk": "@@ -65,7 +70,16 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 new RestBuilderListener<AuthenticateResponse>(channel) {\n             @Override\n             public RestResponse buildResponse(AuthenticateResponse authenticateResponse, XContentBuilder builder) throws Exception {\n-                authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                if (anonymousEnabled\n+                    && false == anonymousUser.equals(authenticateResponse.authentication().getUser())\n+                    && anonymousUser.roles().length != 0) {\n+                    builder.startObject();\n+                    authenticateResponse.authentication().toXContentFragment(builder);\n+                    builder.array(User.Fields.ANONYMOUS_ROLES.getPreferredName(), anonymousUser.roles());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "149c6f8a80b4ebb50d09a895e103f09f371b7f3d"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjE0OTUxNw==", "bodyText": "One approach is to add an new anonymousRoles field to User class and populate it during authentication.\n\nI think the best way forward is to actually do this ( no need to add a field to User), but evaluate the anonymous roles during authentication (i.e. right after the realms return the User in AuthenticationService#consumeToken ) instead of during authorization.\nIf we don't want to do this now, but defer it to a later point ( or as part of the effort to refactor the logic around AuthenticationTokens ), I think this fits better in the Transport Action than in the Rest one.", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r392149517", "createdAt": "2020-03-13T10:37:01Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/RestAuthenticateAction.java", "diffHunk": "@@ -65,7 +70,16 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 new RestBuilderListener<AuthenticateResponse>(channel) {\n             @Override\n             public RestResponse buildResponse(AuthenticateResponse authenticateResponse, XContentBuilder builder) throws Exception {\n-                authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                if (anonymousEnabled\n+                    && false == anonymousUser.equals(authenticateResponse.authentication().getUser())\n+                    && anonymousUser.roles().length != 0) {\n+                    builder.startObject();\n+                    authenticateResponse.authentication().toXContentFragment(builder);\n+                    builder.array(User.Fields.ANONYMOUS_ROLES.getPreferredName(), anonymousUser.roles());\n+                    builder.endObject();\n+                } else {\n+                    authenticateResponse.authentication().toXContent(builder, ToXContent.EMPTY_PARAMS);\n+                }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTQ2MzExNQ=="}, "originalCommit": {"oid": "98a319d4c32b92faa66ab2af6480cd28b5317512"}, "originalPosition": 37}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "149c6f8a80b4ebb50d09a895e103f09f371b7f3d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/149c6f8a80b4ebb50d09a895e103f09f371b7f3d", "committedDate": "2020-03-13T01:20:13Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}, "afterCommit": {"oid": "19a3307df519a85eaa1ad6fb0031b87a068045b5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/19a3307df519a85eaa1ad6fb0031b87a068045b5", "committedDate": "2020-03-20T05:02:52Z", "message": "Move anonymous role merging from authz to authc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dac757111f96b407a0fd86884c761d2c041b4bb", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/8dac757111f96b407a0fd86884c761d2c041b4bb", "committedDate": "2020-03-20T05:22:46Z", "message": "Move anonymous role merging from authz to authc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "committedDate": "2020-03-20T05:22:46Z", "message": "Update rest tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3dca6289db618f95c9677b37fa1aeed0ae9ae960", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3dca6289db618f95c9677b37fa1aeed0ae9ae960", "committedDate": "2020-03-20T05:20:34Z", "message": "Update rest tests"}, "afterCommit": {"oid": "09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/09df4fbd611cb358b463cfbd527fe4cfaf9a501a", "committedDate": "2020-03-20T05:22:46Z", "message": "Update rest tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e24072aae10802bccd9488a28507c4b1dd713634", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e24072aae10802bccd9488a28507c4b1dd713634", "committedDate": "2020-03-20T05:43:49Z", "message": "Add unit tests for authenticationService"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf8516c1827344442a5bfc417eda8e918409f81", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/2cf8516c1827344442a5bfc417eda8e918409f81", "committedDate": "2020-03-20T05:48:46Z", "message": "Remove unnecessary authorizationService test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c5531b19914ce808a14548df0373f45a0d4a4b2", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c5531b19914ce808a14548df0373f45a0d4a4b2", "committedDate": "2020-03-20T06:25:15Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "903b805760bc0335b06de7d8b13afe8222f89506", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/903b805760bc0335b06de7d8b13afe8222f89506", "committedDate": "2020-03-20T08:27:03Z", "message": "style"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMDY5ODc5", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-380069879", "createdAt": "2020-03-24T08:00:15Z", "commit": {"oid": "903b805760bc0335b06de7d8b13afe8222f89506"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODowMDoxNlrOF6kjow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQwODoxNTo0M1rOF6lAyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2MDY3NQ==", "bodyText": "Do we guarantee order ? if not maybe containsInAnyOrder() is better here ?", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396960675", "createdAt": "2020-03-24T08:00:16Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/qa/basic-enable-security/src/test/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -126,7 +126,7 @@ private void checkAuthentication() throws IOException {\n         final Map<String, Object> auth = getAsMap(\"/_security/_authenticate\");\n         // From file realm, configured in build.gradle\n         assertThat(ObjectPath.evaluate(auth, \"username\"), equalTo(\"security_test_user\"));\n-        assertThat(ObjectPath.evaluate(auth, \"roles\"), contains(\"security_test_role\"));\n+        assertThat(ObjectPath.evaluate(auth, \"roles\"), contains(\"security_test_role\", \"anonymous\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "903b805760bc0335b06de7d8b13afe8222f89506"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2Mzg0MA==", "bodyText": "nit: this implies that we have some special handling when merging the anonymous roles, while we just merge the two String arrays. I get that this is cleaner than doing it twice above but maybe a more generic mergeRoles where you pass both existingRoles and anonymoysUser.roles? Just a suggestion though", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396963840", "createdAt": "2020-03-24T08:06:49Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = new User(\n+                    user.principal(),\n+                    mergeAnonymousRoles(user.roles()),\n+                    user.fullName(),\n+                    user.email(),\n+                    user.metadata(),\n+                    user.enabled()\n+                );\n+                if (user.isRunAs()) {\n+                    final User authenticatedUserWithMergedRoles = new User(\n+                        user.authenticatedUser().principal(),\n+                        mergeAnonymousRoles(user.authenticatedUser().roles()),\n+                        user.authenticatedUser().fullName(),\n+                        user.authenticatedUser().email(),\n+                        user.authenticatedUser().metadata(),\n+                        user.authenticatedUser().enabled()\n+                    );\n+                    userWithMergedRoles = new User(userWithMergedRoles, authenticatedUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return user;\n+            }\n+        }\n+\n+        private String[] mergeAnonymousRoles(String[] existingRoles) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "903b805760bc0335b06de7d8b13afe8222f89506"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njk2ODEzNg==", "bodyText": "Shouldn't we create a Set here and Collections.addAll so that we don't end up with duplicate roles in case the anonymous roles contains a role the user already has ?", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r396968136", "createdAt": "2020-03-24T08:15:43Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = new User(\n+                    user.principal(),\n+                    mergeAnonymousRoles(user.roles()),\n+                    user.fullName(),\n+                    user.email(),\n+                    user.metadata(),\n+                    user.enabled()\n+                );\n+                if (user.isRunAs()) {\n+                    final User authenticatedUserWithMergedRoles = new User(\n+                        user.authenticatedUser().principal(),\n+                        mergeAnonymousRoles(user.authenticatedUser().roles()),\n+                        user.authenticatedUser().fullName(),\n+                        user.authenticatedUser().email(),\n+                        user.authenticatedUser().metadata(),\n+                        user.authenticatedUser().enabled()\n+                    );\n+                    userWithMergedRoles = new User(userWithMergedRoles, authenticatedUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return user;\n+            }\n+        }\n+\n+        private String[] mergeAnonymousRoles(String[] existingRoles) {\n+            String[] mergedRoles = new String[existingRoles.length + anonymousUser.roles().length];\n+            System.arraycopy(existingRoles, 0, mergedRoles, 0, existingRoles.length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "903b805760bc0335b06de7d8b13afe8222f89506"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c17175793e4d505bec9a18d4977d93698662c05f", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c17175793e4d505bec9a18d4977d93698662c05f", "committedDate": "2020-03-24T08:31:31Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c43f8ba959e20e01c66b988a68c0dd23db57307b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c43f8ba959e20e01c66b988a68c0dd23db57307b", "committedDate": "2020-03-24T08:48:24Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "857c9e49239a58ae977c9ca7798782f313956e21", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/857c9e49239a58ae977c9ca7798782f313956e21", "committedDate": "2020-03-24T09:02:14Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1deaa58b5b18984be64588c5d45fca4236d24c42", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/1deaa58b5b18984be64588c5d45fca4236d24c42", "committedDate": "2020-03-24T09:04:03Z", "message": "Remove extra empty line"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMTc5NTI2", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-380179526", "createdAt": "2020-03-24T10:31:29Z", "commit": {"oid": "1deaa58b5b18984be64588c5d45fca4236d24c42"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDozMToyOVrOF6p_oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMDozMToyOVrOF6p_oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA0OTc2MQ==", "bodyText": "I'm also a bit worried about duplicating the check here. Should we make \n  \n    \n      elasticsearch/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/AuthorizationService.java\n    \n    \n         Line 418\n      in\n      9467dbf\n    \n    \n    \n    \n\n        \n          \n           private boolean isInternalUser(User user) { \n        \n    \n  \n\n public, update it to take AsyncSearchUSer into consideration ( which was missed when we introduced AsyncSearchUser - point in case )  and use that as a single source of truth for the check here ?", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397049761", "createdAt": "2020-03-24T10:31:29Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,45 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeMergeAnonymousRolesForUser(User user) {\n+            if (SystemUser.is(user) || XPackUser.is(user) || XPackSecurityUser.is(user) || AsyncSearchUser.is(user)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1deaa58b5b18984be64588c5d45fca4236d24c42"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe6eae8f8e4271b8afee60ebef2f8d9c10904ced", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe6eae8f8e4271b8afee60ebef2f8d9c10904ced", "committedDate": "2020-03-24T11:45:53Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fcbfadf54bec9a12e3d77dae3b0933b00ff08bc", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/2fcbfadf54bec9a12e3d77dae3b0933b00ff08bc", "committedDate": "2020-03-24T12:22:06Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72d26671843771d69ff4a0d8045f9cd4f4afb8f5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/72d26671843771d69ff4a0d8045f9cd4f4afb8f5", "committedDate": "2020-03-24T13:45:16Z", "message": "Fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65faa2cc10bce07ebb1d3b2ead04763099dc7645", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/65faa2cc10bce07ebb1d3b2ead04763099dc7645", "committedDate": "2020-03-24T13:50:05Z", "message": "Fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c686985ba93b28214042b9f85765cb4dd3ec4856", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c686985ba93b28214042b9f85765cb4dd3ec4856", "committedDate": "2020-03-24T14:01:35Z", "message": "Refactor for clarity"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "faa0471a560cb9d8768ef66187876475878bc212", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/faa0471a560cb9d8768ef66187876475878bc212", "committedDate": "2020-03-24T23:24:59Z", "message": "Refactor for more predictable behaviour"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTQwNzQ2", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-380940746", "createdAt": "2020-03-25T08:33:39Z", "commit": {"oid": "faa0471a560cb9d8768ef66187876475878bc212"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwODozMzozOVrOF7Qh6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQwODo1MToxNVrOF7RHWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4MTEzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    private User dedupUserRoles(User user) {\n          \n          \n            \n                    private User deduplicateUserRoles(User user) {", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397681131", "createdAt": "2020-03-25T08:33:39Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa0471a560cb9d8768ef66187876475878bc212"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY4OTQ5NA==", "bodyText": "Do we have to do the length check ? Can't this always be user.withRoles(Set.of(user.roles()).toArray(new String[0]));", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397689494", "createdAt": "2020-03-25T08:49:08Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {\n+            final Set<String> userRoles = new LinkedHashSet<>(Arrays.asList(user.roles()));\n+            User userWithDedupRoles = userRoles.size() == user.roles().length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa0471a560cb9d8768ef66187876475878bc212"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzY5MDcxMg==", "bodyText": "same as above", "url": "https://github.com/elastic/elasticsearch/pull/53453#discussion_r397690712", "createdAt": "2020-03-25T08:51:15Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -690,6 +694,51 @@ void writeAuthToContext(Authentication authentication) {\n         private void authenticateToken(AuthenticationToken token) {\n             this.consumeToken(token);\n         }\n+\n+        private User maybeConsolidateRolesForUser(User user) {\n+            if (User.isInternal(user)) {\n+                return user;\n+            } else if (isAnonymousUserEnabled && anonymousUser.equals(user) == false) {\n+                if (anonymousUser.roles().length == 0) {\n+                    throw new IllegalStateException(\"anonymous is only enabled when the anonymous user has roles\");\n+                }\n+                User userWithMergedRoles = user.withRoles(mergeRoles(user.roles(), anonymousUser.roles()));\n+                if (user.isRunAs()) {\n+                    final User authUserWithMergedRoles = user.authenticatedUser().withRoles(\n+                        mergeRoles(user.authenticatedUser().roles(), anonymousUser.roles()));\n+                    userWithMergedRoles = new User(userWithMergedRoles, authUserWithMergedRoles);\n+                }\n+                return userWithMergedRoles;\n+            } else {\n+                return dedupUserRoles(user);\n+            }\n+        }\n+\n+        private String[] mergeRoles(String[] existingRoles, String[] otherRoles) {\n+            Set<String> roles = new LinkedHashSet<>(Arrays.asList(existingRoles));\n+            if (otherRoles != null) {\n+                Collections.addAll(roles, otherRoles);\n+            }\n+            return roles.toArray(new String[0]);\n+        }\n+\n+        private User dedupUserRoles(User user) {\n+            final Set<String> userRoles = new LinkedHashSet<>(Arrays.asList(user.roles()));\n+            User userWithDedupRoles = userRoles.size() == user.roles().length\n+                ? user\n+                : user.withRoles(userRoles.toArray(new String[0]));\n+\n+            if (user.isRunAs()) {\n+                final Set <String> authUserRoles = new LinkedHashSet<>(Arrays.asList(user.authenticatedUser().roles()));\n+                User authUserWithDedupRoles = authUserRoles.size() == user.authenticatedUser().roles().length", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "faa0471a560cb9d8768ef66187876475878bc212"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "384aa17e2003061b60f2cd727561d638c6dad656", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/384aa17e2003061b60f2cd727561d638c6dad656", "committedDate": "2020-03-26T00:44:33Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fa37e48c913c1f1e08c29b5605fbbfa87ae819e", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fa37e48c913c1f1e08c29b5605fbbfa87ae819e", "committedDate": "2020-03-26T00:44:49Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fd8249dc81c2b84a7c9a48a1a89f953d1b54279", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fd8249dc81c2b84a7c9a48a1a89f953d1b54279", "committedDate": "2020-03-26T02:03:58Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7f259ecf77773a34d476779816b16afd88105d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc7f259ecf77773a34d476779816b16afd88105d", "committedDate": "2020-04-08T04:42:59Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a8bd636cc6b45396cd791aef5d2a12d261a279a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a8bd636cc6b45396cd791aef5d2a12d261a279a", "committedDate": "2020-04-08T06:59:25Z", "message": "Deduplicate roles for file and native realms earlier in the chain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6af416ced443f194ff98bf3af6c2e7739f554798", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/6af416ced443f194ff98bf3af6c2e7739f554798", "committedDate": "2020-04-08T09:20:56Z", "message": "Remove unnecessary tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2892218e148505bc7bb82372e57a4d8827e5acd0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/2892218e148505bc7bb82372e57a4d8827e5acd0", "committedDate": "2020-04-08T11:44:11Z", "message": "Update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6a8aa136e74b4454114c2f85a98f446ee959ead", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6a8aa136e74b4454114c2f85a98f446ee959ead", "committedDate": "2020-04-22T07:33:20Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMzk3NjEy", "url": "https://github.com/elastic/elasticsearch/pull/53453#pullrequestreview-402397612", "createdAt": "2020-04-29T06:43:24Z", "commit": {"oid": "c6a8aa136e74b4454114c2f85a98f446ee959ead"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c63c49faba17900a2f2322c9606a3f451879489d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c63c49faba17900a2f2322c9606a3f451879489d", "committedDate": "2020-04-30T00:30:48Z", "message": "Merge remote-tracking branch 'origin/master' into es-47195-anonymous-role"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1524, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}