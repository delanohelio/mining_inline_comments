{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1ODM3ODE2", "number": 53317, "title": "Enable deprecation checks for removed settings", "bodyText": "Today we do not have any infrastructure for adding a deprecation check for settings that are removed. This commit enables this by adding such infrastructure. Note that this infrastructure is unused in this commit, which is deliberate. However, the primary target for this commit is 7.x where this infrastructure will be used, in a follow-up.", "createdAt": "2020-03-09T21:57:11Z", "url": "https://github.com/elastic/elasticsearch/pull/53317", "merged": true, "mergeCommit": {"oid": "ee31217ba5b46c9847710a7b9263b673055bbd16"}, "closed": true, "closedAt": "2020-03-11T20:44:48Z", "author": {"login": "jasontedor"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMFKYJAH2gAyMzg1ODM3ODE2OmU1NDExMGUyZTllZjZkYmVmMGY5NzdlZmE0ZTk3MWUzNGFmYTU0NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMshMPgFqTM3MzA3MTIxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e54110e2e9ef6dbef0f977efa4e971e34afa5470", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/e54110e2e9ef6dbef0f977efa4e971e34afa5470", "committedDate": "2020-03-09T21:54:02Z", "message": "Enable deprecation checks for removed settings\n\nToday we do not have any infrastructure for adding a deprecation check\nfor settings that are removed. This commit enables this by adding such\ninfrastructure. Note that this infrastructure is unused in this commit,\nwhich is deliberate. However, the primary target for this commit is 7.x\nwhere this infrastructue will be used, in a follow-up."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b29c683068d42010a7b3660b97e7e221eccce932", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/b29c683068d42010a7b3660b97e7e221eccce932", "committedDate": "2020-03-09T21:57:03Z", "message": "Fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c36611760b19cb9988eed01e9085c36f40ace52a", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c36611760b19cb9988eed01e9085c36f40ace52a", "committedDate": "2020-03-09T22:49:09Z", "message": "Fix forbidden call"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42b5aadae1e857a09d734569ba9af1417cd9c7fc", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/42b5aadae1e857a09d734569ba9af1417cd9c7fc", "committedDate": "2020-03-09T23:05:08Z", "message": "Consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb7740a4085b1f912d14f922fff1c32d45a348c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb7740a4085b1f912d14f922fff1c32d45a348c", "committedDate": "2020-03-11T12:43:38Z", "message": "Merge branch 'master' into removed-setting-deprecation-check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNzIyNjgy", "url": "https://github.com/elastic/elasticsearch/pull/53317#pullrequestreview-372722682", "createdAt": "2020-03-11T12:44:02Z", "commit": {"oid": "42b5aadae1e857a09d734569ba9af1417cd9c7fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo0NDowM1rOF01Tow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxMjo0NDowM1rOF01Tow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDk0MzY1MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = List.of();\n          \n          \n            \n                static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = Collections.emptyList();", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r390943651", "createdAt": "2020-03-11T12:44:03Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationChecks.java", "diffHunk": "@@ -33,7 +33,7 @@ private DeprecationChecks() {\n     static List<Function<ClusterState, DeprecationIssue>> CLUSTER_SETTINGS_CHECKS =\n         Collections.emptyList();\n \n-    static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = Collections.emptyList();\n+    static List<BiFunction<Settings, PluginsAndModules, DeprecationIssue>> NODE_SETTINGS_CHECKS = List.of();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "42b5aadae1e857a09d734569ba9af1417cd9c7fc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9a24da88caea12d0d272806051cc7a8aec5d74d", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9a24da88caea12d0d272806051cc7a8aec5d74d", "committedDate": "2020-03-11T12:44:07Z", "message": "Update x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/DeprecationChecks.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDEyNTAx", "url": "https://github.com/elastic/elasticsearch/pull/53317#pullrequestreview-373012501", "createdAt": "2020-03-11T18:18:06Z", "commit": {"oid": "e9a24da88caea12d0d272806051cc7a8aec5d74d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxODoxODowN1rOF1DQ4A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxODoxODowN1rOF1DQ4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTE3MjMyMA==", "bodyText": "should this be WARNING instead of CRITICAL ?\nIf the setting is removed, won't it be be \"archived\" allowing the server to continue to function ? I think we are trying to reserve CRITICAL for things items that will prevent the server from running.", "url": "https://github.com/elastic/elasticsearch/pull/53317#discussion_r391172320", "createdAt": "2020-03-11T18:18:07Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.xpack.core.deprecation.DeprecationIssue;\n+\n+import java.util.Locale;\n+\n+public class NodeDeprecationChecks {\n+\n+    static DeprecationIssue checkRemovedSetting(final Settings settings, final Setting<?> removedSetting, final String url) {\n+        if (removedSetting.exists(settings) == false) {\n+            return null;\n+        }\n+        final String removedSettingKey = removedSetting.getKey();\n+        final String value = removedSetting.get(settings).toString();\n+        final String message =\n+            String.format(Locale.ROOT, \"setting [%s] is deprecated and will be removed in the next major version\", removedSettingKey);\n+        final String details =\n+            String.format(Locale.ROOT, \"the setting [%s] is currently set to [%s], remove this setting\", removedSettingKey, value);\n+        return new DeprecationIssue(DeprecationIssue.Level.CRITICAL, message, url, details);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9a24da88caea12d0d272806051cc7a8aec5d74d"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczMDcxMjE4", "url": "https://github.com/elastic/elasticsearch/pull/53317#pullrequestreview-373071218", "createdAt": "2020-03-11T19:45:15Z", "commit": {"oid": "e9a24da88caea12d0d272806051cc7a8aec5d74d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1675, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}