{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwNjQyMjIy", "number": 56986, "title": "Remove Mapper.updateFieldType()", "bodyText": "When we had multiple mapping types, an update to a field in one type had to be\npropagated to the same field in all other types.  This was done using the\nMapper.updateFieldType() method, called at the end of a merge.  However, now\nthat we only have a single type per index, this method is unnecessary and can\nbe removed.\nRelates to #41059", "createdAt": "2020-05-20T09:57:34Z", "url": "https://github.com/elastic/elasticsearch/pull/56986", "merged": true, "mergeCommit": {"oid": "fed71fbd669c30181df2663aa30384773534da7e"}, "closed": true, "closedAt": "2020-05-26T12:06:14Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjGAGJAH2gAyNDIwNjQyMjIyOmU2ZDA4N2JlNWY3MTBmMTE1MjEyMzI4OGUwN2UyNDgyMDMwYjdhYmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclC4sggH2gAyNDIwNjQyMjIyOjcyYTM1N2VhOGNjNGEzMzExZDBjZmUxZDcyNDI4MGI4NWFlYjU1OWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e6d087be5f710f1152123288e07e2482030b7abf", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6d087be5f710f1152123288e07e2482030b7abf", "committedDate": "2020-05-20T09:52:58Z", "message": "Remove Mapper.updateFieldType()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/b66c60eba70c0cdfdb8b1dc6a358c19940346eab", "committedDate": "2020-05-20T12:01:57Z", "message": "MetaJoinMapperField uses a fieldname lookup rather than holding a reference to the mapper"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1MzAxOTIz", "url": "https://github.com/elastic/elasticsearch/pull/56986#pullrequestreview-415301923", "createdAt": "2020-05-20T12:55:32Z", "commit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjo1NTozMlrOGYKKnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxMjo1Njo0M1rOGYKN1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NTU2NA==", "bodyText": "ParentJoinFieldMapper was using updateFieldType() to update its linked MetaJoinFieldMapper.  This requires a small bit of hackery to get round, which I hope to fix in a followup by moving the various filter factory methods from the field mapper to the field type.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r427985564", "createdAt": "2020-05-20T12:55:32Z", "author": {"login": "romseygeek"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentJoinFieldMapper.java", "diffHunk": "@@ -85,7 +85,8 @@\n     public static ParentJoinFieldMapper getMapper(MapperService service) {\n         MetaJoinFieldMapper.MetaJoinFieldType fieldType =\n             (MetaJoinFieldMapper.MetaJoinFieldType) service.fieldType(MetaJoinFieldMapper.NAME);\n-        return fieldType == null ? null : fieldType.getMapper();\n+        return fieldType == null ? null :\n+            (ParentJoinFieldMapper) service.fieldMapper(fieldType.getJoinField());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NjM4OA==", "bodyText": "This is unfortunately necessary as a shim to get round the ParentJoinFieldMapper issue above.  Hopefully removed asap.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r427986388", "createdAt": "2020-05-20T12:56:43Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -590,6 +584,10 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.get(fullName);\n     }\n \n+    public Mapper fieldMapper(String fieldName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "originalPosition": 55}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1NTk4NDQ0", "url": "https://github.com/elastic/elasticsearch/pull/56986#pullrequestreview-415598444", "createdAt": "2020-05-20T18:20:31Z", "commit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQxODoyMDozMVrOGYYOkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMFQyMDozMzowMVrOGYcyUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNTk1NQ==", "bodyText": "I think we could remove this whole method assertMappersShareSameFieldType, it doesn't seem helpful now that we only have one type.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428215955", "createdAt": "2020-05-20T18:20:31Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -439,7 +431,9 @@ private boolean assertMappersShareSameFieldType() {\n             Collections.addAll(fieldMappers, mapper.mapping().metadataMappers);\n             MapperUtils.collect(mapper.root(), new ArrayList<>(), fieldMappers, new ArrayList<>());\n             for (FieldMapper fieldMapper : fieldMappers) {\n-                assert fieldMapper.fieldType() == fieldTypes.get(fieldMapper.name()) : fieldMapper.name();\n+                assert Objects.equals(fieldMapper.fieldType(), fieldTypes.get(fieldMapper.name())) :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "originalPosition": 45}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODIxNjAyNQ==", "bodyText": "If I'm understanding correctly, we can now assume existingFieldType will always be null, since there is only one type. In that case we could remove the logic above too, including the method createBuilderFromFieldType.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428216025", "createdAt": "2020-05-20T18:20:38Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -812,10 +812,6 @@ private static void parseDynamicValue(final ParseContext context, ObjectMapper p\n             builder = createBuilderFromDynamicValue(context, token, currentFieldName);\n         }\n         Mapper mapper = builder.build(builderContext);\n-        if (existingFieldType != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODI5MDY0MQ==", "bodyText": "Could we avoid adding this new method and call this inline in ParentJoinFieldMapper? All the methods like documentMapper() are public, so it seems do-able.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428290641", "createdAt": "2020-05-20T20:33:01Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -590,6 +584,10 @@ public MappedFieldType fieldType(String fullName) {\n         return fieldTypes.get(fullName);\n     }\n \n+    public Mapper fieldMapper(String fieldName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzk4NjM4OA=="}, "originalCommit": {"oid": "b66c60eba70c0cdfdb8b1dc6a358c19940346eab"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ca0d7f377f69fbd36b6a5e01f01d7398676ffea", "committedDate": "2020-05-21T12:52:22Z", "message": "feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MTIzOTE5", "url": "https://github.com/elastic/elasticsearch/pull/56986#pullrequestreview-416123919", "createdAt": "2020-05-21T13:00:25Z", "commit": {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMzowMDoyNVrOGYx3nQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxMzowMDoyNVrOGYx3nQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODYzNjA2MQ==", "bodyText": "I wasted several hours trying to work out why my mocked DocumentMapper class wasn't returning the DocumentFieldMapper instance I was asking it to.  This appears to be unnecessary, so I've removed it", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428636061", "createdAt": "2020-05-21T13:00:25Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -295,10 +293,6 @@ public boolean shouldCache(Query query) {\n         MapperService mapperService = mapperServiceMock();\n         when(mapperService.getIndexSettings()).thenReturn(indexSettings);\n         when(mapperService.hasNested()).thenReturn(false);\n-        DocumentMapper mapper = mock(DocumentMapper.class);\n-        when(mapper.typeText()).thenReturn(new Text(TYPE_NAME));\n-        when(mapper.type()).thenReturn(TYPE_NAME);\n-        when(mapperService.documentMapper()).thenReturn(mapper);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Mjc4NzAx", "url": "https://github.com/elastic/elasticsearch/pull/56986#pullrequestreview-416278701", "createdAt": "2020-05-21T15:58:16Z", "commit": {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTo1ODoxNlrOGY40aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTo1ODoxNlrOGY40aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc0OTkzMQ==", "bodyText": "I think we can delete createBuilderFromFieldType now, since it's unused.", "url": "https://github.com/elastic/elasticsearch/pull/56986#discussion_r428749931", "createdAt": "2020-05-21T15:58:16Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -801,16 +801,8 @@ private static void parseDynamicValue(final ParseContext context, ObjectMapper p\n         if (dynamic == ObjectMapper.Dynamic.FALSE) {\n             return;\n         }\n-        final String path = context.path().pathAsText(currentFieldName);\n         final Mapper.BuilderContext builderContext = new Mapper.BuilderContext(context.indexSettings().getSettings(), context.path());\n-        final MappedFieldType existingFieldType = context.mapperService().fieldType(path);\n-        final Mapper.Builder builder;\n-        if (existingFieldType != null) {\n-            // create a builder of the same type\n-            builder = createBuilderFromFieldType(context, existingFieldType, currentFieldName);\n-        } else {\n-            builder = createBuilderFromDynamicValue(context, token, currentFieldName);\n-        }\n+        final Mapper.Builder<?> builder = createBuilderFromDynamicValue(context, token, currentFieldName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ca0d7f377f69fbd36b6a5e01f01d7398676ffea"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de25af92b3bdce9ca6b8164f363408883fc4bbe5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/de25af92b3bdce9ca6b8164f363408883fc4bbe5", "committedDate": "2020-05-21T17:20:49Z", "message": "Remove Mapper.updateFieldType()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71abe8e5df8f8853c59ebf541856846d6e7991ef", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/71abe8e5df8f8853c59ebf541856846d6e7991ef", "committedDate": "2020-05-21T17:20:49Z", "message": "MetaJoinMapperField uses a fieldname lookup rather than holding a reference to the mapper"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b710a50163e3f887ca4dc6097ea3a3c57f29461f", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/b710a50163e3f887ca4dc6097ea3a3c57f29461f", "committedDate": "2020-05-21T17:20:49Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdae94408f77a79a31f730e798fb1a68e641052f", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdae94408f77a79a31f730e798fb1a68e641052f", "committedDate": "2020-05-21T17:22:56Z", "message": "remove unused method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33a0faf16e07d00b61f4c9065470ac6c6010e218", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/33a0faf16e07d00b61f4c9065470ac6c6010e218", "committedDate": "2020-05-21T17:30:10Z", "message": "Merge remote-tracking branch 'romseygeek/mapper/update-field-type' into mapper/update-field-type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72a357ea8cc4a3311d0cfe1d724280b85aeb559e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/72a357ea8cc4a3311d0cfe1d724280b85aeb559e", "committedDate": "2020-05-26T11:23:01Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/update-field-type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4727, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}