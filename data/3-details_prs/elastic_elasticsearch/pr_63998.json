{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3NTA1NjUy", "number": 63998, "title": "Remove QueryShardContext#getMapperService", "bodyText": "We have been removing usages of getMapperService with the purpose of removing the method at some point. This is so we don't have to expose the entire MapperService to all of the users of QueryShardContext, but rather only specific methods so we can better control its usages, especially around resolving field types.\nThis commit removes the last few usages and adds the missing methods to QueryShardContext. They all revolve around retrieving DocumentMapper from MapperService, yet we can expose specific methods without even exposing DocumentMapper, which would also cause issues.", "createdAt": "2020-10-21T12:41:05Z", "url": "https://github.com/elastic/elasticsearch/pull/63998", "merged": true, "mergeCommit": {"oid": "3efcc55693515fc2d9b100e1720417ea10046c86"}, "closed": true, "closedAt": "2020-10-22T08:06:46Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUsr93AH2gAyNTA3NTA1NjUyOjdjZjg2MGNjYzY0ZmE3ZjZlZGU3YTMxNjEzYjhmMmZjZTk1NjJlYzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUuFhTgFqTUxMzczODUzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5", "committedDate": "2020-10-21T12:39:34Z", "message": "Remove QueryShardContext#getMapperService\n\nWe have been removing usages of getMapperService with the purpose of removing the method at some point. This is so we don't have to expose the entire MapperService to all of the users of QueryShardContext, but rather only specific methods so we can better control its usages, especially around resolving field types.\n\nThis commit removes the last few usages and adds the missing methods to QueryShardContext. They all revolve around retrieving DocumentMapper from MapperService, yet we can expose specific methods without even exposing DocumentMapper, which would also cause issues."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNjM5MDA2", "url": "https://github.com/elastic/elasticsearch/pull/63998#pullrequestreview-513639006", "createdAt": "2020-10-21T12:49:58Z", "commit": {"oid": "7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo0OTo1OFrOHlqIng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMjo0OTo1OFrOHlqIng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTI0OTY5NA==", "bodyText": "This is only used for the RandomScoreFunctionBuilder, correct?  Do we need to add it, or can we just remove that 'no mappings' special case?", "url": "https://github.com/elastic/elasticsearch/pull/63998#discussion_r509249694", "createdAt": "2020-10-21T12:49:58Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -216,6 +221,23 @@ public void addNamedQuery(String name, Query query) {\n         return Map.copyOf(namedQueries);\n     }\n \n+    public ParsedDocument parseDocument(SourceToParse source) throws MapperParsingException {\n+        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().parse(source);\n+    }\n+\n+    public FieldNameAnalyzer getFieldNameIndexAnalyzer() {\n+        DocumentMapper documentMapper = mapperService.documentMapper();\n+        return documentMapper == null ? null : documentMapper.mappers().indexAnalyzer();\n+    }\n+\n+    public boolean hasNested() {\n+        return mapperService.hasNested();\n+    }\n+\n+    public boolean hasMappings() {\n+        return mapperService.documentMapper() != null;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cf860ccc64fa7f6ede7a31613b8f2fce9562ec5"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36dea78a5e8c53c910b9784438a2739a83758aba", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/36dea78a5e8c53c910b9784438a2739a83758aba", "committedDate": "2020-10-21T13:18:14Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzNzM4NTM5", "url": "https://github.com/elastic/elasticsearch/pull/63998#pullrequestreview-513738539", "createdAt": "2020-10-21T14:17:23Z", "commit": {"oid": "36dea78a5e8c53c910b9784438a2739a83758aba"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1069, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}