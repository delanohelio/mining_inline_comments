{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MTMzMTUw", "number": 55276, "title": "Remove Redundant CS Update on Snapshot Finalization", "bodyText": "This change folds the removal of the in-progress snapshot entry\ninto setting the safe repository generation.\nOutside of removing an unnecessary cluster state update, this also has the advantage\nof removing a somewhat inconsistent cluster state where the safe repository generation points at RepositoryData that contains a finished snapshot while it is still in-progress in the cluster\nstate, making it easier to reason about the state machine of upcoming concurrent snapshot operations.\nNote: We can do the same for snapshot deletion where it is a much more interesting change because most of the work in the delete (deleting all unreferenced blobs) can happen after the new index-N is written and does not require the delete-in-progress entry in the cluster state (assuming the repo is using shard-generations). I just wanted to start with the snapshot finalization since it's much easier to review and has no BwC implications.", "createdAt": "2020-04-16T05:52:10Z", "url": "https://github.com/elastic/elasticsearch/pull/55276", "merged": true, "mergeCommit": {"oid": "e9fbfea1b7f4f6276470c1eaf6a6cac7bacf4bcd"}, "closed": true, "closedAt": "2020-04-21T12:03:23Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYGFqmgH2gAyNDA0MTMzMTUwOjY2YjNmZmMyMzcxN2VlYTExN2RlYTVkNmRmN2RmNTg1NTZiMDFlMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZyH3ZAFqTM5NzI0NDI3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66b3ffc23717eea117dea5d6df7df58556b01e18", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/66b3ffc23717eea117dea5d6df7df58556b01e18", "committedDate": "2020-04-16T05:45:53Z", "message": "Remove Redundant CS Update on Snapshot Finalization\n\nThis change folds the removal of the in-progress snapshot entry\ninto setting the safe repository generation. Outside of removing\nan unnecessary cluster state update, this also has the advantage\nof removing a somewhat inconsistent cluster state where the safe\nrepository generation points at `RepositoryData` that contains a\nfinished snapshot while it is still in-progress in the cluster\nstate, making it easier to reason about the state machine of\nupcoming concurrent snapshot operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f82c2646cd52d07db7df20c6e9ed023dac88ee3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f82c2646cd52d07db7df20c6e9ed023dac88ee3", "committedDate": "2020-04-16T05:54:39Z", "message": "noisy indent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0e85eccad661ba7f9c5cc895c9cc0afa58042d1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0e85eccad661ba7f9c5cc895c9cc0afa58042d1", "committedDate": "2020-04-16T06:03:30Z", "message": "Merge remote-tracking branch 'elastic/master' into atomic-snapshot-finalization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6c1cbb84d8b0fad70599a09630855cd9e8e20f61", "committedDate": "2020-04-16T07:56:20Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0Mzg1OTA1", "url": "https://github.com/elastic/elasticsearch/pull/55276#pullrequestreview-394385905", "createdAt": "2020-04-16T07:58:14Z", "commit": {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1ODoxNFrOGGZJGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwNzo1ODoxNFrOGGZJGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTM1NjU3MA==", "bodyText": "The concrete situation that this test was covering is technically gone with this change, but I think it's reasonable to keep testing the very similar situation of master fail-over during the repository side of the finalization here now.", "url": "https://github.com/elastic/elasticsearch/pull/55276#discussion_r409356570", "createdAt": "2020-04-16T07:58:14Z", "author": {"login": "original-brownbear"}, "path": "server/src/test/java/org/elasticsearch/discovery/SnapshotDisruptionIT.java", "diffHunk": "@@ -189,8 +189,7 @@ public void clusterChanged(ClusterChangedEvent event) {\n                         final RepositoriesMetadata repoMeta =\n                             event.state().metadata().custom(RepositoriesMetadata.TYPE);\n                         final RepositoryMetadata metadata = repoMeta.repository(\"test-repo\");\n-                        if (metadata.generation() == metadata.pendingGeneration()\n-                            && metadata.generation() > snapshotEntry.repositoryStateId()) {\n+                        if (metadata.pendingGeneration() > snapshotEntry.repositoryStateId()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTIxMjIz", "url": "https://github.com/elastic/elasticsearch/pull/55276#pullrequestreview-397121223", "createdAt": "2020-04-21T08:50:09Z", "commit": {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwODo1MDowOVrOGI6VkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwODo1MDowOVrOGI6VkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTk5NzU4NA==", "bodyText": "It's not a filter, rather a transformation function. Perhaps adapt naming?", "url": "https://github.com/elastic/elasticsearch/pull/55276#discussion_r411997584", "createdAt": "2020-04-21T08:50:09Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1301,10 +1304,11 @@ public boolean isReadOnly() {\n      * @param repositoryData RepositoryData to write\n      * @param expectedGen    expected repository generation at the start of the operation\n      * @param writeShardGens whether to write {@link ShardGenerations} to the new {@link RepositoryData} blob\n+     * @param stateFilter    filter for the last cluster state update executed by this method", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6c1cbb84d8b0fad70599a09630855cd9e8e20f61"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0741cb1a0bcd20826e447b38ada3314616dc6256", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0741cb1a0bcd20826e447b38ada3314616dc6256", "committedDate": "2020-04-21T10:51:39Z", "message": "Merge remote-tracking branch 'elastic/master' into atomic-snapshot-finalization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df04dfe59fe4bf69bb91596dd83050e9d7487bbe", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/df04dfe59fe4bf69bb91596dd83050e9d7487bbe", "committedDate": "2020-04-21T10:56:02Z", "message": "naming"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjQ0Mjc3", "url": "https://github.com/elastic/elasticsearch/pull/55276#pullrequestreview-397244277", "createdAt": "2020-04-21T11:38:02Z", "commit": {"oid": "df04dfe59fe4bf69bb91596dd83050e9d7487bbe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3420, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}