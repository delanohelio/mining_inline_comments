{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNzg3ODQw", "number": 66508, "title": "Make the construction of alias abstractions immutable", "bodyText": "and change validation to be an implementation detail and\npart of construction of the alias abstraction.\nThis change is part of series of changes to clean up the usage\nIndexAbstraction.Alias in the codebase, so that it is no longer\nneeded to cast to IndexAbstraction.Alias and just use the methods\non the IndexAbstraction interface. This should help adding data\nstream aliases, so that IndexAbstraction instances of type ALIAS\ncan also be data stream aliases.\nRelates to #66163", "createdAt": "2020-12-17T11:08:27Z", "url": "https://github.com/elastic/elasticsearch/pull/66508", "merged": true, "mergeCommit": {"oid": "2e907008bb63d48a1455a354d49d53c763e4f944"}, "closed": true, "closedAt": "2021-01-06T08:10:26Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnEl3uAH2gAyNTQxNzg3ODQwOmU0NTk2YjRiNjNmOGEwMmI2NzQ3NjcxNzYyMWFhYzMwNzc1MWEwZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdtNSQYAH2gAyNTQxNzg3ODQwOjdiMGU0YjhmNWU3M2RjZTU0OTRlMjRjYmM4ZTc2NDc2MjliZTkwYmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e4596b4b63f8a02b67476717621aac307751a0e6", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4596b4b63f8a02b67476717621aac307751a0e6", "committedDate": "2020-12-17T14:41:16Z", "message": "Make the construction of alias abstractions immutable\nand change validation to be an implementation detail and\npart of construction of the alias abstraction.\n\nThis change is part of series of changes to clean up the usage\nIndexAbstraction.Alias in the codebase, so that it is no longer\nneeded to cast to IndexAbstraction.Alias and just use the methods\non the IndexAbstraction interface. This should help adding data\nstream aliases, so that IndexAbstraction instances of type ALIAS\ncan also be data stream aliases.\n\nRelates to #66163"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "84c5226c498ed40b62adeabe588a65a666b4bf01", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/84c5226c498ed40b62adeabe588a65a666b4bf01", "committedDate": "2020-12-17T14:13:45Z", "message": "fixed test"}, "afterCommit": {"oid": "e4596b4b63f8a02b67476717621aac307751a0e6", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4596b4b63f8a02b67476717621aac307751a0e6", "committedDate": "2020-12-17T14:41:16Z", "message": "Make the construction of alias abstractions immutable\nand change validation to be an implementation detail and\npart of construction of the alias abstraction.\n\nThis change is part of series of changes to clean up the usage\nIndexAbstraction.Alias in the codebase, so that it is no longer\nneeded to cast to IndexAbstraction.Alias and just use the methods\non the IndexAbstraction interface. This should help adding data\nstream aliases, so that IndexAbstraction instances of type ALIAS\ncan also be data stream aliases.\n\nRelates to #66163"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1ODc1MzIy", "url": "https://github.com/elastic/elasticsearch/pull/66508#pullrequestreview-555875322", "createdAt": "2020-12-18T23:21:53Z", "commit": {"oid": "e4596b4b63f8a02b67476717621aac307751a0e6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzoyMTo1M1rOII17YA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQyMzoyMTo1M1rOII17YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjE0MzA3Mg==", "bodyText": "I didn't follow this case where the write index is set? It seems to me like it could incorrectly match the scenario when there is a single index for the alias but the index has not been specified as the write index for the alias.", "url": "https://github.com/elastic/elasticsearch/pull/66508#discussion_r546143072", "createdAt": "2020-12-18T23:21:53Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -178,14 +176,35 @@ public boolean isSystem() {\n \n         private final String aliasName;\n         private final List<IndexMetadata> referenceIndexMetadatas;\n-        private final SetOnce<IndexMetadata> writeIndex = new SetOnce<>();\n+        private final IndexMetadata writeIndex;\n         private final boolean isHidden;\n \n-        public Alias(AliasMetadata aliasMetadata, IndexMetadata indexMetadata) {\n+        public Alias(AliasMetadata aliasMetadata, List<IndexMetadata> indices) {\n             this.aliasName = aliasMetadata.getAlias();\n-            this.referenceIndexMetadatas = new ArrayList<>();\n-            this.referenceIndexMetadatas.add(indexMetadata);\n+            this.referenceIndexMetadatas = indices;\n+\n+            List<IndexMetadata> writeIndices = indices.stream()\n+                .filter(idxMeta -> Boolean.TRUE.equals(idxMeta.getAliases().get(aliasName).writeIndex()))\n+                .collect(Collectors.toList());\n+\n+            if (writeIndices.isEmpty() && referenceIndexMetadatas.size() == 1\n+                && referenceIndexMetadatas.get(0).getAliases().get(aliasName).writeIndex() == null) {\n+                writeIndices.add(referenceIndexMetadatas.get(0));\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4596b4b63f8a02b67476717621aac307751a0e6"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b52de132d83b17f27bbad9d434ac46db572df27", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b52de132d83b17f27bbad9d434ac46db572df27", "committedDate": "2021-01-05T08:59:20Z", "message": "Merge branch 'master' into hide_alias_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b0e4b8f5e73dce5494e24cbc8e7647629be90bc", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b0e4b8f5e73dce5494e24cbc8e7647629be90bc", "committedDate": "2021-01-05T16:12:32Z", "message": "Merge branch 'master' into hide_alias_validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4468, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}