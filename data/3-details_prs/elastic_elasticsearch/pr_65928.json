{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzNTM4MzU0", "number": 65928, "title": "[Transform] Always apply range query in continuous mode.", "bodyText": "This PR makes the range query from sync config applied always when the transform is continuous.\nRelates #65817", "createdAt": "2020-12-07T09:51:42Z", "url": "https://github.com/elastic/elasticsearch/pull/65928", "merged": true, "mergeCommit": {"oid": "de17a4a3a23c3f712f13352fc262b2c962e46d39"}, "closed": true, "closedAt": "2020-12-09T06:38:17Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjzEapAFqTU0NjAxOTUwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkKwOXAH2gAyNTMzNTM4MzU0OmRkY2Y0NzY1ODc3Y2YwYjI2ODQxMGQ4YWE3Y2NjZmY0YTRjNmYwNDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDE5NTA4", "url": "https://github.com/elastic/elasticsearch/pull/65928#pullrequestreview-546019508", "createdAt": "2020-12-07T10:34:34Z", "commit": {"oid": "252dc4ec1e916d4c6723eefc9d4485070353dd64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDozNDozNFrOIAgNAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDozNDozNFrOIAgNAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5ODUzMQ==", "bodyText": "config.getSyncConfig() is null for batch mode. Seems to make sense to\n\nbranch based on batch vs. continuous\nadd filter changeCollector.buildFilterQuery only if nextCheckpoint.getCheckpoint() > 1", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r537398531", "createdAt": "2020-12-07T10:34:34Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,14 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n-\n-            return sourceBuilder;\n-        }\n-\n-        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder)\n-            .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));\n-\n-        QueryBuilder filter = changeCollector != null\n-            ? changeCollector.buildFilterQuery(lastCheckpoint.getTimeUpperBound(), nextCheckpoint.getTimeUpperBound())\n-            : null;\n-\n-        if (filter != null) {\n-            filteredQuery.filter(filter);\n+        BoolQueryBuilder filteredQuery =\n+            new BoolQueryBuilder()\n+                .filter(queryBuilder)\n+                .filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "252dc4ec1e916d4c6723eefc9d4485070353dd64"}, "originalPosition": 24}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "252dc4ec1e916d4c6723eefc9d4485070353dd64", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/252dc4ec1e916d4c6723eefc9d4485070353dd64", "committedDate": "2020-12-07T09:45:59Z", "message": "Always apply filter query with upper bound."}, "afterCommit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bb46df4d119b35bcb267eaddfb3ad786a2e008c", "committedDate": "2020-12-08T07:59:27Z", "message": "Always apply range query in continuous mode."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2ODQyNDYy", "url": "https://github.com/elastic/elasticsearch/pull/65928#pullrequestreview-546842462", "createdAt": "2020-12-08T08:14:18Z", "commit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNDoxOFrOIBMhKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwODoxNDoxOFrOIBMhKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODEyNDU4NQ==", "bodyText": "for batch transforms this creates an unnecessary bool clause.\nwhat about:\nQueryBuilder queryBuilder = config.getSource().getQueryConfig().getQuery();\n\nif (isContinuous()) {\n    BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder).filter(config.getSyncConfig().getRangeQuery(nextCheckpoint));\n\n    // Only apply extra filter if its the subsequent run of the continuous transform\n    if (nextCheckpoint.getCheckpoint() > 1 && changeCollector != null) {\n        filteredQuery.filter(changeCollector.buildFilterQuery(lastCheckpoint.getTimeUpperBound(), nextCheckpoint.getTimeUpperBound()));\n    }\n    \n    queryBuilder = filteredQuery;\n}\n\n...\n\nsourceBuilder.query(queryBuilder);", "url": "https://github.com/elastic/elasticsearch/pull/65928#discussion_r538124585", "createdAt": "2020-12-08T08:14:18Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -875,23 +875,15 @@ private SearchSourceBuilder buildUpdateQuery(SearchSourceBuilder sourceBuilder)\n \n         function.buildSearchQuery(sourceBuilder, position != null ? position.getIndexerPosition() : null, pageSize);\n \n-        // if its either the 1st run or not continuous, do not apply extra filters\n-        if (nextCheckpoint.getCheckpoint() == 1 || isContinuous() == false) {\n-            sourceBuilder.query(queryBuilder);\n-            logger.debug(() -> new ParameterizedMessage(\"[{}] Querying for data: {}\", getJobId(), sourceBuilder));\n+        BoolQueryBuilder filteredQuery = new BoolQueryBuilder().filter(queryBuilder);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4410a046dcece8f0434f722f02ac277c84a58a83", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/4410a046dcece8f0434f722f02ac277c84a58a83", "committedDate": "2020-12-08T12:46:07Z", "message": "Always apply range query in continuous mode."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b43c4a771a65eff032fac7408e9b8742020a6b6", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b43c4a771a65eff032fac7408e9b8742020a6b6", "committedDate": "2020-12-08T12:54:18Z", "message": "Apply review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bb46df4d119b35bcb267eaddfb3ad786a2e008c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bb46df4d119b35bcb267eaddfb3ad786a2e008c", "committedDate": "2020-12-08T07:59:27Z", "message": "Always apply range query in continuous mode."}, "afterCommit": {"oid": "5b43c4a771a65eff032fac7408e9b8742020a6b6", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b43c4a771a65eff032fac7408e9b8742020a6b6", "committedDate": "2020-12-08T12:54:18Z", "message": "Apply review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MjE3ODUz", "url": "https://github.com/elastic/elasticsearch/pull/65928#pullrequestreview-547217853", "createdAt": "2020-12-08T13:09:57Z", "commit": {"oid": "5b43c4a771a65eff032fac7408e9b8742020a6b6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddcf4765877cf0b268410d8aa7cccff4a4c6f049", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ddcf4765877cf0b268410d8aa7cccff4a4c6f049", "committedDate": "2020-12-08T14:10:14Z", "message": "Make sure filter query is not null before adding it to bool query"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4046, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}