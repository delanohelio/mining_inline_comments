{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2NDk5MTQ0", "number": 51366, "title": "Use '--cursor-after' flag to get recent journal messages", "bodyText": "When we get Elasticsearch logs from journald, we want to fetch only log\nmessages from the last run. There are two reasons for this. First, if\nthere are many logs, we might get a string that's too large for our\nutility methods. Second, when we're looking for a specific message or\nerror, we almost certainly want to look only at messages from the last\nexecution.\nPreviously, we've been trying to do this by clearing out the physical\nfiles under the journald process. But there seems to be some contention\nover these directories: if journald writes a log file in between when\nour deletion command deletes the file and when it deletes the log\ndirectory, the deletion will fail.\nIt seems to me that we might be able to use journald's \"--since\" flag to\nretrieve only log messages from the last run, and that this might be\nless likely to fail due to race conditions in file deletion.\nUnfortunately, it looks as if the \"--since\" flag has a granularity of\none-second. I've added a two-second sleep to make sure that there's a\nsufficient gap between the test that will read from journald and the\ntest before it.\nSpecifically, I hope this will fix issues with test90DoNotCloseStderrWhenQuiet in PackageTests. The two error messages related to this issue are:\njava.lang.AssertionError: \nExpected: a string containing \"Failed to load settings from [elasticsearch.yml]\"\n     but: was \"<<Too large to read: 119812 bytes>>\"\n\nand\njava.lang.RuntimeException: Command was not successful: [bash -c rm -rf /run/log/journal/*]\n   result: exitCode = [1] stdout = [] stderr = [rm: cannot remove '/run/log/journal/1c27adbf8016dcaa47e05e24d8b6a7a7': Directory not empty]\n\nSee a build-stats report here, if you have access.", "createdAt": "2020-01-23T18:20:20Z", "url": "https://github.com/elastic/elasticsearch/pull/51366", "merged": true, "mergeCommit": {"oid": "8b8bff6e332b580d34f4e81ddadcded681b7ec0b"}, "closed": true, "closedAt": "2020-01-24T20:11:29Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9OG-eAH2gAyMzY2NDk5MTQ0OmU4NDdlNTNlNzk5ZDcwNzVkZDY2NWY4ZWFkYmIyM2ZjMTgwNTQ1MmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9izcGAFqTM0ODEyNDI3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e847e53e799d7075dd665f8eadbb23fc1805452c", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/e847e53e799d7075dd665f8eadbb23fc1805452c", "committedDate": "2020-01-23T17:50:36Z", "message": "Use '--since' flag to get recent journal messages\n\nWhen we get Elasticsearch logs from journald, we want to fetch only log\nmessages from the last run. There are two reasons for this. First, if\nthere are many logs, we might get a string that's too large for our\nutility methods. Second, when we're looking for a specific message or\nerror, we almost certainly want to look only at messages from the last\nexecution.\n\nPreviously, we've been trying to do this by clearing out the physical\nfiles under the journald process. But there seems to be some contention\nover these directories: if journald writes a log file in between when\nour deletion command deletes the file and when it deletes the log\ndirectory, the deletion will fail.\n\nIt seems to me that we might be able to use journald's \"--since\" flag to\nretrieve only log messages from the last run, and that this might be\nless likely to fail due to race conditions in file deletion.\n\nUnfortunately, it looks as if the \"--since\" flag has a granularity of\none-second. I've added a two-second sleep to make sure that there's a\nsufficient gap between the test that will read from journald and the\ntest before it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17a4324c3c2429456c16934a82258e0999300b6e", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/17a4324c3c2429456c16934a82258e0999300b6e", "committedDate": "2020-01-23T18:31:50Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3NTg4ODY1", "url": "https://github.com/elastic/elasticsearch/pull/51366#pullrequestreview-347588865", "createdAt": "2020-01-23T20:34:04Z", "commit": {"oid": "17a4324c3c2429456c16934a82258e0999300b6e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMDozNDowNFrOFhLx7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QyMDozNDowNFrOFhLx7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDM0MDMzMg==", "bodyText": "Could we just adjust the since time by 2 seconds instead of sleeping?", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370340332", "createdAt": "2020-01-23T20:34:04Z", "author": {"login": "rjernst"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/PackageTests.java", "diffHunk": "@@ -342,10 +341,9 @@ public void test90DoNotCloseStderrWhenQuiet() throws Exception {\n             append(tempConf.resolve(\"elasticsearch.yml\"), \"discovery.zen.ping.unicast.hosts:15172.30.5.3416172.30.5.35, 172.30.5.17]\\n\");\n \n             // Make sure we don't pick up the journal entries for previous ES instances.\n-            clearJournal(sh);\n+            String elasticsearchStartTime = sh.run(\"sleep 2 && date +\\\"%Y-%m-%d %H:%M:%S\\\"\").stdout.trim();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "17a4324c3c2429456c16934a82258e0999300b6e"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "083a74eb3494e064817b4def69298debb97522ce", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/083a74eb3494e064817b4def69298debb97522ce", "committedDate": "2020-01-24T00:00:04Z", "message": "Use journald cursors to retrieve recent messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODUyNTY5", "url": "https://github.com/elastic/elasticsearch/pull/51366#pullrequestreview-347852569", "createdAt": "2020-01-24T10:06:18Z", "commit": {"oid": "083a74eb3494e064817b4def69298debb97522ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MDQzNjY0", "url": "https://github.com/elastic/elasticsearch/pull/51366#pullrequestreview-348043664", "createdAt": "2020-01-24T15:47:24Z", "commit": {"oid": "083a74eb3494e064817b4def69298debb97522ce"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo0NzoyNFrOFhh5Aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNTo0NzoyNFrOFhh5Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDcwMjU5NQ==", "bodyText": "Note: even though this is only invoked in one test on the master branch, I'm going to need it for keystore tests on the feature branch, and it seems like something that could be generally useful later on.", "url": "https://github.com/elastic/elasticsearch/pull/51366#discussion_r370702595", "createdAt": "2020-01-24T15:47:24Z", "author": {"login": "williamrandolph"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Packages.java", "diffHunk": "@@ -332,4 +306,41 @@ public static void restartElasticsearch(Shell sh, Installation installation) thr\n         }\n         assertElasticsearchStarted(sh, installation);\n     }\n+\n+    /**\n+     * A small wrapper for retrieving only recent journald logs for the\n+     * Elasticsearch service. It works by creating a cursor for the logs\n+     * when instantiated, and advancing that cursor when the {@code clear()}\n+     * method is called.\n+     */\n+    public static class JournaldWrapper {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "083a74eb3494e064817b4def69298debb97522ce"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTI0Mjcw", "url": "https://github.com/elastic/elasticsearch/pull/51366#pullrequestreview-348124270", "createdAt": "2020-01-24T17:57:16Z", "commit": {"oid": "083a74eb3494e064817b4def69298debb97522ce"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2893, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}