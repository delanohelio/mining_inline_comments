{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MTA5Mjg2", "number": 53456, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0MjowNFrODn8AHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0OToxNlrODn8IGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjA0MTI0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0MjowNFrOF2OpMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0MjowNFrOF2OpMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzM0Nw==", "bodyText": "While this may never happen in practice, we need to have a consistent view of the license state for correctness here.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (licenseState.isAuthAllowed() == false) {\n          \n          \n            \n                        return Collections.emptyList();\n          \n          \n            \n                    }\n          \n          \n            \n                    final XPackLicenseState licenseStateSnapshot = copyCurrentLicenseState();\n          \n          \n            \n                    if (licenseStateSnapshot.isAuthAllowed() == false) {\n          \n          \n            \n                        return Collections.emptyList();\n          \n          \n            \n                    }", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392407347", "createdAt": "2020-03-13T18:42:04Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -153,17 +137,13 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n         if (licenseState.isAuthAllowed() == false) {\n             return Collections.emptyList();\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjA0MzI2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0Mjo1MVrOF2OqiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0Mjo1MVrOF2OqiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwNzY4OQ==", "bodyText": "Continuation of the previous comment.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (licenseState.areAllRealmsAllowed()) {\n          \n          \n            \n                        return realms;\n          \n          \n            \n                    } else if (licenseState.areStandardRealmsAllowed()) {\n          \n          \n            \n                        return standardRealmsOnly;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        // native realms are basic licensed, and always allowed, even for an expired license\n          \n          \n            \n                        return nativeRealmsOnly;\n          \n          \n            \n                    if (licenseStateSnapshot.areAllRealmsAllowed()) {\n          \n          \n            \n                        return realms;\n          \n          \n            \n                    } else if (licenseStateSnapshot.areStandardRealmsAllowed()) {\n          \n          \n            \n                        return standardRealmsOnly;\n          \n          \n            \n                    } else {\n          \n          \n            \n                        // native realms are basic licensed, and always allowed, even for an expired license\n          \n          \n            \n                        return nativeRealmsOnly;", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392407689", "createdAt": "2020-03-13T18:42:51Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -153,17 +137,13 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n         if (licenseState.isAuthAllowed() == false) {\n             return Collections.emptyList();\n         }\n-\n-        AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n-        switch (allowedRealmType) {\n-            case ALL:\n-                return Collections.unmodifiableList(realms);\n-            case DEFAULT:\n-                return Collections.unmodifiableList(standardRealmsOnly);\n-            case NATIVE:\n-                return Collections.unmodifiableList(nativeRealmsOnly);\n-            default:\n-                throw new IllegalStateException(\"authentication should not be enabled\");\n+        if (licenseState.areAllRealmsAllowed()) {\n+            return realms;\n+        } else if (licenseState.areStandardRealmsAllowed()) {\n+            return standardRealmsOnly;\n+        } else {\n+            // native realms are basic licensed, and always allowed, even for an expired license\n+            return nativeRealmsOnly;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjA0NzE0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0NDoyMFrOF2OtNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0NDoyMFrOF2OtNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwODM3Mw==", "bodyText": "For correctness, this method should also get a snapshot of the license state and possibly even pass it into an internal version of asList() that accepts the snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392408373", "createdAt": "2020-03-13T18:44:20Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -128,9 +113,8 @@ public Realms(Settings settings, Environment env, Map<String, Realm.Factory> fac\n             return Collections.unmodifiableList(realms);\n         }\n \n-        AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n         // If all realms are allowed, then nothing is unlicensed\n-        if (allowedRealmType == AllowedRealmType.ALL) {\n+        if (licenseState.areAllRealmsAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjA1MDQ0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0NToyOVrOF2OvXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0NToyOVrOF2OvXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQwODkyNQ==", "bodyText": "We'll also want to have a snapshot of the license state here since it can change.", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392408925", "createdAt": "2020-03-13T18:45:29Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -250,26 +230,24 @@ public void usageStats(ActionListener<Map<String, Object>> listener) {\n         final List<Realm> realmList = asList().stream()\n             .filter(r -> ReservedRealm.TYPE.equals(r.type()) == false)\n             .collect(Collectors.toList());\n+        final Set<String> realmTypes = realmList.stream().map(Realm::type).collect(Collectors.toSet());\n         final CountDown countDown = new CountDown(realmList.size());\n         final Runnable doCountDown = () -> {\n             if ((realmList.isEmpty() || countDown.countDown()) && failed.get() == false) {\n-                final AllowedRealmType allowedRealmType = licenseState.allowedRealmType();\n                 // iterate over the factories so we can add enabled & available info\n                 for (String type : factories.keySet()) {\n                     assert ReservedRealm.TYPE.equals(type) == false;\n                     realmMap.compute(type, (key, value) -> {\n                         if (value == null) {\n                             return MapBuilder.<String, Object>newMapBuilder()\n                                 .put(\"enabled\", false)\n-                                .put(\"available\", isRealmTypeAvailable(allowedRealmType, type))\n+                                .put(\"available\", isRealmTypeAvailable(licenseState, type))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 93}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQzMjA2MTY4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/oidc/OpenIdConnectBaseRestHandler.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxODo0OToxNlrOF2O2Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMToxNTowM1rOF2TL5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxMDcxMA==", "bodyText": "I do not believe OIDC should be allowed in standard realms based on the InternalRealms class. It might be best to have these use Realms.isRealmTypeAvailable to try to keep the logic consolidated?", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392410710", "createdAt": "2020-03-13T18:49:16Z", "author": {"login": "jaymode"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/oidc/OpenIdConnectBaseRestHandler.java", "diffHunk": "@@ -33,7 +32,7 @@ protected Exception checkFeatureAvailable(RestRequest request) {\n         Exception failedFeature = super.checkFeatureAvailable(request);\n         if (failedFeature != null) {\n             return failedFeature;\n-        } else if (Realms.isRealmTypeAvailable(licenseState.allowedRealmType(), OIDC_REALM_TYPE)) {\n+        } else if (licenseState.areStandardRealmsAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ4MTc2Nw==", "bodyText": "This was an accidental change, I will revert.", "url": "https://github.com/elastic/elasticsearch/pull/53456#discussion_r392481767", "createdAt": "2020-03-13T21:15:03Z", "author": {"login": "rjernst"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/oidc/OpenIdConnectBaseRestHandler.java", "diffHunk": "@@ -33,7 +32,7 @@ protected Exception checkFeatureAvailable(RestRequest request) {\n         Exception failedFeature = super.checkFeatureAvailable(request);\n         if (failedFeature != null) {\n             return failedFeature;\n-        } else if (Realms.isRealmTypeAvailable(licenseState.allowedRealmType(), OIDC_REALM_TYPE)) {\n+        } else if (licenseState.areStandardRealmsAllowed()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQxMDcxMA=="}, "originalCommit": {"oid": "9e38f8c85ca7be63edd74b4d66210bbe1bf93ec2"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3315, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}