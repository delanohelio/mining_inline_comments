{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4NTUyNTA0", "number": 63326, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NDozNVrOEqvPGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo1Nzo1NlrOEqvvEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjQ5NTYyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NDozNVrOHdHTjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NDozNVrOHdHTjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MDQ0NA==", "bodyText": "I think it's best if it's a string in the JSON.  The mapping on the index will be keyword and the JSON docs storing the field in results will have the field as a string, so for all round consistency it will be best if this is a string too.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    parser.declareLong((cd, mc) -> { /*Ignore as it is always equal to category_id*/ }, MLCATEGORY);\n          \n          \n            \n                    parser.declareString((cd, mc) -> { /*Ignore as it is always equal to category_id*/ }, MLCATEGORY);", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500290444", "createdAt": "2020-10-06T13:44:35Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -62,6 +63,8 @@\n         parser.declareString(CategoryDefinition::setGrokPattern, GROK_PATTERN);\n         parser.declareLongArray(CategoryDefinition::setPreferredToCategories, PREFERRED_TO_CATEGORIES);\n         parser.declareLong(CategoryDefinition::setNumMatches, NUM_MATCHES);\n+        parser.declareString((cd, rt) -> { /*Ignore as it is always category_definition*/ }, Result.RESULT_TYPE);\n+        parser.declareLong((cd, mc) -> { /*Ignore as it is always equal to category_id*/ }, MLCATEGORY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjUwNDM1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NjowM1rOHdHY-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0NjowM1rOHdHY-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MTgzNA==", "bodyText": "As above, actually store it as a string for complete consistency with the results documents.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    builder.field(MLCATEGORY.getPreferredName(), categoryId);\n          \n          \n            \n                    builder.field(MLCATEGORY.getPreferredName(), Long.toString(categoryId));", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500291834", "createdAt": "2020-10-06T13:46:03Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -246,6 +249,8 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (partitionFieldName != null && partitionFieldValue != null && ReservedFieldNames.isValidFieldName(partitionFieldName)) {\n             builder.field(partitionFieldName, partitionFieldValue);\n         }\n+        builder.field(Result.RESULT_TYPE.getPreferredName(), TYPE.getPreferredName());\n+        builder.field(MLCATEGORY.getPreferredName(), categoryId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjUxNjc3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/ReservedFieldNames.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo0ODoxMFrOHdHgzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1MDozM1rOHdTQLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MzgzNg==", "bodyText": "I think this will stop the field getting written into anomaly records, which would be very bad.  It will still get written as \"blah_field_name\": \"mlcategory\", \"blah_field_value\": \"42\", but won't get written as \"mlcategory\": \"42\".  So this line needs to be removed.", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500293836", "createdAt": "2020-10-06T13:48:10Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/ReservedFieldNames.java", "diffHunk": "@@ -121,6 +121,7 @@\n             CategoryDefinition.EXAMPLES.getPreferredName(),\n             CategoryDefinition.NUM_MATCHES.getPreferredName(),\n             CategoryDefinition.PREFERRED_TO_CATEGORIES.getPreferredName(),\n+            CategoryDefinition.MLCATEGORY.getPreferredName(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ3NTIyOA==", "bodyText": "\ud83e\udd14 When I ran this manually, it worked just fine. We don't validate the reserved field names ahead of time anywhere?", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500475228", "createdAt": "2020-10-06T17:31:56Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/ReservedFieldNames.java", "diffHunk": "@@ -121,6 +121,7 @@\n             CategoryDefinition.EXAMPLES.getPreferredName(),\n             CategoryDefinition.NUM_MATCHES.getPreferredName(),\n             CategoryDefinition.PREFERRED_TO_CATEGORIES.getPreferredName(),\n+            CategoryDefinition.MLCATEGORY.getPreferredName(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MzgzNg=="}, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ4NjE5MA==", "bodyText": "Ah, I see, we don't fail the job or anything. The field is just not written.", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500486190", "createdAt": "2020-10-06T17:50:33Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/ReservedFieldNames.java", "diffHunk": "@@ -121,6 +121,7 @@\n             CategoryDefinition.EXAMPLES.getPreferredName(),\n             CategoryDefinition.NUM_MATCHES.getPreferredName(),\n             CategoryDefinition.PREFERRED_TO_CATEGORIES.getPreferredName(),\n+            CategoryDefinition.MLCATEGORY.getPreferredName(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI5MzgzNg=="}, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMjU3NzQ2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo1Nzo1NlrOHdIGKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzo1Nzo1NlrOHdIGKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDMwMzQwMw==", "bodyText": "It would be good to add a comment here (or somewhere) to say that result_type cannot be relied upon to find category definitions.  We still need to get them by checking for the existence of a category_id field until results generated in versions that don't have this are several years old.", "url": "https://github.com/elastic/elasticsearch/pull/63326#discussion_r500303403", "createdAt": "2020-10-06T13:57:56Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -246,6 +249,8 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (partitionFieldName != null && partitionFieldValue != null && ReservedFieldNames.isValidFieldName(partitionFieldName)) {\n             builder.field(partitionFieldName, partitionFieldValue);\n         }\n+        builder.field(Result.RESULT_TYPE.getPreferredName(), TYPE.getPreferredName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "008a77e3effbd83984b0ee55d2d1d4ee53e72b51"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3129, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}