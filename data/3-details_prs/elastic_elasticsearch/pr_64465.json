{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTc0MjU5", "number": 64465, "title": "LinearCounting recompute size tripping assertion", "bodyText": "Linear counting algorithm holds two big arrays, one for holding the number of elements per buckets (sizes) and another one that holds the values for a given bucket (hll.runlens). The issue here is that in #60201 we changed the way BigArrays are resized. So it might happen that the sizes array contains more buckets than hll.runlens array. When we recompute the size (in an assertion), we might try to read values for thehll.runlens array and trip an out of bounds exception.\nThis commit adds a safeguard against this case.", "createdAt": "2020-11-02T10:55:26Z", "url": "https://github.com/elastic/elasticsearch/pull/64465", "merged": true, "mergeCommit": {"oid": "c77df0a062bf8ae25fadc8c550c96adb83ba29c0"}, "closed": true, "closedAt": "2020-11-03T14:07:49Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYiLDoAH2gAyNTEzOTc0MjU5OmU5N2NjMmM1Y2JmZjYzMjM0Njc4ZDg4NzNlMjRhMTQyMzJlNjIxOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY5BZeAFqTUyMjQ4Mzc4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e97cc2c5cbff63234678d8873e24a14232e6219f", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/e97cc2c5cbff63234678d8873e24a14232e6219f", "committedDate": "2020-11-02T10:40:16Z", "message": "guard recomputeSize from out of bounds exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDY4ODQx", "url": "https://github.com/elastic/elasticsearch/pull/64465#pullrequestreview-522468841", "createdAt": "2020-11-03T12:58:24Z", "commit": {"oid": "e97cc2c5cbff63234678d8873e24a14232e6219f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo1ODoyNFrOHstoSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo1ODoyNFrOHstoSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0Njk4NQ==", "bodyText": "Probably worth a comment about why this particular random number. If it is to trip the problem, can we somehow assert that it tripped with this number? I feel like we could easily end up in a position where the test doesn't do anything if we don't have some package private method to check to see if this thing happened somehow.", "url": "https://github.com/elastic/elasticsearch/pull/64465#discussion_r516646985", "createdAt": "2020-11-03T12:58:24Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/HyperLogLogPlusPlusTests.java", "diffHunk": "@@ -171,4 +171,16 @@ public long addWithoutBreaking(long bytes) {\n \n         assertThat(total.get(), equalTo(0L));\n     }\n+\n+    public void testRetrieveCardinality() {\n+        final int p = randomIntBetween(MIN_PRECISION, MAX_PRECISION);\n+        final HyperLogLogPlusPlus counts = new HyperLogLogPlusPlus(p, BigArrays.NON_RECYCLING_INSTANCE, 1);\n+        int bucket = randomInt(100);\n+        counts.collect(bucket, -8688952809613614893L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e97cc2c5cbff63234678d8873e24a14232e6219f"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDY5MDc4", "url": "https://github.com/elastic/elasticsearch/pull/64465#pullrequestreview-522469078", "createdAt": "2020-11-03T12:58:44Z", "commit": {"oid": "e97cc2c5cbff63234678d8873e24a14232e6219f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a683e7ceed39c11e225a6c3b4051ae17c93bb47", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a683e7ceed39c11e225a6c3b4051ae17c93bb47", "committedDate": "2020-11-03T13:13:14Z", "message": "Merge branch 'master' into hllarraysize"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199383841dc1a02865166c90e7f3e29111b4e672", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/199383841dc1a02865166c90e7f3e29111b4e672", "committedDate": "2020-11-03T13:15:58Z", "message": "use random long"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDgzNzg0", "url": "https://github.com/elastic/elasticsearch/pull/64465#pullrequestreview-522483784", "createdAt": "2020-11-03T13:17:32Z", "commit": {"oid": "199383841dc1a02865166c90e7f3e29111b4e672"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 908, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}