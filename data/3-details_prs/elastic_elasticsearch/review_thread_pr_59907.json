{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzNjE0MTg0", "number": 59907, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzowNDoxMFrOEQfcEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNToyMzowNFrOESb_pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzI3NzYwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzowNDoxMFrOG0qzog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NToyNFrOG1guRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MDQ4Mg==", "bodyText": "I'd say IllegalArgumentException fits better.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r457880482", "createdAt": "2020-07-21T07:04:10Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -109,15 +109,33 @@ protected String eol() {\n      *\n      */\n     CSV() {\n+        private Character delimiter = ',';\n \n         @Override\n-        protected String delimiter() {\n-            return \",\";\n+        protected Character delimiter() {\n+            return delimiter;\n+        }\n+\n+        @Override\n+        protected void setDelimiter(Character delimiter) {\n+            if (delimiter == null) {\n+                throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2Mzg0NA==", "bodyText": "Makes sense.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r458763844", "createdAt": "2020-07-22T12:45:24Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -109,15 +109,33 @@ protected String eol() {\n      *\n      */\n     CSV() {\n+        private Character delimiter = ',';\n \n         @Override\n-        protected String delimiter() {\n-            return \",\";\n+        protected Character delimiter() {\n+            return delimiter;\n+        }\n+\n+        @Override\n+        protected void setDelimiter(Character delimiter) {\n+            if (delimiter == null) {\n+                throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MDQ4Mg=="}, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzI4NzQ1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/plugin/TextFormatTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzowNzowN1rOG0q5QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NTozOFrOG1gu7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MTkyMQ==", "bodyText": "Minor, a set would be faster.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r457881921", "createdAt": "2020-07-21T07:07:07Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/plugin/TextFormatTests.java", "diffHunk": "@@ -90,7 +92,25 @@ public void testCsvFormatWithRegularData() {\n         assertEquals(\"string,number\\r\\n\" +\n                 \"Along The River Bank,708\\r\\n\" +\n                 \"Mind Train,280\\r\\n\",\n-                text);\n+            text);\n+    }\n+\n+    public void testCsvFormatWithCustomDelimiterRegularData() {\n+        List<Character> forbidden = Arrays.asList('\"', '\\r', '\\n', '\\t');", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDAxNQ==", "bodyText": "Changed, thanks.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r458764015", "createdAt": "2020-07-22T12:45:38Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/plugin/TextFormatTests.java", "diffHunk": "@@ -90,7 +92,25 @@ public void testCsvFormatWithRegularData() {\n         assertEquals(\"string,number\\r\\n\" +\n                 \"Along The River Bank,708\\r\\n\" +\n                 \"Mind Train,280\\r\\n\",\n-                text);\n+            text);\n+    }\n+\n+    public void testCsvFormatWithCustomDelimiterRegularData() {\n+        List<Character> forbidden = Arrays.asList('\"', '\\r', '\\n', '\\t');", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MTkyMQ=="}, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NzI5NTg4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQwNzowOTo0OFrOG0q-TQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxMjo0NTo0OVrOG1gvVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MzIxMw==", "bodyText": "Can we use some static variable for \"delimiter\"?", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r457883213", "createdAt": "2020-07-21T07:09:48Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "diffHunk": "@@ -124,6 +128,11 @@ public RestResponse buildResponse(SqlQueryResponse response) throws Exception {\n         });\n     }\n \n+    @Override\n+    protected Set<String> responseParams() {\n+        return textFormat == TextFormat.CSV ? Collections.singleton(\"delimiter\") : Collections.emptySet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODc2NDExNg==", "bodyText": "Sure. I've updated along a few other embedded strings, for this change to make sense.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r458764116", "createdAt": "2020-07-22T12:45:49Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "diffHunk": "@@ -124,6 +128,11 @@ public RestResponse buildResponse(SqlQueryResponse response) throws Exception {\n         });\n     }\n \n+    @Override\n+    protected Set<String> responseParams() {\n+        return textFormat == TextFormat.CSV ? Collections.singleton(\"delimiter\") : Collections.emptySet();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Nzg4MzIxMw=="}, "originalCommit": {"oid": "b910a899de0eb7375e8bff76bfe5530ca6305f98"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NjEyNTI3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzozMTowMFrOG1_LLg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMTo1MDozNlrOG2HEVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2Mjc2Ng==", "bodyText": "Why did you add that second argument? I don't see it being used, or am I missing something :) ?", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459262766", "createdAt": "2020-07-23T07:31:00Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -235,7 +247,7 @@ String contentType(RestRequest request) {\n         }\n \n         @Override\n-        String maybeEscape(String value) {\n+        String maybeEscape(String value, Character __) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4NDAxOA==", "bodyText": "The second param of maybeEscape, the delimiter, is only used for the CSV value, but not for the TSV.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459384018", "createdAt": "2020-07-23T11:33:06Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -235,7 +247,7 @@ String contentType(RestRequest request) {\n         }\n \n         @Override\n-        String maybeEscape(String value) {\n+        String maybeEscape(String value, Character __) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2Mjc2Ng=="}, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5MjA4Nw==", "bodyText": "Of course, sorry, I was just confused.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459392087", "createdAt": "2020-07-23T11:50:36Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -235,7 +247,7 @@ String contentType(RestRequest request) {\n         }\n \n         @Override\n-        String maybeEscape(String value) {\n+        String maybeEscape(String value, Character __) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2Mjc2Ng=="}, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 162}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NjEzOTA0OnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/endpoints/rest.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzozNTo0MlrOG1_TYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMTozMzoyNFrOG2GlRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDg2NQ==", "bodyText": "Isn't it better to say double quote  instead of apostrophe ?", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459264865", "createdAt": "2020-07-23T07:35:42Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.\n++\n+* `delimiter` (default: `,`)\n++\n+Indicates which character should be used to separate the CSV values. The following values cannot be used for this attribute:\n+apostrophe (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4NDEzNA==", "bodyText": "Oops, you're right, thanks. Fixed.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459384134", "createdAt": "2020-07-23T11:33:24Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.\n++\n+* `delimiter` (default: `,`)\n++\n+Indicates which character should be used to separate the CSV values. The following values cannot be used for this attribute:\n+apostrophe (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NDg2NQ=="}, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NjE0NTMzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwNzozODowMFrOG1_XMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMTozMzozNlrOG2GllA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NTg0Mg==", "bodyText": "You could also use Set here, but personally I would use a switch statement on the head.toLowerCase(Locale.ROOT) to return true, false, and default => throw the exception.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459265842", "createdAt": "2020-07-23T07:38:00Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -186,23 +193,28 @@ String maybeEscape(String value) {\n \n         @Override\n         boolean needsHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+            String header = request.param(URL_PARAM_HEADER);\n             if (header == null) {\n                 List<String> values = request.getAllHeaderValues(\"Accept\");\n                 if (values != null) {\n                     // header values are separated by `;` so try breaking it down\n                     for (String value : values) {\n                         String[] params = Strings.tokenizeToStringArray(value, \";\");\n                         for (String param : params) {\n-                            if (param.toLowerCase(Locale.ROOT).equals(\"header=absent\")) {\n+                            if (param.toLowerCase(Locale.ROOT).equals(URL_PARAM_HEADER + \"=\" + PARAM_HEADER_ABSENT)) {\n                                 return false;\n                             }\n                         }\n                     }\n                 }\n                 return true;\n             } else {\n-                return !header.toLowerCase(Locale.ROOT).equals(\"absent\");\n+                List<String> allowed = List.of(PARAM_HEADER_ABSENT, PARAM_HEADER_PRESENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 133}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM4NDIxMg==", "bodyText": "Good suggestion, thanks. Fixed.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459384212", "createdAt": "2020-07-23T11:33:36Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -186,23 +193,28 @@ String maybeEscape(String value) {\n \n         @Override\n         boolean needsHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+            String header = request.param(URL_PARAM_HEADER);\n             if (header == null) {\n                 List<String> values = request.getAllHeaderValues(\"Accept\");\n                 if (values != null) {\n                     // header values are separated by `;` so try breaking it down\n                     for (String value : values) {\n                         String[] params = Strings.tokenizeToStringArray(value, \";\");\n                         for (String param : params) {\n-                            if (param.toLowerCase(Locale.ROOT).equals(\"header=absent\")) {\n+                            if (param.toLowerCase(Locale.ROOT).equals(URL_PARAM_HEADER + \"=\" + PARAM_HEADER_ABSENT)) {\n                                 return false;\n                             }\n                         }\n                     }\n                 }\n                 return true;\n             } else {\n-                return !header.toLowerCase(Locale.ROOT).equals(\"absent\");\n+                List<String> allowed = List.of(PARAM_HEADER_ABSENT, PARAM_HEADER_PRESENT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTI2NTg0Mg=="}, "originalCommit": {"oid": "6d5b28a776ed071c83caf79ff48f3c8184b65290"}, "originalPosition": 133}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2Njk2MTk4OnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/endpoints/rest.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMTo1MToyMFrOG2HFnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QxMTo1MToyMFrOG2HFnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTM5MjQxMw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            double quotes (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used\n          \n          \n            \n            double quote (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used\n          \n      \n    \n    \n  \n\nsince all the rest are also singular.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r459392413", "createdAt": "2020-07-23T11:51:20Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -118,7 +118,7 @@ Controls if the CSV header should be included in the response or not. It can tak\n * `delimiter` (default: `,`)\n +\n Indicates which character should be used to separate the CSV values. The following values cannot be used for this attribute:\n-apostrophe (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used\n+double quotes (`\"`), carriage-return (`\\r`) and new-line (`\\n`). The tab (`\\t`) can also not be used, the `tsv` format needs to be used", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2b3c3513053df25352ea8bfd2424c9b31f935954"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NzUzNDUxOnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/endpoints/rest.asciidoc", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNDo1MDozNFrOG3mDTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTozMjowNFrOG4EmAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg==", "bodyText": "Why not using a true/false kind of approach with the csv header? It's simpler to use (true/false values) and less prone to wrong values. Something like include_header=true (the default, which can be omitted) and include_header=false which needs to be specifically mentioned.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r460948302", "createdAt": "2020-07-27T14:50:34Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk4NzI4Ng==", "bodyText": "Actually, thinking about this a bit more, why did you expose this request parameter in the first place? It has always been there as an option (to have or not the header in the response), but it was a way of distinguishing between the first page of the response and the subsequent pages of it. Also, the initial request this PR is fixing refers only to the delimiter itself.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r460987286", "createdAt": "2020-07-27T15:45:22Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA0NzY1Mw==", "bodyText": "Why not using a true/false kind of approach with the csv header?\n\nThe absent/present values were coded in before. And my guess is that the values have been chosen to be in-line with the CT header values.\n\nit was a way of distinguishing between the first page of the response and the subsequent pages of it\n\nI see. ..actually how would a subsequent page be requested with a URL attribute in CSV format? I think we have no OFFSET, neither at API, nor at SQL level, do we?\nI also found no tests covering this scenario or the use of the header attribute.\nAnd these two points above...\n\nwhy did you expose this request parameter in the first place?\n\n...let me to believe that it might be an intended feature, but no[t / longer] correctly functioning.\nAnd I think it would be good to have it, CSV handling applications generally offer such functionality. So irrespective of the original intent, is there any concern exposing it?\n\nAlso, the initial request this PR is fixing refers only to the delimiter itself.\n\nTrue. Would it make sense to split the PR (vs. maybe extending this PR's description)?", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461047653", "createdAt": "2020-07-27T17:21:10Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM1MDEzMQ==", "bodyText": "...let me to believe that it might be an intended feature, but no[t / longer] correctly functioning.\n\nMy 2c on this: if it's requested, we can discuss about adding it. If there is no demand, we don't complicate things.\n\nI see. ..actually how would a subsequent page be requested with a URL attribute in CSV format? I think we have no OFFSET, neither at API, nor at SQL level, do we?\n\nThe first response that comes from ES contains a header called cursor to be used for a subsequent call to get the next page of rows. The URL remains the same, but the second call doesn't have a query in it, but a cursor.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461350131", "createdAt": "2020-07-28T06:35:41Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM3NTM2Nw==", "bodyText": "My 2c on this: if it's requested, we can discuss about adding it. If there is no demand, we don't complicate things.\n\nSure, I can take it out. But just to understand how to take it out:\n\nit was a way of distinguishing between the first page of the response and the subsequent pages of it\n\nHow is this distinguishing being done, since I believe there's no way to specify a header URL attribute currently, since it's not \"consumed\" by the RestSqlQueryAction and so using it would generate a \"request [/_sql] contains unrecognized parameter: [header]\" error. Should I remove it entirely then? Sorry if missing something.\n\nThe first response that comes from ES contains a header called cursor to be used for a subsequent call to get the next page of rows.\n\nRight, it's inserted by RestSqlQueryAction, should have spotted it before. Thanks.\nIs this documented anywhere though? I couldn't find it on the REST formats page. I can add it if not.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461375367", "createdAt": "2020-07-28T07:30:00Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM5NTQzMw==", "bodyText": "Sure, I can take it out. But just to understand how to take it out:\n\nJust do not expose it as a request parameter. Leave the rest of the logic unchanged and this PR should only address the delimiter part.\n\nHow is this distinguishing being done, since I believe there's no way to specify a header URL attribute currently, since it's not \"consumed\" by the RestSqlQueryAction and so using it would generate a \"request [/_sql] contains unrecognized parameter: [header]\" error. Should I remove it entirely then? Sorry if missing something.\n\nI don't think it's actually being used, indeed. I see logic that's based on the presence of the cursor or not, not much about the header being present or not in the request...\n\nRight, it's inserted by RestSqlQueryAction, should have spotted it before. Thanks.\nIs this documented anywhere though? I couldn't find it on the REST formats page. I can add it if not.\n\nIt's not documented for other formats (except json and txt), either. I think a simple statement change in this page also mentioning csv and tsv should be enough (ie, no examples).", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461395433", "createdAt": "2020-07-28T08:05:52Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ0ODcwNQ==", "bodyText": "I've reverted the changes here and opened #60271, since this is clearly a (very minor) bug.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461448705", "createdAt": "2020-07-28T09:32:04Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/endpoints/rest.asciidoc", "diffHunk": "@@ -106,6 +106,21 @@ s|Description\n \n |===\n \n+The `CSV` format accepts the following additional formatting URL query attributes:\n+\n+* `header`\n++\n+Controls if the CSV header should be included in the response or not. It can take one of the following values:\n++\n+   - `present` (default): include the header;\n+   - `absent`: exclude the header.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk0ODMwMg=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3NzY4NDg2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxNToyMzowNFrOG3nfDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwOTozMzoyMVrOG4Eo4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk3MTc4OA==", "bodyText": "I would have kept this method name as is.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r460971788", "createdAt": "2020-07-27T15:23:04Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -162,52 +190,58 @@ String maybeEscape(String value) {\n                 sb.append('\"');\n                 value = sb.toString();\n             }\n+\n             return value;\n         }\n \n         @Override\n-        boolean hasHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+        boolean needsHeader(RestRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA1MjUwOA==", "bodyText": "My interpretation of what the code does is that it decides if a header is required in the response and not if the RestRequest has a header value at all (either URL attribute or HTTP header value). I.e. for the configuration header=absent the function will still return false, despite the fact that there is actually a header (attribute).\nBut I'm happy to revert or apply a more suggestive name if this be an incorrect interpretation.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461052508", "createdAt": "2020-07-27T17:29:08Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -162,52 +190,58 @@ String maybeEscape(String value) {\n                 sb.append('\"');\n                 value = sb.toString();\n             }\n+\n             return value;\n         }\n \n         @Override\n-        boolean hasHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+        boolean needsHeader(RestRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk3MTc4OA=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM2MDUwOA==", "bodyText": "The way I looked at it is from the request perspective: the request has a header or not, thus the formatting behavior changes based on this. I would argue further and say that the response needs a header (thus a needsHeader method should belong to the SqlQueryResponse object) and not the row-by-row formatting behavior.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461360508", "createdAt": "2020-07-28T06:59:28Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -162,52 +190,58 @@ String maybeEscape(String value) {\n                 sb.append('\"');\n                 value = sb.toString();\n             }\n+\n             return value;\n         }\n \n         @Override\n-        boolean hasHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+        boolean needsHeader(RestRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk3MTc4OA=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 123}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTQ0OTQ0MA==", "bodyText": "thus a needsHeader method should belong to the SqlQueryResponse object\n\nAgreed.\nI've reverted the change anyways.", "url": "https://github.com/elastic/elasticsearch/pull/59907#discussion_r461449440", "createdAt": "2020-07-28T09:33:21Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/TextFormat.java", "diffHunk": "@@ -162,52 +190,58 @@ String maybeEscape(String value) {\n                 sb.append('\"');\n                 value = sb.toString();\n             }\n+\n             return value;\n         }\n \n         @Override\n-        boolean hasHeader(RestRequest request) {\n-            String header = request.param(\"header\");\n+        boolean needsHeader(RestRequest request) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MDk3MTc4OA=="}, "originalCommit": {"oid": "1b3958decc61d2036c6122a5a66223df9d7ec5ed"}, "originalPosition": 123}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2157, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}