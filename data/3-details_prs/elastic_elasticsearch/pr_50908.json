{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMDcwMzIw", "number": 50908, "title": "Check for deprecations when analyzers are built", "bodyText": "Generally speaking, deprecated analysis components in elasticsearch will issue deprecation\nwarnings when they are first used.  However, this means that no warnings are emitted when\nindexes are created with deprecated components, and users have to actually index a document\nto see warnings.  This makes it much harder to see these warnings and act on them at\nappropriate times.\nThis commit adds a new check that pushes an empty string through all user-defined analyzers\nand normalizers when an IndexAnalyzers object is built for each index; deprecation warnings\nare now emitted when indexes are created or opened.\nFixes #42349", "createdAt": "2020-01-13T11:32:54Z", "url": "https://github.com/elastic/elasticsearch/pull/50908", "merged": true, "mergeCommit": {"oid": "736ed474e2602fd1fc0f48d2dfdf15db2bbe1793"}, "closed": true, "closedAt": "2020-01-14T13:12:26Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb56mLAAH2gAyMzYyMDcwMzIwOjU0YzY1OWNmZTkyM2QwYTg2ZTU0N2JkMGQ5NjNhMGNhZDRlODhhOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6OS8dAH2gAyMzYyMDcwMzIwOmQ5MzhlYWEyZGRmYTY2YmViMjg1MzVhNmM2MjI2YmMxZmNlNTAzMjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "54c659cfe923d0a86e547bd0d963a0cad4e88a98", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/54c659cfe923d0a86e547bd0d963a0cad4e88a98", "committedDate": "2020-01-13T11:24:48Z", "message": "Check for deprecations when analyzers are built"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca8b8bc73c1722622ce87e8f20d000c9eca98cc", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ca8b8bc73c1722622ce87e8f20d000c9eca98cc", "committedDate": "2020-01-13T12:09:57Z", "message": "checkstyle; tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxODg1MjMy", "url": "https://github.com/elastic/elasticsearch/pull/50908#pullrequestreview-341885232", "createdAt": "2020-01-13T14:33:41Z", "commit": {"oid": "1ca8b8bc73c1722622ce87e8f20d000c9eca98cc"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5", "committedDate": "2020-01-13T14:43:07Z", "message": "Add version check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxOTQ1NjM2", "url": "https://github.com/elastic/elasticsearch/pull/50908#pullrequestreview-341945636", "createdAt": "2020-01-13T15:55:14Z", "commit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNTo1NToxNFrOFc7j_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNTo1NToxNFrOFc7j_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTg4MDMxOA==", "bodyText": "Just a small observation: I thought this checks that the normalize method in DeprecatedTokenFilterFactory, so I tried changing it but the test didn't fail, do you know why?", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r365880318", "createdAt": "2020-01-13T15:55:14Z", "author": {"login": "cbuescher"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/TransportAnalyzeActionTests.java", "diffHunk": "@@ -492,4 +512,28 @@ public void testExceedSetMaxTokenLimit() {\n         assertEquals(e.getMessage(), \"The number of tokens produced by calling _analyze has exceeded the allowed maximum of [\"\n             + idxMaxTokenCount + \"].\" + \" This limit can be set by changing the [index.analyze.max_token_count] index level setting.\");\n     }\n+\n+    public void testDeprecationWarnings() throws IOException {\n+        AnalyzeAction.Request req = new AnalyzeAction.Request();\n+        req.tokenizer(\"standard\");\n+        req.addTokenFilter(\"lowercase\");\n+        req.addTokenFilter(\"deprecated\");\n+        req.text(\"test text\");\n+\n+        AnalyzeAction.Response analyze =\n+            TransportAnalyzeAction.analyze(req, registry, mockIndexService(), maxTokenCount);\n+        assertEquals(2, analyze.getTokens().size());\n+        assertWarnings(\"Using deprecated token filter [deprecated]\");\n+\n+        // normalizer\n+        req = new AnalyzeAction.Request();\n+        req.addTokenFilter(\"lowercase\");\n+        req.addTokenFilter(\"deprecated\");\n+        req.text(\"text\");\n+\n+        analyze =\n+            TransportAnalyzeAction.analyze(req, registry, mockIndexService(), maxTokenCount);\n+        assertEquals(1, analyze.getTokens().size());\n+        assertWarnings(\"Using deprecated token filter [deprecated]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxOTc1MzQw", "url": "https://github.com/elastic/elasticsearch/pull/50908#pullrequestreview-341975340", "createdAt": "2020-01-13T16:34:59Z", "commit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMTM4MDE4", "url": "https://github.com/elastic/elasticsearch/pull/50908#pullrequestreview-342138018", "createdAt": "2020-01-13T21:05:39Z", "commit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMTowNTozOVrOFdEihA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QyMTowNjoyOVrOFdEjzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyNzM5Ng==", "bodyText": "We also throw exceptions in some cases so it's not only about deprecations ?", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r366027396", "createdAt": "2020-01-13T21:05:39Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/analysis/AnalysisRegistry.java", "diffHunk": "@@ -626,4 +632,17 @@ private void processNormalizerFactory(\n         NamedAnalyzer normalizer = new NamedAnalyzer(name, normalizerFactory.scope(), normalizerF);\n         normalizers.put(name, normalizer);\n     }\n+\n+    // Deprecation warnings are emitted when actual TokenStreams are built; this is usually\n+    // too late to be useful, so we build an empty tokenstream at construction time and\n+    // use it, to ensure that warnings are emitted immediately.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjAyNzcyNw==", "bodyText": "Can you also add a test that throws an exception ?", "url": "https://github.com/elastic/elasticsearch/pull/50908#discussion_r366027727", "createdAt": "2020-01-13T21:06:29Z", "author": {"login": "jimczi"}, "path": "server/src/test/java/org/elasticsearch/index/analysis/AnalysisRegistryTests.java", "diffHunk": "@@ -264,4 +271,90 @@ public void testEnsureCloseInvocationProperlyDelegated() throws IOException {\n         registry.close();\n         verify(mock).close();\n     }\n+\n+    public void testDeprecations() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdd2b0c2bc3bd833606d12d61c7a67b40910cd5"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "494147055697679e63b1eb80493fc448970bb92e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/494147055697679e63b1eb80493fc448970bb92e", "committedDate": "2020-01-14T09:36:51Z", "message": "Add tests for exceptions as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a18f6205e2b798be4230b684a20e4cbf5c0117c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a18f6205e2b798be4230b684a20e4cbf5c0117c", "committedDate": "2020-01-14T09:54:33Z", "message": "Merge remote-tracking branch 'origin/master' into analysis/deprecations-check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d938eaa2ddfa66beb28535a6c6226bc1fce50322", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/d938eaa2ddfa66beb28535a6c6226bc1fce50322", "committedDate": "2020-01-14T10:21:54Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3165, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}