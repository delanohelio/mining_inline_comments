{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4NTk3MTI5", "number": 56821, "title": "Track multipart/resumable uploads GCS API calls", "bodyText": "Add tracking for multipart and resumable uploads for GoogleCloudStorage.\nFor resumable uploads only the last request is taken into account for\nbilling, so that's the only request that's tracked.", "createdAt": "2020-05-15T13:35:33Z", "url": "https://github.com/elastic/elasticsearch/pull/56821", "merged": true, "mergeCommit": {"oid": "79a69cb67692309c96d3d51dd5a342834ae79b22"}, "closed": true, "closedAt": "2020-05-18T09:41:56Z", "author": {"login": "fcofdez"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchiFmGAH2gAyNDE4NTk3MTI5OjRiZGQxNjRhM2Y2NDkxNDVhNjdjYjEwOWQzMDhmZmRkYzI3YzVkOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcibPS3gH2gAyNDE4NTk3MTI5OjJjNTNmNDdjNDYzYjg0OWMxNzkxY2QzZjc4YjBmMTIxY2FiZTExYWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4bdd164a3f649145a67cb109d308ffddc27c5d9a", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bdd164a3f649145a67cb109d308ffddc27c5d9a", "committedDate": "2020-05-15T13:28:28Z", "message": "Track multipart/resumable uploads GCS API calls\n\nAdd tracking for multipart and resumable uploads for GoogleCloudStorage.\nFor resumable uploads only the last request is taken into account for\nbilling, so that's the only request that's tracked."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjkwOTYx", "url": "https://github.com/elastic/elasticsearch/pull/56821#pullrequestreview-412690961", "createdAt": "2020-05-15T14:19:01Z", "commit": {"oid": "4bdd164a3f649145a67cb109d308ffddc27c5d9a"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDoxOTowMVrOGWG2Iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNDoyMzoxMlrOGWHBeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNDAxOQ==", "bodyText": "Let's track this under a different key so we can identify the counts by type? Just POST is probably fine here as I currently can't think of another POST we do on GCS.", "url": "https://github.com/elastic/elasticsearch/pull/56821#discussion_r425834019", "createdAt": "2020-05-15T14:19:01Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-gcs/src/test/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStoreRepositoryTests.java", "diffHunk": "@@ -289,17 +292,40 @@ protected boolean canFailRequest(final HttpExchange exchange) {\n     @SuppressForbidden(reason = \"this tests uses a HttpServer to emulate an GCS endpoint\")\n     private static class GoogleCloudStorageStatsCollectorHttpHandler extends HttpStatsCollectorHandler {\n \n+        public static final Pattern contentRangeMatcher = Pattern.compile(\"bytes \\\\d+-(\\\\d+)/(\\\\d+)\");\n+\n         GoogleCloudStorageStatsCollectorHttpHandler(final HttpHandler delegate) {\n             super(delegate);\n         }\n \n         @Override\n-        public void maybeTrack(final String request) {\n+        public void maybeTrack(final String request, Headers requestHeaders) {\n             if (Regex.simpleMatch(\"GET /storage/v1/b/*/o*\", request)) {\n                 trackRequest(\"LIST\");\n             } else if (Regex.simpleMatch(\"GET /download/storage/v1/b/*\", request)) {\n                 trackRequest(\"GET\");\n+            } else if (Regex.simpleMatch(\"PUT /upload/storage/v1/b/*\", request) && isLastPart(requestHeaders)) {\n+                trackRequest(\"PUT\");\n+            } else if (Regex.simpleMatch(\"POST /upload/storage/v1/b/*uploadType=multipart*\", request)) {\n+                trackRequest(\"PUT\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bdd164a3f649145a67cb109d308ffddc27c5d9a"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTgzNjkyMA==", "bodyText": "As mentioned below, let's give this a separate key to track under so we get metrics on what upload type we use how often.", "url": "https://github.com/elastic/elasticsearch/pull/56821#discussion_r425836920", "createdAt": "2020-05-15T14:23:12Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-gcs/src/main/java/org/elasticsearch/repositories/gcs/GoogleCloudStorageBlobStore.java", "diffHunk": "@@ -335,6 +336,7 @@ private void writeBlobMultipart(BlobInfo blobInfo, InputStream inputStream, long\n                 new Storage.BlobTargetOption[0];\n             SocketAccess.doPrivilegedVoidIOException(\n                     () -> client().create(blobInfo, buffer, targetOptions));\n+            stats.trackPutObjectOperation();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bdd164a3f649145a67cb109d308ffddc27c5d9a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b907b285a40857b92710aae0d8f098395946b63", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b907b285a40857b92710aae0d8f098395946b63", "committedDate": "2020-05-15T15:06:55Z", "message": "Classify multipart and resumable uploads into two categories"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "139d5539a53b5c8794563b5effad7b15d238656b", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/139d5539a53b5c8794563b5effad7b15d238656b", "committedDate": "2020-05-15T15:10:17Z", "message": "Change how requests are counted."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyODM3MjQy", "url": "https://github.com/elastic/elasticsearch/pull/56821#pullrequestreview-412837242", "createdAt": "2020-05-15T17:30:28Z", "commit": {"oid": "139d5539a53b5c8794563b5effad7b15d238656b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "321989853793a840c00afb6fbb88a90692cba35d", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/321989853793a840c00afb6fbb88a90692cba35d", "committedDate": "2020-05-18T08:02:52Z", "message": "Clarify why put and post are tracked differently"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c53f47c463b849c1791cd3f78b0f121cabe11aa", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c53f47c463b849c1791cd3f78b0f121cabe11aa", "committedDate": "2020-05-18T08:03:39Z", "message": "Merge remote-tracking branch 'origin/master' into track-put-requests-gcs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 13, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}