{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2MzI2NTY0", "number": 62287, "title": "Add example settings to sample security realm", "bodyText": "This change adds configurable settings to the CustomRealm in the QA\nproject as the correct declaration and use of settings can be a source\nof confusion in custom realms.\nThe \"username\" \"password\" and \"roles\" are now all configurable, which\ndemonstrates the use of a simple string setting (\"username\") a secure\nsetting (\"password\") and a more complex list setting (\"roles\").", "createdAt": "2020-09-14T04:58:34Z", "url": "https://github.com/elastic/elasticsearch/pull/62287", "merged": true, "mergeCommit": {"oid": "d5c7746903a1f89f74a1ceff18e792b44448910d"}, "closed": true, "closedAt": "2020-10-06T02:47:31Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIr2_sgH2gAyNDg2MzI2NTY0OmUxZGYxMWMxYWMzOWY0MmViNGY3ZDM3MDhiNTNiMjA4YjQxOWY0MDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPdvKyAH2gAyNDg2MzI2NTY0OjRmZjc0ZmQwMTYwZWU0N2UzNjk0MmZjMjYyMGM2MjM1ZjAzZWRhMzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1df11c1ac39f42eb4f7d3708b53b208b419f401", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1df11c1ac39f42eb4f7d3708b53b208b419f401", "committedDate": "2020-09-14T04:54:37Z", "message": "Add example settings to sample security realm\n\nThis change adds configurable settings to the `CustomRealm` in the QA\nproject as the correct declaration and use of settings can be a source\nof confusion in custom realms.\n\nThe \"username\" \"password\" and \"roles\" are now all configurable, which\ndemonstrates the use of a simple string setting (\"username\") a secure\nsetting (\"password\") and a more complex list setting (\"roles\")."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9138f6f26d2b31adb71401dab28dd05f595b7036", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/9138f6f26d2b31adb71401dab28dd05f595b7036", "committedDate": "2020-09-14T05:46:08Z", "message": "Merge branch 'master' into sample-realm-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5101a1573891df47b36fe644b965c0cb9cdb0286", "committedDate": "2020-09-15T01:24:23Z", "message": "Merge branch 'master' into sample-realm-config"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNTg2MTY5", "url": "https://github.com/elastic/elasticsearch/pull/62287#pullrequestreview-492586169", "createdAt": "2020-09-21T13:13:29Z", "commit": {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzoxMzozMFrOHVPW5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMzo0OToyMVrOHVQ8bQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjAzMzc2Nw==", "bodyText": "This is not new in this PR. But I find the repetition of custom confusing as well. Probably better to have something like custom.custom1 or custom.default_custom.", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r492033767", "createdAt": "2020-09-21T13:13:30Z", "author": {"login": "ywangd"}, "path": "x-pack/qa/security-example-spi-extension/build.gradle", "diffHunk": "@@ -25,6 +25,9 @@ testClusters.all {\n \n   setting 'xpack.security.authc.realms.custom.custom.order', '0'\n   setting 'xpack.security.authc.realms.custom.custom.filtered_setting', 'should be filtered'\n+  setting 'xpack.security.authc.realms.custom.custom.username', 'test_user'\n+  keystore 'xpack.security.authc.realms.custom.custom.password', 'secret_password'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA0MzIyMA==", "bodyText": "Unless you are intentionally showing that password here can bypass the \"at last 6-chars\" policy, I'd prefer it to be compliant for consistency.", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r492043220", "createdAt": "2020-09-21T13:27:19Z", "author": {"login": "ywangd"}, "path": "x-pack/qa/security-example-spi-extension/src/test/java/org/elasticsearch/example/realm/CustomRealmTests.java", "diffHunk": "@@ -17,26 +18,56 @@\n import org.elasticsearch.xpack.core.security.authc.support.UsernamePasswordToken;\n import org.elasticsearch.xpack.core.security.user.User;\n \n+import java.util.List;\n+\n import static org.elasticsearch.xpack.core.security.authc.RealmSettings.getFullSettingKey;\n+import static org.hamcrest.Matchers.arrayContaining;\n import static org.hamcrest.Matchers.equalTo;\n import static org.hamcrest.Matchers.notNullValue;\n \n public class CustomRealmTests extends ESTestCase {\n-    public void testAuthenticate() {\n+\n+    public void testAuthenticateDefaultConfig() {\n         Settings globalSettings = Settings.builder().put(\"path.home\", createTempDir()).build();\n         final RealmConfig.RealmIdentifier realmIdentifier = new RealmConfig.RealmIdentifier(CustomRealm.TYPE, \"test\");\n         CustomRealm realm = new CustomRealm(new RealmConfig(\n             realmIdentifier,\n             Settings.builder().put(globalSettings).put(getFullSettingKey(realmIdentifier, RealmSettings.ORDER_SETTING), 0).build(),\n             TestEnvironment.newEnvironment(globalSettings), new ThreadContext(globalSettings)));\n-        SecureString password = CustomRealm.KNOWN_PW.clone();\n-        UsernamePasswordToken token = new UsernamePasswordToken(CustomRealm.KNOWN_USER, password);\n+        SecureString password = CustomRealm.DEFAULT_KNOWN_PW.clone();\n+        UsernamePasswordToken token = new UsernamePasswordToken(CustomRealm.DEFAULT_KNOWN_USER, password);\n+        PlainActionFuture<AuthenticationResult> plainActionFuture = new PlainActionFuture<>();\n+        realm.authenticate(token, plainActionFuture);\n+        User user = plainActionFuture.actionGet().getUser();\n+        assertThat(user, notNullValue());\n+        assertThat(List.of(user.roles()), equalTo(CustomRealm.DEFAULT_ROLES));\n+        assertThat(user.principal(), equalTo(CustomRealm.DEFAULT_KNOWN_USER));\n+    }\n+\n+    public void testAuthenticateCustomConfig() {\n+        final RealmConfig.RealmIdentifier realmIdentifier = new RealmConfig.RealmIdentifier(CustomRealm.TYPE, \"test\");\n+        MockSecureSettings secureSettings = new MockSecureSettings();\n+        secureSettings.setString(getFullSettingKey(realmIdentifier.getName(), CustomRealm.PASSWORD_SETTING), \"12345\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjA1OTc1Nw==", "bodyText": "This is rather a question for my learning. Why are these needed here? This configures the threadContext to always contain the right headers of username and password. Does that mean transport client can always connect without providing credentials?", "url": "https://github.com/elastic/elasticsearch/pull/62287#discussion_r492059757", "createdAt": "2020-09-21T13:49:21Z", "author": {"login": "ywangd"}, "path": "x-pack/qa/security-example-spi-extension/src/javaRestTest/java/org/elasticsearch/example/realm/CustomRealmIT.java", "diffHunk": "@@ -23,12 +23,16 @@\n  */\n public class CustomRealmIT extends ESRestTestCase {\n \n+    // These are configured in build.gradle\n+    public static final String USERNAME= \"test_user\";\n+    public static final String PASSWORD = \"secret_password\";\n+\n     @Override\n     protected Settings restClientSettings() {\n         return Settings.builder()\n-                .put(ThreadContext.PREFIX + \".\" + CustomRealm.USER_HEADER, CustomRealm.KNOWN_USER)\n-                .put(ThreadContext.PREFIX + \".\" + CustomRealm.PW_HEADER, CustomRealm.KNOWN_PW.toString())\n-                .build();\n+            .put(ThreadContext.PREFIX + \".\" + CustomRealm.USER_HEADER, USERNAME)\n+            .put(ThreadContext.PREFIX + \".\" + CustomRealm.PW_HEADER, PASSWORD)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5101a1573891df47b36fe644b965c0cb9cdb0286"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73104d7b3882ba23d2849129ff27a90ee481078d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/73104d7b3882ba23d2849129ff27a90ee481078d", "committedDate": "2020-10-05T06:04:26Z", "message": "Merge branch 'master' into sample-realm-config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ff74fd0160ee47e36942fc2620c6235f03eda30", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ff74fd0160ee47e36942fc2620c6235f03eda30", "committedDate": "2020-10-05T06:24:52Z", "message": "Address feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4562, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}