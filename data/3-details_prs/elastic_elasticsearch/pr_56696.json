{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE3NDYzNzQ1", "number": 56696, "title": "[Transform] add support for terms agg in transforms", "bodyText": "This adds support for terms and rare_terms aggs in transforms.\nThe default behavior is that the results are collapsed in the following manner:\n<AGG_NAME>.<BUCKET_NAME>.<SUBAGGS...>...\nOr if no sub aggs exist\n<AGG_NAME>.<BUCKET_NAME>.<_doc_count>\nThe mapping is also defined as flattened by default. This is to avoid field explosion while still providing (limited) search and aggregation capabilities.", "createdAt": "2020-05-13T16:07:05Z", "url": "https://github.com/elastic/elasticsearch/pull/56696", "merged": true, "mergeCommit": {"oid": "fd812d2adaff3c1ed36f825cafb48d7b13a8fa43"}, "closed": true, "closedAt": "2020-05-15T11:11:46Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg7RuUgH2gAyNDE3NDYzNzQ1OmMxODIzOGMwMWE5OTQ3YjVjYzU3OTJmMGVkZTliZTFiZWQxMjRhYmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchdPUrAFqTQxMjQyMTkzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c18238c01a9947b5cc5792f0ede9be1bed124aba", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c18238c01a9947b5cc5792f0ede9be1bed124aba", "committedDate": "2020-05-13T16:15:25Z", "message": "[Transform] add support for terms agg in transforms"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1c8f47c5e9851aba4b7807ff6fda2b92b2313a6b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c8f47c5e9851aba4b7807ff6fda2b92b2313a6b", "committedDate": "2020-05-13T16:03:49Z", "message": "[Transform] add support for terms agg in transforms"}, "afterCommit": {"oid": "c18238c01a9947b5cc5792f0ede9be1bed124aba", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c18238c01a9947b5cc5792f0ede9be1bed124aba", "committedDate": "2020-05-13T16:15:25Z", "message": "[Transform] add support for terms agg in transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c", "committedDate": "2020-05-13T16:51:27Z", "message": "fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExNTk5ODI2", "url": "https://github.com/elastic/elasticsearch/pull/56696#pullrequestreview-411599826", "createdAt": "2020-05-14T08:56:45Z", "commit": {"oid": "d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwODo1Njo0NlrOGVSm3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNFQwOToxMjo1N1rOGVTP7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk3ODE0MA==", "bodyText": "\ud83d\ude04", "url": "https://github.com/elastic/elasticsearch/pull/56696#discussion_r424978140", "createdAt": "2020-05-14T08:56:46Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/transform/preview_transforms.yml", "diffHunk": "@@ -265,12 +265,12 @@ setup:\n               \"group_by\": {\n                 \"time\": {\"date_histogram\": {\"fixed_interval\": \"1h\", \"field\": \"time\"}}},\n               \"aggs\": {\n-                \"vals\": {\"terms\": {\"field\":\"airline\"}}\n+                \"vals\": {\"significant_terms\": {\"field\":\"airline\"}}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4MTA1MA==", "bodyText": "\ud83d\udc4d this is almost exactly the way I implemented it, too (well, there is probably no other way).", "url": "https://github.com/elastic/elasticsearch/pull/56696#discussion_r424981050", "createdAt": "2020-05-14T09:00:56Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -246,6 +250,35 @@ public Object value(Aggregation agg, Map<String, String> fieldTypeMap, String lo\n         }\n     }\n \n+    static class MultiBucketsAggExtractor implements AggValueExtractor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDk4ODY1NA==", "bodyText": "it would be good to cover this branch and have a test with nested terms aggs, like your common user example, broke down by e.g. businesses or filtered by something", "url": "https://github.com/elastic/elasticsearch/pull/56696#discussion_r424988654", "createdAt": "2020-05-14T09:12:57Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -246,6 +250,35 @@ public Object value(Aggregation agg, Map<String, String> fieldTypeMap, String lo\n         }\n     }\n \n+    static class MultiBucketsAggExtractor implements AggValueExtractor {\n+        @Override\n+        public Object value(Aggregation agg, Map<String, String> fieldTypeMap, String lookupFieldPrefix) {\n+            MultiBucketsAggregation aggregation = (MultiBucketsAggregation) agg;\n+\n+            HashMap<String, Object> nested = new HashMap<>();\n+\n+            for (MultiBucketsAggregation.Bucket bucket : aggregation.getBuckets()) {\n+                if (bucket.getAggregations().iterator().hasNext() == false) {\n+                    nested.put(bucket.getKeyAsString(), bucket.getDocCount());\n+                } else {\n+                    HashMap<String, Object> nestedBucketObject = new HashMap<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d9b6ea4638fe7ce56ff3b4dff9eaa00a3f03574c"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26eec61f048c4a47d93da90aaa6253525e16dd69", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/26eec61f048c4a47d93da90aaa6253525e16dd69", "committedDate": "2020-05-14T18:55:24Z", "message": "Merge branch 'master' into feature/ml-add-terms-support-transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31d03ab34b33f0529b2140292dd5e9ab2d16c232", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/31d03ab34b33f0529b2140292dd5e9ab2d16c232", "committedDate": "2020-05-14T19:16:39Z", "message": "addressing pr comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNDIxOTMz", "url": "https://github.com/elastic/elasticsearch/pull/56696#pullrequestreview-412421933", "createdAt": "2020-05-15T07:49:34Z", "commit": {"oid": "31d03ab34b33f0529b2140292dd5e9ab2d16c232"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4907, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}