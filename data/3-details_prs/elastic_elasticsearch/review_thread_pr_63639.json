{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNzMyMzEw", "number": 63639, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0Mjo1N1rOEtYSYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNzoxMVrOEtaWLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDE5Mjk5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0Mjo1N1rOHhIiqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOToxMzozM1rOHhJxhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw==", "bodyText": "Rather than having to pass these through to merge, can't we just keep references to them instead of references to the MapperService?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504505003", "createdAt": "2020-10-14T08:42:57Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxMTM4OA==", "bodyText": "I don't see the point in holding on to references of objects that callers also hold on to already? Also, looking at potential further improvements, I think not holding those references simplifies things in DocumentMapper, doesn't it? are you annoyed by the number of arguments required by calling merge?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504511388", "createdAt": "2020-10-14T08:52:27Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}, "originalCommit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNDg4Ng==", "bodyText": "The IndexSettings, IndexAnalyzers and DocumentMapperParser always remain the same, I think? So it's annoying to have to keep passing them to merge when the DocumentMapper has already been told about them.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504514886", "createdAt": "2020-10-14T08:57:34Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}, "originalCommit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUyNTE4OA==", "bodyText": "yes they ought to stay the same :) I see your point. these additional arguments do clutter the API, I just find it odd that we need to keep a reference to them only because it is needed for when merge is called, which is called from a place that has all this available too. I can be convinced though. I think not holding on to MapperService is the primary goal, hence I can go back and remove those arguments from merge.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504525188", "createdAt": "2020-10-14T09:13:33Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw=="}, "originalCommit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDIwNDUyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0NTo0MlrOHhIpWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo1ODo1OVrOHhJM3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ==", "bodyText": "I don't think we need to change this method signature? Particularly now that the DocumentMapper constructor is private, just passing the MapperService here is a much simpler API.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504506715", "createdAt": "2020-10-14T08:45:42Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -99,19 +99,17 @@ public Builder put(MetadataFieldMapper.Builder mapper) {\n             return this;\n         }\n \n-        public DocumentMapper build(MapperService mapperService) {\n+        public DocumentMapper build(IndexSettings indexSettings, DocumentMapperParser documentMapperParser, IndexAnalyzers indexAnalyzers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNDI0OQ==", "bodyText": "I think it depends on perspective. Does the lower number of arguments make it a simpler API? To me, three arguments make it clear what is needed, while MapperService means \"I may or may not need a bunch of stuff\". I think with the three arguments, it is clearer what the method actually uses and needs. MapperService is such a big object to carry around.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504514249", "createdAt": "2020-10-14T08:56:38Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -99,19 +99,17 @@ public Builder put(MetadataFieldMapper.Builder mapper) {\n             return this;\n         }\n \n-        public DocumentMapper build(MapperService mapperService) {\n+        public DocumentMapper build(IndexSettings indexSettings, DocumentMapperParser documentMapperParser, IndexAnalyzers indexAnalyzers) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ=="}, "originalCommit": {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxNTgwNQ==", "bodyText": "Fair enough - I think we'll end up removing the IndexAnalyzers param soon anyway, so that drops it down to just two parameters which doesn't seem excessive.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504515805", "createdAt": "2020-10-14T08:58:59Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -99,19 +99,17 @@ public Builder put(MetadataFieldMapper.Builder mapper) {\n             return this;\n         }\n \n-        public DocumentMapper build(MapperService mapperService) {\n+        public DocumentMapper build(IndexSettings indexSettings, DocumentMapperParser documentMapperParser, IndexAnalyzers indexAnalyzers) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ=="}, "originalCommit": {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDUyNDc3OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNTozOFrOHhLvlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoyMjowNlrOHhMUVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NzQ2Mw==", "bodyText": "I think these changes are unnecessary now?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557463", "createdAt": "2020-10-14T10:05:38Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java", "diffHunk": "@@ -43,8 +43,8 @@\n public class DocumentMapperTests extends MapperServiceTestCase {\n \n     public void testAddFields() throws Exception {\n-        DocumentMapper stage1\n-            = createDocumentMapper(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n+        MapperService mapperService = createMapperService(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2Njg3MQ==", "bodyText": "right", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504566871", "createdAt": "2020-10-14T10:22:06Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java", "diffHunk": "@@ -43,8 +43,8 @@\n public class DocumentMapperTests extends MapperServiceTestCase {\n \n     public void testAddFields() throws Exception {\n-        DocumentMapper stage1\n-            = createDocumentMapper(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n+        MapperService mapperService = createMapperService(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NzQ2Mw=="}, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDUyNzYxOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNjoyN1rOHhLxgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDoyNzozOFrOHhMf1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzk1NQ==", "bodyText": "I think this can be left unchanged as well?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557955", "createdAt": "2020-10-14T10:06:27Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java", "diffHunk": "@@ -78,8 +78,9 @@ public static MapperService newMapperService(NamedXContentRegistry xContentRegis\n \n     public static void assertConflicts(String mapping1,\n                                        String mapping2,\n-                                       DocumentMapperParser\n-                                           parser, String... conflicts) throws IOException {\n+                                       DocumentMapperParser parser,\n+                                       MapperService mapperService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU2OTgxMw==", "bodyText": "thanks for catching it, mapper service is unused.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504569813", "createdAt": "2020-10-14T10:27:38Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java", "diffHunk": "@@ -78,8 +78,9 @@ public static MapperService newMapperService(NamedXContentRegistry xContentRegis\n \n     public static void assertConflicts(String mapping1,\n                                        String mapping2,\n-                                       DocumentMapperParser\n-                                           parser, String... conflicts) throws IOException {\n+                                       DocumentMapperParser parser,\n+                                       MapperService mapperService,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzk1NQ=="}, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDUzMDM3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNzoxMVrOHhLzNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNzoxMVrOHhLzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1ODM5MA==", "bodyText": "These too", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504558390", "createdAt": "2020-10-14T10:07:11Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java", "diffHunk": "@@ -366,10 +366,9 @@ public void testDepthLimit() throws IOException {\n                 .endObject()\n             .endObject()\n         .endObject());\n-\n+        MapperService mapperService = indexService.mapperService();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2991, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}