{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk1MTEwMjE1", "number": 63038, "title": "Move SLM history to data stream", "bodyText": "This change converts SLM history index to data stream.\nConsequence of this is name change as name of data stream can't start with .. New name for SLM history data stream will be slm-history-4 (retaining version in the name).", "createdAt": "2020-09-29T21:18:37Z", "url": "https://github.com/elastic/elasticsearch/pull/63038", "merged": true, "mergeCommit": {"oid": "a3dd08eba31f81ff3b3594ab9074a5337855a3ad"}, "closed": true, "closedAt": "2020-10-01T11:35:27Z", "author": {"login": "probakowski"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNu3mkgH2gAyNDk1MTEwMjE1OmJmNDg1Y2VlZjQ2Mzc0NDM0MDBkODU1YWFlZjk2YjRkMGEyYzFiMWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdODuFzAH2gAyNDk1MTEwMjE1OjQxNGExMTM2OGE2MjZjODQzOTI4NDhlYWQxNmE5Nzc1MThlMjBiY2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf485ceef4637443400d855aaef96b4d0a2c1b1e", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf485ceef4637443400d855aaef96b4d0a2c1b1e", "committedDate": "2020-09-29T21:14:37Z", "message": "Move SLM history to data stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82d140da0799f67458a6b5c3c0bf4a6eee4304d7", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/82d140da0799f67458a6b5c3c0bf4a6eee4304d7", "committedDate": "2020-09-29T21:45:33Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7564e73da9b1694498bf1314b8d10ca398b711", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc7564e73da9b1694498bf1314b8d10ca398b711", "committedDate": "2020-09-29T23:22:31Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "672f19813c4ed9e58048689056bc541305417f05", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/672f19813c4ed9e58048689056bc541305417f05", "committedDate": "2020-09-30T08:48:34Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk5NzUwNDY2", "url": "https://github.com/elastic/elasticsearch/pull/63038#pullrequestreview-499750466", "createdAt": "2020-09-30T19:36:02Z", "commit": {"oid": "672f19813c4ed9e58048689056bc541305417f05"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxOTozNjowMlrOHasc4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0zMFQxOTozNjowMlrOHasc4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Nzc1MzMxNA==", "bodyText": "I think this should be a bit more descriptive about why it failed (such as mentioning that the data stream and template were missing) since we don't have an exception in this case", "url": "https://github.com/elastic/elasticsearch/pull/63038#discussion_r497753314", "createdAt": "2020-09-30T19:36:02Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/slm/history/SnapshotHistoryStore.java", "diffHunk": "@@ -59,85 +56,29 @@ public void putAsync(SnapshotHistoryItem item) {\n                 SLM_HISTORY_INDEX_ENABLED_SETTING.getKey(), item);\n             return;\n         }\n-        logger.trace(\"about to index snapshot history item in index [{}]: [{}]\", SLM_HISTORY_ALIAS, item);\n-        ensureHistoryIndex(client, clusterService.state(), ActionListener.wrap(createdIndex -> {\n-            try (XContentBuilder builder = XContentFactory.jsonBuilder()) {\n-                item.toXContent(builder, ToXContent.EMPTY_PARAMS);\n-                IndexRequest request = new IndexRequest(SLM_HISTORY_ALIAS)\n-                    .source(builder);\n-                client.index(request, ActionListener.wrap(indexResponse -> {\n-                    logger.debug(\"successfully indexed snapshot history item with id [{}] in index [{}]: [{}]\",\n-                        indexResponse.getId(), SLM_HISTORY_ALIAS, item);\n-                }, exception -> {\n-                    logger.error(new ParameterizedMessage(\"failed to index snapshot history item in index [{}]: [{}]\",\n-                        SLM_HISTORY_ALIAS, item), exception);\n-                }));\n-            } catch (IOException exception) {\n+        logger.trace(\"about to index snapshot history item in index [{}]: [{}]\", SLM_HISTORY_DATA_STREAM, item);\n+        Metadata metadata = clusterService.state().getMetadata();\n+        if (metadata.dataStreams().containsKey(SLM_HISTORY_DATA_STREAM) == false &&\n+            metadata.templatesV2().containsKey(SLM_TEMPLATE_NAME) == false) {\n+            logger.error(new ParameterizedMessage(\"failed to index snapshot history item in index [{}]: [{}]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "672f19813c4ed9e58048689056bc541305417f05"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "414a11368a626c84392848ead16a977518e20bca", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/414a11368a626c84392848ead16a977518e20bca", "committedDate": "2020-09-30T21:32:14Z", "message": "better error message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4546, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}