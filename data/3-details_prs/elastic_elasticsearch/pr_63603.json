{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMjE2NDM5", "number": 63603, "title": "Remove some more usages of QueryShardContext#getMapperService", "bodyText": "The 7.x branch has usages of QueryShardContext#getMapperService that revolve around types, which can be replaced by adding a couple of specific methods to QueryShardContext.\nThis commit takes care of those as well as a couple of other usages that can be removed.", "createdAt": "2020-10-13T11:27:24Z", "url": "https://github.com/elastic/elasticsearch/pull/63603", "merged": true, "mergeCommit": {"oid": "8866df240e3b6f05d0d8ecee0da05a4dbd713ed8"}, "closed": true, "closedAt": "2020-10-13T14:15:35Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSG0KugH2gAyNTAyMjE2NDM5OjY0MTU0OTA4NTQ2YWFlMWY2YjdlY2ZjM2YyNDMwOTdiZTdlMDNkNjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSIo_SgFqTUwNzQzNzgxMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/64154908546aae1f6b7ecfc3f243097be7e03d64", "committedDate": "2020-10-13T11:24:17Z", "message": "Remove some more usages of QueryShardContext#getMapperService\n\nThe 7.x branch has usages of QueryShardContext#getMapperService that revolve around types, which can be replaced by adding a couple of specific methods to QueryShardContext.\n\nThis commit takes care of those as well as a couple of other usages that can be removed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MzMzODQy", "url": "https://github.com/elastic/elasticsearch/pull/63603#pullrequestreview-507333842", "createdAt": "2020-10-13T11:28:34Z", "commit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyODozNFrOHgiCdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyODozNFrOHgiCdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ==", "bodyText": "the supplier feels weird, yet I believe we need to distinguish between a null document mapper and a null type, hence simply providing the type as an argument did not feel right to me. Happy to be proven wrong.", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503874165", "createdAt": "2020-10-13T11:28:34Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -85,13 +85,13 @@ public Status needsField(FieldInfo fieldInfo) {\n         // All these fields are single-valued so we can stop when the set is\n         // empty\n         return requiredFields.isEmpty()\n-                ? Status.STOP\n-                : Status.NO;\n+            ? Status.STOP\n+            : Status.NO;\n     }\n \n-    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable DocumentMapper mapper) {\n-        if (mapper != null) {\n-            type = mapper.type();\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable Supplier<String> typeSupplier) {\n+        if (typeSupplier != null) {\n+            type = typeSupplier.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee1d444052718a5febc83aff39f35f1f89bae042", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee1d444052718a5febc83aff39f35f1f89bae042", "committedDate": "2020-10-13T11:36:58Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c79179f7c6cd0587ee7fac2fb160a9d6beffef5", "committedDate": "2020-10-13T13:23:02Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDMwODQx", "url": "https://github.com/elastic/elasticsearch/pull/63603#pullrequestreview-507430841", "createdAt": "2020-10-13T13:25:06Z", "commit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyNTowNlrOHgmlvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyNTowNlrOHgmlvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ==", "bodyText": "I took a shortcut here, to avoid having to expose typeText from MapperService. Is it reasonable?", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503948735", "createdAt": "2020-10-13T13:25:06Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "diffHunk": "@@ -237,7 +237,8 @@ protected MultiSearchResponse shardOperation(Request request, ShardId shardId) t\n                     () -> { throw new UnsupportedOperationException(); },\n                     null\n                 );\n-                final Text typeText = context.getMapperService().documentMapper().typeText();\n+                final String type = context.getType();\n+                final Text typeText = new Text(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDM3ODEy", "url": "https://github.com/elastic/elasticsearch/pull/63603#pullrequestreview-507437812", "createdAt": "2020-10-13T13:31:46Z", "commit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzozMTo0NlrOHgm5og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzozMTo0NlrOHgm5og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1MzgyNg==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503953826", "createdAt": "2020-10-13T13:31:46Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "diffHunk": "@@ -237,7 +237,8 @@ protected MultiSearchResponse shardOperation(Request request, ShardId shardId) t\n                     () -> { throw new UnsupportedOperationException(); },\n                     null\n                 );\n-                final Text typeText = context.getMapperService().documentMapper().typeText();\n+                final String type = context.getType();\n+                final Text typeText = new Text(type);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ=="}, "originalCommit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4090, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}