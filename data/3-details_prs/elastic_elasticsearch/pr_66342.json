{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMjUyNjAz", "number": 66342, "title": "Avoid building ES archives for bwc nested builds", "bodyText": "Certain BWC tests rely on elasticsearch distributions build from source.\nSo far this was done by building an ES archive in a nested build ( e.g. see\nhttps://gradle-enterprise.elastic.co/s/e7jb5w2dyi7oy/timeline?details=potxx3gikoxci )\nand then the consuming build extracted that archive immediately before running tests\nagainst that distribution.\nThis change closes the loop on consuming extract only configurations that were introduced in\nan earlier PR (#63599) which results in saving us building\nthe elasticsearch tars and zips in the nested builds which reduces the overhead drastically\nnew nested build without archive building:\nhttps://gradle-enterprise.elastic.co/s/xa56zkpa6awhw/timeline?details=qjvevbdhsjooy\nFixes #62115\nMost of the changed files are integTest related to have a proper reflection of how we handle older versions that do not support directly access extracted assemble.", "createdAt": "2020-12-15T13:31:48Z", "url": "https://github.com/elastic/elasticsearch/pull/66342", "merged": true, "mergeCommit": {"oid": "5f219b3eee6b27840d5e10016e117a2c103f198b"}, "closed": true, "closedAt": "2020-12-17T08:59:30Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmcN2xABqjQxMTUyMzMzMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm-y9cABqjQxMjM3NjQ4Mzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1f36e795954b1a20be706d8731f30eba481aabeb", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f36e795954b1a20be706d8731f30eba481aabeb", "committedDate": "2020-12-15T15:16:37Z", "message": "Distinguish between extractedAssemble and expandedDist support"}, "afterCommit": {"oid": "bdfbfb238e0db2d51d63bfefcf2213e84fef5736", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/bdfbfb238e0db2d51d63bfefcf2213e84fef5736", "committedDate": "2020-12-15T15:38:31Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MDQxMTA3", "url": "https://github.com/elastic/elasticsearch/pull/66342#pullrequestreview-554041107", "createdAt": "2020-12-16T20:04:09Z", "commit": {"oid": "675e7e0953724ec5e28cf5697fd0551c996f6163"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMDowNDowOVrOIHW8Dg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQyMDoxODo1MVrOIHXfHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU4Njc2Ng==", "bodyText": "I think this should be private.", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544586766", "createdAt": "2020-12-16T20:04:09Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionBwcSetupPlugin.java", "diffHunk": "@@ -225,49 +245,59 @@ static void createBuildBwcTask(\n      * we build from a bwc Version in a cloned repository\n      */\n     private static class DistributionProject {\n-        private final String name;\n-        private File checkoutDir;\n-        private String projectPath;\n-        private File distFile;\n-        private File expandedDistDir;\n+        final String name;\n+        final File checkoutDir;\n+        final String projectPath;\n+\n+        /**\n+         * can be removed once we don't build 7.10 anymore\n+         * from source for bwc tests.\n+         * */\n+        @Deprecated\n+        final boolean expandedDistDirSupport;\n+        final boolean extractedAssembleSupported;\n+        final DistributionProjectArtifact expectedBuildArtifact;\n \n         DistributionProject(String name, String baseDir, Version version, String classifier, String extension, File checkoutDir) {\n             this.name = name;\n             this.checkoutDir = checkoutDir;\n             this.projectPath = baseDir + \"/\" + name;\n-            this.distFile = new File(\n-                checkoutDir,\n-                baseDir\n-                    + \"/\"\n-                    + name\n-                    + \"/build/distributions/elasticsearch-\"\n-                    + (name.startsWith(\"oss\") ? \"oss-\" : \"\")\n-                    + version\n-                    + \"-SNAPSHOT\"\n-                    + classifier\n-                    + \".\"\n-                    + extension\n+            this.expandedDistDirSupport = version.onOrAfter(\"7.10.0\") && (name.endsWith(\"zip\") || name.endsWith(\"tar\"));\n+            this.extractedAssembleSupported = version.onOrAfter(\"7.11.0\") && (name.endsWith(\"zip\") || name.endsWith(\"tar\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675e7e0953724ec5e28cf5697fd0551c996f6163"}, "originalPosition": 154}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA==", "bodyText": "One thing we lose here with the directory approach is the check that this created the correct version. When we forget to bump versions in branches this will error in a scenario where we expect it to produce an artifact with say, version 7.11.0 but instead 7.12.0 is created. This is an indicator a version bump was missed and we are not testing the thing we expect.\nThat works with the file approach, as the version is embedded in the expected file name, but here we are simply looking for a folder .../build/install at which point that could container an exploded install directory with any version name. The expected build artifact should take this into account. We should specifically ensure the exploded folder name matches the expected version.", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544594918", "createdAt": "2020-12-16T20:17:21Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionBwcSetupPlugin.java", "diffHunk": "@@ -194,28 +206,36 @@ static void createBuildBwcTask(\n         Provider<Version> bwcVersion,\n         String projectName,\n         String projectPath,\n-        File projectArtifact,\n-        TaskProvider<Task> bwcTaskProvider\n+        DistributionProjectArtifact projectArtifact,\n+        TaskProvider<Task> bwcTaskProvider,\n+        String assembleTaskName\n     ) {\n         String bwcTaskName = buildBwcTaskName(projectName);\n         bwcSetupExtension.bwcTask(bwcTaskName, c -> {\n+            boolean useNativeExpanded = projectArtifact.expandedDistDir != null;\n+            File expectedOutputFile = useNativeExpanded ? projectArtifact.expandedDistDir : projectArtifact.distFile;\n             c.getInputs().file(new File(project.getBuildDir(), \"refspec\"));\n-            c.getOutputs().files(projectArtifact);\n+            if (useNativeExpanded) {\n+                c.getOutputs().dir(expectedOutputFile);\n+            } else {\n+                c.getOutputs().files(expectedOutputFile);\n+            }\n             c.getOutputs().cacheIf(\"BWC distribution caching is disabled on 'master' branch\", task -> {\n                 String gitBranch = System.getenv(\"GIT_BRANCH\");\n                 return BuildParams.isCi() && (gitBranch == null || gitBranch.endsWith(\"master\") == false);\n             });\n-            c.args(projectPath.replace('/', ':') + \":assemble\");\n+            c.args(projectPath.replace('/', ':') + \":\" + assembleTaskName);\n             if (project.getGradle().getStartParameter().isBuildCacheEnabled()) {\n                 c.args(\"--build-cache\");\n             }\n             c.doLast(task -> {\n-                if (projectArtifact.exists() == false) {\n+                if (expectedOutputFile.exists() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "675e7e0953724ec5e28cf5697fd0551c996f6163"}, "originalPosition": 104}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NTc0MA==", "bodyText": "Might also be worth adding a test case for this.", "url": "https://github.com/elastic/elasticsearch/pull/66342#discussion_r544595740", "createdAt": "2020-12-16T20:18:51Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionBwcSetupPlugin.java", "diffHunk": "@@ -194,28 +206,36 @@ static void createBuildBwcTask(\n         Provider<Version> bwcVersion,\n         String projectName,\n         String projectPath,\n-        File projectArtifact,\n-        TaskProvider<Task> bwcTaskProvider\n+        DistributionProjectArtifact projectArtifact,\n+        TaskProvider<Task> bwcTaskProvider,\n+        String assembleTaskName\n     ) {\n         String bwcTaskName = buildBwcTaskName(projectName);\n         bwcSetupExtension.bwcTask(bwcTaskName, c -> {\n+            boolean useNativeExpanded = projectArtifact.expandedDistDir != null;\n+            File expectedOutputFile = useNativeExpanded ? projectArtifact.expandedDistDir : projectArtifact.distFile;\n             c.getInputs().file(new File(project.getBuildDir(), \"refspec\"));\n-            c.getOutputs().files(projectArtifact);\n+            if (useNativeExpanded) {\n+                c.getOutputs().dir(expectedOutputFile);\n+            } else {\n+                c.getOutputs().files(expectedOutputFile);\n+            }\n             c.getOutputs().cacheIf(\"BWC distribution caching is disabled on 'master' branch\", task -> {\n                 String gitBranch = System.getenv(\"GIT_BRANCH\");\n                 return BuildParams.isCi() && (gitBranch == null || gitBranch.endsWith(\"master\") == false);\n             });\n-            c.args(projectPath.replace('/', ':') + \":assemble\");\n+            c.args(projectPath.replace('/', ':') + \":\" + assembleTaskName);\n             if (project.getGradle().getStartParameter().isBuildCacheEnabled()) {\n                 c.args(\"--build-cache\");\n             }\n             c.doLast(task -> {\n-                if (projectArtifact.exists() == false) {\n+                if (expectedOutputFile.exists() == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDU5NDkxOA=="}, "originalCommit": {"oid": "675e7e0953724ec5e28cf5697fd0551c996f6163"}, "originalPosition": 104}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "675e7e0953724ec5e28cf5697fd0551c996f6163", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/675e7e0953724ec5e28cf5697fd0551c996f6163", "committedDate": "2020-12-16T19:52:43Z", "message": "Merge branch 'master' into no-archives-build-in-bwc-nested"}, "afterCommit": {"oid": "fa0404cf74301fd26438173484b6c51a59773532", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa0404cf74301fd26438173484b6c51a59773532", "committedDate": "2020-12-17T07:27:49Z", "message": "Address review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "512630cc91e7c723b4020f218200471e3ce5f38b", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/512630cc91e7c723b4020f218200471e3ce5f38b", "committedDate": "2020-12-17T07:46:22Z", "message": "Avoid building ES archives for bwc nested builds\n\n- This closes the loop on avoiding building es archives for bwc tests when build from source\n- Instead of assemble the consuming builds request assembleExtracted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e2b5711aaab866cf0dbaae16abc46cff5bcd433", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e2b5711aaab866cf0dbaae16abc46cff5bcd433", "committedDate": "2020-12-17T07:46:24Z", "message": "Fix configuration reference to extractedAssemble"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "634c0eb2e1ed6567aba48576d88e64a64622566c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/634c0eb2e1ed6567aba48576d88e64a64622566c", "committedDate": "2020-12-17T07:46:24Z", "message": "native extracted bwc config only available since 7.11"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45bd4f4dec4a145a1175b936df152768e70ead1c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/45bd4f4dec4a145a1175b936df152768e70ead1c", "committedDate": "2020-12-17T07:46:25Z", "message": "Distinguish between extractedAssemble and expandedDist support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ad36ffab64bb4f971b7fcf4ba6204bfd5395659", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ad36ffab64bb4f971b7fcf4ba6204bfd5395659", "committedDate": "2020-12-17T07:46:25Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "committedDate": "2020-12-17T07:46:26Z", "message": "Address review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fa0404cf74301fd26438173484b6c51a59773532", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa0404cf74301fd26438173484b6c51a59773532", "committedDate": "2020-12-17T07:27:49Z", "message": "Address review feedback"}, "afterCommit": {"oid": "2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d0d2dbba3e1ec847d1ffaf0bf45ec1d47adbf76", "committedDate": "2020-12-17T07:46:26Z", "message": "Address review feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4522, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}