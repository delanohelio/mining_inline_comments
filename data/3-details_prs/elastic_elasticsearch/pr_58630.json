{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwODcyMzE5", "number": 58630, "title": "Fix Snapshots Capturing Incomplete Datastreams", "bodyText": "Only snapshot datastreams that are recorded in SnapshotInfo and clean those\nthat aren't from the snapshotted metadata.\nDo not restore all datastreams by default when restoring global metadata, use the same\nmechanics used for indices here.\nCloses #58544", "createdAt": "2020-06-27T06:51:09Z", "url": "https://github.com/elastic/elasticsearch/pull/58630", "merged": true, "mergeCommit": {"oid": "c01e822185334e267df9ca294a34e3321ba026a0"}, "closed": true, "closedAt": "2020-06-29T08:58:13Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcvSIQfAH2gAyNDQwODcyMzE5OmZkOGQyOGFmMzZhNmQ1NDljNWUyNDEzNWMwNGQyNDQxMDkyMzkyZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcv8srxAFqTQzODk4NTQ5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd8d28af36a6d549c5e24135c04d2441092392e7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd8d28af36a6d549c5e24135c04d2441092392e7", "committedDate": "2020-06-27T06:47:50Z", "message": "Fix Snapshots Capturing Incomplete Datastreams\n\nOnly snapshot datastreams that are recorded in `SnapshotInfo` and clean those\nthat aren't from the snapshotted metadata.\nDo not restore all datastreams by default when restoring global metadata, use the same\nmechanics used for indices here.\n\nCloses #58544"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9200324c16facaf62149d63c5619b31c79453a9d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9200324c16facaf62149d63c5619b31c79453a9d", "committedDate": "2020-06-27T07:04:41Z", "message": "Merge remote-tracking branch 'elastic/master' into 58544"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e", "committedDate": "2020-06-27T07:30:49Z", "message": "cleaner loop"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjgyODQx", "url": "https://github.com/elastic/elasticsearch/pull/58630#pullrequestreview-438682841", "createdAt": "2020-06-27T08:27:20Z", "commit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODoyNzoyMVrOGp0RFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODoyNzoyMVrOGp0RFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMTE0MA==", "bodyText": "We gotta only restore those data streams actually matched by the restore request, even if we include global state.\nWe really shouldn't be mutating the deserialization result here. Come to think of it, we also shouldn't be deserializing the data streams to a mutable map, that invites all kinds of weird bugs. I'll open a PR to fix that.", "url": "https://github.com/elastic/elasticsearch/pull/58630#discussion_r446501140", "createdAt": "2020-06-27T08:27:21Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/RestoreService.java", "diffHunk": "@@ -215,9 +215,12 @@ public void restoreSnapshot(final RestoreSnapshotRequest request, final ActionLi\n                     dataStreams = new HashMap<>();\n                 } else {\n                     globalMetadata = repository.getSnapshotGlobalMetadata(snapshotId);\n-                    dataStreams = globalMetadata.dataStreams();\n-                    if (request.includeGlobalState() == false) {\n-                        dataStreams.keySet().retainAll(requestedDataStreams);\n+                    final Map<String, DataStream> dataStreamsInSnapshot = globalMetadata.dataStreams();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjgyODgy", "url": "https://github.com/elastic/elasticsearch/pull/58630#pullrequestreview-438682882", "createdAt": "2020-06-27T08:28:11Z", "commit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODoyODoxMVrOGp0RXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODoyODoxMVrOGp0RXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMTIxMw==", "bodyText": "Just like for indices we should respect the data streams constraints given by the request and not simply always snapshot all data-streams when doing a global snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/58630#discussion_r446501213", "createdAt": "2020-06-27T08:28:11Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -230,13 +230,8 @@ public ClusterState execute(ClusterState currentState) {\n                 List<String> indices = Arrays.asList(indexNameExpressionResolver.concreteIndexNames(currentState,\n                     request.indicesOptions(), true, request.indices()));\n \n-                Map<String, DataStream> allDataStreams = currentState.metadata().dataStreams();\n-                List<String> dataStreams;\n-                if (request.includeGlobalState()) {\n-                    dataStreams = new ArrayList<>(allDataStreams.keySet());\n-                } else {\n-                    dataStreams = indexNameExpressionResolver.dataStreamNames(currentState, request.indicesOptions(), request.indices());\n-                }\n+                final List<String> dataStreams =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "originalPosition": 11}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4NjgzMDAx", "url": "https://github.com/elastic/elasticsearch/pull/58630#pullrequestreview-438683001", "createdAt": "2020-06-27T08:31:08Z", "commit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODozMTowOFrOGp0SPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yN1QwODozMTowOFrOGp0SPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjUwMTQzNg==", "bodyText": "This change is a little ugly because now we filter data streams that aren't part of the snapshot from metadata but not indices. In fact, for indices we could (and probably should) do the same as the index metadata for indices that aren't recorded in SnapshotInfo is not touched by restores anyway and just pointless bytes.\nFor data streams we absolutely have to clean up the metadata though since when writing SnapshotInfo, we use the metadata contents to determine what data streams go into SnapshotInfo.\nIf we don't clean this up here, then data streams not initially request for snapshotting will be part of the snapshot for every snapshot that includes global metadata.", "url": "https://github.com/elastic/elasticsearch/pull/58630#discussion_r446501436", "createdAt": "2020-06-27T08:31:08Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -354,9 +349,10 @@ private static ShardGenerations buildGenerations(SnapshotsInProgress.Entry snaps\n     }\n \n     private static Metadata metadataForSnapshot(SnapshotsInProgress.Entry snapshot, Metadata metadata) {\n+        final Metadata.Builder builder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2ab02c2e564884ff2ba0582e5c6f22ae7efa64e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4ca754c83d9aed635b70f0e80ab1a27ecf2b77d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4ca754c83d9aed635b70f0e80ab1a27ecf2b77d", "committedDate": "2020-06-27T08:33:53Z", "message": "shorter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM4OTg1NDkw", "url": "https://github.com/elastic/elasticsearch/pull/58630#pullrequestreview-438985490", "createdAt": "2020-06-29T08:23:39Z", "commit": {"oid": "d4ca754c83d9aed635b70f0e80ab1a27ecf2b77d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2508, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}