{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NjE0NjY4", "number": 54412, "title": "[DOCS] Adds HTTP response count example to Painless examples", "bodyText": "This PR contains a scripted metric aggregation example for counting HTTP responses in a web log dataset and adds it to the Painless examples for transforms page.", "createdAt": "2020-03-30T12:21:58Z", "url": "https://github.com/elastic/elasticsearch/pull/54412", "merged": true, "mergeCommit": {"oid": "b7d6ebc21ba41e8e0d7936536e30b848f67e303e"}, "closed": true, "closedAt": "2020-03-31T13:11:41Z", "author": {"login": "szabosteve"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcStiF0gH2gAyMzk1NjE0NjY4Ojk3YzZhNzg3Yjc1NzIwYmUwZmI2ZDJiMWIzMDNiNjliOTM2MGRlMDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTC3sQgFqTM4NDcxNjEwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "97c6a787b75720be0fb6d2b1b303b69b9360de06", "author": {"user": {"login": "szabosteve", "name": "Istv\u00e1n Zolt\u00e1n Szab\u00f3"}}, "url": "https://github.com/elastic/elasticsearch/commit/97c6a787b75720be0fb6d2b1b303b69b9360de06", "committedDate": "2020-03-30T12:19:41Z", "message": "[DOCS] Adds HTTP response count example to Painless examples."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTE3Mzky", "url": "https://github.com/elastic/elasticsearch/pull/54412#pullrequestreview-383917392", "createdAt": "2020-03-30T14:34:02Z", "commit": {"oid": "97c6a787b75720be0fb6d2b1b303b69b9360de06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDozNDowMlrOF9swAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNDozNDowMlrOF9swAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI0MDY0MQ==", "bodyText": "craters -> create ??", "url": "https://github.com/elastic/elasticsearch/pull/54412#discussion_r400240641", "createdAt": "2020-03-30T14:34:02Z", "author": {"login": "davidkyle"}, "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -327,3 +327,63 @@ the buckets you want to use for the variable. In this particular case, `min` and\n `max` are variables mapped to `time_frame.gte.value` and `time_frame.lte.value`.\n <3> Finally, the script substracts the start date of the session from the end \n date which results in the duration of the session.\n+\n+\n+[discrete]\n+[[painless-count-http]]\n+==== Counting HTTP responses by using scripted metric aggregation\n+\n+You can count the different HTTP response types in a web log data set by using \n+scripted metric aggregation as part of the {transform}. The example below \n+assumes that the HTTP response codes are stored in the `response` field of the \n+documents.\n+\n+[source,js]\n+--------------------------------------------------\n+\"aggregations\": { <1>\n+  \"responses.counts\": { <2>\n+    \"scripted_metric\": { <3>\n+      \"init_script\": \"state.responses = ['error':0L,'success':0L,'other':0L]\", <4>\n+      \"map_script\": \"\"\" <5>\n+        def code = doc['response.keyword'].value;\n+        if (code.startsWith('5') || code.startsWith('4')) {\n+          state.responses.error += 1 ;\n+        } else if(code.startsWith('2')) {\n+          state.responses.success += 1;\n+        } else {\n+          state.responses.other += 1;\n+        }\n+        \"\"\",\n+      \"combine_script\": \"state.responses\", <6>\n+      \"reduce_script\": \"\"\" <7>\n+        def counts = ['error': 0L, 'success': 0L, 'other': 0L];\n+        for (responses in states) {\n+          counts.error += responses['error'];\n+          counts.success += responses['success'];\n+          counts.other += responses['other'];\n+        }\n+        return counts;\n+        \"\"\"\n+      }\n+    },\n+  ...  \n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> The `aggregations` object of the {transform} that contains all aggregations.\n+<2> Object of the `scripted_metric` aggregation.\n+<3> This `scripted_metric` performs a distributed operation on the web log data \n+to count specific types of HTTP responses (error, success, and other).\n+<4> The `init_script` creates a `responses` array in the `state` object with \n+three properties (`error`, `success`, `other`) with long data type.\n+<5> The `map_script` defines `code` based on the `response.keyword` value of the \n+document, then it counts the errors, successes, and other responses based on the \n+first digit of the responses.\n+<6> The `combine_script` returns `state.responses` from each shard.\n+<7> The `reduce_script` craters a `counts` array with the `error`, `success`, ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97c6a787b75720be0fb6d2b1b303b69b9360de06"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgzOTUwMTkz", "url": "https://github.com/elastic/elasticsearch/pull/54412#pullrequestreview-383950193", "createdAt": "2020-03-30T15:06:10Z", "commit": {"oid": "97c6a787b75720be0fb6d2b1b303b69b9360de06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTowNjoxMFrOF9uS1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxNTowNjoxMFrOF9uS1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2NTk0Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            <7> The `reduce_script` craters a `counts` array with the `error`, `success`, \n          \n          \n            \n            <7> The `reduce_script` creates a `counts` array with the `error`, `success`,", "url": "https://github.com/elastic/elasticsearch/pull/54412#discussion_r400265942", "createdAt": "2020-03-30T15:06:10Z", "author": {"login": "szabosteve"}, "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -327,3 +327,63 @@ the buckets you want to use for the variable. In this particular case, `min` and\n `max` are variables mapped to `time_frame.gte.value` and `time_frame.lte.value`.\n <3> Finally, the script substracts the start date of the session from the end \n date which results in the duration of the session.\n+\n+\n+[discrete]\n+[[painless-count-http]]\n+==== Counting HTTP responses by using scripted metric aggregation\n+\n+You can count the different HTTP response types in a web log data set by using \n+scripted metric aggregation as part of the {transform}. The example below \n+assumes that the HTTP response codes are stored in the `response` field of the \n+documents.\n+\n+[source,js]\n+--------------------------------------------------\n+\"aggregations\": { <1>\n+  \"responses.counts\": { <2>\n+    \"scripted_metric\": { <3>\n+      \"init_script\": \"state.responses = ['error':0L,'success':0L,'other':0L]\", <4>\n+      \"map_script\": \"\"\" <5>\n+        def code = doc['response.keyword'].value;\n+        if (code.startsWith('5') || code.startsWith('4')) {\n+          state.responses.error += 1 ;\n+        } else if(code.startsWith('2')) {\n+          state.responses.success += 1;\n+        } else {\n+          state.responses.other += 1;\n+        }\n+        \"\"\",\n+      \"combine_script\": \"state.responses\", <6>\n+      \"reduce_script\": \"\"\" <7>\n+        def counts = ['error': 0L, 'success': 0L, 'other': 0L];\n+        for (responses in states) {\n+          counts.error += responses['error'];\n+          counts.success += responses['success'];\n+          counts.other += responses['other'];\n+        }\n+        return counts;\n+        \"\"\"\n+      }\n+    },\n+  ...  \n+}\n+--------------------------------------------------\n+// NOTCONSOLE\n+\n+<1> The `aggregations` object of the {transform} that contains all aggregations.\n+<2> Object of the `scripted_metric` aggregation.\n+<3> This `scripted_metric` performs a distributed operation on the web log data \n+to count specific types of HTTP responses (error, success, and other).\n+<4> The `init_script` creates a `responses` array in the `state` object with \n+three properties (`error`, `success`, `other`) with long data type.\n+<5> The `map_script` defines `code` based on the `response.keyword` value of the \n+document, then it counts the errors, successes, and other responses based on the \n+first digit of the responses.\n+<6> The `combine_script` returns `state.responses` from each shard.\n+<7> The `reduce_script` craters a `counts` array with the `error`, `success`, ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "97c6a787b75720be0fb6d2b1b303b69b9360de06"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4b199d2191981242922b3874e1169b326f50165", "author": {"user": {"login": "szabosteve", "name": "Istv\u00e1n Zolt\u00e1n Szab\u00f3"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4b199d2191981242922b3874e1169b326f50165", "committedDate": "2020-03-30T15:06:18Z", "message": "Update docs/reference/transform/painless-examples.asciidoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NjEyOTUx", "url": "https://github.com/elastic/elasticsearch/pull/54412#pullrequestreview-384612951", "createdAt": "2020-03-31T10:46:28Z", "commit": {"oid": "e4b199d2191981242922b3874e1169b326f50165"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0NjoyOFrOF-P3ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDo0ODozNFrOF-P78g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNjA1OA==", "bodyText": "we omit \"aggregations\" on the other example. I think we should be consistent. However I like it, so I suggest to add \"aggregations\" on the other example.", "url": "https://github.com/elastic/elasticsearch/pull/54412#discussion_r400816058", "createdAt": "2020-03-31T10:46:28Z", "author": {"login": "hendrikmuhs"}, "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -327,3 +327,63 @@ the buckets you want to use for the variable. In this particular case, `min` and\n `max` are variables mapped to `time_frame.gte.value` and `time_frame.lte.value`.\n <3> Finally, the script substracts the start date of the session from the end \n date which results in the duration of the session.\n+\n+\n+[discrete]\n+[[painless-count-http]]\n+==== Counting HTTP responses by using scripted metric aggregation\n+\n+You can count the different HTTP response types in a web log data set by using \n+scripted metric aggregation as part of the {transform}. The example below \n+assumes that the HTTP response codes are stored in the `response` field of the \n+documents.\n+\n+[source,js]\n+--------------------------------------------------\n+\"aggregations\": { <1>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b199d2191981242922b3874e1169b326f50165"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgxNzEzOA==", "bodyText": "I would add that the response code is stored as keyword and not as numeric.", "url": "https://github.com/elastic/elasticsearch/pull/54412#discussion_r400817138", "createdAt": "2020-03-31T10:48:34Z", "author": {"login": "hendrikmuhs"}, "path": "docs/reference/transform/painless-examples.asciidoc", "diffHunk": "@@ -327,3 +327,63 @@ the buckets you want to use for the variable. In this particular case, `min` and\n `max` are variables mapped to `time_frame.gte.value` and `time_frame.lte.value`.\n <3> Finally, the script substracts the start date of the session from the end \n date which results in the duration of the session.\n+\n+\n+[discrete]\n+[[painless-count-http]]\n+==== Counting HTTP responses by using scripted metric aggregation\n+\n+You can count the different HTTP response types in a web log data set by using \n+scripted metric aggregation as part of the {transform}. The example below \n+assumes that the HTTP response codes are stored in the `response` field of the \n+documents.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e4b199d2191981242922b3874e1169b326f50165"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c9619e260e775a208c0243c0cd7747097ab3b8", "author": {"user": {"login": "szabosteve", "name": "Istv\u00e1n Zolt\u00e1n Szab\u00f3"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7c9619e260e775a208c0243c0cd7747097ab3b8", "committedDate": "2020-03-31T12:01:06Z", "message": "[DOCS] Addresses feedback and minor changes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57b009b843b98e342c02406c3409ac6059b75f17", "author": {"user": {"login": "szabosteve", "name": "Istv\u00e1n Zolt\u00e1n Szab\u00f3"}}, "url": "https://github.com/elastic/elasticsearch/commit/57b009b843b98e342c02406c3409ac6059b75f17", "committedDate": "2020-03-31T12:01:54Z", "message": "Merge branch 'sm.painless' of github.com:szabosteve/elasticsearch into sm.painless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b22197f56be7ad79a0781d03b05524d5088c20c0", "author": {"user": {"login": "szabosteve", "name": "Istv\u00e1n Zolt\u00e1n Szab\u00f3"}}, "url": "https://github.com/elastic/elasticsearch/commit/b22197f56be7ad79a0781d03b05524d5088c20c0", "committedDate": "2020-03-31T12:02:49Z", "message": "[DOCS] Addresses feedback and minor changes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NzE2MTA5", "url": "https://github.com/elastic/elasticsearch/pull/54412#pullrequestreview-384716109", "createdAt": "2020-03-31T13:11:17Z", "commit": {"oid": "b22197f56be7ad79a0781d03b05524d5088c20c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1498, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}