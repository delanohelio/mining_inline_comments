{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwOTk3MTc4", "number": 64240, "title": "Ignore cancellation error when search is cancelled", "bodyText": "Since #63520, we will cancel a search that hits shard failures and does not accept partial results. However, that change can return the wrong HTTP code for bad requests (from 4xx to 5xx) due to the cancellation.\nRelates #63520\nCloses #64012\nCloses #63702", "createdAt": "2020-10-27T19:20:30Z", "url": "https://github.com/elastic/elasticsearch/pull/64240", "merged": true, "mergeCommit": {"oid": "43884496262f71aa3f33b34ac2f2271959dbf12a"}, "closed": true, "closedAt": "2020-10-27T23:43:03Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWt3LbAH2gAyNTEwOTk3MTc4Ojg4Njk4ZDE1MzdiNmQ3ZWM0OTVmMGJlMDBkMDI2NzQ5ODNhNjBmNDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWw3MfAH2gAyNTEwOTk3MTc4OjA1ZGNlNzRlODExZjI1ODE2MzMwMjE0NjVhNWIwMTg1NDk2MzY0YzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88698d1537b6d7ec495f0be00d02674983a60f49", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/88698d1537b6d7ec495f0be00d02674983a60f49", "committedDate": "2020-10-27T19:09:34Z", "message": "Ignore cancellation error when search is cancelled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd7c4dca8a638ddcd888e9e2f470ba9516119052", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd7c4dca8a638ddcd888e9e2f470ba9516119052", "committedDate": "2020-10-27T20:32:55Z", "message": "Fix testSearchPhaseFailureNoCause"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4MTI3MzE2", "url": "https://github.com/elastic/elasticsearch/pull/64240#pullrequestreview-518127316", "createdAt": "2020-10-27T20:46:00Z", "commit": {"oid": "bd7c4dca8a638ddcd888e9e2f470ba9516119052"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMDo0NjowMFrOHpQL4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yN1QyMDo0NjowMFrOHpQL4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzAxODg1MA==", "bodyText": "Can you update the comment above to say that we don't aggregate shard failures on search cancelled internally ?", "url": "https://github.com/elastic/elasticsearch/pull/64240#discussion_r513018850", "createdAt": "2020-10-27T20:46:00Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -438,7 +439,7 @@ protected void onShardGroupFailure(int shardIndex, SearchShardTarget shardTarget\n     @Override\n     public final void onShardFailure(final int shardIndex, @Nullable SearchShardTarget shardTarget, Exception e) {\n         // we don't aggregate shard failures on non active shards (but do keep the header counts right)\n-        if (TransportActions.isShardNotAvailableException(e) == false) {\n+        if (TransportActions.isShardNotAvailableException(e) == false && (requestCancelled.get() && isTaskCancelledException(e)) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd7c4dca8a638ddcd888e9e2f470ba9516119052"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd53c74a057a1bcddfe7d7429643607f993312cf", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd53c74a057a1bcddfe7d7429643607f993312cf", "committedDate": "2020-10-27T22:39:14Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05dce74e811f2581633021465a5b0185496364c4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/05dce74e811f2581633021465a5b0185496364c4", "committedDate": "2020-10-27T22:39:18Z", "message": "Merge branch 'master' into ignore-cancel-error"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1020, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}