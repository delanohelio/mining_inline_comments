{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2ODMzNjg5", "number": 54558, "title": "Move Snapshot Status Related Method to Appropriate Places", "bodyText": "Lots of thnigs living in SnapshotsService for no reason other than\nthat SnapshotsService provides the RepositoriesService.\nCleaning this up to directly use RepositoriesService in the relevant\ntransport actions and by that shortening the already very complex SnapshotsService.\nThere's definitely additional simplifications possible here, but for now I limited myself to just moving things around as they are to keep the review simple (only exceptions being merging the two repositoryInUseMethods into one and adding the new constructor to SnapshotInfo).", "createdAt": "2020-04-01T08:19:23Z", "url": "https://github.com/elastic/elasticsearch/pull/54558", "merged": true, "mergeCommit": {"oid": "82ce17764cc4e61e2728476bb56aca340f73ffd6"}, "closed": true, "closedAt": "2020-04-01T15:59:58Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTTPDggH2gAyMzk2ODMzNjg5Ojc3NmNhYTEzNDhjNWRjYTdkMjZiZDY2Y2MwMTE2NjM3YTA1NDc4YTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTZQuIAH2gAyMzk2ODMzNjg5OjI0ZGZkZDFkOWUxMDZmYWFlODEwNjI1M2NjYjEwYTlmMDkxZmU3MTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "776caa1348c5dca7d26bd66cc0116637a05478a8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/776caa1348c5dca7d26bd66cc0116637a05478a8", "committedDate": "2020-04-01T08:15:17Z", "message": "Move Snapshot Status Related Method to Appropriate Places\n\nLots of thnigs living in `SnapshotsService` for no reason other than\nthat `SnapshotsService` provides the `RepositoriesService`.\nCleaning this up to directly use `RepositoriesService` in the relevant\ntransport actions and by that shortening the already very complex `SnapshotsService`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1NjE1MjE0", "url": "https://github.com/elastic/elasticsearch/pull/54558#pullrequestreview-385615214", "createdAt": "2020-04-01T14:01:28Z", "commit": {"oid": "776caa1348c5dca7d26bd66cc0116637a05478a8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNDowMToyOFrOF_CF9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxNDowNzoyMFrOF_CWjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTYzODkwMQ==", "bodyText": "perhaps call this sortedCurrentSnapshots", "url": "https://github.com/elastic/elasticsearch/pull/54558#discussion_r401638901", "createdAt": "2020-04-01T14:01:28Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java", "diffHunk": "@@ -155,14 +166,33 @@ private void getSingleRepoSnapshotInfo(@Nullable SnapshotsInProgress snapshotsIn\n         if (isCurrentSnapshotsOnly(snapshots)) {\n             repositoryDataListener.onResponse(null);\n         } else {\n-            snapshotsService.getRepositoryData(repo, repositoryDataListener);\n+            repositoriesService.getRepositoryData(repo, repositoryDataListener);\n         }\n \n         repositoryDataListener.whenComplete(repositoryData -> listener.onResponse(loadSnapshotInfos(snapshotsInProgress, repo, snapshots,\n             ignoreUnavailable, verbose, allSnapshotIds, currentSnapshots, repositoryData)),\n             listener::onFailure);\n     }\n \n+    /**\n+     * Returns a list of currently running snapshots from repository sorted by snapshot creation date\n+     *\n+     * @param snapshotsInProgress snapshots in progress in the cluster state\n+     * @param repositoryName repository name\n+     * @return list of snapshots\n+     */\n+    private static List<SnapshotInfo> currentSnapshots(@Nullable SnapshotsInProgress snapshotsInProgress, String repositoryName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "776caa1348c5dca7d26bd66cc0116637a05478a8"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTY0MzE1MA==", "bodyText": "Couldn't the repository have been removed after we checked the repo exists? I think we should throw a RepositoryMissingException here instead of NullPointerException", "url": "https://github.com/elastic/elasticsearch/pull/54558#discussion_r401643150", "createdAt": "2020-04-01T14:07:20Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoriesService.java", "diffHunk": "@@ -357,6 +359,22 @@ public void applyClusterState(ClusterChangedEvent event) {\n         }\n     }\n \n+    /**\n+     * Gets the {@link RepositoryData} for the given repository.\n+     *\n+     * @param repositoryName repository name\n+     * @param listener       listener to pass {@link RepositoryData} to\n+     */\n+    public void getRepositoryData(final String repositoryName, final ActionListener<RepositoryData> listener) {\n+        try {\n+            Repository repository = repository(repositoryName);\n+            assert repository != null; // should only be called once we've validated the repository exists", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "776caa1348c5dca7d26bd66cc0116637a05478a8"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc5e10cec5e749828805c16660d222800f49aa7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8cc5e10cec5e749828805c16660d222800f49aa7", "committedDate": "2020-04-01T14:19:08Z", "message": "Merge remote-tracking branch 'elastic/master' into refactor-snapshot-status-methods"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a68fbc18094b053085e8130ca3f83bcacb1145a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a68fbc18094b053085e8130ca3f83bcacb1145a", "committedDate": "2020-04-01T15:00:05Z", "message": "CR: renaming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24dfdd1d9e106faae8106253ccb10a9f091fe719", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/24dfdd1d9e106faae8106253ccb10a9f091fe719", "committedDate": "2020-04-01T15:16:32Z", "message": "Merge remote-tracking branch 'elastic/master' into refactor-snapshot-status-methods"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1428, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}