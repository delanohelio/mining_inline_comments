{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4ODA4MDY3", "number": 55758, "title": "Async Search: correct shards counting", "bodyText": "Async search allows users to retrieve partial results for a running search. For partial results, the number of successful shards does not include the skipped shards, while the response returned to users should.\nAlso, we recently had a bug where async search would miss tracking shard failures, which would have been caught if we had assertions in place that verified that whenever we get the last response, the number of failures included in it is the same as the failures that were tracked through the listener notifications.", "createdAt": "2020-04-24T23:32:38Z", "url": "https://github.com/elastic/elasticsearch/pull/55758", "merged": true, "mergeCommit": {"oid": "9ffd006ca022e02f462e5edac2b5768172f6eb2c"}, "closed": true, "closedAt": "2020-05-06T10:05:11Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABca6GvPAH2gAyNDA4ODA4MDY3OjAzMTE1YWE5NTQ3ZWQ1MTlmN2MxOTkxOTI3YWFhNWVjNWJiNjViYjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcejlmAgH2gAyNDA4ODA4MDY3OjM3MmUwZWRhODRmOGEwOGQxY2Q0Y2Y2NmQ4ZjQ1NDFkZmQ1ZjhhNWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/03115aa9547ed519f7c1991927aaa5ec5bb65bb8", "committedDate": "2020-04-24T23:29:58Z", "message": "Async Search: correct shards counting\n\nAsync search allows users to retrieve partial results for a running search. For partial results, the number of successful shards does not include the skipped shards, while the response returned to users should.\n\nWhen a fatal failure happened after some partial results were processed, for instance because all of the shards failed to fetch their hits, the number of successful shards should be reset to align it with what ordinary search would return.\n\nAlso, we recently had a bug where async search would miss tracking shard failures, which would have been caught if we had assertions in place that verified that whenever we get the last response, the number of failures included in it is the same as the failures that were tracked through the listener notifications."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNjY3NjAz", "url": "https://github.com/elastic/elasticsearch/pull/55758#pullrequestreview-401667603", "createdAt": "2020-04-28T09:40:03Z", "commit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOTo0MDowM1rOGNLnLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwOTo0MDowM1rOGNLnLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw==", "bodyText": "I believe this makes what gets returned more consistent with what _search does, though we lose information on how many shards the partial results come from. We possibly need to expand the info that we return if we want to better represent this scenario where there are partial results yet the whole search has failed hence stopped.", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416474927", "createdAt": "2020-04-28T09:40:03Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java", "diffHunk": "@@ -120,6 +129,10 @@ synchronized void updateWithFailure(Exception exc) {\n         failIfFrozen();\n         // copy the response headers from the current context\n         this.responseHeaders = threadContext.getResponseHeaders();\n+        //We may have already received some partial results, in which case the number of successful shards reflects that despite the search\n+        //has failed entirely at a later stage. We should consider all shards as failed given that none of them was able to e.g. fetch\n+        //skipped shards are considered successful though\n+        this.successfulShards = this.skippedShards;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxNzgxMjIx", "url": "https://github.com/elastic/elasticsearch/pull/55758#pullrequestreview-401781221", "createdAt": "2020-04-28T12:25:16Z", "commit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjoyNToxNlrOGNRYOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxMjoyODo0M1rOGNRhSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU2OTQwMQ==", "bodyText": "+1, #55683 has the same change", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416569401", "createdAt": "2020-04-28T12:25:16Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -387,7 +387,7 @@ public void onFinalReduce(List<SearchShard> shards, TotalHits totalHits, Interna\n \n         @Override\n         public void onResponse(SearchResponse response) {\n-            searchResponse.get().updateFinalResponse(response.getSuccessfulShards(), response.getInternalResponse());\n+            searchResponse.get().updateFinalResponse(response);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjU3MTcyMQ==", "bodyText": "Why do we need to update these informations ? They are not used anymore when the response is final. I think #55683 has the more straightforward approach of keeping the final response as is.", "url": "https://github.com/elastic/elasticsearch/pull/55758#discussion_r416571721", "createdAt": "2020-04-28T12:28:43Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/MutableSearchResponse.java", "diffHunk": "@@ -120,6 +129,10 @@ synchronized void updateWithFailure(Exception exc) {\n         failIfFrozen();\n         // copy the response headers from the current context\n         this.responseHeaders = threadContext.getResponseHeaders();\n+        //We may have already received some partial results, in which case the number of successful shards reflects that despite the search\n+        //has failed entirely at a later stage. We should consider all shards as failed given that none of them was able to e.g. fetch\n+        //skipped shards are considered successful though\n+        this.successfulShards = this.skippedShards;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQ3NDkyNw=="}, "originalCommit": {"oid": "03115aa9547ed519f7c1991927aaa5ec5bb65bb8"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3db15c389760b4f57e8620fcbbb675f5f6cd25e", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3db15c389760b4f57e8620fcbbb675f5f6cd25e", "committedDate": "2020-04-30T15:43:44Z", "message": "Merge branch 'master' into enhancement/async_search_shards_assert"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NzI5MTA3", "url": "https://github.com/elastic/elasticsearch/pull/55758#pullrequestreview-404729107", "createdAt": "2020-05-04T06:21:19Z", "commit": {"oid": "b3db15c389760b4f57e8620fcbbb675f5f6cd25e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f377669973687ffebadde53d25661e68f91502f9", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/f377669973687ffebadde53d25661e68f91502f9", "committedDate": "2020-05-06T06:49:44Z", "message": "Merge branch 'master' into enhancement/async_search_shards_assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372e0eda84f8a08d1cd4cf66d8f4541dfd5f8a5f", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/372e0eda84f8a08d1cd4cf66d8f4541dfd5f8a5f", "committedDate": "2020-05-06T07:31:33Z", "message": "iter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 368, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}