{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDkxOTM0", "number": 54523, "title": "Unassign DFA tasks in SetUpgradeModeAction", "bodyText": "This PR unassigns Data Frame Analytics tasks from the node (the same way as Job and Datafeed tasks) when enabling ML upgrade mode.\nRelates #54326", "createdAt": "2020-03-31T17:45:36Z", "url": "https://github.com/elastic/elasticsearch/pull/54523", "merged": true, "mergeCommit": {"oid": "7375d858ca8b18f8a2156052f97e681102c16086"}, "closed": true, "closedAt": "2020-04-14T08:01:28Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTSIFhABqjMxODY0NzIyMTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXdbASgBqjMyMjk2NDY3Njc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "55ccb4b1c351868e2145bd5aaedef76dc63e44b2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/55ccb4b1c351868e2145bd5aaedef76dc63e44b2", "committedDate": "2020-03-31T17:41:10Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}, "afterCommit": {"oid": "2a44e322dc64a167111cedfd35b1d57931c0616d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a44e322dc64a167111cedfd35b1d57931c0616d", "committedDate": "2020-04-01T06:57:31Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2a44e322dc64a167111cedfd35b1d57931c0616d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a44e322dc64a167111cedfd35b1d57931c0616d", "committedDate": "2020-04-01T06:57:31Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}, "afterCommit": {"oid": "ceba14701140d834356f1e1812ee52387cf4ff4d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ceba14701140d834356f1e1812ee52387cf4ff4d", "committedDate": "2020-04-01T10:45:36Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ceba14701140d834356f1e1812ee52387cf4ff4d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ceba14701140d834356f1e1812ee52387cf4ff4d", "committedDate": "2020-04-01T10:45:36Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}, "afterCommit": {"oid": "97414ca39c57a5359bad703f9bf31e2a67e56794", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/97414ca39c57a5359bad703f9bf31e2a67e56794", "committedDate": "2020-04-01T11:23:51Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "97414ca39c57a5359bad703f9bf31e2a67e56794", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/97414ca39c57a5359bad703f9bf31e2a67e56794", "committedDate": "2020-04-01T11:23:51Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}, "afterCommit": {"oid": "b7f6ab8ace2e8dee107dae8cb981785b0a476ec5", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7f6ab8ace2e8dee107dae8cb981785b0a476ec5", "committedDate": "2020-04-02T06:01:54Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f197a2056fe0a6b6dadae4d95f2f27d64a934bed", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f197a2056fe0a6b6dadae4d95f2f27d64a934bed", "committedDate": "2020-04-02T09:29:34Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}, "afterCommit": {"oid": "c020995013e13c87f1267811d61d1bdcaae49f68", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c020995013e13c87f1267811d61d1bdcaae49f68", "committedDate": "2020-04-06T12:48:01Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c020995013e13c87f1267811d61d1bdcaae49f68", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c020995013e13c87f1267811d61d1bdcaae49f68", "committedDate": "2020-04-06T12:48:01Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}, "afterCommit": {"oid": "a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "committedDate": "2020-04-10T07:26:59Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a05cff2871f8e6d1d47ddd96c0d597744f70b4dc", "committedDate": "2020-04-10T07:26:59Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}, "afterCommit": {"oid": "81362ee57b0d20e71927190864905fa3ac7d31b7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/81362ee57b0d20e71927190864905fa3ac7d31b7", "committedDate": "2020-04-10T11:42:21Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "81362ee57b0d20e71927190864905fa3ac7d31b7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/81362ee57b0d20e71927190864905fa3ac7d31b7", "committedDate": "2020-04-10T11:42:21Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}, "afterCommit": {"oid": "34ddd74609981e493eee4463f49522757b97bef8", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/34ddd74609981e493eee4463f49522757b97bef8", "committedDate": "2020-04-10T11:45:22Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e96a07d40899eec7b6e48109999f4c31dc131243", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e96a07d40899eec7b6e48109999f4c31dc131243", "committedDate": "2020-04-10T12:00:44Z", "message": "Enable upgrade mode *after* putting a job in order to fix the test"}, "afterCommit": {"oid": "e5d67cde5225930125b3aec339a8f49c595af3e5", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5d67cde5225930125b3aec339a8f49c595af3e5", "committedDate": "2020-04-10T12:17:45Z", "message": "Enable upgrade mode *after* putting a job in order to fix the test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e5d67cde5225930125b3aec339a8f49c595af3e5", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5d67cde5225930125b3aec339a8f49c595af3e5", "committedDate": "2020-04-10T12:17:45Z", "message": "Enable upgrade mode *after* putting a job in order to fix the test"}, "afterCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2", "committedDate": "2020-04-10T13:12:31Z", "message": "Enable upgrade mode *after* putting a job in order to fix the test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDM0OTEw", "url": "https://github.com/elastic/elasticsearch/pull/54523#pullrequestreview-391434910", "createdAt": "2020-04-10T13:13:28Z", "commit": {"oid": "e5d67cde5225930125b3aec339a8f49c595af3e5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoxMzo0NVrOGD6JKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoxMzo0NVrOGD6JKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ==", "bodyText": "Isn't this assertion risky? Could it not be the task has advanced state by this point?", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406751531", "createdAt": "2020-04-10T13:13:45Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDQ4OTE4", "url": "https://github.com/elastic/elasticsearch/pull/54523#pullrequestreview-391448918", "createdAt": "2020-04-10T13:44:11Z", "commit": {"oid": "9158f23d693f59b783c03939b073a7b5a5fd8a3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzo0NDoxMVrOGD63mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzo0NDoxMVrOGD63mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2MzQxNw==", "bodyText": "I'd say we don't need this assertion at all.", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406763417", "createdAt": "2020-04-10T13:44:11Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,68 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9158f23d693f59b783c03939b073a7b5a5fd8a3b"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNDcyNjQ5", "url": "https://github.com/elastic/elasticsearch/pull/54523#pullrequestreview-391472649", "createdAt": "2020-04-10T14:30:28Z", "commit": {"oid": "4b81f84b063e7787a100363d8211cae9bf8564e3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01070e0db802764aee7fca3fd91cfd51401dfe46", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/01070e0db802764aee7fca3fd91cfd51401dfe46", "committedDate": "2020-04-14T06:22:51Z", "message": "Unassign DFA tasks in SetUpgradeModeAction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7a0e802f12f0d5c20bb8e30aa1fecad952593ad", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7a0e802f12f0d5c20bb8e30aa1fecad952593ad", "committedDate": "2020-04-14T06:22:52Z", "message": "Wait for the job to be at least REINDEXING before attempting setting upgrade mode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6bed636efa003f5feab272c3b1c6dd8d09419f09", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/6bed636efa003f5feab272c3b1c6dd8d09419f09", "committedDate": "2020-04-14T06:22:52Z", "message": "Revert \"Wait for the job to be at least REINDEXING before attempting setting upgrade mode\"\n\nThis reverts commit ee9245e3e93794cfc576580d7696bf7cb48b7cc1."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2467797a8bdcd5764b976a160cc0e6ee5d014a01", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2467797a8bdcd5764b976a160cc0e6ee5d014a01", "committedDate": "2020-04-14T06:22:52Z", "message": "Enable upgrade mode *after* putting a job in order to fix the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8714baaa2e72948e60816ec3a55aabaf89ca1e0c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8714baaa2e72948e60816ec3a55aabaf89ca1e0c", "committedDate": "2020-04-14T06:22:52Z", "message": "Apply review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f3e39452c51d662562ae4a80033b05b9f3d767b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f3e39452c51d662562ae4a80033b05b9f3d767b", "committedDate": "2020-04-14T06:22:52Z", "message": "Apply review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a2bf578dc3dca737299986f7c2254b746c7f1b0", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a2bf578dc3dca737299986f7c2254b746c7f1b0", "committedDate": "2020-04-14T06:22:52Z", "message": "Remove unnecessary assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4c281b3fe916ee06769b564ac2d40cde352f775", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4c281b3fe916ee06769b564ac2d40cde352f775", "committedDate": "2020-04-14T06:22:52Z", "message": "Remove solved TODOs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b506bfc88b2f18dcf1535e7230c706002f476fda", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b506bfc88b2f18dcf1535e7230c706002f476fda", "committedDate": "2020-04-10T14:34:08Z", "message": "Remove solved TODOs"}, "afterCommit": {"oid": "f4c281b3fe916ee06769b564ac2d40cde352f775", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4c281b3fe916ee06769b564ac2d40cde352f775", "committedDate": "2020-04-14T06:22:52Z", "message": "Remove solved TODOs"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1408, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}