{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1NzQwNjU0", "number": 55435, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzoyNDoxOFrODzlXtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzo0MzoxNVrODzu93Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDE2MjQ1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportSubmitAsyncSearchAction.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzoyNDoxOFrOGIGvIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjo1OToyOFrOGITNmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1MjE2MA==", "bodyText": "not related to your change, but I think this one should be changed like I did in other places to use ExceptionHelper.unwrapCause , I forgot about this one. When can version conflict be thrown again?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411152160", "createdAt": "2020-04-20T07:24:18Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportSubmitAsyncSearchAction.java", "diffHunk": "@@ -187,7 +188,8 @@ private void onFinalResponse(CancellableTask submitTask,\n             store.storeFinalResponse(searchTask.getSearchId().getDocId(), threadContext.getResponseHeaders(),response,\n                 ActionListener.wrap(resp -> unregisterTaskAndMoveOn(searchTask, nextAction),\n                                     exc -> {\n-                                        if (exc.getCause() instanceof DocumentMissingException == false) {\n+                                        if (exc.getCause() instanceof DocumentMissingException == false &&\n+                                                exc.getCause() instanceof VersionConflictEngineException == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NjU3MA==", "bodyText": "++, I pushed bf01fc0", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411356570", "createdAt": "2020-04-20T12:59:28Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportSubmitAsyncSearchAction.java", "diffHunk": "@@ -187,7 +188,8 @@ private void onFinalResponse(CancellableTask submitTask,\n             store.storeFinalResponse(searchTask.getSearchId().getDocId(), threadContext.getResponseHeaders(),response,\n                 ActionListener.wrap(resp -> unregisterTaskAndMoveOn(searchTask, nextAction),\n                                     exc -> {\n-                                        if (exc.getCause() instanceof DocumentMissingException == false) {\n+                                        if (exc.getCause() instanceof DocumentMissingException == false &&\n+                                                exc.getCause() instanceof VersionConflictEngineException == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1MjE2MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDE2Njc2OnYy", "diffSide": "LEFT", "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/GetAsyncSearchRequestTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzoyNToyNlrOGIGxiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjo1OTozM1rOGITNxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1Mjc3Nw==", "bodyText": "ops", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411152777", "createdAt": "2020-04-20T07:25:26Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/GetAsyncSearchRequestTests.java", "diffHunk": "@@ -34,8 +34,4 @@ static String randomSearchId() {\n         return AsyncSearchId.encode(UUIDs.randomBase64UUID(),\n             new TaskId(randomAlphaOfLengthBetween(10, 20), randomLongBetween(0, Long.MAX_VALUE)));\n     }\n-\n-    public void testValidateWaitForCompletion() {\n-\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NjYxMw==", "bodyText": ";)", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411356613", "createdAt": "2020-04-20T12:59:33Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/GetAsyncSearchRequestTests.java", "diffHunk": "@@ -34,8 +34,4 @@ static String randomSearchId() {\n         return AsyncSearchId.encode(UUIDs.randomBase64UUID(),\n             new TaskId(randomAlphaOfLengthBetween(10, 20), randomLongBetween(0, Long.MAX_VALUE)));\n     }\n-\n-    public void testValidateWaitForCompletion() {\n-\n-    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1Mjc3Nw=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDE5OTUyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozNDoxMFrOGIHEpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMToxNzo0MFrOGIoFIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA==", "bodyText": "do we plan on using this new setting only in our tests? Or can it be useful for users too?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411157670", "createdAt": "2020-04-20T07:34:10Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NzQwNw==", "bodyText": "Maybe for debug but I don't think it's useful for users, only for tests at the moment.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411357407", "createdAt": "2020-04-20T13:00:46Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1OTM5MA==", "bodyText": "There is no way to somehow make this \"private\" or for use only in our tests? I worry mostly about naming, and the fact that users may end up using it although we would not want them to.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411359390", "createdAt": "2020-04-20T13:03:43Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM2ODQ0OQ==", "bodyText": "The default value is quite large (1h) so maybe there's some value to change it. I am not sure, I can make it private but that would work only in fantasy integration tests (single vm) so this will come back. I was expecting that the lack of documentation would make this setting an expert thing that users would never heard from ?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411368449", "createdAt": "2020-04-20T13:17:03Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM3NDUwMw==", "bodyText": "yea I see, can you add a comment that this is intentionally undocumented?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411374503", "createdAt": "2020-04-20T13:25:26Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY5ODQ2NQ==", "bodyText": "I pushed 09afaca", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411698465", "createdAt": "2020-04-20T21:17:40Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -26,13 +28,17 @@\n import java.util.concurrent.atomic.AtomicBoolean;\n \n import static org.elasticsearch.xpack.search.AsyncSearchIndexService.EXPIRATION_TIME_FIELD;\n+import static org.elasticsearch.xpack.search.AsyncSearchIndexService.INDEX;\n \n /**\n  * A service that runs a periodic cleanup over the async-search index.\n  */\n class AsyncSearchMaintenanceService implements Releasable, ClusterStateListener {\n     private static final Logger logger = LogManager.getLogger(AsyncSearchMaintenanceService.class);\n \n+    public static final Setting<TimeValue> ASYNC_SEARCH_CLEANUP_INTERVAL_SETTING =\n+        Setting.timeSetting(\"async_search.index_cleanup_interval\", TimeValue.timeValueHours(1), Setting.Property.NodeScope);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1NzY3MA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDIwOTgyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozNjo1MlrOGIHKng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzowMToxMVrOGITSAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTE5OA==", "bodyText": "I think that isCleanupRunning no longer needs to be atomic boolean given that it's only accessed from synchronized methods", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411159198", "createdAt": "2020-04-20T07:36:52Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -62,31 +68,29 @@ public void clusterChanged(ClusterChangedEvent event) {\n         tryStartCleanup(state);\n     }\n \n-    void tryStartCleanup(ClusterState state) {\n+    synchronized void tryStartCleanup(ClusterState state) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1NzY5OA==", "bodyText": "++, I pushed 47f3544", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411357698", "createdAt": "2020-04-20T13:01:11Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -62,31 +68,29 @@ public void clusterChanged(ClusterChangedEvent event) {\n         tryStartCleanup(state);\n     }\n \n-    void tryStartCleanup(ClusterState state) {\n+    synchronized void tryStartCleanup(ClusterState state) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTE5OA=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDIxNDU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozODoxM1rOGIHNhw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwODoxOTo1NlrOGIIvQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTk0Mw==", "bodyText": "I am curious about these changesL: the newly added tests uncovered some bug?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411159943", "createdAt": "2020-04-20T07:38:13Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -107,11 +111,17 @@ synchronized void scheduleNextCleanup() {\n         }\n     }\n \n+    synchronized void stop() {\n+        if (isCleanupRunning.compareAndSet(true, false)) {\n+            if (cancellable != null && cancellable.isCancelled() == false) {\n+                cancellable.cancel();\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE4NDk2MQ==", "bodyText": "Yes, if the index is deleted we close the service. I added a test for this AsyncSearchActionIT#testRemoveAsyncIndex. I can add a note in the commit/pr or open a separate pr if you prefer.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411184961", "createdAt": "2020-04-20T08:19:56Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchMaintenanceService.java", "diffHunk": "@@ -107,11 +111,17 @@ synchronized void scheduleNextCleanup() {\n         }\n     }\n \n+    synchronized void stop() {\n+        if (isCleanupRunning.compareAndSet(true, false)) {\n+            if (cancellable != null && cancellable.isCancelled() == false) {\n+                cancellable.cancel();\n+            }\n+        }\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTk0Mw=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDIxOTU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchIndexService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozOToxN1rOGIHQNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwOTozODozN1rOGIL7XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MDYyOQ==", "bodyText": "this seems at first glance unrelated, did it come up from the tests you added as part of this PR?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411160629", "createdAt": "2020-04-20T07:39:17Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchIndexService.java", "diffHunk": "@@ -265,14 +265,17 @@ void getResponse(AsyncSearchId searchId,\n                     return;\n                 }\n \n-                if (restoreResponseHeaders) {\n+                if (restoreResponseHeaders && get.getSource().containsKey(RESPONSE_HEADERS_FIELD)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTIzNzIxMg==", "bodyText": "Yes, this fixes an NPE when retrieving the initial result (if the coordinating node died during the request). We discussed some options here,  whether we should throw a resource not found  or not but this change is just an hot-fix", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411237212", "createdAt": "2020-04-20T09:38:37Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchIndexService.java", "diffHunk": "@@ -265,14 +265,17 @@ void getResponse(AsyncSearchId searchId,\n                     return;\n                 }\n \n-                if (restoreResponseHeaders) {\n+                if (restoreResponseHeaders && get.getSource().containsKey(RESPONSE_HEADERS_FIELD)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MDYyOQ=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDIzMTQ0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzo0MjozNlrOGIHXXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzowMTo0NFrOGITTSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MjQ2MQ==", "bodyText": "this one was causing NPE? lovely to get NPE as part of a null check :) maybe getNodeId should be changed to return null instead of NPE when nodeId is null? it seems like a trappy behaviour.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411162461", "createdAt": "2020-04-20T07:42:36Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -338,7 +341,7 @@ protected void onQueryFailure(int shardIndex, SearchShardTarget shardTarget, Exc\n             // best effort to cancel expired tasks\n             checkCancellation();\n             searchResponse.get().addShardFailure(shardIndex,\n-                new ShardSearchFailure(exc, shardTarget.getNodeId() != null ? shardTarget : null));\n+                new ShardSearchFailure(exc, shardTarget.getNodeIdText() != null ? shardTarget : null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1ODAyNA==", "bodyText": "+1, I pushed 47f3544 to adapt the code in the shard search target class directly.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411358024", "createdAt": "2020-04-20T13:01:44Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -338,7 +341,7 @@ protected void onQueryFailure(int shardIndex, SearchShardTarget shardTarget, Exc\n             // best effort to cancel expired tasks\n             checkCancellation();\n             searchResponse.get().addShardFailure(shardIndex,\n-                new ShardSearchFailure(exc, shardTarget.getNodeId() != null ? shardTarget : null));\n+                new ShardSearchFailure(exc, shardTarget.getNodeIdText() != null ? shardTarget : null));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2MjQ2MQ=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDI0Njg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/AsyncSearchResponse.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzo0NjoyNlrOGIHgDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzowMTo1MVrOGITTmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2NDY4Ng==", "bodyText": "I wonder if we could add a constructor that takes this, it seems possible given that we call decode in one place only and it could accept the expiration time too, and pass it to the constructor.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411164686", "createdAt": "2020-04-20T07:46:26Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/AsyncSearchResponse.java", "diffHunk": "@@ -157,6 +157,10 @@ public long getExpirationTime() {\n         return expirationTimeMillis;\n     }\n \n+    public void setExpirationTime(long expirationTimeMillis) {\n+        this.expirationTimeMillis = expirationTimeMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1ODEwNQ==", "bodyText": "+1, I pushed 47f3544", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411358105", "createdAt": "2020-04-20T13:01:51Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/AsyncSearchResponse.java", "diffHunk": "@@ -157,6 +157,10 @@ public long getExpirationTime() {\n         return expirationTimeMillis;\n     }\n \n+    public void setExpirationTime(long expirationTimeMillis) {\n+        this.expirationTimeMillis = expirationTimeMillis;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2NDY4Ng=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NDI0ODU2OnYy", "diffSide": "LEFT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/GetAsyncSearchAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzo0Njo0OVrOGIHhAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzoxMDo0OFrOGITqnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2NDkyOQ==", "bodyText": "I am curious, what triggered this change?", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411164929", "createdAt": "2020-04-20T07:46:49Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/GetAsyncSearchAction.java", "diffHunk": "@@ -63,12 +60,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         @Override\n         public ActionRequestValidationException validate() {\n-            ActionRequestValidationException validationException = null;\n-            if (keepAlive.getMillis() != -1 && keepAlive.getMillis() < MIN_KEEP_ALIVE) {\n-                validationException =\n-                    addValidationError(\"keep_alive must be greater than 1 minute, got:\" + keepAlive.toString(), validationException);\n-            }\n-            return validationException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM1ODYxMg==", "bodyText": "The fact that we use very small value of keep_alive in tests to check the automatic cancellation.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411358612", "createdAt": "2020-04-20T13:02:36Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/GetAsyncSearchAction.java", "diffHunk": "@@ -63,12 +60,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         @Override\n         public ActionRequestValidationException validate() {\n-            ActionRequestValidationException validationException = null;\n-            if (keepAlive.getMillis() != -1 && keepAlive.getMillis() < MIN_KEEP_ALIVE) {\n-                validationException =\n-                    addValidationError(\"keep_alive must be greater than 1 minute, got:\" + keepAlive.toString(), validationException);\n-            }\n-            return validationException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2NDkyOQ=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM2Mzk5Nw==", "bodyText": "I see, while less than one minute does not make sense for submit, it does for get, probably.", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411363997", "createdAt": "2020-04-20T13:10:48Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/GetAsyncSearchAction.java", "diffHunk": "@@ -63,12 +60,7 @@ public void writeTo(StreamOutput out) throws IOException {\n \n         @Override\n         public ActionRequestValidationException validate() {\n-            ActionRequestValidationException validationException = null;\n-            if (keepAlive.getMillis() != -1 && keepAlive.getMillis() < MIN_KEEP_ALIVE) {\n-                validationException =\n-                    addValidationError(\"keep_alive must be greater than 1 minute, got:\" + keepAlive.toString(), validationException);\n-            }\n-            return validationException;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE2NDkyOQ=="}, "originalCommit": {"oid": "df22f66314d0b1aff801dca6a4d3157aea41cd4f"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU1NTczNDY5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchActionIT.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMzo0MzoxNVrOGIVHHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQwNzoxODoxMlrOGI2Z3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4NzY3Ng==", "bodyText": "perhaps you can now remove this TODO? 146b2a8#diff-97b9cc86781ba2021cd3ae58d6851834R38", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411387676", "createdAt": "2020-04-20T13:43:15Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchActionIT.java", "diffHunk": "@@ -277,4 +279,117 @@ public void testCancellation() throws Exception {\n         deleteAsyncSearch(response.getId());\n         ensureTaskRemoval(response.getId());\n     }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bf01fc0a6640c82ddcc04af379313e4b950cef38"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY5ODg1MQ==", "bodyText": "That's already removed in this change:\nhttps://github.com/elastic/elasticsearch/pull/55435/files#diff-dcd3d2ba4a8ca88c8655de7eb18981e6L38", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411698851", "createdAt": "2020-04-20T21:18:19Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchActionIT.java", "diffHunk": "@@ -277,4 +279,117 @@ public void testCancellation() throws Exception {\n         deleteAsyncSearch(response.getId());\n         ensureTaskRemoval(response.getId());\n     }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4NzY3Ng=="}, "originalCommit": {"oid": "bf01fc0a6640c82ddcc04af379313e4b950cef38"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTkzMzE1MQ==", "bodyText": "great I did not notice", "url": "https://github.com/elastic/elasticsearch/pull/55435#discussion_r411933151", "createdAt": "2020-04-21T07:18:12Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchActionIT.java", "diffHunk": "@@ -277,4 +279,117 @@ public void testCancellation() throws Exception {\n         deleteAsyncSearch(response.getId());\n         ensureTaskRemoval(response.getId());\n     }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM4NzY3Ng=="}, "originalCommit": {"oid": "bf01fc0a6640c82ddcc04af379313e4b950cef38"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2819, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}