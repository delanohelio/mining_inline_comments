{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2OTA2MTMw", "number": 52498, "title": "Scripting: split out compile limits and caching", "bodyText": "Phase 1 of adding compilation limits per context.\n\nRefactor rate limiting and caching into separate class,\nScriptCache,  which will be used per context.\nDisable compilation limit for certain tests.\n\nRefs: #50152", "createdAt": "2020-02-19T00:37:45Z", "url": "https://github.com/elastic/elasticsearch/pull/52498", "merged": true, "mergeCommit": {"oid": "0866031899a889afb6f296e89a4c1d277b496cfc"}, "closed": true, "closedAt": "2020-02-20T23:48:26Z", "author": {"login": "stu-elastic"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFrfCDgH2gAyMzc2OTA2MTMwOjUyNzFhZDQ0MDk1NzFlMTExMWQ0MzE1OTRhMGFkOTEyYzkyMjk2N2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGS_L0AH2gAyMzc2OTA2MTMwOjY4YzM2ODdkMTQ1YTFjMDEwYmI5NTdhMmIzYWUxYjhlYzNjN2I5N2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5271ad4409571e1111d431594a0ad912c922967d", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/5271ad4409571e1111d431594a0ad912c922967d", "committedDate": "2020-02-19T00:35:31Z", "message": "Scripting: split out compile limits and caching\n\nPhase 1 of adding compilation limits per context.\n* Refactor compilation and caching into separate class, ContextCompiler\n  which will be used per context.\n* Disable compilation limit for tests.\n* Add script.max_compilations_rate = \"unlimited\" setting which disables\n  compilation limits.\n\nRefs: #50152"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45eb308b6773ad7f9eec2a9d5685fb27f249bb8a", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/45eb308b6773ad7f9eec2a9d5685fb27f249bb8a", "committedDate": "2020-02-19T01:03:13Z", "message": "Use ROOT Locale for unlimited compilation setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "120f6a680fe3e52e00cf69941bd5f7c64ff12c10", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/120f6a680fe3e52e00cf69941bd5f7c64ff12c10", "committedDate": "2020-02-19T01:10:23Z", "message": "Use better str comp"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907912ea9845b9bafe5ec53192a33054468433ac", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/907912ea9845b9bafe5ec53192a33054468433ac", "committedDate": "2020-02-19T22:16:10Z", "message": "Revert unlimited for integTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa196ff4a82cf0ddc5a74f658316201e71d6d99b", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa196ff4a82cf0ddc5a74f658316201e71d6d99b", "committedDate": "2020-02-19T22:20:54Z", "message": "Revert per context defaults"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfc3f6e96914619ac79677c2b9eca53c4ca69dbd", "committedDate": "2020-02-19T22:55:44Z", "message": "No unlimited max compilation anymore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNTc0NjE5", "url": "https://github.com/elastic/elasticsearch/pull/52498#pullrequestreview-361574619", "createdAt": "2020-02-20T01:14:18Z", "commit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMToxNDoxOFrOFr9Wlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwMzo0MzozNlrOFsCRHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTYzODI5NQ==", "bodyText": "some basic javadocs please", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381638295", "createdAt": "2020-02-20T01:14:18Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ContextCompiler.java", "diffHunk": "@@ -0,0 +1,249 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.script;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.common.breaker.CircuitBreaker;\n+import org.elasticsearch.common.breaker.CircuitBreakingException;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.cache.RemovalListener;\n+import org.elasticsearch.common.cache.RemovalNotification;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.unit.TimeValue;\n+\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class ContextCompiler {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNTI5NQ==", "bodyText": "Can you please add a comment explaining this is overridden for the test infrastructure?", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381715295", "createdAt": "2020-02-20T03:36:29Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -213,29 +200,23 @@ public ScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<S\n             }\n         }\n \n-        int cacheMaxSize = SCRIPT_CACHE_SIZE_SETTING.get(settings);\n-\n-        CacheBuilder<CacheKey, Object> cacheBuilder = CacheBuilder.builder();\n-        if (cacheMaxSize >= 0) {\n-            cacheBuilder.setMaximumWeight(cacheMaxSize);\n-        }\n-\n-        TimeValue cacheExpire = SCRIPT_CACHE_EXPIRE_SETTING.get(settings);\n-        if (cacheExpire.getNanos() != 0) {\n-            cacheBuilder.setExpireAfterAccess(cacheExpire);\n-        }\n-\n-        logger.debug(\"using script cache with max_size [{}], expire [{}]\", cacheMaxSize, cacheExpire);\n-        this.cache = cacheBuilder.removalListener(new ScriptCacheRemovalListener()).build();\n-\n-        this.lastInlineCompileTime = System.nanoTime();\n         this.setMaxSizeInBytes(SCRIPT_MAX_SIZE_IN_BYTES.get(settings));\n-        this.setMaxCompilationRate(SCRIPT_MAX_COMPILATIONS_RATE.get(settings));\n+        compiler = new ContextCompiler(\n+                    SCRIPT_CACHE_SIZE_SETTING.get(settings),\n+                    SCRIPT_CACHE_EXPIRE_SETTING.get(settings),\n+                    compilationLimitsEnabled() ?\n+                        SCRIPT_MAX_COMPILATIONS_RATE.get(settings):\n+                        new Tuple<>(0, TimeValue.ZERO)\n+                    );\n+    }\n+\n+    boolean compilationLimitsEnabled() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxNjQwNQ==", "bodyText": "This seems like a series of unit tests on ContextCompiler, not a test of ScriptService.  Can we add a ContextCompilerTests, and move this test there?", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381716405", "createdAt": "2020-02-20T03:38:50Z", "author": {"login": "rjernst"}, "path": "server/src/test/java/org/elasticsearch/script/ScriptServiceTests.java", "diffHunk": "@@ -102,25 +101,25 @@ StoredScriptSource getScriptFromClusterState(String id) {\n     // simply by multiplying by five, so even setting it to one, requires five compilations to break\n     public void testCompilationCircuitBreaking() throws Exception {\n         buildScriptService(Settings.EMPTY);\n-        scriptService.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n-        scriptService.setMaxCompilationRate(Tuple.tuple(2, TimeValue.timeValueMinutes(1)));\n-        scriptService.checkCompilationLimit(); // should pass\n-        scriptService.checkCompilationLimit(); // should pass\n-        expectThrows(CircuitBreakingException.class, () -> scriptService.checkCompilationLimit());\n+        scriptService.compiler.setMaxCompilationRate(Tuple.tuple(1, TimeValue.timeValueMinutes(1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTcxODgxMg==", "bodyText": "We need to actually add this test plugin to the mock plugins. See ESIntegTestCase.getMockPlugins() and ESSingleNodeTestCase.newNode(). For now we can probably just always add it.", "url": "https://github.com/elastic/elasticsearch/pull/52498#discussion_r381718812", "createdAt": "2020-02-20T03:43:36Z", "author": {"login": "rjernst"}, "path": "test/framework/src/main/java/org/elasticsearch/node/MockNode.java", "diffHunk": "@@ -134,6 +138,14 @@ protected SearchService newSearchService(ClusterService clusterService, IndicesS\n             bigArrays, fetchPhase, circuitBreakerService);\n     }\n \n+    @Override\n+    protected ScriptService newScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<String, ScriptContext<?>> contexts) {\n+        if (getPluginsService().filterPlugins(MockScriptService.TestPlugin.class).isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMDM0NTQx", "url": "https://github.com/elastic/elasticsearch/pull/52498#pullrequestreview-362034541", "createdAt": "2020-02-20T16:12:08Z", "commit": {"oid": "bfc3f6e96914619ac79677c2b9eca53c4ca69dbd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8d16dfaf06f29dd666aa32d73b541d63569e6e9", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8d16dfaf06f29dd666aa32d73b541d63569e6e9", "committedDate": "2020-02-20T17:59:32Z", "message": "Javadoc for ContextCompiler and ScriptService.compilationLimitsEnabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a940b86d66907cc0601b99769969714478307e7e", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/a940b86d66907cc0601b99769969714478307e7e", "committedDate": "2020-02-20T18:59:47Z", "message": "ContextCompiler -> ScriptCache, move out ScriptServiceTests.testCompilationCircuitBreaking to ScriptCacheTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c27a51a00cf494583a25ccad79c86121b271e01", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c27a51a00cf494583a25ccad79c86121b271e01", "committedDate": "2020-02-20T20:38:46Z", "message": "Add MockScriptService.TestPlugin to ESIntegTestCase & ESSingleNodeTestCase to disable compilation limits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMjI1ODE2", "url": "https://github.com/elastic/elasticsearch/pull/52498#pullrequestreview-362225816", "createdAt": "2020-02-20T20:54:48Z", "commit": {"oid": "0c27a51a00cf494583a25ccad79c86121b271e01"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68c3687d145a1c010bb957a2b3ae1b8ec3c7b97b", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/68c3687d145a1c010bb957a2b3ae1b8ec3c7b97b", "committedDate": "2020-02-20T22:36:56Z", "message": "Merge from upstream"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2418, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}