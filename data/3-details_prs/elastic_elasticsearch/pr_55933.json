{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNzA1ODAy", "number": 55933, "title": "Histogram field type support for ValueCount and Avg aggregations", "bodyText": "Implements value_count and avg aggregations over Histogram fields as discussed in #53285\n\nvalue_count returns the sum of all counts array of the histograms\navg computes a weighted average of the values array of the histogram by multiplying each value with its associated element in the counts array", "createdAt": "2020-04-29T13:14:35Z", "url": "https://github.com/elastic/elasticsearch/pull/55933", "merged": true, "mergeCommit": {"oid": "caf6c5ac197415fabfa9737c561aeba66d57c2d6"}, "closed": true, "closedAt": "2020-05-04T07:24:36Z", "author": {"login": "csoulios"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccU-QmAH2gAyNDEwNzA1ODAyOmJiNzU1MzMwZjc2ZGU3NDNkZTA3YTk0ZTQ1N2U1ZjFmYTY5YWY5MWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccuY8_gH2gAyNDEwNzA1ODAyOjQ4NjhmNTM4MzU0MmZiYTlmMDY2MGVlNGZhNDU0YzVkMjhjODAwODk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bb755330f76de743de07a94e457e5f1fa69af91f", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb755330f76de743de07a94e457e5f1fa69af91f", "committedDate": "2020-04-29T09:22:04Z", "message": "Moved histogram agg tests to correct test package"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbdb7f837ed76449abdf14035a3924fc7fd785c3", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbdb7f837ed76449abdf14035a3924fc7fd785c3", "committedDate": "2020-04-29T10:04:46Z", "message": "Cleaned up histo sum agg test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/2671d5c2a3980193bf162338cb4d5c9c9400d66e", "committedDate": "2020-04-29T13:08:56Z", "message": "Added histogram backed average aggregation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyNzYxNTgw", "url": "https://github.com/elastic/elasticsearch/pull/55933#pullrequestreview-402761580", "createdAt": "2020-04-29T15:06:14Z", "commit": {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTowNjoxNFrOGODakQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNjowMDo0MlrOGOF5yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzM4OTIwMQ==", "bodyText": "@not-napoleon and I've been favoring changing the ctor so you can just to (MetricAggregatorSupplier) HistoBackedSumAggregator::new. It is less \"big\".", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417389201", "createdAt": "2020-04-29T15:06:14Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AnalyticsAggregatorFactory.java", "diffHunk": "@@ -65,6 +68,24 @@ public static void registerPercentileRanksAggregator(ValuesSourceRegistry.Builde\n     public static void registerHistoBackedSumAggregator(ValuesSourceRegistry.Builder builder) {\n         builder.register(SumAggregationBuilder.NAME,\n             AnalyticsValuesSourceType.HISTOGRAM,\n-            (MetricAggregatorSupplier) HistoBackedSumAggregator::new);\n+            (MetricAggregatorSupplier) (name, valuesSource, format, context, parent, metadata) ->\n+                new HistoBackedSumAggregator(name, (HistogramValuesSource.Histogram) valuesSource, format, context, parent, metadata)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyOTM1NA==", "bodyText": "You probably can merge master and remove this now.", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417429354", "createdAt": "2020-04-29T15:59:52Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedAvgAggregatorTests.java", "diffHunk": "@@ -0,0 +1,154 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import com.tdunning.math.stats.Centroid;\n+import com.tdunning.math.stats.TDigest;\n+import org.apache.lucene.document.BinaryDocValuesField;\n+import org.apache.lucene.document.Field;\n+import org.apache.lucene.document.StringField;\n+import org.apache.lucene.index.RandomIndexWriter;\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.MatchAllDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.common.CheckedConsumer;\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.plugins.SearchPlugin;\n+import org.elasticsearch.search.aggregations.AggregationBuilder;\n+import org.elasticsearch.search.aggregations.AggregatorTestCase;\n+import org.elasticsearch.search.aggregations.metrics.AvgAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.InternalAvg;\n+import org.elasticsearch.search.aggregations.metrics.TDigestState;\n+import org.elasticsearch.search.aggregations.support.AggregationInspectionHelper;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.xpack.analytics.AnalyticsPlugin;\n+import org.elasticsearch.xpack.analytics.aggregations.support.AnalyticsValuesSourceType;\n+import org.elasticsearch.xpack.analytics.mapper.HistogramFieldMapper;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.function.Consumer;\n+\n+import static java.util.Collections.singleton;\n+import static org.elasticsearch.search.aggregations.AggregationBuilders.avg;\n+\n+public class HistoBackedAvgAggregatorTests extends AggregatorTestCase {\n+\n+    private static final String FIELD_NAME = \"field\";\n+\n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyOTk2MQ==", "bodyText": "I think this is merged, right?", "url": "https://github.com/elastic/elasticsearch/pull/55933#discussion_r417429961", "createdAt": "2020-04-29T16:00:42Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/aggregations/metrics/HistoBackedSumAggregatorTests.java", "diffHunk": "@@ -49,6 +45,7 @@\n \n     private static final String FIELD_NAME = \"field\";\n \n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/55824\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2671d5c2a3980193bf162338cb4d5c9c9400d66e"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89e6d94884b7b3591ba203c5c27b709e2f4549ab", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/89e6d94884b7b3591ba203c5c27b709e2f4549ab", "committedDate": "2020-04-29T19:28:03Z", "message": "Merge branch 'master' into histo-value-count-avg"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/efeab0f14cdf3a02ed73e4c92c41f2e8577a67bc", "committedDate": "2020-04-29T19:42:04Z", "message": "Enabled testNoDocs() tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d18029e2854f8a326dcb26edf60220855e60226c", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/d18029e2854f8a326dcb26edf60220855e60226c", "committedDate": "2020-04-30T13:48:47Z", "message": "Added documentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4868f5383542fba9f0660ee4fa454c5d28c80089", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/4868f5383542fba9f0660ee4fa454c5d28c80089", "committedDate": "2020-04-30T14:58:51Z", "message": "Small doc changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 286, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}