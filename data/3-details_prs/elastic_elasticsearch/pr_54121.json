{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMjAxMTY2", "number": 54121, "title": "[ML] prefer secondary authorization header for data[feed|frame] authz", "bodyText": "Secondary authorization headers are to be used to facilitate Kibana spaces support + ML jobs/datafeeds.\nNow on PUT/Update/Preview datafeed, and PUT data frame analytics the secondary authorization is preferred over the primary (if provided).\ncloses #53801", "createdAt": "2020-03-24T19:00:58Z", "url": "https://github.com/elastic/elasticsearch/pull/54121", "merged": true, "mergeCommit": {"oid": "1d24960ff80c47208690a860fcf2f9a65ee9ed9e"}, "closed": true, "closedAt": "2020-04-02T14:10:47Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ3q7IAH2gAyMzkzMjAxMTY2OjMwY2ZiMTJiN2RjOTFjMTQ3NTY3ZTRjYTY2YjYzNWYwMTJkZjRhMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTsLL2gH2gAyMzkzMjAxMTY2OmI3YmU5NmQyNzdhZTM3MzNkNjFjODIyYjdjZWViYWM5OTNlOWRiZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "30cfb12b7dc91c147567e4ca66b635f012df4a01", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/30cfb12b7dc91c147567e4ca66b635f012df4a01", "committedDate": "2020-03-24T19:00:32Z", "message": "[ML] prefer secondary authorization header for data[feed|frame] authz"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjEyNTAy", "url": "https://github.com/elastic/elasticsearch/pull/54121#pullrequestreview-380612502", "createdAt": "2020-03-24T19:01:37Z", "commit": {"oid": "30cfb12b7dc91c147567e4ca66b635f012df4a01"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowMTozN1rOF6-6yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxOTowNTozOVrOF6_DrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5MjU4NQ==", "bodyText": "@tvernum I made this public so that it is accessible to the ML plugin", "url": "https://github.com/elastic/elasticsearch/pull/54121#discussion_r397392585", "createdAt": "2020-03-24T19:01:37Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/SecondaryAuthentication.java", "diffHunk": "@@ -24,7 +24,7 @@\n  */\n public class SecondaryAuthentication {\n \n-    private static final String THREAD_CTX_KEY = \"_xpack_security_secondary_authc\";\n+    public static final String THREAD_CTX_KEY = \"_xpack_security_secondary_authc\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30cfb12b7dc91c147567e4ca66b635f012df4a01"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5NDg2MQ==", "bodyText": "@tvernum We are storing _xpack_security_secondary_authc as the primary auth for some of our tasks. This way we \"prefer\" the secondary auth if it was provided.\nIs simply replacing _xpack_security_authentication with the contents of _xpack_security_secondary_authc acceptable? Or are there technical limitations/details that I am missing?", "url": "https://github.com/elastic/elasticsearch/pull/54121#discussion_r397394861", "createdAt": "2020-03-24T19:05:39Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/AuthHeadersExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils;\n+\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.security.authc.AuthenticationField;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public final class AuthHeadersExtractor {\n+\n+    private AuthHeadersExtractor() {}\n+\n+    public static Map<String, String> extractAuthHeadersAndPreferSecondaryAuth(ThreadContext context) {\n+        Map<String, String> threadHeaders = context.getHeaders();\n+        if (threadHeaders == null || threadHeaders.isEmpty()) {\n+            return new HashMap<>();\n+        }\n+\n+        Map<String, String> headers = threadHeaders.entrySet().stream()\n+            .filter(e -> ClientHelper.SECURITY_HEADER_FILTERS.contains(e.getKey()))\n+            .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+        String secondaryAuth = headers.get(SecondaryAuthentication.THREAD_CTX_KEY);\n+        if (secondaryAuth != null) {\n+            headers.put(AuthenticationField.AUTHENTICATION_KEY, secondaryAuth);\n+        }\n+        return headers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30cfb12b7dc91c147567e4ca66b635f012df4a01"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "740e6667956ca7e3e0fbb89ba82e71b692675dbe", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/740e6667956ca7e3e0fbb89ba82e71b692675dbe", "committedDate": "2020-03-24T19:12:14Z", "message": "Merge branch 'master' into feature/ml-allow-secondary-auth-header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODU2ODg1", "url": "https://github.com/elastic/elasticsearch/pull/54121#pullrequestreview-382856885", "createdAt": "2020-03-27T13:30:32Z", "commit": {"oid": "740e6667956ca7e3e0fbb89ba82e71b692675dbe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozMDozMlrOF8xLjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yN1QxMzozMDozMlrOF8xLjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTI2NDY1NA==", "bodyText": "Since \"secondary authorization headers\" are an ES thing, not a global standard, I think we should have a paragraph somewhere in the security docs that says the header name is es-secondary-authorization and the format is the same as for basic auth, and then \"secondary authorization headers\" in this sentence and the equivalent one in the other 3 files should be a link to that.", "url": "https://github.com/elastic/elasticsearch/pull/54121#discussion_r399264654", "createdAt": "2020-03-27T13:30:32Z", "author": {"login": "droberts195"}, "path": "docs/reference/ml/anomaly-detection/apis/update-datafeed.asciidoc", "diffHunk": "@@ -35,6 +35,12 @@ IMPORTANT: When {es} {security-features} are enabled, your {dfeed} remembers\n which roles the user who updated it had at the time of update and runs the query\n using those same roles.\n \n++\n+--\n+NOTE: It is possible that secondary authorization headers are supplied in the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "740e6667956ca7e3e0fbb89ba82e71b692675dbe"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06ae0579cddffd697d5f08f38768a243186bec6", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d06ae0579cddffd697d5f08f38768a243186bec6", "committedDate": "2020-03-30T19:29:03Z", "message": "removing secondary auth header when storing and preferring it as primary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f821505ba013548873a1924e4d486c9eedeab425", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f821505ba013548873a1924e4d486c9eedeab425", "committedDate": "2020-03-30T19:33:31Z", "message": "Merge branch 'master' into feature/ml-allow-secondary-auth-header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTM0Nzcy", "url": "https://github.com/elastic/elasticsearch/pull/54121#pullrequestreview-384934772", "createdAt": "2020-03-31T17:06:21Z", "commit": {"oid": "f821505ba013548873a1924e4d486c9eedeab425"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowNjoyMVrOF-fpAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNzowNzozOFrOF-fr-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3NDQzMw==", "bodyText": "Following the test you did yesterday this looks like it works as intended now.", "url": "https://github.com/elastic/elasticsearch/pull/54121#discussion_r401074433", "createdAt": "2020-03-31T17:06:21Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/AuthHeadersExtractor.java", "diffHunk": "@@ -0,0 +1,38 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils;\n+\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.security.authc.AuthenticationField;\n+import org.elasticsearch.xpack.core.security.authc.support.SecondaryAuthentication;\n+\n+import java.util.HashMap;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+public final class AuthHeadersExtractor {\n+\n+    private AuthHeadersExtractor() {}\n+\n+    public static Map<String, String> extractAuthHeadersAndPreferSecondaryAuth(ThreadContext context) {\n+        Map<String, String> threadHeaders = context.getHeaders();\n+        if (threadHeaders == null || threadHeaders.isEmpty()) {\n+            return new HashMap<>();\n+        }\n+\n+        Map<String, String> headers = threadHeaders.entrySet().stream()\n+            .filter(e -> ClientHelper.SECURITY_HEADER_FILTERS.contains(e.getKey()))\n+            .collect(Collectors.toMap(Map.Entry::getKey, Map.Entry::getValue));\n+        String secondaryAuth = headers.get(SecondaryAuthentication.THREAD_CTX_KEY);\n+        if (secondaryAuth != null) {\n+            headers.put(AuthenticationField.AUTHENTICATION_KEY, secondaryAuth);\n+        }\n+        return headers;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzM5NDg2MQ=="}, "originalCommit": {"oid": "30cfb12b7dc91c147567e4ca66b635f012df4a01"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA3NTE5NQ==", "bodyText": "nit: 3 s's", "url": "https://github.com/elastic/elasticsearch/pull/54121#discussion_r401075195", "createdAt": "2020-03-31T17:07:38Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -544,6 +544,46 @@ public void testInsufficientSearchPrivilegesOnPreview() throws Exception {\n                 containsString(\"[indices:data/read/field_caps] is unauthorized for user [ml_admin]\"));\n     }\n \n+    public void testSecondaryAuthSearchPrivilegesLookBack() throws Exception {\n+        setupDataAccessRole(\"airline-data\");\n+        String jobId = \"secondary-privs-put-job\";\n+        createJob(jobId, \"airline.keyword\");\n+        String datafeedId = \"datafeed-\" + jobId;\n+        // Primary auth header does not have accesss, but secondary auth does", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f821505ba013548873a1924e4d486c9eedeab425"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ed4cff3448bed284fbf6d0c3726044fa9cdf557", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ed4cff3448bed284fbf6d0c3726044fa9cdf557", "committedDate": "2020-03-31T18:24:52Z", "message": "Update DatafeedJobsRestIT.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23578d393f4d5d5f04b280d83f1dd937dae7ec7a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/23578d393f4d5d5f04b280d83f1dd937dae7ec7a", "committedDate": "2020-04-02T12:25:58Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-allow-secondary-auth-header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4674ffaf3e11e14088f178dc5e426688bb996a05", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4674ffaf3e11e14088f178dc5e426688bb996a05", "committedDate": "2020-04-02T13:03:47Z", "message": "adjusting how secondary auth headers are added"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b93bd5bbeac647aeb96485170d0ac79a514aabb", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b93bd5bbeac647aeb96485170d0ac79a514aabb", "committedDate": "2020-04-02T13:08:29Z", "message": "fixing minor things"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7be96d277ae3733d61c822b7ceebac993e9dbfc", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7be96d277ae3733d61c822b7ceebac993e9dbfc", "committedDate": "2020-04-02T13:18:41Z", "message": "reverting unnecessary change"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1713, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}