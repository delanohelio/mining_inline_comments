{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzcxMzk5", "number": 56556, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0Nzo0MVrOD7biOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0ODozMFrOD7bi-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjQzNzA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0Nzo0MVrOGTwCFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0Nzo0MVrOGTwCFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzA5NQ==", "bodyText": "Need a live view of the state, but I didn't want to expose the actual reference to avoid the ability to set the state.", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363095", "createdAt": "2020-05-11T22:47:41Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java", "diffHunk": "@@ -203,7 +204,7 @@ private boolean clearAllocationIds() {\n         return previousShardRoutings.get();\n     }\n \n-    public WatcherState getState() {\n-        return state.get();\n+    public Supplier<WatcherState> getState(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYzNjQzODk5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0ODozMFrOGTwDQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0ODozMFrOGTwDQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzM5Mg==", "bodyText": "I manually tested that when the service is stopped, and you add a new watch, it does indeed get added (as expected) upon startup.", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363392", "createdAt": "2020-05-11T22:48:30Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java", "diffHunk": "@@ -119,8 +124,8 @@ public void postIndex(ShardId shardId, Engine.Index operation, Engine.IndexResul\n                 }\n \n                 boolean shouldBeTriggered = shardAllocationConfiguration.shouldBeTriggered(watch.id());\n-                if (shouldBeTriggered) {\n-                    if (watch.status().state().isActive()) {\n+                if (shouldBeTriggered && EnumSet.of(WatcherState.STOPPING, WatcherState.STOPPED).contains(watcherState.get()) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "originalPosition": 44}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 557, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}