{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MDQ3Mjc3", "number": 62943, "title": "SQL: Fix exception when using CAST on inexact field", "bodyText": "Currently, CAST will use the first keyword subfield of a text field for\nan expression in WHERE clause that gets translated to a painless script\nwhich will lead to an exception thrown:\n\"root_cause\": [\n      {\n        \"type\": \"script_exception\",\n        \"reason\": \"runtime error\",\n        \"script_stack\": [\n          \"org.elasticsearch.index.mapper.TextFieldMapper$TextFieldType.fielddataBuilder(TextFieldMapper.java:759)\",\n          \"org.elasticsearch.index.fielddata.IndexFieldDataService.getForField(IndexFieldDataService.java:116)\",\n          \"org.elasticsearch.index.query.QueryShardContext.lambda$lookup$0(QueryShardContext.java:308)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup$1.run(LeafDocLookup.java:101)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup$1.run(LeafDocLookup.java:98)\",\n          \"java.security.AccessController.doPrivileged(Native Method)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:98)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:41)\",\n          \"org.elasticsearch.xpack.sql.expression.function.scalar.whitelist.InternalSqlScriptUtils.docValue(InternalSqlScriptUtils.java:79)\",\n          \"InternalSqlScriptUtils.cast(InternalSqlScriptUtils.docValue(doc,params.v0),params.v1)\",\n          \"                                                                      ^---- HERE\"\n        ],\n        \"script\": \"InternalSqlScriptUtils.cast(InternalSqlScriptUtils.docValue(doc,params.v0),params.v1)\",\n        \"lang\": \"painless\"\n      }\n    ],\n\nInstead of fixing this behaviour and allowing a painless translation using the\nfirst underlying keyword silently, which can be confusing, we detect such usage\nand throw an error early.\nRelates to #60178", "createdAt": "2020-09-28T10:34:02Z", "url": "https://github.com/elastic/elasticsearch/pull/62943", "merged": true, "mergeCommit": {"oid": "7402e8267ba564e52dc672c25b262824b6048b40"}, "closed": true, "closedAt": "2020-10-02T13:50:56Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNQ8bSAH2gAyNDk0MDQ3Mjc3OmE3YzQxZTQwY2MxYjQxMTBhMGNlMTJmM2ZmNGZkOGMzZTY5NGZlOTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOlozlAH2gAyNDk0MDQ3Mjc3OmRmOTMzYzAyYzYxMDYzNTUzNDU3OWY2ZjM1ZTBiM2I0ZjBkN2YxODM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93", "committedDate": "2020-09-28T10:22:44Z", "message": "SQL: Fix exception when using CAST on inexact field\n\nCurrently, CAST will use the first keyword subfield of a text field for\nan expression in WHERE clause that gets translated to a painless script\nwhich will lead to an exception thrown:\n```\n\"root_cause\": [\n      {\n        \"type\": \"script_exception\",\n        \"reason\": \"runtime error\",\n        \"script_stack\": [\n          \"org.elasticsearch.index.mapper.TextFieldMapper$TextFieldType.fielddataBuilder(TextFieldMapper.java:759)\",\n          \"org.elasticsearch.index.fielddata.IndexFieldDataService.getForField(IndexFieldDataService.java:116)\",\n          \"org.elasticsearch.index.query.QueryShardContext.lambda$lookup$0(QueryShardContext.java:308)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup$1.run(LeafDocLookup.java:101)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup$1.run(LeafDocLookup.java:98)\",\n          \"java.security.AccessController.doPrivileged(Native Method)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:98)\",\n          \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:41)\",\n          \"org.elasticsearch.xpack.sql.expression.function.scalar.whitelist.InternalSqlScriptUtils.docValue(InternalSqlScriptUtils.java:79)\",\n          \"InternalSqlScriptUtils.cast(InternalSqlScriptUtils.docValue(doc,params.v0),params.v1)\",\n          \"                                                                      ^---- HERE\"\n        ],\n        \"script\": \"InternalSqlScriptUtils.cast(InternalSqlScriptUtils.docValue(doc,params.v0),params.v1)\",\n        \"lang\": \"painless\"\n      }\n    ],\n```\n\nInstead of allowing a painless translation using the first underlying\nkeyword silently, which can be confusing, we detect such usage and throw\\\nan error early.\n\nRelates to #60178"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTA2NjIy", "url": "https://github.com/elastic/elasticsearch/pull/62943#pullrequestreview-501106622", "createdAt": "2020-10-02T12:52:19Z", "commit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjo1MjoyMFrOHbsbxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjo1MjoyMFrOHbsbxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwMTYwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                localFailures.add(fail(c.field(), \"[{}] of data type [{}] cannot be used for [{}()] inside WHERE clause\",\n          \n          \n            \n                                localFailures.add(fail(c.field(), \"[{}] of data type [{}] cannot be used for [{}()] inside the WHERE clause\",", "url": "https://github.com/elastic/elasticsearch/pull/62943#discussion_r498801605", "createdAt": "2020-10-02T12:52:20Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -865,4 +867,18 @@ private static void checkMatrixStats(LogicalPlan p, Set<Failure> localFailures)\n             }\n         }, Skewness.class));\n     }\n+\n+    private static void checkCastOnInexact(LogicalPlan p, Set<Failure> localFailures) {\n+        p.forEachDown(f -> f.forEachExpressionsUp(e -> e.forEachUp((Cast c) -> {\n+            if (c.field() instanceof FieldAttribute) {\n+                EsField.Exact exactInfo = ((FieldAttribute) c.field()).getExactInfo();\n+                if (exactInfo.hasExact() == false\n+                        || ((FieldAttribute) c.field()).exactAttribute().equals(c.field()) == false) {\n+                    localFailures.add(fail(c.field(), \"[{}] of data type [{}] cannot be used for [{}()] inside WHERE clause\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTA4Njg4", "url": "https://github.com/elastic/elasticsearch/pull/62943#pullrequestreview-501108688", "createdAt": "2020-10-02T12:55:19Z", "commit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjo1NToxOVrOHbshfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjo1NToxOVrOHbshfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODgwMzA2OQ==", "bodyText": "Does the relatively not-straight WHERE clause bare any meaning to the test target (for instance, vs. some WHERE CAST(some.string AS string) = 'foo')? Just curious.", "url": "https://github.com/elastic/elasticsearch/pull/62943#discussion_r498803069", "createdAt": "2020-10-02T12:55:19Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/analysis/analyzer/VerifierErrorMessagesTests.java", "diffHunk": "@@ -1135,4 +1135,13 @@ public void testErrorMessageForMatrixStatsWithScalars() {\n         assertEquals(\"1:17: [SKEWNESS()] cannot be used on top of operators or scalars\",\n                 error(\"SELECT SKEWNESS(ABS(int * 10.123)) FROM test\"));\n     }\n+\n+    public void testCastOnInexact() {\n+        // inexact with underlying keyword\n+        assertEquals(\"1:36: [some.string] of data type [text] cannot be used for [CAST()] inside WHERE clause\",\n+                error(\"SELECT * FROM test WHERE NOT (CAST(some.string AS string) = 'foo') OR true\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTA5MDI4", "url": "https://github.com/elastic/elasticsearch/pull/62943#pullrequestreview-501109028", "createdAt": "2020-10-02T12:55:47Z", "commit": {"oid": "a7c41e40cc1b4110a0ce12f3ff4fd8c3e694fe93"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d2088e3267981b23a71987e6465fb2eeb1fde7", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/28d2088e3267981b23a71987e6465fb2eeb1fde7", "committedDate": "2020-10-02T13:01:24Z", "message": "Merge remote-tracking branch 'upstream/master' into fix-cast-inexact"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df933c02c610635534579f6f35e0b3b4f0d7f183", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/df933c02c610635534579f6f35e0b3b4f0d7f183", "committedDate": "2020-10-02T13:03:14Z", "message": "address feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4640, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}