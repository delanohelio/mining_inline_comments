{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MTI4NDcy", "number": 62490, "title": "Adding authentication information to access token create APIs", "bodyText": "Adding authentication object to following APIs:\n/_security/oauth2/token\n/_security/delegate_pki\n/_security/saml/authenticate\n/_security/oidc/authenticate\nResolves: #59685", "createdAt": "2020-09-16T17:11:01Z", "url": "https://github.com/elastic/elasticsearch/pull/62490", "merged": true, "mergeCommit": {"oid": "2351bb399caf1cd9a1b652bedbb82fd08faa4672"}, "closed": true, "closedAt": "2020-10-16T07:12:45Z", "author": {"login": "BigPandaToo"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJ-jmQgFqTQ5MTEzMDg2OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS7fjSAFqTUwOTg4MDY3OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTMwODY5", "url": "https://github.com/elastic/elasticsearch/pull/62490#pullrequestreview-491130869", "createdAt": "2020-09-18T03:41:59Z", "commit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwMzo0MjowMFrOHT84-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNDozMDoyNFrOHT9r7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4MjYxNg==", "bodyText": "An actual authentication object is needed here instead of null for better test coverage.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490682616", "createdAt": "2020-09-18T03:42:00Z", "author": {"login": "ywangd"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/security/DelegatePkiAuthenticationResponseTests.java", "diffHunk": "@@ -37,7 +37,7 @@\n     protected org.elasticsearch.xpack.core.security.action.DelegatePkiAuthenticationResponse createServerTestInstance(\n         XContentType xContentType) {\n         return new org.elasticsearch.xpack.core.security.action.DelegatePkiAuthenticationResponse(randomAlphaOfLength(6),\n-                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"));\n+                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4NTgyOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.principal = principal;\n          \n          \n            \n                    this.principal = authentication.getUser().principal();", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490685828", "createdAt": "2020-09-18T03:48:25Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java", "diffHunk": "@@ -17,12 +18,15 @@\n     private String accessTokenString;\n     private String refreshTokenString;\n     private TimeValue expiresIn;\n+    private Authentication authentication;\n \n-    public OpenIdConnectAuthenticateResponse(String principal, String accessTokenString, String refreshTokenString, TimeValue expiresIn) {\n+    public OpenIdConnectAuthenticateResponse(Authentication authentication, String accessTokenString, String refreshTokenString,\n+                                             TimeValue expiresIn) {\n         this.principal = principal;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4NzU5Mw==", "bodyText": "The authentication object should be deserialised from the stream as well, i.e. authentication = new Authentication(in);.\nSince this is a new field, which does not exist in previous version, we need to protect the read with version check, i.e.:\nif (in.getVersion().onOrAfter(Version.V_7_10_0) {\n    authentication = new Authentication(in);\n}\nTechically, I don't think class like OpenIdConnectAuthenticateResponse travel across nodes, so whether reader/writer interfaces are really necessary for them  is debatable. But that is a separate issue, for consistency, it's better to have it here. (Edit: in fact, given the presense of TransportClient in 7.x, these interfaces could still be actually necessary)", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490687593", "createdAt": "2020-09-18T03:55:29Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java", "diffHunk": "@@ -31,6 +35,7 @@ public OpenIdConnectAuthenticateResponse(StreamInput in) throws IOException {\n         accessTokenString = in.readString();\n         refreshTokenString = in.readString();\n         expiresIn = in.readTimeValue();\n+        authentication = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4NzgxMw==", "bodyText": "Similarly, serialisation should handle the new authentication field as well plus version check.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490687813", "createdAt": "2020-09-18T03:56:19Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java", "diffHunk": "@@ -49,6 +54,8 @@ public TimeValue getExpiresIn() {\n         return expiresIn;\n     }\n \n+    public Authentication getAuthentication() { return authentication; }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY4OTY3MQ==", "bodyText": "Same here, I think we could use a real authentication object instead of null.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490689671", "createdAt": "2020-09-18T04:04:24Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/DelegatePkiAuthenticationResponseTests.java", "diffHunk": "@@ -35,7 +35,7 @@ public void testSerialization() throws Exception {\n     @Override\n     protected DelegatePkiAuthenticationResponse createTestInstance() {\n         return new DelegatePkiAuthenticationResponse(randomAlphaOfLengthBetween(0, 10),\n-                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"));\n+                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDY5NTY2MQ==", "bodyText": "Similar to TransportCreateTokenAction#createToken, there are two authentication involved. One is used to authenticate the request and the other is the one being refreshed. securityContext#getAuthentication is used for the first one, which is not what we want to return in the response.\nThe authentication that should be in the response is the one that gets refreshed. It is not directly available here, but can be derived from the access token (tuple.v1()).  TokenService#authenticateToken can take the access token and decode it for the authentication object.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r490695661", "createdAt": "2020-09-18T04:30:24Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/token/TransportRefreshTokenAction.java", "diffHunk": "@@ -21,19 +22,23 @@\n public class TransportRefreshTokenAction extends HandledTransportAction<CreateTokenRequest, CreateTokenResponse> {\n \n     private final TokenService tokenService;\n+    private final SecurityContext securityContext;\n \n     @Inject\n-    public TransportRefreshTokenAction(TransportService transportService, ActionFilters actionFilters, TokenService tokenService) {\n+    public TransportRefreshTokenAction(TransportService transportService, ActionFilters actionFilters, TokenService tokenService,\n+                                       SecurityContext securityContext) {\n         super(RefreshTokenAction.NAME, transportService, actionFilters, CreateTokenRequest::new);\n         this.tokenService = tokenService;\n+        this.securityContext = securityContext;\n     }\n \n     @Override\n     protected void doExecute(Task task, CreateTokenRequest request, ActionListener<CreateTokenResponse> listener) {\n         tokenService.refreshToken(request.getRefreshToken(), ActionListener.wrap(tuple -> {\n             final String scope = getResponseScopeValue(request.getScope());\n             final CreateTokenResponse response =\n-                    new CreateTokenResponse(tuple.v1(), tokenService.getExpirationDelay(), scope, tuple.v2(), null);\n+                    new CreateTokenResponse(tuple.v1(), tokenService.getExpirationDelay(), scope, tuple.v2(), null,\n+                        securityContext.getAuthentication());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "346695a05aa04f439f41ecf25e5d3a20e29ade39"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzQ2NTA0", "url": "https://github.com/elastic/elasticsearch/pull/62490#pullrequestreview-501746504", "createdAt": "2020-10-05T06:19:13Z", "commit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "state": "COMMENTED", "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjoxOToxNFrOHcO1dA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNzoyOTozMVrOHcQe5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2NTIzNg==", "bodyText": "It's minor, but I think it reads better to replace these arbitrary strings with randomAlphaOfLength(...).", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499365236", "createdAt": "2020-10-05T06:19:14Z", "author": {"login": "ywangd"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/security/CreateTokenResponseTests.java", "diffHunk": "@@ -38,6 +40,9 @@ public void testFromXContent() throws IOException {\n         final String scope = randomBoolean() ? null : randomAlphaOfLength(4);\n         final String type = randomAlphaOfLength(6);\n         final String kerberosAuthenticationResponseToken = randomBoolean() ? null : randomAlphaOfLength(7);\n+        final AuthenticateResponse authenticateResponse = new AuthenticateResponse(new User(\"abcdefg\", Arrays.asList( \"kdjklsd\" )),\n+            true, new AuthenticateResponse.RealmInfo(\"abcd\", \"ghjk\" ), new AuthenticateResponse.RealmInfo(\"xfhfhgc\", \"sgdhfhg\" ),\n+            \"realm\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM2NjQ2MA==", "bodyText": "Nit: method should begin with lowercase letter, i.e. createServerAuthenticationResponse(...).", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499366460", "createdAt": "2020-10-05T06:23:13Z", "author": {"login": "ywangd"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/security/DelegatePkiAuthenticationResponseTests.java", "diffHunk": "@@ -51,5 +59,52 @@ protected void assertInstances(org.elasticsearch.xpack.core.security.action.Dele\n         assertThat(serverTestInstance.getAccessToken(), is(clientInstance.getAccessToken()));\n         assertThat(serverTestInstance.getExpiresIn(), is(clientInstance.getExpiresIn()));\n         assertThat(clientInstance.getType(), is(\"Bearer\"));\n+        AuthenticateResponse serverAuthenticationResponse = CreateServerAuthenticationResponse(serverTestInstance.getAuthentication());\n+        User user = serverTestInstance.getAuthentication().getUser();\n+        assertThat(serverAuthenticationResponse, equalTo(clientInstance.getAuthenticationResponse()));\n+    }\n+\n+    protected Authentication createAuthentication() {\n+        final String username = randomAlphaOfLengthBetween(1, 4);\n+        final String[] roles = generateRandomStringArray(4, 4, false, true);\n+        final Map<String, Object> metadata;\n+        metadata = new HashMap<>();\n+        if (randomBoolean()) {\n+            metadata.put(\"string\", null);\n+        } else {\n+            metadata.put(\"string\", randomAlphaOfLengthBetween(0, 4));\n+        }\n+        if (randomBoolean()) {\n+            metadata.put(\"string_list\", null);\n+        } else {\n+            metadata.put(\"string_list\", Arrays.asList(generateRandomStringArray(4, 4, false, true)));\n+        }\n+        final String fullName = randomFrom(random(), null, randomAlphaOfLengthBetween(0, 4));\n+        final String email = randomFrom(random(), null, randomAlphaOfLengthBetween(0, 4));\n+        final boolean enabled = randomBoolean();\n+        final String authenticationRealmName = randomAlphaOfLength(5);\n+        final String authenticationRealmType = randomFrom(\"file\", \"native\", \"ldap\", \"active_directory\", \"saml\", \"kerberos\");\n+        final String lookupRealmName = randomAlphaOfLength(5);\n+        final String lookupRealmType = randomFrom(\"file\", \"native\", \"ldap\", \"active_directory\", \"saml\", \"kerberos\");\n+        final String nodeName = randomAlphaOfLengthBetween(1, 10);\n+        final Authentication.AuthenticationType authenticationType = randomFrom(Authentication.AuthenticationType.values());\n+        return new Authentication(\n+            new User(username, roles, fullName, email, metadata, true),\n+            new Authentication.RealmRef(authenticationRealmName, authenticationRealmType, nodeName),\n+            new Authentication.RealmRef(lookupRealmName, lookupRealmType, nodeName), Version.CURRENT, authenticationType, metadata);\n+    }\n+\n+    AuthenticateResponse CreateServerAuthenticationResponse(Authentication authentication){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4MDMwMg==", "bodyText": "I think it is useful to cross-link the existing page of authentication response, e.g.:\n<<{upid}-authenticate-response, authenticate response>>.\nThis applies to a few other similar places as well.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499380302", "createdAt": "2020-10-05T07:02:25Z", "author": {"login": "ywangd"}, "path": "docs/java-rest/high-level/security/create-token.asciidoc", "diffHunk": "@@ -49,6 +49,7 @@ The returned `CreateTokenResponse` contains the following properties:\n `scope`:: The scope of the token. May be `null`.\n `refreshToken`:: A secondary \"refresh\" token that may be used to extend\n  the life of an access token. May be `null`.\n+`authentication`:: This is the authentication object for the newly created token.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4NzI2Mg==", "bodyText": "We need fix the indentation levels here. Otherwise it looks weird on the documentation page\nPlease note that the same thing needs to be fixed in a few other places as well.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499387262", "createdAt": "2020-10-05T07:19:04Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/delegate-pki-authentication.asciidoc", "diffHunk": "@@ -89,7 +89,28 @@ Which returns the following response:\n {\n   \"access_token\" : \"dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==\",\n   \"type\" : \"Bearer\",\n-  \"expires_in\" : 1200\n+  \"expires_in\" : 1200,\n+  \"authentication\" : {\n+          \"username\" : \"Elasticsearch Test Client\",\n+          \"roles\" : [ ],\n+          \"full_name\" : null,\n+          \"email\" : null,\n+          \"metadata\" : {\n+            \"pki_dn\" : \"O=org, OU=Elasticsearch, CN=Elasticsearch Test Client\",\n+            \"pki_delegated_by_user\" : \"test_admin\",\n+            \"pki_delegated_by_realm\" : \"file\"\n+          },\n+          \"enabled\" : true,\n+          \"authentication_realm\" : {\n+            \"name\" : \"pki1\",\n+            \"type\" : \"pki\"\n+          },\n+          \"lookup_realm\" : {\n+            \"name\" : \"pki1\",\n+            \"type\" : \"pki\"\n+          },\n+          \"authentication_type\" : \"realm\"\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4ODc4MQ==", "bodyText": "This needs to be guarded by version check as well, e.g.\nif (out.getVersion().onOrAfter(..) {\n}", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499388781", "createdAt": "2020-10-05T07:22:28Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/DelegatePkiAuthenticationResponse.java", "diffHunk": "@@ -69,10 +59,15 @@ public TimeValue getExpiresIn() {\n         return expiresIn;\n     }\n \n+    public Authentication getAuthentication() {\n+        return authentication;\n+    }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         out.writeString(accessToken);\n         out.writeTimeValue(expiresIn);\n+        authentication.writeTo(out);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM4OTM2Mw==", "bodyText": "Needs version check here as well.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499389363", "createdAt": "2020-10-05T07:23:40Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/oidc/OpenIdConnectAuthenticateResponse.java", "diffHunk": "@@ -49,11 +57,14 @@ public TimeValue getExpiresIn() {\n         return expiresIn;\n     }\n \n+    public Authentication getAuthentication() { return authentication; }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         out.writeString(principal);\n         out.writeString(accessTokenString);\n         out.writeString(refreshTokenString);\n         out.writeTimeValue(expiresIn);\n+        authentication.writeTo(out);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM5MDExNw==", "bodyText": "Need add the new authentication field here.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499390117", "createdAt": "2020-10-05T07:25:10Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/saml/SamlAuthenticateResponse.java", "diffHunk": "@@ -64,6 +70,8 @@ public TimeValue getExpiresIn() {\n         return expiresIn;\n     }\n \n+    public Authentication getAuthentication() { return authentication; }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         out.writeString(principal);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM5MDQzMQ==", "bodyText": "Again, version check is needed here.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499390431", "createdAt": "2020-10-05T07:25:47Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/token/CreateTokenResponse.java", "diffHunk": "@@ -68,13 +75,16 @@ public String getKerberosAuthenticationResponseToken() {\n         return kerberosAuthenticationResponseToken;\n     }\n \n+    public Authentication getAuthentication() { return authentication; }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         out.writeString(tokenString);\n         out.writeTimeValue(expiresIn);\n         out.writeOptionalString(scope);\n         out.writeOptionalString(refreshToken);\n         out.writeOptionalString(kerberosAuthenticationResponseToken);\n+        authentication.writeTo(out);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM5MTA3MA==", "bodyText": "Nit: static variables normally use uppercase letters, e.g. AUTH_PARSER.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499391070", "createdAt": "2020-10-05T07:27:03Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/DelegatePkiAuthenticationResponseTests.java", "diffHunk": "@@ -35,16 +47,97 @@ public void testSerialization() throws Exception {\n     @Override\n     protected DelegatePkiAuthenticationResponse createTestInstance() {\n         return new DelegatePkiAuthenticationResponse(randomAlphaOfLengthBetween(0, 10),\n-                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"));\n+                TimeValue.parseTimeValue(randomTimeValue(), getClass().getSimpleName() + \".expiresIn\"),\n+                createAuthentication());\n     }\n \n     @Override\n     protected DelegatePkiAuthenticationResponse doParseInstance(XContentParser parser) throws IOException {\n-        return DelegatePkiAuthenticationResponse.PARSER.apply(parser, null);\n+        return DelegatePkiAuthenticationResponseTests.PARSER.apply(parser, null);\n     }\n \n     @Override\n     protected boolean supportsUnknownFields() {\n-        return true;\n+        return false;\n+    }\n+\n+    private static final ParseField ACCESS_TOKEN_FIELD = new ParseField(\"access_token\");\n+    private static final ParseField TYPE_FIELD = new ParseField(\"type\");\n+    private static final ParseField EXPIRES_IN_FIELD = new ParseField(\"expires_in\");\n+    private static final ParseField AUTHENTICATION = new ParseField(\"authentication\");\n+\n+    public static final ConstructingObjectParser<DelegatePkiAuthenticationResponse, Void> PARSER = new ConstructingObjectParser<>(\n+        \"delegate_pki_response\", true, a -> {\n+        final String accessToken = (String) a[0];\n+        final String type = (String) a[1];\n+        if (false == \"Bearer\".equals(type)) {\n+            throw new IllegalArgumentException(\"Unknown token type [\" + type + \"], only [Bearer] type permitted\");\n+        }\n+        final Long expiresIn = (Long) a[2];\n+        final Authentication authentication = (Authentication) a[3];\n+\n+        return new DelegatePkiAuthenticationResponse(accessToken, TimeValue.timeValueSeconds(expiresIn), authentication);\n+    });\n+\n+    static {\n+        PARSER.declareString(ConstructingObjectParser.constructorArg(), ACCESS_TOKEN_FIELD);\n+        PARSER.declareString(ConstructingObjectParser.constructorArg(), TYPE_FIELD);\n+        PARSER.declareLong(ConstructingObjectParser.constructorArg(), EXPIRES_IN_FIELD);\n+        PARSER.declareObject(optionalConstructorArg(), (p, c) -> parseAuthentication(p), AUTHENTICATION);\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private static final ConstructingObjectParser<Authentication, Void> AuthPARSER = new ConstructingObjectParser<>(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 82}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM5MjIyOQ==", "bodyText": "Along the same logic of existing code, I think we need test the map hasEntry for authentication as well.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r499392229", "createdAt": "2020-10-05T07:29:31Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/action/oauth2/RestGetTokenActionTests.java", "diffHunk": "@@ -85,7 +89,7 @@ public void sendResponse(RestResponse restResponse) {\n         assertThat(map, hasEntry(\"expires_in\", Math.toIntExact(createTokenResponse.getExpiresIn().seconds())));\n         assertThat(map, hasEntry(\"refresh_token\", createTokenResponse.getRefreshToken()));\n         assertThat(map, hasEntry(\"kerberos_authentication_response_token\", createTokenResponse.getKerberosAuthenticationResponseToken()));\n-        assertEquals(5, map.size());\n+        assertEquals(6, map.size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49d056fe68ed29418150fe8c2a7f3d39c78024d4"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MDM1NTMx", "url": "https://github.com/elastic/elasticsearch/pull/62490#pullrequestreview-507035531", "createdAt": "2020-10-13T02:57:54Z", "commit": {"oid": "cfa68225e2bf1e0733ecf95cb9f0f4b9824eac69"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMjo1Nzo1NVrOHgTpuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QwMzowOTozM1rOHgT1Iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzODQ1Nw==", "bodyText": "This reads a bit abruptly. Might wanna add a few connection words, something like \"This is the authentication object for the newly created token. See also <<{upid}-authenticate-response, authenticate response>>.\"", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r503638457", "createdAt": "2020-10-13T02:57:55Z", "author": {"login": "ywangd"}, "path": "docs/java-rest/high-level/security/create-token.asciidoc", "diffHunk": "@@ -49,6 +49,8 @@ The returned `CreateTokenResponse` contains the following properties:\n `scope`:: The scope of the token. May be `null`.\n `refreshToken`:: A secondary \"refresh\" token that may be used to extend\n  the life of an access token. May be `null`.\n+`authentication`:: This is the authentication object for the newly created token:\n+<<{upid}-authenticate-response, authenticate response>>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa68225e2bf1e0733ecf95cb9f0f4b9824eac69"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzYzODU0Mg==", "bodyText": "Same here (see above)", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r503638542", "createdAt": "2020-10-13T02:58:14Z", "author": {"login": "ywangd"}, "path": "docs/java-rest/high-level/security/delegate-pki-authentication.asciidoc", "diffHunk": "@@ -52,6 +52,8 @@ The returned +{response}+ contains the following properties:\n `type`:: The type of the token, this is always `\"Bearer\"`.\n `expiresIn`:: The length of time (in seconds) until the token will expire.\n    The token will be considered invalid after that time.\n+`authentication`:: This is the authentication object for the newly created token:\n+<<{upid}-authenticate-response, authenticate response>>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa68225e2bf1e0733ecf95cb9f0f4b9824eac69"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzY0MTM3OQ==", "bodyText": "I think we need a null check here to not show the field at all if the value is null. As far as I understand it, this is the general preference (see other fields in this method). This comment applies to other places where xcontent is built with authentication field.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r503641379", "createdAt": "2020-10-13T03:09:33Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/token/CreateTokenResponse.java", "diffHunk": "@@ -93,6 +105,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (kerberosAuthenticationResponseToken != null) {\n             builder.field(\"kerberos_authentication_response_token\", kerberosAuthenticationResponseToken);\n         }\n+        builder.field(\"authentication\", authentication);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfa68225e2bf1e0733ecf95cb9f0f4b9824eac69"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a91757063e07463feaf9de64e735d75e742be878", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/a91757063e07463feaf9de64e735d75e742be878", "committedDate": "2020-10-14T16:18:34Z", "message": "Adding authentication information to access token create APIs\n\nAdding authentication object to following APIs:\n/_security/oauth2/token\n/_security/delegate_pki\n/_security/saml/authenticate\n/_security/oidc/authenticate\n\nResolves: #59685\n(cherry picked from commit 51dbd9e584813dcb82f9c28cfff8a1a9f4af846c)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1f7c1f2f35ea14af7129ba11145ef1ab254cdbb", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1f7c1f2f35ea14af7129ba11145ef1ab254cdbb", "committedDate": "2020-10-14T16:18:35Z", "message": "Addressing PR commends, fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0966f92b848f73308e7f054476085948816a2ee4", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/0966f92b848f73308e7f054476085948816a2ee4", "committedDate": "2020-10-14T16:18:36Z", "message": "Returning tokenGroups attribute as SID string instead of byte array (AD metadata)\n\nAddressing PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbcb68b41c08f5176a1b11ea9258d637767e648d", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbcb68b41c08f5176a1b11ea9258d637767e648d", "committedDate": "2020-10-14T16:18:36Z", "message": "Returning tokenGroups attribute as SID string instead of byte array (AD metadata)\n\nUpdate version check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eba3272191ca8f0b9370753c31cabadcc71a93ec", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/eba3272191ca8f0b9370753c31cabadcc71a93ec", "committedDate": "2020-10-14T16:18:37Z", "message": "Returning tokenGroups attribute as SID string instead of byte array (AD metadata)\n\nUpdate version check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58a8c7be565350867d728565ece5cbfb16c07efe", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a8c7be565350867d728565ece5cbfb16c07efe", "committedDate": "2020-10-14T16:48:59Z", "message": "Addressing more PR comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "20b37996cb18f93903dec8a22c2d72d1617b04f3", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/20b37996cb18f93903dec8a22c2d72d1617b04f3", "committedDate": "2020-10-14T17:06:00Z", "message": "Merge branch 'APIresponse' of github.com:BigPandaToo/elasticsearch into APIresponse"}, "afterCommit": {"oid": "58a8c7be565350867d728565ece5cbfb16c07efe", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a8c7be565350867d728565ece5cbfb16c07efe", "committedDate": "2020-10-14T16:48:59Z", "message": "Addressing more PR comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d", "author": {"user": {"login": "BigPandaToo", "name": "Lyudmila Fokina"}}, "url": "https://github.com/elastic/elasticsearch/commit/49fbded29957b7cfa8c1b738289f6b28c058af5d", "committedDate": "2020-10-15T17:03:52Z", "message": "Adding more to integration tests + some small fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODgwNjc5", "url": "https://github.com/elastic/elasticsearch/pull/62490#pullrequestreview-509880679", "createdAt": "2020-10-15T23:34:32Z", "commit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "state": "APPROVED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQyMzozNDozM1rOHifChw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwMDozNjowNVrOHigGDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyMjE4Mw==", "bodyText": "There are some inconsistency for this variable name:\n\nIn the client side code, it is named authenticationResponse and getAuthenticationResponse\nIn the corresponding server side code, it is just authentication .\nIn this class, the parser field is defined as authentication, i.e. new ParseField(\"authentication\").\nIn the HLRC documentation, e.g. create-token.asciidoc, it is also named just authentication\n\nI think we could stick to just authentication. This comment applies to the client side DelegatePkiAuthenticationResponse as well.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505922183", "createdAt": "2020-10-15T23:34:33Z", "author": {"login": "ywangd"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/CreateTokenResponse.java", "diffHunk": "@@ -42,15 +42,17 @@\n     private final String scope;\n     private final String refreshToken;\n     private final String kerberosAuthenticationResponseToken;\n+    private final AuthenticateResponse authenticationResponse;\n \n     public CreateTokenResponse(String accessToken, String type, TimeValue expiresIn, String scope, String refreshToken,\n-                               String kerberosAuthenticationResponseToken) {\n+                               String kerberosAuthenticationResponseToken, AuthenticateResponse authenticationResponse) {\n         this.accessToken = accessToken;\n         this.type = type;\n         this.expiresIn = expiresIn;\n         this.scope = scope;\n         this.refreshToken = refreshToken;\n         this.kerberosAuthenticationResponseToken = kerberosAuthenticationResponseToken;\n+        this.authenticationResponse = authenticationResponse;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkyOTkwOQ==", "bodyText": "The format of the authentication field is inconsistent. Sorry for being picky on this since it is user facing documentation. I think we should strive to ensure:\n\nThe indentation is 2 spaces per level instead of 1.\nThe closing curly and square brackets should align to the corresponding key\n\nThis comment applies to all places (some are better formatted than others) where the authentcation field is shown.\nAn example of the above format is like the follows (please note that . is used in place of whitespace to make it easier to show indentation. ):\n{\n..\"authentication\" : {\n....\"username\" : \"test_admin\",\n....\"roles\" : [\n......\"superuser\"\n....],\n....\"full_name\" : null,\n....\"email\" : null,\n....\"metadata\" : {},\n....\"enabled\" : true,\n....\"authentication_realm\" : {\n......\"name\" : \"file\",\n......\"type\" : \"file\"\n....},\n....\"lookup_realm\" : {\n......\"name\" : \"file\",\n......\"type\" : \"file\"\n....},\n....\"authentication_type\" : \"realm\"\n..}\n}\n\nYou can also refer to get-role-mappings.asciidoc", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505929909", "createdAt": "2020-10-16T00:01:51Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/get-tokens.asciidoc", "diffHunk": "@@ -161,7 +180,26 @@ seconds) that the token expires in, the type, and the refresh token:\n   \"access_token\" : \"dGhpcyBpcyBub3QgYSByZWFsIHRva2VuIGJ1dCBpdCBpcyBvbmx5IHRlc3QgZGF0YS4gZG8gbm90IHRyeSB0byByZWFkIHRva2VuIQ==\",\n   \"type\" : \"Bearer\",\n   \"expires_in\" : 1200,\n-  \"refresh_token\": \"vLBPvmAB6KvwvJZr27cS\"\n+  \"refresh_token\": \"vLBPvmAB6KvwvJZr27cS\",\n+  \"authentication\" : {\n+   \"username\" : \"test_admin\",\n+   \"roles\" : [\n+    \"superuser\"\n+    ],\n+   \"full_name\" : null,\n+   \"email\" : null,\n+   \"metadata\" : { },\n+   \"enabled\" : true,\n+   \"authentication_realm\" : {\n+    \"name\" : \"file\",\n+    \"type\" : \"file\"\n+    },\n+   \"lookup_realm\" : {\n+    \"name\" : \"file\",\n+    \"type\" : \"file\"\n+   },\n+   \"authentication_type\" : \"realm\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 112}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzMzY1NA==", "bodyText": "Nit: I think this assertion is better to be close to where the response object is defined, i.e. straight after CreateTokenResponse response = restClient.... It reads better this way since the test is close to the target. Also, in case it fails, it fails quickly before having to go through the token decrpytion which involves cluster traffic.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505933654", "createdAt": "2020-10-16T00:15:53Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java", "diffHunk": "@@ -104,6 +104,7 @@ public void testTokenServiceBootstrapOnNodeJoin() throws Exception {\n         PlainActionFuture<UserToken> userTokenFuture = new PlainActionFuture<>();\n         tokenService.decodeToken(response.getAccessToken(), userTokenFuture);\n         assertNotNull(userTokenFuture.actionGet());\n+        assertNotNull(response.getAuthenticationResponse());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzNDUwNA==", "bodyText": "We should assert the authentication object's principal name as well. This is because the token creation call involves two credentials, one is the invoking user and the other is the user whom the token is created for. We can assert that the authentication's principal is the second user, not the first one.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505934504", "createdAt": "2020-10-16T00:19:21Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java", "diffHunk": "@@ -133,6 +134,7 @@ public void testTokenServiceCanRotateKeys() throws Exception {\n             assertNotNull(userTokenFuture.actionGet());\n             assertNotEquals(activeKeyHash, tokenService.getActiveKeyHash());\n         }\n+        assertNotNull(response.getAuthenticationResponse());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzOTM4NQ==", "bodyText": "I wonder whether we should have null check here as well similar to how it is done in the toXContent, writeTo methods. It may not be absolutely necessary since this is a rest action and odic cannot be perform with transport client only. But then I am not sure whether there could be some weird combination that could lead to a null value here. Overall I'd say it is easier to just add a null check here so we are sure it is covered in any cases.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505939385", "createdAt": "2020-10-16T00:35:55Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/oidc/RestOpenIdConnectAuthenticateAction.java", "diffHunk": "@@ -63,12 +63,13 @@ protected RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClien\n                     @Override\n                     public RestResponse buildResponse(OpenIdConnectAuthenticateResponse response, XContentBuilder builder)\n                         throws Exception {\n-                        builder.startObject()\n-                            .field(\"username\", response.getPrincipal())\n-                            .field(\"access_token\", response.getAccessTokenString())\n-                            .field(\"refresh_token\", response.getRefreshTokenString())\n-                            .field(\"expires_in\", response.getExpiresIn().seconds())\n-                            .endObject();\n+                        builder.startObject();\n+                        builder.field(\"username\", response.getPrincipal());\n+                        builder.field(\"access_token\", response.getAccessTokenString());\n+                        builder.field(\"refresh_token\", response.getRefreshTokenString());\n+                        builder.field(\"expires_in\", response.getExpiresIn().seconds());\n+                        builder.field(\"authentication\", response.getAuthentication());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTkzOTQ2OQ==", "bodyText": "Same here as above.", "url": "https://github.com/elastic/elasticsearch/pull/62490#discussion_r505939469", "createdAt": "2020-10-16T00:36:05Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/saml/RestSamlAuthenticateAction.java", "diffHunk": "@@ -95,13 +95,14 @@ public RestChannelConsumer innerPrepareRequest(RestRequest request, NodeClient c\n                 requestBuilder.execute(new RestBuilderListener<>(channel) {\n                     @Override\n                     public RestResponse buildResponse(SamlAuthenticateResponse response, XContentBuilder builder) throws Exception {\n-                        builder.startObject()\n-                                .field(\"username\", response.getPrincipal())\n-                                .field(\"realm\", response.getRealm())\n-                                .field(\"access_token\", response.getTokenString())\n-                                .field(\"refresh_token\", response.getRefreshToken())\n-                                .field(\"expires_in\", response.getExpiresIn().seconds())\n-                                .endObject();\n+                        builder.startObject();\n+                        builder.field(\"username\", response.getPrincipal());\n+                        builder.field(\"realm\", response.getRealm());\n+                        builder.field(\"access_token\", response.getTokenString());\n+                        builder.field(\"refresh_token\", response.getRefreshToken());\n+                        builder.field(\"expires_in\", response.getExpiresIn().seconds());\n+                        builder.field(\"authentication\", response.getAuthentication());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "49fbded29957b7cfa8c1b738289f6b28c058af5d"}, "originalPosition": 17}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4530, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}