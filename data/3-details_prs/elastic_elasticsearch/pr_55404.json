{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA1MTczODE0", "number": 55404, "title": "Remove ban tasks with the current thread context", "bodyText": "[2020-04-07T05:23:07,037][WARN ][o.e.x.s.a.AuthorizationService] [v8.0.0-1] denying access as action [internal:admin/tasks/ban] is not an index or cluster action\n\nThis warning is for an unban request, not a ban request as we do not have a corresponding log in TransportCancelTasksAction.\nIf we start unbanning when the last child task completed and that child task executed with a specific user, then unban requests are denied because internal requests can't run with a user. We need to remove bans with the current thread context.\nLabelled this non-issue for an unreleased bug.", "createdAt": "2020-04-17T14:42:41Z", "url": "https://github.com/elastic/elasticsearch/pull/55404", "merged": true, "mergeCommit": {"oid": "9a8aa92a047d4b285fdd0ec79cecc18b8d4a2d46"}, "closed": true, "closedAt": "2020-04-17T16:40:33Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYh6r9AH2gAyNDA1MTczODE0OmM1Y2NlM2JhNDhhY2Y0NzZhNWU1OGVmNTRmMTZlMTAxM2YzNDRlNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYjJJcAH2gAyNDA1MTczODE0OmI3MTQwYzAxMjI5MmJmY2IxZTcwZmZhNzUyMDg2OGUyNWU4NTc2M2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c5cce3ba48acf476a5e58ef54f16e1013f344e5c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5cce3ba48acf476a5e58ef54f16e1013f344e5c", "committedDate": "2020-04-17T14:11:14Z", "message": "Remove ban tasks using the current thread context"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NTMxNTg3", "url": "https://github.com/elastic/elasticsearch/pull/55404#pullrequestreview-395531587", "createdAt": "2020-04-17T15:00:52Z", "commit": {"oid": "c5cce3ba48acf476a5e58ef54f16e1013f344e5c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTowMDo1MlrOGHRlhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNTowMDo1MlrOGHRlhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDI4MTM1MA==", "bodyText": "can you add a comment saying why this is necessary?", "url": "https://github.com/elastic/elasticsearch/pull/55404#discussion_r410281350", "createdAt": "2020-04-17T15:00:52Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/tasks/cancel/TransportCancelTasksAction.java", "diffHunk": "@@ -121,8 +123,10 @@ void cancelTaskAndDescendants(CancellableTask task, String reason, boolean waitF\n             StepListener<Void> banOnNodesListener = new StepListener<>();\n             setBanOnNodes(reason, waitForCompletion, task, childrenNodes, banOnNodesListener);\n             banOnNodesListener.whenComplete(groupedListener::onResponse, groupedListener::onFailure);\n+            final Runnable removeBansRunnable = transportService.getThreadPool().getThreadContext()\n+                .preserveContext(() -> removeBanOnNodes(task, childrenNodes));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c5cce3ba48acf476a5e58ef54f16e1013f344e5c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7140c012292bfcb1e70ffa7520868e25e85763b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7140c012292bfcb1e70ffa7520868e25e85763b", "committedDate": "2020-04-17T15:36:56Z", "message": "add comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3287, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}