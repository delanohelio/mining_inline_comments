{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5NjQyODk5", "number": 66268, "title": "QL: Verify filter's condition type", "bodyText": "This adds a check in the verifier to check if filter's condition is of a\nboolean type and fail the request otherwise.\nCloses #66254.", "createdAt": "2020-12-14T16:24:46Z", "url": "https://github.com/elastic/elasticsearch/pull/66268", "merged": true, "mergeCommit": {"oid": "3aec1a3d99a3f4650ec8be014a97106320f0874a"}, "closed": true, "closedAt": "2020-12-15T18:47:11Z", "author": {"login": "bpintea"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmIH_2AH2gAyNTM5NjQyODk5OjZhMjQzMjM5YWY2NGYzZTk3NWE2NjE3NDVhMmQwYTZmMmEyNDBkMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmdMCQgFqTU1MjY1ODM2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6a243239af64f3e975a661745a2d0a6f2a240d08", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a243239af64f3e975a661745a2d0a6f2a240d08", "committedDate": "2020-12-14T16:14:20Z", "message": "Verify filter's condition type\n\nThis adds a check in the verifier to check if filter's condition is of a\nboolean type and fail the request otherwise."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/e91fd4b80d5be5c2ce665836b985ae1b35846c4d", "committedDate": "2020-12-14T16:52:47Z", "message": "Fix: check type resolution before type's val\n\nMake sure a fields's type is available before checking it's value."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNjMwODA4", "url": "https://github.com/elastic/elasticsearch/pull/66268#pullrequestreview-551630808", "createdAt": "2020-12-14T17:05:44Z", "commit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNzowNTo0NVrOIFatYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNzowOTowOFrOIFa3pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU1MTM5Mw==", "bodyText": "Filtering only works on bool hence why I recommend renaming it to checkFilterConditionType", "url": "https://github.com/elastic/elasticsearch/pull/66268#discussion_r542551393", "createdAt": "2020-12-14T17:05:45Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -626,6 +628,15 @@ private static boolean checkGroupMatch(Expression e, Node<?> source, List<Expres\n         return false;\n     }\n \n+    private static void checkBooleanFiltering(LogicalPlan p, Set<Failure> localFailures) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU1MTkzNA==", "bodyText": "No need to check if the condition is resolved, this has already been checked before - these checks get applied only if the plan is fully resolved.", "url": "https://github.com/elastic/elasticsearch/pull/66268#discussion_r542551934", "createdAt": "2020-12-14T17:06:31Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -626,6 +628,15 @@ private static boolean checkGroupMatch(Expression e, Node<?> source, List<Expres\n         return false;\n     }\n \n+    private static void checkBooleanFiltering(LogicalPlan p, Set<Failure> localFailures) {\n+        if (p instanceof Filter) {\n+            Expression condition = ((Filter) p).condition();\n+            if (condition.resolved() && condition.dataType() != BOOLEAN) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU1NDAyMg==", "bodyText": "Maybe Condition expression needs to be boolean, found [{}]. Remove the notion of filter which is not something the user declares.", "url": "https://github.com/elastic/elasticsearch/pull/66268#discussion_r542554022", "createdAt": "2020-12-14T17:09:08Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -626,6 +628,15 @@ private static boolean checkGroupMatch(Expression e, Node<?> source, List<Expres\n         return false;\n     }\n \n+    private static void checkBooleanFiltering(LogicalPlan p, Set<Failure> localFailures) {\n+        if (p instanceof Filter) {\n+            Expression condition = ((Filter) p).condition();\n+            if (condition.resolved() && condition.dataType() != BOOLEAN) {\n+                localFailures.add(fail(condition, \"Cannot filter by non-boolean expression of type [{}]\", condition.dataType()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNjc2NDYy", "url": "https://github.com/elastic/elasticsearch/pull/66268#pullrequestreview-551676462", "createdAt": "2020-12-14T17:29:04Z", "commit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNzoyOTowNVrOIFbyYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNzoyOTowNVrOIFbyYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU2OTA1OQ==", "bodyText": "\ud83d\udc4d  for this test case.\nWhat about covering the simplest case (WHERE boolField) specifically too? The reason: the test case above gets translated into a script query, while the WHERE boolField into a terms query, and while there are plenty of test cases that test the script query, I don't think we have any that tests querying a bool field directly. Note: This would require adding a new field to the test dataset with bool type though.", "url": "https://github.com/elastic/elasticsearch/pull/66268#discussion_r542569059", "createdAt": "2020-12-14T17:29:05Z", "author": {"login": "palesz"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/conditionals.csv-spec", "diffHunk": "@@ -326,6 +326,23 @@ Pettey\n Heyers\n ;\n \n+iifConditionWhere\n+SELECT last_name FROM test_emp WHERE IIF(LENGTH(last_name) < 7, true, false) LIMIT 10;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNzI2MjQy", "url": "https://github.com/elastic/elasticsearch/pull/66268#pullrequestreview-551726242", "createdAt": "2020-12-14T17:55:47Z", "commit": {"oid": "e91fd4b80d5be5c2ce665836b985ae1b35846c4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "807b1f047324de09adc27c383085f011e4f1bab7", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/807b1f047324de09adc27c383085f011e4f1bab7", "committedDate": "2020-12-14T19:25:20Z", "message": "Adress review comments\n\n- remove superfluous resolution check.\n- rename a method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96db9546ee7fa927ad843a5b5e55e159204c630c", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/96db9546ee7fa927ad843a5b5e55e159204c630c", "committedDate": "2020-12-15T09:30:48Z", "message": "Extract common SQL-EQL verifier code into class\n\nMove checkFilterConditionType() into it's own QL class, VerifierChecks."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMjczOTUw", "url": "https://github.com/elastic/elasticsearch/pull/66268#pullrequestreview-552273950", "createdAt": "2020-12-15T09:48:03Z", "commit": {"oid": "807b1f047324de09adc27c383085f011e4f1bab7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4b8c17c7653bc73ffeb88ed73595a719cb7210b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4b8c17c7653bc73ffeb88ed73595a719cb7210b", "committedDate": "2020-12-15T14:29:50Z", "message": "Merge branch 'master' into feat/verify_non_boolean_cond"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "640ce29879b59d1fac2306d95723456877276296", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/640ce29879b59d1fac2306d95723456877276296", "committedDate": "2020-12-15T15:17:08Z", "message": "Remove now obsolete test\n\nRemove now obsolete test."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjU4MzY1", "url": "https://github.com/elastic/elasticsearch/pull/66268#pullrequestreview-552658365", "createdAt": "2020-12-15T16:46:45Z", "commit": {"oid": "640ce29879b59d1fac2306d95723456877276296"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4627, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}