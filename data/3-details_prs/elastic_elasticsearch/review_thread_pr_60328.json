{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTY3ODU0", "number": 60328, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NDoxNVrOES8NCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NTowN1rOES8OVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk2MjAxOnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NDoxNlrOG4Zu8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTo0NDoyNVrOG4b7Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng==", "bodyText": "I wonder if we should use the formatted version in the sort output ? We don't allow this format (nanoseconds since epoch) when ingesting or querying a date_nanos field so that's an exception here.", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795056", "createdAt": "2020-07-28T18:44:16Z", "author": {"login": "jimczi"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwOTU3Mg==", "bodyText": "I'm honestly not sure! I kind of figured the contact of search_after was \"take the last sort value and stick it into search_after\" but I see that we support formatted.\nI also wonder what counts as breaking here. If we were to change the result to be formatted I imagine we'll break someone.", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461809572", "createdAt": "2020-07-28T19:10:07Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyMDgwNg==", "bodyText": "We do support formatted output so my point was that the sort section should return the formatted version in  order to avoid returning long that represents nanoseconds since epoch. I agree that this is not in the scope of this change so let's merge this one and we can discuss the formatting of sort values in a follow up (I can open the issue) ?", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461820806", "createdAt": "2020-07-28T19:29:27Z", "author": {"login": "jimczi"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMDk5MQ==", "bodyText": "I agree that this is not in the scope of this change so let's merge this one and we can discuss the formatting of sort values in a follow up (I can open the issue) ?\n\n\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461830991", "createdAt": "2020-07-28T19:44:25Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng=="}, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk2NTM0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NTowOFrOG4Zw5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NTowOFrOG4Zw5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTU1OA==", "bodyText": "nit: because lots of ...", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795558", "createdAt": "2020-07-28T18:45:08Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -440,6 +440,7 @@ public DocValueFormat docValueFormat(@Nullable String format, ZoneId timeZone) {\n             }\n             // the resolution here is always set to milliseconds, as aggregations use this formatter mainly and those are always in\n             // milliseconds. The only special case here is docvalue fields, which are handled somewhere else\n+            // TODO maybe aggs should force millis because lot so of other places want nanos?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2787, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}