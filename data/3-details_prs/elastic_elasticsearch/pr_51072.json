{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMzU0MDkx", "number": 51072, "title": "[Transform] Improve force stop robustness in case of an error", "bodyText": "If a transform config got lost (e.g. because the internal index disappeared) tasks could not be stopped using transform API. This change makes it possible to stop transforms without a config, meaning to remove the background task. In order to do so force must be set to true.", "createdAt": "2020-01-15T21:50:19Z", "url": "https://github.com/elastic/elasticsearch/pull/51072", "merged": true, "mergeCommit": {"oid": "605620ca688fdbe30d644fc877450b19052ae2de"}, "closed": true, "closedAt": "2020-01-17T06:40:03Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6rEOQAH2gAyMzYzMzU0MDkxOmRkZTg4MGEyM2U4NmE5NjY1MzRlYzYzZmM1MDIwNTM0NTg3NGRmODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb67jv9gFqTM0Mzk4MDI1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dde880a23e86a966534ec63fc50205345874df83", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/dde880a23e86a966534ec63fc50205345874df83", "committedDate": "2020-01-15T19:53:04Z", "message": "make it possible to stop dangling transforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/77df1c75c3edcef04fe723e1266a82f3522efe5a", "committedDate": "2020-01-15T21:36:34Z", "message": "test task removal after internal index deletion"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNzkwNzE2", "url": "https://github.com/elastic/elasticsearch/pull/51072#pullrequestreview-343790716", "createdAt": "2020-01-16T09:54:46Z", "commit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTo1NDo0NlrOFeTuuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDowNTowOVrOFeUDCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyNDg1Ng==", "bodyText": "I wonder if we dangling is a bit vague here for users. Should we rephrase to Detected transforms [{0}] without matching configs?", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367324856", "createdAt": "2020-01-16T09:54:46Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/TransformMessages.java", "diffHunk": "@@ -17,6 +17,7 @@\n             \"Interrupted while waiting for transform [{0}] to stop\";\n     public static final String REST_PUT_TRANSFORM_EXISTS = \"Transform with id [{0}] already exists\";\n     public static final String REST_UNKNOWN_TRANSFORM = \"Transform with id [{0}] could not be found\";\n+    public static final String REST_STOP_TRANSFORM_WITHOUT_CONFIG = \"Detected dangling transforms [{0}]. Use force to stop/delete them.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ==", "bodyText": "Could transformId be \"foo-*\"? If yes, then this is not going to work.", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367328011", "createdAt": "2020-01-16T10:00:54Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -127,6 +134,25 @@ static void validateTaskState(ClusterState state, List<String> transformIds, boo\n         }\n     }\n \n+    static Tuple<Set<String>, Set<String>> findTasksWithoutConfig(ClusterState state, String transformId) {\n+        PersistentTasksCustomMetaData tasks = state.metaData().custom(PersistentTasksCustomMetaData.TYPE);\n+\n+        Set<String> taskIds = new HashSet<>();\n+        Set<String> executorNodes = new HashSet<>();\n+\n+        Predicate<PersistentTask<?>> taskMatcher = Strings.isAllOrWildcard(new String[] { transformId }) ? t -> true : t -> {\n+            TransformTaskParams transformParams = (TransformTaskParams) t.getParams();\n+            return transformParams.getId().equals(transformId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMDA1OA==", "bodyText": "Rename to runningTasksAndNodes? Just so it's clear what's what when we later get each part of the tuple.", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367330058", "createdAt": "2020-01-16T10:05:09Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -160,7 +186,31 @@ protected void doExecute(Task task, Request request, ActionListener<Response> li\n                     request.setExpandedIds(new HashSet<>(hitsAndIds.v2()));\n                     request.setNodes(TransformNodes.transformTaskNodes(hitsAndIds.v2(), state));\n                     super.doExecute(task, request, finalListener);\n-                }, listener::onFailure)\n+                }, e -> {\n+                    if (e instanceof ResourceNotFoundException) {\n+                        Tuple<Set<String>, Set<String>> runningTasks = findTasksWithoutConfig(state, request.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "557b0bef5f73b1cc328473314b7bc52f48b91390", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/557b0bef5f73b1cc328473314b7bc52f48b91390", "committedDate": "2020-01-16T12:44:05Z", "message": "apply review suggestions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzOTgwMjU2", "url": "https://github.com/elastic/elasticsearch/pull/51072#pullrequestreview-343980256", "createdAt": "2020-01-16T15:05:59Z", "commit": {"oid": "557b0bef5f73b1cc328473314b7bc52f48b91390"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3127, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}