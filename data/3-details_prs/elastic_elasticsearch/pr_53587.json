{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5MTIxMTc2", "number": 53587, "title": "Delete empty .ml-state* indices during nightly maintenance task.", "bodyText": "This PR adds a new remover class for removing the whole .ml-state* indices provided that they do not contain any documents and are not pointed by the current write alias (.ml-state-write).\nRelates #29938", "createdAt": "2020-03-16T10:09:25Z", "url": "https://github.com/elastic/elasticsearch/pull/53587", "merged": true, "mergeCommit": {"oid": "bb582f1317f1e76ee36bd862c3e46ee1a9ee9f7e"}, "closed": true, "closedAt": "2020-03-20T10:29:46Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcON30AgBqjMxMzMxMTE2ODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPdCyJAH2gAyMzg5MTIxMTc2OjQ3ODJhOWQ4MjdiOTI5YTFiYzM2MjFiYzg5YmMwZGQ4NzFkMDk5YjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "27de9272bbbebe7a61139b933c6fdbb6969824ca", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/27de9272bbbebe7a61139b933c6fdbb6969824ca", "committedDate": "2020-03-16T07:26:15Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "2faf6ced0acfdf935b19fd8f3150d940b740bc82", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2faf6ced0acfdf935b19fd8f3150d940b740bc82", "committedDate": "2020-03-16T13:10:32Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2faf6ced0acfdf935b19fd8f3150d940b740bc82", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2faf6ced0acfdf935b19fd8f3150d940b740bc82", "committedDate": "2020-03-16T13:10:32Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "fb39294a08588dd3d6c855b059e20b3eb9d5d570", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb39294a08588dd3d6c855b059e20b3eb9d5d570", "committedDate": "2020-03-17T10:56:55Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fb39294a08588dd3d6c855b059e20b3eb9d5d570", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb39294a08588dd3d6c855b059e20b3eb9d5d570", "committedDate": "2020-03-17T10:56:55Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "d70324c272fad2ee6d42fce2b4506238c218a160", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d70324c272fad2ee6d42fce2b4506238c218a160", "committedDate": "2020-03-17T11:14:25Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d70324c272fad2ee6d42fce2b4506238c218a160", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d70324c272fad2ee6d42fce2b4506238c218a160", "committedDate": "2020-03-17T11:14:25Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "030d4d4cfe3587187de4e4a3359c9a876b92d96c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/030d4d4cfe3587187de4e4a3359c9a876b92d96c", "committedDate": "2020-03-17T12:03:13Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "030d4d4cfe3587187de4e4a3359c9a876b92d96c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/030d4d4cfe3587187de4e4a3359c9a876b92d96c", "committedDate": "2020-03-17T12:03:13Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "589db76b94f2fdf7a62effc978ed452e7255a377", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/589db76b94f2fdf7a62effc978ed452e7255a377", "committedDate": "2020-03-18T08:30:23Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODIyMjMx", "url": "https://github.com/elastic/elasticsearch/pull/53587#pullrequestreview-377822231", "createdAt": "2020-03-19T15:18:16Z", "commit": {"oid": "589db76b94f2fdf7a62effc978ed452e7255a377"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNToxODoxNlrOF4zXcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xOVQxNToxODoxNlrOF4zXcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTEwNjE2Mg==", "bodyText": "I think we can request here indices that match the write alias. Then we don't need to filter them as it will just return indices that have the alias.", "url": "https://github.com/elastic/elasticsearch/pull/53587#discussion_r395106162", "createdAt": "2020-03-19T15:18:16Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/EmptyStateIndexRemover.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.ml.job.retention;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.admin.indices.delete.DeleteIndexRequest;\n+import org.elasticsearch.action.admin.indices.get.GetIndexRequest;\n+import org.elasticsearch.action.admin.indices.get.GetIndexResponse;\n+import org.elasticsearch.action.admin.indices.stats.IndexStats;\n+import org.elasticsearch.action.admin.indices.stats.IndicesStatsRequest;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.common.util.set.Sets;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndex;\n+\n+import java.util.HashSet;\n+import java.util.Objects;\n+import java.util.Set;\n+import java.util.function.Supplier;\n+\n+import static java.util.stream.Collectors.toSet;\n+\n+/**\n+ * This class deletes empty indices matching .ml-state* pattern that are not pointed at by the .ml-state-write alias.\n+ */\n+public class EmptyStateIndexRemover implements MlDataRemover {\n+    \n+    private final OriginSettingClient client;\n+\n+    public EmptyStateIndexRemover(OriginSettingClient client) {\n+        this.client = Objects.requireNonNull(client);\n+    }\n+\n+    @Override\n+    public void remove(ActionListener<Boolean> listener, Supplier<Boolean> isTimedOutSupplier) {\n+        try {\n+            if (isTimedOutSupplier.get()) {\n+                listener.onResponse(false);\n+                return;\n+            }\n+            getEmptyStateIndices(\n+                ActionListener.wrap(\n+                    emptyStateIndices -> {\n+                        if (emptyStateIndices.isEmpty()) {\n+                            listener.onResponse(true);\n+                            return;\n+                        }\n+                        getCurrentStateIndices(\n+                            ActionListener.wrap(\n+                                currentStateIndices -> {\n+                                    Set<String> stateIndicesToRemove = Sets.difference(emptyStateIndices, currentStateIndices);\n+                                    executeDeleteEmptyStateIndices(stateIndicesToRemove, listener);\n+                                },\n+                                listener::onFailure\n+                            )\n+                        );\n+                    },\n+                    listener::onFailure\n+                )\n+            );\n+        } catch (Exception e) {\n+            listener.onFailure(e);\n+        }\n+    }\n+\n+    private void getEmptyStateIndices(ActionListener<Set<String>> listener) {\n+        IndicesStatsRequest indicesStatsRequest = new IndicesStatsRequest().indices(AnomalyDetectorsIndex.jobStateIndexPattern());\n+        client.admin().indices().stats(\n+            indicesStatsRequest,\n+            ActionListener.wrap(\n+                indicesStatsResponse -> {\n+                    Set<String> emptyStateIndices =\n+                        indicesStatsResponse.getIndices().values().stream()\n+                            .filter(stats -> stats.getTotal().getDocs().getCount() == 0)\n+                            .map(IndexStats::getIndex)\n+                            .collect(toSet());\n+                    listener.onResponse(emptyStateIndices);\n+                },\n+                listener::onFailure\n+            )\n+        );\n+    }\n+\n+    private void getCurrentStateIndices(ActionListener<Set<String>> listener) {\n+        GetIndexRequest getIndexRequest = new GetIndexRequest().indices(AnomalyDetectorsIndex.jobStateIndexPattern());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "589db76b94f2fdf7a62effc978ed452e7255a377"}, "originalPosition": 87}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "589db76b94f2fdf7a62effc978ed452e7255a377", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/589db76b94f2fdf7a62effc978ed452e7255a377", "committedDate": "2020-03-18T08:30:23Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}, "afterCommit": {"oid": "e6f7543df52e28e8957831fdb58ebb821ce9414c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6f7543df52e28e8957831fdb58ebb821ce9414c", "committedDate": "2020-03-19T16:01:56Z", "message": "Apply review comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3ODY4OTAz", "url": "https://github.com/elastic/elasticsearch/pull/53587#pullrequestreview-377868903", "createdAt": "2020-03-19T16:06:58Z", "commit": {"oid": "e6f7543df52e28e8957831fdb58ebb821ce9414c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfb25178ff0fbf1754d48da8f439c62af913b25c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfb25178ff0fbf1754d48da8f439c62af913b25c", "committedDate": "2020-03-20T07:56:07Z", "message": "Delete empty .ml-state* indices during daily maintenance task."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40df603485f3bbbfc27a947595fa300550c448be", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/40df603485f3bbbfc27a947595fa300550c448be", "committedDate": "2020-03-20T07:56:07Z", "message": "Apply review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e6f7543df52e28e8957831fdb58ebb821ce9414c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6f7543df52e28e8957831fdb58ebb821ce9414c", "committedDate": "2020-03-19T16:01:56Z", "message": "Apply review comment"}, "afterCommit": {"oid": "40df603485f3bbbfc27a947595fa300550c448be", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/40df603485f3bbbfc27a947595fa300550c448be", "committedDate": "2020-03-20T07:56:07Z", "message": "Apply review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4782a9d827b929a1bc3621bc89bc0dd871d099b4", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/4782a9d827b929a1bc3621bc89bc0dd871d099b4", "committedDate": "2020-03-20T09:25:14Z", "message": "Do not invoke Delete API when there are no indices to delete"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1436, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}