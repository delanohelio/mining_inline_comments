{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMTMzMDgy", "number": 54866, "title": "Add Snapshot Resiliency Test for Master Failover during Delete", "bodyText": "We only have very indirect coverage of master failovers during snaphot delete\nat the moment. This comment adds a direct test of this scenario and also\nan assertion that makes sure we are not leaking any snapshot completion listeners\nin the snapshots service in this scenario.\nThis gives us better coverage of scenarios like #54256 and makes the diff\nto the upcoming more consistent snapshot delete implementation in #54705\nsmaller.", "createdAt": "2020-04-07T08:56:53Z", "url": "https://github.com/elastic/elasticsearch/pull/54866", "merged": true, "mergeCommit": {"oid": "db04fd2a86afea568289f35371461069def4d598"}, "closed": true, "closedAt": "2020-04-08T17:36:19Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVPXFegH2gAyNDAwMTMzMDgyOjdjMzRiMzdiMTFhZWMxOTc4OTU5NzEzZWUxMzE1MzQxYmUxNzE0MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVq2HmgH2gAyNDAwMTMzMDgyOjBlM2YzZWJiYjc0MmI4YmMxNDUxOTJjNmQzYTJmNDhmMWE0M2Y3NWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7c34b37b11aec1978959713ee1315341be171425", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c34b37b11aec1978959713ee1315341be171425", "committedDate": "2020-04-07T08:52:17Z", "message": "Add Snapshot Resiliency Test for Master Failover during Delete\n\nWe only have very indirect coverage of master failovers during snaphot delete\nat the moment. This comment adds a direct test of this scenario and also\nan assertion that makes sure we are not leaking any snapshot completion listeners\nin the snapshots service in this scenario.\n\nThis gives us better coverage of scenarios like #54256 and makes the diff\nto the upcoming more consistent snapshot delete implementation in #54705\nsmaller."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MTUzNjk0", "url": "https://github.com/elastic/elasticsearch/pull/54866#pullrequestreview-389153694", "createdAt": "2020-04-07T14:09:13Z", "commit": {"oid": "7c34b37b11aec1978959713ee1315341be171425"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDowOToxNFrOGCFX9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNDowOToxNFrOGCFX9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDgzODM5MQ==", "bodyText": "Shouldn't it be always hasSize(0) when waitForSnapshot is true?", "url": "https://github.com/elastic/elasticsearch/pull/54866#discussion_r404838391", "createdAt": "2020-04-07T14:09:14Z", "author": {"login": "tlrx"}, "path": "server/src/test/java/org/elasticsearch/snapshots/SnapshotResiliencyTests.java", "diffHunk": "@@ -407,6 +408,49 @@ public void testSnapshotWithNodeDisconnects() {\n         assertThat(snapshotIds, hasSize(1));\n     }\n \n+    public void testSnapshotDeleteWithMasterFailOvers() {\n+        final int dataNodes = randomIntBetween(2, 10);\n+        final int masterNodes = randomFrom(3, 5);\n+        setupTestCluster(masterNodes, dataNodes);\n+\n+        String repoName = \"repo\";\n+        String snapshotName = \"snapshot\";\n+        final String index = \"test\";\n+        final int shards = randomIntBetween(1, 10);\n+\n+        final boolean waitForSnapshot = randomBoolean();\n+        final StepListener<CreateSnapshotResponse> createSnapshotResponseStepListener = new StepListener<>();\n+        continueOrDie(createRepoAndIndex(repoName, index, shards), createIndexResponse ->\n+            testClusterNodes.randomMasterNodeSafe().client.admin().cluster().prepareCreateSnapshot(repoName, snapshotName)\n+                .setWaitForCompletion(waitForSnapshot).execute(createSnapshotResponseStepListener));\n+\n+        final AtomicBoolean snapshotDeleteResponded = new AtomicBoolean(false);\n+        continueOrDie(createSnapshotResponseStepListener, createSnapshotResponse -> {\n+            scheduleNow(this::disconnectOrRestartMasterNode);\n+            testClusterNodes.randomDataNodeSafe().client.admin().cluster()\n+                .prepareDeleteSnapshot(repoName, snapshotName).execute(ActionListener.wrap(() -> snapshotDeleteResponded.set(true)));\n+        });\n+\n+        runUntil(() -> testClusterNodes.randomMasterNode().map(master -> {\n+            if (snapshotDeleteResponded.get() == false) {\n+                return false;\n+            }\n+            final SnapshotDeletionsInProgress snapshotDeletionsInProgress =\n+                master.clusterService.state().custom(SnapshotDeletionsInProgress.TYPE);\n+            return snapshotDeletionsInProgress == null || snapshotDeletionsInProgress.getEntries().isEmpty();\n+        }).orElse(false), TimeUnit.MINUTES.toMillis(1L));\n+\n+        clearDisruptionsAndAwaitSync();\n+\n+        final TestClusterNodes.TestClusterNode randomMaster = testClusterNodes.randomMasterNode()\n+            .orElseThrow(() -> new AssertionError(\"expected to find at least one active master node\"));\n+        SnapshotsInProgress finalSnapshotsInProgress = randomMaster.clusterService.state().custom(SnapshotsInProgress.TYPE);\n+        assertThat(finalSnapshotsInProgress.entries(), empty());\n+        final Repository repository = randomMaster.repositoriesService.repository(repoName);\n+        Collection<SnapshotId> snapshotIds = getRepositoryData(repository).getSnapshotIds();\n+        assertThat(snapshotIds, either(hasSize(1)).or(hasSize(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c34b37b11aec1978959713ee1315341be171425"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c88dff7ce779351c2c0a8e427118584e01373be5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c88dff7ce779351c2c0a8e427118584e01373be5", "committedDate": "2020-04-07T14:09:51Z", "message": "Merge remote-tracking branch 'elastic/master' into add-snapshot-delete-master-failover-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ca65174b3f0b132921619666d4dc42f17a45fac", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ca65174b3f0b132921619666d4dc42f17a45fac", "committedDate": "2020-04-07T14:41:38Z", "message": "tricky business"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50088b6622cc1df39b03632f436ab3f5ab91647d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/50088b6622cc1df39b03632f436ab3f5ab91647d", "committedDate": "2020-04-07T16:07:18Z", "message": "We never leave any snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MjczMTA3", "url": "https://github.com/elastic/elasticsearch/pull/54866#pullrequestreview-389273107", "createdAt": "2020-04-07T16:10:45Z", "commit": {"oid": "50088b6622cc1df39b03632f436ab3f5ab91647d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoxMDo0NlrOGCLLAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNjoxMDo0NlrOGCLLAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDkzMzM3Nw==", "bodyText": "I'm investigating why this is taking so long, until then upping the value here to because even though I found a seed that fails here now I bet there's one where this could fail in one of the other master failover tests.", "url": "https://github.com/elastic/elasticsearch/pull/54866#discussion_r404933377", "createdAt": "2020-04-07T16:10:46Z", "author": {"login": "original-brownbear"}, "path": "server/src/test/java/org/elasticsearch/snapshots/SnapshotResiliencyTests.java", "diffHunk": "@@ -266,7 +267,7 @@ public void verifyReposThenStopServices() {\n             final AtomicBoolean cleanedUp = new AtomicBoolean(false);\n             continueOrDie(cleanupResponse, r -> cleanedUp.set(true));\n \n-            runUntil(cleanedUp::get, TimeUnit.MINUTES.toMillis(1L));\n+            runUntil(cleanedUp::get, TimeUnit.MINUTES.toMillis(5L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50088b6622cc1df39b03632f436ab3f5ab91647d"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7444b3e0a75b7be6dae254f6b47f2e7bf71e631", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7444b3e0a75b7be6dae254f6b47f2e7bf71e631", "committedDate": "2020-04-08T09:21:20Z", "message": "Merge remote-tracking branch 'elastic/master' into add-snapshot-delete-master-failover-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3370c84c53249d81414e2ee29900d6537e7b713a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3370c84c53249d81414e2ee29900d6537e7b713a", "committedDate": "2020-04-08T12:48:54Z", "message": "start node connections service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMDcwMDAw", "url": "https://github.com/elastic/elasticsearch/pull/54866#pullrequestreview-390070000", "createdAt": "2020-04-08T15:12:11Z", "commit": {"oid": "3370c84c53249d81414e2ee29900d6537e7b713a"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNToxMjoxMVrOGCz4Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNToxNToyM1rOGC0Bog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMDMzMA==", "bodyText": "Should we also call close in the stop method?", "url": "https://github.com/elastic/elasticsearch/pull/54866#discussion_r405600330", "createdAt": "2020-04-08T15:12:11Z", "author": {"login": "ywelsch"}, "path": "server/src/test/java/org/elasticsearch/snapshots/SnapshotResiliencyTests.java", "diffHunk": "@@ -1477,10 +1525,9 @@ public void start(ClusterState initialState) {\n                     new BatchedRerouteService(clusterService, allocationService::reroute), ElectionStrategy.DEFAULT_INSTANCE);\n                 masterService.setClusterStatePublisher(coordinator);\n                 coordinator.start();\n-                masterService.start();\n-                clusterService.getClusterApplierService().setNodeConnectionsService(\n-                    new NodeConnectionsService(clusterService.getSettings(), threadPool, transportService));\n-                clusterService.getClusterApplierService().start();\n+                clusterService.getClusterApplierService().setNodeConnectionsService(nodeConnectionsService);\n+                nodeConnectionsService.start();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3370c84c53249d81414e2ee29900d6537e7b713a"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTYwMjcyMg==", "bodyText": "Failover", "url": "https://github.com/elastic/elasticsearch/pull/54866#discussion_r405602722", "createdAt": "2020-04-08T15:15:23Z", "author": {"login": "ywelsch"}, "path": "server/src/test/java/org/elasticsearch/snapshots/SnapshotResiliencyTests.java", "diffHunk": "@@ -407,6 +408,49 @@ public void testSnapshotWithNodeDisconnects() {\n         assertThat(snapshotIds, hasSize(1));\n     }\n \n+    public void testSnapshotDeleteWithMasterFailOvers() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3370c84c53249d81414e2ee29900d6537e7b713a"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9873a89895553aaa7a1c558e23e9017855c330ca", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9873a89895553aaa7a1c558e23e9017855c330ca", "committedDate": "2020-04-08T16:45:00Z", "message": "Merge remote-tracking branch 'elastic/master' into add-snapshot-delete-master-failover-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3f3ebbb742b8bc145192c6d3a2f48f1a43f75a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e3f3ebbb742b8bc145192c6d3a2f48f1a43f75a", "committedDate": "2020-04-08T16:53:37Z", "message": "CR comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3736, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}