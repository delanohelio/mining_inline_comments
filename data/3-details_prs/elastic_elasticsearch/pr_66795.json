{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTQ5MDkx", "number": 66795, "title": "Bust the request cache when the mapping changes (backport of #66295)", "bodyText": "This makes sure that we only serve a hit from the request cache if it\nwas build using the same mapping and that the same mapping is used for\nthe entire \"query phase\" of the search.\nCloses #62033", "createdAt": "2020-12-23T17:22:37Z", "url": "https://github.com/elastic/elasticsearch/pull/66795", "merged": true, "mergeCommit": {"oid": "2ebfe7d3b38e6317af9fd772a327867ddda2177c"}, "closed": true, "closedAt": "2020-12-23T20:46:46Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdpAsoogH2gAyNTQ0OTQ5MDkxOmE0ZTEwYTIyOGE4OTYzZTkxY2U4Mzg4NTA3OWRjMWE1NmU5M2ZiZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdpEpp_gH2gAyNTQ0OTQ5MDkxOjE4Zjk3YTQxNWJjZDUxYjg5ZWVkNzgwZTkyOGIzMzdhYzllZWE2N2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a4e10a228a8963e91ce83885079dc1a56e93fbfb", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4e10a228a8963e91ce83885079dc1a56e93fbfb", "committedDate": "2020-12-23T15:16:53Z", "message": "Bust the request cache when the mapping changes (backport of #66295)\n\nThis makes sure that we only serve a hit from the request cache if it\nwas build using the same mapping and that the same mapping is used for\nthe entire \"query phase\" of the search.\n\nCloses #62033"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30a14587a447ce4ed915cdad5c7f0c04c7161d6b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/30a14587a447ce4ed915cdad5c7f0c04c7161d6b", "committedDate": "2020-12-23T16:09:24Z", "message": "Fixup type query"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a89ad3c901fec1ca29f445b4828b309c32a2c548", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a89ad3c901fec1ca29f445b4828b309c32a2c548", "committedDate": "2020-12-23T16:34:29Z", "message": "Add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf788d34c558904146ec60178d5632b8e749a485", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf788d34c558904146ec60178d5632b8e749a485", "committedDate": "2020-12-23T17:23:10Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c", "committedDate": "2020-12-23T17:24:27Z", "message": "Typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc596c56ebb140ea79227630c1fcc32822476b94", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc596c56ebb140ea79227630c1fcc32822476b94", "committedDate": "2020-12-23T18:26:21Z", "message": "Merge branch '7.x' into cache_bust_take_two_7_x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MTY4OTYx", "url": "https://github.com/elastic/elasticsearch/pull/66795#pullrequestreview-558168961", "createdAt": "2020-12-23T18:41:13Z", "commit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo0MToxM1rOIKvGKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo0MToxM1rOIKvGKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ==", "bodyText": "If there is a default mapping, this call mapperService.documentMapper(type) returns a non-null mapper for the _default_ type. So this refactor may change the type query behavior slightly. This seems acceptable since default mappings were deprecated in 6.0 and the type query isn't completely clear on this behavior, but it felt worth pointing out.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548128299", "createdAt": "2020-12-23T18:41:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "originalPosition": 171}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a886b0449c2556eb20a43f741f0bd6d719cb33a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a886b0449c2556eb20a43f741f0bd6d719cb33a", "committedDate": "2020-12-23T18:53:31Z", "message": "Oh sneaky test, you relied on no snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b", "committedDate": "2020-12-23T19:18:20Z", "message": "Update skip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU4MTkxMzQw", "url": "https://github.com/elastic/elasticsearch/pull/66795#pullrequestreview-558191340", "createdAt": "2020-12-23T19:31:10Z", "commit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOTozMToxMFrOIKxd5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOTozMToxMFrOIKxd5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA==", "bodyText": "this threw me off: how can typeExists be replaced with an equality check?", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548167140", "createdAt": "2020-12-23T19:31:10Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "diffHunk": "@@ -129,7 +129,7 @@ public String getWriteableName() {\n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n         deprecationLogger.deprecate(\"type_query\", TYPES_DEPRECATION_MESSAGE);\n-        if (context.typeExists(type)) {\n+        if (context.getType().equals(type)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18f97a415bcd51b89eed780e928b337ac9eea67e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/18f97a415bcd51b89eed780e928b337ac9eea67e", "committedDate": "2020-12-23T19:53:15Z", "message": "Drop query with type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4326, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}