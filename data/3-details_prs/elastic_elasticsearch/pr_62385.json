{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MzIyMDE5", "number": 62385, "title": "Fix failure in AppendProcessorTests.testAppendingToListWithDuplicatesDisallowed", "bodyText": "One of the test cases purported to test the appending of unique values to an existing list but the list of unique values to be appended was randomly generated and would occasionally contain values already in the list (see example test seed below). This fix ensures that the list of unique values never contains any values in the existing list.\nExample of a test seed that would fail:\n./gradlew ':modules:ingest-common:test' --tests \"org.elasticsearch.ingest.common.AppendProcessorTests.testAppendingToListWithDuplicatesDisallowed\" -Dtests.seed=AC5D435485DE7219", "createdAt": "2020-09-15T14:05:12Z", "url": "https://github.com/elastic/elasticsearch/pull/62385", "merged": true, "mergeCommit": {"oid": "03d0e191c684424f2b5c4eff71a31ee280004a4c"}, "closed": true, "closedAt": "2020-09-16T13:04:21Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJIRTxAH2gAyNDg3MzIyMDE5OjI2MGE2MWNmMTMxZTc2M2QxMmZmY2ZjOGNkMjJmZTdkYzVhZGM5YWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJKG0RgFqTQ4ODg0MzQzMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "260a61cf131e763d12ffcfc8cd22fe7dc5adc9ac", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/260a61cf131e763d12ffcfc8cd22fe7dc5adc9ac", "committedDate": "2020-09-15T14:00:42Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODI2NzYx", "url": "https://github.com/elastic/elasticsearch/pull/62385#pullrequestreview-488826761", "createdAt": "2020-09-15T15:50:36Z", "commit": {"oid": "260a61cf131e763d12ffcfc8cd22fe7dc5adc9ac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo1MDozNlrOHSIhhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxNTo1MDozNlrOHSIhhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODc3NjA2OA==", "bodyText": "This seems really confusing to me, I think we could do the same thing with:\nint nonexistingValueSize = randomIntBetween(0, 10);\n// generate n new values\nSet<String> newValues = Stream.generate(() -> randomAlphaOfLengthBetween(1, 10)).limit(nonexistingValueSize).collect(Collectors.toSet());\n// create a set using the new values, making sure there are no overlapping values already present in the existing values\nSet<String> nonexistingValues = Sets.difference(newValues, new HashSet<>(existingValues));\nUsing the while loop for this is a bit overkill, I think Sets makes it easier to avoid duplicates", "url": "https://github.com/elastic/elasticsearch/pull/62385#discussion_r488776068", "createdAt": "2020-09-15T15:50:36Z", "author": {"login": "dakrone"}, "path": "modules/ingest-common/src/test/java/org/elasticsearch/ingest/common/AppendProcessorTests.java", "diffHunk": "@@ -198,14 +198,21 @@ public void testAppendingToListWithDuplicatesDisallowed() throws Exception {\n         String originalField = RandomDocumentPicks.addRandomField(random(), ingestDocument, list);\n         List<String> expectedValues = new ArrayList<>(list);\n         List<String> existingValues = randomSubsetOf(list);\n-        int uniqueValuesSize = randomIntBetween(0, 10);\n-        List<String> uniqueValues = new ArrayList<>();\n-        for (int i = 0; i < uniqueValuesSize; i++) {\n-            uniqueValues.add(randomAlphaOfLengthBetween(1, 10));\n+        int nonexistingValuesSize = randomIntBetween(0, 10);\n+        List<String> nonexistingValues = new ArrayList<>();\n+        for (int i = 0; i < nonexistingValuesSize; i++) {\n+            boolean valueExists = true;\n+            while (valueExists) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260a61cf131e763d12ffcfc8cd22fe7dc5adc9ac"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34a9cf97c2041aae0815757b91224de1d654eb5a", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/34a9cf97c2041aae0815757b91224de1d654eb5a", "committedDate": "2020-09-15T16:04:01Z", "message": "simplify test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4ODQzNDMw", "url": "https://github.com/elastic/elasticsearch/pull/62385#pullrequestreview-488843430", "createdAt": "2020-09-15T16:09:03Z", "commit": {"oid": "34a9cf97c2041aae0815757b91224de1d654eb5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4458, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}