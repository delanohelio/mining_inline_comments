{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjA3MjQ5", "number": 50874, "title": "[ML][Inference] Adding classification_weights to ensemble models", "bodyText": "classification_weights are a way to allow models to\nprefer specific classification results over others\nthis might be advantageous if classification value\nprobabilities are a known quantity and can improve\nmodel error rates.", "createdAt": "2020-01-10T20:20:01Z", "url": "https://github.com/elastic/elasticsearch/pull/50874", "merged": true, "mergeCommit": {"oid": "f1eb3c3e84f5d6f9cf99775e284fd34df79ebfa4"}, "closed": true, "closedAt": "2020-01-14T16:32:19Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5EcNtgH2gAyMzYxNjA3MjQ5OjUzYmI5YmEwMWExMDhjMzNlYjRkM2VmODliZjUwMTUzMmYwZGM2NzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6S4bqAH2gAyMzYxNjA3MjQ5OjdlZTUxZDQ5NzA4MTA3ZDI0YWRjMmU5ZTBmZjBlNGVlYmZjYzQ5ZDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/53bb9ba01a108c33eb4d3ef89bf501532f0dc673", "committedDate": "2020-01-10T20:19:03Z", "message": "[ML][Inference] Adding classification_weights to ensemble models\n\nclassification_weights are a way to allow models to\nprefer specific classification results over others\nthis might be advantageous if classification value\nprobabilities are a known quantity and can improve\nmodel error rates."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTA4NTcw", "url": "https://github.com/elastic/elasticsearch/pull/50874#pullrequestreview-342508570", "createdAt": "2020-01-14T12:52:43Z", "commit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTEyMzYx", "url": "https://github.com/elastic/elasticsearch/pull/50874#pullrequestreview-342512361", "createdAt": "2020-01-14T12:59:38Z", "commit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxMjo1OTozOVrOFdWnIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxMzoxNTowNlrOFdXB0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMyMzQ4OA==", "bodyText": "I think it's better how it was before [{}]", "url": "https://github.com/elastic/elasticsearch/pull/50874#discussion_r366323488", "createdAt": "2020-01-14T12:59:39Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java", "diffHunk": "@@ -20,27 +21,40 @@\n \n     private InferenceHelpers() { }\n \n-    public static List<ClassificationInferenceResults.TopClassEntry> topClasses(List<Double> probabilities,\n-                                                                                List<String> classificationLabels,\n-                                                                                int numToInclude) {\n-        if (numToInclude == 0) {\n-            return Collections.emptyList();\n-        }\n-        int[] sortedIndices = IntStream.range(0, probabilities.size())\n-            .boxed()\n-            .sorted(Comparator.comparing(probabilities::get).reversed())\n-            .mapToInt(i -> i)\n-            .toArray();\n+    /**\n+     * @return Tuple of the highest scored index and the top classes\n+     */\n+    public static Tuple<Integer, List<ClassificationInferenceResults.TopClassEntry>> topClasses(List<Double> probabilities,\n+                                                                                                List<String> classificationLabels,\n+                                                                                                @Nullable double[] classificationWeights,\n+                                                                                                int numToInclude) {\n \n         if (classificationLabels != null && probabilities.size() != classificationLabels.size()) {\n             throw ExceptionsHelper\n                 .serverError(\n-                    \"model returned classification probabilities of size [{}] which is not equal to classification labels size [{}]\",\n+                    \"model returned classification probabilities of size [{}] which is not equal to classification labels size {}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMyOTExMw==", "bodyText": "Consider adding LANGUAGE_NAMES to toXContent and the parser. Tree includes the labels in its xcontent representation", "url": "https://github.com/elastic/elasticsearch/pull/50874#discussion_r366329113", "createdAt": "2020-01-14T13:12:26Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/langident/LangIdentNeuralNetwork.java", "diffHunk": "@@ -156,11 +146,6 @@ public TargetType targetType() {\n         return TargetType.CLASSIFICATION;\n     }\n \n-    @Override\n-    public List<String> classificationLabels() {\n-        return LANGUAGE_NAMES;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMzMDAyMA==", "bodyText": "Is there no test for this method?", "url": "https://github.com/elastic/elasticsearch/pull/50874#discussion_r366330020", "createdAt": "2020-01-14T13:14:25Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/InferenceHelpers.java", "diffHunk": "@@ -20,27 +21,40 @@\n \n     private InferenceHelpers() { }\n \n-    public static List<ClassificationInferenceResults.TopClassEntry> topClasses(List<Double> probabilities,\n-                                                                                List<String> classificationLabels,\n-                                                                                int numToInclude) {\n-        if (numToInclude == 0) {\n-            return Collections.emptyList();\n-        }\n-        int[] sortedIndices = IntStream.range(0, probabilities.size())\n-            .boxed()\n-            .sorted(Comparator.comparing(probabilities::get).reversed())\n-            .mapToInt(i -> i)\n-            .toArray();\n+    /**\n+     * @return Tuple of the highest scored index and the top classes\n+     */\n+    public static Tuple<Integer, List<ClassificationInferenceResults.TopClassEntry>> topClasses(List<Double> probabilities,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjMzMDMyMA==", "bodyText": "Both these methods are just not called anywhere? Is that why they are removed? If so \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/50874#discussion_r366330320", "createdAt": "2020-01-14T13:15:06Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/TrainedModel.java", "diffHunk": "@@ -6,21 +6,14 @@\n package org.elasticsearch.xpack.core.ml.inference.trainedmodel;\n \n import org.apache.lucene.util.Accountable;\n-import org.elasticsearch.common.Nullable;\n import org.elasticsearch.common.io.stream.NamedWriteable;\n import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n import org.elasticsearch.xpack.core.ml.utils.NamedXContentObject;\n \n-import java.util.List;\n import java.util.Map;\n \n public interface TrainedModel extends NamedXContentObject, NamedWriteable, Accountable {\n \n-    /**\n-     * @return List of featureNames expected by the model. In the order that they are expected\n-     */\n-    List<String> getFeatureNames();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53bb9ba01a108c33eb4d3ef89bf501532f0dc673"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d735cadb91d7f93a8d54fb8b1c4020f27368bb0d", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d735cadb91d7f93a8d54fb8b1c4020f27368bb0d", "committedDate": "2020-01-14T13:21:37Z", "message": "Update InferenceHelpers.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1ac9995bbcd8708c41d187d3dd9ec4f9d256dbc", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1ac9995bbcd8708c41d187d3dd9ec4f9d256dbc", "committedDate": "2020-01-14T13:35:04Z", "message": "Merge branch 'master' into feature/ml-inference-add-classification-threshold"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1ed38dd46711b199d1820b4b868feccacc14f9", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b1ed38dd46711b199d1820b4b868feccacc14f9", "committedDate": "2020-01-14T14:38:58Z", "message": "fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc40c737d5acb3acd76905822642dcbff9264f5", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdc40c737d5acb3acd76905822642dcbff9264f5", "committedDate": "2020-01-14T15:22:42Z", "message": "fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ee51d49708107d24adc2e9e0ff0e4eebfcc49d1", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ee51d49708107d24adc2e9e0ff0e4eebfcc49d1", "committedDate": "2020-01-14T15:42:28Z", "message": "Update TreeTests.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3803, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}