{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3Njk0OTI0", "number": 64768, "title": "Review retrying persister audit messages", "bodyText": "The ResultsPersisterService retries indexing/searches and takes a message handler function that is triggered after a failure when a retry is queued.\nfailed to {} after [{}] attempts. Will attempt again in [{}].\nIn some cases the retry message was being audited at warning level. This isn't an operational message - the final failure is - the fact that the action is being retried can be a debug log message.\nThe retry message can easily be interpreted as the final failure message however, this is not the case as the final failure after N reties throws an exception. I've renamed the parameter errorMsg -> retryMessage in a effort to make that clear", "createdAt": "2020-11-09T11:29:40Z", "url": "https://github.com/elastic/elasticsearch/pull/64768", "merged": true, "mergeCommit": {"oid": "cfa4dfa0213755a3c6787b05cf2382bf0e62cb56"}, "closed": true, "closedAt": "2020-11-10T10:24:38Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdazMjQAFqTUyNjE2NTQ0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbGE7MABqjM5Nzc5MzYyMzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MTY1NDQ3", "url": "https://github.com/elastic/elasticsearch/pull/64768#pullrequestreview-526165447", "createdAt": "2020-11-09T11:34:55Z", "commit": {"oid": "a80a567a2ee0a4eba52e7ebaa33b67fd54847fb6"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTozNDo1NlrOHvqiag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMTozNjo0M1rOHvqmNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MjA1OA==", "bodyText": "Could it be renamed to retryMessage for consistency?", "url": "https://github.com/elastic/elasticsearch/pull/64768#discussion_r519742058", "createdAt": "2020-11-09T11:34:56Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -160,6 +160,6 @@ private void executeBulkRequest(BulkRequest bulkRequest) {\n             bulkRequest,\n             config.getId(),\n             () -> isCancelled == false,\n-            errorMsg -> {});\n+            retryMsg -> {});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80a567a2ee0a4eba52e7ebaa33b67fd54847fb6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MjE1Mg==", "bodyText": "Could it be renamed to retryMessage for consistency?", "url": "https://github.com/elastic/elasticsearch/pull/64768#discussion_r519742152", "createdAt": "2020-11-09T11:35:04Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoiner.java", "diffHunk": "@@ -109,7 +109,7 @@ private void executeBulkRequest(BulkRequest bulkRequest) {\n             bulkRequest,\n             analyticsId,\n             () -> isCancelled == false,\n-            errorMsg -> {});\n+            retryMsg -> {});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80a567a2ee0a4eba52e7ebaa33b67fd54847fb6"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc0MzAyOA==", "bodyText": "Double-checking: should it be semicolon or colon in this string: \"]; \"?", "url": "https://github.com/elastic/elasticsearch/pull/64768#discussion_r519743028", "createdAt": "2020-11-09T11:36:43Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/stats/StatsPersister.java", "diffHunk": "@@ -46,13 +46,13 @@ public void persistWithRetry(ToXContentObject result, Function<String, String> d\n                 docIdSupplier.apply(jobId),\n                 true,\n                 () -> true,\n-                errorMsg -> auditor.error(jobId,\n-                    \"failed to persist result with id [\" + docIdSupplier.apply(jobId) + \"]; \" + errorMsg)\n+                retryMessage -> LOGGER.debug(\"[{}] failed to persist result with id [{}]; {}\", jobId, docIdSupplier.apply(jobId), retryMessage)\n             );\n         } catch (IOException ioe) {\n             LOGGER.error(() -> new ParameterizedMessage(\"[{}] Failed serializing stats result\", jobId), ioe);\n         } catch (Exception e) {\n             LOGGER.error(() -> new ParameterizedMessage(\"[{}] Failed indexing stats result\", jobId), e);\n+            auditor.error(jobId, \"Failed indexing stats result with id [\" + docIdSupplier.apply(jobId) + \"]; \" + e.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a80a567a2ee0a4eba52e7ebaa33b67fd54847fb6"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MjE0MzEz", "url": "https://github.com/elastic/elasticsearch/pull/64768#pullrequestreview-526214313", "createdAt": "2020-11-09T12:45:55Z", "commit": {"oid": "a8693ee598a524898704999248faeb721b6f8ef9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo0NTo1NlrOHvs29Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxMjo0NTo1NlrOHvs29Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTc4MDA4NQ==", "bodyText": "<3", "url": "https://github.com/elastic/elasticsearch/pull/64768#discussion_r519780085", "createdAt": "2020-11-09T12:45:56Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsPersister.java", "diffHunk": "@@ -524,10 +524,12 @@ void persist(ActionListener<IndexResponse> listener, boolean requireAlias) {\n         }\n \n         private void logCall(String indexName) {\n-            if (id != null) {\n-                logger.trace(\"[{}] ES API CALL: to index {} with ID [{}]\", jobId, indexName, id);\n-            } else {\n-                logger.trace(\"[{}] ES API CALL: to index {} with auto-generated ID\", jobId, indexName);\n+            if (logger.isTraceEnabled()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8693ee598a524898704999248faeb721b6f8ef9"}, "originalPosition": 39}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8693ee598a524898704999248faeb721b6f8ef9", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8693ee598a524898704999248faeb721b6f8ef9", "committedDate": "2020-11-09T12:29:56Z", "message": "Remove unused auditor from annotations processor and checkstyle fix"}, "afterCommit": {"oid": "9a4ef33aca54199f5dcbd17592ebdb069c3533f6", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a4ef33aca54199f5dcbd17592ebdb069c3533f6", "committedDate": "2020-11-09T16:26:47Z", "message": "Remove unused auditor from annotations processor and checkstyle fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2ODk2OTYz", "url": "https://github.com/elastic/elasticsearch/pull/64768#pullrequestreview-526896963", "createdAt": "2020-11-10T06:39:53Z", "commit": {"oid": "9a4ef33aca54199f5dcbd17592ebdb069c3533f6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a0390e6f89f0249390299eed408de6d7cb066b", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/06a0390e6f89f0249390299eed408de6d7cb066b", "committedDate": "2020-11-10T09:37:46Z", "message": "Review retrying persister audit messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ec125bcaf80bc4af4c63e267d6491effd6fbb1b5", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec125bcaf80bc4af4c63e267d6491effd6fbb1b5", "committedDate": "2020-11-10T09:37:46Z", "message": "Remove unused auditor from annotations processor and checkstyle fix"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9a4ef33aca54199f5dcbd17592ebdb069c3533f6", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a4ef33aca54199f5dcbd17592ebdb069c3533f6", "committedDate": "2020-11-09T16:26:47Z", "message": "Remove unused auditor from annotations processor and checkstyle fix"}, "afterCommit": {"oid": "ec125bcaf80bc4af4c63e267d6491effd6fbb1b5", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/ec125bcaf80bc4af4c63e267d6491effd6fbb1b5", "committedDate": "2020-11-10T09:37:46Z", "message": "Remove unused auditor from annotations processor and checkstyle fix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1271, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}