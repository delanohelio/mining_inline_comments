{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk4MjY3ODA4", "number": 54731, "title": "Allow different source sets from forbiddenApis", "bodyText": "ForbiddenApis task via the precommit task currently makes an assumption\nthat only the test and main source sets are present for any given project.\nThis commit removes that assumption and allows for any project source set's\ncompileClasspath class path to be added to the forbiddenApis classpath\nconfiguration.", "createdAt": "2020-04-03T16:24:13Z", "url": "https://github.com/elastic/elasticsearch/pull/54731", "merged": true, "mergeCommit": {"oid": "13d1683becd7e9ee188816d029bb65f51ee5125a"}, "closed": true, "closedAt": "2020-04-08T20:21:19Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUDV-SgH2gAyMzk4MjY3ODA4OjUzYjcxN2FhMjliOTMzM2Y5ZDU3MGNmNjE0YmFlNDQwY2Q3NTA3Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVpfxPAH2gAyMzk4MjY3ODA4OmE1OGE0ZTUwMTE5Yjc3Y2EyNDc5YTBmODc3NDBiMWQwNzMxZWExNDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/53b717aa29b9333f9d570cf614bae440cd7507f7", "committedDate": "2020-04-03T16:18:17Z", "message": "Allow different source sets from forbiddenApis\n\nForbiddenApis task via the precommit task currently makes an assumption\nthat only the test and main source sets are present for any given project.\nThis commit removes that assumption and allows for any roject source set's\ncompileClasspath class path to be added to the forbiddenApis classpath\nconfiguration."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NDI0MDE0", "url": "https://github.com/elastic/elasticsearch/pull/54731#pullrequestreview-387424014", "createdAt": "2020-04-03T16:53:39Z", "commit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1Mzo0MFrOGAd43A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QxNjo1NjozOVrOGAeBPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0Mjg3Ng==", "bodyText": "We should use ForbiddenApisPlugin.FORBIDDEN_APIS_TASK_NAME here, which in theory should even avoid the potential for the exception below.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403142876", "createdAt": "2020-04-03T16:53:40Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,26 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split('forbiddenApis')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzM3OQ==", "bodyText": "Can we ditch the ; since this is Groovy.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403143379", "createdAt": "2020-04-03T16:54:28Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,26 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split('forbiddenApis')\n+            if (parts.length == 0) {\n+                throw new IllegalStateException(\"The forbidden APIs plugin has changed it's task name please update the precommit task\")\n+            }\n+            String sourceSetName = 'main';", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0MzU3MA==", "bodyText": "In before Ryan complains about using def instead of an explicit type \ud83d\ude09\nAlso, no need for the ; here either.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403143570", "createdAt": "2020-04-03T16:54:48Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,26 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split('forbiddenApis')\n+            if (parts.length == 0) {\n+                throw new IllegalStateException(\"The forbidden APIs plugin has changed it's task name please update the precommit task\")\n+            }\n+            String sourceSetName = 'main';\n+            if (parts.length == 2) {\n+                sourceSetName = parts[1].toLowerCase(Locale.ROOT)\n+            }\n+            //add the sourceSet's compile classPath if it exists\n+            def sourceSets = project.sourceSets;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0Mzg1Mg==", "bodyText": "Replace def with SourceSet.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403143852", "createdAt": "2020-04-03T16:55:18Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,26 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split('forbiddenApis')\n+            if (parts.length == 0) {\n+                throw new IllegalStateException(\"The forbidden APIs plugin has changed it's task name please update the precommit task\")\n+            }\n+            String sourceSetName = 'main';\n+            if (parts.length == 2) {\n+                sourceSetName = parts[1].toLowerCase(Locale.ROOT)\n+            }\n+            //add the sourceSet's compile classPath if it exists\n+            def sourceSets = project.sourceSets;\n+            if (sourceSetName) {\n+                def sourceSet = sourceSets.findByName(sourceSetName)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzE0NTAyMA==", "bodyText": "I think we can ditch this null-check. A source set will always have a compile and runtime classpath (even if they are empty) so concatenating them will never error. I believe this is a relic from when we were looking at Configurations instead.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403145020", "createdAt": "2020-04-03T16:56:39Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,26 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split('forbiddenApis')\n+            if (parts.length == 0) {\n+                throw new IllegalStateException(\"The forbidden APIs plugin has changed it's task name please update the precommit task\")\n+            }\n+            String sourceSetName = 'main';\n+            if (parts.length == 2) {\n+                sourceSetName = parts[1].toLowerCase(Locale.ROOT)\n+            }\n+            //add the sourceSet's compile classPath if it exists\n+            def sourceSets = project.sourceSets;\n+            if (sourceSetName) {\n+                def sourceSet = sourceSets.findByName(sourceSetName)\n+                if (sourceSet) {\n+                    FileCollection runtime = sourceSet.runtimeClasspath\n+                    if (runtime && sourceSet.compileClasspath) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "53b717aa29b9333f9d570cf614bae440cd7507f7"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d1cc03795ea8c345226a538340b56ecc3cc61ae", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d1cc03795ea8c345226a538340b56ecc3cc61ae", "committedDate": "2020-04-03T17:08:27Z", "message": "review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg3NTc5NzM0", "url": "https://github.com/elastic/elasticsearch/pull/54731#pullrequestreview-387579734", "createdAt": "2020-04-03T21:04:52Z", "commit": {"oid": "5d1cc03795ea8c345226a538340b56ecc3cc61ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMTowNDo1M1rOGApoBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QyMTowNDo1M1rOGApoBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzMzNTE3NA==", "bodyText": "Why do we need this leniency? If a CheckForbiddenApis task exists, this source set should exist shouldn't it? With this leniency, or that below, we could have a bug here in the name munging and silently skip over all of this?", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r403335174", "createdAt": "2020-04-03T21:04:53Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +146,23 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n+            String[] parts = name.split(ForbiddenApisPlugin.FORBIDDEN_APIS_TASK_NAME)\n+            String sourceSetName = 'main'\n+            if (parts.length == 2) {\n+                sourceSetName = parts[1].toLowerCase(Locale.ROOT)\n+            }\n+            //add the sourceSet's compile classPath if it exists\n+            SourceSetContainer sourceSets = project.sourceSets\n+            if (sourceSetName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d1cc03795ea8c345226a538340b56ecc3cc61ae"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf8253325727d62a227c415a49d041cdb681861", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdf8253325727d62a227c415a49d041cdb681861", "committedDate": "2020-04-06T19:19:03Z", "message": "less lenient and fix casing from parsing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5b13d050922d10bb7a2cb6f3b32bc6984c6693d", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5b13d050922d10bb7a2cb6f3b32bc6984c6693d", "committedDate": "2020-04-06T21:06:49Z", "message": "Merge branch 'master' into forbidden_task_assumption"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzI3MjUz", "url": "https://github.com/elastic/elasticsearch/pull/54731#pullrequestreview-389327253", "createdAt": "2020-04-07T17:16:03Z", "commit": {"oid": "e5b13d050922d10bb7a2cb6f3b32bc6984c6693d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoxNjowM1rOGCN6fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzoxNjowM1rOGCN6fw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDk3ODMwMw==", "bodyText": "Instead of a split, could we assert the name startsWith and then do a substring using the length? Otherwise we have an edge case (part.length != 2) that should never happen that we allow for errors in this logic.", "url": "https://github.com/elastic/elasticsearch/pull/54731#discussion_r404978303", "createdAt": "2020-04-07T17:16:03Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/precommit/PrecommitTasks.groovy", "diffHunk": "@@ -144,18 +144,19 @@ class PrecommitTasks {\n         project.tasks.withType(CheckForbiddenApis).configureEach {\n             dependsOn(buildResources)\n \n-            //  use the runtime classpath if we have it, but some qa projects don't have one...\n-            if (name.endsWith('Test')) {\n-                FileCollection runtime = project.sourceSets.test.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.test.compileClasspath)\n-                }\n-            } else {\n-                FileCollection runtime = project.sourceSets.main.runtimeClasspath\n-                if (runtime != null) {\n-                    classpath = runtime.plus(project.sourceSets.main.compileClasspath)\n-                }\n+            //parse out the sourceSetName\n+            String[] parts = name.split(ForbiddenApisPlugin.FORBIDDEN_APIS_TASK_NAME)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e5b13d050922d10bb7a2cb6f3b32bc6984c6693d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "309c7a92955fb8f1bf038362df4bbe24d1cfe97e", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/309c7a92955fb8f1bf038362df4bbe24d1cfe97e", "committedDate": "2020-04-08T13:00:09Z", "message": "substring instead of split"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a58a4e50119b77ca2479a0f87740b1d0731ea143", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a58a4e50119b77ca2479a0f87740b1d0731ea143", "committedDate": "2020-04-08T15:19:18Z", "message": "Merge branch 'master' into forbidden_task_assumption"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3810, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}