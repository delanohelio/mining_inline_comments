{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3Mzk3NDA0", "number": 55607, "title": "Merge V2 index/component template mappings in specific manner", "bodyText": "This commit changes the way that V2 index, component, and request mappings are merged. Specifically:\n\nFields are merged in a \"replacement\" manner, meaning that the entire definition is replaced rather\nthan merging the interior configuration\nMapping metadata (all fields outside of properties) are merged recursively.\n\nThe merging for V1 templates does not change.\nRelates to #53101", "createdAt": "2020-04-22T16:23:01Z", "url": "https://github.com/elastic/elasticsearch/pull/55607", "merged": true, "mergeCommit": {"oid": "4574802dc54a72f982cf86a415511bb219e6dbc9"}, "closed": true, "closedAt": "2020-04-22T18:51:44Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaKwQEAH2gAyNDA3Mzk3NDA0Ojg5MGRiODhkMDQyNTRlOGRlNDNhNTE1ZDdlZmRiMGUwMmIxOWY3ZTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaO1jsgFqTM5ODU4ODQ2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "890db88d04254e8de43a515d7efdb0e02b19f7e4", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/890db88d04254e8de43a515d7efdb0e02b19f7e4", "committedDate": "2020-04-22T16:19:52Z", "message": "Merge V2 index/component template mappings in specific manner\n\nThis commit changes the way that V2 index, component, and request mappings are merged. Specifically:\n\n- Fields are merged in a \"replacement\" manner, meaning that the entire definition is replaced rather\nthan merging the interior configuration\n- Mapping metadata (all fields outside of `properties`) are merged recursively.\n\nThe merging for V1 templates does not change.\n\nRelates to #53101"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Mzc0Mjg5", "url": "https://github.com/elastic/elasticsearch/pull/55607#pullrequestreview-398374289", "createdAt": "2020-04-22T16:38:52Z", "commit": {"oid": "890db88d04254e8de43a515d7efdb0e02b19f7e4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjozODo1M1rOGJ_-9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxNjozODo1M1rOGJ_-9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzEzODY3OQ==", "bodyText": "innerTemplateMapping is only used to initialize innerTemplateNonProperties\nWould it make sense for these statements to be executed in reversed order to avoid over allocating innerTemplateNonProperties just to immediately remove \"properties\" ?\nie.\nMap<String, Object> maybeProperties = (Map<String, Object>) innerTemplateMapping.remove(\"properties\");\nMap<String, Object> innerTemplateNonProperties = new HashMap<>(innerTemplateMapping);", "url": "https://github.com/elastic/elasticsearch/pull/55607#discussion_r413138679", "createdAt": "2020-04-22T16:38:53Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -529,13 +537,76 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n     }\n \n     /**\n-     * Parses the provided mappings json and the inheritable mappings from the templates (if any) into a map.\n+     * Parses the provided mappings json and the inheritable mappings from the templates (if any)\n+     * into a map.\n      *\n-     * The template mappings are applied in the order they are encountered in the list (clients should make sure the lower index, closer\n-     * to the head of the list, templates have the highest {@link IndexTemplateMetadata#order()})\n+     * The template mappings are applied in the order they are encountered in the list, with the\n+     * caveat that mapping fields are only merged at the top-level, meaning that field settings are\n+     * not merged, instead they replace any previous field definition.\n+     */\n+    @SuppressWarnings(\"unchecked\")\n+    static Map<String, Object> parseV2Mappings(String mappingsJson, List<CompressedXContent> templateMappings,\n+                                               NamedXContentRegistry xContentRegistry) throws Exception {\n+        Map<String, Object> requestMappings = MapperService.parseMapping(xContentRegistry, mappingsJson);\n+        // apply templates, merging the mappings into the request mapping if exists\n+        Map<String, Object> properties = new HashMap<>();\n+        Map<String, Object> nonProperties = new HashMap<>();\n+        for (CompressedXContent mapping : templateMappings) {\n+            if (mapping != null) {\n+                Map<String, Object> templateMapping = MapperService.parseMapping(xContentRegistry, mapping.string());\n+                if (templateMapping.isEmpty()) {\n+                    // Someone provided an empty '{}' for mappings, which is okay, but to avoid\n+                    // tripping the below assertion, we can safely ignore it\n+                    continue;\n+                }\n+                assert templateMapping.size() == 1 : \"expected exactly one mapping value, got: \" + templateMapping;\n+                if (templateMapping.get(MapperService.SINGLE_MAPPING_NAME) instanceof Map == false) {\n+                    throw new IllegalStateException(\"invalid mapping definition, expected a single map underneath [\" +\n+                        MapperService.SINGLE_MAPPING_NAME + \"] but it was: [\" + templateMapping + \"]\");\n+                }\n+\n+                Map<String, Object> innerTemplateMapping = (Map<String, Object>) templateMapping.get(MapperService.SINGLE_MAPPING_NAME);\n+                Map<String, Object> innerTemplateNonProperties = new HashMap<>(innerTemplateMapping);\n+                Map<String, Object> maybeProperties = (Map<String, Object>) innerTemplateNonProperties.remove(\"properties\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "890db88d04254e8de43a515d7efdb0e02b19f7e4"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTg4NDY5", "url": "https://github.com/elastic/elasticsearch/pull/55607#pullrequestreview-398588469", "createdAt": "2020-04-22T21:05:17Z", "commit": {"oid": "890db88d04254e8de43a515d7efdb0e02b19f7e4"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 680, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}