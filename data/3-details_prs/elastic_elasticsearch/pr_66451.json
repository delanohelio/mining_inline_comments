{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxMjY4ODYy", "number": 66451, "title": "[ML] change to only calculate model size on initial load to prevent slow cache promotions", "bodyText": "When a value is promoted in the LRU cache, its weight is removed and added.\nThe LocalModel object was recalculating the model size for ever weight check, which caused a polynomial runtime.\nThis commit changes the model size to only be calculated in the LocalModel ctor.", "createdAt": "2020-12-16T16:00:18Z", "url": "https://github.com/elastic/elasticsearch/pull/66451", "merged": true, "mergeCommit": {"oid": "ed6616c984bed57f311aa2665a425564aeadc5ee"}, "closed": true, "closedAt": "2020-12-16T17:26:33Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmxFMrgH2gAyNTQxMjY4ODYyOjA4NDE5NTczYWM1ZWI1ZmYyZmI2MzZiMDY5M2MyOTI5OThiOGQzY2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmx7w3gFqTU1Mzg5MTc1NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/08419573ac5eb5ff2fb636b0693c292998b8d3ca", "committedDate": "2020-12-16T15:57:23Z", "message": "[ML] change to only calculate model size on initial load to prevent slow cache promotions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODU0NDg0", "url": "https://github.com/elastic/elasticsearch/pull/66451#pullrequestreview-553854484", "createdAt": "2020-12-16T16:19:25Z", "commit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjoxOToyNlrOIHNkpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjoxOToyNlrOIHNkpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQzMzMxOA==", "bodyText": "maybe rename to cachedRamBytesUsed and add a comment to remember why it's a good idea to cache it?", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544433318", "createdAt": "2020-12-16T16:19:26Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -56,6 +56,7 @@\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n+    private final long modelSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODc2OTUw", "url": "https://github.com/elastic/elasticsearch/pull/66451#pullrequestreview-553876950", "createdAt": "2020-12-16T16:42:03Z", "commit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjo0MjowM1rOIHOqVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxNjo0MzozOFrOIHOvVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MTE1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final long modelSize;\n          \n          \n            \n                private final long cachedRamBytesUsed;", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544451157", "createdAt": "2020-12-16T16:42:03Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -56,6 +56,7 @@\n     private final License.OperationMode licenseLevel;\n     private final CircuitBreaker trainedModelCircuitBreaker;\n     private final AtomicLong referenceCount;\n+    private final long modelSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MTI1Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.modelSize = trainedModelDefinition.ramBytesUsed();\n          \n          \n            \n                    this.cachedRamBytesUsed = trainedModelDefinition.ramBytesUsed();", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544451257", "createdAt": "2020-12-16T16:42:11Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -67,6 +68,7 @@\n                TrainedModelStatsService trainedModelStatsService,\n                CircuitBreaker trainedModelCircuitBreaker) {\n         this.trainedModelDefinition = trainedModelDefinition;\n+        this.modelSize = trainedModelDefinition.ramBytesUsed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDQ1MjQzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return modelSize;\n          \n          \n            \n                    // This should always be cached and not calculated on call. \n          \n          \n            \n                    // This is because the caching system calls this method on every promotion call that changes the LRU head\n          \n          \n            \n                    // Consequently, recalculating can cause serious throughput issues due to LRU changes in the cache\n          \n          \n            \n                    return cachedRamBytesUsed;", "url": "https://github.com/elastic/elasticsearch/pull/66451#discussion_r544452438", "createdAt": "2020-12-16T16:43:38Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -82,7 +84,7 @@\n     }\n \n     long ramBytesUsed() {\n-        return trainedModelDefinition.ramBytesUsed();\n+        return modelSize;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08419573ac5eb5ff2fb636b0693c292998b8d3ca"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "578c8ea576617f3f95ce13447331d85491e1a55d", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/578c8ea576617f3f95ce13447331d85491e1a55d", "committedDate": "2020-12-16T16:44:15Z", "message": "Apply suggestions from code review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzODkxNzU1", "url": "https://github.com/elastic/elasticsearch/pull/66451#pullrequestreview-553891755", "createdAt": "2020-12-16T16:56:59Z", "commit": {"oid": "578c8ea576617f3f95ce13447331d85491e1a55d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4432, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}