{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MjcxMTEx", "number": 64937, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNjozN1rOE4EXMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToyMDowN1rOE4Ecng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjI3MTg0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNjozN1rOHxxdIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNjozN1rOHxxdIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1MjU0Nw==", "bodyText": "Ditto", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952547", "createdAt": "2020-11-12T09:16:37Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());\n     }\n \n     public List<String> getOutputFieldNames() {\n-        return preProcessor.outputFields();\n+        return preProcessor.outputFields().stream().sorted().collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjI3NDUzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNzoxMVrOHxxerA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToxNzoxMVrOHxxerA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1Mjk0MA==", "bodyText": "This is called for every document we load into the process. I suggest we sort once when we store them in the PreProcessor.", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521952940", "createdAt": "2020-11-12T09:17:11Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -24,20 +27,21 @@ public ProcessedField(PreProcessor processor) {\n     }\n \n     public List<String> getInputFieldNames() {\n-        return preProcessor.inputFields();\n+        return preProcessor.inputFields().stream().sorted().collect(Collectors.toList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MjI4NTc0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQwOToyMDowN1rOHxxlrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxMjowNToyNFrOHx30CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg==", "bodyText": "If the preprocessor already returns the output fields sorted, we shouldn't need to sort here.\nNow unfortunately there is not sorted list interface. But as we're dealing with fields, if we want to enforce this to the PreProcessor interface we should switch to SortedSet.", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r521954732", "createdAt": "2020-11-12T09:20:07Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -47,12 +51,12 @@ public ProcessedField(PreProcessor processor) {\n                 continue;\n             }\n             final Object value = values[0];\n-            if (values.length == 1 && (value instanceof String || value instanceof Number)) {\n+            if (values.length == 1 && (isValidValue(value))) {\n                 inputs.put(field, value);\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1MjYzMw==", "bodyText": "The only one that causes this problem is the Onehot processor, I will see if I can figure out a way for the order to always be the same. The order will always have to be the same after serializing from the wire and on xcontent.", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r522052633", "createdAt": "2020-11-12T11:58:22Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -47,12 +51,12 @@ public ProcessedField(PreProcessor processor) {\n                 continue;\n             }\n             final Object value = values[0];\n-            if (values.length == 1 && (value instanceof String || value instanceof Number)) {\n+            if (values.length == 1 && (isValidValue(value))) {\n                 inputs.put(field, value);\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg=="}, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjA1NjcxMg==", "bodyText": "Yeah, I don't know what I was thinking \ud83e\udd26\nI will fix this...The preprocessor output should be consistent", "url": "https://github.com/elastic/elasticsearch/pull/64937#discussion_r522056712", "createdAt": "2020-11-12T12:05:24Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/ProcessedField.java", "diffHunk": "@@ -47,12 +51,12 @@ public ProcessedField(PreProcessor processor) {\n                 continue;\n             }\n             final Object value = values[0];\n-            if (values.length == 1 && (value instanceof String || value instanceof Number)) {\n+            if (values.length == 1 && (isValidValue(value))) {\n                 inputs.put(field, value);\n             }\n         }\n         preProcessor.process(inputs);\n-        return preProcessor.outputFields().stream().map(inputs::get).toArray();\n+        return preProcessor.outputFields().stream().sorted().map(inputs::get).toArray();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk1NDczMg=="}, "originalCommit": {"oid": "d830809c7b658eaada3550f18a8b75cf3e3b366b"}, "originalPosition": 47}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3097, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}