{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMzMjQ3MjAw", "number": 65921, "title": "Stop Copying Large Byte Arrays from Transport Messages", "bodyText": "We were copying any byte arrays we would read streams that are backed by\na BytesReference. This would mean copying e.g. 500k chunks during\nfile based recovery, large chunks during CCR file copy, or many MB when\nreceiving a large cluster state for the first time.\nThis PR adds the ability to read shared bytes from streams that support it,\nadds reference counting to transport messages that make use of these bytes\nand makes use of the new functionality in recovery, CCR and CS publication.\nThis should reduce memory usage by all 3 adjusted transport APIs significantly\nand could be extended to other very large messages that currently get copied\nduring deserialization like e.g. bulk requests.", "createdAt": "2020-12-06T18:52:31Z", "url": "https://github.com/elastic/elasticsearch/pull/65921", "merged": true, "mergeCommit": {"oid": "55996cd156c1a7c73f61b4bb29eb7c1c3d47a660"}, "closed": true, "closedAt": "2021-01-06T11:05:03Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdjlCBkgH2gAyNTMzMjQ3MjAwOjY3NjJhM2VhZDJhOGY3Y2M3Y2YzYTAyZDg5MmUwNGFmZjM1Y2I5MGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdta59cAFqTU2MjM5MDc1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6762a3ead2a8f7cc7cf3a02d892e04aff35cb90d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6762a3ead2a8f7cc7cf3a02d892e04aff35cb90d", "committedDate": "2020-12-06T18:13:17Z", "message": "Stop Copying Large Byte Arrays from Transport Messages\n\nWe were copying any byte arrays we would read streams that are backed by\na `BytesReference`. This would mean copying e.g. 500k chunks during\nfile based recovery, large chunks during CCR file copy, or many MB when\nreceiving a large cluster state for the first time.\n\nThis PR adds the ability to read shared bytes from streams that support it,\nadds reference counting to transport messages that make use of these bytes\nand makes use of the new functionality in recovery, CCR and CS publication.\n\nThis should reduce memory usage by all 3 adjusted transport APIs significantly\nand could be extended to other very large messages that currently get copied\nduring deserialization like e.g. bulk requests."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5d3b01c67462d4a6dccc372a4b03ebfe1a355b0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5d3b01c67462d4a6dccc372a4b03ebfe1a355b0", "committedDate": "2020-12-06T18:52:14Z", "message": "shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdc3b672f758ee8ef4e6645723c8790ed13e8668", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdc3b672f758ee8ef4e6645723c8790ed13e8668", "committedDate": "2020-12-07T00:38:49Z", "message": "Merge remote-tracking branch 'elastic/master' into just-stop-copying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1Nzc2Mjc3", "url": "https://github.com/elastic/elasticsearch/pull/65921#pullrequestreview-545776277", "createdAt": "2020-12-07T01:15:12Z", "commit": {"oid": "b5d3b01c67462d4a6dccc372a4b03ebfe1a355b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMToxNToxMlrOIASSgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QwMToxNToxMlrOIASSgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzE3MDU2MA==", "bodyText": "Inlined this so that the reference count handling is all in one place and it's \"clear\" that there's no path to leaking a request (except for some corner cases where the threadPool is shutting down but we have that issue with all kinds of ref counted things and its only relevant for tests).", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r537170560", "createdAt": "2020-12-07T01:15:12Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -193,23 +194,58 @@ private void messageReceived(TcpChannel channel, InboundMessage message, long st\n                     final RequestHandlerRegistry<T> reg = requestHandlers.getHandler(action);\n                     assert reg != null;\n                     final T request = reg.newRequest(stream);\n-                    request.remoteAddress(new TransportAddress(channel.getRemoteAddress()));\n-                    // in case we throw an exception, i.e. when the limit is hit, we don't want to verify\n-                    final int nextByte = stream.read();\n-                    // calling read() is useful to make sure the message is fully read, even if there some kind of EOS marker\n-                    if (nextByte != -1) {\n-                        throw new IllegalStateException(\"Message not fully read (request) for requestId [\" + requestId + \"], action [\"\n-                            + action + \"], available [\" + stream.available() + \"]; resetting\");\n-                    }\n-                    final String executor = reg.getExecutor();\n-                    if (ThreadPool.Names.SAME.equals(executor)) {\n-                        try {\n-                            reg.processMessageReceived(request, transportChannel);\n-                        } catch (Exception e) {\n-                            sendErrorResponse(reg.getAction(), transportChannel, e);\n+                    try {\n+                        request.remoteAddress(new TransportAddress(channel.getRemoteAddress()));\n+                        // in case we throw an exception, i.e. when the limit is hit, we don't want to verify\n+                        final int nextByte = stream.read();\n+                        // calling read() is useful to make sure the message is fully read, even if there some kind of EOS marker\n+                        if (nextByte != -1) {\n+                            throw new IllegalStateException(\"Message not fully read (request) for requestId [\" + requestId + \"], action [\"\n+                                + action + \"], available [\" + stream.available() + \"]; resetting\");\n                         }\n-                    } else {\n-                        threadPool.executor(executor).execute(new RequestHandler<>(reg, request, transportChannel));\n+                        final String executor = reg.getExecutor();\n+                        if (ThreadPool.Names.SAME.equals(executor)) {\n+                            try {\n+                                reg.processMessageReceived(request, transportChannel);\n+                            } catch (Exception e) {\n+                                sendErrorResponse(reg.getAction(), transportChannel, e);\n+                            }\n+                        } else {\n+                            boolean success = false;\n+                            if (request instanceof RefCounted) {\n+                                ((RefCounted) request).incRef();\n+                            }\n+                            try {\n+                                threadPool.executor(executor).execute(new AbstractRunnable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5d3b01c67462d4a6dccc372a4b03ebfe1a355b0"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e7de56c10b3e291e5072967864e9f8f5f9f792", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/73e7de56c10b3e291e5072967864e9f8f5f9f792", "committedDate": "2020-12-07T01:17:55Z", "message": "docs and less noise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f49cf97e9e3b0c5cfbd79595f54afc30295c2f6", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f49cf97e9e3b0c5cfbd79595f54afc30295c2f6", "committedDate": "2020-12-17T11:26:58Z", "message": "Merge remote-tracking branch 'elastic/master' into just-stop-copying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dc5bf34125cb7ff3e978e6873dff707ce979525", "committedDate": "2020-12-17T11:27:57Z", "message": "Merge remote-tracking branch 'origin/just-stop-copying' into just-stop-copying"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwOTQwMDU1", "url": "https://github.com/elastic/elasticsearch/pull/65921#pullrequestreview-560940055", "createdAt": "2021-01-04T10:54:41Z", "commit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMDo1NDo0MlrOINtZ0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQxMTo0Njo1MVrOINu2jA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI0NjI5MA==", "bodyText": "Alternative name suggestion:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public ReleasableBytesReference readUnsafeBytesReference() throws IOException {\n          \n          \n            \n                public ReleasableBytesReference readReleasableBytesReference() throws IOException {\n          \n      \n    \n    \n  \n\nMethods that return a ReleasableBytesReference should pretty much all have the expectation that the caller takes responsibility for releasing it later, so I don't think this is as unsafe as the proposed name indicates.", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551246290", "createdAt": "2021-01-04T10:54:42Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java", "diffHunk": "@@ -129,14 +130,23 @@ public void setVersion(Version version) {\n     public abstract void readBytes(byte[] b, int offset, int len) throws IOException;\n \n     /**\n-     * Reads a bytes reference from this stream, might hold an actual reference to the underlying\n-     * bytes of the stream.\n+     * Reads a bytes reference from this stream, copying any bytes read to a new {@code byte[]}. Use {@link #readUnsafeBytesReference()}\n+     * when reading large bytes references where possible top avoid needless allocations and copying.\n      */\n     public BytesReference readBytesReference() throws IOException {\n         int length = readArraySize();\n         return readBytesReference(length);\n     }\n \n+    /**\n+     * Reads a releasable bytes reference from this stream. Unlike {@link #readBytesReference()} the returned bytes reference may reference\n+     * bytes in a pooled buffer and must be explicitly released via {@link ReleasableBytesReference#close()} once no longer used.\n+     * Prefer this method over {@link #readBytesReference()} when reading large bytes references to avoid allocations and copying.\n+     */\n+    public ReleasableBytesReference readUnsafeBytesReference() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1NzQ5Ng==", "bodyText": "Would it be so bad to have TransportMessage implements RefCounted - I think it'll catch someone out in future. At least let's add Javadoc somewhere saying that subclasses that implement RefCounted are released by the transport service.", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551257496", "createdAt": "2021-01-04T11:18:44Z", "author": {"login": "DaveCTurner"}, "path": "libs/core/src/main/java/org/elasticsearch/common/util/concurrent/RefCounted.java", "diffHunk": "@@ -65,4 +65,15 @@\n      * @return returns {@code true} if the ref count dropped to 0 as a result of calling this method\n      */\n     boolean decRef();\n+\n+    /**\n+     * Decrement the ref count on the given {@code object} by one if it is a {@link RefCounted}\n+     *\n+     * @param object object to decrement ref count for if it is a {@link RefCounted}\n+     */\n+    static void decRef(Object object) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1ODkwMg==", "bodyText": "Maybe avoid the casting?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            final ReleasableBytesReference result = ((ReleasableBytesReference) bytesReference).retainedSlice(offset(), len);\n          \n          \n            \n                            final ReleasableBytesReference result = ReleasableBytesReference.this.retainedSlice(offset(), len);", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551258902", "createdAt": "2021-01-04T11:21:51Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/ReleasableBytesReference.java", "diffHunk": "@@ -104,26 +121,41 @@ public long ramBytesUsed() {\n \n     @Override\n     public StreamInput streamInput() throws IOException {\n-        return delegate.streamInput();\n+        assert refCount() > 0;\n+        return new BytesReferenceStreamInput(this) {\n+            @Override\n+            public ReleasableBytesReference readUnsafeBytesReference() throws IOException {\n+                final int len = readArraySize();\n+                // instead of reading the bytes from a stream we just create a slice of the underlying bytes\n+                final ReleasableBytesReference result = ((ReleasableBytesReference) bytesReference).retainedSlice(offset(), len);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI1OTgyMQ==", "bodyText": "The chunk is already closed here, seems wrong to be accessing it still. Can we close it after the synchronised block?", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551259821", "createdAt": "2021-01-04T11:23:53Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/recovery/MultiFileWriter.java", "diffHunk": "@@ -210,7 +216,9 @@ void writeChunk(FileChunk newChunk) throws IOException {\n                     }\n                     pendingChunks.remove();\n                 }\n-                innerWriteFileChunk(chunk.md, chunk.position, chunk.content, chunk.lastChunk);\n+                try (chunk) {\n+                    innerWriteFileChunk(chunk.md, chunk.position, chunk.content, chunk.lastChunk);\n+                }\n                 synchronized (this) {\n                     assert lastPosition == chunk.position : \"last_position \" + lastPosition + \" != chunk_position \" + chunk.position;\n                     lastPosition += chunk.content.length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2MjMyMw==", "bodyText": "I think we would leak these if a recovery fails: MultiFileWriter#closeInternal simply drops its FileChunkWriter objects on the floor.", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551262323", "createdAt": "2021-01-04T11:29:18Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/recovery/MultiFileWriter.java", "diffHunk": "@@ -179,17 +180,22 @@ public void renameAllTempFiles() throws IOException {\n         store.renameTempFilesSafe(tempFileNames);\n     }\n \n-    static final class FileChunk {\n+    private static final class FileChunk implements Releasable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI2NDUxNQ==", "bodyText": "content is actually already a ReleasableBytesReference (in prod code at least)", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551264515", "createdAt": "2021-01-04T11:34:19Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/recovery/RecoveryFileChunkRequest.java", "diffHunk": "@@ -64,7 +66,7 @@ public RecoveryFileChunkRequest(long recoveryId, final long requestSeqNo, ShardI\n         this.shardId = shardId;\n         this.metadata = metadata;\n         this.position = position;\n-        this.content = content;\n+        this.content = ReleasableBytesReference.wrap(content);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTI3MDAyOA==", "bodyText": "I think this means the comment above (\"This is currently safe to do ...\") isn't needed any more. I mean it's still safe to do, but not for the reason it gives any more.", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r551270028", "createdAt": "2021-01-04T11:46:51Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/repositories/GetCcrRestoreFileChunkAction.java", "diffHunk": "@@ -72,27 +73,27 @@ protected void doExecute(Task task, GetCcrRestoreFileChunkRequest request,\n         }\n     }\n \n-    public static class GetCcrRestoreFileChunkResponse extends ActionResponse {\n+    public static class GetCcrRestoreFileChunkResponse extends ActionResponse implements RefCounted {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1dc5bf34125cb7ff3e978e6873dff707ce979525"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "153d4a8211cf785cd38ac80d4d10c7dc90211d2a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/153d4a8211cf785cd38ac80d4d10c7dc90211d2a", "committedDate": "2021-01-05T07:23:41Z", "message": "Merge remote-tracking branch 'elastic/master' into just-stop-copying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f55f6c1cff21d3a898d369842689ee68318eed1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f55f6c1cff21d3a898d369842689ee68318eed1", "committedDate": "2021-01-05T10:12:58Z", "message": "CR: comments round 1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "766abf7e1f5e7f5ea949897597a7da8b02c11b64", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/766abf7e1f5e7f5ea949897597a7da8b02c11b64", "committedDate": "2021-01-05T10:13:39Z", "message": "Merge remote-tracking branch 'elastic/master' into just-stop-copying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19517e4b2b46f2568f077efb6aab1c851978d944", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/19517e4b2b46f2568f077efb6aab1c851978d944", "committedDate": "2021-01-05T11:06:08Z", "message": "CR: ensure pending chunks are released every time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed8df1a141387de04af50d89a21b4bda06bb9106", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed8df1a141387de04af50d89a21b4bda06bb9106", "committedDate": "2021-01-05T15:16:32Z", "message": "Merge remote-tracking branch 'elastic/master' into just-stop-copying"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da56e8355ece729bd40c8828da8722b8f93409c9", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/da56e8355ece729bd40c8828da8722b8f93409c9", "committedDate": "2021-01-05T16:24:25Z", "message": "CR: release pending chunks safely"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYyMzkwNzUz", "url": "https://github.com/elastic/elasticsearch/pull/65921#pullrequestreview-562390753", "createdAt": "2021-01-06T08:04:36Z", "commit": {"oid": "da56e8355ece729bd40c8828da8722b8f93409c9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwODowNDozNlrOIO1SNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNlQwODowNDozNlrOIO1SNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjQyMzk5MA==", "bodyText": "All worked out pretty nicely here \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/65921#discussion_r552423990", "createdAt": "2021-01-06T08:04:36Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/recovery/MultiFileWriter.java", "diffHunk": "@@ -152,6 +158,7 @@ public void close() {\n \n     @Override\n     protected void closeInternal() {\n+        Releasables.close(fileChunkWriters.values());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "da56e8355ece729bd40c8828da8722b8f93409c9"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4026, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}