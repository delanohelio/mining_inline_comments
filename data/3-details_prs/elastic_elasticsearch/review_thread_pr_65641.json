{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODc0MTgw", "number": 65641, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0Njo0MlrOE-42mw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0Njo0MlrOE-42mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0Mzc4NjUxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0Njo0MlrOH8SYeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMToxODowNlrOH9uhgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ==", "bodyText": "This is hacky but felt like the best way to fix this right now. FragmentsBuilder is an external (Lucene) interface and there's not a good way to pass in _source to its methods like getFields.", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r532977785", "createdAt": "2020-11-30T23:46:42Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -160,8 +160,13 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        String[] fragments;\n+        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n+        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzk5OTQ0OA==", "bodyText": "Could we replace the cached FragmentsBuilder with a Function<SourceLookup, FragmentsBuilder> and then call that with the new SourceLookup for each hit?  The FragmentsBuilders themselves don't seem to do any significant processing on construction so I don't think there would be a performance penalty for rebuilding them each time.", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r533999448", "createdAt": "2020-12-02T09:02:55Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -160,8 +160,13 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        String[] fragments;\n+        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n+        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ=="}, "originalCommit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQ4NzQyNA==", "bodyText": "It seems like that should work! I'd like to check I understand the context. We have these cached entries not because fragment builders are expensive to build, but to avoid rebuilding the FieldQuery which looks more complex?", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r534487424", "createdAt": "2020-12-02T21:18:06Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -160,8 +160,13 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        String[] fragments;\n+        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n+        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ=="}, "originalCommit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1865, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}