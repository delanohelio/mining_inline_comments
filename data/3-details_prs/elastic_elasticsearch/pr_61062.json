{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2OTUwMDA0", "number": 61062, "title": "Introduce point in time APIs in x-pack basic", "bodyText": "This commit introduces a new API that manages point-in-times in x-pack basic. Elasticsearch pit (point in time) is a lightweight view into the state of the data as it existed when initiated. A search request by default executes against the most recent point in time. In some cases, it is preferred to perform multiple search requests using the same point in time. For example, if refreshes happen between search_after requests, then the results of those requests might not be consistent as changes happening between searches are only visible to the more recent point in time.\nA point in time must be opened before being used in search requests. The keep_alive parameter tells Elasticsearch how long it should keep a point in time around.\nPOST /my_index/_pit?keep_alive=1m\n\nThe response from the above request includes a id, which should be passed to the id of the pit parameter of search requests.\nPOST /_search\n{\n    \"query\": {\n        \"match\" : {\n            \"title\" : \"elasticsearch\"\n        }\n    },\n    \"pit\": {\n\t    \"id\":  \"46ToAwMDaWR4BXV1aWQxAgZub2RlXzEAAAAAAAAAAAEBYQNpZHkFdXVpZDIrBm5vZGVfMwAAAAAAAAAAKgFjA2lkeQV1dWlkMioGbm9kZV8yAAAAAAAAAAAMAWICBXV1aWQyAAAFdXVpZDEAAQltYXRjaF9hbGw_gAAAAA==\",\n\t    \"keep_alive\": \"1m\"\n    }\n}\n\nPoint-in-times are automatically closed when the keep_alive is elapsed. However, keeping point-in-times has a cost; hence, point-in-times should be closed as soon as they are no longer used in search requests.\nDELETE /_pit\n{\n    \"id\" : \"46ToAwMDaWR4BXV1aWQxAgZub2RlXzEAAAAAAAAAAAEBYQNpZHkFdXVpZDIrBm5vZGVfMwAAAAAAAAAAKgFjA2lkeQV1dWlkMioGbm9kZV8yAAAAAAAAAAAMAWIBBXV1aWQyAAA=\"\n}\n\nNotable works in this change:\n\nMove the search state to the coordinating node: #52741\nAllow searches with a specific reader context: #53989\nAdd the ability to acquire readers in IndexShard: #54966\n\nRelates #46523\nRelates #26472\nCo-authored-by: Jim Ferenczi <jimczi@apache.org>", "createdAt": "2020-08-12T18:59:26Z", "url": "https://github.com/elastic/elasticsearch/pull/61062", "merged": true, "mergeCommit": {"oid": "879279c9b46b5a9606dfca96075e005624f0785d"}, "closed": true, "closedAt": "2020-08-25T00:24:36Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-PXaSAH2gAyNDY2OTUwMDA0OjMxNGE1OTYzZWUyOTg3MzhlNGVjYmMxYTM3OWY1OWM2OTRiNWY4YmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCGNvDgH2gAyNDY2OTUwMDA0OjE0YzgyODg5MTczNmIzMjk4MzAyYzdkMGNlODQ2NWM1NDc5ZTgyNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "314a5963ee298738e4ecbc1a379f59c694b5f8be", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/314a5963ee298738e4ecbc1a379f59c694b5f8be", "committedDate": "2020-08-12T18:03:32Z", "message": "Introduce search context\n\nCo-authored-by: Jim Ferenczi <jimczi@apache.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d92aa92c02b30a9771298ba025e818e1137293ba", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d92aa92c02b30a9771298ba025e818e1137293ba", "committedDate": "2020-08-12T19:36:04Z", "message": "changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44dc0adc7496e2c81377f6b6aa76cc2a8347e27", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b44dc0adc7496e2c81377f6b6aa76cc2a8347e27", "committedDate": "2020-08-12T20:59:55Z", "message": "fix doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ed217afb2d01d8e4bf285056e8c6df13ce9b8cb", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ed217afb2d01d8e4bf285056e8c6df13ce9b8cb", "committedDate": "2020-08-17T17:03:59Z", "message": "Merge branch 'master' into search-context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "136bf341c587303071df1d6ce47dd78efb09d513", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/136bf341c587303071df1d6ce47dd78efb09d513", "committedDate": "2020-08-17T19:39:43Z", "message": "search context -> point in time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43b9dadc740e25cccac3928acb2709c7ab554f37", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/43b9dadc740e25cccac3928acb2709c7ab554f37", "committedDate": "2020-08-17T21:10:35Z", "message": "fix rest test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcbe3e33160e18591998a57073fb346858c6d34b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcbe3e33160e18591998a57073fb346858c6d34b", "committedDate": "2020-08-19T21:16:06Z", "message": "validate only scroll and multi session point in time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64537547f358c099fd23137c8ea421a6620480fe", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/64537547f358c099fd23137c8ea421a6620480fe", "committedDate": "2020-08-20T14:05:47Z", "message": "handle point-in-time related request in RBACEngine"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff38a8a287c26c6355f8174fc0cdc23dc85203b4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff38a8a287c26c6355f8174fc0cdc23dc85203b4", "committedDate": "2020-08-20T14:06:26Z", "message": "Merge branch 'master' into search-context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af02abf36c62f8843f5bdd6b5ca34743cf70abd0", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/af02abf36c62f8843f5bdd6b5ca34743cf70abd0", "committedDate": "2020-08-20T14:28:08Z", "message": "combine scroll and point-in-time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d902b68fc5e3d64a35b071a3e80732637a83e8", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4d902b68fc5e3d64a35b071a3e80732637a83e8", "committedDate": "2020-08-20T19:54:21Z", "message": "Revert \"combine scroll and point-in-time\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba21139b6bd4edaee1fd66bac47e4832e9a7ac4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ba21139b6bd4edaee1fd66bac47e4832e9a7ac4", "committedDate": "2020-08-20T21:18:23Z", "message": "pass NamedWriteableRegistry to NodeClient"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a7eb6af57f993ccebbc8fd89ac16bb2050270ef", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a7eb6af57f993ccebbc8fd89ac16bb2050270ef", "committedDate": "2020-08-20T21:20:52Z", "message": "override indices of search request if point-in-time specified"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4b4c6ef07161b6be163c44c7d21e59efa9fab5", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa4b4c6ef07161b6be163c44c7d21e59efa9fab5", "committedDate": "2020-08-20T21:33:03Z", "message": "validate scroll request only"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12429acda00c623f4ac95c21dce717ff128d587b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/12429acda00c623f4ac95c21dce717ff128d587b", "committedDate": "2020-08-20T21:40:08Z", "message": "Merge branch 'master' into search-context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "289766068c391b27e3f71407cad5d58b5b3f596e", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/289766068c391b27e3f71407cad5d58b5b3f596e", "committedDate": "2020-08-20T22:11:18Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a454de0c5b6e084626d0b47cdc80e55c53f13d2", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a454de0c5b6e084626d0b47cdc80e55c53f13d2", "committedDate": "2020-08-20T23:39:31Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjA3MTU3", "url": "https://github.com/elastic/elasticsearch/pull/61062#pullrequestreview-473207157", "createdAt": "2020-08-24T08:07:00Z", "commit": {"oid": "0a454de0c5b6e084626d0b47cdc80e55c53f13d2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczNDU3NDQx", "url": "https://github.com/elastic/elasticsearch/pull/61062#pullrequestreview-473457441", "createdAt": "2020-08-24T13:21:43Z", "commit": {"oid": "0a454de0c5b6e084626d0b47cdc80e55c53f13d2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMzoyMTo0M1rOHFkAgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQxMzoyMTo0M1rOHFkAgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTU5NDg4MA==", "bodyText": "Is this condition still required, given RestSearchAction#preparePointInTime?", "url": "https://github.com/elastic/elasticsearch/pull/61062#discussion_r475594880", "createdAt": "2020-08-24T13:21:43Z", "author": {"login": "albertzaharovits"}, "path": "server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java", "diffHunk": "@@ -212,18 +283,27 @@ protected void doExecute(Task task, SearchRequest searchRequest, ActionListener<\n                 // situations when source is rewritten to null due to a bug\n                 searchRequest.source(source);\n             }\n-            final ClusterState clusterState = clusterService.state();\n-            final Map<String, OriginalIndices> remoteClusterIndices = remoteClusterService.groupIndices(searchRequest.indicesOptions(),\n-                searchRequest.indices());\n+            final SearchContextId searchContext;\n+            final Map<String, OriginalIndices> remoteClusterIndices;\n+            if (searchRequest.pointInTimeBuilder() != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0a454de0c5b6e084626d0b47cdc80e55c53f13d2"}, "originalPosition": 149}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa15e5dd65ed550eb761387f40b0ee1d9e7f0483", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa15e5dd65ed550eb761387f40b0ee1d9e7f0483", "committedDate": "2020-08-24T13:39:20Z", "message": "Merge branch 'master' into search-context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14c828891736b3298302c7d0ce8465c5479e8263", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/14c828891736b3298302c7d0ce8465c5479e8263", "committedDate": "2020-08-24T17:39:31Z", "message": "Fix rescore docIds"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3257, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}