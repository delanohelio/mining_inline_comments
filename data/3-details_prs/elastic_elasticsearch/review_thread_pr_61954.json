{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5MjExNTAx", "number": 61954, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozNToyMFrOEgbotg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTo0MToyMFrOEgb1_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDQyNjc4OnYy", "diffSide": "LEFT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozNToyMFrOHNSe2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNzozNjo0OVrOHNWnJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5NjM0NQ==", "bodyText": "Why is this no longer needed?", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483696345", "createdAt": "2020-09-04T15:35:20Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "diffHunk": "@@ -55,32 +53,6 @@ static RestIntegTestTask setupTask(Project project, String sourceSetName) {\n     static void setupRunnerTask(Project project, RestIntegTestTask testTask, SourceSet sourceSet) {\n         testTask.setTestClassesDirs(sourceSet.getOutput().getClassesDirs());\n         testTask.setClasspath(sourceSet.getRuntimeClasspath());\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc2NDAwNg==", "bodyText": "The test task depending on the module is handled within testclusters now. The plugin extension dependsOn is handled inside PluginBuildPlugin.", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483764006", "createdAt": "2020-09-04T17:36:49Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/RestTestUtil.java", "diffHunk": "@@ -55,32 +53,6 @@ static RestIntegTestTask setupTask(Project project, String sourceSetName) {\n     static void setupRunnerTask(Project project, RestIntegTestTask testTask, SourceSet sourceSet) {\n         testTask.setTestClassesDirs(sourceSet.getOutput().getClassesDirs());\n         testTask.setClasspath(sourceSet.getRuntimeClasspath());\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5NjM0NQ=="}, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDQ0MTE3OnYy", "diffSide": "RIGHT", "path": "distribution/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozODowMFrOHNSoVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTozODowMFrOHNSoVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzY5ODc3NQ==", "bodyText": "We should open an issue to use artifact transforms for this stuff as well so we don't have to keep doing this zipTree and singleFile nonsense. This is the same as the stuff @breskeby is working on to avoid a lot of unnecessary packing/unpacking in build processes.", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483698775", "createdAt": "2020-09-04T15:38:00Z", "author": {"login": "mark-vieira"}, "path": "distribution/build.gradle", "diffHunk": "@@ -139,11 +145,22 @@ tasks.register(\"buildTransportModules\") {\n   dependsOn \"processTransportOutputs\"\n   outputs.dir \"${transportOutputs}/modules\"\n }\n+tasks.register(\"buildExternalTestModules\") {\n+  dependsOn \"processExternalTestOutputs\"\n+  outputs.dir \"${externalTestOutputs}/modules\"\n+}\n+\n+Configuration moduleZip(Project module) {\n+  Dependency dep = project.dependencies.project(path: module.path, configuration: 'zip')\n+  Configuration config = project.configurations.detachedConfiguration(dep)\n+  return config\n+}\n \n void copyModule(Sync copyTask, Project module) {\n+  Configuration moduleConfig = moduleZip(module)\n   copyTask.configure {\n-    dependsOn \"${module.path}:bundlePlugin\"\n-    from({ zipTree(module.bundlePlugin.outputs.files.singleFile) }) {\n+    dependsOn moduleConfig\n+    from({ zipTree(moduleConfig.singleFile) }) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNDQ2MDc3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNTo0MToyMFrOHNS0bw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNjoyNjoxMVrOHNUYjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcwMTg3MQ==", "bodyText": "Seems basing this on name is a little brittle. Is there no way to add arbitrary metadata to modules?", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483701871", "createdAt": "2020-09-04T15:41:20Z", "author": {"login": "mark-vieira"}, "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -367,6 +368,9 @@ private static Bundle readPluginBundle(final Set<Bundle> bundles, final Path plu\n         if (bundles.add(bundle) == false) {\n             throw new IllegalStateException(\"duplicate \" + type + \": \" + info);\n         }\n+        if (type.equals(\"module\") && info.getName().startsWith(\"test-\") && Build.CURRENT.isSnapshot() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcyNzUwMg==", "bodyText": "There is not. We can add to the plugin properties, but I did not want to add an \"official\" property here, as it is really only about modules, yet the properties apply to all plugins and modules. I think the name checking is fine for now, since we completely own the namespace of modules.", "url": "https://github.com/elastic/elasticsearch/pull/61954#discussion_r483727502", "createdAt": "2020-09-04T16:26:11Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/plugins/PluginsService.java", "diffHunk": "@@ -367,6 +368,9 @@ private static Bundle readPluginBundle(final Set<Bundle> bundles, final Path plu\n         if (bundles.add(bundle) == false) {\n             throw new IllegalStateException(\"duplicate \" + type + \": \" + info);\n         }\n+        if (type.equals(\"module\") && info.getName().startsWith(\"test-\") && Build.CURRENT.isSnapshot() == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzcwMTg3MQ=="}, "originalCommit": {"oid": "ceb46cc19aec20b740407068c29f955696d69446"}, "originalPosition": 12}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1733, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}