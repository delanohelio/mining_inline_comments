{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0ODk0ODU2", "number": 63811, "title": "Fix broken parent and child aggregator", "bodyText": "In #57892 I broke some sub-aggregations inside of the parent and\nchild aggregator, specifically any sub-aggregations that do work in\nthe postCollect phase. This fixes it by delaying the post collect\nphase of aggs under parent and child until beforeBuildingBuckets\nbecause, well, we haven't done any collection until after that phase.", "createdAt": "2020-10-16T14:34:43Z", "url": "https://github.com/elastic/elasticsearch/pull/63811", "merged": true, "mergeCommit": {"oid": "769e30dd8847a7491ff581ea0de741611803296d"}, "closed": true, "closedAt": "2020-10-19T14:54:10Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTHTFxgH2gAyNTA0ODk0ODU2OjYwOWVjYjYyODM3MmJkOTU1ODE3ZmJhYWI4NTY5MzEzMWNiYTI5Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUFRy6gFqTUxMTg0MzcxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/609ecb628372bd955817fbaab85693131cba29c9", "committedDate": "2020-10-16T14:31:59Z", "message": "Fix broken parent and child aggregator\n\nIn #57892 I broke *some* sub-aggregations inside of the `parent` and\n`child` aggregator, specifically any sub-aggregations that do work in\nthe `postCollect` phase. This fixes it by delaying the post collect\nphase of aggs under `parent` and `child` until `beforeBuildingBuckets`\nbecause, well, we haven't done *any* collection until after that phase."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNTMxMzEx", "url": "https://github.com/elastic/elasticsearch/pull/63811#pullrequestreview-510531311", "createdAt": "2020-10-16T14:35:35Z", "commit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNDozNTozNVrOHjB0zg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNDozNzowMVrOHjB6hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MjExMA==", "bodyText": "I was borrowing this test setup and wanted to clean it up a bit while I was here. bulk is ever so slightly quicker for this sort of thing. And it takes up a lot fewer lines!", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506492110", "createdAt": "2020-10-16T14:35:35Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/yamlRestTest/resources/rest-api-spec/test/20_parent_join.yml", "diffHunk": "@@ -3,53 +3,30 @@ setup:\n       indices.create:\n         index: test\n         body:\n+          settings:\n+            number_of_shards: 2 #Two shards proves that we route properly\n           mappings:\n             properties:\n               join_field: { \"type\": \"join\", \"relations\": { \"parent\": \"child\", \"child\": \"grand_child\" } }\n               id: { \"type\": \"keyword\" }\n \n   - do:\n-      index:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MjQ4Mg==", "bodyText": "I moved this into 40_aggregations.yml.", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506492482", "createdAt": "2020-10-16T14:35:57Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/test/resources/rest-api-spec/test/40_unconfigred.yml", "diffHunk": "@@ -1,24 +0,0 @@\n----\n-\"unconfigured\":\n-  - do:\n-      index:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjQ5MzU3NA==", "bodyText": "I think we'd be better off removing postCollection entirely and replacing it with beforeBuildingBuckets because it is very similar but it has access to the buckets we actually want.", "url": "https://github.com/elastic/elasticsearch/pull/63811#discussion_r506493574", "createdAt": "2020-10-16T14:37:01Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java", "diffHunk": "@@ -250,9 +250,12 @@ public SearchContext context() {\n \n     /**\n      * Called after collection of all document is done.\n+     * <p>\n+     * Warning: this is not final only to allow the parent join aggregator\n+     * to delay this until building buckets.\n      */\n     @Override\n-    public final void postCollection() throws IOException {\n+    public void postCollection() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExODQzNzEx", "url": "https://github.com/elastic/elasticsearch/pull/63811#pullrequestreview-511843711", "createdAt": "2020-10-19T14:44:41Z", "commit": {"oid": "609ecb628372bd955817fbaab85693131cba29c9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3884, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}