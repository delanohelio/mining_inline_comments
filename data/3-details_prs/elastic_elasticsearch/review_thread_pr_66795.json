{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0OTQ5MDkx", "number": 66795, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo0MToxM1rOFIrmGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOTozMToxMFrOFItAPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjQ3MTk0OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo0MToxM1rOIKvGKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxODo1ODozOFrOIKv9Gw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ==", "bodyText": "If there is a default mapping, this call mapperService.documentMapper(type) returns a non-null mapper for the _default_ type. So this refactor may change the type query behavior slightly. This seems acceptable since default mappings were deprecated in 6.0 and the type query isn't completely clear on this behavior, but it felt worth pointing out.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548128299", "createdAt": "2020-12-23T18:41:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEzMDE1OA==", "bodyText": "I think it only returns something for _default_ if there isn't another mapping. Which, I think, only happens when the index is in the process of being made. Though, I can fiddle with it a bit to see if a totally empty mapping gets it.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548130158", "createdAt": "2020-12-23T18:43:33Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}, "originalCommit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MjIzMw==", "bodyText": "I played around a bit - I don't think you can have documents in the index and not have a DocumentMapper. So I think this is safe.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548142233", "createdAt": "2020-12-23T18:58:26Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}, "originalCommit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "originalPosition": 171}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE0MjM2Mw==", "bodyText": "And if it isn't then that change is quite small.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548142363", "createdAt": "2020-12-23T18:58:38Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -620,11 +629,7 @@ public IndexSettings getIndexSettings() {\n     }\n \n     public String getType() {\n-        return mapperService.documentMapper() == null ? null : mapperService.documentMapper().type();\n-    }\n-\n-    public boolean typeExists(String type) {\n-        return mapperService.documentMapper(type) != null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODEyODI5OQ=="}, "originalCommit": {"oid": "f74ca216bdc0e4fe1febaa6305bf0b9de3675d9c"}, "originalPosition": 171}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQ0NjcwMjY4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOTozMToxMFrOIKxd5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxOTozNjowNFrOIKxs3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA==", "bodyText": "this threw me off: how can typeExists be replaced with an equality check?", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548167140", "createdAt": "2020-12-23T19:31:10Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "diffHunk": "@@ -129,7 +129,7 @@ public String getWriteableName() {\n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n         deprecationLogger.deprecate(\"type_query\", TYPES_DEPRECATION_MESSAGE);\n-        if (context.typeExists(type)) {\n+        if (context.getType().equals(type)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3MDA3NA==", "bodyText": "Weird, right? There is only one type in an index in 7.x and either the type you are searching is it or it ain't. There was some complexity around getting the _default_ mapper, but you could only get it if the there isn't a type. Check out MapperService#documentMapper(String type) for the trick. I only changed this so we'd use the snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548170074", "createdAt": "2020-12-23T19:35:01Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "diffHunk": "@@ -129,7 +129,7 @@ public String getWriteableName() {\n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n         deprecationLogger.deprecate(\"type_query\", TYPES_DEPRECATION_MESSAGE);\n-        if (context.typeExists(type)) {\n+        if (context.getType().equals(type)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA=="}, "originalCommit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE3MDk3Mg==", "bodyText": "And, to top it off, there can't not be a type and be documents in the index. So all that funny stuff around _default_ doesn't do anything in this case.", "url": "https://github.com/elastic/elasticsearch/pull/66795#discussion_r548170972", "createdAt": "2020-12-23T19:36:04Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/query/TypeQueryBuilder.java", "diffHunk": "@@ -129,7 +129,7 @@ public String getWriteableName() {\n     @Override\n     protected Query doToQuery(QueryShardContext context) throws IOException {\n         deprecationLogger.deprecate(\"type_query\", TYPES_DEPRECATION_MESSAGE);\n-        if (context.typeExists(type)) {\n+        if (context.getType().equals(type)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0ODE2NzE0MA=="}, "originalCommit": {"oid": "80f526c9da1f2a11e9dc84aba50ea8aa27d5a00b"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4433, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}