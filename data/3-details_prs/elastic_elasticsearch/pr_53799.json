{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxMDIwMDEx", "number": 53799, "title": "Improve async search's tasks cancellation", "bodyText": "This commit adds an explicit cancellation of the search task if the initial async search submit task is cancelled (connection closed by the user). This was previously done through the cancellation of the parent task but we don't handle grand-children cancellation yet so we have to manually cancel the search task in order to ensure that shard actions are cancelled too.\nThis change can be considered as a workaround until #50990 is resolved.", "createdAt": "2020-03-19T13:59:14Z", "url": "https://github.com/elastic/elasticsearch/pull/53799", "merged": true, "mergeCommit": {"oid": "68f42979f74d8653d3006078100ed55aa84c51ae"}, "closed": true, "closedAt": "2020-03-24T11:31:08Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPMVVzgH2gAyMzkxMDIwMDExOmQ3ODFkYzdmMmJjNmZkZjE2MzZiZjQ0M2Q0M2MzNGYxNjZlYmYyZjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQo8RDAH2gAyMzkxMDIwMDExOmQ3NDU5MmRkYjJlZWNhMDEwMmY1NTg3MTlmMDE2NGM1MjYwYmRmNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7", "committedDate": "2020-03-19T13:57:07Z", "message": "Improve async search's tasks cancellation\n\nThis commit adds an explicit cancellation of the search task if\nthe initial async search submit task is cancelled (connection closed by the user).\nThis was previously done through the cancellation of the parent task but we don't\nhandle grand-children cancellation yet so we have to manually cancel the search task\nin order to ensure that shard actions are cancelled too.\nThis change can be considered as a workaround until #50990 is fixed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4NTIwMTQx", "url": "https://github.com/elastic/elasticsearch/pull/53799#pullrequestreview-378520141", "createdAt": "2020-03-20T14:16:09Z", "commit": {"oid": "d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxNjowOVrOF5VejA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNDoxNjowOVrOF5VejA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTY2NTAzNg==", "bodyText": "shall we still set the parent task id anyways just for the consistency of the tasks tree, or is it required that we don't do so?", "url": "https://github.com/elastic/elasticsearch/pull/53799#discussion_r395665036", "createdAt": "2020-03-20T14:16:09Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -77,15 +79,16 @@\n     AsyncSearchTask(long id,\n                     String type,\n                     String action,\n-                    TaskId parentTaskId,\n+                    CancellableTask submitTask,\n                     TimeValue keepAlive,\n                     Map<String, String> originHeaders,\n                     Map<String, String> taskHeaders,\n                     AsyncSearchId searchId,\n                     Client client,\n                     ThreadPool threadPool,\n                     Supplier<InternalAggregation.ReduceContext> aggReduceContextSupplier) {\n-        super(id, type, action, \"async_search\", parentTaskId, taskHeaders);\n+        super(id, type, action, \"async_search\", TaskId.EMPTY_TASK_ID, taskHeaders);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d781dc7f2bc6fdf1636bf443d43c34f166ebf2f7"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f892ebf24ae0e4997ca3b73dc43f1761dc3667", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3f892ebf24ae0e4997ca3b73dc43f1761dc3667", "committedDate": "2020-03-23T17:56:07Z", "message": "address review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c052a19209f37e5bc8c05dfb5647e5dc0b56bc", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1c052a19209f37e5bc8c05dfb5647e5dc0b56bc", "committedDate": "2020-03-23T18:33:18Z", "message": "Merge branch 'master' into async_search_submit_cancellation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d177d965346d0a489962bbd109823314ce39d37d", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d177d965346d0a489962bbd109823314ce39d37d", "committedDate": "2020-03-24T01:07:18Z", "message": "Merge branch 'master' into async_search_submit_cancellation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d74592ddb2eeca0102f558719f0164c5260bdf66", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d74592ddb2eeca0102f558719f0164c5260bdf66", "committedDate": "2020-03-24T01:50:54Z", "message": "set the parent task id on the submit search request"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1851, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}