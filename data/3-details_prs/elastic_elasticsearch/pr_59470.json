{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4NDk3MzU5", "number": 59470, "title": "Audited API Key authentication might not have a realm name", "bodyText": "The Authentication object that gets built following an API Key authentication contains the realm name of the owner user that created the key (which is audited), but the specific field used for storing that changed in #51305 .\nThis PR makes it so that auditing tolerates an \"unfound\" realm name (so it doesn't throw an NPE), because the owner realm name is not under the expected field.\nCloses #59425", "createdAt": "2020-07-13T21:19:06Z", "url": "https://github.com/elastic/elasticsearch/pull/59470", "merged": true, "mergeCommit": {"oid": "4f8ff438d21441187c4abd4717d3ae6babf0238f"}, "closed": true, "closedAt": "2020-07-14T11:10:54Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc0oA07gH2gAyNDQ4NDk3MzU5OjQ1ZWNjMjkxMmRlOTRhOTZjYmM1NWE5M2Y0ZDg2MWIyODM4ZWZkYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0zZxRgH2gAyNDQ4NDk3MzU5OmNjZWFmZDM3OTBmZTUyN2U0Nzk4ODEzNTRmMDBlMDA1NGE0OGU3OGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45ecc2912de94a96cbc55a93f4d861b2838efdc8", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/45ecc2912de94a96cbc55a93f4d861b2838efdc8", "committedDate": "2020-07-13T21:07:15Z", "message": "Realm could be null for API key authn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3NzAyNDc0", "url": "https://github.com/elastic/elasticsearch/pull/59470#pullrequestreview-447702474", "createdAt": "2020-07-14T00:27:38Z", "commit": {"oid": "45ecc2912de94a96cbc55a93f4d861b2838efdc8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMDoyNzozOFrOGw_eiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQwMDoyNzozOFrOGw_eiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDAyNDg0Mw==", "bodyText": "This can just be\nlogEntry.with(PRINCIPAL_REALM_FIELD_NAME, creatorRealmName);", "url": "https://github.com/elastic/elasticsearch/pull/59470#discussion_r454024843", "createdAt": "2020-07-14T00:27:38Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -819,9 +833,13 @@ LogEntryBuilder withAuthentication(Authentication authentication) {\n             logEntry.with(AUTHENTICATION_TYPE_FIELD_NAME, authentication.getAuthenticationType().toString());\n             if (Authentication.AuthenticationType.API_KEY == authentication.getAuthenticationType()) {\n                 logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY))\n-                        .with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY))\n-                        .with(PRINCIPAL_REALM_FIELD_NAME,\n-                                (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME));\n+                        .with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY));\n+                String creatorRealmName = (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME);\n+                if (creatorRealmName != null) {\n+                    // can be null for API keys created before version 7.7\n+                    logEntry.with(PRINCIPAL_REALM_FIELD_NAME,\n+                            (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45ecc2912de94a96cbc55a93f4d861b2838efdc8"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "333d6708df50f78a5790527951e705d9034435fb", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/333d6708df50f78a5790527951e705d9034435fb", "committedDate": "2020-07-14T10:12:47Z", "message": "Merge branch 'master' into audit_log_null_realm_for_api_keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cceafd3790fe527e479881354f00e0054a48e78e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/cceafd3790fe527e479881354f00e0054a48e78e", "committedDate": "2020-07-14T10:23:27Z", "message": "review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4446, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}