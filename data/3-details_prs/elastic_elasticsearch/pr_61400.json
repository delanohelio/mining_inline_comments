{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcxMzkxNTc5", "number": 61400, "title": "Remove node from cluster when node locks broken", "bodyText": "In #52680 we introduced a mechanism that will allow nodes to remove\nthemselves from the cluster if they locally determine themselves to be\nunhealthy. The only check today is that their data paths are all\nempirically writeable. This commit extends this check to consider a\nfailure of NodeEnvironment#assertEnvIsLocked() to be an indication of\nunhealthiness.\nCloses #58373", "createdAt": "2020-08-21T05:27:35Z", "url": "https://github.com/elastic/elasticsearch/pull/61400", "merged": true, "mergeCommit": {"oid": "71d0958c4d420d45e262c8f84e6c333e53e83f89"}, "closed": true, "closedAt": "2020-09-22T09:08:21Z", "author": {"login": "amoghRZP"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdA0unegH2gAyNDcxMzkxNTc5Ojk0NzhlMmJkMTdkMGFjNzAwZmUyOGNiN2UyMmM4OTJjYzRkNTg5OTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJpqrwgH2gAyNDcxMzkxNTc5OmZkOWQyOTIwZjk1MDAxYjgyN2VmY2UwMjBlOWVlZmI4YzBiMmZjYzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/9478e2bd17d0ac700fe28cb7e22c892cc4d58999", "committedDate": "2020-08-20T18:43:13Z", "message": "Remove node from cluster when node locks are broken."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyMjUxNDcw", "url": "https://github.com/elastic/elasticsearch/pull/61400#pullrequestreview-472251470", "createdAt": "2020-08-21T07:02:23Z", "commit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwNzowMjoyM1rOHEeAzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMVQwNzoxNTowOVrOHEeneg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ0ODA3OA==", "bodyText": "I'd prefer the try{} block only to contain the call to nodeEnv.nodeDataPaths(), would you reduce its scope? That way you don't need a local lockAssertionFailed, you can set brokenLock and exit immediately.", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r474448078", "createdAt": "2020-08-21T07:02:23Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/monitor/fs/FsHealthService.java", "diffHunk": "@@ -150,32 +153,39 @@ public void run() {\n \n         private void monitorFSHealth() {\n             Set<Path> currentUnhealthyPaths = null;\n-            for (Path path : nodeEnv.nodeDataPaths()) {\n-                long executionStartTime = currentTimeMillisSupplier.getAsLong();\n-                try {\n-                    if (Files.exists(path)) {\n-                        Path tempDataPath = path.resolve(TEMP_FILE_NAME);\n-                        Files.deleteIfExists(tempDataPath);\n-                        try (OutputStream os = Files.newOutputStream(tempDataPath, StandardOpenOption.CREATE_NEW)) {\n-                            os.write(byteToWrite);\n-                            IOUtils.fsync(tempDataPath, false);\n+            boolean lockAssertionFailed = false;\n+            try {\n+                for (Path path : nodeEnv.nodeDataPaths()) {\n+                    long executionStartTime = currentTimeMillisSupplier.getAsLong();\n+                    try {\n+                        if (Files.exists(path)) {\n+                            Path tempDataPath = path.resolve(TEMP_FILE_NAME);\n+                            Files.deleteIfExists(tempDataPath);\n+                            try (OutputStream os = Files.newOutputStream(tempDataPath, StandardOpenOption.CREATE_NEW)) {\n+                                os.write(byteToWrite);\n+                                IOUtils.fsync(tempDataPath, false);\n+                            }\n+                            Files.delete(tempDataPath);\n+                            final long elapsedTime = currentTimeMillisSupplier.getAsLong() - executionStartTime;\n+                            if (elapsedTime > slowPathLoggingThreshold.millis()) {\n+                                logger.warn(\"health check of [{}] took [{}ms] which is above the warn threshold of [{}]\",\n+                                    path, elapsedTime, slowPathLoggingThreshold);\n+                            }\n                         }\n-                        Files.delete(tempDataPath);\n-                        final long elapsedTime = currentTimeMillisSupplier.getAsLong() - executionStartTime;\n-                        if (elapsedTime > slowPathLoggingThreshold.millis()) {\n-                            logger.warn(\"health check of [{}] took [{}ms] which is above the warn threshold of [{}]\",\n-                                path, elapsedTime, slowPathLoggingThreshold);\n+                    } catch (Exception ex) {\n+                        logger.error(new ParameterizedMessage(\"health check of [{}] failed\", path), ex);\n+                        if (currentUnhealthyPaths == null) {\n+                            currentUnhealthyPaths = new HashSet<>(1);\n                         }\n+                        currentUnhealthyPaths.add(path);\n                     }\n-                } catch (Exception ex) {\n-                    logger.error(new ParameterizedMessage(\"health check of [{}] failed\", path), ex);\n-                    if (currentUnhealthyPaths == null) {\n-                        currentUnhealthyPaths = new HashSet<>(1);\n-                    }\n-                    currentUnhealthyPaths.add(path);\n                 }\n+            } catch (IllegalStateException e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "originalPosition": 68}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1MTU5Mg==", "bodyText": "Minor wording nit: specify which lock was broken (and remove redundant on node), suggest this:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        statusInfo = new StatusInfo(UNHEALTHY, \"health check failed on node due to broken locks\");\n          \n          \n            \n                        statusInfo = new StatusInfo(UNHEALTHY, \"health check failed due to broken node lock\");", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r474451592", "createdAt": "2020-08-21T07:06:59Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/monitor/fs/FsHealthService.java", "diffHunk": "@@ -117,6 +118,8 @@ public StatusInfo getHealth() {\n         Set<Path> unhealthyPaths = this.unhealthyPaths;\n         if (enabled == false) {\n             statusInfo = new StatusInfo(HEALTHY, \"health check disabled\");\n+        } else if (brokenLock == true) {\n+            statusInfo = new StatusInfo(UNHEALTHY, \"health check failed on node due to broken locks\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1NDI2Mg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r474454262", "createdAt": "2020-08-21T07:10:27Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/monitor/fs/FsHealthServiceTests.java", "diffHunk": "@@ -254,7 +383,8 @@ public int getInjectedPathCount(){\n         public OutputStream newOutputStream(Path path, OpenOption... options) throws IOException {\n             if (injectIOException.get()){\n                 assert pathPrefix != null : \"must set pathPrefix before starting disruptions\";\n-                if (path.toString().startsWith(pathPrefix) && path.toString().endsWith(\".es_temp_file\")) {\n+                if (path.toString().startsWith(pathPrefix) && path.toString().\n+                    endsWith(FsHealthService.FsHealthMonitor.TEMP_FILE_NAME)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "originalPosition": 152}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1NDMyMg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r474454322", "createdAt": "2020-08-21T07:10:31Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/monitor/fs/FsHealthServiceTests.java", "diffHunk": "@@ -289,7 +419,8 @@ public FileChannel newFileChannel(Path path, Set<? extends OpenOption> options,\n                 public void force(boolean metaData) throws IOException {\n                     if (injectIOException.get()) {\n                         assert pathPrefix != null : \"must set pathPrefix before starting disruptions\";\n-                        if (path.toString().startsWith(pathPrefix) && path.toString().endsWith(\".es_temp_file\")) {\n+                        if (path.toString().startsWith(pathPrefix) && path.toString().\n+                            endsWith(FsHealthService.FsHealthMonitor.TEMP_FILE_NAME)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "originalPosition": 162}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NDQ1Nzk3OA==", "bodyText": "Thorough tests \ud83d\ude04 However they're not really testing anything in the FsHealthService so much as testing the details of the implementation of the NativeFSLock. Let's just have one of these here, and maybe consider filling in any gaps in Lucene's TestNativeFSLockFactory separately.", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r474457978", "createdAt": "2020-08-21T07:15:09Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/monitor/fs/FsHealthServiceTests.java", "diffHunk": "@@ -231,6 +234,132 @@ public void testFailsHealthOnSinglePathWriteFailure() throws IOException {\n         }\n     }\n \n+    public void testFailsHealthOnMissingLockFile() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9478e2bd17d0ac700fe28cb7e22c892cc4d58999"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ce8839e717fb6a3702e4057d395d15206465f38", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ce8839e717fb6a3702e4057d395d15206465f38", "committedDate": "2020-08-24T10:21:04Z", "message": "Merge remote-tracking branch 'origin/master' into broken_nl_handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eeb51baa6ca2a8abd10a91d9d4cc351873531af0", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/eeb51baa6ca2a8abd10a91d9d4cc351873531af0", "committedDate": "2020-08-24T11:31:56Z", "message": "changes as per suggested in review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c43b6fb219f356bbb85990042856480534f49a75", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/c43b6fb219f356bbb85990042856480534f49a75", "committedDate": "2020-08-24T11:44:19Z", "message": "Keeping one test for broken node locks in FsHealthServiceTests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2NTgxNjg2", "url": "https://github.com/elastic/elasticsearch/pull/61400#pullrequestreview-476581686", "createdAt": "2020-08-27T10:19:40Z", "commit": {"oid": "c43b6fb219f356bbb85990042856480534f49a75"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDoxOTo0MFrOHIJ3ow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxMDoyMDo1NlrOHIJ6Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMxMjM1NQ==", "bodyText": "Clearing this flag here may mean the node reports itself as healthy even though it hasn't actually passed this health check yet. I think we should clear this flag only after setting unhealthyPaths at the very bottom of this method.", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r478312355", "createdAt": "2020-08-27T10:19:40Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/monitor/fs/FsHealthService.java", "diffHunk": "@@ -150,7 +153,17 @@ public void run() {\n \n         private void monitorFSHealth() {\n             Set<Path> currentUnhealthyPaths = null;\n-            for (Path path : nodeEnv.nodeDataPaths()) {\n+            brokenLock = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c43b6fb219f356bbb85990042856480534f49a75"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODMxMjk3NA==", "bodyText": "Minor wording nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.error(\"Lock assertions failed due to\", e);\n          \n          \n            \n                            logger.error(\"health check failed\", e);", "url": "https://github.com/elastic/elasticsearch/pull/61400#discussion_r478312974", "createdAt": "2020-08-27T10:20:56Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/monitor/fs/FsHealthService.java", "diffHunk": "@@ -150,7 +153,17 @@ public void run() {\n \n         private void monitorFSHealth() {\n             Set<Path> currentUnhealthyPaths = null;\n-            for (Path path : nodeEnv.nodeDataPaths()) {\n+            brokenLock = false;\n+            Path[] paths = null;\n+            try {\n+                paths = nodeEnv.nodeDataPaths();\n+            } catch (IllegalStateException e) {\n+                logger.error(\"Lock assertions failed due to\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c43b6fb219f356bbb85990042856480534f49a75"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841a8b17a121c7c6e045a2a74fe92d465f736c85", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/841a8b17a121c7c6e045a2a74fe92d465f736c85", "committedDate": "2020-08-28T05:11:29Z", "message": "Merge branch 'master' into broken_nl_handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a207fb5ad94c306b2a19ab6bef3673d62764e2c", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a207fb5ad94c306b2a19ab6bef3673d62764e2c", "committedDate": "2020-08-28T05:13:25Z", "message": "Changes error message being logged and clearing boolean flag at the end of the method."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9caac476d4289960a8cdc964a5fee849b254b13f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9caac476d4289960a8cdc964a5fee849b254b13f", "committedDate": "2020-09-16T10:08:42Z", "message": "Merge branch 'master' into broken_nl_handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NDc0MTMy", "url": "https://github.com/elastic/elasticsearch/pull/61400#pullrequestreview-489474132", "createdAt": "2020-09-16T10:09:05Z", "commit": {"oid": "4a207fb5ad94c306b2a19ab6bef3673d62764e2c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd9d2920f95001b827efce020e9eefb8c0b2fcc7", "author": {"user": {"login": "amoghRZP", "name": "Amogh Mishra"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd9d2920f95001b827efce020e9eefb8c0b2fcc7", "committedDate": "2020-09-17T04:55:17Z", "message": "Merge remote-tracking branch 'upstream/master' into broken_nl_handling"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4827, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}