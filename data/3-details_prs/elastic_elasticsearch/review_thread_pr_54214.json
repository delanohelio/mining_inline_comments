{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNzI3MzM4", "number": 54214, "reviewThreads": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNToxM1rODtbJtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo1NzoyMVrODtdgcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU3MzY2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/results/CategoryDefinitionTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNToxM1rOF-1kzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNToxM1rOF-1kzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzMzgwNA==", "bodyText": "I think you could simplify this to:\nLongStream.generate(ESTestCase::randomNonNegativeLong).limit(10).toArray()", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401433804", "createdAt": "2020-04-01T08:15:13Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/results/CategoryDefinitionTests.java", "diffHunk": "@@ -28,6 +31,15 @@ public CategoryDefinition createTestInstance(String jobId) {\n         if (randomBoolean()) {\n             categoryDefinition.setGrokPattern(randomAlphaOfLength(50));\n         }\n+        if (randomBoolean()) {\n+            categoryDefinition.setNumMatches(randomNonNegativeLong());\n+        }\n+        if (randomBoolean()) {\n+            categoryDefinition.setPreferredToCategories(Stream.generate(ESTestCase::randomNonNegativeLong)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU3NTk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/results/CategoryDefinitionTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNTo1MVrOF-1mPQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMjoyNDo1OFrOF--JCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNDE3Mw==", "bodyText": "Just out of curiosity: Is this something new? I haven't seen this before.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401434173", "createdAt": "2020-04-01T08:15:51Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/results/CategoryDefinitionTests.java", "diffHunk": "@@ -5,18 +5,21 @@\n  */\n package org.elasticsearch.xpack.ml.job.results;\n \n+import org.elasticsearch.Version;\n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.common.xcontent.json.JsonXContent;\n-import org.elasticsearch.test.AbstractSerializingTestCase;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.core.ml.AbstractBWCSerializationTestCase;\n import org.elasticsearch.xpack.core.ml.job.results.CategoryDefinition;\n \n import java.io.IOException;\n import java.util.Arrays;\n+import java.util.stream.Stream;\n \n import static org.hamcrest.Matchers.containsString;\n \n-public class CategoryDefinitionTests extends AbstractSerializingTestCase<CategoryDefinition> {\n+public class CategoryDefinitionTests extends AbstractBWCSerializationTestCase<CategoryDefinition> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU3NDE1Mw==", "bodyText": "yes, well, sort of new.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401574153", "createdAt": "2020-04-01T12:24:58Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/results/CategoryDefinitionTests.java", "diffHunk": "@@ -5,18 +5,21 @@\n  */\n package org.elasticsearch.xpack.ml.job.results;\n \n+import org.elasticsearch.Version;\n import org.elasticsearch.common.io.stream.Writeable;\n import org.elasticsearch.common.xcontent.XContentParser;\n import org.elasticsearch.common.xcontent.json.JsonXContent;\n-import org.elasticsearch.test.AbstractSerializingTestCase;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.core.ml.AbstractBWCSerializationTestCase;\n import org.elasticsearch.xpack.core.ml.job.results.CategoryDefinition;\n \n import java.io.IOException;\n import java.util.Arrays;\n+import java.util.stream.Stream;\n \n import static org.hamcrest.Matchers.containsString;\n \n-public class CategoryDefinitionTests extends AbstractSerializingTestCase<CategoryDefinition> {\n+public class CategoryDefinitionTests extends AbstractBWCSerializationTestCase<CategoryDefinition> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNDE3Mw=="}, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU3NzA3OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/anomaly-detection/apis/get-category.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNjowNlrOF-1m2w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxNjowNlrOF-1m2w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNDMzMQ==", "bodyText": "guaranteed", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401434331", "createdAt": "2020-04-01T08:16:06Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/ml/anomaly-detection/apis/get-category.asciidoc", "diffHunk": "@@ -93,6 +93,16 @@ category.\n (string) A space separated list of the common tokens that are matched in values\n of the category.\n \n+`num_matches`::\n+(long) The number of messages that have been matched by this category. This is\n+only guarunteed to have the latest accurate count after a job `_flush` or `_close`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU4NDUwOnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/anomaly-detection/apis/get-category.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxODowNlrOF-1rag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxODowNlrOF-1rag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNTQ5OA==", "bodyText": "guaranteed", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401435498", "createdAt": "2020-04-01T08:18:06Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/ml/anomaly-detection/apis/get-category.asciidoc", "diffHunk": "@@ -93,6 +93,16 @@ category.\n (string) A space separated list of the common tokens that are matched in values\n of the category.\n \n+`num_matches`::\n+(long) The number of messages that have been matched by this category. This is\n+only guarunteed to have the latest accurate count after a job `_flush` or `_close`\n+\n+`preferred_to_categories`::\n+(list) A list of `category_id` entries that this current category encompasses.\n+Any new message that is processed by the categorizer will match against this\n+category and not any of the categories in this list. This is only guarunteed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU4OTM3OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxOToyNVrOF-1uVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoxOToyNVrOF-1uVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNjI0NQ==", "bodyText": "I would feel better if preferredToCategories.isEmpty() == false was in parentheses, just in case ;)", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401436245", "createdAt": "2020-04-01T08:19:25Z", "author": {"login": "przemekwitek"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -140,6 +163,10 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (grokPattern != null) {\n             builder.field(GROK_PATTERN.getPreferredName(), grokPattern);\n         }\n+        builder.field(NUM_MATCHES.getPreferredName(), numMatches);\n+        if (preferredToCategories != null && preferredToCategories.isEmpty() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTU5MjgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoyMDoyM1rOF-1wUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMjo1MzozOVrOF-_LjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNjc1NQ==", "bodyText": "Is it ok to pass array reference here? Should we make a copy maybe?", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401436755", "createdAt": "2020-04-01T08:20:23Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -152,6 +167,26 @@ public void setGrokPattern(String grokPattern) {\n         this.grokPattern = grokPattern;\n     }\n \n+    public long[] getPreferredToCategories() {\n+        return preferredToCategories;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU5MTE4MQ==", "bodyText": "I don't think there is much danger. No code paths are using this getter outside of tests.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401591181", "createdAt": "2020-04-01T12:53:39Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -152,6 +167,26 @@ public void setGrokPattern(String grokPattern) {\n         this.grokPattern = grokPattern;\n     }\n \n+    public long[] getPreferredToCategories() {\n+        return preferredToCategories;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzNjc1NQ=="}, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTYwMTc5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/CategorizationIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoyMzowMlrOF-12Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoyMzowMlrOF-12Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzODI2Mw==", "bodyText": "You could use hasSize here for brevity.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401438263", "createdAt": "2020-04-01T08:23:02Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/CategorizationIT.java", "diffHunk": "@@ -205,6 +205,93 @@ public void testCategorizationPerformance() {\n                 (MachineLearning.CATEGORIZATION_TOKENIZATION_IN_JAVA ? \"Java\" : \"C++\") + \" took \" + duration + \"ms\");\n     }\n \n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/ml-cpp/pull/1062\")\n+    public void testNumMatchesAndCategoryPreference() throws Exception {\n+        String index = \"hadoop_logs\";\n+        client().admin().indices().prepareCreate(index)\n+            .setMapping(\"time\", \"type=date,format=epoch_millis\",\n+                \"msg\", \"type=text\")\n+            .get();\n+\n+        nowMillis = System.currentTimeMillis();\n+\n+        BulkRequestBuilder bulkRequestBuilder = client().prepareBulk();\n+        IndexRequest indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(8).millis(),\n+            \"msg\", \"2015-10-18 18:01:51,963 INFO [main] org.mortbay.log: jetty-6.1.26\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(7).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.mortbay.log: Started HttpServer2$SelectChannelConnectorWithSafeStartup@0.0.0.0:62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(6).millis(),\n+            \"msg\", \"2015-10-18 18:01:53,400 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Registered webapp guice modules\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(5).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,447 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerRequestor: nodeBlacklistingEnabled:true\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(4).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Web app /mapreduce started at 62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(2).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,557 INFO [main] org.apache.hadoop.yarn.client.RMProxy: \" +\n+                \"Connecting to ResourceManager at msra-sa-41/10.190.173.170:8030\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(1).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerAllocator: \" +\n+                \"maxContainerCapability: <memory:8192, vCores:32>\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis,\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy: \" +\n+                \"yarn.client.max-cached-nodemanagers-proxies : 0\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+\n+        BulkResponse bulkResponse = bulkRequestBuilder\n+            .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE)\n+            .get();\n+        assertThat(bulkResponse.hasFailures(), is(false));\n+\n+        Job.Builder job = newJobBuilder(\"categorization-with-preferred-categories\", Collections.emptyList());\n+        registerJob(job);\n+        putJob(job);\n+        openJob(job.getId());\n+\n+        String datafeedId = job.getId() + \"-feed\";\n+        DatafeedConfig.Builder datafeedConfig = new DatafeedConfig.Builder(datafeedId, job.getId());\n+        datafeedConfig.setIndices(Collections.singletonList(index));\n+        DatafeedConfig datafeed = datafeedConfig.build();\n+        registerDatafeed(datafeed);\n+        putDatafeed(datafeed);\n+        startDatafeed(datafeedId, 0, nowMillis + 1);\n+        waitUntilJobIsClosed(job.getId());\n+\n+        List<CategoryDefinition> categories = getCategories(job.getId());\n+        assertThat(categories.size(), equalTo(7));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTYwMjY1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/CategorizationIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODoyMzoyMFrOF-12yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQxMjo1NToyOVrOF-_QmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzODQwOA==", "bodyText": "You could use arrayWithSize matcher here.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401438408", "createdAt": "2020-04-01T08:23:20Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/CategorizationIT.java", "diffHunk": "@@ -205,6 +205,93 @@ public void testCategorizationPerformance() {\n                 (MachineLearning.CATEGORIZATION_TOKENIZATION_IN_JAVA ? \"Java\" : \"C++\") + \" took \" + duration + \"ms\");\n     }\n \n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/ml-cpp/pull/1062\")\n+    public void testNumMatchesAndCategoryPreference() throws Exception {\n+        String index = \"hadoop_logs\";\n+        client().admin().indices().prepareCreate(index)\n+            .setMapping(\"time\", \"type=date,format=epoch_millis\",\n+                \"msg\", \"type=text\")\n+            .get();\n+\n+        nowMillis = System.currentTimeMillis();\n+\n+        BulkRequestBuilder bulkRequestBuilder = client().prepareBulk();\n+        IndexRequest indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(8).millis(),\n+            \"msg\", \"2015-10-18 18:01:51,963 INFO [main] org.mortbay.log: jetty-6.1.26\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(7).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.mortbay.log: Started HttpServer2$SelectChannelConnectorWithSafeStartup@0.0.0.0:62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(6).millis(),\n+            \"msg\", \"2015-10-18 18:01:53,400 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Registered webapp guice modules\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(5).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,447 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerRequestor: nodeBlacklistingEnabled:true\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(4).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Web app /mapreduce started at 62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(2).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,557 INFO [main] org.apache.hadoop.yarn.client.RMProxy: \" +\n+                \"Connecting to ResourceManager at msra-sa-41/10.190.173.170:8030\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(1).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerAllocator: \" +\n+                \"maxContainerCapability: <memory:8192, vCores:32>\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis,\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy: \" +\n+                \"yarn.client.max-cached-nodemanagers-proxies : 0\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+\n+        BulkResponse bulkResponse = bulkRequestBuilder\n+            .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE)\n+            .get();\n+        assertThat(bulkResponse.hasFailures(), is(false));\n+\n+        Job.Builder job = newJobBuilder(\"categorization-with-preferred-categories\", Collections.emptyList());\n+        registerJob(job);\n+        putJob(job);\n+        openJob(job.getId());\n+\n+        String datafeedId = job.getId() + \"-feed\";\n+        DatafeedConfig.Builder datafeedConfig = new DatafeedConfig.Builder(datafeedId, job.getId());\n+        datafeedConfig.setIndices(Collections.singletonList(index));\n+        DatafeedConfig datafeed = datafeedConfig.build();\n+        registerDatafeed(datafeed);\n+        putDatafeed(datafeed);\n+        startDatafeed(datafeedId, 0, nowMillis + 1);\n+        waitUntilJobIsClosed(job.getId());\n+\n+        List<CategoryDefinition> categories = getCategories(job.getId());\n+        assertThat(categories.size(), equalTo(7));\n+\n+        CategoryDefinition category1 = categories.get(0);\n+        assertThat(category1.getNumMatches(), equalTo(2L));\n+        long[] expectedPreferenceTo = new long[]{2L, 3L, 4L, 5L, 6L};\n+        assertThat(category1.getPreferredToCategories().length, equalTo(5));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 85}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTU5MjQ3Mg==", "bodyText": "that only works on boxed object arrays. Not native arrays.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401592472", "createdAt": "2020-04-01T12:55:29Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/CategorizationIT.java", "diffHunk": "@@ -205,6 +205,93 @@ public void testCategorizationPerformance() {\n                 (MachineLearning.CATEGORIZATION_TOKENIZATION_IN_JAVA ? \"Java\" : \"C++\") + \" took \" + duration + \"ms\");\n     }\n \n+    @AwaitsFix(bugUrl = \"https://github.com/elastic/ml-cpp/pull/1062\")\n+    public void testNumMatchesAndCategoryPreference() throws Exception {\n+        String index = \"hadoop_logs\";\n+        client().admin().indices().prepareCreate(index)\n+            .setMapping(\"time\", \"type=date,format=epoch_millis\",\n+                \"msg\", \"type=text\")\n+            .get();\n+\n+        nowMillis = System.currentTimeMillis();\n+\n+        BulkRequestBuilder bulkRequestBuilder = client().prepareBulk();\n+        IndexRequest indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(8).millis(),\n+            \"msg\", \"2015-10-18 18:01:51,963 INFO [main] org.mortbay.log: jetty-6.1.26\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(7).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.mortbay.log: Started HttpServer2$SelectChannelConnectorWithSafeStartup@0.0.0.0:62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(6).millis(),\n+            \"msg\", \"2015-10-18 18:01:53,400 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Registered webapp guice modules\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(5).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,447 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerRequestor: nodeBlacklistingEnabled:true\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(4).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:52,728 INFO [main] org.apache.hadoop.yarn.webapp.WebApps: Web app /mapreduce started at 62267\");\n+        bulkRequestBuilder.add(indexRequest);\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(2).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,557 INFO [main] org.apache.hadoop.yarn.client.RMProxy: \" +\n+                \"Connecting to ResourceManager at msra-sa-41/10.190.173.170:8030\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis - TimeValue.timeValueHours(1).millis(),\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.mapreduce.v2.app.rm.RMContainerAllocator: \" +\n+                \"maxContainerCapability: <memory:8192, vCores:32>\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+        indexRequest = new IndexRequest(index);\n+        indexRequest.source(\"time\", nowMillis,\n+            \"msg\",\n+            \"2015-10-18 18:01:53,713 INFO [main] org.apache.hadoop.yarn.client.api.impl.ContainerManagementProtocolProxy: \" +\n+                \"yarn.client.max-cached-nodemanagers-proxies : 0\");\n+        bulkRequestBuilder.add(indexRequest);\n+\n+\n+        BulkResponse bulkResponse = bulkRequestBuilder\n+            .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE)\n+            .get();\n+        assertThat(bulkResponse.hasFailures(), is(false));\n+\n+        Job.Builder job = newJobBuilder(\"categorization-with-preferred-categories\", Collections.emptyList());\n+        registerJob(job);\n+        putJob(job);\n+        openJob(job.getId());\n+\n+        String datafeedId = job.getId() + \"-feed\";\n+        DatafeedConfig.Builder datafeedConfig = new DatafeedConfig.Builder(datafeedId, job.getId());\n+        datafeedConfig.setIndices(Collections.singletonList(index));\n+        DatafeedConfig datafeed = datafeedConfig.build();\n+        registerDatafeed(datafeed);\n+        putDatafeed(datafeed);\n+        startDatafeed(datafeedId, 0, nowMillis + 1);\n+        waitUntilJobIsClosed(job.getId());\n+\n+        List<CategoryDefinition> categories = getCategories(job.getId());\n+        assertThat(categories.size(), equalTo(7));\n+\n+        CategoryDefinition category1 = categories.get(0);\n+        assertThat(category1.getNumMatches(), equalTo(2L));\n+        long[] expectedPreferenceTo = new long[]{2L, 3L, 4L, 5L, 6L};\n+        assertThat(category1.getPreferredToCategories().length, equalTo(5));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQzODQwOA=="}, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTk1NDg5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo1NjowNlrOF-5TyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo1NjowNlrOF-5TyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ5NDk4NA==", "bodyText": "Since the value is being serialized using writeVLong() this should throw if passed a negative number.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401494984", "createdAt": "2020-04-01T09:56:06Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -152,6 +167,26 @@ public void setGrokPattern(String grokPattern) {\n         this.grokPattern = grokPattern;\n     }\n \n+    public long[] getPreferredToCategories() {\n+        return preferredToCategories;\n+    }\n+\n+    public void setPreferredToCategories(long[] preferredToCategories) {\n+        this.preferredToCategories = preferredToCategories;\n+    }\n+\n+    private void setPreferredToCategories(List<Long> preferredToCategories) {\n+        setPreferredToCategories(preferredToCategories.stream().mapToLong(Long::longValue).toArray());\n+    }\n+\n+    public long getNumMatches() {\n+        return numMatches;\n+    }\n+\n+    public void setNumMatches(long numMatches) {\n+        this.numMatches = numMatches;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4OTk1OTUyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo1NzoyMVrOF-5WsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwOTo1NzoyMVrOF-5WsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ5NTcyOA==", "bodyText": "Since the value is being serialized using writeVLongArray() this should throw if any value in the array is negative.", "url": "https://github.com/elastic/elasticsearch/pull/54214#discussion_r401495728", "createdAt": "2020-04-01T09:57:21Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/results/CategoryDefinition.java", "diffHunk": "@@ -152,6 +167,26 @@ public void setGrokPattern(String grokPattern) {\n         this.grokPattern = grokPattern;\n     }\n \n+    public long[] getPreferredToCategories() {\n+        return preferredToCategories;\n+    }\n+\n+    public void setPreferredToCategories(long[] preferredToCategories) {\n+        this.preferredToCategories = preferredToCategories;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4581f01dc182b9c4efbd0822324dd85b6d98e177"}, "originalPosition": 75}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4103, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}