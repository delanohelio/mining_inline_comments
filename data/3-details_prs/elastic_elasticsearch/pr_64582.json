{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1MzM1OTUx", "number": 64582, "title": "Add query watches api to retrieve multiple watches.", "bodyText": "This api supports pagination (from / size) and\nquerying and sorting by watch _id and watcher metadata.\nThis avoids using .watch index directly.\nOn a per watch basis the same information that the get watch api returns is returned,\nexcept version.\nExample 1:\nGET /_watcher/_query_watches\n\n{\n    \"count\": 2,\n    \"watches\": [\n        {\n            \"_id\": \"my-watch1\",\n            \"watch\": {\n                \"trigger\": {\n                    \"schedule\": {\n                        \"yearly\": [\n                            {\n                                \"in\": [\n                                    \"JAN\"\n                                ],\n                                \"on\": [\n                                    10\n                                ],\n                                \"at\": [\n                                    \"noon\"\n                                ]\n                            }\n                        ]\n                    }\n                },\n                \"input\": {\n                    \"simple\": {}\n                },\n                \"condition\": {\n                    \"never\": {}\n                },\n                \"actions\": {}\n            },\n            \"status\": {\n                \"state\": {\n                    \"active\": true,\n                    \"timestamp\": \"2020-11-04T11:49:50.891Z\"\n                },\n                \"actions\": {},\n                \"version\": -1\n            },\n            \"_seq_no\": 0,\n            \"_primary_term\": 1\n        },\n        {\n            \"_id\": \"my-watch2\",\n            \"watch\": {\n                \"trigger\": {\n                    \"schedule\": {\n                        \"yearly\": [\n                            {\n                                \"in\": [\n                                    \"JAN\"\n                                ],\n                                \"on\": [\n                                    10\n                                ],\n                                \"at\": [\n                                    \"noon\"\n                                ]\n                            }\n                        ]\n                    }\n                },\n                \"input\": {\n                    \"simple\": {}\n                },\n                \"condition\": {\n                    \"never\": {}\n                },\n                \"actions\": {}\n            },\n            \"status\": {\n                \"state\": {\n                    \"active\": true,\n                    \"timestamp\": \"2020-11-04T11:49:53.500Z\"\n                },\n                \"actions\": {},\n                \"version\": -1\n            },\n            \"_seq_no\": 1,\n            \"_primary_term\": 1\n        }\n    ]\n}\n\nExample 2:\nGET /_watcher/_list_watches\n{\n    \"query\": {\n        \"term\": {\n            \"_id\": \"my-watch2\"\n        }\n    }\n}\n\n{\n    \"count\": 1,\n    \"watches\": [\n        {\n            \"_id\": \"my-watch2\",\n            \"watch\": {\n                \"trigger\": {\n                    \"schedule\": {\n                        \"yearly\": [\n                            {\n                                \"in\": [\n                                    \"JAN\"\n                                ],\n                                \"on\": [\n                                    10\n                                ],\n                                \"at\": [\n                                    \"noon\"\n                                ]\n                            }\n                        ]\n                    }\n                },\n                \"input\": {\n                    \"simple\": {}\n                },\n                \"condition\": {\n                    \"never\": {}\n                },\n                \"actions\": {}\n            },\n            \"status\": {\n                \"state\": {\n                    \"active\": true,\n                    \"timestamp\": \"2020-11-04T11:49:53.500Z\"\n                },\n                \"actions\": {},\n                \"version\": -1\n            },\n            \"_seq_no\": 1,\n            \"_primary_term\": 1\n        }\n    ]\n}\n\nRelates #62501", "createdAt": "2020-11-04T11:55:50Z", "url": "https://github.com/elastic/elasticsearch/pull/64582", "merged": true, "mergeCommit": {"oid": "3adb6d8aee0f1ed75921f47ac04513d98dfb619a"}, "closed": true, "closedAt": "2020-12-03T13:14:56Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZMauyAH2gAyNTE1MzM1OTUxOjBlMWI2Yzk3MjBjYWNjYjIwMTA2NTk5ZDRiZWM3MzhmODg0NjU4M2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiiZOTgH2gAyNTE1MzM1OTUxOjVhZGYxODFhMjczYmFhM2U5MzhiYzY4Y2IxMWI5NWQyYmY2OTA5MzY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e1b6c9720caccb20106599d4bec738f8846583f", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e1b6c9720caccb20106599d4bec738f8846583f", "committedDate": "2020-11-04T11:53:24Z", "message": "Add list watches api to retrieve multiple watches.\n\nThis api supports pagination (from / size) and\nquerying and sorting by watch _id and watcher metadata.\n\nThis avoids using .watch index directly.\n\nRelates #62501"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da07e704d48b9f5ba6a43e81aad695ba62ad347a", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/da07e704d48b9f5ba6a43e81aad695ba62ad347a", "committedDate": "2020-11-04T13:22:57Z", "message": "fixed precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3854a5e67aa4246c4a104bbff37659ece8e4b9d3", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3854a5e67aa4246c4a104bbff37659ece8e4b9d3", "committedDate": "2020-11-04T13:39:14Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68aa70ebacc301670e1c2a74173821b8af25f02f", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/68aa70ebacc301670e1c2a74173821b8af25f02f", "committedDate": "2020-11-18T13:00:57Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2740b8a507dd46506127c894b4fd9cb87d907c4c", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2740b8a507dd46506127c894b4fd9cb87d907c4c", "committedDate": "2020-11-18T13:35:40Z", "message": "added support for search after"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad053f8c3a067feac9c09b197342422b9373b2f", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ad053f8c3a067feac9c09b197342422b9373b2f", "committedDate": "2020-11-19T12:45:26Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f47e66ea76146dd325c606d500ac66ac73f2d57a", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f47e66ea76146dd325c606d500ac66ac73f2d57a", "committedDate": "2020-11-19T15:49:00Z", "message": "added docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c4bf9606b96aae7ef8e2eaf52882d55d94759a9", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c4bf9606b96aae7ef8e2eaf52882d55d94759a9", "committedDate": "2020-11-19T15:57:32Z", "message": "handle no .watches index gracefully"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "160a64986039f5a3f16a711585da1dcf20b7c394", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/160a64986039f5a3f16a711585da1dcf20b7c394", "committedDate": "2020-11-23T12:40:44Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9507b914297f1033370036d9adea5f646937e1ef", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/9507b914297f1033370036d9adea5f646937e1ef", "committedDate": "2020-11-23T14:47:22Z", "message": "fixed docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzE1Njk2", "url": "https://github.com/elastic/elasticsearch/pull/64582#pullrequestreview-537715696", "createdAt": "2020-11-24T16:52:59Z", "commit": {"oid": "9507b914297f1033370036d9adea5f646937e1ef"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNjo1NjowNFrOH5MMTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNzoyMjoxNlrOH5NSRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTczMDYzNg==", "bodyText": "need to cc client's team for awareness", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r529730636", "createdAt": "2020-11-24T16:56:04Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/api/watcher.list_watches.json", "diffHunk": "@@ -0,0 +1,25 @@\n+{\n+  \"watcher.list_watches\":{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9507b914297f1033370036d9adea5f646937e1ef"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0MzA1Mg==", "bodyText": "Should we also include a search_after here ?  (or in a seperate test)", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r529743052", "createdAt": "2020-11-24T17:14:11Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/internalClusterTest/java/org/elasticsearch/xpack/watcher/test/integration/BasicWatcherTests.java", "diffHunk": "@@ -375,4 +382,79 @@ private void testConditionSearch(WatcherSearchTemplateRequest request) throws Ex\n         timeWarp().trigger(watchName);\n         assertWatchWithMinimumPerformedActionsCount(watchName, 1);\n     }\n+\n+    public void testListWatches() {\n+        int numWatches = 6;\n+        for (int i = 0; i < numWatches; i++) {\n+            PutWatchResponse putWatchResponse = new PutWatchRequestBuilder(client()).setId(\"\" + i)\n+                .setSource(watchBuilder()\n+                    .trigger(schedule(interval(1, IntervalSchedule.Interval.Unit.DAYS)))\n+                    .addAction(\"_logger\", loggingAction(\"log me\"))\n+                    .metadata(Map.of(\"key1\", i, \"key2\", numWatches - i)))\n+                .get();\n+            assertThat(putWatchResponse.isCreated(), is(true));\n+        }\n+        refresh();\n+\n+        ListWatchesAction.Request request =\n+            new ListWatchesAction.Request(0, 2, null, List.of(new FieldSortBuilder(\"metadata.key1\")), null);\n+        ListWatchesAction.Response response = client().execute(ListWatchesAction.INSTANCE, request).actionGet();\n+        assertThat(response.getWatchTotalCount(), equalTo((long) numWatches));\n+        assertThat(response.getWatches().size(), equalTo(2));\n+        assertThat(response.getWatches().get(0).getId(), equalTo(\"0\"));\n+        Map<?, ?> watcherMetadata = (Map<?, ?>) response.getWatches().get(0).getSource().getAsMap().get(\"metadata\");\n+        assertThat(watcherMetadata.get(\"key2\"), equalTo(6));\n+        assertThat(response.getWatches().get(1).getId(), equalTo(\"1\"));\n+        watcherMetadata = (Map<?, ?>) response.getWatches().get(1).getSource().getAsMap().get(\"metadata\");\n+        assertThat(watcherMetadata.get(\"key2\"), equalTo(5));\n+\n+        request = new ListWatchesAction.Request(2, 2, null, List.of(new FieldSortBuilder(\"metadata.key1\")), null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9507b914297f1033370036d9adea5f646937e1ef"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc0ODU1MQ==", "bodyText": "What is this change for ?", "url": "https://github.com/elastic/elasticsearch/pull/64582#discussion_r529748551", "createdAt": "2020-11-24T17:22:16Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/test/WatcherTestUtils.java", "diffHunk": "@@ -149,24 +152,25 @@ public static WatchExecutionContext createWatchExecutionContext() throws Excepti\n \n \n     public static Watch createTestWatch(String watchName, Client client, HttpClient httpClient, EmailService emailService,\n-                                        WatcherSearchTemplateService searchTemplateService, Logger logger) throws AddressException {\n+                                        WatcherSearchTemplateService searchTemplateService, Logger logger) {\n+        ActionThrottler actionThrottler = new ActionThrottler(Clock.systemUTC(), null, mock(XPackLicenseState.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9507b914297f1033370036d9adea5f646937e1ef"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84a10e7e5cf39d42fca0c8d5fe505b64bcd62768", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/84a10e7e5cf39d42fca0c8d5fe505b64bcd62768", "committedDate": "2020-11-25T08:58:11Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05d7acde56b212788c9bc792efc6f0cd975b35fc", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/05d7acde56b212788c9bc792efc6f0cd975b35fc", "committedDate": "2020-11-25T09:52:04Z", "message": "added test with search_after"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1efecc7b22f4f8dd3750c89d34c5150054124e", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b1efecc7b22f4f8dd3750c89d34c5150054124e", "committedDate": "2020-12-01T07:51:38Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836c17d3255673436465e29f8db89db003c6fdfd", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/836c17d3255673436465e29f8db89db003c6fdfd", "committedDate": "2020-12-01T08:50:34Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01dc16a279e11649ac901d258784d9b2193ac943", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/01dc16a279e11649ac901d258784d9b2193ac943", "committedDate": "2020-12-01T08:53:31Z", "message": "renamed comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyOTgwNTg5", "url": "https://github.com/elastic/elasticsearch/pull/64582#pullrequestreview-542980589", "createdAt": "2020-12-02T15:54:56Z", "commit": {"oid": "01dc16a279e11649ac901d258784d9b2193ac943"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cbc0fe5c9e16b3ade68705c2c42fb43287a6eca8", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cbc0fe5c9e16b3ade68705c2c42fb43287a6eca8", "committedDate": "2020-12-03T10:28:16Z", "message": "Merge remote-tracking branch 'es/master' into watcher_list_api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2a559f113bd4b759afd7b59825eef64233d8610", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2a559f113bd4b759afd7b59825eef64233d8610", "committedDate": "2020-12-03T10:42:46Z", "message": "changed url path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5adf181a273baa3e938bc68cb11b95d2bf690936", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5adf181a273baa3e938bc68cb11b95d2bf690936", "committedDate": "2020-12-03T12:34:59Z", "message": "adjusted list on non operator list actions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 806, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}