{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzNDY4ODQ5", "number": 59880, "title": "Fix scheduling of ClusterInfoService#refresh", "bodyText": "Today the InternalClusterInfoService uses the\nLocalNodeMasterListener interface to start/stop its operations. Since\nthe onMaster and offMaster methods are called on the MANAGEMENT\nthreadpool, there's no guarantee that they run in the correct sequence,\nwhich could result in an elected master failing to regularly update the\ncluster info.\nSince this service is also a ClusterStateListener we may as well drop\nthe usage of the LocalNodeMasterListener interface and simply update\nthe status of the local node on the applier thread in clusterChanged\nto ensure consistency.\nAdditionally, today the InternalClusterInfoService uses a simple flag\nto track whether the local node is the elected master or not. If the\nnode stops being the master and then starts again within a few seconds\nthen the scheduled updates from the old mastership might carry on\nrunning in addition to the ones for the new mastership.\nThis commit addresses that by tracking the identity of the scheduled\nupdate job and creating a new job for each mastership.", "createdAt": "2020-07-20T13:48:11Z", "url": "https://github.com/elastic/elasticsearch/pull/59880", "merged": true, "mergeCommit": {"oid": "fefb31ba17065488965668c9c8e1a5eb621dc9ea"}, "closed": true, "closedAt": "2020-07-21T15:06:40Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc2x5zwgH2gAyNDUzNDY4ODQ5OmFlMWFmOTdmMDJlODRhMzljZTIyMzllYzE1ZmYzNzIyNDhkZWUwMWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3GGq7AH2gAyNDUzNDY4ODQ5OmIxYTIzMzBjODM1OWMxZjc4MGZhMzdiM2E4OTZhMzg5MDM5ZDAxMzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ae1af97f02e84a39ce2239ec15ff372248dee01a", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae1af97f02e84a39ce2239ec15ff372248dee01a", "committedDate": "2020-07-20T13:46:29Z", "message": "Fix scheduling of ClusterInfoService#refresh\n\nToday the `InternalClusterInfoService` uses the\n`LocalNodeMasterListener` interface to start/stop its operations. Since\nthe `onMaster` and `offMaster` methods are called on the `MANAGEMENT`\nthreadpool, there's no guarantee that they run in the correct sequence,\nwhich could result in an elected master failing to regularly update the\ncluster info.\n\nSince this service is also a `ClusterStateListener` we may as well drop\nthe usage of the `LocalNodeMasterListener` interface and simply update\nthe status of the local node on the applier thread in `clusterChanged`\nto ensure consistency.\n\nAdditionally, today the `InternalClusterInfoService` uses a simple flag\nto track whether the local node is the elected master or not. If the\nnode stops being the master and then starts again within a few seconds\nthen the scheduled updates from the old mastership might carry on\nrunning in addition to the ones for the new mastership.\n\nThis commit addresses that by tracking the identity of the scheduled\nupdate job and creating a new job for each mastership."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDExMTAx", "url": "https://github.com/elastic/elasticsearch/pull/59880#pullrequestreview-452411101", "createdAt": "2020-07-21T12:38:37Z", "commit": {"oid": "ae1af97f02e84a39ce2239ec15ff372248dee01a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjozODozN1rOG019CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMjozODozN1rOG019CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODA2MzExMw==", "bodyText": "Maybe just event.state() here?", "url": "https://github.com/elastic/elasticsearch/pull/59880#discussion_r458063113", "createdAt": "2020-07-21T12:38:37Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/cluster/InternalClusterInfoService.java", "diffHunk": "@@ -127,75 +131,53 @@ void setUpdateFrequency(TimeValue updateFrequency) {\n     }\n \n     @Override\n-    public void onMaster() {\n-        this.isMaster = true;\n-        if (logger.isTraceEnabled()) {\n-            logger.trace(\"I have been elected master, scheduling a ClusterInfoUpdateJob\");\n-        }\n-\n-        // Submit a job that will reschedule itself after running\n-        threadPool.scheduleUnlessShuttingDown(updateFrequency, executorName(), new SubmitReschedulingClusterInfoUpdatedJob());\n-\n-        try {\n-            if (clusterService.state().getNodes().getDataNodes().size() > 1) {\n-                // Submit an info update job to be run immediately\n-                threadPool.executor(executorName()).execute(this::maybeRefresh);\n-            }\n-        } catch (EsRejectedExecutionException ex) {\n-            logger.debug(\"Couldn't schedule cluster info update task - node might be shutting down\", ex);\n+    public void clusterChanged(ClusterChangedEvent event) {\n+        if (event.localNodeMaster() && refreshAndRescheduleRunnable.get() == null) {\n+            logger.trace(\"elected as master, scheduling cluster info update tasks\");\n+            executeRefresh(clusterService.state(), \"became master\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae1af97f02e84a39ce2239ec15ff372248dee01a"}, "originalPosition": 101}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "620918286835415099d8839ac0f5b31089f709c8", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/620918286835415099d8839ac0f5b31089f709c8", "committedDate": "2020-07-21T13:01:56Z", "message": "No need to use clusterService any more"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1a2330c8359c1f780fa37b3a896a389039d0139", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1a2330c8359c1f780fa37b3a896a389039d0139", "committedDate": "2020-07-21T13:18:38Z", "message": "Merge branch 'master' into 2020-07-20-cluster-info-service-scheduling-bug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4247, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}