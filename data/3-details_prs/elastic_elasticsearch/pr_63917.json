{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2NjQ4MjY3", "number": 63917, "title": "DocumentMapperParser to no longer depend directly on MapperService", "bodyText": "Backport of #63850\nThis change was mainly triggered by the need for MapperService to pass this during its constructor when creating DocumentMapperParser. Also, MapperService is carried around in some places where only a subset of it is needed.\nWith this change we rather carry around the components that are strictly needed, in a couple of cases functions that MapperService provides, which helps clarifying the dependency between DocumentMapperParser, DocumentMapper and MapperService, as well as removing the need for MapperService to pass this to DocumentMapperParser", "createdAt": "2020-10-20T09:52:45Z", "url": "https://github.com/elastic/elasticsearch/pull/63917", "merged": true, "mergeCommit": {"oid": "2ac35682cbc1927e9e9f64853627a4108dffb0f2"}, "closed": true, "closedAt": "2020-10-20T13:54:30Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUVrwLgH2gAyNTA2NjQ4MjY3OmVkMGEwN2M3MDBlNDgyYzExMjRkNWQwNDI2YzJmNDBhZmZkZDhlODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUXntxgH2gAyNTA2NjQ4MjY3OjViNWQ0MGU0YzM5YjM4Mzg5MDUyYTcyN2RjYjI5MGVhZTMxOTZlNTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ed0a07c700e482c1124d5d0426c2f40affdd8e86", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed0a07c700e482c1124d5d0426c2f40affdd8e86", "committedDate": "2020-10-20T09:51:31Z", "message": "DocumentMapperParser to no longer depend directly on MapperService (#63850)\n\nThis change was mainly triggered by the need for `MapperService` to pass `this` during its constructor when creating `DocumentMapperParser`. Also, `MapperService` is carried around in some places where only a subset of it is needed.\n\nWith this change we rather carry around the components that are strictly needed, in a couple of cases functions that `MapperService` provides, which helps clarifying the dependency between `DocumentMapperParser`, `DocumentMapper` and `MapperService`, as well as removing the need for MapperService to pass `this` to `DocumentMapperParser`"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNTMyNjM4", "url": "https://github.com/elastic/elasticsearch/pull/63917#pullrequestreview-512532638", "createdAt": "2020-10-20T09:54:27Z", "commit": {"oid": "ed0a07c700e482c1124d5d0426c2f40affdd8e86"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwOTo1NDoyN1rOHk0PcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQwOTo1NDoyN1rOHk0PcQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODM2NjcwNQ==", "bodyText": "@romseygeek as part of the backport, due to this call to documentMapper that takes a type, I had to make this argument a function, and the corresponding method in MapperService now takes a String argument. Is that good enough or can you thin of further simplications?", "url": "https://github.com/elastic/elasticsearch/pull/63917#discussion_r508366705", "createdAt": "2020-10-20T09:54:27Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -46,49 +45,38 @@\n import java.util.LinkedHashMap;\n import java.util.Map;\n import java.util.Objects;\n+import java.util.function.Function;\n import java.util.stream.Stream;\n \n \n public class DocumentMapper implements ToXContentFragment {\n \n     public static class Builder {\n-\n-        private final Map<Class<? extends MetadataFieldMapper>, MetadataFieldMapper> metadataMappers = new LinkedHashMap<>();\n+        private final Map<Class<? extends MetadataFieldMapper>, MetadataFieldMapper> metadataMappers;\n         private final RootObjectMapper rootObjectMapper;\n         private final Mapper.BuilderContext builderContext;\n         private final IndexSettings indexSettings;\n         private final IndexAnalyzers indexAnalyzers;\n-        private final DocumentMapperParser documentMapperParser;\n         private final DocumentParser documentParser;\n \n         private Map<String, Object> meta;\n \n         public Builder(RootObjectMapper.Builder builder, MapperService mapperService) {\n-            this.indexSettings = mapperService.getIndexSettings();\n-            this.indexAnalyzers = mapperService.getIndexAnalyzers();\n-            this.documentMapperParser = mapperService.documentMapperParser();\n-            this.documentParser = mapperService.documentParser();\n+            this(builder, mapperService.getIndexSettings(), mapperService.getIndexAnalyzers(), mapperService.documentParser(),\n+                mapperService::getMetadataMappers);\n+        }\n+\n+        Builder(RootObjectMapper.Builder builder,\n+                IndexSettings indexSettings,\n+                IndexAnalyzers indexAnalyzers,\n+                DocumentParser documentParser,\n+                Function<String, Map<Class<? extends MetadataFieldMapper>, MetadataFieldMapper>> metadataMappersFunction) {\n+            this.indexSettings = indexSettings;\n+            this.indexAnalyzers = indexAnalyzers;\n+            this.documentParser = documentParser;\n             this.builderContext = new Mapper.BuilderContext(indexSettings.getSettings(), new ContentPath(1));\n             this.rootObjectMapper = builder.build(builderContext);\n-            final String type = rootObjectMapper.name();\n-            final DocumentMapper existingMapper = mapperService.documentMapper(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed0a07c700e482c1124d5d0426c2f40affdd8e86"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7807973ac0922d1b9455580eb9d7ae2c4c1496b", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7807973ac0922d1b9455580eb9d7ae2c4c1496b", "committedDate": "2020-10-20T10:11:43Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b5d40e4c39b38389052a727dcb290eae3196e59", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b5d40e4c39b38389052a727dcb290eae3196e59", "committedDate": "2020-10-20T12:06:55Z", "message": "Merge branch '7.x' into backport/63850"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1169, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}