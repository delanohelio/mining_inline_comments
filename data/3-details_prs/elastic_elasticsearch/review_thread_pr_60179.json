{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU2ODI2NTEw", "number": 60179, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODoxOToxM1rOESgOkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoyNTo1MlrOETafvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3ODM3ODQwOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/InnerHitsPhase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yN1QxODoxOToxM1rOG3uJUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoyNDozNVrOG5Izyg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MDkxMw==", "bodyText": "We set the root document's _source here, but when processing inner hits we didn't use it and instead reloaded the _source. So this is safe to remove for now.\nIn a follow-up PR, I will fix this to make sure the _source is loaded only once for the root doc + inner hits.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461080913", "createdAt": "2020-07-27T18:19:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/InnerHitsPhase.java", "diffHunk": "@@ -65,10 +65,6 @@ public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOExcept\n                 }\n                 innerHits.docIdsToLoad(docIdsToLoad, 0, docIdsToLoad.length);\n                 innerHits.setId(hit.getId());\n-                innerHits.lookup().source().setSource(context.lookup().source().internalSourceRef());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NjM0Ng==", "bodyText": "+1, that's something that we spotted sometime ago: #32818 (comment) and maybe #56210 but never implemented.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462566346", "createdAt": "2020-07-29T20:24:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/InnerHitsPhase.java", "diffHunk": "@@ -65,10 +65,6 @@ public void hitsExecute(SearchContext context, SearchHit[] hits) throws IOExcept\n                 }\n                 innerHits.docIdsToLoad(docIdsToLoad, 0, docIdsToLoad.length);\n                 innerHits.setId(hit.getId());\n-                innerHits.lookup().source().setSource(context.lookup().source().internalSourceRef());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTA4MDkxMw=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg3OTYzOTM2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwMjoxMTo0MVrOG36AvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToyNTowOFrOG4bKRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3NTMyNQ==", "bodyText": "Do we always need to create SourceLookup object here?  What about cases where we don't need _source?  May be do a object creation lazily: the 1st time it is needed?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461275325", "createdAt": "2020-07-28T02:11:41Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxODQzNw==", "bodyText": "To me the optimization might not be worth it, it's not an expensive object to construct and we only create one SourceLookup per hit?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461818437", "createdAt": "2020-07-28T19:25:08Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTI3NTMyNQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MjgxNzc4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODowMzoxNVrOG4YUIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOToxMzo1MVrOG4avdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MTgxMQ==", "bodyText": "Since this one happens at query time maybe we can keep using it? I think what you have here would cause two significant text aggs to load source twice.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461771811", "createdAt": "2020-07-28T18:03:15Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -154,13 +153,12 @@ protected Aggregator createInternal(SearchContext searchContext, Aggregator pare\n         private ObjectArray<DuplicateByteSequenceSpotter> dupSequenceSpotters;\n \n         SignificantTextCollectorSource(\n-            SourceLookup sourceLookup,\n             BigArrays bigArrays,\n             MappedFieldType fieldType,\n             String[] sourceFieldNames,\n             boolean filterDuplicateText\n         ) {\n-            this.sourceLookup = sourceLookup;\n+            this.sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMTU3Mw==", "bodyText": "Oops, this is a great point. I think I took the refactor too far. I plan to restore the shared SourceLookup on SearchLookup so it can be used to share cached _source in the query phase.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461811573", "createdAt": "2020-07-28T19:13:51Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorFactory.java", "diffHunk": "@@ -154,13 +153,12 @@ protected Aggregator createInternal(SearchContext searchContext, Aggregator pare\n         private ObjectArray<DuplicateByteSequenceSpotter> dupSequenceSpotters;\n \n         SignificantTextCollectorSource(\n-            SourceLookup sourceLookup,\n             BigArrays bigArrays,\n             MappedFieldType fieldType,\n             String[] sourceFieldNames,\n             boolean filterDuplicateText\n         ) {\n-            this.sourceLookup = sourceLookup;\n+            this.sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc3MTgxMQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Mjk1Mjc1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0MToyOFrOG4ZpIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDowMjo1M1rOG4crAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ==", "bodyText": "Similar to @nik9000's comment, it looks like source will be loaded twice here for cases when a script needs to access  _source and when _source is requested for hits because we will have two different SourceLookup objects , for example for queries like this:\n{\n  \"_source\": true,\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"script_fields\": {\n    \"my_script\": {\n      \"script\": {\n        \"source\": \"params['_source']['my_field']\"\n      }\n    }\n  }\n}", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461793571", "createdAt": "2020-07-28T18:41:28Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgxMDczOQ==", "bodyText": "I'm not sure this is the case -- looking at ScriptFieldsPhase, it overwrites hitsExecute and so processes all hits at once. That means it wouldn't be able to re-use the loaded _source (even before the refactor) ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461810739", "createdAt": "2020-07-28T19:12:13Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgyNDg5OQ==", "bodyText": "Another note: I'll add some Javadoc to HitContext explaining the _source sharing strategy, since it is quite tricky to understand.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461824899", "createdAt": "2020-07-28T19:36:57Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgzMDE0OA==", "bodyText": "I do think this'll break the shared loading of _source in scripts at query time though. Each script calls this method to get its own fresh LeafSearchLookup and we sort of rely on them being able to share the loaded _source.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461830148", "createdAt": "2020-07-28T19:43:28Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MzIwMA==", "bodyText": "I do think this'll break the shared loading of _source in scripts at query time though.\n\nI agree, this will be fixed when I restore the shared SourceLookup on SearchLookup.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461843200", "createdAt": "2020-07-28T20:02:53Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;\n-\n-    final FieldsLookup fieldsLookup;\n+    private final DocLookup docLookup;\n+    private final MapperService mapperService;\n \n     public SearchLookup(MapperService mapperService, Function<MappedFieldType, IndexFieldData<?>> fieldDataLookup) {\n-        docMap = new DocLookup(mapperService, fieldDataLookup);\n-        sourceLookup = new SourceLookup();\n-        fieldsLookup = new FieldsLookup(mapperService);\n+        docLookup = new DocLookup(mapperService, fieldDataLookup);\n+        this.mapperService = mapperService;\n     }\n \n     public LeafSearchLookup getLeafSearchLookup(LeafReaderContext context) {\n         return new LeafSearchLookup(context,\n-                docMap.getLeafDocLookup(context),\n-                sourceLookup,\n-                fieldsLookup.getLeafFieldsLookup(context));\n+                docLookup.getLeafDocLookup(context),\n+                new SourceLookup(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5MzU3MQ=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzAyMDA4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTowMDozNlrOG4aTbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMTo0Njo1N1rOG4gOKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNDM5OA==", "bodyText": "I think we should add a comment here about why we don't want to share the lookup in QueryShardContext.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461804398", "createdAt": "2020-07-28T19:00:36Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTkwMTM1Mg==", "bodyText": "I added Javadoc on HitContext#sourceLookup and FetchPhase#prepareHitContext to explain the logic. Let me know if it could use more clarification.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461901352", "createdAt": "2020-07-28T21:46:57Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchSubPhase.java", "diffHunk": "@@ -39,13 +40,15 @@\n         private IndexSearcher searcher;\n         private LeafReaderContext readerContext;\n         private int docId;\n+        private final SourceLookup sourceLookup = new SourceLookup();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNDM5OA=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4MzAyNDkzOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxOTowMTo0N1rOG4aWQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMDowMTo0OFrOG4coxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNTEyMg==", "bodyText": "I think we still need SourceLookup here both for significant text, and for the thing we talked about where I wanted SearchLookup on FieldMapper#lookup.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461805122", "createdAt": "2020-07-28T19:01:47Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg0MjYyOQ==", "bodyText": "\ud83d\udc4d  will restore it.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r461842629", "createdAt": "2020-07-28T20:01:48Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/lookup/SearchLookup.java", "diffHunk": "@@ -27,31 +27,22 @@\n import java.util.function.Function;\n \n public class SearchLookup {\n-\n-    final DocLookup docMap;\n-\n-    final SourceLookup sourceLookup;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTgwNTEyMg=="}, "originalCommit": {"oid": "aca5233c1c80ab9d32187dad6ee7663ce63ceed3"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Nzg5OTQyOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoxODowNlrOG5ImfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0Nzo1NVrOG5Jkug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Mjk0MA==", "bodyText": "I wonder if we can still assign the context.lookup().source() with the current _source so that _script can share the source with other fetch sub-phase. That would only work for sub-phases that use a script and override hitExecute so the new FetchFieldsPhase would benefit from this hack ? We can then think how we could clenup the context for script in a follow up ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462562940", "createdAt": "2020-07-29T20:18:06Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -222,42 +221,60 @@ private int findRootDocumentIfNested(SearchContext context, LeafReaderContext su\n         return -1;\n     }\n \n-    private SearchHit createSearchHit(SearchContext context,\n-                                      FieldsVisitor fieldsVisitor,\n-                                      int docId,\n-                                      int subDocId,\n-                                      Map<String, Set<String>> storedToRequestedFields,\n-                                      LeafReaderContext subReaderContext) {\n+    /**\n+     * Resets the provided {@link FetchSubPhase.HitContext} with information on the current\n+     * document. This includes the following:\n+     *   - Adding an initial {@link SearchHit} instance.\n+     *   - Loading the document source and setting it on {@link SourceLookup}. This allows\n+     *     fetch subphases that use the hit context to access the preloaded source.\n+     */\n+    private void prepareHitContext(FetchSubPhase.HitContext hitContext,\n+                                   SearchContext context,\n+                                   FieldsVisitor fieldsVisitor,\n+                                   int docId,\n+                                   int subDocId,\n+                                   Map<String, Set<String>> storedToRequestedFields,\n+                                   LeafReaderContext subReaderContext) {\n         if (fieldsVisitor == null) {\n-            return new SearchHit(docId, null, null, null);\n-        }\n-        loadStoredFields(context.shardTarget(), subReaderContext, fieldsVisitor, subDocId);\n-        fieldsVisitor.postProcess(context.mapperService());\n-        SearchHit searchHit;\n-        if (fieldsVisitor.fields().isEmpty() == false) {\n-            Map<String, DocumentField> docFields = new HashMap<>();\n-            Map<String, DocumentField> metaFields = new HashMap<>();\n-            fillDocAndMetaFields(context, fieldsVisitor, storedToRequestedFields, docFields, metaFields);\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), docFields, metaFields);\n+            SearchHit hit = new SearchHit(docId, null, null, null);\n+            hitContext.reset(hit, subReaderContext, subDocId, context.searcher());\n         } else {\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), emptyMap(), emptyMap());\n-        }\n-        // Set _source if requested.\n-        SourceLookup sourceLookup = context.lookup().source();\n-        sourceLookup.setSegmentAndDocument(subReaderContext, subDocId);\n-        if (fieldsVisitor.source() != null) {\n-            sourceLookup.setSource(fieldsVisitor.source());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NDg2Mw==", "bodyText": "I don't think FetchFieldsPhase would benefit currently, because it doesn't support scripts? I like the plan of considering it in a follow-up, for example as part of converting ScriptFieldsPhase to use hitExecute.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462574863", "createdAt": "2020-07-29T20:40:20Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -222,42 +221,60 @@ private int findRootDocumentIfNested(SearchContext context, LeafReaderContext su\n         return -1;\n     }\n \n-    private SearchHit createSearchHit(SearchContext context,\n-                                      FieldsVisitor fieldsVisitor,\n-                                      int docId,\n-                                      int subDocId,\n-                                      Map<String, Set<String>> storedToRequestedFields,\n-                                      LeafReaderContext subReaderContext) {\n+    /**\n+     * Resets the provided {@link FetchSubPhase.HitContext} with information on the current\n+     * document. This includes the following:\n+     *   - Adding an initial {@link SearchHit} instance.\n+     *   - Loading the document source and setting it on {@link SourceLookup}. This allows\n+     *     fetch subphases that use the hit context to access the preloaded source.\n+     */\n+    private void prepareHitContext(FetchSubPhase.HitContext hitContext,\n+                                   SearchContext context,\n+                                   FieldsVisitor fieldsVisitor,\n+                                   int docId,\n+                                   int subDocId,\n+                                   Map<String, Set<String>> storedToRequestedFields,\n+                                   LeafReaderContext subReaderContext) {\n         if (fieldsVisitor == null) {\n-            return new SearchHit(docId, null, null, null);\n-        }\n-        loadStoredFields(context.shardTarget(), subReaderContext, fieldsVisitor, subDocId);\n-        fieldsVisitor.postProcess(context.mapperService());\n-        SearchHit searchHit;\n-        if (fieldsVisitor.fields().isEmpty() == false) {\n-            Map<String, DocumentField> docFields = new HashMap<>();\n-            Map<String, DocumentField> metaFields = new HashMap<>();\n-            fillDocAndMetaFields(context, fieldsVisitor, storedToRequestedFields, docFields, metaFields);\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), docFields, metaFields);\n+            SearchHit hit = new SearchHit(docId, null, null, null);\n+            hitContext.reset(hit, subReaderContext, subDocId, context.searcher());\n         } else {\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), emptyMap(), emptyMap());\n-        }\n-        // Set _source if requested.\n-        SourceLookup sourceLookup = context.lookup().source();\n-        sourceLookup.setSegmentAndDocument(subReaderContext, subDocId);\n-        if (fieldsVisitor.source() != null) {\n-            sourceLookup.setSource(fieldsVisitor.source());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Mjk0MA=="}, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3ODg3NA==", "bodyText": "Right, I was thinking preemptively of runtime scripted field but +1 to consider this in a follow up.", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462578874", "createdAt": "2020-07-29T20:47:55Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java", "diffHunk": "@@ -222,42 +221,60 @@ private int findRootDocumentIfNested(SearchContext context, LeafReaderContext su\n         return -1;\n     }\n \n-    private SearchHit createSearchHit(SearchContext context,\n-                                      FieldsVisitor fieldsVisitor,\n-                                      int docId,\n-                                      int subDocId,\n-                                      Map<String, Set<String>> storedToRequestedFields,\n-                                      LeafReaderContext subReaderContext) {\n+    /**\n+     * Resets the provided {@link FetchSubPhase.HitContext} with information on the current\n+     * document. This includes the following:\n+     *   - Adding an initial {@link SearchHit} instance.\n+     *   - Loading the document source and setting it on {@link SourceLookup}. This allows\n+     *     fetch subphases that use the hit context to access the preloaded source.\n+     */\n+    private void prepareHitContext(FetchSubPhase.HitContext hitContext,\n+                                   SearchContext context,\n+                                   FieldsVisitor fieldsVisitor,\n+                                   int docId,\n+                                   int subDocId,\n+                                   Map<String, Set<String>> storedToRequestedFields,\n+                                   LeafReaderContext subReaderContext) {\n         if (fieldsVisitor == null) {\n-            return new SearchHit(docId, null, null, null);\n-        }\n-        loadStoredFields(context.shardTarget(), subReaderContext, fieldsVisitor, subDocId);\n-        fieldsVisitor.postProcess(context.mapperService());\n-        SearchHit searchHit;\n-        if (fieldsVisitor.fields().isEmpty() == false) {\n-            Map<String, DocumentField> docFields = new HashMap<>();\n-            Map<String, DocumentField> metaFields = new HashMap<>();\n-            fillDocAndMetaFields(context, fieldsVisitor, storedToRequestedFields, docFields, metaFields);\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), docFields, metaFields);\n+            SearchHit hit = new SearchHit(docId, null, null, null);\n+            hitContext.reset(hit, subReaderContext, subDocId, context.searcher());\n         } else {\n-            searchHit = new SearchHit(docId, fieldsVisitor.id(), emptyMap(), emptyMap());\n-        }\n-        // Set _source if requested.\n-        SourceLookup sourceLookup = context.lookup().source();\n-        sourceLookup.setSegmentAndDocument(subReaderContext, subDocId);\n-        if (fieldsVisitor.source() != null) {\n-            sourceLookup.setSource(fieldsVisitor.source());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Mjk0MA=="}, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 67}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzkyNDE1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceScoreOrderFragmentsBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoyNTozNVrOG5I17w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDozMToyN1rOG5JCsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Njg5NQ==", "bodyText": "Maybe just pass the SourceLookup directly ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462566895", "createdAt": "2020-07-29T20:25:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceScoreOrderFragmentsBuilder.java", "diffHunk": "@@ -36,11 +35,10 @@\n public class SourceScoreOrderFragmentsBuilder extends ScoreOrderFragmentsBuilder {\n \n     private final MappedFieldType fieldType;\n-\n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceScoreOrderFragmentsBuilder(MappedFieldType fieldType,\n-                                            QueryShardContext context,\n+                                            FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MDE2Mg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462570162", "createdAt": "2020-07-29T20:31:27Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceScoreOrderFragmentsBuilder.java", "diffHunk": "@@ -36,11 +35,10 @@\n public class SourceScoreOrderFragmentsBuilder extends ScoreOrderFragmentsBuilder {\n \n     private final MappedFieldType fieldType;\n-\n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceScoreOrderFragmentsBuilder(MappedFieldType fieldType,\n-                                            QueryShardContext context,\n+                                            FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2Njg5NQ=="}, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4NzkyNTA5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceSimpleFragmentsBuilder.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDoyNTo1MlrOG5I2kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDozMTo0NFrOG5JDRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NzA1OA==", "bodyText": "Same here ?", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462567058", "createdAt": "2020-07-29T20:25:52Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceSimpleFragmentsBuilder.java", "diffHunk": "@@ -21,21 +21,20 @@\n import org.apache.lucene.document.Field;\n import org.apache.lucene.document.TextField;\n import org.apache.lucene.index.IndexReader;\n-import org.apache.lucene.index.LeafReaderContext;\n import org.apache.lucene.search.vectorhighlight.BoundaryScanner;\n import org.elasticsearch.index.mapper.MappedFieldType;\n-import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.search.fetch.FetchSubPhase;\n import org.elasticsearch.search.lookup.SourceLookup;\n \n import java.io.IOException;\n import java.util.List;\n \n public class SourceSimpleFragmentsBuilder extends SimpleFragmentsBuilder {\n \n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceSimpleFragmentsBuilder(MappedFieldType fieldType,\n-                                        QueryShardContext context,\n+                                        FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3MDMwOA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/60179#discussion_r462570308", "createdAt": "2020-07-29T20:31:44Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/SourceSimpleFragmentsBuilder.java", "diffHunk": "@@ -21,21 +21,20 @@\n import org.apache.lucene.document.Field;\n import org.apache.lucene.document.TextField;\n import org.apache.lucene.index.IndexReader;\n-import org.apache.lucene.index.LeafReaderContext;\n import org.apache.lucene.search.vectorhighlight.BoundaryScanner;\n import org.elasticsearch.index.mapper.MappedFieldType;\n-import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.search.fetch.FetchSubPhase;\n import org.elasticsearch.search.lookup.SourceLookup;\n \n import java.io.IOException;\n import java.util.List;\n \n public class SourceSimpleFragmentsBuilder extends SimpleFragmentsBuilder {\n \n-    private final QueryShardContext context;\n+    private final FetchSubPhase.HitContext context;\n \n     public SourceSimpleFragmentsBuilder(MappedFieldType fieldType,\n-                                        QueryShardContext context,\n+                                        FetchSubPhase.HitContext context,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU2NzA1OA=="}, "originalCommit": {"oid": "174edb6584436f2f222e5ae7cadca9271027e14c"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2055, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}