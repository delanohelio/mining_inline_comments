{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMTU5OTI4", "number": 66327, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozODoyOFrOFFiu0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMzowOTowNVrOFFlDvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMzU2MjQzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/TimestampFieldMapperService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozODoyOFrOIGGl7w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMTozODoyOFrOIGGl7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzI3MDM4Mw==", "bodyText": "Let's not fail the whole node if we messed this up somehow :)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    }\n          \n          \n            \n                        throw e;\n          \n          \n            \n                    }", "url": "https://github.com/elastic/elasticsearch/pull/66327#discussion_r543270383", "createdAt": "2020-12-15T11:38:28Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/TimestampFieldMapperService.java", "diffHunk": "@@ -176,7 +178,17 @@ private static boolean hasUsefulTimestampField(IndexMetadata indexMetadata) {\n         if (future == null || future.isDone() == false) {\n             return null;\n         }\n-        return future.actionGet();\n+\n+        try {\n+            // It's possible that callers of this class are executed\n+            // in a transport thread, for that reason we request\n+            // the future value with a timeout of 0. That won't\n+            // trigger assertion errors.\n+            return future.actionGet(TimeValue.ZERO);\n+        } catch (ElasticsearchTimeoutException e) {\n+            assert false : \"Unexpected timeout exception while getting a timestamp mapping\";\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "979eed947fbbfb693fa52892439383a2a90e239e"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMzk0MzY1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/TimestampFieldMapperService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMzowOTowNVrOIGKC4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxMzoxMDoxM1rOIGKFvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNjk0Nw==", "bodyText": "We can remove this override now that we're setting the timeout.", "url": "https://github.com/elastic/elasticsearch/pull/66327#discussion_r543326947", "createdAt": "2020-12-15T13:09:05Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/indices/TimestampFieldMapperService.java", "diffHunk": "@@ -104,7 +106,15 @@ public void applyClusterState(ClusterChangedEvent event) {\n \n             if (hasUsefulTimestampField(indexMetadata) && fieldTypesByIndex.containsKey(index) == false) {\n                 logger.trace(\"computing timestamp mapping for {}\", index);\n-                final PlainActionFuture<DateFieldMapper.DateFieldType> future = new PlainActionFuture<>();\n+                final PlainActionFuture<DateFieldMapper.DateFieldType> future = new PlainActionFuture<>() {\n+                    @Override\n+                    protected boolean blockingAllowed() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5c19ed47f989d5d1e3067ec53efa8b93e5222f8"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNzY3Ng==", "bodyText": "Oh, I thought I removed it... I need more \u2615  today", "url": "https://github.com/elastic/elasticsearch/pull/66327#discussion_r543327676", "createdAt": "2020-12-15T13:10:13Z", "author": {"login": "fcofdez"}, "path": "server/src/main/java/org/elasticsearch/indices/TimestampFieldMapperService.java", "diffHunk": "@@ -104,7 +106,15 @@ public void applyClusterState(ClusterChangedEvent event) {\n \n             if (hasUsefulTimestampField(indexMetadata) && fieldTypesByIndex.containsKey(index) == false) {\n                 logger.trace(\"computing timestamp mapping for {}\", index);\n-                final PlainActionFuture<DateFieldMapper.DateFieldType> future = new PlainActionFuture<>();\n+                final PlainActionFuture<DateFieldMapper.DateFieldType> future = new PlainActionFuture<>() {\n+                    @Override\n+                    protected boolean blockingAllowed() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzMyNjk0Nw=="}, "originalCommit": {"oid": "f5c19ed47f989d5d1e3067ec53efa8b93e5222f8"}, "originalPosition": 23}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4600, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}