{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMjYzNTQ5", "number": 51061, "reviewThreads": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowMzoxOVrODYQ4BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMzo0MVrODZSvFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2NzY4OTAwOnYy", "diffSide": "LEFT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowMzoxOVrOFeBaDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowMzoxOVrOFeBaDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAyNDY1NQ==", "bodyText": "There is no way to create a job without a model snapshot retention policy. If you set modelSnapshotRetentionDays to null then the builder will automatically default it back to 1 when the job is read back from xcontent.\nNegative numbers are not tolerated and throw a validation exception so the only way of not having a retention policy is setting it to a large value", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r367024655", "createdAt": "2020-01-15T18:03:19Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -45,114 +43,97 @@\n import static org.mockito.Matchers.same;\n import static org.mockito.Mockito.doAnswer;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n public class ExpiredModelSnapshotsRemoverTests extends ESTestCase {\n \n     private Client client;\n     private OriginSettingClient originSettingClient;\n-    private ThreadPool threadPool;\n     private List<SearchRequest> capturedSearchRequests;\n     private List<DeleteModelSnapshotAction.Request> capturedDeleteModelSnapshotRequests;\n-    private List<SearchResponse> searchResponsesPerCall;\n     private TestListener listener;\n \n     @Before\n     public void setUpTests() {\n         capturedSearchRequests = new ArrayList<>();\n         capturedDeleteModelSnapshotRequests = new ArrayList<>();\n-        searchResponsesPerCall = new ArrayList<>();\n \n         client = mock(Client.class);\n         originSettingClient = MockOriginSettingClient.mockOriginSettingClient(client, ClientHelper.ML_ORIGIN);\n \n         listener = new TestListener();\n-\n-        // Init thread pool\n-        Settings settings = Settings.builder()\n-                .put(\"node.name\", \"expired_model_snapshots_remover_test\")\n-                .build();\n-        threadPool = new ThreadPool(settings,\n-                new FixedExecutorBuilder(settings, MachineLearning.UTILITY_THREAD_POOL_NAME, 1, 1000, \"\"));\n-    }\n-\n-    @After\n-    public void shutdownThreadPool() {\n-        terminate(threadPool);\n-    }\n-\n-    public void testRemove_GivenJobsWithoutRetentionPolicy() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdd99d3908a02cdb3d5b876e5061bb014f789d99"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2OTczNDg1OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDozNjozNVrOFeU-gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxMzo0ODozNlrOFfe4LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NTI4Mg==", "bodyText": "@szabosteve can you look over these docs changes please. Do they make sense?", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r367345282", "createdAt": "2020-01-16T10:36:35Z", "author": {"login": "davidkyle"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU1NjA3Nw==", "bodyText": "@davidkyle Sorry, I haven't noticed this one earlier.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368556077", "createdAt": "2020-01-20T13:48:36Z", "author": {"login": "szabosteve"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NTI4Mg=="}, "originalCommit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NzcxMzgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDowMzozNFrOFffUbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDowMzozNFrOFffUbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2MzMxMQ==", "bodyText": "typo: lastest -> latest", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368563311", "createdAt": "2020-01-20T14:03:34Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 2 days of data starting 24 hrs ago\n+        long lastestBucketTime = System.currentTimeMillis() - TimeValue.timeValueHours(1).millis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NzczMDY0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDowOTowOFrOFffecA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDowOTowOFrOFffecA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2NTg3Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // We are going to create 2 days of data starting 24 hrs ago\n          \n          \n            \n                    // We are going to create 3 days of data ending 1 hour ago", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368565872", "createdAt": "2020-01-20T14:09:08Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 2 days of data starting 24 hrs ago", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3Nzc1ODY1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDoxNzo1NFrOFffu7g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDoxNzo1NFrOFffu7g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU3MDA5NA==", "bodyText": "Could this method be abstract instead of providing a default based on wall clock time?  It seems that now we've made deletion of model snapshots and results relative to latest bucket time rather than wall clock time we should do that for all job related documents that have a timestamp.  So having a default implementation of this method that uses wall clock time just seems like a way that we'll introduce a bug by accidentally deleting some other type of document based on wall clock time.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368570094", "createdAt": "2020-01-20T14:17:54Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {\n         long nowEpochMs = Instant.now(Clock.systemDefaultZone()).toEpochMilli();\n-        return nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis();\n+        listener.onResponse(nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis());\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3NzgxNjM3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemoverTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDozNTowNFrOFfgQhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDozNTowNFrOFfgQhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU3ODY5Mg==", "bodyText": "Looks like this is indented more than the line above.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368578692", "createdAt": "2020-01-20T14:35:04Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemoverTests.java", "diffHunk": "@@ -82,10 +82,10 @@ static SearchResponse createSearchResponse(List<? extends ToXContent> toXContent\n     static void givenJobs(Client client, List<Job> jobs) throws IOException {\n         SearchResponse response = AbstractExpiredJobDataRemoverTests.createSearchResponse(jobs);\n \n-        doAnswer(invocationOnMock -> {\n-            ActionListener<SearchResponse> listener = (ActionListener<SearchResponse>) invocationOnMock.getArguments()[2];\n-            listener.onResponse(response);\n-            return null;\n+            doAnswer(invocationOnMock -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3Nzg1OTcxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDo0ODoxNFrOFfgq1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzozNDowMVrOFflcSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU4NTQzMA==", "bodyText": "The other methods that extending classes are expected to override are protected, even though the actual classes that do extend this class are all in the same package.  But then this class's constructor is package private so it would be impossible to have a derived class in another package despite the abstract methods being set up for that.  I think for consistency they should all be the same - either protected or package private.  Certainly with a default implementation here I think protected makes it clearer that we expect derived classes to modify it rather than it's just been made accessible for testing.  But then if you agree with my other suggestion and make this abstract then that also makes that clear.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368585430", "createdAt": "2020-01-20T14:48:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODYzODUxNQ==", "bodyText": "The method is package-private for testing otherwise it is very difficult to test and can only be done indirectly. abstract makes sense.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368638515", "createdAt": "2020-01-20T16:34:38Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU4NTQzMA=="}, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY0NTY3MA==", "bodyText": "But protected would also allow it to be tested directly.  Basically I think all the abstract methods and the constructor should have the same accessibility, whether that be protected or package private.  So either change the ones that are currently protected to be package private or change this one plus the constructor to be protected.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368645670", "createdAt": "2020-01-20T16:49:43Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU4NTQzMA=="}, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2MzYyNQ==", "bodyText": "Given that the base class is package private, only classes in the same package can implement the abstract method whether the method is protected or package private. The only difference is I could derive a new class from one of the package's public non-abstract classes and reimplement calcCutoffEpochMs in a different package if it was protected but not if package private. In practice this isn't a concern so I've gone for the principle of least visibility and made the abstract methods package private.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368663625", "createdAt": "2020-01-20T17:34:01Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU4NTQzMA=="}, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODM4ODcxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzozOTowOFrOFfljhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzozOTowOFrOFfljhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2NTQ3Ng==", "bodyText": "The next two methods (removeDataBefore and createQuery) might as well be package private too for consistency with the other abstract methods.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368665476", "createdAt": "2020-01-20T17:39:08Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,22 +64,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n-        long nowEpochMs = Instant.now(Clock.systemDefaultZone()).toEpochMilli();\n-        return nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis();\n-    }\n+    abstract void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener);\n \n-    protected abstract Long getRetentionDays(Job job);\n+    abstract Long getRetentionDays(Job job);\n \n     /**\n      * Template method to allow implementation details of various types of data (e.g. results, model snapshots).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea"}, "originalPosition": 58}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODM5NDg1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzo0MTo0OVrOFflnFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzo0MTo0OVrOFflnFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2NjM5MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // We are going to create 3 days of data starting 1 hr ago\n          \n          \n            \n                    // We are going to create 3 days of data ending 1 hr ago", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368666391", "createdAt": "2020-01-20T17:41:49Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 3 days of data starting 1 hr ago", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQzNzA5OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowMTozNVrOFfmAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowNToyMVrOFfmEaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3Mjg1MA==", "bodyText": "If this property is still a number that represents days, I think it's worth keeping that in the definition.  For example:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Advanced configuration option. Denotes the period for which model snapshots\n          \n          \n            \n            Advanced configuration option. The period of time (in days) that model snapshots are retained.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368672850", "createdAt": "2020-01-20T18:01:35Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3Mzg5OQ==", "bodyText": "Yes that's better thanks", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368673899", "createdAt": "2020-01-20T18:05:21Z", "author": {"login": "davidkyle"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3Mjg1MA=="}, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ0ODk0OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowNzo1M1rOFfmHYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowNzo1M1rOFfmHYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NDY1OQ==", "bodyText": "Not mandatory, but I try to avoid possessives:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            will be retained. Age is calculated as the time from the newest model snapshot's\n          \n          \n            \n            Age is calculated relative to the timestamp of the newest model snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368674659", "createdAt": "2020-01-20T18:07:53Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots\n+will be retained. Age is calculated as the time from the newest model snapshot's", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 8}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ1MTk0OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowOToyMVrOFfmJMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowOToyMVrOFfmJMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NTEyMA==", "bodyText": "Maybe move the deletion info here?:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            which means snapshots are retained for one day (twenty-four hours).\n          \n          \n            \n            which means snapshots that are one day (twenty-four hours) older than the newest snapshot are deleted.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368675120", "createdAt": "2020-01-20T18:09:21Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots\n+will be retained. Age is calculated as the time from the newest model snapshot's\n+timestamp, older snapshots are automatically deleted. The default value is `1`,\n+which means snapshots are retained for one day (twenty-four hours).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 10}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ2NTA0OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxNjowNFrOFfmQ0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxNjowNFrOFfmQ0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NzA3Mw==", "bodyText": "I'm not sure I understand why we're making the descriptions diverge like this (focus on pruning vs retaining). I'd recommend keeping them in synch unless I'm missing something important here. For example:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Advanced configuration option. When set this option will prune results older\n          \n          \n            \n            Advanced configuration option. The period of time (in days) that results are retained.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368677073", "createdAt": "2020-01-20T18:16:04Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ3MTQ1OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxOTozM1rOFfmUwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxOTozM1rOFfmUwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3ODA4Mg==", "bodyText": "Note sure if newest or latest is correct, bit I think it should be used similarly in both definitions:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            than this age in days. Age is calculated as the difference between the latest\n          \n          \n            \n            Age is calculated relative to the timestamp of the latest bucket result.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368678082", "createdAt": "2020-01-20T18:19:33Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ3NTIzOnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMToyOVrOFfmXDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMToyOVrOFfmXDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3ODY2OA==", "bodyText": "Moving the \"when set this option...\" here:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            bucket result's timestamp and the result's timestamp. Once per day at 00:30\n          \n          \n            \n            If this property has a non-null value, once per day at 00:30", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368678668", "createdAt": "2020-01-20T18:21:29Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest\n+bucket result's timestamp and the result's timestamp. Once per day at 00:30", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI3ODQ3OTU3OnYy", "diffSide": "RIGHT", "path": "docs/reference/ml/ml-shared.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMzo0MVrOFfmZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMzo0MVrOFfmZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3OTMyNQ==", "bodyText": "Trying to match suggestion in the other definition :) :\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            (server time), results older than this are deleted from {es}. The default\n          \n          \n            \n            (server time), results that are the specified number of days older than the latest bucket result are deleted from {es}. The default", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368679325", "createdAt": "2020-01-20T18:23:41Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest\n+bucket result's timestamp and the result's timestamp. Once per day at 00:30\n+(server time), results older than this are deleted from {es}. The default", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4614, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}