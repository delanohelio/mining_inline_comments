{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0ODUwMDU5", "number": 63806, "title": "Count only mapped fields towards docvalue_fields limit", "bodyText": "Currently we count every field requested in the search request bodies\n'docvalue_fields' section towards the limit defined by\nthe 'max_docvalue_fields_search' index setting which defaults to 100. This can\nbe a problem e.g. if the user searches across several indices with some fields\npresent in one index but not the other and has to add the joint set of field\nnames to the query. We currently trip the limit even if the number of actually\nmapped fields in each index is below the limit.\nThis change adds a step to distiguish between mappend and unmapped fields and\nonly count the former towards the limit.\nCloses #63730", "createdAt": "2020-10-16T13:29:57Z", "url": "https://github.com/elastic/elasticsearch/pull/63806", "merged": true, "mergeCommit": {"oid": "498e264df4e8f3c833dd9e3531a1ec5acd305ebd"}, "closed": true, "closedAt": "2020-10-21T15:51:12Z", "author": {"login": "cbuescher"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdTGU5TgH2gAyNTA0ODUwMDU5Ojg4ZDhmZjFiODdmMDY0YmFmZjBjOGQ0MjJiZjRjNjgwMGJkMWExZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUvagwgFqTUxMzgzODY1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "88d8ff1b87f064baff0c8d422bf4c6800bd1a1d5", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/88d8ff1b87f064baff0c8d422bf4c6800bd1a1d5", "committedDate": "2020-10-16T13:24:03Z", "message": "Count only mapped fields towards docvalue_fields limit\n\nCurrently we count every field requested in the search request bodies\n'docvalue_fields' section towards the limit defined by\nthe 'max_docvalue_fields_search' index setting which defaults to 100. This can\nbe a problem e.g. if the user searches across several indices with some fields\npresent in one index but not the other and has to add the joint set of field\nnames to the query. We currently trip the limit even if the number of actually\nmapped fields in each index is below the limit.\nThis change adds a step to distiguish between mappend and unmapped fields and\nonly count the former towards the limit.\n\nCloses #63730"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02738f8860c459f216428ab842b1d852055a045f", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/02738f8860c459f216428ab842b1d852055a045f", "committedDate": "2020-10-16T14:57:31Z", "message": "fix yaml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb0d60983d8901ba19d2e341b4b0515055c4cd02", "committedDate": "2020-10-16T15:58:48Z", "message": "Skip yaml test for mixed cluster since message changed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjAzMDg4", "url": "https://github.com/elastic/elasticsearch/pull/63806#pullrequestreview-510603088", "createdAt": "2020-10-16T16:00:03Z", "commit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjowMDowM1rOHjGpSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjowMDowM1rOHjGpSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU3MTA4Mg==", "bodyText": "I dislike having to do this here just because I changed the error message slightly. Happy do get some better ideas what we do in such cases in other places if possible.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506571082", "createdAt": "2020-10-16T16:00:03Z", "author": {"login": "cbuescher"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,18 +85,22 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason: waiting for backport", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjEwMjU4", "url": "https://github.com/elastic/elasticsearch/pull/63806#pullrequestreview-510610258", "createdAt": "2020-10-16T16:09:14Z", "commit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjoyMTowOVrOHjHZBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjoyNDo1MVrOHjHhOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4MzMwMQ==", "bodyText": "I think this signature change undoes some of @javanna's work in #63239. The easiest fix would be to keep the function parameter, and add a new one QueryShardContext::isFieldMapped.\nAs a side note, if we end up passing a lot of functions to avoid exposing MapperService, I wonder if we should pull out a lightweight abstraction similar to FieldTypeLookup and pass it around instead?", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506583301", "createdAt": "2020-10-16T16:21:09Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4NTQwMg==", "bodyText": "For efficiency could we only create a new FieldAndFormat if the field is mapped? I think we'll end up dropping the field anyways, not even having an entry in the response for it.\nAlso small typo, fedinde -> defined.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506585402", "createdAt": "2020-10-16T16:24:51Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {\n+        int maxAllowedDocvalueFields = mapperService.getIndexSettings().getMaxDocvalueFields();\n+\n         List<FieldAndFormat> fields = new ArrayList<>();\n+        int mappedFieldCount = 0;\n         for (FieldAndFormat field : fieldPatterns) {\n-            Collection<String> fieldNames = simpleMatchToFullName.apply(field.field);\n+            Collection<String> fieldNames = mapperService.simpleMatchToFullName(field.field);\n             for (String fieldName: fieldNames) {\n                 fields.add(new FieldAndFormat(fieldName, field.format));\n+                // only count the mapped fields towards the limit fedinde by IndexSettings.MAX_DOCVALUE_FIELDS_SEARCH_SETTING\n+                if (mapperService.fieldType(fieldName) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09744e5d0aa70870505c9ff13e9c612ff7e4bc1", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/d09744e5d0aa70870505c9ff13e9c612ff7e4bc1", "committedDate": "2020-10-19T08:58:31Z", "message": "Merge branch 'master' into fix-63730"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c331adf181c951e2fdfa1c35272346a74512cc60", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/c331adf181c951e2fdfa1c35272346a74512cc60", "committedDate": "2020-10-19T10:09:18Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTExOTIzODk3", "url": "https://github.com/elastic/elasticsearch/pull/63806#pullrequestreview-511923897", "createdAt": "2020-10-19T16:04:05Z", "commit": {"oid": "c331adf181c951e2fdfa1c35272346a74512cc60"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNDowNVrOHkWGbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNDowNVrOHkWGbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3Mjg3OQ==", "bodyText": "Do we want to remove this skip now?", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r507872879", "createdAt": "2020-10-19T16:04:05Z", "author": {"login": "jtibshirani"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,6 +85,10 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c331adf181c951e2fdfa1c35272346a74512cc60"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3822a3e2c9d3a9a6dfdd91d424c436e0784c53d8", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/3822a3e2c9d3a9a6dfdd91d424c436e0784c53d8", "committedDate": "2020-10-19T17:24:01Z", "message": "remove skip"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzODM4NjU4", "url": "https://github.com/elastic/elasticsearch/pull/63806#pullrequestreview-513838658", "createdAt": "2020-10-21T15:50:13Z", "commit": {"oid": "3822a3e2c9d3a9a6dfdd91d424c436e0784c53d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3880, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}