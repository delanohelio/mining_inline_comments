{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MDg0NDM5", "number": 62480, "title": "Introduce a sparse HyperLogLogPlusPlus class for cloning and serializing low cardinality buckets", "bodyText": "Whenever we build the HLL++ structure, we clone every bucket into a new HLL++ structure into an InternalCardinality object. In addition, those object might be serialise and sent to the coordinated node where they are deserialised.\nIn all cases we are constructing a dense HLL++ structure. For example if the bucket contains three values in the Linear counting strategy, we are still constructing an array of size 1 << precision. This is probably quite wasteful.\nThis PR adds a new sparse HLL++ structure for cloning and serialising which only supports linear counting.\nIn order to share as much code as possible a new base class for HLL++ algorithm is introduced which contains the methods for cloning, serialising, equality and hashing.", "createdAt": "2020-09-16T15:50:59Z", "url": "https://github.com/elastic/elasticsearch/pull/62480", "merged": true, "mergeCommit": {"oid": "ebb381c6bcb70e653658c2726131d607dc94f5ff"}, "closed": true, "closedAt": "2020-09-17T06:06:50Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJeRgxAH2gAyNDg4MDg0NDM5OmQ5NGQyNmM4MzEyMzMyYjIzOWY5MWZlZDkyOTA5OGEyYWYzYjljYjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJgEhHgH2gAyNDg4MDg0NDM5OjE3MDJjMGE0MDc4OWY1MGU0MDljNTkyZDcwNzJmNjYwNmM0MGFkYzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d94d26c8312332b239f91fed929098a2af3b9cb6", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/d94d26c8312332b239f91fed929098a2af3b9cb6", "committedDate": "2020-09-16T15:38:50Z", "message": "Introduce a sparse HyperLogLogPlusPlus class for cloning and serializing low cardinality buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e488006a90ec6e62a807772ee19f7b18b281ac5", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e488006a90ec6e62a807772ee19f7b18b281ac5", "committedDate": "2020-09-16T15:50:41Z", "message": "unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5Nzc2MzA0", "url": "https://github.com/elastic/elasticsearch/pull/62480#pullrequestreview-489776304", "createdAt": "2020-09-16T16:00:59Z", "commit": {"oid": "7e488006a90ec6e62a807772ee19f7b18b281ac5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjowMDo1OVrOHS33AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNjowMDo1OVrOHS33AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTU1MTYxNw==", "bodyText": "This means that as soon as you reduce you allocate the whole array, even if the cardinality is still small.", "url": "https://github.com/elastic/elasticsearch/pull/62480#discussion_r489551617", "createdAt": "2020-09-16T16:00:59Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/InternalCardinality.java", "diffHunk": "@@ -78,34 +78,30 @@ public long getValue() {\n         return counts == null ? 0 : counts.cardinality(0);\n     }\n \n-    public HyperLogLogPlusPlus getCounts() {\n+    public AbstractHyperLogLogPlusPlus getCounts() {\n         return counts;\n     }\n \n     @Override\n     public InternalAggregation reduce(List<InternalAggregation> aggregations, ReduceContext reduceContext) {\n-        InternalCardinality reduced = null;\n+        HyperLogLogPlusPlus reduced = null;\n         for (InternalAggregation aggregation : aggregations) {\n             final InternalCardinality cardinality = (InternalCardinality) aggregation;\n             if (cardinality.counts != null) {\n                 if (reduced == null) {\n-                    reduced = new InternalCardinality(name, new HyperLogLogPlusPlus(cardinality.counts.precision(),\n-                            BigArrays.NON_RECYCLING_INSTANCE, 1), getMetadata());\n+                    reduced = new HyperLogLogPlusPlus(cardinality.counts.precision(),\n+                        BigArrays.NON_RECYCLING_INSTANCE, 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e488006a90ec6e62a807772ee19f7b18b281ac5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e6f650de7bbdc8831684b1d23108e0401d1a8d0", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e6f650de7bbdc8831684b1d23108e0401d1a8d0", "committedDate": "2020-09-16T16:08:35Z", "message": "xpack compile error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "296658011bc37e85c134e91575aaaa629059eaa8", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/296658011bc37e85c134e91575aaaa629059eaa8", "committedDate": "2020-09-16T16:39:34Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1702c0a40789f50e409c592d7072f6606c40adc4", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/1702c0a40789f50e409c592d7072f6606c40adc4", "committedDate": "2020-09-16T17:44:27Z", "message": "add test for new class"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4514, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}