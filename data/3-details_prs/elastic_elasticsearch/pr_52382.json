{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1NTQ4MDIw", "number": 52382, "title": "Geo shape query vs geo point", "bodyText": "Enable geo_shape query to work on geo_point fields for shapes: circle, polygon, multipolygon, rectangle\nsee: #48928\nmany thanks to @iverase for fa64b52", "createdAt": "2020-02-14T19:51:18Z", "url": "https://github.com/elastic/elasticsearch/pull/52382", "merged": true, "mergeCommit": {"oid": "d1cbdfb753045a0eafebefe22cf7aa6b235a3da3"}, "closed": true, "closedAt": "2020-03-18T16:03:53Z", "author": {"login": "djptek"}, "timelineItems": {"totalCount": 125, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMmOHXgH2gAyMzc1NTQ4MDIwOmZkYzgzNzlmZTVmMWFmNDA2OGMzZWMwOThmZTNmNjgxZTEwOWMwMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO4xtUAFqTM3NjI4MzcyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fdc8379fe5f1af4068c3ec098fe3f681e109c02f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdc8379fe5f1af4068c3ec098fe3f681e109c02f", "committedDate": "2020-03-11T12:24:59Z", "message": "refactor make doCreateTestQueryBuilder(boolean indexedShape) abstract"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3db5f95fcdd7a1baf3e0b96ae2f6f586bba601c9", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/3db5f95fcdd7a1baf3e0b96ae2f6f586bba601c9", "committedDate": "2020-03-13T07:56:35Z", "message": "added @iverase patch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ca69654bd24ae360e4c2734d6a7d554a315e3f8", "committedDate": "2020-03-13T08:17:21Z", "message": "fix style violations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTI0ODA5", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-374124809", "createdAt": "2020-03-13T08:38:58Z", "commit": {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODozODo1OVrOF17aGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODozODo1OVrOF17aGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5MjE4Ng==", "bodyText": "@djptek this is my fault but I think is more correct to call it AbstractSearchableGeometryFieldType?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392092186", "createdAt": "2020-03-13T08:38:59Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,33 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearcheableGeometryFieldType extends MappedFieldType {\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTI1NDE5", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-374125419", "createdAt": "2020-03-13T08:40:15Z", "commit": {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODo0MDoxNVrOF17b7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwODo0MDoxNVrOF17b7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjA5MjY1Mg==", "bodyText": "In this subclass we can remove setGeometryQueryBuilder and geometryQueryBuilder methods?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392092652", "createdAt": "2020-03-13T08:40:15Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,33 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearcheableGeometryFieldType extends MappedFieldType {\n+\n+        protected QueryProcessor geometryQueryBuilder;\n+\n+        protected AbstractSearcheableGeometryFieldType() {\n+        }\n+\n+        protected AbstractSearcheableGeometryFieldType(AbstractSearcheableGeometryFieldType ref) {\n+            super(ref);\n+        }\n+        public void setGeometryQueryBuilder(QueryProcessor geometryQueryBuilder)  {\n+            this.geometryQueryBuilder = geometryQueryBuilder;\n+        }\n+\n+        public QueryProcessor geometryQueryBuilder() {\n+            return geometryQueryBuilder;\n+        }\n+    }\n+\n+    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends AbstractSearcheableGeometryFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca69654bd24ae360e4c2734d6a7d554a315e3f8"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1f1a4b4a13d31165043e0ef65fe6561e26dbb96", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1f1a4b4a13d31165043e0ef65fe6561e26dbb96", "committedDate": "2020-03-13T08:46:52Z", "message": "fix classname typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf79c774938d1e799acd87475ac98767145b8c5b", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf79c774938d1e799acd87475ac98767145b8c5b", "committedDate": "2020-03-13T09:45:59Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51dcb707a169c3e2c2de098a9441e0f1cbb85662", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/51dcb707a169c3e2c2de098a9441e0f1cbb85662", "committedDate": "2020-03-13T09:47:02Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4251742678c4a72da0ac74d2daa5a151383c14ad", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/4251742678c4a72da0ac74d2daa5a151383c14ad", "committedDate": "2020-03-13T10:54:53Z", "message": "remove copycat methods from child class"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjMwOTY3", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-374630967", "createdAt": "2020-03-13T21:31:35Z", "commit": {"oid": "4251742678c4a72da0ac74d2daa5a151383c14ad"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMTozMTozNVrOF2TzlQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMTozMTozNVrOF2TzlQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ5MTkyNQ==", "bodyText": "Since GeoPointFieldMapper doesn't inherit from AbstractGeometryFieldMapper I would prefer AbstractSearchableGeometryFieldType to be in a separate file. It's not longer confined to AbstractGeometryFieldMapper and its derivatives, so doesn't make much sense making it an inner class. It would be also good to add some javadocs to it explaining the purpose of this class for future readers. Basically, something as simple as \"a base class for geometry types that supports shape query builder\" should help.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392491925", "createdAt": "2020-03-13T21:31:35Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -272,14 +272,34 @@ protected Builder newBuilder(String name, Map<String, Object> params) {\n         }\n     }\n \n-    public abstract static class AbstractGeometryFieldType<Parsed, Processed> extends MappedFieldType {\n+    public abstract static class AbstractSearchableGeometryFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4251742678c4a72da0ac74d2daa5a151383c14ad"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd9cb07fba2a506162e2ab5db7cbb101a3a2eb99", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd9cb07fba2a506162e2ab5db7cbb101a3a2eb99", "committedDate": "2020-03-13T22:31:05Z", "message": "added AbstractSearchableGeometryFieldType as separate file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7dcfa6ece9a4535e561aca05309f0c7d562918a6", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/7dcfa6ece9a4535e561aca05309f0c7d562918a6", "committedDate": "2020-03-14T07:52:51Z", "message": "add Licenseheaders"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b49c3d001242ef47ea75f9145aec08967762082", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b49c3d001242ef47ea75f9145aec08967762082", "committedDate": "2020-03-14T08:40:58Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6358862b0d8e12ecf6af59be7a065b12e9c72b2a", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/6358862b0d8e12ecf6af59be7a065b12e9c72b2a", "committedDate": "2020-03-14T08:41:31Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NzA4MzQ5", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-374708349", "createdAt": "2020-03-14T08:49:46Z", "commit": {"oid": "6358862b0d8e12ecf6af59be7a065b12e9c72b2a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwODo0OTo0NlrOF2YhWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xNFQwODo0OTo0NlrOF2YhWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjU2OTE3Ng==", "bodyText": "Shouldn't be move the query processor interface in this class as well?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r392569176", "createdAt": "2020-03-14T08:49:46Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractSearchableGeometryFieldType.java", "diffHunk": "@@ -0,0 +1,44 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+/**\n+ * a base class for geometry types that support shape query builder\n+ */\n+public abstract class AbstractSearchableGeometryFieldType extends MappedFieldType {\n+\n+    protected AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder;\n+\n+    protected AbstractSearchableGeometryFieldType() {\n+    }\n+\n+    protected AbstractSearchableGeometryFieldType(AbstractSearchableGeometryFieldType ref) {\n+        super(ref);\n+    }\n+\n+    public void setGeometryQueryBuilder(AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder)  {\n+        this.geometryQueryBuilder = geometryQueryBuilder;\n+    }\n+\n+    public AbstractGeometryFieldMapper.QueryProcessor geometryQueryBuilder() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6358862b0d8e12ecf6af59be7a065b12e9c72b2a"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/01548bb8db6184a9af8776e2a244c8726f958946", "committedDate": "2020-03-14T10:58:52Z", "message": "move AbstractGeometryFieldMapper.QueryProcessor to AbstractSearchableGeometryFieldType"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjAwMTM0", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-376200134", "createdAt": "2020-03-17T16:27:31Z", "commit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjoyNzozMVrOF3kJjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxNjozODozNlrOF3kmyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwODI3MQ==", "bodyText": "I think we will want to add a section explicitly listing which shape types are not supported for geo_point types:\n\nPOINT\nLINE\nMULTIPOINT\nMULTILINE\n\nAnd I think we can eventually add these as new LatLonPoint queries in Lucene by reusing our relate methods? Which would give us full parity. /cc @iverase", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393808271", "createdAt": "2020-03-17T16:27:31Z", "author": {"login": "nknize"}, "path": "docs/reference/query-dsl/geo-shape-query.asciidoc", "diffHunk": "@@ -4,9 +4,9 @@\n <titleabbrev>Geo-shape</titleabbrev>\n ++++\n \n-Filter documents indexed using the `geo_shape` type.\n+Filter documents indexed using the `geo_shape` or `geo_point` type.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwOTg2Ng==", "bodyText": "I think we should we add testing for GeometryCollection. But I'm okay with it coming in a separate PR.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393809866", "createdAt": "2020-03-17T16:29:48Z", "author": {"login": "nknize"}, "path": "server/src/test/java/org/elasticsearch/index/query/GeoShapeQueryBuilderGeoPointTests.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.index.query;\n+\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.ShapeBuilder;\n+import org.elasticsearch.test.geo.RandomShapeGenerator;\n+\n+public class GeoShapeQueryBuilderGeoPointTests extends GeoShapeQueryBuilderTests {\n+\n+    protected String fieldName() {\n+        return GEO_POINT_FIELD_NAME;\n+    }\n+\n+    protected GeoShapeQueryBuilder doCreateTestQueryBuilder(boolean indexedShape) {\n+        RandomShapeGenerator.ShapeType shapeType = RandomShapeGenerator.ShapeType.POLYGON;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMDI5OA==", "bodyText": "Lets add support here for GeometryCollection as well (separate PR is fine).", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393810298", "createdAt": "2020-03-17T16:30:24Z", "author": {"login": "nknize"}, "path": "server/src/test/java/org/elasticsearch/index/query/GeoShapeQueryBuilderGeoShapeTests.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.index.query;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.ShapeBuilder;\n+import org.elasticsearch.test.geo.RandomShapeGenerator;\n+\n+public class GeoShapeQueryBuilderGeoShapeTests extends GeoShapeQueryBuilderTests {\n+\n+    protected String fieldName() {\n+        return GEO_SHAPE_FIELD_NAME;\n+    }\n+\n+    protected GeoShapeQueryBuilder doCreateTestQueryBuilder(boolean indexedShape) {\n+        RandomShapeGenerator.ShapeType shapeType = randomFrom(\n+            RandomShapeGenerator.ShapeType.POINT,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMTIyMw==", "bodyText": "Same: lets add testing for GeometryCollection.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393811223", "createdAt": "2020-03-17T16:31:48Z", "author": {"login": "nknize"}, "path": "server/src/test/java/org/elasticsearch/search/geo/GeoPointShapeQueryTests.java", "diffHunk": "@@ -19,23 +19,158 @@\n \n package org.elasticsearch.search.geo;\n \n+import org.elasticsearch.action.search.SearchAction;\n+import org.elasticsearch.action.search.SearchPhaseExecutionException;\n+import org.elasticsearch.action.search.SearchRequestBuilder;\n+import org.elasticsearch.common.Strings;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.geo.builders.CoordinatesBuilder;\n+import org.elasticsearch.common.geo.builders.LineStringBuilder;\n+import org.elasticsearch.common.geo.builders.MultiLineStringBuilder;\n+import org.elasticsearch.common.geo.builders.MultiPointBuilder;\n+import org.elasticsearch.common.geo.builders.PointBuilder;\n import org.elasticsearch.common.xcontent.XContentBuilder;\n import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.geometry.Line;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.query.GeoShapeQueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+\n+import static org.hamcrest.Matchers.containsString;\n \n public class GeoPointShapeQueryTests extends GeoQueryTests {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzU2Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (validContentTypes().contains(fieldType.typeName()) == false) {\n          \n          \n            \n                    List<String> validContentTypes = validContentTypes()\n          \n          \n            \n                    if (validContentTypes.contains(fieldType.typeName()) == false) {", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393813563", "createdAt": "2020-03-17T16:35:21Z", "author": {"login": "nknize"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (validContentTypes().contains(fieldType.typeName()) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzg4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes())\n          \n          \n            \n                            \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes)", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393813888", "createdAt": "2020-03-17T16:35:52Z", "author": {"login": "nknize"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (validContentTypes().contains(fieldType.typeName()) == false) {\n             throw new QueryShardException(context,\n-                \"Field [\" + fieldName + \"] is not of type [\" + queryFieldType() + \"] but of type [\" + fieldType.typeName() + \"]\");\n+                \"Field [\" + fieldName + \"] is not of type [\" + String.join(\" or \", validContentTypes())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxNTc1NQ==", "bodyText": "I was afraid of this danger biting us. I'm not much a fan of validContentTypes() returning a new List instance for every call. So maybe we should consider making a static variable within each of the derived builders (that only calls this method once)? I'm okay changing that in a follow up PR, but lets change this method now to only call validContentTypes once.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393815755", "createdAt": "2020-03-17T16:38:36Z", "author": {"login": "nknize"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (validContentTypes().contains(fieldType.typeName()) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgxMzU2Mw=="}, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1acc0f09d9d8f680fa67f7398ac0f8d1bce57998", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/1acc0f09d9d8f680fa67f7398ac0f8d1bce57998", "committedDate": "2020-03-17T17:41:49Z", "message": "use static to avoid (re-)creating lists"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15f8497c647e632a92081531bd452bcb2cdf90b5", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/15f8497c647e632a92081531bd452bcb2cdf90b5", "committedDate": "2020-03-17T17:42:37Z", "message": "add reference to shapes NOT supported for geo_shape query vs geo_point fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "833ac0d13f19b60a6bfc1a3e1d7eeb51d9cab94b", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/833ac0d13f19b60a6bfc1a3e1d7eeb51d9cab94b", "committedDate": "2020-03-17T17:52:15Z", "message": "Update x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java\n\nCo-Authored-By: Nick Knize <nknize@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2facb66286bd942ec9b34cf9d40c71c102f9f2c9", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/2facb66286bd942ec9b34cf9d40c71c102f9f2c9", "committedDate": "2020-03-17T17:57:38Z", "message": "+; ;-)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5df014a6d4d29d850d986b93588be346260684c8", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/5df014a6d4d29d850d986b93588be346260684c8", "committedDate": "2020-03-17T19:37:25Z", "message": "merge upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f3f90bbf06c61a0c91e4df64a7a7bc02484191a", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f3f90bbf06c61a0c91e4df64a7a7bc02484191a", "committedDate": "2020-03-17T19:37:56Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e986c92c0557c0df10330e6a5b3e8c7c5e9b7c05", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e986c92c0557c0df10330e6a5b3e8c7c5e9b7c05", "committedDate": "2020-03-17T20:11:34Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MjgzNzI1", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-376283725", "createdAt": "2020-03-17T18:07:40Z", "commit": {"oid": "2facb66286bd942ec9b34cf9d40c71c102f9f2c9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODowNzo0MVrOF3oIkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xN1QxODowNzo0MVrOF3oIkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Mzg3MzU1NA==", "bodyText": "\ud83e\udd47", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r393873554", "createdAt": "2020-03-17T18:07:41Z", "author": {"login": "nknize"}, "path": "docs/reference/query-dsl/geo-shape-query.asciidoc", "diffHunk": "@@ -4,9 +4,9 @@\n <titleabbrev>Geo-shape</titleabbrev>\n ++++\n \n-Filter documents indexed using the `geo_shape` type.\n+Filter documents indexed using the `geo_shape` or `geo_point` type.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MzgwODI3MQ=="}, "originalCommit": {"oid": "01548bb8db6184a9af8776e2a244c8726f958946"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5f09fbfbe21fee1960467da4ce6d124a1bc501f", "committedDate": "2019-11-15T18:05:23Z", "message": "WIP subclassing GeoShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478cee77cd823009bf0f7ac7a622e09ca3efc35f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/478cee77cd823009bf0f7ac7a622e09ca3efc35f", "committedDate": "2019-11-18T17:17:59Z", "message": "WIP subclassing GeoShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ebd06e44089a94b605d6a2d3f77fbb9a4828d14c", "committedDate": "2019-11-19T12:34:44Z", "message": "WIP subclassing GeoShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d3c189b8cdaf9d644af94399d15e6207a19594d", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d3c189b8cdaf9d644af94399d15e6207a19594d", "committedDate": "2019-11-19T19:58:13Z", "message": "WIP writing GeoPointShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab60f0679b0837885dde114f8870e6484ba4077d", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab60f0679b0837885dde114f8870e6484ba4077d", "committedDate": "2019-11-20T19:07:45Z", "message": "Added Failing Test testIndexPointsFilterRectangle\n in Class org.elasticsearch.search.geo.GeoPointShapeQueryTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22308fa23135907331c969f1f16459789b0eccd", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/c22308fa23135907331c969f1f16459789b0eccd", "committedDate": "2019-11-20T19:20:10Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "443441c728982862c9cf5112afc231ea6f9683e8", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/443441c728982862c9cf5112afc231ea6f9683e8", "committedDate": "2019-11-21T20:16:16Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b95358fca9a5b1f266651ac507fe17115a5e35", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/24b95358fca9a5b1f266651ac507fe17115a5e35", "committedDate": "2019-11-23T19:40:19Z", "message": "permit GeoShapeQueryBuilder to accept a geo_point -> class_cast_exception raised, see org.elasticsearch.index.query.QueryShardContext.toQuery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c1bfcd37b42af01746e17c7a55a1557142aac1", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/59c1bfcd37b42af01746e17c7a55a1557142aac1", "committedDate": "2019-12-02T18:03:56Z", "message": "added @Override protected XContentBuilder createMapping\nin GeoPointShapeQueryTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "192ad15e5e73a57e8b909360130fb14c8ca458c4", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/192ad15e5e73a57e8b909360130fb14c8ca458c4", "committedDate": "2020-01-07T08:59:26Z", "message": "merged upstream including 418edc6 types fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ddc9e8cc08d288cbc0b03bd49880a16b7fba27f1", "committedDate": "2020-01-07T15:26:12Z", "message": "repeat refactor post type removal and remove remaining types from GeoShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f3bd915b56e3c5ca26fc19d0a63a66003e3f0cc", "committedDate": "2020-01-07T15:27:59Z", "message": "tidy GeoPointShapeQueryTests.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d68e7febd1033882c125def51cc604e8ecaeac1", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d68e7febd1033882c125def51cc604e8ecaeac1", "committedDate": "2020-01-08T10:06:11Z", "message": "interim checkin, still failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d880c260540139a356be59d161d99436ac9070a", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d880c260540139a356be59d161d99436ac9070a", "committedDate": "2020-01-08T11:11:41Z", "message": "GeoShapeQueryTests.java passing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e275f3eb0a771fd11aa967b4d7653f7f64276a87", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e275f3eb0a771fd11aa967b4d7653f7f64276a87", "committedDate": "2020-01-08T11:21:19Z", "message": "GeoShapeQueryTests.java extends GeoQueryTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "316c7b18e843fef85c668aaf3aefdb69d9909b17", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/316c7b18e843fef85c668aaf3aefdb69d9909b17", "committedDate": "2020-01-08T11:35:58Z", "message": "refactored + tests passing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7e5e7b86c853314445938090fc4782fbd58b45e", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7e5e7b86c853314445938090fc4782fbd58b45e", "committedDate": "2020-01-08T11:43:10Z", "message": "refactored + tests passing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7f2218a3ca3fa0d87e888d68bd6ec5ed1db6afb", "committedDate": "2020-01-08T11:58:43Z", "message": "reset GeoShapeQueryBuilder.java for future PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e54c867b82cebac4bf144ccdf2a1c45961f509e9", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e54c867b82cebac4bf144ccdf2a1c45961f509e9", "committedDate": "2020-01-09T18:29:03Z", "message": "improved refactoring see: https://github.com/elastic/elasticsearch/pull/50737#pullrequestreview-340443408"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9025578d4fb3b94aefb2b37671e699abff1df3f8", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/9025578d4fb3b94aefb2b37671e699abff1df3f8", "committedDate": "2020-01-14T14:03:34Z", "message": "refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13e8b00752d45d9290cb8f2d715cf8702a582f94", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/13e8b00752d45d9290cb8f2d715cf8702a582f94", "committedDate": "2020-01-24T13:31:26Z", "message": "Merge branch 'djptek-geo-shape-query-vs-geo-point'\n\nGeoShapeQueryTests refactored adding superclass and sibling to accomodate new test coverage as part of adaptation of geo_shape query to work on geo_point fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83504d1866b1ab048cfd8ac1967e63586f964ec5", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/83504d1866b1ab048cfd8ac1967e63586f964ec5", "committedDate": "2020-01-24T15:16:45Z", "message": "merged refactor changes to upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d3676bc6a3e0e319d8fb44e3c9da196ef764207", "committedDate": "2020-01-24T15:58:12Z", "message": "rectified Checkstyle rule violations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322db3fbe2bf01174bc9a4ba5182e63edb87ec0f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/322db3fbe2bf01174bc9a4ba5182e63edb87ec0f", "committedDate": "2020-01-31T16:54:54Z", "message": "merge to upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa64b522092f30e49b5be39b644c798205e585dc", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa64b522092f30e49b5be39b644c798205e585dc", "committedDate": "2020-02-12T13:32:39Z", "message": "add @iverase patch with thanks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca4ef1acf1af620de255f441ed57e05eb80aea32", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca4ef1acf1af620de255f441ed57e05eb80aea32", "committedDate": "2020-02-12T17:29:32Z", "message": "tidied patch, added geo_shape vs circle test and implmented visitor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4683d5b38cee3ae84a75edfdfb6c8e35fff92b5a", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/4683d5b38cee3ae84a75edfdfb6c8e35fff92b5a", "committedDate": "2020-02-13T18:26:07Z", "message": "added tests, all OK EXCEPT testQueryLinearRing()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09ac81863a357fdc855dfb44feaf4270a06692c0", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/09ac81863a357fdc855dfb44feaf4270a06692c0", "committedDate": "2020-02-14T17:13:27Z", "message": "LinearRing test OK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "364d9f80ff50f217e3dcdd3ee0cba333512fb95e", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/364d9f80ff50f217e3dcdd3ee0cba333512fb95e", "committedDate": "2020-02-14T19:13:03Z", "message": "document geo_shape vs geo_point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d77f793026f88e2fb1a621b8abe6a5ab275165fd", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/d77f793026f88e2fb1a621b8abe6a5ab275165fd", "committedDate": "2020-02-14T19:26:07Z", "message": "fix unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb0a526b96cd0879f8996c405378dd42f7d56339", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb0a526b96cd0879f8996c405378dd42f7d56339", "committedDate": "2020-02-14T19:31:58Z", "message": "Merge branch 'master' of https://github.com/djptek/elasticsearch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77c866405a2056581bfc0ff62fbf7bedbb31e6d3", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/77c866405a2056581bfc0ff62fbf7bedbb31e6d3", "committedDate": "2020-02-14T19:46:02Z", "message": "fixed marge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3577ca2cbcc9a63d3b8137e6fae0d61a7f4137b2", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/3577ca2cbcc9a63d3b8137e6fae0d61a7f4137b2", "committedDate": "2020-02-14T20:46:53Z", "message": "fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb9f9a92ceb8bbe0253a49a88282f1a7431e40c", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/5bb9f9a92ceb8bbe0253a49a88282f1a7431e40c", "committedDate": "2020-02-14T20:56:12Z", "message": "fix docs reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0753166fd0935995107637b994b5f0eba9183cd4", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/0753166fd0935995107637b994b5f0eba9183cd4", "committedDate": "2020-02-14T21:29:34Z", "message": "fix unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/a81c7c195325da4c3d2d1ae7028034998ab071ff", "committedDate": "2020-02-15T10:53:18Z", "message": "fix failing test 1/2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDIwMTA4", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-359420108", "createdAt": "2020-02-16T18:17:46Z", "commit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxODoxNzo0N1rOFqUoFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxODoyMjoyMlrOFqUpbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjQ1Mg==", "bodyText": "I think this is wrong. GeoShapeIndexer works on geo_shape fields and CIRCLE is not a supported geometry for indexing.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922452", "createdAt": "2020-02-16T18:17:47Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/GeoShapeIndexer.java", "diffHunk": "@@ -79,7 +79,10 @@ public Geometry prepareForIndexing(Geometry geometry) {\n         return geometry.visit(new GeometryVisitor<>() {\n             @Override\n             public Geometry visit(Circle circle) {\n-                throw new UnsupportedOperationException(\"CIRCLE geometry is not supported\");\n+                double[] latlon = new double[]{circle.getX(), circle.getY()};\n+                normalizePoint(latlon);\n+                double radius = circle.getRadiusMeters();\n+                return new Circle(latlon[0], latlon[1], radius);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjU2Nw==", "bodyText": "We cannot hardcode those values. This method is called for geo_shape and shape queries, therefore we use queryFieldType() to get the underlaying fields. I think the solution here is to change the signature of queryFieldType() method to return an arrays of fields.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922567", "createdAt": "2020-02-16T18:19:31Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -197,9 +198,13 @@ protected GeoShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<G\n \n     @Override\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false &&\n+            fieldType.typeName().equals(GeoPointFieldMapper.CONTENT_TYPE) == false) {\n             throw new QueryShardException(context,\n-                \"Field [\" + fieldName + \"] is not of type [\" + queryFieldType() + \"] but of type [\" + fieldType.typeName() + \"]\");\n+                \"Field [\" + fieldName + \"] is of unsupported type [\" + fieldType.typeName() + \"]. [\"\n+                + NAME + \"] query supports the following types [\"\n+                + GeoShapeFieldMapper.CONTENT_TYPE + \", \"\n+                + GeoPointFieldMapper.CONTENT_TYPE + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjY5Nw==", "bodyText": "geo_shape queries over geo_shape fields do not support circle queries. It should be an error.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922697", "createdAt": "2020-02-16T18:20:48Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoShapeQueryProcessor.java", "diffHunk": "@@ -86,7 +87,9 @@ protected Query getVectorQueryFromShape(Geometry queryShape, String fieldName, S\n \n         @Override\n         public Query visit(Circle circle) {\n-            throw new QueryShardException(context, \"Field [\" + fieldName + \"] found and unknown shape Circle\");\n+            // use Point visitor", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjc1Nw==", "bodyText": "is it needed this change?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922757", "createdAt": "2020-02-16T18:21:32Z", "author": {"login": "iverase"}, "path": "docs/reference/query-dsl/geo-shape-query.asciidoc", "diffHunk": "@@ -31,7 +31,7 @@ PUT /example\n {\n     \"mappings\": {\n         \"properties\": {\n-            \"location\": {\n+            \"geo\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkyMjc5OQ==", "bodyText": "This looks wrong? why are we changing this?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r379922799", "createdAt": "2020-02-16T18:22:22Z", "author": {"login": "iverase"}, "path": "docs/reference/query-dsl/geo-shape-query.asciidoc", "diffHunk": "@@ -56,24 +56,17 @@ The following query will find the point using the Elasticsearch's\n --------------------------------------------------\n GET /example/_search\n {\n-    \"query\":{\n-        \"bool\": {\n-            \"must\": {\n-                \"match_all\": {}\n-            },\n-            \"filter\": {\n-                \"geo_shape\": {\n-                    \"location\": {\n-                        \"shape\": {\n-                            \"type\": \"envelope\",\n-                            \"coordinates\" : [[13.0, 53.0], [14.0, 52.0]]\n-                        },\n-                        \"relation\": \"within\"\n-                    }\n-                }\n-            }\n-        }\n+  \"query\": {\n+    \"geo_shape\": {\n+      \"geo\": {\n+        \"shape\": {\n+          \"type\": \"envelope\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a81c7c195325da4c3d2d1ae7028034998ab071ff"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d2f25bdd08588a7a7b67613b032610168d03d30", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d2f25bdd08588a7a7b67613b032610168d03d30", "committedDate": "2020-02-17T11:22:28Z", "message": "Update GeoShapeIndexer.java\n\nrollback Circle Visitor, this is not supported"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8fe901ae92e2a53ba34bb2cae992175cef2ab11c", "committedDate": "2020-02-17T13:34:31Z", "message": "removed CIRCLE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODA5Njg0", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-359809684", "createdAt": "2020-02-17T15:19:12Z", "commit": {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxOToxMlrOFqoBnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToxOToxMlrOFqoBnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MDI4NQ==", "bodyText": "+1", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380240285", "createdAt": "2020-02-17T15:19:12Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -169,12 +170,13 @@ public SpatialStrategy strategy() {\n \n     @Override\n     protected List validContentTypes() {\n-        return Arrays.asList(GeoShapeFieldMapper.CONTENT_TYPE);\n+        return Arrays.asList(GeoShapeFieldMapper.CONTENT_TYPE, GeoPointFieldMapper.CONTENT_TYPE);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5ODExNjEy", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-359811612", "createdAt": "2020-02-17T15:21:55Z", "commit": {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToyMTo1NVrOFqoHHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xN1QxNToyMTo1NVrOFqoHHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDI0MTY5NA==", "bodyText": "You cannot change the signature of the method and deprecate it. In any case I think this an internal API so we probably can just remove the method all together (I will check).", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r380241694", "createdAt": "2020-02-17T15:21:55Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/AbstractGeometryQueryBuilder.java", "diffHunk": "@@ -341,7 +341,8 @@ public boolean ignoreUnmapped() {\n     /** builds the appropriate lucene shape query */\n     protected abstract Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType);\n     /** returns expected content type for this query */\n-    protected abstract String queryFieldType();\n+    @Deprecated\n+    protected abstract List queryFieldType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8fe901ae92e2a53ba34bb2cae992175cef2ab11c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71617b58c2289639788e31a1f7e25618451b4a87", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/71617b58c2289639788e31a1f7e25618451b4a87", "committedDate": "2020-02-17T15:31:33Z", "message": "List validContentTypes() populated and tests updated"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3706e85e0f5c9af5c22a7fb9f80a82cd5ab3f0d6", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/3706e85e0f5c9af5c22a7fb9f80a82cd5ab3f0d6", "committedDate": "2020-02-17T15:48:58Z", "message": "removal of String queryFieldType()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0f943d1968fbcc2e3144f8da48de5c428a651e", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc0f943d1968fbcc2e3144f8da48de5c428a651e", "committedDate": "2020-02-17T15:59:16Z", "message": "fix testIgnoreUnmapped()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73ca89d2ae495abc0aa1df3011388e902ce68118", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/73ca89d2ae495abc0aa1df3011388e902ce68118", "committedDate": "2020-02-17T22:25:50Z", "message": "back out docs changes and synch xpack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1569db7dcb1a9ce7fdf67afd163295ad8fb2ecd", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1569db7dcb1a9ce7fdf67afd163295ad8fb2ecd", "committedDate": "2020-02-18T12:14:03Z", "message": "fix xpack compile issue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8094a4a2d200290d46bc8b6644df017f9600e562", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8094a4a2d200290d46bc8b6644df017f9600e562", "committedDate": "2020-02-19T10:57:33Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df876736951b2f2548d45a2277ba937a14b9d92b", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/df876736951b2f2548d45a2277ba937a14b9d92b", "committedDate": "2020-02-19T11:14:33Z", "message": "merge 30316d6d6409a359431d47094c497c482118a226"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22a6b2f275644fea15ed46b5cc9d517f47dfc7fb", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/22a6b2f275644fea15ed46b5cc9d517f47dfc7fb", "committedDate": "2020-02-19T13:32:09Z", "message": " remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "322290a72e7ac8f4cf6b3f4537f7638a4372aff6", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/322290a72e7ac8f4cf6b3f4537f7638a4372aff6", "committedDate": "2020-02-19T16:32:31Z", "message": "rollback geo-shape-query.asciidoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2789356ae320b7978efac38ac3bda793c461c37", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2789356ae320b7978efac38ac3bda793c461c37", "committedDate": "2020-02-19T16:41:35Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43be178ef3b4cf275c030bab3140ed7aab3f4e4b", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/43be178ef3b4cf275c030bab3140ed7aab3f4e4b", "committedDate": "2020-02-19T21:25:19Z", "message": "restore xpack...ShapeQueryBuilder.validContentTypes to shape"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d8ac102265476f9558876ed210e785f96b92046", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d8ac102265476f9558876ed210e785f96b92046", "committedDate": "2020-02-19T21:58:42Z", "message": "remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca122121ddadfeacc722f7aff7c77655d9544112", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca122121ddadfeacc722f7aff7c77655d9544112", "committedDate": "2020-02-19T22:07:08Z", "message": "restore missing import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f555309de00e37f1f9b93a765eb59d55fc160434", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/f555309de00e37f1f9b93a765eb59d55fc160434", "committedDate": "2020-02-20T07:52:45Z", "message": "include geo_point in geo-shape-query docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13afa49d20edaab2a411d1f47297b9eb8e6080eb", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/13afa49d20edaab2a411d1f47297b9eb8e6080eb", "committedDate": "2020-02-20T08:43:13Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTE5MTg1", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-361919185", "createdAt": "2020-02-20T13:57:19Z", "commit": {"oid": "13afa49d20edaab2a411d1f47297b9eb8e6080eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzo1NzoyMFrOFsUPmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzo1NzoyMFrOFsUPmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjAxMzMzOQ==", "bodyText": "We should not be using here the GeoShapeIndexer. Instead we should be calling the GeoPolygon decomposer in the visitor.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r382013339", "createdAt": "2020-02-20T13:57:20Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,167 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.geo.Polygon;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.GeoShapeIndexer;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        GeoShapeIndexer geometryIndexer = new GeoShapeIndexer(true, fieldName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13afa49d20edaab2a411d1f47297b9eb8e6080eb"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eaaaba83526487ff40733abc4619993799a9dffa", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/eaaaba83526487ff40733abc4619993799a9dffa", "committedDate": "2020-02-21T11:56:22Z", "message": "merge upstream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50550b4f098fd13b9768ce2f4edd38d72de29a15", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/50550b4f098fd13b9768ce2f4edd38d72de29a15", "committedDate": "2020-02-21T12:08:28Z", "message": "update tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eff1b6f5fb61774bfb3607d7ba5e3cebc52d24a5", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/eff1b6f5fb61774bfb3607d7ba5e3cebc52d24a5", "committedDate": "2020-02-21T12:09:26Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c68db61a5e7a158b0463f9d243e0e451af6872d", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c68db61a5e7a158b0463f9d243e0e451af6872d", "committedDate": "2020-02-26T16:46:50Z", "message": "remove the GeometryIndexer and call the Decomposers on the visitor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ce856b316468bf72a853ef807426690cc8bca5c", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ce856b316468bf72a853ef807426690cc8bca5c", "committedDate": "2020-02-26T17:37:16Z", "message": "fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b713a125e7b293bc5ad3dca3bcf7a084bd59801", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8b713a125e7b293bc5ad3dca3bcf7a084bd59801", "committedDate": "2020-02-26T18:54:19Z", "message": "added tests testPolygonSpanningDateline() testMultiPolygonSpanningDateline()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/83bdc937d79d09bbfb730a5a4ef5a8daadec23fc", "committedDate": "2020-02-26T20:34:07Z", "message": "added testRectangleSpanningDateline"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NDYwNjEy", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-365460612", "createdAt": "2020-02-27T07:28:14Z", "commit": {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNzoyODoxNFrOFvHlrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwNzoyODoxNFrOFvHlrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDk1MTcyNg==", "bodyText": "I think we should move this logic inside the visitor and decompose the polygons in the methods visit(MultiPolygon multiPolygon) and visit(Polygon polygon). Note that the query accepts an array and therefore the boolean query is not necessary.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r384951726", "createdAt": "2020-02-27T07:28:14Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,181 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoPolygonDecomposer;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Polygon;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import java.util.ArrayList;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        ShapeVisitor shapeVisitor = new ShapeVisitor(context, fieldName, relation);\n+        if (queryShape.type().equals(ShapeType.POLYGON)) {\n+            ArrayList<org.elasticsearch.geometry.Polygon> collector = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc"}, "originalPosition": 76}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NTczNDU3", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-365573457", "createdAt": "2020-02-27T10:35:09Z", "commit": {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMDozNTowOVrOFvNHbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxMDozNTowOVrOFvNHbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTA0MjI4Ng==", "bodyText": "For readability we prefer == false rather than !", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385042286", "createdAt": "2020-02-27T10:35:09Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/GeoShapeQueryBuilder.java", "diffHunk": "@@ -197,9 +193,11 @@ protected GeoShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<G\n \n     @Override\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(GeoShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (!validContentTypes().contains(fieldType.typeName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "83bdc937d79d09bbfb730a5a4ef5a8daadec23fc"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "798a16f9911f8e943d3a74dfa8af0164115a517c", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/798a16f9911f8e943d3a74dfa8af0164115a517c", "committedDate": "2020-02-27T16:14:02Z", "message": "change != to == false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc609787df1ce3eec2f9cece66220ccf813b631d", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc609787df1ce3eec2f9cece66220ccf813b631d", "committedDate": "2020-02-27T17:30:18Z", "message": "commented out Decompose, tests passing, hardened tests, still passing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Mjg5MDA2", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-366289006", "createdAt": "2020-02-28T10:14:36Z", "commit": {"oid": "fc609787df1ce3eec2f9cece66220ccf813b631d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDoxNDozNlrOFvv5zA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxMDoxNDozNlrOFvv5zA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTYxMjIzNg==", "bodyText": "== false", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r385612236", "createdAt": "2020-02-28T10:14:36Z", "author": {"login": "iverase"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/query/ShapeQueryBuilder.java", "diffHunk": "@@ -100,23 +100,19 @@ protected ShapeQueryBuilder newShapeQueryBuilder(String fieldName, Supplier<Geom\n         return new ShapeQueryBuilder(fieldName, shapeSupplier, indexedShapeId);\n     }\n \n-    @Override\n-    public String queryFieldType() {\n-        return ShapeFieldMapper.CONTENT_TYPE;\n-    }\n-\n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n-    protected List validContentTypes() {\n+    protected List<String> validContentTypes(){\n         return Arrays.asList(ShapeFieldMapper.CONTENT_TYPE);\n     }\n \n     @Override\n     @SuppressWarnings({ \"rawtypes\" })\n     public Query buildShapeQuery(QueryShardContext context, MappedFieldType fieldType) {\n-        if (fieldType.typeName().equals(ShapeFieldMapper.CONTENT_TYPE) == false) {\n+        if (!validContentTypes().contains(fieldType.typeName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc609787df1ce3eec2f9cece66220ccf813b631d"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "783276af7a1b034d45781589696579a9464ddf55", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/783276af7a1b034d45781589696579a9464ddf55", "committedDate": "2020-02-28T10:56:15Z", "message": "refactor tests, testMultiPolygonSpanningDateline() now failing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f084f7299800c791862a5031550b7b6dea4c0ca5", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/f084f7299800c791862a5031550b7b6dea4c0ca5", "committedDate": "2020-02-28T10:58:24Z", "message": "ShapeQueryBuilder change ! to == false"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb44b3b9ff02c93b57152a6c42c99631a22f0679", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb44b3b9ff02c93b57152a6c42c99631a22f0679", "committedDate": "2020-02-28T12:25:30Z", "message": "tests still failing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57faaed2d21e5f23e9b8cef14a571e95398270be", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/57faaed2d21e5f23e9b8cef14a571e95398270be", "committedDate": "2020-02-28T18:41:07Z", "message": "working, pending refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b9a33e3999a7085843fede5aa79c5d534d39479", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b9a33e3999a7085843fede5aa79c5d534d39479", "committedDate": "2020-02-28T19:03:23Z", "message": "fixed imports etc."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99be3be2542c19bbcdcf8c35552e379a28c35bc0", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/99be3be2542c19bbcdcf8c35552e379a28c35bc0", "committedDate": "2020-02-29T08:11:16Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b98a6a9d300613cdcb184ac6be1d2eca488b24be", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/b98a6a9d300613cdcb184ac6be1d2eca488b24be", "committedDate": "2020-02-29T08:13:06Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2Nzg3NDEw", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-366787410", "createdAt": "2020-02-29T09:09:50Z", "commit": {"oid": "b98a6a9d300613cdcb184ac6be1d2eca488b24be"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwOTowOTo1MFrOFwIciw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOVQwOTowOTo1MFrOFwIciw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjAxNDM0Nw==", "bodyText": "The second loop is not necessary. You can just create one collector and pass the same array to the decomposer.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386014347", "createdAt": "2020-02-29T09:09:50Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoPointShapeQueryProcessor.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.query;\n+\n+import org.apache.lucene.document.LatLonPoint;\n+import org.apache.lucene.search.BooleanClause;\n+import org.apache.lucene.search.BooleanQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoPolygonDecomposer;\n+import org.elasticsearch.common.geo.GeoShapeType;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.geometry.ShapeType;\n+import org.elasticsearch.index.mapper.AbstractGeometryFieldMapper;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+\n+import java.util.ArrayList;\n+\n+import static org.elasticsearch.index.mapper.GeoShapeIndexer.toLucenePolygon;\n+\n+public class VectorGeoPointShapeQueryProcessor implements AbstractGeometryFieldMapper.QueryProcessor {\n+\n+    @Override\n+    public Query process(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        validateIsGeoPointFieldType(fieldName, context);\n+        // geo points only support intersects\n+        if (relation != ShapeRelation.INTERSECTS) {\n+            throw new QueryShardException(context,\n+                relation+ \" query relation not supported for Field [\" + fieldName + \"].\");\n+        }\n+        // wrap geoQuery as a ConstantScoreQuery\n+        return getVectorQueryFromShape(shape, fieldName, relation, context);\n+    }\n+\n+    private void validateIsGeoPointFieldType(String fieldName, QueryShardContext context) {\n+        MappedFieldType fieldType = context.fieldMapper(fieldName);\n+        if (fieldType instanceof GeoPointFieldMapper.GeoPointFieldType == false) {\n+            throw new QueryShardException(context, \"Expected \" + GeoPointFieldMapper.CONTENT_TYPE\n+                + \" field type for Field [\" + fieldName + \"] but found \" + fieldType.typeName());\n+        }\n+    }\n+\n+    protected Query getVectorQueryFromShape(\n+        Geometry queryShape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        ShapeVisitor shapeVisitor = new ShapeVisitor(context, fieldName, relation);\n+        return queryShape.visit(shapeVisitor);\n+    }\n+\n+    private class ShapeVisitor implements GeometryVisitor<Query, RuntimeException> {\n+        QueryShardContext context;\n+        MappedFieldType fieldType;\n+        String fieldName;\n+        ShapeRelation relation;\n+\n+        ShapeVisitor(QueryShardContext context, String fieldName, ShapeRelation relation) {\n+            this.context = context;\n+            this.fieldType = context.fieldMapper(fieldName);\n+            this.fieldName = fieldName;\n+            this.relation = relation;\n+        }\n+\n+        @Override\n+        public Query visit(Circle circle) {\n+            return LatLonPoint.newDistanceQuery(fieldName, circle.getLat(), circle.getLon(), circle.getRadiusMeters());\n+        }\n+\n+        @Override\n+        public Query visit(GeometryCollection<?> collection) {\n+            BooleanQuery.Builder bqb = new BooleanQuery.Builder();\n+            visit(bqb, collection);\n+            return bqb.build();\n+        }\n+\n+        private void visit(BooleanQuery.Builder bqb, GeometryCollection<?> collection) {\n+            BooleanClause.Occur occur = BooleanClause.Occur.FILTER;\n+            for (Geometry shape : collection) {\n+                bqb.add(shape.visit(this), occur);\n+            }\n+        }\n+\n+        @Override\n+        public Query visit(org.elasticsearch.geometry.Line line) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.LINESTRING + \" queries\");\n+        }\n+\n+        @Override\n+        // don't think this is called directly\n+        public Query visit(LinearRing ring) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + ShapeType.LINEARRING + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiLine multiLine) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.MULTILINESTRING + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiPoint multiPoint) {\n+            throw new QueryShardException(context, \"Field [\" + fieldName + \"] does not support \"\n+                + GeoShapeType.MULTIPOINT + \" queries\");\n+        }\n+\n+        @Override\n+        public Query visit(MultiPolygon multiPolygon) {\n+            ArrayList<org.apache.lucene.geo.Polygon> polygonArrayList = new ArrayList<>();\n+            for (int i = 0; i < multiPolygon.size(); i++) {\n+                ArrayList<org.elasticsearch.geometry.Polygon> collector = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b98a6a9d300613cdcb184ac6be1d2eca488b24be"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0000365ba6206d359334a7e70e8e49adfceb6f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed0000365ba6206d359334a7e70e8e49adfceb6f", "committedDate": "2020-02-29T09:43:17Z", "message": "use single collector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "830635f97d1da476952eef96d3ff12809912d8e3", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/830635f97d1da476952eef96d3ff12809912d8e3", "committedDate": "2020-02-29T09:49:54Z", "message": "use single collector"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "024175390fb0ca1a87c2bf271f94f1e9c4ca4366", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/024175390fb0ca1a87c2bf271f94f1e9c4ca4366", "committedDate": "2020-02-29T22:36:32Z", "message": "use GeoPolygonDecomposer.decomposeMultiPolygon"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MDM0MDcy", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-367034072", "createdAt": "2020-03-02T09:00:21Z", "commit": {"oid": "024175390fb0ca1a87c2bf271f94f1e9c4ca4366"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwOTowMDoyMlrOFwXunA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwOTowMDoyMlrOFwXunA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI2NDczMg==", "bodyText": "left over from merging?", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r386264732", "createdAt": "2020-03-02T09:00:22Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/query/VectorGeoShapeQueryProcessor.java", "diffHunk": "@@ -1,4 +1,4 @@\n-/*\n+/*uto-merging server/src/main/java/org/elasticsearch/index/mapper/GeoPointFieldMapper.java", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "024175390fb0ca1a87c2bf271f94f1e9c4ca4366"}, "originalPosition": 2}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5807864a3a3e61f0aff8e9d3f18ece5c431a73e1", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/5807864a3a3e61f0aff8e9d3f18ece5c431a73e1", "committedDate": "2020-03-02T11:44:40Z", "message": "add GeoQueryTests.testIndexPointsIndexedRectangle()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ed8bfe372a5883718ff7e62a80408ba3c6103d2", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ed8bfe372a5883718ff7e62a80408ba3c6103d2", "committedDate": "2020-03-02T14:59:55Z", "message": "clean stray comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9391222d01b39221416210e52053ddc557971ead", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/9391222d01b39221416210e52053ddc557971ead", "committedDate": "2020-03-02T17:49:30Z", "message": "add docValues optimisation to visit(MultiPolygon multiPolygon) and visit(Polygon polygon)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21dcc843880c49081d4620856309c0dca4be76d", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e21dcc843880c49081d4620856309c0dca4be76d", "committedDate": "2020-03-02T17:55:30Z", "message": "clarify imports to distinguish Polygon vs Lucene Polygon"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27f4101d159083b73bf5019b5acfa4fb2e7e988f", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/27f4101d159083b73bf5019b5acfa4fb2e7e988f", "committedDate": "2020-03-02T18:43:46Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6dfbc18a41d8e106e0be1ec2b755e13333a0f925", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/6dfbc18a41d8e106e0be1ec2b755e13333a0f925", "committedDate": "2020-03-02T18:46:48Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0932589aa82894821785ef0b3833efad63b24027", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/0932589aa82894821785ef0b3833efad63b24027", "committedDate": "2020-03-02T20:51:02Z", "message": "added dvQuery to visit(Rectangle) visit(Circle)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "291115644665a718ea0011979c9bd7f180de0893", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/291115644665a718ea0011979c9bd7f180de0893", "committedDate": "2020-03-02T21:28:22Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "110f58fa5c5be62e0a99c57eb6bf9dc0c441f963", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/110f58fa5c5be62e0a99c57eb6bf9dc0c441f963", "committedDate": "2020-03-02T21:29:20Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjA3MDg0", "url": "https://github.com/elastic/elasticsearch/pull/52382#pullrequestreview-368207084", "createdAt": "2020-03-03T18:09:29Z", "commit": {"oid": "110f58fa5c5be62e0a99c57eb6bf9dc0c441f963"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODowOToyOVrOFxQ1ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxODowOToyOVrOFxQ1ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzIwMDM5NA==", "bodyText": "That feels a bit awkward. I think that should go into  AbstractGeometryFieldMapper.AbstractGeometryFieldType if we need to clone it. I think the reason it is not cloned there already is that we override it always in setupFileds anyway. But cloning it in AbstractGeometryFieldType seems like a logical thing to do here.", "url": "https://github.com/elastic/elasticsearch/pull/52382#discussion_r387200394", "createdAt": "2020-03-03T18:09:29Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/GeoPointFieldMapper.java", "diffHunk": "@@ -213,12 +216,13 @@ protected void parseCreateField(ParseContext context, List<IndexableField> field\n         throw new UnsupportedOperationException(\"Parsing is implemented in parse(), this method should NEVER be called\");\n     }\n \n-    public static class GeoPointFieldType extends MappedFieldType {\n+    public static class GeoPointFieldType extends AbstractGeometryFieldMapper.AbstractGeometryFieldType<Geometry, Geometry> {\n         public GeoPointFieldType() {\n         }\n \n         GeoPointFieldType(GeoPointFieldType ref) {\n             super(ref);\n+            this.geometryQueryBuilder  = ref.geometryQueryBuilder;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "110f58fa5c5be62e0a99c57eb6bf9dc0c441f963"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ddb6e940c21a5be4ce17dedefed9827c782562a", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ddb6e940c21a5be4ce17dedefed9827c782562a", "committedDate": "2020-03-09T17:54:50Z", "message": "refactor to add GeoShapeQueryBuilder tests specific to geo_shape, geo_point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab708cff915dab10d6ee80efae3e757736363a22", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab708cff915dab10d6ee80efae3e757736363a22", "committedDate": "2020-03-09T20:14:50Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0803f8749edb1102a4180865170cb1946172ddb8", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/0803f8749edb1102a4180865170cb1946172ddb8", "committedDate": "2020-03-09T21:18:11Z", "message": "WIP refactor GeoShapeQueryBuilderTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d64b9dda5b9641309e6f95e968345e563e84ca67", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/d64b9dda5b9641309e6f95e968345e563e84ca67", "committedDate": "2020-03-10T17:50:15Z", "message": "added test overrides in GeoShapeQueryBuilderGeoPointTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "253c3223d2372b09bd55e8d1a55de8d1bca73d18", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/253c3223d2372b09bd55e8d1a55de8d1bca73d18", "committedDate": "2020-03-10T18:32:38Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e25dc29398021dfdbcac20fdecb3c8477dfff72b", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/e25dc29398021dfdbcac20fdecb3c8477dfff72b", "committedDate": "2020-03-10T18:33:18Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f755dbe762ac28cdc7740bd70061d5da071ff5", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/06f755dbe762ac28cdc7740bd70061d5da071ff5", "committedDate": "2020-03-11T11:24:11Z", "message": "Merge remote-tracking branch 'upstream/master'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f88c8dfc676b68285feaaffeb6a7775663afffe6", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/f88c8dfc676b68285feaaffeb6a7775663afffe6", "committedDate": "2020-03-11T11:24:32Z", "message": "Merge branch 'master' into geo-shape-query-vs-geo-point"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cebf279027aba1eaf9f8db63212fbbee5e3275ad", "author": {"user": {"login": "djptek", "name": "Dominic Page"}}, "url": "https://github.com/elastic/elasticsearch/commit/cebf279027aba1eaf9f8db63212fbbee5e3275ad", "committedDate": "2020-03-11T12:05:10Z", "message": "override doCreateTestQueryBuilder() in GeoShapeQueryBuilderTests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2312, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}