{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTYyNDYz", "number": 65606, "title": "Add search runtime_mappings to datafeed configuration", "bodyText": "This change adds runtime fields in search to the datafeed.\nThe DatafeedConfig has an optional section to defined search runtime fields\n            \"runtime_mappings\" : {\n                \"rt_field_1\": {\n                    \"type\": \"double\",\n                    \"script\": \"emit(doc['some_field'].value * 100.0)\"\n                },\n                \"rt_field_2\": {\n                    \"type\": \"double\",\n                    \"script\": \"emit(doc['another_field'].value)\"\n                },\n\nThe actual configuration is just a loose Map<String, Object> as this is what SearchSourceBuilder uses. There is some validation on PUT that the map contents resemble a runtime_mappings configuration.\nDatafeed preview and running a datafeed are not exactly the same. The checks in DatafeedJobValidator are not run in preview which means the check that the time field is not an RT field will not happen. We should discuss changing preview to exactly match the behaviour or running a datafeed.\nThere are some design decisions that the reviewer should know about:\n\nConfigurations of jobs/datafeeds that use runtime_mappings to create the job time field will be rejected.\nRT fields do no work with v1 Rollup searches. If the datafeed is querying a rollup index it will not start if RT fields are used.\nRT fields in Cross Cluster Search require the remote cluster to be v7.11 or above. The datafeed will start and the search will fail in this case. It is not possible to check prior to starting the datafeed.\n\nHLRC to follow, this change is big enough.", "createdAt": "2020-11-30T13:49:11Z", "url": "https://github.com/elastic/elasticsearch/pull/65606", "merged": true, "mergeCommit": {"oid": "ab08631c09e9608683744ce11f6648bfafc42694"}, "closed": true, "closedAt": "2020-12-02T15:20:54Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdht74MABqjQwNTQ0MDM5OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiK19dgFqTU0MjYyNjI3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0330176192b6f07f7f22cdf11c90bf448db3489f", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/0330176192b6f07f7f22cdf11c90bf448db3489f", "committedDate": "2020-11-30T23:17:16Z", "message": "Preview datafeed aggs test"}, "afterCommit": {"oid": "2f982bd16092ff3e8e92778a5f917e30ecc5cfd5", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f982bd16092ff3e8e92778a5f917e30ecc5cfd5", "committedDate": "2020-11-30T23:27:25Z", "message": "Revert \"Add test for datafeed aggs\"\n\nThis reverts commit 9233485160f416a15187941f19912c7e58f2a105."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODEyNDUz", "url": "https://github.com/elastic/elasticsearch/pull/65606#pullrequestreview-541812453", "createdAt": "2020-12-01T11:39:18Z", "commit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTozOToxOFrOH8ou_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMTo0ODoxNFrOH8pBmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0Mzk5Ng==", "bodyText": "It might be better to say object instead of map in this error message, as the user reading the message is thinking of the JSON structure rather than the Java structure.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533343996", "createdAt": "2020-12-01T11:39:18Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfig.java", "diffHunk": "@@ -824,6 +853,28 @@ void validateScriptFields() {\n             }\n         }\n \n+        /**\n+         * Perform a light check that the structure resembles runtime_mappings.\n+         * The full check cannot happen until search\n+         */\n+        void validateRuntimeMappings() {\n+            for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {\n+                // top level objects are fields\n+                String fieldName = entry.getKey();\n+                if (entry.getValue() instanceof Map) {\n+                    @SuppressWarnings(\"unchecked\")\n+                    Map<String, Object> propNode = new HashMap<>(((Map<String, Object>) entry.getValue()));\n+                    Object typeNode = propNode.get(\"type\");\n+                    if (typeNode == null) {\n+                        throw ExceptionsHelper.badRequestException(\"No type specified for runtime field [\" + fieldName + \"]\");\n+                    }\n+                } else {\n+                    throw ExceptionsHelper.badRequestException(\"Expected map for runtime field [\" + fieldName + \"] \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 180}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTIzMw==", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345233", "createdAt": "2020-12-01T11:41:37Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -38,6 +40,8 @@ public static void validate(DatafeedConfig datafeedConfig, Job job, NamedXConten\n         if (delayedDataCheckConfig.isEnabled()) {\n             checkValidDelayedDataCheckConfig(bucketSpan, delayedDataCheckConfig);\n         }\n+\n+        checkTimeFieldIsNotARuntimeField(datafeedConfig, job.getDataDescription().getTimeField());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NTM0OA==", "bodyText": "I think there should be a comment to say this is only checking search-time runtime fields.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533345348", "createdAt": "2020-12-01T11:41:48Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedJobValidator.java", "diffHunk": "@@ -97,4 +101,16 @@ private static void checkFrequencyIsMultipleOfHistogramInterval(DatafeedConfig d\n             }\n         }\n     }\n+\n+    private static void checkTimeFieldIsNotARuntimeField(DatafeedConfig datafeedConfig, String timeField) {\n+        Map<String, Object> runtimeMappings = datafeedConfig.getRuntimeMappings();\n+        for (Map.Entry<String, Object> entry : runtimeMappings.entrySet()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0NzIwOQ==", "bodyText": "SearchSourceBuilder.RUNTIME_MAPPINGS_FIELD.getPreferredName()?", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533347209", "createdAt": "2020-12-01T11:45:16Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/job/persistence/ElasticsearchMappingsTests.java", "diffHunk": "@@ -75,7 +75,8 @@\n             ElasticsearchMappings.NESTED,\n             ElasticsearchMappings.PROPERTIES,\n             ElasticsearchMappings.TYPE,\n-            ElasticsearchMappings.WHITESPACE\n+            ElasticsearchMappings.WHITESPACE,\n+            \"runtime_mappings\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM0ODc2MQ==", "bodyText": "This shouldn't be necessary.  I thought we ignored the time format in the data description when using a datafeed.  If deleting this line makes the test fail then something unexpected is happening somewhere.", "url": "https://github.com/elastic/elasticsearch/pull/65606#discussion_r533348761", "createdAt": "2020-12-01T11:48:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsIT.java", "diffHunk": "@@ -145,6 +152,68 @@ public void testLookbackOnlyDataStream() throws Exception {\n         waitUntilJobIsClosed(job.getId());\n     }\n \n+    public void testLookbackOnlyRuntimeMapping() throws Exception {\n+        client().admin().indices().prepareCreate(\"data-1\")\n+            .setMapping(\"time\", \"type=date\")\n+            .get();\n+        long numDocs = randomIntBetween(32, 2048);\n+        long now = System.currentTimeMillis();\n+        long oneWeekAgo = now - 604800000;\n+        long twoWeeksAgo = oneWeekAgo - 604800000;\n+        indexDocs(logger, \"data-1\", numDocs, twoWeeksAgo, oneWeekAgo);\n+\n+        DataDescription.Builder dataDescription = new DataDescription.Builder();\n+        dataDescription.setTimeFormat(\"yyyy-MM-dd HH:mm:ss\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b98567d6a8b25087445b74a8b09fab7d127a185e", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/b98567d6a8b25087445b74a8b09fab7d127a185e", "committedDate": "2020-12-01T13:49:25Z", "message": "Add runtime mappings to datafeed and extractors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fa77f888071408926ab49437016d8dc89a044a5", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9fa77f888071408926ab49437016d8dc89a044a5", "committedDate": "2020-12-01T13:49:25Z", "message": "Rollup search does not work with RT fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b879180edf8afdd3e72d66f029041735bfaf983", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b879180edf8afdd3e72d66f029041735bfaf983", "committedDate": "2020-12-01T13:49:25Z", "message": "Testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a29ff35fd9a2c6173c6cc7472b1494873e6df6d8", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/a29ff35fd9a2c6173c6cc7472b1494873e6df6d8", "committedDate": "2020-12-01T13:49:25Z", "message": "don't request RT fields in field caps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fd4b666441b5961180ba07b5b3073d030e21a45", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fd4b666441b5961180ba07b5b3073d030e21a45", "committedDate": "2020-12-01T13:49:25Z", "message": "Testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a72baf9ec95c88adb7bafea8139109e5655a77e9", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/a72baf9ec95c88adb7bafea8139109e5655a77e9", "committedDate": "2020-12-01T13:49:25Z", "message": "Tidy up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7c8cf7616b30d93529065d6be21956da0b6b816", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7c8cf7616b30d93529065d6be21956da0b6b816", "committedDate": "2020-12-01T13:49:25Z", "message": "Add test for datafeed aggs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed78e23a9dfcf9f863cfe23ade0b88cac7e0c801", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed78e23a9dfcf9f863cfe23ade0b88cac7e0c801", "committedDate": "2020-12-01T13:49:25Z", "message": "Preview datafeed aggs test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fda46c5603f0e180789766de7bbe650ff327d306", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/fda46c5603f0e180789766de7bbe650ff327d306", "committedDate": "2020-12-01T13:49:25Z", "message": "Revert \"Add test for datafeed aggs\"\n\nThis reverts commit 9233485160f416a15187941f19912c7e58f2a105."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98f65ac4645231be714cd57ead050416126d5c9f", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/98f65ac4645231be714cd57ead050416126d5c9f", "committedDate": "2020-12-01T13:49:25Z", "message": "Fix up the yaml test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "committedDate": "2020-12-01T13:49:25Z", "message": "Nits"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9333c1a56751a98b06f9d1a837b8a503a2f8cf9b", "committedDate": "2020-11-30T23:37:05Z", "message": "Fix up the yaml test"}, "afterCommit": {"oid": "9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998", "committedDate": "2020-12-01T13:49:25Z", "message": "Nits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjI2Mjc4", "url": "https://github.com/elastic/elasticsearch/pull/65606#pullrequestreview-542626278", "createdAt": "2020-12-02T09:08:39Z", "commit": {"oid": "9f401278aa9f0b7d7f0cabbb5f7a3855a37b2998"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4375, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}