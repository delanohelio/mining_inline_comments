{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5Mjk1NDcw", "number": 64948, "reviewThreads": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODoyNToxM1rOE55saw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOTozMDowN1rOFAtWpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTQ5NTQ3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODoyNToxM1rOH0pWqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODoyNToxM1rOH0pWqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk2NTU0Nw==", "bodyText": "s/avILble/available. Nit: also change the description of the Status class above to add the expiration date", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524965547", "createdAt": "2020-11-17T08:25:13Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -400,9 +404,13 @@ private static boolean isBasic(OperationMode mode) {\n         /** True if the license is active, or false if it is expired. */\n         final boolean active;\n \n-        Status(OperationMode mode, boolean active) {\n+        /** The current expiration date of the license; Long.MAX_VALUE if not avILble yet. */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTUzMzY4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODozNDo1OVrOH0ptZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODozNDo1OVrOH0ptZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MTM2NA==", "bodyText": "I think we'd need to access this by calling checkAgainstStatus instead of accessing the licenseExpiryDate  field directly", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524971364", "createdAt": "2020-11-17T08:34:59Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 75}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTUzODM5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODozNjoxNFrOH0pwQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODozNjoxNFrOH0pwQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MjA5Nw==", "bodyText": "nit: if (feature....", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524972097", "createdAt": "2020-11-17T08:36:14Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5MTU0Nzk4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwODozODo0NVrOH0p2MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xN1QwOToxNjo0NFrOH0rU9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg==", "bodyText": "I'm not sure about the wording here but I'll defer to a native speaker and maybe get Fabio's input too?\nMaybe s/update/renew ?  and s/for continued use of/in order to continue using the licensed ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524973616", "createdAt": "2020-11-17T08:38:45Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +\n+                    \"Contact your administrator or update your license for continued use of features\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5NzM3MA==", "bodyText": "This is the wording Kibana has. I talked to Fabio and he suggested us to be consistant with wording when possible.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524997370", "createdAt": "2020-11-17T09:15:58Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +\n+                    \"Contact your administrator or update your license for continued use of features\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg=="}, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk5Nzg3Ng==", "bodyText": "SGTM then!", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r524997876", "createdAt": "2020-11-17T09:16:44Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,18 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if(feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0\n+            && now > status.licenseExpiryDate - GRACE_PERIOD_DURATION.getMillis()) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +\n+                    \"Contact your administrator or update your license for continued use of features\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNDk3MzYxNg=="}, "originalCommit": {"oid": "10029990758325d0400f7b2abc5a2607e4a99dbf"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Nzg4Mzc5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDo1Njo1NFrOH1oLlg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOVQxOToxMDowOFrOH2tlIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg==", "bodyText": "If we're in the grace period, shouldn't this say has expired ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r525994902", "createdAt": "2020-11-18T10:56:54Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMDA4OA==", "bodyText": "I'll double-check with Fabio. This is the only message Kibana has and the idea was to be consistent when possible.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526000088", "createdAt": "2020-11-18T11:05:07Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjA4MDY5NQ==", "bodyText": "I don't think we have a grace period anymore. AFAIK we have warnings before the expiration date, and no service after that. Could you please double check what isLicenseExpiring() assumes?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526080695", "createdAt": "2020-11-18T13:18:44Z", "author": {"login": "bytebilly"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjU4MDI1OA==", "bodyText": "We still have a grace period. We may not in the future, but we do now.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526580258", "createdAt": "2020-11-19T04:03:04Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjY2MTYxNQ==", "bodyText": "(sorry I cannot find the description of the full approach, so it may be already this)\nWhat about having two separate checks with two separate messages?\n\n7 days before expiration \u2014\u00a0expiration: \"will expire in N days\"\nexpiration \u2014\u00a0end of grace period: \"has expired N days ago\"", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526661615", "createdAt": "2020-11-19T08:03:31Z", "author": {"login": "bytebilly"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMDMyNw==", "bodyText": "I changed the behaviour to have 3 different messages:\n\n7 days before expiration \u2014 expiration: \"will expire in N days\"\n<1 days before expiration: \"expires today\"\n\n\nexpiration: \"has expired N days ago\"\n\n\n\nIf grace period is over this code should be irrelevant as the license is not active.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527130327", "createdAt": "2020-11-19T19:07:22Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzEzMTkzNg==", "bodyText": "Also, addad a test", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527131936", "createdAt": "2020-11-19T19:10:08Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -508,9 +517,17 @@ public boolean isActive() {\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            HeaderWarning.addWarning(\"Your license will expire in [{}] days. \" +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NDkwMg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI5Nzg4NjYxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMDo1NzozNVrOH1oNSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xOFQxMTowNjowNVrOH1oiYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NTMzNg==", "bodyText": "Why is this dependent on the GRACE_PERIOD ? It seems to be a co-incidence that they're both 7days, but they shouldn't be tied to one another.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r525995336", "createdAt": "2020-11-18T10:57:35Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -627,6 +644,22 @@ public boolean isAllowedByLicense(OperationMode minimumMode, boolean needActive)\n         });\n     }\n \n+    /**\n+     * Test whether current license expires in less than {@code GRACE_PERIOD_DURATION}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNjAwMDczOQ==", "bodyText": "Good point, I'll add new const", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r526000739", "createdAt": "2020-11-18T11:06:05Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -627,6 +644,22 @@ public boolean isAllowedByLicense(OperationMode minimumMode, boolean needActive)\n         });\n     }\n \n+    /**\n+     * Test whether current license expires in less than {@code GRACE_PERIOD_DURATION}.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNTk5NTMzNg=="}, "originalCommit": {"oid": "ffcd72bed08f16f5d9603a0cb2e9885955a86a95"}, "originalPosition": 97}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODAxMTg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxMjoyNVrOH3JZgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoxMjoyNVrOH3JZgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU4NzcxMw==", "bodyText": "Given what this does, would it make sense to name it shouldWarnAboutLicense() ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527587713", "createdAt": "2020-11-20T10:12:25Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -627,6 +650,22 @@ public boolean isAllowedByLicense(OperationMode minimumMode, boolean needActive)\n         });\n     }\n \n+    /**\n+     * Test whether current license expires in less than {@code LICENSE_EXPIRATION_WARNING_PERIOD}.\n+     *\n+     * @param now  Current time in milliseconds\n+     *\n+     * @return true if current license expires in less than {@code LICENSE_EXPIRATION_WARNING_PERIOD}, otherwise false\n+     */\n+    public boolean isLicenseExpiring(long now) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e"}, "originalPosition": 116}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODA2Njk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDoyNjo0NFrOH3J6Uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxOToyODo0NFrOH4cPWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NjExNQ==", "bodyText": "Do we have to do the double update dance here? setLicensingExpirationDate is the only thing that calls update with anything other than Long.MAX_VALUE, what cluster state could trigger the license state (Expiration date) to change ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527596115", "createdAt": "2020-11-20T10:26:44Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -235,8 +293,42 @@ private void enableLicensing(License.OperationMode operationMode) throws Excepti\n             // re-apply the update in case any node received an updated cluster state that triggered the license state\n             // to change\n             for (XPackLicenseState licenseState : internalCluster().getInstances(XPackLicenseState.class)) {\n-                licenseState.update(operationMode, true, null);\n+                licenseState.update(operationMode, true, Long.MAX_VALUE, null);\n             }\n         }, 30L, TimeUnit.SECONDS);\n     }\n+\n+    private void setLicensingExpirationDate(License.OperationMode operationMode, long expirationDate) throws Exception {\n+        // do this in an await busy since there is a chance that the setting expiration date of the license is\n+        // overwritten by some other cluster activity and the node throws an exception while we\n+        // wait for things to stabilize!\n+        assertBusy(() -> {\n+            // first update the license so we can execute monitoring actions", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODk0NDk4Nw==", "bodyText": "Probably, not. Removed the second update, left hte assertBusy though.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r528944987", "createdAt": "2020-11-23T19:28:44Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -235,8 +293,42 @@ private void enableLicensing(License.OperationMode operationMode) throws Excepti\n             // re-apply the update in case any node received an updated cluster state that triggered the license state\n             // to change\n             for (XPackLicenseState licenseState : internalCluster().getInstances(XPackLicenseState.class)) {\n-                licenseState.update(operationMode, true, null);\n+                licenseState.update(operationMode, true, Long.MAX_VALUE, null);\n             }\n         }, 30L, TimeUnit.SECONDS);\n     }\n+\n+    private void setLicensingExpirationDate(License.OperationMode operationMode, long expirationDate) throws Exception {\n+        // do this in an await busy since there is a chance that the setting expiration date of the license is\n+        // overwritten by some other cluster activity and the node throws an exception while we\n+        // wait for things to stabilize!\n+        assertBusy(() -> {\n+            // first update the license so we can execute monitoring actions", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzU5NjExNQ=="}, "originalCommit": {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e"}, "originalPosition": 127}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODEzNTUzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDo0NDowNlrOH3KicQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDo0NDowNlrOH3KicQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwNjM4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        final String expiryMessage = days == 0? \"expires today\":\n          \n          \n            \n                        final String expiryMessage = days == 0 ? \"expires today\" :", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527606385", "createdAt": "2020-11-20T10:44:06Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -505,12 +516,24 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(status.licenseExpiryDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMwODEzNzk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDo0NDo0OFrOH3Kj9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQxMDo0NDo0OFrOH3Kj9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzYwNjc3Mw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n          \n          \n            \n                            (days > 0 ? String.format(Locale.ROOT, \"will expire in [%d] days\", days):", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r527606773", "createdAt": "2020-11-20T10:44:48Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -505,12 +516,24 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 && isLicenseExpiring(now)) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(status.licenseExpiryDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "34efa0e099fa6d7f7dc174aeadb1c2dbe992a94e"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzMzMDAyOTU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMDozNzozOFrOH6Vjzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxMTozNToyOFrOH6XplQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzMjY4Ng==", "bodyText": "Not necessary?  This method doesn't appear to use Math.abs().", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r530932686", "createdAt": "2020-11-26T10:37:38Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +513,15 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ed1cb2741104d21cdb6458403a9a672ad26b65a"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDk2NjkzMw==", "bodyText": "Leftover from the previous iteration, but will come back handy with the next one )", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r530966933", "createdAt": "2020-11-26T11:35:28Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +513,15 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDkzMjY4Ng=="}, "originalCommit": {"oid": "1ed1cb2741104d21cdb6458403a9a672ad26b65a"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NDU5NTY5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNjoxNzoxMVrOH8ZncQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMDo0NlrOH896dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjMwNQ==", "bodyText": "For expired licenses, I think it's preferable to just print out the date that is expired, rather than calculate how lonh ago that was.\nThat's what the log warning does and it seems neater for this case.\n\nLICENSE [EXPIRED] ON [SUNDAY, NOVEMBER 29, 2020]\n\nThe number of days makes sense for \"will expire\" because it creates a sense of urgency, but once it's expired I think the date is a better option.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533096305", "createdAt": "2020-12-01T06:17:11Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MDk5Nw==", "bodyText": "Changed the wording to \"license expired on [EEEE, MMMM DD, YYYY]\". For the sace of keeping the headers relatively short kept the rest of the message the same.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533690997", "createdAt": "2020-12-01T20:10:46Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5NjMwNQ=="}, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NDYwODI4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNjoyMzowMlrOH8ZupQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMTowNVrOH897Hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODE0OQ==", "bodyText": "I think we should be doing the first round of calculations in millis, not in days otherwise we potentially says \"expires today\" after the expiry date (because it's less than 1 day expired)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n          \n          \n            \n                        now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n          \n          \n            \n                        final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n          \n          \n            \n                        final String expiryMessage = days == 0? \"expires today\":\n          \n          \n            \n                            (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n          \n          \n            \n                                String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));\n          \n          \n            \n                \n          \n          \n            \n                    if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0) {\n          \n          \n            \n                        final long expiryMillis = licenseExpirationDate - now;        \n          \n          \n            \n                        if (expiryMillis < LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n          \n          \n            \n                            final String expiryMessage;\n          \n          \n            \n                            if (expiryMillis <= 0) {\n          \n          \n            \n                                expiryMessage = \"expired on [\" + DATE_FORMATTER.formatMillis(expirationMillis) + \"]\";\n          \n          \n            \n                            } else {\n          \n          \n            \n                                final long days = TimeUnit.MILLISECONDS.toDays(expiryMillis);\n          \n          \n            \n                                expiryMessage = days == 0 ? \"expires today\": \n          \n          \n            \n                                   String.format(Locale.ROOT, \"will expire in [%d] days\", days);\n          \n          \n            \n                            }", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533098149", "createdAt": "2020-12-01T06:23:02Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 99}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTE2Ng==", "bodyText": "Done", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533691166", "createdAt": "2020-12-01T20:11:05Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -507,12 +518,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        long now = System.currentTimeMillis();\n+        long licenseExpirationDate = getLicenseExpiryDate();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            now >  licenseExpirationDate - LICENSE_EXPIRATION_WARNING_PERIOD.getMillis()) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(licenseExpirationDate - now);\n+            final String expiryMessage = days == 0? \"expires today\":\n+                (days > 0? String.format(Locale.ROOT, \"will expire in [%d] days\", days):\n+                    String.format(Locale.ROOT, \"has expired [%d] days ago\", Math.abs(days)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODE0OQ=="}, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 99}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM0NDYxMzkyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQwNjoyNTozMVrOH8Zx0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQyMDoxMTo1NVrOH8988Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODk2Mw==", "bodyText": "Do we have a test for this anywhere?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533098963", "createdAt": "2020-12-01T06:25:31Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {\n+                        return Maps.copyMapWithRemovedEntry(headers, \"Warning\");\n+                    }\n+                    return headers;\n+                }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzY5MTYzMw==", "bodyText": "Added a test to verify Warnings are removed if authN fails.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r533691633", "createdAt": "2020-12-01T20:11:55Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {\n+                        return Maps.copyMapWithRemovedEntry(headers, \"Warning\");\n+                    }\n+                    return headers;\n+                }\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzA5ODk2Mw=="}, "originalCommit": {"oid": "39e7ca7b5d29c8efa4519895b67d4843f387d3f8"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1NDg5ODM0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNTo1OToyMVrOH97mWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNTo1OToyMVrOH97mWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDcwMTY1OQ==", "bodyText": "In general we prefer to use Matcher based assertions because they provide better context when something fails.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertTrue(afterWarningHeaders.size() == 1);\n          \n          \n            \n                    assertTrue(afterWarningHeaders.stream().anyMatch(v ->v.contains(\"Your license will expire in [6] days. \" +\n          \n          \n            \n                        \"Contact your administrator or update your license for continued use of features\")));\n          \n          \n            \n                    assertThat(afterWarningHeaders, Matchers.hasSize(1));\n          \n          \n            \n                    assertThat(afterWarningHeaders, Matchers.contains(\"Your license will expire in [6] days. \" +\n          \n          \n            \n                        \"Contact your administrator or update your license for continued use of features\"));\n          \n      \n    \n    \n  \n\n(Although, technically, the first assertion is redundant, because the `contains matcher already checks size)", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r534701659", "createdAt": "2020-12-03T05:59:21Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -192,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(afterWarningHeaders.size() == 1);\n+        assertTrue(afterWarningHeaders.stream().anyMatch(v ->v.contains(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d27df6f4d69e968dc39e417ef3abafc441ffa4cb"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjgwNjYwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxNDozOVrOH_Hs0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMDoyOTo1NFrOH_Kr0g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0ODQ5Nw==", "bodyText": "Do we want to remove all warning headers on authentication failure?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535948497", "createdAt": "2020-12-04T09:14:39Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk5NzM5NA==", "bodyText": "Yes, it is intentional (see Tim's comment above). If Authentication fails it does make sense to not reveal any additional information", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535997394", "createdAt": "2020-12-04T10:29:54Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -100,6 +102,14 @@ private void handleException(String actionType, RestRequest request, RestChannel\n                 @Override\n                 protected boolean skipStackTrace() { return restStatus == RestStatus.UNAUTHORIZED; }\n \n+                @Override\n+                public Map<String, List<String>> filterHeaders(Map<String, List<String>> headers) {\n+                    if (headers.containsKey(\"Warning\")) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk0ODQ5Nw=="}, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjgxNjY4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/test/SecuritySettingsSourceField.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxNjo1NlrOH_Hy2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxNjo1NlrOH_Hy2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MDA0MQ==", "bodyText": "I think you can use a randomAlphaNumericOfLength , or a permutation of TEST_PASSWORD plus some random string for whenever we need this, other than defining it here. That's just personal preference, no strong views, feel free to keep as is if you prefer it", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535950041", "createdAt": "2020-12-04T09:16:56Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/test/SecuritySettingsSourceField.java", "diffHunk": "@@ -10,6 +10,7 @@\n public final class SecuritySettingsSourceField {\n     public static final SecureString TEST_PASSWORD_SECURE_STRING = new SecureString(\"x-pack-test-password\".toCharArray());\n     public static final String TEST_PASSWORD = \"x-pack-test-password\";\n+    public static final String TEST_INVALID_PASSWORD = \"invalid-test-password\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjgyMjA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxODoxNVrOH_H2DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxODoxNVrOH_H2DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MDg2MQ==", "bodyText": "use assertThat ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535950861", "createdAt": "2020-12-04T09:18:15Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MjgyNDkwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxODo1MFrOH_H3oQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToxODo1MFrOH_H3oQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1MTI2NQ==", "bodyText": "nit: Do we need all the empty lines?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535951265", "createdAt": "2020-12-04T09:18:50Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2Mjg1OTU1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToyNjo1MFrOH_IL0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMDo0MzoxOVrOH_LMSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1NjQzMg==", "bodyText": "I Guess we are fine with the message in warnigns and subtleties of toDays and being close to midnight in a given timezone , right? I think we are, just asking for completeness.", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535956432", "createdAt": "2020-12-04T09:26:50Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -509,12 +520,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        final long licenseExpiryDate = getLicenseExpiryDate();\n+        final long diff = licenseExpiryDate - System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() > diff) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(diff);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAwNTcwNw==", "bodyText": "I believe we are :)", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r536005707", "createdAt": "2020-12-04T10:43:19Z", "author": {"login": "BigPandaToo"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/XPackLicenseState.java", "diffHunk": "@@ -509,12 +520,26 @@ public boolean isActive() {\n     /**\n      * Checks whether the given feature is allowed, tracking the last usage time.\n      */\n+    @SuppressForbidden(reason = \"Argument to Math.abs() is definitely not Long.MIN_VALUE\")\n     public boolean checkFeature(Feature feature) {\n         boolean allowed = isAllowed(feature);\n         LongAccumulator maxEpochAccumulator = lastUsed.get(feature);\n+        final long licenseExpiryDate = getLicenseExpiryDate();\n+        final long diff = licenseExpiryDate - System.currentTimeMillis();\n         if (maxEpochAccumulator != null) {\n             maxEpochAccumulator.accumulate(epochMillisProvider.getAsLong());\n         }\n+\n+        if (feature.minimumOperationMode.compareTo(OperationMode.BASIC) > 0 &&\n+            LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() > diff) {\n+            final long days = TimeUnit.MILLISECONDS.toDays(diff);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1NjQzMg=="}, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 96}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2Mjg3MDg4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToyOToyNFrOH_ISig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOToyOToyNFrOH_ISig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1ODE1NA==", "bodyText": "use assertThat ?", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535958154", "createdAt": "2020-12-04T09:29:24Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now + 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license expires today. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now - 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        long finalNewExpirationDate = newExpirationDate;\n+        String expiredMessage = String.format(Locale.ROOT, \"Your license expired on [%s]. \",\n+            LicenseService.DATE_FORMATTER.formatMillis(finalNewExpirationDate));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(expiredMessage +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+    }\n+\n+    public void testWarningHeaderAuthenticationFailed() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_INVALID_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+        Header[] headers = null;\n+        try {\n+            getRestClient().performRequest(request);\n+        } catch (ResponseException e) {\n+            headers = e.getResponse().getHeaders();\n+            List<String> afterWarningHeaders= getWarningHeaders(e.getResponse().getHeaders());\n+            assertThat(afterWarningHeaders, Matchers.hasSize(0));\n+        }\n+        assertTrue(headers != null && headers.length == 3);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 128}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2Mjg3Mzk2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOTozMDowN1rOH_IUaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwOTozMDowN1rOH_IUaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTk1ODYzMg==", "bodyText": "nit suggestion : testNoWarningHeaderWhenAuthenticationFailed", "url": "https://github.com/elastic/elasticsearch/pull/64948#discussion_r535958632", "createdAt": "2020-12-04T09:30:07Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/license/LicensingTests.java", "diffHunk": "@@ -190,6 +202,82 @@ public void testNodeJoinWithoutSecurityExplicitlyEnabled() throws Exception {\n         }\n     }\n \n+    public void testWarningHeader() throws Exception {\n+        Request request = new Request(\"GET\", \"/_security/user\");\n+        RequestOptions.Builder options = request.getOptions().toBuilder();\n+        options.addHeader(\"Authorization\", basicAuthHeaderValue(SecuritySettingsSource.TEST_USER_NAME,\n+            new SecureString(SecuritySettingsSourceField.TEST_PASSWORD.toCharArray())));\n+        request.setOptions(options);\n+\n+        Response response = getRestClient().performRequest(request);\n+\n+        List<String> beforeWarningHeaders = getWarningHeaders(response.getHeaders());\n+\n+        assertTrue(beforeWarningHeaders.isEmpty());\n+\n+        License.OperationMode mode = randomFrom(License.OperationMode.GOLD, License.OperationMode.PLATINUM,\n+            License.OperationMode.ENTERPRISE, License.OperationMode.STANDARD);\n+        long now = System.currentTimeMillis();\n+        long newExpirationDate = now + LICENSE_EXPIRATION_WARNING_PERIOD.getMillis() - 1;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        List<String> afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license will expire in [6] days. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now + 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(\"Your license expires today. \" +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+\n+        newExpirationDate = now - 300000;\n+        setLicensingExpirationDate(mode, newExpirationDate);\n+\n+        response = getRestClient().performRequest(request);\n+\n+        afterWarningHeaders= getWarningHeaders(response.getHeaders());\n+\n+        assertThat(afterWarningHeaders, Matchers.hasSize(1));\n+        long finalNewExpirationDate = newExpirationDate;\n+        String expiredMessage = String.format(Locale.ROOT, \"Your license expired on [%s]. \",\n+            LicenseService.DATE_FORMATTER.formatMillis(finalNewExpirationDate));\n+        assertThat(afterWarningHeaders.get(0), Matchers.containsString(expiredMessage +\n+            \"Contact your administrator or update your license for continued use of features\"));\n+    }\n+\n+    public void testWarningHeaderAuthenticationFailed() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8773e3ca0aa2d03e11f9ae14c91049afef922b5"}, "originalPosition": 108}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2958, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}