{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxNDA5MzY1", "number": 62061, "title": "Shard Search Scroll failures consistency", "bodyText": "Today some uncaught shard failures such as RejectedExecutionException skips the release of shard context\nand let subsequent scroll requests access the same shard context again. Depending on how the other shards advanced,\nthis behavior can lead to missing data since scrolls always move forward.\nIn order to avoid hidden data loss, this commit ensures that we always release the context of shard search scroll requests whenever a failure occurs locally.\nThe shard search context will no longer exist in subsequent scroll requests which will lead to consistent shard failures in the responses.\nThis change also modifies the retry tests of the reindex feature. Reindex retries scroll search request that contains a shard failure and move on whenever the failure disappears. That is not compatible with how scrolls work and can lead to missing data as explained above.\nThat means that reindex will now report scroll failures when search rejection happen during the operation instead of skipping document silently.\nFinally this change removes an old TODO that was fulfilled with #61062.\nRelates #61062\nNote for reviewer: The last commit contains a fix for #62046 and #62056 since these tests failed in CI when checking this PR. The change ensures that we create a single searcher for scrolls.\nCloses #62046\nCloses #62056", "createdAt": "2020-09-07T13:51:07Z", "url": "https://github.com/elastic/elasticsearch/pull/62061", "merged": true, "mergeCommit": {"oid": "aefca5edd76b86d0de06c9c3a2bbba6b0f1ebb58"}, "closed": true, "closedAt": "2020-09-09T07:14:09Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGrVFsAH2gAyNDgxNDA5MzY1OjVhMDI2Nzc3NTRmZDE3MGQ3YmE4NzQ0ZTU3MzNkZGUwZDdmODQ2ODE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHGDO6AH2gAyNDgxNDA5MzY1OjZhNTY5YzMzOGY3NDNhMmQ2ZTNkYTI2MWViOWIyNzAwOWQwNTdmNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a02677754fd170d7ba8744e5733dde0d7f84681", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a02677754fd170d7ba8744e5733dde0d7f84681", "committedDate": "2020-09-07T23:09:44Z", "message": "Shard Search Scroll failures consistency\n\nToday some uncaught shard failures such as RejectedExecutionException skips the release of shard context\nand let subsequent scroll requests access the same shard context again. Depending on how the other shards advanced,\nthis behavior can lead to missing data since scrolls always move forward.\nIn order to avoid hidden data loss, this commit ensures that we always release the context of shard search scroll requests whenever a failure\noccurs locally. The shard search context will no longer exist in subsequent scroll requests which will lead to consistent shard failures\nin the responses.\nThis change also modifies the retry tests of the reindex feature. Reindex retries scroll search request that contains a shard failure and\nmove on whenever the failure disappears. That is not compatible with how scrolls work and can lead to missing data as explained above.\nThat means that reindex will now report scroll failures when search rejection happen during the operation instead of skipping document\nsilently.\nFinally this change removes an old TODO that was fulfilled with #61062."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f12505eac0e18d8077101a807a8d0c751d0700f", "committedDate": "2020-09-07T23:09:44Z", "message": "Make the searcher for legacy reader context final\n\nThis commit ensures that the searcher that we create for scrolls is initialized only once.t"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e4d690a5271333f11197bd1e0e55c7402cb4d6ed", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4d690a5271333f11197bd1e0e55c7402cb4d6ed", "committedDate": "2020-09-07T23:04:34Z", "message": "fix serialization test"}, "afterCommit": {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f12505eac0e18d8077101a807a8d0c751d0700f", "committedDate": "2020-09-07T23:09:44Z", "message": "Make the searcher for legacy reader context final\n\nThis commit ensures that the searcher that we create for scrolls is initialized only once.t"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MTQ3MTQ2", "url": "https://github.com/elastic/elasticsearch/pull/62061#pullrequestreview-484147146", "createdAt": "2020-09-08T13:36:45Z", "commit": {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MzQ0MDAy", "url": "https://github.com/elastic/elasticsearch/pull/62061#pullrequestreview-484344002", "createdAt": "2020-09-08T17:18:07Z", "commit": {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzoxODowN1rOHOmyqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxNzoxODowN1rOHOmyqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTA3NzY3Mw==", "bodyText": "I think we can move this method to ReaderContext? (i.e., ReaderContext.markAsUsed(long keepAliveInMillis)?", "url": "https://github.com/elastic/elasticsearch/pull/62061#discussion_r485077673", "createdAt": "2020-09-08T17:18:07Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -643,13 +611,18 @@ private ReaderContext findReaderContext(ShardSearchContextId id, TransportReques\n         return reader;\n     }\n \n+    private Releasable updateKeepAliveAndMarkAsUsed(ReaderContext reader, long keepAlive) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f12505eac0e18d8077101a807a8d0c751d0700f"}, "originalPosition": 148}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d927699905a354353f242505aedf805019bade8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d927699905a354353f242505aedf805019bade8", "committedDate": "2020-09-08T23:27:22Z", "message": "add keepAlive in markAsUsed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a569c338f743a2d6e3da261eb9b27009d057f68", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a569c338f743a2d6e3da261eb9b27009d057f68", "committedDate": "2020-09-09T06:17:40Z", "message": "Merge branch 'master' into scroll_failures"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4730, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}