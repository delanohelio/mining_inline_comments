{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyMDk3MjY2", "number": 66559, "title": "Allow ESRestTestClient to trust certificates", "bodyText": "ESRestTestCase rest clients could only be configured to trust\nthe certificate authorities that were contained in a truststore. In\ncertain cases (like in fips mode where JKS/PKCS12 keystores) cannot\nbe used, it's beneficial to be able to trust specific certificate\nauthorities (indicated by the CA PEM endoded certificate)", "createdAt": "2020-12-17T20:08:00Z", "url": "https://github.com/elastic/elasticsearch/pull/66559", "merged": true, "mergeCommit": {"oid": "abaf81e37ec8c26f3a78539dc00c1a7ecfa6c921"}, "closed": true, "closedAt": "2020-12-23T15:29:44Z", "author": {"login": "jkakavas"}, "timelineItems": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnJPvMgH2gAyNTQyMDk3MjY2OjdjZDAzMjY0MmVlYWIxZDViOTJhY2FmNDA3MTEyYTc0YWYwMTAwYzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdo9nrKgFqTU1NzgxNjYyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7cd032642eeab1d5b92acaf407112a74af0100c2", "author": {"user": {"login": "jkakavas", "name": "Ioannis Kakavas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cd032642eeab1d5b92acaf407112a74af0100c2", "committedDate": "2020-12-17T20:06:37Z", "message": "Allow ESRestTestClient to trust certificates\n\nESRestTestCase rest clients could only be configured to trust\nthe certificate authorities that were contained in a truststore. In\ncertain cases (like in fips mode where JKS/PKCS12 keystores) cannot\nbe used, it's beneficial to be able to trust specific certificate\nauthorities (indicated by the CA PEM endoded certificate)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU3ODE2NjIz", "url": "https://github.com/elastic/elasticsearch/pull/66559#pullrequestreview-557816623", "createdAt": "2020-12-23T11:40:17Z", "commit": {"oid": "7cd032642eeab1d5b92acaf407112a74af0100c2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0MDoxN1rOIKiL-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yM1QxMTo0MDoxN1rOIKiL-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NzkxNjc5Mg==", "bodyText": "Do we need to cater for the use case of mulitple certificates from the single PEM file?", "url": "https://github.com/elastic/elasticsearch/pull/66559#discussion_r547916792", "createdAt": "2020-12-23T11:40:17Z", "author": {"login": "ywangd"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -1020,7 +1034,24 @@ protected static void configureClient(RestClientBuilder builder, Settings settin\n                 SSLContext sslcontext = SSLContexts.custom().loadTrustMaterial(keyStore, null).build();\n                 SSLIOSessionStrategy sessionStrategy = new SSLIOSessionStrategy(sslcontext);\n                 builder.setHttpClientConfigCallback(httpClientBuilder -> httpClientBuilder.setSSLStrategy(sessionStrategy));\n-            } catch (KeyStoreException |NoSuchAlgorithmException |KeyManagementException |CertificateException e) {\n+            } catch (KeyStoreException | NoSuchAlgorithmException | KeyManagementException | CertificateException e) {\n+                throw new RuntimeException(\"Error setting up ssl\", e);\n+            }\n+        }\n+        if (certificateAuthorities != null) {\n+            Path path = PathUtils.get(certificateAuthorities);\n+            if (!Files.exists(path)) {\n+                throw new IllegalStateException(CERTIFICATE_AUTHORITIES + \" is set but points to a non-existing file\");\n+            }\n+            try {\n+                KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n+                keyStore.load(null, null);\n+                Certificate cert = PemUtils.readCertificates(List.of(path)).get(0);\n+                keyStore.setCertificateEntry(cert.toString(), cert);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cd032642eeab1d5b92acaf407112a74af0100c2"}, "originalPosition": 62}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4344, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}