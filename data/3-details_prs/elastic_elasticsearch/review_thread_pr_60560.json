{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwNjk3NDAz", "number": 60560, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxOTowMDozNlrOEUuPoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowNToyNFrOEUxdow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMTY0NjQxOnYy", "diffSide": "LEFT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/BatsTestTask.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxOTowMDozNlrOG7FNOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxOTowMDozNlrOG7FNOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNDQ3NA==", "bodyText": "Yay!", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464604474", "createdAt": "2020-08-03T19:00:36Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/BatsTestTask.java", "diffHunk": "@@ -1,131 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjE1MDY4OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMTo1NjoyMVrOG7KAqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMzoxODo1MFrOG7LtSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw==", "bodyText": "I'm now wondering if this intermediary task is striclty necessary. Is there anyreason why the test task can't just depend directly on the distribution, and the VM tasks depend on all distributions?", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464683177", "createdAt": "2020-08-03T21:56:21Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5MDA2OQ==", "bodyText": "I don't think we want the VM task depending on all distributions. That would mean a repro line would rebuild all distros, instead of just the one you are trying to run.", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464690069", "createdAt": "2020-08-03T22:14:33Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5NzA4NQ==", "bodyText": "Ok, I got confused by the fact we are passing all the deps tasks to the wrapper task creation. Couldn't we do the same thing though, and directly bucket the distributions, instead of the deps tasks? Just seems another layer we don't really need.", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464697085", "createdAt": "2020-08-03T22:34:47Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDcxMDk4NQ==", "bodyText": "We would need to apply the distro download plugin inside the subprojects (ie the ones with the wrapper tasks), as well as produce the test jar as an artifact. However, that is a lot of extra work that is not useful since we don't actually need those in the subproject to run, we only want to ensure the tasks in :qa:os ran before launching the VM task.", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464710985", "createdAt": "2020-08-03T23:18:50Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw=="}, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 101}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjE3Mzc5OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowNToyNFrOG7KORA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowNToyNFrOG7KORA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NjY2MA==", "bodyText": "Why rename this? I think having \"VM\" in the name is helpful. Else let's add a comment.", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464686660", "createdAt": "2020-08-03T22:05:24Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -323,69 +295,52 @@ private static Configuration configureExamplePlugin(Project project) {\n         return examplePlugin;\n     }\n \n-    private static TaskProvider<GradleDistroTestTask> configureVMWrapperTask(\n+    private static void configureWrapperTasks(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 361}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2703, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}