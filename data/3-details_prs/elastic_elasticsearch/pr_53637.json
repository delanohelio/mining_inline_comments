{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg5NTE0MjUz", "number": 53637, "title": "Use set-based interface for NodesStatsRequest", "bodyText": "This PR refactors the NodesStatsRequest object towards pluggability. It has the same basic structure as a similar refactor of the NodesInfoRequest object.\nNow that the NodesStatsRequest class uses a set of strings for its internal serialization, we need to update the class's interface so that we no longer use hard-coded getters and setters, but rather methods that add strings directly. For example, the old way of adding \"os\" metrics to a request would be to call request.os(true). The new way of doing this is to call request.addMetric(\"os\").\nFor the time being, the canonical list of metrics is an enum in NodesStatsRequest. This will eventually be replaced with something pluggable.\nNote that the NodesStatsRequestBuilder class also needs to be refactored, but I'm leaving that for a later PR in order to keep the diff manageable.\nRelates #52975 (meta issue)\nRelates #53410 (parallel refactor of Nodes Info)\nRelates #53235 (previous work on NodesStatsRequest)", "createdAt": "2020-03-16T21:56:49Z", "url": "https://github.com/elastic/elasticsearch/pull/53637", "merged": true, "mergeCommit": {"oid": "7bc130bc6204cf8720be5227e297bea4ae49ee80"}, "closed": true, "closedAt": "2020-03-26T18:40:07Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcOUUr1gH2gAyMzg5NTE0MjUzOjBlNWFjNmUxMjMzMWFjYmM3NzNjN2JhMmY1ZGVhOTdhNzY3YmU1NGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRFo5-AH2gAyMzg5NTE0MjUzOmM1NWNkYWY3ZWI5YWEwNjU1ZDQ3ZjRkNGY3YTZmZmEzNWJmMzgxYTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0e5ac6e12331acbc773c7ba2f5dea97a767be54d", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e5ac6e12331acbc773c7ba2f5dea97a767be54d", "committedDate": "2020-03-16T20:41:43Z", "message": "Add set-based interface for NodesStatsRequest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60f8ec664cf23f3d304b43586723136782c11724", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/60f8ec664cf23f3d304b43586723136782c11724", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed0d521bae8c6d5684102f67e486c54703fee9a7", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed0d521bae8c6d5684102f67e486c54703fee9a7", "committedDate": "2020-03-16T20:41:43Z", "message": "Add set-based checks to NodesStatsRequestTests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12131cdd0ff29d15c833094169d2468867d1a22a", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/12131cdd0ff29d15c833094169d2468867d1a22a", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old setters from RestNodesStatsAction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "476f32f7f0a801e080911b90f3da2f82493fc24b", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/476f32f7f0a801e080911b90f3da2f82493fc24b", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old setters from NodesStatsRequestBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27be1a77e4b9f09eac68de7c0ec0087f13a16eef", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/27be1a77e4b9f09eac68de7c0ec0087f13a16eef", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old getters from TransportNodesStatsAction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b17c48a89a1d85d302368031b931341f2da73e9f", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/b17c48a89a1d85d302368031b931341f2da73e9f", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old getters and setters from tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4efb83c9051ef33f630620bc18517f00531db1c8", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/4efb83c9051ef33f630620bc18517f00531db1c8", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old getters from NodesStatsRequest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61b1215ed6939eeb4f35be7c47b7c9795116ab4c", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/61b1215ed6939eeb4f35be7c47b7c9795116ab4c", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove redundant setter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69819c5db1e2b2d8870bfd47d5b5bdc32a45bc8f", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/69819c5db1e2b2d8870bfd47d5b5bdc32a45bc8f", "committedDate": "2020-03-16T20:41:43Z", "message": "Replace various uses of old metric setters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c362d49d205295266759eafd0fe597f9d383475d", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/c362d49d205295266759eafd0fe597f9d383475d", "committedDate": "2020-03-16T20:41:43Z", "message": "Remove old metric setters from NodesStatsRequest"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d06e74f808d655b9bb793625f8f53a0776b7e1d1", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/d06e74f808d655b9bb793625f8f53a0776b7e1d1", "committedDate": "2020-03-16T20:41:43Z", "message": "Make setter variatic instead of set-based"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ff0b532361100dbc946297b6c4b6c7722afb377", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ff0b532361100dbc946297b6c4b6c7722afb377", "committedDate": "2020-03-16T20:41:43Z", "message": "Add test for exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da864a4b1c99115db83b27dca0462994d2c58cf3", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/da864a4b1c99115db83b27dca0462994d2c58cf3", "committedDate": "2020-03-16T20:41:43Z", "message": "Move metric list into stats request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a743ad8f32d2c3470353d1a37c64f761bdf96391", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/a743ad8f32d2c3470353d1a37c64f761bdf96391", "committedDate": "2020-03-16T21:35:40Z", "message": "Rename deserialization helper method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc37c4b3b1d022d0907dbdff0de7fef714e3d744", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc37c4b3b1d022d0907dbdff0de7fef714e3d744", "committedDate": "2020-03-16T21:36:15Z", "message": "Update javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb0ac9fbedb99d5aba80dd5b191265b08aa148f0", "committedDate": "2020-03-16T21:57:54Z", "message": "Slight refactor"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NzQwMTg5", "url": "https://github.com/elastic/elasticsearch/pull/53637#pullrequestreview-379740189", "createdAt": "2020-03-23T19:12:40Z", "commit": {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOToxMjo0MVrOF6URgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxOToyNDoyOFrOF6UrEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Mzg5MA==", "bodyText": "Could we simplify this by using Set.containsAll? Essentially this:\nSet<String> metricsSet = new TreeSet<>(metrics);\nif (Metric.allMetrics().containsAll(metricSet) == false) {\n    Set<String> illegalMetrics = metricsSet.removaAll(Metric.allMetrics());\n    // throw\n}\nrequestMetrics.addAll(metricsSet);", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396693890", "createdAt": "2020-03-23T19:12:41Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -114,178 +130,65 @@ public NodesStatsRequest indices(boolean indices) {\n     }\n \n     /**\n-     * Should the node OS be returned.\n-     */\n-    public boolean os() {\n-        return Metric.OS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node OS be returned.\n-     */\n-    public NodesStatsRequest os(boolean os) {\n-        addOrRemoveMetric(os, Metric.OS.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node Process be returned.\n-     */\n-    public boolean process() {\n-        return Metric.PROCESS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Process be returned.\n-     */\n-    public NodesStatsRequest process(boolean process) {\n-        addOrRemoveMetric(process, Metric.PROCESS.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node JVM be returned.\n+     * Get the names of requested metrics, excluding indices, which are\n+     * handled separately.\n      */\n-    public boolean jvm() {\n-        return Metric.JVM.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node JVM be returned.\n-     */\n-    public NodesStatsRequest jvm(boolean jvm) {\n-        addOrRemoveMetric(jvm, Metric.JVM.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node Thread Pool be returned.\n-     */\n-    public boolean threadPool() {\n-        return Metric.THREAD_POOL.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Thread Pool be returned.\n-     */\n-    public NodesStatsRequest threadPool(boolean threadPool) {\n-        addOrRemoveMetric(threadPool, Metric.THREAD_POOL.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node file system stats be returned.\n-     */\n-    public boolean fs() {\n-        return Metric.FS.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node file system stats be returned.\n-     */\n-    public NodesStatsRequest fs(boolean fs) {\n-        addOrRemoveMetric(fs, Metric.FS.metricName());\n-        return this;\n+    public Set<String> requestedMetrics() {\n+        return Set.copyOf(requestedMetrics);\n     }\n \n     /**\n-     * Should the node Transport be returned.\n+     * Add metric\n      */\n-    public boolean transport() {\n-        return Metric.TRANSPORT.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node Transport be returned.\n-     */\n-    public NodesStatsRequest transport(boolean transport) {\n-        addOrRemoveMetric(transport, Metric.TRANSPORT.metricName());\n-        return this;\n-    }\n-\n-    /**\n-     * Should the node HTTP be returned.\n-     */\n-    public boolean http() {\n-        return Metric.HTTP.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node HTTP be returned.\n-     */\n-    public NodesStatsRequest http(boolean http) {\n-        addOrRemoveMetric(http, Metric.HTTP.metricName());\n-        return this;\n-    }\n-\n-    public boolean breaker() {\n-        return Metric.BREAKER.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node's circuit breaker stats be returned.\n-     */\n-    public NodesStatsRequest breaker(boolean breaker) {\n-        addOrRemoveMetric(breaker, Metric.BREAKER.metricName());\n-        return this;\n-    }\n-\n-    public boolean script() {\n-        return Metric.SCRIPT.containedIn(requestedMetrics);\n-    }\n-\n-    public NodesStatsRequest script(boolean script) {\n-        addOrRemoveMetric(script, Metric.SCRIPT.metricName());\n-        return this;\n-    }\n-\n-\n-    public boolean discovery() {\n-        return Metric.DISCOVERY.containedIn(requestedMetrics);\n-    }\n-\n-    /**\n-     * Should the node's discovery stats be returned.\n-     */\n-    public NodesStatsRequest discovery(boolean discovery) {\n-        addOrRemoveMetric(discovery, Metric.DISCOVERY.metricName());\n+    public NodesStatsRequest addMetric(String metric) {\n+        if (Metric.allMetrics().contains(metric) == false) {\n+            throw new IllegalStateException(\"Used an illegal metric: \" + metric);\n+        }\n+        requestedMetrics.add(metric);\n         return this;\n     }\n \n-    public boolean ingest() {\n-        return Metric.INGEST.containedIn(requestedMetrics);\n-    }\n-\n     /**\n-     * Should ingest statistics be returned.\n+     * Add an array of metric names\n      */\n-    public NodesStatsRequest ingest(boolean ingest) {\n-        addOrRemoveMetric(ingest, Metric.INGEST.metricName());\n+    public NodesStatsRequest addMetrics(String... metrics) {\n+        // use sorted set for reliable ordering in error messages\n+        SortedSet<String> illegalMetrics = new TreeSet<>();\n+        Set<String> validMetrics = new HashSet<>();\n+        for (String metric : metrics) {\n+            if (Metric.allMetrics().contains(metric)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0"}, "originalPosition": 238}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjY5Nzc2MQ==", "bodyText": "Why is this moved to here? It seems like an implementation detail that should stay in the stats action. The request should be a opaque list of strings?", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396697761", "createdAt": "2020-03-23T19:19:36Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -311,11 +214,20 @@ public void writeTo(StreamOutput out) throws IOException {\n         }\n     }\n \n+    public static Map<String, Consumer<NodesStatsRequest>> getDispatchMap() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0"}, "originalPosition": 290}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjcwMDQzNQ==", "bodyText": "Can you elaborate on why this might need to be removed?", "url": "https://github.com/elastic/elasticsearch/pull/53637#discussion_r396700435", "createdAt": "2020-03-23T19:24:28Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/stats/NodesStatsRequest.java", "diffHunk": "@@ -327,15 +239,15 @@ public void writeTo(StreamOutput out) throws IOException {\n         SCRIPT(\"script\"),\n         DISCOVERY(\"discovery\"),\n         INGEST(\"ingest\"),\n-        ADAPTIVE_SELECTION(\"adaptiveSelection\");\n+        ADAPTIVE_SELECTION(\"adaptiveSelection\"); // TODO: Should this be removed?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0ac9fbedb99d5aba80dd5b191265b08aa148f0"}, "originalPosition": 313}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d083ede3220e4b475c6b38d839e30821cf9fcfac", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/d083ede3220e4b475c6b38d839e30821cf9fcfac", "committedDate": "2020-03-23T19:49:02Z", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b877f9fa29ff1a92a1d684fb027686af8b3205c9", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/b877f9fa29ff1a92a1d684fb027686af8b3205c9", "committedDate": "2020-03-23T20:23:25Z", "message": "Simplify set-checking logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25a06b596f66e98e79425910ebc16e5eda97bd1b", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/25a06b596f66e98e79425910ebc16e5eda97bd1b", "committedDate": "2020-03-23T20:29:57Z", "message": "Move dispatch map and change token for adaptive selection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03d1f0d595549ec13666565a858b081355344d77", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/03d1f0d595549ec13666565a858b081355344d77", "committedDate": "2020-03-23T21:11:21Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNjk5NDUx", "url": "https://github.com/elastic/elasticsearch/pull/53637#pullrequestreview-380699451", "createdAt": "2020-03-24T21:11:03Z", "commit": {"oid": "03d1f0d595549ec13666565a858b081355344d77"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e88027c6dc2529452005fb05dba849b4e2e7aa95", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/e88027c6dc2529452005fb05dba849b4e2e7aa95", "committedDate": "2020-03-25T01:10:16Z", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "982cb768fa9afdcb0aefa89290bf9cfbebbdd946", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/982cb768fa9afdcb0aefa89290bf9cfbebbdd946", "committedDate": "2020-03-25T01:39:43Z", "message": "Disable bwc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c55cdaf7eb9aa0655d47f4d4f7a6ffa35bf381a8", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/c55cdaf7eb9aa0655d47f4d4f7a6ffa35bf381a8", "committedDate": "2020-03-25T11:17:00Z", "message": "Merge branch 'master' into nodes-stats-request-interface-refactor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1456, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}