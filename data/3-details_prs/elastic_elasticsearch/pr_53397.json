{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NjUwODUx", "number": 53397, "title": "Fix pre-sorting of shards in the can_match phase", "bodyText": "This commit fixes a bug on sorted queries with a primary sort field that uses different types in the requested indices. In this scenario the returned min/max values to sort the shards are not comparable so we should avoid the sorting rather than throwing an obscure exception.", "createdAt": "2020-03-11T12:07:02Z", "url": "https://github.com/elastic/elasticsearch/pull/53397", "merged": true, "mergeCommit": {"oid": "37c739c0483f1b7202ba7325e459d2b91ee07695"}, "closed": true, "closedAt": "2020-03-13T00:27:27Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMl8x_gH2gAyMzg2NjUwODUxOjE3NzVkMTlkNTkyNzdjY2JhYTRjMjIzMzhjOTY4NGY2ZTQ5MDcxMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNBnA6gH2gAyMzg2NjUwODUxOmVmM2RmMzVjMWQ5YzU3ZDMxMTg3ZTBjMDJjMWIwN2M2OWIxMjUwZGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1775d19d59277ccbaa4c22338c9684f6e4907126", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1775d19d59277ccbaa4c22338c9684f6e4907126", "committedDate": "2020-03-11T12:06:03Z", "message": "Fix pre-sorting of shards in the can_match phase\n\nThis commit fixes a bug on sorted queries with a primary sort field\nthat uses different types in the requested indices. In this scenario\nthe returned min/max values to sort the shards are not comparable so\nwe should avoid the sorting rather than throwing an obscure exception."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9eea0ee20e8bdc057983e68f6bfc7eb63914466", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f9eea0ee20e8bdc057983e68f6bfc7eb63914466", "committedDate": "2020-03-11T12:19:56Z", "message": "unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyODk0NDI2", "url": "https://github.com/elastic/elasticsearch/pull/53397#pullrequestreview-372894426", "createdAt": "2020-03-11T15:54:50Z", "commit": {"oid": "f9eea0ee20e8bdc057983e68f6bfc7eb63914466"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNTo1NDo1MVrOF09aXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQxNTo1NDo1MVrOF09aXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTA3NjQ0NA==", "bodyText": "It's slightly confusing that we use getMin for the initial getClass and then getMax. Use getMin all the time maybe?", "url": "https://github.com/elastic/elasticsearch/pull/53397#discussion_r391076444", "createdAt": "2020-03-11T15:54:51Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/action/search/CanMatchPreFilterSearchPhase.java", "diffHunk": "@@ -128,7 +126,18 @@ protected SearchPhase getNextPhase(SearchPhaseResults<CanMatchResponse> results,\n     }\n \n     private static boolean shouldSortShards(MinAndMax<?>[] minAndMaxes) {\n-        return Arrays.stream(minAndMaxes).anyMatch(Objects::nonNull);\n+        Class<?> clazz = null;\n+        for (MinAndMax<?> minAndMax : minAndMaxes) {\n+            if (clazz == null) {\n+                clazz = minAndMax == null ? null : minAndMax.getMin().getClass();\n+            } else if (minAndMax != null && clazz != minAndMax.getMax().getClass()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9eea0ee20e8bdc057983e68f6bfc7eb63914466"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14185e6d4dc5334693e5eade31b41587d4f3b8d8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/14185e6d4dc5334693e5eade31b41587d4f3b8d8", "committedDate": "2020-03-12T20:18:55Z", "message": "Merge branch 'master' into bugs/can_match_phase_sort_clazz"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ef3df35c1d9c57d31187e0c02c1b07c69b1250dc", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef3df35c1d9c57d31187e0c02c1b07c69b1250dc", "committedDate": "2020-03-12T20:19:37Z", "message": "address review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1467, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}