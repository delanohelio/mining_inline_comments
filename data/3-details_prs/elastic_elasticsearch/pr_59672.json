{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NzM4NjM1", "number": 59672, "title": "Scripted keyword field type: update family type and test field caps output", "bodyText": "Relates to #59332", "createdAt": "2020-07-15T21:07:29Z", "url": "https://github.com/elastic/elasticsearch/pull/59672", "merged": true, "mergeCommit": {"oid": "390fa6570f3819c6502acda97b02cafd2c41b9b6"}, "closed": true, "closedAt": "2020-07-17T13:52:23Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1RMpUAH2gAyNDQ5NzM4NjM1OjY5MzQwZTc1OGU1OWE2YzA5OTRlNDE3NWVlZTFkYzhkOGQxZjc3ZmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1zRASAFqTQ1MDYyNjc4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/69340e758e59a6c0994e4175eee1dc8d8d1f77fe", "committedDate": "2020-07-15T21:06:16Z", "message": "Scripted keyword field type: update family type and test field caps output"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzMyNTgz", "url": "https://github.com/elastic/elasticsearch/pull/59672#pullrequestreview-449332583", "createdAt": "2020-07-15T21:09:36Z", "commit": {"oid": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNDY4MTAw", "url": "https://github.com/elastic/elasticsearch/pull/59672#pullrequestreview-450468100", "createdAt": "2020-07-17T08:25:42Z", "commit": {"oid": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwODoyNTo0MlrOGzKINQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QwODoyNTo0MlrOGzKINQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjI5NjUwMQ==", "bodyText": "I think that I will remove this assertion. I initially assumed that calling this would make us load doc_values for a runtime field which is expensive, but it will only make us instantiate the classes and doc_values will not be advanced, hence no script is going to be executed.", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456296501", "createdAt": "2020-07-17T08:25:42Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeKeywordMappedFieldType.java", "diffHunk": "@@ -62,13 +63,27 @@ public Object valueForDisplay(Object value) {\n \n     @Override\n     public String typeName() {\n-        // TODO not sure what we should return here: the runtime type or the field type?\n-        // why is the same string returned from three different methods?\n         return ScriptFieldMapper.CONTENT_TYPE;\n     }\n \n+    @Override\n+    public String familyTypeName() {\n+        return KeywordFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public boolean isSearchable() {\n+        return true;\n+    }\n+\n+    @Override\n+    public boolean isAggregatable() {\n+        return true;\n+    }\n+\n     @Override\n     public ScriptBinaryFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName) {\n+        assert fullyQualifiedIndexName.length() > 0 : \"index name must not be empty\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69340e758e59a6c0994e4175eee1dc8d8d1f77fe"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37e44f21bfef73af94d9ab27fd94ecfe96dc3215", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/37e44f21bfef73af94d9ab27fd94ecfe96dc3215", "committedDate": "2020-07-17T08:27:39Z", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa771b2a47920194bff6a3b5c42a0692a62c091b", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa771b2a47920194bff6a3b5c42a0692a62c091b", "committedDate": "2020-07-17T08:32:36Z", "message": "remove assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ac336ccd2b8d0665befd400e25451b8cfa4b9d0", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ac336ccd2b8d0665befd400e25451b8cfa4b9d0", "committedDate": "2020-07-17T09:21:09Z", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da24f124adb6792789569d649331494176268111", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/da24f124adb6792789569d649331494176268111", "committedDate": "2020-07-17T09:41:54Z", "message": "Merge branch 'feature/runtime_fields' into enhancement/scripted_fields_test_field_caps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b586ca072bd7553b7d51a953f77d0588c7f24469", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/b586ca072bd7553b7d51a953f77d0588c7f24469", "committedDate": "2020-07-17T10:09:41Z", "message": "expand field caps testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06875dc0eea5079a3b0ae1683710cfa7be98e037", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/06875dc0eea5079a3b0ae1683710cfa7be98e037", "committedDate": "2020-07-17T11:02:21Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjI2Nzg4", "url": "https://github.com/elastic/elasticsearch/pull/59672#pullrequestreview-450626788", "createdAt": "2020-07-17T12:47:47Z", "commit": {"oid": "06875dc0eea5079a3b0ae1683710cfa7be98e037"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMjo0Nzo0N1rOGzRqPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMjo0Nzo0N1rOGzRqPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQxOTkwMA==", "bodyText": "@nik9000 you may have opinions on this. I added it because I did not want to have tests to maintain a list of supported runtime types and rather rely on the truth which cannot get outdated. Downside is we have no if but rather a map with a bifunction, maybe a bit cryptic.", "url": "https://github.com/elastic/elasticsearch/pull/59672#discussion_r456419900", "createdAt": "2020-07-17T12:47:47Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptFieldMapper.java", "diffHunk": "@@ -112,13 +130,13 @@ protected Builder(String name, ScriptCompiler scriptCompiler) {\n \n         @Override\n         public ScriptFieldMapper build(BuilderContext context) {\n-            MappedFieldType mappedFieldType;\n-            if (runtimeType.getValue().equals(\"keyword\")) {\n-                StringScriptFieldScript.Factory factory = scriptCompiler.compile(script.getValue(), StringScriptFieldScript.CONTEXT);\n-                mappedFieldType = new RuntimeKeywordMappedFieldType(buildFullName(context), script.getValue(), factory, meta.getValue());\n-            } else {\n+            BiFunction<Builder, BuilderContext, MappedFieldType> fieldTypeResolver = Builder.FIELD_TYPE_RESOLVER.get(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06875dc0eea5079a3b0ae1683710cfa7be98e037"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4265, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}