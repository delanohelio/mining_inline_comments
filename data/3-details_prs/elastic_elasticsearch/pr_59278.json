{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ2Njg5NTYz", "number": 59278, "title": "Set specific keepalive options by default on supported platforms", "bodyText": "keepalives tell any intermediate devices that the connection remains alive, which helps with overzealous firewalls that are killing idle connections. keepalives are enabled by default in Elasticsearch, but use system defaults for their configuration, which often times do not have reasonable defaults (e.g. 7200s for TCP_KEEP_IDLE) in the context of distributed systems such as Elasticsearch.\nThis PR sets the socket-level keep_alive options for transport.tcp.{keep_idle,keep_interval} to 5 minutes on configurations that support it (>= Java 11 & (MacOS || Linux)) and where the system defaults are set to something higher than 5 minutes. This helps keep the connections alive while not interfering with system defaults or user-specified settings unless they are deemed to be set too high by providing better out-of-the-box defaults.", "createdAt": "2020-07-09T08:02:34Z", "url": "https://github.com/elastic/elasticsearch/pull/59278", "merged": true, "mergeCommit": {"oid": "2078509af584ac98e447e60290f8f567e2c4ad7b"}, "closed": true, "closedAt": "2020-07-27T11:38:24Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABczKVgvAH2gAyNDQ2Njg5NTYzOjA1YjQ2ZDQ3ZjVhNDQ1NmFhYWZhODFjZDZjYzE0ODQ5OGIwNzU4MWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc4_X_iAFqTQ1NTY2NjMwNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "05b46d47f5a4456aaafa81cd6cc148498b07581a", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/05b46d47f5a4456aaafa81cd6cc148498b07581a", "committedDate": "2020-07-09T07:58:46Z", "message": "Set specific keepalive options by default on supported platforms"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3aa4c0c43a1a57d780671d49dc9eb84815818c9", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3aa4c0c43a1a57d780671d49dc9eb84815818c9", "committedDate": "2020-07-09T08:23:10Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c860643e2958aa9ed00bb2ce8752b576af4afd", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/05c860643e2958aa9ed00bb2ce8752b576af4afd", "committedDate": "2020-07-09T09:03:24Z", "message": "Oops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4OTc3MTkz", "url": "https://github.com/elastic/elasticsearch/pull/59278#pullrequestreview-448977193", "createdAt": "2020-07-15T13:54:45Z", "commit": {"oid": "05c860643e2958aa9ed00bb2ce8752b576af4afd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxMzo1NDo0NlrOGx_Rww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxNDowMDozOFrOGx_jMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MDE0Nw==", "bodyText": "Suggest describing the meaning of -1 here rather than in the sentence about the default:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               starting to send TCP keepalive probes.\n          \n          \n            \n               starting to send TCP keepalive probes. A value of `-1` means not to set this option at the socket level and to use the system default instead.\n          \n      \n    \n    \n  \n\n(also for the other settings)", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r455070147", "createdAt": "2020-07-15T13:54:46Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/modules/transport.asciidoc", "diffHunk": "@@ -88,19 +88,22 @@ example above:\n    determines the time in seconds that a connection must be idle before\n    starting to send TCP keepalive probes.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c860643e2958aa9ed00bb2ce8752b576af4afd"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3MDM3MA==", "bodyText": "Can delete the rest of this sentence:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n               Defaults to 60 on applicable configurations, and -1 otherwise, which does\n          \n          \n            \n               Defaults to `60` on applicable configurations, and `-1` otherwise.\n          \n      \n    \n    \n  \n\n(also subsequent lines)", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r455070370", "createdAt": "2020-07-15T13:55:04Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/modules/transport.asciidoc", "diffHunk": "@@ -88,19 +88,22 @@ example above:\n    determines the time in seconds that a connection must be idle before\n    starting to send TCP keepalive probes.\n    Only applicable on Linux and Mac, and requires JDK 11 or newer.\n-   Defaults to -1, which does not set this option at the socket level, but\n-   uses default system configuration instead.\n+   Defaults to 60 on applicable configurations, and -1 otherwise, which does", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c860643e2958aa9ed00bb2ce8752b576af4afd"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTA3NDYxMA==", "bodyText": "I would have chosen 60 for the default here I think. The purpose of these keepalives is more to tell any intermediate devices that the connection remains alive rather than to test the health of the connection ourselves, and I don't think that needs a packet every 10s. IMO #59222 is a better way to pick up on failed connections much more quickly in cases where it matters.\nThat said, anything less than the ridiculous default of 7200 is a major improvement anyway.", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r455074610", "createdAt": "2020-07-15T14:00:38Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/modules/transport.asciidoc", "diffHunk": "@@ -88,19 +88,22 @@ example above:\n    determines the time in seconds that a connection must be idle before\n    starting to send TCP keepalive probes.\n    Only applicable on Linux and Mac, and requires JDK 11 or newer.\n-   Defaults to -1, which does not set this option at the socket level, but\n-   uses default system configuration instead.\n+   Defaults to 60 on applicable configurations, and -1 otherwise, which does\n+   not set this option at the socket level, but uses the default system\n+   configuration instead.\n * `tcp.keep_interval`: Configures the `TCP_KEEPINTVL` option for this socket,\n    which determines the time in seconds between sending TCP keepalive probes.\n    Only applicable on Linux and Mac, and requires JDK 11 or newer.\n-   Defaults to -1, which does not set this option at the socket level, but\n-   uses default system configuration instead.\n+   Defaults to 10 on applicable configurations, and -1 otherwise, which does", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05c860643e2958aa9ed00bb2ce8752b576af4afd"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5239fe95b753382aa4e3b90c01d439e7e30cd394", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/5239fe95b753382aa4e3b90c01d439e7e30cd394", "committedDate": "2020-07-16T09:37:35Z", "message": "revise docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1b3bbc7ceb2ac84a2c87c04da06d5af2642ffd4", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1b3bbc7ceb2ac84a2c87c04da06d5af2642ffd4", "committedDate": "2020-07-17T13:28:12Z", "message": "align code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b18d53598806585c6d6a0171551669d295e5d8", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/29b18d53598806585c6d6a0171551669d295e5d8", "committedDate": "2020-07-20T08:03:58Z", "message": "New approach"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33aa5659d91fbb2d18448b8fe61b79816d9425b1", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/33aa5659d91fbb2d18448b8fe61b79816d9425b1", "committedDate": "2020-07-20T09:06:24Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "75c7251973c7def05b241ab93822cc6395566642", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/75c7251973c7def05b241ab93822cc6395566642", "committedDate": "2020-07-20T09:06:45Z", "message": "Merge remote-tracking branch 'elastic/master' into default-keepalive-settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "625ffc0564946bf43e9da28e641f3509081e88c1", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/625ffc0564946bf43e9da28e641f3509081e88c1", "committedDate": "2020-07-20T10:07:43Z", "message": "oh noes, an unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d840b2d6e75f340b7b0d2e4bd3ccde65d60e0e18", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/d840b2d6e75f340b7b0d2e4bd3ccde65d60e0e18", "committedDate": "2020-07-22T14:41:51Z", "message": "reject  values above 5 minutes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/51b46d9af799dae949e491cc4ec4be1446bbeaad", "committedDate": "2020-07-22T14:42:02Z", "message": "Merge remote-tracking branch 'elastic/master' into default-keepalive-settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTUyNDcz", "url": "https://github.com/elastic/elasticsearch/pull/59278#pullrequestreview-453952473", "createdAt": "2020-07-23T09:04:23Z", "commit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwOTowNDoyM1rOG2CIcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QwOToxMjowMlrOG2CYbg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMTIxOQ==", "bodyText": "This bit needs a breaking change tag (and docs in the backport)", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459311219", "createdAt": "2020-07-23T09:04:23Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/common/network/NetworkService.java", "diffHunk": "@@ -51,9 +51,9 @@\n     public static final Setting<Boolean> TCP_KEEP_ALIVE =\n         Setting.boolSetting(\"network.tcp.keep_alive\", true, Property.NodeScope);\n     public static final Setting<Integer> TCP_KEEP_IDLE =\n-        Setting.intSetting(\"network.tcp.keep_idle\", -1, -1, Property.NodeScope);\n+        Setting.intSetting(\"network.tcp.keep_idle\", -1, -1, 300, Property.NodeScope);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjI4Mw==", "bodyText": "ClosedChannelException extends IOException so this is enough:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assert e instanceof IOException || e instanceof ClosedChannelException :\n          \n          \n            \n                        assert e instanceof IOException :", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459312283", "createdAt": "2020-07-23T09:06:21Z", "author": {"login": "DaveCTurner"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n+        assert socketChannel != null;\n+        try {\n+            if (socketChannel.supportedOptions().contains(StandardSocketOptions.SO_KEEPALIVE)) {\n+                final Boolean keepalive = socketChannel.getOption(StandardSocketOptions.SO_KEEPALIVE);\n+                if (keepalive != null && keepalive.booleanValue()) {\n+                    for (SocketOption<Integer> option : Arrays.asList(\n+                        NetUtils.getTcpKeepIdleSocketOptionOrNull(),\n+                        NetUtils.getTcpKeepIntervalSocketOptionOrNull())) {\n+                        setMinValueForSocketOption(socketChannel, option, 300);\n+                    }\n+                }\n+            }\n+        } catch (Exception e) {\n+            assert e instanceof IOException || e instanceof ClosedChannelException :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjczNw==", "bodyText": "Maybe just rethrow e, stack trace and all?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            \"unexpected exception when setting channel option: \" + e.getClass() + \": \" + e.getMessage();\n          \n          \n            \n                            e;", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459312737", "createdAt": "2020-07-23T09:07:16Z", "author": {"login": "DaveCTurner"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n+        assert socketChannel != null;\n+        try {\n+            if (socketChannel.supportedOptions().contains(StandardSocketOptions.SO_KEEPALIVE)) {\n+                final Boolean keepalive = socketChannel.getOption(StandardSocketOptions.SO_KEEPALIVE);\n+                if (keepalive != null && keepalive.booleanValue()) {\n+                    for (SocketOption<Integer> option : Arrays.asList(\n+                        NetUtils.getTcpKeepIdleSocketOptionOrNull(),\n+                        NetUtils.getTcpKeepIntervalSocketOptionOrNull())) {\n+                        setMinValueForSocketOption(socketChannel, option, 300);\n+                    }\n+                }\n+            }\n+        } catch (Exception e) {\n+            assert e instanceof IOException || e instanceof ClosedChannelException :\n+                \"unexpected exception when setting channel option: \" + e.getClass() + \": \" + e.getMessage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjg4OQ==", "bodyText": "Similarly,\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            assert e instanceof IOException || e instanceof ClosedChannelException :\n          \n          \n            \n                            assert e instanceof IOException : e;", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459312889", "createdAt": "2020-07-23T09:07:35Z", "author": {"login": "DaveCTurner"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n+        assert socketChannel != null;\n+        try {\n+            if (socketChannel.supportedOptions().contains(StandardSocketOptions.SO_KEEPALIVE)) {\n+                final Boolean keepalive = socketChannel.getOption(StandardSocketOptions.SO_KEEPALIVE);\n+                if (keepalive != null && keepalive.booleanValue()) {\n+                    for (SocketOption<Integer> option : Arrays.asList(\n+                        NetUtils.getTcpKeepIdleSocketOptionOrNull(),\n+                        NetUtils.getTcpKeepIntervalSocketOptionOrNull())) {\n+                        setMinValueForSocketOption(socketChannel, option, 300);\n+                    }\n+                }\n+            }\n+        } catch (Exception e) {\n+            assert e instanceof IOException || e instanceof ClosedChannelException :\n+                \"unexpected exception when setting channel option: \" + e.getClass() + \": \" + e.getMessage();\n+        }\n+    }\n+\n+    private static void setMinValueForSocketOption(NetworkChannel socketChannel, SocketOption<Integer> option, int minValue) {\n+        if (option != null && socketChannel.supportedOptions().contains(option)) {\n+            try {\n+                final Integer currentIdleVal = socketChannel.getOption(option);\n+                if (currentIdleVal != null && currentIdleVal.intValue() > minValue) {\n+                    socketChannel.setOption(option, minValue);\n+                }\n+            } catch (Exception e) {\n+                // Getting an exception here should be ok when concurrently closing the channel\n+                // An UnsupportedOperationException or IllegalArgumentException, however, should not happen\n+                assert e instanceof IOException || e instanceof ClosedChannelException :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxNTMxMA==", "bodyText": "Naming nit, suggest this instead:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n          \n          \n            \n                public static void tryEnsureReasonableKeepAliveConfig(NetworkChannel socketChannel) {", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459315310", "createdAt": "2020-07-23T09:12:02Z", "author": {"login": "DaveCTurner"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzOTcwMjIz", "url": "https://github.com/elastic/elasticsearch/pull/59278#pullrequestreview-453970223", "createdAt": "2020-07-23T09:30:25Z", "commit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU0NTEzMzMy", "url": "https://github.com/elastic/elasticsearch/pull/59278#pullrequestreview-454513332", "createdAt": "2020-07-23T21:37:56Z", "commit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMTozNzo1NlrOG2cdZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yM1QyMTo0Mjo1M1rOG2cmCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0MjU2NQ==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459742565", "createdAt": "2020-07-23T21:37:56Z", "author": {"login": "tbrooks8"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n+        assert socketChannel != null;\n+        try {\n+            if (socketChannel.supportedOptions().contains(StandardSocketOptions.SO_KEEPALIVE)) {\n+                final Boolean keepalive = socketChannel.getOption(StandardSocketOptions.SO_KEEPALIVE);\n+                if (keepalive != null && keepalive.booleanValue()) {\n+                    for (SocketOption<Integer> option : Arrays.asList(\n+                        NetUtils.getTcpKeepIdleSocketOptionOrNull(),\n+                        NetUtils.getTcpKeepIntervalSocketOptionOrNull())) {\n+                        setMinValueForSocketOption(socketChannel, option, 300);\n+                    }\n+                }\n+            }\n+        } catch (Exception e) {\n+            assert e instanceof IOException || e instanceof ClosedChannelException :\n+                \"unexpected exception when setting channel option: \" + e.getClass() + \": \" + e.getMessage();\n+        }\n+    }\n+\n+    private static void setMinValueForSocketOption(NetworkChannel socketChannel, SocketOption<Integer> option, int minValue) {\n+        if (option != null && socketChannel.supportedOptions().contains(option)) {\n+            try {\n+                final Integer currentIdleVal = socketChannel.getOption(option);\n+                if (currentIdleVal != null && currentIdleVal.intValue() > minValue) {\n+                    socketChannel.setOption(option, minValue);\n+                }\n+            } catch (Exception e) {\n+                // Getting an exception here should be ok when concurrently closing the channel\n+                // An UnsupportedOperationException or IllegalArgumentException, however, should not happen\n+                assert e instanceof IOException || e instanceof ClosedChannelException :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTMxMjg4OQ=="}, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0MzE3OA==", "bodyText": "I understand that you are being safe, but is there a known scenario where the socket option is supported, but the current value is null?", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459743178", "createdAt": "2020-07-23T21:39:24Z", "author": {"login": "tbrooks8"}, "path": "libs/core/src/main/java/org/elasticsearch/core/internal/net/NetUtils.java", "diffHunk": "@@ -59,4 +64,45 @@\n             return null;\n         }\n     }\n+\n+    /**\n+     * If SO_KEEPALIVE is enabled (default), this method ensures sane default values for the extended socket options\n+     * TCP_KEEPIDLE and TCP_KEEPINTERVAL. The default value for TCP_KEEPIDLE is system dependent, but is typically 2 hours.\n+     * Such a high value can result in firewalls eagerly closing these connections. To tell any intermediate devices that\n+     * the connection remains alive, we explicitly set these options to 5 minutes if the defaults are higher than that.\n+     */\n+    public static void setSaneDefaultKeepAliveOptions(NetworkChannel socketChannel) {\n+        assert socketChannel != null;\n+        try {\n+            if (socketChannel.supportedOptions().contains(StandardSocketOptions.SO_KEEPALIVE)) {\n+                final Boolean keepalive = socketChannel.getOption(StandardSocketOptions.SO_KEEPALIVE);\n+                if (keepalive != null && keepalive.booleanValue()) {\n+                    for (SocketOption<Integer> option : Arrays.asList(\n+                        NetUtils.getTcpKeepIdleSocketOptionOrNull(),\n+                        NetUtils.getTcpKeepIntervalSocketOptionOrNull())) {\n+                        setMinValueForSocketOption(socketChannel, option, 300);\n+                    }\n+                }\n+            }\n+        } catch (Exception e) {\n+            assert e instanceof IOException || e instanceof ClosedChannelException :\n+                \"unexpected exception when setting channel option: \" + e.getClass() + \": \" + e.getMessage();\n+        }\n+    }\n+\n+    private static void setMinValueForSocketOption(NetworkChannel socketChannel, SocketOption<Integer> option, int minValue) {\n+        if (option != null && socketChannel.supportedOptions().contains(option)) {\n+            try {\n+                final Integer currentIdleVal = socketChannel.getOption(option);\n+                if (currentIdleVal != null && currentIdleVal.intValue() > minValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTc0NDc3Nw==", "bodyText": "Is the if block so that this does not break in production is assertions are disabled and for some reason there is a scenario where the channel is a different type? Feels like we should just be able to cast after the assertion since this is all Elasticsearch code.", "url": "https://github.com/elastic/elasticsearch/pull/59278#discussion_r459744777", "createdAt": "2020-07-23T21:42:53Z", "author": {"login": "tbrooks8"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/netty4/Netty4Transport.java", "diffHunk": "@@ -311,6 +307,11 @@ protected void stopInternal() {\n \n         @Override\n         protected void initChannel(Channel ch) throws Exception {\n+            addClosedExceptionLogger(ch);\n+            assert ch instanceof Netty4NioSocketChannel;\n+            if (ch instanceof Netty4NioSocketChannel) {\n+                NetUtils.setSaneDefaultKeepAliveOptions(((Netty4NioSocketChannel) ch).javaChannel());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b46d9af799dae949e491cc4ec4be1446bbeaad"}, "originalPosition": 121}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "785e35fbcab2dd8787906e6709fef66954efbe39", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/785e35fbcab2dd8787906e6709fef66954efbe39", "committedDate": "2020-07-27T09:40:58Z", "message": "rework docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5c8faf08bcba2043919d2ba7507f548632cb02b", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5c8faf08bcba2043919d2ba7507f548632cb02b", "committedDate": "2020-07-27T09:42:41Z", "message": "ClosedChannelException subclasses IOException"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9a582ce7fe7340392f7457a98cbcc1e7c30511a", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9a582ce7fe7340392f7457a98cbcc1e7c30511a", "committedDate": "2020-07-27T09:45:03Z", "message": "shorter assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dbe2391e6135ab28686fca959569b227631afe5", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dbe2391e6135ab28686fca959569b227631afe5", "committedDate": "2020-07-27T09:45:53Z", "message": "Naming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "380abcac93d99b88eb965705a9577406da6e6eb9", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/380abcac93d99b88eb965705a9577406da6e6eb9", "committedDate": "2020-07-27T09:49:06Z", "message": "The given socket options won't return null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57f49168fac2837f8b87df55f2efb14558072150", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/57f49168fac2837f8b87df55f2efb14558072150", "committedDate": "2020-07-27T09:52:53Z", "message": "don't be so defensive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e70945bde16c723fb167578a1a690bd0b1efff7", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e70945bde16c723fb167578a1a690bd0b1efff7", "committedDate": "2020-07-27T09:54:55Z", "message": "Merge remote-tracking branch 'elastic/master' into default-keepalive-settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1NjY2MzA2", "url": "https://github.com/elastic/elasticsearch/pull/59278#pullrequestreview-455666306", "createdAt": "2020-07-27T10:36:04Z", "commit": {"oid": "0e70945bde16c723fb167578a1a690bd0b1efff7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2104, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}