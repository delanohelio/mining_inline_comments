{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUzOTQwMTM5", "number": 59939, "title": "Introduce javaRestTest source set/task and convert modules", "bodyText": "Introduce a javaRestTest source set and task to compliment the yamlRestTest.\njavaRestTest differs such that the code is sourced from Java and may have\ndifferent dependencies and setup requirements for the test clusters. This also\nallows the tests to run in parallel in different cluster instances to prevent any\ncross test contamination between the two types of tests.\nIncluded in this PR is all :modules no longer use the integTest task. The tests\nare now driven by test, yamlRestTest, javaRestTest, and internalClusterTest.\nSince only :modules (and :rest-api-spec) have been converted to yamlRestTest\nwe can now disable the integTest task if either yamlRestTest or javaRestTest have\nbeen applied. Once all projects are converted, we can delete the integTest task.\nrelated: #56841\nrelated: #59444", "createdAt": "2020-07-20T23:34:43Z", "url": "https://github.com/elastic/elasticsearch/pull/59939", "merged": true, "mergeCommit": {"oid": "7dd57c9415a702f0f608dba0a38b54a99c85d405"}, "closed": true, "closedAt": "2020-07-21T22:17:18Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc25ZcDAH2gAyNDUzOTQwMTM5OmE2NTkxNGM5ZDU4OGQwMzBhNzgwYjc5NmYxYzRhYWRjZTA3Njg3OTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3NVTUgFqTQ1Mjg1MTYyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a65914c9d588d030a780b796f1c4aadce0768797", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/a65914c9d588d030a780b796f1c4aadce0768797", "committedDate": "2020-07-20T22:30:22Z", "message": "new javaRestTest plugin and 1/2 modules converted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45bf3d85a0756b528cb26e04c01d41766a0b5b71", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/45bf3d85a0756b528cb26e04c01d41766a0b5b71", "committedDate": "2020-07-20T23:33:13Z", "message": "should all work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/319d6fac4b71d76dccd37fa44e73f0176f7aa70f", "committedDate": "2020-07-21T12:53:13Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNDg4OTM0", "url": "https://github.com/elastic/elasticsearch/pull/59939#pullrequestreview-452488934", "createdAt": "2020-07-21T14:02:15Z", "commit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDowMjoxNVrOG05fHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNDowMjoxNVrOG05fHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMDk4OA==", "bodyText": "this was pulled from YamlRestTestPlugin so it can be reused with JavaRestTestPlugin. There are no substantive changes introduced here ... just copy/pasted.", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458120988", "createdAt": "2020-07-21T14:02:15Z", "author": {"login": "jakelandis"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/AbstractRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Helper parent to configure the necessary tasks and dependencies.\n+ */\n+public abstract class AbstractRestTestPlugin implements Plugin<Project> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyNzMwODU1", "url": "https://github.com/elastic/elasticsearch/pull/59939#pullrequestreview-452730855", "createdAt": "2020-07-21T18:39:36Z", "commit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODozOTozN1rOG1FBgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxODo0NjoyNVrOG1FQVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMDAxOQ==", "bodyText": "nit: space after if\nHowever, should the integTest task be disabled through onlyIf? There is no guarantee the plugins checked for here will be applied before esplugin.", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458310019", "createdAt": "2020-07-21T18:39:37Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if(project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODMxMzgxNA==", "bodyText": "Dont' we still need this system property for test?", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458313814", "createdAt": "2020-07-21T18:46:25Z", "author": {"login": "rjernst"}, "path": "modules/transport-netty4/build.gradle", "diffHunk": "@@ -55,15 +59,15 @@ tasks.named(\"dependencyLicenses\").configure {\n   mapping from: /netty-.*/, to: 'netty'\n }\n \n-test {\n+internalClusterTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5e45728ec18fa707685582cc0db065d45591f59", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5e45728ec18fa707685582cc0db065d45591f59", "committedDate": "2020-07-21T19:08:14Z", "message": "minor review changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODEzNDg3", "url": "https://github.com/elastic/elasticsearch/pull/59939#pullrequestreview-452813487", "createdAt": "2020-07-21T20:42:22Z", "commit": {"oid": "d5e45728ec18fa707685582cc0db065d45591f59"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDo0MjoyMlrOG1JAsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQyMDo0NjowMVrOG1JH8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NTM0Ng==", "bodyText": "Let's not use afterEvaluate + hasPlugin. This is subject to configuration ordering. Let's instead move this outside of afterEvaluate and just use withPlugin to disable that integTest task whenever either of these plugins is applied.", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458375346", "createdAt": "2020-07-21T20:42:22Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if (project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5e45728ec18fa707685582cc0db065d45591f59"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NjM1OA==", "bodyText": "All these methods can be static and therefore live in a utility class rather than an abstract class that must be extended.", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458376358", "createdAt": "2020-07-21T20:44:25Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/rest/AbstractRestTestPlugin.java", "diffHunk": "@@ -0,0 +1,104 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.test.rest;\n+\n+import org.elasticsearch.gradle.VersionProperties;\n+import org.elasticsearch.gradle.info.BuildParams;\n+import org.elasticsearch.gradle.plugin.PluginPropertiesExtension;\n+import org.elasticsearch.gradle.test.RestIntegTestTask;\n+import org.elasticsearch.gradle.testclusters.RestTestRunnerTask;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.plugins.JavaBasePlugin;\n+import org.gradle.api.tasks.SourceSet;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+/**\n+ * Helper parent to configure the necessary tasks and dependencies.\n+ */\n+public abstract class AbstractRestTestPlugin implements Plugin<Project> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODEyMDk4OA=="}, "originalCommit": {"oid": "319d6fac4b71d76dccd37fa44e73f0176f7aa70f"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODM3NzIwMQ==", "bodyText": "So this doesn't actually remove this task, we simply disable it in a central location to remove noise from build scripts. What's keeping us from actually getting rid of this altogether?", "url": "https://github.com/elastic/elasticsearch/pull/59939#discussion_r458377201", "createdAt": "2020-07-21T20:46:01Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -115,6 +115,11 @@ class PluginBuildPlugin implements Plugin<Project> {\n             if (isModule == false || isXPackModule) {\n                 addNoticeGeneration(project, extension1)\n             }\n+            if (project.pluginManager.hasPlugin(\"elasticsearch.yaml-rest-test\")\n+                || project.pluginManager.hasPlugin(\"elasticsearch.java-rest-test\")) {\n+                //disable integTest task if project has been converted to use yaml or java rest test plugin\n+                project.tasks.integTest.enabled = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d5e45728ec18fa707685582cc0db065d45591f59"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01521f972fc1d79ca201ce7e3f14ef1444f24626", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/01521f972fc1d79ca201ce7e3f14ef1444f24626", "committedDate": "2020-07-21T21:09:59Z", "message": "withPlugin and static methods"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyODUxNjIy", "url": "https://github.com/elastic/elasticsearch/pull/59939#pullrequestreview-452851622", "createdAt": "2020-07-21T21:43:58Z", "commit": {"oid": "01521f972fc1d79ca201ce7e3f14ef1444f24626"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4145, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}