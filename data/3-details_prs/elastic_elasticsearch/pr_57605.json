{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjQ3MDE4", "number": 57605, "title": "SQL: handle MIN and MAX functions on dates in Painless scripts", "bodyText": "MIN and MAX aggregate functions on date fields natively generate a number which, when used in Painless scripts, should be converted to a date/datetime. This used to work in the past, but was broken in more recent versions. Not having tests for this type of query didn't help either. This PR re-adds the date/datetime conversion back in aggregate scripts and adds tests. The solution is not ideal, but until the SQL specific scripts handling in QL is not made pluggable, the current approach is a quick fix.\nFixes #57581.", "createdAt": "2020-06-03T14:38:26Z", "url": "https://github.com/elastic/elasticsearch/pull/57605", "merged": true, "mergeCommit": {"oid": "f1de99e2a6fbf3806c4f2b6b809738aa8faa2d75"}, "closed": true, "closedAt": "2020-06-09T05:39:48Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnqXYmgH2gAyNDI3MjQ3MDE4OjM1MDcwMTgxOTI5MDY1ZDBiNGQ3YTU3MTBmYmRmZDg2NzhlMmY5ZmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoPx3rAFqTQyNTE2ODAyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "35070181929065d0b4d7a5710fbdfd8678e2f9fb", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/35070181929065d0b4d7a5710fbdfd8678e2f9fb", "committedDate": "2020-06-03T14:30:41Z", "message": "Convert to date/datetime the result of numeric aggregations (min, max)\nin Painless scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6a4d6730157fdf37e48c8deadaa7b9372651c36", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6a4d6730157fdf37e48c8deadaa7b9372651c36", "committedDate": "2020-06-03T14:30:58Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 57581_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjI5MzM5", "url": "https://github.com/elastic/elasticsearch/pull/57605#pullrequestreview-423629339", "createdAt": "2020-06-03T14:46:43Z", "commit": {"oid": "f6a4d6730157fdf37e48c8deadaa7b9372651c36"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0Njo0M1rOGefXQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNDo0Njo0M1rOGefXQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDYyNDMyMQ==", "bodyText": "Shouldn't we remove this method as currently there is no such case that a groupingfunction (actually histogram) results into a script?", "url": "https://github.com/elastic/elasticsearch/pull/57605#discussion_r434624321", "createdAt": "2020-06-03T14:46:43Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/expression/function/scalar/ScalarFunction.java", "diffHunk": "@@ -108,19 +109,28 @@ protected ScriptTemplate scriptWithScalar(ScalarFunction scalar) {\n     }\n     \n     protected ScriptTemplate scriptWithAggregate(AggregateFunction aggregate) {\n-        String template = \"{}\";\n+        String template = basicTemplate(aggregate);\n         return new ScriptTemplate(processScript(template),\n                 paramsBuilder().agg(aggregate).build(),\n                 dataType());\n     }\n \n     protected ScriptTemplate scriptWithGrouping(GroupingFunction grouping) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a4d6730157fdf37e48c8deadaa7b9372651c36"}, "originalPosition": 19}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0Mzc5NTUx", "url": "https://github.com/elastic/elasticsearch/pull/57605#pullrequestreview-424379551", "createdAt": "2020-06-04T12:14:31Z", "commit": {"oid": "f6a4d6730157fdf37e48c8deadaa7b9372651c36"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59d2a2a34c1161c8ece24009f9ab66974aa5f501", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/59d2a2a34c1161c8ece24009f9ab66974aa5f501", "committedDate": "2020-06-05T07:47:35Z", "message": "Added method comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63a8727bc7fd468af6dd9a5fd4c11f66d77e330a", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/63a8727bc7fd468af6dd9a5fd4c11f66d77e330a", "committedDate": "2020-06-05T07:48:00Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 57581_fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MTY4MDIy", "url": "https://github.com/elastic/elasticsearch/pull/57605#pullrequestreview-425168022", "createdAt": "2020-06-05T10:06:06Z", "commit": {"oid": "63a8727bc7fd468af6dd9a5fd4c11f66d77e330a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3842, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}