{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MzcxMzk5", "number": 56556, "title": "Watcher dont add watches post index if stopped", "bodyText": "Watcher adds watches to the trigger service on the postIndex action\nfor the .watches index. This has the (intentional) side effect of also\nadding the watches to the stats. The tests rely on these stats for their\nassertions. The tests also start and stop Watcher between each test for\na clean slate.\nWhen Watcher executes it updates the .watches index and upon this update\nit will go through the postIndex method and end up added that watch to the\ntrigger service (and stats). Functionally this is not a problem, if Watcher\nis stopping or stopped since Watcher is also paused and will not execute\nthe watch. However, with specific timing and expectations of a clean slate\ncan cause issues the test assertions against the stats.\nThis commit ensures that the postIndex action only adds to the trigger service\nif the Watcher state is not stopping or stopped. When started back up it will\nre-read index .watches.\nThis commit also un-mutes the tests related to #53177 and #56534", "createdAt": "2020-05-11T22:00:17Z", "url": "https://github.com/elastic/elasticsearch/pull/56556", "merged": true, "mergeCommit": {"oid": "5aa36efa2dc10a6936cad138af457c2228a36b51"}, "closed": true, "closedAt": "2020-05-12T17:56:35Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgW6aFAH2gAyNDE2MzcxMzk5OjA3OTQ0NzMzNWVkMDY5ZWU1MzU4YWYxMGZhYTEyZWJlYWUyMTM2OWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgkI27gFqTQxMDAzMDM3MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "079447335ed069ee5358af10faa12ebeae21369e", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/079447335ed069ee5358af10faa12ebeae21369e", "committedDate": "2020-05-11T21:53:22Z", "message": "don't allow adding to the trigger service if stopping or stopped"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c555e3eb1b619b3dea7e05bdb31d46b9c00d29a5", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/c555e3eb1b619b3dea7e05bdb31d46b9c00d29a5", "committedDate": "2020-05-11T21:55:16Z", "message": "un-mute tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbee35f76a4a690f4782ded15bc8399eef98ba34", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbee35f76a4a690f4782ded15bc8399eef98ba34", "committedDate": "2020-05-11T22:12:42Z", "message": "fix test compile and checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88bb906be0ddafd21622697501af0356110aa170", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/88bb906be0ddafd21622697501af0356110aa170", "committedDate": "2020-05-11T22:25:24Z", "message": "more checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df2246b3d404f59d1c3baa51056d7014cd6001d3", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/df2246b3d404f59d1c3baa51056d7014cd6001d3", "committedDate": "2020-05-11T22:44:41Z", "message": "another checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTgzNzYw", "url": "https://github.com/elastic/elasticsearch/pull/56556#pullrequestreview-409583760", "createdAt": "2020-05-11T22:47:40Z", "commit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0Nzo0MVrOGTwCFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0Nzo0MVrOGTwCFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzA5NQ==", "bodyText": "Need a live view of the state, but I didn't want to expose the actual reference to avoid the ability to set the state.", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363095", "createdAt": "2020-05-11T22:47:41Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java", "diffHunk": "@@ -203,7 +204,7 @@ private boolean clearAllocationIds() {\n         return previousShardRoutings.get();\n     }\n \n-    public WatcherState getState() {\n-        return state.get();\n+    public Supplier<WatcherState> getState(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTg0MTA1", "url": "https://github.com/elastic/elasticsearch/pull/56556#pullrequestreview-409584105", "createdAt": "2020-05-11T22:48:30Z", "commit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0ODozMFrOGTwDQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0ODozMFrOGTwDQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MzM5Mg==", "bodyText": "I manually tested that when the service is stopped, and you add a new watch, it does indeed get added (as expected) upon startup.", "url": "https://github.com/elastic/elasticsearch/pull/56556#discussion_r423363392", "createdAt": "2020-05-11T22:48:30Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherIndexingListener.java", "diffHunk": "@@ -119,8 +124,8 @@ public void postIndex(ShardId shardId, Engine.Index operation, Engine.IndexResul\n                 }\n \n                 boolean shouldBeTriggered = shardAllocationConfiguration.shouldBeTriggered(watch.id());\n-                if (shouldBeTriggered) {\n-                    if (watch.status().state().isActive()) {\n+                if (shouldBeTriggered && EnumSet.of(WatcherState.STOPPING, WatcherState.STOPPED).contains(watcherState.get()) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88bb906be0ddafd21622697501af0356110aa170"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4", "committedDate": "2020-05-11T23:03:54Z", "message": "log message and test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDMwMzcx", "url": "https://github.com/elastic/elasticsearch/pull/56556#pullrequestreview-410030371", "createdAt": "2020-05-12T13:17:55Z", "commit": {"oid": "3e65e9b9f2f4a9ab46f4f76846a93064e94c0df4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 172, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}