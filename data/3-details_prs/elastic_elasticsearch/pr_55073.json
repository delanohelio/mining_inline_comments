{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxOTYxMjkz", "number": 55073, "title": "Define aarch64 packaging test tasks", "bodyText": "We added tasks to build an ARM distribution and Docker image, but didn't\nprovide any way to run packaging tests against them. Add extra loops on\nthe possible Architecture values, and skip tasks that can't be run on\nthe current Architecture.\nPart of #54925.", "createdAt": "2020-04-10T15:46:56Z", "url": "https://github.com/elastic/elasticsearch/pull/55073", "merged": true, "mergeCommit": {"oid": "a45b4eb809113de6a57aa4c86fde2e31909040d0"}, "closed": true, "closedAt": "2020-04-15T11:12:08Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcWS74lgH2gAyNDAxOTYxMjkzOmU1ZmRiOGEwODMxYmU0N2RlZjIwMzhhMTJiOTU4YmJkZDUzMjczMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX1bPoAH2gAyNDAxOTYxMjkzOmVlNGZmZWExOWViNGVkMDRiZTc1NjgzYWFlMTdlOWQ4YmY5YmY1ZjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e5fdb8a0831be47def2038a12b958bbdd5327313", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5fdb8a0831be47def2038a12b958bbdd5327313", "committedDate": "2020-04-10T15:36:07Z", "message": "Define aarch64 packaging test tasks\n\nWe added tasks to build an ARM distribution and Docker image, but didn't\nprovide any way to run packaging tests against them. Add extra loops on\nthe possible Architecture values, and skip tasks that can't be run on\nthe current Architecture."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24f0eb9d1dd37359201ec4e2fe2d30ba90000e4b", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/24f0eb9d1dd37359201ec4e2fe2d30ba90000e4b", "committedDate": "2020-04-13T08:51:08Z", "message": "Don't define non-x86 non-bundled JDK tasks\n\nAlso rename some boolean getters to have names that reflect the return\ntype, since it makes the resulting code clearer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21a723a46b01670976f299a0a9165ceb151e6ab9", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/21a723a46b01670976f299a0a9165ceb151e6ab9", "committedDate": "2020-04-13T09:02:00Z", "message": "Merge remote-tracking branch 'upstream/master' into aarch64-packaging-test-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4e3f82ce5a7a68155fe63bc19ba9bcde1091510", "committedDate": "2020-04-13T10:19:32Z", "message": "Configure arch in distribution-download/subproj"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMzY3OTIx", "url": "https://github.com/elastic/elasticsearch/pull/55073#pullrequestreview-392367921", "createdAt": "2020-04-13T19:13:31Z", "commit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxOToxMzozMVrOGExtWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxOToyOTo1OVrOGEyPmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MTkxMg==", "bodyText": "The implementation is complicated by the fact that we're inconsistent regarding where the distribution architecture appears in the name\n\nWe should make this consistent then. My preference would be for the convention we take with the :archives project with the arch being a suffix. We should rename the docker and packages subprojects to match that convention so things are consisten IMO. @jasontedor thoughts?", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407661912", "createdAt": "2020-04-13T19:13:31Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -285,23 +285,52 @@ private static String distributionProjectPath(ElasticsearchDistribution distribu\n         return projectPath;\n     }\n \n+    /**\n+     * Works out the gradle project name that provides a distribution artifact. The implementation is\n+     * complicated by the fact that we're inconsistent regarding where the distribution architecture\n+     * appears in the name, and whether a distribution even exists for non-x86 architectures.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2MzMzOQ==", "bodyText": "I think one thing for not originally naming this \"has\" is that we configure one of these when we request a distribution and so the naming there makes a bit less sense when the context is that we are asking for a distribution w/ or w/o a bundled JDK.", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407663339", "createdAt": "2020-04-13T19:16:18Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -182,22 +184,30 @@ public void setFlavor(Flavor flavor) {\n         this.flavor.set(flavor);\n     }\n \n-    public boolean getBundledJdk() {\n+    public boolean hasBundledJdk() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2NDU3Mg==", "bodyText": "Again, this isn't only a description of the distribution, we configure this to ask for a distribution. So in that context we are telling the build to fail or not.\nI think in this case we can just make this getter private. It's only used here locally and nothing else should be inspecting this properly. Whatever we do we should make the getter and setter the same name though, even if the getter is private.", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407664572", "createdAt": "2020-04-13T19:18:39Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -182,22 +184,30 @@ public void setFlavor(Flavor flavor) {\n         this.flavor.set(flavor);\n     }\n \n-    public boolean getBundledJdk() {\n+    public boolean hasBundledJdk() {\n         return bundledJdk.getOrElse(true);\n     }\n \n     public void setBundledJdk(Boolean bundledJdk) {\n         this.bundledJdk.set(bundledJdk);\n     }\n \n-    public boolean getFailIfUnavailable() {\n+    public boolean shouldFailIfUnavailable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2NzM1OQ==", "bodyText": "FYI, you can add multiple onlyIf conditions, which I think i easier to reason about than having a single more complex conditional. Basically I only run this task if \"docker works\" and \"it's the right architecture\".", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407667359", "createdAt": "2020-04-13T19:23:39Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -346,8 +349,14 @@ public String toString() {\n         Provider<DockerSupportService> dockerSupport\n     ) {\n         return project.getTasks().register(destructiveDistroTestTaskName(distribution), Test.class, t -> {\n+            // Only run tests for the current architecture\n             // Disable Docker distribution tests unless a Docker installation is available\n-            t.onlyIf(t2 -> distribution.getType() != Type.DOCKER || dockerSupport.get().getDockerAvailability().isAvailable);\n+            t.onlyIf(t2 -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY2ODk2Mw==", "bodyText": "I'd like clarification on this. Why wouldn't we? One main difference between the archives is the version of the bundled JDK but there are other differences (config changes, eventually ml binaries, etc). @jasontedor what's the rationale for offering a no-jdk distro for x86 but not arm?", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407668963", "createdAt": "2020-04-13T19:26:46Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -381,47 +390,68 @@ public String toString() {\n         List<ElasticsearchDistribution> currentDistros = new ArrayList<>();\n         List<ElasticsearchDistribution> upgradeDistros = new ArrayList<>();\n \n-        for (Type type : List.of(Type.DEB, Type.RPM, Type.DOCKER)) {\n-            for (Flavor flavor : Flavor.values()) {\n-                for (boolean bundledJdk : Arrays.asList(true, false)) {\n-                    // All our Docker images include a bundled JDK so it doesn't make sense to test without one\n-                    boolean skip = type == Type.DOCKER && bundledJdk == false;\n-\n-                    if (skip == false) {\n-                        addDistro(distributions, type, null, flavor, bundledJdk, VersionProperties.getElasticsearch(), currentDistros);\n+        for (Architecture architecture : Architecture.values()) {\n+            for (Type type : List.of(Type.DEB, Type.RPM, Type.DOCKER)) {\n+                for (Flavor flavor : Flavor.values()) {\n+                    for (boolean bundledJdk : Arrays.asList(true, false)) {\n+                        // All our Docker images include a bundled JDK so it doesn't make sense to test without one.\n+                        // Also we'll never publish an ARM (aarch64) build without a bundled JDK.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDEwOQ==", "bodyText": "Hmmm, don't we already have an issue where this blows up if we don't have Docker installed?", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670109", "createdAt": "2020-04-13T19:29:02Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -236,6 +239,8 @@ subprojects { Project subProject ->\n \n     exportDockerImageTask.dependsOn(parent.tasks.getByName(buildTaskName))\n \n+    exportDockerImageTask.onlyIf { Architecture.current().name().toLowerCase().equals(architecture) }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDUwOA==", "bodyText": "Should this technically use the current architecture instead of being hard-coded to x86?", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670508", "createdAt": "2020-04-13T19:29:43Z", "author": {"login": "mark-vieira"}, "path": "qa/remote-clusters/build.gradle", "diffHunk": "@@ -42,6 +44,7 @@ task copyKeystore(type: Sync) {\n elasticsearch_distributions {\n   docker {\n     type = 'docker'\n+    architecture = Architecture.X64", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzY3MDY4MQ==", "bodyText": "Same as above. Why not use current arch?", "url": "https://github.com/elastic/elasticsearch/pull/55073#discussion_r407670681", "createdAt": "2020-04-13T19:29:59Z", "author": {"login": "mark-vieira"}, "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -55,6 +56,7 @@ war {\n elasticsearch_distributions {\n   docker {\n     type = 'docker'\n+    architecture = Architecture.X64", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f4e3f82ce5a7a68155fe63bc19ba9bcde1091510"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfba5915cf478a5a66beb3ef4ac6dd83b994d5ab", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfba5915cf478a5a66beb3ef4ac6dd83b994d5ab", "committedDate": "2020-04-14T10:56:55Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDQ2MjQ0", "url": "https://github.com/elastic/elasticsearch/pull/55073#pullrequestreview-393046244", "createdAt": "2020-04-14T15:31:43Z", "commit": {"oid": "dfba5915cf478a5a66beb3ef4ac6dd83b994d5ab"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5385a77849ad23118cfe434b82df8b6b52e0e0c5", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/5385a77849ad23118cfe434b82df8b6b52e0e0c5", "committedDate": "2020-04-14T21:11:27Z", "message": "Merge remote-tracking branch 'upstream/master' into aarch64-packaging-test-tasks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee4ffea19eb4ed04be75683aae17e9d8bf9bf5f6", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee4ffea19eb4ed04be75683aae17e9d8bf9bf5f6", "committedDate": "2020-04-15T10:21:04Z", "message": "Updates and polishing after master merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3464, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}