{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MTY2NjMz", "number": 53468, "title": "Add support for distance queries on shape queries", "bodyText": "With the upgrade to Lucene 8.5, XYShape field has support for distance queries. This change implements this new feature and removes the limitation.\nIn addition the strategy for building queries is changed as Lucene adds a new interface method called XYShape.newGeometryQuery that takes an array of Lucene geometries. This allows the query engine to build the most efficient query for the given parameters. For example an intersect query with a geometry collection currently creates one query per geometry. With this change, the engine can build just one query with all geometries.", "createdAt": "2020-03-12T10:40:51Z", "url": "https://github.com/elastic/elasticsearch/pull/53468", "merged": true, "mergeCommit": {"oid": "112ae9cb1796737e6b4d92caf17965c7cfed0f6f"}, "closed": true, "closedAt": "2020-03-19T13:27:39Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM5R8tAH2gAyMzg3MTY2NjMzOjYwNWY2OWIwZTJmODRhMTdhNzQwYTA4MzE0N2VkZjdjZTAxZjcwZDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcPJVkXgH2gAyMzg3MTY2NjMzOjkyNzY4YjQ4MTY0M2JkOWZmMjJkZDNiYzU3MjA3MTdjZDYxMzE1MTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "605f69b0e2f84a17a740a083147edf7ce01f70d5", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/605f69b0e2f84a17a740a083147edf7ce01f70d5", "committedDate": "2020-03-12T10:37:22Z", "message": "Add support for distance queries on shape queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDQ1NDg0", "url": "https://github.com/elastic/elasticsearch/pull/53468#pullrequestreview-373445484", "createdAt": "2020-03-12T10:42:07Z", "commit": {"oid": "605f69b0e2f84a17a740a083147edf7ce01f70d5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo0MjowN1rOF1ZYEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMDo0MjowN1rOF1ZYEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDYxMQ==", "bodyText": "It seems our circle interface does not really support cartesian circles.", "url": "https://github.com/elastic/elasticsearch/pull/53468#discussion_r391534611", "createdAt": "2020-03-12T10:42:07Z", "author": {"login": "iverase"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/ShapeUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.spatial.index.mapper;\n+\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Line;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Polygon;\n+import org.elasticsearch.geometry.Rectangle;\n+\n+\n+/**\n+ * Utility class that transforms Elasticsearch geometry objects to the Lucene representation\n+ */\n+public class ShapeUtils {\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Polygon polygon) {\n+        org.apache.lucene.geo.XYPolygon[] holes = new org.apache.lucene.geo.XYPolygon[polygon.getNumberOfHoles()];\n+        for(int i = 0; i<holes.length; i++) {\n+            holes[i] = new org.apache.lucene.geo.XYPolygon(\n+                doubleArrayToFloatArray(polygon.getHole(i).getX()),\n+                doubleArrayToFloatArray(polygon.getHole(i).getY()));\n+        }\n+        return new org.apache.lucene.geo.XYPolygon(\n+            doubleArrayToFloatArray(polygon.getPolygon().getX()),\n+            doubleArrayToFloatArray(polygon.getPolygon().getY()), holes);\n+    }\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Rectangle r) {\n+        return new org.apache.lucene.geo.XYPolygon(\n+            new float[]{(float) r.getMinX(), (float) r.getMaxX(), (float) r.getMaxX(), (float) r.getMinX(), (float) r.getMinX()},\n+            new float[]{(float) r.getMinY(), (float) r.getMinY(), (float) r.getMaxY(), (float) r.getMaxY(), (float) r.getMinY()});\n+    }\n+\n+    public static org.apache.lucene.geo.XYRectangle toLuceneXYRectangle(Rectangle r) {\n+        return new org.apache.lucene.geo.XYRectangle((float) r.getMinX(), (float) r.getMaxX(),\n+                                                     (float) r.getMinY(), (float) r.getMaxY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYPoint toLuceneXYPoint(Point point) {\n+        return new org.apache.lucene.geo.XYPoint((float) point.getX(), (float) point.getY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYLine toLuceneXYLine(Line line) {\n+        return new org.apache.lucene.geo.XYLine(\n+            doubleArrayToFloatArray(line.getX()),\n+            doubleArrayToFloatArray(line.getY()));\n+    }\n+\n+    public static org.apache.lucene.geo.XYCircle toLuceneXYCircle(Circle circle) {\n+        return new org.apache.lucene.geo.XYCircle((float) circle.getX(), (float) circle.getY(), (float) circle.getRadiusMeters());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "605f69b0e2f84a17a740a083147edf7ce01f70d5"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82218d720825168ca326ea48dc0618fac38298e1", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/82218d720825168ca326ea48dc0618fac38298e1", "committedDate": "2020-03-12T14:26:28Z", "message": "Merge branch 'master' into ShapeCircle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NjEzNzgy", "url": "https://github.com/elastic/elasticsearch/pull/53468#pullrequestreview-374613782", "createdAt": "2020-03-13T20:53:44Z", "commit": {"oid": "82218d720825168ca326ea48dc0618fac38298e1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDo1Mzo0NFrOF2SdeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QyMDo1Mzo0NFrOF2SdeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjQ2OTg4MQ==", "bodyText": "Yeah, it is a bit misleading to have the Geometry API specify the circle radius as getRadiusMeters. Probably worth a clean up in another PR. /cc @imotov", "url": "https://github.com/elastic/elasticsearch/pull/53468#discussion_r392469881", "createdAt": "2020-03-13T20:53:44Z", "author": {"login": "nknize"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/index/mapper/ShapeUtils.java", "diffHunk": "@@ -0,0 +1,68 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.spatial.index.mapper;\n+\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Line;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Polygon;\n+import org.elasticsearch.geometry.Rectangle;\n+\n+\n+/**\n+ * Utility class that transforms Elasticsearch geometry objects to the Lucene representation\n+ */\n+public class ShapeUtils {\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Polygon polygon) {\n+        org.apache.lucene.geo.XYPolygon[] holes = new org.apache.lucene.geo.XYPolygon[polygon.getNumberOfHoles()];\n+        for(int i = 0; i<holes.length; i++) {\n+            holes[i] = new org.apache.lucene.geo.XYPolygon(\n+                doubleArrayToFloatArray(polygon.getHole(i).getX()),\n+                doubleArrayToFloatArray(polygon.getHole(i).getY()));\n+        }\n+        return new org.apache.lucene.geo.XYPolygon(\n+            doubleArrayToFloatArray(polygon.getPolygon().getX()),\n+            doubleArrayToFloatArray(polygon.getPolygon().getY()), holes);\n+    }\n+\n+    public static org.apache.lucene.geo.XYPolygon toLuceneXYPolygon(Rectangle r) {\n+        return new org.apache.lucene.geo.XYPolygon(\n+            new float[]{(float) r.getMinX(), (float) r.getMaxX(), (float) r.getMaxX(), (float) r.getMinX(), (float) r.getMinX()},\n+            new float[]{(float) r.getMinY(), (float) r.getMinY(), (float) r.getMaxY(), (float) r.getMaxY(), (float) r.getMinY()});\n+    }\n+\n+    public static org.apache.lucene.geo.XYRectangle toLuceneXYRectangle(Rectangle r) {\n+        return new org.apache.lucene.geo.XYRectangle((float) r.getMinX(), (float) r.getMaxX(),\n+                                                     (float) r.getMinY(), (float) r.getMaxY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYPoint toLuceneXYPoint(Point point) {\n+        return new org.apache.lucene.geo.XYPoint((float) point.getX(), (float) point.getY());\n+    }\n+\n+    public static org.apache.lucene.geo.XYLine toLuceneXYLine(Line line) {\n+        return new org.apache.lucene.geo.XYLine(\n+            doubleArrayToFloatArray(line.getX()),\n+            doubleArrayToFloatArray(line.getY()));\n+    }\n+\n+    public static org.apache.lucene.geo.XYCircle toLuceneXYCircle(Circle circle) {\n+        return new org.apache.lucene.geo.XYCircle((float) circle.getX(), (float) circle.getY(), (float) circle.getRadiusMeters());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTUzNDYxMQ=="}, "originalCommit": {"oid": "605f69b0e2f84a17a740a083147edf7ce01f70d5"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92768b481643bd9ff22dd3bc5720717cd6131516", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/92768b481643bd9ff22dd3bc5720717cd6131516", "committedDate": "2020-03-19T10:27:39Z", "message": "Merge branch 'master' into shapeCircle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1547, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}