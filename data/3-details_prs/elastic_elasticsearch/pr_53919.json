{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxODczOTIx", "number": 53919, "title": "Use Azure Bulk Deletes in Azure Repository", "bodyText": "Now that we upgraded the Azure SDK in #53865 we can start using bulk deletes like we do with S3 and GCS.", "createdAt": "2020-03-21T15:36:35Z", "url": "https://github.com/elastic/elasticsearch/pull/53919", "merged": true, "mergeCommit": {"oid": "23cccf088810b8416ed278571352393cc2de9523"}, "closed": true, "closedAt": "2020-03-23T11:22:38Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcPmm82gH2gAyMzkxODczOTIxOmUwNGQ4ZDVmOTNmNzgyZDVhN2NlYzc3NzE4NzEyZDU5ODVlMDQyNTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQbpd4AH2gAyMzkxODczOTIxOmE5MzNjMmQxZmE2ZTdiMWIyYTdhMTUyYWM0N2Y3NzNkMjEwYjkzNzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e04d8d5f93f782d5a7cec77718712d5985e04257", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e04d8d5f93f782d5a7cec77718712d5985e04257", "committedDate": "2020-03-20T20:33:53Z", "message": "Fix Azure Repository with HTTPs Endpoint\n\nUpgrading to 8.6.2 in #53865 broke running against HTTPs endpoints (and hence real azure)\nbecause the https url connection needs the newly added permission to work."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa3e01d3deb8ea8150ab113866d4a6d8379ed6de", "committedDate": "2020-03-21T15:34:10Z", "message": "Use Azure Repository Bulk Deletes\n\nNow that we upgraded the Azure SDK to 8.6.2 we can make use of\nbulk deletes."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTI3Mjcx", "url": "https://github.com/elastic/elasticsearch/pull/53919#pullrequestreview-378927271", "createdAt": "2020-03-21T15:38:08Z", "commit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTozODowOFrOF5qEcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTozODowOFrOF5qEcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjQxNg==", "bodyText": "No need to deprecate here. We have never documented this threadpool and it was always seen as an internal setting.\nHaving it set will not prevent ES from starting up cleanly so I don't see anyone getting hurt here.", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396002416", "createdAt": "2020-03-21T15:38:08Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureRepositoryPlugin.java", "diffHunk": "@@ -80,15 +74,6 @@ AzureStorageService createAzureStoreService(final Settings settings) {\n         );\n     }\n \n-    @Override\n-    public List<ExecutorBuilder<?>> getExecutorBuilders(Settings settings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "originalPosition": 31}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTI3NDM5", "url": "https://github.com/elastic/elasticsearch/pull/53919#pullrequestreview-378927439", "createdAt": "2020-03-21T15:40:17Z", "commit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTo0MDoxN1rOF5qFHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTo0MDoxN1rOF5qFHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjU4OQ==", "bodyText": "Since we needed the request body again I refactored things like we did for the other mocks to full drain the input first thing here as well to keep things simple.", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396002589", "createdAt": "2020-03-21T15:40:17Z", "author": {"login": "original-brownbear"}, "path": "test/fixtures/azure-fixture/src/main/java/fixture/azure/AzureHttpHandler.java", "diffHunk": "@@ -67,18 +72,21 @@ public void handle(final HttpExchange exchange) throws IOException {\n             assert read == -1 : \"Request body should have been empty but saw [\" + read + \"]\";\n         }\n         try {\n+            // Request body is closed in the finally block\n+            final BytesReference requestBody = Streams.readFully(Streams.noCloseStream(exchange.getRequestBody()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc4OTI3NDg5", "url": "https://github.com/elastic/elasticsearch/pull/53919#pullrequestreview-378927489", "createdAt": "2020-03-21T15:40:56Z", "commit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTo0MDo1NlrOF5qFUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMVQxNTo0MDo1NlrOF5qFUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjAwMjY0Mw==", "bodyText": "From #53903 this will go away once #53903 is merged, I just set it to be able to run 3rd party tests locally and verify this actually works now.", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396002643", "createdAt": "2020-03-21T15:40:56Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/plugin-metadata/plugin-security.policy", "diffHunk": "@@ -20,4 +20,5 @@\n grant {\n   // azure client opens socket connections for to access repository\n   permission java.net.SocketPermission \"*\", \"connect\";\n+  permission java.lang.RuntimePermission \"setFactory\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aa3e01d3deb8ea8150ab113866d4a6d8379ed6de"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/145569833c91e08a36f6880b3c26c48444c1c20d", "committedDate": "2020-03-21T15:42:11Z", "message": "shorter diff"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5MjIxMzc0", "url": "https://github.com/elastic/elasticsearch/pull/53919#pullrequestreview-379221374", "createdAt": "2020-03-23T08:40:30Z", "commit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo0MDozMFrOF57T1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QwODo0Mzo1N1rOF57bdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NDg4Nw==", "bodyText": "In case of more than 256 blobs to delete, this will log the same message multiple times right?", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396284887", "createdAt": "2020-03-23T08:40:30Z", "author": {"login": "tlrx"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureStorageService.java", "diffHunk": "@@ -187,72 +188,61 @@ public boolean blobExists(String account, String container, String blob) throws\n         });\n     }\n \n-    public void deleteBlob(String account, String container, String blob) throws URISyntaxException, StorageException {\n+    public void deleteBlobsIgnoringIfNotExists(String account, String container, Collection<String> blobs)\n+            throws URISyntaxException, StorageException {\n         final Tuple<CloudBlobClient, Supplier<OperationContext>> client = client(account);\n         // Container name must be lower case.\n         final CloudBlobContainer blobContainer = client.v1().getContainerReference(container);\n-        logger.trace(() -> new ParameterizedMessage(\"delete blob for container [{}], blob [{}]\", container, blob));\n-        SocketAccess.doPrivilegedVoidException(() -> {\n-            final CloudBlockBlob azureBlob = blobContainer.getBlockBlobReference(blob);\n-            logger.trace(() -> new ParameterizedMessage(\"container [{}]: blob [{}] found. removing.\", container, blob));\n-            azureBlob.delete(DeleteSnapshotsOption.NONE, null, null, client.v2().get());\n-        });\n+        final Iterator<String> blobIterator = blobs.iterator();\n+        int currentBatchSize = 0;\n+        while (blobIterator.hasNext()) {\n+            final BlobDeleteBatchOperation batchDeleteOp = new BlobDeleteBatchOperation();\n+            do {\n+                batchDeleteOp.addSubOperation(blobContainer.getBlockBlobReference(blobIterator.next()),\n+                    DeleteSnapshotsOption.NONE, null, null);\n+                ++currentBatchSize;\n+            } while (blobIterator.hasNext() && currentBatchSize < Constants.BATCH_MAX_REQUESTS);\n+            currentBatchSize = 0;\n+            logger.trace(() -> new ParameterizedMessage(\"delete blobs for container [{}], blob [{}]\", container, blobs));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjA4Mg==", "bodyText": "Batch request does not prefix with the container name, right?", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396286082", "createdAt": "2020-03-23T08:42:37Z", "author": {"login": "tlrx"}, "path": "plugins/repository-azure/src/test/java/org/elasticsearch/repositories/azure/AzureBlobStoreRepositoryTests.java", "diffHunk": "@@ -64,7 +64,7 @@ protected Settings repositorySettings() {\n \n     @Override\n     protected Map<String, HttpHandler> createHttpHandlers() {\n-        return Collections.singletonMap(\"/container\", new AzureBlobStoreHttpHandler(\"container\"));\n+        return Collections.singletonMap(\"/\", new AzureBlobStoreHttpHandler(\"container\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjI4NjgzOQ==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/53919#discussion_r396286839", "createdAt": "2020-03-23T08:43:57Z", "author": {"login": "tlrx"}, "path": "test/fixtures/azure-fixture/src/main/java/fixture/azure/AzureHttpHandler.java", "diffHunk": "@@ -190,6 +198,45 @@ public void handle(final HttpExchange exchange) throws IOException {\n                 exchange.sendResponseHeaders(RestStatus.OK.getStatus(), response.length);\n                 exchange.getResponseBody().write(response);\n \n+            } else if (Regex.simpleMatch(\"POST /?comp=batch\", request)) {\n+                // Batch Delete (https://docs.microsoft.com/en-us/rest/api/storageservices/blob-batch)\n+                try (BufferedReader reader = new BufferedReader(new InputStreamReader(requestBody.streamInput()))) {\n+                    final Set<String> toDelete = reader.lines().filter(l -> l.startsWith(\"DELETE\"))\n+                        .map(l -> l.split(\" \")[1]).collect(Collectors.toSet());\n+                    final BytesStreamOutput baos = new BytesStreamOutput();\n+                    final String batchSeparator = \"batchresponse_\" + UUIDs.randomBase64UUID();\n+                    try (Writer writer = new OutputStreamWriter(baos)) {\n+                        int contentId = 0;\n+                        for (String b : toDelete) {\n+                            writer.write(\"\\r\\n--\" + batchSeparator + \"\\r\\n\" +\n+                                \"Content-Type: application/http \\r\\n\" +\n+                                \"Content-ID: \" + contentId++ + \" \\r\\n\");\n+                            if (blobs.remove(b) == null) {\n+                                writer.write(\"\\r\\nHTTP/1.1 404 The specified blob does not exist. \\r\\n\" +\n+                                    \"x-ms-error-code: BlobNotFound \\r\\n\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d"}, "originalPosition": 80}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5Mjg1MDU4", "url": "https://github.com/elastic/elasticsearch/pull/53919#pullrequestreview-379285058", "createdAt": "2020-03-23T10:07:44Z", "commit": {"oid": "145569833c91e08a36f6880b3c26c48444c1c20d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "290d325cd510aa074504fc4014ab30231a2ffd3b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/290d325cd510aa074504fc4014ab30231a2ffd3b", "committedDate": "2020-03-23T10:18:57Z", "message": "Merge remote-tracking branch 'elastic/master' into azure-bulk-deletes-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a933c2d1fa6e7b1b2a7a152ac47f773d210b9378", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a933c2d1fa6e7b1b2a7a152ac47f773d210b9378", "committedDate": "2020-03-23T10:21:36Z", "message": "CR: move log statement"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1745, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}