{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2Nzg0NTc1", "number": 63164, "title": "geo_point runtime field implementation", "bodyText": "Run time field that emits geo points from lat/lon values.  For example, given a mapping like:\n{\n    \"mappings\": {\n        \"properties\": {\n            \"location\": {\n                \"lat\": {\"type\" : \"double\"},\n                \"lon\" : {\"type\" \"double\"}\n            }\n        }\n    }\n}\n\nA geo_point runtime field can be declared as:\n{\n    \"runtime_geo_point\": {\n        \"type\" : \"runtime\",\n         \"runtime_type\": \"geo_point\",\n         \"script\": {\n             \"source\" : \"emit(doc['location'].lat, doc['location'].lon);\"\n         }\n}\n\nwhere the emit function takes two arguments, the first argument is the latitude and the second argument the longitude.", "createdAt": "2020-10-02T09:12:33Z", "url": "https://github.com/elastic/elasticsearch/pull/63164", "merged": true, "mergeCommit": {"oid": "265a2142b716caf066b8d76b92b3ed2682e4ae56"}, "closed": true, "closedAt": "2020-10-21T07:58:55Z", "author": {"login": "iverase"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOiPCFAH2gAyNDk2Nzg0NTc1OmZkOWVmZjM2NmI4YzgzYWNjODVkMzk4YTY1Njc3YmE0OTU2OTZlMjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUnoEXgH2gAyNDk2Nzg0NTc1OjUwM2QzMzIxNmY4NmZiYTcxYzE1YmUzY2JiYjRkMWFkMmY1ZGVkNWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd9eff366b8c83acc85d398a65677ba495696e21", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd9eff366b8c83acc85d398a65677ba495696e21", "committedDate": "2020-10-02T09:05:22Z", "message": "geo_point runtime implementation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47e4eb36c6009787a65d89a7841262135ef16567", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/47e4eb36c6009787a65d89a7841262135ef16567", "committedDate": "2020-10-02T09:32:25Z", "message": "Add geo_distance sort yaml test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "767d39806e2715a475600f37b65519a7d820edd3", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/767d39806e2715a475600f37b65519a7d820edd3", "committedDate": "2020-10-02T09:37:39Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTk0NTgy", "url": "https://github.com/elastic/elasticsearch/pull/63164#pullrequestreview-500994582", "createdAt": "2020-10-02T09:38:46Z", "commit": {"oid": "767d39806e2715a475600f37b65519a7d820edd3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOTozODo0NlrOHbnZuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQwOTozODo0NlrOHbnZuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODcxOTE2MA==", "bodyText": "This is horrible but I didn't want to fix it until getting feedback.", "url": "https://github.com/elastic/elasticsearch/pull/63164#discussion_r498719160", "createdAt": "2020-10-02T09:38:46Z", "author": {"login": "iverase"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/GeoPointScriptMappedFieldTypeTests.java", "diffHunk": "@@ -0,0 +1,309 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.document.StoredField;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.RandomIndexWriter;\n+import org.apache.lucene.search.Collector;\n+import org.apache.lucene.search.IndexSearcher;\n+import org.apache.lucene.search.LeafCollector;\n+import org.apache.lucene.search.MatchAllDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.Scorable;\n+import org.apache.lucene.search.ScoreMode;\n+import org.apache.lucene.store.Directory;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.geo.GeoPoint;\n+import org.elasticsearch.common.lucene.search.function.ScriptScoreQuery;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.geo.GeometryTestUtils;\n+import org.elasticsearch.index.fielddata.MultiGeoPointValues;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.plugins.ScriptPlugin;\n+import org.elasticsearch.script.ScoreScript;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.script.ScriptContext;\n+import org.elasticsearch.script.ScriptEngine;\n+import org.elasticsearch.script.ScriptModule;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.script.ScriptType;\n+import org.elasticsearch.search.MultiValueMode;\n+import org.elasticsearch.xpack.runtimefields.RuntimeFields;\n+import org.elasticsearch.xpack.runtimefields.fielddata.GeoPointScriptFieldData;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collection;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Set;\n+\n+import static java.util.Collections.emptyMap;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class GeoPointScriptMappedFieldTypeTests extends AbstractScriptFieldTypeTestCase {\n+\n+    @Override\n+    public void testDocValues() throws IOException {\n+        try (Directory directory = newDirectory(); RandomIndexWriter iw = new RandomIndexWriter(random(), directory)) {\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 45.0, \\\"lon\\\" : 45.0}}\"))));\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 0.0, \\\"lon\\\" : 0.0}}\"))));\n+            List<Object> results = new ArrayList<>();\n+            try (DirectoryReader reader = iw.getReader()) {\n+                IndexSearcher searcher = newSearcher(reader);\n+                GeoPointScriptMappedFieldType ft = build(\"fromLatLon\", Map.of());\n+                GeoPointScriptFieldData ifd = ft.fielddataBuilder(\"test\", mockContext()::lookup).build(null, null, null);\n+                searcher.search(new MatchAllDocsQuery(), new Collector() {\n+                    @Override\n+                    public ScoreMode scoreMode() {\n+                        return ScoreMode.COMPLETE_NO_SCORES;\n+                    }\n+\n+                    @Override\n+                    public LeafCollector getLeafCollector(LeafReaderContext context) {\n+                        MultiGeoPointValues dv = ifd.load(context).getGeoPointValues();\n+                        return new LeafCollector() {\n+                            @Override\n+                            public void setScorer(Scorable scorer) {}\n+\n+                            @Override\n+                            public void collect(int doc) throws IOException {\n+                                if (dv.advanceExact(doc)) {\n+                                    for (int i = 0; i < dv.docValueCount(); i++) {\n+                                        final GeoPoint point = dv.nextValue();\n+                                        results.add(new GeoPoint(point.lat(), point.lon()));\n+                                    }\n+                                }\n+                            }\n+                        };\n+                    }\n+                });\n+                assertThat(results, equalTo(List.of(new GeoPoint(45.0, 45.0), new GeoPoint(0.0, 0.0))));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void testSort() throws IOException {\n+        GeoPointScriptFieldData ifd = simpleMappedFieldType().fielddataBuilder(\"test\", mockContext()::lookup).build(null, null, null);\n+        Exception e = expectThrows(IllegalArgumentException.class, () -> ifd.sortField(null, MultiValueMode.MIN, null, false));\n+        assertThat(e.getMessage(), equalTo(\"can't sort on geo_point field without using specific sorting feature, like geo_distance\"));\n+    }\n+\n+    @Override\n+    public void testUsedInScript() throws IOException {\n+        try (Directory directory = newDirectory(); RandomIndexWriter iw = new RandomIndexWriter(random(), directory)) {\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 45.0, \\\"lon\\\" : 45.0}}\"))));\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 0.0, \\\"lon\\\" : 0.0}}\"))));\n+            try (DirectoryReader reader = iw.getReader()) {\n+                IndexSearcher searcher = newSearcher(reader);\n+                QueryShardContext qsc = mockContext(true, simpleMappedFieldType());\n+                assertThat(searcher.count(new ScriptScoreQuery(new MatchAllDocsQuery(), new Script(\"test\"), new ScoreScript.LeafFactory() {\n+                    @Override\n+                    public boolean needs_score() {\n+                        return false;\n+                    }\n+\n+                    @Override\n+                    public ScoreScript newInstance(LeafReaderContext ctx) {\n+                        return new ScoreScript(Map.of(), qsc.lookup(), ctx) {\n+                            @Override\n+                            public double execute(ExplanationHolder explanation) {\n+                                ScriptDocValues.GeoPoints points = (ScriptDocValues.GeoPoints) getDoc().get(\"test\");\n+                                return (int) points.get(0).lat() + 1;\n+                            }\n+                        };\n+                    }\n+                }, 2.5f, \"test\", 0, Version.CURRENT)), equalTo(1));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void testExistsQuery() throws IOException {\n+        try (Directory directory = newDirectory(); RandomIndexWriter iw = new RandomIndexWriter(random(), directory)) {\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 45.0, \\\"lon\\\" : 45.0}}\"))));\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": {\\\"lat\\\": 0.0, \\\"lon\\\" : 0.0}}\"))));\n+            try (DirectoryReader reader = iw.getReader()) {\n+                IndexSearcher searcher = newSearcher(reader);\n+                assertThat(searcher.count(simpleMappedFieldType().existsQuery(mockContext())), equalTo(2));\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public void testRangeQuery() throws IOException {\n+        Exception e = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> simpleMappedFieldType().rangeQuery(\"0.0\", \"45.0\", false, false, null, null, null, mockContext())\n+        );\n+        assertThat(e.getMessage(), equalTo(\"Field [test] of type [runtime] does not support range queries\"));\n+    }\n+\n+    @Override\n+    protected Query randomRangeQuery(MappedFieldType ft, QueryShardContext ctx) {\n+        return ft.rangeQuery(\"0.0\", \"45.0\", false, false, null, null, null, mockContext());\n+    }\n+\n+    @Override\n+    public void testTermQuery() throws IOException {\n+        Exception e = expectThrows(IllegalArgumentException.class, () -> simpleMappedFieldType().termQuery(\"0.0,0.0\", mockContext()));\n+        assertThat(\n+            e.getMessage(),\n+            equalTo(\"Geometry fields do not support exact searching, use dedicated geometry queries instead: [test]\")\n+        );\n+    }\n+\n+    @Override\n+    protected Query randomTermQuery(MappedFieldType ft, QueryShardContext ctx) {\n+        return ft.termQuery(GeometryTestUtils.randomPoint(), mockContext());\n+    }\n+\n+    @Override\n+    public void testTermsQuery() {\n+        Exception e = expectThrows(\n+            IllegalArgumentException.class,\n+            () -> simpleMappedFieldType().termsQuery(List.of(\"0.0,0.0\", \"45.0,45.0\"), mockContext())\n+        );\n+\n+        assertThat(\n+            e.getMessage(),\n+            equalTo(\"Geometry fields do not support exact searching, use dedicated geometry queries instead: [test]\")\n+        );\n+\n+    }\n+\n+    @Override\n+    protected Query randomTermsQuery(MappedFieldType ft, QueryShardContext ctx) {\n+        return ft.termsQuery(randomList(100, () -> GeometryTestUtils.randomPoint()), mockContext());\n+    }\n+\n+    @Override\n+    @AwaitsFix(bugUrl = \"Not supported\")\n+    public void testRangeQueryWithShapeRelationIsError() {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "767d39806e2715a475600f37b65519a7d820edd3"}, "originalPosition": 192}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a6509ab53f5af619c62f9aa54ea3a6fbe766a3d", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a6509ab53f5af619c62f9aa54ea3a6fbe766a3d", "committedDate": "2020-10-02T09:46:13Z", "message": "Shorten field type class name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a88e14db65b3215367b4f28ed7e5e271175b943", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a88e14db65b3215367b4f28ed7e5e271175b943", "committedDate": "2020-10-05T12:48:49Z", "message": "cleanup tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMTI1MzEx", "url": "https://github.com/elastic/elasticsearch/pull/63164#pullrequestreview-502125311", "createdAt": "2020-10-05T14:39:09Z", "commit": {"oid": "5a88e14db65b3215367b4f28ed7e5e271175b943"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDozOTowOVrOHcgJeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNDo0NzozNFrOHcgisQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY0ODg4OA==", "bodyText": "These were in alphabetical order I think.", "url": "https://github.com/elastic/elasticsearch/pull/63164#discussion_r499648888", "createdAt": "2020-10-05T14:39:09Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/RuntimeFields.java", "diffHunk": "@@ -38,7 +39,8 @@\n             DoubleFieldScript.CONTEXT,\n             IpFieldScript.CONTEXT,\n             LongFieldScript.CONTEXT,\n-            StringFieldScript.CONTEXT\n+            StringFieldScript.CONTEXT,\n+            GeoPointFieldScript.CONTEXT", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a88e14db65b3215367b4f28ed7e5e271175b943"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1MzY1OA==", "bodyText": "Is this something we can move into core? It looks like something we'd have there already?", "url": "https://github.com/elastic/elasticsearch/pull/63164#discussion_r499653658", "createdAt": "2020-10-05T14:45:23Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/GeoPointScriptFieldType.java", "diffHunk": "@@ -0,0 +1,174 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.geo.LatLonGeometry;\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.geo.GeoPolygonDecomposer;\n+import org.elasticsearch.common.geo.GeoShapeUtils;\n+import org.elasticsearch.common.geo.ShapeRelation;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.geometry.Circle;\n+import org.elasticsearch.geometry.Geometry;\n+import org.elasticsearch.geometry.GeometryCollection;\n+import org.elasticsearch.geometry.GeometryVisitor;\n+import org.elasticsearch.geometry.LinearRing;\n+import org.elasticsearch.geometry.MultiLine;\n+import org.elasticsearch.geometry.MultiPoint;\n+import org.elasticsearch.geometry.MultiPolygon;\n+import org.elasticsearch.geometry.Point;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.mapper.GeoPointFieldMapper;\n+import org.elasticsearch.index.mapper.GeoShapeQueryable;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.index.query.QueryShardException;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.fielddata.GeoPointScriptFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.GeoPointScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.GeoPointScriptFieldGeoShapeQuery;\n+\n+import java.time.ZoneId;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public final class GeoPointScriptFieldType extends AbstractScriptFieldType<GeoPointFieldScript.LeafFactory> implements GeoShapeQueryable {\n+\n+    GeoPointScriptFieldType(String name, Script script, GeoPointFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, scriptFactory::newFactory, meta);\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return GeoPointFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    protected Query rangeQuery(\n+        Object lowerTerm,\n+        Object upperTerm,\n+        boolean includeLower,\n+        boolean includeUpper,\n+        ZoneId timeZone,\n+        DateMathParser parser,\n+        QueryShardContext context\n+    ) {\n+        throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support range queries\");\n+    }\n+\n+    @Override\n+    public Query termQuery(Object value, QueryShardContext context) {\n+        throw new IllegalArgumentException(\n+            \"Geometry fields do not support exact searching, use dedicated geometry queries instead: [\" + name() + \"]\"\n+        );\n+    }\n+\n+    @Override\n+    public GeoPointScriptFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n+        return new GeoPointScriptFieldData.Builder(name(), leafFactory(searchLookup.get()));\n+    }\n+\n+    @Override\n+    public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);\n+        return new GeoPointScriptFieldExistsQuery(script, leafFactory(context), name());\n+    }\n+\n+    @Override\n+    public Query geoShapeQuery(Geometry shape, String fieldName, ShapeRelation relation, QueryShardContext context) {\n+        if (shape == null) {\n+            return new MatchNoDocsQuery();\n+        }\n+        final LatLonGeometry[] geometries = toLuceneGeometry(fieldName, context, shape);\n+        return new GeoPointScriptFieldGeoShapeQuery(script, leafFactory(context), fieldName, geometries);\n+    }\n+\n+    private static LatLonGeometry[] toLuceneGeometry(String name, QueryShardContext context, Geometry geometry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a88e14db65b3215367b4f28ed7e5e271175b943"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY1NTM0NQ==", "bodyText": "Maybe it'd be better to make a new superclass that doesn't have these methods?", "url": "https://github.com/elastic/elasticsearch/pull/63164#discussion_r499655345", "createdAt": "2020-10-05T14:47:34Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptFieldTypeTestCase.java", "diffHunk": "@@ -67,6 +67,14 @@ protected static QueryShardContext mockContext(boolean allowExpensiveQueries) {\n         return mockContext(allowExpensiveQueries, null);\n     }\n \n+    protected boolean supportsTermQueries() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a88e14db65b3215367b4f28ed7e5e271175b943"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9117fd9c1fcc9e8019c455303ca9e25dbc76c0aa", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/9117fd9c1fcc9e8019c455303ca9e25dbc76c0aa", "committedDate": "2020-10-05T16:16:43Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94874c2fcd638571ebb050f1485ebd505f56ce7", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/d94874c2fcd638571ebb050f1485ebd505f56ce7", "committedDate": "2020-10-05T17:08:29Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f53b662c3014fc168c3e3d4d5b176009ffbd4cc5", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/f53b662c3014fc168c3e3d4d5b176009ffbd4cc5", "committedDate": "2020-10-06T08:50:01Z", "message": "Move creation of LatLonGeometries to GeoShapeUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb6cab1af1e6d282500266fab35fae3a2de7fa00", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb6cab1af1e6d282500266fab35fae3a2de7fa00", "committedDate": "2020-10-06T08:51:10Z", "message": "Merge branch 'master' into runtime_geopoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d84ca69b9cd0d5bf0bba798b5991b066a5bff4", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7d84ca69b9cd0d5bf0bba798b5991b066a5bff4", "committedDate": "2020-10-06T10:39:49Z", "message": "compile errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e9ec53f0ba13be8faa5d7b29c11f27fddc54d8c", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e9ec53f0ba13be8faa5d7b29c11f27fddc54d8c", "committedDate": "2020-10-06T10:46:10Z", "message": "precommit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MTEzODQ0", "url": "https://github.com/elastic/elasticsearch/pull/63164#pullrequestreview-504113844", "createdAt": "2020-10-07T17:33:58Z", "commit": {"oid": "2e9ec53f0ba13be8faa5d7b29c11f27fddc54d8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozMzo1OFrOHd-O1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzozMzo1OFrOHd-O1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE5MDM1Nw==", "bodyText": "Copy and paste error, I think.", "url": "https://github.com/elastic/elasticsearch/pull/63164#discussion_r501190357", "createdAt": "2020-10-07T17:33:58Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/100_geo_point.yml", "diffHunk": "@@ -0,0 +1,155 @@\n+---\n+setup:\n+  - do:\n+      indices.create:\n+        index: locations\n+        body:\n+          settings:\n+            number_of_shards: 1\n+            number_of_replicas: 0\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+              location:\n+                type: geo_point\n+              location_from_doc_value:\n+                type: runtime\n+                runtime_type: geo_point\n+                script:\n+                  source: |\n+                    emit(doc[\"location\"].lat, doc[\"location\"].lon);\n+              location_from_source:\n+                type: runtime\n+                runtime_type: geo_point\n+                script:\n+                  source: |\n+                    emit(params._source.location.lat, params._source.location.lon);\n+\n+\n+  - do:\n+      bulk:\n+        index: locations\n+        refresh: true\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:30:17-05:00\", \"location\" : {\"lat\": 13.5, \"lon\" : 34.89}}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:30:53-05:00\", \"location\" : {\"lat\": -7.9, \"lon\" : 120.78}}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:12-05:00\", \"location\" : {\"lat\": 45.78, \"lon\" : -173.45}}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:19-05:00\", \"location\" : {\"lat\": 32.45, \"lon\" : 45.6}}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:22-05:00\", \"location\" : {\"lat\": -63.24, \"lon\" : 31.0}}\n+          {\"index\":{}}\n+          {\"timestamp\": \"1998-04-30T14:31:27-05:00\", \"location\" : {\"lat\": 0.0, \"lon\" : 0.0}}\n+\n+\n+---\n+\"get mapping\":\n+  - do:\n+      indices.get_mapping:\n+        index: locations\n+  - match: {locations.mappings.properties.location_from_source.type: runtime }\n+  - match: {locations.mappings.properties.location_from_source.runtime_type: geo_point }\n+  - match:\n+      locations.mappings.properties.location_from_source.script.source: |\n+        emit(params._source.location.lat, params._source.location.lon);\n+  - match: {locations.mappings.properties.location_from_source.script.lang: painless }\n+\n+\n+---\n+\"fetch fields from source\":\n+  - do:\n+      search:\n+        index: locations\n+        body:\n+          sort: timestamp\n+          fields: [location, location_from_doc_value, location_from_source]\n+  - match: {hits.total.value: 6}\n+  - match: {hits.hits.0.fields.location.0.type: \"Point\" }\n+  - match: {hits.hits.0.fields.location.0.coordinates: [34.89, 13.5] }\n+  - match: {hits.hits.0.fields.location_from_doc_value: [\"13.499999991618097, 34.889999935403466\"] }\n+  - match: {hits.hits.0.fields.location_from_source: [\"13.499999991618097, 34.889999935403466\"] }\n+\n+---\n+\"exists query\":\n+  - do:\n+      search:\n+        index: locations\n+        body:\n+          query:\n+            exists:\n+              field: location_from_source\n+  - match: {hits.total.value: 6}\n+\n+---\n+\"geo bounding box query\":\n+  - do:\n+      search:\n+        index: locations\n+        body:\n+          query:\n+            geo_shape:\n+              location_from_source:\n+                shape:\n+                  type: \"envelope\"\n+                  coordinates: [ [ -10, 10 ], [ 10, -10 ] ]\n+  - match: {hits.total.value: 1}\n+\n+---\n+\"bounds agg\":\n+  - do:\n+      search:\n+        index: locations\n+        body:\n+          aggs:\n+            bounds:\n+              geo_bounds:\n+                field: \"location\"\n+                wrap_longitude: false\n+            bounds_from_doc_value:\n+              geo_bounds:\n+                 field: \"location_from_doc_value\"\n+                 wrap_longitude: false\n+            bounds_from_source:\n+              geo_bounds:\n+                 field: \"location_from_source\"\n+                 wrap_longitude: false\n+  - match: {hits.total.value: 6}\n+  - match: {aggregations.bounds.bounds.top_left.lat: 45.7799999602139 }\n+  - match: {aggregations.bounds.bounds.top_left.lon: -173.4500000718981 }\n+  - match: {aggregations.bounds.bounds.bottom_right.lat: -63.240000014193356 }\n+  - match: {aggregations.bounds.bounds.bottom_right.lon: 120.77999993227422 }\n+  - match: {aggregations.bounds_from_doc_value.bounds.top_left.lat: 45.7799999602139 }\n+  - match: {aggregations.bounds_from_doc_value.bounds.top_left.lon: -173.4500000718981 }\n+  - match: {aggregations.bounds_from_doc_value.bounds.bottom_right.lat: -63.240000014193356 }\n+  - match: {aggregations.bounds_from_doc_value.bounds.bottom_right.lon: 120.77999993227422 }\n+  - match: {aggregations.bounds_from_source.bounds.top_left.lat: 45.7799999602139 }\n+  - match: {aggregations.bounds_from_source.bounds.top_left.lon: -173.4500000718981 }\n+  - match: {aggregations.bounds_from_source.bounds.bottom_right.lat: -63.240000014193356 }\n+  - match: {aggregations.bounds_from_source.bounds.bottom_right.lon: 120.77999993227422 }\n+\n+---\n+\"geo_distance sort\":\n+  - do:\n+      search:\n+        index: locations\n+        body:\n+          sort:\n+            _geo_distance:\n+              location_from_source:\n+                lat: 0.0\n+                lon: 0.0\n+  - match: {hits.total.value: 6}\n+  - match: {hits.hits.0._source.location.lat: 0.0 }\n+  - match: {hits.hits.0._source.location.lon: 0.0 }\n+  - match: {hits.hits.1._source.location.lat: 13.5 }\n+  - match: {hits.hits.1._source.location.lon: 34.89 }\n+  - match: {hits.hits.2._source.location.lat: 32.45 }\n+  - match: {hits.hits.2._source.location.lon: 45.6 }\n+  - match: {hits.hits.3._source.location.lat: -63.24 }\n+  - match: {hits.hits.3._source.location.lon: 31.0 }\n+\n+# TODO tests for using the ip in a script. there is almost certainly whitelist \"fun\" here.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e9ec53f0ba13be8faa5d7b29c11f27fddc54d8c"}, "originalPosition": 155}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af770cfd5ca636b599a294475d6762b7d67b3f1", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/8af770cfd5ca636b599a294475d6762b7d67b3f1", "committedDate": "2020-10-08T12:07:18Z", "message": "Merge branch 'master' into runtime_geopoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a77aaa2a69d51bd7c58df5dc7836477d2d133786", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/a77aaa2a69d51bd7c58df5dc7836477d2d133786", "committedDate": "2020-10-08T12:09:36Z", "message": "remove copy/paste nosense"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwMjc0NDg1", "url": "https://github.com/elastic/elasticsearch/pull/63164#pullrequestreview-510274485", "createdAt": "2020-10-16T08:49:48Z", "commit": {"oid": "a77aaa2a69d51bd7c58df5dc7836477d2d133786"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEwNjYyMjA4", "url": "https://github.com/elastic/elasticsearch/pull/63164#pullrequestreview-510662208", "createdAt": "2020-10-16T17:20:31Z", "commit": {"oid": "a77aaa2a69d51bd7c58df5dc7836477d2d133786"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c983c00de7004fd9c323aec35c7b81f28e67bf36", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/c983c00de7004fd9c323aec35c7b81f28e67bf36", "committedDate": "2020-10-19T12:54:17Z", "message": "Merge branch 'master' into runtime_geopoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503d33216f86fba71c15be3cbbb4d1ad2f5ded5c", "author": {"user": {"login": "iverase", "name": "Ignacio Vera"}}, "url": "https://github.com/elastic/elasticsearch/commit/503d33216f86fba71c15be3cbbb4d1ad2f5ded5c", "committedDate": "2020-10-21T06:45:47Z", "message": "Merge branch 'master' into runtime_geopoint"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4470, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}