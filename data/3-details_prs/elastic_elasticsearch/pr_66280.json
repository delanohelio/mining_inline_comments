{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Njk2OTcz", "number": 66280, "title": "Fix handling of search shard failures in the coordinating node", "bodyText": "This commit ensures that we catch exceptions that happens when the coordinating\nnode consumes a shard response. Such failures can happen if we need to compute\nthe serialized size of an aggregation that was computed locally and the serialization\nfails. In such case, we now return a shard error rather than an uncaught NPE for the entire\nsearch.", "createdAt": "2020-12-14T17:54:23Z", "url": "https://github.com/elastic/elasticsearch/pull/66280", "merged": true, "mergeCommit": {"oid": "5e15a20844b97b6d296f24daee69b53b9fbe4f8b"}, "closed": true, "closedAt": "2020-12-22T09:40:07Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmJid4gH2gAyNTM5Njk2OTczOjlmZmQ2MjNlYzQ5ZDUzNjRhYTkzOGNhM2QyYzY1ZGFiODhiNGE3YTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnZVhcgH2gAyNTM5Njk2OTczOjQxZGNkODQ2MTNhZDExNzhlNzY5OTZmYTMzZGUyNDkzYWQ4NTMwZmI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ffd623ec49d5364aa938ca3d2c65dab88b4a7a5", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ffd623ec49d5364aa938ca3d2c65dab88b4a7a5", "committedDate": "2020-12-14T17:53:09Z", "message": "Fix handling of search shard failures in the coordinating node\n\nThis commit ensures that we catch exceptions that happens when the coordinating\nnode consumes a shard response. Such failures can happen if we need to compute\nthe serialized size of an aggregation that was computed locally and the serialization\nfails. In such case, we now return a shard error rather than an uncaught NPE for the entire\nsearch."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDA4NTA4", "url": "https://github.com/elastic/elasticsearch/pull/66280#pullrequestreview-555408508", "createdAt": "2020-12-18T11:26:27Z", "commit": {"oid": "9ffd623ec49d5364aa938ca3d2c65dab88b4a7a5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMToyNjoyOFrOIIfOFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMToyNjoyOFrOIIfOFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTc3MTAzMQ==", "bodyText": "Is it needed both conditions? I would expect that if reducePhase.aggregations is not null, then hasAggs is always true?", "url": "https://github.com/elastic/elasticsearch/pull/66280#discussion_r545771031", "createdAt": "2020-12-18T11:26:28Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/action/search/QueryPhaseResultConsumer.java", "diffHunk": "@@ -140,7 +140,7 @@ public void consumeResult(SearchPhaseResult result, Runnable next) {\n         }\n         SearchPhaseController.ReducedQueryPhase reducePhase = controller.reducedQueryPhase(results.asList(), aggsList,\n             topDocsList, topDocsStats, pendingMerges.numReducePhases, false, aggReduceContextBuilder, performFinalReduce);\n-        if (hasAggs) {\n+        if (hasAggs && reducePhase.aggregations != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ffd623ec49d5364aa938ca3d2c65dab88b4a7a5"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDA5ODY5", "url": "https://github.com/elastic/elasticsearch/pull/66280#pullrequestreview-555409869", "createdAt": "2020-12-18T11:28:25Z", "commit": {"oid": "9ffd623ec49d5364aa938ca3d2c65dab88b4a7a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "baabbbd38f395b7ca6adacd590a5475db647f168", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/baabbbd38f395b7ca6adacd590a5475db647f168", "committedDate": "2020-12-18T11:32:38Z", "message": "add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d465d3bfb8d860f1234d2595c8ef9d0376135961", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d465d3bfb8d860f1234d2595c8ef9d0376135961", "committedDate": "2020-12-18T12:13:46Z", "message": "Merge branch 'master' into shard_consumer_failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDc1MDIy", "url": "https://github.com/elastic/elasticsearch/pull/66280#pullrequestreview-555475022", "createdAt": "2020-12-18T13:15:27Z", "commit": {"oid": "d465d3bfb8d860f1234d2595c8ef9d0376135961"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMzoxNToyOFrOIIibbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMzoxNToyOFrOIIibbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTgyMzU5OQ==", "bodyText": "I find this change hard to follow, I am sure I am missing something. Why do we need the conditional compared to before? And why do we call asSerialized when the aggregation is already serialized?", "url": "https://github.com/elastic/elasticsearch/pull/66280#discussion_r545823599", "createdAt": "2020-12-18T13:15:28Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/action/search/QueryPhaseResultConsumer.java", "diffHunk": "@@ -290,9 +293,13 @@ long ramBytesUsedQueryResult(QuerySearchResult result) {\n             if (hasAggs == false) {\n                 return 0;\n             }\n-            return result.aggregations()\n-                .asSerialized(InternalAggregations::readFrom, namedWriteableRegistry)\n-                .ramBytesUsed();\n+            if (result.aggregations().isSerialized()) {\n+                return result.aggregations()\n+                    .asSerialized(InternalAggregations::readFrom, namedWriteableRegistry)\n+                    .ramBytesUsed();\n+            } else {\n+                return result.aggregations().expand().getSerializedSize();\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d465d3bfb8d860f1234d2595c8ef9d0376135961"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8673076f2de921f4799de19de3e82d2c83e0149", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8673076f2de921f4799de19de3e82d2c83e0149", "committedDate": "2020-12-18T13:40:02Z", "message": "cleanup serialized size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41dcd84613ad1178e76996fa33de2493ad8530fb", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/41dcd84613ad1178e76996fa33de2493ad8530fb", "committedDate": "2020-12-18T14:51:25Z", "message": "Merge branch 'master' into shard_consumer_failure"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4631, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}