{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyNTYwMzk0", "number": 50962, "title": "QL: Remove implicit conversion inside Literal", "bodyText": "Literal constructor makes an implicit conversion for each value given\nwhich turns out has some subtle side-effects.\nImprove MathProcessors to preserve numeric type where possible\nFix bug on issue compatibility between date and intervals\nPreserve the source when folding inside the Optimizer", "createdAt": "2020-01-14T10:32:57Z", "url": "https://github.com/elastic/elasticsearch/pull/50962", "merged": true, "mergeCommit": {"oid": "9b73e225b0aa07a23859550fb117bae571a2b672"}, "closed": true, "closedAt": "2020-01-15T09:06:21Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6ObkNgH2gAyMzYyNTYwMzk0OmYyN2ZiYjAzNjk2N2VlODhhNjdmNGJhNTUzMzA4ODEyOGUwMTZlOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6h186AFqTM0MzA3MTE3Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f27fbb036967ee88a67f4ba5533088128e016e91", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/f27fbb036967ee88a67f4ba5533088128e016e91", "committedDate": "2020-01-14T10:31:19Z", "message": "QL: Remove implicit conversion inside Literal\n\nLiteral constructor makes an implicit conversion for each value given\nwhich turns out has some subtle side-effects.\nImprove MathProcessors to preserve numeric type where possible\nFix bug on issue compatibility between date and intervals\nPreserve the source when folding inside the Optimizer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/02340f996b5076d5e1cd6fa267cdf75ca269474b", "committedDate": "2020-01-14T11:44:23Z", "message": "Fix broken tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTk4Mjc4", "url": "https://github.com/elastic/elasticsearch/pull/50962#pullrequestreview-342598278", "createdAt": "2020-01-14T15:02:55Z", "commit": {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjUxODQ5", "url": "https://github.com/elastic/elasticsearch/pull/50962#pullrequestreview-342651849", "createdAt": "2020-01-14T16:09:54Z", "commit": {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowOTo1NFrOFddDUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjoxMDowN1rOFddDzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTAxMQ==", "bodyText": "Is this case tested?", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366429011", "createdAt": "2020-01-14T16:09:54Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/math/MathProcessor.java", "diffHunk": "@@ -21,17 +23,38 @@\n     \n     public enum MathOperation {\n         ABS((Object l) -> {\n-            if (l instanceof Float) {\n-                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n-            }\n             if (l instanceof Double) {\n                 return Math.abs(((Double) l).doubleValue());\n             }\n+            if (l instanceof Float) {\n+                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n+            }\n+\n+            // fallback to integer\n             long lo = ((Number) l).longValue();\n-            //handles the corner-case of Long.MIN_VALUE\n-            return lo >= 0 ? lo : lo == Long.MIN_VALUE ? Double.valueOf(Long.MAX_VALUE) : -lo;\n-        }),\n \n+            if (lo == Long.MIN_VALUE) {\n+                throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyOTEzMg==", "bodyText": "This also?", "url": "https://github.com/elastic/elasticsearch/pull/50962#discussion_r366429132", "createdAt": "2020-01-14T16:10:07Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/math/MathProcessor.java", "diffHunk": "@@ -21,17 +23,38 @@\n     \n     public enum MathOperation {\n         ABS((Object l) -> {\n-            if (l instanceof Float) {\n-                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n-            }\n             if (l instanceof Double) {\n                 return Math.abs(((Double) l).doubleValue());\n             }\n+            if (l instanceof Float) {\n+                return Double.valueOf(Math.abs(((Float) l).floatValue()));\n+            }\n+\n+            // fallback to integer\n             long lo = ((Number) l).longValue();\n-            //handles the corner-case of Long.MIN_VALUE\n-            return lo >= 0 ? lo : lo == Long.MIN_VALUE ? Double.valueOf(Long.MAX_VALUE) : -lo;\n-        }),\n \n+            if (lo == Long.MIN_VALUE) {\n+                throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");\n+            }\n+\n+            lo = lo < 0 ? -lo : lo;\n+\n+            if (l instanceof Integer) {\n+                if (lo == Integer.MIN_VALUE) {\n+                    throw new QlIllegalArgumentException(\"[\" + lo + \"] cannot be negated since the result is outside the range\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02340f996b5076d5e1cd6fa267cdf75ca269474b"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96124d543eaed24031a6ed84c177896e58fc87f3", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/96124d543eaed24031a6ed84c177896e58fc87f3", "committedDate": "2020-01-14T19:28:23Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into ql/datatype-refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a32da608c0e40af877634ec7f47eb28d3ea60998", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a32da608c0e40af877634ec7f47eb28d3ea60998", "committedDate": "2020-01-14T20:02:09Z", "message": "Add basic tests for ABS"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMDcxMTcy", "url": "https://github.com/elastic/elasticsearch/pull/50962#pullrequestreview-343071172", "createdAt": "2020-01-15T09:08:21Z", "commit": {"oid": "a32da608c0e40af877634ec7f47eb28d3ea60998"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3234, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}