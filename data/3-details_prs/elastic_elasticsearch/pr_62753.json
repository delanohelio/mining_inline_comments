{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwODMyOTk5", "number": 62753, "title": "Make TransportNodesAction finishHim Execute on Configured Executor", "bodyText": "Currently, finishHim can either execute on the specified executor\n(in the less likely case that the local node request is the last to arrive)\nor on a transport thread.\nIn case of e.g. org.elasticsearch.action.admin.cluster.stats.TransportClusterStatsAction\nthis leads to an expensive execution that deserializes all mapping metadata in the cluster\nrunning on the transport thread and destabilizing the cluster. In case of this transport\naction it was specifically moved to the MANAGEMENT thread to avoid the high cost of processing\nthe stats requests on the nodes during fan-out but that did not cover the final execution\non the node that received the initial request. This PR  adds to ability to optionally specify the executor for the final step of the\nnodes request execution and uses that to work around the issue for the slow TransportClusterStatsAction.\nNote: the specific problem that motivated this PR is essentially the same as #57937 where we moved the execution off the transport and on the management thread as a fix as well.", "createdAt": "2020-09-22T10:13:02Z", "url": "https://github.com/elastic/elasticsearch/pull/62753", "merged": true, "mergeCommit": {"oid": "82aa1d3c839f299da2eeb7e1a3920ca7e4124be5"}, "closed": true, "closedAt": "2020-09-28T12:57:30Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLVGoTgH2gAyNDkwODMyOTk5OjI3ODUwZmY3MTYxOGZjY2I4Yzk3YTUyMjgzZGMyMzU4OGY5MmU2NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdNSYFfgH2gAyNDkwODMyOTk5OjQ3NGQ0Y2JiNWIzMTg4YjUwYWQ4Y2JmZDMxYmUzYmUxOTFjNDA4OGM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27850ff71618fccb8c97a52283dc23588f92e645", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/27850ff71618fccb8c97a52283dc23588f92e645", "committedDate": "2020-09-22T10:05:39Z", "message": "Make TransportNodesAction finishHim Execute on Configured Executor\n\nCurrently, `finishHim` can either execute on the specified executor\n(in the less likely case that the local node request is the last to arrive)\nor on a transport thread.\nIn case of e.g. `org.elasticsearch.action.admin.cluster.stats.TransportClusterStatsAction`\nthis leads to an expensive execution that deserializes all mapping metadata in the cluster\nrunning on the transport thread and destabilizing the cluster. In case of this transport\naction it was specifically moved to the `MANAGEMENT` thread to avoid the high cost of processing\nthe stats requests on the nodes during fan-out but that did not cover the final execution\non the node that received the initial request."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a9095fda727c0173d35a1b9eade2b66811b24d4", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a9095fda727c0173d35a1b9eade2b66811b24d4", "committedDate": "2020-09-24T10:35:46Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-mapping-monitoring-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19028898559535391b3c8ba21a12dc104b0e876e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/19028898559535391b3c8ba21a12dc104b0e876e", "committedDate": "2020-09-24T10:55:21Z", "message": "adjust to be more specific"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NDIzOTkz", "url": "https://github.com/elastic/elasticsearch/pull/62753#pullrequestreview-497423993", "createdAt": "2020-09-28T11:33:27Z", "commit": {"oid": "19028898559535391b3c8ba21a12dc104b0e876e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzoyOFrOHY5oxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yOFQxMTozMzoyOFrOHY5oxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NTg3MjE5OQ==", "bodyText": "nit: this reintroduces double firing the listener if listener.onResponse fails (will also invoke onFailure now). I am OK with it, since it is a separate effort to come up with a good solution for the pattern you use here - unless you can see an easy way around it.", "url": "https://github.com/elastic/elasticsearch/pull/62753#discussion_r495872199", "createdAt": "2020-09-28T11:33:28Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/support/nodes/TransportNodesAction.java", "diffHunk": "@@ -226,15 +256,7 @@ private void onFailure(int idx, String nodeId, Throwable t) {\n         }\n \n         private void finishHim() {\n-            NodesResponse finalResponse;\n-            try {\n-                finalResponse = newResponse(request, responses);\n-            } catch (Exception e) {\n-                logger.debug(\"failed to combine responses from nodes\", e);\n-                listener.onFailure(e);\n-                return;\n-            }\n-            listener.onResponse(finalResponse);\n+            threadPool.executor(finalExecutor).execute(ActionRunnable.supply(listener, () -> newResponse(request, responses)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19028898559535391b3c8ba21a12dc104b0e876e"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fba4787d4254e824dd7dfb52294459430790aa0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fba4787d4254e824dd7dfb52294459430790aa0", "committedDate": "2020-09-28T11:59:53Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-mapping-monitoring-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474d4cbb5b3188b50ad8cbfd31be3be191c4088c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/474d4cbb5b3188b50ad8cbfd31be3be191c4088c", "committedDate": "2020-09-28T12:02:51Z", "message": "assert not on transport thread"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4707, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}