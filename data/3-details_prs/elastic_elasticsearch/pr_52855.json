{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgwNTU0Mzkz", "number": 52855, "title": "Scripting: Per-context script cache, default off", "bodyText": "Adds per context settings:\nscript.context.${CONTEXT}.cache_max_size ~\nscript.cache.max_size\nscript.context.${CONTEXT}.cache_expire ~\nscript.cache.expire\nscript.context.${CONTEXT}.max_compilations_rate ~\nscript.max_compilations_rate\n\n\nContext cache is used if:\nscript.max_compilations_rate=use-context.  This\nvalue is dynamically updatable, so users can\nswitch back to the general cache if desired.\n\n\nSettings for context caches take the first value\nthat applies:\n\nContext specific settings if set, eg\nscript.context.ingest.cache_max_size\nCorrelated general setting is set to the non-default\nvalue, eg script.cache.max_size\nContext default\n\n\n\nThe reason for 2's inclusion is to allow an easy\ntransition for users who've customized their general\ncache settings.\nUsing the general cache settings for the context caches\nresults in higher effective settings, since they are\nmultiplied across the number of contexts.  So a general\ncache max size of 200 will become 200 * # of contexts.\nHowever, this behavior it will avoid users snapping to a\nvalue that is too low for them.\nRefs: #50152", "createdAt": "2020-02-26T23:12:56Z", "url": "https://github.com/elastic/elasticsearch/pull/52855", "merged": true, "mergeCommit": {"oid": "070ea7eff1d67a054bc23a6557ea081ebdff57d4"}, "closed": true, "closedAt": "2020-03-18T18:31:31Z", "author": {"login": "stu-elastic"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIPEbEgH2gAyMzgwNTU0MzkzOjZjYzM1OWNiMGQzZWJkNGRiNTA4NjlhMjc5OTVmMGM0MjA2ZjVkMGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcO7nTYgFqTM3NzEzMDMwNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/6cc359cb0d3ebd4db50869a27995f0c4206f5d0e", "committedDate": "2020-02-26T23:10:53Z", "message": "Scripting: Per-context script cache, default off\n\n* Adds per context settings:\n  `script.context.${CONTEXT}.cache_max_size` ~\n    `script.cache.max_size`\n\n  `script.context.${CONTEXT}.cache_expire` ~\n    `script.cache.expire`\n\n  `script.context.${CONTEXT}.max_compilations_rate` ~\n    `script.max_compilations_rate`\n\n* General script cache is used if there are no cache settings or if\n  the general settings are used.\n\n* Context script cache is used if there are any context cache settings\n  and no general cache settings.\n\n* Mixed context and general cache settings are an error.\n\n* Context cache settings are dynamically updatable.  If the general\n  cache is used, these updates are rejected.\n\n* Existing general cache setting, `script.max_compilations_rate` remains\n  dynamically updatable.  Updates are rejected if context caches are in\n  use."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTQwNjAx", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-365940601", "createdAt": "2020-02-27T19:33:39Z", "commit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTozMzozOVrOFvedwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTozMzozOVrOFvedwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMyNjUzMA==", "bodyText": "After looking through the code more carefully, we can't do this because settings is never actually updated for dynamic settings. This would only determine if this setting exists at start-up. So if a user were to dynamically update this setting we would be using old information.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385326530", "createdAt": "2020-02-27T19:33:39Z", "author": {"login": "jdconrad"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -219,7 +383,29 @@ boolean compilationLimitsEnabled() {\n \n     void registerClusterSettingsListeners(ClusterSettings clusterSettings) {\n         clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_SIZE_IN_BYTES, this::setMaxSizeInBytes);\n-        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE, compiler::setMaxCompilationRate);\n+        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED,\n+                // Don't deref potentially null generalCache\n+                r -> {\n+                    if (generalCache != null) {\n+                        generalCache.setMaxCompilationRate(r);\n+                    }\n+                },\n+                s -> {\n+                    if (generalCache == null) {\n+                        // This validator is run on every settings update.\n+                        // Here we try to detect if it's a spurious update to the default.\n+                        // This _will_ allow through bad updates to the default.\n+                        if (SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED.getDefault(Settings.EMPTY).equals(s) &&\n+                            SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED.exists(settings) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 236}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1OTQ5MjAw", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-365949200", "createdAt": "2020-02-27T19:46:35Z", "commit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTo0NjozNVrOFve4Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QxOTo1NDoyN1rOFvfIOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzMzMxOQ==", "bodyText": "I don't think we've used this naming pattern of suffixing with _DEPRECATED before. If we are going to change the object name, perhaps instead we could refer to this as the \"general\" version since that is the terminology you used elsewhere? eg SCRIPT_GENERAL_CACHE_SIZE_SETTING. We also need the Property.Deprecated on these.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385333319", "createdAt": "2020-02-27T19:46:35Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,15 +94,52 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING_DEPRECATED =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzMzgzMA==", "bodyText": "call caps case?", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385333830", "createdAt": "2020-02-27T19:47:35Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,15 +94,52 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING_DEPRECATED =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING_DEPRECATED =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED =\n             new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n \n+    // Per-context settings\n+    static final String contextPrefix = \"script.context.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNDk3Ng==", "bodyText": "Why are we not just using the exists method?", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385334976", "createdAt": "2020-02-27T19:49:46Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -201,13 +240,138 @@ public ScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<S\n         }\n \n         this.setMaxSizeInBytes(SCRIPT_MAX_SIZE_IN_BYTES.get(settings));\n-        compiler = new ScriptCache(\n-                    SCRIPT_CACHE_SIZE_SETTING.get(settings),\n-                    SCRIPT_CACHE_EXPIRE_SETTING.get(settings),\n+        generalCache = initCache(settings, contextCache, contexts.keySet());\n+    }\n+\n+    /**\n+     * initialize contextCache with per context settings or return a general script cache\n+     */\n+    ScriptCache initCache(Settings settings, Map<String, ScriptCache> contextCache, Set<String> contextNames) {\n+        if (useGeneralCacheSettings(settings)) {\n+            return new ScriptCache(\n+                SCRIPT_CACHE_SIZE_SETTING_DEPRECATED.get(settings),\n+                SCRIPT_CACHE_EXPIRE_SETTING_DEPRECATED.get(settings),\n+                compilationLimitsEnabled() ?\n+                    SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED.get(settings):\n+                    new Tuple<>(0, TimeValue.ZERO)\n+            );\n+        }\n+\n+        Map<String, Integer> sizePerContext = SCRIPT_CACHE_SIZE_SETTING.getAsMap(settings);\n+        Map<String, TimeValue> expirePerContext = SCRIPT_CACHE_EXPIRE_SETTING.getAsMap(settings);\n+        Map<String, Tuple<Integer, TimeValue>> ratePerContext = SCRIPT_MAX_COMPILATIONS_RATE.getAsMap(settings);\n+\n+        List<String> badContexts = invalidContextSettings(contextNames, sizePerContext.keySet(), expirePerContext.keySet(),\n+                                    ratePerContext.keySet());\n+        if (badContexts.size() > 0) {\n+            throw new IllegalArgumentException(\"Invalid contexts for script cache settings [\" + String.join(\", \", badContexts) + \"]\");\n+        }\n+\n+        for (String contextName: contexts.keySet()) {\n+            contextCache.put(contextName,\n+                new ScriptCache(\n+                    sizePerContext.getOrDefault(contextName, SCRIPT_CACHE_SIZE_SETTING.getDefault(settings)),\n+                    expirePerContext.getOrDefault(contextName, SCRIPT_CACHE_EXPIRE_SETTING.getDefault(settings)),\n                     compilationLimitsEnabled() ?\n-                        SCRIPT_MAX_COMPILATIONS_RATE.get(settings):\n+                        ratePerContext.getOrDefault(contextName, SCRIPT_MAX_COMPILATIONS_RATE.getDefault(settings)) :\n                         new Tuple<>(0, TimeValue.ZERO)\n-                    );\n+                )\n+            );\n+        }\n+\n+        return null;\n+    }\n+\n+    /**\n+     * Return all setting values that do not correspond to the set of contexts.  Visible for testing.\n+     */\n+    static List<String> invalidContextSettings(Set<String> contextNames, Set<String> size, Set<String> expire, Set<String> rate) {\n+        Set<String> badSize = new HashSet<>(size);\n+        Set<String> badExpire = new HashSet<>(expire);\n+        Set<String> badRate = new HashSet<>(rate);\n+        for (String context: contextNames) {\n+            badSize.remove(context);\n+            badExpire.remove(context);\n+            badRate.remove(context);\n+        }\n+\n+        List<String> badSettings = new ArrayList<>();\n+        for (String sizeContext: badSize) {\n+            badSettings.add(SCRIPT_CACHE_SIZE_SETTING.getConcreteSettingForNamespace(sizeContext).getKey());\n+        }\n+        for (String expireContext: badExpire) {\n+            badSettings.add(SCRIPT_CACHE_EXPIRE_SETTING.getConcreteSettingForNamespace(expireContext).getKey());\n+        }\n+        for (String rateContext: badRate) {\n+            badSettings.add(SCRIPT_MAX_COMPILATIONS_RATE.getConcreteSettingForNamespace(rateContext).getKey());\n+        }\n+\n+        Collections.sort(badSettings);\n+        return badSettings;\n+    }\n+\n+    /**\n+     * Ensure that either the general cache settings are given or the per context settings are given.  If neither are set, the default is to\n+     * using general cache settings.\n+     * Visible for testing\n+     * TODO(stu): change default to per context when context defaults exist\n+     */\n+    static boolean useGeneralCacheSettings(Settings settings) {\n+        Set<String> generalKeys = new HashSet<>();\n+        Set<String> contextKeys = new HashSet<>();\n+        for (String key: settings.keySet()) {\n+            if (SCRIPT_CACHE_SIZE_SETTING_DEPRECATED.match(key) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 163}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNTgzNg==", "bodyText": "This looks like the case for cross setting validation. Whether the general cache should be created should strictly be based on any general cache settings existing. Validating both sets of settings don't exist at the same time is a separate issue, and can be done by the settings validators themselves.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385335836", "createdAt": "2020-02-27T19:51:28Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -201,13 +240,138 @@ public ScriptService(Settings settings, Map<String, ScriptEngine> engines, Map<S\n         }\n \n         this.setMaxSizeInBytes(SCRIPT_MAX_SIZE_IN_BYTES.get(settings));\n-        compiler = new ScriptCache(\n-                    SCRIPT_CACHE_SIZE_SETTING.get(settings),\n-                    SCRIPT_CACHE_EXPIRE_SETTING.get(settings),\n+        generalCache = initCache(settings, contextCache, contexts.keySet());\n+    }\n+\n+    /**\n+     * initialize contextCache with per context settings or return a general script cache\n+     */\n+    ScriptCache initCache(Settings settings, Map<String, ScriptCache> contextCache, Set<String> contextNames) {\n+        if (useGeneralCacheSettings(settings)) {\n+            return new ScriptCache(\n+                SCRIPT_CACHE_SIZE_SETTING_DEPRECATED.get(settings),\n+                SCRIPT_CACHE_EXPIRE_SETTING_DEPRECATED.get(settings),\n+                compilationLimitsEnabled() ?\n+                    SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED.get(settings):\n+                    new Tuple<>(0, TimeValue.ZERO)\n+            );\n+        }\n+\n+        Map<String, Integer> sizePerContext = SCRIPT_CACHE_SIZE_SETTING.getAsMap(settings);\n+        Map<String, TimeValue> expirePerContext = SCRIPT_CACHE_EXPIRE_SETTING.getAsMap(settings);\n+        Map<String, Tuple<Integer, TimeValue>> ratePerContext = SCRIPT_MAX_COMPILATIONS_RATE.getAsMap(settings);\n+\n+        List<String> badContexts = invalidContextSettings(contextNames, sizePerContext.keySet(), expirePerContext.keySet(),\n+                                    ratePerContext.keySet());\n+        if (badContexts.size() > 0) {\n+            throw new IllegalArgumentException(\"Invalid contexts for script cache settings [\" + String.join(\", \", badContexts) + \"]\");\n+        }\n+\n+        for (String contextName: contexts.keySet()) {\n+            contextCache.put(contextName,\n+                new ScriptCache(\n+                    sizePerContext.getOrDefault(contextName, SCRIPT_CACHE_SIZE_SETTING.getDefault(settings)),\n+                    expirePerContext.getOrDefault(contextName, SCRIPT_CACHE_EXPIRE_SETTING.getDefault(settings)),\n                     compilationLimitsEnabled() ?\n-                        SCRIPT_MAX_COMPILATIONS_RATE.get(settings):\n+                        ratePerContext.getOrDefault(contextName, SCRIPT_MAX_COMPILATIONS_RATE.getDefault(settings)) :\n                         new Tuple<>(0, TimeValue.ZERO)\n-                    );\n+                )\n+            );\n+        }\n+\n+        return null;\n+    }\n+\n+    /**\n+     * Return all setting values that do not correspond to the set of contexts.  Visible for testing.\n+     */\n+    static List<String> invalidContextSettings(Set<String> contextNames, Set<String> size, Set<String> expire, Set<String> rate) {\n+        Set<String> badSize = new HashSet<>(size);\n+        Set<String> badExpire = new HashSet<>(expire);\n+        Set<String> badRate = new HashSet<>(rate);\n+        for (String context: contextNames) {\n+            badSize.remove(context);\n+            badExpire.remove(context);\n+            badRate.remove(context);\n+        }\n+\n+        List<String> badSettings = new ArrayList<>();\n+        for (String sizeContext: badSize) {\n+            badSettings.add(SCRIPT_CACHE_SIZE_SETTING.getConcreteSettingForNamespace(sizeContext).getKey());\n+        }\n+        for (String expireContext: badExpire) {\n+            badSettings.add(SCRIPT_CACHE_EXPIRE_SETTING.getConcreteSettingForNamespace(expireContext).getKey());\n+        }\n+        for (String rateContext: badRate) {\n+            badSettings.add(SCRIPT_MAX_COMPILATIONS_RATE.getConcreteSettingForNamespace(rateContext).getKey());\n+        }\n+\n+        Collections.sort(badSettings);\n+        return badSettings;\n+    }\n+\n+    /**\n+     * Ensure that either the general cache settings are given or the per context settings are given.  If neither are set, the default is to\n+     * using general cache settings.\n+     * Visible for testing\n+     * TODO(stu): change default to per context when context defaults exist\n+     */\n+    static boolean useGeneralCacheSettings(Settings settings) {\n+        Set<String> generalKeys = new HashSet<>();\n+        Set<String> contextKeys = new HashSet<>();\n+        for (String key: settings.keySet()) {\n+            if (SCRIPT_CACHE_SIZE_SETTING_DEPRECATED.match(key) ||\n+                SCRIPT_CACHE_EXPIRE_SETTING_DEPRECATED.match(key) ||\n+                SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED.match(key)) {\n+\n+                generalKeys.add(key);\n+\n+            } else if (\n+                SCRIPT_CACHE_SIZE_SETTING.getRawKey().match(key) ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 170}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTMzNzQwMA==", "bodyText": "I think we need to consider changing the signature here to allow the old value to be passed through. We have it in the update consumer within Setting. Also, using the cross setting validation should allow simpler validation here I think. See the other validate methods that can be implemented on Setting.Validator.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r385337400", "createdAt": "2020-02-27T19:54:27Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -219,7 +383,29 @@ boolean compilationLimitsEnabled() {\n \n     void registerClusterSettingsListeners(ClusterSettings clusterSettings) {\n         clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_SIZE_IN_BYTES, this::setMaxSizeInBytes);\n-        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE, compiler::setMaxCompilationRate);\n+        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE_DEPRECATED,\n+                // Don't deref potentially null generalCache\n+                r -> {\n+                    if (generalCache != null) {\n+                        generalCache.setMaxCompilationRate(r);\n+                    }\n+                },\n+                s -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cc359cb0d3ebd4db50869a27995f0c4206f5d0e"}, "originalPosition": 230}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc55177fc24d173fe72b257ac7eea8401778243b", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc55177fc24d173fe72b257ac7eea8401778243b", "committedDate": "2020-02-27T20:24:30Z", "message": "Setting SCRIPT_*_DEPRECATED -> SCRIPT_GENERAL_*; contextPrefix -> CONTEXT_PREFIX, use `exists` for non-affix settings; Remove general compilation rate exists check in dynamic validator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e0cbb9056752883c37e53a23e185ea089983ee2", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e0cbb9056752883c37e53a23e185ea089983ee2", "committedDate": "2020-02-28T22:08:45Z", "message": "Settings: AffixSettings as validator dependencies\n\nAllow AffixSetting as validator dependencies.  If a validator\nspecifies AffixSettings as a dependency, then `validate(T, Map)`\nwill have the concrete setting in a map.\n\nFixes: #52933"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c516495932ae176311b79f2fe778e0a13a7d60e5", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/c516495932ae176311b79f2fe778e0a13a7d60e5", "committedDate": "2020-03-02T20:16:18Z", "message": "Use validators for TimeSettings, use atomic ref to change context settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5762bd5eb6317585c4707504e00b7f27991bc2fb", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/5762bd5eb6317585c4707504e00b7f27991bc2fb", "committedDate": "2020-03-02T21:25:50Z", "message": "Get affix match any"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab9ad444d8ad7f933e4e33f426615fc64c0abd5f", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab9ad444d8ad7f933e4e33f426615fc64c0abd5f", "committedDate": "2020-03-03T00:02:28Z", "message": "WIP flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06f0bd887a77af0c293a0fd556338fde629d876b", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/06f0bd887a77af0c293a0fd556338fde629d876b", "committedDate": "2020-03-03T02:14:24Z", "message": "Add script.context.cache_enabled setting, use single cache updater to process updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfa97f9cabc6885af3b58eaad65081780f2cecdd", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfa97f9cabc6885af3b58eaad65081780f2cecdd", "committedDate": "2020-03-04T23:10:56Z", "message": "Allow \"use-context\" setting to flip back and forth between context and general caches"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7b6ef8b9efd8587d2450b61f7e6a456ecb6f33f", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7b6ef8b9efd8587d2450b61f7e6a456ecb6f33f", "committedDate": "2020-03-04T23:12:55Z", "message": "Merge branch 'master' into fix/50152-painless-limit-per-context__02__context_specific"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ce234af3e41f5103ba8329ebafc0b78e3d61d51", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ce234af3e41f5103ba8329ebafc0b78e3d61d51", "committedDate": "2020-03-04T23:32:53Z", "message": "Remove commented out tests, unnecessary settings updates, simpile cache checking"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c59b352e9d99d4eb92cddce8bd045710c74fd3d", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c59b352e9d99d4eb92cddce8bd045710c74fd3d", "committedDate": "2020-03-09T20:23:56Z", "message": "Add some cache object tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ae8bb10e4bb77a2430367fd5569675067c7600", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8ae8bb10e4bb77a2430367fd5569675067c7600", "committedDate": "2020-03-09T22:09:18Z", "message": "Test per context nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6310977482d2839734a872d2c3193fc0a08de11c", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/6310977482d2839734a872d2c3193fc0a08de11c", "committedDate": "2020-03-09T22:09:51Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__02__context_specific"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNTk1NTMy", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-371595532", "createdAt": "2020-03-09T23:36:18Z", "commit": {"oid": "6310977482d2839734a872d2c3193fc0a08de11c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzozNjoxOFrOFz81Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQyMzozNjoxOFrOFz81Ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDAxODMzOA==", "bodyText": "ZERO is pretty vague as a name here, but I see it matches TimeValue. Maybe this could be SCRIPT_COMPILATION_RATE_ZERO or something like that to match SCRIPT_COMPILATION_RATE.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390018338", "createdAt": "2020-03-09T23:36:18Z", "author": {"login": "jdconrad"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -468,11 +515,259 @@ public ScriptLanguagesInfo getScriptLanguages() {\n     }\n \n     public ScriptStats stats() {\n-        return compiler.stats();\n+        return cache.get().stats();\n     }\n \n     @Override\n     public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n+\n+    /**\n+     * CacheUpdater updates the script cache based on dynamic settings updates.  It keeps track of which context and general\n+     * settings are set to determine how to fall back on settings.\n+     *\n+     * If the context specific {size, expiration} are set then they are used.  Otherwise, if the general {size, expiration} are\n+     * set to the non-default, then we fall back to those.  Finally, if neither are set we use the context default.\n+     *\n+     * If the general compilation rate is set to the special value {@code ScriptService.USE_CONTEXT_RATE_KEY}, {@code \"use-context\"},\n+     * then context caches are used.  If the general compilation rate is set to a valid value, eg 50/1m, then the general\n+     * cache is used.\n+     */\n+    static class CacheUpdater {\n+        private final Object lock = new Object();\n+        private static final Tuple<Integer, TimeValue> ZERO = new Tuple<>(0, TimeValue.ZERO);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6310977482d2839734a872d2c3193fc0a08de11c"}, "originalPosition": 175}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "020cc27a7685cfd9ad17213835e66591eb1dfc93", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/020cc27a7685cfd9ad17213835e66591eb1dfc93", "committedDate": "2020-03-10T15:17:54Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__02__context_specific"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/893f18732d8d3d12329c144afdb29640132ccd0d", "committedDate": "2020-03-10T15:22:20Z", "message": "ZERO -> SCRIPT_COMPILATION_RATE_ZERO"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMDY4MTYy", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-372068162", "createdAt": "2020-03-10T15:34:02Z", "commit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNTozNDowM1rOF0Ud2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQyMToxNTozNFrOF0hUig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNTU5Mw==", "bodyText": "Since we are renaming this variable anyways, can we make it consistent with the rest here ending in _SETTING?", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390405593", "createdAt": "2020-03-10T15:34:03Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,14 +102,45 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_GENERAL_CACHE_SIZE_SETTING =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_GENERAL_CACHE_EXPIRE_SETTING =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n-            new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_GENERAL_MAX_COMPILATIONS_RATE =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwNjIwNA==", "bodyText": "ditto on ending with _SETTING", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390406204", "createdAt": "2020-03-10T15:34:51Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,14 +102,45 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_GENERAL_CACHE_SIZE_SETTING =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_GENERAL_CACHE_EXPIRE_SETTING =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n-            new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_GENERAL_MAX_COMPILATIONS_RATE =\n+        new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION,\n+            Property.Dynamic, Property.NodeScope);\n+\n+    // Per-context settings\n+    static final String CONTEXT_PREFIX = \"script.context.\";\n+\n+    // script.context.<context-name>.{cache_max_size, cache_expire, max_compilations_rate}\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+        Setting.affixKeySetting(CONTEXT_PREFIX,\n+            \"cache_max_size\",\n+            key -> Setting.intSetting(key, 100, 0, Property.NodeScope, Property.Dynamic));\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+        Setting.affixKeySetting(CONTEXT_PREFIX,\n+            \"cache_expire\",\n+            key -> Setting.positiveTimeSetting(key, TimeValue.timeValueMillis(0), Property.NodeScope, Property.Dynamic));\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQwOTA4Mw==", "bodyText": "Can we move this into a lambda for the general setting, wrapping around this function? That way we don't need extra validation for the per context setting.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390409083", "createdAt": "2020-03-10T15:38:40Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -61,10 +62,18 @@\n \n     static final String DISABLE_DYNAMIC_SCRIPTING_SETTING = \"script.disable_dynamic\";\n \n+    // Special setting value for SCRIPT_GENERAL_MAX_COMPILATIONS_RATE to indicate the script service should use context\n+    // specific caches\n+    static final Tuple<Integer, TimeValue> USE_CONTEXT_RATE_VALUE = new Tuple<>(-1, TimeValue.MINUS_ONE);\n+    static final String USE_CONTEXT_RATE_KEY = \"use-context\";\n+\n     // a parsing function that requires a non negative int and a timevalue as arguments split by a slash\n     // this allows you to easily define rates\n     static final Function<String, Tuple<Integer, TimeValue>> MAX_COMPILATION_RATE_FUNCTION =\n             (String value) -> {\n+                if (value.equals(USE_CONTEXT_RATE_KEY)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQxODEzMg==", "bodyText": "What is this sentinel value? I don't see it described here anywhere.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390418132", "createdAt": "2020-03-10T15:50:40Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,14 +102,45 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_GENERAL_CACHE_SIZE_SETTING =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_GENERAL_CACHE_EXPIRE_SETTING =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n-            new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_GENERAL_MAX_COMPILATIONS_RATE =\n+        new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION,\n+            Property.Dynamic, Property.NodeScope);\n+\n+    // Per-context settings\n+    static final String CONTEXT_PREFIX = \"script.context.\";\n+\n+    // script.context.<context-name>.{cache_max_size, cache_expire, max_compilations_rate}\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMDkxMA==", "bodyText": "Shouldn't this be an illegal state? Can this be an assertion?", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390420910", "createdAt": "2020-03-10T15:54:22Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -304,7 +346,12 @@ void setMaxSizeInBytes(int newMaxSizeInBytes) {\n             logger.trace(\"compiling lang: [{}] type: [{}] script: {}\", lang, type, idOrCode);\n         }\n \n-        return compiler.compile(context, scriptEngine, id, idOrCode, type, options);\n+        ScriptCache scriptCache = this.cache.get().contextCache.get(context.name);\n+        if (scriptCache == null) {\n+            throw new IllegalArgumentException(\"script context [\" + context.name + \"] has no script cache\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 142}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQyMTYzOQ==", "bodyText": "Why aren't the general expire and size settings here as well?", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390421639", "createdAt": "2020-03-10T15:55:24Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -219,7 +252,16 @@ boolean compilationLimitsEnabled() {\n \n     void registerClusterSettingsListeners(ClusterSettings clusterSettings) {\n         clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_SIZE_IN_BYTES, this::setMaxSizeInBytes);\n-        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE, compiler::setMaxCompilationRate);\n+        clusterSettings.addSettingsUpdateConsumer(SCRIPT_GENERAL_MAX_COMPILATIONS_RATE, cacheUpdater::setMaxCompilationRate);\n+        clusterSettings.addAffixUpdateConsumer(SCRIPT_CACHE_SIZE_SETTING,\n+                                               cacheUpdater::setScriptCacheSize,\n+                                               cacheUpdater::contextExists);\n+        clusterSettings.addAffixUpdateConsumer(SCRIPT_CACHE_EXPIRE_SETTING,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU5ODk2Mw==", "bodyText": "This should have a fallback of the general expire setting.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390598963", "createdAt": "2020-03-10T20:43:48Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,14 +102,45 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_GENERAL_CACHE_SIZE_SETTING =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_GENERAL_CACHE_EXPIRE_SETTING =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n-            new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_GENERAL_MAX_COMPILATIONS_RATE =\n+        new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION,\n+            Property.Dynamic, Property.NodeScope);\n+\n+    // Per-context settings\n+    static final String CONTEXT_PREFIX = \"script.context.\";\n+\n+    // script.context.<context-name>.{cache_max_size, cache_expire, max_compilations_rate}\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+        Setting.affixKeySetting(CONTEXT_PREFIX,\n+            \"cache_max_size\",\n+            key -> Setting.intSetting(key, 100, 0, Property.NodeScope, Property.Dynamic));\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+        Setting.affixKeySetting(CONTEXT_PREFIX,\n+            \"cache_expire\",\n+            key -> Setting.positiveTimeSetting(key, TimeValue.timeValueMillis(0), Property.NodeScope, Property.Dynamic));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDU5OTI3OQ==", "bodyText": "This should have a fallback of the general size setting.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390599279", "createdAt": "2020-03-10T20:44:18Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -93,14 +102,45 @@\n                 }\n             };\n \n-    public static final Setting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+    public static final Setting<Integer> SCRIPT_GENERAL_CACHE_SIZE_SETTING =\n         Setting.intSetting(\"script.cache.max_size\", 100, 0, Property.NodeScope);\n-    public static final Setting<TimeValue> SCRIPT_CACHE_EXPIRE_SETTING =\n+    public static final Setting<TimeValue> SCRIPT_GENERAL_CACHE_EXPIRE_SETTING =\n         Setting.positiveTimeSetting(\"script.cache.expire\", TimeValue.timeValueMillis(0), Property.NodeScope);\n     public static final Setting<Integer> SCRIPT_MAX_SIZE_IN_BYTES =\n         Setting.intSetting(\"script.max_size_in_bytes\", 65535, 0, Property.Dynamic, Property.NodeScope);\n-    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_MAX_COMPILATIONS_RATE =\n-            new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION, Property.Dynamic, Property.NodeScope);\n+    public static final Setting<Tuple<Integer, TimeValue>> SCRIPT_GENERAL_MAX_COMPILATIONS_RATE =\n+        new Setting<>(\"script.max_compilations_rate\", \"75/5m\", MAX_COMPILATION_RATE_FUNCTION,\n+            Property.Dynamic, Property.NodeScope);\n+\n+    // Per-context settings\n+    static final String CONTEXT_PREFIX = \"script.context.\";\n+\n+    // script.context.<context-name>.{cache_max_size, cache_expire, max_compilations_rate}\n+\n+    // TODO(stu): set to sentinel value when we start using per-context defaults\n+    public static final Setting.AffixSetting<Integer> SCRIPT_CACHE_SIZE_SETTING =\n+        Setting.affixKeySetting(CONTEXT_PREFIX,\n+            \"cache_max_size\",\n+            key -> Setting.intSetting(key, 100, 0, Property.NodeScope, Property.Dynamic));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwMDEyMA==", "bodyText": "Why are we testing for the setting existing? We should be using fallback settings and never need to look at this setting directly except when constructing the general cache.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390600120", "createdAt": "2020-03-10T20:45:55Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -468,11 +515,260 @@ public ScriptLanguagesInfo getScriptLanguages() {\n     }\n \n     public ScriptStats stats() {\n-        return compiler.stats();\n+        return cache.get().stats();\n     }\n \n     @Override\n     public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n+\n+    /**\n+     * CacheUpdater updates the script cache based on dynamic settings updates.  It keeps track of which context and general\n+     * settings are set to determine how to fall back on settings.\n+     *\n+     * If the context specific {size, expiration} are set then they are used.  Otherwise, if the general {size, expiration} are\n+     * set to the non-default, then we fall back to those.  Finally, if neither are set we use the context default.\n+     *\n+     * If the general compilation rate is set to the special value {@code ScriptService.USE_CONTEXT_RATE_KEY}, {@code \"use-context\"},\n+     * then context caches are used.  If the general compilation rate is set to a valid value, eg 50/1m, then the general\n+     * cache is used.\n+     */\n+    static class CacheUpdater {\n+        private final Object lock = new Object();\n+        private static final Tuple<Integer, TimeValue> SCRIPT_COMPILATION_RATE_ZERO = new Tuple<>(0, TimeValue.ZERO);\n+\n+        final boolean generalSizeSet;\n+        final Set<String> contextSizeSet;\n+        final Integer sizeDefault = SCRIPT_CACHE_SIZE_SETTING.getDefault(Settings.EMPTY);\n+\n+        final boolean generalExpireSet;\n+        final Set<String> contextExpireSet;\n+        final TimeValue expireDefault = SCRIPT_CACHE_EXPIRE_SETTING.getDefault(Settings.EMPTY);\n+\n+        private final CacheSettings generalSettings;\n+        private final Map<String, CacheSettings> contextSettings;\n+\n+        private AtomicReference<ScriptService.Cache> cacheRef;\n+\n+        CacheUpdater(\n+            Settings settings,\n+            Map<String, ScriptContext<?>> contexts,\n+            boolean compilationLimitsEnabled,\n+            AtomicReference<ScriptService.Cache> cacheRef\n+        ) {\n+            this.cacheRef = cacheRef;\n+\n+            generalSizeSet = SCRIPT_GENERAL_CACHE_SIZE_SETTING.exists(settings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwMTM2MA==", "bodyText": "We have the contexts on the ScriptService, could we instead have this method there? Which contexts exist has little to do with how the caches are updated.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390601360", "createdAt": "2020-03-10T20:48:21Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -468,11 +515,260 @@ public ScriptLanguagesInfo getScriptLanguages() {\n     }\n \n     public ScriptStats stats() {\n-        return compiler.stats();\n+        return cache.get().stats();\n     }\n \n     @Override\n     public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n+\n+    /**\n+     * CacheUpdater updates the script cache based on dynamic settings updates.  It keeps track of which context and general\n+     * settings are set to determine how to fall back on settings.\n+     *\n+     * If the context specific {size, expiration} are set then they are used.  Otherwise, if the general {size, expiration} are\n+     * set to the non-default, then we fall back to those.  Finally, if neither are set we use the context default.\n+     *\n+     * If the general compilation rate is set to the special value {@code ScriptService.USE_CONTEXT_RATE_KEY}, {@code \"use-context\"},\n+     * then context caches are used.  If the general compilation rate is set to a valid value, eg 50/1m, then the general\n+     * cache is used.\n+     */\n+    static class CacheUpdater {\n+        private final Object lock = new Object();\n+        private static final Tuple<Integer, TimeValue> SCRIPT_COMPILATION_RATE_ZERO = new Tuple<>(0, TimeValue.ZERO);\n+\n+        final boolean generalSizeSet;\n+        final Set<String> contextSizeSet;\n+        final Integer sizeDefault = SCRIPT_CACHE_SIZE_SETTING.getDefault(Settings.EMPTY);\n+\n+        final boolean generalExpireSet;\n+        final Set<String> contextExpireSet;\n+        final TimeValue expireDefault = SCRIPT_CACHE_EXPIRE_SETTING.getDefault(Settings.EMPTY);\n+\n+        private final CacheSettings generalSettings;\n+        private final Map<String, CacheSettings> contextSettings;\n+\n+        private AtomicReference<ScriptService.Cache> cacheRef;\n+\n+        CacheUpdater(\n+            Settings settings,\n+            Map<String, ScriptContext<?>> contexts,\n+            boolean compilationLimitsEnabled,\n+            AtomicReference<ScriptService.Cache> cacheRef\n+        ) {\n+            this.cacheRef = cacheRef;\n+\n+            generalSizeSet = SCRIPT_GENERAL_CACHE_SIZE_SETTING.exists(settings);\n+            generalExpireSet = SCRIPT_GENERAL_CACHE_EXPIRE_SETTING.exists(settings);\n+\n+            generalSettings = new CacheSettings(\n+                SCRIPT_GENERAL_CACHE_SIZE_SETTING.get(settings),\n+                SCRIPT_GENERAL_CACHE_EXPIRE_SETTING.get(settings),\n+                compilationLimitsEnabled ? SCRIPT_GENERAL_MAX_COMPILATIONS_RATE.get(settings) : SCRIPT_COMPILATION_RATE_ZERO\n+            );\n+\n+            Map<String, Integer> cacheSize = SCRIPT_CACHE_SIZE_SETTING.getAsMap(settings);\n+            Map<String, TimeValue> cacheExpire = SCRIPT_CACHE_EXPIRE_SETTING.getAsMap(settings);\n+            Map<String, Tuple<Integer, TimeValue>> compileRate = SCRIPT_MAX_COMPILATIONS_RATE.getAsMap(settings);\n+\n+            Map<String, CacheSettings> contextSettings = new HashMap<>(contexts.size());\n+\n+            for (String context: contexts.keySet()) {\n+                contextSettings.put(context,\n+                    new CacheSettings(\n+                        cacheSize.getOrDefault(context, SCRIPT_CACHE_SIZE_SETTING.getDefault(settings)),\n+                        cacheExpire.getOrDefault(context, SCRIPT_CACHE_EXPIRE_SETTING.getDefault(settings)),\n+                        compilationLimitsEnabled ?\n+                            compileRate.getOrDefault(context, SCRIPT_MAX_COMPILATIONS_RATE.getDefault(settings)) :\n+                            SCRIPT_COMPILATION_RATE_ZERO\n+                    )\n+                );\n+            }\n+\n+            this.contextSettings = Collections.unmodifiableMap(contextSettings);\n+            this.contextSizeSet = new HashSet<>(cacheSize.keySet());\n+            this.contextExpireSet = new HashSet<>(cacheExpire.keySet());\n+\n+            if (isContextCacheEnabled()) {\n+                buildContextCache();\n+            } else {\n+                buildGeneralCache();\n+            }\n+        }\n+\n+        boolean isContextCacheEnabled() {\n+            return generalSettings.compileRate.equals(USE_CONTEXT_RATE_VALUE);\n+        }\n+\n+        void contextExists(String context, Object o) {\n+            if (contextSettings.containsKey(context) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 241}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYwNDk2MQ==", "bodyText": "We shouldn't need to extract the default. Fallback settings exist so we can chain them together. We just do a get on the setting we care about (eg context expire setting), and if it doesn't exist, it will lookup the fallback (this general setting), and if that doesn't exist, it will use the default.", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390604961", "createdAt": "2020-03-10T20:55:02Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -468,11 +515,260 @@ public ScriptLanguagesInfo getScriptLanguages() {\n     }\n \n     public ScriptStats stats() {\n-        return compiler.stats();\n+        return cache.get().stats();\n     }\n \n     @Override\n     public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n+\n+    /**\n+     * CacheUpdater updates the script cache based on dynamic settings updates.  It keeps track of which context and general\n+     * settings are set to determine how to fall back on settings.\n+     *\n+     * If the context specific {size, expiration} are set then they are used.  Otherwise, if the general {size, expiration} are\n+     * set to the non-default, then we fall back to those.  Finally, if neither are set we use the context default.\n+     *\n+     * If the general compilation rate is set to the special value {@code ScriptService.USE_CONTEXT_RATE_KEY}, {@code \"use-context\"},\n+     * then context caches are used.  If the general compilation rate is set to a valid value, eg 50/1m, then the general\n+     * cache is used.\n+     */\n+    static class CacheUpdater {\n+        private final Object lock = new Object();\n+        private static final Tuple<Integer, TimeValue> SCRIPT_COMPILATION_RATE_ZERO = new Tuple<>(0, TimeValue.ZERO);\n+\n+        final boolean generalSizeSet;\n+        final Set<String> contextSizeSet;\n+        final Integer sizeDefault = SCRIPT_CACHE_SIZE_SETTING.getDefault(Settings.EMPTY);\n+\n+        final boolean generalExpireSet;\n+        final Set<String> contextExpireSet;\n+        final TimeValue expireDefault = SCRIPT_CACHE_EXPIRE_SETTING.getDefault(Settings.EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 183}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDYxNjIwMg==", "bodyText": "One problem that seems to make this more complicated is having individual update consumers. There is an existing method we can use that takes a list of settings, and passes all the values when any are updated. I think using this pattern will make the code simpler (less locking and special cases). The pattern I'm imagining is something like an update consumer for the following scenarios:\n\ngeneral settings -> this changes the general cache, and handles flipping between general and per context\nper context + general settings -> the general settings along with concrete settings for each context. if the general cache is used, this would result in an error if any of the per context settings exist. otherwise the ScriptCache for that context would be looked up. All 3 setting values should then be passed into a single update method on ScriptCache, so it can be rebuilt once whether one or all 3 settings change (or the fallbacks for size/expire changed).", "url": "https://github.com/elastic/elasticsearch/pull/52855#discussion_r390616202", "createdAt": "2020-03-10T21:15:34Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -219,7 +252,16 @@ boolean compilationLimitsEnabled() {\n \n     void registerClusterSettingsListeners(ClusterSettings clusterSettings) {\n         clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_SIZE_IN_BYTES, this::setMaxSizeInBytes);\n-        clusterSettings.addSettingsUpdateConsumer(SCRIPT_MAX_COMPILATIONS_RATE, compiler::setMaxCompilationRate);\n+        clusterSettings.addSettingsUpdateConsumer(SCRIPT_GENERAL_MAX_COMPILATIONS_RATE, cacheUpdater::setMaxCompilationRate);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "893f18732d8d3d12329c144afdb29640132ccd0d"}, "originalPosition": 122}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b626a163cd303b23ba585920a35a64d060e73a", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9b626a163cd303b23ba585920a35a64d060e73a", "committedDate": "2020-03-11T17:17:56Z", "message": "SCRIPT_MAX_COMPILATIONS_RATE += _SETTING, CacheUpdater:contextExists -> ScriptService, throw to assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6672e6472a8e4b024d4c14ab81a796a87c85c674", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/6672e6472a8e4b024d4c14ab81a796a87c85c674", "committedDate": "2020-03-11T17:28:26Z", "message": "MAX_COMPILATION_RATE_FUNCTION check of USE_CONTEXT_RATE_KEY moved to lambda in SCRIPT_GENERAL_MAX_COMPILATIONS_RATE_SETTING"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfb77edf9793bb461eff99850c97e938c279ec01", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfb77edf9793bb461eff99850c97e938c279ec01", "committedDate": "2020-03-11T17:33:12Z", "message": "flip assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6deb708bafd45dfb6166dae3437d606483e7c8bc", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/6deb708bafd45dfb6166dae3437d606483e7c8bc", "committedDate": "2020-03-11T17:41:11Z", "message": "script.context.$CONTEXT.{cache_max_size,cache_expire} fallback to general settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "821cc54eaf93539c4ba3b9700a41fd30357ad3fa", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/821cc54eaf93539c4ba3b9700a41fd30357ad3fa", "committedDate": "2020-03-13T16:06:30Z", "message": "use validator in group settings updater, validate all settings together"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ec2ab8b1ea2a49c060253f8b07a4eb4810da36", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/76ec2ab8b1ea2a49c060253f8b07a4eb4810da36", "committedDate": "2020-03-13T17:02:21Z", "message": "Update dependencies on context cache updaters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b588673dfde08e41fab5552bce76237370d6fb3c", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/b588673dfde08e41fab5552bce76237370d6fb3c", "committedDate": "2020-03-13T18:55:11Z", "message": "Add conflict, fallback, and validator tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63ffa650287b82cf7cfada34f1c336881f75a195", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/63ffa650287b82cf7cfada34f1c336881f75a195", "committedDate": "2020-03-13T20:48:12Z", "message": "CacheHolder settings tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "557c8561b207cd75fe20e2a8e7b30bbdcbd5425a", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/557c8561b207cd75fe20e2a8e7b30bbdcbd5425a", "committedDate": "2020-03-13T21:31:29Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__02__context_specific"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MTU5ODQ1", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-376159845", "createdAt": "2020-03-17T15:44:40Z", "commit": {"oid": "557c8561b207cd75fe20e2a8e7b30bbdcbd5425a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc3MTMwMzA3", "url": "https://github.com/elastic/elasticsearch/pull/52855#pullrequestreview-377130307", "createdAt": "2020-03-18T18:28:22Z", "commit": {"oid": "557c8561b207cd75fe20e2a8e7b30bbdcbd5425a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1986, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}