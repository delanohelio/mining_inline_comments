{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyMjQ3NjAy", "number": 64337, "title": " Do not skip not available shard exception in search response", "bodyText": "Today search responses do not report failures for shard that were not available\nfor the search.\nSo if one shard is not assigned on a search over 5 shards, the\nsearch response will report:\n\"_shards\": {\n   \"total\": 5,\n   \"successful\": 4,\n   \"skipped\": 0,\n   \"failed\": 0\n}\n\nIf all shards are unassigned, we report a generic search phase exception with no cause.\nIt's easy to spot that successful is less than total in the response but not reporting\nthe failure is misleading for users.\nThis change removes the special handling of not available shards exception in search responses\nand treat them as any other failure that could occur on a shard.\nThese exceptions will count in the failed section and will be reported in details in\nthe shard_failures section.\nCloses #47700", "createdAt": "2020-10-29T12:42:50Z", "url": "https://github.com/elastic/elasticsearch/pull/64337", "merged": true, "mergeCommit": {"oid": "6d22901eecc5987770673f2a02880f28e63be4cf"}, "closed": true, "closedAt": "2020-11-24T07:48:59Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXRgMxgH2gAyNTEyMjQ3NjAyOjIzMTBjMmYyOTUyMzZlMTA5MmFkZDU1MTkxZjEzNjRjNmJjM2UzYzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdea5QXAH2gAyNTEyMjQ3NjAyOmYwOTNlZDVkYTVkNjJhMWQ4MzIxZDBmMTYyYjk0OWYwYjA0MDExYTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2310c2f295236e1092add55191f1364c6bc3e3c8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2310c2f295236e1092add55191f1364c6bc3e3c8", "committedDate": "2020-10-29T12:41:03Z", "message": " Do not skip not available shard exception in search response\n\n Today search responses do not report failures for shard that were not available\n for the search.\n So if one shard is not assigned on a search over 5 shards, the\n search response will report:\n\n ```\n \"_shards\": {\n    \"total\": 5,\n    \"successful\": 4,\n    \"skipped\": 0,\n    \"failed\": 0\n}\n```\n\nIf all shards are unassigned, we report a generic search phase exception with no cause.\nIt's easy to spot that `successful` is less than `total` in the response but not reporting\nthe failure is misleading for users.\n\nThis change removes the special handling of not available shards exception in search responses\nand treat them as any other failure that could occur on a shard.\nThese exceptions will count in the `failed` section and will be reported in details in\nthe `shard_failures` section.\nIf all shards are unavailable, the search API will now return 404 NOT_FOUND as an indication\nthat the search failed because it couldn't find any of the resources.\n\nCloses #47700"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d", "committedDate": "2020-10-29T13:11:39Z", "message": "fix error status code in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ae20cc1b2dbc16b0632a2f003f4501445ecf93a", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ae20cc1b2dbc16b0632a2f003f4501445ecf93a", "committedDate": "2020-10-29T20:24:46Z", "message": "fix transform test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NjY3MDgx", "url": "https://github.com/elastic/elasticsearch/pull/64337#pullrequestreview-519667081", "createdAt": "2020-10-29T13:33:06Z", "commit": {"oid": "ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxMzozMzowN1rOHqb-Ig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwNzoyOToxMFrOHrD0GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI2MDUxNA==", "bodyText": "The many different shard not available exceptions have a variety of rest status codes. I wonder if it is best to wrap them or just create a NoShardAvailableActionException with the message from the inner exception - to get a 503 out every time. Otherwise we risk seeing among others a 400 NOT FOUND, which is a bit weird. Also, whether the shard was unavailable at the beginning of search or we detected it during the first phase of search is largely irrelevant to clients I think, using the same exception in all those cases could allow clients to filter out those specific errors if they want to.", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514260514", "createdAt": "2020-10-29T13:33:07Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/search/AbstractSearchAsyncAction.java", "diffHunk": "@@ -437,10 +437,10 @@ protected void onShardGroupFailure(int shardIndex, SearchShardTarget shardTarget\n      * @param e the failure reason\n      */\n     @Override\n-    public final void onShardFailure(final int shardIndex, @Nullable SearchShardTarget shardTarget, Exception e) {\n-        // we don't aggregate shard failures on non active shards and failures due to the internal cancellation,\n+    public final void onShardFailure(final int shardIndex, SearchShardTarget shardTarget, Exception e) {\n+        // we don't aggregate shard on failures due to the internal cancellation,\n         // but do keep the header counts right\n-        if (TransportActions.isShardNotAvailableException(e) == false && (requestCancelled.get() && isTaskCancelledException(e)) == false) {\n+        if ((requestCancelled.get() && isTaskCancelledException(e)) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae283b3bf95764b5ecd4f72206ea74dec7f4bf8d"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkxMzMwNQ==", "bodyText": "Could we also validate that a failure is returned here in the failures field (as well as it being the right kind of failure)?", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r514913305", "createdAt": "2020-10-30T07:29:10Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/basic/SearchRedStateIndexIT.java", "diffHunk": "@@ -52,7 +54,7 @@ public void testAllowPartialsWithRedState() throws Exception {\n         SearchResponse searchResponse = client().prepareSearch().setSize(0).setAllowPartialSearchResults(true)\n                 .get();\n         assertThat(RestStatus.OK, equalTo(searchResponse.status()));\n-        assertThat(\"Expect no shards failed\", searchResponse.getFailedShards(), equalTo(0));\n+        assertThat(\"Expect some shards failed\", searchResponse.getFailedShards(), allOf(greaterThan(0), lessThanOrEqualTo(numShards)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ae20cc1b2dbc16b0632a2f003f4501445ecf93a"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1427b5c1dde9e716c161f296b46a2e50aea3342a", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1427b5c1dde9e716c161f296b46a2e50aea3342a", "committedDate": "2020-10-30T09:44:35Z", "message": "apply review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce3b4e65eca2f03abede78dbe3680c814d971e45", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/ce3b4e65eca2f03abede78dbe3680c814d971e45", "committedDate": "2020-10-30T15:01:31Z", "message": "Merge branch 'master' into not_available_shards_search"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjQ4NDI3", "url": "https://github.com/elastic/elasticsearch/pull/64337#pullrequestreview-523248427", "createdAt": "2020-11-04T10:52:46Z", "commit": {"oid": "ce3b4e65eca2f03abede78dbe3680c814d971e45"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDo1Mjo0NlrOHtS7hw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDo1Mjo0NlrOHtS7hw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI1ODExOQ==", "bodyText": "I think we can now add an assertion to the constructor that shardFailures.length + successfullShards == totalShards?", "url": "https://github.com/elastic/elasticsearch/pull/64337#discussion_r517258119", "createdAt": "2020-11-04T10:52:46Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchResponse.java", "diffHunk": "@@ -204,8 +204,6 @@ public int getSkippedShards() {\n      * The failed number of shards the search was executed on.\n      */\n     public int getFailedShards() {\n-        // we don't return totalShards - successfulShards, we don't count \"no shards available\" as a failed shard, just don't", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce3b4e65eca2f03abede78dbe3680c814d971e45"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9615dde82525d47db9de89c2492aa5ac796ce88d", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/9615dde82525d47db9de89c2492aa5ac796ce88d", "committedDate": "2020-11-05T11:05:55Z", "message": "Merge branch 'master' into not_available_shards_search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31a3eebfecf8ebda32e7ca08d84b156ca887f8b0", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/31a3eebfecf8ebda32e7ca08d84b156ca887f8b0", "committedDate": "2020-11-20T11:18:36Z", "message": "Merge branch 'master' into not_available_shards_search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235416573feb3cae1b85b52417a6f1eaa6ce2edf", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/235416573feb3cae1b85b52417a6f1eaa6ce2edf", "committedDate": "2020-11-20T11:26:05Z", "message": "add assert in AbstractSearchAsyncAction#buildSearchResponse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f093ed5da5d62a1d8321d0f162b949f0b04011a3", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f093ed5da5d62a1d8321d0f162b949f0b04011a3", "committedDate": "2020-11-20T17:35:02Z", "message": "remove noop tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 965, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}