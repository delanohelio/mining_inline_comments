{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwMjI5MDg5", "number": 55873, "title": "Save memory when numeric terms agg is not top", "bodyText": "Right now all implementations of the terms agg allocate a new\nAggregator per bucket. This uses a bunch of memory. Exactly how much\nisn't clear but each Aggregator ends up making its own objects to read\ndoc values which have non-trivial buffers. And it forces all of it\nsub-aggregations to do the same. We allocate a new Aggregator per\nbucket for two reasons:\n\nWe didn't have an appropriate data structure to track the\nsub-ordinals of each parent bucket.\nYou can only make a single call to runDeferredCollections(long...)\nper Aggregator which was the only way to delay collection of\nsub-aggregations.\n\nThis change adds a way to return \"deferred\" aggregations from any\nbucket aggregation and undefers them as part of regular collections.\nThis mechanism allows you to defer without\nrunDeferredCollections(long...).\nThis change also adds a fairly simplistic data structure to track the\nsub-ordinals for long-keyed buckets.\nIt uses both of those to power numeric terms aggregations and removes\nthe per-bucket allocation of their Aggregator. This fairly\nsubstantially reduces memory consumption of numeric terms aggregations\nthat are not the \"top level\", especially when those aggregations contain\nmany sub-aggregations.\nI picked numeric terms aggregations because those have the simplest\nimplementation. At least, I could kind of fit it in my head. And I\nhaven't fully understood the \"bytes\"-based terms aggregations, but I\nimagine I'll be able to make similar optimizations to them in follow up\nchanges.", "createdAt": "2020-04-28T16:30:41Z", "url": "https://github.com/elastic/elasticsearch/pull/55873", "merged": true, "mergeCommit": {"oid": "0d7320499d77e57e16b1789b9d1e91e42f4638c9"}, "closed": true, "closedAt": "2020-05-08T19:39:50Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccED9BAH2gAyNDEwMjI5MDg5OjQ1ZDA0YjJjZDAwYzU3OThhMjQxNjJlZjQ5MTNkOWRjY2I2ZWJlOGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcfVMH7gH2gAyNDEwMjI5MDg5OjdmODhlYTgxZDVhZjgxZjBhZDkxYzdlMjNjMmI2ZGIzOWVkM2E2OTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45d04b2cd00c5798a24162ef4913d9dccb6ebe8c", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/45d04b2cd00c5798a24162ef4913d9dccb6ebe8c", "committedDate": "2020-04-28T13:39:54Z", "message": "Save memory when numeric terms agg is not top\n\nRight now all implementations of the `terms` agg allocate a new\n`Aggregator` per bucket. This uses a bunch of memory. Exactly how much\nisn't clear but each `Aggregator` ends up making its own objects to read\ndoc values which have non-trivial buffers. And it forces all of it\nsub-aggregations to do the same. We allocate a new `Aggregator` per\nbucket for two reasons:\n\n1. We didn't have an appropriate data structure to track the\n   sub-ordinals of each parent bucket.\n2. You can only make a single call to `runDeferredCollections(long...)`\n   per `Aggregator` which was the only way to delay collection of\n   sub-aggregations.\n\nThis change adds a way to return \"deferred\" aggregations from any\nbucket aggregation and undefers them as part of regular collections.\nThis mechanism allows you to defer without\n`runDeferredCollections(long...)`.\n\nThis change also adds a fairly simplistic data structure to track the\nsub-ordinals for `long`-keyed buckets.\n\nIt uses both of those to power numeric `terms` aggregations and removes\nthe per-bucket allocation of their `Aggregator`. This fairly\nsubstantially reduces memory consumption of numeric `terms` aggregations\nthat are not the \"top level\", especially when those aggregations contain\nmany sub-aggregations.\n\nI picked numeric `terms` aggregations because those have the simplest\nimplementation. At least, I could kind of fit it in my head. And I\nhaven't fully understood the \"bytes\"-based terms aggregations, but I\nimagine I'll be able to make similar optimizations to them in follow up\nchanges."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyMDExNzYw", "url": "https://github.com/elastic/elasticsearch/pull/55873#pullrequestreview-402011760", "createdAt": "2020-04-28T16:31:14Z", "commit": {"oid": "45d04b2cd00c5798a24162ef4913d9dccb6ebe8c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjozMToxNVrOGNcwrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQxNjozMToxNVrOGNcwrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1NTg4Ng==", "bodyText": "I had to add these lines so I took the opportunity to update the values above with results from my test.", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r416755886", "createdAt": "2020-04-28T16:31:15Z", "author": {"login": "nik9000"}, "path": "docs/reference/search/profile.asciidoc", "diffHunk": "@@ -784,46 +784,52 @@ This yields the following aggregation profile output:\n           {\n             \"type\" : \"LongTermsAggregator\",\n             \"description\" : \"my_scoped_agg\",\n-            \"time_in_nanos\" : 195386,\n+            \"time_in_nanos\" : 195421,\n             \"breakdown\" : {\n               \"reduce\" : 0,\n-              \"build_aggregation\" : 81171,\n+              \"build_aggregation\" : 80927,\n               \"build_aggregation_count\" : 1,\n-              \"initialize\" : 22753,\n+              \"initialize\" : 3619,\n               \"initialize_count\" : 1,\n               \"reduce_count\" : 0,\n-              \"collect\" : 91456,\n-              \"collect_count\" : 4\n+              \"collect\" : 109778,\n+              \"collect_count\" : 4,\n+              \"run_deferred_collections\" : 1090,\n+              \"run_deferred_collections_count\" : 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45d04b2cd00c5798a24162ef4913d9dccb6ebe8c"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3d9476117ddfdfc9cf51df6cda84622ae992595", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3d9476117ddfdfc9cf51df6cda84622ae992595", "committedDate": "2020-04-28T18:39:40Z", "message": "Fix funny test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3786e8ea7fc6759de29f8c70560af63a15ad4e27", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/3786e8ea7fc6759de29f8c70560af63a15ad4e27", "committedDate": "2020-04-28T18:39:56Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad9c1a2adca61ea3469ebbcc82b82c5728d8e11", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/aad9c1a2adca61ea3469ebbcc82b82c5728d8e11", "committedDate": "2020-04-28T21:07:31Z", "message": "Oh rollup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc76b971fcbd7a4478bdf1745777e3970112f7a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcc76b971fcbd7a4478bdf1745777e3970112f7a", "committedDate": "2020-04-29T14:55:49Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d", "committedDate": "2020-04-29T15:22:10Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f29f36ebfc1a29cf27c0dc6c8c902b8d9d9cf6d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f29f36ebfc1a29cf27c0dc6c8c902b8d9d9cf6d", "committedDate": "2020-04-29T19:18:46Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f5ed9d33fc64d647e42904b17984578f0449dfb", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f5ed9d33fc64d647e42904b17984578f0449dfb", "committedDate": "2020-04-30T19:35:12Z", "message": "huh"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzODQ2MTI5", "url": "https://github.com/elastic/elasticsearch/pull/55873#pullrequestreview-403846129", "createdAt": "2020-04-30T20:16:54Z", "commit": {"oid": "1f5ed9d33fc64d647e42904b17984578f0449dfb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMDoxNjo1NFrOGO4yYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQyMDoxNjo1NFrOGO4yYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODI2MzY0OQ==", "bodyText": "I can revert this.", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r418263649", "createdAt": "2020-04-30T20:16:54Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalMultiBucketAggregation.java", "diffHunk": "@@ -158,19 +158,27 @@ public final InternalAggregation reducePipelines(\n \n     @Override\n     public InternalAggregation copyWithRewritenBuckets(Function<InternalAggregations, InternalAggregations> rewriter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1f5ed9d33fc64d647e42904b17984578f0449dfb"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ad5c4c56c5cc9080fa9ee1b6e9a868a0b1099f", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/22ad5c4c56c5cc9080fa9ee1b6e9a868a0b1099f", "committedDate": "2020-05-03T16:29:53Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da4447601e8a5939a0fdd44b439784ed28f15482", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/da4447601e8a5939a0fdd44b439784ed28f15482", "committedDate": "2020-05-03T17:06:19Z", "message": "Drop docs change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6", "committedDate": "2020-05-03T17:21:03Z", "message": "Doc method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8c83b80eced0169629706d8ef8bf159a1bb883b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8c83b80eced0169629706d8ef8bf159a1bb883b", "committedDate": "2020-05-03T17:27:53Z", "message": "WIP"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0NjM5ODYy", "url": "https://github.com/elastic/elasticsearch/pull/55873#pullrequestreview-404639862", "createdAt": "2020-05-03T17:24:50Z", "commit": {"oid": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNzoyNDo1MFrOGPt47Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wM1QxNzoyNToxMFrOGPt5Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzY3Nw==", "bodyText": "This was missing from some work that I did previously and removing the wrapping of LongTermsAggregator revealed it.", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r419133677", "createdAt": "2020-05-03T17:24:50Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -174,6 +373,9 @@ public Aggregator resolveSortPath(AggregationPath.PathElement next, Iterator<Agg\n \n     @Override\n     public BucketComparator bucketComparator(String key, SortOrder order) {\n+        if (false == this instanceof SingleBucketAggregator) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6"}, "originalPosition": 244}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzcxNQ==", "bodyText": "Without this we get strange test failures around sorting.", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r419133715", "createdAt": "2020-05-03T17:25:10Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BucketsAggregator.java", "diffHunk": "@@ -174,6 +373,9 @@ public Aggregator resolveSortPath(AggregationPath.PathElement next, Iterator<Agg\n \n     @Override\n     public BucketComparator bucketComparator(String key, SortOrder order) {\n+        if (false == this instanceof SingleBucketAggregator) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTEzMzY3Nw=="}, "originalCommit": {"oid": "e064c4c16850ffcb2fd86d6ab493de2ace7e6bf6"}, "originalPosition": 244}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fedfd64286b171df219602f8942afab1e797033", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fedfd64286b171df219602f8942afab1e797033", "committedDate": "2020-05-03T21:55:50Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ae83964d7865efebf22e7f3b06787fe5475e754", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ae83964d7865efebf22e7f3b06787fe5475e754", "committedDate": "2020-05-04T13:15:38Z", "message": "Remove useless method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "107c3b5597c787cdc233107133a394b6d8464cce", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/107c3b5597c787cdc233107133a394b6d8464cce", "committedDate": "2020-05-04T13:45:25Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e872b238774841974ccacbc7002e77422b869a90", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e872b238774841974ccacbc7002e77422b869a90", "committedDate": "2020-05-04T15:06:20Z", "message": "Add tests for nested and reverse nested"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODA1OTQ2", "url": "https://github.com/elastic/elasticsearch/pull/55873#pullrequestreview-402805946", "createdAt": "2020-04-29T15:53:01Z", "commit": {"oid": "9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNTo1MzowMVrOGOFjlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMDowMjozNVrOGQ5evA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyNDI3Ng==", "bodyText": "That looks like a useful addition, thanks!", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r417424276", "createdAt": "2020-04-29T15:53:01Z", "author": {"login": "jimczi"}, "path": "docs/reference/search/profile.asciidoc", "diffHunk": "@@ -784,46 +784,52 @@ This yields the following aggregation profile output:\n           {\n             \"type\" : \"LongTermsAggregator\",\n             \"description\" : \"my_scoped_agg\",\n-            \"time_in_nanos\" : 195386,\n+            \"time_in_nanos\" : 195421,\n             \"breakdown\" : {\n               \"reduce\" : 0,\n-              \"build_aggregation\" : 81171,\n+              \"build_aggregation\" : 80927,\n               \"build_aggregation_count\" : 1,\n-              \"initialize\" : 22753,\n+              \"initialize\" : 3619,\n               \"initialize_count\" : 1,\n               \"reduce_count\" : 0,\n-              \"collect\" : 91456,\n-              \"collect_count\" : 4\n+              \"collect\" : 109778,\n+              \"collect_count\" : 4,\n+              \"run_deferred_collections\" : 1090,\n+              \"run_deferred_collections_count\" : 1", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjc1NTg4Ng=="}, "originalCommit": {"oid": "45d04b2cd00c5798a24162ef4913d9dccb6ebe8c"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQyNDc0Nw==", "bodyText": "Can you add a comment regarding what the returned boolean means ?", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r417424747", "createdAt": "2020-04-29T15:53:43Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -152,15 +152,53 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n     }\n \n     /**\n-     * Build an aggregation for data that has been collected into {@code bucket}.\n+     * Build an aggregation for data that has been collected into\n+     * {@code owningBucketOrd}.\n+     * <p>\n+     * Bucketing aggregations sometimes delay collecting their results if they\n+     * are selective (like {@code terms}) or if they aren't sure which buckets\n+     * their documents will ultimately fall into\n+     * (like {@code auto_date_histogram}). If they do so then anything they\n+     * return from this method can't be trusted. To turn them into \"real\"\n+     * results you have to make all of the calls to this method that you\n+     * will ever make, then call {@link #runDeferredCollections()}. If that\n+     * returns {@code true} then every aggregation will need to be rewritten\n+     * with {@code InternalAggregation#undefer()}. This entire dance is\n+     * generally accomplished by calling {@link #buildTopLevel()} on each top\n+     * level aggregator. \n      */\n-    public abstract InternalAggregation buildAggregation(long bucket) throws IOException;\n+    public abstract InternalAggregation buildAggregation(long owningBucketOrd) throws IOException;\n+\n+    /**\n+     * Build the result of this aggregation if it is on top level of the\n+     * aggregation tree, properly handling deferred collections. It is only\n+     * correct to call this on aggregations that <strong>are</strong> at the\n+     * top level of the aggregation tree. Calling it for other aggregations\n+     * will trip assertions or return the wrong result. Those aggregtions will\n+     * have {@link #buildAggregation(long)}, {@link #runDeferredCollections()}\n+     * and {@link InternalAggregation#undefer()} called by their parent\n+     * aggregations. \n+     */\n+    public final InternalAggregation buildTopLevel() throws IOException {\n+        assert parent() == null;\n+        InternalAggregation result = buildAggregation(0);\n+        if (runDeferredCollections()) {\n+            return result.undefer();\n+        }\n+        return result;\n+    }\n \n     /**\n      * Build an empty aggregation.\n      */\n     public abstract InternalAggregation buildEmptyAggregation();\n \n+    /**\n+     * Run any deferred collections that are required to\n+     * {@link InternalAggregation#undefer()} this aggregations's results.\n+     */\n+    public abstract boolean runDeferredCollections() throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9dbbfbf95cf342f565fabb3c78f6eae6b954dc7d"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDg5MA==", "bodyText": "Can we use aggregator.buildTopLevel() ?", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420370890", "createdAt": "2020-05-05T20:00:12Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregationPhase.java", "diffHunk": "@@ -125,7 +125,7 @@ public void execute(SearchContext context) {\n         for (Aggregator aggregator : context.aggregations().aggregators()) {\n             try {\n                 aggregator.postCollection();\n-                aggregations.add(aggregator.buildAggregation(0));\n+                aggregations.add(aggregator.buildAggregations(new long[] {0})[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e872b238774841974ccacbc7002e77422b869a90"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MjE1Ng==", "bodyText": "I think we should do this on the same pr, otherwise we should add a no-release tag so that we don't forget to do it before a release.", "url": "https://github.com/elastic/elasticsearch/pull/55873#discussion_r420372156", "createdAt": "2020-05-05T20:02:35Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -152,9 +152,43 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n     }\n \n     /**\n-     * Build an aggregation for data that has been collected into {@code bucket}.\n+     * Build an aggregation for data that has been collected into\n+     * {@code owningBucketOrd}.\n+     * @deprecated use {@link #buildAggregations(long[])} instead \n      */\n-    public abstract InternalAggregation buildAggregation(long bucket) throws IOException;\n+    @Deprecated\n+    public InternalAggregation buildAggregation(long owningBucketOrd) throws IOException {\n+        /*\n+         * Temporarily check if it looks like we're being called from a test\n+         * and try to answer with the top level agg. This just prevents us from\n+         * having to modify 1231234134124 tests in one PR.\n+         */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e872b238774841974ccacbc7002e77422b869a90"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "651673c380c6192f1e8130b58feb999e7e1018b6", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/651673c380c6192f1e8130b58feb999e7e1018b6", "committedDate": "2020-05-06T21:25:28Z", "message": "Finish up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb8098b4bec33475d2156e43baeec58349f542f", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5bb8098b4bec33475d2156e43baeec58349f542f", "committedDate": "2020-05-06T21:38:55Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7f7db0f2f55a57862e05ea906549cc05cd9466b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7f7db0f2f55a57862e05ea906549cc05cd9466b", "committedDate": "2020-05-06T22:07:08Z", "message": "geo!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA4Mzg5NTE4", "url": "https://github.com/elastic/elasticsearch/pull/55873#pullrequestreview-408389518", "createdAt": "2020-05-08T17:15:41Z", "commit": {"oid": "c7f7db0f2f55a57862e05ea906549cc05cd9466b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67b0dda1033af295f2903b18ac87435434b13a42", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/67b0dda1033af295f2903b18ac87435434b13a42", "committedDate": "2020-05-08T17:17:36Z", "message": "Merge branch 'master' into sneaky_delay"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f88ea81d5af81f0ad91c7e23c2b6db39ed3a692", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f88ea81d5af81f0ad91c7e23c2b6db39ed3a692", "committedDate": "2020-05-08T17:18:59Z", "message": "Explain"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 479, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}