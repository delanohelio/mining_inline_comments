{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0MzU2NDkx", "number": 65292, "title": "Simplify how source is passed to fetch subphases.", "bodyText": "This PR simplifies how the document source is passed to each fetch subphase. A summary of the strategy:\n\nFor each document, we try to eagerly load the source and store it on HitContext. Most subphases that access source, like source filtering and highlighting, use HitContext. For nested hits, we filter the parent source and also store this source on HitContext.\nOnly for non-nested documents, we also store the loaded source on QueryShardContext#lookup. This allows subphases that access source through SearchLookup to use the pre-loaded source when possible. This is now a common occurrence, since runtime fields are supported in the 'fields' option and may soon be supported in highlighting.\n\nThere is no longer a special SearchLookup just for the fetch phase. This was not necessary and was mostly caused by a misunderstanding of how QueryShardContext should be used.\nAddresses #62511.", "createdAt": "2020-11-20T01:57:24Z", "url": "https://github.com/elastic/elasticsearch/pull/65292", "merged": true, "mergeCommit": {"oid": "f4a462d05e76a4a7275de18e39dd40119a9fada2"}, "closed": true, "closedAt": "2020-11-20T22:09:41Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdeNHY6AH2gAyNTI0MzU2NDkxOjJmN2FhOTQ1NDY2YWVjM2M4YWQyYTUyNzdkYzNmOWE5ODMzNjNlMzM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdebs0KgH2gAyNTI0MzU2NDkxOjFlZjI2M2QzZTZiY2IxMzkyNGUyMmNiNjViZTg1MDE4M2YzNjRiYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2f7aa945466aec3c8ad2a5277dc3f9a983363e33", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f7aa945466aec3c8ad2a5277dc3f9a983363e33", "committedDate": "2020-11-20T01:31:48Z", "message": "Add a test for an edge case we previously encountered."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4da8764d3e0b42e3b584413eae516bb6d8101d21", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/4da8764d3e0b42e3b584413eae516bb6d8101d21", "committedDate": "2020-11-20T01:31:48Z", "message": "Simplify how source is passed to fetch subphases."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1MDE5MjYw", "url": "https://github.com/elastic/elasticsearch/pull/65292#pullrequestreview-535019260", "createdAt": "2020-11-20T02:00:21Z", "commit": {"oid": "4da8764d3e0b42e3b584413eae516bb6d8101d21"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjowMDoyMVrOH26pBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yMFQwMjowMDoyMVrOH26pBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyNzM0NTkyNQ==", "bodyText": "This protects against reintroducing the bug in #31000. I should have added this test when fixing the bug originally, but better late than never!", "url": "https://github.com/elastic/elasticsearch/pull/65292#discussion_r527345925", "createdAt": "2020-11-20T02:00:21Z", "author": {"login": "jtibshirani"}, "path": "modules/lang-painless/src/yamlRestTest/resources/rest-api-spec/test/painless/80_script_score.yml", "diffHunk": "@@ -546,3 +546,46 @@\n   - match: {hits.hits.0.highlight.company.0: \"<em>ABC</em> company\"}\n   - match: {hits.hits.1.highlight.company.0: \"<em>ABC</em> <em>ABCD</em> company\"}\n   - match: {hits.hits.2.highlight.company.0: \"<em>ABCD</em> company\"}\n+\n+---\n+# This test guards against a subtle edge case in the fetch phase related to source-loading and", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4da8764d3e0b42e3b584413eae516bb6d8101d21"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM1NjM4OTI0", "url": "https://github.com/elastic/elasticsearch/pull/65292#pullrequestreview-535638924", "createdAt": "2020-11-20T17:36:20Z", "commit": {"oid": "4da8764d3e0b42e3b584413eae516bb6d8101d21"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f974efbf7e25f7b27872dfa003c45fc470cf5822", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f974efbf7e25f7b27872dfa003c45fc470cf5822", "committedDate": "2020-11-20T18:19:57Z", "message": "Merge remote-tracking branch 'upstream/master' into share-search-lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ef263d3e6bcb13924e22cb65be850183f364bad", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ef263d3e6bcb13924e22cb65be850183f364bad", "committedDate": "2020-11-20T18:31:21Z", "message": "Correct the document ID passed to the script lookup."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 892, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}