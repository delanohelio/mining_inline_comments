{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM5Njc0NjU4", "number": 66273, "title": "[Transform] Handle multi-fields properly when creating destination index.", "bodyText": "When source index contained a text & keyword field foo, creation of the destination index finished with error:\norg.elasticsearch.ElasticsearchException: Elasticsearch exception [type=illegal_argument_exception, reason=can't merge a non object mapping [foo] with an object mapping]\n\nThis PR solves the problem by producing a proper mapping for a multi-field before creating the destination index.\nRelates #65869\nMarking >non-issue as this fix is for an unreleased feature.", "createdAt": "2020-12-14T17:15:44Z", "url": "https://github.com/elastic/elasticsearch/pull/66273", "merged": true, "mergeCommit": {"oid": "81343ac7e375225a653dd894bf0b20baeb29a608"}, "closed": true, "closedAt": "2020-12-16T07:19:56Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmUPIPgFqTU1MjEzNjcyNA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmpHZugBqjQxMTgwODQ0MTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTM2NzI0", "url": "https://github.com/elastic/elasticsearch/pull/66273#pullrequestreview-552136724", "createdAt": "2020-12-15T06:20:58Z", "commit": {"oid": "e2e38ed7c7fd49a62ac3efa1a88b44186827fa52"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoyMDo1OVrOIF6x3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoyMDo1OVrOIF6x3w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NjgzMQ==", "bodyText": "Tests show this doesn't work when there are object fields mixed with multi-fields.\nI need to rethink this solution.", "url": "https://github.com/elastic/elasticsearch/pull/66273#discussion_r543076831", "createdAt": "2020-12-15T06:20:59Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/persistence/TransformIndex.java", "diffHunk": "@@ -134,10 +134,28 @@ private static Settings createSettings() {\n      * }\n      * @param mappings A Map of the form {\"fieldName\": \"fieldType\"}\n      */\n-    private static Map<String, Object> createMappingsFromStringMap(Map<String, String> mappings) {\n+    static Map<String, Object> createMappingsFromStringMap(Map<String, String> mappings) {\n         Map<String, Object> fieldMappings = new HashMap<>();\n-        mappings.forEach((k, v) -> fieldMappings.put(k, Map.of(\"type\", v)));\n-\n+        for (Map.Entry<String, String> entry : mappings.entrySet()) {\n+            String[] parts = entry.getKey().split(\"\\\\.\");\n+            Map<String, Object> current = fieldMappings;\n+            current = diveInto(current, parts[0]);\n+            for (int j = 1; j < parts.length; ++j) {\n+                current = diveInto(current, \"fields\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e2e38ed7c7fd49a62ac3efa1a88b44186827fa52"}, "originalPosition": 14}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "13ea108c98dc3931cb81dcee093d32e86a3d1fab", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/13ea108c98dc3931cb81dcee093d32e86a3d1fab", "committedDate": "2020-12-15T12:55:25Z", "message": "Fix failing unit test\nSimplify \"diveInto\" method by using \"computeIfAbsent\""}, "afterCommit": {"oid": "5dca6cd23e4af96f23cc246ed49b64bf04030e01", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5dca6cd23e4af96f23cc246ed49b64bf04030e01", "committedDate": "2020-12-15T13:09:05Z", "message": "Fix failing unit test\nSimplify \"diveInto\" method by using \"computeIfAbsent\""}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjQ1ODg4", "url": "https://github.com/elastic/elasticsearch/pull/66273#pullrequestreview-552645888", "createdAt": "2020-12-15T16:33:58Z", "commit": {"oid": "5dca6cd23e4af96f23cc246ed49b64bf04030e01"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMzo1OFrOIGUhaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjozMzo1OFrOIGUhaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5ODYwMA==", "bodyText": "nit: I am not a big fan of using regex if there is no reason. Arguably its java's fault. A potential alternative: the tokenize methods in org.elasticsearch.common.Strings", "url": "https://github.com/elastic/elasticsearch/pull/66273#discussion_r543498600", "createdAt": "2020-12-15T16:33:58Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/persistence/TransformIndex.java", "diffHunk": "@@ -134,10 +148,28 @@ private static Settings createSettings() {\n      * }\n      * @param mappings A Map of the form {\"fieldName\": \"fieldType\"}\n      */\n-    private static Map<String, Object> createMappingsFromStringMap(Map<String, String> mappings) {\n+    static Map<String, Object> createMappingsFromStringMap(Map<String, String> mappings) {\n+        List<Map.Entry<String, String>> sortedMappingsEntries = new ArrayList<>(mappings.entrySet());\n+        // We sort the entry list to make sure that for each (parent, parent.child) pair, parent entry will be processed before child entry.\n+        sortedMappingsEntries.sort(comparingByKey());\n         Map<String, Object> fieldMappings = new HashMap<>();\n-        mappings.forEach((k, v) -> fieldMappings.put(k, Map.of(\"type\", v)));\n-\n+        for (Map.Entry<String, String> entry : sortedMappingsEntries) {\n+            String[] parts = entry.getKey().split(\"\\\\.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5dca6cd23e4af96f23cc246ed49b64bf04030e01"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3384109121aa0a6ece9339c66f5fd51c29ac2840", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/3384109121aa0a6ece9339c66f5fd51c29ac2840", "committedDate": "2020-12-16T06:40:13Z", "message": "Handle multi-fields properly when creating destination index."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67ac9f422c62c7367f470046a02169c7f5a7ecf", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b67ac9f422c62c7367f470046a02169c7f5a7ecf", "committedDate": "2020-12-16T06:40:13Z", "message": "Handle \"object\" and \"nested\" mappings when constructing transform's destination index mappings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f138d23073160694deb0a98c43b19c0d1cd4891d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f138d23073160694deb0a98c43b19c0d1cd4891d", "committedDate": "2020-12-16T06:40:13Z", "message": "Emit explicit { \"type\": \"object\" } entries and fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62495ba1bcfbf22341e0d380fe1289dc3883a710", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/62495ba1bcfbf22341e0d380fe1289dc3883a710", "committedDate": "2020-12-16T06:40:13Z", "message": "Fix failing unit test\nSimplify \"diveInto\" method by using \"computeIfAbsent\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "141e1fbf493344cb2e165cea446213bf1aadedb7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/141e1fbf493344cb2e165cea446213bf1aadedb7", "committedDate": "2020-12-16T06:40:13Z", "message": "Apply review comment"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5dca6cd23e4af96f23cc246ed49b64bf04030e01", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5dca6cd23e4af96f23cc246ed49b64bf04030e01", "committedDate": "2020-12-15T13:09:05Z", "message": "Fix failing unit test\nSimplify \"diveInto\" method by using \"computeIfAbsent\""}, "afterCommit": {"oid": "141e1fbf493344cb2e165cea446213bf1aadedb7", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/141e1fbf493344cb2e165cea446213bf1aadedb7", "committedDate": "2020-12-16T06:40:13Z", "message": "Apply review comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4629, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}