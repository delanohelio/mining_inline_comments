{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMTY1OTYz", "number": 60517, "title": "Refactor SnapshotsInProgress State Transitions", "bodyText": "The copy constructors previously used were hard to read and the exact state changes\nwere not obvious at all.\nRefactored those into a number of named constructors instead, added additional assertions\nand moved the snapshot abort logic into SnapshotsInProgress.\nMainly motivated by wanting to clean up the state machine a little before adding the clone snapshot functionality which I'm planning on putting on top of SnapshotsInProgress.", "createdAt": "2020-07-31T13:51:29Z", "url": "https://github.com/elastic/elasticsearch/pull/60517", "merged": true, "mergeCommit": {"oid": "c99cac4e2664ff9264c7ed2fba0c24a9a5bcc5e0"}, "closed": true, "closedAt": "2020-08-03T10:05:37Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6Uh1kgH2gAyNDYwMTY1OTYzOmUxNDk1YzkyY2EzNTI5ZTE2NGQ0ZWQ3OTc5ODkyMjI3OTA2OWZlNjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ObLLAH2gAyNDYwMTY1OTYzOjYyODM1MzE5OThmZTZkYmUxNzc0Y2IwYTUzMDg2NTY3MTE4ZWUwZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1495c92ca3529e164d4ed79798922279069fe62", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1495c92ca3529e164d4ed79798922279069fe62", "committedDate": "2020-07-31T13:48:45Z", "message": "Refactor SnapshotsInProgress State Transitions\n\nThe copy constructors previously used were hard to read and the exact state changes\nwere not obvious at all.\nRefactored those into a number of named constructors instead, added additional assertions\nand moved the snapshot abort logic into `SnapshotsInProgress`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5MTkxMjI0", "url": "https://github.com/elastic/elasticsearch/pull/60517#pullrequestreview-459191224", "createdAt": "2020-07-31T13:53:20Z", "commit": {"oid": "e1495c92ca3529e164d4ed79798922279069fe62"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzo1MzoyMVrOG6JZow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQxMzo1MzoyMVrOG6JZow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzYyNDYxMQ==", "bodyText": "This is only used in the BwC path and kind of weird, left it logically unchanged because the BwC path goes away in master once 7.9 is out anyway and I didn't want to add any risk since we don't have full test coverage on aborts on mixed version clusters.", "url": "https://github.com/elastic/elasticsearch/pull/60517#discussion_r463624611", "createdAt": "2020-07-31T13:53:21Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -146,42 +159,67 @@ private static boolean assertShardsConsistent(State state, List<IndexId> indices\n             shards.keysIt().forEachRemaining(s -> indexNamesInShards.add(s.getIndexName()));\n             assert indexNames.equals(indexNamesInShards)\n                 : \"Indices in shards \" + indexNamesInShards + \" differ from expected indices \" + indexNames + \" for state [\" + state + \"]\";\n+            assert (state.completed() && completed(shards.values())) || state.completed() == false\n+                : \"Completed state must imply all shards completed but saw state [\" + state + \"] and shards \" + shards;\n             return true;\n         }\n \n-        public Entry(Snapshot snapshot, boolean includeGlobalState, boolean partial, State state, List<IndexId> indices,\n-                     long startTime, long repositoryStateId, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards,\n-                     Map<String, Object> userMetadata, Version version) {\n-            this(snapshot, includeGlobalState, partial, state, indices, Collections.emptyList(), startTime, repositoryStateId, shards,\n-                null, userMetadata, version);\n-        }\n-\n-        public Entry(Entry entry, State state, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n-            this(entry.snapshot, entry.includeGlobalState, entry.partial, state, entry.indices, entry.dataStreams, entry.startTime,\n-                entry.repositoryStateId, shards, entry.failure, entry.userMetadata, entry.version);\n-        }\n-\n-        public Entry(Entry entry, State state, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards, String failure) {\n-            this(entry.snapshot, entry.includeGlobalState, entry.partial, state, entry.indices, entry.dataStreams, entry.startTime,\n-                 entry.repositoryStateId, shards, failure, entry.userMetadata, entry.version);\n-        }\n-\n-        public Entry(Entry entry, ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n-            this(entry, entry.state, shards, entry.failure);\n-        }\n-\n         public Entry withRepoGen(long newRepoGen) {\n             assert newRepoGen > repositoryStateId : \"Updated repository generation [\" + newRepoGen\n                     + \"] must be higher than current generation [\" + repositoryStateId + \"]\";\n             return new Entry(snapshot, includeGlobalState, partial, state, indices, dataStreams, startTime, newRepoGen, shards, failure,\n                     userMetadata, version);\n         }\n \n-        public Entry withShards(ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards) {\n+        public Entry abort() {\n+            final ImmutableOpenMap.Builder<ShardId, ShardSnapshotStatus> shardsBuilder = ImmutableOpenMap.builder();\n+            boolean completed = true;\n+            for (ObjectObjectCursor<ShardId, ShardSnapshotStatus> shardEntry : shards) {\n+                ShardSnapshotStatus status = shardEntry.value;\n+                if (status.state().completed() == false) {\n+                    final String nodeId = status.nodeId();\n+                    status = new ShardSnapshotStatus(nodeId, nodeId == null ? ShardState.FAILED : ShardState.ABORTED,\n+                            \"aborted by snapshot deletion\", status.generation());\n+                }\n+                completed &= status.state().completed();\n+                shardsBuilder.put(shardEntry.key, status);\n+            }\n+            return fail(shardsBuilder.build(), completed ? State.SUCCESS : State.ABORTED, \"Snapshot was aborted by deletion\");\n+        }\n+\n+        public Entry fail(ImmutableOpenMap<ShardId, ShardSnapshotStatus> shards, State state, String failure) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e1495c92ca3529e164d4ed79798922279069fe62"}, "originalPosition": 81}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa8275a46104edce5604b3ce826316bdcde25ff2", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa8275a46104edce5604b3ce826316bdcde25ff2", "committedDate": "2020-07-31T15:31:47Z", "message": "even stricter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fce147f3401d6f37d0ba4e2710a94437aef2bbb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fce147f3401d6f37d0ba4e2710a94437aef2bbb", "committedDate": "2020-07-31T15:50:19Z", "message": "fix assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3eb6249ad740fbaeffa133516d9aec7e614b738", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3eb6249ad740fbaeffa133516d9aec7e614b738", "committedDate": "2020-07-31T15:50:24Z", "message": "Merge remote-tracking branch 'elastic/master' into nicer-snapshots-in-progress"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5ODU4MTU4", "url": "https://github.com/elastic/elasticsearch/pull/60517#pullrequestreview-459858158", "createdAt": "2020-08-03T08:54:29Z", "commit": {"oid": "c3eb6249ad740fbaeffa133516d9aec7e614b738"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo1NDozMFrOG6xcvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QwODo1NDozMFrOG6xcvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDI4MDc2Ng==", "bodyText": "perhaps mention that the state can also be success here already?", "url": "https://github.com/elastic/elasticsearch/pull/60517#discussion_r464280766", "createdAt": "2020-08-03T08:54:30Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -83,6 +83,18 @@ public String toString() {\n         return builder.append(\"]\").toString();\n     }\n \n+    /**\n+     * Creates the initial {@link Entry} when starting a snapshot.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3eb6249ad740fbaeffa133516d9aec7e614b738"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd2c340be964800b082ca61cacf3582eed3a1f8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2fd2c340be964800b082ca61cacf3582eed3a1f8", "committedDate": "2020-08-03T09:12:16Z", "message": "Merge remote-tracking branch 'elastic/master' into nicer-snapshots-in-progress"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6283531998fe6dbe1774cb0a53086567118ee0f1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6283531998fe6dbe1774cb0a53086567118ee0f1", "committedDate": "2020-08-03T09:15:58Z", "message": "CR: better javadoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3567, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}