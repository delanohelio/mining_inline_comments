{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc2NDE0MjI2", "number": 61744, "title": "Keep checkpoint file channel open across fsyncs", "bodyText": "Currently we open and close the checkpoint file channel for every fsync.\nThis file channel can be kept open for the lifecycle of a translog\nwriter. This avoids the overhead of opening the file, checking file\npermissions, and closing the file on every fsync.", "createdAt": "2020-08-31T16:52:54Z", "url": "https://github.com/elastic/elasticsearch/pull/61744", "merged": true, "mergeCommit": {"oid": "1a31f9e332c702dbaf9faccc06a98dcd7151143e"}, "closed": true, "closedAt": "2020-09-01T17:35:17Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDGHLqgH2gAyNDc2NDE0MjI2OjI4MDdmNzRhNDNkMGNlMzc1Mjc3N2Y5MjQyNmQ4OTRjZDAxZDk1NGY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEpw0nAH2gAyNDc2NDE0MjI2OjhjZjQ0MGMwYWMyNDBlYmU4NjlkOGUzMTE1ODMyOGYzMDNkYjY2YTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2807f74a43d0ce3752777f92426d894cd01d954f", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/2807f74a43d0ce3752777f92426d894cd01d954f", "committedDate": "2020-08-27T20:06:17Z", "message": "Keep checkpoint file channel open in-between syncs\n\nCurrently we open, write, fsync, and close the same file for every\nfsync. This is unnecessary as fsyncs are common and we continue to use\nthe same checkpoint file. This commit modifies the translog to open the\ncheckpoint when a new writer is created and close it when we roll or\nclose the writer."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8", "committedDate": "2020-08-31T16:49:10Z", "message": "Merge remote-tracking branch 'upstream/master' into file_channel_open"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NDg4MDI5", "url": "https://github.com/elastic/elasticsearch/pull/61744#pullrequestreview-479488029", "createdAt": "2020-09-01T07:55:43Z", "commit": {"oid": "b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzo1NTo0M1rOHKqWfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwNzo1NTo0M1rOHKqWfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk0MTY5NA==", "bodyText": "What's a bit subtle here is that we assume callers to not have any concurrent access to this method. Also we assume that once an exception occurs, this method is no more called on the same FileChannel. The surrounding context currently correctly implements this, but it is easy to break and can have disastrous effects. Is there a way we can strengthen these assumptions via assertions?  I was also wondering if we should use positional writes (see FileChannel.write(ByteBuffer src, long position), to ensure we truly always write starting with offset 0 in all cases, and move the positioning logic to the Checkpoint.write method.", "url": "https://github.com/elastic/elasticsearch/pull/61744#discussion_r480941694", "createdAt": "2020-09-01T07:55:43Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -414,10 +427,12 @@ protected void readBytes(ByteBuffer targetBuffer, long position) throws IOExcept\n     }\n \n     private static void writeCheckpoint(\n-            final ChannelFactory channelFactory,\n-            final Path translogFile,\n-            final Checkpoint checkpoint) throws IOException {\n-        Checkpoint.write(channelFactory, translogFile.resolve(Translog.CHECKPOINT_FILE_NAME), checkpoint, StandardOpenOption.WRITE);\n+        final FileChannel fileChannel,\n+        final Path checkpointFile,\n+        final Checkpoint checkpoint) throws IOException {\n+        // Since we used a fixed size checkpoint, we overwrite the checkpoint each time.\n+        fileChannel.position(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8"}, "originalPosition": 118}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5NTI3ODk0", "url": "https://github.com/elastic/elasticsearch/pull/61744#pullrequestreview-479527894", "createdAt": "2020-09-01T08:47:50Z", "commit": {"oid": "b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0Nzo1MFrOHKsa9A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQwODo0Nzo1MFrOHKsa9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk3NTYwNA==", "bodyText": "++ to using positional writes, those should technically be slightly faster as well I think because we only have to lock the internal positionLock in the file channel once.", "url": "https://github.com/elastic/elasticsearch/pull/61744#discussion_r480975604", "createdAt": "2020-09-01T08:47:50Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -414,10 +427,12 @@ protected void readBytes(ByteBuffer targetBuffer, long position) throws IOExcept\n     }\n \n     private static void writeCheckpoint(\n-            final ChannelFactory channelFactory,\n-            final Path translogFile,\n-            final Checkpoint checkpoint) throws IOException {\n-        Checkpoint.write(channelFactory, translogFile.resolve(Translog.CHECKPOINT_FILE_NAME), checkpoint, StandardOpenOption.WRITE);\n+        final FileChannel fileChannel,\n+        final Path checkpointFile,\n+        final Checkpoint checkpoint) throws IOException {\n+        // Since we used a fixed size checkpoint, we overwrite the checkpoint each time.\n+        fileChannel.position(0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MDk0MTY5NA=="}, "originalCommit": {"oid": "b4d2f5b8f5d4cf6d4171f4da72ba2b47984f4bc8"}, "originalPosition": 118}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a36c985845221c6e79226c97c8f6334daeeceb2", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a36c985845221c6e79226c97c8f6334daeeceb2", "committedDate": "2020-09-01T15:01:09Z", "message": "Change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e96d8b09a7490572111d1b4224479c09c2f98193", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/e96d8b09a7490572111d1b4224479c09c2f98193", "committedDate": "2020-09-01T15:40:30Z", "message": "Merge remote-tracking branch 'upstream/master' into file_channel_open"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cf440c0ac240ebe869d8e31158328f303db66a9", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/8cf440c0ac240ebe869d8e31158328f303db66a9", "committedDate": "2020-09-01T16:12:22Z", "message": "Changes"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 52, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}