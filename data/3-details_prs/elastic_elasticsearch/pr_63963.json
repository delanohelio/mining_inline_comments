{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3MTk4MjIz", "number": 63963, "title": "Add index commit id to searcher", "bodyText": "This commit adds an id, which is composed of the ids of segment files, to ElasticsearchDirectoryReader. With this id, we can retry search requests on another shard copy if its latest \"snapshot\" has the same segment files as the failing shard.", "createdAt": "2020-10-21T02:07:19Z", "url": "https://github.com/elastic/elasticsearch/pull/63963", "merged": true, "mergeCommit": {"oid": "0e8e02f752021525a29f28fa9570138c88e81e39"}, "closed": true, "closedAt": "2020-12-12T15:30:19Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 23, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUjntJAH2gAyNTA3MTk4MjIzOmU5Y2M0MDRiZmQxYWJlMzYxYTQ0YTM2YTVlNGNlZDEyMzBlMzQyMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdk28iFAH2gAyNTA3MTk4MjIzOmU5NDMwNmQyNzIwYmI2ODIyNDA5ZTEyNzMyM2M5NDI5NmY3ZGVlZTU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e9cc404bfd1abe361a44a36a5e4ced1230e34230", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9cc404bfd1abe361a44a36a5e4ced1230e34230", "committedDate": "2020-10-21T02:05:46Z", "message": "Assign id to searcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e445182ee5569ac9bcc4255f0459628207a8aedf", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e445182ee5569ac9bcc4255f0459628207a8aedf", "committedDate": "2020-10-21T02:39:15Z", "message": "stylecheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23146bb4d69d6a2390fec6ec39602398a4d88b34", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/23146bb4d69d6a2390fec6ec39602398a4d88b34", "committedDate": "2020-10-21T14:36:55Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68e2e12489ac75020f53d823b9998457e52656ad", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/68e2e12489ac75020f53d823b9998457e52656ad", "committedDate": "2020-10-21T15:36:27Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4db30e62f405741884e325805ef4de80f1f9949d", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4db30e62f405741884e325805ef4de80f1f9949d", "committedDate": "2020-10-21T15:47:38Z", "message": "more tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEzOTk1Mzc4", "url": "https://github.com/elastic/elasticsearch/pull/63963#pullrequestreview-513995378", "createdAt": "2020-10-21T17:22:36Z", "commit": {"oid": "4db30e62f405741884e325805ef4de80f1f9949d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoyMjozNlrOHl3k_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxNzoyMjozNlrOHl3k_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTQ2OTk1MA==", "bodyText": "I am not sure if we should pursue this. But without it, we'd never have the same searcher id between copies except with searchable snapshots.", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r509469950", "createdAt": "2020-10-21T17:22:36Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/common/lucene/index/ElasticsearchDirectoryReader.java", "diffHunk": "@@ -35,12 +42,48 @@\n \n     private final ShardId shardId;\n     private final FilterDirectoryReader.SubReaderWrapper wrapper;\n+    private final CheckedFunction<DirectoryReader, String, IOException> readerIdGenerator;\n+    private final String readerId;\n \n-    private ElasticsearchDirectoryReader(DirectoryReader in, FilterDirectoryReader.SubReaderWrapper wrapper,\n-            ShardId shardId) throws IOException {\n+    private ElasticsearchDirectoryReader(DirectoryReader in, FilterDirectoryReader.SubReaderWrapper wrapper, ShardId shardId,\n+                                         CheckedFunction<DirectoryReader, String, IOException> readerIdGenerator) throws IOException {\n         super(in, wrapper);\n         this.wrapper = wrapper;\n         this.shardId = shardId;\n+        this.readerIdGenerator = readerIdGenerator;\n+        this.readerId = readerIdGenerator.apply(in);\n+    }\n+\n+    /**\n+     * If two readers have the same reader id, then their underlying reader must consist of the same list of segments.\n+     */\n+    @Nullable\n+    public String getReaderId() {\n+        return readerId;\n+    }\n+\n+    public static String getReaderIdFromSegmentInfos(SegmentInfos segmentInfos, BooleanSupplier fullyCommitted) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db30e62f405741884e325805ef4de80f1f9949d"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0NDEwMDYz", "url": "https://github.com/elastic/elasticsearch/pull/63963#pullrequestreview-514410063", "createdAt": "2020-10-22T06:54:48Z", "commit": {"oid": "4db30e62f405741884e325805ef4de80f1f9949d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNjo1NDo0OFrOHmTFHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQwNjo1NDo0OFrOHmTFHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTkyMDU0Mg==", "bodyText": "It is not clear to me that this is valid across different shard copies. The id generation starts somewhere random and then increments. I acknowledge the risk is small and I did not dig deeply into whether this increases the risk of collissions over using more standard uuid generation.", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r509920542", "createdAt": "2020-10-22T06:54:48Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/common/lucene/index/ElasticsearchDirectoryReader.java", "diffHunk": "@@ -35,12 +42,48 @@\n \n     private final ShardId shardId;\n     private final FilterDirectoryReader.SubReaderWrapper wrapper;\n+    private final CheckedFunction<DirectoryReader, String, IOException> readerIdGenerator;\n+    private final String readerId;\n \n-    private ElasticsearchDirectoryReader(DirectoryReader in, FilterDirectoryReader.SubReaderWrapper wrapper,\n-            ShardId shardId) throws IOException {\n+    private ElasticsearchDirectoryReader(DirectoryReader in, FilterDirectoryReader.SubReaderWrapper wrapper, ShardId shardId,\n+                                         CheckedFunction<DirectoryReader, String, IOException> readerIdGenerator) throws IOException {\n         super(in, wrapper);\n         this.wrapper = wrapper;\n         this.shardId = shardId;\n+        this.readerIdGenerator = readerIdGenerator;\n+        this.readerId = readerIdGenerator.apply(in);\n+    }\n+\n+    /**\n+     * If two readers have the same reader id, then their underlying reader must consist of the same list of segments.\n+     */\n+    @Nullable\n+    public String getReaderId() {\n+        return readerId;\n+    }\n+\n+    public static String getReaderIdFromSegmentInfos(SegmentInfos segmentInfos, BooleanSupplier fullyCommitted) {\n+        // Here we prefer using an id composed of the ids of the underlying segments instead of the id of the commit because\n+        // the commit id changes whenever IndexWriter#commit is called although the segment files stay unchanged. A file-based\n+        // recovery creates a new commit to associate the new translog uuid. Hence, the commit ids of the primary and replicas\n+        // are always different although they can have the identical segment files.\n+        final MessageDigest md = MessageDigests.sha256();\n+        for (SegmentCommitInfo sci : segmentInfos) {\n+            final byte[] segmentId = sci.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4db30e62f405741884e325805ef4de80f1f9949d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae4c4c9a76a53947cf179515268cc6a4724a8da4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae4c4c9a76a53947cf179515268cc6a4724a8da4", "committedDate": "2020-11-16T18:31:38Z", "message": "Merge branch 'master' into add-searcher-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13116cc6276a14dc91742231da074167a6d17874", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/13116cc6276a14dc91742231da074167a6d17874", "committedDate": "2020-11-16T19:25:46Z", "message": "new direction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f410eb4210ff043ed1abd52bf052107ca398d7a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f410eb4210ff043ed1abd52bf052107ca398d7a", "committedDate": "2020-11-16T21:23:06Z", "message": "Use es commit id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "800c9be966f60ddf3ac57b54f742ddb3346f26f5", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/800c9be966f60ddf3ac57b54f742ddb3346f26f5", "committedDate": "2020-11-17T19:37:31Z", "message": "try extract"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3892d32384e2bf76f5e69ad3ee557e515f0c7e3a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3892d32384e2bf76f5e69ad3ee557e515f0c7e3a", "committedDate": "2020-11-17T19:37:50Z", "message": "Merge branch 'master' into add-searcher-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/47f310d4702cbc689e925cca048cd40b45da1096", "committedDate": "2020-11-17T20:46:06Z", "message": "Simplify"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMTUwMzAz", "url": "https://github.com/elastic/elasticsearch/pull/63963#pullrequestreview-541150303", "createdAt": "2020-11-30T17:49:16Z", "commit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3MTE4MjA3", "url": "https://github.com/elastic/elasticsearch/pull/63963#pullrequestreview-537118207", "createdAt": "2020-11-24T06:48:04Z", "commit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNjo0ODowNVrOH4uEAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQwNzo0MDoxN1rOH4vecg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTIzNjk5Mg==", "bodyText": "identical content at the Lucene document level.\n\nMaybe:\nidentical Lucene level indices, i.e., identical segments with same docs using same doc-ids.", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r529236992", "createdAt": "2020-11-24T06:48:05Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/engine/Engine.java", "diffHunk": "@@ -1205,6 +1205,15 @@ public final void close() {\n         protected abstract void doClose();\n \n         protected abstract Searcher acquireSearcherInternal(String source);\n+\n+        /**\n+         * Returns a commit id associated with this searcher if it's opened from an index commit; otherwise, return null.\n+         * Two searcher with the same commit id must have identical content at the Lucene document level.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI0NDM0OQ==", "bodyText": "StringHelper.idToString mentions in its javadoc that it is for debugging purposes.\nI wonder if we should use:\nBase64.getEncoder().encodeToString(id)\ninstead like we do in CommitId.toString().", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r529244349", "createdAt": "2020-11-24T07:06:32Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/engine/ReadOnlyEngine.java", "diffHunk": "@@ -107,6 +109,7 @@ public ReadOnlyEngine(EngineConfig config, SeqNoStats seqNoStats, TranslogStats\n                 // yet this makes sure nobody else does. including some testing tools that try to be messy\n                 indexWriterLock = obtainLock ? directory.obtainLock(IndexWriter.WRITE_LOCK_NAME) : null;\n                 this.lastCommittedSegmentInfos = Lucene.readSegmentInfos(directory);\n+                this.commitId = StringHelper.idToString(this.lastCommittedSegmentInfos.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTI2MDE0Ng==", "bodyText": "Could we also set replicas=1 and then check that the recovered copy has the same commit id?", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r529260146", "createdAt": "2020-11-24T07:40:17Z", "author": {"login": "henningandersen"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/indices/state/CloseIndexIT.java", "diffHunk": "@@ -472,6 +474,34 @@ public void testResyncPropagatePrimaryTerm() throws Exception {\n         }\n     }\n \n+    public void testCommitIdInSearcher() throws Exception {\n+        final String indexName = \"test_commit_id\";\n+        createIndex(indexName, Settings.builder()\n+            .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 1)\n+            .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+            .build());\n+        indexRandom(randomBoolean(), randomBoolean(), randomBoolean(), IntStream.range(0, randomIntBetween(0, 50))\n+            .mapToObj(n -> client().prepareIndex(indexName).setSource(\"num\", n)).collect(toList()));\n+        ensureGreen(indexName);\n+        assertAcked(client().admin().indices().prepareClose(indexName));\n+        assertIndexIsClosed(indexName);\n+        ensureGreen(indexName);\n+        final String nodeWithPrimary = Iterables.get(internalCluster().nodesInclude(indexName), 0);\n+        IndexShard shard = internalCluster().getInstance(IndicesService.class, nodeWithPrimary)\n+            .indexService(resolveIndex(indexName)).getShard(0);\n+        final String commitId;\n+        try (Engine.SearcherSupplier searcherSupplier = shard.acquireSearcherSupplier(randomFrom(Engine.SearcherScope.values()))) {\n+            assertNotNull(searcherSupplier.getCommitId());\n+            commitId = searcherSupplier.getCommitId();\n+        }\n+        internalCluster().restartNode(nodeWithPrimary);\n+        ensureGreen(indexName);\n+        shard = internalCluster().getInstance(IndicesService.class, nodeWithPrimary).indexService(resolveIndex(indexName)).getShard(0);\n+        try (Engine.SearcherSupplier searcherSupplier = shard.acquireSearcherSupplier(randomFrom(Engine.SearcherScope.values()))) {\n+            assertThat(searcherSupplier.getCommitId(), equalTo(commitId));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "47f310d4702cbc689e925cca048cd40b45da1096"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a93fa03fe48a343e5904df9cd0b84f8b6b49cf78", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a93fa03fe48a343e5904df9cd0b84f8b6b49cf78", "committedDate": "2020-12-02T15:19:02Z", "message": "Merge branch 'master' into add-searcher-id\n\n# Conflicts:\n#\tserver/src/main/java/org/elasticsearch/index/engine/ReadOnlyEngine.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05fcf3849c4e137533f7ff93df696d3896c88e91", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/05fcf3849c4e137533f7ff93df696d3896c88e91", "committedDate": "2020-12-02T16:10:20Z", "message": "base64"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "193b631a5c6f48e6a12beb1e0e6b04fee97c5fb9", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/193b631a5c6f48e6a12beb1e0e6b04fee97c5fb9", "committedDate": "2020-12-02T16:10:26Z", "message": "javadocs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3OTY0NjMx", "url": "https://github.com/elastic/elasticsearch/pull/63963#pullrequestreview-547964631", "createdAt": "2020-12-09T08:58:17Z", "commit": {"oid": "193b631a5c6f48e6a12beb1e0e6b04fee97c5fb9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwODo1ODoxN1rOICJeBA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQwODo1ODoxN1rOICJeBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTEyMzIwNA==", "bodyText": "can this get some javadocs?", "url": "https://github.com/elastic/elasticsearch/pull/63963#discussion_r539123204", "createdAt": "2020-12-09T08:58:17Z", "author": {"login": "s1monw"}, "path": "server/src/main/java/org/elasticsearch/common/lucene/Lucene.java", "diffHunk": "@@ -808,6 +809,10 @@ public void delete() {\n         }\n     }\n \n+    public static String getCommitId(SegmentInfos segmentInfos) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "193b631a5c6f48e6a12beb1e0e6b04fee97c5fb9"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b65f083cd393d6b817479cdd9d5ebb50f02696fa", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b65f083cd393d6b817479cdd9d5ebb50f02696fa", "committedDate": "2020-12-10T14:43:09Z", "message": "Merge branch 'master' into add-searcher-id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51d4ef4ccfa0a93ce0f4ac17356bdfb67bd8a512", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/51d4ef4ccfa0a93ce0f4ac17356bdfb67bd8a512", "committedDate": "2020-12-10T14:48:08Z", "message": "add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ec5781c2d56571dd665b38e4ec20f74f36afad5", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ec5781c2d56571dd665b38e4ec20f74f36afad5", "committedDate": "2020-12-10T17:37:41Z", "message": "Add external commit_id"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e94306d2720bb6822409e127323c94296f7deee5", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e94306d2720bb6822409e127323c94296f7deee5", "committedDate": "2020-12-10T17:39:30Z", "message": "Revert \"Add external commit_id\"\n\nThis reverts commit 5ec5781c2d56571dd665b38e4ec20f74f36afad5."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1219, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}