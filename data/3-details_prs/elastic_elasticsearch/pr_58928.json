{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzNTY3MjU5", "number": 58928, "title": "Improve auditing of API key authentication", "bodyText": "These changes roughly follow #52551 (comment) after some course correct.\n\nadd the apikey.id, apikey.name and authentication.type fields to the access_granted, access_denied, authentication_success and (some) tampered_request audit events (apikey.id and apikey.name are present only when authn with an API Key)\nwhen authn with an API Key, the user.realm field now contains the realm name of the user that created the key, instead of the synthetic value of _es_api_key. Note that in this circumstance, the user.name field reflects the name of the user that created the key (they are consistent)\nuser.roles contains the role names (only of found/resolved roles) of the user that created the key. It previously wrongly had the role descriptor names from the API key definition. This is now handled separately in #59041 .\n\nRelates #52551", "createdAt": "2020-07-02T14:50:47Z", "url": "https://github.com/elastic/elasticsearch/pull/58928", "merged": true, "mergeCommit": {"oid": "83cf22a7881a36fa172ccdf812cf9ab40da8c126"}, "closed": true, "closedAt": "2020-07-09T09:34:02Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcrdJ8YAH2gAyNDQzNTY3MjU5Ojk5MzYzNTUwNjdmYTk4NTkxZGMzZmM0OGUxMDE4ZDBiMzgyYjIzNTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczJFsVgFqTQ0NTMyMzA0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9936355067fa98591dc3fc48e1018d0b382b2353", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/9936355067fa98591dc3fc48e1018d0b382b2353", "committedDate": "2020-06-15T09:22:56Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d4029bff1a980fbbcddff4b1a5ec753e96aed95", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/9d4029bff1a980fbbcddff4b1a5ec753e96aed95", "committedDate": "2020-06-15T15:34:31Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e337dbef5b58010c2c697cb296d8de9e13327469", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/e337dbef5b58010c2c697cb296d8de9e13327469", "committedDate": "2020-06-15T18:10:10Z", "message": "WIP mhhhmm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb4b8eafd4660f178f8ceffe9c98d2fc73792865", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb4b8eafd4660f178f8ceffe9c98d2fc73792865", "committedDate": "2020-06-15T18:20:40Z", "message": "WIP mhmm"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df1fee9bce5ddcdf8c826b11c2fef73abfda9387", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/df1fee9bce5ddcdf8c826b11c2fef73abfda9387", "committedDate": "2020-06-18T09:57:57Z", "message": "Nothing here"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0680978a3fbd9c2d7cdfb76f19a46bfce219175d", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/0680978a3fbd9c2d7cdfb76f19a46bfce219175d", "committedDate": "2020-06-28T16:09:10Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f041041f9bc04a9bce3233065d20f05d4fc5761c", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/f041041f9bc04a9bce3233065d20f05d4fc5761c", "committedDate": "2020-06-28T16:44:40Z", "message": "Revert to wrong format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9092e66b9a6d125eb4928888e6edf7e9a7dddc79", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/9092e66b9a6d125eb4928888e6edf7e9a7dddc79", "committedDate": "2020-06-28T19:05:31Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39e4e5af2d53a968822b819fb4c1e56e9e82cd74", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/39e4e5af2d53a968822b819fb4c1e56e9e82cd74", "committedDate": "2020-06-29T04:48:50Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1b189792a768857c2143f826b2870d9cfae3eea", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1b189792a768857c2143f826b2870d9cfae3eea", "committedDate": "2020-06-29T09:02:01Z", "message": "Tests FIX WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f4883986ec3c628d1539c29d934275277bc9a95", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f4883986ec3c628d1539c29d934275277bc9a95", "committedDate": "2020-06-29T09:50:24Z", "message": "Teests compile and AuthenticationServiceTests passes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55744e5b253ea224f81439155caae34dbd6594cd", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/55744e5b253ea224f81439155caae34dbd6594cd", "committedDate": "2020-06-29T10:36:53Z", "message": "Le tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b5616c8e1dbfcc419db42c2c1b755d7e2e72d8d", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b5616c8e1dbfcc419db42c2c1b755d7e2e72d8d", "committedDate": "2020-07-01T06:11:48Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd24d50c5c9c3e61d4db27d6d8607095ec8395df", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd24d50c5c9c3e61d4db27d6d8607095ec8395df", "committedDate": "2020-07-01T10:42:57Z", "message": "Limited role changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "170cc33746edd34c497c287a3ae46fad9112c682", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/170cc33746edd34c497c287a3ae46fad9112c682", "committedDate": "2020-07-01T11:09:15Z", "message": "Authentication type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3857df914e8a68e170a98a5b0cec6a3839856434", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/3857df914e8a68e170a98a5b0cec6a3839856434", "committedDate": "2020-07-02T10:06:44Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f1bbfea2a32989f82b79c73d0f1446e975366e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/34f1bbfea2a32989f82b79c73d0f1446e975366e", "committedDate": "2020-07-02T14:13:00Z", "message": "Filter tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "659f2e8d313e7c64600113a02c92fa1e4a9635b0", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/659f2e8d313e7c64600113a02c92fa1e4a9635b0", "committedDate": "2020-07-02T14:19:27Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed88ee85aa958d36642f31347a543e93bc3c853a", "committedDate": "2020-07-02T14:51:14Z", "message": "Revert gradle run file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzU3Mjc0", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-441757274", "createdAt": "2020-07-02T14:54:02Z", "commit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDo1NDowM1rOGsQfWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNDo1NDowM1rOGsQfWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2MDY5OQ==", "bodyText": "This refactoring is necessary because the LimitedRole#names (which is what's used by the audit) reported the names of the role descriptors from the API Key definition. It now returns the names of the owner user roles.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449060699", "createdAt": "2020-07-02T14:54:03Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -27,17 +27,13 @@\n  * provided role.\n  */\n public final class LimitedRole extends Role {\n-    private final Role limitedBy;\n+    private final Role fromRole;\n \n     LimitedRole(String[] names, ClusterPermission cluster, IndicesPermission indices, ApplicationPermission application,\n-            RunAsPermission runAs, Role limitedBy) {\n+            RunAsPermission runAs, Role fromRole) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "549083d66c26e01f7ae20eb791a55d7aee7f3e89", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/549083d66c26e01f7ae20eb791a55d7aee7f3e89", "committedDate": "2020-07-02T14:56:34Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzcyMDMy", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-441772032", "createdAt": "2020-07-02T15:09:23Z", "commit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTowOToyM1rOGsRIIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNTowOToyM1rOGsRIIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MTEzOA==", "bodyText": "authentication_success is different because it returned the realm inside the realm field instead of user.realm field. It almost makes sense, but the problem is that the user.name could reside in the lookup realm, which is not audited. Also the authn realm name could be _es_api_key which is even less helpful.\nI feel this change is borderline. Happy to discuss it.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449071138", "createdAt": "2020-07-02T15:09:23Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -231,16 +235,19 @@ public LoggingAuditTrail(Settings settings, ClusterService clusterService, Threa\n     }\n \n     @Override\n-    public void authenticationSuccess(String requestId, String realm, User user, RestRequest request) {\n+    public void authenticationSuccess(String requestId, Authentication authentication, RestRequest request) {\n         if (events.contains(AUTHENTICATION_SUCCESS) && eventFilterPolicyRegistry.ignorePredicate()\n-                .test(new AuditEventMetaInfo(Optional.of(user), Optional.of(realm), Optional.empty(), Optional.empty())) == false) {\n+                .test(new AuditEventMetaInfo(\n+                        Optional.of(authentication.getUser()),\n+                        Optional.of(effectiveRealmName(authentication)),\n+                        Optional.empty(),\n+                        Optional.empty())) == false) {\n             final StringMapMessage logEntry = new LogEntryBuilder()\n                     .with(EVENT_TYPE_FIELD_NAME, REST_ORIGIN_FIELD_VALUE)\n                     .with(EVENT_ACTION_FIELD_NAME, \"authentication_success\")\n-                    .with(REALM_FIELD_NAME, realm)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxNzczMTMz", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-441773133", "createdAt": "2020-07-02T15:10:04Z", "commit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToxMDowNFrOGsRJ7Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQxNToxMDowNFrOGsRJ7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MTU5Nw==", "bodyText": "this tampered_request can now be filtered by ignore policies.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449071597", "createdAt": "2020-07-02T15:10:04Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -571,19 +581,22 @@ public void tamperedRequest(String requestId, String action, TransportRequest tr\n     }\n \n     @Override\n-    public void tamperedRequest(String requestId, User user, String action, TransportRequest transportRequest) {\n+    public void tamperedRequest(String requestId, Authentication authentication, String action, TransportRequest transportRequest) {\n         if (events.contains(TAMPERED_REQUEST)) {\n             final Optional<String[]> indices = indices(transportRequest);\n-            if (eventFilterPolicyRegistry.ignorePredicate()\n-                    .test(new AuditEventMetaInfo(Optional.of(user), Optional.empty(), Optional.empty(), indices)) == false) {\n+            if (eventFilterPolicyRegistry.ignorePredicate().test(new AuditEventMetaInfo(\n+                            Optional.of(authentication.getUser()),\n+                            Optional.of(effectiveRealmName(authentication)),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "originalPosition": 109}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22b1b77163f4456e6642e8b0ec39227b690ff54", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/c22b1b77163f4456e6642e8b0ec39227b690ff54", "committedDate": "2020-07-02T21:57:43Z", "message": "nothing to see here"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMTY2NjI1", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-442166625", "createdAt": "2020-07-03T06:09:27Z", "commit": {"oid": "549083d66c26e01f7ae20eb791a55d7aee7f3e89"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNjowOToyN1rOGskxJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwNjo0ODo0NFrOGslkCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5MjkzNQ==", "bodyText": "This method is now a duplicate of ApiKeyService#getCreatorRealmName. It is probably better to consolidate them.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449392935", "createdAt": "2020-07-03T06:09:27Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -879,8 +892,13 @@ String toQuotedJsonArray(Object[] values) {\n     }\n \n     private static String effectiveRealmName(Authentication authentication) {\n-        return authentication.getLookedUpBy() != null ? authentication.getLookedUpBy().getName()\n-                : authentication.getAuthenticatedBy().getName();\n+        if (authentication.getLookedUpBy() != null) {\n+            return authentication.getLookedUpBy().getName();\n+        } else if (authentication.getAuthenticationType() == Authentication.AuthenticationType.API_KEY) {\n+            return (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME);\n+        } else {\n+            return authentication.getAuthenticatedBy().getName();\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "549083d66c26e01f7ae20eb791a55d7aee7f3e89"}, "originalPosition": 173}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTM5ODM5Ng==", "bodyText": "We have quite a few realm related fields:\n\nrealm\nuser.realm\nuser.run_by.realm\nuser.run_as.realm\n\nIs there a valid situation that all four of them would have different meanings? Or should we get rid of one of them, e.g. realm, completely?", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449398396", "createdAt": "2020-07-03T06:27:23Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -231,16 +235,19 @@ public LoggingAuditTrail(Settings settings, ClusterService clusterService, Threa\n     }\n \n     @Override\n-    public void authenticationSuccess(String requestId, String realm, User user, RestRequest request) {\n+    public void authenticationSuccess(String requestId, Authentication authentication, RestRequest request) {\n         if (events.contains(AUTHENTICATION_SUCCESS) && eventFilterPolicyRegistry.ignorePredicate()\n-                .test(new AuditEventMetaInfo(Optional.of(user), Optional.of(realm), Optional.empty(), Optional.empty())) == false) {\n+                .test(new AuditEventMetaInfo(\n+                        Optional.of(authentication.getUser()),\n+                        Optional.of(effectiveRealmName(authentication)),\n+                        Optional.empty(),\n+                        Optional.empty())) == false) {\n             final StringMapMessage logEntry = new LogEntryBuilder()\n                     .with(EVENT_TYPE_FIELD_NAME, REST_ORIGIN_FIELD_VALUE)\n                     .with(EVENT_ACTION_FIELD_NAME, \"authentication_success\")\n-                    .with(REALM_FIELD_NAME, realm)", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA3MTEzOA=="}, "originalCommit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwMTg0Nw==", "bodyText": "If the intention is to have LimitedRole#names to report creator's roles instead of the sythetic roles. I wonder whether it would be better to just override Role#names instead of changing it here. This change works as well, but it makes the code hard to read unless you go all the way to change all relevant names:\n\nindicesAccessControl.limitIndicesAccessControl(...)\nlimitedByIndicesAccessControl\nresourcePrivilegesMapForLimitedRole\nEven the class name itself LimitedRole kinda suggests the field of name limitedBy.\n\nWe also may wanna change the order of the conditional checks, e.g.:\nreturn super.checkClusterAction(action, request, authentication) && fromRole.checkClusterAction(action, request, authentication);\n\nIt might be better to check against fromRole first, since common cases would be fromRole having less privileges than the limitedBy role.\nBut I wonder whether all above changes are worthwhile if the goal is just to get the role names of the creator. It might be simpler to just override the names method unless there is some concern that I am missing. Also, this is a remote concern, but if we decide to support derived keys by using multiple limitedBy roles, this change would make it harder to do so.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449401847", "createdAt": "2020-07-03T06:37:31Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -27,17 +27,13 @@\n  * provided role.\n  */\n public final class LimitedRole extends Role {\n-    private final Role limitedBy;\n+    private final Role fromRole;\n \n     LimitedRole(String[] names, ClusterPermission cluster, IndicesPermission indices, ApplicationPermission application,\n-            RunAsPermission runAs, Role limitedBy) {\n+            RunAsPermission runAs, Role fromRole) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTA2MDY5OQ=="}, "originalCommit": {"oid": "ed88ee85aa958d36642f31347a543e93bc3c853a"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQwNTk2MA==", "bodyText": "I understand these are existing logic and probably not the current focus. But I am troubled by the fact that we have:\n\nuser.xxx\nuser.run_by.xxx\nuser.run_as.xxx\n\nI personally think we could drop user.run_by.xxx. The presence of having user.run_as.xxx fields already give the information that user.xxx fields are run_by. It would be simpler and more consistent imo. Happy to discuss.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449405960", "createdAt": "2020-07-03T06:48:44Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/logfile/LoggingAuditTrail.java", "diffHunk": "@@ -797,22 +810,22 @@ LogEntryBuilder withXForwardedFor(ThreadContext threadContext) {\n             return this;\n         }\n \n-        LogEntryBuilder withPrincipal(User user) {\n-            logEntry.with(PRINCIPAL_FIELD_NAME, user.principal());\n-            if (user.isRunAs()) {\n-                logEntry.with(PRINCIPAL_RUN_BY_FIELD_NAME, user.authenticatedUser().principal());\n-            }\n-            return this;\n-        }\n-\n-        LogEntryBuilder withSubject(Authentication authentication) {\n+        LogEntryBuilder withAuthentication(Authentication authentication) {\n             logEntry.with(PRINCIPAL_FIELD_NAME, authentication.getUser().principal());\n-            if (authentication.getUser().isRunAs()) {\n-                logEntry.with(PRINCIPAL_REALM_FIELD_NAME, authentication.getLookedUpBy().getName())\n-                        .with(PRINCIPAL_RUN_BY_FIELD_NAME, authentication.getUser().authenticatedUser().principal())\n-                        .with(PRINCIPAL_RUN_BY_REALM_FIELD_NAME, authentication.getAuthenticatedBy().getName());\n+            logEntry.with(AUTHENTICATION_TYPE_FIELD_NAME, authentication.getAuthenticationType().toString());\n+            if (Authentication.AuthenticationType.API_KEY == authentication.getAuthenticationType()) {\n+                logEntry.with(API_KEY_ID_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_ID_KEY))\n+                        .with(API_KEY_NAME_FIELD_NAME, (String) authentication.getMetadata().get(ApiKeyService.API_KEY_NAME_KEY))\n+                        .with(PRINCIPAL_REALM_FIELD_NAME,\n+                                (String) authentication.getMetadata().get(ApiKeyService.API_KEY_CREATOR_REALM_NAME));\n             } else {\n-                logEntry.with(PRINCIPAL_REALM_FIELD_NAME, authentication.getAuthenticatedBy().getName());\n+                if (authentication.getUser().isRunAs()) {\n+                    logEntry.with(PRINCIPAL_REALM_FIELD_NAME, authentication.getLookedUpBy().getName())\n+                            .with(PRINCIPAL_RUN_BY_FIELD_NAME, authentication.getUser().authenticatedUser().principal())\n+                            .with(PRINCIPAL_RUN_BY_REALM_FIELD_NAME, authentication.getAuthenticatedBy().getName());\n+                } else {\n+                    logEntry.with(PRINCIPAL_REALM_FIELD_NAME, authentication.getAuthenticatedBy().getName());\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "549083d66c26e01f7ae20eb791a55d7aee7f3e89"}, "originalPosition": 157}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "267349fb55b5c01e2bcda1783550a09c8cf83f90", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/267349fb55b5c01e2bcda1783550a09c8cf83f90", "committedDate": "2020-07-05T16:28:48Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a8ddbb16bd1842ce87602d2e83d690c82dfbe30", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a8ddbb16bd1842ce87602d2e83d690c82dfbe30", "committedDate": "2020-07-05T16:37:32Z", "message": "Revert changes to api key roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f497d506215fc0f84c6eda3338b5085e5c4db72", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f497d506215fc0f84c6eda3338b5085e5c4db72", "committedDate": "2020-07-05T17:42:18Z", "message": "ApiKeyService#getCreatorRealmName"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjk1Mzk3", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-442695397", "createdAt": "2020-07-05T17:53:10Z", "commit": {"oid": "7f497d506215fc0f84c6eda3338b5085e5c4db72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNzo1MzoxMFrOGtD3ng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxNzo1MzoxMFrOGtD3ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwMjQ5NA==", "bodyText": "Moving the auditing of authentication_success down here avoids the unlikely, but confusing case of authentication_success followed by authentication_failed.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449902494", "createdAt": "2020-07-05T17:53:10Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -676,13 +675,13 @@ void finishAuthentication(User finalUser) {\n          * successful\n          */\n         void writeAuthToContext(Authentication authentication) {\n-            request.authenticationSuccess(authentication.getAuthenticatedBy().getName(), authentication.getUser());\n             Runnable action = () -> {\n                 logger.trace(\"Established authentication [{}] for request [{}]\", authentication, request);\n                 listener.onResponse(authentication);\n             };\n             try {\n                 authenticationSerializer.writeToContext(authentication, threadContext);\n+                request.authenticationSuccess(authentication);\n             } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f497d506215fc0f84c6eda3338b5085e5c4db72"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNjk3NDE4", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-442697418", "createdAt": "2020-07-05T18:28:02Z", "commit": {"oid": "7f497d506215fc0f84c6eda3338b5085e5c4db72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxODoyODowMlrOGtEDGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNVQxODoyODowMlrOGtEDGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTkwNTQzNQ==", "bodyText": "mix-in creating an API Key while running-as.", "url": "https://github.com/elastic/elasticsearch/pull/58928#discussion_r449905435", "createdAt": "2020-07-05T18:28:02Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/ApiKeyServiceTests.java", "diffHunk": "@@ -148,7 +148,13 @@ public void testAuthenticateWithApiKey() throws Exception {\n         final String id = randomAlphaOfLength(12);\n         final String key = randomAlphaOfLength(16);\n \n-        mockKeyDocument(service, id, key, new User(\"hulk\", \"superuser\"));\n+        final User user;\n+        if (randomBoolean()) {\n+            user = new User(\"hulk\", new String[] { \"superuser\" }, new User(\"authenticated_user\", new String[] { \"other\" }));\n+        } else {\n+            user = new User(\"hulk\", new String[] { \"superuser\" });\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f497d506215fc0f84c6eda3338b5085e5c4db72"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06894d1fd0687ed14a239710e98040eafb7441eb", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/06894d1fd0687ed14a239710e98040eafb7441eb", "committedDate": "2020-07-05T18:28:52Z", "message": "Tease out the roles PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "856eea7a6493c38e222b18991bbddf1033d73e42", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/856eea7a6493c38e222b18991bbddf1033d73e42", "committedDate": "2020-07-05T18:33:25Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22a16875e53377565091f0f849c4b312f1eb15ce", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/22a16875e53377565091f0f849c4b312f1eb15ce", "committedDate": "2020-07-07T20:38:40Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2977aa1a7ac958d877b4c6dbb70bbbac780c82ef", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2977aa1a7ac958d877b4c6dbb70bbbac780c82ef", "committedDate": "2020-07-07T20:39:12Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "112bfee8a0b45097f39a0fde7c71af2e931f3f18", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/112bfee8a0b45097f39a0fde7c71af2e931f3f18", "committedDate": "2020-07-07T21:05:12Z", "message": "Merge fallout"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e112ae6f4331a33e054d0d70698adbca6864a42", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e112ae6f4331a33e054d0d70698adbca6864a42", "committedDate": "2020-07-08T05:02:02Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03cc8de97cc75304580823d08c4593f91b580136", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/03cc8de97cc75304580823d08c4593f91b580136", "committedDate": "2020-07-08T23:02:31Z", "message": "Merge branch 'master' into audit_key_usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8aa90686381135ce53e56bfd827ae6467b67bfb4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/8aa90686381135ce53e56bfd827ae6467b67bfb4", "committedDate": "2020-07-08T23:22:42Z", "message": "Review resurrect \"realm\" for authn_success"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzE3NTA0", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-445317504", "createdAt": "2020-07-09T06:19:04Z", "commit": {"oid": "8aa90686381135ce53e56bfd827ae6467b67bfb4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzIzMDQ2", "url": "https://github.com/elastic/elasticsearch/pull/58928#pullrequestreview-445323046", "createdAt": "2020-07-09T06:31:35Z", "commit": {"oid": "8aa90686381135ce53e56bfd827ae6467b67bfb4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2393, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}