{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxNDY4ODA0", "number": 52959, "title": "[ML] Fixing datafeed bwc tests", "bodyText": "Datafeed bwc tests have been muted for some time in the 7.x. This is because of date_histogram interval deprecation warnings.\nThis commit fixes the tests as must as possible while still handling deprecation warnings.", "createdAt": "2020-02-28T16:11:57Z", "url": "https://github.com/elastic/elasticsearch/pull/52959", "merged": true, "mergeCommit": {"oid": "85d7112e78c7d865ab1fc5ef92ca80ad114a2516"}, "closed": true, "closedAt": "2020-03-06T15:27:22Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcIyM5agH2gAyMzgxNDY4ODA0OmI5MTdlNDE1YjY1MzdiMjFjZWE3MWI1ZWM3ZDBiZjhkY2Y5OGE5NmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcLBPtngFqTM3MDM3NDExMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b917e415b6537b21cea71b5ec7d0bf8dcf98a96e", "committedDate": "2020-02-28T16:06:49Z", "message": "[ML] Fixing datafeed bwc tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY2NTE2MzMx", "url": "https://github.com/elastic/elasticsearch/pull/52959#pullrequestreview-366516331", "createdAt": "2020-02-28T16:16:36Z", "commit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoxNjozNlrOFv6jrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQxNjoyMjowOFrOFv6vZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw==", "bodyText": "@nik9000 Since you wrote the original logic, thought I would ping you.\nThis allows for the same warning to be mentioned multiple times in the headers. This is required for ML since there are times when a warning appears more than once.\nThe number of times a warning appears is non-deterministic in multi-node tests.\nThis is because for ML we occasionally need to route to specific nodes (e.g. to a master node) and warnings can appear on parsing XContent and on serializing between nodes.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385786797", "createdAt": "2020-02-28T16:16:36Z", "author": {"login": "benwtrent"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -307,16 +310,20 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n                      * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n                      * mixed-version tests that used typed APIs.\n                      */\n-                } else if (expected.remove(message) == false) {\n+                } else if (expected.contains(message) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NzQwNA==", "bodyText": "This is frustrating, but I cannot think of a way to \"sometimes\" expected a warning header. We just don't know if the call would hit an old node, a new node, or is serialized between the two.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385787404", "createdAt": "2020-02-28T16:17:44Z", "author": {"login": "benwtrent"}, "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -137,7 +137,10 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n     if (bwcVersion.before('7.4.0')) {\n       toBlackList.addAll([\n         'mixed_cluster/80_transform_jobs_crud/Test GET, start, and stop old cluster batch transforms',\n-        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms'\n+        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms',\n+        //Cannot determine if we will throw a warning on get as we might hit an old node\n+        //Cannot determine if we will have a warning on get _stats as we might hit an old node\n+        'mixed_cluster/40_ml_datafeed_crud/Test old cluster datafeed with aggs'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Nzg1Nw==", "bodyText": "Again, it is possible here that the PUT does not hit a new node at all and no deprecation warning is returned :(", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385787857", "createdAt": "2020-02-28T16:18:29Z", "author": {"login": "benwtrent"}, "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -160,9 +163,17 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n         'mixed_cluster/80_transform_jobs_crud/Test put batch transform on mixed cluster',\n         'mixed_cluster/80_transform_jobs_crud/Test GET, start, and stop old cluster batch transforms',\n         'mixed_cluster/80_transform_jobs_crud/Test put continuous transform on mixed cluster',\n-        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms'\n+        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms',\n+        //Cannot determine if we will throw a warning on get as we might hit an old node\n+        //Cannot determine if we will have a warning on get _stats as we might hit an old node\n+        'mixed_cluster/40_ml_datafeed_crud/Test old cluster datafeed with aggs'\n       ])\n     }\n+    // Skip putting aggs if we have a mixed cluster were certain nodes will return a deprecation warning\n+    // and others will not.\n+    if (bwcVersion.before('7.2.0')) {\n+      toBlackList << 'mixed_cluster/40_ml_datafeed_crud/Put job and datafeed with aggs in mixed cluster'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4ODY1Mg==", "bodyText": "This is so we at least have mixed cluster coverage on versions > 7.2.0.\nI could add this back, but then we would lose mixed cluster coverage for aggs for clusters containing nodes < 7.4.0", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385788652", "createdAt": "2020-02-28T16:20:04Z", "author": {"login": "benwtrent"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -151,9 +148,3 @@ setup:\n               }\n             }\n           }\n-\n-  - do:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTU0MQ==", "bodyText": "I am going to forward-port this split if we merge this pr.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385789541", "createdAt": "2020-02-28T16:21:38Z", "author": {"login": "benwtrent"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/upgraded_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -183,6 +166,45 @@ setup:\n         job_id: old-cluster-datafeed-job-with-aggs\n   - match: { acknowledged: true }\n \n+  - do:\n+      indices.delete:\n+        index: airline-data\n+\n+---\n+\"Test mixed cluster datafeeds with aggs\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4OTc5Ng==", "bodyText": "Also, this PR is against 7.x. If approved and merged, I am going to forward-port this change.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r385789796", "createdAt": "2020-02-28T16:22:08Z", "author": {"login": "benwtrent"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -307,16 +310,20 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n                      * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n                      * mixed-version tests that used typed APIs.\n                      */\n-                } else if (expected.remove(message) == false) {\n+                } else if (expected.contains(message) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e", "committedDate": "2020-02-28T16:22:58Z", "message": "removing unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4ODU0MDc1", "url": "https://github.com/elastic/elasticsearch/pull/52959#pullrequestreview-368854075", "createdAt": "2020-03-04T15:04:54Z", "commit": {"oid": "ea4c2ef5cb553bcf5fff8226c0878411fa9b6a2e"}, "state": "DISMISSED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNTowNDo1NFrOFxw2og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNTowNToyNFrOFxw30w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNDk2Mg==", "bodyText": "I'm weary to change this behavior, though I admit the error message that you get with duplicate warning ain't great. I think for the most part we want to assert that you get exactly the warnings that you specify back. Emitting duplicate warnings feels a little like a bug to me.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387724962", "createdAt": "2020-03-04T15:04:54Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/yaml/section/DoSection.java", "diffHunk": "@@ -307,16 +310,20 @@ void checkWarningHeaders(final List<String> warningHeaders, final Version master\n                      * We skip warnings related to types deprecation and transform rename so that we can continue to run the many\n                      * mixed-version tests that used typed APIs.\n                      */\n-                } else if (expected.remove(message) == false) {\n+                } else if (expected.contains(message) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4Njc5Nw=="}, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyNTI2Nw==", "bodyText": "I think it'd be useful to have \"allowed warnings\" as a thing.", "url": "https://github.com/elastic/elasticsearch/pull/52959#discussion_r387725267", "createdAt": "2020-03-04T15:05:24Z", "author": {"login": "nik9000"}, "path": "x-pack/qa/rolling-upgrade/build.gradle", "diffHunk": "@@ -137,7 +137,10 @@ for (Version bwcVersion : bwcVersions.wireCompatible) {\n     if (bwcVersion.before('7.4.0')) {\n       toBlackList.addAll([\n         'mixed_cluster/80_transform_jobs_crud/Test GET, start, and stop old cluster batch transforms',\n-        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms'\n+        'mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms',\n+        //Cannot determine if we will throw a warning on get as we might hit an old node\n+        //Cannot determine if we will have a warning on get _stats as we might hit an old node\n+        'mixed_cluster/40_ml_datafeed_crud/Test old cluster datafeed with aggs'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTc4NzQwNA=="}, "originalCommit": {"oid": "b917e415b6537b21cea71b5ec7d0bf8dcf98a96e"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9962f8b520d2601daf28d66669ca747ff8c9e66", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9962f8b520d2601daf28d66669ca747ff8c9e66", "committedDate": "2020-03-06T13:52:47Z", "message": "reverting some changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/8435d58a6b3bfe03becbdf699e52d48cc0d8d00e", "committedDate": "2020-03-06T13:52:53Z", "message": "Merge remote-tracking branch 'upstream/7.x' into tests/datafeed-bwc-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f43aefd468a45902bb85f9c3a0644adf68eba8", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/44f43aefd468a45902bb85f9c3a0644adf68eba8", "committedDate": "2020-03-06T14:00:33Z", "message": "using new allowed_warnings setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94007a5c2c2e0405cbfa4b279cd317a94c3db319", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/94007a5c2c2e0405cbfa4b279cd317a94c3db319", "committedDate": "2020-03-06T14:09:01Z", "message": "reverting needless changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0bc3369b86e5e376762e714dc36447ad52d6638", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0bc3369b86e5e376762e714dc36447ad52d6638", "committedDate": "2020-03-06T14:25:27Z", "message": "allowing warnings in updated cluster tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzY3NDQx", "url": "https://github.com/elastic/elasticsearch/pull/52959#pullrequestreview-370367441", "createdAt": "2020-03-06T14:37:40Z", "commit": {"oid": "c0bc3369b86e5e376762e714dc36447ad52d6638"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMzc0MTEw", "url": "https://github.com/elastic/elasticsearch/pull/52959#pullrequestreview-370374110", "createdAt": "2020-03-06T14:46:19Z", "commit": {"oid": "c0bc3369b86e5e376762e714dc36447ad52d6638"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1858, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}