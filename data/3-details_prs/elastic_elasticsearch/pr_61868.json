{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3OTM3NDUz", "number": 61868, "title": "[ML] Update reindexing task progress before persisting job progress", "bodyText": "This fixes a bug introduced by #61782. In that PR I thought I could\nsimplify the persistence of progress by using the progress straight\nfrom the stats holder in the task instead of calling the get\nstats action. However, I overlooked that it is then possible to\nhave stale progress for the reindexing task as that is only updated\nwhen the get stats API is called.\nIn this commit this is fixed by updating reindexing task progress\nbefore persisting the job progress. This seems to be much more\nlightweight than calling the get stats request.\nCloses #61852", "createdAt": "2020-09-02T16:17:30Z", "url": "https://github.com/elastic/elasticsearch/pull/61868", "merged": true, "mergeCommit": {"oid": "76fa5000b24948c468d923c612d7a43ed4d57154"}, "closed": true, "closedAt": "2020-09-02T18:00:53Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE-VShAH2gAyNDc3OTM3NDUzOjMyZDM0MjdkYTdiYWM1YmU0OTE1YTViODQzNTQzY2NlZjU2NTE5MmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE_Vc9gH2gAyNDc3OTM3NDUzOmQ1OGM5NDgwNTMxYjMwOTdhZDFlYzcyMGYzMDVkZGFhZmFiNjhjNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32d3427da7bac5be4915a5b843543ccef565192d", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/32d3427da7bac5be4915a5b843543ccef565192d", "committedDate": "2020-09-02T16:10:18Z", "message": "[ML] Update reindexing task progress before persisting job progress\n\nThis fixes a bug introduced by #61782. In that PR I thought I could\nsimplify the persistence of progress by using the progress straight\nfrom the stats holder in the task instead of calling the get\nstats action. However, I overlooked that it is then possible to\nhave stale progress for the reindexing task as that is only updated\nwhen the get stats API is called.\n\nIn this commit this is fixed by updating reindexing task progress\nbefore persisting the job progress. This seems to be much more\nlightweight than calling the get stats request.\n\nCloses #61852"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwOTk4NDgz", "url": "https://github.com/elastic/elasticsearch/pull/61868#pullrequestreview-480998483", "createdAt": "2020-09-02T16:32:08Z", "commit": {"oid": "32d3427da7bac5be4915a5b843543ccef565192d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjozMjowOVrOHL3hGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxNjozMjowOVrOHL3hGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjIwNTk3OA==", "bodyText": "I was going to comment about \"what else could be stale\", but looking at how we handle the _stats call, we effectively do this.\nSo, we are just shortcutting the _stats call here by slightly \"duplicating\" the code here\nI am referencing:\n\n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportGetDataFrameAnalyticsStatsAction.java\n    \n    \n         Line 122\n      in\n      c5cef17\n    \n    \n    \n    \n\n        \n          \n           task.updateReindexTaskProgress(reindexingProgressListener);", "url": "https://github.com/elastic/elasticsearch/pull/61868#discussion_r482205978", "createdAt": "2020-09-02T16:32:09Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -331,14 +331,26 @@ void persistProgress(Client client, String jobId, Runnable runnable) {\n             }\n         );\n \n-        // Step 1: Search for existing progress document in .ml-state*\n-        SearchRequest searchRequest =\n-            new SearchRequest(AnomalyDetectorsIndex.jobStateIndexPattern())\n-                .source(\n-                    new SearchSourceBuilder()\n-                        .size(1)\n-                        .query(new IdsQueryBuilder().addIds(progressDocId)));\n-        executeAsyncWithOrigin(client, ML_ORIGIN, SearchAction.INSTANCE, searchRequest, searchFormerProgressDocListener);\n+        // Step 2: Search for existing progress document in .ml-state*\n+        ActionListener<Void> reindexProgressUpdateListener = ActionListener.wrap(\n+            aVoid -> {\n+                SearchRequest searchRequest =\n+                    new SearchRequest(AnomalyDetectorsIndex.jobStateIndexPattern())\n+                        .source(\n+                            new SearchSourceBuilder()\n+                                .size(1)\n+                                .query(new IdsQueryBuilder().addIds(progressDocId)));\n+                executeAsyncWithOrigin(client, ML_ORIGIN, SearchAction.INSTANCE, searchRequest, searchFormerProgressDocListener);\n+            },\n+            e -> {\n+                LOGGER.error(new ParameterizedMessage(\n+                    \"[{}] cannot persist progress as an error occurred while updating reindexing task progress\", taskParams.getId()), e);\n+                runnable.run();\n+            }\n+        );\n+\n+        // Step 1: Update reindexing progress as it could be stale\n+        updateReindexTaskProgress(reindexProgressUpdateListener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32d3427da7bac5be4915a5b843543ccef565192d"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d58c9480531b3097ad1ec720f305ddaafab68c70", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/d58c9480531b3097ad1ec720f305ddaafab68c70", "committedDate": "2020-09-02T17:20:23Z", "message": "Add comment in get stats"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 19, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}