{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NDg5ODk1", "number": 51270, "title": "Fix Overly Aggressive Request DeDuplication", "bodyText": "On master failover we have to resent all the shard failed messages,\nbut the transport requests remain the same in the eyes of equals.\nIf the master failover is registered and the requests to the new master\nare sent before all the callbacks have executed and the request to the\nold master removed from the deduplicator then the requuests to the new\nmaster will incorrectly fail and the snapshot get stuck.\nCloses #51253", "createdAt": "2020-01-21T20:13:51Z", "url": "https://github.com/elastic/elasticsearch/pull/51270", "merged": true, "mergeCommit": {"oid": "fac1247e16f35fe282af041ec3f32477faca515e"}, "closed": true, "closedAt": "2020-01-22T09:33:27Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8m1n-gH2gAyMzY1NDg5ODk1OmEyYzdhMzFkOTdjYzM3MTMwMjU1NjI0OTI5NDhhZWNkYzJhZTc1MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8zFe-AFqTM0NjQ3OTExNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a2c7a31d97cc3713025562492948aecdc2ae7516", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2c7a31d97cc3713025562492948aecdc2ae7516", "committedDate": "2020-01-21T20:05:21Z", "message": "Fix Overly Optimistic Request Deduplication\n\nOn master failover we have to resent all the shard failed messages,\nbut the transport requests remain the same in the eyes of `equals`.\nIf the master failover is registered and the requests to the new master\nare sent before all the callbacks have executed and the request to the\nold master removed from the deduplicator then the requuests to the new\nmaster will incorrectly fail and the snapshot get stuck.\n\nCloses #51253"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MTYyOTQ2", "url": "https://github.com/elastic/elasticsearch/pull/51270#pullrequestreview-346162946", "createdAt": "2020-01-21T20:17:06Z", "commit": {"oid": "a2c7a31d97cc3713025562492948aecdc2ae7516"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDoxNzowN1rOFgHeqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMDoxNzowN1rOFgHeqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTIyMTI5MQ==", "bodyText": "I know there's just one use case for this now, but just dropping all deduplication seems to be the right approach to master failovers in general if we ever want to  reuse this for e.g. put mapping calls or so.", "url": "https://github.com/elastic/elasticsearch/pull/51270#discussion_r369221291", "createdAt": "2020-01-21T20:17:07Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/transport/TransportRequestDeduplicator.java", "diffHunk": "@@ -53,6 +53,14 @@ public void executeOnce(T request, ActionListener<Void> listener, BiConsumer<T,\n         }\n     }\n \n+    /**\n+     * Remove all tracked requests from this instance so that the first time {@link #executeOnce} is invoked with any request it triggers\n+     * an actual request execution. Use this e.g. for requests to master that need to be sent again on master failover.\n+     */\n+    public void clear() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2c7a31d97cc3713025562492948aecdc2ae7516"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02a8a3e1e0448b317c1f07ffca4382de29a510ef", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/02a8a3e1e0448b317c1f07ffca4382de29a510ef", "committedDate": "2020-01-21T20:30:39Z", "message": "Merge remote-tracking branch 'elastic/master' into 51253"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzI2Mzg3", "url": "https://github.com/elastic/elasticsearch/pull/51270#pullrequestreview-346326387", "createdAt": "2020-01-22T03:19:56Z", "commit": {"oid": "02a8a3e1e0448b317c1f07ffca4382de29a510ef"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "700184e526c3af77725bfecc7465b7a57d794ae5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/700184e526c3af77725bfecc7465b7a57d794ae5", "committedDate": "2020-01-22T08:40:53Z", "message": "Merge remote-tracking branch 'elastic/master' into 51253"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDc5MTE1", "url": "https://github.com/elastic/elasticsearch/pull/51270#pullrequestreview-346479115", "createdAt": "2020-01-22T10:21:31Z", "commit": {"oid": "700184e526c3af77725bfecc7465b7a57d794ae5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDoyMTozMlrOFgXCeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDoyMTozMlrOFgXCeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ3NjIxNg==", "bodyText": "I don't understand why this is needed. UpdateSnapshotStatusAction is a TransportMasterNodeAction and should resend the request in case of master failover.", "url": "https://github.com/elastic/elasticsearch/pull/51270#discussion_r369476216", "createdAt": "2020-01-22T10:21:32Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotShardsService.java", "diffHunk": "@@ -358,6 +358,9 @@ private void syncShardStatsOnNewMaster(ClusterChangedEvent event) {\n             return;\n         }\n \n+        // Clear request deduplicator since we need to send all requests that were potentially not handled by the previous\n+        // master again\n+        remoteFailedRequestDeduplicator.clear();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "700184e526c3af77725bfecc7465b7a57d794ae5"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2809, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}