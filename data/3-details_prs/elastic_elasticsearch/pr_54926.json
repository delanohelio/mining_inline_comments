{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTE0MDE5", "number": 54926, "title": "Deprecate serializing PipelineAggregators", "bodyText": "PipelineAggregators are only sent across the wire for backwards\ncompatibility with 7.7.0. PipelineAggregator needs to continue to\nimplement NamedWriteable for backwards compatibility but pipeline\naggregations created after 7.7.0 need not implement any of the methods\nin that interface because we'll never attempt to call them. So this\ncreates implementations in PipelineAggregator (the base class) that\njust throw exceptions.", "createdAt": "2020-04-07T21:34:05Z", "url": "https://github.com/elastic/elasticsearch/pull/54926", "merged": true, "mergeCommit": {"oid": "ea6152c64e675c3e69b5e5b84116d9ceb0a9d037"}, "closed": true, "closedAt": "2020-04-09T16:01:34Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVaLTPAH2gAyNDAwNTE0MDE5OjAxZDBkNDQ5YTQ2Mzg1MGI4ZjQzYjYxZGZkYTgxM2UwNGJmYWQ1M2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcV-D2ugH2gAyNDAwNTE0MDE5OjUwOTQ2MTE5MWMyMWMxMzMzYjI5MDQ5NTVmOTlhY2EzMzU5ZmMzZWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "01d0d449a463850b8f43b61dfda813e04bfad53b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/01d0d449a463850b8f43b61dfda813e04bfad53b", "committedDate": "2020-04-07T21:28:22Z", "message": "Deprecate serializing PipelineAggregators\n\n`PipelineAggregator`s are only sent across the wire for backwards\ncompatibility with 7.7.0. `PipelineAggregator` needs to continue to\nimplement `NamedWriteable` for backwards compatibility but pipeline\naggregations created after 7.7.0 need not implement any of the methods\nin that interface because we'll never attempt to call them. So this\ncreates implementations in `PipelineAggregator` (the base class) that\njust throw exceptions."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/761ba29cba4a7878af05375cc250a85f23fd89f7", "committedDate": "2020-04-08T13:01:50Z", "message": "Merge branch 'master' into pipeline_drop_dep"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTUwNDAy", "url": "https://github.com/elastic/elasticsearch/pull/54926#pullrequestreview-390150402", "createdAt": "2020-04-08T16:45:14Z", "commit": {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo0NToxNFrOGC323w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo0NToxNFrOGC323w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NTUwMw==", "bodyText": "Hmm, I think these exception messages are a bit confusing.  If I understand correctly, this path theoretically should never happen because e.g. InternalAggregations won't serialize pipelines in 7.8+, so read/write on the aggregator 7.8+ should never be invoked.\nI think we should probably change the message to \"Cannot (de)serialize pipeline aggregator from stream because pipelines are not serialized after 7.8\" or something to that effect.  That way if a user does see this, it won't confuse them; the current message may make them think the aggregation itself is no longer supported (due to the node being 7.8+ to reach that statement, but the message saying \"before 7.8\").\nI think we need to throw a 5xx error too, because if we get here we are firmly in the server-side going pear shaped and not the fault of a client/user.  Perhaps IllegalStateException?", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r405665503", "createdAt": "2020-04-08T16:45:14Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalArgumentException(\"[\" + getClass() + \"] is not supported on versions before 7.8.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbbc216507c26406c2a8a3475754b1a89b870d7d", "committedDate": "2020-04-09T14:09:26Z", "message": "Update exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODQwODIz", "url": "https://github.com/elastic/elasticsearch/pull/54926#pullrequestreview-390840823", "createdAt": "2020-04-09T14:24:26Z", "commit": {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyNDoyNlrOGDbEyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyNDoyNlrOGDbEyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjUwNA==", "bodyText": "Typo: \"because it 7.8.0\" :)", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r406242504", "createdAt": "2020-04-09T14:24:26Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalStateException(\"Cannot deserialize pipeline [\" + getClass() + \"] because it 7.8.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0966deca17e5124418895754b42a2cb4bbf161b4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/0966deca17e5124418895754b42a2cb4bbf161b4", "committedDate": "2020-04-09T15:16:11Z", "message": "Merge branch 'master' into pipeline_drop_dep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "509461191c21c1333b2904955f99aca3359fc3ed", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/509461191c21c1333b2904955f99aca3359fc3ed", "committedDate": "2020-04-09T15:16:49Z", "message": "Words are hard"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3571, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}