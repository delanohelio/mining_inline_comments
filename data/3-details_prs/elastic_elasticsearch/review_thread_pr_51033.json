{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMDk4OTMz", "number": 51033, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDowOTowOFrODZgQCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxNDoxM1rODZgXKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDY5Mzg0OnYy", "diffSide": "RIGHT", "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDowOTowOFrOFf7OxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDowOTowOFrOFf7OxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMDYxMw==", "bodyText": "#TBD -> #51154", "url": "https://github.com/elastic/elasticsearch/pull/51033#discussion_r369020613", "createdAt": "2020-01-21T14:09:08Z", "author": {"login": "davidkyle"}, "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "diffHunk": "@@ -0,0 +1,261 @@\n+---\n+setup:\n+  - skip:\n+      features: headers\n+\n+  - do:\n+      cluster.health:\n+        wait_for_status: yellow\n+\n+  - do:\n+      security.put_user:\n+        username: \"joe\"\n+        body:  >\n+            {\n+              \"password\": \"transform\",\n+              \"roles\" : [  \"transform_admin\", \"x_cluster_role\" ]\n+            }\n+  - do:\n+      security.put_role:\n+        name: \"x_cluster_role\"\n+        body:  >\n+            {\n+              \"cluster\": [],\n+              \"indices\": [\n+                {\n+                  \"names\": [\"test_index\", \"my_remote_cluster:test_i*\", \"my_remote_cluster:aliased_test_index\"],\n+                  \"privileges\": [\"all\", \"view_index_metadata\"]\n+                },\n+                {\n+                  \"names\": [\"simple-remote-transform\", \"simple-local-remote-transform\"],\n+                  \"privileges\": [\"all\"]\n+                }\n+              ]\n+            }\n+---\n+teardown:\n+  - do:\n+      security.delete_user:\n+        username: \"joe\"\n+        ignore: 404\n+\n+---\n+\"Search remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: my_remote_cluster:test_index\n+        body:\n+          aggs:\n+            user:\n+              terms:\n+                field: user\n+\n+  - match: { _shards.total: 3 }\n+  - match: { hits.total: 9 }\n+  - length: { aggregations.user.buckets: 3 }\n+  - match: { aggregations.user.buckets.0.key: \"a\" }\n+  - match: { aggregations.user.buckets.0.doc_count: 5 }\n+\n+---\n+\"Batch transform from remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": \"my_remote_cluster:test_index\" },\n+            \"dest\": { \"index\": \"simple-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\"avg_stars\": {\"avg\": {\"field\": \"stars\"}}}\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d09a497026e309dda75ce4b86c39d1009aff9c4"}, "originalPosition": 108}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI4MDcxMjA4OnYy", "diffSide": "RIGHT", "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxNDoxM1rOFf7aFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxNDoxNDoxM1rOFf7aFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTAyMzUwOQ==", "bodyText": "#TBD -> #51154", "url": "https://github.com/elastic/elasticsearch/pull/51033#discussion_r369023509", "createdAt": "2020-01-21T14:14:13Z", "author": {"login": "davidkyle"}, "path": "x-pack/qa/multi-cluster-tests-with-security/src/test/resources/rest-api-spec/test/multi_cluster/80_transform.yml", "diffHunk": "@@ -0,0 +1,261 @@\n+---\n+setup:\n+  - skip:\n+      features: headers\n+\n+  - do:\n+      cluster.health:\n+        wait_for_status: yellow\n+\n+  - do:\n+      security.put_user:\n+        username: \"joe\"\n+        body:  >\n+            {\n+              \"password\": \"transform\",\n+              \"roles\" : [  \"transform_admin\", \"x_cluster_role\" ]\n+            }\n+  - do:\n+      security.put_role:\n+        name: \"x_cluster_role\"\n+        body:  >\n+            {\n+              \"cluster\": [],\n+              \"indices\": [\n+                {\n+                  \"names\": [\"test_index\", \"my_remote_cluster:test_i*\", \"my_remote_cluster:aliased_test_index\"],\n+                  \"privileges\": [\"all\", \"view_index_metadata\"]\n+                },\n+                {\n+                  \"names\": [\"simple-remote-transform\", \"simple-local-remote-transform\"],\n+                  \"privileges\": [\"all\"]\n+                }\n+              ]\n+            }\n+---\n+teardown:\n+  - do:\n+      security.delete_user:\n+        username: \"joe\"\n+        ignore: 404\n+\n+---\n+\"Search remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: my_remote_cluster:test_index\n+        body:\n+          aggs:\n+            user:\n+              terms:\n+                field: user\n+\n+  - match: { _shards.total: 3 }\n+  - match: { hits.total: 9 }\n+  - length: { aggregations.user.buckets: 3 }\n+  - match: { aggregations.user.buckets.0.key: \"a\" }\n+  - match: { aggregations.user.buckets.0.doc_count: 5 }\n+\n+---\n+\"Batch transform from remote cluster\":\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": \"my_remote_cluster:test_index\" },\n+            \"dest\": { \"index\": \"simple-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\"avg_stars\": {\"avg\": {\"field\": \"stars\"}}}\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      indices.refresh:\n+        index: simple-remote-transform\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      search:\n+        rest_total_hits_as_int: true\n+        index: simple-remote-transform\n+        sort: user\n+\n+  - match: { hits.total: 3 }\n+  - match: { hits.hits.0._index: simple-remote-transform }\n+  - match: { hits.hits.0._source.avg_stars: 3.6 }\n+  - match: { hits.hits.0._source.user: a }\n+  - match: { hits.hits.1._source.avg_stars: 2.0 }\n+  - match: { hits.hits.1._source.user: b }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.update_transform:\n+        transform_id: \"simple-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": [\"my_remote_cluster:test_index\", \"my_remote_cluster:test_index_2\"] }\n+          }\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  # we added test_index_2, which has 2 more docs:\n+  - match: { transforms.0.checkpointing.operations_behind: 2 }\n+\n+---\n+\"Batch transform from local and remote cluster\":\n+  - do:\n+      indices.create:\n+        index: test_index\n+        body:\n+          settings:\n+            index:\n+              number_of_shards: 3\n+              number_of_replicas: 0\n+          aliases:\n+            test_alias: {}\n+          mappings:\n+            properties:\n+              time:\n+                type: date\n+              user:\n+                type: keyword\n+              stars:\n+                type: integer\n+              coolness:\n+                type: integer\n+\n+  - do:\n+      bulk:\n+        refresh: true\n+        body:\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"a\", \"stars\": 3, \"date\" : \"2018-11-29T12:12:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 5, \"date\" : \"2018-11-29T12:14:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"d\", \"stars\": 5, \"date\" : \"2018-11-29T12:16:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"e\", \"stars\": 2, \"date\" : \"2018-11-29T12:17:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"b\", \"stars\": 3, \"date\" : \"2018-11-29T12:22:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 5, \"date\" : \"2018-11-29T12:23:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"d\", \"stars\": 1, \"date\" : \"2018-11-29T12:32:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"e\", \"stars\": 3, \"date\" : \"2018-11-29T12:34:12.123456789Z\"}'\n+            - '{\"index\": {\"_index\": \"test_index\"}}'\n+            - '{\"user\": \"c\", \"stars\": 4, \"date\" : \"2018-11-29T12:35:12.123456789Z\"}'\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.put_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+        body: >\n+          {\n+            \"source\": { \"index\": [\"test_index\", \"my_remote_cluster:test_index\"] },\n+            \"dest\": { \"index\": \"simple-local-remote-transform\" },\n+            \"pivot\": {\n+              \"group_by\": { \"user\": {\"terms\": {\"field\": \"user\"}}},\n+              \"aggs\": {\n+                \"avg_stars\": {\"avg\": {\"field\": \"stars\"}},\n+                \"count\": {\"value_count\": {\"field\": \"user\"}}\n+              }\n+            }\n+          }\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.start_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      transform.get_transform_stats:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-local-remote-transform\" }\n+  - match: { transforms.0.state: \"/started|indexing|stopping|stopped/\" }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.stop_transform:\n+        transform_id: \"simple-local-remote-transform\"\n+        wait_for_completion: true\n+        wait_for_checkpoint: true\n+  - match: { acknowledged: true }\n+\n+  - do:\n+      headers: { Authorization: \"Basic am9lOnRyYW5zZm9ybQ==\" }\n+      transform.get_transform_stats:\n+        transform_id: \"simple-local-remote-transform\"\n+  - match: { count: 1 }\n+  - match: { transforms.0.id: \"simple-local-remote-transform\" }\n+  - match: { transforms.0.state: \"stopped\" }\n+  - match: { transforms.0.checkpointing.last.checkpoint: 1 }\n+\n+  # workaround: refresh dest index, to be removed, see gh #TBD", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d09a497026e309dda75ce4b86c39d1009aff9c4"}, "originalPosition": 240}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4604, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}