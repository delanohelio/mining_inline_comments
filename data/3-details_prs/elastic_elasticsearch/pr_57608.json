{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjcwNjQ0", "number": 57608, "title": "Fix Remote Recovery Being Retried for Removed Nodes", "bodyText": "If a node is disconnected we retry. It does not make sense\nto retry the recovery if the node is removed from the cluster though.\n=> added a check for the node being part of the cluster before retrying\nAlso, we were running the retry on the SAME pool which for each retry will\nbe the scheduler pool. Since the error path of the listener we use here\nwill do blocking operations when closing the resources used by the recovery\nwe can't use the SAME pool here since not all exceptions go to the ActionListenerResponseHandler\nthreading like e.g. NodeNotConnectedException.\nCloses #57585\n... non-issue label because this hasn't yet been released", "createdAt": "2020-06-03T15:13:48Z", "url": "https://github.com/elastic/elasticsearch/pull/57608", "merged": true, "mergeCommit": {"oid": "e1065b24142d1011213fee685de7a24046bd2b5d"}, "closed": true, "closedAt": "2020-06-10T06:49:10Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnq6IPAH2gAyNDI3MjcwNjQ0OjI2ZWYzZDE3YWQyNTMxMjBlZjMwMzhiMzJkNmQ3YWY3YTBkMjY5OGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcptXFPgFqTQyNzYwNTE1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "26ef3d17ad253120ef3038b32d6d7af7a0d2698d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/26ef3d17ad253120ef3038b32d6d7af7a0d2698d", "committedDate": "2020-06-03T15:08:38Z", "message": "Fix Remote Recovery Being Retried for Removed Nodes\n\nIf a node is disconnected we retry. It does not make sense\nto retry the recovery if the node is removed from the cluster though.\n=> added a check for the node being part of the cluster before retrying\n\nAlso, we were running the retry on the `SAME` pool which for each retry will\nbe the scheduler pool. Since the error path of the listener we use here\nwill do blocking operations when closing the resources used by the recovery\nwe can't use the `SAME` pool here since not all exceptions go to the `ActionListenerResponseHandler`\nthreading like e.g. `NodeNotConnectedException`.\n\nCloses #57585"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjU4NjAy", "url": "https://github.com/elastic/elasticsearch/pull/57608#pullrequestreview-423658602", "createdAt": "2020-06-03T15:15:14Z", "commit": {"oid": "26ef3d17ad253120ef3038b32d6d7af7a0d2698d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNToxNToxNFrOGegqBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNToxNToxNFrOGegqBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY0NTUxMA==", "bodyText": "The root of the issue here is that we keep retrying the request here when the node is gone from the cluster for good. Since we never stop this retry, we never release the underlying commit and the respective assertion for releasing all the commits in the ITs fails.\nThis fix feels really dirty to me though. I mainly opened this to illustrate where the problem lies, not sure this is an appropriate fix. Ideally, I'd hope we would have some mechanism for cancelling the retry if a node is dropped form the cluster but I couldn't find an easy way of building that (maybe someone else can?).", "url": "https://github.com/elastic/elasticsearch/pull/57608#discussion_r434645510", "createdAt": "2020-06-03T15:15:14Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/indices/recovery/RemoteRecoveryTargetHandler.java", "diffHunk": "@@ -261,7 +266,7 @@ public void tryAction(ActionListener<T> listener) {\n \n             @Override\n             public boolean shouldRetry(Exception e) {\n-                return retriesSupported && retryableException(e);\n+                return retriesSupported && clusterService.state().nodes().nodeExists(targetNode) && retryableException(e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26ef3d17ad253120ef3038b32d6d7af7a0d2698d"}, "originalPosition": 51}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "082b8918076aaf915af7c10a1b2363a3444227d5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/082b8918076aaf915af7c10a1b2363a3444227d5", "committedDate": "2020-06-04T11:59:16Z", "message": "CR: track retries by listening to CS"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c58e0bc7fb5eddd9bc55182b5c16c38838ef59d9", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c58e0bc7fb5eddd9bc55182b5c16c38838ef59d9", "committedDate": "2020-06-04T11:59:32Z", "message": "Merge remote-tracking branch 'elastic/master' into 57585"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2NjM4MTY4", "url": "https://github.com/elastic/elasticsearch/pull/57608#pullrequestreview-426638168", "createdAt": "2020-06-08T21:34:19Z", "commit": {"oid": "c58e0bc7fb5eddd9bc55182b5c16c38838ef59d9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e90c5b4eeefd44e35b1a7cfeee85d966c558f0eb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e90c5b4eeefd44e35b1a7cfeee85d966c558f0eb", "committedDate": "2020-06-09T09:25:51Z", "message": "Merge remote-tracking branch 'elastic/master' into 57585"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82ec5e6204f1debe4f88f4879add46c1855f99ad", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/82ec5e6204f1debe4f88f4879add46c1855f99ad", "committedDate": "2020-06-09T11:49:52Z", "message": "simpler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c882a351a14b824a12cb2aed72759f7be8d41ff6", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c882a351a14b824a12cb2aed72759f7be8d41ff6", "committedDate": "2020-06-09T11:56:22Z", "message": "simpler"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI3NjA1MTU3", "url": "https://github.com/elastic/elasticsearch/pull/57608#pullrequestreview-427605157", "createdAt": "2020-06-09T23:07:55Z", "commit": {"oid": "c882a351a14b824a12cb2aed72759f7be8d41ff6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3856, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}