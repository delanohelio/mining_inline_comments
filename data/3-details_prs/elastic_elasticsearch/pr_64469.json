{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0MDAwNTA0", "number": 64469, "title": "Fix merging of terms aggregation with compound order", "bodyText": "This change fixes a bug introduced in #61779 that uses a compound order to\ncompare buckets when merging. The bug is triggered when the compound order\nuses a primary sort ordered by key (asc or desc).\nThis commit ensures that we always extract the primary sort when comparing keys\nduring merging.\nThe PR is marked as no-issue since the bug has not been released in any official version.", "createdAt": "2020-11-02T11:40:49Z", "url": "https://github.com/elastic/elasticsearch/pull/64469", "merged": true, "mergeCommit": {"oid": "9c7ad84bba024d1048ff4851677a16f4b1857f88"}, "closed": true, "closedAt": "2020-11-05T10:29:48Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYjBIkAH2gAyNTE0MDAwNTA0OmZhZjMzZWQyOTg1ODc0YzdmYzliNGEzM2FjMzYxOGU1ZmJiYmI5MjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZelwYAH2gAyNTE0MDAwNTA0OjM3Nzc3NjA5NjZiNzM5NDE2NzllZjc0MmNlODZlNzE0OWMzYmY2ZGQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "faf33ed2985874c7fc9b4a33ac3618e5fbbbb921", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/faf33ed2985874c7fc9b4a33ac3618e5fbbbb921", "committedDate": "2020-11-02T11:39:20Z", "message": "Fix merging of terms aggregation with compound order\n\nThis change fixes a bug introduced in #61779 that uses a compound order to\ncompare buckets when merging. The bug is triggered when the compound order\nuses a primary sort ordered by key (asc or desc).\nThis commit ensures that we always extract the primary sort when comparing keys\nduring merging.\nThe PR is marked as no-issue since the bug has not been released in any official version."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b0a05e8765d8ad3cf1f1ec482e6d9151308660f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b0a05e8765d8ad3cf1f1ec482e6d9151308660f", "committedDate": "2020-11-02T12:21:00Z", "message": "fix random dictionary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6844571f433e1355bb919fccb9beca471cb05e8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6844571f433e1355bb919fccb9beca471cb05e8", "committedDate": "2020-11-02T12:42:21Z", "message": "checkstyl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5", "committedDate": "2020-11-03T08:20:34Z", "message": "Merge branch 'master' into bugs/terms_compound_order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzNTI5NjA2", "url": "https://github.com/elastic/elasticsearch/pull/64469#pullrequestreview-523529606", "createdAt": "2020-11-04T16:28:39Z", "commit": {"oid": "f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNjoyODozOVrOHtf9TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxNjoyODozOVrOHtf9TA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzQ3MTU2NA==", "bodyText": "Can dict be a local variable?", "url": "https://github.com/elastic/elasticsearch/pull/64469#discussion_r517471564", "createdAt": "2020-11-04T16:28:39Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/StringTermsTests.java", "diffHunk": "@@ -34,13 +34,26 @@\n import java.util.Set;\n \n public class StringTermsTests extends InternalTermsTestCase {\n+    private BytesRef[] dict;\n+\n+    public synchronized void generateRandomDict() {\n+        if (dict == null) {\n+            Set<BytesRef> terms = new HashSet<>();\n+            int numTerms = randomIntBetween(2, 100);\n+            for (int i = 0; i < numTerms; i++) {\n+                terms.add(new BytesRef(randomAlphaOfLength(10)));\n+            }\n+            dict = terms.stream().toArray(BytesRef[]::new);\n+        }\n+    }\n \n     @Override\n     protected InternalTerms<?, ?> createTestInstance(String name,\n                                                      Map<String, Object> metadata,\n                                                      InternalAggregations aggregations,\n                                                      boolean showTermDocCountError,\n                                                      long docCountError) {\n+        generateRandomDict();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f7e5eaa26e1c7a2a8c8f3d36bc525e06950b8cc5"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e48bd76529f47db3cf6951848d54c05c5c8b4c", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1e48bd76529f47db3cf6951848d54c05c5c8b4c", "committedDate": "2020-11-04T20:28:36Z", "message": "apply review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22ae61b8c0003e09c7208c251d692456307e6c5e", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/22ae61b8c0003e09c7208c251d692456307e6c5e", "committedDate": "2020-11-04T20:28:51Z", "message": "Merge branch 'master' into bugs/terms_compound_order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3777760966b73941679ef742ce86e7149c3bf6dd", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3777760966b73941679ef742ce86e7149c3bf6dd", "committedDate": "2020-11-05T09:03:44Z", "message": "refactor tests to use a local variable"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 911, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}