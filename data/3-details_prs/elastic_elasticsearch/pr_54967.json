{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwOTY2MTIy", "number": 54967, "title": "Deprecate the kibana reserved user; introduce kibana_system user", "bodyText": "Deprecates the reserved kibana user in favor of a new kibana_system user with an identical set of privileges.\nThis uses the same _deprecated and _deprecated_reason metadata attributes that we use to denote deprecated roles. Similarly, this logs a deprecation warning when a deprecated user successfully authenticates to Elasticsearch.\nPartially addresses elastic/kibana#25879\nCompanion PRs:\nelastic/stack-docs#991\nelastic/kibana#63186", "createdAt": "2020-04-08T16:54:52Z", "url": "https://github.com/elastic/elasticsearch/pull/54967", "merged": true, "mergeCommit": {"oid": "269b152a8f372cd729f3847a26c6cfb31f9b02b8"}, "closed": true, "closedAt": "2020-04-27T17:31:21Z", "author": {"login": "legrego"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVsBNRABqjMyMTUyNzgzNTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcbyCczAH2gAyNDAwOTY2MTIyOjc0ZmRjMWNkMjBkZTQ2MDJkNjVlYWUwMTc3YTlmNWE3MmVjNTc0ODg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b974c0cd330c76e371ad07c0c2d7b78a14d4936b", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/b974c0cd330c76e371ad07c0c2d7b78a14d4936b", "committedDate": "2020-04-08T17:15:30Z", "message": "fix license and test errors"}, "afterCommit": {"oid": "601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "committedDate": "2020-04-08T18:15:17Z", "message": "fix license and test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/601b05cbe9cb2a4eafe57cf44b37cb2bc214290f", "committedDate": "2020-04-08T18:15:17Z", "message": "fix license and test errors"}, "afterCommit": {"oid": "6813965047e5e8605b46efb8fecba3a82e86b85b", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/6813965047e5e8605b46efb8fecba3a82e86b85b", "committedDate": "2020-04-08T20:36:07Z", "message": "fix license and test errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b34e4bbdab5bde85cc8f3cabbcbc92a5cd64d665", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/b34e4bbdab5bde85cc8f3cabbcbc92a5cd64d665", "committedDate": "2020-04-09T12:19:41Z", "message": "deprecate the kibana reserved user; introduce kibana_system user"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6813965047e5e8605b46efb8fecba3a82e86b85b", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/6813965047e5e8605b46efb8fecba3a82e86b85b", "committedDate": "2020-04-08T20:36:07Z", "message": "fix license and test errors"}, "afterCommit": {"oid": "6e9c434b1b21d4670e77583192df6b8583428cf5", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e9c434b1b21d4670e77583192df6b8583428cf5", "committedDate": "2020-04-09T12:19:41Z", "message": "fix license and test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e9c434b1b21d4670e77583192df6b8583428cf5", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e9c434b1b21d4670e77583192df6b8583428cf5", "committedDate": "2020-04-09T12:19:41Z", "message": "fix license and test errors"}, "afterCommit": {"oid": "ef8452ac8a43e4ccd8f8d65e747271c810634b09", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef8452ac8a43e4ccd8f8d65e747271c810634b09", "committedDate": "2020-04-09T14:17:09Z", "message": "fix license and test errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bc702d903009d1414ab20716eb814ba2ca334ad", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bc702d903009d1414ab20716eb814ba2ca334ad", "committedDate": "2020-04-09T17:33:58Z", "message": "fix license and test errors"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ef8452ac8a43e4ccd8f8d65e747271c810634b09", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/ef8452ac8a43e4ccd8f8d65e747271c810634b09", "committedDate": "2020-04-09T14:17:09Z", "message": "fix license and test errors"}, "afterCommit": {"oid": "7bc702d903009d1414ab20716eb814ba2ca334ad", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bc702d903009d1414ab20716eb814ba2ca334ad", "committedDate": "2020-04-09T17:33:58Z", "message": "fix license and test errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5125556a15bea064c2d0123c125962ea68e96fd", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5125556a15bea064c2d0123c125962ea68e96fd", "committedDate": "2020-04-09T18:50:31Z", "message": "fix IdentityProviderAuthenticationIT tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "761f401ba0a1c932622df7455b9d61e3e9c613b9", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/761f401ba0a1c932622df7455b9d61e3e9c613b9", "committedDate": "2020-04-09T19:45:29Z", "message": "test deprecation logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6b576e8b7a684f5ae6296d574374b0c169db7e8a", "committedDate": "2020-04-10T01:47:25Z", "message": "Merge branch 'master' into security/deprecate-kibana-user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNjQwMDk0", "url": "https://github.com/elastic/elasticsearch/pull/54967#pullrequestreview-391640094", "createdAt": "2020-04-10T20:17:50Z", "commit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoxNzo1MFrOGEEteQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQyMDoxNzo1MFrOGEEteQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDY2NQ==", "bodyText": "I don't love this test because it's fixed on the single deprecated kibana user, and won't work once we actually remove this user. I'm open to suggestions on how to rewrite this more generically, because it wasn't immediately obvious to me.\nI could make the logDeprercatedUser method public so that it's testable on its own, but that didn't seem like the right solution either.", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r406924665", "createdAt": "2020-04-10T20:17:50Z", "author": {"login": "legrego"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java", "diffHunk": "@@ -125,10 +126,22 @@ public void testAuthenticationDisabledUserWithStoredPassword() throws Throwable\n         verifySuccessfulAuthentication(false);\n     }\n \n+    public void testLogDeprecatedUser() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNzcwMjE5", "url": "https://github.com/elastic/elasticsearch/pull/54967#pullrequestreview-393770219", "createdAt": "2020-04-15T13:26:00Z", "commit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxMzoyNjowMFrOGF5jQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxNDoxNTozMFrOGF7zhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODgzODk3Nw==", "bodyText": "I think it's cumbersome on the user to have password prompts for both kibana and kibana_system.\nI suggest we display the prompt for the new kibana_system user and also set the same password for the kibana user.", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r408838977", "createdAt": "2020-04-15T13:26:00Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/esnative/tool/SetupPasswordTool.java", "diffHunk": "@@ -65,8 +66,8 @@\n public class SetupPasswordTool extends LoggingAwareMultiCommand {\n \n     private static final char[] CHARS = (\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\").toCharArray();\n-    public static final List<String> USERS = asList(ElasticUser.NAME, APMSystemUser.NAME, KibanaUser.NAME, LogstashSystemUser.NAME,\n-        BeatsSystemUser.NAME, RemoteMonitoringUser.NAME);\n+    public static final List<String> USERS = asList(ElasticUser.NAME, APMSystemUser.NAME, KibanaUser.NAME, KibanaSystemUser.NAME,\n+        LogstashSystemUser.NAME, BeatsSystemUser.NAME, RemoteMonitoringUser.NAME);\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODg3NTkxMA==", "bodyText": "I think this is fine, but I would go with:\n--- a/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n+++ b/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java\n@@ -126,16 +126,13 @@ public class ReservedRealmTests extends ESTestCase {\n         verifySuccessfulAuthentication(false);\n     }\n\n-    public void testLogDeprecatedUser() throws Exception {\n-        final User expected = new KibanaUser(true);\n-        this.verifySuccessfulAuthenticationForUser(expected, true);\n-        assertWarnings(\"The user [kibana] is deprecated and will be removed in a future version of Elasticsearch. \" +\n-            \"Please use the [kibana_system] user instead.\");\n-    }\n-\n     private void verifySuccessfulAuthentication(boolean enabled) throws Exception {\n         final User expectedUser = randomReservedUser(enabled);\n         this.verifySuccessfulAuthenticationForUser(expectedUser, enabled);\n+        if (new KibanaUser(enabled).equals(expectedUser)) {\n+            assertWarnings(\"The user [kibana] is deprecated and will be removed in a future version of Elasticsearch. \" +\n+                    \"Please use the [kibana_system] user instead.\");\n+        }\n     }\n\n     private void verifySuccessfulAuthenticationForUser(User expectedUser, boolean enabled) throws Exception {", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r408875910", "createdAt": "2020-04-15T14:15:30Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/esnative/ReservedRealmTests.java", "diffHunk": "@@ -125,10 +126,22 @@ public void testAuthenticationDisabledUserWithStoredPassword() throws Throwable\n         verifySuccessfulAuthentication(false);\n     }\n \n+    public void testLogDeprecatedUser() throws Exception {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjkyNDY2NQ=="}, "originalCommit": {"oid": "6b576e8b7a684f5ae6296d574374b0c169db7e8a"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fe89d886feb8accfd997ae430a8ea0f7cd16835", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fe89d886feb8accfd997ae430a8ea0f7cd16835", "committedDate": "2020-04-17T16:02:30Z", "message": "First pass at SetupPasswordTool updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cde855042c5ab13fc4c7fbbd9b4d40c1d69d17a", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/9cde855042c5ab13fc4c7fbbd9b4d40c1d69d17a", "committedDate": "2020-04-17T16:03:10Z", "message": "Merge branch 'security/deprecate-kibana-user' of github.com:legrego/elasticsearch into security/deprecate-kibana-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b32de55722bfd469e9a381996e0c6b2cf3806bc8", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/b32de55722bfd469e9a381996e0c6b2cf3806bc8", "committedDate": "2020-04-23T13:20:59Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56490e5eb3a9e1adb2edd1b1d7a40f383af15b60", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/56490e5eb3a9e1adb2edd1b1d7a40f383af15b60", "committedDate": "2020-04-23T13:21:06Z", "message": "update docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f28670c1c3f5d790fc4350ba6be652a072a23c9c", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/f28670c1c3f5d790fc4350ba6be652a072a23c9c", "committedDate": "2020-04-23T13:31:30Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into security/deprecate-kibana-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e92196c4f2cfd2f74a5a5fd10d6b23488ed041a8", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e92196c4f2cfd2f74a5a5fd10d6b23488ed041a8", "committedDate": "2020-04-23T17:37:02Z", "message": "Merge branch 'master' into security/deprecate-kibana-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da5acfa3b6218cca625473e6389867741ca11fb5", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/da5acfa3b6218cca625473e6389867741ca11fb5", "committedDate": "2020-04-23T19:38:43Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into security/deprecate-kibana-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5938991edfb36c4677f4b4cba2a17e8f7daba66", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5938991edfb36c4677f4b4cba2a17e8f7daba66", "committedDate": "2020-04-23T19:39:04Z", "message": "Merge branch 'security/deprecate-kibana-user' of github.com:legrego/elasticsearch into security/deprecate-kibana-user"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50b58d434bd320e6b2cd7c396248c9ed90ae692f", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/50b58d434bd320e6b2cd7c396248c9ed90ae692f", "committedDate": "2020-04-23T19:50:23Z", "message": "update number of expected users"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832", "committedDate": "2020-04-27T13:32:02Z", "message": "Merge branch 'master' into security/deprecate-kibana-user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDg1NDgy", "url": "https://github.com/elastic/elasticsearch/pull/54967#pullrequestreview-401085482", "createdAt": "2020-04-27T15:46:58Z", "commit": {"oid": "b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNTo0Njo1OFrOGMqQrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QxNTo0Njo1OFrOGMqQrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTkyODQ5Mw==", "bodyText": "This notice looks dope \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/54967#discussion_r415928493", "createdAt": "2020-04-27T15:46:58Z", "author": {"login": "albertzaharovits"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -132,3 +132,40 @@ It is now an error to enable SSL for the HTTP (Rest) server without also configu\n a certificate and key through use of the `xpack.security.http.ssl.keystore.path`\n setting or the `xpack.security.http.ssl.certificate` and\n `xpack.security.http.ssl.key` settings.\n+\n+\n+[float]\n+[[builtin-users-changes]]\n+==== Changes to built-in users\n+\n+[float]\n+===== The `kibana` user has been removed in favor of the `kibana_system` user\n+\n+The `kibana` user was historically used to authenticate {kib} to {es}.\n+The name of this user was confusing, and was often mistakenly used to login to {kib}.\n+This has been renamed to `kibana_system` in order to reduce confusion, and to better\n+align with other built-in system accounts.\n+\n+If your `kibana.yml` used to contain:\n+[source,yaml]\n+--------------------------------------------------\n+elasticsearch.username: kibana\n+--------------------------------------------------\n+\n+then you should update to use the new `kibana_system` user instead:\n+[source,yaml]\n+--------------------------------------------------\n+elasticsearch.username: kibana_system\n+--------------------------------------------------\n+\n+\n+[float]\n+[[builtin-roles-changes]]\n+==== Changes to built-in roles\n+\n+[float]\n+===== The `kibana_user` role has been removed in favor of the `kibana_admin` role\n+\n+Users who were previously assigned the `kibana_user` role should instead be assigned\n+the `kibana_admin` role. This role grants the same set of privileges as `kibana_user`, but has been\n+renamed to better reflect its intended use.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAxMDkwODUx", "url": "https://github.com/elastic/elasticsearch/pull/54967#pullrequestreview-401090851", "createdAt": "2020-04-27T15:52:54Z", "commit": {"oid": "b9d1ab87c1e3ed9e8f66f80056bbe51c03bd7832"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74fdc1cd20de4602d65eae0177a9f5a72ec57488", "author": {"user": {"login": "legrego", "name": "Larry Gregory"}}, "url": "https://github.com/elastic/elasticsearch/commit/74fdc1cd20de4602d65eae0177a9f5a72ec57488", "committedDate": "2020-04-27T16:39:58Z", "message": "update test to expect deprecation header"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3610, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}