{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYwNDEwNjE0", "number": 50735, "title": "Add max_resource_units to enterprise license", "bodyText": "The enterprise license type must has \"max_resource_units\" and may not\nhave \"max_nodes\".\nThis change adds support for this new field, validation that the field\nis present if-and-only-if the license is enterprise and bumps the\nlicense version number to reflect the new field.", "createdAt": "2020-01-08T11:25:38Z", "url": "https://github.com/elastic/elasticsearch/pull/50735", "merged": true, "mergeCommit": {"oid": "8727f2717e0cb913097c667e55e331ab2bac8366"}, "closed": true, "closedAt": "2020-01-13T07:13:21Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4TTupAH2gAyMzYwNDEwNjE0OjcxZjAyOWFlNGJjMTA5OWI1NWYxMzVhYmUxNTk1YTk2Y2NmMTJlNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb528g5gFqTM0MTY2MTg3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "71f029ae4bc1099b55f135abe1595a96ccf12e77", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/71f029ae4bc1099b55f135abe1595a96ccf12e77", "committedDate": "2020-01-08T11:04:26Z", "message": "Add max_resource_units to enterprise license\n\nThe enterprise license type must has \"max_resource_units\" and may not\nhave \"max_nodes\".\n\nThis change adds support for this new field, validation that the field\nis present if-and-only-if the license is enterprise and bumps the\nlicense version number to reflect the new field."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bcba71ac7ddf2a0a899d22b9ac042a8d57358f4", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/0bcba71ac7ddf2a0a899d22b9ac042a8d57358f4", "committedDate": "2020-01-09T00:31:06Z", "message": "Fix compatible license versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a26ca3d4e0f8e5e9ef0cb95788c3df909070eef", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a26ca3d4e0f8e5e9ef0cb95788c3df909070eef", "committedDate": "2020-01-09T00:44:01Z", "message": "Merge branch 'master' into enterprise-license/max_resource_units"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3019233a97cc28627b980f020ac53ff34c33766b", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/3019233a97cc28627b980f020ac53ff34c33766b", "committedDate": "2020-01-09T01:47:28Z", "message": "Fix some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c03b5c1c3cb6ae97684dc38c6471ecc6fef6e68", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c03b5c1c3cb6ae97684dc38c6471ecc6fef6e68", "committedDate": "2020-01-09T07:18:14Z", "message": "Merge branch 'master' into enterprise-license/max_resource_units"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8147c820752d5d84c72055ffe7a15387e8656a0e", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/8147c820752d5d84c72055ffe7a15387e8656a0e", "committedDate": "2020-01-09T07:38:52Z", "message": "Add max_resource_units to monitoring test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a", "committedDate": "2020-01-09T07:57:52Z", "message": "Fix docs snippet"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQwMzUzOTYz", "url": "https://github.com/elastic/elasticsearch/pull/50735#pullrequestreview-340353963", "createdAt": "2020-01-09T08:31:05Z", "commit": {"oid": "1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwODozMTowNVrOFbuBqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOVQwODozMjoxMVrOFbuDJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYwOTk2MA==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException(\"maxResourceUnits must be set for enterprise licenses\");\n          \n          \n            \n                            throw new IllegalStateException(\"maxResourceUnits must be set for license type [\" + type + \"]\");", "url": "https://github.com/elastic/elasticsearch/pull/50735#discussion_r364609960", "createdAt": "2020-01-09T08:31:05Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/License.java", "diffHunk": "@@ -386,20 +407,38 @@ private void validate() {\n             throw new IllegalStateException(\"uid can not be null\");\n         } else if (feature == null && version == VERSION_START) {\n             throw new IllegalStateException(\"feature can not be null\");\n-        } else if (maxNodes == -1) {\n-            throw new IllegalStateException(\"maxNodes has to be set\");\n         } else if (expiryDate == -1) {\n             throw new IllegalStateException(\"expiryDate has to be set\");\n         } else if (expiryDate == LicenseService.BASIC_SELF_GENERATED_LICENSE_EXPIRATION_MILLIS && LicenseType.isBasic(type) == false) {\n             throw new IllegalStateException(\"only basic licenses are allowed to have no expiration\");\n         }\n+\n+        if (LicenseType.isEnterprise(type) && version < VERSION_ENTERPRISE) {\n+            throw new IllegalStateException(\"license type [\" + type + \"] is not a valid for version [\" + version + \"] licenses\");\n+        }\n+        validateLimits(type, maxNodes, maxResourceUnits);\n+    }\n+\n+    private static void validateLimits(String type, int maxNodes, int maxResourceUnits) {\n+        if (LicenseType.isEnterprise(type)) {\n+            if (maxResourceUnits == -1) {\n+                throw new IllegalStateException(\"maxResourceUnits must be set for enterprise licenses\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYxMDIxNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException(\"maxNodes may not be set for enterprise licenses\");\n          \n          \n            \n                            throw new IllegalStateException(\"maxNodes may not be set  license type [\" + type + \"]\");", "url": "https://github.com/elastic/elasticsearch/pull/50735#discussion_r364610217", "createdAt": "2020-01-09T08:31:51Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/License.java", "diffHunk": "@@ -386,20 +407,38 @@ private void validate() {\n             throw new IllegalStateException(\"uid can not be null\");\n         } else if (feature == null && version == VERSION_START) {\n             throw new IllegalStateException(\"feature can not be null\");\n-        } else if (maxNodes == -1) {\n-            throw new IllegalStateException(\"maxNodes has to be set\");\n         } else if (expiryDate == -1) {\n             throw new IllegalStateException(\"expiryDate has to be set\");\n         } else if (expiryDate == LicenseService.BASIC_SELF_GENERATED_LICENSE_EXPIRATION_MILLIS && LicenseType.isBasic(type) == false) {\n             throw new IllegalStateException(\"only basic licenses are allowed to have no expiration\");\n         }\n+\n+        if (LicenseType.isEnterprise(type) && version < VERSION_ENTERPRISE) {\n+            throw new IllegalStateException(\"license type [\" + type + \"] is not a valid for version [\" + version + \"] licenses\");\n+        }\n+        validateLimits(type, maxNodes, maxResourceUnits);\n+    }\n+\n+    private static void validateLimits(String type, int maxNodes, int maxResourceUnits) {\n+        if (LicenseType.isEnterprise(type)) {\n+            if (maxResourceUnits == -1) {\n+                throw new IllegalStateException(\"maxResourceUnits must be set for enterprise licenses\");\n+            } else if (maxNodes != -1) {\n+                throw new IllegalStateException(\"maxNodes may not be set for enterprise licenses\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDYxMDM0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            throw new IllegalStateException(\"maxResourceUnits may only be set for enterprise licenses\");\n          \n          \n            \n                            throw new IllegalStateException(\"maxResourceUnits may only be set  license type [\" + type + \"]\");", "url": "https://github.com/elastic/elasticsearch/pull/50735#discussion_r364610340", "createdAt": "2020-01-09T08:32:11Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/License.java", "diffHunk": "@@ -386,20 +407,38 @@ private void validate() {\n             throw new IllegalStateException(\"uid can not be null\");\n         } else if (feature == null && version == VERSION_START) {\n             throw new IllegalStateException(\"feature can not be null\");\n-        } else if (maxNodes == -1) {\n-            throw new IllegalStateException(\"maxNodes has to be set\");\n         } else if (expiryDate == -1) {\n             throw new IllegalStateException(\"expiryDate has to be set\");\n         } else if (expiryDate == LicenseService.BASIC_SELF_GENERATED_LICENSE_EXPIRATION_MILLIS && LicenseType.isBasic(type) == false) {\n             throw new IllegalStateException(\"only basic licenses are allowed to have no expiration\");\n         }\n+\n+        if (LicenseType.isEnterprise(type) && version < VERSION_ENTERPRISE) {\n+            throw new IllegalStateException(\"license type [\" + type + \"] is not a valid for version [\" + version + \"] licenses\");\n+        }\n+        validateLimits(type, maxNodes, maxResourceUnits);\n+    }\n+\n+    private static void validateLimits(String type, int maxNodes, int maxResourceUnits) {\n+        if (LicenseType.isEnterprise(type)) {\n+            if (maxResourceUnits == -1) {\n+                throw new IllegalStateException(\"maxResourceUnits must be set for enterprise licenses\");\n+            } else if (maxNodes != -1) {\n+                throw new IllegalStateException(\"maxNodes may not be set for enterprise licenses\");\n+            }\n+        } else {\n+            if (maxNodes == -1) {\n+                throw new IllegalStateException(\"maxNodes has to be set\");\n+            } else if (maxResourceUnits != -1) {\n+                throw new IllegalStateException(\"maxResourceUnits may only be set for enterprise licenses\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cfc6305bb2fc5ba9b26ab4b63c7bd83f5f09c1a"}, "originalPosition": 134}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "736057ac7dad86aff988562080b2df6de3ef2ab8", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/736057ac7dad86aff988562080b2df6de3ef2ab8", "committedDate": "2020-01-13T02:59:57Z", "message": "Update Rest tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c54d6372cd0aa7b74a71941398b1e448042e3d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3c54d6372cd0aa7b74a71941398b1e448042e3d", "committedDate": "2020-01-13T03:00:11Z", "message": "Merge branch 'master' into enterprise-license/max_resource_units"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7e537dc03677d8e4c2ba62a9799c3c1fd216602", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7e537dc03677d8e4c2ba62a9799c3c1fd216602", "committedDate": "2020-01-13T03:47:52Z", "message": "Fix self generated (trial) enterprise licenses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a02c11de1747fd6c3d6582239ef92862734215b6", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/a02c11de1747fd6c3d6582239ef92862734215b6", "committedDate": "2020-01-13T03:51:23Z", "message": "Fix another broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbfe58c749696b0eb54d7ade84f9eaf7627e533d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbfe58c749696b0eb54d7ade84f9eaf7627e533d", "committedDate": "2020-01-13T05:28:14Z", "message": "Update validation messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNjYxODc4", "url": "https://github.com/elastic/elasticsearch/pull/50735#pullrequestreview-341661878", "createdAt": "2020-01-13T07:09:35Z", "commit": {"oid": "fbfe58c749696b0eb54d7ade84f9eaf7627e533d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3914, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}