{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NzAzMDE5", "number": 52483, "title": "[Transform] add support for filter aggregation", "bodyText": "add support for filter aggregations, refactor code for sub-aggregation support in mapping deduction\nfixes #52151\nNote: Dear reviewer, please start with 78b63e3", "createdAt": "2020-02-18T16:06:44Z", "url": "https://github.com/elastic/elasticsearch/pull/52483", "merged": true, "mergeCommit": {"oid": "075fee249c983aeeb08bdbae1ecd044c314c9bf5"}, "closed": true, "closedAt": "2020-02-21T12:06:19Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFk7hbAFqTM2MDQ5OTQwMw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGdpWBABqjMwNjAwOTU3MzQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwNDk5NDAz", "url": "https://github.com/elastic/elasticsearch/pull/52483#pullrequestreview-360499403", "createdAt": "2020-02-18T16:45:39Z", "commit": {"oid": "78b63e334cd3c10cfcf3b399048cd453d22734ef"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo0NTozOVrOFrKC9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQxNjo1MTozNFrOFrKRZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NzY4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            nested.put(subAgg.getName(), getExtractor(subAgg).value(subAgg, fieldTypeMap.get(agg.getName()), fieldTypeMap));\n          \n          \n            \n                            nested.put(subAgg.getName(), getExtractor(subAgg).value(subAgg, fieldTypeMap.get(subAgg.getName()), fieldTypeMap));\n          \n      \n    \n    \n  \n\nWe should use the subAgg field type no? If we just used the parent agg's type, we could pass fieldType", "url": "https://github.com/elastic/elasticsearch/pull/52483#discussion_r380797686", "createdAt": "2020-02-18T16:45:39Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -211,17 +215,35 @@ public Object value(Aggregation agg, String fieldType) {\n         }\n     }\n \n+    static class SingleBucketAggExtractor implements AggValueExtractor {\n+        @Override\n+        public Object value(Aggregation agg, String fieldType, Map<String, String> fieldTypeMap) {\n+            SingleBucketAggregation aggregation = (SingleBucketAggregation) agg;\n+\n+            if (aggregation.getAggregations().iterator().hasNext() == false) {\n+                return aggregation.getDocCount();\n+            }\n+\n+            HashMap<String, Object> nested = new HashMap<>();\n+            for (Aggregation subAgg : aggregation.getAggregations()) {\n+                nested.put(subAgg.getName(), getExtractor(subAgg).value(subAgg, fieldTypeMap.get(agg.getName()), fieldTypeMap));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "78b63e334cd3c10cfcf3b399048cd453d22734ef"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDgwMTM4Mg==", "bodyText": "\ud83e\udd14\nDoes this actually work? It seems like we should recursively supply the String fieldName or something and then read that from fieldTypeMap.\nThat way we can continually append the field name.\nSomething like\nnested.put(subAgg.getName(), getExtractor(subAgg).value(subAgg, fieldName + \".\" + subAgg.getName(), fieldTypeMap));\n\nAnd those that worry about fieldType can get it from the fieldTypeMap", "url": "https://github.com/elastic/elasticsearch/pull/52483#discussion_r380801382", "createdAt": "2020-02-18T16:51:34Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -211,17 +215,35 @@ public Object value(Aggregation agg, String fieldType) {\n         }\n     }\n \n+    static class SingleBucketAggExtractor implements AggValueExtractor {\n+        @Override\n+        public Object value(Aggregation agg, String fieldType, Map<String, String> fieldTypeMap) {\n+            SingleBucketAggregation aggregation = (SingleBucketAggregation) agg;\n+\n+            if (aggregation.getAggregations().iterator().hasNext() == false) {\n+                return aggregation.getDocCount();\n+            }\n+\n+            HashMap<String, Object> nested = new HashMap<>();\n+            for (Aggregation subAgg : aggregation.getAggregations()) {\n+                nested.put(subAgg.getName(), getExtractor(subAgg).value(subAgg, fieldTypeMap.get(agg.getName()), fieldTypeMap));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDc5NzY4Ng=="}, "originalCommit": {"oid": "78b63e334cd3c10cfcf3b399048cd453d22734ef"}, "originalPosition": 73}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "78b63e334cd3c10cfcf3b399048cd453d22734ef", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/78b63e334cd3c10cfcf3b399048cd453d22734ef", "committedDate": "2020-02-18T16:05:17Z", "message": "add support for filter aggregations, refactor code for sub-aggregation support"}, "afterCommit": {"oid": "68aeabeee2042fbd28358c59500a88b12a332b33", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/68aeabeee2042fbd28358c59500a88b12a332b33", "committedDate": "2020-02-20T13:24:06Z", "message": "fix recursive field mapping lookup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMDA4NjE5", "url": "https://github.com/elastic/elasticsearch/pull/52483#pullrequestreview-362008619", "createdAt": "2020-02-20T15:42:02Z", "commit": {"oid": "d3279744e53c6a532ee6c23c710a7dd0ab8c665b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTo0MjowMlrOFsYdwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxNTo0MjowMlrOFsYdwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjA4MjQ5Nw==", "bodyText": "It strikes me that supplying fieldType is no longer necessary.\nAnything that desires to know fieldType could look it up via its own agg name combined with the prefix (if not empty).", "url": "https://github.com/elastic/elasticsearch/pull/52483#discussion_r382082497", "createdAt": "2020-02-20T15:42:02Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -211,17 +215,44 @@ public Object value(Aggregation agg, String fieldType) {\n         }\n     }\n \n+    static class SingleBucketAggExtractor implements AggValueExtractor {\n+        @Override\n+        public Object value(Aggregation agg, String fieldType, Map<String, String> fieldTypeMap, String lookupFieldPrefix) {\n+            SingleBucketAggregation aggregation = (SingleBucketAggregation) agg;\n+\n+            if (aggregation.getAggregations().iterator().hasNext() == false) {\n+                return aggregation.getDocCount();\n+            }\n+\n+            HashMap<String, Object> nested = new HashMap<>();\n+            for (Aggregation subAgg : aggregation.getAggregations()) {\n+                String subLookupFieldPrefix = lookupFieldPrefix.isEmpty() ? agg.getName() : lookupFieldPrefix + \".\" + agg.getName();\n+                nested.put(\n+                    subAgg.getName(),\n+                    getExtractor(subAgg).value(\n+                        subAgg,\n+                        fieldTypeMap.get(subLookupFieldPrefix + \".\" + subAgg.getName()),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3279744e53c6a532ee6c23c710a7dd0ab8c665b"}, "originalPosition": 78}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcc10aac70190c58aa0f3ea44e5f17b7a0927d6e", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcc10aac70190c58aa0f3ea44e5f17b7a0927d6e", "committedDate": "2020-02-21T11:01:52Z", "message": "code formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe11de0f6b7a911e35cc01c5348d3f808fffe3cc", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe11de0f6b7a911e35cc01c5348d3f808fffe3cc", "committedDate": "2020-02-21T11:01:52Z", "message": "add support for filter aggregations, refactor code for sub-aggregation support"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfdc1540620bef523af474b5c0b301f57d9dcac0", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfdc1540620bef523af474b5c0b301f57d9dcac0", "committedDate": "2020-02-21T11:01:52Z", "message": "add a combined test for mapping deduction and extraction"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46485a95a9030607aa02e08cdd61c1bea080e6e6", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/46485a95a9030607aa02e08cdd61c1bea080e6e6", "committedDate": "2020-02-21T11:01:52Z", "message": "fix recursive field mapping lookup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb457bc2825d3671a681960299f5872f8244a95e", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb457bc2825d3671a681960299f5872f8244a95e", "committedDate": "2020-02-21T11:01:52Z", "message": "fix recursive type lookup in unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dddfe05d82b9ac56dabb244b97c23b3d5c05dace", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/dddfe05d82b9ac56dabb244b97c23b3d5c05dace", "committedDate": "2020-02-21T11:01:52Z", "message": "checkstyle fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8d6d00bdd94c9a2982529a5729f84b78146474", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d8d6d00bdd94c9a2982529a5729f84b78146474", "committedDate": "2020-02-21T11:01:52Z", "message": "simplify field type lookup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8f444d7355e6f2787b2af883f74272500e5b0b7d", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f444d7355e6f2787b2af883f74272500e5b0b7d", "committedDate": "2020-02-21T08:17:11Z", "message": "simplify field type lookup"}, "afterCommit": {"oid": "0d8d6d00bdd94c9a2982529a5729f84b78146474", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d8d6d00bdd94c9a2982529a5729f84b78146474", "committedDate": "2020-02-21T11:01:52Z", "message": "simplify field type lookup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2386, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}