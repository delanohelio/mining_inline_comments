{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MDkwNTY1", "number": 60827, "title": "Simplify Compressible Stream Handling", "bodyText": "Two things that can be simplified here:\n\nInstantiating a CompressibleBytesOutputStream when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\nThe fact that the compressible stream closes the stream that it wraps is a problem\nin a few spots that we then have to hack around by disabling close whenever close isn't a noop\non the wrapped stream => changed behavior here to save some more wrapping and complication.", "createdAt": "2020-08-06T15:12:14Z", "url": "https://github.com/elastic/elasticsearch/pull/60827", "merged": true, "mergeCommit": {"oid": "10000f6a18adca9ff76e16f439fb91c76d0e0422"}, "closed": true, "closedAt": "2021-04-29T10:06:06Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8RVDNgH2gAyNDY0MDkwNTY1OmRhYmQ1YWU5MTgwYWRlZTI5OWQ2YTg1ZWFkMmZkZWVjMzUxYTQzODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABeRzn4MgFqTY0Nzk4MDA5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dabd5ae9180adee299d6a85ead2fdeec351a4384", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/dabd5ae9180adee299d6a85ead2fdeec351a4384", "committedDate": "2020-08-06T15:12:55Z", "message": "Simplify Compressible Stream Handling\n\nTwo things that can be simplified here:\n1. Instantiating a `CompressibleBytesOutputStream` when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\n2. The fact that the compressible stream closes the stream that it wraps is never used productively\nand we had to hack around it by wrapping the stream to disable close\n=> changed behavior here to save some more wrapping and complication."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fe195b624795febaaa4720a87e5b753493caadb8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe195b624795febaaa4720a87e5b753493caadb8", "committedDate": "2020-08-06T15:01:59Z", "message": "Simplify Compressible Stream Handling\n\nTwo things that can be simplified here:\n1. Instantiating a `CompressibleBytesOutputStream` when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\n2. The fact that the compressible stream closes the stream that it wraps is never used productively\nand we had to hack around it by wrapping the stream to disable close\n=> changed behavior here to save some more wrapping and complication."}, "afterCommit": {"oid": "dabd5ae9180adee299d6a85ead2fdeec351a4384", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/dabd5ae9180adee299d6a85ead2fdeec351a4384", "committedDate": "2020-08-06T15:12:55Z", "message": "Simplify Compressible Stream Handling\n\nTwo things that can be simplified here:\n1. Instantiating a `CompressibleBytesOutputStream` when not doing any compression\njust needlessly wastes a few objects and adds indirection. When doing compression\nit does not really simplify the code by much if at all.\n=> removing it to save some cycles on the IO threads\n2. The fact that the compressible stream closes the stream that it wraps is never used productively\nand we had to hack around it by wrapping the stream to disable close\n=> changed behavior here to save some more wrapping and complication."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8e070d0688df113b95f893176efaa33e912f56d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8e070d0688df113b95f893176efaa33e912f56d", "committedDate": "2020-08-06T18:21:03Z", "message": "Merge remote-tracking branch 'elastic/master' into get-rid-of-redundant-stream-wrap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7165bf94e92753b382fb7a20cef992d35ac4abd5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7165bf94e92753b382fb7a20cef992d35ac4abd5", "committedDate": "2021-04-29T06:21:51Z", "message": "Merge remote-tracking branch 'elastic/master' into get-rid-of-redundant-stream-wrap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92896025b9d234031d52a36fc9297a7dfe2a0cb9", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/92896025b9d234031d52a36fc9297a7dfe2a0cb9", "committedDate": "2021-04-29T06:43:58Z", "message": "fix merge issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NjQ3OTgwMDk0", "url": "https://github.com/elastic/elasticsearch/pull/60827#pullrequestreview-647980094", "createdAt": "2021-04-29T09:13:02Z", "commit": {"oid": "92896025b9d234031d52a36fc9297a7dfe2a0cb9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yOVQwOToxMzowMlrOJSBElA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wNC0yOVQwOToxMzowMlrOJSBElA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDYyMjg3MTcwMA==", "bodyText": "For the record, InboundDecoderTests#testCompressedDecode and friends are enough to cover this code now. We rarely() enable compression in internal cluster tests but apparently never in real cluster tests, maybe we should?", "url": "https://github.com/elastic/elasticsearch/pull/60827#discussion_r622871700", "createdAt": "2021-04-29T09:13:02Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/CompressibleBytesOutputStreamTests.java", "diffHunk": "@@ -1,114 +0,0 @@\n-/*\n- * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n- * or more contributor license agreements. Licensed under the Elastic License\n- * 2.0 and the Server Side Public License, v 1; you may not use this file except\n- * in compliance with, at your election, the Elastic License 2.0 or the Server\n- * Side Public License, v 1.\n- */\n-\n-package org.elasticsearch.transport;\n-\n-import org.elasticsearch.common.bytes.BytesReference;\n-import org.elasticsearch.common.compress.CompressorFactory;\n-import org.elasticsearch.common.io.stream.BytesStream;\n-import org.elasticsearch.common.io.stream.BytesStreamOutput;\n-import org.elasticsearch.common.io.stream.InputStreamStreamInput;\n-import org.elasticsearch.common.io.stream.StreamInput;\n-import org.elasticsearch.test.ESTestCase;\n-\n-import java.io.EOFException;\n-import java.io.IOException;\n-\n-public class CompressibleBytesOutputStreamTests extends ESTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92896025b9d234031d52a36fc9297a7dfe2a0cb9"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3438, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}