{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwODYyODk2", "number": 51866, "title": "Add stats for time spent fetching data while searching snapshots", "bodyText": "This commit builds on #51637, adding tracking of the total time spent fetching\ndata from the blob store.\nRelates #50999.", "createdAt": "2020-02-04T14:19:31Z", "url": "https://github.com/elastic/elasticsearch/pull/51866", "merged": true, "mergeCommit": {"oid": "c9ac57fb9e8559333fcef9e29350ae1aed8ddeab"}, "closed": true, "closedAt": "2020-02-24T15:21:20Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBCOKQgH2gAyMzcwODYyODk2OjQ4ZTJkMWFmMDA5ZThlODRiNWYzOGU3MDBjYjczNjQzNWZlNTJmOTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHd-UWAFqTM2MzQwNjI0Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48e2d1af009e8e84b5f38e700cb736435fe52f96", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/48e2d1af009e8e84b5f38e700cb736435fe52f96", "committedDate": "2020-02-04T14:15:17Z", "message": "Add stats for fetch speed as a function of size\n\nThis commit builds on #51637, adding tracking of the total time spent fetching\ndata from the blob store and a linear regression model for these fetches."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5870d96fc3eb360fab738af58758305689bf8233", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/5870d96fc3eb360fab738af58758305689bf8233", "committedDate": "2020-02-24T10:16:33Z", "message": "Merge branch 'feature/searchable-snapshots' into 2020-02-04-searchable-snapshots-track-time-spent-fetching-from-blob-store"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "906a39e8430d7fd057bf96254f951e64702123d2", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/906a39e8430d7fd057bf96254f951e64702123d2", "committedDate": "2020-02-24T10:30:35Z", "message": "Remove linear model"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86e4b97632b25d23b1a25c735cedba420b6a36bb", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/86e4b97632b25d23b1a25c735cedba420b6a36bb", "committedDate": "2020-02-24T10:52:17Z", "message": "Rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7db2ef7af73136035621d10bd6fb141ddf88c80", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7db2ef7af73136035621d10bd6fb141ddf88c80", "committedDate": "2020-02-24T10:53:29Z", "message": "Use System::nanoTime since threadpool's time is too coarse"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbc18a78a26fe86b903814534bd604bab9c3f58f", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbc18a78a26fe86b903814534bd604bab9c3f58f", "committedDate": "2020-02-24T10:55:03Z", "message": "Unnecessary test case"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2246193c61941acab537fc22989105a1ccebe41", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2246193c61941acab537fc22989105a1ccebe41", "committedDate": "2020-02-24T10:57:57Z", "message": "inline test utilities"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4c2a5d17160d7b753351bcf468520dba232d01c", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4c2a5d17160d7b753351bcf468520dba232d01c", "committedDate": "2020-02-24T10:59:15Z", "message": "Tidy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e634b7890fb5276e2c30d816793359104ffa9295", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/e634b7890fb5276e2c30d816793359104ffa9295", "committedDate": "2020-02-24T11:59:10Z", "message": "Add stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95a86e707e034cdfd38df1825bcc2631b8fddfc9", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/95a86e707e034cdfd38df1825bcc2631b8fddfc9", "committedDate": "2020-02-24T12:05:21Z", "message": "Whitespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzQxMzg3", "url": "https://github.com/elastic/elasticsearch/pull/51866#pullrequestreview-363341387", "createdAt": "2020-02-24T12:03:50Z", "commit": {"oid": "e634b7890fb5276e2c30d816793359104ffa9295"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjowMzo1MVrOFteU8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMjowMzo1MVrOFteU8A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzIyNzEyMA==", "bodyText": "Using System::nanoTime since we need finer resolution than ThreadPool::relativeTimeInNanos offers.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383227120", "createdAt": "2020-02-24T12:03:51Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java", "diffHunk": "@@ -106,7 +106,7 @@ public void onRepositoriesModule(RepositoriesModule repositoriesModule) {\n     @Override\n     public Map<String, DirectoryFactory> getDirectoryFactories() {\n         return Map.of(SearchableSnapshotRepository.SNAPSHOT_DIRECTORY_FACTORY_KEY,\n-            SearchableSnapshotRepository.newDirectoryFactory(repositoriesService::get, cacheService::get));\n+            SearchableSnapshotRepository.newDirectoryFactory(repositoriesService::get, cacheService::get, System::nanoTime));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e634b7890fb5276e2c30d816793359104ffa9295"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/8edbdf64482ce0c415ab8d47779bbedc722c57a5", "committedDate": "2020-02-24T12:20:00Z", "message": "ZLong"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzcyOTIw", "url": "https://github.com/elastic/elasticsearch/pull/51866#pullrequestreview-363372920", "createdAt": "2020-02-24T13:04:43Z", "commit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzowNDo0M1rOFtf3ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoxMzoyOFrOFtgIig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1MjQxOQ==", "bodyText": "builder.timeField(String, String, long) does not produce what we want here?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383252419", "createdAt": "2020-02-24T13:04:43Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            builder.startObject();\n+            {\n+                builder.field(\"count\", getCount());\n+                builder.field(\"sum\", getTotal());\n+                builder.field(\"min\", getMin());\n+                builder.field(\"max\", getMax());\n+                builder.field(\"time\", TimeValue.timeValueNanos(totalNanoseconds));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1Mjk4Mw==", "bodyText": "I'm wondering if we should check that it's greater than 0?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383252983", "createdAt": "2020-02-24T13:06:01Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/qa/rest/src/test/resources/rest-api-spec/test/stats.yml", "diffHunk": "@@ -167,11 +167,15 @@ teardown:\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.sum: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.min: 0 }\n   - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.max: 0 }\n+  - gte:     { indices.docs.shards.0.0.files.0.cached_bytes_written.time_in_nanos: 0 }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NDk5Ng==", "bodyText": "Interestingly, this captures the start time after the initial blob read request has been made. I'm wondering if we should capture it before the openInput() which sends the underlying S3 request and update the stats in a finally block?", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383254996", "createdAt": "2020-02-24T13:10:34Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "diffHunk": "@@ -274,6 +278,7 @@ void writeCacheFile(FileChannel fc, long start, long end) throws IOException {\n             int bytesCopied = 0;\n             try (IndexInput input = in.openInput(cacheFileReference.getFileName(), ioContext)) {\n                 stats.incrementInnerOpenCount();\n+                final long startTimeNanos = currentTimeNanosSupplier.getAsLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI1NjcxNA==", "bodyText": "Maybe define an empty innerToXContent(XContentBuilder, Params) to the Counter class and overrides it here to only add the time field? That's what we do for other XContent implementations.", "url": "https://github.com/elastic/elasticsearch/pull/51866#discussion_r383256714", "createdAt": "2020-02-24T13:13:28Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -395,4 +396,55 @@ public int hashCode() {\n             return Objects.hash(count, total, min, max);\n         }\n     }\n+\n+    public static class TimedCounter extends Counter {\n+\n+        private final long totalNanoseconds;\n+\n+        public TimedCounter(long count, long total, long min, long max, long totalNanoseconds) {\n+            super(count, total, min, max);\n+            this.totalNanoseconds = totalNanoseconds;\n+        }\n+\n+        TimedCounter(StreamInput in) throws IOException {\n+            super(in);\n+            totalNanoseconds = in.readZLong();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            out.writeZLong(totalNanoseconds);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8edbdf64482ce0c415ab8d47779bbedc722c57a5"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b26f66ad3bd54d4f2c43febaf6be448ca0d4b5f", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b26f66ad3bd54d4f2c43febaf6be448ca0d4b5f", "committedDate": "2020-02-24T13:43:18Z", "message": "Neater subclassing and human-only output"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNDA2MjQ2", "url": "https://github.com/elastic/elasticsearch/pull/51866#pullrequestreview-363406246", "createdAt": "2020-02-24T13:58:52Z", "commit": {"oid": "5b26f66ad3bd54d4f2c43febaf6be448ca0d4b5f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3010, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}