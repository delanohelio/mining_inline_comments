{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MjQxNTM1", "number": 56533, "title": "Improve cardinality measure used to build aggs", "bodyText": "This makes a parentCardinality available to every Aggregator's ctor\nso it can make intelligent choices about how it collects bucket values.\nThis replaces collectsFromSingleBucket and is similar to it but:\n\nIt supports NONE, ONE, and MANY values and is generally\nextensible if we decide we can use more precise counts.\nIt is more accurate. collectsFromSingleBucket assumed that all\nsub-aggregations live under multi-bucket aggregations. This is\nnormally true but parentCardinality is properly carried forward\nfor single bucket aggregations like filter and for multi-bucket\naggregations configured in single-bucket for like range with a\nsingle range.\n\nRelates to #56487\nEdit: I used to have this in the description:\n\nWhile I was touching every aggregation I renamed doCreateInternal to\ncreateMapped because that seemed like a much better name and it was\nright there, next to the change I was already making.\n\nBut it is no longer accurate.", "createdAt": "2020-05-11T17:30:30Z", "url": "https://github.com/elastic/elasticsearch/pull/56533", "merged": true, "mergeCommit": {"oid": "ea5df51b910bbfe41c914b12bfa1854648262573"}, "closed": true, "closedAt": "2020-07-06T22:31:09Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgTHIvgH2gAyNDE2MjQxNTM1OjJhNDZjMzI2N2U1Zjk0YTU0ZDUwY2E3MzE0M2M0MmY2ZDk2YWQxMDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyWZM4AH2gAyNDE2MjQxNTM1OmYyZWI4N2I4MTc4YWMxYzZjNTc0YTgxNmU1NzA0MTg3MmEzNzA0ZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2a46c3267e5f94a54d50ca73143c42f6d96ad100", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a46c3267e5f94a54d50ca73143c42f6d96ad100", "committedDate": "2020-05-11T17:27:39Z", "message": "Improve cardinality measure used to build aggs\n\nThis makes a `parentCardinality` available to every `Aggregator`'s ctor\nso it can make intelligent choices about how it collects bucket values.\nThis replaces `collectsFromSingleBucket` and is similar to it but:\n1. It supports `NONE`, `ONE`, and `MANY` values and is generally\n   extensible if we decide we can use more precise counts.\n2. It is more accurate. `collectsFromSingleBucket` assumed that all\n   sub-aggregations live under multi-bucket aggregations. This is\n   normally true but `parentCardinality` is properly carried forward\n   for single bucket aggregations like `filter` and for multi-bucket\n   aggregations configured in single-bucket for like `range` with a\n   single range.\n\nWhile I was touching every aggregation I renamed `doCreateInternal` to\n`createMapped` because that seemed like a much better name and it was\nright there, next to the change I was already making.\n\nRelates to #56487"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTgwNzE1", "url": "https://github.com/elastic/elasticsearch/pull/56533#pullrequestreview-409580715", "createdAt": "2020-05-11T22:40:09Z", "commit": {"oid": "2a46c3267e5f94a54d50ca73143c42f6d96ad100"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0MDowOVrOGTv39w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjo0MDowOVrOGTv39w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM2MDUwMw==", "bodyText": "A better name for this might be CardinalityEstimate or CardinalityUpperBound.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r423360503", "createdAt": "2020-05-11T22:40:09Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/TotalBucketCardinality.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations;\n+\n+import org.elasticsearch.search.aggregations.bucket.BucketsAggregator;\n+import org.elasticsearch.search.aggregations.metrics.MetricsAggregator;\n+\n+/**\n+ * Rough measure of how many buckets this {@link Aggregator} will collect\n+ * used to pick data structures used during collection. Just \"none\", \"one\",\n+ * and \"many\".\n+ * <p>\n+ * Unlike {@link AggregationBuilder.BucketCardinality} this is influenced\n+ * by the number of buckets that the parent aggregation collect.\n+ */\n+public enum TotalBucketCardinality {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a46c3267e5f94a54d50ca73143c42f6d96ad100"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMDc3ODc3", "url": "https://github.com/elastic/elasticsearch/pull/56533#pullrequestreview-410077877", "createdAt": "2020-05-12T14:06:12Z", "commit": {"oid": "2a46c3267e5f94a54d50ca73143c42f6d96ad100"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDowNjoxM1rOGUIWvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxNDowNjoxM1rOGUIWvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzc2MTU5Nw==", "bodyText": "This should return NONE if passed 0.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r423761597", "createdAt": "2020-05-12T14:06:13Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/TotalBucketCardinality.java", "diffHunk": "@@ -0,0 +1,84 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.search.aggregations;\n+\n+import org.elasticsearch.search.aggregations.bucket.BucketsAggregator;\n+import org.elasticsearch.search.aggregations.metrics.MetricsAggregator;\n+\n+/**\n+ * Rough measure of how many buckets this {@link Aggregator} will collect\n+ * used to pick data structures used during collection. Just \"none\", \"one\",\n+ * and \"many\".\n+ * <p>\n+ * Unlike {@link AggregationBuilder.BucketCardinality} this is influenced\n+ * by the number of buckets that the parent aggregation collect.\n+ */\n+public enum TotalBucketCardinality {\n+    /**\n+     * {@link Aggregator}s with this cardinality won't collect any buckets.\n+     * This could be because they are {@link MetricsAggregator}s which don't\n+     * support buckets at all. Or they could be {@link BucketsAggregator}\n+     * that are configured in such a way that they collect any buckets. \n+     */\n+    NONE {\n+        @Override\n+        public TotalBucketCardinality forKnownBucketAggregator(int bucketCount) {\n+            return NONE;\n+        }\n+    },\n+\n+    /**\n+     * {@link Aggregator}s with this cardinality will collect only a single\n+     * bucket. This will only be true for top level {@linkplain Aggregator}s\n+     * and for descendants of aggregation\n+     */\n+    ONE {\n+        @Override\n+        public TotalBucketCardinality forKnownBucketAggregator(int bucketCount) {\n+            switch (bucketCount) {\n+                case 0:\n+                    return NONE;\n+                case 1:\n+                    return ONE;\n+                default:\n+                    return MANY;\n+            }\n+        }\n+    },\n+    /**\n+     * {@link Aggregator}s with this cardinality will collect many buckets.\n+     * Most {@link BucketsAggregator}s will have this cardinality.\n+     */\n+    MANY {\n+        @Override\n+        public TotalBucketCardinality forKnownBucketAggregator(int bucketCount) {\n+            return MANY;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2a46c3267e5f94a54d50ca73143c42f6d96ad100"}, "originalPosition": 72}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e75f414fbdadb2621ec218f9a144d8039f8756e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e75f414fbdadb2621ec218f9a144d8039f8756e", "committedDate": "2020-05-13T18:40:52Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b1ebd2ff1a1f5685757841cdc2f8a2683f450a9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b1ebd2ff1a1f5685757841cdc2f8a2683f450a9", "committedDate": "2020-05-13T19:20:12Z", "message": "Rework"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ddfe6ef9ed2dd840081b30b659a6d45a6275f7da", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/ddfe6ef9ed2dd840081b30b659a6d45a6275f7da", "committedDate": "2020-05-13T19:32:23Z", "message": "Rename multiply"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "022e31c92d9b77fe4d7911aa4bd59f4f5c4f31a6", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/022e31c92d9b77fe4d7911aa4bd59f4f5c4f31a6", "committedDate": "2020-05-13T19:39:56Z", "message": "Rename test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31375fbac72bf651a54ab8fb49eafa9f722671ac", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/31375fbac72bf651a54ab8fb49eafa9f722671ac", "committedDate": "2020-05-13T20:14:38Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMjU3MDg1", "url": "https://github.com/elastic/elasticsearch/pull/56533#pullrequestreview-411257085", "createdAt": "2020-05-13T20:02:27Z", "commit": {"oid": "ddfe6ef9ed2dd840081b30b659a6d45a6275f7da"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDowMjoyN1rOGVBgVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QyMDoxMDo0MVrOGVBxdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5Nzk0Mg==", "bodyText": "This isn't accurate.  If the user specified a script, we might not have a mapped field at this point.  Or for that matter, if we couldn't map a field but the user provided a missing value.  It would be accurate to say we are creating the aggregator for a non-empty values source.\nIn fact, a large point of the values source abstraction is to not have to know at this point if we have a mapped field or not.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r424697942", "createdAt": "2020-05-13T20:02:27Z", "author": {"login": "not-napoleon"}, "path": "modules/aggs-matrix-stats/src/main/java/org/elasticsearch/search/aggregations/support/ArrayValuesSourceAggregatorFactory.java", "diffHunk": "@@ -58,17 +59,27 @@ public Aggregator createInternal(SearchContext searchContext,\n         if (valuesSources.isEmpty()) {\n             return createUnmapped(searchContext, parent, metadata);\n         }\n-        return doCreateInternal(valuesSources, searchContext, parent, collectsFromSingleBucket, metadata);\n+        return doCreateInternal(valuesSources, searchContext, parent, cardinality, metadata);\n     }\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a field that isn't mapped.\n+     */\n     protected abstract Aggregator createUnmapped(SearchContext searchContext,\n                                                     Aggregator parent,\n                                                     Map<String, Object> metadata) throws IOException;\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a mapped field.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddfe6ef9ed2dd840081b30b659a6d45a6275f7da"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDY5ODQ3NA==", "bodyText": "As noted on doCreateInternal, it's more accurate to say this is used when we have no values.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r424698474", "createdAt": "2020-05-13T20:03:29Z", "author": {"login": "not-napoleon"}, "path": "modules/aggs-matrix-stats/src/main/java/org/elasticsearch/search/aggregations/support/ArrayValuesSourceAggregatorFactory.java", "diffHunk": "@@ -58,17 +59,27 @@ public Aggregator createInternal(SearchContext searchContext,\n         if (valuesSources.isEmpty()) {\n             return createUnmapped(searchContext, parent, metadata);\n         }\n-        return doCreateInternal(valuesSources, searchContext, parent, collectsFromSingleBucket, metadata);\n+        return doCreateInternal(valuesSources, searchContext, parent, cardinality, metadata);\n     }\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a field that isn't mapped.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddfe6ef9ed2dd840081b30b659a6d45a6275f7da"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDcwMjMyNg==", "bodyText": "+1 for dropping this comment.  3 lines to say nothing the type declaration didn't.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r424702326", "createdAt": "2020-05-13T20:10:41Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorFactory.java", "diffHunk": "@@ -226,28 +226,20 @@ public void doValidate() {\n \n     protected abstract Aggregator createInternal(SearchContext searchContext,\n                                                     Aggregator parent,\n-                                                    boolean collectsFromSingleBucket,\n+                                                    CardinalityUpperBound cardinality,\n                                                     Map<String, Object> metadata) throws IOException;\n \n     /**\n-     * Creates the aggregator\n+     * Creates the aggregator.\n      *\n-     *\n-     * @param searchContext\n-     *            The search context", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ddfe6ef9ed2dd840081b30b659a6d45a6275f7da"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d4d742336857ea6051157417c0855e669bdf6b1", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d4d742336857ea6051157417c0855e669bdf6b1", "committedDate": "2020-05-13T20:17:44Z", "message": "license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae792250ad9cd8642509c839d01f39f2d1d564e2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae792250ad9cd8642509c839d01f39f2d1d564e2", "committedDate": "2020-05-13T20:29:32Z", "message": "Different comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fd02bd2fb442d7ed96a5042ba5819dcb540cee7", "committedDate": "2020-05-18T20:02:36Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1NTY1NTgz", "url": "https://github.com/elastic/elasticsearch/pull/56533#pullrequestreview-425565583", "createdAt": "2020-06-05T19:25:31Z", "commit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOToyNTozMVrOGf6q0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxOTo0NjozMFrOGf7Mcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyMDI3NA==", "bodyText": "nit: I know it was like this when you found it, but since you're touching this anyway, maybe add a message to the exception?", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r436120274", "createdAt": "2020-06-05T19:25:31Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/global/GlobalAggregatorFactory.java", "diffHunk": "@@ -42,13 +43,13 @@ public GlobalAggregatorFactory(String name,\n     @Override\n     public Aggregator createInternal(SearchContext searchContext,\n                                         Aggregator parent,\n-                                        boolean collectsFromSingleBucket,\n+                                        CardinalityUpperBound cardinality,\n                                         Map<String, Object> metadata) throws IOException {\n         if (parent != null) {\n             throw new AggregationExecutionException(\"Aggregation [\" + parent.name() + \"] cannot have a global \" + \"sub-aggregation [\" + name\n                     + \"]. Global aggregations can only be defined as top level aggregations\");\n         }\n-        if (collectsFromSingleBucket == false) {\n+        if (cardinality != CardinalityUpperBound.ONE) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyNjIxNg==", "bodyText": "Why is this always ONE?", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r436126216", "createdAt": "2020-06-05T19:39:54Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantLongTermsAggregator.java", "diffHunk": "@@ -47,7 +48,7 @@ public SignificantLongTermsAggregator(String name, AggregatorFactories factories\n             IncludeExclude.LongFilter includeExclude, Map<String, Object> metadata) throws IOException {\n \n         super(name, factories, valuesSource, format, null, bucketCountThresholds, context, parent,\n-                SubAggCollectionMode.BREADTH_FIRST, false, includeExclude, false, metadata);\n+                SubAggCollectionMode.BREADTH_FIRST, false, includeExclude, CardinalityUpperBound.ONE, metadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyODM5OA==", "bodyText": "I liked your comment for this method on MultiValuesSourceAggregationBuilder better.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r436128398", "createdAt": "2020-06-05T19:45:22Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregatorFactory.java", "diffHunk": "@@ -40,23 +41,35 @@ public ValuesSourceAggregatorFactory(String name, ValuesSourceConfig config, Que\n     }\n \n     @Override\n-    public Aggregator createInternal(SearchContext searchContext, Aggregator parent, boolean collectsFromSingleBucket,\n+    public Aggregator createInternal(SearchContext searchContext, Aggregator parent, CardinalityUpperBound cardinality,\n                                      Map<String, Object> metadata) throws IOException {\n         ValuesSource vs = config.toValuesSource();\n         if (vs == null) {\n             return createUnmapped(searchContext, parent, metadata);\n         }\n-        return doCreateInternal(vs, searchContext, parent, collectsFromSingleBucket, metadata);\n+        return doCreateInternal(vs, searchContext, parent, cardinality, metadata);\n     }\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a field that couldn't be resolved\n+     * to a {@link ValuesSource}.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjEyODg4Mg==", "bodyText": "Nit - there doesn't have to be a field here.  Could be a script, for example.  I prefer to say a values source that has values to return, which is still clunky but English.", "url": "https://github.com/elastic/elasticsearch/pull/56533#discussion_r436128882", "createdAt": "2020-06-05T19:46:30Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceAggregatorFactory.java", "diffHunk": "@@ -40,23 +41,35 @@ public ValuesSourceAggregatorFactory(String name, ValuesSourceConfig config, Que\n     }\n \n     @Override\n-    public Aggregator createInternal(SearchContext searchContext, Aggregator parent, boolean collectsFromSingleBucket,\n+    public Aggregator createInternal(SearchContext searchContext, Aggregator parent, CardinalityUpperBound cardinality,\n                                      Map<String, Object> metadata) throws IOException {\n         ValuesSource vs = config.toValuesSource();\n         if (vs == null) {\n             return createUnmapped(searchContext, parent, metadata);\n         }\n-        return doCreateInternal(vs, searchContext, parent, collectsFromSingleBucket, metadata);\n+        return doCreateInternal(vs, searchContext, parent, cardinality, metadata);\n     }\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a field that couldn't be resolved\n+     * to a {@link ValuesSource}.\n+     */\n     protected abstract Aggregator createUnmapped(SearchContext searchContext,\n                                                  Aggregator parent,\n                                                  Map<String, Object> metadata) throws IOException;\n \n+    /**\n+     * Create the {@linkplain Aggregator} for a field that was resolved to a", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fd02bd2fb442d7ed96a5042ba5819dcb540cee7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ae89c41acd5ad38d91e3b2280f79e84e1fe003b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ae89c41acd5ad38d91e3b2280f79e84e1fe003b", "committedDate": "2020-06-12T19:13:29Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3968927208a5a5585ae6fec637048e392a5dc9c2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/3968927208a5a5585ae6fec637048e392a5dc9c2", "committedDate": "2020-06-12T19:18:30Z", "message": "itr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cfcc2c1c0d277604f7443aff625abd860fd1db2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6cfcc2c1c0d277604f7443aff625abd860fd1db2", "committedDate": "2020-06-12T19:41:11Z", "message": "oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e9eb9eb235d55802893d1d1cc2d3321f035eb76", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e9eb9eb235d55802893d1d1cc2d3321f035eb76", "committedDate": "2020-06-12T20:26:38Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c0d69f461a8ccc5669041cf07d35a7cf8362ef9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c0d69f461a8ccc5669041cf07d35a7cf8362ef9", "committedDate": "2020-07-01T21:57:39Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "171381dbb4ca56a159df1ba9303159afcfb9be05", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/171381dbb4ca56a159df1ba9303159afcfb9be05", "committedDate": "2020-07-06T14:09:44Z", "message": "Merge branch 'master' into collects_from_single_buckets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f22b431c995c627e32f7cf580089ddf8a36e9b7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f22b431c995c627e32f7cf580089ddf8a36e9b7", "committedDate": "2020-07-06T15:31:04Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c23498c387ac2767b506eb4a6e6949ba59b631", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9c23498c387ac2767b506eb4a6e6949ba59b631", "committedDate": "2020-07-06T16:17:29Z", "message": "Parent?"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2eb87b8178ac1c6c574a816e57041872a3704f4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2eb87b8178ac1c6c574a816e57041872a3704f4", "committedDate": "2020-07-06T19:27:44Z", "message": "Explain"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 153, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}