{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE1NTU0MDIz", "number": 64606, "title": "Create async search index if necessary on updates and deletes", "bodyText": "This change ensures that we create the async search index with the right mappings and settings when updating or deleting a document. Users can delete the async search index at any time so we have to re-create it internally if necessary before applying any new operation.", "createdAt": "2020-11-04T18:05:29Z", "url": "https://github.com/elastic/elasticsearch/pull/64606", "merged": true, "mergeCommit": {"oid": "2adac36af88600c55dde91295e51026c329524e1"}, "closed": true, "closedAt": "2020-12-02T07:54:40Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZRue7AH2gAyNTE1NTU0MDIzOjY0Nzg0MDdhNmI0MDQ0MGVlZDBmZGRkNmYyZThhNjZmYTY1MmY4YmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiBXj5AH2gAyNTE1NTU0MDIzOjZhMmIxZDViYzYzMDg3OWI5NGNlZDIxOTU1NDViN2Y0ZDAzMWZlMDI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6478407a6b40440eed0fddd6f2e8a66fa652f8bf", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/6478407a6b40440eed0fddd6f2e8a66fa652f8bf", "committedDate": "2020-11-04T18:04:30Z", "message": "Register a template for .async-search index\n\nThis change registers a template for the .async-search system index in order\nto ensure that deleting and re-creating the index outside of the async search API\ndoesn't break the strict mapping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f807e3c8cc5c101bf286aa77ae4112ca3a08622b", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f807e3c8cc5c101bf286aa77ae4112ca3a08622b", "committedDate": "2020-11-04T18:11:00Z", "message": "fix test compilation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "950b4ea34f8afd7dc00229d52c9a70fc64325c65", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/950b4ea34f8afd7dc00229d52c9a70fc64325c65", "committedDate": "2020-11-04T20:04:44Z", "message": "fix template name in ESRestTestCase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "50a53182dc732f41036ca21bf9cf204c8f8b8db9", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/50a53182dc732f41036ca21bf9cf204c8f8b8db9", "committedDate": "2020-11-04T20:30:19Z", "message": "line len"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzQwNzU5", "url": "https://github.com/elastic/elasticsearch/pull/64606#pullrequestreview-525340759", "createdAt": "2020-11-06T17:10:16Z", "commit": {"oid": "50a53182dc732f41036ca21bf9cf204c8f8b8db9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMDoxN1rOHu2ZSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzoxMDoxN1rOHu2ZSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Nzc1Mg==", "bodyText": "Hmm, does this meant that any async search user can now mess with templates. Does this really necessary?", "url": "https://github.com/elastic/elasticsearch/pull/64606#discussion_r518887752", "createdAt": "2020-11-06T17:10:17Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/AsyncSearchUser.java", "diffHunk": "@@ -16,7 +16,8 @@\n     public static final AsyncSearchUser INSTANCE = new AsyncSearchUser();\n     public static final String ROLE_NAME = UsernamesField.ASYNC_SEARCH_ROLE;\n     public static final Role ROLE = Role.builder(new RoleDescriptor(ROLE_NAME,\n-            null,\n+            // handles template registry for the .async-search index\n+            new String[] { \"manage_index_templates\" },", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50a53182dc732f41036ca21bf9cf204c8f8b8db9"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08a01fbe57c050f31840f59b1094f2872b80aa80", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/08a01fbe57c050f31840f59b1094f2872b80aa80", "committedDate": "2020-11-30T18:48:18Z", "message": "Merge branch 'master' into async_search_index_template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "383d030d1403105d49f8808cd920fca3f7967bd7", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/383d030d1403105d49f8808cd920fca3f7967bd7", "committedDate": "2020-11-30T18:55:38Z", "message": "apply review comment and set index.codec to best_compression"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMjY3MTcz", "url": "https://github.com/elastic/elasticsearch/pull/64606#pullrequestreview-541267173", "createdAt": "2020-11-30T20:25:57Z", "commit": {"oid": "383d030d1403105d49f8808cd920fca3f7967bd7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDoyNTo1N1rOH8MiBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMDoyNTo1N1rOH8MiBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjg4MTkyNg==", "bodyText": "It looks like we are reusing this in snapshot as well. So I am ok with this approach. I am just not 100% sure of it needs a separate original and a separate role. Maybe ping somebody from security?", "url": "https://github.com/elastic/elasticsearch/pull/64606#discussion_r532881926", "createdAt": "2020-11-30T20:25:57Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskTemplateRegistry.java", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.template.IndexTemplateConfig;\n+import org.elasticsearch.xpack.core.template.IndexTemplateRegistry;\n+\n+import java.util.Collections;\n+import java.util.List;\n+\n+/**\n+ * The {@link AsyncTaskTemplateRegistry} class sets up the index template for the .async-search index.\n+ */\n+public class AsyncTaskTemplateRegistry extends IndexTemplateRegistry {\n+    public static final int INDEX_TEMPLATE_VERSION = 0;\n+\n+    public static final String ASYNC_TASK_TEMPLATE_VERSION_VARIABLE = \"xpack.async_search.template.version\";\n+    public static final String ASYNC_SEARCH_TEMPLATE_NAME = \"async-search\";\n+\n+    public static final IndexTemplateConfig TEMPLATE_ASYNC_SEARCH = new IndexTemplateConfig(\n+        ASYNC_SEARCH_TEMPLATE_NAME,\n+        \"/async-search.json\",\n+        INDEX_TEMPLATE_VERSION,\n+        ASYNC_TASK_TEMPLATE_VERSION_VARIABLE\n+    );\n+\n+    public AsyncTaskTemplateRegistry(Settings nodeSettings, ClusterService clusterService,\n+                                     ThreadPool threadPool, Client client,\n+                                     NamedXContentRegistry xContentRegistry) {\n+        super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n+    }\n+\n+    @Override\n+    protected boolean requiresMasterNode() {\n+        return true;\n+    }\n+\n+    @Override\n+    protected List<IndexTemplateConfig> getComposableTemplateConfigs() {\n+        return Collections.singletonList(TEMPLATE_ASYNC_SEARCH);\n+    }\n+\n+    @Override\n+    protected String getOrigin() {\n+        return ClientHelper.INDEX_LIFECYCLE_ORIGIN;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "383d030d1403105d49f8808cd920fca3f7967bd7"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6be60beeeb0d1acb72da2930547ae33b9850cb2f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/6be60beeeb0d1acb72da2930547ae33b9850cb2f", "committedDate": "2020-12-01T11:55:58Z", "message": "another round of review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd49e88381fed357ae800715a80f151074aaeab", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cd49e88381fed357ae800715a80f151074aaeab", "committedDate": "2020-12-01T11:57:27Z", "message": "remove change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df5b3f0c2b96f97752920e7c7c88eaf25023ce62", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/df5b3f0c2b96f97752920e7c7c88eaf25023ce62", "committedDate": "2020-12-01T12:31:28Z", "message": "add a test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTQ4OTAy", "url": "https://github.com/elastic/elasticsearch/pull/64606#pullrequestreview-542148902", "createdAt": "2020-12-01T17:46:38Z", "commit": {"oid": "df5b3f0c2b96f97752920e7c7c88eaf25023ce62"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNzo0NjozOFrOH84nkQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxNzo0NjozOFrOH84nkQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzYwNDI0MQ==", "bodyText": "Do we need to create an index in this case or this is for consistency?", "url": "https://github.com/elastic/elasticsearch/pull/64606#discussion_r533604241", "createdAt": "2020-12-01T17:46:38Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskIndexService.java", "diffHunk": "@@ -225,7 +227,7 @@ public void deleteResponse(AsyncExecutionId asyncExecutionId,\n                                ActionListener<DeleteResponse> listener) {\n         try {\n             DeleteRequest request = new DeleteRequest(index).id(asyncExecutionId.getDocId());\n-            client.delete(request, listener);\n+            createIndexIfNecessary(ActionListener.wrap(v -> client.delete(request, listener), listener::onFailure));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df5b3f0c2b96f97752920e7c7c88eaf25023ce62"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25874dd833cc0f5480ccd44fa29b72b5d4b122c9", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/25874dd833cc0f5480ccd44fa29b72b5d4b122c9", "committedDate": "2020-12-01T21:35:51Z", "message": "Merge branch 'master' into async_search_index_template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a273d920cd9f91e67507abe2c1c321c3e9eb62ad", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a273d920cd9f91e67507abe2c1c321c3e9eb62ad", "committedDate": "2020-12-01T21:39:31Z", "message": "apply review comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a2b1d5bc630879b94ced2195545b7f4d031fe02", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a2b1d5bc630879b94ced2195545b7f4d031fe02", "committedDate": "2020-12-01T22:06:18Z", "message": "Merge branch 'master' into async_search_index_template"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 823, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}