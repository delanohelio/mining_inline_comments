{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MTM4OTUw", "number": 64046, "title": "Move tasks in build scripts to task avoidance api", "bodyText": "Some trivial cleanup on build scripts\nChange task referencing in build scripts to use task avoidance api\nwhere replacement is trivial.\n\nBefore:\nhttps://gradle-enterprise.elastic.co/s/yqoztiubfz5za/performance/configuration#summary-task-totals\nAfter:\nhttps://gradle-enterprise.elastic.co/s/giqtxsr5z25d2/performance/configuration#summary-task-totals", "createdAt": "2020-10-22T09:12:08Z", "url": "https://github.com/elastic/elasticsearch/pull/64046", "merged": true, "mergeCommit": {"oid": "810e7ff6b0163164e8f5b79d68814ecadb830488"}, "closed": true, "closedAt": "2020-11-12T11:04:16Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdazscRABqjM5NzM0NDIyNTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbvxr-AH2gAyNTA4MTM4OTUwOmQ3Mzc5MzhhYWEyZDIwMzM5OTE0NjNmZjdjYjAzMTIxODUwMzM4MGI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "59ced3e829995db430d77a0ee71decba4adbf551", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/59ced3e829995db430d77a0ee71decba4adbf551", "committedDate": "2020-10-22T09:10:14Z", "message": "Move tasks in build scripts to task avoidance api"}, "afterCommit": {"oid": "1122d063cd96d90cd39766175a0582b58f26804a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/1122d063cd96d90cd39766175a0582b58f26804a", "committedDate": "2020-11-09T12:12:40Z", "message": "Move tasks in build scripts to task avoidance api"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1122d063cd96d90cd39766175a0582b58f26804a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/1122d063cd96d90cd39766175a0582b58f26804a", "committedDate": "2020-11-09T12:12:40Z", "message": "Move tasks in build scripts to task avoidance api"}, "afterCommit": {"oid": "d41a8e3a26586fab09809d4aeaf430882a59e20c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d41a8e3a26586fab09809d4aeaf430882a59e20c", "committedDate": "2020-11-11T09:39:17Z", "message": "Move tasks in build scripts to task avoidance api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f783deea09f02a270d087e42e6112a31bed7ccfc", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/f783deea09f02a270d087e42e6112a31bed7ccfc", "committedDate": "2020-11-11T14:35:58Z", "message": "Move tasks in build scripts to task avoidance api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82512ad0ec551677483a3aa4e9687fcadc8fb1f0", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/82512ad0ec551677483a3aa4e9687fcadc8fb1f0", "committedDate": "2020-11-11T14:35:58Z", "message": "Use more task avoidance API in build scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cd0b4789eb900d016f0a7e00461f59d9280714a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/6cd0b4789eb900d016f0a7e00461f59d9280714a", "committedDate": "2020-11-11T14:35:58Z", "message": "Fix ci"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "committedDate": "2020-11-11T14:54:20Z", "message": "Revert change that introduce task dependency cycle"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "69a6ebb800a934aecd51a999a82f8f06b50915d2", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/69a6ebb800a934aecd51a999a82f8f06b50915d2", "committedDate": "2020-11-11T12:59:07Z", "message": "Fix ci"}, "afterCommit": {"oid": "ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea6c89def1eb58674aec1a1bde430ee1e5f7641c", "committedDate": "2020-11-11T14:54:20Z", "message": "Revert change that introduce task dependency cycle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b0d0611f1d6a3845f8ad46c45bcabdc5757d927", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b0d0611f1d6a3845f8ad46c45bcabdc5757d927", "committedDate": "2020-11-11T22:05:17Z", "message": "Some more cleanup on build scripts\n\n- add reusable method for making subprojects depend on check task\n- more task avoidance api"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a10a04806acb85b3d1e4bd6c39928d6c8dad997", "committedDate": "2020-11-11T22:12:51Z", "message": "Fix task dependency in :modules:reindex"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4NTg2MzEz", "url": "https://github.com/elastic/elasticsearch/pull/64046#pullrequestreview-528586313", "createdAt": "2020-11-11T22:38:00Z", "commit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMjozODowMFrOHxg2Fw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMzoxOTozOFrOHxhz5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MDQwNw==", "bodyText": "We seem to be relying on delegation in some places and using the implicit it argument in others. Should we standardize on one or the other?", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521680407", "createdAt": "2020-11-11T22:38:00Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/build.gradle", "diffHunk": "@@ -146,19 +148,29 @@ if (project != rootProject) {\n   apply plugin: 'elasticsearch.publish'\n \n   // groovydoc succeeds, but has some weird internal exception...\n-  groovydoc.enabled = false\n+  tasks.named(\"groovydoc\").configure {\n+    it.enabled = false", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTU4MA==", "bodyText": "Is this findAll filter necessary. Doesn't the find above ensure that will always be the case?", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521681580", "createdAt": "2020-11-11T22:40:56Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -108,6 +108,21 @@ class PluginBuildPlugin implements Plugin<Project> {\n             }\n         }\n \n+        // We've ported this from multiple build scripts where we see this pattern into\n+        // an extension method as a first step of consolidation.\n+        // We might want to port this into a general pattern later on.\n+        project.ext.addQaCheckDependencies = {\n+            project.afterEvaluate {\n+                // let check depend on check tasks of qa sub-projects\n+                def checkTaskProvider = project.tasks.named(\"check\")\n+                def qaSubproject = project.subprojects.find { it.path == project.path + \":qa\" }\n+                if(qaSubproject) {\n+                    qaSubproject.subprojects.findAll {p -> p.path.startsWith(project.path + \":qa\") }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MTk5Mg==", "bodyText": "This is kind of an odd thing already. I would assume in most cases folks would just do ./gradlew -p path/to/project check which should essentially be the same thing. This wiring now makes it impossible to just run the checks on a single project w/o transitively running a ton of other stuff.", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521681992", "createdAt": "2020-11-11T22:41:57Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/plugin/PluginBuildPlugin.groovy", "diffHunk": "@@ -108,6 +108,21 @@ class PluginBuildPlugin implements Plugin<Project> {\n             }\n         }\n \n+        // We've ported this from multiple build scripts where we see this pattern into\n+        // an extension method as a first step of consolidation.\n+        // We might want to port this into a general pattern later on.\n+        project.ext.addQaCheckDependencies = {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY4MzEzNQ==", "bodyText": "Why is this necessary? Should we be depending on some kind of configuration or artifact instead?", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521683135", "createdAt": "2020-11-11T22:44:50Z", "author": {"login": "mark-vieira"}, "path": "distribution/archives/integ-test-zip/build.gradle", "diffHunk": "@@ -48,15 +44,16 @@ publishing {\n   }\n }\n \n-integTest {\n+tasks.named(\"integTest\").configure {\n+  dependsOn \"assemble\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MTQ1Mg==", "bodyText": "Doesn't this effectively nullify any benefit of lazily creating the unzip task? Is there a reason we can't lazily create the fixture task?", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521691452", "createdAt": "2020-11-11T23:07:22Z", "author": {"login": "mark-vieira"}, "path": "modules/reindex/build.gradle", "diffHunk": "@@ -146,7 +148,7 @@ if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n       env 'JAVA_HOME', jdks.legacy.javaHomePath\n       args 'oldes.OldElasticsearch',\n         baseDir,\n-        unzip.temporaryDir,\n+        unzip.get().temporaryDir,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5MzU3NQ==", "bodyText": "By this you just mean that we move this config inside the task configuration block as that guarantees the task has been created, and subsequently, the corresponding testcluster will exist as well?", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521693575", "createdAt": "2020-11-11T23:13:42Z", "author": {"login": "mark-vieira"}, "path": "plugins/repository-gcs/build.gradle", "diffHunk": "@@ -293,29 +293,28 @@ testClusters {\n  * We only use a small amount of data in these tests, which means that the resumable upload path is not tested. We add\n  * an additional test that forces the large blob threshold to be small to exercise the resumable upload path.\n  */\n-task largeBlobYamlRestTest(type: RestIntegTestTask) {\n-  dependsOn bundlePlugin\n+def largeBlobYamlRestTest = tasks.register(\"largeBlobYamlRestTest\", RestIntegTestTask) {\n+  dependsOn \"bundlePlugin\"\n   if (useFixture) {\n-    dependsOn createServiceAccountFile\n+    dependsOn \"createServiceAccountFile\"\n   }\n-    SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n-    SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n-    setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n-    setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n-}\n+  SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+  SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n+  setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n+  setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n \n-check.dependsOn largeBlobYamlRestTest\n+  // We have to wait for configure the cluster here as it might not have been created otherwise yet.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 89}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NDI1Ng==", "bodyText": "I see we wrap the task dependency in quotes here, but not later with integTest. In practice, does it matter? Obviously this config block is deferred until this task is needed, at which point we'll need all its dependencies as well, right? Essentially, there's no scenario in which this block will evaluate and we don't need to create the war task.", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521694256", "createdAt": "2020-11-11T23:15:39Z", "author": {"login": "mark-vieira"}, "path": "qa/wildfly/build.gradle", "diffHunk": "@@ -63,8 +63,8 @@ elasticsearch_distributions {\n   }\n }\n \n-preProcessFixture {\n-  dependsOn war, elasticsearch_distributions.docker\n+tasks.named(\"preProcessFixture\").configure {\n+  dependsOn \"war\", elasticsearch_distributions.docker", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY5NjIyOQ==", "bodyText": "I feel like the rest test plugin or something should be adding this ordering rule.", "url": "https://github.com/elastic/elasticsearch/pull/64046#discussion_r521696229", "createdAt": "2020-11-11T23:19:38Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/ccr/qa/downgrade-to-basic-license/build.gradle", "diffHunk": "@@ -11,7 +11,7 @@ dependencies {\n }\n \n task \"leader-cluster\"(type: RestIntegTestTask) {\n-  mustRunAfter(precommit)\n+  mustRunAfter(\"precommit\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a10a04806acb85b3d1e4bd6c39928d6c8dad997"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b54aba559853cf92ed0e931e3617be03f7d8a833", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b54aba559853cf92ed0e931e3617be03f7d8a833", "committedDate": "2020-11-12T09:58:27Z", "message": "Apply review feedback\n\n- rely in closure delegation for task config blocks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d737938aaa2d2033991463ff7cb031218503380b", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d737938aaa2d2033991463ff7cb031218503380b", "committedDate": "2020-11-12T10:13:00Z", "message": "Fix formatting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1119, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}