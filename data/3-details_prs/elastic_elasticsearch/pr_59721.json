{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUwNDE3Njgx", "number": 59721, "title": "Add long flavored script field", "bodyText": "This adds the long runtime type to script fields and implements doc\nvalues, field data, the term and exists query.\nRelates to #59332", "createdAt": "2020-07-16T18:42:16Z", "url": "https://github.com/elastic/elasticsearch/pull/59721", "merged": true, "mergeCommit": {"oid": "c8b5af91fc227e945f30bb91d262278c00548ddb"}, "closed": true, "closedAt": "2020-07-17T19:33:19Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1jvCBgH2gAyNDUwNDE3NjgxOjVmZjFlNzU2ZGU1Yzg3ZjEzMGY1NTE0ZDVlYTk0YjQ2YmJlYjUwZmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc14lhQAFqTQ1MDg5MDU5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ff1e756de5c87f130f5514d5ea94b46bbeb50fc", "committedDate": "2020-07-16T18:42:07Z", "message": "Add long flavored script field\n\nThis adds the `long` runtime type to `script` fields and implements doc\nvalues, field data, the `term` and `exists` query."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2896a016c963c510d6001be6e2eef7d9ae588d71", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2896a016c963c510d6001be6e2eef7d9ae588d71", "committedDate": "2020-07-16T18:38:43Z", "message": "Add long flavored script field\n\nThis adds the `long` runtime type to `script` fields and implements doc\nvalues, field data, the `term` and `exists` query."}, "afterCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ff1e756de5c87f130f5514d5ea94b46bbeb50fc", "committedDate": "2020-07-16T18:42:07Z", "message": "Add long flavored script field\n\nThis adds the `long` runtime type to `script` fields and implements doc\nvalues, field data, the `term` and `exists` query."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwNjQ0OTcy", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450644972", "createdAt": "2020-07-17T13:12:40Z", "commit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "state": "COMMENTED", "comments": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzoxMjo0MFrOGzSc-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxMzoyOTozN1rOGzTCiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMjg5MQ==", "bodyText": "does it need to be protected? Also maybe rename to something like collectValue ? I find it weird to call add against the script itself", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456432891", "createdAt": "2020-07-17T13:12:40Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/LongScriptFieldScript.java", "diffHunk": "@@ -32,14 +32,47 @@\n     }\n \n     public interface LeafFactory {\n-        LongScriptFieldScript newInstance(LeafReaderContext ctx, LongConsumer sync) throws IOException;\n+        LongScriptFieldScript newInstance(LeafReaderContext ctx) throws IOException;\n     }\n \n-    private final LongConsumer sync;\n+    private long[] values = new long[1];\n+    private int count;\n \n-    public LongScriptFieldScript(Map<String, Object> params, SearchLookup searchLookup, LeafReaderContext ctx, LongConsumer sync) {\n+    public LongScriptFieldScript(Map<String, Object> params, SearchLookup searchLookup, LeafReaderContext ctx) {\n         super(params, searchLookup, ctx);\n-        this.sync = sync;\n+    }\n+\n+    /**\n+     * Execute the script for the provided {@code docId}.\n+     */\n+    public final void runForDoc(int docId) {\n+        count = 0;\n+        setDocument(docId);\n+        execute();\n+    }\n+\n+    /**\n+     * Values from the last time {@link #runForDoc(int)} was called. This array\n+     * is mutable and will change with the next call of {@link #runForDoc(int)}.\n+     * It is also oversized and will contain garbage at all indices at and\n+     * above {@link #count()}.\n+     */\n+    public final long[] values() {\n+        return values;\n+    }\n+\n+    /**\n+     * The number of results produced the last time {@link #runForDoc(int)} was called.\n+     */\n+    public final int count() {\n+        return count;\n+    }\n+\n+    protected final void add(long v) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzMzg4OQ==", "bodyText": "you can use SortingNumericDocValues?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456433889", "createdAt": "2020-07-17T13:14:28Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongDocValues.java", "diffHunk": "@@ -0,0 +1,43 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.elasticsearch.index.fielddata.AbstractSortedNumericDocValues;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+\n+public final class ScriptLongDocValues extends AbstractSortedNumericDocValues {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNDQzMw==", "bodyText": "For now we need to the same as I proposed in #59762 so that we can carry the params around. That will go away once we can change the signature of fielddataBuilder", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456434433", "createdAt": "2020-07-17T13:15:27Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongFieldData.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.util.SetOnce;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.FieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.LeafNumericFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SearchLookupAware;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+import org.elasticsearch.index.fielddata.SortedNumericDoubleValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class ScriptLongFieldData extends IndexNumericFieldData implements SearchLookupAware {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private final LongScriptFieldScript.Factory scriptFactory;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNDg2MQ==", "bodyText": "if you carry the script around you can remove this TODO :)", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456434861", "createdAt": "2020-07-17T13:16:15Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongFieldData.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.util.SetOnce;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.FieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.LeafNumericFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SearchLookupAware;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+import org.elasticsearch.index.fielddata.SortedNumericDoubleValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class ScriptLongFieldData extends IndexNumericFieldData implements SearchLookupAware {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private final LongScriptFieldScript.Factory scriptFactory;\n+\n+        public Builder(LongScriptFieldScript.Factory scriptFactory) {\n+            this.scriptFactory = scriptFactory;\n+        }\n+\n+        @Override\n+        public ScriptLongFieldData build(\n+            IndexSettings indexSettings,\n+            MappedFieldType fieldType,\n+            IndexFieldDataCache cache,\n+            CircuitBreakerService breakerService,\n+            MapperService mapperService\n+        ) {\n+            return new ScriptLongFieldData(indexSettings.getIndex(), fieldType.name(), scriptFactory);\n+        }\n+    }\n+\n+    private final Index index;\n+    private final String fieldName;\n+    private final LongScriptFieldScript.Factory scriptFactory;\n+    private final SetOnce<LongScriptFieldScript.LeafFactory> leafFactory = new SetOnce<>();\n+\n+    private ScriptLongFieldData(Index index, String fieldName, LongScriptFieldScript.Factory scriptFactory) {\n+        this.index = index;\n+        this.fieldName = fieldName;\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    public void setSearchLookup(SearchLookup searchLookup) {\n+        // TODO wire the params from the mappings definition, we don't parse them yet", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNTQ2Mw==", "bodyText": "another change that I lost somehow, but this should rather be ExceptionsHelper#convertToElastic . Can you make the same change in the binary one too?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456435463", "createdAt": "2020-07-17T13:17:29Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongFieldData.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.util.SetOnce;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.FieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.LeafNumericFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SearchLookupAware;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+import org.elasticsearch.index.fielddata.SortedNumericDoubleValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class ScriptLongFieldData extends IndexNumericFieldData implements SearchLookupAware {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private final LongScriptFieldScript.Factory scriptFactory;\n+\n+        public Builder(LongScriptFieldScript.Factory scriptFactory) {\n+            this.scriptFactory = scriptFactory;\n+        }\n+\n+        @Override\n+        public ScriptLongFieldData build(\n+            IndexSettings indexSettings,\n+            MappedFieldType fieldType,\n+            IndexFieldDataCache cache,\n+            CircuitBreakerService breakerService,\n+            MapperService mapperService\n+        ) {\n+            return new ScriptLongFieldData(indexSettings.getIndex(), fieldType.name(), scriptFactory);\n+        }\n+    }\n+\n+    private final Index index;\n+    private final String fieldName;\n+    private final LongScriptFieldScript.Factory scriptFactory;\n+    private final SetOnce<LongScriptFieldScript.LeafFactory> leafFactory = new SetOnce<>();\n+\n+    private ScriptLongFieldData(Index index, String fieldName, LongScriptFieldScript.Factory scriptFactory) {\n+        this.index = index;\n+        this.fieldName = fieldName;\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    public void setSearchLookup(SearchLookup searchLookup) {\n+        // TODO wire the params from the mappings definition, we don't parse them yet\n+        this.leafFactory.set(scriptFactory.newFactory(Collections.emptyMap(), searchLookup));\n+    }\n+\n+    @Override\n+    public String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public ValuesSourceType getValuesSourceType() {\n+        return CoreValuesSourceType.NUMERIC;\n+    }\n+\n+    @Override\n+    public ScriptLongLeafFieldData load(LeafReaderContext context) {\n+        try {\n+            return loadDirect(context);\n+        } catch (Exception e) {\n+            if (e instanceof ElasticsearchException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNTkwMg==", "bodyText": "this is not needed right?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456435902", "createdAt": "2020-07-17T13:18:19Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongFieldData.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.util.SetOnce;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.FieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.LeafNumericFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SearchLookupAware;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+import org.elasticsearch.index.fielddata.SortedNumericDoubleValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class ScriptLongFieldData extends IndexNumericFieldData implements SearchLookupAware {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private final LongScriptFieldScript.Factory scriptFactory;\n+\n+        public Builder(LongScriptFieldScript.Factory scriptFactory) {\n+            this.scriptFactory = scriptFactory;\n+        }\n+\n+        @Override\n+        public ScriptLongFieldData build(\n+            IndexSettings indexSettings,\n+            MappedFieldType fieldType,\n+            IndexFieldDataCache cache,\n+            CircuitBreakerService breakerService,\n+            MapperService mapperService\n+        ) {\n+            return new ScriptLongFieldData(indexSettings.getIndex(), fieldType.name(), scriptFactory);\n+        }\n+    }\n+\n+    private final Index index;\n+    private final String fieldName;\n+    private final LongScriptFieldScript.Factory scriptFactory;\n+    private final SetOnce<LongScriptFieldScript.LeafFactory> leafFactory = new SetOnce<>();\n+\n+    private ScriptLongFieldData(Index index, String fieldName, LongScriptFieldScript.Factory scriptFactory) {\n+        this.index = index;\n+        this.fieldName = fieldName;\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    public void setSearchLookup(SearchLookup searchLookup) {\n+        // TODO wire the params from the mappings definition, we don't parse them yet\n+        this.leafFactory.set(scriptFactory.newFactory(Collections.emptyMap(), searchLookup));\n+    }\n+\n+    @Override\n+    public String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public ValuesSourceType getValuesSourceType() {\n+        return CoreValuesSourceType.NUMERIC;\n+    }\n+\n+    @Override\n+    public ScriptLongLeafFieldData load(LeafReaderContext context) {\n+        try {\n+            return loadDirect(context);\n+        } catch (Exception e) {\n+            if (e instanceof ElasticsearchException) {\n+                throw (ElasticsearchException) e;\n+            } else {\n+                throw new ElasticsearchException(e);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public ScriptLongLeafFieldData loadDirect(LeafReaderContext context) throws IOException {\n+        return new ScriptLongLeafFieldData(new ScriptLongDocValues(leafFactory.get().newInstance(context)));\n+    }\n+\n+    @Override\n+    public NumericType getNumericType() {\n+        return NumericType.LONG;\n+    }\n+\n+    @Override\n+    protected boolean sortRequiresCustomComparator() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void clear() {}\n+\n+    @Override\n+    public Index index() {\n+        return index;\n+    }\n+\n+    public static class ScriptLongLeafFieldData implements LeafNumericFieldData {\n+        private final ScriptLongDocValues scriptBinaryDocValues;\n+\n+        ScriptLongLeafFieldData(ScriptLongDocValues scriptBinaryDocValues) {\n+            this.scriptBinaryDocValues = scriptBinaryDocValues;\n+        }\n+\n+        @Override\n+        public ScriptDocValues<?> getScriptValues() {\n+            return new ScriptDocValues.Longs(getLongValues());\n+        }\n+\n+        @Override\n+        public SortedBinaryDocValues getBytesValues() {\n+            return FieldData.toString(scriptBinaryDocValues);\n+        }\n+\n+        @Override\n+        public SortedNumericDoubleValues getDoubleValues() {\n+            return FieldData.castToDouble(getLongValues());\n+        }\n+\n+        @Override\n+        public SortedNumericDocValues getLongValues() {\n+            return scriptBinaryDocValues;\n+        }\n+\n+        @Override\n+        public long ramBytesUsed() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public void close() {\n+\n+        }\n+    }\n+\n+    static class ScriptBinaryResult {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNjA0OQ==", "bodyText": "needs to be removed also in the binary one, it's unused :)", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456436049", "createdAt": "2020-07-17T13:18:36Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptLongFieldData.java", "diffHunk": "@@ -0,0 +1,171 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.util.SetOnce;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.index.Index;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.fielddata.FieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.LeafNumericFieldData;\n+import org.elasticsearch.index.fielddata.ScriptDocValues;\n+import org.elasticsearch.index.fielddata.SearchLookupAware;\n+import org.elasticsearch.index.fielddata.SortedBinaryDocValues;\n+import org.elasticsearch.index.fielddata.SortedNumericDoubleValues;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.List;\n+\n+public final class ScriptLongFieldData extends IndexNumericFieldData implements SearchLookupAware {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+\n+        private final LongScriptFieldScript.Factory scriptFactory;\n+\n+        public Builder(LongScriptFieldScript.Factory scriptFactory) {\n+            this.scriptFactory = scriptFactory;\n+        }\n+\n+        @Override\n+        public ScriptLongFieldData build(\n+            IndexSettings indexSettings,\n+            MappedFieldType fieldType,\n+            IndexFieldDataCache cache,\n+            CircuitBreakerService breakerService,\n+            MapperService mapperService\n+        ) {\n+            return new ScriptLongFieldData(indexSettings.getIndex(), fieldType.name(), scriptFactory);\n+        }\n+    }\n+\n+    private final Index index;\n+    private final String fieldName;\n+    private final LongScriptFieldScript.Factory scriptFactory;\n+    private final SetOnce<LongScriptFieldScript.LeafFactory> leafFactory = new SetOnce<>();\n+\n+    private ScriptLongFieldData(Index index, String fieldName, LongScriptFieldScript.Factory scriptFactory) {\n+        this.index = index;\n+        this.fieldName = fieldName;\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    public void setSearchLookup(SearchLookup searchLookup) {\n+        // TODO wire the params from the mappings definition, we don't parse them yet\n+        this.leafFactory.set(scriptFactory.newFactory(Collections.emptyMap(), searchLookup));\n+    }\n+\n+    @Override\n+    public String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public ValuesSourceType getValuesSourceType() {\n+        return CoreValuesSourceType.NUMERIC;\n+    }\n+\n+    @Override\n+    public ScriptLongLeafFieldData load(LeafReaderContext context) {\n+        try {\n+            return loadDirect(context);\n+        } catch (Exception e) {\n+            if (e instanceof ElasticsearchException) {\n+                throw (ElasticsearchException) e;\n+            } else {\n+                throw new ElasticsearchException(e);\n+            }\n+        }\n+    }\n+\n+    @Override\n+    public ScriptLongLeafFieldData loadDirect(LeafReaderContext context) throws IOException {\n+        return new ScriptLongLeafFieldData(new ScriptLongDocValues(leafFactory.get().newInstance(context)));\n+    }\n+\n+    @Override\n+    public NumericType getNumericType() {\n+        return NumericType.LONG;\n+    }\n+\n+    @Override\n+    protected boolean sortRequiresCustomComparator() {\n+        return true;\n+    }\n+\n+    @Override\n+    public void clear() {}\n+\n+    @Override\n+    public Index index() {\n+        return index;\n+    }\n+\n+    public static class ScriptLongLeafFieldData implements LeafNumericFieldData {\n+        private final ScriptLongDocValues scriptBinaryDocValues;\n+\n+        ScriptLongLeafFieldData(ScriptLongDocValues scriptBinaryDocValues) {\n+            this.scriptBinaryDocValues = scriptBinaryDocValues;\n+        }\n+\n+        @Override\n+        public ScriptDocValues<?> getScriptValues() {\n+            return new ScriptDocValues.Longs(getLongValues());\n+        }\n+\n+        @Override\n+        public SortedBinaryDocValues getBytesValues() {\n+            return FieldData.toString(scriptBinaryDocValues);\n+        }\n+\n+        @Override\n+        public SortedNumericDoubleValues getDoubleValues() {\n+            return FieldData.castToDouble(getLongValues());\n+        }\n+\n+        @Override\n+        public SortedNumericDocValues getLongValues() {\n+            return scriptBinaryDocValues;\n+        }\n+\n+        @Override\n+        public long ramBytesUsed() {\n+            return 0;\n+        }\n+\n+        @Override\n+        public void close() {\n+\n+        }\n+    }\n+\n+    static class ScriptBinaryResult {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNTkwMg=="}, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 160}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNjY1NQ==", "bodyText": "shall we add some way to not forget about overriding familyType for all the subclasses? Maybe we could override the method and make it call some other new abstract method?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456436655", "createdAt": "2020-07-17T13:19:40Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.ToXContent.Params;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.TextSearchInfo;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import static org.elasticsearch.search.SearchService.ALLOW_EXPENSIVE_QUERIES;\n+\n+/**\n+ * Abstract base {@linkplain MappedFieldType} for scripted fields.\n+ */\n+abstract class AbstractScriptMappedFieldType extends MappedFieldType {\n+    protected final Script script;\n+\n+    AbstractScriptMappedFieldType(String name, Script script, Map<String, String> meta) {\n+        super(name, false, false, TextSearchInfo.NONE, meta);\n+        this.script = script;\n+    }\n+\n+    @Override\n+    public final String typeName() {\n+        return ScriptFieldMapper.CONTENT_TYPE;\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzA4OA==", "bodyText": "oh well I see below that you have runtimeType, so it would be enough to override familyTypeName and call runtimeType in there.", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456437088", "createdAt": "2020-07-17T13:20:26Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.ToXContent.Params;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.TextSearchInfo;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import static org.elasticsearch.search.SearchService.ALLOW_EXPENSIVE_QUERIES;\n+\n+/**\n+ * Abstract base {@linkplain MappedFieldType} for scripted fields.\n+ */\n+abstract class AbstractScriptMappedFieldType extends MappedFieldType {\n+    protected final Script script;\n+\n+    AbstractScriptMappedFieldType(String name, Script script, Map<String, String> meta) {\n+        super(name, false, false, TextSearchInfo.NONE, meta);\n+        this.script = script;\n+    }\n+\n+    @Override\n+    public final String typeName() {\n+        return ScriptFieldMapper.CONTENT_TYPE;\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNjY1NQ=="}, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzNzU3NA==", "bodyText": "use the existing constant from KeywordFieldMapper#CONTENT_TYPE?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456437574", "createdAt": "2020-07-17T13:21:15Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptKeywordMappedFieldType.java", "diffHunk": "@@ -31,27 +26,30 @@\n import org.elasticsearch.xpack.runtimefields.query.StringScriptFieldTermsQuery;\n import org.elasticsearch.xpack.runtimefields.query.StringScriptFieldWildcardQuery;\n \n-import java.io.IOException;\n import java.time.ZoneId;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n import java.util.Set;\n \n import static java.util.stream.Collectors.toSet;\n-import static org.elasticsearch.search.SearchService.ALLOW_EXPENSIVE_QUERIES;\n \n-public final class RuntimeKeywordMappedFieldType extends MappedFieldType {\n+public final class ScriptKeywordMappedFieldType extends AbstractScriptMappedFieldType {\n \n     private final Script script;\n     private final StringScriptFieldScript.Factory scriptFactory;\n \n-    RuntimeKeywordMappedFieldType(String name, Script script, StringScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n-        super(name, false, false, TextSearchInfo.NONE, meta);\n+    ScriptKeywordMappedFieldType(String name, Script script, StringScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n         this.script = script;\n         this.scriptFactory = scriptFactory;\n     }\n \n+    @Override\n+    protected String runtimeType() {\n+        return \"keyword\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzODE3OA==", "bodyText": "I was making changes to the lookup as well in #59762 , let's use the constants from the existing mappers for their type?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456438178", "createdAt": "2020-07-17T13:22:16Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptFieldMapper.java", "diffHunk": "@@ -131,6 +125,27 @@ public ScriptFieldMapper build(BuilderContext context) {\n             );\n         }\n \n+        private MappedFieldType buildType(String fullName) {\n+            switch (runtimeType.getValue()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzODk1MA==", "bodyText": "should we introduce some way to not forget the check? like having this done in the base class, and define queries through new abstract methods?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456438950", "createdAt": "2020-07-17T13:23:38Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptLongMappedFieldType.java", "diffHunk": "@@ -0,0 +1,63 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.Query;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.index.mapper.NumberFieldMapper.NumberType;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptLongFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.LongScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.LongScriptFieldTermQuery;\n+\n+import java.util.Map;\n+\n+public class ScriptLongMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final LongScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptLongMappedFieldType(String name, Script script, LongScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return \"long\";\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        return value; // These should come back as a Long\n+    }\n+\n+    @Override\n+    public ScriptLongFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName) {\n+        // TODO once we get SearchLookup as an argument, we can already call scriptFactory.newFactory here and pass through the result\n+        return new ScriptLongFieldData.Builder(scriptFactory);\n+    }\n+\n+    private LongScriptFieldScript.LeafFactory leafFactory(QueryShardContext context) {\n+        return scriptFactory.newFactory(script.getParams(), context.lookup());\n+    }\n+\n+    @Override\n+    public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzOTM4OQ==", "bodyText": "Shall we make this a shared constant somewhere, and remove the TODO as that is what we will keep for the time being?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456439389", "createdAt": "2020-07-17T13:24:13Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractLongScriptFieldQuery.java", "diffHunk": "@@ -0,0 +1,79 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.query;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.search.ConstantScoreScorer;\n+import org.apache.lucene.search.ConstantScoreWeight;\n+import org.apache.lucene.search.DocIdSetIterator;\n+import org.apache.lucene.search.IndexSearcher;\n+import org.apache.lucene.search.QueryVisitor;\n+import org.apache.lucene.search.ScoreMode;\n+import org.apache.lucene.search.Scorer;\n+import org.apache.lucene.search.TwoPhaseIterator;\n+import org.apache.lucene.search.Weight;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.StringScriptFieldScript;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+/**\n+ * Abstract base class for building queries based on {@link StringScriptFieldScript}.\n+ */\n+abstract class AbstractLongScriptFieldQuery extends AbstractScriptFieldQuery {\n+    private final LongScriptFieldScript.LeafFactory leafFactory;\n+\n+    AbstractLongScriptFieldQuery(Script script, LongScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n+        super(script, fieldName);\n+        this.leafFactory = Objects.requireNonNull(leafFactory);\n+    }\n+\n+    /**\n+     * Does the value match this query?\n+     */\n+    protected abstract boolean matches(long[] values, int count);\n+\n+    @Override\n+    public final Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n+        return new ConstantScoreWeight(this, boost) {\n+            @Override\n+            public boolean isCacheable(LeafReaderContext ctx) {\n+                return false; // scripts aren't really cacheable at this point\n+            }\n+\n+            @Override\n+            public Scorer scorer(LeafReaderContext ctx) throws IOException {\n+                LongScriptFieldScript script = leafFactory.newInstance(ctx);\n+                DocIdSetIterator approximation = DocIdSetIterator.all(ctx.reader().maxDoc());\n+                TwoPhaseIterator twoPhase = new TwoPhaseIterator(approximation) {\n+                    @Override\n+                    public boolean matches() throws IOException {\n+                        script.runForDoc(approximation().docID());\n+                        return AbstractLongScriptFieldQuery.this.matches(script.values(), script.count());\n+                    }\n+\n+                    @Override\n+                    public float matchCost() {\n+                        // TODO we don't have a good way of estimating the complexity of the script so we just go with 9000\n+                        return 9000f;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQzOTc3Mg==", "bodyText": "I would be fine with even printing the getSimpleName", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456439772", "createdAt": "2020-07-17T13:24:55Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/LongScriptFieldExistsQuery.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.query;\n+\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+\n+public class LongScriptFieldExistsQuery extends AbstractLongScriptFieldQuery {\n+    public LongScriptFieldExistsQuery(Script script, LongScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n+        super(script, leafFactory, fieldName);\n+    }\n+\n+    @Override\n+    protected boolean matches(long[] values, int count) {\n+        return count > 0;\n+    }\n+\n+    @Override\n+    public final String toString(String field) {\n+        if (fieldName().contentEquals(field)) {\n+            return \"ScriptFieldExists\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MTU4OA==", "bodyText": "we are going to have ton of conflicts here with #59672, but I like the direction :)", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456441588", "createdAt": "2020-07-17T13:28:01Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptFieldMapperTests.java", "diffHunk": "@@ -93,27 +95,43 @@ public void testStoredScriptsAreNotSupported() throws Exception {\n         );\n     }\n \n-    public void testDefaultMapping() throws Exception {\n-        XContentBuilder mapping = XContentFactory.jsonBuilder()\n-            .startObject()\n-            .startObject(\"_doc\")\n-            .startObject(\"properties\")\n-            .startObject(\"field\")\n-            .field(\"type\", \"script\")\n-            .field(\"runtime_type\", randomFrom(SUPPORTED_RUNTIME_TYPES))\n-            .startObject(\"script\")\n-            .field(\"source\", \"value('test')\")\n-            .field(\"lang\", \"test\")\n-            .endObject()\n-            .endObject()\n-            .endObject()\n-            .endObject()\n-            .endObject();\n+    public void testKeyword() throws IOException {\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping(\"keyword\")).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(ScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping(\"keyword\")), Strings.toString(mapperService.documentMapper()));\n+    }\n \n-        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping).mapperService();\n+    public void testLong() throws IOException {\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping(\"long\")).mapperService();\n         FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n         assertThat(mapper, instanceOf(ScriptFieldMapper.class));\n-        assertEquals(Strings.toString(mapping), Strings.toString(mapperService.documentMapper()));\n+        assertEquals(Strings.toString(mapping(\"long\")), Strings.toString(mapperService.documentMapper()));\n+    }\n+\n+    private XContentBuilder mapping(String type) throws IOException {\n+        XContentBuilder mapping = XContentFactory.jsonBuilder().startObject();\n+        {\n+            mapping.startObject(\"_doc\");\n+            {\n+                mapping.startObject(\"properties\");\n+                {\n+                    mapping.startObject(\"field\");\n+                    {\n+                        mapping.field(\"type\", \"script\").field(\"runtime_type\", type);\n+                        mapping.startObject(\"script\");\n+                        {\n+                            mapping.field(\"source\", \"dummy_source\").field(\"lang\", \"test\");\n+                        }\n+                        mapping.endObject();\n+                    }\n+                    mapping.endObject();\n+                }\n+                mapping.endObject();\n+            }\n+            mapping.endObject();\n+        }\n+        return mapping.endObject();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MjE2MQ==", "bodyText": "shall we have a test for aggs and a test for term query that use script params?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456442161", "createdAt": "2020-07-17T13:29:03Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptLongMappedFieldTypeTests.java", "diffHunk": "@@ -0,0 +1,148 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.document.StoredField;\n+import org.apache.lucene.index.DirectoryReader;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.RandomIndexWriter;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.apache.lucene.search.Collector;\n+import org.apache.lucene.search.IndexSearcher;\n+import org.apache.lucene.search.LeafCollector;\n+import org.apache.lucene.search.MatchAllDocsQuery;\n+import org.apache.lucene.search.Scorable;\n+import org.apache.lucene.search.ScoreMode;\n+import org.apache.lucene.store.Directory;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.Version;\n+import org.elasticsearch.cluster.metadata.IndexMetadata;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.IndexSettings;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.painless.PainlessPlugin;\n+import org.elasticsearch.plugins.ExtensiblePlugin.ExtensionLoader;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.script.ScriptModule;\n+import org.elasticsearch.script.ScriptService;\n+import org.elasticsearch.xpack.runtimefields.LongScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.RuntimeFields;\n+import org.elasticsearch.xpack.runtimefields.RuntimeFieldsPainlessExtension;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptLongFieldData;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.function.BiConsumer;\n+\n+import static java.util.Collections.emptyMap;\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class ScriptLongMappedFieldTypeTests extends AbstractScriptMappedFieldTypeTestCase {\n+    public void testDocValues() throws IOException {\n+        try (Directory directory = newDirectory(); RandomIndexWriter iw = new RandomIndexWriter(random(), directory)) {\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": [1]}\"))));\n+            iw.addDocument(List.of(new StoredField(\"_source\", new BytesRef(\"{\\\"foo\\\": [2, 1]}\"))));\n+            List<Long> results = new ArrayList<>();\n+            try (DirectoryReader reader = iw.getReader()) {\n+                IndexSearcher searcher = newSearcher(reader);\n+                ScriptLongMappedFieldType ft = build(\"for (def v : source.foo) {value(v)}\");\n+                IndexMetadata imd = IndexMetadata.builder(\"test\")\n+                    .settings(Settings.builder().put(\"index.version.created\", Version.CURRENT))\n+                    .numberOfShards(1)\n+                    .numberOfReplicas(1)\n+                    .build();\n+                ScriptLongFieldData ifd = ft.fielddataBuilder(\"test\").build(new IndexSettings(imd, Settings.EMPTY), ft, null, null, null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjQ0MjUwNw==", "bodyText": "why this?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456442507", "createdAt": "2020-07-17T13:29:37Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/10_keyword.yml", "diffHunk": "@@ -14,7 +14,7 @@ setup:\n               temperature:\n                 type: long\n               voltage:\n-                type: float\n+                type: double", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ff1e756de5c87f130f5514d5ea94b46bbeb50fc"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5ea47aa794360fde4c9ca4c6af5a20ebf3040b1", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5ea47aa794360fde4c9ca4c6af5a20ebf3040b1", "committedDate": "2020-07-17T16:57:20Z", "message": "Merge branch 'feature/runtime_fields' into script_field_long_1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66f11a0ca071e3403f453cb145d21a3b610a5791", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/66f11a0ca071e3403f453cb145d21a3b610a5791", "committedDate": "2020-07-17T17:19:41Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1763c20dea8df05bafa2bb9a7813b2d27267ddd7", "committedDate": "2020-07-17T17:36:28Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg1Njk3", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450885697", "createdAt": "2020-07-17T18:51:31Z", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1MTozMlrOGzdusQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1MTozMlrOGzdusQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxNzY0OQ==", "bodyText": "thanks! that was my bad after all :D", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456617649", "createdAt": "2020-07-17T18:51:32Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/StringScriptFieldScript.java", "diffHunk": "@@ -35,7 +35,7 @@\n         StringScriptFieldScript newInstance(LeafReaderContext ctx) throws IOException;\n     }\n \n-    protected final List<String> results = new ArrayList<>();\n+    private final List<String> results = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg2Njg1", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450886685", "createdAt": "2020-07-17T18:53:13Z", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1MzoxM1rOGzdxow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1MzoxM1rOGzdxow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxODQwMw==", "bodyText": "I no longer remember what this TODO is about. what can we do to address it? and what do we need this method for, again?", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456618403", "createdAt": "2020-07-17T18:53:13Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.common.xcontent.ToXContent.Params;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.index.mapper.MappedFieldType;\n+import org.elasticsearch.index.mapper.TextSearchInfo;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import static org.elasticsearch.search.SearchService.ALLOW_EXPENSIVE_QUERIES;\n+\n+/**\n+ * Abstract base {@linkplain MappedFieldType} for scripted fields.\n+ */\n+abstract class AbstractScriptMappedFieldType extends MappedFieldType {\n+    protected final Script script;\n+\n+    AbstractScriptMappedFieldType(String name, Script script, Map<String, String> meta) {\n+        super(name, false, false, TextSearchInfo.NONE, meta);\n+        this.script = script;\n+    }\n+\n+    protected abstract String runtimeType();\n+\n+    void mapperXContentBody(XContentBuilder builder, Params params) throws IOException {\n+        builder.field(\"runtime_type\", runtimeType());\n+        builder.field(\"script\", script.getIdOrCode()); // TODO For some reason this doesn't allow us to do the full xcontent of the script.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg3MjY3", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450887267", "createdAt": "2020-07-17T18:54:11Z", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1NDoxMVrOGzdzaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1NDoxMVrOGzdzaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYxODg1OQ==", "bodyText": "++ thanks!", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456618859", "createdAt": "2020-07-17T18:54:11Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptKeywordMappedFieldType.java", "diffHunk": "@@ -32,27 +27,30 @@\n import org.elasticsearch.xpack.runtimefields.query.StringScriptFieldTermsQuery;\n import org.elasticsearch.xpack.runtimefields.query.StringScriptFieldWildcardQuery;\n \n-import java.io.IOException;\n import java.time.ZoneId;\n import java.util.List;\n import java.util.Map;\n import java.util.Objects;\n import java.util.Set;\n \n import static java.util.stream.Collectors.toSet;\n-import static org.elasticsearch.search.SearchService.ALLOW_EXPENSIVE_QUERIES;\n \n-public final class RuntimeKeywordMappedFieldType extends MappedFieldType {\n+public final class ScriptKeywordMappedFieldType extends AbstractScriptMappedFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODg5NzQ4", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450889748", "createdAt": "2020-07-17T18:58:21Z", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1ODoyMVrOGzd7Og==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xN1QxODo1ODoyMVrOGzd7Og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjYyMDg1OA==", "bodyText": "maybe adding one of these methods could even be automatic once a new supported field type is added to the map? not sure that it's important now though", "url": "https://github.com/elastic/elasticsearch/pull/59721#discussion_r456620858", "createdAt": "2020-07-17T18:58:21Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptFieldMapperTests.java", "diffHunk": "@@ -106,46 +107,32 @@ public void testStoredScriptsAreNotSupported() throws Exception {\n     }\n \n     public void testUnsupportedRuntimeType() throws Exception {\n-        XContentBuilder mapping = XContentFactory.jsonBuilder()\n-            .startObject()\n-            .startObject(\"_doc\")\n-            .startObject(\"properties\")\n-            .startObject(\"field\")\n-            .field(\"type\", \"script\")\n-            .field(\"runtime_type\", \"unsupported\")\n-            .startObject(\"script\")\n-            .field(\"source\", \"keyword('test')\")\n-            .field(\"lang\", \"test\")\n-            .endObject()\n-            .endObject()\n-            .endObject()\n-            .endObject()\n-            .endObject();\n-\n-        MapperParsingException exc = expectThrows(MapperParsingException.class, () -> createIndex(\"test\", Settings.EMPTY, mapping));\n+        MapperParsingException exc = expectThrows(\n+            MapperParsingException.class,\n+            () -> createIndex(\"test\", Settings.EMPTY, mapping(\"unsupported\"))\n+        );\n         assertEquals(\"Failed to parse mapping: runtime_type [unsupported] not supported\", exc.getMessage());\n     }\n \n+    public void testKeyword() throws IOException {\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping(\"keyword\")).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(ScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping(\"keyword\")), Strings.toString(mapperService.documentMapper()));\n+    }\n+\n+    public void testLong() throws IOException {\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping(\"long\")).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(ScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping(\"long\")), Strings.toString(mapperService.documentMapper()));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "originalPosition": 60}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUwODkwNTk5", "url": "https://github.com/elastic/elasticsearch/pull/59721#pullrequestreview-450890599", "createdAt": "2020-07-17T18:59:44Z", "commit": {"oid": "1763c20dea8df05bafa2bb9a7813b2d27267ddd7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4291, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}