{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY4NjE5NDk3", "number": 61183, "title": "Some Optimizations around BytesArray", "bodyText": "Faster equals and hashCode for BytesArray which is nice since with this change we use it for the search cache\nLighter StreamInput for BytesArray that should save memory and some indirection relative to the one on the abstract bytes reference\nLighter writeTo implementation\nBuild a BytesArray instead of a PagedBytesReference whenever possible to save indirection and memory", "createdAt": "2020-08-17T06:30:50Z", "url": "https://github.com/elastic/elasticsearch/pull/61183", "merged": true, "mergeCommit": {"oid": "d070c99d4fe1aec29dacfea771e0a08b44e54628"}, "closed": true, "closedAt": "2020-08-25T04:29:45Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc_sb-AgH2gAyNDY4NjE5NDk3Ojc1MDBjNzI1N2MyZDU4NzgwMzFjYTE4ZTBkMDMxNzhiMjVhNTM3NDU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCPTegAFqTQ3NDEyMjU0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7500c7257c2d5878031ca18e0d03178b25a53745", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7500c7257c2d5878031ca18e0d03178b25a53745", "committedDate": "2020-08-17T06:29:41Z", "message": "Some Optimizations around BytesArray\n\n* Faster `equals` and `hashCode` for `BytesArray` which is nice since with this change we use it for the search cache\n* Lighter `StreamInput` for `BytesArray` that should save memory and some indirection relative to the one on the abstract bytes reference\n* Lighter `writeTo` implementation\n* Build a `BytesArray` instead of a PagedBytesReference whenever possible to save indirection and memory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "269e6546f703ec5e35cd36726cd96ac033c36598", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/269e6546f703ec5e35cd36726cd96ac033c36598", "committedDate": "2020-08-17T07:23:52Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjI1OTU5", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-468225959", "createdAt": "2020-08-17T07:25:01Z", "commit": {"oid": "7500c7257c2d5878031ca18e0d03178b25a53745"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNTowMVrOHBdQfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNTowMVrOHBdQfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI4OTk4MA==", "bodyText": "I think this is well worth the optimization to not allocating anything for equals and hashCode since we use BytesArray as keys in request caches.", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r471289980", "createdAt": "2020-08-17T07:25:01Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/BytesArray.java", "diffHunk": "@@ -67,6 +71,33 @@ public int length() {\n         return length;\n     }\n \n+    @Override\n+    public int hashCode() {\n+        // NOOP override to satisfy Checkstyle's EqualsHashCode\n+        return super.hashCode();\n+    }\n+\n+    @Override\n+    protected int calculateHashCode() {\n+        int result = 1;\n+        for (int i = 0; i < length; i++) {\n+            result = 31 * result + bytes[offset + i];\n+        }\n+        return result;\n+    }\n+\n+    @Override\n+    public boolean equals(Object other) {\n+        if (this == other) {\n+            return true;\n+        }\n+        if (other instanceof BytesArray) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7500c7257c2d5878031ca18e0d03178b25a53745"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjI2NDc0", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-468226474", "createdAt": "2020-08-17T07:25:53Z", "commit": {"oid": "269e6546f703ec5e35cd36726cd96ac033c36598"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNTo1M1rOHBdSZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNTo1M1rOHBdSZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MDQ2OA==", "bodyText": "Taking advantage of the now cheaper writeTo for the BytesArray + this is always cheaper since we never cleverly batch up writes from multiple components anyway", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r471290468", "createdAt": "2020-08-17T07:25:53Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/CompositeBytesReference.java", "diffHunk": "@@ -187,6 +188,13 @@ public BytesRef next() throws IOException {\n         };\n     }\n \n+    @Override\n+    public void writeTo(OutputStream os) throws IOException {\n+        for (BytesReference reference : references) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "269e6546f703ec5e35cd36726cd96ac033c36598"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MjI2OTY2", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-468226966", "createdAt": "2020-08-17T07:26:45Z", "commit": {"oid": "269e6546f703ec5e35cd36726cd96ac033c36598"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNjo0NlrOHBdUCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QwNzoyNjo0NlrOHBdUCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTI5MDg5MA==", "bodyText": "Why have another step going to the byte[] through ByteArray when we don't have to, especially with the new optimizations for that case in here.", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r471290890", "createdAt": "2020-08-17T07:26:46Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/PagedBytesReference.java", "diffHunk": "@@ -39,11 +39,18 @@\n     private final int offset;\n     private final int length;\n \n-    public PagedBytesReference(ByteArray byteArray, int length) {\n-        this(byteArray, 0, length);\n+    public static BytesReference of(ByteArray byteArray, int length) {\n+        if (length == 0) {\n+            return BytesArray.EMPTY;\n+        }\n+        if (byteArray.hasArray()) {\n+            return new BytesArray(byteArray.array(), 0, length);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "269e6546f703ec5e35cd36726cd96ac033c36598"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f3f7ed986da0770397386bb951f5a45aa9dc4ae", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f3f7ed986da0770397386bb951f5a45aa9dc4ae", "committedDate": "2020-08-17T07:30:19Z", "message": "obsolete null check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY4MzQyMTE4", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-468342118", "createdAt": "2020-08-17T10:21:06Z", "commit": {"oid": "7f3f7ed986da0770397386bb951f5a45aa9dc4ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMDoyMTowNlrOHBi8AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xN1QxMDoyMTowNlrOHBi8AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MTM4MzA0MQ==", "bodyText": "assert false here, we shouldn't be calling this?", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r471383041", "createdAt": "2020-08-17T10:21:06Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/common/util/BigByteArray.java", "diffHunk": "@@ -127,6 +127,16 @@ public void fill(long fromIndex, long toIndex, byte value) {\n         }\n     }\n \n+    @Override\n+    public boolean hasArray() {\n+        return false;\n+    }\n+\n+    @Override\n+    public byte[] array() {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f3f7ed986da0770397386bb951f5a45aa9dc4ae"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f739cb620c06e4218af35fc579ddaa93bf0dc5c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f739cb620c06e4218af35fc579ddaa93bf0dc5c", "committedDate": "2020-08-17T10:38:58Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae645bc6cfd20d227bfceee3beaef67bc41d887e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae645bc6cfd20d227bfceee3beaef67bc41d887e", "committedDate": "2020-08-17T10:39:45Z", "message": "assert false"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5ODk0NDg3", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-469894487", "createdAt": "2020-08-18T23:22:38Z", "commit": {"oid": "ae645bc6cfd20d227bfceee3beaef67bc41d887e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzoyMjozOVrOHCp9XA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQyMzoyMjozOVrOHCp9XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjU0NjY1Mg==", "bodyText": "Why did this change?", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r472546652", "createdAt": "2020-08-18T23:22:39Z", "author": {"login": "tbrooks8"}, "path": "server/src/test/java/org/elasticsearch/common/io/stream/BytesStreamsTests.java", "diffHunk": "@@ -796,7 +796,7 @@ public void testReadCorruptedArraySize() throws IOException {\n                     assertEquals(i, ints[i]);\n                 }\n                 EOFException eofException = expectThrows(EOFException.class, () -> streamInput.readIntArray());\n-                assertEquals(\"tried to read: 100 bytes but only 40 remaining\", eofException.getMessage());\n+                assertEquals(\"tried to read: 100 bytes but this stream is limited to: 82\", eofException.getMessage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae645bc6cfd20d227bfceee3beaef67bc41d887e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24be3e7ae6fbbcec357b61cfb356916ea2cf3deb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/24be3e7ae6fbbcec357b61cfb356916ea2cf3deb", "committedDate": "2020-08-19T07:06:13Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f447eb7428f9b4654b22ee6a0226cb17586216b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f447eb7428f9b4654b22ee6a0226cb17586216b", "committedDate": "2020-08-19T07:22:10Z", "message": "revert hashcode change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "33ecd9c2608ad0cbfeae2781fc5a2f202b1eb3e1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/33ecd9c2608ad0cbfeae2781fc5a2f202b1eb3e1", "committedDate": "2020-08-19T09:41:23Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25afc12af530bf4717fd0ebd056299b8956d39b3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/25afc12af530bf4717fd0ebd056299b8956d39b3", "committedDate": "2020-08-19T10:06:49Z", "message": "CR: less trappy page BR construction"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwMzIzMDM0", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-470323034", "createdAt": "2020-08-19T10:22:56Z", "commit": {"oid": "25afc12af530bf4717fd0ebd056299b8956d39b3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMDoyMjo1NlrOHDA_OQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxMDoyMjo1NlrOHDA_OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjkyMzk2MQ==", "bodyText": "Just to remind me when I inevitably trip over this in future...\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assert byteArray.hasArray() == false;\n          \n          \n            \n                    assert byteArray.hasArray() == false : \"use BytesReference#fromByteArray\";", "url": "https://github.com/elastic/elasticsearch/pull/61183#discussion_r472923961", "createdAt": "2020-08-19T10:22:56Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/PagedBytesReference.java", "diffHunk": "@@ -39,11 +39,8 @@\n     private final int offset;\n     private final int length;\n \n-    public PagedBytesReference(ByteArray byteArray, int length) {\n-        this(byteArray, 0, length);\n-    }\n-\n-    private PagedBytesReference(ByteArray byteArray, int from, int length) {\n+    PagedBytesReference(ByteArray byteArray, int from, int length) {\n+        assert byteArray.hasArray() == false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25afc12af530bf4717fd0ebd056299b8956d39b3"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b47de757bb73ad61d6c744a6940958089a8a2bb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6b47de757bb73ad61d6c744a6940958089a8a2bb", "committedDate": "2020-08-19T10:37:03Z", "message": "Update server/src/main/java/org/elasticsearch/common/bytes/PagedBytesReference.java\n\nCo-authored-by: David Turner <david.turner@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34e1580db4dd8a69710d215dc109cf6a34911411", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/34e1580db4dd8a69710d215dc109cf6a34911411", "committedDate": "2020-08-24T17:21:38Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d9d2ac5434bfd332399a4c45c08915dae5425aa3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9d2ac5434bfd332399a4c45c08915dae5425aa3", "committedDate": "2020-08-24T17:20:08Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}, "afterCommit": {"oid": "34e1580db4dd8a69710d215dc109cf6a34911411", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/34e1580db4dd8a69710d215dc109cf6a34911411", "committedDate": "2020-08-24T17:21:38Z", "message": "Merge remote-tracking branch 'elastic/master' into bytes-array-optimizations"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc0MTIyNTQ4", "url": "https://github.com/elastic/elasticsearch/pull/61183#pullrequestreview-474122548", "createdAt": "2020-08-25T04:14:56Z", "commit": {"oid": "34e1580db4dd8a69710d215dc109cf6a34911411"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4855, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}