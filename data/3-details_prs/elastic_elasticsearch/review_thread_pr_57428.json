{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI2MDIzMzg4", "number": 57428, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjo0MjowM1rOEBb3lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozMTowN1rOEBeBRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTQwNjMwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjo0MjowM1rOGdR6MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjo0MjowM1rOGdR6MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1NTMxMw==", "bodyText": "I'd prefer calling the method simply limit - it's not really wrapping but instead adding a new node to the tree.", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433355313", "createdAt": "2020-06-01T16:42:03Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "diffHunk": "@@ -243,4 +258,8 @@ public LogicalPlan visitTableName(TableNameContext ctx) {\n         TableIdentifier tableIdentifier = visitTableIdentifier(ctx.tableIdentifier());\n         return new UnresolvedRelation(source(ctx), tableIdentifier, alias, ctx.FROZEN() != null);\n     }\n+\n+    private Limit wrapWithLimit(LogicalPlan plan, Source source, Token limit) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4563cf8beb4b18fb7171bd6402c0388ad2d19e44"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTY2NTQxOnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/language/syntax/commands/select.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODowMTo1NFrOGdUgSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozMDozNFrOGdVaSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5NzgzMg==", "bodyText": "I think fewer goes better with matches.", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433397832", "createdAt": "2020-06-01T18:01:54Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/language/syntax/commands/select.asciidoc", "diffHunk": "@@ -371,26 +371,52 @@ all are equally relevant.\n [[sql-syntax-limit]]\n ==== LIMIT\n \n-The `LIMIT` clause restricts (limits) the number of rows returns using the format:\n+The `LIMIT` clause restricts (limits) the number of rows returned using the format:\n \n [source, sql]\n ----\n-LIMIT ( count | ALL )\n+LIMIT ( <count> | ALL )\n ----\n \n where\n \n-count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches than the limit). If `0` is specified, no results are returned.\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches\n+than the limit). If `0` is specified, no results are returned.\n \n ALL:: indicates there is no limit and thus all results are being returned.\n \n-To return \n-\n [source, sql]\n ----\n include-tagged::{sql-specs}/docs/docs.csv-spec[limitBasic]\n ----\n \n+[NOTE]\n+<<sql-syntax-top, `TOP`>> and <<sql-syntax-limit, `LIMIT`>> cannot be used in combination in the same query and error is returned.\n+\n+\n+[[sql-syntax-top]]\n+==== TOP\n+\n+The `TOP` clause restricts (limits) the number of rows returned using the format:\n+\n+[source, sql]\n+----\n+SELECT TOP <count> <list of fields> ...\n+----\n+\n+where\n+\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15e739f5ffc00d0aa377b794e16ca699034ab490"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMjY4Mw==", "bodyText": "Was a copy from LIMIT, so fixing it there as well.", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433412683", "createdAt": "2020-06-01T18:30:34Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/language/syntax/commands/select.asciidoc", "diffHunk": "@@ -371,26 +371,52 @@ all are equally relevant.\n [[sql-syntax-limit]]\n ==== LIMIT\n \n-The `LIMIT` clause restricts (limits) the number of rows returns using the format:\n+The `LIMIT` clause restricts (limits) the number of rows returned using the format:\n \n [source, sql]\n ----\n-LIMIT ( count | ALL )\n+LIMIT ( <count> | ALL )\n ----\n \n where\n \n-count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches than the limit). If `0` is specified, no results are returned.\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches\n+than the limit). If `0` is specified, no results are returned.\n \n ALL:: indicates there is no limit and thus all results are being returned.\n \n-To return \n-\n [source, sql]\n ----\n include-tagged::{sql-specs}/docs/docs.csv-spec[limitBasic]\n ----\n \n+[NOTE]\n+<<sql-syntax-top, `TOP`>> and <<sql-syntax-limit, `LIMIT`>> cannot be used in combination in the same query and error is returned.\n+\n+\n+[[sql-syntax-top]]\n+==== TOP\n+\n+The `TOP` clause restricts (limits) the number of rows returned using the format:\n+\n+[source, sql]\n+----\n+SELECT TOP <count> <list of fields> ...\n+----\n+\n+where\n+\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5NzgzMg=="}, "originalCommit": {"oid": "15e739f5ffc00d0aa377b794e16ca699034ab490"}, "originalPosition": 71}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTY2ODY5OnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/language/syntax/commands/select.asciidoc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODowMjo1M1rOGdUiZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODowMjo1M1rOGdUiZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5ODM3NQ==", "bodyText": "...cannot be used together in the same query and an error is returned otherwise sounds better? If so, same sentence was used for LIMIT and the change is needed there as well.", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433398375", "createdAt": "2020-06-01T18:02:53Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/language/syntax/commands/select.asciidoc", "diffHunk": "@@ -371,26 +371,52 @@ all are equally relevant.\n [[sql-syntax-limit]]\n ==== LIMIT\n \n-The `LIMIT` clause restricts (limits) the number of rows returns using the format:\n+The `LIMIT` clause restricts (limits) the number of rows returned using the format:\n \n [source, sql]\n ----\n-LIMIT ( count | ALL )\n+LIMIT ( <count> | ALL )\n ----\n \n where\n \n-count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches than the limit). If `0` is specified, no results are returned.\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches\n+than the limit). If `0` is specified, no results are returned.\n \n ALL:: indicates there is no limit and thus all results are being returned.\n \n-To return \n-\n [source, sql]\n ----\n include-tagged::{sql-specs}/docs/docs.csv-spec[limitBasic]\n ----\n \n+[NOTE]\n+<<sql-syntax-top, `TOP`>> and <<sql-syntax-limit, `LIMIT`>> cannot be used in combination in the same query and error is returned.\n+\n+\n+[[sql-syntax-top]]\n+==== TOP\n+\n+The `TOP` clause restricts (limits) the number of rows returned using the format:\n+\n+[source, sql]\n+----\n+SELECT TOP <count> <list of fields> ...\n+----\n+\n+where\n+\n+count:: is a positive integer or zero indicating the maximum *possible* number of results being returned (as there might be less matches\n+than the limit). If `0` is specified, no results are returned.\n+\n+[source, sql]\n+----\n+include-tagged::{sql-specs}/docs/docs.csv-spec[topBasic]\n+----\n+\n+[NOTE]\n+<<sql-syntax-top, `TOP`>> and <<sql-syntax-limit, `LIMIT`>> cannot be used in combination in the same query and error is returned.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15e739f5ffc00d0aa377b794e16ca699034ab490"}, "originalPosition": 80}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTY3NjQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODowNTozMFrOGdUnjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODowNTozMFrOGdUnjg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM5OTY5NA==", "bodyText": "Why not combining all three conditions in the same if?  More readable this way?", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433399694", "createdAt": "2020-06-01T18:05:30Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "diffHunk": "@@ -155,6 +158,15 @@ else if (!selectTarget.isEmpty()) {\n         if (ctx.setQuantifier() != null && ctx.setQuantifier().DISTINCT() != null) {\n             query = new Distinct(source(ctx.setQuantifier()), query);\n         }\n+\n+        // TOP\n+        SqlBaseParser.TopClauseContext topClauseContext = ctx.topClause();\n+        if (topClauseContext != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15e739f5ffc00d0aa377b794e16ca699034ab490"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTc1ODc4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozMTowN1rOGdVbbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxODozMTowN1rOGdVbbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzQxMjk3Mg==", "bodyText": "I would rephrase the error a bit - TOP and LIMIT are not allowed in the same query - use one or the other.", "url": "https://github.com/elastic/elasticsearch/pull/57428#discussion_r433412972", "createdAt": "2020-06-01T18:31:07Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/LogicalPlanBuilder.java", "diffHunk": "@@ -105,8 +105,11 @@ public LogicalPlan visitQueryNoWith(QueryNoWithContext ctx) {\n         if (limitClause != null) {\n             Token limit = limitClause.limit;\n             if (limit != null && limitClause.INTEGER_VALUE() != null) {\n-                plan = new Limit(source(limitClause), new Literal(source(limitClause),\n-                        Integer.parseInt(limit.getText()), DataTypes.INTEGER), plan);\n+                if (plan instanceof Limit) {\n+                    throw new ParsingException(source(limitClause), \"Cannot use both TOP and LIMIT in the same query\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15e739f5ffc00d0aa377b794e16ca699034ab490"}, "originalPosition": 7}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3809, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}