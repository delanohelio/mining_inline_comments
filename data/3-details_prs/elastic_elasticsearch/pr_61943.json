{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc4NzgxMDEx", "number": 61943, "title": "[ML] Add incremental id during data frame analytics reindexing", "bodyText": "Previously, we added a copy of the _id during reindexing and sorted\nthe destination index on that. This allowed us to traverse the docs in the\ndestination index in a stable order multiple times and with efficiency.\nHowever, the destination index being sorted means we cannot have nested\ntyped fields. This is a problem as it does not allow us to provide\na good experience with our evaluate API when it comes to computing\nmetrics for specific classes, features, etc.\nThis commit changes the approach in order to result to a destination\nindex that allows nested fields.\nInstead of adding a copy of the _id field, we now add an incremental\nid that we can use to traverse the docs in a stable order. We also\nensure we always assign the same incremental id to the same doc from\nthe source indices by sorting on _seq_no during reindexing. That\nin combination with the reindexing API using scroll gives us a stable\norder as scroll uses the (_index, _doc, shard_id) tuple to resolve ties.\nThe extractor now does not need to scroll. Instead we sort on the incremental\nid and we do ranged searches to avoid the sort-all-docs overhead.\nFinally, the TestDocsIterator is simply changed to search_after the incremental id.\nWith these changes data frame analytics jobs do not use scroll at any part.\nHaving all these in place, the commit adds the nested types to the necessary\nfields of classification and regression analyses results.", "createdAt": "2020-09-03T17:31:10Z", "url": "https://github.com/elastic/elasticsearch/pull/61943", "merged": true, "mergeCommit": {"oid": "5d1be250e9f8e8fca8a593e22f5afc44733006f5"}, "closed": true, "closedAt": "2020-09-04T08:45:05Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdFT-e3AH2gAyNDc4NzgxMDExOjVkMWQyYWYxMTBhNDQ5YTNjODg4ZDZjM2RmMTQ5NmY0MzhiODE2NjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdFUa1UAH2gAyNDc4NzgxMDExOmE3OTRjY2FkNzVlOGZlNWVhMzcwODAzNDU5ZWQ0MjFhMTljYmZlNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d1d2af110a449a3c888d6c3df1496f438b81665", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d1d2af110a449a3c888d6c3df1496f438b81665", "committedDate": "2020-09-03T17:23:18Z", "message": "[ML] Add incremental id during data frame analytics reindexing\n\nPreviously, we added a copy of the `_id` during reindexing and sorted\nthe destination index on that. This allowed us to traverse the docs in the\ndestination index in a stable order multiple times and with efficiency.\nHowever, the destination index being sorted means we cannot have `nested`\ntyped fields. This is a problem as it does not allow us to provide\na good experience with our evaluate API when it comes to computing\nmetrics for specific classes, features, etc.\n\nThis commit changes the approach in order to result to a destination\nindex that allows nested fields.\n\nInstead of adding a copy of the `_id` field, we now add an incremental\nid that we can use to traverse the docs in a stable order. We also\nensure we always assign the same incremental id to the same doc from\nthe source indices by sorting on `_seq_no` during reindexing. That\nin combination with the reindexing API using scroll gives us a stable\norder as scroll uses the (`_index`, `_doc`, shard_id) tuple to resolve ties.\n\nThe extractor now does not need to scroll. Instead we sort on the incremental\nid and we do ranged searches to avoid the sort-all-docs overhead.\n\nFinally, the `TestDocsIterator` is simply changed to search_after the incremental id.\n\nWith these changes data frame analytics jobs do not use scroll at any part.\n\nHaving all these in place, the commit adds the `nested` types to the necessary\nfields of `classification` and `regression` analyses results."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88b2b43aade2579f50f31e6fadad8d5e86651a00", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/88b2b43aade2579f50f31e6fadad8d5e86651a00", "committedDate": "2020-09-03T17:51:34Z", "message": "Move classification/regression feature importance mappings to respective classes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMDYxMTgz", "url": "https://github.com/elastic/elasticsearch/pull/61943#pullrequestreview-482061183", "createdAt": "2020-09-03T17:37:05Z", "commit": {"oid": "5d1d2af110a449a3c888d6c3df1496f438b81665"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzozNzowNVrOHMw7ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxNzozNzowNVrOHMw7ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzE0NjYwMg==", "bodyText": "This is a tad nuanced. Could you add a comment here explaining the indirection for object reference reuse in the script parameters?", "url": "https://github.com/elastic/elasticsearch/pull/61943#discussion_r483146602", "createdAt": "2020-09-03T17:37:05Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsManager.java", "diffHunk": "@@ -263,11 +268,25 @@ private void reindexDataframeAndStartAnalysis(DataFrameAnalyticsTask task, DataF\n                 reindexRequest.setRefresh(true);\n                 reindexRequest.setSourceIndices(config.getSource().getIndex());\n                 reindexRequest.setSourceQuery(config.getSource().getParsedQuery());\n+                reindexRequest.getSearchRequest().allowPartialSearchResults(false);\n                 reindexRequest.getSearchRequest().source().fetchSource(config.getSource().getSourceFiltering());\n+                reindexRequest.getSearchRequest().source().sort(SeqNoFieldMapper.NAME, SortOrder.ASC);\n                 reindexRequest.setDestIndex(config.getDest().getIndex());\n-                reindexRequest.setScript(new Script(\"ctx._source.\" + DestinationIndex.ID_COPY + \" = ctx._id\"));\n+\n+                // We explicitly set slices to 1 as we cannot parallelize in order to have the incremental id\n+                reindexRequest.setSlices(1);\n+                Map<String, Object> counterValueParam = new HashMap<>();\n+                counterValueParam.put(\"value\", -1);\n+                reindexRequest.setScript(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d1d2af110a449a3c888d6c3df1496f438b81665"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e42303235c0c0af332d5935f2163b035aac9854", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e42303235c0c0af332d5935f2163b035aac9854", "committedDate": "2020-09-03T17:53:48Z", "message": "Add comment on indirection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a794ccad75e8fe5ea370803459ed421a19cbfe63", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a794ccad75e8fe5ea370803459ed421a19cbfe63", "committedDate": "2020-09-03T17:54:16Z", "message": "Merge branch 'master' into add-incremental-id-during-dfa-reindexing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4849, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}