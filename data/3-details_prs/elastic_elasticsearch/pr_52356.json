{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1MzI3OTQ0", "number": 52356, "title": "Implement ILM policy for .ml-state* indices", "bodyText": "This PR adds ILM policy for .ml-state* indices.\nIn case ILM plugin is not available at the time the template is being created, the ILM policy is not created.\nIn case only the legacy .ml-state index exists, the .ml-state-000001 index is created and the write alias (.ml-state-write) is moved from .ml-state to .ml-state-000001 so that rollover can be performed by ILM.\nRelates #29938", "createdAt": "2020-02-14T10:53:40Z", "url": "https://github.com/elastic/elasticsearch/pull/52356", "merged": true, "mergeCommit": {"oid": "9c7b6d191251665f8b38486b21677a4e86f851bd"}, "closed": true, "closedAt": "2020-03-10T09:49:38Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 33, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcENXgMgBqjMwMzgzMTY0MzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcL6YCgABqjMxMDk3Njg0OTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b31366ec0452c94df47420487f3f71b4b1607bfc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b31366ec0452c94df47420487f3f71b4b1607bfc", "committedDate": "2020-02-14T10:51:49Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "5355111743b8197ba4763b8e0f6fcc0d190e717c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5355111743b8197ba4763b8e0f6fcc0d190e717c", "committedDate": "2020-02-14T10:56:06Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5355111743b8197ba4763b8e0f6fcc0d190e717c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5355111743b8197ba4763b8e0f6fcc0d190e717c", "committedDate": "2020-02-14T10:56:06Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "707007eaa35c219f62408ff801eef1e09bb0dbe8", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/707007eaa35c219f62408ff801eef1e09bb0dbe8", "committedDate": "2020-02-17T10:48:01Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "707007eaa35c219f62408ff801eef1e09bb0dbe8", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/707007eaa35c219f62408ff801eef1e09bb0dbe8", "committedDate": "2020-02-17T10:48:01Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "d765bc7fcf5b548ed47b9248181ea3f7187f248b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d765bc7fcf5b548ed47b9248181ea3f7187f248b", "committedDate": "2020-02-17T12:41:32Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d765bc7fcf5b548ed47b9248181ea3f7187f248b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d765bc7fcf5b548ed47b9248181ea3f7187f248b", "committedDate": "2020-02-17T12:41:32Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "121932b56291e3c0056745b5477b789dad463723", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/121932b56291e3c0056745b5477b789dad463723", "committedDate": "2020-02-17T12:49:03Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "121932b56291e3c0056745b5477b789dad463723", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/121932b56291e3c0056745b5477b789dad463723", "committedDate": "2020-02-17T12:49:03Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "1357d19d73e89f361cc74d2b473441fcf9553e51", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1357d19d73e89f361cc74d2b473441fcf9553e51", "committedDate": "2020-02-19T10:37:41Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1357d19d73e89f361cc74d2b473441fcf9553e51", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1357d19d73e89f361cc74d2b473441fcf9553e51", "committedDate": "2020-02-19T10:37:41Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "f5f1bf0d3ce1cc336a36dc8d217efe85cbba2517", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5f1bf0d3ce1cc336a36dc8d217efe85cbba2517", "committedDate": "2020-02-19T10:48:06Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f5f1bf0d3ce1cc336a36dc8d217efe85cbba2517", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5f1bf0d3ce1cc336a36dc8d217efe85cbba2517", "committedDate": "2020-02-19T10:48:06Z", "message": "Implement ILM policy for .ml-state* indices"}, "afterCommit": {"oid": "265623716fd57f22e0f156a6042e8f3a3a7ef31b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/265623716fd57f22e0f156a6042e8f3a3a7ef31b", "committedDate": "2020-02-19T11:39:04Z", "message": "Rename ML_STATE to INITIAL_ML_STATE"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxMDg3MDIy", "url": "https://github.com/elastic/elasticsearch/pull/52356#pullrequestreview-361087022", "createdAt": "2020-02-19T12:57:13Z", "commit": {"oid": "265623716fd57f22e0f156a6042e8f3a3a7ef31b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMjo1NzoxM1rOFrnDUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOVQxMjo1NzoxM1rOFrnDUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTI3MjkxMw==", "bodyText": "There's an edge case here, which is that it's sorting on the concrete index names, and those could have been modified during a major version upgrade.\nFor example, if .ml-state was first created in 5.5 then in 6.8 the migration assistant would have reindexed it to .reindexed-6-ml-state with an alias of .ml-state (in addition to the .ml-state-write alias).  Sorting in reverse would put . reindexed-6-ml-state before .ml-state-000042.\nIt would be safer to create a custom comparator that extracts the last 6 digits from the name for concrete names that end with a dash followed by 6 digits, and 000000 otherwise.", "url": "https://github.com/elastic/elasticsearch/pull/52356#discussion_r381272913", "createdAt": "2020-02-19T12:57:13Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/persistence/AnomalyDetectorsIndex.java", "diffHunk": "@@ -89,64 +107,105 @@ public static String configIndexName() {\n     }\n \n     /**\n-     * Create the .ml-state index (if necessary)\n-     * Create the .ml-state-write alias for the .ml-state index (if necessary)\n+     * Creates the .ml-state-000001 index (if necessary)\n+     * Creates the .ml-state-write alias for the .ml-state-000001 index (if necessary)\n      */\n     public static void createStateIndexAndAliasIfNecessary(Client client, ClusterState state, final ActionListener<Boolean> finalListener) {\n-\n-        if (state.getMetaData().getAliasAndIndexLookup().containsKey(jobStateIndexWriteAlias())) {\n-            finalListener.onResponse(false);\n-            return;\n+        IndexNameExpressionResolver indexNameExpressionResolver = new IndexNameExpressionResolver();\n+        String[] stateIndices =\n+            indexNameExpressionResolver.concreteIndexNames(state, IndicesOptions.lenientExpandOpen(), jobStateIndexPattern());\n+        Optional<IndexMetaData> indexPointedByCurrentWriteAlias = state.getMetaData().hasAlias(\".ml-state-write\")\n+            ? state.getMetaData().getAliasAndIndexLookup().get(\".ml-state-write\").getIndices().stream().findFirst()\n+            : Optional.empty();\n+        String legacyJobStateIndex = AnomalyDetectorsIndexFields.STATE_INDEX_PREFIX;\n+\n+        if (stateIndices.length == 0) {\n+            if (indexPointedByCurrentWriteAlias.isEmpty()) {\n+                createInitialStateIndex(client, true, finalListener);\n+                return;\n+            }\n+            logger.error(\n+                \"There are no indices matching '.ml-state*' pattern but '.ml-state-write' alias points at [{}]. \"\n+                + \"This should never happen.\",\n+                indexPointedByCurrentWriteAlias.get());\n+        } else if (stateIndices.length == 1 && stateIndices[0].equals(legacyJobStateIndex)) {\n+            if (indexPointedByCurrentWriteAlias.isEmpty()) {\n+                createInitialStateIndex(client, true, finalListener);\n+                return;\n+            }\n+            if (indexPointedByCurrentWriteAlias.get().getIndex().getName().equals(legacyJobStateIndex)) {\n+                createInitialStateIndex(\n+                    client,\n+                    false,\n+                    ActionListener.wrap(\n+                        unused -> updateStateWriteAlias(client, legacyJobStateIndex, initialJobStateIndex(), finalListener),\n+                        finalListener::onFailure)\n+                );\n+                return;\n+            }\n+            logger.error(\n+                \"There is exactly one index (i.e. '.ml-state') matching '.ml-state*' pattern but '.ml-state-write' alias points at [{}]. \"\n+                + \"This should never happen.\",\n+                indexPointedByCurrentWriteAlias.get());\n+        } else {\n+            if (indexPointedByCurrentWriteAlias.isEmpty()) {\n+                Arrays.sort(stateIndices, Collections.reverseOrder());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "265623716fd57f22e0f156a6042e8f3a3a7ef31b"}, "originalPosition": 108}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1bfc2abcdf8992e4bc39870cffa6e3a709f8d48f", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1bfc2abcdf8992e4bc39870cffa6e3a709f8d48f", "committedDate": "2020-02-20T12:27:39Z", "message": "Implement custom comparator for state index names"}, "afterCommit": {"oid": "1de4e4c168d6fa75bb8f500b27ed9a40421ea1cd", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1de4e4c168d6fa75bb8f500b27ed9a40421ea1cd", "committedDate": "2020-02-20T20:20:07Z", "message": "Implement custom comparator for state index names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1de4e4c168d6fa75bb8f500b27ed9a40421ea1cd", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1de4e4c168d6fa75bb8f500b27ed9a40421ea1cd", "committedDate": "2020-02-20T20:20:07Z", "message": "Implement custom comparator for state index names"}, "afterCommit": {"oid": "379f6c9a1ebf1f6b96ec1444675688a9b3698649", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/379f6c9a1ebf1f6b96ec1444675688a9b3698649", "committedDate": "2020-02-20T20:29:48Z", "message": "Implement custom comparator for state index names"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d98cc7982e1a6dd9a3d6213737b8eb3279034f5a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d98cc7982e1a6dd9a3d6213737b8eb3279034f5a", "committedDate": "2020-02-21T10:21:23Z", "message": "Apply ILM template settings only when ILM plugin is enabled"}, "afterCommit": {"oid": "e0bb5b1693fd68d37be64db5aff1538f2679f693", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0bb5b1693fd68d37be64db5aff1538f2679f693", "committedDate": "2020-02-21T12:01:11Z", "message": "Apply ILM template settings only when ILM plugin is enabled"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2f81554821cddffa2f7e1c8636fd894b7593ddbd", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f81554821cddffa2f7e1c8636fd894b7593ddbd", "committedDate": "2020-02-21T13:04:48Z", "message": "Fix licencing tests"}, "afterCommit": {"oid": "f6d27fffa9c5acd289acd4a7cc5298d29102a67d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6d27fffa9c5acd289acd4a7cc5298d29102a67d", "committedDate": "2020-02-21T14:05:41Z", "message": "Fix MachineLearningLicensingTests and AutodetectProcessManagerTests tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODc0NzMx", "url": "https://github.com/elastic/elasticsearch/pull/52356#pullrequestreview-362874731", "createdAt": "2020-02-21T19:47:06Z", "commit": {"oid": "f6d27fffa9c5acd289acd4a7cc5298d29102a67d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTo0NzowNlrOFtCm0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxOTo0NzowNlrOFtCm0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc3Mjk0Nw==", "bodyText": "What happens if .ml-state-write is a concrete index? I may have missed a logic branch somewhere.", "url": "https://github.com/elastic/elasticsearch/pull/52356#discussion_r382772947", "createdAt": "2020-02-21T19:47:06Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/persistence/AnomalyDetectorsIndex.java", "diffHunk": "@@ -120,60 +138,99 @@ public static String configIndexName() {\n     public static void createStateIndexAndAliasIfNecessary(Client client, ClusterState state, IndexNameExpressionResolver resolver,\n                                                            final ActionListener<Boolean> finalListener) {\n \n-        if (state.getMetaData().getAliasAndIndexLookup().containsKey(jobStateIndexWriteAlias())) {\n-            finalListener.onResponse(false);\n-            return;\n-        }\n+        String[] stateIndices = resolver.concreteIndexNames(state, IndicesOptions.lenientExpandOpen(), jobStateIndexPattern());\n+        Optional<IndexMetaData> indexPointedByCurrentWriteAlias = state.getMetaData().hasAlias(\".ml-state-write\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6d27fffa9c5acd289acd4a7cc5298d29102a67d"}, "originalPosition": 65}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f6d27fffa9c5acd289acd4a7cc5298d29102a67d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6d27fffa9c5acd289acd4a7cc5298d29102a67d", "committedDate": "2020-02-21T14:05:41Z", "message": "Fix MachineLearningLicensingTests and AutodetectProcessManagerTests tests"}, "afterCommit": {"oid": "e1f40611722864e0af620b230393e86b573e5aea", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1f40611722864e0af620b230393e86b573e5aea", "committedDate": "2020-03-03T10:44:21Z", "message": "Adapt the code to the refactoring done in MlIndexAndAlias class"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "574447ebb09c162b419bdf6e64d90b75ff8bef64", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/574447ebb09c162b419bdf6e64d90b75ff8bef64", "committedDate": "2020-03-03T11:58:51Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}, "afterCommit": {"oid": "fdd0b04844d50e67927e6df866ea583078a17ae5", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdd0b04844d50e67927e6df866ea583078a17ae5", "committedDate": "2020-03-03T12:39:14Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "92d8a5f68eab30efde0eec486d68d317eb539602", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/92d8a5f68eab30efde0eec486d68d317eb539602", "committedDate": "2020-03-04T07:39:27Z", "message": "Add some debugging"}, "afterCommit": {"oid": "7d7aa358f34412ec248985b5d05cd987295f84bf", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d7aa358f34412ec248985b5d05cd987295f84bf", "committedDate": "2020-03-04T08:08:45Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d7aa358f34412ec248985b5d05cd987295f84bf", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d7aa358f34412ec248985b5d05cd987295f84bf", "committedDate": "2020-03-04T08:08:45Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}, "afterCommit": {"oid": "a4b35c420700de6d59886033c3178058ce725253", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4b35c420700de6d59886033c3178058ce725253", "committedDate": "2020-03-04T08:28:01Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4b35c420700de6d59886033c3178058ce725253", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4b35c420700de6d59886033c3178058ce725253", "committedDate": "2020-03-04T08:28:01Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}, "afterCommit": {"oid": "95ab96ea4f6fc475a30cea74cfb8c6e8cb9c4c28", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/95ab96ea4f6fc475a30cea74cfb8c6e8cb9c4c28", "committedDate": "2020-03-04T09:13:49Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzEzNjcy", "url": "https://github.com/elastic/elasticsearch/pull/52356#pullrequestreview-369713672", "createdAt": "2020-03-05T16:20:08Z", "commit": {"oid": "63f312369d365b622f76660e439c0ee874c818ae"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoyMDowOVrOFyaS9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoyMDowOVrOFyaS9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzk1OQ==", "bodyText": "What is the scope of the name state_index_ilm_policy here (the first argument)?  Is it local to the ML plugin or is it global across the whole of Elasticsearch?  If it is global I think it should be changed to ml_state_index_ilm_policy.\nAlso, all the other policies set up by X-Pack plugins use hyphens instead of underscores in their names and don't contain the word \"index\", so probably ml-state-ilm-policy would be better for product-wide consistency.", "url": "https://github.com/elastic/elasticsearch/pull/52356#discussion_r388403959", "createdAt": "2020-03-05T16:20:09Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlIndexTemplateRegistry.java", "diffHunk": "@@ -59,6 +58,9 @@\n \n     private static final IndexTemplateConfig STATS_TEMPLATE = statsTemplate();\n \n+    private static final LifecyclePolicyConfig ANOMALY_DETECTION_STATE_ILM_POLICY =\n+        new LifecyclePolicyConfig(\"state_index_ilm_policy\", ANOMALY_DETECTION_PATH + \"state_index_ilm_policy.json\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63f312369d365b622f76660e439c0ee874c818ae"}, "originalPosition": 26}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a127b4d78db8daca3521debfed9199f08f387138", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a127b4d78db8daca3521debfed9199f08f387138", "committedDate": "2020-03-05T17:50:10Z", "message": "Rename ILM policy for ML state index"}, "afterCommit": {"oid": "0caa02f4fb6b3a0d0cc3de4609849381234523a0", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0caa02f4fb6b3a0d0cc3de4609849381234523a0", "committedDate": "2020-03-05T17:51:53Z", "message": "Rename ILM policy for ML state index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMTk0NDk0", "url": "https://github.com/elastic/elasticsearch/pull/52356#pullrequestreview-370194494", "createdAt": "2020-03-06T09:43:20Z", "commit": {"oid": "0caa02f4fb6b3a0d0cc3de4609849381234523a0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8af618ab12f01efab208d7a9fd966732412b697", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8af618ab12f01efab208d7a9fd966732412b697", "committedDate": "2020-03-09T09:19:38Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0c33501de399e1c77bbb26daadac5a89953d438", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0c33501de399e1c77bbb26daadac5a89953d438", "committedDate": "2020-03-09T09:19:39Z", "message": "Implement ILM policy for .ml-state* indices"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbae198eb7803888ab0c0e42c670ff9c727d0aa0", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbae198eb7803888ab0c0e42c670ff9c727d0aa0", "committedDate": "2020-03-09T09:19:39Z", "message": "Adapt tests to the new state index name (.ml-state-000001)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebf0449651cb91e9b833b13b987f634c3778bf58", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ebf0449651cb91e9b833b13b987f634c3778bf58", "committedDate": "2020-03-09T09:19:39Z", "message": "Implement custom comparator for state index names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93c2108f38eb1ae0155ff727b18733999f233b6d", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/93c2108f38eb1ae0155ff727b18733999f233b6d", "committedDate": "2020-03-09T09:19:39Z", "message": "Apply ILM template settings only when ILM plugin is enabled"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93ca49433747553035ec7729d648334acc8c1926", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/93ca49433747553035ec7729d648334acc8c1926", "committedDate": "2020-03-09T09:19:39Z", "message": "Adapt the code to the new way of using resolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f9ab818d01074be76d05451eb933a031befcf79", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f9ab818d01074be76d05451eb933a031befcf79", "committedDate": "2020-03-09T09:19:39Z", "message": "Fix MachineLearningLicensingTests and AutodetectProcessManagerTests tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e16857041af9fb9b96f43e22fafaded367853df", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e16857041af9fb9b96f43e22fafaded367853df", "committedDate": "2020-03-09T09:19:39Z", "message": "Adapt the code to the refactoring done in MlIndexAndAlias class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cadebd1f0b3de5127339a6f35218fe50164a2ddb", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/cadebd1f0b3de5127339a6f35218fe50164a2ddb", "committedDate": "2020-03-09T09:19:39Z", "message": "Add ILM plugin to MlSingleNodeTestCase so that ILM settings in .ml-state work"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "392d4ea4cc2cbd1cf9dc93a7ec1baa67f9cdd191", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/392d4ea4cc2cbd1cf9dc93a7ec1baa67f9cdd191", "committedDate": "2020-03-09T09:19:39Z", "message": "Fix DeleteExpiredDataIT test so that it indexes docs to .ml-state-000001 rather than .ml-state-write"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93689c0460dcb65c30d9c2faf2183b4f7038bc26", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/93689c0460dcb65c30d9c2faf2183b4f7038bc26", "committedDate": "2020-03-09T09:19:39Z", "message": "Rename ILM policy for ML state index"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0caa02f4fb6b3a0d0cc3de4609849381234523a0", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0caa02f4fb6b3a0d0cc3de4609849381234523a0", "committedDate": "2020-03-05T17:51:53Z", "message": "Rename ILM policy for ML state index"}, "afterCommit": {"oid": "93689c0460dcb65c30d9c2faf2183b4f7038bc26", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/93689c0460dcb65c30d9c2faf2183b4f7038bc26", "committedDate": "2020-03-09T09:19:39Z", "message": "Rename ILM policy for ML state index"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2485, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}