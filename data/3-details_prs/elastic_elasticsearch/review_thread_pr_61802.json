{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MTgwNzA4", "number": 61802, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxMzoyNVrOEfECAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMTowMzowOFrOEfFDlA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDA3MzYxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/common/build.gradle", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxMzoyNVrOHLGj3w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjoyMTo0N1rOHLKSLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ==", "bodyText": "I introduced a qa/common project to better match how the other projects have this configured.", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481403871", "createdAt": "2020-09-01T20:13:25Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/qa/common/build.gradle", "diffHunk": "@@ -0,0 +1,20 @@\n+apply plugin: 'elasticsearch.build'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyMzk3Nw==", "bodyText": "Fair enough, but I don't see the point in the additional testJar. We're literally just defining another jar that's identical to the default jar. Why another artifact? Can't we just depend on this project via the default configuraiton?", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481423977", "createdAt": "2020-09-01T20:52:03Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/watcher/qa/common/build.gradle", "diffHunk": "@@ -0,0 +1,20 @@\n+apply plugin: 'elasticsearch.build'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ=="}, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDg3OQ==", "bodyText": "thanks... fixed on 667ea2a", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464879", "createdAt": "2020-09-01T22:21:47Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/qa/common/build.gradle", "diffHunk": "@@ -0,0 +1,20 @@\n+apply plugin: 'elasticsearch.build'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwMzg3MQ=="}, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDA3OTM4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxNTowMFrOHLGnKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjo1NDowMFrOHLK9Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA==", "bodyText": "minor duplication here to avoid sharing classpath's between test and javaRestTests", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481404714", "createdAt": "2020-09-01T20:15:00Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "diffHunk": "@@ -605,4 +607,18 @@ private EmailAttachments randomEmailAttachments() throws IOException {\n \n         return new EmailAttachments(attachments);\n     }\n+\n+    public static class NoopEmailService extends EmailService {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNTA3Nw==", "bodyText": "Could this go in the \"common\" qa project to be shared then?", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481425077", "createdAt": "2020-09-01T20:54:19Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "diffHunk": "@@ -605,4 +607,18 @@ private EmailAttachments randomEmailAttachments() throws IOException {\n \n         return new EmailAttachments(attachments);\n     }\n+\n+    public static class NoopEmailService extends EmailService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NzM3OA==", "bodyText": "i would prefer not to have the unit tests depend on the qa project (which has the parent classes for the java and yaml rest test runners). creating a dependency the other way requires a new test artifact or test fixture (in this case I prefer the minor duplication)", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481467378", "createdAt": "2020-09-01T22:28:46Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "diffHunk": "@@ -605,4 +607,18 @@ private EmailAttachments randomEmailAttachments() throws IOException {\n \n         return new EmailAttachments(attachments);\n     }\n+\n+    public static class NoopEmailService extends EmailService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ3NTkxNQ==", "bodyText": "No worries. It's a tiny implementation so it's probably not a big deal for a bit of duplication here.", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481475915", "createdAt": "2020-09-01T22:54:00Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/actions/email/EmailActionTests.java", "diffHunk": "@@ -605,4 +607,18 @@ private EmailAttachments randomEmailAttachments() throws IOException {\n \n         return new EmailAttachments(attachments);\n     }\n+\n+    public static class NoopEmailService extends EmailService {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNDcxNA=="}, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDA4MjE1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/transport/filter/IpFilteringIntegrationTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxNTozMlrOHLGorA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDoxNTozMlrOHLGorA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQwNTEwMA==", "bodyText": "didn't mean to change the package ... fixing now ..", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481405100", "createdAt": "2020-09-01T20:15:32Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/security/src/internalClusterTest/java/org/elasticsearch/transport/filter/IpFilteringIntegrationTests.java", "diffHunk": "@@ -3,7 +3,7 @@\n  * or more contributor license agreements. Licensed under the Elastic License;\n  * you may not use this file except in compliance with the Elastic License.\n  */\n-package org.elasticsearch.xpack.security.transport.filter;\n+package org.elasticsearch.transport.filter;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3faa914e2434e4aa5ce33bd926c1cdda3c407dc1"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDIyMDkyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/qa/basic-enable-security/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMDo1Njo1M1rOHLH8Rw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjoxNzoxOVrOHLKLKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwMw==", "bodyText": "This whole thing looks gnarly. Why don't we use two different clusters for this?", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481426503", "createdAt": "2020-09-01T20:56:53Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/security/qa/basic-enable-security/build.gradle", "diffHunk": "@@ -1,36 +1,36 @@\n import org.elasticsearch.gradle.testclusters.StandaloneRestIntegTestTask\n+import org.elasticsearch.gradle.test.rest.JavaRestTestPlugin\n \n-apply plugin: 'elasticsearch.testclusters'\n-apply plugin: 'elasticsearch.standalone-rest-test'\n-apply plugin: 'elasticsearch.rest-test'\n+apply plugin: 'elasticsearch.java-rest-test'\n \n dependencies {\n-  testImplementation project(path: xpackModule('core'), configuration: 'default')\n-  testImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n-  testImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'default')\n+  javaRestTestImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n }\n \n-integTest {\n+javaRestTest {\n   description = \"Run tests against a cluster that doesn't have security\"\n   systemProperty 'tests.has_security', 'false'\n }\n \n-testClusters.integTest {\n+testClusters.javaRestTest {\n   testDistribution = 'DEFAULT'\n   numberOfNodes = 2\n   setting 'xpack.ml.enabled', 'false'\n   setting 'xpack.license.self_generated.type', 'basic'\n   setting 'xpack.security.enabled', 'false'\n }\n \n-task integTestSecurity(type: StandaloneRestIntegTestTask) {\n-  description = \"Run tests against a cluster that has security\"\n-  useCluster testClusters.integTest\n-  dependsOn integTest\n+task javaRestTestWithSecurity(type: StandaloneRestIntegTestTask) {\n+  description = \"Run tests against a cluster that has security enabled\"\n+  useCluster testClusters.javaRestTest\n+  dependsOn javaRestTest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2MzA4Mw==", "bodyText": "yeah... that tripped me up at first sight too.  This is testing that enabling security where it was not enabled prior works. e.g. start without security run some tests, enable security restart then run the same tests. There is a boolean read by the tests that controls what to assert with/without security enabled.", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481463083", "createdAt": "2020-09-01T22:17:19Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/security/qa/basic-enable-security/build.gradle", "diffHunk": "@@ -1,36 +1,36 @@\n import org.elasticsearch.gradle.testclusters.StandaloneRestIntegTestTask\n+import org.elasticsearch.gradle.test.rest.JavaRestTestPlugin\n \n-apply plugin: 'elasticsearch.testclusters'\n-apply plugin: 'elasticsearch.standalone-rest-test'\n-apply plugin: 'elasticsearch.rest-test'\n+apply plugin: 'elasticsearch.java-rest-test'\n \n dependencies {\n-  testImplementation project(path: xpackModule('core'), configuration: 'default')\n-  testImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n-  testImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'default')\n+  javaRestTestImplementation project(path: xpackModule('security'), configuration: 'testArtifacts')\n+  javaRestTestImplementation project(path: xpackModule('core'), configuration: 'testArtifacts')\n }\n \n-integTest {\n+javaRestTest {\n   description = \"Run tests against a cluster that doesn't have security\"\n   systemProperty 'tests.has_security', 'false'\n }\n \n-testClusters.integTest {\n+testClusters.javaRestTest {\n   testDistribution = 'DEFAULT'\n   numberOfNodes = 2\n   setting 'xpack.ml.enabled', 'false'\n   setting 'xpack.license.self_generated.type', 'basic'\n   setting 'xpack.security.enabled', 'false'\n }\n \n-task integTestSecurity(type: StandaloneRestIntegTestTask) {\n-  description = \"Run tests against a cluster that has security\"\n-  useCluster testClusters.integTest\n-  dependsOn integTest\n+task javaRestTestWithSecurity(type: StandaloneRestIntegTestTask) {\n+  description = \"Run tests against a cluster that has security enabled\"\n+  useCluster testClusters.javaRestTest\n+  dependsOn javaRestTest", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyNjUwMw=="}, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDIzMjk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMTowMDoyOFrOHLIDlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjoyMToyMlrOHLKRjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyODM3NQ==", "bodyText": "I suspect this probably isn't needed for unit tests. Can we ditch the block above?", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481428375", "createdAt": "2020-09-01T21:00:28Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/security/build.gradle", "diffHunk": "@@ -476,6 +484,11 @@ test {\n   systemProperty 'es.transport.buffer.size', '256k'\n }\n \n+internalClusterTest {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDcxNg==", "bodyText": "yup: 1f4ca9a", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464716", "createdAt": "2020-09-01T22:21:22Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/security/build.gradle", "diffHunk": "@@ -476,6 +484,11 @@ test {\n   systemProperty 'es.transport.buffer.size', '256k'\n }\n \n+internalClusterTest {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyODM3NQ=="}, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAxMDI0MTQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMTowMzowOFrOHLII6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQyMjoyMToxNFrOHLKRZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyOTczOA==", "bodyText": "Same, I suspect this is only needed for integration tests.", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481429738", "createdAt": "2020-09-01T21:03:08Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/watcher/build.gradle", "diffHunk": "@@ -86,6 +87,10 @@ test {\n   systemProperty 'es.set.netty.runtime.available.processors', 'false'\n }\n \n+internalClusterTest {\n+  systemProperty 'es.set.netty.runtime.available.processors', 'false'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQ2NDY3OA==", "bodyText": "indeed: 1f4ca9a", "url": "https://github.com/elastic/elasticsearch/pull/61802#discussion_r481464678", "createdAt": "2020-09-01T22:21:14Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/build.gradle", "diffHunk": "@@ -86,6 +87,10 @@ test {\n   systemProperty 'es.set.netty.runtime.available.processors', 'false'\n }\n \n+internalClusterTest {\n+  systemProperty 'es.set.netty.runtime.available.processors', 'false'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTQyOTczOA=="}, "originalCommit": {"oid": "f84d203b92622a2d5e794a6a03199daabb15e071"}, "originalPosition": 11}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1812, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}