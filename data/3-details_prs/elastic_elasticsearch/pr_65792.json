{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMzUyODA1", "number": 65792, "title": "SQL: Enable the InnerAggregates inside PIVOT", "bodyText": "Remove the limitation of not being able use InnerAggregate inside\nPIVOT (aggregations using extended and matrix stats)\nIntegration tests that cover the extended stats and the matrix stats aggregations", "createdAt": "2020-12-02T23:26:41Z", "url": "https://github.com/elastic/elasticsearch/pull/65792", "merged": true, "mergeCommit": {"oid": "67704b09be9d9acb73c95eb0dd238815312bbc2c"}, "closed": true, "closedAt": "2020-12-07T14:50:11Z", "author": {"login": "palesz"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiXEN6gH2gAyNTMxMzUyODA1OjYzZmZlMmUwYWFlNjQ3YTVhODEwZjA4N2M2MTU1Y2E3ZTczMjc0ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj5ObcAFqTU0NjM4NDg2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63ffe2e0aae647a5a810f087c6155ca7e7327488", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/63ffe2e0aae647a5a810f087c6155ca7e7327488", "committedDate": "2020-12-02T23:23:05Z", "message": "SQL: Enable the InnerAggregates inside PIVOT\n\n* Remove the limitation of not being able use `InnerAggregate` inside\nPIVOT (aggregations using extended and matrix stats)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6208fb82a7233817a71a555cf24100027f09811", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/a6208fb82a7233817a71a555cf24100027f09811", "committedDate": "2020-12-03T16:19:40Z", "message": "Additional, more complicated testcases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTQxMjA5", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-544141209", "createdAt": "2020-12-03T16:26:48Z", "commit": {"oid": "63ffe2e0aae647a5a810f087c6155ca7e7327488"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTQ2MjU0", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-544146254", "createdAt": "2020-12-03T16:31:49Z", "commit": {"oid": "63ffe2e0aae647a5a810f087c6155ca7e7327488"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjozMTo0OVrOH-lf3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjozMTo0OVrOH-lf3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4ODEyNg==", "bodyText": "I'd like to see a test with multiple arguments that get folded into compound aggs, such as sum / min / max.", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r535388126", "createdAt": "2020-12-03T16:31:49Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/pivot.csv-spec", "diffHunk": "@@ -201,6 +201,29 @@ null                 |10044          |Mingsen        |F              |1994-05-21\n // end::sumWithoutSubquery\n ;\n \n+sumWithInnerAggregateSumOfSquares\n+schema::birth_date:ts|emp_no:i|first_name:s|gender:s|hire_date:ts|last_name:s|1:d|2:d\n+SELECT * FROM test_emp PIVOT (SUM_OF_SQUARES(salary) FOR languages IN (1, 2)) LIMIT 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "63ffe2e0aae647a5a810f087c6155ca7e7327488"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19dc1c62a139eb4c947e6e70ec6275f6603a492a", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/19dc1c62a139eb4c947e6e70ec6275f6603a492a", "committedDate": "2020-12-03T22:46:26Z", "message": "Test that `PIVOT` and `GROUP BY` has same query\n\nTest that the `PIVOT` results in the same query as\nthe `GROUP BY`. This should hold across all the `AggregateFunction`s we\nhave."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NTQ5Mzky", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-544549392", "createdAt": "2020-12-03T23:35:06Z", "commit": {"oid": "19dc1c62a139eb4c947e6e70ec6275f6603a492a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNTowNlrOH-6DAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMzozNTowNlrOH-6DAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTcyNDgwMQ==", "bodyText": "Created #65863", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r535724801", "createdAt": "2020-12-03T23:35:06Z", "author": {"login": "palesz"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/pivot.csv-spec", "diffHunk": "@@ -201,6 +201,51 @@ null                 |10044          |Mingsen        |F              |1994-05-21\n // end::sumWithoutSubquery\n ;\n \n+sumWithInnerAggregateSumOfSquares\n+schema::birth_date:ts|emp_no:i|first_name:s|gender:s|hire_date:ts|last_name:s|1:d|2:d\n+SELECT * FROM test_emp PIVOT (SUM_OF_SQUARES(salary) FOR languages IN (1, 2)) LIMIT 5;\n+\n+  birth_date         |    emp_no     |  first_name   |    gender     |       hire_date        |   last_name   |       1       |       2       \n+---------------------+---------------+---------------+---------------+------------------------+---------------+---------------+---------------\n+null                 |10041          |Uri            |F              |1989-11-12T00:00:00.000Z|Lenart         |3.182652225E9  |null           \n+null                 |10043          |Yishay         |M              |1990-10-20T00:00:00.000Z|Tzvieli        |1.179304281E9  |null           \n+null                 |10044          |Mingsen        |F              |1994-05-21T00:00:00.000Z|Casley         |1.578313984E9  |null           \n+1952-04-19T00:00:00Z |10009          |Sumant         |F              |1985-02-18T00:00:00.000Z|Peac           |4.378998276E9  |null           \n+1953-01-07T00:00:00Z |10067          |Claudi         |M              |1987-03-04T00:00:00.000Z|Stavenow       |null           |2.708577936E9  \n+;\n+\n+sumWithInnerAggregateSumOfSquaresRound\n+schema::birth_date:ts|emp_no:i|first_name:s|gender:s|hire_date:ts|last_name:s|1:d|2:d\n+SELECT * FROM test_emp PIVOT (ROUND(SUM_OF_SQUARES(salary)/1E6, 2) FOR languages IN (1, 2)) LIMIT 5;\n+\n+  birth_date         |    emp_no     |  first_name   |    gender     |       hire_date        |   last_name   |       1       |       2       \n+---------------------+---------------+---------------+---------------+------------------------+---------------+---------------+---------------\n+null                 |10041          |Uri            |F              |1989-11-12T00:00:00.000Z|Lenart         |3182.65        |null           \n+null                 |10043          |Yishay         |M              |1990-10-20T00:00:00.000Z|Tzvieli        |1179.30        |null           \n+null                 |10044          |Mingsen        |F              |1994-05-21T00:00:00.000Z|Casley         |1578.31        |null           \n+1952-04-19T00:00:00Z |10009          |Sumant         |F              |1985-02-18T00:00:00.000Z|Peac           |4379.00        |null           \n+1953-01-07T00:00:00Z |10067          |Claudi         |M              |1987-03-04T00:00:00.000Z|Stavenow       |null           |2708.58        \n+;\n+\n+sumWithInnerAggregateKurtosis\n+schema::client_port:i|'OK':d|'Error':d\n+SELECT * FROM (SELECT client_port, status, bytes_in FROM logs WHERE client_port IS NULL) PIVOT (KURTOSIS(bytes_in) FOR status IN ('OK', 'Error')) LIMIT 10;\n+\n+  client_port  |       'OK'       |    'Error'    \n+---------------+------------------+---------------\n+null           |2.0016153277578916|NaN            \n+;\n+\n+sumWithInnerAggregateKurtosisRound\n+schema::client_port:i|'OK':d|'Error':d\n+SELECT * FROM (SELECT client_port, status, bytes_in FROM logs WHERE client_port IS NULL) PIVOT (ROUND(KURTOSIS(bytes_in), 3) FOR status IN ('OK', 'Error')) LIMIT 10;\n+\n+  client_port  |       'OK'       |    'Error'    \n+---------------+------------------+---------------\n+null           |2.002             |-0.0            ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19dc1c62a139eb4c947e6e70ec6275f6603a492a"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "38675937470735be4d70c80f35f8f14ec6336e14", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/38675937470735be4d70c80f35f8f14ec6336e14", "committedDate": "2020-12-03T23:35:46Z", "message": "Merge remote-tracking branch 'origin/master' into feature/pivot-inneraggregates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0ODgwNzI5", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-544880729", "createdAt": "2020-12-04T11:33:36Z", "commit": {"oid": "38675937470735be4d70c80f35f8f14ec6336e14"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTozMzozNlrOH_M-JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTozNjo0N1rOH_NE4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNDg1Mg==", "bodyText": "It's better to get the list from the Function registry so that all existing aggs and future ones are picked up without having to manually update this test (since it is unlikely it will happen).", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r536034852", "createdAt": "2020-12-04T11:33:36Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/QueryFolderTests.java", "diffHunk": "@@ -495,14 +497,34 @@ public void testFoldingOfPivot() {\n         assertEquals(EsQueryExec.class, p.getClass());\n         EsQueryExec ee = (EsQueryExec) p;\n         assertEquals(3, ee.output().size());\n-        assertEquals(Arrays.asList(\"bool\", \"'A'\", \"'B'\"), Expressions.names(ee.output()));\n+        assertEquals(asList(\"bool\", \"'A'\", \"'B'\"), Expressions.names(ee.output()));\n         String q = ee.toString().replaceAll(\"\\\\s+\", \"\");\n         assertThat(q, containsString(\"\\\"query\\\":{\\\"terms\\\":{\\\"keyword\\\":[\\\"A\\\",\\\"B\\\"]\"));\n         String a = ee.queryContainer().aggs().asAggBuilder().toString().replaceAll(\"\\\\s+\", \"\");\n         assertThat(a, containsString(\"\\\"terms\\\":{\\\"field\\\":\\\"bool\\\"\"));\n         assertThat(a, containsString(\"\\\"terms\\\":{\\\"field\\\":\\\"keyword\\\"\"));\n         assertThat(a, containsString(\"{\\\"avg\\\":{\\\"field\\\":\\\"int\\\"}\"));\n     }\n+    ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38675937470735be4d70c80f35f8f14ec6336e14"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjAzNjU3Ng==", "bodyText": "Is there any validation or check for this (now that PostOptimizerTest has been removed)? this goes beyond the scope of this ticket so please raise a ticket if this functionality is missing or needs to be further investigated.", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r536036576", "createdAt": "2020-12-04T11:36:47Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/pivot.csv-spec", "diffHunk": "@@ -201,6 +201,29 @@ null                 |10044          |Mingsen        |F              |1994-05-21\n // end::sumWithoutSubquery\n ;\n \n+sumWithInnerAggregateSumOfSquares\n+schema::birth_date:ts|emp_no:i|first_name:s|gender:s|hire_date:ts|last_name:s|1:d|2:d\n+SELECT * FROM test_emp PIVOT (SUM_OF_SQUARES(salary) FOR languages IN (1, 2)) LIMIT 5;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM4ODEyNg=="}, "originalCommit": {"oid": "63ffe2e0aae647a5a810f087c6155ca7e7327488"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cca0ed7ff37ad02f9dbd5ff7bb8965d0efb116ee", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/cca0ed7ff37ad02f9dbd5ff7bb8965d0efb116ee", "committedDate": "2020-12-04T18:11:10Z", "message": "Utilized SQLFunctionRegistry to look up the `AggregateFunction`s"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8480e392167385260f249340ad6734db3cd41691", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/8480e392167385260f249340ad6734db3cd41691", "committedDate": "2020-12-04T18:12:16Z", "message": "Merge remote-tracking branch 'origin/master' into feature/pivot-inneraggregates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MDkxMDY0", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-546091064", "createdAt": "2020-12-07T12:13:06Z", "commit": {"oid": "8480e392167385260f249340ad6734db3cd41691"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjoxMzowNlrOIAj7EQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjoxMzowNlrOIAj7EQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ1OTQ3Mw==", "bodyText": "You might want to use a different construct to ease backporting to 7.x due to the JDK difference", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r537459473", "createdAt": "2020-12-07T12:13:06Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/QueryFolderTests.java", "diffHunk": "@@ -495,14 +499,39 @@ public void testFoldingOfPivot() {\n         assertEquals(EsQueryExec.class, p.getClass());\n         EsQueryExec ee = (EsQueryExec) p;\n         assertEquals(3, ee.output().size());\n-        assertEquals(Arrays.asList(\"bool\", \"'A'\", \"'B'\"), Expressions.names(ee.output()));\n+        assertEquals(asList(\"bool\", \"'A'\", \"'B'\"), Expressions.names(ee.output()));\n         String q = ee.toString().replaceAll(\"\\\\s+\", \"\");\n         assertThat(q, containsString(\"\\\"query\\\":{\\\"terms\\\":{\\\"keyword\\\":[\\\"A\\\",\\\"B\\\"]\"));\n         String a = ee.queryContainer().aggs().asAggBuilder().toString().replaceAll(\"\\\\s+\", \"\");\n         assertThat(a, containsString(\"\\\"terms\\\":{\\\"field\\\":\\\"bool\\\"\"));\n         assertThat(a, containsString(\"\\\"terms\\\":{\\\"field\\\":\\\"keyword\\\"\"));\n         assertThat(a, containsString(\"{\\\"avg\\\":{\\\"field\\\":\\\"int\\\"}\"));\n     }\n+    \n+    public void testPivotHasSameQueryAsGroupBy() {\n+        final Map<String, String> aggFnsWithMultipleArguments = Map.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8480e392167385260f249340ad6734db3cd41691"}, "originalPosition": 62}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTIzNTY1", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-546123565", "createdAt": "2020-12-07T12:58:31Z", "commit": {"oid": "8480e392167385260f249340ad6734db3cd41691"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2Mzg0ODY1", "url": "https://github.com/elastic/elasticsearch/pull/65792#pullrequestreview-546384865", "createdAt": "2020-12-07T17:43:28Z", "commit": {"oid": "8480e392167385260f249340ad6734db3cd41691"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0MzoyOFrOIAyoog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNzo0MzoyOFrOIAyoog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzcwMDUxNA==", "bodyText": "This query fails for me in a REST test (using a REST client): it's only returning 3 rows, whereas it should have returned 5. We need to look into why the test passes and/or why the REST call with the same query fails. @palesz please, open an issue for this investigation.", "url": "https://github.com/elastic/elasticsearch/pull/65792#discussion_r537700514", "createdAt": "2020-12-07T17:43:28Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/pivot.csv-spec", "diffHunk": "@@ -201,6 +201,51 @@ null                 |10044          |Mingsen        |F              |1994-05-21\n // end::sumWithoutSubquery\n ;\n \n+sumWithInnerAggregateSumOfSquares\n+schema::birth_date:ts|emp_no:i|first_name:s|gender:s|hire_date:ts|last_name:s|1:d|2:d\n+SELECT * FROM test_emp PIVOT (SUM_OF_SQUARES(salary) FOR languages IN (1, 2)) LIMIT 5;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8480e392167385260f249340ad6734db3cd41691"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4138, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}