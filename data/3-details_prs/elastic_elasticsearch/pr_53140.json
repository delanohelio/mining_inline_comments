{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTE1MjY0", "number": 53140, "title": "Serialize NodesInfoRequest as a set of strings", "bodyText": "If the nodes info endpoint is going to be pluggable, the NodesInfoRequest class needs to support flexible lists of metrics rather than a fixed group of boolean flags. This PR refactors the NodesInfoRequest class so that its serialization will be capable of carrying such lists.\nIt does not change the external API of the NodesInfoRequest class. This will be done in a follow-up PR. I want to keep this PR as small as I can in case I have misunderstood anything important about backwards compatibility for the transport protocol.\nThis PR also adds some granular unit tests that I used to make sure that the class's behavior didn't change.\nRelates #52975", "createdAt": "2020-03-04T21:59:40Z", "url": "https://github.com/elastic/elasticsearch/pull/53140", "merged": true, "mergeCommit": {"oid": "4bd55ce01e08fd48b288d6983a21f35be1d4e2d0"}, "closed": true, "closedAt": "2020-03-06T14:05:34Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKbvVmAH2gAyMzgzOTE1MjY0OjgyNDc2YTk4NDU2YzBlN2NhOTQyMzUwZGVkZWI3NWE3NjlmNDZlN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKyvuBAH2gAyMzgzOTE1MjY0OjM5ODlkMjgzZDczZDAyOGFkMDAwMGM0NTE2NTAzMDlkMTZlZjE1Y2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "82476a98456c0e7ca942350dedeb75a769f46e7b", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/82476a98456c0e7ca942350dedeb75a769f46e7b", "committedDate": "2020-03-04T19:04:28Z", "message": "Replace booleans with set in NodesInfoRequest\n\nFor Node Info to be pluggable, NodesInfoRequest must be able to carry\narbitrary strings. This commit reworks the internals of that class to\nuse a set rather than hard-coded boolean fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c98a1c68704c4ab7f1c9b95582997a3ae557ccc", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c98a1c68704c4ab7f1c9b95582997a3ae557ccc", "committedDate": "2020-03-04T19:04:28Z", "message": "Add license; use standard unit test class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e31e3a4bda03e32b058d1758cd79140967caba", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/49e31e3a4bda03e32b058d1758cd79140967caba", "committedDate": "2020-03-04T19:04:28Z", "message": "Set initial defaults"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b8f9d772eb4cd98195a5d053b9335cc2216e906", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b8f9d772eb4cd98195a5d053b9335cc2216e906", "committedDate": "2020-03-04T19:04:28Z", "message": "Streamline tests and test defaults\n\nNodesInfoRequest defaults to specifying all values. We need to test for\nthis behavior as we refactor. Also, we can use random testing for the\nvarious combinations of metrics rather than having individual tests for\neach metric."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c6de4d08a50884a9bc6391e7f490a3d294ee9cb", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c6de4d08a50884a9bc6391e7f490a3d294ee9cb", "committedDate": "2020-03-04T19:44:36Z", "message": "Add backwards compatibility for transport requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c71be193c0a43a31418d54c3c0c38662349a6e2d", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/c71be193c0a43a31418d54c3c0c38662349a6e2d", "committedDate": "2020-03-04T20:34:22Z", "message": "Rename variables and add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40a9a98e0c9f7f2dd00a026612efeb3ba2dbe98b", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/40a9a98e0c9f7f2dd00a026612efeb3ba2dbe98b", "committedDate": "2020-03-04T20:45:11Z", "message": "Adding test javadoc and renaming test variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6950a566e0fc7762fa4929de7686e78de6a1d43", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/a6950a566e0fc7762fa4929de7686e78de6a1d43", "committedDate": "2020-03-04T21:39:43Z", "message": "Reverse order of if/else clauses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/31699047009720648908cd26aaff7f7ce8c38392", "committedDate": "2020-03-04T22:00:54Z", "message": "Take advantage of convenience methods for brevity"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDgzNTQx", "url": "https://github.com/elastic/elasticsearch/pull/53140#pullrequestreview-369483541", "createdAt": "2020-03-05T11:12:56Z", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxMjo1NlrOFyPjbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToxMjo1NlrOFyPjbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIyNzk0OQ==", "bodyText": "I'm in two minds over whether this is a better name. WDYT?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private void addOrRemoveMetric(boolean includeMetric, String metricName) {\n          \n          \n            \n                private void toggleMetric(boolean includeMetric, String metricName) {", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388227949", "createdAt": "2020-03-05T11:12:56Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequest.java", "diffHunk": "@@ -208,61 +199,116 @@ public NodesInfoRequest http(boolean http) {\n      * @return The request\n      */\n     public NodesInfoRequest plugins(boolean plugins) {\n-        this.plugins = plugins;\n+        addOrRemoveMetric(plugins, Metrics.PLUGINS.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about plugins is requested\n      */\n     public boolean plugins() {\n-        return plugins;\n+        return Metrics.PLUGINS.containedIn(requestedMetrics);\n     }\n \n     /**\n      * Should information about ingest be returned\n      * @param ingest true if you want info\n      */\n     public NodesInfoRequest ingest(boolean ingest) {\n-        this.ingest = ingest;\n+        addOrRemoveMetric(ingest, Metrics.INGEST.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about ingest is requested\n      */\n     public boolean ingest() {\n-        return ingest;\n+        return Metrics.INGEST.containedIn(requestedMetrics);\n     }\n \n     /**\n      * Should information about indices (currently just indexing buffers) be returned\n      * @param indices true if you want info\n      */\n     public NodesInfoRequest indices(boolean indices) {\n-        this.indices = indices;\n+        addOrRemoveMetric(indices, Metrics.INDICES.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about indices (currently just indexing buffers)\n      */\n     public boolean indices() {\n-        return indices;\n+        return Metrics.INDICES.containedIn(requestedMetrics);\n+    }\n+\n+    /**\n+     * Helper method for adding and removing metrics.\n+     * @param includeMetric Whether or not to include a metric.\n+     * @param metricName Name of the metric to include or remove.\n+     */\n+    private void addOrRemoveMetric(boolean includeMetric, String metricName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 289}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDg5NTEy", "url": "https://github.com/elastic/elasticsearch/pull/53140#pullrequestreview-369489512", "createdAt": "2020-03-05T11:22:55Z", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToyMjo1NVrOFyP1vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxMToyMjo1NVrOFyP1vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIzMjYzOQ==", "bodyText": "What do you think about exposing requestedMetrics but readonly? e.g.\nSet<String> getRequestedMetrics() {\n   return Collections.unmodifiableSet(requestedMetrics);\n}\nThen the test can just do:\nassertThat(request1.getRequestedMetrics(), equalTo(request2.getRequestedMetrics()));", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388232639", "createdAt": "2020-03-05T11:22:55Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequestTests.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.cluster.node.info;\n+\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.test.ESTestCase;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+/**\n+ * Granular tests for the {@link NodesInfoRequest} class. Higher-level tests\n+ * can be found in {@link org.elasticsearch.rest.action.admin.cluster.RestNodesInfoActionTests}.\n+ */\n+public class NodesInfoRequestTests extends ESTestCase {\n+\n+    /**\n+     * Make sure that we can set, serialize, and deserialize arbitrary sets\n+     * of metrics.\n+     */\n+    public void testMetricsSetters() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(randomAlphaOfLength(8));\n+        request.settings(randomBoolean());\n+        request.os(randomBoolean());\n+        request.process(randomBoolean());\n+        request.jvm(randomBoolean());\n+        request.threadPool(randomBoolean());\n+        request.transport(randomBoolean());\n+        request.http(randomBoolean());\n+        request.plugins(randomBoolean());\n+        request.ingest(randomBoolean());\n+        request.indices(randomBoolean());\n+        NodesInfoRequest deserializedRequest = roundTripRequest(request);\n+        assertThat(request.settings(), equalTo(deserializedRequest.settings()));\n+    }\n+\n+    /**\n+     * Test that a newly constructed NodesInfoRequestObject requests all of the\n+     * possible metrics defined in {@link NodesInfoRequest.Metrics}.\n+     */\n+    public void testNodesInfoRequestDefaults() {\n+        NodesInfoRequest defaultNodesInfoRequest = new NodesInfoRequest(randomAlphaOfLength(8));\n+        NodesInfoRequest allMetricsNodesInfoRequest = new NodesInfoRequest(randomAlphaOfLength(8));\n+        allMetricsNodesInfoRequest.all();\n+\n+        assertRequestsEqual(defaultNodesInfoRequest, allMetricsNodesInfoRequest);\n+    }\n+\n+    /**\n+     * Test that the {@link NodesInfoRequest#all()} method sets all of the\n+     * metrics to {@code true}.\n+     */\n+    public void testNodesInfoRequestAll() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(\"node\");\n+        request.all();\n+\n+        assertTrue(request.settings());\n+        assertTrue(request.os());\n+        assertTrue(request.process());\n+        assertTrue(request.jvm());\n+        assertTrue(request.threadPool());\n+        assertTrue(request.transport());\n+        assertTrue(request.http());\n+        assertTrue(request.plugins());\n+        assertTrue(request.ingest());\n+        assertTrue(request.indices());\n+    }\n+\n+    /**\n+     * Test that the {@link NodesInfoRequest#clear()} method sets all of the\n+     * metrics to {@code false}.\n+     */\n+    public void testNodesInfoRequestClear() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(\"node\");\n+        request.clear();\n+\n+        assertFalse(request.settings());\n+        assertFalse(request.os());\n+        assertFalse(request.process());\n+        assertFalse(request.jvm());\n+        assertFalse(request.threadPool());\n+        assertFalse(request.transport());\n+        assertFalse(request.http());\n+        assertFalse(request.plugins());\n+        assertFalse(request.ingest());\n+        assertFalse(request.indices());\n+    }\n+\n+    /**\n+     * Serialize and deserialize a request.\n+     * @param request A request to serialize.\n+     * @return The deserialized, \"round-tripped\" request.\n+     */\n+    private static NodesInfoRequest roundTripRequest(NodesInfoRequest request) throws Exception {\n+        try (BytesStreamOutput out = new BytesStreamOutput()) {\n+            request.writeTo(out);\n+            try (StreamInput in = out.bytes().streamInput()) {\n+                return new NodesInfoRequest(in);\n+            }\n+        }\n+    }\n+\n+    private static void assertRequestsEqual(NodesInfoRequest request1, NodesInfoRequest request2) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDg5NjU1", "url": "https://github.com/elastic/elasticsearch/pull/53140#pullrequestreview-369489655", "createdAt": "2020-03-05T11:23:09Z", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NzA3MTQ5", "url": "https://github.com/elastic/elasticsearch/pull/53140#pullrequestreview-369707149", "createdAt": "2020-03-05T16:12:43Z", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoxMjo0M1rOFyZ_yA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjoxMjo0M1rOFyZ_yA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM5OTA0OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(request.settings(), equalTo(deserializedRequest.settings()));\n          \n          \n            \n                    assertRequestsEqual(request, deserializedRequest);", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388399048", "createdAt": "2020-03-05T16:12:43Z", "author": {"login": "williamrandolph"}, "path": "server/src/test/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequestTests.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.cluster.node.info;\n+\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.test.ESTestCase;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+/**\n+ * Granular tests for the {@link NodesInfoRequest} class. Higher-level tests\n+ * can be found in {@link org.elasticsearch.rest.action.admin.cluster.RestNodesInfoActionTests}.\n+ */\n+public class NodesInfoRequestTests extends ESTestCase {\n+\n+    /**\n+     * Make sure that we can set, serialize, and deserialize arbitrary sets\n+     * of metrics.\n+     */\n+    public void testMetricsSetters() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(randomAlphaOfLength(8));\n+        request.settings(randomBoolean());\n+        request.os(randomBoolean());\n+        request.process(randomBoolean());\n+        request.jvm(randomBoolean());\n+        request.threadPool(randomBoolean());\n+        request.transport(randomBoolean());\n+        request.http(randomBoolean());\n+        request.plugins(randomBoolean());\n+        request.ingest(randomBoolean());\n+        request.indices(randomBoolean());\n+        NodesInfoRequest deserializedRequest = roundTripRequest(request);\n+        assertThat(request.settings(), equalTo(deserializedRequest.settings()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 51}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5ODA1NDI1", "url": "https://github.com/elastic/elasticsearch/pull/53140#pullrequestreview-369805425", "createdAt": "2020-03-05T18:20:53Z", "commit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODoyMDo1M1rOFyesDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxODoyNTozM1rOFye1qQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3NTkxNg==", "bodyText": "This should be whatever version we are backporting to.", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388475916", "createdAt": "2020-03-05T18:20:53Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequest.java", "diffHunk": "@@ -19,40 +19,48 @@\n \n package org.elasticsearch.action.admin.cluster.node.info;\n \n+import org.elasticsearch.Version;\n import org.elasticsearch.action.support.nodes.BaseNodesRequest;\n import org.elasticsearch.common.io.stream.StreamInput;\n import org.elasticsearch.common.io.stream.StreamOutput;\n \n import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n \n /**\n  * A request to get node (cluster) level information.\n  */\n public class NodesInfoRequest extends BaseNodesRequest<NodesInfoRequest> {\n \n-    private boolean settings = true;\n-    private boolean os = true;\n-    private boolean process = true;\n-    private boolean jvm = true;\n-    private boolean threadPool = true;\n-    private boolean transport = true;\n-    private boolean http = true;\n-    private boolean plugins = true;\n-    private boolean ingest = true;\n-    private boolean indices = true;\n+    private Set<String> requestedMetrics = Metrics.allMetrics();\n \n+    /**\n+     * Create a new NodeInfoRequest from a {@link StreamInput} object.\n+     *\n+     * @param in A stream input object.\n+     * @throws IOException if the stream cannot be deserialized.\n+     */\n     public NodesInfoRequest(StreamInput in) throws IOException {\n         super(in);\n-        settings = in.readBoolean();\n-        os = in.readBoolean();\n-        process = in.readBoolean();\n-        jvm = in.readBoolean();\n-        threadPool = in.readBoolean();\n-        transport = in.readBoolean();\n-        http = in.readBoolean();\n-        plugins = in.readBoolean();\n-        ingest = in.readBoolean();\n-        indices = in.readBoolean();\n+        requestedMetrics.clear();\n+        if (in.getVersion().before(Version.V_8_0_0)){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3NjkxMg==", "bodyText": "toggle doesn't make sense, since the new state is passed in, not flipped.", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388476912", "createdAt": "2020-03-05T18:22:45Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequest.java", "diffHunk": "@@ -208,61 +199,116 @@ public NodesInfoRequest http(boolean http) {\n      * @return The request\n      */\n     public NodesInfoRequest plugins(boolean plugins) {\n-        this.plugins = plugins;\n+        addOrRemoveMetric(plugins, Metrics.PLUGINS.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about plugins is requested\n      */\n     public boolean plugins() {\n-        return plugins;\n+        return Metrics.PLUGINS.containedIn(requestedMetrics);\n     }\n \n     /**\n      * Should information about ingest be returned\n      * @param ingest true if you want info\n      */\n     public NodesInfoRequest ingest(boolean ingest) {\n-        this.ingest = ingest;\n+        addOrRemoveMetric(ingest, Metrics.INGEST.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about ingest is requested\n      */\n     public boolean ingest() {\n-        return ingest;\n+        return Metrics.INGEST.containedIn(requestedMetrics);\n     }\n \n     /**\n      * Should information about indices (currently just indexing buffers) be returned\n      * @param indices true if you want info\n      */\n     public NodesInfoRequest indices(boolean indices) {\n-        this.indices = indices;\n+        addOrRemoveMetric(indices, Metrics.INDICES.metricName());\n         return this;\n     }\n \n     /**\n      * @return true if information about indices (currently just indexing buffers)\n      */\n     public boolean indices() {\n-        return indices;\n+        return Metrics.INDICES.containedIn(requestedMetrics);\n+    }\n+\n+    /**\n+     * Helper method for adding and removing metrics.\n+     * @param includeMetric Whether or not to include a metric.\n+     * @param metricName Name of the metric to include or remove.\n+     */\n+    private void addOrRemoveMetric(boolean includeMetric, String metricName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODIyNzk0OQ=="}, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 289}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQ3ODM3Nw==", "bodyText": "You could loop through Metric.values() instead of hardcoding each to check for?", "url": "https://github.com/elastic/elasticsearch/pull/53140#discussion_r388478377", "createdAt": "2020-03-05T18:25:33Z", "author": {"login": "rjernst"}, "path": "server/src/test/java/org/elasticsearch/action/admin/cluster/node/info/NodesInfoRequestTests.java", "diffHunk": "@@ -0,0 +1,132 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.cluster.node.info;\n+\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.test.ESTestCase;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+/**\n+ * Granular tests for the {@link NodesInfoRequest} class. Higher-level tests\n+ * can be found in {@link org.elasticsearch.rest.action.admin.cluster.RestNodesInfoActionTests}.\n+ */\n+public class NodesInfoRequestTests extends ESTestCase {\n+\n+    /**\n+     * Make sure that we can set, serialize, and deserialize arbitrary sets\n+     * of metrics.\n+     */\n+    public void testMetricsSetters() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(randomAlphaOfLength(8));\n+        request.settings(randomBoolean());\n+        request.os(randomBoolean());\n+        request.process(randomBoolean());\n+        request.jvm(randomBoolean());\n+        request.threadPool(randomBoolean());\n+        request.transport(randomBoolean());\n+        request.http(randomBoolean());\n+        request.plugins(randomBoolean());\n+        request.ingest(randomBoolean());\n+        request.indices(randomBoolean());\n+        NodesInfoRequest deserializedRequest = roundTripRequest(request);\n+        assertThat(request.settings(), equalTo(deserializedRequest.settings()));\n+    }\n+\n+    /**\n+     * Test that a newly constructed NodesInfoRequestObject requests all of the\n+     * possible metrics defined in {@link NodesInfoRequest.Metrics}.\n+     */\n+    public void testNodesInfoRequestDefaults() {\n+        NodesInfoRequest defaultNodesInfoRequest = new NodesInfoRequest(randomAlphaOfLength(8));\n+        NodesInfoRequest allMetricsNodesInfoRequest = new NodesInfoRequest(randomAlphaOfLength(8));\n+        allMetricsNodesInfoRequest.all();\n+\n+        assertRequestsEqual(defaultNodesInfoRequest, allMetricsNodesInfoRequest);\n+    }\n+\n+    /**\n+     * Test that the {@link NodesInfoRequest#all()} method sets all of the\n+     * metrics to {@code true}.\n+     */\n+    public void testNodesInfoRequestAll() throws Exception {\n+        NodesInfoRequest request = new NodesInfoRequest(\"node\");\n+        request.all();\n+\n+        assertTrue(request.settings());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "31699047009720648908cd26aaff7f7ce8c38392"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "86da887119fe498b7cc0a741ba7e68c9ee7c2939", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/86da887119fe498b7cc0a741ba7e68c9ee7c2939", "committedDate": "2020-03-05T20:48:21Z", "message": "Add todos and fix test checks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3989d283d73d028ad0000c451650309d16ef15ce", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/3989d283d73d028ad0000c451650309d16ef15ce", "committedDate": "2020-03-05T21:52:42Z", "message": "Disable backwards compatibility tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1773, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}