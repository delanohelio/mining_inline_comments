{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTA4ODIx", "number": 57739, "title": "Compatible Api warnings logging", "bodyText": "Extending deprecation logger to also log compatible API warnings.\nThese warnings will be written to deprecation log file, data stream and will emit response warning header - the same as deprecation logs. In order to comply with constant keyword type of data_stream.datatype the value will have to be the same for compatible and deprecation log - elasticsearch.deprecation.\nThe compatible and deprecation logs will differ by elasticsearch.event.category  field which will always be  DeprecationCategory.COMPATIBLE_API for all compatible logs\ncloses #52369", "createdAt": "2020-06-05T14:55:54Z", "url": "https://github.com/elastic/elasticsearch/pull/57739", "merged": true, "mergeCommit": {"oid": "46de21bb5b71fb24d938d20c11ad1249471e7bca"}, "closed": true, "closedAt": "2021-02-15T18:28:00Z", "author": {"login": "pgomulka"}, "timelineItems": {"totalCount": 36, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpOf3LgFqTQyNjEyNzg0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABd6aTsSgH2gAyNDI4NTA4ODIxOjJiYTM5MTNmZWQ0YjE4ODg2NTQ5MjJjNmFhMzVkYzU4N2FjMTA0N2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTI3ODQ3", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-426127847", "createdAt": "2020-06-08T11:10:27Z", "commit": {"oid": "5f428f7d90a7d2218da47560d6d0b35f028ed27f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMToxMDoyN1rOGgZIwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMToxMDoyN1rOGgZIwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYxOTQ1OA==", "bodyText": "can't remember what we agreed. Do we throttle compatible API logs?", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436619458", "createdAt": "2020-06-08T11:10:27Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -79,12 +81,20 @@ public DeprecationLoggerBuilder deprecate(final String key, final String msg, fi\n \n     public class DeprecationLoggerBuilder {\n \n-        public DeprecationLoggerBuilder withDeprecation(String key, String msg, Object[] params) {\n+        public DeprecationLoggerBuilder withDeprecation(String key, String msg, Object... params) {\n             String opaqueId = HeaderWarning.getXOpaqueId();\n             ESLogMessage deprecationMessage = DeprecatedMessage.of(opaqueId, msg, params);\n             deprecationLogger.throttleLogAndAddWarning(key, deprecationMessage);\n             return this;\n         }\n \n+        public DeprecationLoggerBuilder compatibleApiWarning(String key, String msg, Object... params) {\n+            String opaqueId = HeaderWarning.getXOpaqueId();\n+            ESLogMessage deprecationMessage = DeprecatedMessage.compatibleDeprecationMessage(opaqueId, msg, params);\n+            compatibleLogger.throttleLogAndAddWarning(key, deprecationMessage);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f428f7d90a7d2218da47560d6d0b35f028ed27f"}, "originalPosition": 44}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTQ0ODE1", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-426144815", "createdAt": "2020-06-08T11:39:27Z", "commit": {"oid": "5f428f7d90a7d2218da47560d6d0b35f028ed27f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTozOToyOFrOGgZ6aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMTozOToyOFrOGgZ6aQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjYzMjE2OQ==", "bodyText": "I wonder if we should allow anything like this where a deprecation logger is fetched by name\n        final Logger testLogger = LogManager.getLogger(\"deprecation.test\");\nand used without DeprecationLogger and DeprecationMessage class", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436632169", "createdAt": "2020-06-08T11:39:28Z", "author": {"login": "pgomulka"}, "path": "qa/logging-config/src/test/java/org/elasticsearch/common/logging/JsonLoggerTests.java", "diffHunk": "@@ -172,7 +172,7 @@ public void testDeprecatedMessageWithoutXOpaqueId() throws IOException {\n         testLogger.info( DeprecatedMessage.of(\"someId\",\"deprecated message1\"));\n         testLogger.info( DeprecatedMessage.of(\"\",\"deprecated message2\"));\n         testLogger.info( DeprecatedMessage.of(null,\"deprecated message3\"));\n-        testLogger.info(\"deprecated message4\");\n+//        testLogger.info(\"deprecated message4\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f428f7d90a7d2218da47560d6d0b35f028ed27f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MjYxMzE4", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-426261318", "createdAt": "2020-06-08T13:48:44Z", "commit": {"oid": "f267c43a64a30a8cf59044905ed8f9fcf8c1360b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzo0ODo0NFrOGgfFqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMzo0ODo0NFrOGgfFqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjcxNjk2OA==", "bodyText": "Can this (and all other compatible warnings) be a past tense message that explains that what compatibly did ?\nFor this one...something like:\nHTTP compatibility was applied to this request. The GET request for /<index-name>/<type-name>/<id> was mapped to /<index-name>/_doc/<id>. \n\nWhere the actual index-name, type, and id are emitted to the log.", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r436716968", "createdAt": "2020-06-08T13:48:44Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestGetActionV7.java", "diffHunk": "@@ -33,10 +33,11 @@\n import static org.elasticsearch.rest.RestRequest.Method.HEAD;\n \n public class RestGetActionV7 extends RestGetAction {\n-\n-    private static final DeprecationLogger deprecationLogger = new DeprecationLogger(LogManager.getLogger(RestGetAction.class));\n     static final String TYPES_DEPRECATION_MESSAGE = \"[types removal] Specifying types in \"\n         + \"document get requests is deprecated, use the /{index}/_doc/{id} endpoint instead.\";\n+    static final String TYPED_API_COMPATIBLE_WARNING = \"Using typed version of Get API. Use /{index}/_doc/{id} instead.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f267c43a64a30a8cf59044905ed8f9fcf8c1360b"}, "originalPosition": 8}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cfd416d83a3d3b4d11c4fbba6abf72d931a8a904", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/cfd416d83a3d3b4d11c4fbba6abf72d931a8a904", "committedDate": "2020-06-16T14:48:24Z", "message": "Merge branch 'compat_rest_api' into compat/logger"}, "afterCommit": {"oid": "a5693adb252ad080734e0d0d9783ba1bb78d5fba", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5693adb252ad080734e0d0d9783ba1bb78d5fba", "committedDate": "2020-09-09T09:57:20Z", "message": "working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "684105c10260680250e9cd405fc2925f6824d42c", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/684105c10260680250e9cd405fc2925f6824d42c", "committedDate": "2021-02-02T13:40:12Z", "message": "draft\n\nworking\n\nremove test code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "032207a2ccc791d8e40f27b2b0c43ffca0589f63", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/032207a2ccc791d8e40f27b2b0c43ffca0589f63", "committedDate": "2021-02-02T15:50:31Z", "message": "remove the fluent builder, deprecatio ncategory"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "38ae7944d1f73381dbed62f8cb5256fe00feb325", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/38ae7944d1f73381dbed62f8cb5256fe00feb325", "committedDate": "2020-09-09T11:54:57Z", "message": "remove test code"}, "afterCommit": {"oid": "032207a2ccc791d8e40f27b2b0c43ffca0589f63", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/032207a2ccc791d8e40f27b2b0c43ffca0589f63", "committedDate": "2021-02-02T15:50:31Z", "message": "remove the fluent builder, deprecatio ncategory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5245263ff1f8b07ad5bb32d89553331b2032d955", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/5245263ff1f8b07ad5bb32d89553331b2032d955", "committedDate": "2021-02-03T08:09:21Z", "message": "line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "081d95d0a0b1ae2871b87e603e72d24bac868a63", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/081d95d0a0b1ae2871b87e603e72d24bac868a63", "committedDate": "2021-02-04T13:36:09Z", "message": "make data_stream.dataset not hardcoded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eefca46fc5c1f2148db375df6ff61cbe106c59cd", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/eefca46fc5c1f2148db375df6ff61cbe106c59cd", "committedDate": "2021-02-04T14:50:19Z", "message": "remove dataset from indexing deprecation logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd2c699d2f476e4a2c3ed485511d67caa586ced", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/2fd2c699d2f476e4a2c3ed485511d67caa586ced", "committedDate": "2021-02-04T15:07:35Z", "message": "make datastream field always the same for deprecation logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f95a11ee663f98b034f2ba1b86c3d53e91db7cd8", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/f95a11ee663f98b034f2ba1b86c3d53e91db7cd8", "committedDate": "2021-02-04T15:22:40Z", "message": " headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4f4acba07b47276f4e9d78e77bf1c1377021a5", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa4f4acba07b47276f4e9d78e77bf1c1377021a5", "committedDate": "2021-02-04T15:23:02Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b11825f44dc39ae51753fa32dba0eb79afc8d2a5", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/b11825f44dc39ae51753fa32dba0eb79afc8d2a5", "committedDate": "2021-02-04T15:53:06Z", "message": "cleanup and comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84f5c862782f65f8a71f37c3ef005af3b45f1e9c", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/84f5c862782f65f8a71f37c3ef005af3b45f1e9c", "committedDate": "2021-02-04T15:57:24Z", "message": "empty line remove"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e47e3a649f2369606ca2097c4ef0ab6a54549f0", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e47e3a649f2369606ca2097c4ef0ab6a54549f0", "committedDate": "2021-02-04T16:52:01Z", "message": "test indexing compatible logs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f64a849db60a6512d5b6c3e74252d4a2ae44668", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f64a849db60a6512d5b6c3e74252d4a2ae44668", "committedDate": "2021-02-04T17:01:14Z", "message": "codestyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTgzNjE4NjI4", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-583618628", "createdAt": "2021-02-04T17:06:05Z", "commit": {"oid": "7f64a849db60a6512d5b6c3e74252d4a2ae44668"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNFQxNzowNjowNlrOIf-CoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNFQxNzowNjowNlrOIf-CoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MDM5MzI0OQ==", "bodyText": "we always create two loggers when using deprecationLogger. But often it won't be necessary. I wonder what is the performance penalty.\nWe could create a CompatibleLogger that would inherit DeprecationLogger and would allow to create two loggers and would have two logging methods compatibleApiWarning and deprecate.\n@pugnascotia WDYT?", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r570393249", "createdAt": "2021-02-04T17:06:06Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -54,16 +51,21 @@ public static DeprecationLogger getLogger(Class<?> aClass) {\n      * the \"org.elasticsearch\" namespace.\n      */\n     public static DeprecationLogger getLogger(String name) {\n-        return new DeprecationLogger(getDeprecatedLoggerForName(name));\n+        return new DeprecationLogger(name);\n+    }\n+\n+    private DeprecationLogger(String parentLoggerName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7f64a849db60a6512d5b6c3e74252d4a2ae44668"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg0MzU3ODk2", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-584357896", "createdAt": "2021-02-05T13:55:54Z", "commit": {"oid": "7f64a849db60a6512d5b6c3e74252d4a2ae44668"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fc80dbeafe9165eba517a260018097aad6582f4", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fc80dbeafe9165eba517a260018097aad6582f4", "committedDate": "2021-02-05T14:43:43Z", "message": "remove unnecessary compatible logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "345963b22025304644675b2de32c516c00c4d781", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/345963b22025304644675b2de32c516c00c4d781", "committedDate": "2021-02-05T14:45:39Z", "message": "test rename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg0NDI1MTk0", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-584425194", "createdAt": "2021-02-05T15:07:56Z", "commit": {"oid": "345963b22025304644675b2de32c516c00c4d781"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQxNTowNzo1NlrOIglKOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wNVQxNTowNzo1NlrOIglKOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MTAzNDE3MA==", "bodyText": "Do we still need these lines?", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r571034170", "createdAt": "2021-02-05T15:07:56Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingComponent.java", "diffHunk": "@@ -78,11 +78,13 @@ public DeprecationIndexingComponent(Client client, Settings settings) {\n     protected void doStart() {\n         this.appender.start();\n         Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.deprecation\"), this.appender);\n+        Loggers.addAppender(LogManager.getLogger(\"org.elasticsearch.compatible\"), this.appender);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "345963b22025304644675b2de32c516c00c4d781"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8e93780f6e7ed37c75f79798dc2c7c5e5a2a9d9", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8e93780f6e7ed37c75f79798dc2c7c5e5a2a9d9", "committedDate": "2021-02-06T09:30:43Z", "message": "do no add appender to non existing logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/af2f2ad32b0aef6838303326dac12d3a23922143", "committedDate": "2021-02-08T08:02:03Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg1NDMyNDA5", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-585432409", "createdAt": "2021-02-08T12:07:23Z", "commit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg2ODQ5NDc2", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-586849476", "createdAt": "2021-02-09T18:10:39Z", "commit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOVQxODoxMDozOVrOIikW9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMi0wOVQxODoyNzozOFrOIilGag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzExODE5OA==", "bodyText": "Is required to accept a prefix ? (won't it always be deprecation ? (and shouldn't it always be deprecation ?)", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573118198", "createdAt": "2021-02-09T18:10:39Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -54,16 +50,20 @@ public static DeprecationLogger getLogger(Class<?> aClass) {\n      * the \"org.elasticsearch\" namespace.\n      */\n     public static DeprecationLogger getLogger(String name) {\n-        return new DeprecationLogger(getDeprecatedLoggerForName(name));\n+        return new DeprecationLogger(name);\n+    }\n+\n+    private DeprecationLogger(String parentLoggerName) {\n+        this.logger = LogManager.getLogger(getLoggerName(parentLoggerName, \"deprecation\"));\n     }\n \n-    private static Logger getDeprecatedLoggerForName(String name) {\n+    private static String getLoggerName(String name, String prefix) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEyODQ2OQ==", "bodyText": "I wonder if we should leave this class as-is and require the user to pass the CompatibleApi category. Now that we are re-using this log and logger, it feels abit off for this to be special enough to warrant it's own method.", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573128469", "createdAt": "2021-02-09T18:24:57Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/common/logging/DeprecationLogger.java", "diffHunk": "@@ -75,23 +75,25 @@ private static String toLoggerName(final Class<?> cls) {\n      * Logs a message at the {@link #DEPRECATION} level. The message is also sent to the header warning logger,\n      * so that it can be returned to the client.\n      */\n-    public DeprecationLoggerBuilder deprecate(\n+    public DeprecationLogger deprecate(\n         final DeprecationCategory category,\n         final String key,\n         final String msg,\n         final Object... params\n     ) {\n-        return new DeprecationLoggerBuilder().withDeprecation(category, key, msg, params);\n+        ESLogMessage deprecationMessage = DeprecatedMessage.of(category, key, HeaderWarning.getXOpaqueId(), msg, params);\n+        logger.log(DEPRECATION, deprecationMessage);\n+        return this;\n     }\n \n-    public class DeprecationLoggerBuilder {\n-\n-        public DeprecationLoggerBuilder withDeprecation(DeprecationCategory category, String key, String msg, Object[] params) {\n-            ESLogMessage deprecationMessage = DeprecatedMessage.of(category, key, HeaderWarning.getXOpaqueId(), msg, params);\n-\n-            logger.log(DEPRECATION, deprecationMessage);\n-\n-            return this;\n-        }\n+    public DeprecationLogger compatibleApiWarning(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU3MzEzMDM0Ng==", "bodyText": "should we also test the HTTP response warning ?", "url": "https://github.com/elastic/elasticsearch/pull/57739#discussion_r573130346", "createdAt": "2021-02-09T18:27:38Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/DeprecationHttpIT.java", "diffHunk": "@@ -320,6 +321,131 @@ public void testDeprecationMessagesCanBeIndexed() throws Exception {\n         }\n     }\n \n+    /**\n+     * Check that compatible api log messages can be recorded to an index\n+     */\n+    public void testCompatibleMessagesCanBeIndexed() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "af2f2ad32b0aef6838303326dac12d3a23922143"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "105fe533dad92b4a0e160dbba268a24aa11f2c07", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/105fe533dad92b4a0e160dbba268a24aa11f2c07", "committedDate": "2021-02-10T08:56:10Z", "message": "logger"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTg4OTA1NTU0", "url": "https://github.com/elastic/elasticsearch/pull/57739#pullrequestreview-588905554", "createdAt": "2021-02-11T19:21:50Z", "commit": {"oid": "105fe533dad92b4a0e160dbba268a24aa11f2c07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e04acbffc7e0c85d629a2c32976ad1c9094e6dde", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e04acbffc7e0c85d629a2c32976ad1c9094e6dde", "committedDate": "2021-02-11T19:22:06Z", "message": "Merge branch 'master' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "558ec36838420a3832df728223af22f1ded011fc", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/558ec36838420a3832df728223af22f1ded011fc", "committedDate": "2021-02-15T09:30:21Z", "message": "compile fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57a685b0bdc4adbb63865a1379f202917289bf5e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/57a685b0bdc4adbb63865a1379f202917289bf5e", "committedDate": "2021-02-15T09:30:25Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbe2871141b72d3e90ca5e3ff6fb7989955d0015", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbe2871141b72d3e90ca5e3ff6fb7989955d0015", "committedDate": "2021-02-15T11:15:02Z", "message": "Merge branch 'master' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfb35643859f09a7e82906282309cf775fcb2ba8", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfb35643859f09a7e82906282309cf775fcb2ba8", "committedDate": "2021-02-15T14:48:53Z", "message": "Merge branch 'master' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15ecd8ea6d25949869e2a25accd6ec05e5b37483", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/15ecd8ea6d25949869e2a25accd6ec05e5b37483", "committedDate": "2021-02-15T15:14:08Z", "message": "Merge remote-tracking branch 'pgomulka/compat/logger' into compat/logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1044b1a8b6c7458eac9e6d7bda1af33fccf34a1e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/1044b1a8b6c7458eac9e6d7bda1af33fccf34a1e", "committedDate": "2021-02-15T15:46:32Z", "message": "precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba3913fed4b1888654922c6aa35dc587ac1047a", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ba3913fed4b1888654922c6aa35dc587ac1047a", "committedDate": "2021-02-15T16:43:53Z", "message": "adding assert"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3753, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}