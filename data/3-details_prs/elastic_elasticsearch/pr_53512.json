{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3NDM5MjM4", "number": 53512, "title": "Mask wildcard query special characters on keyword queries (#53127)", "bodyText": "Wildcard queries on keyword fields get normalized, however this normalization\nstep should exclude the two special characters * and ? in order to keep the\nwildcard query itself intact.\nBackport of #53127\nChanges wrt. the commit on master: also changed TypeFieldType to extend ConstantFieldType, but we still need to support matching \"_type\" values other than \"_doc\" on 7.x. Also there were tests checking that range queries on types work that are not there anymore on master, but this still seems to work on 7.x so I left the range implementation in TypeFieldType but had to adapt it slightly after changing the supertype.", "createdAt": "2020-03-12T19:46:34Z", "url": "https://github.com/elastic/elasticsearch/pull/53512", "merged": true, "mergeCommit": {"oid": "1c1730facd416c3f8f1d6345962faff483279266"}, "closed": true, "closedAt": "2020-03-24T16:22:30Z", "author": {"login": "cbuescher"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcNBDegAH2gAyMzg3NDM5MjM4OmRmZTFhMTBhYzQzNjE4MzJlYjc5M2QzZDIyMjU5MzQ1MjUwNmMxMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQ0dqaAH2gAyMzg3NDM5MjM4OmY4MzU1YTJhMDk0ZjYyNWIzN2FjYTRjY2RhN2FhYmUyYjIxZjA2NmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dfe1a10ac4361832eb793d3d222593452506c117", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfe1a10ac4361832eb793d3d222593452506c117", "committedDate": "2020-03-12T19:40:48Z", "message": "Mask wildcard query special characters on keyword queries (#53127)\n\nWildcard queries on keyword fields get normalized, however this normalization\nstep should exclude the two special characters * and ? in order to keep the\nwildcard query itself intact.\n\nCloses #46300"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODUzMTQw", "url": "https://github.com/elastic/elasticsearch/pull/53512#pullrequestreview-373853140", "createdAt": "2020-03-12T19:48:13Z", "commit": {"oid": "dfe1a10ac4361832eb793d3d222593452506c117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo0ODoxM1rOF1s0aA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo0ODoxM1rOF1s0aA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1MzE2MA==", "bodyText": "I left this test and added this special case in ConstantFieldType#termQuery because we might still need to support it on 7.x? Happy to remove if its safe but I'm not too familiar with this area.", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r391853160", "createdAt": "2020-03-12T19:48:13Z", "author": {"login": "cbuescher"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/TypeFieldTypeTests.java", "diffHunk": "@@ -53,26 +53,25 @@ public void testTermsQuery() throws Exception {\n         MapperService mapperService = Mockito.mock(MapperService.class);\n         Mockito.when(mapperService.documentMapper()).thenReturn(null);\n         Mockito.when(context.getMapperService()).thenReturn(mapperService);\n+        DocumentMapper mapper = Mockito.mock(DocumentMapper.class);\n+        Mockito.when(mapper.type()).thenReturn(\"_doc\");\n+        Mockito.when(mapperService.documentMapper()).thenReturn(mapper);\n \n         TypeFieldMapper.TypeFieldType ft = new TypeFieldMapper.TypeFieldType();\n         ft.setName(TypeFieldMapper.NAME);\n-        Query query = ft.termQuery(\"my_type\", context);\n+\n+        Query query = ft.termQuery(\"_doc\", context);\n+        assertEquals(new MatchAllDocsQuery(), query);\n+\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(new MatchNoDocsQuery(), query);\n \n-        DocumentMapper mapper = Mockito.mock(DocumentMapper.class);\n-        Mockito.when(mapper.type()).thenReturn(\"my_type\");\n-        Mockito.when(mapperService.documentMapper()).thenReturn(mapper);\n-        query = ft.termQuery(\"my_type\", context);\n+        Mockito.when(mapper.type()).thenReturn(\"other_type\");\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(new MatchAllDocsQuery(), query);\n \n         Mockito.when(mapperService.hasNested()).thenReturn(true);\n-        query = ft.termQuery(\"my_type\", context);\n+        query = ft.termQuery(\"other_type\", context);\n         assertEquals(Queries.newNonNestedFilter(context.indexVersionCreated()), query);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe1a10ac4361832eb793d3d222593452506c117"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczODUzNDM5", "url": "https://github.com/elastic/elasticsearch/pull/53512#pullrequestreview-373853439", "createdAt": "2020-03-12T19:48:44Z", "commit": {"oid": "dfe1a10ac4361832eb793d3d222593452506c117"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo0ODo0NVrOF1s1VQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxOTo0ODo0NVrOF1s1VQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTg1MzM5Nw==", "bodyText": "See comment in tests below, I wasn't sure if on 7.x we still need this so left it here for discussion.", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r391853397", "createdAt": "2020-03-12T19:48:45Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConstantFieldType.java", "diffHunk": "@@ -79,6 +79,10 @@ private static String valueToString(Object value) {\n     public final Query termQuery(Object value, QueryShardContext context) {\n         String pattern = valueToString(value);\n         if (matches(pattern, context)) {\n+            if (context != null && context.getMapperService().hasNested()) {\n+                // type filters are expected not to match nested docs\n+                return Queries.newNonNestedFilter(context.indexVersionCreated());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfe1a10ac4361832eb793d3d222593452506c117"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "committedDate": "2020-03-13T10:57:05Z", "message": "Changing TypeFieldType back to extend StringFieldType on 7.x"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "158edb88dc1a705bb0e8447fc9f9fed82482f786", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/158edb88dc1a705bb0e8447fc9f9fed82482f786", "committedDate": "2020-03-13T10:19:49Z", "message": "Changing TypeFieldType back to extend StringFieldType on 7.x"}, "afterCommit": {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b8e6628b2aacc701cd01419e7615ca1eb640c1a", "committedDate": "2020-03-13T10:57:05Z", "message": "Changing TypeFieldType back to extend StringFieldType on 7.x"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0Mjc1NDM2", "url": "https://github.com/elastic/elasticsearch/pull/53512#pullrequestreview-374275436", "createdAt": "2020-03-13T12:54:35Z", "commit": {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjo1NDozNVrOF2CjHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QxMjo1NDozNVrOF2CjHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjIwOTE4Mg==", "bodyText": "I removed this test for wildcard queries on \"_type\" fields. These don't return anything useful at the moment already, however before the change in this PR we still got an empty response while now we get an error because \"_type\" is not indexed. I don't know if we can tolerate this, otherwise I need to add a very simple wildcard implementation to TypeFieldType again.", "url": "https://github.com/elastic/elasticsearch/pull/53512#discussion_r392209182", "createdAt": "2020-03-13T12:54:35Z", "author": {"login": "cbuescher"}, "path": "server/src/test/java/org/elasticsearch/index/query/WildcardQueryBuilderTests.java", "diffHunk": "@@ -133,19 +136,13 @@ public void testParseFailsWithMultipleFields() throws IOException {\n         assertEquals(\"[wildcard] query doesn't support multiple fields, found [user1] and [user2]\", e.getMessage());\n     }\n \n-    public void testTypeField() throws IOException {\n-        WildcardQueryBuilder builder = QueryBuilders.wildcardQuery(\"_type\", \"doc*\");\n-        builder.doToQuery(createShardContext());\n-        assertWarnings(QueryShardContext.TYPES_DEPRECATION_MESSAGE);\n-    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwMzg0MTUy", "url": "https://github.com/elastic/elasticsearch/pull/53512#pullrequestreview-380384152", "createdAt": "2020-03-24T14:48:27Z", "commit": {"oid": "0b8e6628b2aacc701cd01419e7615ca1eb640c1a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4ee30cb900ad8b4de29a6fd9c40e7ec5c968e1d", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4ee30cb900ad8b4de29a6fd9c40e7ec5c968e1d", "committedDate": "2020-03-24T15:07:41Z", "message": "Merge branch '7.x' of github.com:elastic/elasticsearch into backport-53127"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8355a2a094f625b37aca4ccda7aabe2b21f066e", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8355a2a094f625b37aca4ccda7aabe2b21f066e", "committedDate": "2020-03-24T15:16:20Z", "message": "Move old wildcardQuery impl from StringFieldType to TypeFieldType for bwc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1365, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}