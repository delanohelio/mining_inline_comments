{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTIxMTMy", "number": 60315, "title": "[ML] require alias when indexing to an alias that should be created", "bodyText": "This sets up all indexing to one of our write aliases to require it actually be an alias.\nThis allows failures scenarios to be captured quickly, loudly, and then potentially recovered.\nI purposefully did not add any recovery code. This is so we can test it out in integration tests and then see where recovery scenarios are necessary.", "createdAt": "2020-07-28T16:30:15Z", "url": "https://github.com/elastic/elasticsearch/pull/60315", "merged": true, "mergeCommit": {"oid": "8751911e7342226617ae4cf5a70a453f5020c987"}, "closed": true, "closedAt": "2020-07-29T13:57:21Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5Y9u9gH2gAyNDU3OTIxMTMyOjJlOTE4M2RhNjgzYWI2Y2JlNTk3NDNhMmNiMGRiYmMyMjU5NjJjMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5p6OMAFqTQ1NzQ1NzY5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2e9183da683ab6cbe59743a2cb0dbbc225962c19", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e9183da683ab6cbe59743a2cb0dbbc225962c19", "committedDate": "2020-07-28T16:24:55Z", "message": "[ML] require alias when indexing to an alias that should be created"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d586a15181ac8446f1b244f3dd7f1f49ab1815f", "committedDate": "2020-07-28T19:59:03Z", "message": "Merge branch 'master' into feature/ml-prevent-index-auto-creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjY5MTEx", "url": "https://github.com/elastic/elasticsearch/pull/60315#pullrequestreview-457269111", "createdAt": "2020-07-29T07:39:48Z", "commit": {"oid": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzozOTo0OFrOG4sY1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzo0MjozN1rOG4se-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMDY5Mw==", "bodyText": "Just to make sure: would you also like to add the requireAlias(true) to the index requests in integration tests (like RevertModelSnapshotIT.java in line 217)? Or do you find it unnecessary?", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462100693", "createdAt": "2020-07-29T07:39:48Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/annotations/AnnotationPersister.java", "diffHunk": "@@ -74,7 +74,7 @@ public Builder bulkPersisterBuilder(String jobId) {\n     public class Builder {\n \n         private final String jobId;\n-        private BulkRequest bulkRequest = new BulkRequest(AnnotationIndex.WRITE_ALIAS_NAME);\n+        private BulkRequest bulkRequest = new BulkRequest(AnnotationIndex.WRITE_ALIAS_NAME).requireAlias(true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjEwMjI2NA==", "bodyText": "One concern I have about this pattern of figuring out the value of requireAlias is that we need to be very careful to provide it with the right value as there is nothing (other than reading the code ;)) that could help us here.\nIdeally, I would like to see AnomalyDetectorsIndex.jobStateIndexWriteAlias() (and other methods of this kind) return a tuple (AliasOrIndex) with two fields: name and isAlias. This way the two pieces of information would be bundled together.\nHowever, this may be a big code change and the benefits are not easy to measure.\nAlternatively, you could have a local variable boolean requireAlias initialized to true in line 296 and set to false in line 298. This way, the decisions whether to use alias or index and whether to require alias would be logically grouped.", "url": "https://github.com/elastic/elasticsearch/pull/60315#discussion_r462102264", "createdAt": "2020-07-29T07:42:37Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -299,6 +299,7 @@ static void persistProgress(Client client, String jobId, Runnable runnable) {\n                 }\n                 IndexRequest indexRequest = new IndexRequest(indexOrAlias)\n                     .id(progressDocId)\n+                    .setRequireAlias(AnomalyDetectorsIndex.jobStateIndexWriteAlias().equals(indexOrAlias))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d586a15181ac8446f1b244f3dd7f1f49ab1815f"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d873de76f19de271f79781958869db01f2e57c26", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/d873de76f19de271f79781958869db01f2e57c26", "committedDate": "2020-07-29T11:51:50Z", "message": "adding require alias to integration tests as well"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDU3Njk1", "url": "https://github.com/elastic/elasticsearch/pull/60315#pullrequestreview-457457695", "createdAt": "2020-07-29T12:09:28Z", "commit": {"oid": "d873de76f19de271f79781958869db01f2e57c26"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3710, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}