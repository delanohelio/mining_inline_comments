{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMDAzMDY1", "number": 66317, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxMjo1M1rOFFajGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NzowOFrOFG_A9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjIyMTY4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxMjo1M1rOIF6l3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QwNDozODozNlrOIHkXGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw==", "bodyText": "I changed this to have an empty name so that the deprecation message generated by LoggingDeprecationHandler does not include the location of the deprecated id field. The value of location is somehow random in the yml test and makes it impossible to match with the warnings directive. Please let me know if there is another preferred solution.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543073757", "createdAt": "2020-12-15T06:12:53Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3ODk4Nw==", "bodyText": "I don't think we should remove location information that would be useful to clients just to help a yml test.\nDoes the yml test need to care?", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543078987", "createdAt": "2020-12-15T06:26:09Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw=="}, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5MTA5Mg==", "bodyText": "A warning message is emitted during the yml test that uses the deprecated id field. If not caught, the yml test fails. But there is not existing way we can catch this because:\n\nwarnings directive requires exact match\nThe location value is unstable during the test, it could be [invalidate_api_key][-1:8] Deprecated field ... for one run and [invalidate_api_key][1:4] Deprecated field ... for another, and some other value for the yet another.\n\nI didn't look into why the value is unstable. There could be value in fixing it? But I noticed that none of the deprecate warning messages in our tests care about the location values, i.e. they opt out of showing the location. For example, updateBy query passes null for parser name so that no location would be shown. Also GetDataFeeds does the same thing as well. I could not find any existing examples that try to match these locations. So I assumed it is not important.\nWith above being said, if we do wanna keep the parser name and in turn the location value, we have a few options:\n\nRemove the yml test that uses the deprecated id field. We can have an unit test for the deprecation message.\nOr fix the unstable location value in yaml test. I suspect it is caused by how payload is prepared by the yaml test and the fix could take some time.\nOr enhance the warnings directive so it can match a regex.\n\nI prefer option 1. What do you think? I doubt I am the first person to have this issue given deprecation messages are such a common thing. So maybe I am missing something obvious, please let me know.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543791092", "createdAt": "2020-12-16T00:39:51Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw=="}, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzkwMzM1OA==", "bodyText": "I didn't look into why the value is unstable\n\nI assume it's because we randomise the input. The YML Rest tests will randomly send the body in JSON/YAML/SMILE/etc, and might (I can't remember off hand) also randomise the order.\nOption 1 makes sense to me.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543903358", "createdAt": "2020-12-16T03:51:49Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw=="}, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDgwNjY4MA==", "bodyText": "Option 1 implemented. Also removed the yml test and doc example of using the deprecated id field, which imo is overall benefiical because it's better to not advertise the deprecated usages.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r544806680", "createdAt": "2020-12-17T04:38:36Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw=="}, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjIzODc0OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxOTowOFrOIF6vDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxOTowOFrOIF6vDg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NjExMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when there are multiple of them\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + Arrays.toString(ids));", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543076110", "createdAt": "2020-12-15T06:19:08Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -78,8 +104,19 @@ public String getUserName() {\n         return userName;\n     }\n \n+    @Deprecated\n     public String getId() {\n-        return id;\n+        if (ids == null) {\n+            return null;\n+        } else if (ids.length == 1) {\n+            return ids[0];\n+        } else {\n+            throw new IllegalArgumentException(\"Cannot get a single api key id when there are multiple of them\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQxMjI0MDY1OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxOTo0MlrOIF6wDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxOTo0MlrOIF6wDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NjM2NQ==", "bodyText": "Should this be a List instead? Then it can be truly immutable.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543076365", "createdAt": "2020-12-15T06:19:42Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -34,38 +36,62 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n+    private final String[] ids;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODY4MDc4OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NjoyN1rOIIQESQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NjoyN1rOIIQESQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMjc2MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + ids);\n          \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set [\" + Strings.collectionToCommaDelimitedString(ids) + \"]\");\n          \n      \n    \n    \n  \n\nThere's no guarantee that List.toString will be what we want.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r545522761", "createdAt": "2020-12-18T01:56:27Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -78,8 +105,19 @@ public String getUserName() {\n         return userName;\n     }\n \n+    @Deprecated\n     public String getId() {\n-        return id;\n+        if (ids == null) {\n+            return null;\n+        } else if (ids.size() == 1) {\n+            return ids.get(0);\n+        } else {\n+            throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + ids);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzQyODY4MjE0OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NzowOFrOIIQFDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMjo1MzowNFrOIIRIww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMjk1OQ==", "bodyText": "Should this be an immutable copy?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.ids = apiKeyIds;\n          \n          \n            \n                    this.ids = List.copyOf(apiKeyIds);", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r545522959", "createdAt": "2020-12-18T01:57:08Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -34,38 +37,62 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n+    private final List<String> ids;\n     private final String name;\n     private final boolean ownedByAuthenticatedUser;\n \n     // pkg scope for testing\n+    @Deprecated\n     InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName, @Nullable String apiKeyId,\n                             @Nullable String apiKeyName, boolean ownedByAuthenticatedUser) {\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(apiKeyId) == false\n-                && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n-            throwValidationError(\"One of [api key id, api key name, username, realm name] must be specified if [owner] flag is false\");\n+        this(realmName, userName, apiKeyName, ownedByAuthenticatedUser, apiKeyIdToIds(apiKeyId));\n+    }\n+\n+    InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName,\n+                            @Nullable String apiKeyName, boolean ownedByAuthenticatedUser, @Nullable List<String> apiKeyIds) {\n+        validateApiKeyIds(apiKeyIds);\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && apiKeyIds == null\n+            && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n+            throwValidationError(\"One of [api key id(s), api key name, username, realm name] must be specified if [owner] flag is false\");\n         }\n-        if (Strings.hasText(apiKeyId) || Strings.hasText(apiKeyName)) {\n+        if (apiKeyIds != null || Strings.hasText(apiKeyName)) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\n-                        \"username or realm name must not be specified when the api key id or api key name is specified\");\n+                    \"username or realm name must not be specified when the api key id(s) or api key name is specified\");\n             }\n         }\n         if (ownedByAuthenticatedUser) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\"neither username nor realm-name may be specified when invalidating owned API keys\");\n             }\n         }\n-        if (Strings.hasText(apiKeyId) && Strings.hasText(apiKeyName)) {\n-            throwValidationError(\"only one of [api key id, api key name] can be specified\");\n+        if (apiKeyIds != null && Strings.hasText(apiKeyName)) {\n+            throwValidationError(\"only one of [api key id(s), api key name] can be specified\");\n         }\n         this.realmName = realmName;\n         this.userName = userName;\n-        this.id = apiKeyId;\n+        this.ids = apiKeyIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTU0MDI5MQ==", "bodyText": "Absolutely! Thanks for noticing.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r545540291", "createdAt": "2020-12-18T02:53:04Z", "author": {"login": "ywangd"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -34,38 +37,62 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n+    private final List<String> ids;\n     private final String name;\n     private final boolean ownedByAuthenticatedUser;\n \n     // pkg scope for testing\n+    @Deprecated\n     InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName, @Nullable String apiKeyId,\n                             @Nullable String apiKeyName, boolean ownedByAuthenticatedUser) {\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(apiKeyId) == false\n-                && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n-            throwValidationError(\"One of [api key id, api key name, username, realm name] must be specified if [owner] flag is false\");\n+        this(realmName, userName, apiKeyName, ownedByAuthenticatedUser, apiKeyIdToIds(apiKeyId));\n+    }\n+\n+    InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName,\n+                            @Nullable String apiKeyName, boolean ownedByAuthenticatedUser, @Nullable List<String> apiKeyIds) {\n+        validateApiKeyIds(apiKeyIds);\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && apiKeyIds == null\n+            && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n+            throwValidationError(\"One of [api key id(s), api key name, username, realm name] must be specified if [owner] flag is false\");\n         }\n-        if (Strings.hasText(apiKeyId) || Strings.hasText(apiKeyName)) {\n+        if (apiKeyIds != null || Strings.hasText(apiKeyName)) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\n-                        \"username or realm name must not be specified when the api key id or api key name is specified\");\n+                    \"username or realm name must not be specified when the api key id(s) or api key name is specified\");\n             }\n         }\n         if (ownedByAuthenticatedUser) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\"neither username nor realm-name may be specified when invalidating owned API keys\");\n             }\n         }\n-        if (Strings.hasText(apiKeyId) && Strings.hasText(apiKeyName)) {\n-            throwValidationError(\"only one of [api key id, api key name] can be specified\");\n+        if (apiKeyIds != null && Strings.hasText(apiKeyName)) {\n+            throwValidationError(\"only one of [api key id(s), api key name] can be specified\");\n         }\n         this.realmName = realmName;\n         this.userName = userName;\n-        this.id = apiKeyId;\n+        this.ids = apiKeyIds;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMjk1OQ=="}, "originalCommit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4597, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}