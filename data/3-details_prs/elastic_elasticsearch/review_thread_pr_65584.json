{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NDQ4NTU4", "number": 65584, "reviewThreads": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyNTozMlrOE_hseQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozOTozMFrOFBwkGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDQ3ODAxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyNTozMlrOH9Rrww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyNTozMlrOH9Rrww==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDkxNQ==", "bodyText": "Shouldn't it be plural here as well?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534014915", "createdAt": "2020-12-02T09:25:32Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -64,6 +65,8 @@\n \n     private static final Map<String, BucketKeyExtractor> BUCKET_KEY_EXTRACTOR_MAP;\n     private static final BucketKeyExtractor DEFAULT_BUCKET_KEY_EXTRACTOR = new DefaultBucketKeyExtractor();\n+    private static final BucketKeyExtractor DATE_AS_EPOCH_BUCKET_KEY_EXTRACTOR = new DateAsEpochBucketKeyExtractor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDQ5MTUzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyODozM1rOH9R0Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMTo1OToxOFrOH_N0cA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzA0Ng==", "bodyText": "You use formatMillis here for formatting but in the line above you check that the type is DateFieldMapper.DATE_NANOS_CONTENT_TYPE.\nPlease double-check it works as expected in case of nanos.", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534017046", "createdAt": "2020-12-02T09:28:33Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {\n \n+        @Override\n+        public Object value(Object key, String type) {\n+            if (isNumericType(type) && key instanceof Double) {\n+                return dropFloatingPointComponentIfTypeRequiresIt(type, (Double) key);\n+            } else if ((DateFieldMapper.CONTENT_TYPE.equals(type) || DateFieldMapper.DATE_NANOS_CONTENT_TYPE.equals(type))\n+                && key instanceof Long) {\n+                    return DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.formatMillis((Long) key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0ODc1Mg==", "bodyText": "\ud83d\udc4d checked, I will create a code comment", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r536048752", "createdAt": "2020-12-04T11:59:18Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {\n \n+        @Override\n+        public Object value(Object key, String type) {\n+            if (isNumericType(type) && key instanceof Double) {\n+                return dropFloatingPointComponentIfTypeRequiresIt(type, (Double) key);\n+            } else if ((DateFieldMapper.CONTENT_TYPE.equals(type) || DateFieldMapper.DATE_NANOS_CONTENT_TYPE.equals(type))\n+                && key instanceof Long) {\n+                    return DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.formatMillis((Long) key);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzA0Ng=="}, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUwMjE3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMDo1MVrOH9R6aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMDo1MVrOH9R6aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxODY2Nw==", "bodyText": "Would this class benefit from unit tests or is the current coverage enough?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534018667", "createdAt": "2020-12-02T09:30:51Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 52}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUwODQ2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjoyMFrOH9R-WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozMjoyMFrOH9R-WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTY3Mg==", "bodyText": "datesAsEpochMillis?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534019672", "createdAt": "2020-12-02T09:32:20Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUxNTk5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozNDoxMVrOH9SDHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozNDoxMVrOH9SDHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMDg5Mw==", "bodyText": "Why is this the only test that does it? Wouldn't it be applicable for example for DateHistogramGroupByOtherTimeFieldIT.java as well?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534020893", "createdAt": "2020-12-02T09:34:11Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;\n \n     public DateHistogramGroupByIT() {\n         missing = randomBoolean();\n+        dateAsEpochMillis = randomBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUzMzE3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozODoxN1rOH9SOBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozODoxN1rOH9SOBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzY4NQ==", "bodyText": "Do you mean it to stay or was it just for debug?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023685", "createdAt": "2020-12-02T09:38:17Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -111,12 +149,19 @@ public boolean equals(Object other) {\n         }\n \n         SettingsConfig that = (SettingsConfig) other;\n-        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize) && Objects.equals(docsPerSecond, that.docsPerSecond);\n+        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize)\n+            && Objects.equals(docsPerSecond, that.docsPerSecond)\n+            && Objects.equals(datesAsEpochMillis, that.datesAsEpochMillis);\n     }\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(maxPageSearchSize, docsPerSecond);\n+        return Objects.hash(maxPageSearchSize, docsPerSecond, datesAsEpochMillis);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return Strings.toString(this, true, true) + \" wdaem: \" + this.datesAsEpochMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 126}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDUzMzgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozODoyNVrOH9SOdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTozODoyNVrOH9SOdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzc5Nw==", "bodyText": "plural?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023797", "createdAt": "2020-12-02T09:38:25Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -126,13 +171,12 @@ public static SettingsConfig fromXContent(final XContentParser parser, boolean l\n     public static class Builder {\n         private Integer maxPageSearchSize;\n         private Float docsPerSecond;\n+        private Integer dateAsEpochMilli;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU0MzE4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0MDozMFrOH9SURA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxMjowMDo0MFrOH_N3bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA==", "bodyText": "Is this deprecation related to handling dates?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534025284", "createdAt": "2020-12-02T09:40:30Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -449,12 +449,17 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n         // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        if (transformConfig.getVersion() != null\n+            && transformConfig.getVersion().onOrAfter(Version.V_8_0_0) // todo: V_7_11_0\n+            && (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDMyMjY2Mw==", "bodyText": "ok, the code comment is outdated, will change it. What this does is basically rewriting the config to the latest format. The problem is as follows, a transform <7.11 will write millis, 7.11> will write strings (note the version is the version of the transform, not the es version). If update is called, it always updates the version field, a former 7.6 transform becomes a 7.11 transform. But that would mean that this transform starts writing strings. That's why we inject the dates_as_epoch_millis into the config, so it still becomes a 7.11 transform config, but with dates_as_epoch_millis:true.", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534322663", "createdAt": "2020-12-02T16:50:54Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -449,12 +449,17 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n         // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        if (transformConfig.getVersion() != null\n+            && transformConfig.getVersion().onOrAfter(Version.V_8_0_0) // todo: V_7_11_0\n+            && (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA=="}, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjA0OTUxOQ==", "bodyText": "ok, the code comment is outdated, will change it", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r536049519", "createdAt": "2020-12-04T12:00:40Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -449,12 +449,17 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n         // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        if (transformConfig.getVersion() != null\n+            && transformConfig.getVersion().onOrAfter(Version.V_8_0_0) // todo: V_7_11_0\n+            && (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA=="}, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU1MTE1OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0MjoxNlrOH9SY_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0MjoxNlrOH9SY_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjQ5Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026492", "createdAt": "2020-12-02T09:42:16Z", "author": {"login": "przemekwitek"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -77,6 +82,15 @@ public void testExplicitNullOnWriteParser() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = fromString(\"{\\\"dates_as_epoch_millis\\\" : null}\");\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU1MjY3OnYy", "diffSide": "RIGHT", "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0MjozOFrOH9SZ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0MjozOFrOH9SZ5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjcyNg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026726", "createdAt": "2020-12-02T09:42:38Z", "author": {"login": "przemekwitek"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -100,6 +116,16 @@ public void testExplicitNullOnWriteBuilder() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = new SettingsConfig.Builder().setDatesAsEpochMilli(null).build();\n+        // returns null, however it's `null` as in \"use default\"\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 57}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU2MDc2OnYy", "diffSide": "RIGHT", "path": "docs/reference/rest-api/common-parms.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDozN1rOH9SfOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDozN1rOH9SfOw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyODA5MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Defines if dates in the ouput should be written as ISO formated string (default)\n          \n          \n            \n            Defines if dates in the ouput should be written as ISO formatted string (default)", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534028091", "createdAt": "2020-12-02T09:44:37Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -965,6 +965,13 @@ adjusted to a lower value. The minimum value is `10` and the maximum is `10,000`\n The default value is `500`.\n end::transform-settings-max-page-search-size[]\n \n+tag::transform-settings-dates-as-epoch-milli[]\n+Defines if dates in the ouput should be written as ISO formated string (default)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM1MDU2MjIxOnYy", "diffSide": "RIGHT", "path": "docs/reference/rest-api/common-parms.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDo1NVrOH9SgJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDo1NVrOH9SgJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyODMyNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            before version `7.11`. For compatible output set this to true.\n          \n          \n            \n            before version `7.11`. For compatible output set this to `true`.", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534028324", "createdAt": "2020-12-02T09:44:55Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -965,6 +965,13 @@ adjusted to a lower value. The minimum value is `10` and the maximum is `10,000`\n The default value is `500`.\n end::transform-settings-max-page-search-size[]\n \n+tag::transform-settings-dates-as-epoch-milli[]\n+Defines if dates in the ouput should be written as ISO formated string (default)\n+or as millis since epoch. `epoch_millis` has been the default for transforms created\n+before version `7.11`. For compatible output set this to true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Mzg3MjEwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozNjowMVrOIAkt-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozNjowMVrOIAkt-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MjUwNg==", "bodyText": "nit:  Could this constructor reuse the other one?\nthis(maxPageSearchSize, docsPerSecond, datesAsEpochMillis == null ? null : datesAsEpochMillis ? 1 : 0);\n\n?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537472506", "createdAt": "2020-12-07T12:36:01Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -28,33 +31,54 @@\n \n     private static final int DEFAULT_MAX_PAGE_SEARCH_SIZE = -1;\n     private static final float DEFAULT_DOCS_PER_SECOND = -1F;\n+    private static final int DEFAULT_DATES_AS_EPOCH_MILLIS = -1;\n \n     private static ConstructingObjectParser<SettingsConfig, Void> createParser(boolean lenient) {\n         ConstructingObjectParser<SettingsConfig, Void> parser = new ConstructingObjectParser<>(\n             \"transform_config_settings\",\n             lenient,\n-            args -> new SettingsConfig((Integer) args[0], (Float) args[1])\n+            args -> new SettingsConfig((Integer) args[0], (Float) args[1], (Integer) args[2])\n         );\n         parser.declareIntOrNull(optionalConstructorArg(), DEFAULT_MAX_PAGE_SEARCH_SIZE, TransformField.MAX_PAGE_SEARCH_SIZE);\n         parser.declareFloatOrNull(optionalConstructorArg(), DEFAULT_DOCS_PER_SECOND, TransformField.DOCS_PER_SECOND);\n+        // this boolean requires 4 possible values: true, false, not_specified, default, therefore using a custom parser\n+        parser.declareField(\n+            optionalConstructorArg(),\n+            p -> p.currentToken() == XContentParser.Token.VALUE_NULL ? DEFAULT_DATES_AS_EPOCH_MILLIS : p.booleanValue() ? 1 : 0,\n+            TransformField.DATES_AS_EPOCH_MILLIS,\n+            ValueType.BOOLEAN_OR_NULL\n+        );\n         return parser;\n     }\n \n     private final Integer maxPageSearchSize;\n     private final Float docsPerSecond;\n+    private final Integer datesAsEpochMillis;\n \n     public SettingsConfig() {\n-        this(null, null);\n+        this(null, null, (Integer) null);\n     }\n \n-    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond) {\n+    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond, Boolean datesAsEpochMillis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3Mzg4NTY5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozOTozMFrOIAk1xQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozOTozMFrOIAk1xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NDUwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // quick checks(optimization) if a rewrite is required, if none found just return the original\n          \n          \n            \n                    // quick checks (optimization) if a rewrite is required, if none found just return the original", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537474501", "createdAt": "2020-12-07T12:39:30Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -440,37 +440,63 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     }\n \n     /**\n-     * Rewrites the transform config according to the latest format, for example moving deprecated\n-     * settings to its new place.\n+     * Rewrites the transform config according to the latest format.\n+     *\n+     * Operations cover:\n+     *\n+     *  - move deprecated settings to its new place\n+     *  - change configuration options so it stays compatible (given a newer version)\n      *\n      * @param transformConfig original config\n      * @return a rewritten transform config if a rewrite was necessary, otherwise the given transformConfig\n      */\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n-        // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        // quick checks(optimization) if a rewrite is required, if none found just return the original", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c"}, "originalPosition": 31}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1979, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}