{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MjMzODA4", "number": 63298, "title": "Write translog operation bytes to byte stream", "bodyText": "Currently we add translog operation bytes to an array list and flush\nthem on the next write. Unfortunately, this does not currently play well\nwith our byte pooling which means each operation is backed, at minimum,\nby a 16KB array. This commit improves memory efficiency for small\noperations by serializing the operations to an output stream.", "createdAt": "2020-10-06T03:12:03Z", "url": "https://github.com/elastic/elasticsearch/pull/63298", "merged": true, "mergeCommit": {"oid": "aa6c88f56645716706bb43bb4e6193f5b46d210d"}, "closed": true, "closedAt": "2020-10-06T16:49:46Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPuITUAH2gAyNDk4MjMzODA4OmRlYWU2M2IwZTAzNTg5ODg3YTIxMWFiNGRmMzg0M2E2ZTcwMWU4NDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdP6jycgH2gAyNDk4MjMzODA4OmM1MGUzZDE2NzhmMjg3YzM4YzIyOGE5ZDMzYjZkNzc0NGRjMDU2M2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "deae63b0e03589887a211ab4df3843a6e701e842", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/deae63b0e03589887a211ab4df3843a6e701e842", "committedDate": "2020-10-06T01:30:48Z", "message": "Write translog operation bytes to byte stream\n\nCurrently we add translog operation bytes to an array list and flush\nthem on the next write. Unfortunately, this does not currently play well\nwith our byte pooling which means each operation is backed, at minimum,\nby a 16KB array. This commit improves memory efficiency for small\noperations by serializing the operations to an output stream."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cc0ce55a8cfee0802739c1208f735a4a9c832ad", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/6cc0ce55a8cfee0802739c1208f735a4a9c832ad", "committedDate": "2020-10-06T03:38:19Z", "message": "Merge remote-tracking branch 'upstream/master' into use_bytes_stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43200b58f119a70e04bed55941d8f22a96ad9857", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/43200b58f119a70e04bed55941d8f22a96ad9857", "committedDate": "2020-10-06T04:04:56Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyNzM3NjY3", "url": "https://github.com/elastic/elasticsearch/pull/63298#pullrequestreview-502737667", "createdAt": "2020-10-06T09:11:41Z", "commit": {"oid": "43200b58f119a70e04bed55941d8f22a96ad9857"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOToxMTo0MVrOHc9KnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwOTozNTo1NlrOHc-FEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEyNDMxNw==", "bodyText": "I struggle to see how this can do anything, given that we assert that buffer is null a few lines above and we retain synchronized(this) throughout?", "url": "https://github.com/elastic/elasticsearch/pull/63298#discussion_r500124317", "createdAt": "2020-10-06T09:11:41Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -335,11 +339,13 @@ public TranslogReader closeIntoReader() throws IOException {\n                         throw ex;\n                     }\n                     // If we reached this point, all of the buffered ops should have been flushed successfully.\n-                    assert bufferedOps.size() == 0;\n+                    assert buffer == null;\n                     assert checkChannelPositionWhileHandlingException(totalOffset);\n                     assert totalOffset == lastSyncedCheckpoint.offset;\n                     if (closed.compareAndSet(false, true)) {\n                         try {\n+                            Releasables.closeWhileHandlingException(buffer);\n+                            buffer = null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43200b58f119a70e04bed55941d8f22a96ad9857"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDEzOTI4Mg==", "bodyText": "I think we should also revert the signature change of add, allowing us to revert Translog.add to its previous slightly simpler form?", "url": "https://github.com/elastic/elasticsearch/pull/63298#discussion_r500139282", "createdAt": "2020-10-06T09:35:56Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java", "diffHunk": "@@ -187,10 +189,12 @@ private synchronized void closeWithTragicEvent(final Exception ex) {\n         final long bytesBufferedAfterAdd;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43200b58f119a70e04bed55941d8f22a96ad9857"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b0e36735ddd2c496c54f27f9114de63885c934d", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b0e36735ddd2c496c54f27f9114de63885c934d", "committedDate": "2020-10-06T15:17:49Z", "message": "Changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74318513aefd72477e003f564da2781eca0acfc9", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/74318513aefd72477e003f564da2781eca0acfc9", "committedDate": "2020-10-06T15:22:21Z", "message": "Final"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMDk5NTE0", "url": "https://github.com/elastic/elasticsearch/pull/63298#pullrequestreview-503099514", "createdAt": "2020-10-06T15:36:00Z", "commit": {"oid": "74318513aefd72477e003f564da2781eca0acfc9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e32f33988bc777880cfa57fc574ccab8660499", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1e32f33988bc777880cfa57fc574ccab8660499", "committedDate": "2020-10-06T15:47:11Z", "message": "Increase stress of writer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c50e3d1678f287c38c228a9d33b6d7744dc0563e", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/c50e3d1678f287c38c228a9d33b6d7744dc0563e", "committedDate": "2020-10-06T15:59:41Z", "message": "Merge remote-tracking branch 'upstream/master' into use_bytes_stream"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4296, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}