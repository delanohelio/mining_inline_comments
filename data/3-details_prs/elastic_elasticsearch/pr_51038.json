{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMTE4MTkz", "number": 51038, "title": "Block too many concurrent mapping updates", "bodyText": "Ensures that there are not too many concurrent dynamic mapping updates going out from the data nodes to the master.\nCloses #50670", "createdAt": "2020-01-15T12:42:02Z", "url": "https://github.com/elastic/elasticsearch/pull/51038", "merged": true, "mergeCommit": {"oid": "bfbbd73dab8ba0da1fb78193629833d4ddc584de"}, "closed": true, "closedAt": "2020-01-15T14:50:09Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6kyhRAH2gAyMzYzMTE4MTkzOjE1ZmI5NmQzNWY2ODdjYzE5ODhlNjNkNjg0NjE3NDVkN2QyZjNhZjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6l91lAH2gAyMzYzMTE4MTkzOmM0ZWJkMWY4ODM0YjI1ZTQ5ZTNhMDdhYjJkMDA1OWU4MGVhNWY0MDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "15fb96d35f687cc1988e63d68461745d7d2f3af6", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/15fb96d35f687cc1988e63d68461745d7d2f3af6", "committedDate": "2020-01-15T12:34:18Z", "message": "Block too many concurrent mapping updates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzMjA2MjY1", "url": "https://github.com/elastic/elasticsearch/pull/51038#pullrequestreview-343206265", "createdAt": "2020-01-15T13:11:03Z", "commit": {"oid": "15fb96d35f687cc1988e63d68461745d7d2f3af6"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMzoxMTowNFrOFd3wMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxMzoxNDoxMlrOFd31YA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg2NjQ4Mg==", "bodyText": "Sadly, this changes exception handling to renotify onFailure if onResponse fails. Not sure if it is important here, but I would opt to keep the explicit listener until #50886 is merged.", "url": "https://github.com/elastic/elasticsearch/pull/51038#discussion_r366866482", "createdAt": "2020-01-15T13:11:04Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/action/index/MappingUpdatedAction.java", "diffHunk": "@@ -68,18 +81,62 @@ public void setClient(Client client) {\n      * potentially waiting for a master node to be available.\n      */\n     public void updateMappingOnMaster(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n+        final RunOnce release = new RunOnce(() -> semaphore.release());\n+        try {\n+            semaphore.acquire();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            listener.onFailure(e);\n+            return;\n+        }\n+        boolean successFullySent = false;\n+        try {\n+            sendUpdateMapping(index, mappingUpdate, ActionListener.runBefore(listener, release::run));\n+            successFullySent = true;\n+        } finally {\n+            if (successFullySent == false) {\n+                release.run();\n+            }\n+        }\n+    }\n+\n+    // used by tests\n+    int blockedThreads() {\n+        return semaphore.getQueueLength();\n+    }\n+\n+    // can be overridden by tests\n+    protected void sendUpdateMapping(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n         client.preparePutMapping().setConcreteIndex(index).setSource(mappingUpdate.toString(), XContentType.JSON)\n             .setMasterNodeTimeout(dynamicMappingUpdateTimeout).setTimeout(TimeValue.ZERO)\n-            .execute(new ActionListener<>() {\n-                @Override\n-                public void onResponse(AcknowledgedResponse acknowledgedResponse) {\n-                    listener.onResponse(null);\n-                }\n+            .execute(ActionListener.map(listener, resp -> null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15fb96d35f687cc1988e63d68461745d7d2f3af6"}, "originalPosition": 90}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg2NzczNQ==", "bodyText": "nit: I think this comment is unnecessary (but feel free to leave it in)", "url": "https://github.com/elastic/elasticsearch/pull/51038#discussion_r366867735", "createdAt": "2020-01-15T13:14:00Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/action/index/MappingUpdatedAction.java", "diffHunk": "@@ -68,18 +81,62 @@ public void setClient(Client client) {\n      * potentially waiting for a master node to be available.\n      */\n     public void updateMappingOnMaster(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n+        final RunOnce release = new RunOnce(() -> semaphore.release());\n+        try {\n+            semaphore.acquire();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            listener.onFailure(e);\n+            return;\n+        }\n+        boolean successFullySent = false;\n+        try {\n+            sendUpdateMapping(index, mappingUpdate, ActionListener.runBefore(listener, release::run));\n+            successFullySent = true;\n+        } finally {\n+            if (successFullySent == false) {\n+                release.run();\n+            }\n+        }\n+    }\n+\n+    // used by tests\n+    int blockedThreads() {\n+        return semaphore.getQueueLength();\n+    }\n+\n+    // can be overridden by tests\n+    protected void sendUpdateMapping(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n         client.preparePutMapping().setConcreteIndex(index).setSource(mappingUpdate.toString(), XContentType.JSON)\n             .setMasterNodeTimeout(dynamicMappingUpdateTimeout).setTimeout(TimeValue.ZERO)\n-            .execute(new ActionListener<>() {\n-                @Override\n-                public void onResponse(AcknowledgedResponse acknowledgedResponse) {\n-                    listener.onResponse(null);\n-                }\n+            .execute(ActionListener.map(listener, resp -> null));\n+    }\n+\n+    static class AdjustableSemaphore extends Semaphore {\n \n-                @Override\n-                public void onFailure(Exception e) {\n-                    listener.onFailure(e);\n+        private final Object maxPermitsMutex = new Object();\n+        private int maxPermits;\n+\n+        // sets the number of initial maximum permits", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15fb96d35f687cc1988e63d68461745d7d2f3af6"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Njg2NzgwOA==", "bodyText": "nit: I think this comment is unnecessary (but feel free to leave it in)", "url": "https://github.com/elastic/elasticsearch/pull/51038#discussion_r366867808", "createdAt": "2020-01-15T13:14:12Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/action/index/MappingUpdatedAction.java", "diffHunk": "@@ -68,18 +81,62 @@ public void setClient(Client client) {\n      * potentially waiting for a master node to be available.\n      */\n     public void updateMappingOnMaster(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n+        final RunOnce release = new RunOnce(() -> semaphore.release());\n+        try {\n+            semaphore.acquire();\n+        } catch (InterruptedException e) {\n+            Thread.currentThread().interrupt();\n+            listener.onFailure(e);\n+            return;\n+        }\n+        boolean successFullySent = false;\n+        try {\n+            sendUpdateMapping(index, mappingUpdate, ActionListener.runBefore(listener, release::run));\n+            successFullySent = true;\n+        } finally {\n+            if (successFullySent == false) {\n+                release.run();\n+            }\n+        }\n+    }\n+\n+    // used by tests\n+    int blockedThreads() {\n+        return semaphore.getQueueLength();\n+    }\n+\n+    // can be overridden by tests\n+    protected void sendUpdateMapping(Index index, Mapping mappingUpdate, ActionListener<Void> listener) {\n         client.preparePutMapping().setConcreteIndex(index).setSource(mappingUpdate.toString(), XContentType.JSON)\n             .setMasterNodeTimeout(dynamicMappingUpdateTimeout).setTimeout(TimeValue.ZERO)\n-            .execute(new ActionListener<>() {\n-                @Override\n-                public void onResponse(AcknowledgedResponse acknowledgedResponse) {\n-                    listener.onResponse(null);\n-                }\n+            .execute(ActionListener.map(listener, resp -> null));\n+    }\n+\n+    static class AdjustableSemaphore extends Semaphore {\n \n-                @Override\n-                public void onFailure(Exception e) {\n-                    listener.onFailure(e);\n+        private final Object maxPermitsMutex = new Object();\n+        private int maxPermits;\n+\n+        // sets the number of initial maximum permits\n+        AdjustableSemaphore(int maxPermits, boolean fair) {\n+            super(maxPermits, fair);\n+            this.maxPermits = maxPermits;\n+        }\n+\n+        // adjust the number of maximum permits", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "15fb96d35f687cc1988e63d68461745d7d2f3af6"}, "originalPosition": 107}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bb6533083b138801e5506872a35bfe6e9e6d6a0", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/1bb6533083b138801e5506872a35bfe6e9e6d6a0", "committedDate": "2020-01-15T13:56:26Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4ebd1f8834b25e49e3a07ab2d0059e80ea5f406", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4ebd1f8834b25e49e3a07ab2d0059e80ea5f406", "committedDate": "2020-01-15T13:56:34Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3104, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}