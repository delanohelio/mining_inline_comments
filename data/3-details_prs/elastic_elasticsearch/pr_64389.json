{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyODI1MDU0", "number": 64389, "title": "Attachment ingest processor: add resource_name field", "bodyText": "In the current plugin: ingest-attachment, the text file cannot be read properly if the encode is not utf-8\nand contain some non-ascii characters.\nI study a little about Tika which is used in ingest-attachment. Then I find out if we can tell Tika the file's name, it can recognize the file better. So I add an attachment options file_name, if there is a field defined as file_name, then this name will sent to Tika to improve the result.\nBut there is something not looks well. That's the gradle check. I wrote the unit test for reading different text using\ndifferent  encoding. But seems there is a role to not commit no-utf8 things.", "createdAt": "2020-10-30T07:58:08Z", "url": "https://github.com/elastic/elasticsearch/pull/64389", "merged": true, "mergeCommit": {"oid": "0f8476361c567dba92237bc2013d8bd17e8ac683"}, "closed": true, "closedAt": "2020-12-07T17:46:21Z", "author": {"login": "yangyaofei"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXdn3WgH2gAyNTEyODI1MDU0OmUxMTU0OTgxYjc5ZjU0OGVkYTgwYjRlODUxODdiYjBjZjNkNTFlZjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj4unTgH2gAyNTEyODI1MDU0OjBkMTU4ZDE1Y2YwNDAyYTZmMzMzM2FiZDRlMThlNzJjNjdmNWQ2ZGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e1154981b79f548eda80b4e85187bb0cf3d51ef2", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/e1154981b79f548eda80b4e85187bb0cf3d51ef2", "committedDate": "2020-10-30T02:48:17Z", "message": "Add filename for Tika to better recognize the txt file"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "285a513f7d11d3bd95daf9a55666c7417fe21770", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/285a513f7d11d3bd95daf9a55666c7417fe21770", "committedDate": "2020-10-30T07:31:24Z", "message": "bugfix : no field \"file_name\""}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcdcb52a1fe3dc635d20eb46a10ff76346cd7968", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/dcdcb52a1fe3dc635d20eb46a10ff76346cd7968", "committedDate": "2020-10-30T07:32:20Z", "message": "add test for adding file_name field in ingest-attachment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbd914eae835ca75519250f396d2c9e337293670", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbd914eae835ca75519250f396d2c9e337293670", "committedDate": "2020-11-16T16:42:42Z", "message": "Merge branch 'master' into plugin-attachment-filename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8adca4029a3353f584101d7b612e835750672fe", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/f8adca4029a3353f584101d7b612e835750672fe", "committedDate": "2020-11-17T02:33:51Z", "message": "[Plugin Attachment] update exclude file"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MjQ4OTA5", "url": "https://github.com/elastic/elasticsearch/pull/64389#pullrequestreview-545248909", "createdAt": "2020-12-04T19:44:52Z", "commit": {"oid": "f8adca4029a3353f584101d7b612e835750672fe"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxOTo0NDo1MlrOH_fiaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQyMDowMDozMVrOH_gCtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMzOTA1MQ==", "bodyText": "I think this should call readOptionalStringProperty so that any existing fields named file_name that are not intended for Tika will not be inadvertently used.", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r536339051", "createdAt": "2020-12-04T19:44:52Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/main/java/org/elasticsearch/ingest/attachment/AttachmentProcessor.java", "diffHunk": "@@ -197,6 +203,7 @@ int getIndexedChars() {\n         public AttachmentProcessor create(Map<String, Processor.Factory> registry, String processorTag,\n                                           String description, Map<String, Object> config) throws Exception {\n             String field = readStringProperty(TYPE, processorTag, config, \"field\");\n+            String fileName = readStringProperty(TYPE, processorTag, config, \"file_name\", \"file_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8adca4029a3353f584101d7b612e835750672fe"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMzOTU5NA==", "bodyText": "When readOptionalStringProperty is used as I suggested in another comment, this should retrieve the field value only when fileName != null.", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r536339594", "createdAt": "2020-12-04T19:46:00Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/main/java/org/elasticsearch/ingest/attachment/AttachmentProcessor.java", "diffHunk": "@@ -77,6 +79,7 @@ public IngestDocument execute(IngestDocument ingestDocument) {\n         Map<String, Object> additionalFields = new HashMap<>();\n \n         byte[] input = ingestDocument.getFieldValueAsBytes(field, ignoreMissing);\n+        String fileNameInput = ingestDocument.getFieldValue(fileName, String.class, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8adca4029a3353f584101d7b612e835750672fe"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjM0NzMxOQ==", "bodyText": "Also, is there any particular reason why you chose file_name as the property name when it's called resourceName on the Tika side? Unless there's a good reason for file_name, it's probably best to stick with resource_name since that's what Tika calls the property.", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r536347319", "createdAt": "2020-12-04T20:00:31Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/main/java/org/elasticsearch/ingest/attachment/AttachmentProcessor.java", "diffHunk": "@@ -197,6 +203,7 @@ int getIndexedChars() {\n         public AttachmentProcessor create(Map<String, Processor.Factory> registry, String processorTag,\n                                           String description, Map<String, Object> config) throws Exception {\n             String field = readStringProperty(TYPE, processorTag, config, \"field\");\n+            String fileName = readStringProperty(TYPE, processorTag, config, \"file_name\", \"file_name\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjMzOTA1MQ=="}, "originalCommit": {"oid": "f8adca4029a3353f584101d7b612e835750672fe"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f882434da13340a905a3691dab32a750d290ede", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/8f882434da13340a905a3691dab32a750d290ede", "committedDate": "2020-12-05T03:15:04Z", "message": "[Plugin Attachment] update variable name to meet tika's name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "914648d9d8a70bdd17eedeee1af22cb0d8c171a3", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/914648d9d8a70bdd17eedeee1af22cb0d8c171a3", "committedDate": "2020-12-07T02:40:52Z", "message": "[Plugin Attachment] update test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8e46385fe6d3612eeb5b01f4f2dbef205d6203a", "committedDate": "2020-12-07T13:54:52Z", "message": "Merge branch 'master' into plugin-attachment-filename"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjA5OTA3", "url": "https://github.com/elastic/elasticsearch/pull/64389#pullrequestreview-546209907", "createdAt": "2020-12-07T14:38:24Z", "commit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozODoyNVrOIAp2UA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozODoyNVrOIAp2UA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NjU2MA==", "bodyText": "Let's leave this unspecified so the existing behavior of the processor without a resource_name is still verified.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 10000, false, null, \"resource_name\");\n          \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 10000, false, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537556560", "createdAt": "2020-12-07T14:38:25Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -55,7 +55,7 @@\n     @Before\n     public void createStandardProcessor() {\n         processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n-            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 10000, false, null);\n+            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 10000, false, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MjEwODE4", "url": "https://github.com/elastic/elasticsearch/pull/64389#pullrequestreview-546210818", "createdAt": "2020-12-07T14:39:21Z", "commit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDozOToyMlrOIAp5IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxNDo0NDo1OFrOIAqKVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NzI4MQ==", "bodyText": "Same here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"target_field\", selectedProperties, 10000, false, null, \"resource_name\");\n          \n          \n            \n                        \"target_field\", selectedProperties, 10000, false, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537557281", "createdAt": "2020-12-07T14:39:22Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -88,7 +88,7 @@ public void testHtmlDocumentWithRandomFields() throws Exception {\n             selectedProperties.add(AttachmentProcessor.Property.DATE);\n         }\n         processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n-            \"target_field\", selectedProperties, 10000, false, null);\n+            \"target_field\", selectedProperties, 10000, false, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1NzY5NQ==", "bodyText": "This test will remain unchanged:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/x-asciidoc\"));\n          \n          \n            \n                    assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537557695", "createdAt": "2020-12-07T14:39:53Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -211,7 +211,7 @@ public void testAsciidocDocument() throws Exception {\n         Map<String, Object> attachmentData = parseDocument(\"asciidoc.asciidoc\", processor);\n \n         assertThat(attachmentData.keySet(), containsInAnyOrder(\"language\", \"content_type\", \"content\", \"content_length\"));\n-        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/x-asciidoc\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1ODE2NA==", "bodyText": "Let's remove this line so these tests remain unchanged as well.", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537558164", "createdAt": "2020-12-07T14:40:30Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -229,6 +229,7 @@ public void testParseAsBytesArray() throws Exception {\n \n         Map<String, Object> document = new HashMap<>();\n         document.put(\"source_field\", bytes);\n+        document.put(\"resource_name\", path);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1ODM5Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"randomTarget\", null, 10, true, null, \"resource_name\");\n          \n          \n            \n                        \"randomTarget\", null, 10, true, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537558397", "createdAt": "2020-12-07T14:40:48Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -247,15 +248,17 @@ public void testNullValueWithIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(),\n             Collections.singletonMap(\"source_field\", null));\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, true, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, true, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1ODU0OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"randomTarget\", null, 10, true, null, \"resource_name\");\n          \n          \n            \n                        \"randomTarget\", null, 10, true, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537558549", "createdAt": "2020-12-07T14:40:59Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -247,15 +248,17 @@ public void testNullValueWithIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(),\n             Collections.singletonMap(\"source_field\", null));\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, true, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, true, null, \"resource_name\");\n         processor.execute(ingestDocument);\n         assertIngestDocument(originalIngestDocument, ingestDocument);\n     }\n \n     public void testNonExistentWithIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(), Collections.emptyMap());\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, true, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, true, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1ODY5OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"randomTarget\", null, 10, false, null, \"resource_name\");\n          \n          \n            \n                        \"randomTarget\", null, 10, false, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537558699", "createdAt": "2020-12-07T14:41:12Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -264,15 +267,17 @@ public void testNullWithoutIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(),\n             Collections.singletonMap(\"source_field\", null));\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, false, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, false, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1ODgyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"randomTarget\", null, 10, false, null, \"resource_name\");\n          \n          \n            \n                        \"randomTarget\", null, 10, false, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537558826", "createdAt": "2020-12-07T14:41:23Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -264,15 +267,17 @@ public void testNullWithoutIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(),\n             Collections.singletonMap(\"source_field\", null));\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, false, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, false, null, \"resource_name\");\n         Exception exception = expectThrows(Exception.class, () -> processor.execute(ingestDocument));\n         assertThat(exception.getMessage(), equalTo(\"field [source_field] is null, cannot parse.\"));\n     }\n \n     public void testNonExistentWithoutIgnoreMissing() throws Exception {\n         IngestDocument originalIngestDocument = RandomDocumentPicks.randomIngestDocument(random(), Collections.emptyMap());\n         IngestDocument ingestDocument = new IngestDocument(originalIngestDocument);\n-        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\", \"randomTarget\", null, 10, false, null);\n+        Processor processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n+            \"randomTarget\", null, 10, false, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU1OTc1NQ==", "bodyText": "Could you add an override for the parseDocument method that adds a boolean includeResourceName parameter and only add resource_name if that parameter is true?", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537559755", "createdAt": "2020-12-07T14:42:29Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -285,6 +290,7 @@ public void testNonExistentWithoutIgnoreMissing() throws Exception {\n         throws Exception {\n         Map<String, Object> document = new HashMap<>();\n         document.put(\"source_field\", getAsBinaryOrBase64(file));\n+        document.put(\"resource_name\", file);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2MDA5Mw==", "bodyText": "Let's not change the behavior of these tests:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, null, \"resource_name\");\n          \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, null, null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537560093", "createdAt": "2020-12-07T14:42:54Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -297,7 +303,7 @@ public void testNonExistentWithoutIgnoreMissing() throws Exception {\n \n     public void testIndexedChars() throws Exception {\n         processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n-            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, null);\n+            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, null, \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2MDY1OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, \"max_length\", \"resource_name\");\n          \n          \n            \n                        \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, \"max_length\", null);", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537560658", "createdAt": "2020-12-07T14:43:39Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -308,7 +314,7 @@ public void testIndexedChars() throws Exception {\n         assertThat(attachmentData.get(\"content_length\"), is(19L));\n \n         processor = new AttachmentProcessor(randomAlphaOfLength(10), null, \"source_field\",\n-            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, \"max_length\");\n+            \"target_field\", EnumSet.allOf(AttachmentProcessor.Property.class), 19, false, \"max_length\", \"resource_name\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzU2MTY4Ng==", "bodyText": "Can you add these tests to a new test method named something like testIndexedCharsWithResourceName that calls your new overloaded parseDocument method with includeResourceName as true so that it separately tests your new functionality without changing the existing tests?", "url": "https://github.com/elastic/elasticsearch/pull/64389#discussion_r537561686", "createdAt": "2020-12-07T14:44:58Z", "author": {"login": "danhermann"}, "path": "plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java", "diffHunk": "@@ -333,6 +339,30 @@ public void testIndexedChars() throws Exception {\n         assertThat(attachmentData.get(\"content\"), is(\"\\\"God Save the Queen\\\" (alternatively \\\"God Save the King\\\"\"));\n         assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));\n         assertThat(attachmentData.get(\"content_length\"), is(56L));\n+\n+        attachmentData = parseDocument(\"text-cjk-big5.txt\", processor, Collections.singletonMap(\"max_length\", 100));\n+\n+        assertThat(attachmentData.keySet(), containsInAnyOrder(\"language\", \"content\", \"content_type\", \"content_length\"));\n+        assertThat(attachmentData.get(\"content\").toString(), containsString(\"\u78a9\u9f20\u78a9\u9f20\uff0c\u7121\u98df\u6211\u9ecd\uff01\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"charset=Big5\"));\n+        assertThat(attachmentData.get(\"content_length\"), is(100L));\n+\n+        attachmentData = parseDocument(\"text-cjk-gbk.txt\", processor, Collections.singletonMap(\"max_length\", 100));\n+\n+        assertThat(attachmentData.keySet(), containsInAnyOrder(\"language\", \"content\", \"content_type\", \"content_length\"));\n+        assertThat(attachmentData.get(\"content\").toString(), containsString(\"\u7855\u9f20\u7855\u9f20\uff0c\u65e0\u98df\u6211\u9ecd\uff01\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"charset=GB18030\"));\n+        assertThat(attachmentData.get(\"content_length\"), is(100L));\n+\n+        attachmentData = parseDocument(\"text-cjk-euc-jp.txt\", processor, Collections.singletonMap(\"max_length\", 100));\n+\n+        assertThat(attachmentData.keySet(), containsInAnyOrder(\"language\", \"content\", \"content_type\", \"content_length\"));\n+        assertThat(attachmentData.get(\"content\").toString(), containsString(\"\u78a9\u9f20\u3088\u78a9\u9f20\u3088\u3001\\n\u6211\u304c\u9ecd\u3092\u98df\u3089\u3046\u7121\u304b\u308c\uff01\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"text/plain\"));\n+        assertThat(attachmentData.get(\"content_type\").toString(), containsString(\"charset=EUC-JP\"));\n+        assertThat(attachmentData.get(\"content_length\"), is(100L));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8e46385fe6d3612eeb5b01f4f2dbef205d6203a"}, "originalPosition": 137}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca11758e3881253261eea347c6cde77e349b6db", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/bca11758e3881253261eea347c6cde77e349b6db", "committedDate": "2020-12-07T14:45:41Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d4d6cfbcde2a28ab2656c57e065752127203eda", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/0d4d6cfbcde2a28ab2656c57e065752127203eda", "committedDate": "2020-12-07T14:52:07Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93f8cf5f269c442ee64bf2f6243241199da82ad8", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/93f8cf5f269c442ee64bf2f6243241199da82ad8", "committedDate": "2020-12-07T14:52:31Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d927ca80db09b07e0ebd7337450120f29bce10c", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/2d927ca80db09b07e0ebd7337450120f29bce10c", "committedDate": "2020-12-07T14:52:57Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cfded6259c019bed23c15290e5f6f48a44befa8", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/9cfded6259c019bed23c15290e5f6f48a44befa8", "committedDate": "2020-12-07T14:53:14Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f34c5531fdd04844be052d6241b7969dec771bc5", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/f34c5531fdd04844be052d6241b7969dec771bc5", "committedDate": "2020-12-07T14:53:40Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c557746a20e9f86aeeadd23b05bd842e5fd8d80", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/4c557746a20e9f86aeeadd23b05bd842e5fd8d80", "committedDate": "2020-12-07T14:54:51Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a38ebc1bd8524b82f3588a790272275f7b38d1", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/74a38ebc1bd8524b82f3588a790272275f7b38d1", "committedDate": "2020-12-07T14:55:20Z", "message": "Update plugins/ingest-attachment/src/test/java/org/elasticsearch/ingest/attachment/AttachmentProcessorTests.java\n\nCo-authored-by: Dan Hermann <danhermann@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e5e033aadd9348b2186533c544b40ae82109073", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/6e5e033aadd9348b2186533c544b40ae82109073", "committedDate": "2020-12-07T15:30:00Z", "message": "[Plugin Attachment] make test independent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d158d15cf0402a6f3333abd4e18e72c67f5d6da", "author": {"user": {"login": "yangyaofei", "name": null}}, "url": "https://github.com/elastic/elasticsearch/commit/0d158d15cf0402a6f3333abd4e18e72c67f5d6da", "committedDate": "2020-12-07T17:10:11Z", "message": "[Plugin Attachment] update format"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 855, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}