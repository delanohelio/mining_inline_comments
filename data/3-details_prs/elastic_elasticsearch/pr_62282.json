{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg2MjMwMTIx", "number": 62282, "title": "Improve Efficiency of ClusterApplierService Iteration", "bodyText": "The complexity of removing a timeout listener was O(n) which\nmeans that in case of many queued up CS update tasks (such as in the\ncase of an avalance of dynamic mapping updates) we're dealing with\nquadratic complexity for timing out N tasks which was observed to be\nan issue in practice.\nThis PR makes the complexity of timing out a task O(1) and generally\nsimplifies the iteration logic of listeners and applies to be a little\nmore efficient and inline better.", "createdAt": "2020-09-13T19:43:05Z", "url": "https://github.com/elastic/elasticsearch/pull/62282", "merged": true, "mergeCommit": {"oid": "3e9442b7d4f1260d33b0eb29dbc5607b2cfb1f8e"}, "closed": true, "closedAt": "2020-09-15T03:07:04Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdIj9r2gH2gAyNDg2MjMwMTIxOjNiYzhiNDIyYWIxNGZiYzRjZjliNmY2MTQzNmJlYTUwZjU2YTYyYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdI434YgFqTQ4ODEwMDY4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3bc8b422ab14fbc4cf9b6f61436bea50f56a62b4", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3bc8b422ab14fbc4cf9b6f61436bea50f56a62b4", "committedDate": "2020-09-13T19:42:41Z", "message": "Improve Efficiency of ClusterApplierService Iteration\n\nThe complexity of removing a timeout listener was `O(n)` which\nmeans that in case of many queued up CS update tasks (such as in the\ncase of an avalance of dynamic mapping updates) we're dealing with\nquadratic complexity for timing out N tasks which was observed to be\nan issue in practice.\n\nThis PR makes the complexity of timing out a task `O(1)` and generally\nsimplifies the iteration logic of listeners and applies to be a little\nmore efficient and inline better."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72ecd170ded3929f3992367eced272173d93d7e0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/72ecd170ded3929f3992367eced272173d93d7e0", "committedDate": "2020-09-13T19:46:38Z", "message": "Merge remote-tracking branch 'elastic/master' into save-some-cycles-cluster-applier-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60361a50229c1a200103effb437d95b40394c26c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/60361a50229c1a200103effb437d95b40394c26c", "committedDate": "2020-09-14T08:10:47Z", "message": "Merge remote-tracking branch 'elastic/master' into save-some-cycles-cluster-applier-service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjgzNjcz", "url": "https://github.com/elastic/elasticsearch/pull/62282#pullrequestreview-487683673", "createdAt": "2020-09-14T12:03:40Z", "commit": {"oid": "60361a50229c1a200103effb437d95b40394c26c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjowMzo0MVrOHRQhGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMjoxMjo1OFrOHRQ1AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg1ODQ1Ng==", "bodyText": "The existing code seems to accept that addTimeoutListener is called multiple times for the same listener. It is not entirely clear to me that this cannot happen? If it does, a previous notifyTImeout will now go lost and not be cancelled.\nWe should at least add an assert here to verify, but maybe you can also do a bit of checking of whether there are legitimate cases where this could happen?", "url": "https://github.com/elastic/elasticsearch/pull/62282#discussion_r487858456", "createdAt": "2020-09-14T12:03:41Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java", "diffHunk": "@@ -291,12 +274,11 @@ public void addTimeoutListener(@Nullable final TimeValue timeout, final TimeoutC\n             threadPoolExecutor.execute(new SourcePrioritizedRunnable(Priority.HIGH, \"_add_listener_\") {\n                 @Override\n                 public void run() {\n+                    final NotifyTimeout notifyTimeout = new NotifyTimeout(listener, timeout);\n                     if (timeout != null) {\n-                        NotifyTimeout notifyTimeout = new NotifyTimeout(listener, timeout);\n                         notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);\n-                        onGoingTimeouts.add(notifyTimeout);\n                     }\n-                    timeoutClusterStateListeners.add(listener);\n+                    timeoutClusterStateListeners.put(listener, notifyTimeout);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60361a50229c1a200103effb437d95b40394c26c"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Nzg2MzU1Mw==", "bodyText": "Is there not a race here in that the scheduled task could run before adding the listener to the map below and the scheduled task could have called removeTimeoutListener before it is put into the map?\nI recognize this preserves existing behavior, but if you agree I think it is worth fixing in this PR.", "url": "https://github.com/elastic/elasticsearch/pull/62282#discussion_r487863553", "createdAt": "2020-09-14T12:12:58Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java", "diffHunk": "@@ -291,12 +274,11 @@ public void addTimeoutListener(@Nullable final TimeValue timeout, final TimeoutC\n             threadPoolExecutor.execute(new SourcePrioritizedRunnable(Priority.HIGH, \"_add_listener_\") {\n                 @Override\n                 public void run() {\n+                    final NotifyTimeout notifyTimeout = new NotifyTimeout(listener, timeout);\n                     if (timeout != null) {\n-                        NotifyTimeout notifyTimeout = new NotifyTimeout(listener, timeout);\n                         notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "60361a50229c1a200103effb437d95b40394c26c"}, "originalPosition": 97}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5734f4647b41d377744fe2dae223670f4581882", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5734f4647b41d377744fe2dae223670f4581882", "committedDate": "2020-09-14T13:29:09Z", "message": "Merge remote-tracking branch 'elastic/master' into save-some-cycles-cluster-applier-service"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98fe04a520e502a6f1e915aadbf8e9835b2e475f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/98fe04a520e502a6f1e915aadbf8e9835b2e475f", "committedDate": "2020-09-14T13:57:09Z", "message": "CR: fix race"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4MTAwNjg4", "url": "https://github.com/elastic/elasticsearch/pull/62282#pullrequestreview-488100688", "createdAt": "2020-09-14T20:04:21Z", "commit": {"oid": "98fe04a520e502a6f1e915aadbf8e9835b2e475f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4552, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}