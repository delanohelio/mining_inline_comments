{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzMTcxMzE5", "number": 57143, "title": "[ML] mark forecasts for force closed/failed jobs as failed", "bodyText": "forecasts that are still running should be marked as failed/finished in the following scenarios:\n\nJob is force closed\nJob is re-assigned to another node.\n\nForecasts are not \"resilient\". Their execution does not continue after a node failure. Consequently, forecasts marked as STARTED or SCHEDULED should be flagged as failed. These forecasts can then be deleted.\nAdditionally, force closing a job kills the native task directly. This means that if a forecast was running, it is not allowed to complete and could still have the status of STARTED in the index.\nrelates to #56419", "createdAt": "2020-05-26T12:20:59Z", "url": "https://github.com/elastic/elasticsearch/pull/57143", "merged": true, "mergeCommit": {"oid": "6bfd006d8215ec7123e7f96a354b79077c7ab118"}, "closed": true, "closedAt": "2020-05-29T17:24:33Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclDmbRAH2gAyNDIzMTcxMzE5OjExMTRmOWE2NjllYTBmMjJlN2Y0NzI2MWQ0MTc1OGRlMGE3NjA4YTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcmFC30AH2gAyNDIzMTcxMzE5Ojk5YmY5ZmU1MTBlMjg0OGFhMzZlNDZiOTc0YmY5YjNhYmUzYzc1NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1114f9a669ea0f22e7f47261d41758de0a7608a8", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/1114f9a669ea0f22e7f47261d41758de0a7608a8", "committedDate": "2020-05-26T12:12:58Z", "message": "[ML] mark forecasts for force closed/failed jobs as failed"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4MjU4MTA2", "url": "https://github.com/elastic/elasticsearch/pull/57143#pullrequestreview-418258106", "createdAt": "2020-05-26T12:43:00Z", "commit": {"oid": "1114f9a669ea0f22e7f47261d41758de0a7608a8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjo0MzowMFrOGacclA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQxMjo1NDowMFrOGac2qA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4MjIyOA==", "bodyText": "There is a string array field called forecast_messages which can be used to add a reason for the failure.", "url": "https://github.com/elastic/elasticsearch/pull/57143#discussion_r430382228", "createdAt": "2020-05-26T12:43:00Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -1272,6 +1276,39 @@ public void scheduledEvents(ScheduledEventsQueryBuilder query, ActionListener<Qu\n                 client::search);\n     }\n \n+    public void setRunningForecastsToFailed(String jobId, ActionListener<Boolean> listener) {\n+        QueryBuilder forecastQuery = QueryBuilders.boolQuery()\n+            .filter(QueryBuilders.termQuery(Result.RESULT_TYPE.getPreferredName(), ForecastRequestStats.RESULT_TYPE_VALUE))\n+            .filter(QueryBuilders.termQuery(Job.ID.getPreferredName(), jobId))\n+            .filter(QueryBuilders.termsQuery(ForecastRequestStats.STATUS.getPreferredName(),\n+                ForecastRequestStats.ForecastRequestStatus.SCHEDULED.toString(),\n+                ForecastRequestStats.ForecastRequestStatus.STARTED.toString()));\n+\n+        UpdateByQueryRequest request = new UpdateByQueryRequest(AnomalyDetectorsIndex.resultsWriteAlias(jobId))\n+            .setQuery(forecastQuery)\n+            .setIndicesOptions(IndicesOptions.lenientExpandOpen())\n+            .setAbortOnVersionConflict(false)\n+            .setMaxRetries(3)\n+            .setRefresh(true)\n+            .setScript(new Script(\"ctx._source.forecast_status='failed'\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1114f9a669ea0f22e7f47261d41758de0a7608a8"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDM4ODkwNA==", "bodyText": "Isn't sendRemoveRequest async? What if other results are still in the results queue and overwrite the failure state again?\nI wonder if it would be better to do this in AutodetectCommunicator::killProcess?", "url": "https://github.com/elastic/elasticsearch/pull/57143#discussion_r430388904", "createdAt": "2020-05-26T12:54:00Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportCloseJobAction.java", "diffHunk": "@@ -371,7 +375,7 @@ private void sendResponseOrFailure(String jobId,\n                                                                AtomicArray<Exception> failures) {\n                                 List<Exception> caughtExceptions = failures.asList();\n                                 if (caughtExceptions.size() == 0) {\n-                                    listener.onResponse(new CloseJobAction.Response(true));\n+                                    closeRunningForecasts(jobId, listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1114f9a669ea0f22e7f47261d41758de0a7608a8"}, "originalPosition": 44}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb2a6f7acd6db7e59cfd69d8267f59c2de816857", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb2a6f7acd6db7e59cfd69d8267f59c2de816857", "committedDate": "2020-05-26T20:23:00Z", "message": "attempting to move forecast clean up in message processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8c8eb28f6093d501a64a340144156fd76cac55f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8c8eb28f6093d501a64a340144156fd76cac55f", "committedDate": "2020-05-27T14:00:44Z", "message": "adding tests and fixing changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "944148eb064e15e9c6b628ac8eabbd827a5056f4", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/944148eb064e15e9c6b628ac8eabbd827a5056f4", "committedDate": "2020-05-27T14:17:04Z", "message": "clearing bulk request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fbdd5d816192bcdf722577b8eb583d0327676c60", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/fbdd5d816192bcdf722577b8eb583d0327676c60", "committedDate": "2020-05-27T15:25:31Z", "message": "fixing forecast to failed test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e16ae139426f0d94289d2816f73826149b1ca9cc", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/e16ae139426f0d94289d2816f73826149b1ca9cc", "committedDate": "2020-05-27T16:14:01Z", "message": "removing unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a9db0e272b99551db4e0a3c01305552d72d07e4", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a9db0e272b99551db4e0a3c01305552d72d07e4", "committedDate": "2020-05-27T16:35:47Z", "message": "Merge branch 'master' into feature/ml-fix-forecast-handling-on-failure-and-forceclose"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5ODIwNjkz", "url": "https://github.com/elastic/elasticsearch/pull/57143#pullrequestreview-419820693", "createdAt": "2020-05-28T06:48:46Z", "commit": {"oid": "7a9db0e272b99551db4e0a3c01305552d72d07e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwOTgyNjE3", "url": "https://github.com/elastic/elasticsearch/pull/57143#pullrequestreview-420982617", "createdAt": "2020-05-29T14:07:28Z", "commit": {"oid": "7a9db0e272b99551db4e0a3c01305552d72d07e4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDowNzoyOVrOGceEzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOVQxNDowNzoyOVrOGceEzw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjUwNjA2Mw==", "bodyText": "It would be nice if we could reuse here JobResultsProvider.setRunningForecastsToFailed. The benefits would be that we don't need a copy constructor for ForecastRequestStats which is prone for bugs (forgetting to add a new field there), and we don't need to keep track of open forecasts here in the new runningForecasts member.", "url": "https://github.com/elastic/elasticsearch/pull/57143#discussion_r432506063", "createdAt": "2020-05-29T14:07:29Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -206,6 +212,27 @@ public void setProcessKilled() {\n         renormalizer.shutdown();\n     }\n \n+    void handleOpenForecasts() {\n+        try {\n+            if (runningForecasts.isEmpty() == false) {\n+                LOGGER.warn(\"[{}] still had forecasts {} executing. Attempting to set them to failed.\",\n+                    jobId,\n+                    runningForecasts.keySet());\n+                // There may be many docs in the results persistence queue. But we only want to bother updating the running forecasts\n+                bulkResultsPersister.clearBulkRequest();\n+                for (ForecastRequestStats forecastRequestStats : runningForecasts.values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a9db0e272b99551db4e0a3c01305552d72d07e4"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxMDQ4ODIx", "url": "https://github.com/elastic/elasticsearch/pull/57143#pullrequestreview-421048821", "createdAt": "2020-05-29T15:15:50Z", "commit": {"oid": "7a9db0e272b99551db4e0a3c01305552d72d07e4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f302dde1e25932ee80b466fd70996ed7b296f606", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f302dde1e25932ee80b466fd70996ed7b296f606", "committedDate": "2020-05-29T15:20:47Z", "message": "Merge branch 'master' into feature/ml-fix-forecast-handling-on-failure-and-forceclose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99bf9fe510e2848aa36e46b974bf9b3abe3c7552", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/99bf9fe510e2848aa36e46b974bf9b3abe3c7552", "committedDate": "2020-05-29T16:27:52Z", "message": "fixing after merge"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4179, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}