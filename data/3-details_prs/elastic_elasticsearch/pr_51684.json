{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MTI3MDg5", "number": 51684, "title": "Add Trace Logging of REST Requests", "bodyText": "Being able to trace log all REST requests to a node would make debugging\na number of issues a lot easier.", "createdAt": "2020-01-30T15:09:31Z", "url": "https://github.com/elastic/elasticsearch/pull/51684", "merged": true, "mergeCommit": {"oid": "26b9cf787dfcfb2340fd2dbc98e4c42faf868e40"}, "closed": true, "closedAt": "2020-02-06T19:05:04Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_b-v8AH2gAyMzY5MTI3MDg5OmM2NjE2ZDc0NjgxM2QyYjU1YjM3M2NhZGMyNzViZjUxMmIyZDdkYjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcBtVcAgFqTM1NDU5MTYyNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c6616d746813d2b55b373cadc275bf512b2d7db3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6616d746813d2b55b373cadc275bf512b2d7db3", "committedDate": "2020-01-30T15:08:08Z", "message": "Add Trace Logging of REST Requests\n\nBeing able to trace log all REST requests to a node would make debugging\na number of issues a lot easier."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwOTI3ODY1", "url": "https://github.com/elastic/elasticsearch/pull/51684#pullrequestreview-350927865", "createdAt": "2020-01-30T15:47:01Z", "commit": {"oid": "c6616d746813d2b55b373cadc275bf512b2d7db3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20c07fbdc4e6ebd17a18c9d94132fe884bf05e38", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/20c07fbdc4e6ebd17a18c9d94132fe884bf05e38", "committedDate": "2020-01-30T17:57:17Z", "message": "serious tracer log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b88edc05c5d4b1bc7e97f86ffe4cf8e83514421d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b88edc05c5d4b1bc7e97f86ffe4cf8e83514421d", "committedDate": "2020-01-30T17:57:31Z", "message": "Merge remote-tracking branch 'elastic/master' into add-trace-logging-rest-requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fabbcfcd16faa2c84b1410e18281ab66da27c908", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/fabbcfcd16faa2c84b1410e18281ab66da27c908", "committedDate": "2020-01-30T19:10:05Z", "message": "tests + docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1c84507b6ef6b35bfe5c05933066a163c52f106", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1c84507b6ef6b35bfe5c05933066a163c52f106", "committedDate": "2020-01-30T19:12:20Z", "message": "ws"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed95506a132ef37e62bd06a96a09f62f726f9c97", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed95506a132ef37e62bd06a96a09f62f726f9c97", "committedDate": "2020-01-30T19:18:21Z", "message": "fix docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b54f7bb559fd24ef55ecc276bc95dea540788bc", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b54f7bb559fd24ef55ecc276bc95dea540788bc", "committedDate": "2020-01-30T19:26:03Z", "message": "nullable is meh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c10a821cc719a9db68ae8d6ad54e2d6e4db6f0db", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c10a821cc719a9db68ae8d6ad54e2d6e4db6f0db", "committedDate": "2020-01-30T19:27:52Z", "message": "nullable is meh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "670bac4bab99c4aacdddeca62ac39cdc1c82178d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/670bac4bab99c4aacdddeca62ac39cdc1c82178d", "committedDate": "2020-01-30T19:30:07Z", "message": "nullable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNTIzNDkw", "url": "https://github.com/elastic/elasticsearch/pull/51684#pullrequestreview-351523490", "createdAt": "2020-01-31T14:03:13Z", "commit": {"oid": "670bac4bab99c4aacdddeca62ac39cdc1c82178d"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNDowMzoxM1rOFkMPTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNDowNzo0NlrOFkMXrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5MzU4Mw==", "bodyText": "can you show how this will look like? In particular, what does request.getHttpChannel() print?", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373493583", "createdAt": "2020-01-31T14:03:13Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -157,6 +189,10 @@ public void registerHandler(RestRequest.Method method, String path, RestHandler\n \n     @Override\n     public void dispatchRequest(RestRequest request, RestChannel channel, ThreadContext threadContext) {\n+        if (tracerLog.isTraceEnabled() && shouldTraceRequest(request.uri())) {\n+            tracerLog.trace(new ParameterizedMessage(\n+                \"Incoming request [{}][{}] on [{}]\", request.method(), request.uri(), request.getHttpChannel()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "670bac4bab99c4aacdddeca62ac39cdc1c82178d"}, "originalPosition": 88}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzQ5NTcyNQ==", "bodyText": "Should we use the same syntax as for transport-level logging, i.e., [{}][{}] received request?", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373495725", "createdAt": "2020-01-31T14:07:46Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -157,6 +189,10 @@ public void registerHandler(RestRequest.Method method, String path, RestHandler\n \n     @Override\n     public void dispatchRequest(RestRequest request, RestChannel channel, ThreadContext threadContext) {\n+        if (tracerLog.isTraceEnabled() && shouldTraceRequest(request.uri())) {\n+            tracerLog.trace(new ParameterizedMessage(\n+                \"Incoming request [{}][{}] on [{}]\", request.method(), request.uri(), request.getHttpChannel()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "670bac4bab99c4aacdddeca62ac39cdc1c82178d"}, "originalPosition": 88}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbb7e109eca36ca0cc7031d2ef12c73ec2580a2f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbb7e109eca36ca0cc7031d2ef12c73ec2580a2f", "committedDate": "2020-01-31T14:17:23Z", "message": "Merge remote-tracking branch 'elastic/master' into add-trace-logging-rest-requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e830c1f5588097c34ca7c10816f45bc6edb8a251", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e830c1f5588097c34ca7c10816f45bc6edb8a251", "committedDate": "2020-01-31T16:48:02Z", "message": "move tracer to abstract http transport"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ebcccadeaa08369ef17cd27e395138a2a2206a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/51ebcccadeaa08369ef17cd27e395138a2a2206a", "committedDate": "2020-01-31T16:58:33Z", "message": "responses are logging too now"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8782db012dff8ff3473b59979a6ac076cff5248e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8782db012dff8ff3473b59979a6ac076cff5248e", "committedDate": "2020-01-31T17:11:33Z", "message": "log response as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82afbbe66984ab13e3c4c49148224f0bed6f9309", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/82afbbe66984ab13e3c4c49148224f0bed6f9309", "committedDate": "2020-01-31T17:14:50Z", "message": "undo noise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b15c0f75bae8f704cf343c432e6e1c2f70e6533", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b15c0f75bae8f704cf343c432e6e1c2f70e6533", "committedDate": "2020-01-31T17:15:33Z", "message": "undo noise"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a791f4ade7e3816c8739ab0de343c86fad06377a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a791f4ade7e3816c8739ab0de343c86fad06377a", "committedDate": "2020-01-31T17:20:31Z", "message": "Merge remote-tracking branch 'elastic/master' into add-trace-logging-rest-requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fbd42306f81bace7102665f85cc5e97f0bcff77", "committedDate": "2020-01-31T21:14:38Z", "message": "simpler nicer test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTAyMzc3", "url": "https://github.com/elastic/elasticsearch/pull/51684#pullrequestreview-352102377", "createdAt": "2020-02-03T09:05:31Z", "commit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOTowNTozMVrOFkqTHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QwOToxNToxOFrOFkqjgw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk4NjA3OA==", "bodyText": "let's also include restResponse.status() here, as well as content type, length and X_OPAQUE_ID", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373986078", "createdAt": "2020-02-03T09:05:31Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/http/DefaultRestChannel.java", "diffHunk": "@@ -77,6 +84,9 @@ protected BytesStreamOutput newBytesOutput() {\n \n     @Override\n     public void sendResponse(RestResponse restResponse) {\n+        if (tracerLog != null) {\n+            tracerLog.trace(new ParameterizedMessage(\"[{}] sent response to [{}]\", request.hashCode(), httpChannel));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk4NjYxOA==", "bodyText": "Should we move this to the finally block where we have actually sent the response?\nThis allows us to log something different in case where sending the response failed.", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373986618", "createdAt": "2020-02-03T09:06:48Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/http/DefaultRestChannel.java", "diffHunk": "@@ -77,6 +84,9 @@ protected BytesStreamOutput newBytesOutput() {\n \n     @Override\n     public void sendResponse(RestResponse restResponse) {\n+        if (tracerLog != null) {\n+            tracerLog.trace(new ParameterizedMessage(\"[{}] sent response to [{}]\", request.hashCode(), httpChannel));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk4NjA3OA=="}, "originalCommit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk4ODk0OA==", "bodyText": "Instead of the hashCode here, I would prefer to generate an actual unique value for each request (AtomicLong generator could be in RestRequest AFAICS), and return that through a getRequestId() method.", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373988948", "createdAt": "2020-02-03T09:12:11Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java", "diffHunk": "@@ -349,6 +375,15 @@ private void handleIncomingRequest(final HttpRequest httpRequest, final HttpChan\n             restRequest = innerRestRequest;\n         }\n \n+        final Logger trace;\n+        if (tracerLog.isTraceEnabled() && shouldTraceRequest(httpRequest.uri())) {\n+            tracerLog.trace(new ParameterizedMessage(\"[{}][{}][{}] received request from [{}]\", restRequest.hashCode(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mzk5MDI3NQ==", "bodyText": "let's add X_OPAQUE_ID here as well (this will make for great debugging)", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r373990275", "createdAt": "2020-02-03T09:15:18Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/http/AbstractHttpServerTransport.java", "diffHunk": "@@ -349,6 +375,15 @@ private void handleIncomingRequest(final HttpRequest httpRequest, final HttpChan\n             restRequest = innerRestRequest;\n         }\n \n+        final Logger trace;\n+        if (tracerLog.isTraceEnabled() && shouldTraceRequest(httpRequest.uri())) {\n+            tracerLog.trace(new ParameterizedMessage(\"[{}][{}][{}] received request from [{}]\", restRequest.hashCode(),\n+                httpRequest.method(), httpRequest.uri(), httpChannel), exception);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fbd42306f81bace7102665f85cc5e97f0bcff77"}, "originalPosition": 67}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "907f5d6351320bc05372d638bee34f9408a562a3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/907f5d6351320bc05372d638bee34f9408a562a3", "committedDate": "2020-02-03T09:57:50Z", "message": "Merge remote-tracking branch 'elastic/master' into add-trace-logging-rest-requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f82eeaf013318d6b2897381770a3b11306163a27", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f82eeaf013318d6b2897381770a3b11306163a27", "committedDate": "2020-02-03T11:11:42Z", "message": "CR: comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUyMTg4Mjk3", "url": "https://github.com/elastic/elasticsearch/pull/51684#pullrequestreview-352188297", "createdAt": "2020-02-03T11:30:12Z", "commit": {"oid": "f82eeaf013318d6b2897381770a3b11306163a27"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMTozMDoxMlrOFkuWNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wM1QxMTozMDoxMlrOFkuWNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDA1MjQwNQ==", "bodyText": "I wonder if we should rename AbstractHttpServerTransport to HttpServerTransport, so that this looks less ugly. @tbrooks8 thoughts?", "url": "https://github.com/elastic/elasticsearch/pull/51684#discussion_r374052405", "createdAt": "2020-02-03T11:30:12Z", "author": {"login": "ywelsch"}, "path": "docs/reference/modules/http.asciidoc", "diffHunk": "@@ -108,3 +108,33 @@ client HTTP responses, defaults to unbounded.\n \n It also uses the common\n <<modules-network,network settings>>.\n+\n+[float]\n+=== Rest Request Tracer\n+\n+The http module has a dedicated tracer logger which, when activated, logs incoming requests. The log can be dynamically activated\n+by setting the level of the `org.elasticsearch.http.AbstractHttpServerTransport.tracer` logger to `TRACE`:\n+\n+[source,console]\n+--------------------------------------------------\n+PUT _cluster/settings\n+{\n+   \"transient\" : {\n+      \"logger.org.elasticsearch.http.AbstractHttpServerTransport.tracer\" : \"TRACE\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f82eeaf013318d6b2897381770a3b11306163a27"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65b524b0d45ef376f486b6418aac76de19d146c4", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/65b524b0d45ef376f486b6418aac76de19d146c4", "committedDate": "2020-02-05T12:25:51Z", "message": "Merge remote-tracking branch 'elastic/master' into add-trace-logging-rest-requests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bf325bae194a5f8641458a989f9cc599d2855856", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf325bae194a5f8641458a989f9cc599d2855856", "committedDate": "2020-02-05T13:10:12Z", "message": "CR: trace logger in separate class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd80396fa9eafba2b5a9764c667560f4b6742cb6", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd80396fa9eafba2b5a9764c667560f4b6742cb6", "committedDate": "2020-02-05T13:17:34Z", "message": "urgh formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NTkxNjI0", "url": "https://github.com/elastic/elasticsearch/pull/51684#pullrequestreview-354591624", "createdAt": "2020-02-06T16:29:09Z", "commit": {"oid": "cd80396fa9eafba2b5a9764c667560f4b6742cb6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3103, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}