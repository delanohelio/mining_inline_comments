{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM0NzIxNDM1", "number": 66062, "title": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded", "bodyText": "This adds checks that verify that machine learning anomaly job model snapshots support the required minimal version.\nIf any are not the required version, directions are given to either delete the model snapshot, or utilize the _upgrade API.\nrelates: #64154", "createdAt": "2020-12-08T21:00:33Z", "url": "https://github.com/elastic/elasticsearch/pull/66062", "merged": true, "mergeCommit": {"oid": "4ab10c5ed14e6233aee90941cc3a115f9d145b0d"}, "closed": true, "closedAt": "2020-12-16T20:46:58Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdkQ2BoABqjQwODY3OTU4Njc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmHiDIgH2gAyNTM0NzIxNDM1OjM0MzFiZTY1ZDQ1ODM3OWVmMTRlMGMxZjY0NmY0N2YwNmU0Zjc0ZDY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a55dbc2ee646c9cc299f70962f6aeea4b470923b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/a55dbc2ee646c9cc299f70962f6aeea4b470923b", "committedDate": "2020-12-08T20:58:04Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}, "afterCommit": {"oid": "2bc2a21dbc1e7ae4f0591d994d0065cf771d98f7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bc2a21dbc1e7ae4f0591d994d0065cf771d98f7", "committedDate": "2020-12-08T21:15:44Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2bc2a21dbc1e7ae4f0591d994d0065cf771d98f7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bc2a21dbc1e7ae4f0591d994d0065cf771d98f7", "committedDate": "2020-12-08T21:15:44Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}, "afterCommit": {"oid": "0f9770dc77750f2174413d80da3d7d17d4da3f82", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f9770dc77750f2174413d80da3d7d17d4da3f82", "committedDate": "2020-12-08T21:24:10Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/645929a3e899d581c063a99ea09eb6c9716fdd1c", "committedDate": "2020-12-08T21:37:33Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0f9770dc77750f2174413d80da3d7d17d4da3f82", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f9770dc77750f2174413d80da3d7d17d4da3f82", "committedDate": "2020-12-08T21:24:10Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}, "afterCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/645929a3e899d581c063a99ea09eb6c9716fdd1c", "committedDate": "2020-12-08T21:37:33Z", "message": "[ML] [Deprecation] add deprecation check for job model snapshots that need upgraded"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxMTkwMTE1", "url": "https://github.com/elastic/elasticsearch/pull/66062#pullrequestreview-551190115", "createdAt": "2020-12-14T09:35:53Z", "commit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQwOTozNTo1M1rOIFHndw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxMTowOTo1NlrOIFLdPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjIzODU4Mw==", "bodyText": "The defaults are the same as the public RestHighLevelClient ctor (give or take a Collections.emptyList vs new ArrayList)\nI suspect there is a good reason you added this class but I can't see it.", "url": "https://github.com/elastic/elasticsearch/pull/66062#discussion_r542238583", "createdAt": "2020-12-14T09:35:53Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/MlDeprecationIT.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.client.WarningsHandler;\n+import org.elasticsearch.client.migration.DeprecationInfoRequest;\n+import org.elasticsearch.client.migration.DeprecationInfoResponse;\n+import org.elasticsearch.client.ml.PutJobRequest;\n+import org.elasticsearch.client.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.client.ml.job.config.DataDescription;\n+import org.elasticsearch.client.ml.job.config.Detector;\n+import org.elasticsearch.client.ml.job.config.Job;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchModule;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+public class MlDeprecationIT extends ESRestTestCase {\n+\n+    private static final RequestOptions REQUEST_OPTIONS = RequestOptions.DEFAULT.toBuilder()\n+        .setWarningsHandler(WarningsHandler.PERMISSIVE)\n+        .build();\n+\n+    private static class HLRC extends RestHighLevelClient {\n+        HLRC(RestClient restClient) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI0ODg3NQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    );\n          \n          \n            \n                    );\n          \n          \n            \n                    hlrc.close();", "url": "https://github.com/elastic/elasticsearch/pull/66062#discussion_r542248875", "createdAt": "2020-12-14T09:50:24Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/MlDeprecationIT.java", "diffHunk": "@@ -0,0 +1,98 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation;\n+\n+import org.elasticsearch.action.admin.indices.refresh.RefreshRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.client.WarningsHandler;\n+import org.elasticsearch.client.migration.DeprecationInfoRequest;\n+import org.elasticsearch.client.migration.DeprecationInfoResponse;\n+import org.elasticsearch.client.ml.PutJobRequest;\n+import org.elasticsearch.client.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.client.ml.job.config.DataDescription;\n+import org.elasticsearch.client.ml.job.config.Detector;\n+import org.elasticsearch.client.ml.job.config.Job;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.search.SearchModule;\n+import org.elasticsearch.test.rest.ESRestTestCase;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+\n+import static org.hamcrest.Matchers.containsString;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+public class MlDeprecationIT extends ESRestTestCase {\n+\n+    private static final RequestOptions REQUEST_OPTIONS = RequestOptions.DEFAULT.toBuilder()\n+        .setWarningsHandler(WarningsHandler.PERMISSIVE)\n+        .build();\n+\n+    private static class HLRC extends RestHighLevelClient {\n+        HLRC(RestClient restClient) {\n+            super(restClient, RestClient::close, new ArrayList<>());\n+        }\n+    }\n+\n+    @Override\n+    protected NamedXContentRegistry xContentRegistry() {\n+        SearchModule searchModule = new SearchModule(Settings.EMPTY, Collections.emptyList());\n+        return new NamedXContentRegistry(searchModule.getNamedXContents());\n+    }\n+\n+    @Override\n+    protected boolean enableWarningsCheck() {\n+        return false;\n+    }\n+\n+    public void testMlDeprecationChecks() throws Exception {\n+        HLRC hlrc = new HLRC(client());\n+        String jobId = \"deprecation_check_job\";\n+        hlrc.machineLearning()\n+            .putJob(\n+                new PutJobRequest(\n+                    Job.builder(jobId)\n+                        .setAnalysisConfig(\n+                            AnalysisConfig.builder(Collections.singletonList(Detector.builder().setFunction(\"count\").build()))\n+                        )\n+                        .setDataDescription(new DataDescription.Builder().setTimeField(\"time\"))\n+                        .build()\n+                ),\n+                REQUEST_OPTIONS\n+            );\n+\n+        IndexRequest indexRequest = new IndexRequest(\".ml-anomalies-.write-\" + jobId).id(jobId + \"_model_snapshot_1\")\n+            .source(\"{\\\"job_id\\\":\\\"deprecation_check_job\\\",\\\"snapshot_id\\\":\\\"1\\\", \\\"snapshot_doc_count\\\":1}\", XContentType.JSON);\n+        hlrc.index(indexRequest, REQUEST_OPTIONS);\n+\n+        indexRequest = new IndexRequest(\".ml-anomalies-.write-\" + jobId).id(jobId + \"_model_snapshot_2\")\n+            .source(\n+                \"{\\\"job_id\\\":\\\"deprecation_check_job\\\",\\\"snapshot_id\\\":\\\"2\\\",\\\"snapshot_doc_count\\\":1,\\\"min_version\\\":\\\"8.0.0\\\"}\",\n+                XContentType.JSON\n+            );\n+        hlrc.index(indexRequest, REQUEST_OPTIONS);\n+        hlrc.indices().refresh(new RefreshRequest(\".ml-anomalies-*\"), REQUEST_OPTIONS);\n+\n+        DeprecationInfoResponse response = hlrc.migration()\n+            .getDeprecationInfo(\n+                // specify an index so that deprecation checks don't run against any accidentally existing indices\n+                new DeprecationInfoRequest(Collections.singletonList(\"index-that-does-not-exist-*\")),\n+                RequestOptions.DEFAULT\n+            );\n+        assertThat(response.getMlSettingsIssues(), hasSize(1));\n+        assertThat(\n+            response.getMlSettingsIssues().get(0).getMessage(),\n+            containsString(\"model snapshot [1] for job [deprecation_check_job] needs to be deleted or upgraded\")\n+        );", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "originalPosition": 95}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjI1NzUyOQ==", "bodyText": "The snapshot docs are small increase the PageParams to 100 if not more!", "url": "https://github.com/elastic/elasticsearch/pull/66062#discussion_r542257529", "createdAt": "2020-12-14T10:02:48Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/MlDeprecationChecker.java", "diffHunk": "@@ -56,16 +84,36 @@ public void check(Components components, ActionListener<CheckResult> deprecation\n             deprecationIssueListener.onResponse(new CheckResult(getName(), Collections.emptyList()));\n             return;\n         }\n+        List<DeprecationIssue> issues = Collections.synchronizedList(new ArrayList<>());\n+        final GetModelSnapshotsAction.Request getModelSnapshots = new GetModelSnapshotsAction.Request(\"*\", null);\n+        getModelSnapshots.setPageParams(new PageParams(0, 50));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMTIyMg==", "bodyText": "nice one", "url": "https://github.com/elastic/elasticsearch/pull/66062#discussion_r542301222", "createdAt": "2020-12-14T11:09:32Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportGetModelSnapshotsAction.java", "diffHunk": "@@ -53,19 +54,29 @@ protected void doExecute(Task task, GetModelSnapshotsAction.Request request,\n                 request.getSort(),\n                 request.getDescOrder()));\n \n+        if (Strings.isAllOrWildcard(request.getJobId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjMwMTUwMQ==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/66062#discussion_r542301501", "createdAt": "2020-12-14T11:09:56Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -1054,6 +1055,11 @@ private void modelSnapshots(String jobId,\n \n         FieldSortBuilder sb = new FieldSortBuilder(sortField)\n                 .order(sortDescending ? SortOrder.DESC : SortOrder.ASC);\n+        // `min_version` might not be present in very early snapshots.\n+        // Consequently, we should treat it as being at least from 6.3.0 or before\n+        if (sortField.equals(ModelSnapshot.MIN_VERSION.getPreferredName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "645929a3e899d581c063a99ea09eb6c9716fdd1c"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8065042c8821b36f9020e2dc56c86738bb5f60a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8065042c8821b36f9020e2dc56c86738bb5f60a", "committedDate": "2020-12-14T15:23:26Z", "message": "Update x-pack/plugin/deprecation/qa/rest/src/javaRestTest/java/org/elasticsearch/xpack/deprecation/MlDeprecationIT.java\n\nCo-authored-by: David Kyle <david.kyle@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3431be65d458379ef14e0c1f646f47f06e4f74d6", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3431be65d458379ef14e0c1f646f47f06e4f74d6", "committedDate": "2020-12-14T15:32:53Z", "message": "Merge branch 'master' into feature/ml-add-snapshot-deprecation-checks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4655, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}