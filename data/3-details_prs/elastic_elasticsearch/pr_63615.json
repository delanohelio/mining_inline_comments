{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzc5MjAw", "number": 63615, "title": "Retry wget tasks in Dockerfile", "bodyText": "Following #52519, our Docker build pulls down curl sources in an\nAlpine Linux container using wget. However that version of wget\ndoesn't support any retry flags. Since network issues can cause build\nfailures, wrap the wget calls in the same retry construct used for\nyum commands elsewhere.\nCloses #63600.", "createdAt": "2020-10-13T14:20:49Z", "url": "https://github.com/elastic/elasticsearch/pull/63615", "merged": true, "mergeCommit": {"oid": "c5cebb07e90a2d1e3e3ad7fee0b370bb694d94e2"}, "closed": true, "closedAt": "2020-10-14T13:00:49Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSJSHIAH2gAyNTAyMzc5MjAwOmYzZjc2YmJiMWZjOTViMzdhMzhiMTc0NDQxYzYwYjZjNmFjMDlkNjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSZnlSAH2gAyNTAyMzc5MjAwOjZjNWVmM2Y3ZTY1MjVkZGZlN2Q2MGMyZjNkZGFlNDAyMTYwMTcyZjA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3f76bbb1fc95b37a38b174441c60b6c6ac09d65", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3f76bbb1fc95b37a38b174441c60b6c6ac09d65", "committedDate": "2020-10-13T14:16:48Z", "message": "Retry wget tasks in Dockerfile\n\nFollowing #52519, our Docker build pulls down `curl` sources in an\nAlpine Linux container using `wget`. However that version of `wget`\ndoesn't support any retry flags. Since network issues can cause build\nfailures, wrap the `wget` calls in the same retry construct used for\n`yum` commands elsewhere.\n\nCloses #63600."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NTA3NTg0", "url": "https://github.com/elastic/elasticsearch/pull/63615#pullrequestreview-507507584", "createdAt": "2020-10-13T14:37:01Z", "commit": {"oid": "f3f76bbb1fc95b37a38b174441c60b6c6ac09d65"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozNzowMlrOHgqE3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNDozNzowMlrOHgqE3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwNTg1NA==", "bodyText": "A small note: one issue here is that if any of the three wgets fails here, the entire loop will fail and all downloads will be retried. Is this deliberate? Alternatively we'd have to split the wget's within separate loops.", "url": "https://github.com/elastic/elasticsearch/pull/63615#discussion_r504005854", "createdAt": "2020-10-13T14:37:02Z", "author": {"login": "dliappis"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -61,10 +61,14 @@ RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n RUN mkdir /work\n WORKDIR /work\n \n-# Fetch curl sources and files for validation\n-RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n-    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n-    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+# Fetch curl sources and files for validation. Note that alpine's `wget` doesn't have retry options.\n+RUN for iter in {1..10}; do \\\\\n+      wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+      wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+      wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\" && \\\\", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3f76bbb1fc95b37a38b174441c60b6c6ac09d65"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NjM5NzU5", "url": "https://github.com/elastic/elasticsearch/pull/63615#pullrequestreview-507639759", "createdAt": "2020-10-13T16:45:35Z", "commit": {"oid": "f3f76bbb1fc95b37a38b174441c60b6c6ac09d65"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0NTozNVrOHgwRoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxNjo0NTozNVrOHgwRoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDEwNzQyNA==", "bodyText": "These are idempotent operations so that's not a huge deal but you do risk that one fails one iteration and another fails the next. This is still an improvement though. Wrapping each of these is going to start getting a bit silly unless we can somehow encapsulate this logic in a function of some kind.", "url": "https://github.com/elastic/elasticsearch/pull/63615#discussion_r504107424", "createdAt": "2020-10-13T16:45:35Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/src/docker/Dockerfile", "diffHunk": "@@ -61,10 +61,14 @@ RUN apk add gnupg gcc make musl-dev openssl-dev openssl-libs-static file\n RUN mkdir /work\n WORKDIR /work\n \n-# Fetch curl sources and files for validation\n-RUN wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n-    wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n-    wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\"\n+# Fetch curl sources and files for validation. Note that alpine's `wget` doesn't have retry options.\n+RUN for iter in {1..10}; do \\\\\n+      wget \"https://daniel.haxx.se/mykey.asc\" -O \"curl-gpg.pub\" && \\\\\n+      wget \"\\${TARBALL_URL}.asc\" -O \"\\${TARBALL_PATH}.asc\" && \\\\\n+      wget \"\\${TARBALL_URL}\" -O \"\\${TARBALL_PATH}\" && \\\\", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDAwNTg1NA=="}, "originalCommit": {"oid": "f3f76bbb1fc95b37a38b174441c60b6c6ac09d65"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5ef3f7e6525ddfe7d60c2f3ddae402160172f0", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/6c5ef3f7e6525ddfe7d60c2f3ddae402160172f0", "committedDate": "2020-10-14T09:18:44Z", "message": "Retry each wget command seperately"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4102, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}