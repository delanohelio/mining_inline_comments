{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5Mzg3Njk0", "number": 63428, "title": "SQL: Escaped wildcard (*) not accepted in LIKE", "bodyText": "For a query like SELECT name FROM test WHERE name LIKE '%c*' ES SQL generates an error. * is not a special character in a LIKE construct and it's expected to not needing to be escaped, so the previous query should work as is.\nIn the LIKE pattern any * character was treated as invalid character and the usage of % or _ was suggested instead. But * is a valid, acceptable non-wildcard on the right side of the LIKE operator.\nFix: #55108", "createdAt": "2020-10-07T16:53:45Z", "url": "https://github.com/elastic/elasticsearch/pull/63428", "merged": true, "mergeCommit": {"oid": "190d9fe3deb31aed0d8f312007360625d4fff217"}, "closed": true, "closedAt": "2020-10-13T13:38:36Z", "author": {"login": "palesz"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQQLDvgFqTUwNDA5NTQ1OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSIwmmAFqTUwNzQ0NDU0NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDk1NDU5", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-504095459", "createdAt": "2020-10-07T17:10:34Z", "commit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzoxMDozNVrOHd9W0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzoxMDozNVrOHd9W0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg==", "bodyText": "@costin Did I miss anything, is there a reason to keep this check here?", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501176016", "createdAt": "2020-10-07T17:10:35Z", "author": {"login": "palesz"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -270,12 +270,6 @@ public LikePattern visitPattern(PatternContext ctx) {\n         if (pattern == null) {\n             throw new ParsingException(source(ctx.value), \"Pattern must not be [null]\");\n         }\n-        int pos = pattern.indexOf('*');\n-        if (pos >= 0) {\n-            throw new ParsingException(source(ctx.value),\n-                    \"Invalid char [*] found in pattern [{}] at position {}; use [%] or [_] instead\",\n-                    pattern, pos);\n-        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDkyNzU3", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-504092757", "createdAt": "2020-10-07T17:07:11Z", "commit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzowNzoxMVrOHd9O3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzowNzoxMVrOHd9O3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3Mzk4MQ==", "bodyText": "Please revert.", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501173981", "createdAt": "2020-10-07T17:07:11Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/parser/LikeEscapingParsingTests.java", "diffHunk": "@@ -29,7 +29,7 @@ private String error(String pattern) {\n     }\n \n     private LikePattern like(String pattern) {\n-        Expression exp = null;\n+        Expression exp;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0MDk1NDY3", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-504095467", "createdAt": "2020-10-07T17:10:35Z", "commit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzoxMDozNVrOHd9W1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wN1QxNzoxMDozNVrOHd9W1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAyMw==", "bodyText": "Should we maybe improve the error message by listing the wildcard chars for LIKE: % and _ ?", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501176023", "createdAt": "2020-10-07T17:10:35Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/parser/LikeEscapingParsingTests.java", "diffHunk": "@@ -63,8 +63,15 @@ public void testInvalidChar() {\n                 is(\"line 1:28: Char [%] cannot be used for escaping\"));\n     }\n \n-    public void testCannotUseStar() {\n+    public void testCanUseStarWithoutEscaping() {\n+        LikePattern like = like(\"%string*\");\n+        assertThat(like.pattern(), is(\"%string*\"));\n+        assertThat(like.asJavaRegex(), is(\"^.*string\\\\*$\"));\n+        assertThat(like.asLuceneWildcard(), is(\"*string\\\\*\"));\n+    }\n+\n+    public void testCannotUseStarWithEscaping() {\n         assertThat(error(\"'|*string' ESCAPE '|'\"),\n-                is(\"line 1:11: Invalid char [*] found in pattern [|*string] at position 1; use [%] or [_] instead\"));\n+            is(\"line 1:11: Pattern [|*string] is invalid as escape char [|] at position 0 can only escape wildcard chars; found [*]\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c368506f911d36da392142be06ca289cf9b4a8ce", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c368506f911d36da392142be06ca289cf9b4a8ce", "committedDate": "2020-10-07T20:51:08Z", "message": "SQL: Escaped wildcard (*) not accepted in LIKE\n\nFor a query like `SELECT name FROM test WHERE name LIKE ''%c*'` ES SQL\ngenerates an error. `*` is not a special character in a `LIKE` construct\nand it's expected to not needing to be escaped, so the previous query\nshould work as is.\nIn the LIKE pattern any `*` character was treated as invalid character\nand the usage of `%` or `_` was suggested instead. But `*` is a valid,\nacceptable non-wildcard on the right side of the `LIKE` operator.\n\nFix: #55108"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/50fc9d52097cab6ac8b55625fc8b8f387688de13", "committedDate": "2020-10-07T14:20:05Z", "message": "SQL: Escaped wildcard (*) not accepted in LIKE\n\nFor a query like SELECT name FROM test WHERE name LIKE '%c*' ES SQL\ngenerates an error. * is not a special character in a LIKE construct\nand it's expected to not needing to be escaped, so the previous query\nshould work as is.\nIn the LIKE pattern any '*' character was treated as invalid character\nand the usage of '%' or '_' was suggested instead. But '*' is a valid,\nacceptable non-wildcard on the right side of the LIKE operator.\n\nCloses #55108"}, "afterCommit": {"oid": "c368506f911d36da392142be06ca289cf9b4a8ce", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c368506f911d36da392142be06ca289cf9b4a8ce", "committedDate": "2020-10-07T20:51:08Z", "message": "SQL: Escaped wildcard (*) not accepted in LIKE\n\nFor a query like `SELECT name FROM test WHERE name LIKE ''%c*'` ES SQL\ngenerates an error. `*` is not a special character in a `LIKE` construct\nand it's expected to not needing to be escaped, so the previous query\nshould work as is.\nIn the LIKE pattern any `*` character was treated as invalid character\nand the usage of `%` or `_` was suggested instead. But `*` is a valid,\nacceptable non-wildcard on the right side of the `LIKE` operator.\n\nFix: #55108"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/5c97c9d4259fb263e1278605f068e6d6943a962c", "committedDate": "2020-10-07T21:06:00Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/55108"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NTk4ODc3", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-504598877", "createdAt": "2020-10-08T09:33:46Z", "commit": {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTozMzo0NlrOHeWCkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTozNzowOFrOHeWK_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MDQzMg==", "bodyText": "Personally I'd add it as a [NOTE] below the existing sentence, so that it stands out.", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501580432", "createdAt": "2020-10-08T09:33:46Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/functions/like-rlike.asciidoc", "diffHunk": "@@ -33,8 +33,8 @@ with the `LIKE` operator:\n * The percent sign (%)\n * The underscore (_)\n \n-The percent sign represents zero, one or multiple characters. The underscore represents a single number or character. These symbols can be\n-used in combinations.\n+No other characters have special meaning or act as wildcard. The percent sign represents zero, one or multiple characters.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MjU4OA==", "bodyText": "As I see it, since only % and _ are wildcards for LIKE I would only allow escaping of those, but if we go on with this change it shouldn't be part of the bugfix that would be backported, but for next minor release since it's a minor \"breaking\" change.", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501582588", "createdAt": "2020-10-08T09:37:08Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -270,12 +270,6 @@ public LikePattern visitPattern(PatternContext ctx) {\n         if (pattern == null) {\n             throw new ParsingException(source(ctx.value), \"Pattern must not be [null]\");\n         }\n-        int pos = pattern.indexOf('*');\n-        if (pos >= 0) {\n-            throw new ParsingException(source(ctx.value),\n-                    \"Invalid char [*] found in pattern [{}] at position {}; use [%] or [_] instead\",\n-                    pattern, pos);\n-        }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTE3NjAxNg=="}, "originalCommit": {"oid": "50fc9d52097cab6ac8b55625fc8b8f387688de13"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjMzODU2", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-504633856", "createdAt": "2020-10-08T10:17:11Z", "commit": {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNzoxMVrOHeXtZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxMDoxNzoxMVrOHeXtZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTYwNzc4Mg==", "bodyText": "nit: It might be worth providing first the explanation of the above chars, then add a clarification; i.e. reposition the first sentence at the end.", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r501607782", "createdAt": "2020-10-08T10:17:11Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/functions/like-rlike.asciidoc", "diffHunk": "@@ -33,8 +33,8 @@ with the `LIKE` operator:\n * The percent sign (%)\n * The underscore (_)\n \n-The percent sign represents zero, one or multiple characters. The underscore represents a single number or character. These symbols can be\n-used in combinations.\n+No other characters have special meaning or act as wildcard. The percent sign represents zero, one or multiple characters.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4MDQzMg=="}, "originalCommit": {"oid": "5c97c9d4259fb263e1278605f068e6d6943a962c"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f089b47203bb2388b46ec634d8a75e56deab903a", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f089b47203bb2388b46ec634d8a75e56deab903a", "committedDate": "2020-10-08T15:58:26Z", "message": "Merge remote-tracking branch 'origin/master' into fix/55108"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5e6bc1cbd29fa2fff695e287f29eb0b780a32422", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e6bc1cbd29fa2fff695e287f29eb0b780a32422", "committedDate": "2020-10-08T16:12:00Z", "message": "Documentation changes for SQL `LIKE` as per PR\n\nAdded a NOTE explaining that only `%` and `_` treated as wildcards\nand other characters (even `*` or `?`) are just treated as normal\ncharacters in the `LIKE` pattern."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5ee1890ab2d794050c99d22f983c96685d6de0", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff5ee1890ab2d794050c99d22f983c96685d6de0", "committedDate": "2020-10-08T16:21:04Z", "message": "Fixed the checkstyle errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MDg0MTI5", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-505084129", "createdAt": "2020-10-08T19:05:47Z", "commit": {"oid": "ff5ee1890ab2d794050c99d22f983c96685d6de0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3NDQ0NTQ1", "url": "https://github.com/elastic/elasticsearch/pull/63428#pullrequestreview-507444545", "createdAt": "2020-10-13T13:38:04Z", "commit": {"oid": "ff5ee1890ab2d794050c99d22f983c96685d6de0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzozODowNFrOHgnMag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzozODowNFrOHgnMag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1ODYzNA==", "bodyText": "On the same idea (which I like) of actually mentioning the wildcard chars in the error message itself (for the lazy user who doesn't read the docs and asking \"why % char cannot be used for escaping?\"), what about adapting this error message to include the reason? Something like Char [%] cannot be used for escaping as it's one of the wildcard chars [%_].", "url": "https://github.com/elastic/elasticsearch/pull/63428#discussion_r503958634", "createdAt": "2020-10-13T13:38:04Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/parser/ExpressionBuilder.java", "diffHunk": "@@ -288,7 +282,7 @@ public LikePattern visitPattern(PatternContext ctx) {\n             } else if (escapeString.length() == 1) {\n                 escape = escapeString.charAt(0);\n                 // these chars already have a meaning\n-                if (escape == '*' || escape == '%' || escape == '_') {\n+                if (escape == '%' || escape == '_') {\n                     throw new ParsingException(source(escapeCtx.escape), \"Char [{}] cannot be used for escaping\", escape);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ff5ee1890ab2d794050c99d22f983c96685d6de0"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4178, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}