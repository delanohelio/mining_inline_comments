{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzODg3ODgw", "number": 62229, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMzo1OToyOVrOEiIfwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDowNDoyOVrOEiIpYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjI2MjQxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxMzo1OToyOVrOHP1dag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDoxOToxOFrOHP2ZSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NjU3MA==", "bodyText": "is scriptContext a good name here? I wish that we rename also the different BooleanScriptFieldScript in a followup. That is effectively the script context for boolean runtime fields?", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486366570", "createdAt": "2020-09-10T13:59:29Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -6,32 +6,24 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n import org.apache.lucene.search.QueryVisitor;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n import org.elasticsearch.xpack.runtimefields.DoubleScriptFieldScript;\n \n-import java.io.IOException;\n-import java.util.Objects;\n-\n /**\n  * Abstract base class for building queries based on {@link DoubleScriptFieldScript}.\n  */\n-abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery<BooleanScriptFieldScript> {\n \n     AbstractBooleanScriptFieldQuery(Script script, BooleanScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n-        super(script, fieldName);\n-        this.leafFactory = Objects.requireNonNull(leafFactory);\n+        super(script, fieldName, leafFactory::newInstance);\n+    }\n+\n+    @Override\n+    protected boolean matches(BooleanScriptFieldScript scriptContext, int docId) {\n+        scriptContext.runForDoc(docId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NzM4NA==", "bodyText": "It's really a script more than a scriptContext. The context is all of the information we need to compile a script.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486367384", "createdAt": "2020-09-10T14:00:28Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -6,32 +6,24 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n import org.apache.lucene.search.QueryVisitor;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n import org.elasticsearch.xpack.runtimefields.DoubleScriptFieldScript;\n \n-import java.io.IOException;\n-import java.util.Objects;\n-\n /**\n  * Abstract base class for building queries based on {@link DoubleScriptFieldScript}.\n  */\n-abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery<BooleanScriptFieldScript> {\n \n     AbstractBooleanScriptFieldQuery(Script script, BooleanScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n-        super(script, fieldName);\n-        this.leafFactory = Objects.requireNonNull(leafFactory);\n+        super(script, fieldName, leafFactory::newInstance);\n+    }\n+\n+    @Override\n+    protected boolean matches(BooleanScriptFieldScript scriptContext, int docId) {\n+        scriptContext.runForDoc(docId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NjU3MA=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MTIwMA==", "bodyText": "this is what I struggle with: we have the Script class, and this, which is more of a compiled script leaf abstraction. naming is hard", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486371200", "createdAt": "2020-09-10T14:05:22Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -6,32 +6,24 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n import org.apache.lucene.search.QueryVisitor;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n import org.elasticsearch.xpack.runtimefields.DoubleScriptFieldScript;\n \n-import java.io.IOException;\n-import java.util.Objects;\n-\n /**\n  * Abstract base class for building queries based on {@link DoubleScriptFieldScript}.\n  */\n-abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery<BooleanScriptFieldScript> {\n \n     AbstractBooleanScriptFieldQuery(Script script, BooleanScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n-        super(script, fieldName);\n-        this.leafFactory = Objects.requireNonNull(leafFactory);\n+        super(script, fieldName, leafFactory::newInstance);\n+    }\n+\n+    @Override\n+    protected boolean matches(BooleanScriptFieldScript scriptContext, int docId) {\n+        scriptContext.runForDoc(docId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NjU3MA=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MzQxMA==", "bodyText": "Yeah. That Script class is more of a ScriptConfiguration or a ScriptRequest or something like that. These are the \"real\" scripts. I think, at least. Because they instances of these object \"run\".", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486373410", "createdAt": "2020-09-10T14:08:15Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -6,32 +6,24 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n import org.apache.lucene.search.QueryVisitor;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n import org.elasticsearch.xpack.runtimefields.DoubleScriptFieldScript;\n \n-import java.io.IOException;\n-import java.util.Objects;\n-\n /**\n  * Abstract base class for building queries based on {@link DoubleScriptFieldScript}.\n  */\n-abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery<BooleanScriptFieldScript> {\n \n     AbstractBooleanScriptFieldQuery(Script script, BooleanScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n-        super(script, fieldName);\n-        this.leafFactory = Objects.requireNonNull(leafFactory);\n+        super(script, fieldName, leafFactory::newInstance);\n+    }\n+\n+    @Override\n+    protected boolean matches(BooleanScriptFieldScript scriptContext, int docId) {\n+        scriptContext.runForDoc(docId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NjU3MA=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM4MTg5OQ==", "bodyText": "ok I will followup with a proposal to rename these and the corresponding lucene queries", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486381899", "createdAt": "2020-09-10T14:19:18Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -6,32 +6,24 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n import org.apache.lucene.search.QueryVisitor;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n import org.elasticsearch.xpack.runtimefields.DoubleScriptFieldScript;\n \n-import java.io.IOException;\n-import java.util.Objects;\n-\n /**\n  * Abstract base class for building queries based on {@link DoubleScriptFieldScript}.\n  */\n-abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractBooleanScriptFieldQuery extends AbstractScriptFieldQuery<BooleanScriptFieldScript> {\n \n     AbstractBooleanScriptFieldQuery(Script script, BooleanScriptFieldScript.LeafFactory leafFactory, String fieldName) {\n-        super(script, fieldName);\n-        this.leafFactory = Objects.requireNonNull(leafFactory);\n+        super(script, fieldName, leafFactory::newInstance);\n+    }\n+\n+    @Override\n+    protected boolean matches(BooleanScriptFieldScript scriptContext, int docId) {\n+        scriptContext.runForDoc(docId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2NjU3MA=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjI3ODM4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractStringScriptFieldQuery.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDowMjo0MVrOHP1nVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDowNDozNVrOHP1s7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2OTEwOA==", "bodyText": "Maybe leafFactor should be a function everywhere like it is for long, because the function is all we need after all.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486369108", "createdAt": "2020-09-10T14:02:41Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractStringScriptFieldQuery.java", "diffHunk": "@@ -6,63 +6,27 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.StringScriptFieldScript;\n \n-import java.io.IOException;\n import java.util.List;\n-import java.util.Objects;\n \n /**\n  * Abstract base class for building queries based on {@link StringScriptFieldScript}.\n  */\n-abstract class AbstractStringScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final StringScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractStringScriptFieldQuery extends AbstractScriptFieldQuery<StringScriptFieldScript> {\n \n     AbstractStringScriptFieldQuery(Script script, StringScriptFieldScript.LeafFactory leafFactory, String fieldName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDU0MQ==", "bodyText": "I think they'll end up being a Function<LeafReaderContext, StringRuntimeValues> or something like that when we go to use them in grok or source only fields. But I'm not really sure to be honest. I figured we'd make the change when we got to one of those.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486370541", "createdAt": "2020-09-10T14:04:35Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractStringScriptFieldQuery.java", "diffHunk": "@@ -6,63 +6,27 @@\n \n package org.elasticsearch.xpack.runtimefields.query;\n \n-import org.apache.lucene.index.LeafReaderContext;\n-import org.apache.lucene.search.ConstantScoreScorer;\n-import org.apache.lucene.search.ConstantScoreWeight;\n-import org.apache.lucene.search.DocIdSetIterator;\n-import org.apache.lucene.search.IndexSearcher;\n-import org.apache.lucene.search.ScoreMode;\n-import org.apache.lucene.search.Scorer;\n-import org.apache.lucene.search.TwoPhaseIterator;\n-import org.apache.lucene.search.Weight;\n import org.elasticsearch.script.Script;\n import org.elasticsearch.xpack.runtimefields.StringScriptFieldScript;\n \n-import java.io.IOException;\n import java.util.List;\n-import java.util.Objects;\n \n /**\n  * Abstract base class for building queries based on {@link StringScriptFieldScript}.\n  */\n-abstract class AbstractStringScriptFieldQuery extends AbstractScriptFieldQuery {\n-    private final StringScriptFieldScript.LeafFactory leafFactory;\n+abstract class AbstractStringScriptFieldQuery extends AbstractScriptFieldQuery<StringScriptFieldScript> {\n \n     AbstractStringScriptFieldQuery(Script script, StringScriptFieldScript.LeafFactory leafFactory, String fieldName) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM2OTEwOA=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0MjI4NzA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDowNDoyOVrOHP1soQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNDowNjo1OFrOHP10NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDQ2NQ==", "bodyText": "I was also wondering if the visit methods are consistent, i see that most of the impl share the same code, but there are subtleties as not all impls override it. I was about to move the standard impl to the base class but I refrained.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486370465", "createdAt": "2020-09-10T14:04:29Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -41,35 +33,6 @@\n      */\n     protected abstract boolean matches(int trues, int falses);\n \n-    @Override\n-    public final Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n-        return new ConstantScoreWeight(this, boost) {\n-            @Override\n-            public boolean isCacheable(LeafReaderContext ctx) {\n-                return false; // scripts aren't really cacheable at this point\n-            }\n-\n-            @Override\n-            public Scorer scorer(LeafReaderContext ctx) throws IOException {\n-                BooleanScriptFieldScript script = leafFactory.newInstance(ctx);\n-                DocIdSetIterator approximation = DocIdSetIterator.all(ctx.reader().maxDoc());\n-                TwoPhaseIterator twoPhase = new TwoPhaseIterator(approximation) {\n-                    @Override\n-                    public boolean matches() throws IOException {\n-                        script.runForDoc(approximation().docID());\n-                        return AbstractBooleanScriptFieldQuery.this.matches(script.trues(), script.falses());\n-                    }\n-\n-                    @Override\n-                    public float matchCost() {\n-                        return MATCH_COST;\n-                    }\n-                };\n-                return new ConstantScoreScorer(this, score(), scoreMode, twoPhase);\n-            }\n-        };\n-    }\n-\n     @Override\n     public final void visit(QueryVisitor visitor) {\n         // No subclasses contain any Terms because those have to be strings.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MTQzOA==", "bodyText": "The ones that are not for strings aren't going to emit any terms so they all get the standard impl. The String ones have much more interesting visit methods.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486371438", "createdAt": "2020-09-10T14:05:39Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -41,35 +33,6 @@\n      */\n     protected abstract boolean matches(int trues, int falses);\n \n-    @Override\n-    public final Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n-        return new ConstantScoreWeight(this, boost) {\n-            @Override\n-            public boolean isCacheable(LeafReaderContext ctx) {\n-                return false; // scripts aren't really cacheable at this point\n-            }\n-\n-            @Override\n-            public Scorer scorer(LeafReaderContext ctx) throws IOException {\n-                BooleanScriptFieldScript script = leafFactory.newInstance(ctx);\n-                DocIdSetIterator approximation = DocIdSetIterator.all(ctx.reader().maxDoc());\n-                TwoPhaseIterator twoPhase = new TwoPhaseIterator(approximation) {\n-                    @Override\n-                    public boolean matches() throws IOException {\n-                        script.runForDoc(approximation().docID());\n-                        return AbstractBooleanScriptFieldQuery.this.matches(script.trues(), script.falses());\n-                    }\n-\n-                    @Override\n-                    public float matchCost() {\n-                        return MATCH_COST;\n-                    }\n-                };\n-                return new ConstantScoreScorer(this, score(), scoreMode, twoPhase);\n-            }\n-        };\n-    }\n-\n     @Override\n     public final void visit(QueryVisitor visitor) {\n         // No subclasses contain any Terms because those have to be strings.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDQ2NQ=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MjA2NA==", "bodyText": "We could end up with a AbstractNonStringRuntimeFieldQuery or something like that which had the base class. I didn't go for that because I didn't think it was worth the extra layer just for that one class. But if there are more things to share it'd make sense.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486372064", "createdAt": "2020-09-10T14:06:29Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -41,35 +33,6 @@\n      */\n     protected abstract boolean matches(int trues, int falses);\n \n-    @Override\n-    public final Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n-        return new ConstantScoreWeight(this, boost) {\n-            @Override\n-            public boolean isCacheable(LeafReaderContext ctx) {\n-                return false; // scripts aren't really cacheable at this point\n-            }\n-\n-            @Override\n-            public Scorer scorer(LeafReaderContext ctx) throws IOException {\n-                BooleanScriptFieldScript script = leafFactory.newInstance(ctx);\n-                DocIdSetIterator approximation = DocIdSetIterator.all(ctx.reader().maxDoc());\n-                TwoPhaseIterator twoPhase = new TwoPhaseIterator(approximation) {\n-                    @Override\n-                    public boolean matches() throws IOException {\n-                        script.runForDoc(approximation().docID());\n-                        return AbstractBooleanScriptFieldQuery.this.matches(script.trues(), script.falses());\n-                    }\n-\n-                    @Override\n-                    public float matchCost() {\n-                        return MATCH_COST;\n-                    }\n-                };\n-                return new ConstantScoreScorer(this, score(), scoreMode, twoPhase);\n-            }\n-        };\n-    }\n-\n     @Override\n     public final void visit(QueryVisitor visitor) {\n         // No subclasses contain any Terms because those have to be strings.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDQ2NQ=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MjQwNA==", "bodyText": "ok I will have another look later.", "url": "https://github.com/elastic/elasticsearch/pull/62229#discussion_r486372404", "createdAt": "2020-09-10T14:06:58Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/query/AbstractBooleanScriptFieldQuery.java", "diffHunk": "@@ -41,35 +33,6 @@\n      */\n     protected abstract boolean matches(int trues, int falses);\n \n-    @Override\n-    public final Weight createWeight(IndexSearcher searcher, ScoreMode scoreMode, float boost) throws IOException {\n-        return new ConstantScoreWeight(this, boost) {\n-            @Override\n-            public boolean isCacheable(LeafReaderContext ctx) {\n-                return false; // scripts aren't really cacheable at this point\n-            }\n-\n-            @Override\n-            public Scorer scorer(LeafReaderContext ctx) throws IOException {\n-                BooleanScriptFieldScript script = leafFactory.newInstance(ctx);\n-                DocIdSetIterator approximation = DocIdSetIterator.all(ctx.reader().maxDoc());\n-                TwoPhaseIterator twoPhase = new TwoPhaseIterator(approximation) {\n-                    @Override\n-                    public boolean matches() throws IOException {\n-                        script.runForDoc(approximation().docID());\n-                        return AbstractBooleanScriptFieldQuery.this.matches(script.trues(), script.falses());\n-                    }\n-\n-                    @Override\n-                    public float matchCost() {\n-                        return MATCH_COST;\n-                    }\n-                };\n-                return new ConstantScoreScorer(this, score(), scoreMode, twoPhase);\n-            }\n-        };\n-    }\n-\n     @Override\n     public final void visit(QueryVisitor visitor) {\n         // No subclasses contain any Terms because those have to be strings.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjM3MDQ2NQ=="}, "originalCommit": {"oid": "05db6492f42ce8c6726c59bb2c80eb77ac4162ea"}, "originalPosition": 76}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1621, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}