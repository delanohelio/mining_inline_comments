{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNDA3OTIz", "number": 55010, "title": "Validate global V2 templates don't set index.hidden", "bodyText": "", "createdAt": "2020-04-09T12:56:28Z", "url": "https://github.com/elastic/elasticsearch/pull/55010", "merged": true, "mergeCommit": {"oid": "2e768981809887649f49d265d039f056985f7e6a"}, "closed": true, "closedAt": "2020-04-21T10:23:55Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcV8CRwgH2gAyNDAxNDA3OTIzOjEyZGY0NzM0ZmNlNmE2ZTIwMzkxNWU0NDc3YjQ4NjhhNmVkMWQwZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZil-_gFqTM5NjQxMDYwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/12df4734fce6a6e203915e4477b4868a6ed1d0eb", "committedDate": "2020-04-09T12:55:17Z", "message": "Validate global V2 templates don't set index.hidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwODMzOTk1", "url": "https://github.com/elastic/elasticsearch/pull/55010#pullrequestreview-390833995", "createdAt": "2020-04-09T14:16:42Z", "commit": {"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNjo0MlrOGDavyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyMDowOVrOGDa5Zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzEzMQ==", "bodyText": "I think we should add return here, otherwise assertion below will trip or we will have NPE if assertions are disabled", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406237131", "createdAt": "2020-04-09T14:16:42Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java", "diffHunk": "@@ -88,6 +90,17 @@ public ActionRequestValidationException validate() {\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzODIwMQ==", "bodyText": "minor nit: maybe break on + here, then there will be 2 lines instead of 4", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406238201", "createdAt": "2020-04-09T14:18:11Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2Action.java", "diffHunk": "@@ -88,6 +90,17 @@ public ActionRequestValidationException validate() {\n             if (indexTemplate == null) {\n                 validationException = addValidationError(\"an index template is required\", validationException);\n             }\n+            assert indexTemplate != null : \"an index template is required\";\n+            \n+            if (indexTemplate.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(indexTemplate.template().settings())) {\n+                    validationException = addValidationError(\n+                        \"global V2 templates may not specify the setting \" + IndexMetadata.INDEX_HIDDEN_SETTING.getKey(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzOTU5MQ==", "bodyText": "Add test check that null template produce correct message and no NPEs", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r406239591", "createdAt": "2020-04-09T14:20:09Z", "author": {"login": "probakowski"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/template/put/PutIndexTemplateV2RequestTests.java", "diffHunk": "@@ -44,4 +53,19 @@\n     protected PutIndexTemplateV2Action.Request mutateInstance(PutIndexTemplateV2Action.Request instance) throws IOException {\n         return randomValueOtherThan(instance, this::createTestInstance);\n     }\n+\n+    public void testPutGlobalTemplatesCannotHaveHiddenIndexSetting() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12df4734fce6a6e203915e4477b4868a6ed1d0eb"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e21a594d6ca1bdca10b9922d5dafadfaa8413308", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/e21a594d6ca1bdca10b9922d5dafadfaa8413308", "committedDate": "2020-04-09T15:30:36Z", "message": "Handle null template properly"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxMTA3OTE1", "url": "https://github.com/elastic/elasticsearch/pull/55010#pullrequestreview-391107915", "createdAt": "2020-04-09T20:26:29Z", "commit": {"oid": "e21a594d6ca1bdca10b9922d5dafadfaa8413308"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2fa7bb70f47eb5bf408546054c01800b0ae98a1", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2fa7bb70f47eb5bf408546054c01800b0ae98a1", "committedDate": "2020-04-15T11:13:17Z", "message": "Merge branch 'master' into global-v2template-dont-set-indexhidden"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d38ad901f2383bf521952c66ff1e6a4c8a9a1cc1", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/d38ad901f2383bf521952c66ff1e6a4c8a9a1cc1", "committedDate": "2020-04-16T13:16:12Z", "message": "Check the index template resolved settings for index.hidden\n\nThis also prevents updating the component template to add the index.hidden\nsetting if that ct is referenced by a global index template."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09342ee8c19635c66b4f235d9e7b446b0756396a", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/09342ee8c19635c66b4f235d9e7b446b0756396a", "committedDate": "2020-04-16T13:28:56Z", "message": "Add fail statements in test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0ac92cfeb1efeb1dfb302d4be4649934972e357", "committedDate": "2020-04-16T13:29:30Z", "message": "Merge branch 'master' into global-v2template-dont-set-indexhidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NjYyNzM2", "url": "https://github.com/elastic/elasticsearch/pull/55010#pullrequestreview-396662736", "createdAt": "2020-04-20T17:27:26Z", "commit": {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NDEwNjA4", "url": "https://github.com/elastic/elasticsearch/pull/55010#pullrequestreview-396410608", "createdAt": "2020-04-20T12:35:01Z", "commit": {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxMjozNTowMVrOGISPrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQxNzoyOTozMlrOGIfonQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTM0MDcxNw==", "bodyText": "Ifs can be merged", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r411340717", "createdAt": "2020-04-20T12:35:01Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -196,6 +196,29 @@ ClusterState addComponentTemplate(final ClusterState currentState, final boolean\n \n         validateTemplate(finalSettings, stringMappings, indicesService, xContentRegistry);\n \n+        // if we're updating a component template, let's check if it's part of any V2 template that will yield the CT update invalid\n+        if (create == false && finalSettings != null) {\n+            // if the CT is specifying the `index.hidden` setting it cannot be part of any global template\n+            if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(finalSettings)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTU2MDA5Mw==", "bodyText": "This can be replaced with stream version, which for me is more readable:\nList<String> globalTemplatesThatUseThisComponent = currentState.metadata().templatesV2().entrySet().stream()\n                .filter(e -> e.getValue().composedOf().contains(name))\n                .filter(e -> e.getValue().indexPatterns().stream().anyMatch(Regex::isMatchAllPattern))\n                .map(Map.Entry::getKey)\n                .collect(Collectors.toList());", "url": "https://github.com/elastic/elasticsearch/pull/55010#discussion_r411560093", "createdAt": "2020-04-20T17:29:32Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -196,6 +196,29 @@ ClusterState addComponentTemplate(final ClusterState currentState, final boolean\n \n         validateTemplate(finalSettings, stringMappings, indicesService, xContentRegistry);\n \n+        // if we're updating a component template, let's check if it's part of any V2 template that will yield the CT update invalid\n+        if (create == false && finalSettings != null) {\n+            // if the CT is specifying the `index.hidden` setting it cannot be part of any global template\n+            if (IndexMetadata.INDEX_HIDDEN_SETTING.exists(finalSettings)) {\n+                Map<String, IndexTemplateV2> existingTemplates = currentState.metadata().templatesV2();\n+                List<String> globalTemplatesThatUseThisComponent = new ArrayList<>();\n+                for (Map.Entry<String, IndexTemplateV2> entry : existingTemplates.entrySet()) {\n+                    IndexTemplateV2 templateV2 = entry.getValue();\n+                    if (templateV2.composedOf().contains(name) && templateV2.indexPatterns().stream().anyMatch(Regex::isMatchAllPattern)) {\n+                        // global templates don't support configuring the `index.hidden` setting so we don't need to resolve the settings as\n+                        // no other component template can remove this setting from the resolved settings, so just invalidate this update\n+                        globalTemplatesThatUseThisComponent.add(entry.getKey());\n+                    }\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0ac92cfeb1efeb1dfb302d4be4649934972e357"}, "originalPosition": 26}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3644, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}