{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NTM1NDA3", "number": 65599, "title": "Use scriptless fields in CoreTestTranslator", "bodyText": "CoreTestTranslator re-writes some core search yaml tests into a tests\nfor runtime queries, and mimics source-only fields by building ad-hoc\npainless scripts for each runtime type.  We now have source-only fields\nbuilt in via scriptless mappings, so we can cut over to using these\ninstead.", "createdAt": "2020-11-30T13:02:49Z", "url": "https://github.com/elastic/elasticsearch/pull/65599", "merged": true, "mergeCommit": {"oid": "f0fc1b3dadba4459e1485360fd7cbd9ce594e283"}, "closed": true, "closedAt": "2020-12-02T10:06:41Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhk85XAH2gAyNTI5NTM1NDA3OjRhNmUzNDE3YjljZTQ5ODBmN2YyOGU2YWJlYzQ3MDc5ZDBmYTJiODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiK_EeAH2gAyNTI5NTM1NDA3OjNjOTdkMjYzM2YxYTE1NWRjYTRmMzk2ZDNmMmM0ZGZhZWNjMDYwNjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a6e3417b9ce4980f7f28e6abec47079d0fa2b86", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a6e3417b9ce4980f7f28e6abec47079d0fa2b86", "committedDate": "2020-11-30T12:59:50Z", "message": "Use scriptless fields rather than ad-hoc painless load-from-source scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6", "committedDate": "2020-11-30T13:10:15Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwODk2NDk0", "url": "https://github.com/elastic/elasticsearch/pull/65599#pullrequestreview-540896494", "createdAt": "2020-11-30T13:15:46Z", "commit": {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzoxNTo0NlrOH76l5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzoxNTo0NlrOH76l5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjU4ODAwNQ==", "bodyText": "this seems wrong but it's irrelevant because the tests that use it are disabled. I plan on replacing the dynamic template with dynamic:runtime", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532588005", "createdAt": "2020-11-30T13:15:46Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/qa/src/main/java/org/elasticsearch/xpack/runtimefields/test/CoreTestTranslater.java", "diffHunk": "@@ -118,15 +90,11 @@ private static String painlessToLoadFromSource(String name, String type) {\n \n     // TODO there isn't yet a way to create fields in the runtime section from a dynamic template\n     protected static Map<String, Object> dynamicTemplateToAddRuntimeFields(String type) {\n-        return Map.ofEntries(\n-            Map.entry(\"type\", \"runtime\"),\n-            Map.entry(\"runtime_type\", type),\n-            Map.entry(\"script\", painlessToLoadFromSource(\"{name}\", type))\n-        );\n+        return Map.ofEntries(Map.entry(\"type\", \"runtime\"), Map.entry(\"runtime_type\", type));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6"}, "originalPosition": 67}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwOTE1NjE0", "url": "https://github.com/elastic/elasticsearch/pull/65599#pullrequestreview-540915614", "createdAt": "2020-11-30T13:40:05Z", "commit": {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzo0MDowNVrOH77hLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQxMzo0MDowNVrOH77hLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjYwMzE4Mw==", "bodyText": "This is a tricksy bit - it's breaking one test, search/30_limits/Regexp length limit, I think because it's looking for the source value of name.keyword which of course doesn't exist.", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r532603183", "createdAt": "2020-11-30T13:40:05Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/runtime-fields/qa/core-with-search/src/yamlRestTest/java/org/elasticsearch/xpack/runtimefields/test/search/CoreTestsWithSearchRuntimeFieldsIT.java", "diffHunk": "@@ -173,43 +173,43 @@ protected boolean handleIndex(IndexRequest index) {\n                             continue;\n                         }\n                         if (value instanceof Boolean) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"boolean\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"boolean\"));\n                             continue;\n                         }\n                         if (value instanceof Long || value instanceof Integer) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"long\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"long\"));\n                             continue;\n                         }\n                         if (value instanceof Double) {\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"double\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"double\"));\n                             continue;\n                         }\n                         if (false == value instanceof String) {\n                             continue;\n                         }\n                         try {\n                             Long.parseLong(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"long\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"long\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         try {\n                             Double.parseDouble(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"double\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"double\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         try {\n                             DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.parse(value.toString());\n-                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(name, \"date\"));\n+                            indexRuntimeMappings.put(name, runtimeFieldLoadingFromSource(\"date\"));\n                             continue;\n                         } catch (IllegalArgumentException iae) {\n                             // Try the next one\n                         }\n                         // Strings are funny, the regular dynamic mapping puts them in \"name.keyword\" so we follow along.\n-                        indexRuntimeMappings.put(name + \".keyword\", runtimeFieldLoadingFromSource(name, \"keyword\"));\n+                        indexRuntimeMappings.put(name + \".keyword\", runtimeFieldLoadingFromSource(\"keyword\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffcd53b7ec7e5b0324ee3279f82508dfcecf40b6"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1b5b73b9224beb5567829f9b15fe2c81cf59717", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1b5b73b9224beb5567829f9b15fe2c81cf59717", "committedDate": "2020-12-01T10:29:31Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/core-test-translator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92f7675dec158bbd7684ae1a1852b50b59fa0e3b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/92f7675dec158bbd7684ae1a1852b50b59fa0e3b", "committedDate": "2020-12-01T12:43:08Z", "message": "Divide up test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxODYwMjY5", "url": "https://github.com/elastic/elasticsearch/pull/65599#pullrequestreview-541860269", "createdAt": "2020-12-01T12:46:59Z", "commit": {"oid": "92f7675dec158bbd7684ae1a1852b50b59fa0e3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjo0Njo1OVrOH8rCSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMVQxMjo0Njo1OVrOH8rCSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMzM4MTcwNw==", "bodyText": "Splitting this test into two makes it work \ud83e\udd37", "url": "https://github.com/elastic/elasticsearch/pull/65599#discussion_r533381707", "createdAt": "2020-12-01T12:46:59Z", "author": {"login": "romseygeek"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -140,6 +140,9 @@ setup:\n                    \\\".\\\\[\\\\]]))|\\\"(?:[^\\\\\\\"\\\\r\\\\\\\\]|\\\\\\\\.|(?:(?:\\\\r\\\\n)?[\\\\t]))*\\\"(?:(?:\\\\r\\\\n)?[ \\\\t])*)(?:\\\\.(?:( |\n                    \\\\[\\\"()<>@,;:\\\\\\\\\\\".\\\\[\\\\]]))|\\\"(?:[^\\\\\\\"\\\\r\\\\\\\\]|\\\\\\\\.|(?:(?:\\\\r\\\\n)?[\\\\t]))*\\\"(?:(?:\\\\r\\\\n)?[\\\\t\"\n \n+---\n+\"Regexp length limit - query_string\":\n+\n   - do:\n       catch: /The length of regex \\[1110\\]/\n       search:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "92f7675dec158bbd7684ae1a1852b50b59fa0e3b"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f61a939d8cb11d161caaf9723e86b4f597f2c289", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f61a939d8cb11d161caaf9723e86b4f597f2c289", "committedDate": "2020-12-02T09:14:50Z", "message": "Revert \"Divide up test\"\n\nThis reverts commit 92f7675dec158bbd7684ae1a1852b50b59fa0e3b."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c97d2633f1a155dca4f396d3f2c4dfaecc06061", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c97d2633f1a155dca4f396d3f2c4dfaecc06061", "committedDate": "2020-12-02T09:18:36Z", "message": "Mute 30_limits test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4359, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}