{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MjAyMzc5", "number": 60219, "title": "[ML] Ensure bulk requests are not over memory limit", "bodyText": "Data frame analytics jobs that work with very large datasets\nmay produce bulk requests that are over the memory limit\nfor indexing. This commit adds a helper class that bundles\nindex requests in bulk requests that steer away from the\nmemory limit. We then use this class both from the results\njoiner and the inference runner ensuring data frame analytics\njobs do not generate bulk requests that are too large.\nNote the limit was implemented in #58885.", "createdAt": "2020-07-27T14:30:52Z", "url": "https://github.com/elastic/elasticsearch/pull/60219", "merged": true, "mergeCommit": {"oid": "9528f9c0d2c9c15356e10ee71619eec83dc910a8"}, "closed": true, "closedAt": "2020-07-28T11:46:06Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5CtxLAH2gAyNDU3MjAyMzc5OjEyZWEwODI4ZDFkMDM4ZDZkMGI2NWI3ZDIwNzJlZmM2MmFiNWNjZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5TNZuAH2gAyNDU3MjAyMzc5OjYzOWYwZmNmYTc0MjM5OGJjYjVhMjAxYTQyYzdkOTA1MWJhNzM4YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1", "committedDate": "2020-07-27T14:29:34Z", "message": "[ML] Ensure bulk requests are not over memory limit\n\nData frame analytics jobs that work with very large datasets\nmay produce bulk requests that are over the memory limit\nfor indexing. This commit adds a helper class that bundles\nindex requests in bulk requests that steer away from the\nmemory limit. We then use this class both from the results\njoiner and the inference runner ensuring data frame analytics\njobs do not generate bulk requests that are too large.\n\nNote the limit was implemented in #58885."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU1ODY5ODM1", "url": "https://github.com/elastic/elasticsearch/pull/60219#pullrequestreview-455869835", "createdAt": "2020-07-27T15:03:29Z", "commit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Mzg4Mzg5", "url": "https://github.com/elastic/elasticsearch/pull/60219#pullrequestreview-456388389", "createdAt": "2020-07-28T07:54:42Z", "commit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo1NDo0M1rOG4A9Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo1NjozNFrOG4BBGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTA2Nw==", "bodyText": "Would Settings.EMPTY work here as well?", "url": "https://github.com/elastic/elasticsearch/pull/60219#discussion_r461389067", "createdAt": "2020-07-28T07:54:43Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManagerTests.java", "diffHunk": "@@ -112,8 +112,8 @@ public void setUpMocks() {\n \n         resultsPersisterService = mock(ResultsPersisterService.class);\n         modelLoadingService = mock(ModelLoadingService.class);\n-        processManager = new AnalyticsProcessManager(client, executorServiceForJob, executorServiceForProcess, processFactory, auditor,\n-            trainedModelProvider, modelLoadingService, resultsPersisterService, 1);\n+        processManager = new AnalyticsProcessManager(Settings.builder().build(), client, executorServiceForJob, executorServiceForProcess,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTM5Mg==", "bodyText": "hasSize matcher could be used here instead.", "url": "https://github.com/elastic/elasticsearch/pull/60219#discussion_r461389392", "createdAt": "2020-07-28T07:55:14Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoinerTests.java", "diffHunk": "@@ -263,7 +264,10 @@ public void testProcess_GivenMoreResultsThanRows() throws IOException {\n         RowResults result2 = new RowResults(2, resultFields);\n         givenProcessResults(Arrays.asList(result1, result2));\n \n-        verifyNoMoreInteractions(resultsPersisterService);\n+        List<BulkRequest> capturedBulkRequests = bulkRequestCaptor.getAllValues();\n+        assertThat(capturedBulkRequests.size(), equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4OTY5Mw==", "bodyText": "final?", "url": "https://github.com/elastic/elasticsearch/pull/60219#discussion_r461389693", "createdAt": "2020-07-28T07:55:45Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/utils/persistence/MlBulkIndexerTests.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils.persistence;\n+\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.test.ESTestCase;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.empty;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasSize;\n+import static org.hamcrest.Matchers.is;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.when;\n+\n+public class MlBulkIndexerTests extends ESTestCase {\n+\n+    private List<BulkRequest> executedBulkRequests = new ArrayList<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM5MDEwNg==", "bodyText": "There is no ML-specific code in this class. Would it make sense to rename it to BulkIndexer?", "url": "https://github.com/elastic/elasticsearch/pull/60219#discussion_r461390106", "createdAt": "2020-07-28T07:56:34Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/MlBulkIndexer.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.utils.persistence;\n+\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.index.IndexingPressure;\n+\n+import java.util.Objects;\n+import java.util.function.Consumer;\n+\n+/**\n+ * A helper class that gathers index requests in bulk requests\n+ * that do exceed a 1000 operations or half the available memory\n+ * limit for indexing.\n+ */\n+public class MlBulkIndexer implements AutoCloseable {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "12ea0828d1d038d6d0b65b7d2072efc62ab5ccd1"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "195acdbbf4de73a81ff2009ccc8666eefa2b10ff", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/195acdbbf4de73a81ff2009ccc8666eefa2b10ff", "committedDate": "2020-07-28T09:06:30Z", "message": "Address review points"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd6221362bd6e4b2d08c3ada98d220820e984fa", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/9dd6221362bd6e4b2d08c3ada98d220820e984fa", "committedDate": "2020-07-28T09:22:15Z", "message": "Add debug log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "037e9f3d23f7379862c7b5b29467978fc9591d75", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/037e9f3d23f7379862c7b5b29467978fc9591d75", "committedDate": "2020-07-28T09:38:13Z", "message": "Merge branch 'master' into ensure-ml-bulk-requests-are-not-over-limit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "639f0fcfa742398bcb5a201a42c7d9051ba738ab", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/639f0fcfa742398bcb5a201a42c7d9051ba738ab", "committedDate": "2020-07-28T09:42:36Z", "message": "Rename to `LimitAwareBulkIndexer`"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4799, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}