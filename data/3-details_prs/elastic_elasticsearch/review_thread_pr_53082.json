{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzMTY3Mjk5", "number": 53082, "reviewThreads": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOToxODozOFrODk9z5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDoxMjoxMlrODmUDnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMDg4MDM2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Mode.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQwOToxODozOFrOFxlXaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMDo0OVrOFxsnOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUzNjc0Nw==", "bodyText": "I don't see the usefulness of this method tbh. Mode is an enum, and there is only one CLI type of mode. Why not keeping the == Mode.CLI? Things are different for isDriver where is a double check, but for CLI why?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387536747", "createdAt": "2020-03-04T09:18:38Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Mode.java", "diffHunk": "@@ -33,4 +33,9 @@ public String toString() {\n     public static boolean isDriver(Mode mode) {\n         return mode == JDBC || mode == ODBC;\n     }\n+\n+    // TODO: replace all \"== Mode.CLI\"?\n+    public static boolean isCli(Mode mode) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NTQ4MQ==", "bodyText": "In many cases the code look like Mode.isDriver(mode) || mode == Mode.CLI and Mode.isDriver(mode) || Mode.isCli(mode) looked more consistent to me. I got to it from a first thought of adding a Mode.isStrictClient() to check for all drivers+cli (since we treat those grouped in many cases). Irrespective of that, though, if Mode being an enum is to be considered, one would either stick to mode == Mode.JDBC || mode == Mode.jdbc || mode == Mode.CLI or the two methods wrapping, IMO.\nHowever, this isn't a strictly necessary refactoring, it is subjective and I'll happily change it back if you still think the old way is better (just \ud83d\udc4d this comment).", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387655481", "createdAt": "2020-03-04T13:10:49Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Mode.java", "diffHunk": "@@ -33,4 +33,9 @@ public String toString() {\n     public static boolean isDriver(Mode mode) {\n         return mode == JDBC || mode == ODBC;\n     }\n+\n+    // TODO: replace all \"== Mode.CLI\"?\n+    public static boolean isCli(Mode mode) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzUzNjc0Nw=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTA1ODA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDowODowOFrOFxnFcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMzoxMTowNFrOFxsnzQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2NDkxMw==", "bodyText": "Why was this changed?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387564913", "createdAt": "2020-03-04T10:08:08Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -26,7 +26,7 @@\n \n     public void testProperConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n-        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), org.elasticsearch.Version.CURRENT.toString(),\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), Version.CURRENT.toString(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NTYyOQ==", "bodyText": "The class has been making use of the client.Version class already. Using two Version versions is not strictly needed anymore. Before this PR client.Version.toString() behaved differently than elasticsearch.Version.toString(), but this has been changed (old behavior is still available in client.Version.versionString(), but that's not used anywhere atm.)", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387655629", "createdAt": "2020-03-04T13:11:04Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -26,7 +26,7 @@\n \n     public void testProperConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n-        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), org.elasticsearch.Version.CURRENT.toString(),\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), Version.CURRENT.toString(),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2NDkxMw=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTA4NzcwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDoxNjozOFrOFxnYCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo0MTo0OVrOFx089Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2OTY3NQ==", "bodyText": "I think we should check the error message itself, as well.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387569675", "createdAt": "2020-03-04T10:16:38Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -44,6 +44,31 @@ public void testConnection() throws Exception {\n     }\n \n     public void testWrongServerVersion() throws Exception {\n+        HttpClient httpClient = mock(HttpClient.class);\n+        byte minor;\n+        byte major;\n+        if (randomBoolean()) {\n+            if (Version.CURRENT.minor <= 0) {\n+                minor = Version.REVISION_MULTIPLIER - 1;\n+                major = (byte)(Version.CURRENT.major - 1);\n+            } else {\n+                minor = (byte) (Version.CURRENT.minor - 1);\n+                major = Version.CURRENT.major;\n+            }\n+        } else {\n+            minor = Version.CURRENT.minor;\n+            major = (byte) (Version.CURRENT.major - 1);\n+        }\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5),\n+                Version.fromString(major + \".\" + minor + \".23\").toString(),\n+                ClusterName.DEFAULT.value(), UUIDs.randomBase64UUID()));\n+        CliSession cliSession = new CliSession(httpClient);\n+        expectThrows(ClientException.class, cliSession::checkConnection);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NTU1OA==", "bodyText": "Sure. Neither of the already defined tests check the message, but I'll look into adding it.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387655558", "createdAt": "2020-03-04T13:10:56Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -44,6 +44,31 @@ public void testConnection() throws Exception {\n     }\n \n     public void testWrongServerVersion() throws Exception {\n+        HttpClient httpClient = mock(HttpClient.class);\n+        byte minor;\n+        byte major;\n+        if (randomBoolean()) {\n+            if (Version.CURRENT.minor <= 0) {\n+                minor = Version.REVISION_MULTIPLIER - 1;\n+                major = (byte)(Version.CURRENT.major - 1);\n+            } else {\n+                minor = (byte) (Version.CURRENT.minor - 1);\n+                major = Version.CURRENT.major;\n+            }\n+        } else {\n+            minor = Version.CURRENT.minor;\n+            major = (byte) (Version.CURRENT.major - 1);\n+        }\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5),\n+                Version.fromString(major + \".\" + minor + \".23\").toString(),\n+                ClusterName.DEFAULT.value(), UUIDs.randomBase64UUID()));\n+        CliSession cliSession = new CliSession(httpClient);\n+        expectThrows(ClientException.class, cliSession::checkConnection);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2OTY3NQ=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MjExNw==", "bodyText": "added.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387792117", "createdAt": "2020-03-04T16:41:49Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -44,6 +44,31 @@ public void testConnection() throws Exception {\n     }\n \n     public void testWrongServerVersion() throws Exception {\n+        HttpClient httpClient = mock(HttpClient.class);\n+        byte minor;\n+        byte major;\n+        if (randomBoolean()) {\n+            if (Version.CURRENT.minor <= 0) {\n+                minor = Version.REVISION_MULTIPLIER - 1;\n+                major = (byte)(Version.CURRENT.major - 1);\n+            } else {\n+                minor = (byte) (Version.CURRENT.minor - 1);\n+                major = Version.CURRENT.major;\n+            }\n+        } else {\n+            minor = Version.CURRENT.minor;\n+            major = (byte) (Version.CURRENT.major - 1);\n+        }\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5),\n+                Version.fromString(major + \".\" + minor + \".23\").toString(),\n+                ClusterName.DEFAULT.value(), UUIDs.randomBase64UUID()));\n+        CliSession cliSession = new CliSession(httpClient);\n+        expectThrows(ClientException.class, cliSession::checkConnection);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU2OTY3NQ=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTIzMjkxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxMDo1ODo1OVrOFxoy-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo1MDozN1rOFx7XCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5Mjk1Mg==", "bodyText": "Maybe call this version something different. For example, in AbstractFieldHitExtractor we have SWITCHED_FROM_DOCVALUES_TO_SOURCE_EXTRACTION. Does it make sense to have this one called ENFORCED_CLIENT_VERSION_PARAMETER?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387592952", "createdAt": "2020-03-04T10:58:59Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.proto;\n+\n+import java.security.InvalidParameterException;\n+\n+public class Version implements Comparable<Version>{\n+\n+    public final int id;\n+    public final String version; // originally provided String representation\n+    public final byte major;\n+    public final byte minor;\n+    public final byte revision;\n+\n+    public static final int REVISION_MULTIPLIER = 100;\n+    public static final int MINOR_MULTIPLIER = REVISION_MULTIPLIER * REVISION_MULTIPLIER;\n+    public static final int MAJOR_MULTIPLIER = REVISION_MULTIPLIER * MINOR_MULTIPLIER;\n+\n+\n+\n+    public static final Version V_7_7_0 = new Version(7, 7, 0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzY1NTQzMA==", "bodyText": "It could make sense, yes, but I imagine that we'll need to log a new version here with each \"breaking\" change we add in the protocol. If we'd instrument somehow these changes, referring to the versions by their number might be easier. But we could also refer to the versions by a name that conveys the gist of the breaking change, true. Wdyt?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387655430", "createdAt": "2020-03-04T13:10:43Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.proto;\n+\n+import java.security.InvalidParameterException;\n+\n+public class Version implements Comparable<Version>{\n+\n+    public final int id;\n+    public final String version; // originally provided String representation\n+    public final byte major;\n+    public final byte minor;\n+    public final byte revision;\n+\n+    public static final int REVISION_MULTIPLIER = 100;\n+    public static final int MINOR_MULTIPLIER = REVISION_MULTIPLIER * REVISION_MULTIPLIER;\n+    public static final int MAJOR_MULTIPLIER = REVISION_MULTIPLIER * MINOR_MULTIPLIER;\n+\n+\n+\n+    public static final Version V_7_7_0 = new Version(7, 7, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5Mjk1Mg=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5NzA5Nw==", "bodyText": "While I would prefer a name, I think using the versions gives us excellent flexibility in the long term. I'd opt towards adding a comment plus an utility method (that uses the field internally) with a verbose name:\npublic boolean supportsVersioning(Version version) {\n  return version.compareTo(V_7_...) >= 0;\n}", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387897097", "createdAt": "2020-03-04T19:50:37Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.proto;\n+\n+import java.security.InvalidParameterException;\n+\n+public class Version implements Comparable<Version>{\n+\n+    public final int id;\n+    public final String version; // originally provided String representation\n+    public final byte major;\n+    public final byte minor;\n+    public final byte revision;\n+\n+    public static final int REVISION_MULTIPLIER = 100;\n+    public static final int MINOR_MULTIPLIER = REVISION_MULTIPLIER * REVISION_MULTIPLIER;\n+    public static final int MAJOR_MULTIPLIER = REVISION_MULTIPLIER * MINOR_MULTIPLIER;\n+\n+\n+\n+    public static final Version V_7_7_0 = new Version(7, 7, 0);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzU5Mjk1Mg=="}, "originalCommit": {"oid": "33bcd3d5164c6da825ab88cb08f3f0382ea6ca35"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMTk5ODM3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/security/src/test/java/org/elasticsearch/xpack/sql/qa/security/RestSqlSecurityIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo0NzoxNlrOFxwIiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo0MDozMlrOFx05uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxMzE2MA==", "bodyText": "should it be version(m) here?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387713160", "createdAt": "2020-03-04T14:47:16Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/security/src/test/java/org/elasticsearch/xpack/sql/qa/security/RestSqlSecurityIT.java", "diffHunk": "@@ -233,15 +237,16 @@ public void testHijackScrollFails() throws Exception {\n \n         String mode = randomMode();\n         Map<String, Object> adminResponse = RestActions.runSql(null,\n-                new StringEntity(\"{\\\"query\\\": \\\"SELECT * FROM test\\\", \\\"fetch_size\\\": 1\" + mode(mode) + \"}\",\n+                new StringEntity(\"{\\\"query\\\": \\\"SELECT * FROM test\\\", \\\"fetch_size\\\": 1\" + mode(mode) + version(mode) + \"}\",\n                         ContentType.APPLICATION_JSON), mode);\n \n         String cursor = (String) adminResponse.remove(\"cursor\");\n         assertNotNull(cursor);\n \n         final String m = randomMode();\n         ResponseException e = expectThrows(ResponseException.class, () -> RestActions.runSql(\"full_access\",\n-                new StringEntity(\"{\\\"cursor\\\":\\\"\" + cursor + \"\\\"\" + mode(m) + \"}\", ContentType.APPLICATION_JSON), m));\n+                new StringEntity(\"{\\\"cursor\\\":\\\"\" + cursor + \"\\\"\" + mode(m) + version(mode) + \"}\", ContentType.APPLICATION_JSON),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MTI5MQ==", "bodyText": "nice catch, thanks. fixed.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387791291", "createdAt": "2020-03-04T16:40:32Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/security/src/test/java/org/elasticsearch/xpack/sql/qa/security/RestSqlSecurityIT.java", "diffHunk": "@@ -233,15 +237,16 @@ public void testHijackScrollFails() throws Exception {\n \n         String mode = randomMode();\n         Map<String, Object> adminResponse = RestActions.runSql(null,\n-                new StringEntity(\"{\\\"query\\\": \\\"SELECT * FROM test\\\", \\\"fetch_size\\\": 1\" + mode(mode) + \"}\",\n+                new StringEntity(\"{\\\"query\\\": \\\"SELECT * FROM test\\\", \\\"fetch_size\\\": 1\" + mode(mode) + version(mode) + \"}\",\n                         ContentType.APPLICATION_JSON), mode);\n \n         String cursor = (String) adminResponse.remove(\"cursor\");\n         assertNotNull(cursor);\n \n         final String m = randomMode();\n         ResponseException e = expectThrows(ResponseException.class, () -> RestActions.runSql(\"full_access\",\n-                new StringEntity(\"{\\\"cursor\\\":\\\"\" + cursor + \"\\\"\" + mode(m) + \"}\", ContentType.APPLICATION_JSON), m));\n+                new StringEntity(\"{\\\"cursor\\\":\\\"\" + cursor + \"\\\"\" + mode(m) + version(mode) + \"}\", ContentType.APPLICATION_JSON),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxMzE2MA=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 59}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjAwMTE2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/single-node/src/test/java/org/elasticsearch/xpack/sql/qa/single_node/RestSqlIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo0Nzo1OVrOFxwKaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo0MDozOVrOFx06Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxMzY0MQ==", "bodyText": "maybe mode(\"odbc\") as well (also below)?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387713641", "createdAt": "2020-03-04T14:47:59Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/single-node/src/test/java/org/elasticsearch/xpack/sql/qa/single_node/RestSqlIT.java", "diffHunk": "@@ -42,16 +42,16 @@ public void testErrorMessageForTranslatingSQLCommandStatement() throws IOExcepti\n \n     public void testErrorMessageForInvalidParamDataType() throws IOException {\n         expectBadRequest(() -> runTranslateSql(\n-            \"{\\\"query\\\":\\\"SELECT null WHERE 0 = ? \\\", \\\"mode\\\": \\\"odbc\\\", \\\"params\\\":[{\\\"type\\\":\\\"invalid\\\", \\\"value\\\":\\\"irrelevant\\\"}]}\"\n-            ),\n+            \"{\\\"query\\\":\\\"SELECT null WHERE 0 = ? \\\", \\\"mode\\\": \\\"odbc\\\" \" + version(\"odbc\") +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MTM3NA==", "bodyText": "makes sense, fixed.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387791374", "createdAt": "2020-03-04T16:40:39Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/single-node/src/test/java/org/elasticsearch/xpack/sql/qa/single_node/RestSqlIT.java", "diffHunk": "@@ -42,16 +42,16 @@ public void testErrorMessageForTranslatingSQLCommandStatement() throws IOExcepti\n \n     public void testErrorMessageForInvalidParamDataType() throws IOException {\n         expectBadRequest(() -> runTranslateSql(\n-            \"{\\\"query\\\":\\\"SELECT null WHERE 0 = ? \\\", \\\"mode\\\": \\\"odbc\\\", \\\"params\\\":[{\\\"type\\\":\\\"invalid\\\", \\\"value\\\":\\\"irrelevant\\\"}]}\"\n-            ),\n+            \"{\\\"query\\\":\\\"SELECT null WHERE 0 = ? \\\", \\\"mode\\\": \\\"odbc\\\" \" + version(\"odbc\") +", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxMzY0MQ=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjAxOTEyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlRequest.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo1MjoyNVrOFxwV7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo1Mzo0OFrOFx1aZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNjU4OA==", "bodyText": "since you use writeOptionalString no need for null check.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387716588", "createdAt": "2020-03-04T14:52:25Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlRequest.java", "diffHunk": "@@ -56,8 +58,9 @@ public void writeTo(StreamOutput out) throws IOException {\n         super.writeTo(out);\n         out.writeEnum(requestInfo.mode());\n         out.writeOptionalString(requestInfo.clientId());\n+        out.writeOptionalString(requestInfo.version() == null ? null : requestInfo.version().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5NTczMw==", "bodyText": "the check is there for the .toString() to be safe.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387795733", "createdAt": "2020-03-04T16:47:34Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlRequest.java", "diffHunk": "@@ -56,8 +58,9 @@ public void writeTo(StreamOutput out) throws IOException {\n         super.writeTo(out);\n         out.writeEnum(requestInfo.mode());\n         out.writeOptionalString(requestInfo.clientId());\n+        out.writeOptionalString(requestInfo.version() == null ? null : requestInfo.version().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNjU4OA=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5OTY1Mg==", "bodyText": "ah yep, I see, thx!", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387799652", "createdAt": "2020-03-04T16:53:48Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlRequest.java", "diffHunk": "@@ -56,8 +58,9 @@ public void writeTo(StreamOutput out) throws IOException {\n         super.writeTo(out);\n         out.writeEnum(requestInfo.mode());\n         out.writeOptionalString(requestInfo.clientId());\n+        out.writeOptionalString(requestInfo.version() == null ? null : requestInfo.version().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNjU4OA=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjAyNDM0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo1MzozNlrOFxwZGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo0MTozNVrOFx08Vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNzQwMg==", "bodyText": "Why is it null here?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387717402", "createdAt": "2020-03-04T14:53:36Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "diffHunk": "@@ -66,10 +68,11 @@ public void testClearCursorRequestParser() throws IOException {\n         assertNull(request.clientId());\n         assertEquals(Mode.PLAIN, request.mode());\n         assertEquals(\"whatever\", request.getCursor());\n-        \n-        request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"client_id\\\" : \\\"CLI\\\"}\",\n+\n+        request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"client_id\\\" : \\\"CLI\\\", \\\"client_version\\\": \\\"1.2.3\\\"}\",\n                 SqlClearCursorRequest::fromXContent);\n         assertNull(request.clientId());\n+        assertNull(request.version());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MTk1OQ==", "bodyText": "b/c the parser for SqlClearCursorRequest doesn't set these fields.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387791959", "createdAt": "2020-03-04T16:41:35Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "diffHunk": "@@ -66,10 +68,11 @@ public void testClearCursorRequestParser() throws IOException {\n         assertNull(request.clientId());\n         assertEquals(Mode.PLAIN, request.mode());\n         assertEquals(\"whatever\", request.getCursor());\n-        \n-        request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"client_id\\\" : \\\"CLI\\\"}\",\n+\n+        request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"client_id\\\" : \\\"CLI\\\", \\\"client_version\\\": \\\"1.2.3\\\"}\",\n                 SqlClearCursorRequest::fromXContent);\n         assertNull(request.clientId());\n+        assertNull(request.version());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcxNzQwMg=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMjA0MDgzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNDo1NzozMFrOFxwjTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxNjo0MDo1NVrOFx06tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyMDAxNA==", "bodyText": "nit: please keep one or two empy lines.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387720014", "createdAt": "2020-03-04T14:57:30Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.proto;\n+\n+import java.security.InvalidParameterException;\n+\n+public class Version implements Comparable<Version>{\n+\n+    public final int id;\n+    public final String version; // originally provided String representation\n+    public final byte major;\n+    public final byte minor;\n+    public final byte revision;\n+\n+    public static final int REVISION_MULTIPLIER = 100;\n+    public static final int MINOR_MULTIPLIER = REVISION_MULTIPLIER * REVISION_MULTIPLIER;\n+    public static final int MAJOR_MULTIPLIER = REVISION_MULTIPLIER * MINOR_MULTIPLIER;\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzc5MTU0Mw==", "bodyText": "sure. (i'm trying not to commit whitespace editor \"fixes\" - as everybody, prolly - and this one slipped through.)", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387791543", "createdAt": "2020-03-04T16:40:55Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Version.java", "diffHunk": "@@ -0,0 +1,134 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.sql.proto;\n+\n+import java.security.InvalidParameterException;\n+\n+public class Version implements Comparable<Version>{\n+\n+    public final int id;\n+    public final String version; // originally provided String representation\n+    public final byte major;\n+    public final byte minor;\n+    public final byte revision;\n+\n+    public static final int REVISION_MULTIPLIER = 100;\n+    public static final int MINOR_MULTIPLIER = REVISION_MULTIPLIER * REVISION_MULTIPLIER;\n+    public static final int MAJOR_MULTIPLIER = REVISION_MULTIPLIER * MINOR_MULTIPLIER;\n+\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzcyMDAxNA=="}, "originalCommit": {"oid": "1058b72cad5ac4f50bb54bed64d8157a58c3674a"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzAzNTk2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/multi-node/src/test/java/org/elasticsearch/xpack/sql/qa/multi_node/RestSqlMultinodeIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyMjoyMVrOFx6Zog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyNzowOFrOFy4okg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MTM3OA==", "bodyText": "It's worth adding an utility (or two) to handle the query wrapping:\n\none to add mode() and version at the end as parameters\nanother to wrap the given string in a query with the {\\\"query\\\", escaped quotes and everything else.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387881378", "createdAt": "2020-03-04T19:22:21Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/multi-node/src/test/java/org/elasticsearch/xpack/sql/qa/multi_node/RestSqlMultinodeIT.java", "diffHunk": "@@ -110,7 +111,7 @@ private void assertCount(RestClient client, int count) throws IOException {\n         expected.put(\"rows\", singletonList(singletonList(count)));\n \n         Request request = new Request(\"POST\", SQL_QUERY_REST_ENDPOINT);\n-        request.setJsonEntity(\"{\\\"query\\\": \\\"SELECT COUNT(*) FROM test\\\"\" + mode(mode) + \"}\");\n+        request.setJsonEntity(\"{\\\"query\\\": \\\"SELECT COUNT(*) FROM test\\\"\" + mode(mode) + version(mode) + \"}\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTAxMA==", "bodyText": "That's true. And the fact that the queries are \"manually\" build can lead to more work whenever the fields list is updated. I've had a stab at mimicking SqlQueryRequestBuilder's interface at building requests and apply the change through the tests here, but the change is a bit larger, and it might be worth having a separate PR?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901010", "createdAt": "2020-03-06T13:27:08Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/multi-node/src/test/java/org/elasticsearch/xpack/sql/qa/multi_node/RestSqlMultinodeIT.java", "diffHunk": "@@ -110,7 +111,7 @@ private void assertCount(RestClient client, int count) throws IOException {\n         expected.put(\"rows\", singletonList(singletonList(count)));\n \n         Request request = new Request(\"POST\", SQL_QUERY_REST_ENDPOINT);\n-        request.setJsonEntity(\"{\\\"query\\\": \\\"SELECT COUNT(*) FROM test\\\"\" + mode(mode) + \"}\");\n+        request.setJsonEntity(\"{\\\"query\\\": \\\"SELECT COUNT(*) FROM test\\\"\" + mode(mode) + version(mode) + \"}\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MTM3OA=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzAzNzQ5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/security/src/test/java/org/elasticsearch/xpack/sql/qa/security/RestSqlSecurityIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyMjo0NlrOFx6amQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyMjo0NlrOFx6amQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MTYyNQ==", "bodyText": "Same comment as above, it applies in other places but I won't repeat it.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387881625", "createdAt": "2020-03-04T19:22:46Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/security/src/test/java/org/elasticsearch/xpack/sql/qa/security/RestSqlSecurityIT.java", "diffHunk": "@@ -70,10 +71,10 @@ public void expectMatchesAdmin(String adminSql, String user, String userSql) thr\n         public void expectScrollMatchesAdmin(String adminSql, String user, String userSql) throws Exception {\n             String mode = randomMode();\n             Map<String, Object> adminResponse = runSql(null,\n-                    new StringEntity(\"{\\\"query\\\": \\\"\" + adminSql + \"\\\", \\\"fetch_size\\\": 1\" + mode(mode) + \"}\",\n+                    new StringEntity(\"{\\\"query\\\": \\\"\" + adminSql + \"\\\", \\\"fetch_size\\\": 1\" + mode(mode) + version(mode) + \"}\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA0MzQyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/SqlProtocolTestCase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyNDoyOFrOFx6eTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyNzoxOVrOFy4o4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MjU3NA==", "bodyText": "Mode.isCli doesn't add much value and since Mode.isDriver() || Mode.isCli is a common pattern, it's worth wrapping that into its own method: Mode.isInternalClient or Mode.isDedicatedClient or Mode.isSqlClient to differentiate between our \"own\" clients and everything else.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387882574", "createdAt": "2020-03-04T19:24:28Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/SqlProtocolTestCase.java", "diffHunk": "@@ -252,14 +253,13 @@ private void assertQuery(String sql, String columnName, String columnType, Objec\n \n         // randomize binary response enforcement for drivers (ODBC/JDBC) and CLI\n         boolean binaryCommunication = randomBoolean();\n-        Mode m = Mode.fromString(mode);\n         if (randomBoolean()) {\n             // set it explicitly or leave the default (null) as is\n             requestContent = new StringBuilder(requestContent)\n                     .insert(requestContent.length() - 1, \",\\\"binary_format\\\":\" + binaryCommunication).toString();\n-            binaryCommunication = ((Mode.isDriver(m) || m == Mode.CLI) && binaryCommunication);\n+            binaryCommunication = ((Mode.isDriver(mode) || Mode.isCli(mode)) && binaryCommunication);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTA5MQ==", "bodyText": "Agreed, fixed it.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901091", "createdAt": "2020-03-06T13:27:19Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/SqlProtocolTestCase.java", "diffHunk": "@@ -252,14 +253,13 @@ private void assertQuery(String sql, String columnName, String columnType, Objec\n \n         // randomize binary response enforcement for drivers (ODBC/JDBC) and CLI\n         boolean binaryCommunication = randomBoolean();\n-        Mode m = Mode.fromString(mode);\n         if (randomBoolean()) {\n             // set it explicitly or leave the default (null) as is\n             requestContent = new StringBuilder(requestContent)\n                     .insert(requestContent.length() - 1, \",\\\"binary_format\\\":\" + binaryCommunication).toString();\n-            binaryCommunication = ((Mode.isDriver(m) || m == Mode.CLI) && binaryCommunication);\n+            binaryCommunication = ((Mode.isDriver(mode) || Mode.isCli(mode)) && binaryCommunication);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4MjU3NA=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA0NTM4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/rest/RestSqlUsageTestCase.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyNTowMlrOFx6fig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyNTowMlrOFx6fig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4Mjg5MA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387882890", "createdAt": "2020-03-04T19:25:02Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/rest/RestSqlUsageTestCase.java", "diffHunk": "@@ -255,18 +256,18 @@ private void runTranslate(String sql) throws IOException {\n     }\n     \n     private void runSql(String sql) throws IOException {\n-        String mode = Mode.PLAIN.toString();\n+        Mode mode = Mode.PLAIN;\n         if (clientType.equals(ClientType.JDBC.toString())) {\n-            mode = Mode.JDBC.toString();\n+            mode = Mode.JDBC;\n         } else if (clientType.startsWith(ClientType.ODBC.toString())) {\n-            mode = Mode.ODBC.toString();\n+            mode = Mode.ODBC;\n         } else if (clientType.equals(ClientType.CLI.toString())) {\n-            mode = Mode.CLI.toString();\n+            mode = Mode.CLI;\n         }\n \n-        runSql(mode, clientType, sql);\n+        runSql(mode.toString(), clientType, sql);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA1MjEzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOToyNzowMlrOFx6jxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyNzoyN1rOFy4pJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4Mzk3NA==", "bodyText": "I would just say version since all parameters are client specific. client_id has is as such since just id would have been too cryptic.\nThere's no client_mode, or client_params so why client_verision.\nIn fact, if anything we could change client_id to drop the prefix by using a different word: something like fingerprint or info (too loose).", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387883974", "createdAt": "2020-03-04T19:27:02Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -57,6 +63,7 @@\n     static final ParseField FILTER = new ParseField(\"filter\");\n     static final ParseField MODE = new ParseField(\"mode\");\n     static final ParseField CLIENT_ID = new ParseField(\"client_id\");\n+    static final ParseField CLIENT_VERSION = new ParseField(\"client_version\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTE1OQ==", "bodyText": "Makes sense, fixed it.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901159", "createdAt": "2020-03-06T13:27:27Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/AbstractSqlQueryRequest.java", "diffHunk": "@@ -57,6 +63,7 @@\n     static final ParseField FILTER = new ParseField(\"filter\");\n     static final ParseField MODE = new ParseField(\"mode\");\n     static final ParseField CLIENT_ID = new ParseField(\"client_id\");\n+    static final ParseField CLIENT_VERSION = new ParseField(\"client_version\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4Mzk3NA=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA3MTg2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/RequestInfo.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTozMjozMFrOFx6wFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyNzozMlrOFy4pUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NzEyNg==", "bodyText": "It seems this constructor is used everywhere using Version.CURRENT - maybe it makes sense to automatically initialize version when Mode is passed instead of setting it as null.\nAs it stands the constructor initializes Version twice.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387887126", "createdAt": "2020-03-04T19:32:30Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/RequestInfo.java", "diffHunk": "@@ -35,14 +35,25 @@\n     \n     private Mode mode;\n     private String clientId;\n-    \n+    private Version version;\n+\n     public RequestInfo(Mode mode) {\n-        this(mode, null);\n+        this(mode, null, null);\n     }\n     \n     public RequestInfo(Mode mode, String clientId) {\n+        this(mode, clientId, null);\n+    }\n+\n+    public RequestInfo(Mode mode, String clientId, String version) {\n         mode(mode);\n         clientId(clientId);\n+        version(version);\n+    }\n+\n+    public RequestInfo(Mode mode, Version version) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTIwMQ==", "bodyText": "As it stands the constructor initializes Version twice.\n\nAddressed this.\nBut auto-initialising along with Mode is not possible, since the CURRENT Version value is only available in client, but not in proto.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901201", "createdAt": "2020-03-06T13:27:32Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/RequestInfo.java", "diffHunk": "@@ -35,14 +35,25 @@\n     \n     private Mode mode;\n     private String clientId;\n-    \n+    private Version version;\n+\n     public RequestInfo(Mode mode) {\n-        this(mode, null);\n+        this(mode, null, null);\n     }\n     \n     public RequestInfo(Mode mode, String clientId) {\n+        this(mode, clientId, null);\n+    }\n+\n+    public RequestInfo(Mode mode, String clientId, String version) {\n         mode(mode);\n         clientId(clientId);\n+        version(version);\n+    }\n+\n+    public RequestInfo(Mode mode, Version version) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NzEyNg=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzA3Mzg2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/SqlQueryRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTozMzowM1rOFx6xWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyODoyMFrOFy4qxQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NzQ0OA==", "bodyText": "Some constants for these strings would be nice.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387887448", "createdAt": "2020-03-04T19:33:03Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/SqlQueryRequest.java", "diffHunk": "@@ -180,6 +180,9 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (clientId() != null) {\n             builder.field(\"client_id\", clientId());\n         }\n+        if (version() != null) {\n+            builder.field(\"client_version\", version().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTU3Mw==", "bodyText": "Very much agreed. I would address this in a follow-up PR, thought, since these hardcoded strings are used extensively in tests?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901573", "createdAt": "2020-03-06T13:28:20Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/SqlQueryRequest.java", "diffHunk": "@@ -180,6 +180,9 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         if (clientId() != null) {\n             builder.field(\"client_id\", clientId());\n         }\n+        if (version() != null) {\n+            builder.field(\"client_version\", version().toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg4NzQ0OA=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzE0MDA1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo1MjozNVrOFx7bmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzoyOTowM1rOFy4sMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5ODI2Nw==", "bodyText": "Functionally, this class is not another Version but a consumer of Version.\nIt has only isServerCompatible and jdbcMajor/Minor (which were added to this class since it was the only one but could be moved somewhere else).\nTry refactoring it to something else either a consumer:\nClientVersion(Version) { .. }\nor if there's no state, utility methods - ClientVersion/VersionUtils.isServerCompatible(version)`", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387898267", "createdAt": "2020-03-04T19:52:35Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -16,37 +16,20 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n+public class Version extends org.elasticsearch.xpack.sql.proto.Version {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMTkzNw==", "bodyText": "Sure. I've turned that class into a ClientVersion utility class.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388901937", "createdAt": "2020-03-06T13:29:03Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -16,37 +16,20 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n+public class Version extends org.elasticsearch.xpack.sql.proto.Version {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Nzg5ODI2Nw=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzE1MjkwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo1NjozM1rOFx7jvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxMzozMToxNFrOFy4wNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwMDM0OA==", "bodyText": "The V_7_7_0 constant is leaking - encapsulate that into Version (which already has the constant) to something like Version.hasVersionCompatibility/isCompatible or something along those lines so the lines becomes:\nreturn server.isCompatible()", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387900348", "createdAt": "2020-03-04T19:56:33Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -117,11 +100,21 @@ static Version extractVersion(URL url) {\n         return new Version(ver, hash, maj, min, rev);\n     }\n \n-    @Override\n-    public String toString() {\n+    public String versionString() {\n         return \"v\" + version + \" [\" + hash + \"]\";\n     }\n \n+    // This function helps ensure that a client won't attempt to communicate to a server with less features than its own. Since this check\n+    // is part of the client's start-up check that might not involve an actual SQL API request, the client has to do a bare version check\n+    // as well.\n+    public static boolean isServerCompatible(Version server) {\n+        // Starting with this version, the compatibility logic moved from the client to the server. Only relevant for 7.x releases.\n+        return server.compareTo(Version.V_7_7_0) >= 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODkwMjk2NQ==", "bodyText": "took on your .hasVersionCompatibility() suggestion.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r388902965", "createdAt": "2020-03-06T13:31:14Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -117,11 +100,21 @@ static Version extractVersion(URL url) {\n         return new Version(ver, hash, maj, min, rev);\n     }\n \n-    @Override\n-    public String toString() {\n+    public String versionString() {\n         return \"v\" + version + \" [\" + hash + \"]\";\n     }\n \n+    // This function helps ensure that a client won't attempt to communicate to a server with less features than its own. Since this check\n+    // is part of the client's start-up check that might not involve an actual SQL API request, the client has to do a bare version check\n+    // as well.\n+    public static boolean isServerCompatible(Version server) {\n+        // Starting with this version, the compatibility logic moved from the client to the server. Only relevant for 7.x releases.\n+        return server.compareTo(Version.V_7_7_0) >= 0", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwMDM0OA=="}, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQwMzE1MzQ2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/HttpClientRequestTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo1Njo0NFrOFx7kFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNFQxOTo1Njo0NFrOFx7kFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzkwMDQzOQ==", "bodyText": "See my comment on RequestInfo constructor.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r387900439", "createdAt": "2020-03-04T19:56:44Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/HttpClientRequestTests.java", "diffHunk": "@@ -158,7 +158,7 @@ private void assertBinaryRequestForDrivers(boolean isBinary, XContentType xConte\n                 null,\n                 randomBoolean(),\n                 randomAlphaOfLength(128),\n-                new RequestInfo(mode),\n+                new RequestInfo(mode, Version.CURRENT),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e9567b9b7df5de78e6e33e9e8dc6b921b789f5d7"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTU0NjAxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/SqlQueryRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMTowNjowNVrOFzLhbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMTowNDo1MFrOFzNvGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDQ3Ng==", "bodyText": "Why wasn't this called here before? The code we had was a bug?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389210476", "createdAt": "2020-03-07T01:06:05Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/SqlQueryRequest.java", "diffHunk": "@@ -72,7 +72,7 @@ public SqlQueryRequest(String query, List<SqlTypedParamValue> params, QueryBuild\n \n     @Override\n     public ActionRequestValidationException validate() {\n-        ActionRequestValidationException validationException = null;\n+        ActionRequestValidationException validationException = super.validate();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0Njc0Ng==", "bodyText": "The overridden function (in action/AbstractSqlQueryRequest.java) wasn't implemented before (and now it checks client's version).", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389246746", "createdAt": "2020-03-07T11:04:50Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-action/src/main/java/org/elasticsearch/xpack/sql/action/SqlQueryRequest.java", "diffHunk": "@@ -72,7 +72,7 @@ public SqlQueryRequest(String query, List<SqlTypedParamValue> params, QueryBuild\n \n     @Override\n     public ActionRequestValidationException validate() {\n-        ActionRequestValidationException validationException = null;\n+        ActionRequestValidationException validationException = super.validate();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMDQ3Ng=="}, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTU1ODQ3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMToxOTo0N1rOFzLoyg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMTowNDozNFrOFzNvEQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjM2Mg==", "bodyText": "Why not using the same condition as above? Mode.isDedicatedClient(randomMode)", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389212362", "createdAt": "2020-03-07T01:19:47Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "diffHunk": "@@ -119,12 +127,16 @@ public void testQueryRequestParser() throws IOException {\n         \n         SqlQueryRequest request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"mode\\\" : \\\"\"\n                 + randomMode.toString() + \"\\\", \\\"client_id\\\" : \\\"bla\\\",\"\n+                + clientVersion\n                 + \"\\\"query\\\":\\\"select\\\",\"\n                 + \"\\\"params\\\":[\" + params + \"],\"\n                 + \" \\\"time_zone\\\":\\\"UTC\\\",\"\n                 + \"\\\"request_timeout\\\":\\\"5s\\\",\\\"page_timeout\\\":\\\"10s\\\"}\", SqlQueryRequest::fromXContent);\n         assertNull(request.clientId());\n         assertEquals(randomMode, request.mode());\n+        if (clientVersion.isEmpty() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0NjczNw==", "bodyText": "good point.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389246737", "createdAt": "2020-03-07T11:04:34Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-action/src/test/java/org/elasticsearch/xpack/sql/action/SqlRequestParsersTests.java", "diffHunk": "@@ -119,12 +127,16 @@ public void testQueryRequestParser() throws IOException {\n         \n         SqlQueryRequest request = generateRequest(\"{\\\"cursor\\\" : \\\"whatever\\\", \\\"mode\\\" : \\\"\"\n                 + randomMode.toString() + \"\\\", \\\"client_id\\\" : \\\"bla\\\",\"\n+                + clientVersion\n                 + \"\\\"query\\\":\\\"select\\\",\"\n                 + \"\\\"params\\\":[\" + params + \"],\"\n                 + \" \\\"time_zone\\\":\\\"UTC\\\",\"\n                 + \"\\\"request_timeout\\\":\\\"5s\\\",\\\"page_timeout\\\":\\\"10s\\\"}\", SqlQueryRequest::fromXContent);\n         assertNull(request.clientId());\n         assertEquals(randomMode, request.mode());\n+        if (clientVersion.isEmpty() == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMjM2Mg=="}, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMTU2ODg5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QwMTozMjozMlrOFzLu2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wN1QxMTowNDozOVrOFzNvFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMzkxMw==", "bodyText": "Too many round brackets?", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389213913", "createdAt": "2020-03-07T01:32:32Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "diffHunk": "@@ -60,7 +60,7 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n          */\n         String accept = null;\n \n-        if ((Mode.isDriver(sqlRequest.requestInfo().mode()) || sqlRequest.requestInfo().mode() == Mode.CLI)\n+        if ((Mode.isDedicatedClient(sqlRequest.requestInfo().mode()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTI0Njc0MQ==", "bodyText": "thanks, fixed.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389246741", "createdAt": "2020-03-07T11:04:39Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/plugin/RestSqlQueryAction.java", "diffHunk": "@@ -60,7 +60,7 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n          */\n         String accept = null;\n \n-        if ((Mode.isDriver(sqlRequest.requestInfo().mode()) || sqlRequest.requestInfo().mode() == Mode.CLI)\n+        if ((Mode.isDedicatedClient(sqlRequest.requestInfo().mode()))", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTIxMzkxMw=="}, "originalCommit": {"oid": "6bcf6721722e61282ba627ea670846a51aa93a67"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMzAxNjg4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMToyNDozOFrOFzXftQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQwOTo0NjoxNFrOFzgavQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwNjY0NQ==", "bodyText": "Worth adding a javadoc to clarify the difference between ClientVersion, SqlVersion and Version.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389406645", "createdAt": "2020-03-08T21:24:38Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -16,45 +18,17 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n-\n-    public static final Version CURRENT;\n-    public final String version;\n-    public final String hash;\n-    public final byte major;\n-    public final byte minor;\n-    public final byte revision;\n-\n-    private Version(String version, String hash, byte... parts) {\n-        this.version = version;\n-        this.hash = hash;\n-        this.major = parts[0];\n-        this.minor = parts[1];\n-        this.revision = parts[2];\n-    }\n-\n-    public static Version fromString(String version) {\n-        return new Version(version, \"Unknown\", from(version));\n-    }\n+public class ClientVersion {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a471c541d31be8bdf6caf5b778bc217bf7c1b162"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwNzg3MA==", "bodyText": "+1", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389407870", "createdAt": "2020-03-08T21:41:25Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -16,45 +18,17 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n-\n-    public static final Version CURRENT;\n-    public final String version;\n-    public final String hash;\n-    public final byte major;\n-    public final byte minor;\n-    public final byte revision;\n-\n-    private Version(String version, String hash, byte... parts) {\n-        this.version = version;\n-        this.hash = hash;\n-        this.major = parts[0];\n-        this.minor = parts[1];\n-        this.revision = parts[2];\n-    }\n-\n-    public static Version fromString(String version) {\n-        return new Version(version, \"Unknown\", from(version));\n-    }\n+public class ClientVersion {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwNjY0NQ=="}, "originalCommit": {"oid": "a471c541d31be8bdf6caf5b778bc217bf7c1b162"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTU1MjgyOQ==", "bodyText": "I've added a short description for SqlVersion and ClientVersion. Hope it's enough, but could elaborate if felt as necessary.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389552829", "createdAt": "2020-03-09T09:46:14Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -16,45 +18,17 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n-\n-    public static final Version CURRENT;\n-    public final String version;\n-    public final String hash;\n-    public final byte major;\n-    public final byte minor;\n-    public final byte revision;\n-\n-    private Version(String version, String hash, byte... parts) {\n-        this.version = version;\n-        this.hash = hash;\n-        this.major = parts[0];\n-        this.minor = parts[1];\n-        this.revision = parts[2];\n-    }\n-\n-    public static Version fromString(String version) {\n-        return new Version(version, \"Unknown\", from(version));\n-    }\n+public class ClientVersion {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwNjY0NQ=="}, "originalCommit": {"oid": "a471c541d31be8bdf6caf5b778bc217bf7c1b162"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDk4NjcyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDowODo0NlrOFzp-vQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzozMDowOFrOFzyWJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwOTUwMQ==", "bodyText": "That's a good way of wrapping two checks in the same one, but throughout the code in SQL (where there are many such checks) we do them separately: expectThrows and then another assertEquals on the exception message.\nI'm not saying you should change it, but the way it is now, it is inconsistent throughout sql code.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389709501", "createdAt": "2020-03-09T14:08:46Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -26,40 +27,58 @@\n \n     public void testProperConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n-        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), org.elasticsearch.Version.CURRENT.toString(),\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), ClientVersion.CURRENT.toString(),\n                 ClusterName.DEFAULT.value(), UUIDs.randomBase64UUID()));\n         CliSession cliSession = new CliSession(httpClient);\n         cliSession.checkConnection();\n         verify(httpClient, times(1)).serverInfo();\n         verifyNoMoreInteractions(httpClient);\n     }\n \n+    public static <T extends Throwable> void expectThrows(Class<T> expectedType, ThrowingRunnable runnable, String exceptionMessage) {\n+        T throwable = expectThrows(expectedType, runnable);\n+        assertEquals(exceptionMessage, throwable.getMessage());\n+    }\n+\n     public void testConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n         when(httpClient.serverInfo()).thenThrow(new SQLException(\"Cannot connect\"));\n         CliSession cliSession = new CliSession(httpClient);\n-        expectThrows(ClientException.class, cliSession::checkConnection);\n+        expectThrows(ClientException.class, cliSession::checkConnection, \"java.sql.SQLException: Cannot connect\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee904b3d8fdf513387f4ab734837001c906d5dbf"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NjU2Nw==", "bodyText": "adjusted to keep consistency.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389846567", "createdAt": "2020-03-09T17:30:08Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-cli/src/test/java/org/elasticsearch/xpack/sql/cli/CliSessionTests.java", "diffHunk": "@@ -26,40 +27,58 @@\n \n     public void testProperConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n-        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), org.elasticsearch.Version.CURRENT.toString(),\n+        when(httpClient.serverInfo()).thenReturn(new MainResponse(randomAlphaOfLength(5), ClientVersion.CURRENT.toString(),\n                 ClusterName.DEFAULT.value(), UUIDs.randomBase64UUID()));\n         CliSession cliSession = new CliSession(httpClient);\n         cliSession.checkConnection();\n         verify(httpClient, times(1)).serverInfo();\n         verifyNoMoreInteractions(httpClient);\n     }\n \n+    public static <T extends Throwable> void expectThrows(Class<T> expectedType, ThrowingRunnable runnable, String exceptionMessage) {\n+        T throwable = expectThrows(expectedType, runnable);\n+        assertEquals(exceptionMessage, throwable.getMessage());\n+    }\n+\n     public void testConnection() throws Exception {\n         HttpClient httpClient = mock(HttpClient.class);\n         when(httpClient.serverInfo()).thenThrow(new SQLException(\"Cannot connect\"));\n         CliSession cliSession = new CliSession(httpClient);\n-        expectThrows(ClientException.class, cliSession::checkConnection);\n+        expectThrows(ClientException.class, cliSession::checkConnection, \"java.sql.SQLException: Cannot connect\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcwOTUwMQ=="}, "originalCommit": {"oid": "ee904b3d8fdf513387f4ab734837001c906d5dbf"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNDk5NzUyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDoxMDoyM1rOFzqFzw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyOTo1NFrOFzyVjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMTMxMQ==", "bodyText": "they're or they are in the sentence identifying the release their are part of.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389711311", "createdAt": "2020-03-09T14:10:23Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -16,45 +18,25 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n-\n-    public static final Version CURRENT;\n-    public final String version;\n-    public final String hash;\n-    public final byte major;\n-    public final byte minor;\n-    public final byte revision;\n-\n-    private Version(String version, String hash, byte... parts) {\n-        this.version = version;\n-        this.hash = hash;\n-        this.major = parts[0];\n-        this.minor = parts[1];\n-        this.revision = parts[2];\n-    }\n-\n-    public static Version fromString(String version) {\n-        return new Version(version, \"Unknown\", from(version));\n-    }\n+/**\n+ * Clients-specific version utility class.\n+ * <p>\n+ *     The class provides the SQL clients the version identifying the release their are part of. The version is read from the encompassing", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee904b3d8fdf513387f4ab734837001c906d5dbf"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NjQxMw==", "bodyText": "thanks, fixed.", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389846413", "createdAt": "2020-03-09T17:29:54Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -16,45 +18,25 @@\n import java.util.jar.JarInputStream;\n import java.util.jar.Manifest;\n \n-public class Version {\n-\n-    public static final Version CURRENT;\n-    public final String version;\n-    public final String hash;\n-    public final byte major;\n-    public final byte minor;\n-    public final byte revision;\n-\n-    private Version(String version, String hash, byte... parts) {\n-        this.version = version;\n-        this.hash = hash;\n-        this.major = parts[0];\n-        this.minor = parts[1];\n-        this.revision = parts[2];\n-    }\n-\n-    public static Version fromString(String version) {\n-        return new Version(version, \"Unknown\", from(version));\n-    }\n+/**\n+ * Clients-specific version utility class.\n+ * <p>\n+ *     The class provides the SQL clients the version identifying the release their are part of. The version is read from the encompassing", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMTMxMQ=="}, "originalCommit": {"oid": "ee904b3d8fdf513387f4ab734837001c906d5dbf"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxNTAxMDg3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Mode.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDoxMjoxMlrOFzqOBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNDoxMjoxMlrOFzqOBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTcxMzQxNQ==", "bodyText": "return isDriver(mode) || mode == CLI", "url": "https://github.com/elastic/elasticsearch/pull/53082#discussion_r389713415", "createdAt": "2020-03-09T14:12:12Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-proto/src/main/java/org/elasticsearch/xpack/sql/proto/Mode.java", "diffHunk": "@@ -33,4 +33,8 @@ public String toString() {\n     public static boolean isDriver(Mode mode) {\n         return mode == JDBC || mode == ODBC;\n     }\n+\n+    public static boolean isDedicatedClient(Mode mode) {\n+        return mode == JDBC || mode == ODBC || mode == CLI;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ee904b3d8fdf513387f4ab734837001c906d5dbf"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3402, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}