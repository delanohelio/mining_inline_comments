{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NjUxNzk0", "number": 51207, "title": "Short circuited to MatchNone for non-participating  slice", "bodyText": "When the query is  expensive  parallel usage of scroll/slice API overloads cluster, ( In my case a span_multi query causes heap / gc issues )\nLooks like its because same query is processed against all non-matching shards with a MatchNoDocs and matching-shards with MatchAllDocs filter. In case of number of shards =< number of slices, returning a MatchNoDocs query instead of filter seems to avoid that problem.", "createdAt": "2020-01-20T05:34:38Z", "url": "https://github.com/elastic/elasticsearch/pull/51207", "merged": true, "mergeCommit": {"oid": "c7aaf5a2d28cd852407ae7b9fbb1eb454ca0e4bb"}, "closed": true, "closedAt": "2020-01-22T17:43:15Z", "author": {"login": "nirmalc"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8F05IgH2gAyMzY0NjUxNzk0OmVkZTIzZTAyOGE4NDhmMTNiODg0MTZjZThhZGRiMzA1MTU0ZTdjNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb84lRngH2gAyMzY0NjUxNzk0OmM5YWJhNzFlMzEwNTNmMjNhNjZhZDg0OTBjY2M4Nzg2ZDJhOTdhZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48", "author": {"user": {"login": "nirmalc", "name": "Nirmal Chidambaram"}}, "url": "https://github.com/elastic/elasticsearch/commit/ede23e028a848f13b88416ce8addb305154e7c48", "committedDate": "2020-01-20T05:37:41Z", "message": "Short circuited to MatchNone for non-participating  slice\n\nIn case of numSlices = numShards , use a MatchNone query instead of\nboolean with a MatchNone - MUST clause"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "bda93c5283250bdb9fdcc1730ccaf0388d1350d0", "author": {"user": {"login": "nirmalc", "name": "Nirmal Chidambaram"}}, "url": "https://github.com/elastic/elasticsearch/commit/bda93c5283250bdb9fdcc1730ccaf0388d1350d0", "committedDate": "2020-01-20T04:33:17Z", "message": "Short circuited to MatchNone for non-participating  slice\n\nIn case of numSlices = numShards , use a MatchNone query instead of\nboolean with a MatchNone - MUST clause"}, "afterCommit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48", "author": {"user": {"login": "nirmalc", "name": "Nirmal Chidambaram"}}, "url": "https://github.com/elastic/elasticsearch/commit/ede23e028a848f13b88416ce8addb305154e7c48", "committedDate": "2020-01-20T05:37:41Z", "message": "Short circuited to MatchNone for non-participating  slice\n\nIn case of numSlices = numShards , use a MatchNone query instead of\nboolean with a MatchNone - MUST clause"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1ODQ2ODM4", "url": "https://github.com/elastic/elasticsearch/pull/51207#pullrequestreview-345846838", "createdAt": "2020-01-21T12:41:32Z", "commit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo0MTozMlrOFf4mWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQxMjo0NjoxNFrOFf4uBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3NzQ5Nw==", "bodyText": "nit: space before else", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368977497", "createdAt": "2020-01-21T12:41:32Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java", "diffHunk": "@@ -274,7 +275,12 @@ public Query buildFilteredQuery(Query query) {\n         }\n \n         if (sliceBuilder != null) {\n-            filters.add(sliceBuilder.toFilter(clusterService, request, queryShardContext));\n+            Query slicedQuery = sliceBuilder.toFilter(clusterService, request, queryShardContext);\n+            if ( slicedQuery instanceof MatchNoDocsQuery){\n+                return slicedQuery;\n+            }else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3Nzc4NQ==", "bodyText": "extra space after (", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368977785", "createdAt": "2020-01-21T12:42:15Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/DefaultSearchContext.java", "diffHunk": "@@ -274,7 +275,12 @@ public Query buildFilteredQuery(Query query) {\n         }\n \n         if (sliceBuilder != null) {\n-            filters.add(sliceBuilder.toFilter(clusterService, request, queryShardContext));\n+            Query slicedQuery = sliceBuilder.toFilter(clusterService, request, queryShardContext);\n+            if ( slicedQuery instanceof MatchNoDocsQuery){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTE3Mw==", "bodyText": "nit: new DefaultSearchContext(3L, =>  new DefaultSearchContext(4L,", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368979173", "createdAt": "2020-01-21T12:45:33Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java", "diffHunk": "@@ -178,6 +182,20 @@ public void testPreProcess() throws Exception {\n             ParsedQuery parsedQuery = ParsedQuery.parsedMatchAllQuery();\n             context3.sliceBuilder(null).parsedQuery(parsedQuery).preProcess(false);\n             assertEquals(context3.query(), context3.buildFilteredQuery(parsedQuery.query()));\n+\n+            when(queryShardContext.getIndexSettings()).thenReturn(indexSettings);\n+            when(indexService.newQueryShardContext(anyInt(),anyObject(),anyObject(),anyString())).thenReturn(queryShardContext);\n+            when(queryShardContext.fieldMapper(anyString())).thenReturn(mock(MappedFieldType.class));\n+            when(shardSearchRequest.indexRoutings()).thenReturn(new String[0]);\n+\n+            DefaultSearchContext context4 = new DefaultSearchContext(3L, shardSearchRequest, target, searcher, null,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODk3OTQ2MA==", "bodyText": "Looks like, line 187 in not necessary", "url": "https://github.com/elastic/elasticsearch/pull/51207#discussion_r368979460", "createdAt": "2020-01-21T12:46:14Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/test/java/org/elasticsearch/search/DefaultSearchContextTests.java", "diffHunk": "@@ -178,6 +182,20 @@ public void testPreProcess() throws Exception {\n             ParsedQuery parsedQuery = ParsedQuery.parsedMatchAllQuery();\n             context3.sliceBuilder(null).parsedQuery(parsedQuery).preProcess(false);\n             assertEquals(context3.query(), context3.buildFilteredQuery(parsedQuery.query()));\n+\n+            when(queryShardContext.getIndexSettings()).thenReturn(indexSettings);\n+            when(indexService.newQueryShardContext(anyInt(),anyObject(),anyObject(),anyString())).thenReturn(queryShardContext);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ede23e028a848f13b88416ce8addb305154e7c48"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3c838cc6dda37cb3828bb9d7b36ecc48eb87eb8", "author": {"user": {"login": "nirmalc", "name": "Nirmal Chidambaram"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3c838cc6dda37cb3828bb9d7b36ecc48eb87eb8", "committedDate": "2020-01-21T14:09:19Z", "message": "code review changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f0ce3d9d012b8f699da46cc5a5ea502935ba6c0", "author": {"user": {"login": "nirmalc", "name": "Nirmal Chidambaram"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f0ce3d9d012b8f699da46cc5a5ea502935ba6c0", "committedDate": "2020-01-21T15:23:47Z", "message": "Removed unused namespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9aba71e31053f23a66ad8490ccc8786d2a97af5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9aba71e31053f23a66ad8490ccc8786d2a97af5", "committedDate": "2020-01-22T16:45:47Z", "message": "Merge branch 'master' into slicefix"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3024, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}