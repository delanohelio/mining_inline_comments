{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA2Nzg2OTMx", "number": 63937, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoxNDoyM1rOEvxRgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo0NFrOE1MblA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTI1ODI2OnYy", "diffSide": "RIGHT", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoxNDoyM1rOHk7wvA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoxNDoyM1rOHk7wvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ4OTkxNg==", "bodyText": "These changes are due to position increment handling moving directly into TextParams.Analyzers, which simplifies a lot of the palaver around building analyzers for text fields.  SearchAsYouType doesn't actually expose a position increment field so doesn't get the added benefits here, but it still requires a small refactor.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508489916", "createdAt": "2020-10-20T13:14:23Z", "author": {"login": "romseygeek"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/SearchAsYouTypeFieldMapper.java", "diffHunk": "@@ -95,18 +95,14 @@\n     public static final TypeParser PARSER\n         = new TypeParser((n, c) -> new Builder(n, () -> c.getIndexAnalyzers().getDefaultIndexAnalyzer()));\n \n-    private static SearchAsYouTypeFieldMapper toType(FieldMapper in) {\n-        return (SearchAsYouTypeFieldMapper) in;\n-    }\n-\n-    private static SearchAsYouTypeFieldType ft(FieldMapper in) {\n-        return toType(in).fieldType();\n+    private static Builder builder(FieldMapper in) {\n+        return ((SearchAsYouTypeFieldMapper)in).builder;\n     }\n \n     public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        private final Parameter<Boolean> index = Parameter.indexParam(m -> toType(m).index, true);\n-        private final Parameter<Boolean> store = Parameter.storeParam(m -> toType(m).store, false);\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> builder(m).index.get(), true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTI4MzIxOnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoxOTo0MFrOHk8APA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoxOTo0MFrOHk8APA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5Mzg4NA==", "bodyText": "The upshot of this change is to make the analyze action work in precisely the way this comment says it doesn't... if the analyzer hasn't been built specifically for this request, then we're examining the analyzer for a specific field, and so we use the general index analyzer and pass the field name so that it delegates to the correct field analyzer.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508493884", "createdAt": "2020-10-20T13:19:40Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/analyze/TransportAnalyzeAction.java", "diffHunk": "@@ -220,10 +220,8 @@ private static Analyzer buildCustomAnalyzer(AnalyzeAction.Request request, Analy\n         List<AnalyzeAction.AnalyzeToken> tokens = new ArrayList<>();\n         int lastPosition = -1;\n         int lastOffset = 0;\n-        // Note that we always pass \"\" as the field to the various Analyzer methods, because\n-        // the analyzers we use here are all field-specific and so ignore this parameter", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTI4ODcwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMDo0N1rOHk8Dow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMDo0N1rOHk8Dow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NDc1NQ==", "bodyText": "This is moved from the fastvector highlighter - it would be nice to actually fix this in Lucene rather than have this annoying check.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508494755", "createdAt": "2020-10-20T13:20:47Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/analysis/FieldNameAnalyzer.java", "diffHunk": "@@ -48,4 +48,20 @@ protected Analyzer getWrappedAnalyzer(String fieldName) {\n         // Fields need to be explicitly added\n         throw new IllegalArgumentException(\"Field [\" + fieldName + \"] has no associated analyzer\");\n     }\n+\n+    public boolean containsBrokenAnalysis(String field) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTMwMTE5OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMjoyOVrOHk8LKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMjoyOVrOHk8LKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NjY4MA==", "bodyText": "This was an IDE-recommended change, we've just asserted that maxInputLength is smaller than input.length(), so Math.min will always return it.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508496680", "createdAt": "2020-10-20T13:22:29Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/CompletionFieldMapper.java", "diffHunk": "@@ -402,7 +376,7 @@ public void parse(ParseContext context) throws IOException {\n             }\n             // truncate input\n             if (input.length() > maxInputLength) {\n-                int len = Math.min(maxInputLength, input.length());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 178}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTMwNTQ3OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMzoxN1rOHk8Nvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMzoxN1rOHk8Nvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NzM0Mg==", "bodyText": "Nothing calls this anymore (all mappers that use analyzers have been parametrized) so it is safe to remove.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508497342", "createdAt": "2020-10-20T13:23:17Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -400,17 +402,6 @@ private void mergeSharedOptions(FieldMapper mergeWith, List<String> conflicts) {\n         if (fieldType.storeTermVectorPayloads() != other.storeTermVectorPayloads()) {\n             conflicts.add(\"mapper [\" + name() + \"] has different [store_term_vector_payloads] values\");\n         }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTMwNjY0OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMzozMlrOHk8OgQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyMzozMlrOHk8OgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5NzUzNw==", "bodyText": "This is not called from anywhere so can be removed.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508497537", "createdAt": "2020-10-20T13:23:32Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -460,35 +451,6 @@ protected void doXContentBody(XContentBuilder builder, boolean includeDefaults,\n         }\n     }\n \n-    protected final void doXContentAnalyzers(XContentBuilder builder, boolean includeDefaults) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTMxNjQ4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyNToyM1rOHk8UYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyNToyM1rOHk8UYA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODQ5OTA0MA==", "bodyText": "We don't need the default analyzer any more because text-based field mappers now always provide an analyzer even if they're using a default.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508499040", "createdAt": "2020-10-20T13:25:23Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappingLookup.java", "diffHunk": "@@ -42,14 +42,7 @@\n     private final int metadataFieldCount;\n     private final FieldNameAnalyzer indexAnalyzer;\n \n-    private static void put(Map<String, Analyzer> analyzers, String key, Analyzer value, Analyzer defaultValue) {\n-        if (value == null) {\n-            value = defaultValue;\n-        }\n-        analyzers.put(key, value);\n-    }\n-\n-    public static MappingLookup fromMapping(Mapping mapping, Analyzer defaultIndex) {\n+    public static MappingLookup fromMapping(Mapping mapping) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTMyMzg5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyNjo0NFrOHk8Y3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzoyNjo0NFrOHk8Y3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMDE4OQ==", "bodyText": "We will be able to remove these entirely in a follow-up", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508500189", "createdAt": "2020-10-20T13:26:44Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java", "diffHunk": "@@ -569,8 +550,11 @@ public Query existsQuery(QueryShardContext context) {\n \n     private static final class PhraseFieldMapper extends FieldMapper {\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 138}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4NTM0MTc2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozMDowNFrOHk8kTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMFQxMzozMDowNFrOHk8kTw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwODUwMzExOQ==", "bodyText": "These are a consequence of changing to checking for TextSearchInfo.NONE rather than an index analyzer.  Again, it is sort of accidental that they work, and it may not make any real sense, but they do...", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r508503119", "createdAt": "2020-10-20T13:30:04Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTextAggregatorTests.java", "diffHunk": "@@ -80,7 +78,10 @@ protected AggregationBuilder createAggBuilderForTypeTest(MappedFieldType fieldTy\n     protected List<ValuesSourceType> getSupportedValuesSourceTypes() {\n         // TODO it is likely accidental that SigText supports anything other than Bytes, and then only text fields\n         return List.of(CoreValuesSourceType.NUMERIC,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3d8dfc708758b9c3396a3a892f8e114d268e6389"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTYxMjc0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDo0MjozNVrOHlllmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODozODo1MlrOHrFnIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA==", "bodyText": "don't we already expose the indexAnalyzer? In that case do we need this additional method in MapperService?", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509175194", "createdAt": "2020-10-21T10:42:35Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,6 +444,10 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public boolean containsBrokenAnalysis(String field) {\n+        return this.indexAnalyzer.containsBrokenAnalysis(field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5MjU4Mg==", "bodyText": "It's exposed as a plain Analyzer though, and the impl itself is package-private (because it gets set on the IndexWriter immediately but needs to be configured subsequently, so it's a semi-transparent wrapper).  It is annoying though - really what needs to happen is that lucene needs to fix things so that term vectors can't contain broken offsets...", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512092582", "createdAt": "2020-10-26T16:23:44Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,6 +444,10 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public boolean containsBrokenAnalysis(String field) {\n+        return this.indexAnalyzer.containsBrokenAnalysis(field);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0Mjc1NQ==", "bodyText": "I see thanks for explaining", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514942755", "createdAt": "2020-10-30T08:38:52Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -444,6 +444,10 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public boolean containsBrokenAnalysis(String field) {\n+        return this.indexAnalyzer.containsBrokenAnalysis(field);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE3NTE5NA=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTY2OTI0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMDo1ODoxOFrOHlmIGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQxNDoyMjo1M1rOHqeOdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw==", "bodyText": "I think this could be package private.\nCouple more thoughts:  do we need a biconsumer? it seems like every mapper could expose its own analyzers through a Map<String, Analyzer>. This would though be quite a complicated API for the regular case, where a field either registers nothing or registers one analyzer with the same name as the field. Could we simplify things for those cases? I do see that you may want the method as abstract so you don't forget to implement it, but it requires so many empty implementations that I wonder if we should simplify this.\nTo summarize, how about something like this:\n//override this if you need multiple analyzers for the same field\nMap<String, Analyzer> getAnalyzers() {\n    return Collections.singletonMap(name(), getFieldAnalyzer());\n}\n\n//most field mappers implement this one, possibly we could return a placeholder for the case where no analyzer is needed, not sure if we want to not make it abstract, I am undecided on that.\nabstract Analyzer getFieldAnalyzer();\n\nTwo methods would have the advantage that it would be immediately traceable which mappers register multiple fields, if that matters.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509184027", "createdAt": "2020-10-21T10:58:18Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -506,6 +468,8 @@ protected static String indexOptionToString(IndexOptions indexOption) {\n \n     protected abstract String contentType();\n \n+    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA4OTE3OQ==", "bodyText": "Another option would be to create a FieldMapper subclass called AnalyzedFieldMapper or similar that makes this abstract, and then have a default impl on FieldMapper itself that does nothing?", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512089179", "createdAt": "2020-10-26T16:18:59Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -506,6 +468,8 @@ protected static String indexOptionToString(IndexOptions indexOption) {\n \n     protected abstract String contentType();\n \n+    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjQ5OTIwNA==", "bodyText": "That could also work, but I would still find it weird that we need a biconsumer as an argument", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512499204", "createdAt": "2020-10-27T08:32:51Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -506,6 +468,8 @@ protected static String indexOptionToString(IndexOptions indexOption) {\n \n     protected abstract String contentType();\n \n+    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDI5NzQ2Mg==", "bodyText": "I've changed this to return a Map instead.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514297462", "createdAt": "2020-10-29T14:22:53Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/FieldMapper.java", "diffHunk": "@@ -506,6 +468,8 @@ protected static String indexOptionToString(IndexOptions indexOption) {\n \n     protected abstract String contentType();\n \n+    public abstract void registerIndexAnalyzer(BiConsumer<String, Analyzer> analyzerRegistry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NDAyNw=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4OTY3OTQ3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxMTowMToxNFrOHlmOTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODozMjozN1rOHrFbhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ==", "bodyText": "Something that bugs me, not directly related to your change, but that we may want to address: MapperService exposes indexAnalyzer, MappingLookup too. But they are two fundamentally different things. I have issues remembering which is what. Could we name them differently. Also as I am going to need to expose them both in the QueryShardContext. I am calling the new one getFieldNameAnalyzer, but you'll have better ideas.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r509185615", "createdAt": "2020-10-21T11:01:14Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -121,7 +121,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n+        this.indexAnalyzer = new MapperAnalyzerWrapper();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMjA5NDczNw==", "bodyText": "Yeah, I think this should be removed from MappingLookup entirely, and just live in MapperService.  I'll see if I can incorporate that here as well.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r512094737", "createdAt": "2020-10-26T16:26:36Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -121,7 +121,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n+        this.indexAnalyzer = new MapperAnalyzerWrapper();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDE5NzcxMA==", "bodyText": "This turned out not to be straightforward, so let's leave it for a separate issue", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514197710", "createdAt": "2020-10-29T11:48:01Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -121,7 +121,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n+        this.indexAnalyzer = new MapperAnalyzerWrapper();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDkzOTc4Mg==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514939782", "createdAt": "2020-10-30T08:32:37Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -121,7 +121,7 @@ public MapperService(IndexSettings indexSettings, IndexAnalyzers indexAnalyzers,\n         super(indexSettings);\n         this.indexVersionCreated = indexSettings.getIndexVersionCreated();\n         this.indexAnalyzers = indexAnalyzers;\n-        this.indexAnalyzer = new MapperAnalyzerWrapper(indexAnalyzers.getDefaultIndexAnalyzer(), MappedFieldType::indexAnalyzer);\n+        this.indexAnalyzer = new MapperAnalyzerWrapper();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTE4NTYxNQ=="}, "originalCommit": {"oid": "32382ad10226da332423054c78351e3d10ad688a"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzIyNjQxOTg3OnYy", "diffSide": "RIGHT", "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODozNTo1MlrOHrFhsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQwODozNTo1MlrOHrFhsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDk0MTM2Mw==", "bodyText": "should we have an easier path for this common scenario where there is only one analyzer and it is registered with the same name as the field? the mapper in this case only needs to expose which analyzer it is? Having two paths is not optimal, but I think it would help highlighting which mappers are different in that they provide multiple analyzers.", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r514941363", "createdAt": "2020-10-30T08:35:52Z", "author": {"login": "javanna"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeaturesFieldMapper.java", "diffHunk": "@@ -161,4 +161,9 @@ protected String contentType() {\n         return CONTENT_TYPE;\n     }\n \n+    @Override\n+    public Map<String, NamedAnalyzer> indexAnalyzers() {\n+        return Collections.singletonMap(name(), Lucene.KEYWORD_ANALYZER);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25f3c0d4cc16fff576b1a6c71ad9437253f7e8f8"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MTgyODA3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDozMjo1OVrOHtSNiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMTozMDo1OFrOHtUNGg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjM0NA==", "bodyText": "this is introducing another usage of FetchContext#mapperService() that we'd like to remove :( could we find a way around it?", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517246344", "createdAt": "2020-11-04T10:32:59Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -72,6 +72,7 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         FetchSubPhase.HitContext hitContext = fieldContext.hitContext;\n         MappedFieldType fieldType = fieldContext.fieldType;\n         boolean forceSource = fieldContext.forceSource;\n+        boolean fixBrokenAnalysis = fieldContext.context.mapperService().containsBrokenAnalysis(fieldContext.fieldName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "479309734141b6006c49bc8268e72e042eba3e94"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI3OTAwMg==", "bodyText": "I added a delegator method, FetchContext#containsBrokenAnalysis()", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517279002", "createdAt": "2020-11-04T11:30:58Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -72,6 +72,7 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         FetchSubPhase.HitContext hitContext = fieldContext.hitContext;\n         MappedFieldType fieldType = fieldContext.fieldType;\n         boolean forceSource = fieldContext.forceSource;\n+        boolean fixBrokenAnalysis = fieldContext.context.mapperService().containsBrokenAnalysis(fieldContext.fieldName);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI0NjM0NA=="}, "originalCommit": {"oid": "479309734141b6006c49bc8268e72e042eba3e94"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI0MjEzNjUyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo0NFrOHtVKgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMjowMTo0NFrOHtVKgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzI5NDcyMg==", "bodyText": "this also calls mapperService() :) can you add the method to QueryShardContext and call it from there?", "url": "https://github.com/elastic/elasticsearch/pull/63937#discussion_r517294722", "createdAt": "2020-11-04T12:01:44Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/FetchContext.java", "diffHunk": "@@ -167,6 +167,14 @@ public SearchHighlightContext highlight() {\n         return searchContext.highlight();\n     }\n \n+    /**\n+     * Does the index analyzer for this field have token filters that may produce\n+     * backwards offsets in term vectors\n+     */\n+    public boolean containsBrokenAnalysis(String field) {\n+        return mapperService().containsBrokenAnalysis(field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5099a60e7d3bcf3068f05e388fdd474b88fc7056"}, "originalPosition": 9}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4335, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}