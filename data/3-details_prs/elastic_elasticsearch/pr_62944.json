{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk0MDU1NjM5", "number": 62944, "title": "Fix Race in ClusterApplierService Shutdown", "bodyText": "The iteration over timeoutClusterStateListeners starts when the CS applier\nthread is still running. This can lead to entries being added to it that never\nget their listener resolved on shutdown and thus leak that listener as observed\nin a stuck test in #62863 (in this particular test it's a failure to fail the shard on a stopping node that triggers waiting for the next cluster state for which the listener here can slip through the cracks).\nSince listener.onClose() is idempotent we can just call it if we run into a stopped service\non the CS thread to avoid the race with certainty (because the iteration in doStop starts after\nthe stopped state has been set).\nCloses #62863", "createdAt": "2020-09-28T10:49:57Z", "url": "https://github.com/elastic/elasticsearch/pull/62944", "merged": true, "mergeCommit": {"oid": "df50291afac3c591ef05d024323ed1ef308c73d3"}, "closed": true, "closedAt": "2020-10-05T07:38:46Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdNRSK4gH2gAyNDk0MDU1NjM5OmI0MWViMTliMDZhZTk1NTg0OTgxZTZiZWFjN2IyOGJmMTJlZWUxNzI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPeEozgH2gAyNDk0MDU1NjM5OmI0MjBjNWFjN2U4MDdjNjE2OTUzYzdjMmRkYmFlMDk1MjE2NTg0Y2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b41eb19b06ae95584981e6beac7b28bf12eee172", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b41eb19b06ae95584981e6beac7b28bf12eee172", "committedDate": "2020-09-28T10:46:29Z", "message": "Fix Race in ClusterApplierService Shutdown\n\nThe iteration over `timeoutClusterStateListeners` starts when the CS applier\nthread is still running. This can lead to entries being added to it that never\nget their listener resolved on shutdown and thus leak that listener as observed\nin a stuck test in #62863.\nSince `listener.onClose()` is idempotent we can just call it if we run into a stopped service\non the CS thread to avoid the race with certainty (because the iteration in `doStop` starts after\nthe stopped state has been set).\n\nCloses #62863"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxNzU1MDg1", "url": "https://github.com/elastic/elasticsearch/pull/62944#pullrequestreview-501755085", "createdAt": "2020-10-05T06:39:39Z", "commit": {"oid": "b41eb19b06ae95584981e6beac7b28bf12eee172"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozOTo0MFrOHcPOyw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQwNjozOTo0MFrOHcPOyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTM3MTcyMw==", "bodyText": "Could we not do this 3 lines earlier? No need to schedule a task in this case.", "url": "https://github.com/elastic/elasticsearch/pull/62944#discussion_r499371723", "createdAt": "2020-10-05T06:39:40Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java", "diffHunk": "@@ -274,6 +274,10 @@ public void run() {\n                     if (timeout != null) {\n                         notifyTimeout.cancellable = threadPool.schedule(notifyTimeout, timeout, ThreadPool.Names.GENERIC);\n                     }\n+                    if (lifecycle.stoppedOrClosed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b41eb19b06ae95584981e6beac7b28bf12eee172"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb64bb3466ccd0a6994d07d0aba7b23e946ab9e8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb64bb3466ccd0a6994d07d0aba7b23e946ab9e8", "committedDate": "2020-10-05T06:44:00Z", "message": "Merge remote-tracking branch 'elastic/master' into 62863-2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b420c5ac7e807c616953c7c2ddbae095216584cb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b420c5ac7e807c616953c7c2ddbae095216584cb", "committedDate": "2020-10-05T06:48:19Z", "message": "CR: check earlier"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4643, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}