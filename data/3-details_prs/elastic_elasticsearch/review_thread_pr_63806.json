{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0ODUwMDU5", "number": 63806, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjowMDowM1rOEul67Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNDowNVrOEvY-MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MjkxMjQ1OnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjowMDowM1rOHjGpSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjoyODo1NlrOHjHqaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU3MTA4Mg==", "bodyText": "I dislike having to do this here just because I changed the error message slightly. Happy do get some better ideas what we do in such cases in other places if possible.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506571082", "createdAt": "2020-10-16T16:00:03Z", "author": {"login": "cbuescher"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,18 +85,22 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason: waiting for backport", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4Nzc1NQ==", "bodyText": "For me the old message was just as clear, and lets us avoid having to update the test. But if we want to keep it, I wonder if we could just remove this test since it's already covered by SearchServiceTests#testMaxDocvalueFieldsSearch?", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506587755", "createdAt": "2020-10-16T16:28:56Z", "author": {"login": "jtibshirani"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,18 +85,22 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:\n+      version: \" - 7.99.99\"\n+      reason: waiting for backport", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU3MTA4Mg=="}, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3Mjk4ODc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjoyMTowOVrOHjHZBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTo0NzozNlrOHkGYAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4MzMwMQ==", "bodyText": "I think this signature change undoes some of @javanna's work in #63239. The easiest fix would be to keep the function parameter, and add a new one QueryShardContext::isFieldMapped.\nAs a side note, if we end up passing a lot of functions to avoid exposing MapperService, I wonder if we should pull out a lightweight abstraction similar to FieldTypeLookup and pass it around instead?", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506583301", "createdAt": "2020-10-16T16:21:09Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjYzMzExNA==", "bodyText": "thanks for catching this Julie. I am still addressing the original problem: we carry MapperService around too often when it's not needed. I do see the increasing need for functions which is definitely a signal that we dont have the right abstractions. I am using functions in some places but I see it more as a temporary work-around. I do think once we remove getMapperService from QueryShardContext we should reconsider the functions needed. A field type lookup abstraction may also be needed as I would like to split DocumentMapper into some sub-components that can be shared independently. To be seen very soon :)", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506633114", "createdAt": "2020-10-16T17:49:47Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4MzMwMQ=="}, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxNTIzNA==", "bodyText": "Instead of using MapperService, I pass in QueryShardContext now which has methods to resolve field name patterns, allows looking up the setting and look up whether a field is mapped. I can go back to passing in three parameters (functions and the setting itself) if you think this is not ideal for any reason.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r507615234", "createdAt": "2020-10-19T09:47:36Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4MzMwMQ=="}, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MzAwMjE2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNjoyNDo1MVrOHjHhOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToxNzozMlrOHkFM1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4NTQwMg==", "bodyText": "For efficiency could we only create a new FieldAndFormat if the field is mapped? I think we'll end up dropping the field anyways, not even having an entry in the response for it.\nAlso small typo, fedinde -> defined.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r506585402", "createdAt": "2020-10-16T16:24:51Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {\n+        int maxAllowedDocvalueFields = mapperService.getIndexSettings().getMaxDocvalueFields();\n+\n         List<FieldAndFormat> fields = new ArrayList<>();\n+        int mappedFieldCount = 0;\n         for (FieldAndFormat field : fieldPatterns) {\n-            Collection<String> fieldNames = simpleMatchToFullName.apply(field.field);\n+            Collection<String> fieldNames = mapperService.simpleMatchToFullName(field.field);\n             for (String fieldName: fieldNames) {\n                 fields.add(new FieldAndFormat(fieldName, field.format));\n+                // only count the mapped fields towards the limit fedinde by IndexSettings.MAX_DOCVALUE_FIELDS_SEARCH_SETTING\n+                if (mapperService.fieldType(fieldName) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5NTk4OA==", "bodyText": "You are right, I only see the \"fields\" really being used in \"FetchDocValuePhase#getProcessor\" and we seem to disregard fields without a mapping there. I will update the comments on the class though to reflect this for future usage.", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r507595988", "createdAt": "2020-10-19T09:17:32Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/FetchDocValuesContext.java", "diffHunk": "@@ -33,20 +32,25 @@\n \n     private final List<FieldAndFormat> fields;\n \n-    public static FetchDocValuesContext create(Function<String, Set<String>> simpleMatchToFullName,\n-                                               int maxAllowedDocvalueFields,\n-                                               List<FieldAndFormat> fieldPatterns) {\n+    public static FetchDocValuesContext create(MapperService mapperService, List<FieldAndFormat> fieldPatterns) {\n+        int maxAllowedDocvalueFields = mapperService.getIndexSettings().getMaxDocvalueFields();\n+\n         List<FieldAndFormat> fields = new ArrayList<>();\n+        int mappedFieldCount = 0;\n         for (FieldAndFormat field : fieldPatterns) {\n-            Collection<String> fieldNames = simpleMatchToFullName.apply(field.field);\n+            Collection<String> fieldNames = mapperService.simpleMatchToFullName(field.field);\n             for (String fieldName: fieldNames) {\n                 fields.add(new FieldAndFormat(fieldName, field.format));\n+                // only count the mapped fields towards the limit fedinde by IndexSettings.MAX_DOCVALUE_FIELDS_SEARCH_SETTING\n+                if (mapperService.fieldType(fieldName) != null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjU4NTQwMg=="}, "originalCommit": {"oid": "cb0d60983d8901ba19d2e341b4b0515055c4cd02"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE4MTI3NjY1OnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNjowNDowNVrOHkWGbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQxNzoyMTozMlrOHkZI9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3Mjg3OQ==", "bodyText": "Do we want to remove this skip now?", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r507872879", "createdAt": "2020-10-19T16:04:05Z", "author": {"login": "jtibshirani"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,6 +85,10 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c331adf181c951e2fdfa1c35272346a74512cc60"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzkyMjY3OQ==", "bodyText": "sure, missed that", "url": "https://github.com/elastic/elasticsearch/pull/63806#discussion_r507922679", "createdAt": "2020-10-19T17:21:32Z", "author": {"login": "cbuescher"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/30_limits.yml", "diffHunk": "@@ -85,6 +85,10 @@ setup:\n ---\n \"Docvalues_fields size limit\":\n \n+  - skip:", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzg3Mjg3OQ=="}, "originalCommit": {"oid": "c331adf181c951e2fdfa1c35272346a74512cc60"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2816, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}