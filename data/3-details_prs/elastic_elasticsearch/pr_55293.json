{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0MjM1NTcz", "number": 55293, "title": "Make RepositoryData Less Memory Heavy", "bodyText": "We don't really need LinkedHashSet here. We can assume that all the\nentries are unique and just use a list and use the list utilities to\ncreate the cheapest possible version of the list.\nAlso, this fixes a bug in addSnapshot which would mutate the existing\nlinked hash set on the current instance (fortunately this never caused a real world bug)\nand brings the collection in line with the java docs on its getter that claim immutability.", "createdAt": "2020-04-16T09:35:50Z", "url": "https://github.com/elastic/elasticsearch/pull/55293", "merged": true, "mergeCommit": {"oid": "8fd81df01ebf268f2560e497489595c818c28876"}, "closed": true, "closedAt": "2020-04-20T15:23:25Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcYJQiAAH2gAyNDA0MjM1NTczOjEzY2I0OWE4MTE0OGNhNmQ5YzczYzVmY2VjYjU5MjI1M2NlOGQ1YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcZgmHZgFqTM5NjU0ODk1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "13cb49a81148ca6d9c73c5fcecb592253ce8d5c6", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/13cb49a81148ca6d9c73c5fcecb592253ce8d5c6", "committedDate": "2020-04-16T09:27:28Z", "message": "Make RepositoryData Less Memory Heavy\n\nWe don't really need `LinkedHashSet` here. We can assume that all the\nentries are unique and just use a list and use the list utilities to\ncreate the cheapest possible version of the list.\nAlso, this fixes a bug in `addSnapshot` which would mutate the existing\nlinked hash set on the current instance (fortunately this never caused a real world bug)\nand brings the collection in line with the java docs on its getter that claim immutability."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDcwNDQz", "url": "https://github.com/elastic/elasticsearch/pull/55293#pullrequestreview-394470443", "createdAt": "2020-04-16T09:46:29Z", "commit": {"oid": "13cb49a81148ca6d9c73c5fcecb592253ce8d5c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTo0NjoyOVrOGGdWSA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTo0NjoyOVrOGGdWSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQyNTQ4MA==", "bodyText": "This was broken, we were mutating the existing LinkedHashSet", "url": "https://github.com/elastic/elasticsearch/pull/55293#discussion_r409425480", "createdAt": "2020-04-16T09:46:29Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -213,9 +214,16 @@ public RepositoryData addSnapshot(final SnapshotId snapshotId,\n         newSnapshotStates.put(snapshotId.getUUID(), snapshotState);\n         Map<String, Version> newSnapshotVersions = new HashMap<>(snapshotVersions);\n         newSnapshotVersions.put(snapshotId.getUUID(), version);\n-        Map<IndexId, Set<SnapshotId>> allIndexSnapshots = new HashMap<>(indexSnapshots);\n+        Map<IndexId, List<SnapshotId>> allIndexSnapshots = new HashMap<>(indexSnapshots);\n         for (final IndexId indexId : shardGenerations.indices()) {\n-            allIndexSnapshots.computeIfAbsent(indexId, k -> new LinkedHashSet<>()).add(snapshotId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cb49a81148ca6d9c73c5fcecb592253ce8d5c6"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0NDczOTY1", "url": "https://github.com/elastic/elasticsearch/pull/55293#pullrequestreview-394473965", "createdAt": "2020-04-16T09:51:09Z", "commit": {"oid": "13cb49a81148ca6d9c73c5fcecb592253ce8d5c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTo1MTowOVrOGGdhUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQwOTo1MTowOVrOGGdhUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTQyODMwNw==", "bodyText": "Not great that we're quadratic here now (for the nested loop), but I don't think it really matters much relative to the significant space+GC savings.", "url": "https://github.com/elastic/elasticsearch/pull/55293#discussion_r409428307", "createdAt": "2020-04-16T09:51:09Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -253,23 +261,24 @@ public RepositoryData removeSnapshot(final SnapshotId snapshotId, final ShardGen\n         newSnapshotStates.remove(snapshotId.getUUID());\n         final Map<String, Version> newSnapshotVersions = new HashMap<>(snapshotVersions);\n         newSnapshotVersions.remove(snapshotId.getUUID());\n-        Map<IndexId, Set<SnapshotId>> indexSnapshots = new HashMap<>();\n+        Map<IndexId, List<SnapshotId>> indexSnapshots = new HashMap<>();\n         for (final IndexId indexId : indices.values()) {\n-            Set<SnapshotId> set;\n-            Set<SnapshotId> snapshotIds = this.indexSnapshots.get(indexId);\n+            List<SnapshotId> remaining;\n+            List<SnapshotId> snapshotIds = this.indexSnapshots.get(indexId);\n             assert snapshotIds != null;\n             if (snapshotIds.contains(snapshotId)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "13cb49a81148ca6d9c73c5fcecb592253ce8d5c6"}, "originalPosition": 66}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b267d9c4ad95e220544c773d01750e886283d471", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b267d9c4ad95e220544c773d01750e886283d471", "committedDate": "2020-04-16T10:12:16Z", "message": "at least be a little efficient"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2MjA2Nzc3", "url": "https://github.com/elastic/elasticsearch/pull/55293#pullrequestreview-396206777", "createdAt": "2020-04-20T07:35:33Z", "commit": {"oid": "b267d9c4ad95e220544c773d01750e886283d471"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozNTozM1rOGIHHsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQwNzozODowNlrOGIHNSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1ODQ0OA==", "bodyText": "why create a copy of the copy?", "url": "https://github.com/elastic/elasticsearch/pull/55293#discussion_r411158448", "createdAt": "2020-04-20T07:35:33Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -213,9 +214,16 @@ public RepositoryData addSnapshot(final SnapshotId snapshotId,\n         newSnapshotStates.put(snapshotId.getUUID(), snapshotState);\n         Map<String, Version> newSnapshotVersions = new HashMap<>(snapshotVersions);\n         newSnapshotVersions.put(snapshotId.getUUID(), version);\n-        Map<IndexId, Set<SnapshotId>> allIndexSnapshots = new HashMap<>(indexSnapshots);\n+        Map<IndexId, List<SnapshotId>> allIndexSnapshots = new HashMap<>(indexSnapshots);\n         for (final IndexId indexId : shardGenerations.indices()) {\n-            allIndexSnapshots.computeIfAbsent(indexId, k -> new LinkedHashSet<>()).add(snapshotId);\n+            final List<SnapshotId> snapshotIds = allIndexSnapshots.get(indexId);\n+            if (snapshotIds == null) {\n+                allIndexSnapshots.put(indexId, List.of(snapshotId));\n+            } else {\n+                final List<SnapshotId> copy = new ArrayList<>(snapshotIds);\n+                copy.add(snapshotId);\n+                allIndexSnapshots.put(indexId, List.copyOf(copy));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b267d9c4ad95e220544c773d01750e886283d471"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTQ1MQ==", "bodyText": "same thing here, copy of copy", "url": "https://github.com/elastic/elasticsearch/pull/55293#discussion_r411159451", "createdAt": "2020-04-20T07:37:23Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -253,23 +261,25 @@ public RepositoryData removeSnapshot(final SnapshotId snapshotId, final ShardGen\n         newSnapshotStates.remove(snapshotId.getUUID());\n         final Map<String, Version> newSnapshotVersions = new HashMap<>(snapshotVersions);\n         newSnapshotVersions.remove(snapshotId.getUUID());\n-        Map<IndexId, Set<SnapshotId>> indexSnapshots = new HashMap<>();\n+        Map<IndexId, List<SnapshotId>> indexSnapshots = new HashMap<>();\n         for (final IndexId indexId : indices.values()) {\n-            Set<SnapshotId> set;\n-            Set<SnapshotId> snapshotIds = this.indexSnapshots.get(indexId);\n+            List<SnapshotId> remaining;\n+            List<SnapshotId> snapshotIds = this.indexSnapshots.get(indexId);\n             assert snapshotIds != null;\n-            if (snapshotIds.contains(snapshotId)) {\n+            final int listIndex = snapshotIds.indexOf(snapshotId);\n+            if (listIndex > -1) {\n                 if (snapshotIds.size() == 1) {\n                     // removing the snapshot will mean no more snapshots\n                     // have this index, so just skip over it\n                     continue;\n                 }\n-                set = new LinkedHashSet<>(snapshotIds);\n-                set.remove(snapshotId);\n+                remaining = new ArrayList<>(snapshotIds);\n+                remaining.remove(listIndex);\n+                remaining = List.copyOf(remaining);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b267d9c4ad95e220544c773d01750e886283d471"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTE1OTg4Mw==", "bodyText": "copy of copy", "url": "https://github.com/elastic/elasticsearch/pull/55293#discussion_r411159883", "createdAt": "2020-04-20T07:38:06Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoryData.java", "diffHunk": "@@ -513,7 +523,7 @@ public static RepositoryData snapshotsFromXContent(final XContentParser parser,\n                             }\n                         }\n                         assert indexId != null;\n-                        indexSnapshots.put(indexId, snapshotIds);\n+                        indexSnapshots.put(indexId, List.copyOf(snapshotIds));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b267d9c4ad95e220544c773d01750e886283d471"}, "originalPosition": 131}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d99b2850790e86de5477bfcd1b50f0c7774e4300", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d99b2850790e86de5477bfcd1b50f0c7774e4300", "committedDate": "2020-04-20T13:44:55Z", "message": "Merge remote-tracking branch 'elastic/master' into smaller-repository-data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8319e2116d138668e38c3a72b709a8889868088a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8319e2116d138668e38c3a72b709a8889868088a", "committedDate": "2020-04-20T14:09:21Z", "message": "unmodifiable list it is :)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2NTQ4OTU3", "url": "https://github.com/elastic/elasticsearch/pull/55293#pullrequestreview-396548957", "createdAt": "2020-04-20T15:12:47Z", "commit": {"oid": "8319e2116d138668e38c3a72b709a8889868088a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3424, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}