{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0NTM0NTc3", "number": 51195, "title": "Make order setting mandatory for Realm config", "bodyText": "The order parameter must be explicitly specified for each realm.\nThis is a breaking change and will start take effect in 8.0\nResolves: #37614", "createdAt": "2020-01-19T13:29:57Z", "url": "https://github.com/elastic/elasticsearch/pull/51195", "merged": true, "mergeCommit": {"oid": "83a819ab63ea362e1cc55cfed3786ebd2918820e"}, "closed": true, "closedAt": "2020-01-28T06:59:54Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 37, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7OZLbAH2gAyMzY0NTM0NTc3OjY1Y2YyNGNkZTNhZDkwNzk0NDg3OTgzYTZiNGJjNzQ4NTdmZTYzMWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-qzdLgH2gAyMzY0NTM0NTc3OmFkN2ExYjU0NDIzNjdkZmMxZjAwZjg1ZDYyMGQ1NzAyOGY2NGVkZjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "65cf24cde3ad90794487983a6b4bc74857fe631c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/65cf24cde3ad90794487983a6b4bc74857fe631c", "committedDate": "2020-01-17T13:02:38Z", "message": "WIP: making realm order config mandatory"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d186b0a40c8a3c2d60f1a63b76aa3626d61f64c3", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d186b0a40c8a3c2d60f1a63b76aa3626d61f64c3", "committedDate": "2020-01-19T11:54:18Z", "message": "Support explicit order parameter for RealmConfig\n\nReserved realm and default native realms now use the new constructor to\nspecifiy order explicitly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82e08d27356bc1c37e3f9040fbfdb94c5d174e7a", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/82e08d27356bc1c37e3f9040fbfdb94c5d174e7a", "committedDate": "2020-01-19T13:24:45Z", "message": "Fix security plugin tests for required order param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "71bfb3e4a851386fddda7803900fa3c8e6da970c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/71bfb3e4a851386fddda7803900fa3c8e6da970c", "committedDate": "2020-01-19T13:47:35Z", "message": "Fix more tests for required order param"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53701636b31b521b736007d1367645ad5643683b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/53701636b31b521b736007d1367645ad5643683b", "committedDate": "2020-01-19T21:56:09Z", "message": "Fix ci/2 failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1132f5f2f691917295db7d21b28e872ea334ff7b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/1132f5f2f691917295db7d21b28e872ea334ff7b", "committedDate": "2020-01-19T22:16:42Z", "message": "Merge branch 'master' into issue-37614-realm-order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fa20a3d6d42d21b252b0279bf576d55db76b4b2", "committedDate": "2020-01-19T22:59:57Z", "message": "Fix more require order parameter failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MTA0MTU2", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-345104156", "createdAt": "2020-01-20T06:48:23Z", "commit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo0ODoyM1rOFfUu1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQwNjo1NToyOFrOFfU1Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTg0Ng==", "bodyText": "I would prefer the order be a primitive, and we resolve the order from the settings in the original constructor.\nBehaviours around if this parameter is null, do this other thing can end up getting quite confusing in a large code base.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368389846", "createdAt": "2020-01-20T06:48:23Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        } else {\n+            this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM4OTkxNg==", "bodyText": "I think it would be better for this constructor to be  protected, and update the tests to pass through real Settings object with an order config.\nI know that's going to be a pain - so please feel free to convince me if you feel otherwise.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368389916", "createdAt": "2020-01-20T06:48:41Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODM5MTQ0Ng==", "bodyText": "Do we have a test for this validation (e.g. RealmSettingsTests) ?\nI can't see one, but given the number of tests changes, I may have missed it.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r368391446", "createdAt": "2020-01-20T06:55:28Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -24,11 +24,24 @@\n     private final ThreadContext threadContext;\n \n     public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext) {\n+        this(identifier, settings, env, threadContext, null);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, Integer order) {\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n-        this.order = getSetting(RealmSettings.ORDER_SETTING);\n+        if (order != null) {\n+            this.order = order;\n+        } else if (order == null && hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fa20a3d6d42d21b252b0279bf576d55db76b4b2"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d724e84eb91c87f7ed3a9387fb0232b088be289", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d724e84eb91c87f7ed3a9387fb0232b088be289", "committedDate": "2020-01-20T11:41:07Z", "message": "Enforce no same order for realms.\n\nAdd tests for mandatory order setting of RealmConfig.\nFix broken tests due to unique order setting requirement."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "adca1bf64a18fbabb4f3f5f90b82d88d3bb8b5b0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/adca1bf64a18fbabb4f3f5f90b82d88d3bb8b5b0", "committedDate": "2020-01-20T12:41:48Z", "message": "Fix duplicate order for tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f60b225757fa08ed3c2082d38dd23b1123ca0cb", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f60b225757fa08ed3c2082d38dd23b1123ca0cb", "committedDate": "2020-01-20T12:42:02Z", "message": "Add realm order to breaking change doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3cb7a83301c9574de80a204c0ef24a0de64f3e27", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/3cb7a83301c9574de80a204c0ef24a0de64f3e27", "committedDate": "2020-01-20T12:54:41Z", "message": "Start updating docs for realm order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "22399cee002903d51c2d9a7b2edf66e801cc4b0c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/22399cee002903d51c2d9a7b2edf66e801cc4b0c", "committedDate": "2020-01-21T05:26:01Z", "message": "Add missing order config in docs\n\nAlso update descriptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0edef24288aa20268d3425aa5a165265a115e54b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/0edef24288aa20268d3425aa5a165265a115e54b", "committedDate": "2020-01-21T05:55:04Z", "message": "Merge branch 'master' into issue-37614-realm-order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MjUwOTE4", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-346250918", "createdAt": "2020-01-21T22:59:43Z", "commit": {"oid": "0edef24288aa20268d3425aa5a165265a115e54b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1OTo0M1rOFgLp0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMjo1OTo0M1rOFgLp0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI4OTY4MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            specified for each explicitly configured realms. Their values must be unique.\n          \n          \n            \n            specified for each explicitly configured realm. Each value must be unique.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369289681", "createdAt": "2020-01-21T22:59:43Z", "author": {"login": "lcawl"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n+specified for each explicitly configured realms. Their values must be unique.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0edef24288aa20268d3425aa5a165265a115e54b"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b439a49c8a68cf6dad8823261db77c44b7361326", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b439a49c8a68cf6dad8823261db77c44b7361326", "committedDate": "2020-01-21T23:03:06Z", "message": "Update docs/reference/migration/migrate_8_0/security.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MjU4NTE0", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-346258514", "createdAt": "2020-01-21T23:18:35Z", "commit": {"oid": "b439a49c8a68cf6dad8823261db77c44b7361326"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzoxODozNlrOFgMCJg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMVQyMzoxODozNlrOFgMCJg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTI5NTkxMA==", "bodyText": "There's another line in this file that I think should be changed:\n\nIf you are configuring multiple realms, you should also explicitly set the order attribute ....\n\nI think it should be changed to \"you must also explicitly set the order attribute\".", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369295910", "createdAt": "2020-01-21T23:18:36Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -206,6 +206,7 @@ xpack:\n       realms:\n         ldap:\n           ldap1:\n+            order: 0", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b439a49c8a68cf6dad8823261db77c44b7361326"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9548e2fb2cc3ac692f92fb490c798b363b96f05c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9548e2fb2cc3ac692f92fb490c798b363b96f05c", "committedDate": "2020-01-21T23:33:22Z", "message": "Merge branch 'master' into issue-37614-realm-order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/a74482efa5defac9be29c193e7bc60a0426a9f31", "committedDate": "2020-01-21T23:34:45Z", "message": "Update for docs feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2MzAyMjIw", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-346302220", "createdAt": "2020-01-22T01:39:32Z", "commit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTozOTozM1rOFgOTvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwMTozOTozM1rOFgOTvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTMzMzE4MQ==", "bodyText": "This page also has the following:\n\nIf you are configuring multiple realms, you should explicitly set the order attribute.\n\n... which I think should be changed to \"you must explicitly set the order attribute...\"", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r369333181", "createdAt": "2020-01-22T01:39:33Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/security/authentication/configuring-pki-realm.asciidoc", "diffHunk": "@@ -61,6 +61,7 @@ xpack:\n       realms:\n         pki:\n           pki1:\n+            order: 1", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a74482efa5defac9be29c193e7bc60a0426a9f31"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0aa65bfb200d97013ada5a308a7f120e3f34a3f", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0aa65bfb200d97013ada5a308a7f120e3f34a3f", "committedDate": "2020-01-22T02:56:59Z", "message": "Update doc to address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/994c0af8d053c683eaca306770beaf3207c16dc5", "committedDate": "2020-01-22T03:09:05Z", "message": "More wording changes based on feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjY5Mzc3", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-347269377", "createdAt": "2020-01-23T12:47:33Z", "commit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0NzozM1rOFg88AQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxNjo0OTowMVrOFhFUwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NzE1Mw==", "bodyText": "typo: \"relams\" -> \"realms\" (ditto underneath)", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370097153", "createdAt": "2020-01-23T12:47:33Z", "author": {"login": "albertzaharovits"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n+specified for each explicitly configured realm. Each value must be unique.\n+The cluster will fail to start if the requirements are not met.\n+\n+For example, the following configuration is invalid:\n+[source,yaml]\n+--------------------------------------------------\n+xpack.security.authc.relams.kerberos.kerb1:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDE4MzQ5MA==", "bodyText": "Technically, you must set the order even if not configuring multiple realms. I would remove this phrase altogether. (same in other places too)", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370183490", "createdAt": "2020-01-23T15:23:46Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-active-directory-realm.asciidoc", "diffHunk": "@@ -4,7 +4,7 @@ realm and map Active Directory users and groups to roles in the role mapping fil\n . Add a realm configuration of type `active_directory` to `elasticsearch.yml`\n under the `xpack.security.authc.realms.active_directory` namespace.\n At a minimum, you must specify the Active Directory `domain_name`.\n-If you are configuring multiple realms, you should also \n+If you are configuring multiple realms, you must also \n explicitly set the `order` attribute to control the order in which the realms \n are consulted during authentication. \n +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyNDkxNA==", "bodyText": "I would've probably made a different choice of where to place this check because we pass RealmConfigs around in too many places. For example, this:\n\nwill throw an exception in InternalRealms.getBootstrapChecks so the stacktrace for it is funky.\nwill throw an exception in the SamlMetadataCommand which is not nice, although it might not happen in practice too often.\n\nI would've probably removed the order and enabled local vars and do the checks in Realms#initRealms. But there might be subtle problems in that case as well.\nNevertheless, this does the job, and looks OK, to me.\nNit: we use the reverse form for negative condition, i.e. false == <function> (unless we are in some few older files that use a different convention in which case we blend with the background).", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370224914", "createdAt": "2020-01-23T16:32:08Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIyODkyOA==", "bodyText": "Not to dwell on it too much, but just because we need this new constructor is a smell. In this case, the order local var is sometimes the value from the settings, and sometimes a different one passed by this constructor. I know this is only used in tests, but it's still not nice to have to deal with it (Integer.MAX_VALUE).", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370228928", "createdAt": "2020-01-23T16:38:52Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/RealmConfig.java", "diffHunk": "@@ -27,9 +27,24 @@ public RealmConfig(RealmIdentifier identifier, Settings settings, Environment en\n         this.identifier = identifier;\n         this.settings = settings;\n         this.env = env;\n+        this.threadContext = threadContext;\n         this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        if (hasSetting(RealmSettings.ORDER_SETTING.apply(type())) == false) {\n+            throw new IllegalArgumentException(\"'order' is a mandatory parameter for realm config. \" +\n+                \"Found invalid realm config: '\" + identifier.name + \"'\\n\" +\n+                \"Please see the breaking changes documentation.\"\n+            );\n+        }\n         this.order = getSetting(RealmSettings.ORDER_SETTING);\n+    }\n+\n+    public RealmConfig(RealmIdentifier identifier, Settings settings, Environment env, ThreadContext threadContext, int order) {\n+        this.identifier = identifier;\n+        this.settings = settings;\n+        this.env = env;\n         this.threadContext = threadContext;\n+        this.enabled = getSetting(RealmSettings.ENABLED_SETTING);\n+        this.order = order;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzMTU0Mg==", "bodyText": "I think the error message that you're building downstream calls for realm names, and not for setting keys.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370231542", "createdAt": "2020-01-23T16:43:31Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -218,9 +219,13 @@ public Realm realm(String name) {\n             Realm realm = factory.create(config);\n             nameToRealmIdentifier.computeIfAbsent(realm.name(), k ->\n                 new HashSet<>()).add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());\n+            orderToRealmIdentifier.computeIfAbsent(realm.order(), k -> new HashSet<>())\n+                .add(RealmSettings.realmSettingPrefix(realm.type()) + realm.name());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDIzNDU2MQ==", "bodyText": "Why is this necessary? If it isn't, I would steer clear of such changes, it's not productive to start contingent discussions on other topics than the scope of this PR.\nIf you wish we discuss the topic of negative values for the order argument we should do so under a new issue.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r370234561", "createdAt": "2020-01-23T16:49:01Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecuritySettingsSource.java", "diffHunk": "@@ -141,8 +141,8 @@ public Settings nodeSettings(int nodeOrdinal) {\n                 .put(LoggingAuditTrail.EMIT_HOST_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_NAME_SETTING.getKey(), randomBoolean())\n                 .put(LoggingAuditTrail.EMIT_NODE_ID_SETTING.getKey(), randomBoolean())\n-                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", 0)\n-                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", \"1\")\n+                .put(\"xpack.security.authc.realms.\" + FileRealmSettings.TYPE + \".file.order\", Integer.MIN_VALUE)\n+                .put(\"xpack.security.authc.realms.\" + NativeRealmSettings.TYPE + \".index.order\", String.valueOf(Integer.MIN_VALUE + 1))\n                 .put(\"xpack.license.self_generated.type\", \"trial\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "994c0af8d053c683eaca306770beaf3207c16dc5"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da8e7e3bc0ab71c63ae7132cd4958c86e9d75167", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/da8e7e3bc0ab71c63ae7132cd4958c86e9d75167", "committedDate": "2020-01-24T00:26:24Z", "message": "Address feedback for docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fbf06159a029a925ef5303cc624d3e3b3b519c6", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fbf06159a029a925ef5303cc624d3e3b3b519c6", "committedDate": "2020-01-24T00:33:46Z", "message": "Address feedback to revert accident change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "472b2d61bd9bb665a89710ae2ad9a4ec53bed3cf", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/472b2d61bd9bb665a89710ae2ad9a4ec53bed3cf", "committedDate": "2020-01-24T03:42:24Z", "message": "Merge remote-tracking branch 'origin/master' into issue-37614-realm-order"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64d0292fc33d26a27199392dbaccb6afc1dfe89d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/64d0292fc33d26a27199392dbaccb6afc1dfe89d", "committedDate": "2020-01-24T08:24:21Z", "message": "Update based on discussion with Tim."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/aad6d19bea5e08c816a5c3ca8bc7478927ab33a7", "committedDate": "2020-01-24T08:43:02Z", "message": "Address feedback for consistent err msg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4ODI5NTY1", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-348829565", "createdAt": "2020-01-27T17:09:14Z", "commit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzowOToxNFrOFiKglA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QxNzoxMjozMlrOFiKnCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODA4NA==", "bodyText": "This last phrase doesn't make sense, I would avoid describing again what order does.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371368084", "createdAt": "2020-01-27T17:09:14Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -21,10 +21,9 @@ However, multiple bind operations might be needed to find the correct user DN.\n \n .. Add a realm configuration of to `elasticsearch.yml` under the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n-the `url` of the LDAP server, and set `user_search.base_dn` to the container DN\n-where the users are searched for.\n-If you are configuring multiple realms, you should also explicitly set the\n-`order` attribute to control the order in which the realms are consulted during \n+the `url` and `order` of the LDAP server, and set `user_search.base_dn` to the\n+container DN where the users are searched for.\n+The `order` attribute to control the order in which the realms are consulted during \n authentication. See <<ref-ldap-settings>> for all of the options you can set for ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2ODYwMw==", "bodyText": "I would remove\n\nIf you are configuring multiple realms, you must ...\n\naltogether.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371368603", "createdAt": "2020-01-27T17:10:21Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/configuring-ldap-realm.asciidoc", "diffHunk": "@@ -73,7 +72,7 @@ realms you specify are used for authentication. If you also want to use the\n .. Add a realm configuration to `elasticsearch.yml` in the\n `xpack.security.authc.realms.ldap` namespace. At a minimum, you must specify\n the `url` of the LDAP server, and specify at least one template with the\n-`user_dn_templates` option. If you are configuring multiple realms, you should\n+`user_dn_templates` option. If you are configuring multiple realms, you must\n also explicitly set the `order` attribute to control the order in which the\n realms are consulted during authentication.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2OTQ4OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            that two or more realms have the same `order`, the cluster will fail to start.\n          \n          \n            \n            that two or more realms have the same `order`, the node will fail to start.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371369488", "createdAt": "2020-01-27T17:12:03Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/custom-realm.asciidoc", "diffHunk": "@@ -89,11 +89,10 @@ under the `xpack.security.authc.realms` namespace.\n You must define your realm within the namespace that matchesto the type defined\n by the extension.\n The options you can set depend on the settings exposed by the custom realm.\n-If you are configuring multiple realms, you should also explicitly set the\n-`order` attribute to control the order in which the realms are consulted during\n-authentication. You should make sure each configured realm has a distinct\n-`order` setting. In the event that two or more realms have the same `order`,\n-they will be processed in realm `name` order.\n+At a minimum, you must explicitly set the `order` attribute to control the\n+order in which the realms are consulted during authentication. You must also\n+make sure each configured realm has a distinct `order` setting. In the event\n+that two or more realms have the same `order`, the cluster will fail to start.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTM2OTczNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            the cluster will fail to start.\n          \n          \n            \n            the node will fail to start.", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371369737", "createdAt": "2020-01-27T17:12:32Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/docs/en/security/authentication/realm-chains.asciidoc", "diffHunk": "@@ -5,9 +5,9 @@\n <<realms,Realms>> live within a _realm chain_. It is essentially a prioritized\n list of configured realms (typically of various types). Realms are consulted in\n ascending order (that is to say, the realm with the lowest `order` value is\n-consulted first). You should make sure each configured realm has a distinct\n+consulted first). You must make sure each configured realm has a distinct\n `order` setting. In the event that two or more realms have the same `order`,\n-they are processed in `name` order.\n+the cluster will fail to start.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aad6d19bea5e08c816a5c3ca8bc7478927ab33a7"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84cb684a91b5ae51c1fa01712e1c528811f620df", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/84cb684a91b5ae51c1fa01712e1c528811f620df", "committedDate": "2020-01-27T22:39:19Z", "message": "Update x-pack/docs/en/security/authentication/custom-realm.asciidoc\n\nCo-Authored-By: Albert Zaharovits <albert.zaharovits@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c61828c0a49a28372b95b249afe217505549f64", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c61828c0a49a28372b95b249afe217505549f64", "committedDate": "2020-01-27T22:39:42Z", "message": "Update x-pack/docs/en/security/authentication/realm-chains.asciidoc\n\nCo-Authored-By: Albert Zaharovits <albert.zaharovits@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c264e31ca5ffbf048e478cfb0ba1edc03a9c54f0", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c264e31ca5ffbf048e478cfb0ba1edc03a9c54f0", "committedDate": "2020-01-27T22:41:30Z", "message": "Address feedback for docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/43fffa3b1f5fdb979dc1b6676732340ed3f0ca17", "committedDate": "2020-01-27T22:42:23Z", "message": "Merge remote-tracking branch 'origin/master' into issue-37614-realm-order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MTM5Mjcx", "url": "https://github.com/elastic/elasticsearch/pull/51195#pullrequestreview-349139271", "createdAt": "2020-01-28T05:38:27Z", "commit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTozODoyN1rOFiZuyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQwNTo0Mjo1MFrOFiZxxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxNzQ4MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            The `xpack.security.authc.realms.*.*.order` setting is now required and must be\n          \n          \n            \n            The `xpack.security.authc.realms.{type}.{name}.order` setting is now required and must be", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371617480", "createdAt": "2020-01-28T05:38:27Z", "author": {"login": "tvernum"}, "path": "docs/reference/migration/migrate_8_0/security.asciidoc", "diffHunk": "@@ -6,6 +6,29 @@\n //Installation and Upgrade Guide\n \n //tag::notable-breaking-changes[]\n+[float]\n+==== The realm `order` setting is required\n+\n+The `xpack.security.authc.realms.*.*.order` setting is now required and must be", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTYxODI0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders + \"\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders);", "url": "https://github.com/elastic/elasticsearch/pull/51195#discussion_r371618247", "createdAt": "2020-01-28T05:42:50Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -305,15 +310,34 @@ public void usageStats(ActionListener<Map<String, Object>> listener) {\n     private void addNativeRealms(List<Realm> realms) throws Exception {\n         Realm.Factory fileRealm = factories.get(FileRealmSettings.TYPE);\n         if (fileRealm != null) {\n+            var realmIdentifier = new RealmConfig.RealmIdentifier(FileRealmSettings.TYPE, \"default_\" + FileRealmSettings.TYPE);\n             realms.add(fileRealm.create(new RealmConfig(\n-                    new RealmConfig.RealmIdentifier(FileRealmSettings.TYPE, \"default_\" + FileRealmSettings.TYPE),\n-                    settings, env, threadContext)));\n+                realmIdentifier,\n+                ensureOrderSetting(settings, realmIdentifier, Integer.MIN_VALUE + 1),\n+                env, threadContext)));\n         }\n         Realm.Factory indexRealmFactory = factories.get(NativeRealmSettings.TYPE);\n         if (indexRealmFactory != null) {\n+            var realmIdentifier = new RealmConfig.RealmIdentifier(NativeRealmSettings.TYPE, \"default_\" + NativeRealmSettings.TYPE);\n             realms.add(indexRealmFactory.create(new RealmConfig(\n-                    new RealmConfig.RealmIdentifier(NativeRealmSettings.TYPE, \"default_\" + NativeRealmSettings.TYPE),\n-                    settings, env, threadContext)));\n+                realmIdentifier,\n+                ensureOrderSetting(settings, realmIdentifier, Integer.MIN_VALUE + 2),\n+                env, threadContext)));\n+        }\n+    }\n+\n+    private Settings ensureOrderSetting(Settings settings, RealmConfig.RealmIdentifier realmIdentifier, int order) {\n+        String orderSettingKey = RealmSettings.realmSettingPrefix(realmIdentifier) + \"order\";\n+        return Settings.builder().put(settings).put(orderSettingKey, order).build();\n+    }\n+\n+    private void checkUniqueOrders(Map<Integer, Set<String>> orderToRealmName) {\n+        String duplicateOrders = orderToRealmName.entrySet().stream()\n+            .filter(entry -> entry.getValue().size() > 1)\n+            .map(entry -> entry.getKey() + \": \" + entry.getValue())\n+            .collect(Collectors.joining(\"; \"));\n+        if (Strings.hasText(duplicateOrders)) {\n+            throw new IllegalArgumentException(\"Found multiple realms configured with the same order: \" + duplicateOrders + \"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43fffa3b1f5fdb979dc1b6676732340ed3f0ca17"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0614cbc0ef2c82f7b52904d2bf96e82a9f93463b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0614cbc0ef2c82f7b52904d2bf96e82a9f93463b", "committedDate": "2020-01-28T05:47:22Z", "message": "Update docs/reference/migration/migrate_8_0/security.asciidoc\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe13c71c8630380817ddfb2635db20c2127455ea", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe13c71c8630380817ddfb2635db20c2127455ea", "committedDate": "2020-01-28T05:47:43Z", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad7a1b5442367dfc1f00f85d620d57028f64edf4", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad7a1b5442367dfc1f00f85d620d57028f64edf4", "committedDate": "2020-01-28T05:50:27Z", "message": "Merge remote-tracking branch 'origin/master' into issue-37614-realm-order"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3020, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}