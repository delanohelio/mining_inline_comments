{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MTkyMjk2", "number": 53471, "title": "[ML] Add ModelLoadingService method for always caching models", "bodyText": "ModelLoadingService will only cache a model if it is reference by an inference processor in an ingest pipeline which is not what we want for the search use cases.\n\nRename getModel() -> getModelForPipeline() which preserves the existing behaviour\nAdd new method getModelAndCache() which always adds to model to the cache\n\nModelLoadingService now has 2 methods for getting a model which complicates the interface but both use the same cache at least.\nWhat this change does highlight is that TransportInternalInferModelAction has unexpected behaviour if used outside of an inference processor in that the model is not cached as could be assumed.\nFeature branch PR", "createdAt": "2020-03-12T11:35:55Z", "url": "https://github.com/elastic/elasticsearch/pull/53471", "merged": true, "mergeCommit": {"oid": "6910b78ad2d9bb5ad4056b0ea0904dfa24c50080"}, "closed": true, "closedAt": "2020-03-17T14:09:45Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM6dsXAFqTM3MzQ5MjgyOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcOjOd1AFqTM3NjA2MzQzMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzczNDkyODI5", "url": "https://github.com/elastic/elasticsearch/pull/53471#pullrequestreview-373492829", "createdAt": "2020-03-12T11:58:34Z", "commit": {"oid": "89239cb1b5c12d506b6943516789e630d5864612"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMTo1ODozNFrOF1brEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMlQxMTo1ODozNFrOF1brEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTU3MjI0Mg==", "bodyText": "This won't work in the long run.\nWhat if the model is removed from a pipeline while loading?\n\nModel A is referenced by a pipeline on this node\nThat model happens to fall out of cache\nData node says calls loadModelAndCache for model A\nPipeline is then deleted in the middle of loading it up\nData node gets Cancelling load of model [A] as it is no longer referenced by a pipeline failure\n\nThis type of complexity is one of the many reasons I think we need to move away from a cache based system and towards a deployment based system.", "url": "https://github.com/elastic/elasticsearch/pull/53471#discussion_r391572242", "createdAt": "2020-03-12T11:58:34Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingService.java", "diffHunk": "@@ -182,6 +205,24 @@ private boolean loadModelIfNecessary(String modelId, ActionListener<Model> model\n         } // synchronized (loadingListeners)\n     }\n \n+    private void loadModelAndCache(String modelId, ActionListener<Model> modelActionListener) {\n+        synchronized (loadingListeners) {\n+            Model cachedModel = localModelCache.get(modelId);\n+            if (cachedModel != null) {\n+                modelActionListener.onResponse(cachedModel);\n+                return;\n+            }\n+\n+            if (loadingListeners.computeIfPresent(\n+                    modelId,\n+                    (storedModelKey, listenerQueue) -> addFluently(listenerQueue, modelActionListener)) == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "89239cb1b5c12d506b6943516789e630d5864612"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bce86a5da06277de7c35b1eb59c637bd14347fd", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/8bce86a5da06277de7c35b1eb59c637bd14347fd", "committedDate": "2020-03-13T09:39:55Z", "message": "Rename getModel to getModelForPipeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfedab8caba1f3bc3131ffa380c6588d2d199c4", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bfedab8caba1f3bc3131ffa380c6588d2d199c4", "committedDate": "2020-03-13T09:39:55Z", "message": "Add get model without checking pipeline"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83ff9e9054a9efce729fc10ded007e7f45e5c0f5", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/83ff9e9054a9efce729fc10ded007e7f45e5c0f5", "committedDate": "2020-03-13T09:39:55Z", "message": "Call caching version of get model\n\nAnd check for error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cfb60558b060af1704acc1438b2aed75b82dd59", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/0cfb60558b060af1704acc1438b2aed75b82dd59", "committedDate": "2020-03-13T09:39:55Z", "message": "Tidy up comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89239cb1b5c12d506b6943516789e630d5864612", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/89239cb1b5c12d506b6943516789e630d5864612", "committedDate": "2020-03-12T11:40:58Z", "message": "Tidy up comments"}, "afterCommit": {"oid": "0cfb60558b060af1704acc1438b2aed75b82dd59", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/0cfb60558b060af1704acc1438b2aed75b82dd59", "committedDate": "2020-03-13T09:39:55Z", "message": "Tidy up comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc2MDYzNDMz", "url": "https://github.com/elastic/elasticsearch/pull/53471#pullrequestreview-376063433", "createdAt": "2020-03-17T14:03:30Z", "commit": {"oid": "0cfb60558b060af1704acc1438b2aed75b82dd59"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1551, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}