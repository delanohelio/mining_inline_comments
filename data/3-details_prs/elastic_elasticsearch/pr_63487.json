{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5OTM1MDUw", "number": 63487, "title": "Ensure field types consistency on supporting text queries", "bodyText": "Some supported field types don't support term queries, and throw exception in their termQuery method. That exception is either an IllegalArgumentException or a QueryShardException. There is logic in MatchQuery that skips the field or not depending on the exception that is thrown.\nAlso, such field types should hold a TextSearchInfo.NONE while that is not always the case.\nWith this PR we make the following changes:\n\nstreamline using TextSearchInfo.NONE in all field types that don't support text queries\nstandardize the exception being thrown when a field type does not support term queries to be IllegalArgumentException. Note that this is not a breaking change as both exceptions previously returned translated to 400 status code.\nAdapt the MatchQuery logic to skip fields that don't support term queries. There is no need to call termQuery passing an empty string and catch exceptions potentially thrown. We can rather check the TextSearchInfo which tells already whether the field supports text queries or not.\nadd a test method to MapperTestCase that verifies the consistency of a field type by verifying that it is not searchable whenever it uses TextSearchInfo.NONE, while it is otherwise. This is what triggered all of the above changes.", "createdAt": "2020-10-08T13:46:51Z", "url": "https://github.com/elastic/elasticsearch/pull/63487", "merged": true, "mergeCommit": {"oid": "f491422e1edf79ea08d5657b5035f4a5ee444442"}, "closed": true, "closedAt": "2020-10-13T09:05:43Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQhnIdAH2gAyNDk5OTM1MDUwOjQ2OGRiMTE0NzgzYWFiZjRkMDM5YjFmNzlkZWQ4ODI5ZDQ3NzhjMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSEy0aAFqTUwNzIyMDYzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "468db114783aabf4d039b1f79ded8829d4778c13", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/468db114783aabf4d039b1f79ded8829d4778c13", "committedDate": "2020-10-08T13:29:38Z", "message": "Add test to ensure consistency of our field types\n\nThis commit adds a test method to MapperTestCase, which verifies the consistency of a field type by verifying that it is not searchable whenever it uses TextSearchInfo.NONE, while it is otherwise."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0ODE5NTI1", "url": "https://github.com/elastic/elasticsearch/pull/63487#pullrequestreview-504819525", "createdAt": "2020-10-08T14:05:08Z", "commit": {"oid": "468db114783aabf4d039b1f79ded8829d4778c13"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDowNTowOFrOHegRpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQxNDowNTowOFrOHegRpw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTc0ODEzNQ==", "bodyText": "Can we put this on FieldTypeTestCase rather than MapperTestCase? Given that we're explicitly checking things in MappedFieldType rather than FieldMapper I think it would work better there.", "url": "https://github.com/elastic/elasticsearch/pull/63487#discussion_r501748135", "createdAt": "2020-10-08T14:05:08Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -420,4 +429,24 @@ public void testUpdates() throws IOException {\n         assertParseMaximalWarnings();\n     }\n \n+    public final void testTextSearchInfoConsistency() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "468db114783aabf4d039b1f79ded8829d4778c13"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de73db15f46394576f397d9c78b30dc790c7b7a4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/de73db15f46394576f397d9c78b30dc790c7b7a4", "committedDate": "2020-10-08T15:11:04Z", "message": "fix tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa95d9b5ac712b133d886d86bd421ea2b6b80d53", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa95d9b5ac712b133d886d86bd421ea2b6b80d53", "committedDate": "2020-10-12T09:24:51Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e1ebe8aedf6cb6ef184be526dcc69ffb34b1cc7", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e1ebe8aedf6cb6ef184be526dcc69ffb34b1cc7", "committedDate": "2020-10-12T09:57:51Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4f1448c04c995ad169f05790fc381530964d53a", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4f1448c04c995ad169f05790fc381530964d53a", "committedDate": "2020-10-12T09:58:04Z", "message": "Merge branch 'master' into test/text_search_info_consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb468986fa9c9a747cda1127364525dae35350b", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb468986fa9c9a747cda1127364525dae35350b", "committedDate": "2020-10-12T10:09:01Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91ce1453dabd9ef489ece4021492c919314bca70", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/91ce1453dabd9ef489ece4021492c919314bca70", "committedDate": "2020-10-12T11:57:49Z", "message": "Merge branch 'master' into test/text_search_info_consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7151efb18ced18b298dac38ef9ab01a609c1393e", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7151efb18ced18b298dac38ef9ab01a609c1393e", "committedDate": "2020-10-12T14:00:12Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8239bd23f1da02b1a80432a00858566acbd8cfd", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8239bd23f1da02b1a80432a00858566acbd8cfd", "committedDate": "2020-10-12T18:59:11Z", "message": "Merge branch 'master' into test/text_search_info_consistency"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f1e6b4c51ef8127f1f2ed2b3e2a27406214f75b", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f1e6b4c51ef8127f1f2ed2b3e2a27406214f75b", "committedDate": "2020-10-12T19:07:27Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3MjIwNjMx", "url": "https://github.com/elastic/elasticsearch/pull/63487#pullrequestreview-507220631", "createdAt": "2020-10-13T09:03:00Z", "commit": {"oid": "7f1e6b4c51ef8127f1f2ed2b3e2a27406214f75b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4230, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}