{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzODc5MjY5", "number": 55250, "title": "Convert InternalAggTestCase to AbstractNamedWriteableTestCase", "bodyText": "Some aggregations, such as the Terms* family, will use an alternate class to represent unmapped shard results (while the rest of the aggs use the same object but with some form of \"empty\" or \"nullish\" values to represent unmapped).\nThis was problematic with AbstractWireSerializingTestCase because it expects the instanceReader to always match the original class.  Instead, we need to use the NamedWriteable version so that the registry can be consulted for the proper deserialization reader.\nFixes #55149", "createdAt": "2020-04-15T16:58:42Z", "url": "https://github.com/elastic/elasticsearch/pull/55250", "merged": true, "mergeCommit": {"oid": "d72eb68c94dd4ff8bd788a4f2f1616c9ddbdbef9"}, "closed": true, "closedAt": "2020-04-17T19:32:38Z", "author": {"login": "polyfractal"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcX7E0QAH2gAyNDAzODc5MjY5OjU3Njg1YjA3MDk2ODYzOWEyMDg5Mzc3OTllZTM3ZGNiODk4NjE2ZTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcYR71EAH2gAyNDAzODc5MjY5OmJiMWNmYWQxMmQ5ODI2ZTk2YTUxNzEwYmI1ZjhjNmU4MTkwN2IwYTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57685b070968639a208937799ee37dcb898616e9", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/57685b070968639a208937799ee37dcb898616e9", "committedDate": "2020-04-15T16:56:00Z", "message": "Convert InternalAggTestCase to AbstractNamedWriteableTestCase\n\nSome aggregations, such as the Terms* family, will use an alternate\nclass to represent unmapped shard results (while the rest of the aggs\nuse the same object but with some form of \"empty\" or \"nullish\" values\nto represent unmapped).\n\nThis was problematic with AbstractWireSerializingTestCase because it\nexpects the instanceReader to always match the original class.  Instead,\nwe need to use the NamedWriteable version so that the registry\ncan be consulted for the proper deserialization reader."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MDUyMTc4", "url": "https://github.com/elastic/elasticsearch/pull/55250#pullrequestreview-394052178", "createdAt": "2020-04-15T19:00:42Z", "commit": {"oid": "57685b070968639a208937799ee37dcb898616e9"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTowMDo0MlrOGGHddw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQxOTowMjowNVrOGGHgXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2Njg3MQ==", "bodyText": "Could this be extends AbstactNamedWriteableTestCase<InternalAggregation>?", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409066871", "createdAt": "2020-04-15T19:00:42Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -166,7 +166,7 @@\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n-public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractWireSerializingTestCase<T> {\n+public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57685b070968639a208937799ee37dcb898616e9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzU0Mg==", "bodyText": "I think it is worth adding a comment that subclasses need to make sure that xContentRegistry includes the agg we're going to parse. Built in aggs are included automatically but other aggs won't be.", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409067542", "createdAt": "2020-04-15T19:01:59Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -166,7 +166,7 @@\n import static org.hamcrest.Matchers.hasSize;\n import static org.hamcrest.Matchers.lessThanOrEqualTo;\n \n-public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractWireSerializingTestCase<T> {\n+public abstract class InternalAggregationTestCase<T extends InternalAggregation> extends AbstractNamedWriteableTestCase<T> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57685b070968639a208937799ee37dcb898616e9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTA2NzYxNQ==", "bodyText": "Could this be final?", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409067615", "createdAt": "2020-04-15T19:02:05Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -282,6 +282,16 @@ protected T createUnmappedInstance(String name, Map<String, Object> metadata) {\n         return createTestInstance(name, metadata);\n     }\n \n+    /**\n+     * The NamedWriteable class for agg tests _should_ be InternalAggregation so this is being set by default,\n+     * but implementors can change if necessary\n+     */\n+    @Override\n+    @SuppressWarnings(\"unchecked\")\n+    protected Class<T> categoryClass() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "57685b070968639a208937799ee37dcb898616e9"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdac45a74e77697781e22c01a53edaeaefd63f1b", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdac45a74e77697781e22c01a53edaeaefd63f1b", "committedDate": "2020-04-15T20:49:39Z", "message": "Review comments, fix xpack tests, allow tests to register namedwriteables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ead77299bb5cd3f6568ecbc765d97d67c939f9ae", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/ead77299bb5cd3f6568ecbc765d97d67c939f9ae", "committedDate": "2020-04-15T20:59:37Z", "message": "Fix MatrixStats test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "886f1d61c32771283b00f559773c192c44b297d4", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/886f1d61c32771283b00f559773c192c44b297d4", "committedDate": "2020-04-15T21:00:15Z", "message": "Merge remote-tracking branch 'origin/master' into internal_agg_namedwriteable_test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0MTk1NTQ0", "url": "https://github.com/elastic/elasticsearch/pull/55250#pullrequestreview-394195544", "createdAt": "2020-04-15T23:09:22Z", "commit": {"oid": "886f1d61c32771283b00f559773c192c44b297d4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMzowOToyMlrOGGOvCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQyMzowOToyMlrOGGOvCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTE4NjA1OA==", "bodyText": "If you pass the plugins in instead of emptyList() then I think SearchModule will do this stuff for you.", "url": "https://github.com/elastic/elasticsearch/pull/55250#discussion_r409186058", "createdAt": "2020-04-15T23:09:22Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -270,6 +279,58 @@ public ReduceContext forFinalReduction() {\n         return namedXContents;\n     }\n \n+    @Override\n+    protected NamedXContentRegistry xContentRegistry() {\n+        return namedXContentRegistry;\n+    }\n+\n+    @Override\n+    protected final NamedWriteableRegistry getNamedWriteableRegistry() {\n+        return namedWriteableRegistry;\n+    }\n+\n+    /**\n+     * Implementors can override this if they want to provide a custom list of namedWriteables.  If the implementor\n+     * _just_ wants to register in namedWriteables provided by a plugin, prefer overriding\n+     * {@link InternalAggregationTestCase#registerPlugin()} instead because that route handles the automatic\n+     * conversion of AggSpecs into namedWriteables.\n+     */\n+    protected List<NamedWriteableRegistry.Entry> getNamedWriteables() {\n+        List<NamedWriteableRegistry.Entry> entries\n+            = new ArrayList<>(new SearchModule(Settings.EMPTY, emptyList()).getNamedWriteables());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "886f1d61c32771283b00f559773c192c44b297d4"}, "originalPosition": 70}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5090ef838c114c47abcc08d1c37247824c5ab19e", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/5090ef838c114c47abcc08d1c37247824c5ab19e", "committedDate": "2020-04-16T18:50:36Z", "message": "Fix parent/join module tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02324b1a00a1205960b23c4328d554118cc8382f", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/02324b1a00a1205960b23c4328d554118cc8382f", "committedDate": "2020-04-16T19:07:24Z", "message": "Remove code duplication"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk0OTI5Njk0", "url": "https://github.com/elastic/elasticsearch/pull/55250#pullrequestreview-394929694", "createdAt": "2020-04-16T19:19:00Z", "commit": {"oid": "02324b1a00a1205960b23c4328d554118cc8382f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb1cfad12d9826e96a51710bb5f8c6e81907b0a0", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb1cfad12d9826e96a51710bb5f8c6e81907b0a0", "committedDate": "2020-04-16T19:34:00Z", "message": "checkstyle!"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3382, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}