{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NTg1MzE1", "number": 57750, "title": "DataStream creation validation allows for prefixed indices", "bodyText": "We want to validate the DataStreams on creation to make sure the future backing\nindices would not clash with existing indices in the system (so we can\nalways rollover the data stream).\nThis changes the validation logic to allow for a DataStream to be created\nwith a backing index that has a prefix (eg. shrink-foo-000001) even if the\nformer backing index (foo-000001) exists in the system.\nThe new validation logic will look for potential index conflicts with indices\nin the system that have the counter in the name greater than the data stream's\ngeneration.\nThis ensures that the DataStream's future rollovers are safe because for a\nDataStream foo of generation 4, we will look for standalone indices in the\nform of foo-%06d with the counter greater than 4 (ie. validation will fail if\nfoo-000006 exists in the system), but will also allow replacing a\nbacking index with an index named by prefixing the backing index it replaces.\nRelates to #53100", "createdAt": "2020-06-05T17:00:08Z", "url": "https://github.com/elastic/elasticsearch/pull/57750", "merged": true, "mergeCommit": {"oid": "695b242d69f0dc017e732b63737625adb01fe595"}, "closed": true, "closedAt": "2020-06-08T10:09:13Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoVqmBgH2gAyNDI4NTg1MzE1OjcwOGVkNWQ3OWYzMGVkOTMzOTU2NjhiZmY0Nzk2M2E3YmMzMmU0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpM6YEAH2gAyNDI4NTg1MzE1OmE4NTcwY2UxMDVlZmFjNGYxYTlmZjU4NmNhODg3YzIyZDA5M2ViNjM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "708ed5d79f30ed93395668bff47963a7bc32e468", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/708ed5d79f30ed93395668bff47963a7bc32e468", "committedDate": "2020-06-05T16:57:35Z", "message": "DataStream creation validation allows for prefixed indices\n\nWe want to validate the DataStreams on creation to make sure the future backing\nindices would not clash with existing indices in the system (so we can\nalways rollover the data stream).\nThis changes the validation logic to allow for a DataStream to be created\nwith a backing index that has a prefix (eg. `shrink-foo-000001`) even if the\nformer backing index (`foo-000001`) exists in the system.\nThe new validation logic will look for potential index conflicts with indices\nin the system that have the counter in the name greater than the data stream's\ngeneration.\n\nThis ensures that the `DataStream`'s future rollovers are safe because for a\n`DataStream` `foo` of generation 4, we will look for standalone indices in the\nform of `foo-%06d` with the counter greater than 4 (ie. validation will fail if\n`foo-000006` exists in the system), but will also allow replacing a\nbacking index with an index named by prefixing the backing index it replaces."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1OTgwMjM1", "url": "https://github.com/elastic/elasticsearch/pull/57750#pullrequestreview-425980235", "createdAt": "2020-06-08T07:39:04Z", "commit": {"oid": "708ed5d79f30ed93395668bff47963a7bc32e468"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzozOTowNVrOGgSVmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQwNzo1MDowNVrOGgSqEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwODA1OA==", "bodyText": "maybe only catch IllegalArgumentException here? Since these are the cases with specific failure logic, otherwise we would mask any other potential problem.", "url": "https://github.com/elastic/elasticsearch/pull/57750#discussion_r436508058", "createdAt": "2020-06-08T07:39:05Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1452,27 +1452,41 @@ public Metadata build() {\n             return indicesLookup;\n         }\n \n-        private void validateDataStreams(SortedMap<String, IndexAbstraction> indicesLookup) {\n-            DataStreamMetadata dsMetadata = (DataStreamMetadata) customs.get(DataStreamMetadata.TYPE);\n+        /**\n+         * Validates there isn't any index with a name that would clash with the future backing indices of the existing data streams.\n+         *\n+         * For eg. if data stream `foo` has backing indices [`foo-000001`, `foo-000002`] and the indices lookup contains indices\n+         * `foo-000001`, `foo-000002` and `foo-000006` this will throw an IllegalStateException (as attempting to rollover the `foo` data\n+         * stream from generation 5 to 6 will not be possible)\n+         *\n+         * @param indicesLookup the indices in the system (this includes the data streams backing indices)\n+         * @param dsMetadata    the data streams in the system\n+         */\n+        static void validateDataStreams(SortedMap<String, IndexAbstraction> indicesLookup, @Nullable DataStreamMetadata dsMetadata) {\n             if (dsMetadata != null) {\n                 for (DataStream ds : dsMetadata.dataStreams().values()) {\n-                    SortedMap<String, IndexAbstraction> potentialConflicts =\n-                        indicesLookup.subMap(ds.getName() + \"-\", ds.getName() + \".\"); // '.' is the char after '-'\n-                    if (potentialConflicts.size() != 0) {\n-                        List<String> indexNames = ds.getIndices().stream().map(Index::getName).collect(Collectors.toList());\n-                        List<String> conflicts = new ArrayList<>();\n-                        for (Map.Entry<String, IndexAbstraction> entry : potentialConflicts.entrySet()) {\n-                            if (entry.getValue().getType() != IndexAbstraction.Type.CONCRETE_INDEX ||\n-                                indexNames.contains(entry.getKey()) == false) {\n-                                conflicts.add(entry.getKey());\n-                            }\n-                        }\n-\n-                        if (conflicts.size() > 0) {\n-                            throw new IllegalStateException(\"data stream [\" + ds.getName() +\n-                                \"] could create backing indices that conflict with \" + conflicts.size() + \" existing index(s) or alias(s)\" +\n-                                \" including '\" + conflicts.get(0) + \"'\");\n-                        }\n+                    Map<String, IndexAbstraction> conflicts =\n+                        indicesLookup.subMap(ds.getName() + \"-\", ds.getName() + \".\") // '.' is the char after '-'\n+                            .entrySet().stream()\n+                            .filter(entry -> {\n+                                if (entry.getValue().getType() != IndexAbstraction.Type.CONCRETE_INDEX) {\n+                                    return true;\n+                                } else {\n+                                    int indexNameCounter;\n+                                    try {\n+                                        indexNameCounter = IndexMetadata.parseIndexNameCounter(entry.getKey());\n+                                    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708ed5d79f30ed93395668bff47963a7bc32e468"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUwODQwOA==", "bodyText": "maybe also add an assertThat that tests with shrink- prefix?", "url": "https://github.com/elastic/elasticsearch/pull/57750#discussion_r436508408", "createdAt": "2020-06-08T07:39:51Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/IndexMetadataTests.java", "diffHunk": "@@ -331,4 +332,30 @@ public void testNumberOfReplicasIsNonNegative() {\n                 \"Failed to parse value [\" + numberOfReplicas + \"] for setting [index.number_of_replicas] must be >= 0\"));\n     }\n \n+    public void testParseIndexNameReturnsCounter() {\n+        assertThat(parseIndexNameCounter(\"logs-000003\"), is(3));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708ed5d79f30ed93395668bff47963a7bc32e468"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjUxMzI5OA==", "bodyText": "Perhaps just add a comment on why no failure is expected and let the exception bubble up?", "url": "https://github.com/elastic/elasticsearch/pull/57750#discussion_r436513298", "createdAt": "2020-06-08T07:50:05Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataTests.java", "diffHunk": "@@ -1078,6 +1080,148 @@ public void testSerialization() throws IOException {\n         assertTrue(Metadata.isGlobalStateEquals(orig, fromStreamMeta));\n     }\n \n+    public void testValidateDataStreamsNoConflicts() {\n+        Metadata metadata = createIndices(5, 10, \"foo-datastream\").metadata;\n+        try {\n+            validateDataStreams(metadata.getIndicesLookup(), (DataStreamMetadata) metadata.customs().get(DataStreamMetadata.TYPE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "708ed5d79f30ed93395668bff47963a7bc32e468"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "52e0f80c55117d6d859f0c8b4353211091eb9130", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/52e0f80c55117d6d859f0c8b4353211091eb9130", "committedDate": "2020-06-08T08:53:04Z", "message": "Catch IllegalArgumentException and extra test."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bf030b923b5bb26dfc7f2efce8d4b6dbd575cb8", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/0bf030b923b5bb26dfc7f2efce8d4b6dbd575cb8", "committedDate": "2020-06-08T09:18:24Z", "message": "Drop usage of fail() in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8570ce105efac4f1a9ff586ca887c22d093eb63", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8570ce105efac4f1a9ff586ca887c22d093eb63", "committedDate": "2020-06-08T09:19:36Z", "message": "Merge branch 'master' into data-stream-create-validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3770, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}