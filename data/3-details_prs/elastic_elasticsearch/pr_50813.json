{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxMTA3NDEz", "number": 50813, "title": "Remove custom metadata tool", "bodyText": "Adds a command-line tool to remove broken custom metadata from the cluster state.\nRelates to #48701", "createdAt": "2020-01-09T18:55:18Z", "url": "https://github.com/elastic/elasticsearch/pull/50813", "merged": true, "mergeCommit": {"oid": "d94b81e8b0e99b7fff1d51c7f22dce44e2f560c4"}, "closed": true, "closedAt": "2020-01-14T17:33:54Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6PpdkAH2gAyMzYxMTA3NDEzOjExOWE0YTljNzA0OGE4Mzk0YmJmZjc0ZWZlNjFmZTVjMjc2ZDAzMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6T33OgH2gAyMzYxMTA3NDEzOjgyZjdiMzA2MDA0Njg1ZDgwNTI4ODI3ZGI1YWI2MTU3NGEzOGIzMjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/119a4a9c7048a8394bbff74efe61fe5c276d0317", "committedDate": "2020-01-14T11:56:24Z", "message": "Remove custom metadata tool"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d2000bb3c6809eb7aada7b5759bad9342406791f", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2000bb3c6809eb7aada7b5759bad9342406791f", "committedDate": "2020-01-09T19:15:09Z", "message": "checkstyle"}, "afterCommit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/119a4a9c7048a8394bbff74efe61fe5c276d0317", "committedDate": "2020-01-14T11:56:24Z", "message": "Remove custom metadata tool"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjQ0Mzc0", "url": "https://github.com/elastic/elasticsearch/pull/50813#pullrequestreview-342644374", "createdAt": "2020-01-14T16:00:09Z", "commit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjowMDowOVrOFdctdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQxNjozNDowOFrOFdd9DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQyMzQxMw==", "bodyText": "Maybe we should give up here \ud83d\ude01\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            This tool has six modes:\n          \n          \n            \n            This tool has a number of modes:", "url": "https://github.com/elastic/elasticsearch/pull/50813#discussion_r366423413", "createdAt": "2020-01-14T16:00:09Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/commands/node-tool.asciidoc", "diffHunk": "@@ -20,16 +20,20 @@ bin/elasticsearch-node repurpose|unsafe-bootstrap|detach-cluster|override-versio\n [float]\n === Description\n \n-This tool has five modes:\n+This tool has six modes:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0MzA3Mg==", "bodyText": "Do users have a good way of knowing the name of the custom that should be removed? I.e. snapshot_lifecycle here.", "url": "https://github.com/elastic/elasticsearch/pull/50813#discussion_r366443072", "createdAt": "2020-01-14T16:32:56Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/commands/node-tool.asciidoc", "diffHunk": "@@ -407,6 +429,33 @@ You can also use wildcards to remove multiple settings, for example using\n node$ ./bin/elasticsearch-node remove-settings xpack.monitoring.*\n ----\n \n+[float]\n+==== Removing custom metadata from the cluster state\n+\n+If the on-disk cluster state contains custom metadata that prevents the node\n+from starting up and loading the cluster state, you can run the following\n+commands to remove this custom metadata.\n+\n+[source,txt]\n+----\n+node$ ./bin/elasticsearch-node remove-customs snapshot_lifecycle", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjQ0Mzc4OQ==", "bodyText": "Should we document that this uses wildcards, e.g. that * will remove all customs?", "url": "https://github.com/elastic/elasticsearch/pull/50813#discussion_r366443789", "createdAt": "2020-01-14T16:34:08Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/cluster/coordination/RemoveCustomsCommand.java", "diffHunk": "@@ -0,0 +1,102 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.cluster.coordination;\n+\n+import com.carrotsearch.hppc.cursors.ObjectCursor;\n+import joptsimple.OptionSet;\n+import joptsimple.OptionSpec;\n+import org.elasticsearch.cli.ExitCodes;\n+import org.elasticsearch.cli.Terminal;\n+import org.elasticsearch.cli.UserException;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.env.Environment;\n+import org.elasticsearch.gateway.PersistedClusterStateService;\n+\n+import java.io.IOException;\n+import java.nio.file.Path;\n+import java.util.List;\n+\n+public class RemoveCustomsCommand extends ElasticsearchNodeCommand {\n+\n+    static final String CUSTOMS_REMOVED_MSG = \"Customs were successfully removed from the cluster state\";\n+    static final String CONFIRMATION_MSG =\n+        DELIMITER +\n+            \"\\n\" +\n+            \"You should only run this tool if you have broken custom metadata in the\\n\" +\n+            \"cluster state that prevents the cluster state from being loaded.\\n\" +\n+            \"This tool can cause data loss and its use should be your last resort.\\n\" +\n+            \"\\n\" +\n+            \"Do you want to proceed?\\n\";\n+\n+    private final OptionSpec<String> arguments;\n+\n+    public RemoveCustomsCommand() {\n+        super(\"Removes custom metadata from the cluster state\");\n+        arguments = parser.nonOptions(\"custom metadata names\");\n+    }\n+\n+    @Override\n+    protected void processNodePaths(Terminal terminal, Path[] dataPaths, OptionSet options, Environment env)\n+        throws IOException, UserException {\n+        final List<String> customsToRemove = arguments.values(options);\n+        if (customsToRemove.isEmpty()) {\n+            throw new UserException(ExitCodes.USAGE, \"Must supply at least one custom metadata name to remove\");\n+        }\n+\n+        final PersistedClusterStateService persistedClusterStateService = createPersistedClusterStateService(dataPaths);\n+\n+        terminal.println(Terminal.Verbosity.VERBOSE, \"Loading cluster state\");\n+        final Tuple<Long, ClusterState> termAndClusterState = loadTermAndClusterState(persistedClusterStateService, env);\n+        final ClusterState oldClusterState = termAndClusterState.v2();\n+        terminal.println(Terminal.Verbosity.VERBOSE, \"custom metadata names: \" + oldClusterState.metaData().customs().keys());\n+        final MetaData.Builder metaDataBuilder = MetaData.builder(oldClusterState.metaData());\n+        for (String customToRemove : customsToRemove) {\n+            boolean matched = false;\n+            for (ObjectCursor<String> customKeyCur : oldClusterState.metaData().customs().keys()) {\n+                final String customKey = customKeyCur.value;\n+                if (Regex.simpleMatch(customToRemove, customKey)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "119a4a9c7048a8394bbff74efe61fe5c276d0317"}, "originalPosition": 76}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82f7b306004685d80528827db5ab61574a38b325", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/82f7b306004685d80528827db5ab61574a38b325", "committedDate": "2020-01-14T16:51:45Z", "message": "Update docs/reference/commands/node-tool.asciidoc\n\nCo-Authored-By: David Turner <david.turner@elastic.co>"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3712, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}