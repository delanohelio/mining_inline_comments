{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMTQ1NjU0", "number": 61447, "title": "Stop Needlessly Copying Bytes in XContent Parsing", "bodyText": "Wrapping a BytesArray in a StreamInput for deserialization is inefficient.\nThis forces Jackson to internally buffer (i.e. copy) all bytes from the BytesArray\nbefore deserializing, adding overhead for copying the bytes and managing the buffers.\nThis commit fixes a number of spots where BytesArray is the most common type of\nBytesReference to special case this type and parse it more efficiently.\nAlso improves parsing Strings to use the more efficient direct String parsing APIs instead of manually wrapping in a reader (Jackson will do this for long strings itself but will use a more efficient approach of getting chars into a char[] directly without allocation in most cases instead).", "createdAt": "2020-08-23T16:20:03Z", "url": "https://github.com/elastic/elasticsearch/pull/61447", "merged": true, "mergeCommit": {"oid": "305bebfcad138416fb0af9a57a22635edb44db1b"}, "closed": true, "closedAt": "2020-08-24T13:03:22Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdBwWw4AH2gAyNDcyMTQ1NjU0OjFhNTZlNWU5N2IxZjdhZjE1YjBjMWZkOGNlOTZiNWNhNzM1ZDIwOTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdCBcd8gH2gAyNDcyMTQ1NjU0OmI5NjMxZGUwNWQzZmJhYTZkZmM5ZDQ4Y2JkMjgwMzllMDNmZjNjYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a56e5e97b1f7af15b0c1fd8ce96b5ca735d2095", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a56e5e97b1f7af15b0c1fd8ce96b5ca735d2095", "committedDate": "2020-08-23T16:11:28Z", "message": "Stop Needlessly Copying Bytes in XContent Parsing\n\nWrapping a `BytesArray` in a `StreamInput` for deserialization is inefficient.\nThis forces Jackson to internally buffer (i.e. copy) all bytes from the `BytesArray`\nbefore deserializing, adding overhead for copying the bytes and managing the buffers.\n\nThis commit fixes a number of spots where `BytesArray` is the most common type of\n`BytesReference` to special case this type and parse it more efficiently.\nAlso improves parsing `String`s to use the more efficient direct `String` parsing APIs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9cc1d0e04f3640bd420bad085cd5580515bc0c3b", "committedDate": "2020-08-23T16:36:31Z", "message": "math is hard .."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMDI3OTQ1", "url": "https://github.com/elastic/elasticsearch/pull/61447#pullrequestreview-473027945", "createdAt": "2020-08-23T17:13:50Z", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNzoxMzo1MVrOHFOiEg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNzoxMzo1MVrOHFOiEg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI0MzAyNg==", "bodyText": "This now throws with a slightly different text because we read straight from the byte[]", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475243026", "createdAt": "2020-08-23T17:13:51Z", "author": {"login": "original-brownbear"}, "path": "server/src/test/java/org/elasticsearch/index/IndexingSlowLogTests.java", "diffHunk": "@@ -272,12 +272,12 @@ public void testSlowLogParsedDocumentPrinterSourceToLog() throws IOException {\n             () -> IndexingSlowLogMessage.of(index, doc, 10, true, 3));\n         assertThat(e, hasToString(containsString(\"_failed_to_convert_[Unrecognized token 'invalid':\"\n             + \" was expecting (JSON String, Number, Array, Object or token 'null', 'true' or 'false')\\\\n\"\n-            + \" at [Source: (org.elasticsearch.common.bytes.AbstractBytesReference$MarkSupportingStreamInputWrapper)\")));\n+            + \" at [Source: \")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjIxNjA0", "url": "https://github.com/elastic/elasticsearch/pull/61447#pullrequestreview-473221604", "createdAt": "2020-08-24T08:27:48Z", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyNzo0OFrOHFZnjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyNzo0OFrOHFZnjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNDY1Mg==", "bodyText": "This comment looks to be out-of-date with this changes and can ben removed.", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475424652", "createdAt": "2020-08-24T08:27:48Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -133,9 +134,7 @@ public void parse(\n \n             // now parse the action\n             // EMPTY is safe here because we never call namedObject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjIxNjc1", "url": "https://github.com/elastic/elasticsearch/pull/61447#pullrequestreview-473221675", "createdAt": "2020-08-24T08:27:53Z", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyNzo1NFrOHFZn3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyNzo1NFrOHFZn3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNDczMg==", "bodyText": "This comment looks to be out-of-date with this changes and can ben removed.", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475424732", "createdAt": "2020-08-24T08:27:54Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -277,9 +276,8 @@ public void parse(\n                                 .setRequireAlias(requireAlias)\n                                 .routing(routing);\n                         // EMPTY is safe here because we never call namedObject", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjIyMTEz", "url": "https://github.com/elastic/elasticsearch/pull/61447#pullrequestreview-473222113", "createdAt": "2020-08-24T08:28:33Z", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyODozM1rOHFZpcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwODoyODozM1rOHFZpcg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTQyNTEzOA==", "bodyText": "Aha, here is where the EMPTY went. You could re-insert the comment about it here.", "url": "https://github.com/elastic/elasticsearch/pull/61447#discussion_r475425138", "createdAt": "2020-08-24T08:28:33Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkRequestParser.java", "diffHunk": "@@ -299,4 +297,33 @@ public void parse(\n         }\n     }\n \n+    private static XContentParser createParser(BytesReference data, XContent xContent) throws IOException {\n+        if (data instanceof BytesArray) {\n+            return parseBytesArray(xContent, (BytesArray) data, 0, data.length());\n+        } else {\n+            return xContent.createParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE, data.streamInput());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "originalPosition": 91}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMjM2NjI0", "url": "https://github.com/elastic/elasticsearch/pull/61447#pullrequestreview-473236624", "createdAt": "2020-08-24T08:48:53Z", "commit": {"oid": "9cc1d0e04f3640bd420bad085cd5580515bc0c3b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81aaf4d1f0fe63ed639792d14d68ed4cabecb173", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/81aaf4d1f0fe63ed639792d14d68ed4cabecb173", "committedDate": "2020-08-24T12:03:54Z", "message": "Merge remote-tracking branch 'elastic/master' into stop-copying-x-content-bytes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9631de05d3fbaa6dfc9d48cbd28039e03ff3cc5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9631de05d3fbaa6dfc9d48cbd28039e03ff3cc5", "committedDate": "2020-08-24T12:06:05Z", "message": "CR: move comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4663, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}