{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA2MzI5MzE1", "number": 55498, "title": "Rollover for data streams", "bodyText": "Adds support to the _rollover endpoint for data streams.\nRelates to #53100.", "createdAt": "2020-04-20T22:11:03Z", "url": "https://github.com/elastic/elasticsearch/pull/55498", "merged": true, "mergeCommit": {"oid": "f6cd01ea2b987d474bcf7c2bbbcf05a6ebea50b6"}, "closed": true, "closedAt": "2020-04-22T20:48:10Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcZjOW-gH2gAyNDA2MzI5MzE1OjdlZjJhODZiOTliMTc3ZTM2YmRkNWZiMTg5OGE2OThlYmQ1NTRjYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaOEGqAFqTM5ODU0NzA2OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7ef2a86b99b177e36bdd5fb1898a698ebd554cb9", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ef2a86b99b177e36bdd5fb1898a698ebd554cb9", "committedDate": "2020-04-20T18:16:33Z", "message": "wip"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b44eeee6350c8f3881f0a403f474f58a43e23593", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/b44eeee6350c8f3881f0a403f474f58a43e23593", "committedDate": "2020-04-20T18:44:38Z", "message": "finished cherry pick"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c443fe85518c6d21eee457279dacde7fb94161c", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c443fe85518c6d21eee457279dacde7fb94161c", "committedDate": "2020-04-20T22:06:47Z", "message": "add tests and cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "948b8ece2f22c1817e0e29cb6f7f3441f3e0e078", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/948b8ece2f22c1817e0e29cb6f7f3441f3e0e078", "committedDate": "2020-04-20T23:39:42Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/064c3135cf0380dc4980aa20b48ad9c61c8a3389", "committedDate": "2020-04-20T23:40:25Z", "message": "Merge branch 'master' into rollover_data_streams"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MTYwMzYy", "url": "https://github.com/elastic/elasticsearch/pull/55498#pullrequestreview-397160362", "createdAt": "2020-04-21T09:38:03Z", "commit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3MjQyMTk0", "url": "https://github.com/elastic/elasticsearch/pull/55498#pullrequestreview-397242194", "createdAt": "2020-04-21T11:34:46Z", "commit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMTozNDo0NlrOGJA9tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxMjowNzo0MlrOGJCNTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEwNjE2NA==", "bodyText": "I think a test for this is missing?", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412106164", "createdAt": "2020-04-21T11:34:46Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -178,6 +179,10 @@ static ClusterState createDataStream(MetadataCreateIndexService metadataCreateIn\n             MetadataCreateIndexService.validateIndexOrAliasName(request.name,\n                 (s1, s2) -> new IllegalArgumentException(\"data_stream [\" + s1 + \"] \" + s2));\n \n+            if (request.name.toLowerCase(Locale.ROOT).equals(request.name) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjExNDcxOA==", "bodyText": "I think we should rename this to prepareDataStreamCreateIndexRequest, since the hidden setting is applied, making this method data stream specific.", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412114718", "createdAt": "2020-04-21T11:48:43Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java", "diffHunk": "@@ -127,15 +173,28 @@ static String generateRolloverIndexName(String sourceIndexName, IndexNameExpress\n         }\n     }\n \n-    static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final String providedIndexName, final String targetIndexName,\n+    static CreateIndexClusterStateUpdateRequest prepareCreateIndexRequest(final String targetIndexName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEyMTgxOA==", "bodyText": "I wonder if for data streams we should disallow applying aliases, mappings and settings to the new index? It feels odd that you cannot specify them on create data stream but can on rollover?", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412121818", "createdAt": "2020-04-21T12:00:00Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/MetadataRolloverService.java", "diffHunk": "@@ -75,17 +83,33 @@ private RolloverResult(String rolloverIndexName, String sourceIndexName, Cluster\n         }\n     }\n \n-    public RolloverResult rolloverClusterState(ClusterState currentState, String aliasName, String newIndexName,\n+    public RolloverResult rolloverClusterState(ClusterState currentState, String aliasOrDataStream, String newIndexName,\n                                                CreateIndexRequest createIndexRequest, List<Condition<?>> metConditions,\n                                                boolean silent) throws Exception {\n+        validate(currentState.metadata(), aliasOrDataStream, newIndexName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjEyNjU0MQ==", "bodyText": "I think we need to also rename this method?", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412126541", "createdAt": "2020-04-21T12:07:42Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/RolloverRequestBuilder.java", "diffHunk": "@@ -34,7 +34,7 @@ public RolloverRequestBuilder(ElasticsearchClient client, RolloverAction action)\n     }\n \n     public RolloverRequestBuilder setAlias(String alias) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "064c3135cf0380dc4980aa20b48ad9c61c8a3389"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dabd5e52f3b8f0fd977580da54d1833eb564163", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dabd5e52f3b8f0fd977580da54d1833eb564163", "committedDate": "2020-04-21T16:00:19Z", "message": "add test, rename method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f28175f23cecf70907c23a2b6f885787763e143", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f28175f23cecf70907c23a2b6f885787763e143", "committedDate": "2020-04-21T22:28:55Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3OTMxNjcx", "url": "https://github.com/elastic/elasticsearch/pull/55498#pullrequestreview-397931671", "createdAt": "2020-04-22T07:52:45Z", "commit": {"oid": "4f28175f23cecf70907c23a2b6f885787763e143"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNzo1Mjo0NlrOGJojgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQwNzo1Mjo0NlrOGJojgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjc1NDgxNg==", "bodyText": "The TransportRolloverAction#checkBlock() method should be changed.\nThe following\nIndicesOptions indicesOptions = IndicesOptions.fromOptions(true, true,\n            request.indicesOptions().expandWildcardsOpen(), request.indicesOptions().expandWildcardsClosed());\n\nshould be changed into:\nIndicesOptions indicesOptions = IndicesOptions.fromOptions(true, true,\n            request.indicesOptions().expandWildcardsOpen(), request.indicesOptions().expandWildcardsClosed(), \n            request.indicesOptions().expandWildcardsHidden(), request.indicesOptions().allowAliasesToMultipleIndices(), \n            request.indicesOptions().forbidClosedIndices(), request.indicesOptions().ignoreAliases(), \n            request.indicesOptions().ignoreThrottled(), request.indicesOptions().includeDataStreams());\n\nThis why the modified test in DataStreamIT failed.", "url": "https://github.com/elastic/elasticsearch/pull/55498#discussion_r412754816", "createdAt": "2020-04-22T07:52:46Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/rollover/TransportRolloverAction.java", "diffHunk": "@@ -99,14 +99,14 @@ protected void masterOperation(Task task, final RolloverRequest rolloverRequest,\n                                    final ActionListener<RolloverResponse> listener) throws Exception {\n         MetadataRolloverService.RolloverResult preResult =\n             rolloverService.rolloverClusterState(state,\n-                rolloverRequest.getAlias(), rolloverRequest.getNewIndexName(), rolloverRequest.getCreateIndexRequest(),\n+                rolloverRequest.getRolloverTarget(), rolloverRequest.getNewIndexName(), rolloverRequest.getCreateIndexRequest(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f28175f23cecf70907c23a2b6f885787763e143"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2652e5f5261182145a668d787f213a605d75d6f0", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/2652e5f5261182145a668d787f213a605d75d6f0", "committedDate": "2020-04-22T12:18:55Z", "message": "fix more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5612448b1225d12b948e78df0a7e91fffc255e1", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5612448b1225d12b948e78df0a7e91fffc255e1", "committedDate": "2020-04-22T13:16:28Z", "message": "moar test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f1ff0e124105576a9c6c0efad48cf6751abb287", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f1ff0e124105576a9c6c0efad48cf6751abb287", "committedDate": "2020-04-22T14:36:11Z", "message": "change 'alias or data stream' to 'rollover target'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2c73c5f3dc542f13e4e7f2ea2b0d474f18632d4", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2c73c5f3dc542f13e4e7f2ea2b0d474f18632d4", "committedDate": "2020-04-22T14:36:31Z", "message": "Merge branch 'master' into rollover_data_streams"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90e630abf102e7d430d7e334e91ab163db8c34ac", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/90e630abf102e7d430d7e334e91ab163db8c34ac", "committedDate": "2020-04-22T15:38:17Z", "message": "minor DRYing up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ba5379753b629753cb03e56d69ddac24e7eb457", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ba5379753b629753cb03e56d69ddac24e7eb457", "committedDate": "2020-04-22T15:46:50Z", "message": "rename variables"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fd2ac2ed795466cb78f81ad38e4f99fccb100d5f", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd2ac2ed795466cb78f81ad38e4f99fccb100d5f", "committedDate": "2020-04-22T16:23:20Z", "message": "disallow settings, aliases, or mappings for data streams on rollover"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61804e12a5eb13c021f56168eadf4a3f544d1bb3", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/61804e12a5eb13c021f56168eadf4a3f544d1bb3", "committedDate": "2020-04-22T17:01:05Z", "message": "Merge branch 'master' into rollover_data_streams"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTQ3MDY5", "url": "https://github.com/elastic/elasticsearch/pull/55498#pullrequestreview-398547069", "createdAt": "2020-04-22T20:11:16Z", "commit": {"oid": "61804e12a5eb13c021f56168eadf4a3f544d1bb3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 603, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}