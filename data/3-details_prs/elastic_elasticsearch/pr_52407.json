{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2MTA3MDI4", "number": 52407, "title": "License removal leads back to a basic license", "bodyText": "A new basic license will be generated when existing license is deleted.\nIn addition, deleting an existing basic license is a no-op.\nResolves: #45022", "createdAt": "2020-02-17T12:19:03Z", "url": "https://github.com/elastic/elasticsearch/pull/52407", "merged": true, "mergeCommit": {"oid": "0d62213ca4073821d7855d76d9679a8a131b34eb"}, "closed": true, "closedAt": "2020-02-21T04:23:10Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcFMRPqAH2gAyMzc2MTA3MDI4OjIyYmMzODJjYjc2YTA2NTkwM2FlMjUzNDgzNDJlZGE2NDk3MmQxYTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGWsfUAFqTM2MjM3MjQ2OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22bc382cb76a065903ae25348342eda64972d1a7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/22bc382cb76a065903ae25348342eda64972d1a7", "committedDate": "2020-02-17T12:13:24Z", "message": "Remove license now revert back to basic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4cf21a1381d8792b9988c5adcaab9d664396150", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4cf21a1381d8792b9988c5adcaab9d664396150", "committedDate": "2020-02-17T12:24:06Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bf41098dcb97dbf3d9d82ba2a387b2e4262fef6", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bf41098dcb97dbf3d9d82ba2a387b2e4262fef6", "committedDate": "2020-02-17T12:52:25Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYwMDY0MDE0", "url": "https://github.com/elastic/elasticsearch/pull/52407#pullrequestreview-360064014", "createdAt": "2020-02-18T04:24:01Z", "commit": {"oid": "7bf41098dcb97dbf3d9d82ba2a387b2e4262fef6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNDoyNDowMlrOFq0xYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xOFQwNDoyNDowMlrOFq0xYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MDQ0OTEyMg==", "bodyText": "Can we merge this code and the duplicate from StartBasicClusterTask into a single generateNewBasicLicense() method?", "url": "https://github.com/elastic/elasticsearch/pull/52407#discussion_r380449122", "createdAt": "2020-02-18T04:24:02Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java", "diffHunk": "@@ -353,17 +354,32 @@ protected ClusterStateUpdateResponse newResponse(boolean acknowledged) {\n                 @Override\n                 public ClusterState execute(ClusterState currentState) throws Exception {\n                     MetaData metaData = currentState.metaData();\n-                    final LicensesMetaData currentLicenses = metaData.custom(LicensesMetaData.TYPE);\n-                    if (currentLicenses.getLicense() != LicensesMetaData.LICENSE_TOMBSTONE) {\n+                    final LicensesMetaData currentLicensesMetadata = metaData.custom(LicensesMetaData.TYPE);\n+                    final License currentLicense = LicensesMetaData.extractLicense(currentLicensesMetadata);\n+                    if (shouldRemove(currentLicense)) {\n                         MetaData.Builder mdBuilder = MetaData.builder(currentState.metaData());\n-                        LicensesMetaData newMetadata = new LicensesMetaData(LicensesMetaData.LICENSE_TOMBSTONE,\n-                            currentLicenses.getMostRecentTrialVersion());\n-                        mdBuilder.putCustom(LicensesMetaData.TYPE, newMetadata);\n+                        License.Builder specBuilder = License.builder()\n+                            .uid(UUID.randomUUID().toString())\n+                            .issuedTo(clusterService.getClusterName().value())\n+                            .maxNodes(SELF_GENERATED_LICENSE_MAX_NODES)\n+                            .issueDate(clock.millis())\n+                            .type(License.LicenseType.BASIC)\n+                            .expiryDate(BASIC_SELF_GENERATED_LICENSE_EXPIRATION_MILLIS);\n+                        License selfGeneratedLicense = SelfGeneratedLicense.create(specBuilder, currentState.nodes());\n+                        LicensesMetaData newLicensesMetadata = new LicensesMetaData(selfGeneratedLicense,\n+                            currentLicensesMetadata == null ? null : currentLicensesMetadata.getMostRecentTrialVersion());\n+                        mdBuilder.putCustom(LicensesMetaData.TYPE, newLicensesMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7bf41098dcb97dbf3d9d82ba2a387b2e4262fef6"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e2d837ef5a96e54f314d8c1ef461350105f6963", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e2d837ef5a96e54f314d8c1ef461350105f6963", "committedDate": "2020-02-18T13:33:19Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "540ebec8c57f6bbdab6eda382d16d394acd47c5b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/540ebec8c57f6bbdab6eda382d16d394acd47c5b", "committedDate": "2020-02-18T13:53:04Z", "message": "yeah checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6feb936b3b41a7c94b39265ce520521a19621325", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/6feb936b3b41a7c94b39265ce520521a19621325", "committedDate": "2020-02-18T14:23:44Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "331c3b20caf9ac797b2fb790e19297057e36ff0e", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/331c3b20caf9ac797b2fb790e19297057e36ff0e", "committedDate": "2020-02-18T20:37:23Z", "message": "Merge remote-tracking branch 'origin/master' into es-45022-back-to-basic-license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzQ2NzE4", "url": "https://github.com/elastic/elasticsearch/pull/52407#pullrequestreview-362346718", "createdAt": "2020-02-21T01:19:52Z", "commit": {"oid": "331c3b20caf9ac797b2fb790e19297057e36ff0e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMToxOTo1MlrOFsoxrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwMToxOTo1MlrOFsoxrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjM0OTc0MA==", "bodyText": "This feels weird to me.\nWe run a task, that just creates another task and executes that, and it feels like that's just so we can change the response object.\nWhy not change this to something like:\npublic void removeLicense(final DeleteLicenseRequest request, final ActionListener<PostStartBasicResponse> listener) {\n      PostStartBasicRequest startBasicRequest = new PostStartBasicRequest().acknowledge(true);\n      startBasicLicense(startBasicRequest, listener); \n}\n\nand then have the Transport action translate the PostStartBasicResponse into the AcknowledgedResponse it needs to keep compatibilty with the API.", "url": "https://github.com/elastic/elasticsearch/pull/52407#discussion_r382349740", "createdAt": "2020-02-21T01:19:52Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/license/LicenseService.java", "diffHunk": "@@ -352,17 +352,10 @@ protected ClusterStateUpdateResponse newResponse(boolean acknowledged) {\n \n                 @Override\n                 public ClusterState execute(ClusterState currentState) throws Exception {\n-                    MetaData metaData = currentState.metaData();\n-                    final LicensesMetaData currentLicenses = metaData.custom(LicensesMetaData.TYPE);\n-                    if (currentLicenses.getLicense() != LicensesMetaData.LICENSE_TOMBSTONE) {\n-                        MetaData.Builder mdBuilder = MetaData.builder(currentState.metaData());\n-                        LicensesMetaData newMetadata = new LicensesMetaData(LicensesMetaData.LICENSE_TOMBSTONE,\n-                            currentLicenses.getMostRecentTrialVersion());\n-                        mdBuilder.putCustom(LicensesMetaData.TYPE, newMetadata);\n-                        return ClusterState.builder(currentState).metaData(mdBuilder).build();\n-                    } else {\n-                        return currentState;\n-                    }\n+                    final StartBasicClusterTask startBasicClusterTask =\n+                        new StartBasicClusterTask(logger, clusterService.getClusterName().value(), clock,\n+                            new PostStartBasicRequest().acknowledge(true), null);\n+                    return startBasicClusterTask.execute(currentState);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "331c3b20caf9ac797b2fb790e19297057e36ff0e"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c04be91f6e5c2f2040450b74c56a474129ca806", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c04be91f6e5c2f2040450b74c56a474129ca806", "committedDate": "2020-02-21T02:44:03Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34f87165ca5585b4f1a9a9f3ac2e8b6dc2596940", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/34f87165ca5585b4f1a9a9f3ac2e8b6dc2596940", "committedDate": "2020-02-21T02:50:17Z", "message": "Merge remote-tracking branch 'origin/master' into es-45022-back-to-basic-license"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyMzcyNDY4", "url": "https://github.com/elastic/elasticsearch/pull/52407#pullrequestreview-362372468", "createdAt": "2020-02-21T02:56:08Z", "commit": {"oid": "34f87165ca5585b4f1a9a9f3ac2e8b6dc2596940"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2339, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}