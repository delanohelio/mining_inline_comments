{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA5NjAyMzE4", "number": 64113, "title": "Support removing archived settings if cluster has read only blocks.", "bodyText": "Currently if we have follow cluster settings(we have set both persistent and transient before):\nGET_cluster/settings?pretty\n{\n  \"persistent\" : {\n    \"cluster\" : {\n      \"blocks\" : {\n        \"read_only_allow_delete\" : \"true\"\n      }\n    }\n  },\n  \"transient\" : {\n    \"cluster\" : {\n      \"blocks\" : {\n        \"read_only_allow_delete\" : \"true\"\n      }\n    }\n  }\n}\n\nThen we cannot remove them together:\nPUT _cluster/settings?pretty\n{\n  \"persistent\" : {\n    \"cluster.blocks.read_only_allow_delete\": null\n  },\n  \"transient\" : {\n    \"cluster.blocks.read_only_allow_delete\": null\n  }\n}'\n\nResponse:\n{\n  \"error\" : {\n    \"root_cause\" : [\n      {\n        \"type\" : \"cluster_block_exception\",\n        \"reason\" : \"blocked by: [FORBIDDEN/13/cluster read-only / allow delete (api)];\"\n      }\n    ],\n    \"type\" : \"cluster_block_exception\",\n    \"reason\" : \"blocked by: [FORBIDDEN/13/cluster read-only / allow delete (api)];\"\n  },\n  \"status\" : 403\n}\n\n\nEven we can remove them one by one, but I think it's reasonable to allow user to remove them together. This PR supports both of the cases.", "createdAt": "2020-10-25T14:33:43Z", "url": "https://github.com/elastic/elasticsearch/pull/64113", "merged": true, "mergeCommit": {"oid": "65300d6494259021ea263a28c8163f7632c25144"}, "closed": true, "closedAt": "2021-01-27T07:11:26Z", "author": {"login": "howardhuanghua"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdV9fdcgH2gAyNTA5NjAyMzE4OmY4MTVlYjFlNWE5NDRiZDA5MmFmYjllMDMzMGY2MTRmYzk1YTNmNTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdz-2sxAFqTU3NjU4MTYxNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f815eb1e5a944bd092afb9e0330f614fc95a3f55", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/f815eb1e5a944bd092afb9e0330f614fc95a3f55", "committedDate": "2020-10-25T10:48:13Z", "message": "Optimize cluster block clear logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5b1c10330d64968b40c849063fe8032d0ca41f4", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5b1c10330d64968b40c849063fe8032d0ca41f4", "committedDate": "2020-11-07T14:42:28Z", "message": "Merge branch 'master' into remove_block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "814a6cd5b35437d5f9ae138d62ccd8422f60548f", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/814a6cd5b35437d5f9ae138d62ccd8422f60548f", "committedDate": "2020-11-08T08:10:14Z", "message": "Support removing archived settings in cluster read only status."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ccd875776e25ff1e8aa0547ef5237eb4d150c10", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ccd875776e25ff1e8aa0547ef5237eb4d150c10", "committedDate": "2020-11-08T08:11:32Z", "message": "remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0604fca9256aeaf5e1f9ea407bb18b83c539f1b", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/d0604fca9256aeaf5e1f9ea407bb18b83c539f1b", "committedDate": "2020-12-12T13:22:57Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMzE4MDA0", "url": "https://github.com/elastic/elasticsearch/pull/64113#pullrequestreview-552318004", "createdAt": "2020-12-15T10:38:56Z", "commit": {"oid": "d0604fca9256aeaf5e1f9ea407bb18b83c539f1b"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "669db05789a6a5496567c3851adb6f7a8fac7d80", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/669db05789a6a5496567c3851adb6f7a8fac7d80", "committedDate": "2020-12-15T15:03:18Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61fdc763ce6ce5680cfd07e575221994afb0927a", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/61fdc763ce6ce5680cfd07e575221994afb0927a", "committedDate": "2020-12-16T11:43:01Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dbef4a274f70f86c19f58589f67a634acb74900e", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/dbef4a274f70f86c19f58589f67a634acb74900e", "committedDate": "2020-12-27T13:32:35Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ad4c9d00d47ce5833e7e6b17431199c1bd33856", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ad4c9d00d47ce5833e7e6b17431199c1bd33856", "committedDate": "2020-12-27T15:16:33Z", "message": "Update skip block checking logic."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10a0c8a7821c48bf37673ac30db8802b5e6460e4", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/10a0c8a7821c48bf37673ac30db8802b5e6460e4", "committedDate": "2020-12-28T02:12:45Z", "message": "update comment."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e551d8ac5ddf5b5b68665ac0947b337b7a2ef12c", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/e551d8ac5ddf5b5b68665ac0947b337b7a2ef12c", "committedDate": "2020-12-28T02:20:26Z", "message": "revert unchanged line."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/266d31872e7a3bfd03e920c248c43273b33c45c7", "committedDate": "2020-12-30T11:39:10Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODk0Mzk5", "url": "https://github.com/elastic/elasticsearch/pull/64113#pullrequestreview-560894399", "createdAt": "2021-01-04T09:45:01Z", "commit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTo0NTowMVrOINrKbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNFQwOTo1OToxM1rOINrnkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIwOTU4MA==", "bodyText": "Nit: prefer Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()) over state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false), and similarly for the next line.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551209580", "createdAt": "2021-01-04T09:45:01Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,7 +289,112 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n-    public void testClusterUpdateSettingsWithBlocks() {\n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        // set cluster read only or read only allow delete\n+        if (randomBoolean()) {\n+            setClusterReadOnly(true);\n+        } else {\n+            setClusterReadOnlyAllowDelete(true);\n+        }\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIwOTkzOQ==", "bodyText": "Nit: prefer expectThrows over this pattern.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551209939", "createdAt": "2021-01-04T09:45:37Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,7 +289,112 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n-    public void testClusterUpdateSettingsWithBlocks() {\n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        // set cluster read only or read only allow delete\n+        if (randomBoolean()) {\n+            setClusterReadOnly(true);\n+        } else {\n+            setClusterReadOnlyAllowDelete(true);\n+        }\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false)\n+            || state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), false));\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        logger.info(\"brokenMeta[{}]\", brokenMeta.persistentSettings());\n+        restartNodesOnBrokenClusterState(ClusterState.builder(state).metadata(brokenMeta));\n+        ensureGreen(); // wait for state recovery\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().persistentSettings().getAsBoolean(\"archived.this.is.unknown\", false));\n+\n+        // cannot remove read only block due to archived settings\n+        try {\n+            setClusterReadOnly(false);\n+            setClusterReadOnlyAllowDelete(false);\n+            fail(\"should be blocked by archived settings.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxMTA2Mw==", "bodyText": "I think it'd be better to test both of these cases each time: suggest having two top-level test methods that call this method with an argument indicating which branch to take.\nWe should also test the case where both blocks are set.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551211063", "createdAt": "2021-01-04T09:47:49Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,7 +289,112 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n-    public void testClusterUpdateSettingsWithBlocks() {\n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        // set cluster read only or read only allow delete\n+        if (randomBoolean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxMjQ1OA==", "bodyText": "Would prefer to remove this as I don't think it'll help in future debugging (but I can be convinced otherwise)", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551212458", "createdAt": "2021-01-04T09:50:22Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,7 +289,112 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n-    public void testClusterUpdateSettingsWithBlocks() {\n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        // set cluster read only or read only allow delete\n+        if (randomBoolean()) {\n+            setClusterReadOnly(true);\n+        } else {\n+            setClusterReadOnlyAllowDelete(true);\n+        }\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false)\n+            || state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), false));\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        logger.info(\"brokenMeta[{}]\", brokenMeta.persistentSettings());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxMjgyNA==", "bodyText": "This change seems unnecessary, suggest reverting it?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public void testClusterUpdateSettingsWithBlocks() throws Exception {\n          \n          \n            \n                public void testClusterUpdateSettingsWithBlocks() {", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551212824", "createdAt": "2021-01-04T09:51:13Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,7 +289,112 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n-    public void testClusterUpdateSettingsWithBlocks() {\n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        // set cluster read only or read only allow delete\n+        if (randomBoolean()) {\n+            setClusterReadOnly(true);\n+        } else {\n+            setClusterReadOnlyAllowDelete(true);\n+        }\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false)\n+            || state.getMetadata().transientSettings().getAsBoolean(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), false));\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        logger.info(\"brokenMeta[{}]\", brokenMeta.persistentSettings());\n+        restartNodesOnBrokenClusterState(ClusterState.builder(state).metadata(brokenMeta));\n+        ensureGreen(); // wait for state recovery\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().persistentSettings().getAsBoolean(\"archived.this.is.unknown\", false));\n+\n+        // cannot remove read only block due to archived settings\n+        try {\n+            setClusterReadOnly(false);\n+            setClusterReadOnlyAllowDelete(false);\n+            fail(\"should be blocked by archived settings.\");\n+        } catch (IllegalArgumentException ex) {\n+            assertTrue(ex.getMessage().contains(\"unknown setting [archived.this.is.unknown]\"));\n+        }\n+\n+        // fail to clear archived settings with non-archived settings\n+        try {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder().putNull(\"cluster.routing.allocation.enable\"))\n+                .setTransientSettings(Settings.builder().putNull(\"archived.*\")).get());\n+            fail(\"should only can remove archived settings.\");\n+        } catch (ClusterBlockException ex) {\n+            assertTrue(ex.getMessage().contains(\"cluster read-only\"));\n+        }\n+\n+        // fail to clear archived settings due to cluster read only block\n+        try {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder().putNull(\"archived.*\")).get());\n+            fail(\"should fail due to cluster read only block.\");\n+        } catch (ClusterBlockException ex) {\n+            assertTrue(ex.getMessage().contains(\"cluster read-only\"));\n+        }\n+\n+        // fail to clear archived settings with adding cluster block\n+        try {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder()\n+                    .putNull(\"archived.*\")\n+                    .put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\")).get());\n+            fail(\"should fail due to cluster read only block.\");\n+        } catch (ClusterBlockException ex) {\n+            assertTrue(ex.getMessage().contains(\"cluster read-only\"));\n+        }\n+\n+        // fail to set archived settings to non-null value even with clearing blocks together\n+        try {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder()\n+                    .put(\"archived.this.is.unknown\", \"false\")\n+                    .putNull(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n+                    .putNull(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey())).get());\n+            fail(\"should fail due to cluster read only block.\");\n+        } catch (ClusterBlockException ex) {\n+            assertTrue(ex.getMessage().contains(\"cluster read-only\"));\n+        }\n+\n+        // we can clear read-only block with archived settings together\n+        if (randomBoolean()) {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder()\n+                    .putNull(\"archived.*\")\n+                    .putNull(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n+                    .putNull(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey()))\n+                .setTransientSettings(Settings.builder()\n+                    .putNull(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n+                    .putNull(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey())).get());\n+        } else {\n+            assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                .setPersistentSettings(Settings.builder()\n+                    .putNull(\"archived.*\")\n+                    .put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"false\")\n+                    .put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"false\"))\n+                .setTransientSettings(Settings.builder()\n+                    .put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"false\")\n+                    .put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"false\")).get());\n+        }\n+\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertFalse(state.getMetadata().transientSettings()\n+            .getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false));\n+        assertFalse(state.getMetadata().transientSettings()\n+            .getAsBoolean(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), false));\n+        assertFalse(state.getMetadata().persistentSettings()\n+            .getAsBoolean(Metadata.SETTING_READ_ONLY_SETTING.getKey(), false));\n+        assertFalse(state.getMetadata().persistentSettings()\n+            .getAsBoolean(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), false));\n+        assertNull(state.getMetadata().persistentSettings().get(\"archived.this.is.unknown\"));\n+    }\n+\n+    public void testClusterUpdateSettingsWithBlocks() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 119}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNjM3OQ==", "bodyText": "You can do this outside the loop:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        boolean clearBlockSettings = false;\n          \n          \n            \n                        boolean clearBlockSettings \n          \n          \n            \n                                = clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n          \n          \n            \n                                || clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey());", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551216379", "createdAt": "2021-01-04T09:58:05Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java", "diffHunk": "@@ -62,22 +68,75 @@ public TransportClusterUpdateSettingsAction(TransportService transportService, C\n         this.clusterSettings = clusterSettings;\n     }\n \n+    /**\n+     skip check block if:\n+     * Only at least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * Or all of the following are true:\n+     * 1. At least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * 2. Neither cluster.blocks.read_only nor cluster.blocks.read_only_allow_delete is being set to true.\n+     * 3. The only other settings in this update are archived ones being set to null.\n+     */\n     @Override\n     protected ClusterBlockException checkBlock(ClusterUpdateSettingsRequest request, ClusterState state) {\n-        // allow for dedicated changes to the metadata blocks, so we don't block those to allow to \"re-enable\" it\n-        if (request.transientSettings().size() + request.persistentSettings().size() == 1) {\n-            // only one setting\n-            if (Metadata.SETTING_READ_ONLY_SETTING.exists(request.persistentSettings())\n-                || Metadata.SETTING_READ_ONLY_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.persistentSettings())) {\n-                // one of the settings above as the only setting in the request means - resetting the block!\n+        Map<String, String> clearedBlockAndArchivedSettings = new HashMap<>();\n+        if (checkClearedBlockAndArchivedSettings(request.transientSettings(), clearedBlockAndArchivedSettings)\n+            && checkClearedBlockAndArchivedSettings(request.persistentSettings(), clearedBlockAndArchivedSettings)) {\n+            boolean clearBlockSettings = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTIxNzA0Mg==", "bodyText": "IMO we don't need this, if you drop it then the only difference is the DEBUG log message (and I prefer the more informative log message without it).\nWith this, and my previous comment, we don't need the loop at all, and also don't need to track every setting name/value in the request, just to verify that at least one read-only setting is being adjusted.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r551217042", "createdAt": "2021-01-04T09:59:13Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java", "diffHunk": "@@ -62,22 +68,75 @@ public TransportClusterUpdateSettingsAction(TransportService transportService, C\n         this.clusterSettings = clusterSettings;\n     }\n \n+    /**\n+     skip check block if:\n+     * Only at least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * Or all of the following are true:\n+     * 1. At least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * 2. Neither cluster.blocks.read_only nor cluster.blocks.read_only_allow_delete is being set to true.\n+     * 3. The only other settings in this update are archived ones being set to null.\n+     */\n     @Override\n     protected ClusterBlockException checkBlock(ClusterUpdateSettingsRequest request, ClusterState state) {\n-        // allow for dedicated changes to the metadata blocks, so we don't block those to allow to \"re-enable\" it\n-        if (request.transientSettings().size() + request.persistentSettings().size() == 1) {\n-            // only one setting\n-            if (Metadata.SETTING_READ_ONLY_SETTING.exists(request.persistentSettings())\n-                || Metadata.SETTING_READ_ONLY_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.persistentSettings())) {\n-                // one of the settings above as the only setting in the request means - resetting the block!\n+        Map<String, String> clearedBlockAndArchivedSettings = new HashMap<>();\n+        if (checkClearedBlockAndArchivedSettings(request.transientSettings(), clearedBlockAndArchivedSettings)\n+            && checkClearedBlockAndArchivedSettings(request.persistentSettings(), clearedBlockAndArchivedSettings)) {\n+            boolean clearBlockSettings = false;\n+            boolean clearArchivedSettings = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "266d31872e7a3bfd03e920c248c43273b33c45c7"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a6a269fe9ab30a2d856fd0898de0ea187799427a", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/a6a269fe9ab30a2d856fd0898de0ea187799427a", "committedDate": "2021-01-05T02:03:29Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7bb9668587834fbc9ccdf24ebdf32c858c464f32", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bb9668587834fbc9ccdf24ebdf32c858c464f32", "committedDate": "2021-01-05T03:46:39Z", "message": "optimization based on suggestion."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c182311150064b52527a4d7f36e7bd9468fcf068", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/c182311150064b52527a4d7f36e7bd9468fcf068", "committedDate": "2021-01-05T03:55:22Z", "message": "add more accurate block message validation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1709adc649af714ccd45cc357aad391549f6dfb1", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/1709adc649af714ccd45cc357aad391549f6dfb1", "committedDate": "2021-01-16T11:35:48Z", "message": "fix conflict"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b2ada058733f062b66e1f3a6b29fcbcac427f9a", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b2ada058733f062b66e1f3a6b29fcbcac427f9a", "committedDate": "2021-01-16T12:25:57Z", "message": "fix compile issue."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8b3c1dfea8156c90f87630191bac2ecbf31f2423", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/8b3c1dfea8156c90f87630191bac2ecbf31f2423", "committedDate": "2021-01-19T11:46:53Z", "message": "merge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/431a6e589ca3ec29c0dd26d2b06824d142eab591", "committedDate": "2021-01-22T10:29:37Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bed8c5e9077242dcfd60bf69de368248a673efb", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/8bed8c5e9077242dcfd60bf69de368248a673efb", "committedDate": "2021-01-26T16:16:34Z", "message": "Test tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc08c30610477a70963d843e3c998683266cc4ac", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc08c30610477a70963d843e3c998683266cc4ac", "committedDate": "2021-01-26T16:17:11Z", "message": "Impl tweaks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2NTE5MTQ0", "url": "https://github.com/elastic/elasticsearch/pull/64113#pullrequestreview-576519144", "createdAt": "2021-01-26T16:18:09Z", "commit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxNjoxODowOVrOIafBog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0yNlQxNjoyMDoxN1rOIafIbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MjIxMA==", "bodyText": "I think here we should set these settings randomly, not just setting the one we care about to true.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564642210", "createdAt": "2021-01-26T16:18:09Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,6 +289,145 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        testRemoveArchiveSettingsWithBlocks(true, false);\n+        testRemoveArchiveSettingsWithBlocks(false, true);\n+        testRemoveArchiveSettingsWithBlocks(true, true);\n+    }\n+\n+    private void testRemoveArchiveSettingsWithBlocks(boolean readOnly, boolean readOnlyAllowDelete) throws Exception {\n+        Settings.Builder settingsBuilder = Settings.builder();\n+        if (readOnly) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\");\n+        }\n+        if (readOnlyAllowDelete) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"true\");\n+        }\n+        assertAcked(client().admin().cluster().prepareUpdateSettings()\n+            .setPersistentSettings(settingsBuilder).setTransientSettings(settingsBuilder).get());\n+\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        if (readOnly) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        restartNodesOnBrokenClusterState(ClusterState.builder(state).metadata(brokenMeta));\n+        ensureGreen(); // wait for state recovery\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().persistentSettings().getAsBoolean(\"archived.this.is.unknown\", false));\n+\n+        // cannot remove read only block due to archived settings\n+        final IllegalArgumentException e1 =\n+            expectThrows(\n+                IllegalArgumentException.class,\n+                () -> {\n+                    Settings.Builder builder = Settings.builder();\n+                    if (readOnly) {\n+                        builder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"false\");\n+                    }\n+                    if (readOnlyAllowDelete) {\n+                        builder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"false\");\n+                    }\n+                    assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                        .setPersistentSettings(builder).setTransientSettings(builder).get());\n+                });\n+        assertTrue(e1.getMessage().contains(\"unknown setting [archived.this.is.unknown]\"));\n+\n+        // fail to clear archived settings with non-archived settings\n+        final ClusterBlockException e2 =\n+            expectThrows(\n+                ClusterBlockException.class,\n+                () -> assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                        .setPersistentSettings(Settings.builder().putNull(\"cluster.routing.allocation.enable\"))\n+                        .setTransientSettings(Settings.builder().putNull(\"archived.*\")).get()));\n+        if (readOnly) {\n+            assertTrue(e2.getMessage().contains(\"cluster read-only (api)\"));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(e2.getMessage().contains(\"cluster read-only / allow delete (api)\"));\n+        }\n+\n+        // fail to clear archived settings due to cluster read only block\n+        final ClusterBlockException e3 =\n+            expectThrows(\n+                ClusterBlockException.class,\n+                () -> assertAcked(client().admin().cluster().prepareUpdateSettings()\n+                    .setPersistentSettings(Settings.builder().putNull(\"archived.*\")).get()));\n+        if (readOnly) {\n+            assertTrue(e3.getMessage().contains(\"cluster read-only (api)\"));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(e3.getMessage().contains(\"cluster read-only / allow delete (api)\"));\n+        }\n+\n+        // fail to clear archived settings with adding cluster block\n+        final ClusterBlockException e4 =\n+            expectThrows(\n+                ClusterBlockException.class,\n+                () -> {\n+                    Settings.Builder builder = Settings.builder().putNull(\"archived.*\");\n+                    if (readOnly) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MjM5Nw==", "bodyText": "We can assert the persistent settings here too?", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564642397", "createdAt": "2021-01-26T16:18:22Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,6 +289,145 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        testRemoveArchiveSettingsWithBlocks(true, false);\n+        testRemoveArchiveSettingsWithBlocks(false, true);\n+        testRemoveArchiveSettingsWithBlocks(true, true);\n+    }\n+\n+    private void testRemoveArchiveSettingsWithBlocks(boolean readOnly, boolean readOnlyAllowDelete) throws Exception {\n+        Settings.Builder settingsBuilder = Settings.builder();\n+        if (readOnly) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\");\n+        }\n+        if (readOnlyAllowDelete) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"true\");\n+        }\n+        assertAcked(client().admin().cluster().prepareUpdateSettings()\n+            .setPersistentSettings(settingsBuilder).setTransientSettings(settingsBuilder).get());\n+\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        if (readOnly) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MjQ0Mg==", "bodyText": "We can assert the persistent settings here too?", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564642442", "createdAt": "2021-01-26T16:18:26Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,6 +289,145 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        testRemoveArchiveSettingsWithBlocks(true, false);\n+        testRemoveArchiveSettingsWithBlocks(false, true);\n+        testRemoveArchiveSettingsWithBlocks(true, true);\n+    }\n+\n+    private void testRemoveArchiveSettingsWithBlocks(boolean readOnly, boolean readOnlyAllowDelete) throws Exception {\n+        Settings.Builder settingsBuilder = Settings.builder();\n+        if (readOnly) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\");\n+        }\n+        if (readOnlyAllowDelete) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"true\");\n+        }\n+        assertAcked(client().admin().cluster().prepareUpdateSettings()\n+            .setPersistentSettings(settingsBuilder).setTransientSettings(settingsBuilder).get());\n+\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        if (readOnly) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.get(state.getMetadata().transientSettings()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MjY3Mw==", "bodyText": "We could also set this to null.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564642673", "createdAt": "2021-01-26T16:18:40Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,6 +289,145 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        testRemoveArchiveSettingsWithBlocks(true, false);\n+        testRemoveArchiveSettingsWithBlocks(false, true);\n+        testRemoveArchiveSettingsWithBlocks(true, true);\n+    }\n+\n+    private void testRemoveArchiveSettingsWithBlocks(boolean readOnly, boolean readOnlyAllowDelete) throws Exception {\n+        Settings.Builder settingsBuilder = Settings.builder();\n+        if (readOnly) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\");\n+        }\n+        if (readOnlyAllowDelete) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"true\");\n+        }\n+        assertAcked(client().admin().cluster().prepareUpdateSettings()\n+            .setPersistentSettings(settingsBuilder).setTransientSettings(settingsBuilder).get());\n+\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        if (readOnly) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        restartNodesOnBrokenClusterState(ClusterState.builder(state).metadata(brokenMeta));\n+        ensureGreen(); // wait for state recovery\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().persistentSettings().getAsBoolean(\"archived.this.is.unknown\", false));\n+\n+        // cannot remove read only block due to archived settings\n+        final IllegalArgumentException e1 =\n+            expectThrows(\n+                IllegalArgumentException.class,\n+                () -> {\n+                    Settings.Builder builder = Settings.builder();\n+                    if (readOnly) {\n+                        builder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MjcxMw==", "bodyText": "We could also set this to null.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564642713", "createdAt": "2021-01-26T16:18:44Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/settings/ClusterSettingsIT.java", "diffHunk": "@@ -287,6 +289,145 @@ public void testUpdateSettings() {\n         assertThat(clusterService().getClusterSettings().get(INITIAL_RECOVERIES), equalTo(42));\n     }\n \n+    public void testRemoveArchiveSettingsWithBlocks() throws Exception {\n+        testRemoveArchiveSettingsWithBlocks(true, false);\n+        testRemoveArchiveSettingsWithBlocks(false, true);\n+        testRemoveArchiveSettingsWithBlocks(true, true);\n+    }\n+\n+    private void testRemoveArchiveSettingsWithBlocks(boolean readOnly, boolean readOnlyAllowDelete) throws Exception {\n+        Settings.Builder settingsBuilder = Settings.builder();\n+        if (readOnly) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"true\");\n+        }\n+        if (readOnlyAllowDelete) {\n+            settingsBuilder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"true\");\n+        }\n+        assertAcked(client().admin().cluster().prepareUpdateSettings()\n+            .setPersistentSettings(settingsBuilder).setTransientSettings(settingsBuilder).get());\n+\n+        ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        if (readOnly) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+        if (readOnlyAllowDelete) {\n+            assertTrue(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.get(state.getMetadata().transientSettings()));\n+        }\n+\n+        // create archived setting\n+        final Metadata metadata = state.getMetadata();\n+        final Metadata brokenMeta = Metadata.builder(metadata).persistentSettings(Settings.builder()\n+            .put(metadata.persistentSettings()).put(\"this.is.unknown\", true).build()).build();\n+        restartNodesOnBrokenClusterState(ClusterState.builder(state).metadata(brokenMeta));\n+        ensureGreen(); // wait for state recovery\n+        state = client().admin().cluster().prepareState().get().getState();\n+        assertTrue(state.getMetadata().persistentSettings().getAsBoolean(\"archived.this.is.unknown\", false));\n+\n+        // cannot remove read only block due to archived settings\n+        final IllegalArgumentException e1 =\n+            expectThrows(\n+                IllegalArgumentException.class,\n+                () -> {\n+                    Settings.Builder builder = Settings.builder();\n+                    if (readOnly) {\n+                        builder.put(Metadata.SETTING_READ_ONLY_SETTING.getKey(), \"false\");\n+                    }\n+                    if (readOnlyAllowDelete) {\n+                        builder.put(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey(), \"false\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0MzA1OA==", "bodyText": "This could just be a Set<String>, we don't care about the values.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564643058", "createdAt": "2021-01-26T16:19:08Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java", "diffHunk": "@@ -62,22 +68,59 @@ public TransportClusterUpdateSettingsAction(TransportService transportService, C\n         this.clusterSettings = clusterSettings;\n     }\n \n+    /**\n+     skip check block if:\n+     * Only at least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * Or all of the following are true:\n+     * 1. At least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * 2. Neither cluster.blocks.read_only nor cluster.blocks.read_only_allow_delete is being set to true.\n+     * 3. The only other settings in this update are archived ones being set to null.\n+     */\n     @Override\n     protected ClusterBlockException checkBlock(ClusterUpdateSettingsRequest request, ClusterState state) {\n-        // allow for dedicated changes to the metadata blocks, so we don't block those to allow to \"re-enable\" it\n-        if (request.transientSettings().size() + request.persistentSettings().size() == 1) {\n-            // only one setting\n-            if (Metadata.SETTING_READ_ONLY_SETTING.exists(request.persistentSettings())\n-                || Metadata.SETTING_READ_ONLY_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.persistentSettings())) {\n-                // one of the settings above as the only setting in the request means - resetting the block!\n+        Map<String, String> clearedBlockAndArchivedSettings = new HashMap<>();\n+        if (checkClearedBlockAndArchivedSettings(request.transientSettings(), clearedBlockAndArchivedSettings)\n+            && checkClearedBlockAndArchivedSettings(request.persistentSettings(), clearedBlockAndArchivedSettings)) {\n+            if (clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n+                || clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey())) {\n                 return null;\n             }\n         }\n+\n         return state.blocks().globalBlockedException(ClusterBlockLevel.METADATA_WRITE);\n     }\n \n+    /**\n+     * Check settings that only contains block and archived settings.\n+     * @param settings target settings to be checked.\n+     * @param clearedBlockAndArchivedSettings block settings that have been set to null or false,\n+     *                                        archived settings that have been set to null.\n+     * @return true if all settings are clear blocks or archived settings.\n+     */\n+    private boolean checkClearedBlockAndArchivedSettings(final Settings settings,\n+                                                         final Map<String, String> clearedBlockAndArchivedSettings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 59}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU2NDY0Mzk1MQ==", "bodyText": "I don't think we should duplicate the parsing of boolean settings here. Suggest using Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.get(settings) etc.", "url": "https://github.com/elastic/elasticsearch/pull/64113#discussion_r564643951", "createdAt": "2021-01-26T16:20:17Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/settings/TransportClusterUpdateSettingsAction.java", "diffHunk": "@@ -62,22 +68,59 @@ public TransportClusterUpdateSettingsAction(TransportService transportService, C\n         this.clusterSettings = clusterSettings;\n     }\n \n+    /**\n+     skip check block if:\n+     * Only at least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * Or all of the following are true:\n+     * 1. At least one of cluster.blocks.read_only or cluster.blocks.read_only_allow_delete is being cleared (set to null or false).\n+     * 2. Neither cluster.blocks.read_only nor cluster.blocks.read_only_allow_delete is being set to true.\n+     * 3. The only other settings in this update are archived ones being set to null.\n+     */\n     @Override\n     protected ClusterBlockException checkBlock(ClusterUpdateSettingsRequest request, ClusterState state) {\n-        // allow for dedicated changes to the metadata blocks, so we don't block those to allow to \"re-enable\" it\n-        if (request.transientSettings().size() + request.persistentSettings().size() == 1) {\n-            // only one setting\n-            if (Metadata.SETTING_READ_ONLY_SETTING.exists(request.persistentSettings())\n-                || Metadata.SETTING_READ_ONLY_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.transientSettings())\n-                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.exists(request.persistentSettings())) {\n-                // one of the settings above as the only setting in the request means - resetting the block!\n+        Map<String, String> clearedBlockAndArchivedSettings = new HashMap<>();\n+        if (checkClearedBlockAndArchivedSettings(request.transientSettings(), clearedBlockAndArchivedSettings)\n+            && checkClearedBlockAndArchivedSettings(request.persistentSettings(), clearedBlockAndArchivedSettings)) {\n+            if (clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_SETTING.getKey())\n+                || clearedBlockAndArchivedSettings.containsKey(Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey())) {\n                 return null;\n             }\n         }\n+\n         return state.blocks().globalBlockedException(ClusterBlockLevel.METADATA_WRITE);\n     }\n \n+    /**\n+     * Check settings that only contains block and archived settings.\n+     * @param settings target settings to be checked.\n+     * @param clearedBlockAndArchivedSettings block settings that have been set to null or false,\n+     *                                        archived settings that have been set to null.\n+     * @return true if all settings are clear blocks or archived settings.\n+     */\n+    private boolean checkClearedBlockAndArchivedSettings(final Settings settings,\n+                                                         final Map<String, String> clearedBlockAndArchivedSettings) {\n+        for (String key : settings.keySet()) {\n+            String value = settings.get(key);\n+            if (Metadata.SETTING_READ_ONLY_SETTING.getKey().equals(key)\n+                || Metadata.SETTING_READ_ONLY_ALLOW_DELETE_SETTING.getKey().equals(key)) {\n+                if (\"true\".equals(value)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "431a6e589ca3ec29c0dd26d2b06824d142eab591"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a572ae3674850c64c1c286b864dc702fc1dfbff", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a572ae3674850c64c1c286b864dc702fc1dfbff", "committedDate": "2021-01-26T16:41:33Z", "message": "Merge pull request #1 from DaveCTurner/2021-01-26-remove_block-reviews\n\n2021 01 26 remove block reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "34c219a62617072c465037341846537f5c7c22e6", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/34c219a62617072c465037341846537f5c7c22e6", "committedDate": "2021-01-26T16:58:02Z", "message": "Merge remote-tracking branch 'upstream/master' into remove_block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTc2NTgxNjE1", "url": "https://github.com/elastic/elasticsearch/pull/64113#pullrequestreview-576581615", "createdAt": "2021-01-26T17:21:14Z", "commit": {"oid": "34c219a62617072c465037341846537f5c7c22e6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1152, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}