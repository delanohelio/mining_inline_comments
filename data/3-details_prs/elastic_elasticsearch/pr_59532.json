{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4ODYyMDYy", "number": 59532, "title": "Cleanup some Serialization Code around Snapshots", "bodyText": "A number of obvious possible simplifications that also improve efficiency\nin some cases (better empty collection handling and size hint use).\nAlso, added a shortcut for writing and reading immutable open maps that\ncan be used to dry up additional spots.", "createdAt": "2020-07-14T12:54:11Z", "url": "https://github.com/elastic/elasticsearch/pull/59532", "merged": true, "mergeCommit": {"oid": "45ac012262a5fe2a1a44db6bbba3cea7e70bb42c"}, "closed": true, "closedAt": "2020-07-15T11:26:51Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc01g8pAH2gAyNDQ4ODYyMDYyOmM0MDJkNDNjYzI5MGI5ZTQ0NmJlZGFlMWQwYTY4ZWU5NTc4YWM0NDY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1ITXuAFqTQ0ODgzNzA0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c402d43cc290b9e446bedae1d0a68ee9578ac446", "committedDate": "2020-07-14T12:51:06Z", "message": "Cleanup some Serialization Code around Snapshots\n\nA number of obvious possible simplifications that also improve efficiency\nin some cases (better empty collection handling and size hint use).\nAlso, added a shortcut for writing and reading immutable open maps that\ncan be used to dry up additional spots."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MDkwNjEz", "url": "https://github.com/elastic/elasticsearch/pull/59532#pullrequestreview-448090613", "createdAt": "2020-07-14T13:10:44Z", "commit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxMDo0NFrOGxS-Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxMDo0NFrOGxS-Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NDIxMQ==", "bodyText": "We can remove this in master because we're checking against version 7.6 in that method.", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454344211", "createdAt": "2020-07-14T13:10:44Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/SnapshotsInProgress.java", "diffHunk": "@@ -365,11 +401,7 @@ private boolean assertConsistent() {\n         public ShardSnapshotStatus(StreamInput in) throws IOException {\n             nodeId = in.readOptionalString();\n             state = ShardState.fromValue(in.readByte());\n-            if (SnapshotsService.useShardGenerations(in.getVersion())) {\n-                generation = in.readOptionalString();\n-            } else {\n-                generation = null;\n-            }\n+            generation = in.readOptionalString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446"}, "originalPosition": 97}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4NzA3MzAw", "url": "https://github.com/elastic/elasticsearch/pull/59532#pullrequestreview-448707300", "createdAt": "2020-07-15T07:45:24Z", "commit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNzo0NToyNFrOGxyROw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQwNzo0NTozMFrOGxyRdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NzAxOQ==", "bodyText": "Can we add unit tests for this?", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454857019", "createdAt": "2020-07-15T07:45:24Z", "author": {"login": "tlrx"}, "path": "server/src/main/java/org/elasticsearch/common/io/stream/StreamInput.java", "diffHunk": "@@ -678,6 +679,25 @@ public final Boolean readOptionalBoolean() throws IOException {\n         return (Map<String, Object>) readGenericValue();\n     }\n \n+    /**\n+     * Read {@link ImmutableOpenMap} using given key and value readers.\n+     *\n+     * @param keyReader   key reader\n+     * @param valueReader value reader\n+     */\n+    public <K, V> ImmutableOpenMap<K, V> readImmutableMap(Writeable.Reader<K> keyReader, Writeable.Reader<V> valueReader)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDg1NzA3Nw==", "bodyText": "Can we add unit tests for this?", "url": "https://github.com/elastic/elasticsearch/pull/59532#discussion_r454857077", "createdAt": "2020-07-15T07:45:30Z", "author": {"login": "tlrx"}, "path": "server/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java", "diffHunk": "@@ -600,6 +602,28 @@ public void writeMapWithConsistentOrder(@Nullable Map<String, ? extends Object>\n         }\n     }\n \n+    /**\n+     * Write a {@link ImmutableOpenMap} of {@code K}-type keys to {@code V}-type.\n+     *\n+     * @param keyWriter The key writer\n+     * @param valueWriter The value writer\n+     */\n+    public final <K, V> void writeMap(final ImmutableOpenMap<K, V> map, final Writer<K> keyWriter, final Writer<V> valueWriter)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c402d43cc290b9e446bedae1d0a68ee9578ac446"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a15f8e302737dda4dcf4b4f4ecc8b7db542eb11", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a15f8e302737dda4dcf4b4f4ecc8b7db542eb11", "committedDate": "2020-07-15T10:20:39Z", "message": "Merge remote-tracking branch 'elastic/master' into cleanup-some-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a098da58893d0de2402efdc104d942fd81843a7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a098da58893d0de2402efdc104d942fd81843a7", "committedDate": "2020-07-15T10:37:46Z", "message": "CR: add tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4ODM3MDQ0", "url": "https://github.com/elastic/elasticsearch/pull/59532#pullrequestreview-448837044", "createdAt": "2020-07-15T10:44:28Z", "commit": {"oid": "2a098da58893d0de2402efdc104d942fd81843a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4489, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}