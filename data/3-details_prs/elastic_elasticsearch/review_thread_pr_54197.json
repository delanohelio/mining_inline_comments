{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzNjYzOTUy", "number": 54197, "reviewThreads": {"totalCount": 26, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzowNjowN1rODsiWNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDo0Mjo1NVrOD240RA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDI2Njc2OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzowNjowN1rOF9cHNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwNzowNjowN1rOF9cHNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5OTk2ODA1NQ==", "bodyText": "no longer need that logic. each handler is registered with a compatibleWith version.\nThe compatible API registers with Version.7\nthe current version register with Version.Current\nthis version is being used in handlers.getHandler to get the right handler", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r399968055", "createdAt": "2020-03-30T07:06:07Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -309,20 +315,14 @@ private void tryAllHandlers(final RestRequest request, final RestChannel channel\n                 if (handlers == null) {\n                     handler = null;\n                 } else {\n-                    handler = handlers.getHandler(requestMethod);\n+                    handler = handlers.getHandler(requestMethod, compatibleWithVersion);\n                 }\n                 if (handler == null) {\n                   if (handleNoHandlerFound(rawPath, requestMethod, uri, channel)) {\n                       return;\n                   }\n                 } else {\n-                    if(handler.compatibilityRequired() == false //regular (not removed) handlers are always dispatched", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1ad6779f0eb699d3623e055cb932ec041abd39b"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5Mjk2NzgyOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQyMzo1OTozM1rOF_Wx-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQxNzoxODoxOVrOF_1WbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA==", "bodyText": "may want to explicitly reject if there are more then 1 mapping... or will the underlying code blow up in a meaningful way ?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401977850", "createdAt": "2020-04-01T23:59:33Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExMTY4OQ==", "bodyText": "good question.. I forgot that we could have multiple types. When was this deprecated? Do we expect multiple types in mappings in 7.x?\nfrom what I see in Internal CreateIndexRequest holds a single mapping (#48996) Alan Woodward* 18/11/2019, 11:52 it is aimed at 8. so we should expect multiple types in 7.0-7.x?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402111689", "createdAt": "2020-04-02T07:41:26Z", "author": {"login": "pgomulka"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjI0ODQ2Mw==", "bodyText": "I confirmed this with @colings86 that multiple types were deprecated in 6.x and were not expected anymore.\nif it contains two types it will get into else branch here https://github.com/elastic/elasticsearch/pull/54197/files#diff-9327cfc566910ab3fec1c4b23a87a71bR90\nfor v8 logic. It does not expect two types either, and in fact will consider this mapping not typed\nMapperService.java\npublic static boolean isMappingSourceTyped(String type, Map<String, Object> mapping) {\n        return mapping.size() == 1 && mapping.keySet().iterator().next().equals(type);\n    }\n\nthe request with two types in a mapping will  eventually end up with\n     \"type\": \"mapper_parsing_exception\",\n        \"reason\": \"Root mapping definition has unsupported parameters:  [some_type_2 : {properties={field1={type=text}}}] [some_type_1 : {properties={field1={type=text}}}]\"\n      }\n\nShould we improve this or is this good enough?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402248463", "createdAt": "2020-04-02T11:42:22Z", "author": {"login": "pgomulka"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ3ODcwMA==", "bodyText": "thanks for following up. I think that error is good enough.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402478700", "createdAt": "2020-04-02T17:18:19Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3Nzg1MA=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5Mjk3NTEyOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowMzowOVrOF_W2MQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowMzowOVrOF_W2MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3ODkyOQ==", "bodyText": "The internal representation still requires the _doc right ?  can you make a comment here to that effect ?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401978929", "createdAt": "2020-04-02T00:03:09Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n+        final boolean includeTypeName = request.paramAsBoolean(INCLUDE_TYPE_NAME_PARAMETER, DEFAULT_INCLUDE_TYPE_NAME_POLICY);\n+\n+        @SuppressWarnings(\"unchecked\")\n+        Map<String, Object> mappings = (Map<String, Object>) source.get(\"mappings\");\n+\n+        if (includeTypeName && mappings.size() == 1) {\n+            // no matter what the type was, replace it with _doc\n+            Map<String, Object> newSource = new HashMap<>();\n+\n+            String typeName = mappings.keySet().iterator().next();\n+            @SuppressWarnings(\"unchecked\")\n+            Map<String, Object> typedMappings = (Map<String, Object>) mappings.get(typeName);\n+\n+            newSource.put(\"mappings\", Collections.singletonMap(MapperService.SINGLE_MAPPING_NAME, typedMappings));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 87}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5Mjk3OTM1OnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowNToxN1rOF_W4vw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowNToxN1rOF_W4vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk3OTU4Mw==", "bodyText": "Can you add some unit tests for this ?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401979583", "createdAt": "2020-04-02T00:05:17Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5Mjk4NjQxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDowODo0OVrOF_W86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzozNDowMlrOF_euVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDY0OQ==", "bodyText": "why not String.valueOf or Integer.toString ?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401980649", "createdAt": "2020-04-02T00:08:49Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){\n+        return \"\"+ Version.CURRENT.major;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwNzk5MQ==", "bodyText": "this was just a dirty hack, should be as you mentioned in other comments Version.Current", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402107991", "createdAt": "2020-04-02T07:34:02Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){\n+        return \"\"+ Version.CURRENT.major;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MDY0OQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5Mjk5MzYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoxMjoyNVrOF_XBKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wM1QwOTo0Mzo0OFrOGAON9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ==", "bodyText": "If possible, we should avoid using String types in contracts (unless they really are just simple strings). Here we are using a String to represent a Version, can we just pass around a Version object ?\nI think Version.7_0_0 is sufficient to pass around to mean \"7\" and having a proper Version object here allows for smarter comparisons and fewer conversions.  (and Version.CURRENT to represent current).  Then on usage, pull the major version out as close to where it is used as possible, but pass around proper Version objects.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401981739", "createdAt": "2020-04-02T00:12:25Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzMjY5MA==", "bodyText": "I can change it all to use Version, but the only places where a byte or a string are used would be XContentBuilder or params.\nSee AbstractRestChannel", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402132690", "createdAt": "2020-04-02T08:18:36Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEzNDAzMg==", "bodyText": "I can possibly avoid using params() and add an additional property on RestRequest that would keep a Version.\nWhat do you think?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402134032", "createdAt": "2020-04-02T08:21:01Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjQ4MzUwOQ==", "bodyText": "Adding to RestRequest would be in addition to params right ? Since params is still needed for XContent parsers ?\nIf so, I worry abit about having this info in two places, especially if the are set at different times. If we can ensure that they are set at the same time, and early enough on the RestRequest where it couldn't be read by something and then set. I am good with introducing in two places since I think it reads easier.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402483509", "createdAt": "2020-04-02T17:25:18Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjg4NjEzNA==", "bodyText": "At the moment there is no usecase that requires params. XcontenBuilder has a version set in AbstractRestChannel where RestRequest is available\n        builder.setCompatibleMajorVersion(request.getCompatibleApiVersion().major);\n\nXContentParser - not currently used for compatible api, but will be for search_type https://github.com/pgomulka/elasticsearch/pull/17/files#diff-4ca0a565076688b0f2d8206a8aae8d2d , https://github.com/pgomulka/elasticsearch/pull/17/files#diff-8a62025dd40acfdd5de52b62bdb190f2R484\nIt is being created in RestRequest, where an information about Version is stored", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402886134", "createdAt": "2020-04-03T09:43:48Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default String compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MTczOQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzAwNTYxOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoxODo0OVrOF_XIZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoxODo0OVrOF_XIZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MzU5MQ==", "bodyText": "I think this variable can be removed. i think it is only used once.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401983591", "createdAt": "2020-04-02T00:18:49Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzAwNjE1OnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoxOTowM1rOF_XIuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoxOTowM1rOF_XIuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4MzY3Mw==", "bodyText": "This note can be removed.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401983673", "createdAt": "2020-04-02T00:19:03Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzAwODU4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoyMDozMVrOF_XKRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoyMDozMVrOF_XKRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NDA2OA==", "bodyText": "+1 (lets use the the Version object here)", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401984068", "createdAt": "2020-04-02T00:20:31Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzAyMDA5OnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoyNjo1OFrOF_XRRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoyNjo1OFrOF_XRRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NTg2Mw==", "bodyText": "May want to remove \"responses\" since this API does not include the mappings in the response.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401985863", "createdAt": "2020-04-02T00:26:58Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 43}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzAyMTkwOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDoyNzo1NFrOF_XSZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzozMjowMFrOF_eqPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NjE1MQ==", "bodyText": "the comment is a bit confusing .. it says it not replaced with _doc .. but it actually is for the internal representation right ? suggest to just remove the comment.", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401986151", "createdAt": "2020-04-02T00:27:54Z", "author": {"login": "jakelandis"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEwNjk0Mg==", "bodyText": "it is incorrect. It should say  it is always replaced with _doc", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402106942", "createdAt": "2020-04-02T07:32:00Z", "author": {"login": "pgomulka"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,110 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests or responses.\n+     * Note: Support for this parameter will be removed after the transition period to typeless APIs.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+    public static final boolean DEFAULT_INCLUDE_TYPE_NAME_POLICY = false;\n+\n+    @Override\n+    public String compatibleWithVersion() {\n+        return String.valueOf(Version.V_7_0_0.major);\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is not replaced with _doc", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk4NjE1MQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzA2NTQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMDo1MTozOVrOF_Xrtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzo1NzowNVrOF_fgmw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjYzMQ==", "bodyText": "is this part of your changes ... or just showing up in the diff ?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401992631", "createdAt": "2020-04-02T00:51:39Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -701,7 +701,7 @@ public void initRestHandlers(Supplier<DiscoveryNodes> nodesInCluster) {\n \n         registerHandler.accept(new RestIndexAction());\n         registerHandler.accept(new CreateHandler());\n-        registerHandler.accept(new AutoIdHandler(clusterService));\n+        registerHandler.accept(new AutoIdHandler(nodesInCluster));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjEyMDg1OQ==", "bodyText": "compat_rest_api was updated to master where it was (accidentally I suspect) reverted back to use clusterService when nodes in cluster is only needed 8264bdd\nI suspect this will be back to nodesInCluster in master soon", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402120859", "createdAt": "2020-04-02T07:57:05Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -701,7 +701,7 @@ public void initRestHandlers(Supplier<DiscoveryNodes> nodesInCluster) {\n \n         registerHandler.accept(new RestIndexAction());\n         registerHandler.accept(new CreateHandler());\n-        registerHandler.accept(new AutoIdHandler(clusterService));\n+        registerHandler.accept(new AutoIdHandler(nodesInCluster));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5MjYzMQ=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzA4NDU2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMTowMjoyNlrOF_X3Gw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNzo1MjoyNFrOF_fVrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTU0Nw==", "bodyText": "nit: this can be simplified to  methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler); (mostly a cosmetic change though...)", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401995547", "createdAt": "2020-04-02T01:02:26Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte\n+    private final Map<RestRequest.Method, Map<String,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, String version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            methodHandlers.get(method).put(version, handler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjExODA2Mg==", "bodyText": "good idea!", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r402118062", "createdAt": "2020-04-02T07:52:24Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte\n+    private final Map<RestRequest.Method, Map<String,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, String version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            methodHandlers.get(method).put(version, handler);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NTU0Nw=="}, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 23}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzA4ODY2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMTowNDozN1rOF_X5Yw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwMTowNDozN1rOF_X5Yw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTk5NjEzMQ==", "bodyText": "nit: this can be simplified to   RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>()).put(version, handler);", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r401996131", "createdAt": "2020-04-02T01:04:37Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,36 +32,40 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    //TODO maybe we should aim for having a type for version instead of string/byte\n+    private final Map<RestRequest.Method, Map<String,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, String version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            methodHandlers.get(method).put(version, handler);\n         }\n     }\n \n     /**\n      * Add a handler for an additional array of methods. Note that {@code MethodHandlers}\n      * does not allow replacing the handler for an already existing method.\n      */\n-    MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers addMethods(RestHandler handler, String version, RestRequest.Method... methods) {\n         for (RestRequest.Method method : methods) {\n-            RestHandler existing = methodHandlers.putIfAbsent(method, handler);\n+            methodHandlers.putIfAbsent(method, new HashMap<>());\n+            RestHandler existing = methodHandlers.get(method).put(version, handler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff3463f7558256da4aba434f14ba8446e1ebce8"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTY5NjAyOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1MzoyNVrOGLukDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1MzoyNVrOGLukDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MDQxNQ==", "bodyText": "This is more of a nit but since the class itself already has V7 in the name, maybe it is redundant to have V7 in the method names as well?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                CreateIndexRequest prepareV7Request(RestRequest request) {\n          \n          \n            \n                CreateIndexRequest prepareRequest(RestRequest request) {", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414950415", "createdAt": "2020-04-25T01:53:25Z", "author": {"login": "jaymode"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+\n+    @Override\n+    public String getName() {\n+        return \"create_index_action_v7\";\n+    }\n+\n+    @Override\n+    public Version compatibleWithVersion() {\n+        return Version.V_7_0_0;\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = prepareV7Request(request);\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    // default scope for testing\n+    CreateIndexRequest prepareV7Request(RestRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTY5NjY4OnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1Mzo0OFrOGLukYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1Mzo0OFrOGLukYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MDQ5OA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {\n          \n          \n            \n                static Map<String, Object> prepareMappings(Map<String, Object> source, RestRequest request) {", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414950498", "createdAt": "2020-04-25T01:53:48Z", "author": {"login": "jaymode"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7.java", "diffHunk": "@@ -0,0 +1,119 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.action.support.ActiveShardCount;\n+import org.elasticsearch.client.node.NodeClient;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.XContentHelper;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.rest.action.RestToXContentListener;\n+import org.elasticsearch.rest.action.admin.indices.RestCreateIndexAction;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class RestCreateIndexActionV7 extends RestCreateIndexAction {\n+\n+    /**\n+     * Parameter that controls whether certain REST apis should include type names in their requests.\n+     */\n+    public static final String INCLUDE_TYPE_NAME_PARAMETER = \"include_type_name\";\n+\n+    @Override\n+    public String getName() {\n+        return \"create_index_action_v7\";\n+    }\n+\n+    @Override\n+    public Version compatibleWithVersion() {\n+        return Version.V_7_0_0;\n+    }\n+\n+    @Override\n+    public RestChannelConsumer prepareRequest(final RestRequest request, final NodeClient client) throws IOException {\n+        CreateIndexRequest createIndexRequest = prepareV7Request(request);\n+        return channel -> client.admin().indices().create(createIndexRequest, new RestToXContentListener<>(channel));\n+    }\n+\n+    // default scope for testing\n+    CreateIndexRequest prepareV7Request(RestRequest request) {\n+        CreateIndexRequest createIndexRequest = new CreateIndexRequest(request.param(\"index\"));\n+\n+        if (request.hasContent()) {\n+            Map<String, Object> sourceAsMap = XContentHelper.convertToMap(request.requiredContent(), false, request.getXContentType()).v2();\n+\n+            request.param(INCLUDE_TYPE_NAME_PARAMETER);// just consume, it is always replaced with _doc\n+            sourceAsMap = prepareMappingsV7(sourceAsMap, request);\n+\n+            createIndexRequest.source(sourceAsMap, LoggingDeprecationHandler.INSTANCE);\n+        }\n+\n+        createIndexRequest.timeout(request.paramAsTime(\"timeout\", createIndexRequest.timeout()));\n+        createIndexRequest.masterNodeTimeout(request.paramAsTime(\"master_timeout\", createIndexRequest.masterNodeTimeout()));\n+        createIndexRequest.waitForActiveShards(ActiveShardCount.parseString(request.param(\"wait_for_active_shards\")));\n+        return createIndexRequest;\n+    }\n+\n+    static Map<String, Object> prepareMappingsV7(Map<String, Object> source, RestRequest request) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 82}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTcwMzc5OnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestIndexActionV7.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1ODoyOVrOGLunng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNjo0MzoyOVrOGMTOaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTMyNg==", "bodyText": "This is a different way of doing things, but I'd much rather keep the assertion out of the individual rest handlers and add logic to the RestController for throwing an exception if a handler is registered with an incompatible version. So when the version is bumped to 9 that we would throw for any handler registered with a compatible version of 7. What do you think?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951326", "createdAt": "2020-04-25T01:58:29Z", "author": {"login": "jaymode"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestIndexActionV7.java", "diffHunk": "@@ -55,7 +53,7 @@ public String getName() {\n \n         @Override\n         public List<Route> routes() {\n-            assert Version.CURRENT.major == 8 : \"REST API compatilbity for version 7 is only supported on version 8\";\n+            assert Version.CURRENT.major == 8 : \"REST API compatibility for version 7 is only supported on version 8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU1MTA4MA==", "bodyText": "good idea, this will reduce duplication too", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415551080", "createdAt": "2020-04-27T06:43:29Z", "author": {"login": "pgomulka"}, "path": "modules/rest-compatibility/src/main/java/org/elasticsearch/rest/compat/version7/RestIndexActionV7.java", "diffHunk": "@@ -55,7 +53,7 @@ public String getName() {\n \n         @Override\n         public List<Route> routes() {\n-            assert Version.CURRENT.major == 8 : \"REST API compatilbity for version 7 is only supported on version 8\";\n+            assert Version.CURRENT.major == 8 : \"REST API compatibility for version 7 is only supported on version 8\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTMyNg=="}, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTcwNDYzOnYy", "diffSide": "RIGHT", "path": "modules/rest-compatibility/src/test/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7Tests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1OToxMFrOGLuoAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMTo1OToxMFrOGLuoAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTQyNA==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951424", "createdAt": "2020-04-25T01:59:10Z", "author": {"login": "jaymode"}, "path": "modules/rest-compatibility/src/test/java/org/elasticsearch/rest/compat/version7/RestCreateIndexActionV7Tests.java", "diffHunk": "@@ -0,0 +1,76 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest.compat.version7;\n+\n+import org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\n+import org.elasticsearch.common.bytes.BytesArray;\n+import org.elasticsearch.rest.RestRequest;\n+import org.elasticsearch.test.rest.FakeRestRequest;\n+import org.elasticsearch.test.rest.RestActionTestCase;\n+import org.junit.Before;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+public class RestCreateIndexActionV7Tests extends RestActionTestCase {\n+\n+    String mimeType = \"application/vnd.elasticsearch+json;compatible-with=7\";\n+    List<String> contentTypeHeader = Collections.singletonList(mimeType);\n+\n+    RestCreateIndexActionV7 restHandler = new RestCreateIndexActionV7();\n+\n+    @Before\n+    public void setUpAction() {\n+        controller().registerHandler(restHandler);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTcwNzA2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjowMDo1N1rOGLupIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjowMDo1N1rOGLupIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1MTcxMw==", "bodyText": "nit:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;\n          \n          \n            \n                private final Map<RestRequest.Method, Map<Version, RestHandler>> methodHandlers;", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414951713", "createdAt": "2020-04-25T02:00:57Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +32,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc3MTM4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NDozM1rOGLvFwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NDozM1rOGLvFwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTA0Mg==", "bodyText": "In order to preserve the contract that existed previously, this should be:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n          \n          \n            \n                            .put(version, handler);\n          \n          \n            \n                        RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n          \n          \n            \n                            .putIfAbsent(version, handler);", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959042", "createdAt": "2020-04-25T02:44:33Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +32,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version,RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, Version version, RestRequest.Method... methods) {\n         this.path = path;\n         this.methodHandlers = new HashMap<>(methods.length);\n         for (RestRequest.Method method : methods) {\n-            methodHandlers.put(method, handler);\n+            methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n+                .put(version, handler);\n         }\n     }\n \n     /**\n      * Add a handler for an additional array of methods. Note that {@code MethodHandlers}\n      * does not allow replacing the handler for an already existing method.\n      */\n-    MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers addMethods(RestHandler handler, Version version, RestRequest.Method... methods) {\n         for (RestRequest.Method method : methods) {\n-            RestHandler existing = methodHandlers.putIfAbsent(method, handler);\n+            RestHandler existing = methodHandlers.computeIfAbsent(method, k -> new HashMap<>())\n+                .put(version, handler);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc3MjU3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NTozMFrOGLvGSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NTozMFrOGLvGSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTE3Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    if(versionToHandlers == null){\n          \n          \n            \n                    if (versionToHandlers == null) {", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959177", "createdAt": "2020-04-25T02:45:30Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?\n+     *\n+     * @param method a REST method under which a handler was registered\n+     * @param version a Version under which a handler was registered\n+     * @return a handler\n      */\n     @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+\n+        if(versionToHandlers == null){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 62}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc3NTEwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NzowN1rOGLvHWw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo0NzowN1rOGLvHWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk1OTQ1MQ==", "bodyText": "IMO if you request V7 compatibility mode but the API doesn't exist in V7 then this should be a bad request (HTTP 400)", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414959451", "createdAt": "2020-04-25T02:47:07Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc4MTI1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo1MTozMlrOGLvKDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNzo0OTowN1rOGMVfAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDE0MQ==", "bodyText": "Is it ever valid for an entry in the map to have a null handler? I would think not so this could be simplified to:\nfinal RestHandler handler = versionToHandlers.get(version);\nreturn handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960141", "createdAt": "2020-04-25T02:51:32Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?\n+     *\n+     * @param method a REST method under which a handler was registered\n+     * @param version a Version under which a handler was registered\n+     * @return a handler\n      */\n     @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+\n+        if(versionToHandlers == null){\n+            return null;\n+        }\n+        if (versionToHandlers.containsKey(version)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 65}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU4ODA5OQ==", "bodyText": "agree - I don't expect null values in versionToHandlers map. Will apply the suggestion", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415588099", "createdAt": "2020-04-27T07:49:07Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +59,29 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Return a handler for a given method and a version\n+     * If a handler for a given version is not found, the handler for Version.CURRENT is returned.\n+     * We only expect Version.CURRENT or Version.CURRENT -1. This is validated.\n+     *\n+     * Handlers can be registered under the same path and method, but will require to have different versions (CURRENT or CURRENT-1)\n+     *\n+     * //todo What if a handler was added in V8 but was not present in V7?\n+     *\n+     * @param method a REST method under which a handler was registered\n+     * @param version a Version under which a handler was registered\n+     * @return a handler\n      */\n     @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+\n+        if(versionToHandlers == null){\n+            return null;\n+        }\n+        if (versionToHandlers.containsKey(version)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDE0MQ=="}, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 65}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc4MjMwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo1MjoyNVrOGLvKeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo1MjoyNVrOGLvKeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDI1MA==", "bodyText": "can you add javadocs?", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960250", "createdAt": "2020-04-25T02:52:25Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/RestHandler.java", "diffHunk": "@@ -89,8 +90,8 @@ default boolean allowsUnsafeBuffers() {\n         return Collections.emptyList();\n     }\n \n-    default boolean compatibilityRequired(){\n-        return false;\n+    default Version compatibleWithVersion(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3OTc4NjEyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestRequest.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yNVQwMjo1NToyMlrOGLvMHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QwNzo1NzoxM1rOGMV0mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDY3MA==", "bodyText": "This is a nit but I prefer to keep final variables grouped together and non-final member variables grouped together. This means that these two variables should be moved under httpChannel and followed by an empty line, which would separate them from httpRequest and contentConsumed", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r414960670", "createdAt": "2020-04-25T02:55:22Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/RestRequest.java", "diffHunk": "@@ -74,8 +74,8 @@\n     private HttpRequest httpRequest;\n \n     private boolean contentConsumed = false;\n-\n     private final long requestId;\n+    private final Version compatibleApiVersion;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNTU5MzYyNw==", "bodyText": "agree, I like that arrangement too", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r415593627", "createdAt": "2020-04-27T07:57:13Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/RestRequest.java", "diffHunk": "@@ -74,8 +74,8 @@\n     private HttpRequest httpRequest;\n \n     private boolean contentConsumed = false;\n-\n     private final long requestId;\n+    private final Version compatibleApiVersion;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDk2MDY3MA=="}, "originalCommit": {"oid": "a77716e7a19bccff0c07e64c651b706133f23e65"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU4ODgwNTgwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDo0Mjo1NVrOGM2z1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yN1QyMDo0Mjo1NVrOGM2z1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjEzNDEwMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        : \"REST API compatibility is only supported for version \"+Version.minimumRestCompatibilityVersion().major;\n          \n          \n            \n                        : \"REST API compatibility is only supported for version \" + Version.minimumRestCompatibilityVersion().major;", "url": "https://github.com/elastic/elasticsearch/pull/54197#discussion_r416134102", "createdAt": "2020-04-27T20:42:55Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -145,6 +145,10 @@ protected void registerWithDeprecatedHandler(RestRequest.Method method, String p\n      * @param method GET, POST, etc.\n      */\n     protected void registerHandler(RestRequest.Method method, String path, RestHandler handler) {\n+        assert Version.minimumRestCompatibilityVersion() == handler.compatibleWithVersion() ||\n+            Version.CURRENT == handler.compatibleWithVersion()\n+            : \"REST API compatibility is only supported for version \"+Version.minimumRestCompatibilityVersion().major;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e1c917100acf757a1fcacb81b6fac14d71a529e"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4088, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}