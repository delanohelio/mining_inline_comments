{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MTMyNzUx", "number": 54264, "title": "assertBusy in XPackRestIT#awaitCallApi", "bodyText": "Retries in this method were lost in #45794. This commit reinstates them.", "createdAt": "2020-03-26T12:13:13Z", "url": "https://github.com/elastic/elasticsearch/pull/54264", "merged": true, "mergeCommit": {"oid": "d14dca962bfe7d60c1649119aff93fc9cc49fd9d"}, "closed": true, "closedAt": "2020-03-26T16:15:32Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRbA2zAH2gAyMzk0MTMyNzUxOjRjMmY1MjdmYjYwYTM2MmU3YWY2MTg5NjgxOGU3ZjllZDBhYzU1Y2E=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRbJUygFqTM4MTk1MzQ3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4c2f527fb60a362e7af61896818e7f9ed0ac55ca", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c2f527fb60a362e7af61896818e7f9ed0ac55ca", "committedDate": "2020-03-26T12:11:10Z", "message": "assertBusy in XPackRestIT#awaitCallApi\n\nRetries in this method were lost in #45794. This commit reinstates them."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTUzMjYx", "url": "https://github.com/elastic/elasticsearch/pull/54264#pullrequestreview-381953261", "createdAt": "2020-03-26T12:20:10Z", "commit": {"oid": "4c2f527fb60a362e7af61896818e7f9ed0ac55ca"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoyMDoxMFrOF8EORA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMjoyMDoxMFrOF8EORA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUyODA2OA==", "bodyText": "Would it work to just do the following, since assertBusy only re-runs the block if it throws an exception?\nassertBusy(() -> {\n    // The actual method call that sends the API requests returns a Future, but we immediately\n    // call .get() on it so there's no need for this method to do any other awaiting.\n    ClientYamlTestResponse response = callApi(apiName, params, bodies, getApiCallHeaders());\n    assertEquals(HttpStatus.SC_OK, response.get().getStatusCode());\n    success.apply(response);\n});", "url": "https://github.com/elastic/elasticsearch/pull/54264#discussion_r398528068", "createdAt": "2020-03-26T12:20:10Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/src/test/java/org/elasticsearch/xpack/test/rest/XPackRestIT.java", "diffHunk": "@@ -229,11 +230,14 @@ private void awaitCallApi(String apiName,\n                               CheckedFunction<ClientYamlTestResponse, Boolean, IOException> success,\n                               Supplier<String> error) {\n         try {\n-            // The actual method call that sends the API requests returns a Future, but we immediately\n-            // call .get() on it so there's no need for this method to do any other awaiting.\n-            ClientYamlTestResponse response = callApi(apiName, params, bodies, getApiCallHeaders());\n-            assertEquals(response.getStatusCode(), HttpStatus.SC_OK);\n-            success.apply(response);\n+            final AtomicReference<ClientYamlTestResponse> response = new AtomicReference<>();\n+            assertBusy(() -> {\n+                // The actual method call that sends the API requests returns a Future, but we immediately\n+                // call .get() on it so there's no need for this method to do any other awaiting.\n+                response.set(callApi(apiName, params, bodies, getApiCallHeaders()));\n+                assertEquals(HttpStatus.SC_OK, response.get().getStatusCode());\n+            });\n+            success.apply(response.get());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c2f527fb60a362e7af61896818e7f9ed0ac55ca"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTUzNDcz", "url": "https://github.com/elastic/elasticsearch/pull/54264#pullrequestreview-381953473", "createdAt": "2020-03-26T12:20:25Z", "commit": {"oid": "4c2f527fb60a362e7af61896818e7f9ed0ac55ca"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1613, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}