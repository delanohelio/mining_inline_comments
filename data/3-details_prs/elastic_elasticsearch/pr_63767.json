{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MzA2MzEx", "number": 63767, "title": "Apply boost only once for distance_feature query", "bodyText": "Currently if distance_feature query contains boost,\nit incorrectly  gets applied twice: in AbstractQueryBuilder::toQuery and\nwe also pass this boost to Lucene's LongPoint.newDistanceFeatureQuery.\nAs a result we get incorrect scores.\nThis fixes this error to ensure that boost is applied only once.\nCloses #63691", "createdAt": "2020-10-15T18:47:32Z", "url": "https://github.com/elastic/elasticsearch/pull/63767", "merged": true, "mergeCommit": {"oid": "f42d179d4fe054330a0b266a174e8a861ca8de11"}, "closed": true, "closedAt": "2020-10-16T13:49:39Z", "author": {"login": "mayya-sharipova"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdS2R_oAH2gAyNTA0MzA2MzExOjY2NTRjNjg3OTcxY2QxMWEwYWZhNzQwODA1MGFiNTBhNzdkNDNiMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdS6GdIgFqTUwOTg2OTE2MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6654c687971cd11a0afa7408050ab50a77d43b03", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/elastic/elasticsearch/commit/6654c687971cd11a0afa7408050ab50a77d43b03", "committedDate": "2020-10-15T18:42:24Z", "message": "Apply boost only once for distance_feature query\n\nCurrently if distance_feature query contains boost,\nit incorrectly  gets applied twice: in AbstractQueryBuilder::toQuery and\nwe also pass this boost to Lucene's LongPoint.newDistanceFeatureQuery.\nAs a result we get incorrect scores.\n\nThis fixes this error to ensure that boost is applied only once.\n\nCloses #63691"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5Njg1Njg2", "url": "https://github.com/elastic/elasticsearch/pull/63767#pullrequestreview-509685686", "createdAt": "2020-10-15T19:06:17Z", "commit": {"oid": "6654c687971cd11a0afa7408050ab50a77d43b03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NzA4MzEy", "url": "https://github.com/elastic/elasticsearch/pull/63767#pullrequestreview-509708312", "createdAt": "2020-10-15T19:39:20Z", "commit": {"oid": "6654c687971cd11a0afa7408050ab50a77d43b03"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTozOToyMVrOHiXKxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxOTo0MTo0N1rOHiXQwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5MzIyMg==", "bodyText": "When we fix LongScriptFieldDistanceFeatureQuery, I think we could remove the boost parameter altogether from MappedFieldType#distanceFeatureQuery ?", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505793222", "createdAt": "2020-10-15T19:39:21Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/DistanceFeatureQueryBuilder.java", "diffHunk": "@@ -112,7 +112,8 @@ protected Query doToQuery(QueryShardContext context) throws IOException {\n         if (fieldType == null) {\n             return Queries.newMatchNoDocsQuery(\"Can't run [\" + NAME + \"] query on unmapped fields!\");\n         }\n-        return fieldType.distanceFeatureQuery(origin.origin(), pivot, boost, context);\n+        // As we already apply boost in AbstractQueryBuilder::toQuery, we always passing a boost of 1.0 to distanceFeatureQuery\n+        return fieldType.distanceFeatureQuery(origin.origin(), pivot, 1.0f, context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6654c687971cd11a0afa7408050ab50a77d43b03"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTc5NDc1Mw==", "bodyText": "It would be nice to rely on unit tests like DistanceFeatureQueryBuilderTests or a REST test instead of an integration test. We try to avoid new ESIntegTestCase cases unless a full cluster is really needed.", "url": "https://github.com/elastic/elasticsearch/pull/63767#discussion_r505794753", "createdAt": "2020-10-15T19:41:47Z", "author": {"login": "jtibshirani"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/query/SearchQueryIT.java", "diffHunk": "@@ -1626,6 +1627,33 @@ public void testRangeQueryWithLocaleMapping() throws Exception {\n         assertHitCount(searchResponse, 2L);\n     }\n \n+    public void testDistanceFeatureQuery() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6654c687971cd11a0afa7408050ab50a77d43b03"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5", "committedDate": "2020-10-15T20:48:00Z", "message": "Remove test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5ODY5MTYw", "url": "https://github.com/elastic/elasticsearch/pull/63767#pullrequestreview-509869160", "createdAt": "2020-10-15T23:09:25Z", "commit": {"oid": "7cbe160ec5a325ae69bfb6cf1aac07d42658d8d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4027, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}