{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NTcwNTc4", "number": 62535, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzo0NjoxNVrOEki4lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzo0NjoxNVrOEki4lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2NzU1NzMyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxMzo0NjoxNVrOHTjBQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxODoyMTowMlrOHTvnyw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg==", "bodyText": "thanks for writing this test. One point is, there is no need to go to _source to get this field as it's indexed as keyword and has doc_values. The most appropriate way to do this would then be emit(doc['airline'].toLowerCase())\nI care about it because _source is available for runtime fields, yet it is still not the recommended way to retrieve values, which we plan to address over time.", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490258752", "createdAt": "2020-09-17T13:46:15Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDM1NzYwMw==", "bodyText": "What you can't see in the diff is that airline is actually a text multi field with a keyword sub field\n      \"airline\" : { \n        \"type\": \"text\",\n        \"fields\": {\n          \"keyword\" : { \n            \"type\": \"keyword\"\n          }\n        }\n      },\n\nBut I do see the sense in what you're suggesting so I changed the script to:\nemit(doc['airline.keyword'].toLowerCase())\nUnfortunately that failed with the error\n          \"caused_by\" : {\n            \"type\" : \"illegal_argument_exception\",\n            \"reason\" : \"dynamic method [org.elasticsearch.index.fielddata.ScriptDocValues.Strings, toLowerCase/0] not found\"\n          }\n\nI had to put a toString() in to get it to work.\nemit(doc['airline.keyword'].toString().toLowerCase())\nIs this a regression as that example worked previously?\nUPDATE - No I am mistaken, I was trying something different previously\nBTW I'm testing this simply by asking for the docvalue_field in the search\nGET farequote/_search\n{\n  \"docvalue_fields\": [\"airline_lowercase\"]\n}", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490357603", "createdAt": "2020-09-17T15:48:14Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, "originalCommit": {"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ1ODc1Nw==", "bodyText": "nice, I thought I checked out the test data and that field was keyword, but close enough. Ping me if you notice anything when playing with runtime fields ;)", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490458757", "createdAt": "2020-09-17T18:09:22Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, "originalCommit": {"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ1OTM5MQ==", "bodyText": "I think I forgot a .value possibly? From your message I did not get if you managed to make it work after all, if not ping me and let's make sure that it works on doc_values", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490459391", "createdAt": "2020-09-17T18:10:33Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, "originalCommit": {"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQ2NTIyNw==", "bodyText": "\ud83d\udc4d it works with .value thanks", "url": "https://github.com/elastic/elasticsearch/pull/62535#discussion_r490465227", "createdAt": "2020-09-17T18:21:02Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/ml/integration/DatafeedJobsRestIT.java", "diffHunk": "@@ -128,6 +127,11 @@ private void addAirlineData() throws IOException {\n                 + \"          \\\"keyword\\\":{\\\"type\\\":\\\"keyword\\\"}\"\n                 + \"         }\"\n                 + \"       },\"\n+                + \"      \\\"airline_lowercase_rt\\\": { \"\n+                + \"        \\\"type\\\":\\\"runtime\\\",\"\n+                + \"        \\\"runtime_type\\\": \\\"keyword\\\",\"\n+                + \"        \\\"script\\\" : { \\\"source\\\": \\\"emit(params._source.airline.toLowerCase())\\\" }\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI1ODc1Mg=="}, "originalCommit": {"oid": "87408aa7f302edce7302d1b13af06943c7db0bc2"}, "originalPosition": 15}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3538, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}