{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDUxNjM2MDQ3", "number": 59821, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMjozMToxNlrOEPt-nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODozNTo0M1rOERK6Dg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTE3NDA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/common/CartesianPoint.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMjozMToxNlrOGzlFCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMjoyOToxMFrOG0hd6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODA1OQ==", "bodyText": "Without this change, coordinates could change unexpectedly in a roundtrip like WKT -> CartesianPoint -> WKT. It seems common to represent points using doubles even though they're indexed as floats -- for example the Point geometry uses doubles.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r456738059", "createdAt": "2020-07-18T02:31:16Z", "author": {"login": "jtibshirani"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/common/CartesianPoint.java", "diffHunk": "@@ -36,18 +37,18 @@\n     private static final ParseField Y_FIELD = new ParseField(\"y\");\n     private static final ParseField Z_FIELD = new ParseField(\"z\");\n \n-    protected float x;\n-    protected float y;\n+    protected double x;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcyNzQ2NA==", "bodyText": "good Point. I do not see a problem with this. maybe @nknize has an opinion here", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457727464", "createdAt": "2020-07-20T22:29:10Z", "author": {"login": "talevy"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/common/CartesianPoint.java", "diffHunk": "@@ -36,18 +37,18 @@\n     private static final ParseField Y_FIELD = new ParseField(\"y\");\n     private static final ParseField Z_FIELD = new ParseField(\"z\");\n \n-    protected float x;\n-    protected float y;\n+    protected double x;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODA1OQ=="}, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg0OTE4MTQ4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xOFQwMjo0MjoyMlrOGzlItg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzoxOTo0MFrOG1CG0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODk5OA==", "bodyText": "This seemed like the easiest way to integrate with the existing logic but is far from ideal:\n\nWe perform parsing even when it's not necessary: even when the geometry is already in the right format, we still parse it to an object re-serialize it.\nWe also awkwardly translate between maps and xContent.\n\nLet me know if you have suggestions around a better approach. Overall I was hoping to keep this PR reasonably scoped, since it is part of a large 'field retrieval' change that already has a few moving parts. But we could plan a larger refactor in a separate/ follow-up change.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r456738998", "createdAt": "2020-07-18T02:42:22Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -143,7 +153,31 @@ public Builder ignoreZValue(final boolean ignoreZValue) {\n \n     @Override\n     protected Object parseSourceValue(Object value, String format) {\n-        throw new UnsupportedOperationException();\n+        AbstractGeometryFieldType<Parsed, Processed> mappedFieldType = fieldType();\n+        Parser<Parsed> geometryParser = mappedFieldType.geometryParser();\n+        Formatter<Parsed> geometryFormatter = mappedFieldType.geometryFormatter();\n+\n+        Parsed geometry;\n+        try (XContentParser parser = new MapXContentParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3MTU5OA==", "bodyText": "This is pretty yikes, but I do like the idea of keeping the work contained on the branch and doing a larger refactoring after merging. Maybe it'd be cleaner to push the ability to parse these fields into SourceLookup. That way we don't need to do the xcontent -> map -> xcontent dance.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457371598", "createdAt": "2020-07-20T13:15:25Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -143,7 +153,31 @@ public Builder ignoreZValue(final boolean ignoreZValue) {\n \n     @Override\n     protected Object parseSourceValue(Object value, String format) {\n-        throw new UnsupportedOperationException();\n+        AbstractGeometryFieldType<Parsed, Processed> mappedFieldType = fieldType();\n+        Parser<Parsed> geometryParser = mappedFieldType.geometryParser();\n+        Formatter<Parsed> geometryFormatter = mappedFieldType.geometryFormatter();\n+\n+        Parsed geometry;\n+        try (XContentParser parser = new MapXContentParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODk5OA=="}, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcyNjI3OQ==", "bodyText": "would it make sense to specialize between points and shapes? At least for Shapes, we should be able to tell whether value is an object or a string, right?", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457726279", "createdAt": "2020-07-20T22:25:50Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -143,7 +153,31 @@ public Builder ignoreZValue(final boolean ignoreZValue) {\n \n     @Override\n     protected Object parseSourceValue(Object value, String format) {\n-        throw new UnsupportedOperationException();\n+        AbstractGeometryFieldType<Parsed, Processed> mappedFieldType = fieldType();\n+        Parser<Parsed> geometryParser = mappedFieldType.geometryParser();\n+        Formatter<Parsed> geometryFormatter = mappedFieldType.geometryFormatter();\n+\n+        Parsed geometry;\n+        try (XContentParser parser = new MapXContentParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODk5OA=="}, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2MjIyNQ==", "bodyText": "Maybe it'd be cleaner to push the ability to parse these fields into SourceLookup\n\nI think this would be challenging given the current design of SourceLookup, since it is operates only on the level of xContent and is completely agnostic to the mappings. It would be nice though if SourceLookup could provide direct access to the xContent representation instead of always parsing + returning generic objects. This feels like a bigger change that's better suited for a follow-up though?\n\nAt least for Shapes, we should be able to tell whether value is an object or a string, right?\n\nThis would work, I'll look into it further! I'm inclined to not worry about it though if it makes the design more complicated (specifically splitting points vs. shapes handling).", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r458262225", "createdAt": "2020-07-21T17:19:40Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -143,7 +153,31 @@ public Builder ignoreZValue(final boolean ignoreZValue) {\n \n     @Override\n     protected Object parseSourceValue(Object value, String format) {\n-        throw new UnsupportedOperationException();\n+        AbstractGeometryFieldType<Parsed, Processed> mappedFieldType = fieldType();\n+        Parser<Parsed> geometryParser = mappedFieldType.geometryParser();\n+        Formatter<Parsed> geometryFormatter = mappedFieldType.geometryFormatter();\n+\n+        Parsed geometry;\n+        try (XContentParser parser = new MapXContentParser(NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NjczODk5OA=="}, "originalCommit": {"oid": "28ddcc3614fce0f5501bf1b44f5f4895a158b2a7"}, "originalPosition": 44}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mzg5MDk2OnYy", "diffSide": "RIGHT", "path": "docs/reference/mapping/types.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzowODowMFrOG0LZ1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMDo1MjowOFrOG0e17A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2NTk3Mg==", "bodyText": "The leading _ is usually an indicator that this was an automatically generated anchor id. Unless you are replacing one that is auto-generated I'd avoid it.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457365972", "createdAt": "2020-07-20T13:08:00Z", "author": {"login": "nik9000"}, "path": "docs/reference/mapping/types.asciidoc", "diffHunk": "@@ -22,6 +22,7 @@ string::         <<text,`text`>>, <<keyword,`keyword`>> and <<wildcard,`wildcard\n <<nested>>::    `nested` for arrays of JSON objects\n \n [float]\n+[[_spatial_datatypes]]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c5a260b52ee83866c0bd2974dcfec364325171"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzY4NDQ2MA==", "bodyText": "\ud83d\udc4d  will remove the underscore. Note that 'spatial' naming is based on this PR, where I propose grouping all the spatial types into one section: #59731.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457684460", "createdAt": "2020-07-20T20:52:08Z", "author": {"login": "jtibshirani"}, "path": "docs/reference/mapping/types.asciidoc", "diffHunk": "@@ -22,6 +22,7 @@ string::         <<text,`text`>>, <<keyword,`keyword`>> and <<wildcard,`wildcard\n <<nested>>::    `nested` for arrays of JSON objects\n \n [float]\n+[[_spatial_datatypes]]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM2NTk3Mg=="}, "originalCommit": {"oid": "58c5a260b52ee83866c0bd2974dcfec364325171"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1Mzk0MzM2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJson.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQxMzoxODoxMFrOG0L3sw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxNzoyMzowMVrOG1COrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3MzYxOQ==", "bodyText": "Probably worth javadoc. I was confused by the method name because I usually think of map and xcontent as mutually exclusive representations.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457373619", "createdAt": "2020-07-20T13:18:10Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJson.java", "diffHunk": "@@ -610,4 +617,14 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         }\n     }\n \n+    public static Map<?, ?> toXContentMap(Geometry geometry) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "58c5a260b52ee83866c0bd2974dcfec364325171"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzczMDgyNg==", "bodyText": "also, XContent here is just an implementation detail. it is a normal Map, right?", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457730826", "createdAt": "2020-07-20T22:38:15Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJson.java", "diffHunk": "@@ -610,4 +617,14 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         }\n     }\n \n+    public static Map<?, ?> toXContentMap(Geometry geometry) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3MzYxOQ=="}, "originalCommit": {"oid": "58c5a260b52ee83866c0bd2974dcfec364325171"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODI2NDIzOA==", "bodyText": "I will clean this up. Here I was using toXContentMap to mean 'return the JSON representation of the geometry as a Java map'. But I see how this is confusing given there's already a toXContent method ...", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r458264238", "createdAt": "2020-07-21T17:23:01Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJson.java", "diffHunk": "@@ -610,4 +617,14 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n         }\n     }\n \n+    public static Map<?, ?> toXContentMap(Geometry geometry) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzM3MzYxOQ=="}, "originalCommit": {"oid": "58c5a260b52ee83866c0bd2974dcfec364325171"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg1NjI0OTE0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMjoyNjo1OVrOG0ha3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMFQyMjoyNjo1OVrOG0ha3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NzcyNjY4NQ==", "bodyText": "should we add some javadoc for this?", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r457726685", "createdAt": "2020-07-20T22:26:59Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/AbstractGeometryFieldMapper.java", "diffHunk": "@@ -82,6 +87,11 @@\n         Parsed parse(XContentParser parser, AbstractGeometryFieldMapper mapper) throws IOException, ParseException;\n     }\n \n+    public interface Formatter<Parsed> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3bb216a749fae997593685c15513d4c4c2f79e1c"}, "originalPosition": 26}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDM4MzE3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJsonGeometryFormat.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODozMToyOFrOG1vFCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODo0Nzo0MFrOG1vqvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5OTA0OQ==", "bodyText": "Maybe return Object here as well for consistency. I don't think the fact that it returns Map is significant here.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r458999049", "createdAt": "2020-07-22T18:31:28Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJsonGeometryFormat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common.geo;\n+\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.geometry.Geometry;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+public class GeoJsonGeometryFormat implements GeometryFormat<Geometry> {\n+    public static final String NAME = \"geojson\";\n+\n+    private final GeoJson geoJsonParser;\n+\n+    public GeoJsonGeometryFormat(GeoJson geoJsonParser) {\n+        this.geoJsonParser = geoJsonParser;\n+    }\n+\n+    @Override\n+    public String name() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Geometry fromXContent(XContentParser parser) throws IOException {\n+        if (parser.currentToken() == XContentParser.Token.VALUE_NULL) {\n+            return null;\n+        }\n+        return geoJsonParser.fromXContent(parser);\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(Geometry geometry, XContentBuilder builder, ToXContent.Params params) throws IOException {\n+        if (geometry != null) {\n+            return GeoJson.toXContent(geometry, builder, params);\n+        } else {\n+            return builder.nullValue();\n+        }\n+    }\n+\n+    @Override\n+    public Map<?, ?> toObject(Geometry geometry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwODcwMw==", "bodyText": "I sometimes like using covariance like this to clarify that a subclass always returns a specific type. I don't feel strongly about it though, happy to change it. We can always change it back later if we find it helpful for unit testing, etc. to have the exact type.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r459008703", "createdAt": "2020-07-22T18:47:40Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeoJsonGeometryFormat.java", "diffHunk": "@@ -0,0 +1,83 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common.geo;\n+\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.xcontent.LoggingDeprecationHandler;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.common.xcontent.XContentType;\n+import org.elasticsearch.geometry.Geometry;\n+\n+import java.io.IOException;\n+import java.io.UncheckedIOException;\n+import java.util.Map;\n+\n+public class GeoJsonGeometryFormat implements GeometryFormat<Geometry> {\n+    public static final String NAME = \"geojson\";\n+\n+    private final GeoJson geoJsonParser;\n+\n+    public GeoJsonGeometryFormat(GeoJson geoJsonParser) {\n+        this.geoJsonParser = geoJsonParser;\n+    }\n+\n+    @Override\n+    public String name() {\n+        return NAME;\n+    }\n+\n+    @Override\n+    public Geometry fromXContent(XContentParser parser) throws IOException {\n+        if (parser.currentToken() == XContentParser.Token.VALUE_NULL) {\n+            return null;\n+        }\n+        return geoJsonParser.fromXContent(parser);\n+    }\n+\n+    @Override\n+    public XContentBuilder toXContent(Geometry geometry, XContentBuilder builder, ToXContent.Params params) throws IOException {\n+        if (geometry != null) {\n+            return GeoJson.toXContent(geometry, builder, params);\n+        } else {\n+            return builder.nullValue();\n+        }\n+    }\n+\n+    @Override\n+    public Map<?, ?> toObject(Geometry geometry) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5OTA0OQ=="}, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg2NDM5OTUwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/geo/GeometryFormat.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODozNTo0M1rOG1vPTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxOTowMToyOFrOG1wKkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTY3OQ==", "bodyText": "I wonder if somebody can come up with a better name here :) maybe to toXContentObject() or toXConentValue() or something like this. I feel like toObject is misleadingly generic here.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r459001679", "createdAt": "2020-07-22T18:35:43Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeometryFormat.java", "diffHunk": "@@ -41,4 +46,10 @@\n      */\n     XContentBuilder toXContent(ParsedFormat geometry, XContentBuilder builder, ToXContent.Params params) throws IOException;\n \n+    /**\n+     * Serializes the geometry into a standard Java object.\n+     *\n+     * For example, the GeoJson format returns the geometry as a map, while WKT returns a string.\n+     */\n+    Object toObject(ParsedFormat geometry);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxMDY0NQ==", "bodyText": "I previously had a method called toXContentMap that @talevy and @nik9000 found confusing, because we often refer to xContent and maps as distinct representations. Perhaps a name like toXContentAsObject could work?", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r459010645", "createdAt": "2020-07-22T18:50:48Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeometryFormat.java", "diffHunk": "@@ -41,4 +46,10 @@\n      */\n     XContentBuilder toXContent(ParsedFormat geometry, XContentBuilder builder, ToXContent.Params params) throws IOException;\n \n+    /**\n+     * Serializes the geometry into a standard Java object.\n+     *\n+     * For example, the GeoJson format returns the geometry as a map, while WKT returns a string.\n+     */\n+    Object toObject(ParsedFormat geometry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTY3OQ=="}, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNTAwNw==", "bodyText": "haha, oi. since there are javadocs explaining it now, I drop my naming argument. I'm good with whatever sounds good to you!", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r459015007", "createdAt": "2020-07-22T18:58:17Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeometryFormat.java", "diffHunk": "@@ -41,4 +46,10 @@\n      */\n     XContentBuilder toXContent(ParsedFormat geometry, XContentBuilder builder, ToXContent.Params params) throws IOException;\n \n+    /**\n+     * Serializes the geometry into a standard Java object.\n+     *\n+     * For example, the GeoJson format returns the geometry as a map, while WKT returns a string.\n+     */\n+    Object toObject(ParsedFormat geometry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTY3OQ=="}, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAxNjg1MQ==", "bodyText": "I cannot say I love toXContentAsObject but I like it the best comparing to all other versions.", "url": "https://github.com/elastic/elasticsearch/pull/59821#discussion_r459016851", "createdAt": "2020-07-22T19:01:28Z", "author": {"login": "imotov"}, "path": "server/src/main/java/org/elasticsearch/common/geo/GeometryFormat.java", "diffHunk": "@@ -41,4 +46,10 @@\n      */\n     XContentBuilder toXContent(ParsedFormat geometry, XContentBuilder builder, ToXContent.Params params) throws IOException;\n \n+    /**\n+     * Serializes the geometry into a standard Java object.\n+     *\n+     * For example, the GeoJson format returns the geometry as a map, while WKT returns a string.\n+     */\n+    Object toObject(ParsedFormat geometry);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1OTAwMTY3OQ=="}, "originalCommit": {"oid": "d3d62820221c7c0c65f2aad2eca705de26d50a91"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2217, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}