{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg3MzMyMjYy", "number": 53492, "title": "Add file type-based exclusion setting for searchable snapshots cache", "bodyText": "Allows configuring searchable snapshots to avoid caching certain types of files, for example \"fdt\" files for stored fields.", "createdAt": "2020-03-12T16:08:59Z", "url": "https://github.com/elastic/elasticsearch/pull/53492", "merged": true, "mergeCommit": {"oid": "e669f142470dcfb2093315665869de8e52912c34"}, "closed": true, "closedAt": "2020-03-27T15:32:37Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 19, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcM98iFAH2gAyMzg3MzMyMjYyOjgwN2I1MjRlMWI3NmUyOGI3YzcwMjUzY2ViMTEwZmQxODMzNDZkMjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRx6cpgFqTM4MjkyOTUxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "807b524e1b76e28b7c70253ceb110fd183346d22", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/807b524e1b76e28b7c70253ceb110fd183346d22", "committedDate": "2020-03-12T16:03:30Z", "message": "Add cache blacklist setting\n\nAllows for example to configure searchable snapshots to avoid caching certain types of files, for example stored fields."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af16ba55578428f04030d8d59dbcc74b7dcfeb89", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/af16ba55578428f04030d8d59dbcc74b7dcfeb89", "committedDate": "2020-03-13T08:31:38Z", "message": "Merge branch 'feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fe97a41fd86852492c52f664186accc13015bdc", "committedDate": "2020-03-13T08:32:18Z", "message": "Fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MTYwNDE1", "url": "https://github.com/elastic/elasticsearch/pull/53492#pullrequestreview-374160415", "createdAt": "2020-03-13T09:38:21Z", "commit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTozODoyMVrOF19Hjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xM1QwOTo1MDowNFrOF19eCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyMDIwNg==", "bodyText": "I don't think we need to pass all the index settings here, maybe just the black list?", "url": "https://github.com/elastic/elasticsearch/pull/53492#discussion_r392120206", "createdAt": "2020-03-13T09:38:21Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotDirectory.java", "diffHunk": "@@ -170,7 +174,7 @@ public static Directory create(RepositoriesService repositories,\n         if (SNAPSHOT_CACHE_ENABLED_SETTING.get(indexSettings.getSettings())) {\n             final Path cacheDir = shardPath.getDataPath().resolve(\"snapshots\").resolve(snapshotId.getUUID());\n             directory = new CacheDirectory(directory, cache, cacheDir, snapshotId, indexId, shardPath.getShardId(),\n-                currentTimeNanosSupplier);\n+                indexSettings.getSettings(), currentTimeNanosSupplier);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNDk5NA==", "bodyText": "Let's just use IndexFileNames.getExtension() and in case of no extension always cache if name.startsWith(IndexFileNames.SEGMENTS) || name.equals(IndexFileNames.OLD_SEGMENTS_GEN) ?", "url": "https://github.com/elastic/elasticsearch/pull/53492#discussion_r392124994", "createdAt": "2020-03-13T09:48:08Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheDirectory.java", "diffHunk": "@@ -383,4 +396,17 @@ private static boolean assertFileChannelOpen(FileChannel fileChannel) {\n         assert fileChannel.isOpen();\n         return true;\n     }\n+\n+    private static String getExtension(String name) {\n+        int i = name.lastIndexOf('.');\n+        if (i == -1) {\n+            return \"\";\n+        }\n+        return name.substring(i + 1);\n+    }\n+\n+    private boolean isBlackListedFromCache(String name) {\n+        String ext = getExtension(name);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc"}, "originalPosition": 97}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNTMxNA==", "bodyText": "Can we remove .cfs from this list?", "url": "https://github.com/elastic/elasticsearch/pull/53492#discussion_r392125314", "createdAt": "2020-03-13T09:48:47Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -122,12 +123,19 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         final boolean cacheEnabled = randomBoolean();\n         logger.info(\"--> restoring index [{}] with cache [{}]\", restoredIndexName, cacheEnabled ? \"enabled\" : \"disabled\");\n \n+        Settings.Builder indexSettingsBuilder = Settings.builder()\n+            .put(SearchableSnapshots.SNAPSHOT_CACHE_ENABLED_SETTING.getKey(), cacheEnabled)\n+            .put(IndexSettings.INDEX_CHECK_ON_STARTUP.getKey(), Boolean.FALSE.toString());\n+        final List<String> nonCachedExtensions;\n+        if (randomBoolean()) {\n+            nonCachedExtensions = randomSubsetOf(Arrays.asList(\"fdt\", \"fdx\", \"nvd\", \"dvd\", \"tip\", \"cfs\", \"dim\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MjEyNTk2MA==", "bodyText": "@DaveCTurner might have an opinion on this value", "url": "https://github.com/elastic/elasticsearch/pull/53492#discussion_r392125960", "createdAt": "2020-03-13T09:50:04Z", "author": {"login": "tlrx"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java", "diffHunk": "@@ -105,9 +105,13 @@ public InputStream readBlob(String blobName, long position, long length) throws\n     }\n \n     @Override\n-    public long readBlobPreferredLength() {\n+    public long readBlobPreferredLength(boolean cachedRead) {\n         // This container returns streams that must be fully consumed, so we tell consumers to make bounded requests.\n-        return new ByteSizeValue(32, ByteSizeUnit.MB).getBytes();\n+        if (cachedRead) {\n+            return new ByteSizeValue(32, ByteSizeUnit.MB).getBytes();\n+        } else {\n+            return new ByteSizeValue(512, ByteSizeUnit.KB).getBytes();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6fe97a41fd86852492c52f664186accc13015bdc"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2c5489c225f62ba751166c5c0d186fa19140bda", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2c5489c225f62ba751166c5c0d186fa19140bda", "committedDate": "2020-03-13T10:19:36Z", "message": "Use IndexFileNames.getExtension"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d840f0570826b3576febc98e02fd1b1c2f8f5df4", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/d840f0570826b3576febc98e02fd1b1c2f8f5df4", "committedDate": "2020-03-24T15:01:34Z", "message": "Merge remote-tracking branch 'elastic/feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bd379da4e97476c509fc78cb438c13b4a7eeb71", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bd379da4e97476c509fc78cb438c13b4a7eeb71", "committedDate": "2020-03-25T12:19:05Z", "message": "Merge remote-tracking branch 'elastic/feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d377e40d392fb58730991f670ee6f8fd3a139614", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/d377e40d392fb58730991f670ee6f8fd3a139614", "committedDate": "2020-03-27T09:25:26Z", "message": "Merge remote-tracking branch 'elastic/feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d44edec858d1d3f6086d6da58502d34199c3cf41", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/d44edec858d1d3f6086d6da58502d34199c3cf41", "committedDate": "2020-03-27T09:34:43Z", "message": "change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b8e96260a87a21e834d1aad3bb75914e72881e3", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b8e96260a87a21e834d1aad3bb75914e72881e3", "committedDate": "2020-03-27T09:51:09Z", "message": "undo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01a4070b27be303c894a79996c21cd81e92dd94f", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/01a4070b27be303c894a79996c21cd81e92dd94f", "committedDate": "2020-03-27T10:07:47Z", "message": "IDE misconfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e85c68c22ea8ba6747d5e7b48fdca28f0af84433", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/e85c68c22ea8ba6747d5e7b48fdca28f0af84433", "committedDate": "2020-03-27T10:11:31Z", "message": "ALso test new setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25e073ff6f2b9e592e6d651893b8ba4d7fb6289d", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/25e073ff6f2b9e592e6d651893b8ba4d7fb6289d", "committedDate": "2020-03-27T10:19:44Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ff7720eff65f839551b238126788885dfa1d4a5", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ff7720eff65f839551b238126788885dfa1d4a5", "committedDate": "2020-03-27T12:33:02Z", "message": "Merge remote-tracking branch 'elastic/feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8099afd1913838859e829bcdcf29e892cf836d0d", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/8099afd1913838859e829bcdcf29e892cf836d0d", "committedDate": "2020-03-27T13:33:02Z", "message": "Merge branch 'feature/searchable-snapshots' into snapshot-cache-blacklist"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyODYzOTYz", "url": "https://github.com/elastic/elasticsearch/pull/53492#pullrequestreview-382863963", "createdAt": "2020-03-27T13:38:39Z", "commit": {"oid": "8099afd1913838859e829bcdcf29e892cf836d0d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad6ed407047e5290f3b60590ba0dd0a516dc45bd", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad6ed407047e5290f3b60590ba0dd0a516dc45bd", "committedDate": "2020-03-27T14:49:39Z", "message": "Political correctness"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa0246badac6ec949b6bd0ff6fd3fb2896cde383", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa0246badac6ec949b6bd0ff6fd3fb2896cde383", "committedDate": "2020-03-27T14:51:03Z", "message": "forgot one"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyOTI5NTE4", "url": "https://github.com/elastic/elasticsearch/pull/53492#pullrequestreview-382929518", "createdAt": "2020-03-27T14:51:59Z", "commit": {"oid": "aa0246badac6ec949b6bd0ff6fd3fb2896cde383"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1568, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}