{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc2NzUzNzU2", "number": 52486, "title": "Generalize how queries on `_index` are handled at rewrite time", "bodyText": "#49713 aims at introducing a new constant_keyword field which, like _index, always rewrites queries to a MatchAllQueryBuilder or a MatchNoneQueryBuilder in order to skip shards in the can_match phase. This change introduces a new ConstantFieldType marker class that helps get this functionality with any field and not just _index.\nSince this change refactors rewrites, I also took it as an opportunity to adrress #49254: instead of returning the same queries you would get on a keyword field when a field is unmapped, queries get rewritten to a MatchNoDocsQueryBuilder.\nThis change exposed a couple bugs, like the fact that the percolator doesn't rewrite queries at query time, or that the significant_terms aggregation doesn't rewrite its inner filter, which I fixed.\nCloses #49254", "createdAt": "2020-02-18T17:51:05Z", "url": "https://github.com/elastic/elasticsearch/pull/52486", "merged": true, "mergeCommit": {"oid": "8830eb6b9a8da0202806791f29f049b764ad19af"}, "closed": true, "closedAt": "2020-02-26T09:25:39Z", "author": {"login": "jpountz"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABbrak99gH2gAyMzc2NzUzNzU2OmRiMWEwNzk4MmJkNmNkZGNjMGZiYzBjMGQ2NTgzZDBkM2EzNzRjNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcICXY5AH2gAyMzc2NzUzNzU2OjJiMDA3NTFmNTQ1NGNmODliYzRiM2VlZDZiMzllOWFlYmExOWE3ZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "db1a07982bd6cddcc0fbc0c0d6583d0d3a374c76", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/db1a07982bd6cddcc0fbc0c0d6583d0d3a374c76", "committedDate": "2019-11-29T10:11:35Z", "message": "Introduce a `singleton_keyword` field.\n\nThis field is a specialization of the `keyword` field for the case when all\ndocuments have the same value. It typically performs more efficiently than\nkeywords at query time by figuring out whether all or none of the documents\nmatch at rewrite time, like `term` queries on `_index`.\n\nThe name is up for discussion. I liked including `keyword` in it, so that we\nstill have room for a `singleton_numeric` in the future. However I'm unsure\nwhether to call it `singleton`, `constant` or something else, any opinions?\n\nFor this field there is a choice between\n 1. accepting values in `_source` when they are equal to the value configured\n    in mappings, but rejecting mapping updates\n 2. rejecting values in `_source` but then allowing updates to the value that\n    is configured in the mapping\nThis commit implements option 1, so that it is possible to reindex from/to an\nindex that has the field mapped as a keyword with no changes to the source."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c253ce758841a9561b4a002bca95bfce2d3aa078", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/c253ce758841a9561b4a002bca95bfce2d3aa078", "committedDate": "2019-11-29T15:19:19Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abf27f1e4d558e6919491b77cb6505636c7499ab", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/abf27f1e4d558e6919491b77cb6505636c7499ab", "committedDate": "2019-11-29T15:24:52Z", "message": "Rename to `constant_keyword`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "002fe968f83805672d52a749616942ec446a5519", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/002fe968f83805672d52a749616942ec446a5519", "committedDate": "2019-11-29T15:40:10Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6738d80cd2287d80f39924b2e3f10bdd6373be5", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6738d80cd2287d80f39924b2e3f10bdd6373be5", "committedDate": "2019-11-29T15:58:28Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b7b894e01025bd1cf94fe15be68d122eb663c47c", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7b894e01025bd1cf94fe15be68d122eb663c47c", "committedDate": "2019-11-29T16:25:08Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5f288e748a891e2e95f57b95dffc4fbfeb1ab93", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5f288e748a891e2e95f57b95dffc4fbfeb1ab93", "committedDate": "2019-11-29T16:25:31Z", "message": "Merge branch 'master' into feature/singleton_keyword_field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a86ad8a82c0d67e440dcf0f9b5eb0cf7c7255ef9", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/a86ad8a82c0d67e440dcf0f9b5eb0cf7c7255ef9", "committedDate": "2019-11-29T17:08:20Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5949d6f38479875ef7594ecdaa07516a096f593", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5949d6f38479875ef7594ecdaa07516a096f593", "committedDate": "2019-12-02T09:25:40Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9c43aa038e76d893a25538bc6d7ea98eeae51ac", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9c43aa038e76d893a25538bc6d7ea98eeae51ac", "committedDate": "2019-12-02T09:56:38Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6b907c25df8f04c8cfeb8fc0fef1f2a36bdc8585", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/6b907c25df8f04c8cfeb8fc0fef1f2a36bdc8585", "committedDate": "2019-12-02T12:57:44Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "779d128d8198cf50b4cb9447e709b7a582ac1071", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/779d128d8198cf50b4cb9447e709b7a582ac1071", "committedDate": "2019-12-02T13:30:25Z", "message": "unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51dc11889ea74d3b267633456e046d70354ebe68", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/51dc11889ea74d3b267633456e046d70354ebe68", "committedDate": "2019-12-02T13:36:45Z", "message": "add javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8da5b6c4a43ca5edc100d47edbf4a05bbbaac4cb", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/8da5b6c4a43ca5edc100d47edbf4a05bbbaac4cb", "committedDate": "2019-12-02T15:24:22Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af4a55a32a0f029ce35a7ebe3252ddf458ac8d88", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/af4a55a32a0f029ce35a7ebe3252ddf458ac8d88", "committedDate": "2019-12-03T17:31:20Z", "message": "Merge branch 'master' into feature/singleton_keyword_field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1b71f4e96c2f8cd533c116c483acf9a33eefee1", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1b71f4e96c2f8cd533c116c483acf9a33eefee1", "committedDate": "2019-12-03T19:31:30Z", "message": "More docs."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f8ddbf7182b3540d79a1b97794a0d4c6ca728089", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8ddbf7182b3540d79a1b97794a0d4c6ca728089", "committedDate": "2020-01-08T14:41:58Z", "message": "Merge branch 'master' into feature/singleton_keyword_field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d34630320d23b1269ec2270c229c13450f92ead8", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/d34630320d23b1269ec2270c229c13450f92ead8", "committedDate": "2020-01-10T13:57:46Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c378cdf35c386d03da63875e301728386cd734fd", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/c378cdf35c386d03da63875e301728386cd734fd", "committedDate": "2020-01-10T17:46:32Z", "message": "Fix failures."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59fd6b094ef7ebdc8be50b54e52459d0a1f32a86", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/59fd6b094ef7ebdc8be50b54e52459d0a1f32a86", "committedDate": "2020-02-14T17:55:15Z", "message": "Merge branch 'master' into feature/singleton_keyword_field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4592af2c57a7438d7a6afe3605cf535bd01e244f", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/4592af2c57a7438d7a6afe3605cf535bd01e244f", "committedDate": "2020-02-14T17:57:26Z", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab70f103fc67f38b5b90ebc05d76ed7d58ddfc69", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab70f103fc67f38b5b90ebc05d76ed7d58ddfc69", "committedDate": "2020-02-14T18:03:47Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b29a433cab7142cb75d0c902d4329214da77a65", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b29a433cab7142cb75d0c902d4329214da77a65", "committedDate": "2020-02-14T18:05:45Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "936f8831e113c542687f42adf3e6c8e06e30cb2c", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/936f8831e113c542687f42adf3e6c8e06e30cb2c", "committedDate": "2020-02-18T07:59:58Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a71703789c090b77bb7d7675f818df19239c77", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/44a71703789c090b77bb7d7675f818df19239c77", "committedDate": "2020-02-18T12:50:13Z", "message": "Undo renames."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7639d34f200676817906e3e3b24fec202b7e1d4d", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/7639d34f200676817906e3e3b24fec202b7e1d4d", "committedDate": "2020-02-18T16:25:00Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fba9ca3b4bb966d123afaaeddd0dbce7584950c6", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/fba9ca3b4bb966d123afaaeddd0dbce7584950c6", "committedDate": "2020-02-18T17:40:55Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a284be94000e0e8857679295454a6f0f4d04f6db", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/a284be94000e0e8857679295454a6f0f4d04f6db", "committedDate": "2020-02-19T07:47:48Z", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9a23e2c77adb3c1d0089b8bb36234d5e226d6cc", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/f9a23e2c77adb3c1d0089b8bb36234d5e226d6cc", "committedDate": "2020-02-21T08:55:26Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b312407b918f4a86e54f2567076f0932caac2024", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/b312407b918f4a86e54f2567076f0932caac2024", "committedDate": "2020-02-21T10:20:33Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "437315da0de41ac00abe5df78bfb82264355c51d", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/437315da0de41ac00abe5df78bfb82264355c51d", "committedDate": "2020-02-21T10:21:53Z", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f9493019d5c7d9aeaa7db3c73c4c21ce21e2a33", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f9493019d5c7d9aeaa7db3c73c4c21ce21e2a33", "committedDate": "2020-02-21T11:03:39Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cd5c6dad42c579e11c26f08f910caa27889d5e4", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cd5c6dad42c579e11c26f08f910caa27889d5e4", "committedDate": "2020-02-21T12:47:43Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/51f7b3c453ed6e3d234e20ce71c06fbef93b3585", "committedDate": "2020-02-21T13:28:11Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyODA5ODE3", "url": "https://github.com/elastic/elasticsearch/pull/52486#pullrequestreview-362809817", "createdAt": "2020-02-21T17:56:02Z", "commit": {"oid": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNDM2ODAz", "url": "https://github.com/elastic/elasticsearch/pull/52486#pullrequestreview-362436803", "createdAt": "2020-02-21T07:19:04Z", "commit": {"oid": "a284be94000e0e8857679295454a6f0f4d04f6db"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwNzoxOTowNVrOFstn9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQyMDo0OTozMlrOFtEMiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQyOTE3NQ==", "bodyText": "Small comment, could just be if (context != null && context.fieldMapper(...)) { ... }", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382429175", "createdAt": "2020-02-21T07:19:05Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/IdsQueryBuilder.java", "diffHunk": "@@ -136,17 +134,28 @@ public String getWriteableName() {\n         return NAME;\n     }\n \n+    @Override\n+    protected QueryBuilder doRewrite(QueryRewriteContext queryRewriteContext) throws IOException {\n+        if (ids.isEmpty()) {\n+            return new MatchNoneQueryBuilder();\n+        }\n+        QueryShardContext context = queryRewriteContext.convertToShardContext();\n+        if (context != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a284be94000e0e8857679295454a6f0f4d04f6db"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5MzE5NQ==", "bodyText": "This looks unused, I think it can just be deleted?", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382793195", "createdAt": "2020-02-21T20:35:15Z", "author": {"login": "jtibshirani"}, "path": "modules/percolator/src/main/java/org/elasticsearch/percolator/PercolatorFieldMapper.java", "diffHunk": "@@ -491,7 +488,13 @@ static Query toQuery(QueryShardContext context, boolean mapUnmappedFieldsAsStrin\n         // as an analyzed string.\n         context.setAllowUnmappedFields(false);\n         context.setMapUnmappedFieldAsString(mapUnmappedFieldsAsString);\n-        return queryBuilder.toQuery(context);\n+    }\n+\n+    static Query parseQuery(QueryShardContext context, boolean mapUnmappedFieldsAsString, XContentParser parser) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Mjc5ODk4Nw==", "bodyText": "For my knowledge, I'm wondering why this change (and the ones to AbstractQueryTestCase) were necessary.", "url": "https://github.com/elastic/elasticsearch/pull/52486#discussion_r382798987", "createdAt": "2020-02-21T20:49:32Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/query/AbstractQueryBuilder.java", "diffHunk": "@@ -103,7 +104,7 @@ public final Query toQuery(QueryShardContext context) throws IOException {\n             if (boost != DEFAULT_BOOST) {\n                 if (query instanceof SpanQuery) {\n                     query = new SpanBoostQuery((SpanQuery) query, boost);\n-                } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51f7b3c453ed6e3d234e20ce71c06fbef93b3585"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0bf444f4180bd25e6a923dea8ba702c712c1bd", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc0bf444f4180bd25e6a923dea8ba702c712c1bd", "committedDate": "2020-02-25T07:58:40Z", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15af22f2e23925ee42090cd005201f9a00d8124f", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/15af22f2e23925ee42090cd005201f9a00d8124f", "committedDate": "2020-02-25T08:41:14Z", "message": "Review comments."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY0MzU1MjIy", "url": "https://github.com/elastic/elasticsearch/pull/52486#pullrequestreview-364355222", "createdAt": "2020-02-25T18:40:48Z", "commit": {"oid": "15af22f2e23925ee42090cd005201f9a00d8124f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b00751f5454cf89bc4b3eed6b39e9aeba19a7fc", "author": {"user": {"login": "jpountz", "name": "Adrien Grand"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b00751f5454cf89bc4b3eed6b39e9aeba19a7fc", "committedDate": "2020-02-26T08:22:50Z", "message": "Merge branch 'master' into enhancement/simplify_in_rewrite"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2390, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}