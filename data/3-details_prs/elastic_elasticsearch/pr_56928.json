{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5ODE2Njkx", "number": 56928, "title": "Allow field mappers to retrieve fields from source.", "bodyText": "This PR adds new method FieldMapper#lookupValues(SourceLookup) that extracts and parses the source values. This lets us return values like numbers and dates in a consistent format, and also handle special data types like constant_keyword. The lookupValues method calls into parseSourceValue, which mappers can override to specify how values should be parsed.\nOlder draft PR: #56473\nRelates to #55363.", "createdAt": "2020-05-19T01:00:58Z", "url": "https://github.com/elastic/elasticsearch/pull/56928", "merged": true, "mergeCommit": {"oid": "53884ba4510b19f1c8bff1c993dfdc3ece909da0"}, "closed": true, "closedAt": "2020-05-28T15:11:20Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciqs_sABqjMzNDk3NTc0MjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcltuVWgFqTQyMDA5NjI2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c362eeaa6417486aee21ee998acb6ce6309038ce", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/c362eeaa6417486aee21ee998acb6ce6309038ce", "committedDate": "2020-05-18T23:24:18Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}, "afterCommit": {"oid": "8ae330a1f075d50ee14e3e86fab75b1969778097", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ae330a1f075d50ee14e3e86fab75b1969778097", "committedDate": "2020-05-19T02:04:22Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8ae330a1f075d50ee14e3e86fab75b1969778097", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ae330a1f075d50ee14e3e86fab75b1969778097", "committedDate": "2020-05-19T02:04:22Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}, "afterCommit": {"oid": "66e6018004bc8a3c8735753806ba384c3d996284", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/66e6018004bc8a3c8735753806ba384c3d996284", "committedDate": "2020-05-19T03:29:12Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "66e6018004bc8a3c8735753806ba384c3d996284", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/66e6018004bc8a3c8735753806ba384c3d996284", "committedDate": "2020-05-19T03:29:12Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}, "afterCommit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/00e879dc48f1b95826db620bdcbf6f3b9c54bcaa", "committedDate": "2020-05-19T03:54:01Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0MzczOTMx", "url": "https://github.com/elastic/elasticsearch/pull/56928#pullrequestreview-414373931", "createdAt": "2020-05-19T12:01:55Z", "commit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMjowMTo1NlrOGXdFVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxMjowMTo1NlrOGXdFVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0NjkzMw==", "bodyText": "nit: I was wondering if we should use covariance here and anywhere we return Strings, like we do for other types.", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r427246933", "createdAt": "2020-05-19T12:01:56Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java", "diffHunk": "@@ -187,6 +187,11 @@ public KeywordFieldMapper build(BuilderContext context) {\n         }\n     }\n \n+    @Override\n+    protected Object parseSourceValue(Object value) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0Njk5NjU2", "url": "https://github.com/elastic/elasticsearch/pull/56928#pullrequestreview-414699656", "createdAt": "2020-05-19T18:07:54Z", "commit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODowNzo1NFrOGXsipw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQxODowOTowMFrOGXslGw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMDE5OQ==", "bodyText": "You do return a Number from NumberFieldMapper#parseValue. It feels like a good thing to do.", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r427500199", "createdAt": "2020-05-19T18:07:54Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java", "diffHunk": "@@ -187,6 +187,11 @@ public KeywordFieldMapper build(BuilderContext context) {\n         }\n     }\n \n+    @Override\n+    protected Object parseSourceValue(Object value) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzI0NjkzMw=="}, "originalCommit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzUwMDgyNw==", "bodyText": "Could add a space after :? I have trouble reading it as a ternary without for some reason!", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r427500827", "createdAt": "2020-05-19T18:09:00Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/RangeType.java", "diffHunk": "@@ -619,14 +629,17 @@ public Object parseTo(RangeFieldMapper.RangeFieldType fieldType, XContentParser\n     public abstract Query withinQuery(String field, Object from, Object to, boolean includeFrom, boolean includeTo);\n     public abstract Query containsQuery(String field, Object from, Object to, boolean includeFrom, boolean includeTo);\n     public abstract Query intersectsQuery(String field, Object from, Object to, boolean includeFrom, boolean includeTo);\n-    public Object parse(Object value, boolean coerce) {\n-        return numberType.parse(value, coerce);\n-    }\n+\n     public Query rangeQuery(String field, boolean hasDocValues, Object from, Object to, boolean includeFrom, boolean includeTo,\n                             ShapeRelation relation, @Nullable ZoneId timeZone, @Nullable DateMathParser dateMathParser,\n                             QueryShardContext context) {\n-        Object lower = from == null ? minValue() : parse(from, false);\n-        Object upper = to == null ? maxValue() : parse(to, false);\n+        Object lower = from == null ? minValue() : parseValue(from, false, dateMathParser);\n+        Object upper = to == null ? maxValue() :parseValue(to, false, dateMathParser);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00e879dc48f1b95826db620bdcbf6f3b9c54bcaa"}, "originalPosition": 81}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf008a5dbd98e826f3c6657917dca1d5bab349b0", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf008a5dbd98e826f3c6657917dca1d5bab349b0", "committedDate": "2020-05-20T00:43:07Z", "message": "Ensure parseSourceValue returns strings when possible."}, "afterCommit": {"oid": "fab49e7cf0b792bcb95e7e5ebfb3d6ce941c84d0", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/fab49e7cf0b792bcb95e7e5ebfb3d6ce941c84d0", "committedDate": "2020-05-20T21:28:15Z", "message": "Convert murmur3 and token_count values to strings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MzA2NTg3", "url": "https://github.com/elastic/elasticsearch/pull/56928#pullrequestreview-416306587", "createdAt": "2020-05-21T16:34:07Z", "commit": {"oid": "ce0e04f846ef95d65889aa5b95f748a6ff7c9df2"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjozNDowN1rOGY6FxQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjo0NjoyNlrOGY6h5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3MDc1Nw==", "bodyText": "Keywords shouldn't also consider ignore_above and the extraction from _source to happen with this value in mind?", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r428770757", "createdAt": "2020-05-21T16:34:07Z", "author": {"login": "astefan"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/KeywordFieldMapper.java", "diffHunk": "@@ -187,6 +187,11 @@ public KeywordFieldMapper build(BuilderContext context) {\n         }\n     }\n \n+    @Override\n+    protected String parseSourceValue(Object value) {\n+        return value.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0e04f846ef95d65889aa5b95f748a6ff7c9df2"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3NzA1OQ==", "bodyText": "Really minor: all the indentations for the lines containing method calls in testLookupValues are inconsistent compared to the other methods in this class.", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r428777059", "createdAt": "2020-05-21T16:44:57Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/mapper-constant-keyword/src/test/java/org/elasticsearch/xpack/constantkeyword/mapper/ConstantKeywordFieldMapperTests.java", "diffHunk": "@@ -127,4 +130,27 @@ public void testMeta() throws Exception {\n                 new CompressedXContent(mapping3), MergeReason.MAPPING_UPDATE);\n         assertEquals(mapping3, mapper.mappingSource().toString());\n     }\n+\n+    public void testLookupValues() throws Exception {\n+        IndexService indexService = createIndex(\"test\");\n+        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"_doc\")\n+            .startObject(\"properties\").startObject(\"field\").field(\"type\", \"constant_keyword\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0e04f846ef95d65889aa5b95f748a6ff7c9df2"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3Nzk1OA==", "bodyText": "Same comment as the one for keyword field: shouldn't ignore_above be considered when parsing the source?", "url": "https://github.com/elastic/elasticsearch/pull/56928#discussion_r428777958", "createdAt": "2020-05-21T16:46:26Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/wildcard/src/main/java/org/elasticsearch/xpack/wildcard/mapper/WildcardFieldMapper.java", "diffHunk": "@@ -551,6 +551,11 @@ protected void parseCreateField(ParseContext context) throws IOException {\n         parseDoc.addAll(fields);\n     }\n \n+    @Override\n+    protected String parseSourceValue(Object value) {\n+        return value.toString();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ce0e04f846ef95d65889aa5b95f748a6ff7c9df2"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6216fd8621a439f6574cce9a034ccd0b767db85b", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/6216fd8621a439f6574cce9a034ccd0b767db85b", "committedDate": "2020-05-28T04:05:30Z", "message": "Introduce a method FieldMapper#lookupValues to retrieve fields from source."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44f6c381f3d3479f43859c2f0cfa15a968a3b07", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f44f6c381f3d3479f43859c2f0cfa15a968a3b07", "committedDate": "2020-05-28T04:05:30Z", "message": "Ensure parseSourceValue returns strings when possible."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a09d71f3bbc831074f044aeb37a301d191a01bdd", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a09d71f3bbc831074f044aeb37a301d191a01bdd", "committedDate": "2020-05-28T04:05:30Z", "message": "Convert murmur3 and token_count values to strings."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcf54e9903a304c129023aad4041f73f39e8e94f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcf54e9903a304c129023aad4041f73f39e8e94f", "committedDate": "2020-05-28T04:05:30Z", "message": "Format dates based on the mapping format."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e36ef68f2f7d0d2f52c7c03c496827839d129d", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/27e36ef68f2f7d0d2f52c7c03c496827839d129d", "committedDate": "2020-05-28T04:05:30Z", "message": "Make sure to format dates within range types."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1ac1404bd28377107652bb7a81a21b4d24843bf", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1ac1404bd28377107652bb7a81a21b4d24843bf", "committedDate": "2020-05-28T04:05:30Z", "message": "Fix indentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2d259be25627b3b047ba40ef42c3daac565b0fe", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2d259be25627b3b047ba40ef42c3daac565b0fe", "committedDate": "2020-05-28T04:05:30Z", "message": "Standardize IP fields."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a5c3ce34fa99e390ddc167e1f9825f5efae50c1b", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5c3ce34fa99e390ddc167e1f9825f5efae50c1b", "committedDate": "2020-05-28T02:05:05Z", "message": "Standardize IP fields."}, "afterCommit": {"oid": "f2d259be25627b3b047ba40ef42c3daac565b0fe", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2d259be25627b3b047ba40ef42c3daac565b0fe", "committedDate": "2020-05-28T04:05:30Z", "message": "Standardize IP fields."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDk2MjYy", "url": "https://github.com/elastic/elasticsearch/pull/56928#pullrequestreview-420096262", "createdAt": "2020-05-28T13:17:37Z", "commit": {"oid": "f2d259be25627b3b047ba40ef42c3daac565b0fe"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4889, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}