{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDkwMzg0MDQx", "number": 62711, "title": "Ensure MockRepository is Unblocked on Node Close", "bodyText": "RepositoriesService#doClose was never called which lead to\nmock repositories not unblocking until the ThreadPool interrupts\nall threads. Thus stopping a node that is blocked on a mock repository operation wastes 10s\nin each test that does it (which is quite a few as it turns out).", "createdAt": "2020-09-21T15:28:40Z", "url": "https://github.com/elastic/elasticsearch/pull/62711", "merged": true, "mergeCommit": {"oid": "86ba0b2d18d6572d5f588de3eb044bd866e30b0c"}, "closed": true, "closedAt": "2020-09-22T08:04:00Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdLFBWSAH2gAyNDkwMzg0MDQxOmEwMWIxODRhZjE1ZjQ5ODNmZTVjYWRlZDhiMDI5YTBjMjkzYTI3MmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLTEXZAFqTQ5MzE5NTExOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a01b184af15f4983fe5caded8b029a0c293a272b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a01b184af15f4983fe5caded8b029a0c293a272b", "committedDate": "2020-09-21T15:21:24Z", "message": "Ensure MockRepository is Unblocked on Node Close\n\n`RepositoriesService#doClose` was never called which lead to\nmock repositories not unblocking until the `ThreadPool` interrupts\nall threads. Thus stopping a node that is blocked on a mock repository operation wastes `10s`\nin each test that does it (which is quite a few as it turns out)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyNzM1MzIx", "url": "https://github.com/elastic/elasticsearch/pull/62711#pullrequestreview-492735321", "createdAt": "2020-09-21T15:29:26Z", "commit": {"oid": "a01b184af15f4983fe5caded8b029a0c293a272b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNToyOToyN1rOHVWpvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNToyOToyN1rOHVWpvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjE1MzI3Nw==", "bodyText": "We didn't throw here before but then again we only got here when all the threads were already interrupted -> I figured throwing here keeps things nice and deterministic.", "url": "https://github.com/elastic/elasticsearch/pull/62711#discussion_r492153277", "createdAt": "2020-09-21T15:29:27Z", "author": {"login": "original-brownbear"}, "path": "test/framework/src/main/java/org/elasticsearch/snapshots/mockstore/MockRepository.java", "diffHunk": "@@ -322,9 +322,13 @@ private void maybeIOExceptionOrBlock(String blobName) throws IOException {\n                 }\n             }\n \n-            private void blockExecutionAndMaybeWait(final String blobName) {\n+            private void blockExecutionAndMaybeWait(final String blobName) throws IOException {\n                 logger.info(\"[{}] blocking I/O operation for file [{}] at path [{}]\", metadata.name(), blobName, path());\n-                if (blockExecution() && waitAfterUnblock > 0) {\n+                final boolean wasBlocked = blockExecution();\n+                if (wasBlocked && lifecycle.stoppedOrClosed()) {\n+                    throw new IOException(\"already closed\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a01b184af15f4983fe5caded8b029a0c293a272b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93d3b74129251fb9a5c1b44c334600d8fcde8e41", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/93d3b74129251fb9a5c1b44c334600d8fcde8e41", "committedDate": "2020-09-21T16:09:00Z", "message": "Merge remote-tracking branch 'elastic/master' into faster-mock-repo-close"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79578acec2faddd007aaf87f7356330dbdadb389", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/79578acec2faddd007aaf87f7356330dbdadb389", "committedDate": "2020-09-21T17:18:15Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkyODMzMjQ0", "url": "https://github.com/elastic/elasticsearch/pull/62711#pullrequestreview-492833244", "createdAt": "2020-09-21T17:29:58Z", "commit": {"oid": "79578acec2faddd007aaf87f7356330dbdadb389"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzoyOTo1OFrOHVbS6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxNzoyOTo1OFrOHVbS6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyOTM1Mg==", "bodyText": "We need to actually wait here for the cluster change to be fully registerd, otherwise we just randomly pick a node that hasn't yet seen the cleanup in progress in the CS and fail on the leaked running cleanup.\nObviously, there's a bit of a risk with this change in general and it might lead to more failures that need a check like this added now because they implicitly relied on the 10s wait when closing a blocked node but IMO it's worth it given the almost 10s per affected test (and it's quite a few) savings.", "url": "https://github.com/elastic/elasticsearch/pull/62711#discussion_r492229352", "createdAt": "2020-09-21T17:29:58Z", "author": {"login": "original-brownbear"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/repositories/blobstore/BlobStoreRepositoryCleanupIT.java", "diffHunk": "@@ -42,9 +42,12 @@\n     public void testMasterFailoverDuringCleanup() throws Exception {\n         startBlockedCleanup(\"test-repo\");\n \n+        final int nodeCount = internalCluster().numDataAndMasterNodes();\n         logger.info(\"-->  stopping master node\");\n         internalCluster().stopCurrentMasterNode();\n \n+        ensureStableCluster(nodeCount - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "79578acec2faddd007aaf87f7356330dbdadb389"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkzMTk1MTE4", "url": "https://github.com/elastic/elasticsearch/pull/62711#pullrequestreview-493195118", "createdAt": "2020-09-22T07:37:55Z", "commit": {"oid": "79578acec2faddd007aaf87f7356330dbdadb389"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozNzo1NlrOHVtqag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQwNzozNzo1NlrOHVtqag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjUzMDI4Mg==", "bodyText": "We can maybe run this PR on CI multiple times before merging, just to catch the most failing tests if any. But I agree with you, it's better to not have test relying on the implicit 10s.", "url": "https://github.com/elastic/elasticsearch/pull/62711#discussion_r492530282", "createdAt": "2020-09-22T07:37:56Z", "author": {"login": "tlrx"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/repositories/blobstore/BlobStoreRepositoryCleanupIT.java", "diffHunk": "@@ -42,9 +42,12 @@\n     public void testMasterFailoverDuringCleanup() throws Exception {\n         startBlockedCleanup(\"test-repo\");\n \n+        final int nodeCount = internalCluster().numDataAndMasterNodes();\n         logger.info(\"-->  stopping master node\");\n         internalCluster().stopCurrentMasterNode();\n \n+        ensureStableCluster(nodeCount - 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjIyOTM1Mg=="}, "originalCommit": {"oid": "79578acec2faddd007aaf87f7356330dbdadb389"}, "originalPosition": 8}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4670, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}