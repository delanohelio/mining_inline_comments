{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMyMDUzNzE1", "number": 65850, "title": "Cancel proxy requests when the proxy channel closes", "bodyText": "Since #43332 and #56327 we cancel rest requests when the rest channel closes and transport requests when the transport channel closes. This commit cancels proxy requests and its descendant requests when the proxy channel closes. This change is also required to support cross-clusters task cancellation.", "createdAt": "2020-12-03T19:38:17Z", "url": "https://github.com/elastic/elasticsearch/pull/65850", "merged": true, "mergeCommit": {"oid": "95936ebddc6f1b6d242d3a01e9481ae79a658641"}, "closed": true, "closedAt": "2020-12-08T14:10:13Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdioZTXAH2gAyNTMyMDUzNzE1OmZjMjAzYmZiNGVlNzk4N2E2NDlhMDRmYTBkZTdlZGRmNzFjYTc5ZjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkJUZaAFqTU0NzE4Nzc3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fc203bfb4ee7987a649a04fa0de7eddf71ca79f0", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc203bfb4ee7987a649a04fa0de7eddf71ca79f0", "committedDate": "2020-12-03T19:34:30Z", "message": "Cancel proxy requests when the proxy channel closes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5535bc301fc088a256d7f22bf0bc1ff9ea19df18", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5535bc301fc088a256d7f22bf0bc1ff9ea19df18", "committedDate": "2020-12-03T21:06:10Z", "message": "oops"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDA2MzAx", "url": "https://github.com/elastic/elasticsearch/pull/65850#pullrequestreview-545006301", "createdAt": "2020-12-04T14:29:28Z", "commit": {"oid": "5535bc301fc088a256d7f22bf0bc1ff9ea19df18"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyOToyOFrOH_TUJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQxNDoyOToyOFrOH_TUJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNjEzODc5MQ==", "bodyText": "Rather than requiring every registration to record correctly whether the proxied task is cancellable or not, could we call wrapped.createTask() and decide whether to create a CancellableTask or just a regular Task based on whether the wrapped request's task was cancellable or not? At least we should assert that they match, or else we'll forget to update the argument to the proxy registration in future if we ever add cancellability  to another task.", "url": "https://github.com/elastic/elasticsearch/pull/65850#discussion_r536138791", "createdAt": "2020-12-04T14:29:28Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/transport/TransportActionProxy.java", "diffHunk": "@@ -117,27 +122,54 @@ public void writeTo(StreamOutput out) throws IOException {\n         }\n     }\n \n+    private static class CancellableProxyRequest<T extends TransportRequest> extends ProxyRequest<T> {\n+        CancellableProxyRequest(StreamInput in, Writeable.Reader<T> reader) throws IOException {\n+            super(in, reader);\n+        }\n+\n+        @Override\n+        public Task createTask(long id, String type, String action, TaskId parentTaskId, Map<String, String> headers) {\n+            return new CancellableTask(id, type, action, \"\", parentTaskId, headers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5535bc301fc088a256d7f22bf0bc1ff9ea19df18"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7def6448a4965f132e777a1f6e6060dd55c2b64f", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7def6448a4965f132e777a1f6e6060dd55c2b64f", "committedDate": "2020-12-05T20:23:18Z", "message": "Merge branch 'master' into cancellable-proxy-task"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a52a5b9f695bdee2648cb197b3aa439586a6981", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a52a5b9f695bdee2648cb197b3aa439586a6981", "committedDate": "2020-12-05T20:32:33Z", "message": "add assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94490b4dc31eb8dcd518d3f862f2390c82602e4c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/94490b4dc31eb8dcd518d3f862f2390c82602e4c", "committedDate": "2020-12-05T22:40:33Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTc2NjQ2", "url": "https://github.com/elastic/elasticsearch/pull/65850#pullrequestreview-547176646", "createdAt": "2020-12-08T12:13:44Z", "commit": {"oid": "94490b4dc31eb8dcd518d3f862f2390c82602e4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ3MTg3Nzc2", "url": "https://github.com/elastic/elasticsearch/pull/65850#pullrequestreview-547187776", "createdAt": "2020-12-08T12:29:56Z", "commit": {"oid": "94490b4dc31eb8dcd518d3f862f2390c82602e4c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4172, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}