{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTQ2NTgz", "number": 54933, "title": "Prevent putting V2 index template when overlapping with existing template", "bodyText": "This change prevents putting V2 index template when it would overlap with existing V2 template of the same priority\nRelates to #53101", "createdAt": "2020-04-07T23:14:02Z", "url": "https://github.com/elastic/elasticsearch/pull/54933", "merged": true, "mergeCommit": {"oid": "e348959b04a9be98adb21e3a824b7d36233bd698"}, "closed": true, "closedAt": "2020-04-10T05:56:52Z", "author": {"login": "probakowski"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVbmwwAH2gAyNDAwNTQ2NTgzOjNlOGQzZDM3MTE3NThlMGVkZWYwYTdhNzY1ZTc5MWZjOTlkYWRlZmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcWEkMPAH2gAyNDAwNTQ2NTgzOjBlMWJiNjJiMDhkOTE5NmM2ZGVmMzM4ZDVlM2U4MGNkZGU1NjczZmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3e8d3d3711758e0edef0a7a765e791fc99dadefd", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e8d3d3711758e0edef0a7a765e791fc99dadefd", "committedDate": "2020-04-07T23:08:16Z", "message": "Prevent putting V2 index template when overlapping with existing template\n\nThis change prevents putting V2 index template when it would overlap with existing V2 template\nof the same priority\n\nRelates to #53101"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d56ec4bd41efe2bdfdd452a86e4f2af7fb7a8796", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/d56ec4bd41efe2bdfdd452a86e4f2af7fb7a8796", "committedDate": "2020-04-07T23:13:55Z", "message": "removed unneeded change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30d2dbdb19d3a8e8a3d4c656ec52db152bd6eb43", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/30d2dbdb19d3a8e8a3d4c656ec52db152bd6eb43", "committedDate": "2020-04-07T23:28:57Z", "message": "long line fixeD"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4fcdc8d4712a83eab42a5b31c48dc6256d97977", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4fcdc8d4712a83eab42a5b31c48dc6256d97977", "committedDate": "2020-04-08T09:54:42Z", "message": "long line fixed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f3732abcf3c9ba05d3a899d8423f935dc3d312c", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f3732abcf3c9ba05d3a899d8423f935dc3d312c", "committedDate": "2020-04-08T10:10:20Z", "message": "fix npe during sort"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "644a3878d573c08cc4909addf8fe8b9836971dfc", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/644a3878d573c08cc4909addf8fe8b9836971dfc", "committedDate": "2020-04-08T10:19:55Z", "message": "Revert \"fix npe during sort\"\n\nThis reverts commit 9f3732abcf3c9ba05d3a899d8423f935dc3d312c."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a89cb2f6416a288e221474ea6478d3f25890d0a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a89cb2f6416a288e221474ea6478d3f25890d0a", "committedDate": "2020-04-08T10:43:47Z", "message": "Merge branch 'master' into prevent-overlapping-v2-templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae9dcc7428c969ef8c5346e5a4cb552ca007a875", "committedDate": "2020-04-08T11:47:39Z", "message": "Merge branch 'master' into prevent-overlapping-v2-templates"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5OTA2OTM1", "url": "https://github.com/elastic/elasticsearch/pull/54933#pullrequestreview-389906935", "createdAt": "2020-04-08T12:01:25Z", "commit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMTQyOTM0", "url": "https://github.com/elastic/elasticsearch/pull/54933#pullrequestreview-390142934", "createdAt": "2020-04-08T16:35:22Z", "commit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjozNToyMlrOGC3eSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo0MDo0M1rOGC3raw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY1OTIwOQ==", "bodyText": "Super minor nit\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            if(checkPriority == false || Objects.equals(priority, template.priority())) {\n          \n          \n            \n                            if (checkPriority == false || Objects.equals(priority, template.priority())) {", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405659209", "createdAt": "2020-04-08T16:35:22Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -385,16 +400,27 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n      */\n     static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,\n                                                                 final List<String> indexPatterns) {\n+        return findConflictingV2Templates(state, candidateName, indexPatterns, false, null);\n+    }\n+\n+    /**\n+     * Return a map of v2 template names to their index patterns for v2 templates that would overlap\n+     * with the given template's index patterns.\n+     */\n+    static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,\n+                                                                final List<String> indexPatterns, boolean checkPriority, Long priority) {\n         Automaton v1automaton = Regex.simpleMatchToAutomaton(indexPatterns.toArray(Strings.EMPTY_ARRAY));\n         Map<String, List<String>> overlappingTemplates = new HashMap<>();\n         for (Map.Entry<String, IndexTemplateV2> entry : state.metadata().templatesV2().entrySet()) {\n             String name = entry.getKey();\n             IndexTemplateV2 template = entry.getValue();\n             Automaton v2automaton = Regex.simpleMatchToAutomaton(template.indexPatterns().toArray(Strings.EMPTY_ARRAY));\n             if (Operations.isEmpty(Operations.intersection(v1automaton, v2automaton)) == false) {\n-                logger.debug(\"old template {} and index template {} would overlap: {} <=> {}\",\n-                    candidateName, name, indexPatterns, template.indexPatterns());\n-                overlappingTemplates.put(name, template.indexPatterns());\n+                if(checkPriority == false || Objects.equals(priority, template.priority())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MDY0NQ==", "bodyText": "I think we can be a little more explicit with what the user needs to do, maybe something like:\nindex template [foo] has index patterns [bar*] matching patterns from existing templates [baz] with patterns (bar*) that have the same priority [5], multiple index templates may not match during index creation, please use a different priority\n\nWhat do you think?", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405660645", "createdAt": "2020-04-08T16:37:40Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -305,7 +305,22 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n             throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n         }\n \n-        Map<String, List<String>> overlaps = findConflictingV1Templates(currentState, name, template.indexPatterns());\n+        Map<String, List<String>> overlaps = findConflictingV2Templates(currentState, name, template.indexPatterns(), true,\n+            template.priority());\n+        if (overlaps.size() > 0) {\n+            String error = String.format(Locale.ROOT, \"index template [%s] has index patterns %s matching patterns from \" +\n+                    \"existing templates [%s] with patterns (%s) that have the same priority [%d]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2MjU3MQ==", "bodyText": "It's suuuuper unlikely, but this might be better as:\nIndexTemplateV2 newTemplate = randomValueOtherThanMany(t -> Objects.equals(template.priority(), t.priority(), () -> IndexTemplateV2Tests.randomInstance());\nTo prevent generating a new template that accidentally has the same index patterns and priority (highly unlikely but not impossible)", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r405662571", "createdAt": "2020-04-08T16:40:43Z", "author": {"login": "dakrone"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "diffHunk": "@@ -301,12 +301,14 @@ public void testAddIndexTemplateV2() throws Exception {\n         assertNotNull(state.metadata().templatesV2().get(\"foo\"));\n         assertTemplatesEqual(state.metadata().templatesV2().get(\"foo\"), template);\n \n+        IndexTemplateV2 newTemplate = IndexTemplateV2Tests.randomInstance();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ae9dcc7428c969ef8c5346e5a4cb552ca007a875"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d750d3b7b627c8509f896d5cebb1c2f8ccd5086f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d750d3b7b627c8509f896d5cebb1c2f8ccd5086f", "committedDate": "2020-04-08T22:52:29Z", "message": "Merge branch 'master' into prevent-overlapping-v2-templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb0ba5f74577cdf8a0cf3c9e419a070d1005db29", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb0ba5f74577cdf8a0cf3c9e419a070d1005db29", "committedDate": "2020-04-09T07:53:05Z", "message": "Update server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java\n\nCo-Authored-By: Lee Hinman <dakrone@users.noreply.github.com>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwNjg0NzA0", "url": "https://github.com/elastic/elasticsearch/pull/54933#pullrequestreview-390684704", "createdAt": "2020-04-09T10:45:34Z", "commit": {"oid": "eb0ba5f74577cdf8a0cf3c9e419a070d1005db29"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDo0NTozNFrOGDTf6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMDo0NTozNFrOGDTf6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjExODM3Nw==", "bodyText": "do we still need this? would we ever want to find the conflicting templates without checking the priority?", "url": "https://github.com/elastic/elasticsearch/pull/54933#discussion_r406118377", "createdAt": "2020-04-09T10:45:34Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -385,16 +400,27 @@ ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean c\n      */\n     static Map<String, List<String>> findConflictingV2Templates(final ClusterState state, final String candidateName,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eb0ba5f74577cdf8a0cf3c9e419a070d1005db29"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9c7b6515377c559b1486c2aa3fedb67dea505e2", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9c7b6515377c559b1486c2aa3fedb67dea505e2", "committedDate": "2020-04-09T20:24:33Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5452c2f0db0a990341122681571358f548f9bb03", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5452c2f0db0a990341122681571358f548f9bb03", "committedDate": "2020-04-09T22:04:45Z", "message": "Merge branch 'master' into prevent-overlapping-v2-templates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e1bb62b08d9196c6def338d5e3e80cdde5673fe", "author": {"user": {"login": "probakowski", "name": "Przemko Robakowski"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e1bb62b08d9196c6def338d5e3e80cdde5673fe", "committedDate": "2020-04-09T22:51:34Z", "message": "unused import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3579, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}