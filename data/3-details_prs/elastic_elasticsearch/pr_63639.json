{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyNzMyMzEw", "number": 63639, "title": "Remove cyclic dependency between DocumentMapper and MapperService", "bodyText": "DocumentMapper holds on to a reference of MapperService so that its merge method, which creates and return a new DocumentMapper instance, can provide it to its own constructor. On the other hand MapperService has a volatile reference to DocumentMapper, which gets updated by calling merge.\nGiven that only three components out of MapperService are needed, DocumentMapper can instead hold on to those specific objects: IndexSettings, DocumentMapperParser and IndexAnalyzers.", "createdAt": "2020-10-13T19:23:47Z", "url": "https://github.com/elastic/elasticsearch/pull/63639", "merged": true, "mergeCommit": {"oid": "b796e342b6a6c9ad12c87a287bac1915215ae121"}, "closed": true, "closedAt": "2020-10-14T11:28:08Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSNph8AH2gAyNTAyNzMyMzEwOjIwMjM4MmE0NWZlYmM4MTQ0YWVlZmE0M2U1Njk4NGRhNDZmYmQxZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSasQygH2gAyNTAyNzMyMzEwOjhkMmQ2N2U0YTg0MzZlYmY0OThjM2I1NjI1YzBiNjY2ZTkwNTAwYjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/202382a45febc8144aeefa43e56984da46fbd1de", "committedDate": "2020-10-13T19:22:00Z", "message": "Remove cyclic dependency between DocumentMapper and MapperService\n\n`DocumentMapper` holds on to a reference of `MapperService` so that its `merge` method, which creates and return a new `DocumentMapper` instance, can provide it to its own constructor. On the other hand `MapperService` has a volatile reference to `DocumentMapper`, which gets updated by calling `merge`.\n\nTruth is that the callers of the `merge` method could provide an instance of `MapperService` themselves, which removes the need for holding a reference to `MapperService` in `DocumentMapper`. Also, given that only three components out of `MapperService` are needed, we can adapt the signature of the `merge` method to accepts three new arguments: `IndexSettings`, `DocumentMapperParser` and `IndexAnalyzers`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/3639239e6126a1583b3a3132ecc2ccfbba8a5c1d", "committedDate": "2020-10-14T07:28:18Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTIzMzk4", "url": "https://github.com/elastic/elasticsearch/pull/63639#pullrequestreview-508123398", "createdAt": "2020-10-14T08:42:57Z", "commit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0Mjo1N1rOHhIiqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo0NTo0MlrOHhIpWw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNTAwMw==", "bodyText": "Rather than having to pass these through to merge, can't we just keep references to them instead of references to the MapperService?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504505003", "createdAt": "2020-10-14T08:42:57Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -267,9 +264,13 @@ public ObjectMapper findNestedObjectMapper(int nestedDocId, SearchContext sc, Le\n         return nestedObjectMapper;\n     }\n \n-    public DocumentMapper merge(Mapping mapping, MergeReason reason) {\n+    public DocumentMapper merge(Mapping mapping,\n+                                MergeReason reason,\n+                                IndexSettings indexSettings,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "202382a45febc8144aeefa43e56984da46fbd1de"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUwNjcxNQ==", "bodyText": "I don't think we need to change this method signature? Particularly now that the DocumentMapper constructor is private, just passing the MapperService here is a much simpler API.", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504506715", "createdAt": "2020-10-14T08:45:42Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentMapper.java", "diffHunk": "@@ -99,19 +99,17 @@ public Builder put(MetadataFieldMapper.Builder mapper) {\n             return this;\n         }\n \n-        public DocumentMapper build(MapperService mapperService) {\n+        public DocumentMapper build(IndexSettings indexSettings, DocumentMapperParser documentMapperParser, IndexAnalyzers indexAnalyzers) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3639239e6126a1583b3a3132ecc2ccfbba8a5c1d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c5133c0280b03fc565d5557157837eb6eaa8384", "committedDate": "2020-10-14T09:21:22Z", "message": "iter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTkxMzcw", "url": "https://github.com/elastic/elasticsearch/pull/63639#pullrequestreview-508191370", "createdAt": "2020-10-14T10:05:38Z", "commit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNTozOFrOHhLvlw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMDowNzoxMVrOHhLzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1NzQ2Mw==", "bodyText": "I think these changes are unnecessary now?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557463", "createdAt": "2020-10-14T10:05:38Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentMapperTests.java", "diffHunk": "@@ -43,8 +43,8 @@\n public class DocumentMapperTests extends MapperServiceTestCase {\n \n     public void testAddFields() throws Exception {\n-        DocumentMapper stage1\n-            = createDocumentMapper(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));\n+        MapperService mapperService = createMapperService(mapping(b -> b.startObject(\"name\").field(\"type\", \"text\").endObject()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1Nzk1NQ==", "bodyText": "I think this can be left unchanged as well?", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504557955", "createdAt": "2020-10-14T10:06:27Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/MapperTestUtils.java", "diffHunk": "@@ -78,8 +78,9 @@ public static MapperService newMapperService(NamedXContentRegistry xContentRegis\n \n     public static void assertConflicts(String mapping1,\n                                        String mapping2,\n-                                       DocumentMapperParser\n-                                           parser, String... conflicts) throws IOException {\n+                                       DocumentMapperParser parser,\n+                                       MapperService mapperService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU1ODM5MA==", "bodyText": "These too", "url": "https://github.com/elastic/elasticsearch/pull/63639#discussion_r504558390", "createdAt": "2020-10-14T10:07:11Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/mapper-flattened/src/internalClusterTest/java/org/elasticsearch/xpack/flattened/mapper/FlatObjectFieldMapperTests.java", "diffHunk": "@@ -366,10 +366,9 @@ public void testDepthLimit() throws IOException {\n                 .endObject()\n             .endObject()\n         .endObject());\n-\n+        MapperService mapperService = indexService.mapperService();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4c5133c0280b03fc565d5557157837eb6eaa8384"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb327c530f8451b529715ad2fb7d5f90cec60c60", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb327c530f8451b529715ad2fb7d5f90cec60c60", "committedDate": "2020-10-14T10:27:27Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39997e61cca8d38a43001e8bc3f8176a75ffadce", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/39997e61cca8d38a43001e8bc3f8176a75ffadce", "committedDate": "2020-10-14T10:32:06Z", "message": "iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d2d67e4a8436ebf498c3b5625c0b666e90500b2", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d2d67e4a8436ebf498c3b5625c0b666e90500b2", "committedDate": "2020-10-14T10:33:45Z", "message": "iter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4138, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}