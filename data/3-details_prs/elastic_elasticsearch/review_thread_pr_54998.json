{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxMTg3NzU4", "number": 54998, "reviewThreads": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMToyMzo1OVrODwXVMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTo1MjowNFrOEH5brA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDQwNDk2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/node/NodeRoleSettings.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMToyMzo1OVrOGDUm3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMTozMDoyMFrOGDUy3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzNjU0Mg==", "bodyText": "Would there be any benefit to extracting this into a public constant, so that other classes can import it, instead of rekeying it? I'm just imagining typos, or trying to find usages with an IDE. Just a thought.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406136542", "createdAt": "2020-04-09T11:23:59Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/node/NodeRoleSettings.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.node;\n+\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class NodeRoleSettings {\n+\n+    public static final Setting<List<DiscoveryNodeRole>> NODE_ROLES_SETTING = Setting.listSetting(\n+        \"node.roles\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzNzk2MQ==", "bodyText": "The typical way that we refer to these is via NODE_ROLES_SETTING.getKey(). This way, we can find all usages of the setting, whether it's the actual setting representation, or the key, in a single use of \"find usages\", rather than having to find usages for the key, and for the setting separately.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406137961", "createdAt": "2020-04-09T11:26:54Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/node/NodeRoleSettings.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.node;\n+\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class NodeRoleSettings {\n+\n+    public static final Setting<List<DiscoveryNodeRole>> NODE_ROLES_SETTING = Setting.listSetting(\n+        \"node.roles\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzNjU0Mg=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzOTYxNA==", "bodyText": "Ah, that's what I ought to have said, having done exactly the same thing myself. \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406139614", "createdAt": "2020-04-09T11:30:20Z", "author": {"login": "pugnascotia"}, "path": "server/src/main/java/org/elasticsearch/node/NodeRoleSettings.java", "diffHunk": "@@ -0,0 +1,45 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.node;\n+\n+import org.elasticsearch.cluster.node.DiscoveryNode;\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Setting.Property;\n+\n+import java.util.List;\n+import java.util.stream.Collectors;\n+\n+public class NodeRoleSettings {\n+\n+    public static final Setting<List<DiscoveryNodeRole>> NODE_ROLES_SETTING = Setting.listSetting(\n+        \"node.roles\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjEzNjU0Mg=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDc0MDM2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/cluster/node/DiscoveryNodeTests.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzowNjo0NlrOGDX13g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMDozMzozN1rOGE0SUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE4OTUzNA==", "bodyText": "I'm not sure about this. The assertion will hold if the roles collection has at least one item equal to the specifed role. That's not the same as it being the only role in the collection.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406189534", "createdAt": "2020-04-09T13:06:46Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/cluster/node/DiscoveryNodeTests.java", "diffHunk": "@@ -90,22 +93,20 @@ public void testDiscoveryNodeIsRemoteClusterClientDefault() {\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientSet() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), true).build(), true);\n+        runTestDiscoveryNodeIsRemoteClusterClient(remoteClusterClientNode(), true);\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientUnset() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), false).build(), false);\n+        runTestDiscoveryNodeIsRemoteClusterClient(nonRemoteClusterClientNode(), false);\n     }\n \n     private void runTestDiscoveryNodeIsRemoteClusterClient(final Settings settings, final boolean expected) {\n         final DiscoveryNode node = DiscoveryNode.createLocal(settings, new TransportAddress(TransportAddress.META_ADDRESS, 9200), \"node\");\n         assertThat(node.isRemoteClusterClient(), equalTo(expected));\n-        final Set<DiscoveryNodeRole> expectedRoles = new HashSet<>(DiscoveryNodeRole.BUILT_IN_ROLES);\n         if (expected) {\n-            assertThat(node.getRoles(), equalTo(expectedRoles));\n+            assertThat(node.getRoles(), hasItem(DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5MDI2MQ==", "bodyText": "Hmm, actually I may be misreading the before and after. Please ignore if I've misunderstood.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406190261", "createdAt": "2020-04-09T13:08:03Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/cluster/node/DiscoveryNodeTests.java", "diffHunk": "@@ -90,22 +93,20 @@ public void testDiscoveryNodeIsRemoteClusterClientDefault() {\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientSet() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), true).build(), true);\n+        runTestDiscoveryNodeIsRemoteClusterClient(remoteClusterClientNode(), true);\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientUnset() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), false).build(), false);\n+        runTestDiscoveryNodeIsRemoteClusterClient(nonRemoteClusterClientNode(), false);\n     }\n \n     private void runTestDiscoveryNodeIsRemoteClusterClient(final Settings settings, final boolean expected) {\n         final DiscoveryNode node = DiscoveryNode.createLocal(settings, new TransportAddress(TransportAddress.META_ADDRESS, 9200), \"node\");\n         assertThat(node.isRemoteClusterClient(), equalTo(expected));\n-        final Set<DiscoveryNodeRole> expectedRoles = new HashSet<>(DiscoveryNodeRole.BUILT_IN_ROLES);\n         if (expected) {\n-            assertThat(node.getRoles(), equalTo(expectedRoles));\n+            assertThat(node.getRoles(), hasItem(DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE4OTUzNA=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzcwNDE0Nw==", "bodyText": "The intention is not to test the exact list of roles, rather to test whether or not the node has the remote cluster client role based on whether or not it was in the list of configured roles. Therefore I have modified the test to reflect that.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r407704147", "createdAt": "2020-04-13T20:33:37Z", "author": {"login": "jasontedor"}, "path": "server/src/test/java/org/elasticsearch/cluster/node/DiscoveryNodeTests.java", "diffHunk": "@@ -90,22 +93,20 @@ public void testDiscoveryNodeIsRemoteClusterClientDefault() {\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientSet() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), true).build(), true);\n+        runTestDiscoveryNodeIsRemoteClusterClient(remoteClusterClientNode(), true);\n     }\n \n     public void testDiscoveryNodeIsRemoteClusterClientUnset() {\n-        runTestDiscoveryNodeIsRemoteClusterClient(Settings.builder().put(Node.NODE_REMOTE_CLUSTER_CLIENT.getKey(), false).build(), false);\n+        runTestDiscoveryNodeIsRemoteClusterClient(nonRemoteClusterClientNode(), false);\n     }\n \n     private void runTestDiscoveryNodeIsRemoteClusterClient(final Settings settings, final boolean expected) {\n         final DiscoveryNode node = DiscoveryNode.createLocal(settings, new TransportAddress(TransportAddress.META_ADDRESS, 9200), \"node\");\n         assertThat(node.isRemoteClusterClient(), equalTo(expected));\n-        final Set<DiscoveryNodeRole> expectedRoles = new HashSet<>(DiscoveryNodeRole.BUILT_IN_ROLES);\n         if (expected) {\n-            assertThat(node.getRoles(), equalTo(expectedRoles));\n+            assertThat(node.getRoles(), hasItem(DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE4OTUzNA=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDc3NTk1OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/indices/mapping/DedicatedMasterGetFieldMappingIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoxNjoyM1rOGDYMZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQwMDowMTo0OFrOGE5YUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5NTMwMw==", "bodyText": "I see that this change is reflecting what the test was doing previously, but I also notice that the class name suggests that the node should only have the master role. Am I understanding it correctly, and is it worth changing the test?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406195303", "createdAt": "2020-04-09T13:16:23Z", "author": {"login": "pugnascotia"}, "path": "server/src/test/java/org/elasticsearch/indices/mapping/DedicatedMasterGetFieldMappingIT.java", "diffHunk": "@@ -20,21 +20,18 @@\n package org.elasticsearch.indices.mapping;\n \n import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.node.Node;\n import org.junit.Before;\n \n import static org.elasticsearch.test.ESIntegTestCase.ClusterScope;\n import static org.elasticsearch.test.ESIntegTestCase.Scope;\n+import static org.elasticsearch.test.NodeRoles.nonDataNode;\n \n @ClusterScope(scope = Scope.TEST, numDataNodes = 0)\n public class DedicatedMasterGetFieldMappingIT extends SimpleGetFieldMappingsIT {\n \n     @Before\n     public void before1() throws Exception {\n-        Settings settings = Settings.builder()\n-                .put(Node.NODE_DATA_SETTING.getKey(), false)\n-                .build();\n-        internalCluster().startNodes(settings, Settings.EMPTY);\n+        internalCluster().startNodes(nonDataNode(), Settings.EMPTY);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc4NzYwMw==", "bodyText": "This test is very old though, from when we only had two roles: data and master. Historically then, disabling data meant the node only had the master role. So yes, if we want to preserve the historical intent of this test, it should be a master-only node, although functionally for this test it doesn't matter either way (if the node has the ingest and remote_cluster_client roles or not).", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r407787603", "createdAt": "2020-04-14T00:01:48Z", "author": {"login": "jasontedor"}, "path": "server/src/test/java/org/elasticsearch/indices/mapping/DedicatedMasterGetFieldMappingIT.java", "diffHunk": "@@ -20,21 +20,18 @@\n package org.elasticsearch.indices.mapping;\n \n import org.elasticsearch.common.settings.Settings;\n-import org.elasticsearch.node.Node;\n import org.junit.Before;\n \n import static org.elasticsearch.test.ESIntegTestCase.ClusterScope;\n import static org.elasticsearch.test.ESIntegTestCase.Scope;\n+import static org.elasticsearch.test.NodeRoles.nonDataNode;\n \n @ClusterScope(scope = Scope.TEST, numDataNodes = 0)\n public class DedicatedMasterGetFieldMappingIT extends SimpleGetFieldMappingsIT {\n \n     @Before\n     public void before1() throws Exception {\n-        Settings settings = Settings.builder()\n-                .put(Node.NODE_DATA_SETTING.getKey(), false)\n-                .build();\n-        internalCluster().startNodes(settings, Settings.EMPTY);\n+        internalCluster().startNodes(nonDataNode(), Settings.EMPTY);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjE5NTMwMw=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDgyMDkxOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyNzowM1rOGDYoaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzoyNzowM1rOGDYoaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIwMjQ3Mw==", "bodyText": "This is super-nit-picky, but does it make sense to map and then sort, in case the abbreviation, for some reason, ends up making the result look unsorted? It's actually what DiscoveryNode#toString() does too.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return roles.stream().sorted().map(DiscoveryNodeRole::roleNameAbbreviation).collect(Collectors.joining());\n          \n          \n            \n                    return roles.stream().map(DiscoveryNodeRole::roleNameAbbreviation).sorted().collect(Collectors.joining());", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406202473", "createdAt": "2020-04-09T13:27:03Z", "author": {"login": "pugnascotia"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java", "diffHunk": "@@ -694,19 +702,17 @@ private String buildNodeName(int id, Settings settings) {\n      * returns a suffix string based on the node role. If no explicit role is defined, the suffix will be empty\n      */\n     private static String getRoleSuffix(Settings settings) {\n-        String suffix = \"\";\n-        if (Node.NODE_MASTER_SETTING.exists(settings) && Node.NODE_MASTER_SETTING.get(settings)) {\n-            suffix = suffix + DiscoveryNodeRole.MASTER_ROLE.roleNameAbbreviation();\n+        if (NodeRoleSettings.NODE_ROLES_SETTING.exists(settings) == false) {\n+            return \"\";\n         }\n-        if (Node.NODE_DATA_SETTING.exists(settings) && Node.NODE_DATA_SETTING.get(settings)) {\n-            suffix = suffix + DiscoveryNodeRole.DATA_ROLE.roleNameAbbreviation();\n-        }\n-        if (Node.NODE_MASTER_SETTING.exists(settings) && Node.NODE_MASTER_SETTING.get(settings) == false &&\n-            Node.NODE_DATA_SETTING.exists(settings) && Node.NODE_DATA_SETTING.get(settings) == false\n-            ) {\n-            suffix = suffix + \"c\";\n+\n+        final List<DiscoveryNodeRole> roles = NodeRoleSettings.NODE_ROLES_SETTING.get(settings);\n+\n+        if (roles.isEmpty()) {\n+            return \"c\";\n         }\n-        return suffix;\n+\n+        return roles.stream().sorted().map(DiscoveryNodeRole::roleNameAbbreviation).collect(Collectors.joining());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMDg0NzY0OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/NodeRoles.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzozMzowNFrOGDY49w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxMzozMzowNFrOGDY49w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIwNjcxMQ==", "bodyText": "Would the intention be even clearer here if we used Collections.emptyList?\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return Settings.builder().put(settings).putList(NodeRoleSettings.NODE_ROLES_SETTING.getKey(), List.of()).build();\n          \n          \n            \n                    return Settings.builder().put(settings).putList(NodeRoleSettings.NODE_ROLES_SETTING.getKey(), emptyList()).build();", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406206711", "createdAt": "2020-04-09T13:33:04Z", "author": {"login": "pugnascotia"}, "path": "test/framework/src/main/java/org/elasticsearch/test/NodeRoles.java", "diffHunk": "@@ -0,0 +1,186 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.test;\n+\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.node.NodeRoleSettings;\n+\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+\n+/**\n+ * Utility methods for creating {@link Settings} instances defining a set of {@link DiscoveryNodeRole}.\n+ */\n+public class NodeRoles {\n+\n+    public static Settings onlyRole(final DiscoveryNodeRole role) {\n+        return onlyRole(Settings.EMPTY, role);\n+    }\n+\n+    public static Settings onlyRole(final Settings settings, final DiscoveryNodeRole role) {\n+        return onlyRoles(settings, Set.of(role));\n+    }\n+\n+    public static Settings onlyRoles(final Set<DiscoveryNodeRole> roles) {\n+        return onlyRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings onlyRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        return Settings.builder()\n+            .put(settings)\n+            .putList(\n+                NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+                roles.stream().map(DiscoveryNodeRole::roleName).collect(Collectors.toList()))\n+            .build();\n+    }\n+\n+    public static Settings removeRoles(final Set<DiscoveryNodeRole> roles) {\n+        return removeRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings removeRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        final Settings.Builder builder = Settings.builder().put(settings);\n+        builder.putList(\n+            NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+            NodeRoleSettings.NODE_ROLES_SETTING.get(settings)\n+                .stream()\n+                .filter(Predicate.not(roles::contains))\n+                .map(DiscoveryNodeRole::roleName)\n+                .collect(Collectors.toUnmodifiableList())\n+        );\n+        return builder.build();\n+    }\n+\n+    public static Settings addRoles(final Set<DiscoveryNodeRole> roles) {\n+        return addRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings addRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        final Settings.Builder builder = Settings.builder().put(settings);\n+        builder.putList(\n+            NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+            NodeRoleSettings.NODE_ROLES_SETTING.get(settings)\n+                .stream().filter(roles::contains)\n+                .map(DiscoveryNodeRole::roleName)\n+                .collect(Collectors.toUnmodifiableList())\n+        );\n+        return builder.build();\n+    }\n+\n+    public static Settings noRoles() {\n+        return noRoles(Settings.EMPTY);\n+    }\n+\n+    public static Settings noRoles(final Settings settings) {\n+        return Settings.builder().put(settings).putList(NodeRoleSettings.NODE_ROLES_SETTING.getKey(), List.of()).build();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 95}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTAyMjY5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNDowMFrOGDaoBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNDowMFrOGDaoBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNTE0Mw==", "bodyText": "I think this line is supposed to match nodes where ML is enabled, no? The preceding comment says \"stopping ml nodes\".", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406235143", "createdAt": "2020-04-09T14:14:00Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java", "diffHunk": "@@ -302,7 +303,7 @@ public void testMaxConcurrentJobAllocations() throws Exception {\n             Runnable r = () -> {\n                 try {\n                     internalCluster()\n-                            .stopRandomNode(settings -> settings.getAsBoolean(MachineLearning.ML_ENABLED.getKey(), false));\n+                            .stopRandomNode(settings -> DiscoveryNode.hasRole(settings, MachineLearning.ML_ROLE) == false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTAzMDgyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNTo1MFrOGDatJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMzo1MTo0N1rOGE5MQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNjQ1Mg==", "bodyText": "The code used to enable master and data here, was that a mistake in the old code?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406236452", "createdAt": "2020-04-09T14:15:50Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -127,15 +124,9 @@ public void testFullClusterRestart() throws Exception {\n     public void testCloseUnassignedJobAndDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-                .put(\"node.master\", true)\n-                .put(\"node.data\", true)\n-                .put(\"node.ml\", false)\n-                .build());\n+        internalCluster().startMasterOnlyNode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc4NDUxMg==", "bodyText": "It looks like the logging message is what is incorrect here, and the test indeed needs two data nodes.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r407784512", "createdAt": "2020-04-13T23:51:47Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -127,15 +124,9 @@ public void testFullClusterRestart() throws Exception {\n     public void testCloseUnassignedJobAndDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-                .put(\"node.master\", true)\n-                .put(\"node.data\", true)\n-                .put(\"node.ml\", false)\n-                .build());\n+        internalCluster().startMasterOnlyNode();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNjQ1Mg=="}, "originalCommit": {"oid": "eaf2b34d12a5d1b17b431f73a341acfd96f659bc"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTAzNjM5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNjo1N1rOGDawfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNjo1N1rOGDawfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzMxMA==", "bodyText": "The code here used to disable master, but now it is enabled. Which is correct?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406237310", "createdAt": "2020-04-09T14:16:57Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -127,15 +124,9 @@ public void testFullClusterRestart() throws Exception {\n     public void testCloseUnassignedJobAndDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-                .put(\"node.master\", true)\n-                .put(\"node.data\", true)\n-                .put(\"node.ml\", false)\n-                .build());\n+        internalCluster().startMasterOnlyNode();\n         logger.info(\"Starting ml and data node...\");\n-        internalCluster().startNode(Settings.builder()\n-                .put(\"node.master\", false)\n-                .build());\n+        internalCluster().startNode(onlyRoles(Set.of(DiscoveryNodeRole.DATA_ROLE, DiscoveryNodeRole.MASTER_ROLE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb82fb4e755c0c241193e7d53cd92793bcda4a2c"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTAzODk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzozNVrOGDayMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMzo1NDo0N1rOGE5QBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzc0NQ==", "bodyText": "The code used to enable master and data here, was that a mistake in the old code?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406237745", "createdAt": "2020-04-09T14:17:35Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -301,15 +284,9 @@ public void testCloseUnassignedFailedJobAndStopUnassignedStoppingDatafeed() thro\n     public void testStopAndForceStopDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", true)\n-            .put(\"node.data\", true)\n-            .put(\"node.ml\", false)\n-            .build());\n+        internalCluster().startMasterOnlyNode();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb82fb4e755c0c241193e7d53cd92793bcda4a2c"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc4NTQ3OA==", "bodyText": "Yeah, that was unnecessary in this test.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r407785478", "createdAt": "2020-04-13T23:54:47Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -301,15 +284,9 @@ public void testCloseUnassignedFailedJobAndStopUnassignedStoppingDatafeed() thro\n     public void testStopAndForceStopDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", true)\n-            .put(\"node.data\", true)\n-            .put(\"node.ml\", false)\n-            .build());\n+        internalCluster().startMasterOnlyNode();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzc0NQ=="}, "originalCommit": {"oid": "bb82fb4e755c0c241193e7d53cd92793bcda4a2c"}, "originalPosition": 100}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTA0MDMzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoxNzo1MFrOGDay_w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QyMzo1NDozM1rOGE5Ptg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk1MQ==", "bodyText": "The code here used to disable master, but now it is enabled. Which is correct?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r406237951", "createdAt": "2020-04-09T14:17:50Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -301,15 +284,9 @@ public void testCloseUnassignedFailedJobAndStopUnassignedStoppingDatafeed() thro\n     public void testStopAndForceStopDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", true)\n-            .put(\"node.data\", true)\n-            .put(\"node.ml\", false)\n-            .build());\n+        internalCluster().startMasterOnlyNode();\n         logger.info(\"Starting ml and data node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", false)\n-            .build());\n+        internalCluster().startNode(onlyRoles(Set.of(DiscoveryNodeRole.DATA_ROLE, DiscoveryNodeRole.MASTER_ROLE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bb82fb4e755c0c241193e7d53cd92793bcda4a2c"}, "originalPosition": 105}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzc4NTM5OA==", "bodyText": "Oops, that should have been MachineLearning.ML_ROLE.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r407785398", "createdAt": "2020-04-13T23:54:33Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/integration/MlDistributedFailureIT.java", "diffHunk": "@@ -301,15 +284,9 @@ public void testCloseUnassignedFailedJobAndStopUnassignedStoppingDatafeed() thro\n     public void testStopAndForceStopDatafeed() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n         logger.info(\"Starting dedicated master node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", true)\n-            .put(\"node.data\", true)\n-            .put(\"node.ml\", false)\n-            .build());\n+        internalCluster().startMasterOnlyNode();\n         logger.info(\"Starting ml and data node...\");\n-        internalCluster().startNode(Settings.builder()\n-            .put(\"node.master\", false)\n-            .build());\n+        internalCluster().startNode(onlyRoles(Set.of(DiscoveryNodeRole.DATA_ROLE, DiscoveryNodeRole.MASTER_ROLE)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjIzNzk1MQ=="}, "originalCommit": {"oid": "bb82fb4e755c0c241193e7d53cd92793bcda4a2c"}, "originalPosition": 105}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NzAyNTIyOnYy", "diffSide": "RIGHT", "path": "docs/reference/modules/node.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOToxMzo1OVrOGnghZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNjo0NToyMVrOGoaiBA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MDQ4NA==", "bodyText": "Typo:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            dedicated ingest nodes and to not have the `ingest` role on master` and `data`.\n          \n          \n            \n            dedicated ingest nodes and to not have the `ingest` role on `master` and `data`.\n          \n      \n    \n    \n  \n\nI'm not sure about the wording. Maybe:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            dedicated ingest nodes and to not have the `ingest` role on master` and `data`.\n          \n          \n            \n            dedicated ingest nodes and to remove the `ingest` role from nodes that have the `master` or `data` roles.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r444080484", "createdAt": "2020-06-23T09:13:59Z", "author": {"login": "pugnascotia"}, "path": "docs/reference/modules/node.asciidoc", "diffHunk": "@@ -22,39 +22,36 @@ dedicated data nodes, {ml} nodes, and {transform} nodes.\n \n <<master-node,Master-eligible node>>::\n \n-A node that has `node.master` set to `true` (default), which makes it eligible\n-to be <<modules-discovery,elected as the _master_ node>>, which controls the\n-cluster.\n+A node that has the `master` role (default), which makes it eligible to be\n+<<modules-discovery,elected as the _master_ node>>, which controls the cluster.\n \n <<data-node,Data node>>::\n \n-A node that has `node.data` set to `true` (default). Data nodes hold data and\n-perform data related operations such as CRUD, search, and aggregations.\n+A node that has the `data` role (default). Data nodes hold data and perform data\n+related operations such as CRUD, search, and aggregations.\n \n <<ingest,Ingest node>>::\n \n-A node that has `node.ingest` set to `true` (default). Ingest nodes are able\n-to apply an <<pipeline,ingest pipeline>> to a document in order to transform\n-and enrich the document before indexing. With a heavy ingest load, it makes\n-sense to use dedicated ingest nodes and to mark the master and data nodes as\n-`node.ingest: false`.\n+A node that has the `ingest` role (default). Ingest nodes are able to apply an\n+<<pipeline,ingest pipeline>> to a document in order to transform and enrich the\n+document before indexing. With a heavy ingest load, it makes sense to use\n+dedicated ingest nodes and to not have the `ingest` role on master` and `data`.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAzMDkxNg==", "bodyText": "Thanks I incorporated both of these.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r445030916", "createdAt": "2020-06-24T16:45:21Z", "author": {"login": "jasontedor"}, "path": "docs/reference/modules/node.asciidoc", "diffHunk": "@@ -22,39 +22,36 @@ dedicated data nodes, {ml} nodes, and {transform} nodes.\n \n <<master-node,Master-eligible node>>::\n \n-A node that has `node.master` set to `true` (default), which makes it eligible\n-to be <<modules-discovery,elected as the _master_ node>>, which controls the\n-cluster.\n+A node that has the `master` role (default), which makes it eligible to be\n+<<modules-discovery,elected as the _master_ node>>, which controls the cluster.\n \n <<data-node,Data node>>::\n \n-A node that has `node.data` set to `true` (default). Data nodes hold data and\n-perform data related operations such as CRUD, search, and aggregations.\n+A node that has the `data` role (default). Data nodes hold data and perform data\n+related operations such as CRUD, search, and aggregations.\n \n <<ingest,Ingest node>>::\n \n-A node that has `node.ingest` set to `true` (default). Ingest nodes are able\n-to apply an <<pipeline,ingest pipeline>> to a document in order to transform\n-and enrich the document before indexing. With a heavy ingest load, it makes\n-sense to use dedicated ingest nodes and to mark the master and data nodes as\n-`node.ingest: false`.\n+A node that has the `ingest` role (default). Ingest nodes are able to apply an\n+<<pipeline,ingest pipeline>> to a document in order to transform and enrich the\n+document before indexing. With a heavy ingest load, it makes sense to use\n+dedicated ingest nodes and to not have the `ingest` role on master` and `data`.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MDQ4NA=="}, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NzAzMzQzOnYy", "diffSide": "RIGHT", "path": "docs/reference/modules/node.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOToxNjowNVrOGngmsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNjo0NTozNFrOGoaieA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MTg0Mw==", "bodyText": "Is this from a merge conflict?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r444081843", "createdAt": "2020-06-23T09:16:05Z", "author": {"login": "pugnascotia"}, "path": "docs/reference/modules/node.asciidoc", "diffHunk": "@@ -256,6 +195,7 @@ node.remote_cluster_client: false <4>\n <2> The `node.data` role is enabled by default.\n <3> Disable the `node.ingest` role (enabled by default).\n <4> Disable remote cluster connections (enabled by default).\n+>>>>>>> elastic", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 198}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAzMTAzMg==", "bodyText": "Yes, thanks for catching that!", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r445031032", "createdAt": "2020-06-24T16:45:34Z", "author": {"login": "jasontedor"}, "path": "docs/reference/modules/node.asciidoc", "diffHunk": "@@ -256,6 +195,7 @@ node.remote_cluster_client: false <4>\n <2> The `node.data` role is enabled by default.\n <3> Disable the `node.ingest` role (enabled by default).\n <4> Disable remote cluster connections (enabled by default).\n+>>>>>>> elastic", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA4MTg0Mw=="}, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 198}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NzExNzU4OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTozOTowOVrOGnhcUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNFQxNjo0ODoxM1rOGoapPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA5NTU3MQ==", "bodyText": "The method is testing settings.hasValue(\"node.roles\") three times. Could we just test it once, and put the rest of the code in the \"then\" block?", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r444095571", "createdAt": "2020-06-23T09:39:09Z", "author": {"login": "pugnascotia"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java", "diffHunk": "@@ -707,15 +712,15 @@ private String buildNodeName(int id, Settings settings) {\n      */\n     private static String getRoleSuffix(Settings settings) {\n         String suffix = \"\";\n-        if (Node.NODE_MASTER_SETTING.exists(settings) && Node.NODE_MASTER_SETTING.get(settings)) {\n+        if (settings.hasValue(\"node.roles\") && DiscoveryNode.hasRole(settings, DiscoveryNodeRole.MASTER_ROLE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTAzMjc2Nw==", "bodyText": "Thanks, I included this.", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r445032767", "createdAt": "2020-06-24T16:48:13Z", "author": {"login": "jasontedor"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalTestCluster.java", "diffHunk": "@@ -707,15 +712,15 @@ private String buildNodeName(int id, Settings settings) {\n      */\n     private static String getRoleSuffix(Settings settings) {\n         String suffix = \"\";\n-        if (Node.NODE_MASTER_SETTING.exists(settings) && Node.NODE_MASTER_SETTING.get(settings)) {\n+        if (settings.hasValue(\"node.roles\") && DiscoveryNode.hasRole(settings, DiscoveryNodeRole.MASTER_ROLE)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDA5NTU3MQ=="}, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NzE1MTk0OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/NodeRoles.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTo0ODozNFrOGnhx0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTo0ODozNFrOGnhx0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwMTA3Mg==", "bodyText": "I can't help wondering if the roles setting implementation should be using a Set to begin with. \ud83e\udd37\u200d\u2642\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r444101072", "createdAt": "2020-06-23T09:48:34Z", "author": {"login": "pugnascotia"}, "path": "test/framework/src/main/java/org/elasticsearch/test/NodeRoles.java", "diffHunk": "@@ -0,0 +1,187 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.test;\n+\n+import org.elasticsearch.cluster.node.DiscoveryNodeRole;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.node.NodeRoleSettings;\n+\n+import java.util.List;\n+import java.util.Set;\n+import java.util.function.Predicate;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+/**\n+ * Utility methods for creating {@link Settings} instances defining a set of {@link DiscoveryNodeRole}.\n+ */\n+public class NodeRoles {\n+\n+    public static Settings onlyRole(final DiscoveryNodeRole role) {\n+        return onlyRole(Settings.EMPTY, role);\n+    }\n+\n+    public static Settings onlyRole(final Settings settings, final DiscoveryNodeRole role) {\n+        return onlyRoles(settings, Set.of(role));\n+    }\n+\n+    public static Settings onlyRoles(final Set<DiscoveryNodeRole> roles) {\n+        return onlyRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings onlyRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        return Settings.builder()\n+            .put(settings)\n+            .putList(\n+                NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+                roles.stream().map(DiscoveryNodeRole::roleName).collect(Collectors.toUnmodifiableList()))\n+            .build();\n+    }\n+\n+    public static Settings removeRoles(final Set<DiscoveryNodeRole> roles) {\n+        return removeRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings removeRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        final Settings.Builder builder = Settings.builder().put(settings);\n+        builder.putList(\n+            NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+            NodeRoleSettings.NODE_ROLES_SETTING.get(settings)\n+                .stream()\n+                .filter(Predicate.not(roles::contains))\n+                .map(DiscoveryNodeRole::roleName)\n+                .collect(Collectors.toUnmodifiableList())\n+        );\n+        return builder.build();\n+    }\n+\n+    public static Settings addRoles(final Set<DiscoveryNodeRole> roles) {\n+        return addRoles(Settings.EMPTY, roles);\n+    }\n+\n+    public static Settings addRoles(final Settings settings, final Set<DiscoveryNodeRole> roles) {\n+        final Settings.Builder builder = Settings.builder().put(settings);\n+        builder.putList(\n+            NodeRoleSettings.NODE_ROLES_SETTING.getKey(),\n+            Stream.concat(NodeRoleSettings.NODE_ROLES_SETTING.get(settings).stream(), roles.stream())\n+                .map(DiscoveryNodeRole::roleName)\n+                .distinct()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc2NzE2NDYwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTo1MjowNFrOGnh5tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QwOTo1MjowNFrOGnh5tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEwMzA5NQ==", "bodyText": "Would it be worth extracting a constant, since this is referenced a lot?\nprivate final mlRole = Set.of(MachineLearning.ML_ROLE);", "url": "https://github.com/elastic/elasticsearch/pull/54998#discussion_r444103095", "createdAt": "2020-06-23T09:52:04Z", "author": {"login": "pugnascotia"}, "path": "x-pack/plugin/ml/src/internalClusterTest/java/org/elasticsearch/xpack/ml/integration/BasicDistributedJobsIT.java", "diffHunk": "@@ -150,8 +155,8 @@ public void testFailOverBasics_withDataFeeder() throws Exception {\n \n     public void testJobAutoClose() throws Exception {\n         internalCluster().ensureAtMostNumDataNodes(0);\n-        internalCluster().startNode(Settings.builder().put(MachineLearning.ML_ENABLED.getKey(), false));\n-        internalCluster().startNode(Settings.builder().put(MachineLearning.ML_ENABLED.getKey(), true));\n+        internalCluster().startNode(removeRoles(Set.of(MachineLearning.ML_ROLE)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d593f0228fb038d0d9a26a8b4b85c074143c299"}, "originalPosition": 29}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1202, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}