{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTM2OTU0MTc5", "number": 66204, "title": "limit the depth of nested bool queries", "bodyText": "limit the depth of nested bool queries\nfix #55303", "createdAt": "2020-12-11T14:41:11Z", "url": "https://github.com/elastic/elasticsearch/pull/66204", "merged": true, "mergeCommit": {"oid": "168d98b7dd8b9870b3c395c89d830c4a6c9878ce"}, "closed": true, "closedAt": "2021-01-12T14:36:10Z", "author": {"login": "chengyang14"}, "timelineItems": {"totalCount": 22, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdlTcqOAH2gAyNTM2OTU0MTc5OmJiYzI4MThjNWI5MTRkNmM3ZDRlYzQwYzQ4NzJkNjI0YzA3YzgzNjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvIMjvAH2gAyNTM2OTU0MTc5OjY4YmE3OTYxZGI3YTFmZTc5NWVlNDIzZDBkMDlkNTRkMjI0MDJkMTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "committedDate": "2020-12-12T02:51:56Z", "message": "limit the depth of nested bool queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8168221b4c0c70b683108c88e162a65478acb7e", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8168221b4c0c70b683108c88e162a65478acb7e", "committedDate": "2020-12-11T13:34:25Z", "message": "limit the depth of nested bool queries"}, "afterCommit": {"oid": "bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbc2818c5b914d6c7d4ec40c4872d624c07c8360", "committedDate": "2020-12-12T02:51:56Z", "message": "limit the depth of nested bool queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "committedDate": "2020-12-14T04:39:33Z", "message": "limit the depth of nested bool queries"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ed3347cd98a5cff5f5a860b146c5dfecd5356aa5", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed3347cd98a5cff5f5a860b146c5dfecd5356aa5", "committedDate": "2020-12-14T04:33:28Z", "message": "remove unsed fields in `RestAnalyzeAction`"}, "afterCommit": {"oid": "6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ecb2e93e2cb00e94d9cde6d78f61aa1a7a4c4cc", "committedDate": "2020-12-14T04:39:33Z", "message": "limit the depth of nested bool queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "261b06d8eb298d4208240b6d7b51c36503b249cd", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/261b06d8eb298d4208240b6d7b51c36503b249cd", "committedDate": "2020-12-26T12:31:33Z", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd0be6a669e51b684f9e4ed17f93a55fa3b14b56", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd0be6a669e51b684f9e4ed17f93a55fa3b14b56", "committedDate": "2020-12-26T15:12:33Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "34e739d250a2313d24a78ffff418f8fc99a2dbd6", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/34e739d250a2313d24a78ffff418f8fc99a2dbd6", "committedDate": "2020-12-26T15:15:36Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "34e739d250a2313d24a78ffff418f8fc99a2dbd6", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/34e739d250a2313d24a78ffff418f8fc99a2dbd6", "committedDate": "2020-12-26T15:15:36Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "committedDate": "2020-12-26T15:18:03Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ce6d44f5bd27623537e2e7fc2efcbb6f39d8547", "committedDate": "2020-12-26T15:18:03Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "committedDate": "2020-12-26T15:19:29Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/e79c6742bb26b02f7c2c0c83c771dd7ba9daf271", "committedDate": "2020-12-26T15:19:29Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "50e4606fab3f1c0b611932af8314c9d00ee214a7", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/50e4606fab3f1c0b611932af8314c9d00ee214a7", "committedDate": "2020-12-26T15:21:22Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50e4606fab3f1c0b611932af8314c9d00ee214a7", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/50e4606fab3f1c0b611932af8314c9d00ee214a7", "committedDate": "2020-12-26T15:21:22Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "committedDate": "2020-12-27T02:38:35Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/335bc1a1012af1a3c4d621584de65613863dc18e", "committedDate": "2020-12-27T02:40:17Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0e8e19fd78552ef7e31caa2ec60ad12412d8d96", "committedDate": "2020-12-27T02:38:35Z", "message": " put bool depth check in the parsing stage"}, "afterCommit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/335bc1a1012af1a3c4d621584de65613863dc18e", "committedDate": "2020-12-27T02:40:17Z", "message": " put bool depth check in the parsing stage"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYxODM1NDY1", "url": "https://github.com/elastic/elasticsearch/pull/66204#pullrequestreview-561835465", "createdAt": "2021-01-05T14:32:25Z", "commit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNDozMjoyNlrOIOZcZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0wNVQxNTo1Mzo0OFrOIOcqvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk2Nzg0NQ==", "bodyText": "should we call this setting max_nested_depth?", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r551967845", "createdAt": "2021-01-05T14:32:26Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -269,6 +270,9 @@\n     public static final Setting<Integer> INDICES_MAX_CLAUSE_COUNT_SETTING = Setting.intSetting(\"indices.query.bool.max_clause_count\",\n             1024, 1, Integer.MAX_VALUE, Setting.Property.NodeScope);\n \n+    public static final Setting<Integer> INDICES_MAX_CLAUSE_NESTED_SETTING = Setting.intSetting(\"indices.query.bool.max_nested_count\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MTk2ODE0OA==", "bodyText": "should we can this function setMaxNestedDepth and also for corresponding error message?", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r551968148", "createdAt": "2021-01-05T14:32:53Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -91,6 +92,17 @@ public BoolQueryBuilder(StreamInput in) throws IOException {\n         minimumShouldMatch = in.readOptionalString();\n     }\n \n+    /**\n+     * Set the maximum number of nested permitted per BooleanQuery.\n+     * Default value is 20.\n+     */\n+    public static void setMaxClauseCount(int maxNestedCount) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAyMDI5OA==", "bodyText": "may be an error message should be more detailed including what setting should be modified:\n\"the nested depth of the query exceeds the maximum nested depth for bool queries set in [\" + the name of the setting", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r552020298", "createdAt": "2021-01-05T15:53:17Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -288,8 +300,12 @@ private static void doXArrayContent(ParseField field, List<QueryBuilder> clauses\n         PARSER.declareFloat(BoolQueryBuilder::boost, BOOST_FIELD);\n     }\n \n-    public static BoolQueryBuilder fromXContent(XContentParser parser) throws IOException, ParsingException {\n-        return PARSER.parse(parser, null);\n+    public static BoolQueryBuilder fromXContent(XContentParser parser, Integer nestedDepth) throws IOException, ParsingException {\n+        nestedDepth++;\n+        if (nestedDepth > maxNestedCount) {\n+            throw new IllegalArgumentException(\"maxNestedDepth is set to \" + maxNestedCount + \", but current depth is \" + nestedDepth);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MjAyMDY2OA==", "bodyText": "should it be maxNestedDepth?", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r552020668", "createdAt": "2021-01-05T15:53:48Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/index/query/BoolQueryBuilder.java", "diffHunk": "@@ -59,6 +59,7 @@\n     private static final ParseField MUST = new ParseField(\"must\");\n     private static final ParseField MINIMUM_SHOULD_MATCH = new ParseField(\"minimum_should_match\");\n     private static final ParseField ADJUST_PURE_NEGATIVE = new ParseField(\"adjust_pure_negative\");\n+    private static int maxNestedCount = 20;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "335bc1a1012af1a3c4d621584de65613863dc18e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5b583341479fdc14dde29083e391ab47ae4a962", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5b583341479fdc14dde29083e391ab47ae4a962", "committedDate": "2021-01-06T14:01:34Z", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdc5faffdbb54c575ccd356f805b394c9e27d435", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdc5faffdbb54c575ccd356f805b394c9e27d435", "committedDate": "2021-01-07T14:17:05Z", "message": "add test and doc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1e115891fc6049358b744a2dfae019166179e01e", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e115891fc6049358b744a2dfae019166179e01e", "committedDate": "2021-01-07T14:13:31Z", "message": "add test and doc"}, "afterCommit": {"oid": "fdc5faffdbb54c575ccd356f805b394c9e27d435", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdc5faffdbb54c575ccd356f805b394c9e27d435", "committedDate": "2021-01-07T14:17:05Z", "message": "add test and doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "042041e6bdba02dcf1f81974ed700d8ca92f6028", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/042041e6bdba02dcf1f81974ed700d8ca92f6028", "committedDate": "2021-01-07T14:24:59Z", "message": "add test and doc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "73978bad603b9227277ed59d031ca46b34aacef5", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/73978bad603b9227277ed59d031ca46b34aacef5", "committedDate": "2021-01-07T14:19:41Z", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth"}, "afterCommit": {"oid": "042041e6bdba02dcf1f81974ed700d8ca92f6028", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/042041e6bdba02dcf1f81974ed700d8ca92f6028", "committedDate": "2021-01-07T14:24:59Z", "message": "add test and doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/62785d4ecb28c91e3b132ffad4e0bab32594ccfc", "committedDate": "2021-01-10T01:49:29Z", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1Mzk0MDY0", "url": "https://github.com/elastic/elasticsearch/pull/66204#pullrequestreview-565394064", "createdAt": "2021-01-11T14:18:56Z", "commit": {"oid": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNDoxODo1N1rOIRXPMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xMVQxNDoyMDoyNlrOIRXTFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA3NzQyNw==", "bodyText": "May be a little paraphrase the last sentence: \"Deep nesting of boolean queries may lead to stack overflow.\"", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r555077427", "createdAt": "2021-01-11T14:18:57Z", "author": {"login": "mayya-sharipova"}, "path": "docs/reference/modules/indices/search-settings.asciidoc", "diffHunk": "@@ -24,4 +24,11 @@ few resources.\n Maximum number of <<search-aggregations-bucket,aggregation buckets>> allowed in\n a single response. Defaults to 65,535.\n +\n-Requests that attempt to return more than this limit will return an error.\n\\ No newline at end of file\n+Requests that attempt to return more than this limit will return an error.\n+\n+[[indices-query-bool-max-nested-depth]]\n+`indices.query.bool.max_nested_depth`::\n+(<<static-cluster-setting,Static>>, integer) Maximum nested depth of bool queries. Defaults to `20`.\n++\n+This setting limits the nesting depth of bool queries. Nesting too deep will lead to stack overflow\n+errors.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1NTA3ODQyMA==", "bodyText": "The format of assertEquals is assertEquals(expected, actual), so we should write:\nassertEquals(\"The nested...\", e.getCause().getCause().getMessage());", "url": "https://github.com/elastic/elasticsearch/pull/66204#discussion_r555078420", "createdAt": "2021-01-11T14:20:26Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/test/java/org/elasticsearch/index/query/BoolQueryBuilderTests.java", "diffHunk": "@@ -447,4 +450,17 @@ public void testMustRewrite() throws IOException {\n                 () -> boolQuery.toQuery(context));\n         assertEquals(\"Rewrite first\", e.getMessage());\n     }\n+\n+    public void testExceedMaxNestedDepth() throws IOException {\n+        BoolQueryBuilder query = new BoolQueryBuilder();\n+        query.should(new BoolQueryBuilder().should(new BoolQueryBuilder().should(RandomQueryBuilder.createQuery(random()))));\n+        BoolQueryBuilder.setMaxNestedDepth(2);\n+        try (XContentParser parser = createParser(JsonXContent.jsonXContent, query.toString())) {\n+            XContentParseException e = expectThrows(XContentParseException.class,\n+                () -> parseInnerQueryBuilder(parser));\n+            assertThat(e.getCause().getCause(), Matchers.instanceOf(IllegalArgumentException.class));\n+            assertEquals(e.getCause().getCause().getMessage(), \"The nested depth of the query exceeds the maximum nested depth for bool queries set in [\" +\n+                INDICES_MAX_NESTED_DEPTH_SETTING.getKey() + \"]\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "62785d4ecb28c91e3b132ffad4e0bab32594ccfc"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edb278b64ffb7129400da170fd5b60c790df48e9", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/edb278b64ffb7129400da170fd5b60c790df48e9", "committedDate": "2021-01-11T15:21:18Z", "message": "address comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68ba7961db7a1fe795ee423d0d09d54d22402d10", "author": {"user": {"login": "chengyang14", "name": "Yang Cheng"}}, "url": "https://github.com/elastic/elasticsearch/commit/68ba7961db7a1fe795ee423d0d09d54d22402d10", "committedDate": "2021-01-11T15:24:38Z", "message": "Merge remote-tracking branch 'upstream/master' into limit_bool_query_depth"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4589, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}