{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1NzE5Mjk5", "number": 60122, "title": "Clean existing index folder when loading searchable snapshot", "bodyText": "Closing a regular index and mounting a snapshot-backed index into that existing index does not clean the existing index folders of those preexisting shards.\nThis PR removes the existing Lucene / translog files once the searchable snapshot shard is starting up. Future PRs will make  reuse of the existing  index files to populate the cache.", "createdAt": "2020-07-23T13:46:07Z", "url": "https://github.com/elastic/elasticsearch/pull/60122", "merged": true, "mergeCommit": {"oid": "2c746886096428d160f322674b189289c38f2fd1"}, "closed": true, "closedAt": "2020-07-29T12:06:35Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3voXsgH2gAyNDU1NzE5Mjk5OmJlNjAwNGIwZmRmZThiMzcxYzcxNGNiZGYyOThkNTFkZGQwNmQxOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5orcMgFqTQ1NzQwMzY0NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be6004b0fdfe8b371c714cbdf298d51ddd06d199", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/be6004b0fdfe8b371c714cbdf298d51ddd06d199", "committedDate": "2020-07-23T13:41:33Z", "message": "Clean existing index folder when loading searchable snapshot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f50a36d6c9cca16d4e5481ffb4b3f3f4d1924ee", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f50a36d6c9cca16d4e5481ffb4b3f3f4d1924ee", "committedDate": "2020-07-28T07:58:41Z", "message": "Merge remote-tracking branch 'elastic/master' into clean-existing-index-files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "705f14613ed9c98548ff692445038f24d573c215", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/705f14613ed9c98548ff692445038f24d573c215", "committedDate": "2020-07-28T08:07:05Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/e87fcb1888f482e9b1a50435c470a9cce4b662cf", "committedDate": "2020-07-28T08:16:49Z", "message": "one more test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2NzYxMjMy", "url": "https://github.com/elastic/elasticsearch/pull/60122#pullrequestreview-456761232", "createdAt": "2020-07-28T15:38:22Z", "commit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTozODoyMlrOG4SrFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxNTo0NzowMFrOG4TCnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY3OTM4MA==", "bodyText": "Should this be randomBoolean() instead of false?", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461679380", "createdAt": "2020-07-28T15:38:22Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -126,7 +133,14 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         assertThat(snapshotInfo.successfulShards(), greaterThan(0));\n         assertThat(snapshotInfo.successfulShards(), equalTo(snapshotInfo.totalShards()));\n \n-        assertAcked(client().admin().indices().prepareDelete(indexName));\n+        assertShardFolders(indexName, false);\n+\n+        final boolean deletedBeforeMount = false;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTY4NTQwNA==", "bodyText": "Can we assert that we actually asserted this on the right number of nodes (or at least one node)? Just to make sure this isn't vacuous.", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r461685404", "createdAt": "2020-07-28T15:47:00Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -275,6 +292,29 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n \n     }\n \n+    private void assertShardFolders(String indexName, boolean snapshotDirectory) throws IOException {\n+        final Index restoredIndex = resolveIndex(indexName);\n+        final ShardId shardId = new ShardId(restoredIndex, 0);\n+        for (String node : internalCluster().getNodeNames()) {\n+            final NodeEnvironment service = internalCluster().getInstance(NodeEnvironment.class, node);\n+            final ShardPath shardPath = ShardPath.loadShardPath(logger, service, shardId, null);\n+            if (shardPath != null && Files.exists(shardPath.getDataPath())) {\n+                assertEquals(snapshotDirectory, Files.notExists(shardPath.resolveIndex()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e87fcb1888f482e9b1a50435c470a9cce4b662cf"}, "originalPosition": 89}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8461d1ec364ffb71d1e14a945f077719f376f6a", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8461d1ec364ffb71d1e14a945f077719f376f6a", "committedDate": "2020-07-28T16:22:12Z", "message": "review cmments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "445fca95e8abc3db546e6353005461f04baa281c", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/445fca95e8abc3db546e6353005461f04baa281c", "committedDate": "2020-07-28T16:22:34Z", "message": "Merge remote-tracking branch 'elastic/master' into clean-existing-index-files"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MjQ3ODcx", "url": "https://github.com/elastic/elasticsearch/pull/60122#pullrequestreview-457247871", "createdAt": "2020-07-29T07:06:17Z", "commit": {"oid": "445fca95e8abc3db546e6353005461f04baa281c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowNjoxN1rOG4rV_Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQwNzowNjoxN1rOG4rV_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjA4MzU4MQ==", "bodyText": "Ah sorry another lost randomBoolean() here, and I'm guessing that deletedBeforeMount doesn't make sense if restoring into a different index name.", "url": "https://github.com/elastic/elasticsearch/pull/60122#discussion_r462083581", "createdAt": "2020-07-29T07:06:17Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -77,7 +84,7 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n         final String fsRepoName = randomAlphaOfLength(10);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final String aliasName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n-        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = true ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "445fca95e8abc3db546e6353005461f04baa281c"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "070d93c038553296b530e2c688afdc5b613cea1b", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/070d93c038553296b530e2c688afdc5b613cea1b", "committedDate": "2020-07-29T08:16:00Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "012b711b561a00d3bf18a9f9a84e5d251ee6118c", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/012b711b561a00d3bf18a9f9a84e5d251ee6118c", "committedDate": "2020-07-29T08:35:51Z", "message": "so much fun fighting our tooling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3NDAzNjQ0", "url": "https://github.com/elastic/elasticsearch/pull/60122#pullrequestreview-457403644", "createdAt": "2020-07-29T10:43:25Z", "commit": {"oid": "012b711b561a00d3bf18a9f9a84e5d251ee6118c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4122, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}