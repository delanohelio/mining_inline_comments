{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTA2OTE5", "number": 64423, "title": "Allow registering compatible handlers", "bodyText": "Adding an infrastructure to allow for registration of Compatible Handlers.\nCompatible handlers are RestHandlers used for handling rest request from old version clients ( CURRENT-1 version). They might be registered under an endpoint that was removed or changed in CURRENT version (different path, method or an endpoint completely removed).\nBut they also can be registered under the same endpoint (same path, method as the RestHandler in CURRENT)\nRestHandler's endpoint is at the moment 2dimensional - a method and a path.\nThis PR adds a 3rd dimension - a version.\nRegistration:\nRestHandler declares a new compatibleWithVersion method, which will be overridden by Compatible Handlers and returning a Version.CURRENT -1. By default the method returns Version.CURRENT\ncompatibleWithVersion is used when iterating over handlers within RestController#registerHandler. The returned value is used to set a version on MethodHandlers\nLookup:\nAn interface CompatibleVersion is introduced in order to abstract a logic to calculate a compatible version requested by a user.\nIt is not implemented in this PR. A simplified, always returning Version.CURRENT implementation is used.\nWithin RestController, a version is calculated with the use of CompatibleVersion, then the lookup for MethodHandlers is performed (the logic is the same)\nOnce it is find, an additional lookup for a RestHandler for requested version is made.\nThe requested version has to be also passed down to XContentBuilder in order to allow for per version serialisation logic\nrelates #51816", "createdAt": "2020-10-30T16:01:13Z", "url": "https://github.com/elastic/elasticsearch/pull/64423", "merged": true, "mergeCommit": {"oid": "618d8bcec62ecc963ad277e01175b6859e341b3c"}, "closed": true, "closedAt": "2020-11-16T08:11:25Z", "author": {"login": "pgomulka"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXjWiJgH2gAyNTEzMTA2OTE5OmU0NjhmZGYzNTBjNTRiY2ZkNjNlZTlhMWYyMjEyMzI0NzhjMTExYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbMN3oAH2gAyNTEzMTA2OTE5OjAyM2M4ZDk5MmQ2ODUzYjJmYTRhM2VkYTI0ODY1NGNiODJjZWU3MDE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e468fdf350c54bcfd63ee9a1f221232478c111bc", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e468fdf350c54bcfd63ee9a1f221232478c111bc", "committedDate": "2020-10-30T09:28:47Z", "message": "Introduce per endpoint media types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cfa11e9db3416a4f7920806977f1333b1c837fa", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cfa11e9db3416a4f7920806977f1333b1c837fa", "committedDate": "2020-10-30T09:45:06Z", "message": "Merge branch 'master' into compat/parsed_media_type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66224e74f5ede806080c282914870ebac7a8c508", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/66224e74f5ede806080c282914870ebac7a8c508", "committedDate": "2020-10-30T10:14:20Z", "message": "allow smile and cbor to parse charset param. See ClientYamlTestExecutionContext:L122"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29b27e805f8e31f7b2e21cd54ae9a2342d9398aa", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/29b27e805f8e31f7b2e21cd54ae9a2342d9398aa", "committedDate": "2020-10-30T12:37:26Z", "message": "javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "46903625a056c3f615d0c593370e3c442b1a99b5", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/46903625a056c3f615d0c593370e3c442b1a99b5", "committedDate": "2020-10-30T12:42:38Z", "message": "fix javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7866a982d18f3beecc26a217b600f0fc96ba110", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7866a982d18f3beecc26a217b600f0fc96ba110", "committedDate": "2020-10-30T15:59:56Z", "message": "Allow registration of compatible version-1 handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0330d97d2c3722f09530e2ab0546d738981536ef", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/0330d97d2c3722f09530e2ab0546d738981536ef", "committedDate": "2020-11-02T12:27:48Z", "message": "add tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78d46603e02134a026b95ac48bfb76704a998e1c", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/78d46603e02134a026b95ac48bfb76704a998e1c", "committedDate": "2020-11-02T15:00:13Z", "message": "Merge branch 'master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc5de8b5c53664ab70e3e0c45342ea7b3af7398b", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/bc5de8b5c53664ab70e3e0c45342ea7b3af7398b", "committedDate": "2020-11-02T15:19:00Z", "message": "pass version to xcontentbuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f958cdd0d4e1118048051bf20dd7748f517f34bc", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/f958cdd0d4e1118048051bf20dd7748f517f34bc", "committedDate": "2020-11-02T16:47:19Z", "message": "Merge branch 'master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bda74f773d6b682deaa0c256a3568cbc0c1956c", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bda74f773d6b682deaa0c256a3568cbc0c1956c", "committedDate": "2020-11-03T12:15:42Z", "message": "code review follow up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7779083b4e5ed3301bd75bfc340bff51bae2042c", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/7779083b4e5ed3301bd75bfc340bff51bae2042c", "committedDate": "2020-11-03T12:52:14Z", "message": "minor tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd26408343b5633d4981d15207c5a714a8a44e7e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd26408343b5633d4981d15207c5a714a8a44e7e", "committedDate": "2020-11-03T12:52:41Z", "message": "Merge branch 'master' into compat/introduce_per_endpoint_media_types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94b4a0a85ece16e597818e815d958675e5879125", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/94b4a0a85ece16e597818e815d958675e5879125", "committedDate": "2020-11-03T13:41:27Z", "message": "fix test after exception msg rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43855911ed3ec0ad1d245cc398e7d67f59acb975", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/43855911ed3ec0ad1d245cc398e7d67f59acb975", "committedDate": "2020-11-03T15:30:35Z", "message": "rename to header value"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc61731ba05c6d2338ff46cf3f3bf665b334c525", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc61731ba05c6d2338ff46cf3f3bf665b334c525", "committedDate": "2020-11-04T09:24:25Z", "message": "remove charset validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a3138dd46c7826e902f0375e2a61d5aef036c70", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a3138dd46c7826e902f0375e2a61d5aef036c70", "committedDate": "2020-11-05T07:33:33Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jay Modi <jaymode@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b565e566cfb0555b25d02e082105bb482e7e6fd", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b565e566cfb0555b25d02e082105bb482e7e6fd", "committedDate": "2020-11-05T08:02:03Z", "message": "javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b35ad2ce54f0577edd332d8ebedb4fa817475e71", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/b35ad2ce54f0577edd332d8ebedb4fa817475e71", "committedDate": "2020-11-05T08:02:35Z", "message": "Merge branch 'master' into compat/introduce_per_endpoint_media_types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b908bfebd14c7157aeb7592f17c4907d8e9c6a7f", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/b908bfebd14c7157aeb7592f17c4907d8e9c6a7f", "committedDate": "2020-11-05T08:03:20Z", "message": "Merge branch 'compat/introduce_per_endpoint_media_types' of github.com:pgomulka/elasticsearch into compat/introduce_per_endpoint_media_types"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "950ba7b922b323db01e225855604f90d8dcc5286", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/950ba7b922b323db01e225855604f90d8dcc5286", "committedDate": "2020-11-05T08:50:14Z", "message": "Merge branch 'compat/introduce_per_endpoint_media_types' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "310b735cbeecb65ee6e212ea46d655948236269a", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/310b735cbeecb65ee6e212ea46d655948236269a", "committedDate": "2020-11-05T08:51:21Z", "message": "Merge branch 'master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0MDg3OTIx", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-524087921", "createdAt": "2020-11-05T09:47:18Z", "commit": {"oid": "310b735cbeecb65ee6e212ea46d655948236269a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0NzoxOVrOHt7Q1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQwOTo0NzoxOVrOHt7Q1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg==", "bodyText": "I really can't remember the use cases where we needed this. (returning a v8 handler when a handler was not present in v7)\n@jaymode   made a comment about this when we were still working on a feature branch https://github.com/elastic/elasticsearch/pull/54197/files#r414959451", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r517918932", "createdAt": "2020-11-05T09:47:19Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +58,16 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Returns the handler for the given method and version or {@code null} if none exists.\n      */\n-    @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+        if (versionToHandlers == null) {\n+            return null; //method not found\n+        }\n+        final RestHandler handler = versionToHandlers.get(version);\n+        return handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "310b735cbeecb65ee6e212ea46d655948236269a"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "afba70d3cd862b7b3a83536381bf32e5cea575e6", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/afba70d3cd862b7b3a83536381bf32e5cea575e6", "committedDate": "2020-11-05T09:57:15Z", "message": "javadoc and cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NzIzNDk0", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-524723494", "createdAt": "2020-11-05T22:30:21Z", "commit": {"oid": "afba70d3cd862b7b3a83536381bf32e5cea575e6"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjozMDoyMVrOHuZMjg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQyMjo0NDo0MlrOHuZlHw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQwOTM1OA==", "bodyText": "not sure i follow the second sentence (Intended to be ...)", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518409358", "createdAt": "2020-11-05T22:30:21Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/CompatibleVersion.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.rest;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.xcontent.ParsedMediaType;\n+\n+/**\n+ * An interface used to specify a function that returns a compatible API version\n+ * Intended to be used in a code base instead of a plugin.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afba70d3cd862b7b3a83536381bf32e5cea575e6"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODQxNTY0Nw==", "bodyText": "Can you a few unit tests for this class ?", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518415647", "createdAt": "2020-11-05T22:44:42Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -31,23 +31,25 @@\n final class MethodHandlers {\n \n     private final String path;\n-    private final Map<RestRequest.Method, RestHandler> methodHandlers;\n+    private final Map<RestRequest.Method, Map<Version, RestHandler>> methodHandlers;\n \n-    MethodHandlers(String path, RestHandler handler, RestRequest.Method... methods) {\n+    MethodHandlers(String path, RestHandler handler, Version version,  RestRequest.Method... methods) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "afba70d3cd862b7b3a83536381bf32e5cea575e6"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385f5a9a7538dc44a7052c1c029ac24c70dd20ce", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/385f5a9a7538dc44a7052c1c029ac24c70dd20ce", "committedDate": "2020-11-06T06:59:03Z", "message": "Merge branch 'master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/836fe0f1b842929aa6c6e46694aa4e8ca8dead95", "committedDate": "2020-11-06T08:09:28Z", "message": "tests and javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzMzMDE2", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-525333016", "createdAt": "2020-11-06T17:00:00Z", "commit": {"oid": "310b735cbeecb65ee6e212ea46d655948236269a"}, "state": "COMMENTED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowMDowMFrOHu2DNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxNzowNzowOFrOHu2Saw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MjEwMg==", "bodyText": "I think the reason for this is @Mpdreamz's comment #60516 (comment) where clients plan to send compatible with to all APIs. If this is the case, can we please document this in code/method so we do not lose the information", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518882102", "createdAt": "2020-11-06T17:00:00Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/rest/MethodHandlers.java", "diffHunk": "@@ -56,11 +58,16 @@ MethodHandlers addMethods(RestHandler handler, RestRequest.Method... methods) {\n     }\n \n     /**\n-     * Returns the handler for the given method or {@code null} if none exists.\n+     * Returns the handler for the given method and version or {@code null} if none exists.\n      */\n-    @Nullable\n-    RestHandler getHandler(RestRequest.Method method) {\n-        return methodHandlers.get(method);\n+    RestHandler getHandler(RestRequest.Method method, Version version) {\n+        Map<Version, RestHandler> versionToHandlers = methodHandlers.get(method);\n+        if (versionToHandlers == null) {\n+            return null; //method not found\n+        }\n+        final RestHandler handler = versionToHandlers.get(version);\n+        return handler != null || version.equals(Version.CURRENT) ? handler : versionToHandlers.get(Version.CURRENT);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzkxODkzMg=="}, "originalCommit": {"oid": "310b735cbeecb65ee6e212ea46d655948236269a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4Mjk0Nw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){\n          \n          \n            \n                public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion) {", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518882947", "createdAt": "2020-11-06T17:01:30Z", "author": {"login": "jaymode"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,15 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4MzU1Mw==", "bodyText": "can you add javadocs to this method and the one above?", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518883553", "createdAt": "2020-11-06T17:02:40Z", "author": {"login": "jaymode"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,15 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion){\n+        this.compatibleMajorVersion = compatibleMajorVersion;\n+        return this;\n+    }\n+\n+    public byte getCompatibleMajorVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NDAzMw==", "bodyText": "hmm, I wonder if we should make this a SetOnce or add validation that if it is not some sentinel value that it cannot be changed again? I'm not sure that I like it being mutable with a builder pattern and allowing it to be set multiple times", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518884033", "createdAt": "2020-11-06T17:03:37Z", "author": {"login": "jaymode"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -48,6 +48,8 @@\n  */\n public final class XContentBuilder implements Closeable, Flushable {\n \n+    private byte compatibleMajorVersion;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTczMg==", "bodyText": "hmm, should we make this non-static like minimumCompatibilityVersion and minimumIndexCompatibilityVersion? Also, please add javadocs :)", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885732", "createdAt": "2020-11-06T17:06:42Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -268,6 +269,15 @@ private static Version fromStringSlow(String version) {\n         this.build = (byte) (id % 100);\n         this.luceneVersion = Objects.requireNonNull(luceneVersion);\n         this.toString = major + \".\" + minor + \".\" + revision;\n+        this.previousMajorId = major > 0 ? (major - 1) * 1000000 + 99 : major;\n+    }\n+\n+    public Version previousMajor() {\n+        return Version.fromId(previousMajorId);\n+    }\n+\n+    public static Version minimumRestCompatibilityVersion() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTgxNQ==", "bodyText": "javadocs please", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885815", "createdAt": "2020-11-06T17:06:52Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -268,6 +269,15 @@ private static Version fromStringSlow(String version) {\n         this.build = (byte) (id % 100);\n         this.luceneVersion = Objects.requireNonNull(luceneVersion);\n         this.toString = major + \".\" + minor + \".\" + revision;\n+        this.previousMajorId = major > 0 ? (major - 1) * 1000000 + 99 : major;\n+    }\n+\n+    public Version previousMajor() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODg4NTk5NQ==", "bodyText": "Suggested change", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r518885995", "createdAt": "2020-11-06T17:07:08Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/node/Node.java", "diffHunk": "@@ -539,9 +540,11 @@ protected Node(final Environment initialEnvironment,\n                                                  repositoriesServiceReference::get).stream())\n                 .collect(Collectors.toList());\n \n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "836fe0f1b842929aa6c6e46694aa4e8ca8dead95"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2ea927874ce0e737322b6cfc9f348e1f31fa5b", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f2ea927874ce0e737322b6cfc9f348e1f31fa5b", "committedDate": "2020-11-09T12:05:40Z", "message": "javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d70a0712bc4578e4351e6deb29a6adbb60fd69b6", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d70a0712bc4578e4351e6deb29a6adbb60fd69b6", "committedDate": "2020-11-09T12:13:22Z", "message": "do not set compatible version twice"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/87d762f66c418dd238fc1c02d7f7bafc7de0bb34", "committedDate": "2020-11-09T13:12:41Z", "message": "Merge branch 'master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2Mjk3OTk3", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-526297997", "createdAt": "2020-11-09T14:17:02Z", "commit": {"oid": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDoxNzowMlrOHvw3UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQxNDoxNzowMlrOHvw3UQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTg0NTcxMw==", "bodyText": "I am not sure i understand the purpose of this comment here.", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r519845713", "createdAt": "2020-11-09T14:17:02Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -242,7 +250,11 @@ private void dispatchRequest(RestRequest request, RestChannel channel, RestHandl\n                 inFlightRequestsBreaker(circuitBreakerService).addWithoutBreaking(contentLength);\n             }\n             // iff we could reserve bytes for the request we need to send the response also over this channel\n-            responseChannel = new ResourceHandlingHttpChannel(channel, circuitBreakerService, contentLength);\n+            // Using a version from a handler because if no handler was found for requested version,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34"}, "originalPosition": 40}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2MzAzNzk4", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-526303798", "createdAt": "2020-11-09T14:23:13Z", "commit": {"oid": "87d762f66c418dd238fc1c02d7f7bafc7de0bb34"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "deff73987b4db898044e43ffae89a02a2ac66b2e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/deff73987b4db898044e43ffae89a02a2ac66b2e", "committedDate": "2020-11-09T15:06:50Z", "message": "javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72", "committedDate": "2020-11-10T08:13:25Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a38ed04c7f9440b72c82eee801c64367fc3c8c17", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/a38ed04c7f9440b72c82eee801c64367fc3c8c17", "committedDate": "2020-11-10T15:52:07Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/register_compatible_handlers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3MzUwOTA2", "url": "https://github.com/elastic/elasticsearch/pull/64423#pullrequestreview-527350906", "createdAt": "2020-11-10T15:57:18Z", "commit": {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNTo1NzoxOFrOHwjbHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQxNjowMDoyMlrOHwjkxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NDA3OQ==", "bodyText": "this assertion is incorrect as it is asserting on the value passed into the method and not the value in the builder.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assert compatibleMajorVersion != 0 : \"Compatible version has already been set\";\n          \n          \n            \n                    assert this.compatibleMajorVersion == 0 : \"Compatible version has already been set\";\n          \n          \n            \n                    if (compatibleMajorVersion == 0) {\n          \n          \n            \n                        throw new IllegalArgumentException(\"Compatible major version must not be equal to 0\");\n          \n          \n            \n                    }", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520674079", "createdAt": "2020-11-10T15:57:18Z", "author": {"login": "jaymode"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -1004,6 +1006,22 @@ public XContentBuilder copyCurrentStructure(XContentParser parser) throws IOExce\n         return this;\n     }\n \n+    /**\n+     * Sets a version used for serialising a response compatible with a previous version.\n+     */\n+    public XContentBuilder withCompatibleMajorVersion(byte compatibleMajorVersion) {\n+        assert compatibleMajorVersion != 0 : \"Compatible version has already been set\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NTU0MA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String toString;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                private final String toString;\n          \n      \n    \n    \n  \n\nThis is a nit but it helps my eyes read the code better when public values are kept together.", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520675540", "createdAt": "2020-11-10T15:59:06Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -259,6 +259,7 @@ private static Version fromStringSlow(String version) {\n     public final byte build;\n     public final org.apache.lucene.util.Version luceneVersion;\n     private final String toString;\n+    public final int previousMajorId;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NjU0OA==", "bodyText": "Or you could make value private, which I'd prefer\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private final String toString;\n          \n          \n            \n                public final int previousMajorId;\n          \n          \n            \n                private final String toString;\n          \n          \n            \n                private final int previousMajorId;", "url": "https://github.com/elastic/elasticsearch/pull/64423#discussion_r520676548", "createdAt": "2020-11-10T16:00:22Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/Version.java", "diffHunk": "@@ -259,6 +259,7 @@ private static Version fromStringSlow(String version) {\n     public final byte build;\n     public final org.apache.lucene.util.Version luceneVersion;\n     private final String toString;\n+    public final int previousMajorId;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDY3NTU0MA=="}, "originalCommit": {"oid": "4ecbf223b1334ba1e7f3b45aeb2f47a4e0c91a72"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c39d0bb6e0b1428736b05c0cde01be02598f2252", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/c39d0bb6e0b1428736b05c0cde01be02598f2252", "committedDate": "2020-11-10T16:44:09Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Jay Modi <jaymode@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "09704f3aa459dcfcdc547279931fc432a44f0c80", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/09704f3aa459dcfcdc547279931fc432a44f0c80", "committedDate": "2020-11-10T16:45:20Z", "message": "Merge branch 'compat/register_compatible_handlers' of github.com:pgomulka/elasticsearch into compat/register_compatible_handlers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "023c8d992d6853b2fa4a3eda248654cb82cee701", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/023c8d992d6853b2fa4a3eda248654cb82cee701", "committedDate": "2020-11-10T16:47:12Z", "message": "xcontentbuilder has the version requested by a user"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 879, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}