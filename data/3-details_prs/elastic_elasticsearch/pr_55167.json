{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjQ5NTE0", "number": 55167, "title": "Allow transactional metadata update with index creation", "bodyText": "Allows clients to supply a function to mutate cluster metadata in the same cluster state update operation that creates an index. The immediate motivation for this is to permit the rollover API to create a new backing index for a data stream and add that index to the data stream in the same cluster state update operation thus simplifying validation and ensuring consistency.\nRelates to #53100", "createdAt": "2020-04-14T15:18:09Z", "url": "https://github.com/elastic/elasticsearch/pull/55167", "merged": true, "mergeCommit": {"oid": "cd8162ba4fd4b96e9d0c773c9a4178b912a39373"}, "closed": true, "closedAt": "2020-04-15T16:37:48Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXk9mCAH2gAyNDAzMjQ5NTE0OjhlNDI2MjI4MmUzOTQyZDRmNDE0NmY5ZmI2YWQyZmNjNGVkMGJhYWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcX6QU4AFqTM5MzkxNTAwOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa", "committedDate": "2020-04-14T15:10:12Z", "message": "hook for transactional metadata update with index creation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMDY3NjI1", "url": "https://github.com/elastic/elasticsearch/pull/55167#pullrequestreview-393067625", "createdAt": "2020-04-14T15:54:26Z", "commit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NDoyNlrOGFVfDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxNTo1NDoyNlrOGFVfDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ==", "bodyText": "Drive-by comment, but does this really need to return a brand new builder? Since the existing builder is being passed in couldn't this be a BiConsumer<Metadata.Builder, IndexMetadata> and modify the builder directly?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408248079", "createdAt": "2020-04-14T15:54:26Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630f525836e2c8ea4337f785ffb3d80d06263228", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/630f525836e2c8ea4337f785ffb3d80d06263228", "committedDate": "2020-04-14T21:50:53Z", "message": "BiFunction to BiConsumer"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzNTk4MTIw", "url": "https://github.com/elastic/elasticsearch/pull/55167#pullrequestreview-393598120", "createdAt": "2020-04-15T09:17:28Z", "commit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxNzoyOFrOGFxAww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNVQwOToxODo1N1rOGFxEHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTA3NQ==", "bodyText": "Maybe rename metadataTransaction to metadataTransformer?\nSince if provided the function will change the metadata builder.", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699075", "createdAt": "2020-04-15T09:17:28Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTQ2Mw==", "bodyText": "nit: List.of()?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699463", "createdAt": "2020-04-15T09:18:10Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -492,7 +508,7 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n                 // the context is only used for validation so it's fine to pass fake values for the\n                 // shard id and the current timestamp\n                 indexService.newQueryShardContext(0, null, () -> 0L, null)),\n-            Collections.emptyList());\n+            Collections.emptyList(), metadataTransaction);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 128}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODY5OTkzNA==", "bodyText": "maybe in that spirit also add an assertion that the same metadata builder instance is returned from the function?", "url": "https://github.com/elastic/elasticsearch/pull/55167#discussion_r408699934", "createdAt": "2020-04-15T09:18:57Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -685,10 +701,14 @@ static int getIndexNumberOfRoutingShards(Settings indexSettings, @Nullable Index\n      * table based on the live nodes.\n      */\n     static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<ClusterBlock> clusterBlocks, IndexMetadata indexMetadata,\n-                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable) {\n-        Metadata newMetadata = Metadata.builder(currentState.metadata())\n-            .put(indexMetadata, false)\n-            .build();\n+                                                BiFunction<ClusterState, String, ClusterState> rerouteRoutingTable,\n+                                                BiFunction<Metadata.Builder, IndexMetadata, Metadata.Builder> metadataTransaction) {\n+        Metadata.Builder builder = Metadata.builder(currentState.metadata())\n+            .put(indexMetadata, false);\n+        if (metadataTransaction != null) {\n+            builder = metadataTransaction.apply(builder, indexMetadata);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODI0ODA3OQ=="}, "originalCommit": {"oid": "8e4262282e3942d4f4146f9fb6ad2fcc4ed0baaa"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "125f023d4fbc5cbf610150f64c28467668f11665", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/125f023d4fbc5cbf610150f64c28467668f11665", "committedDate": "2020-04-15T12:14:23Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzOTE1MDA5", "url": "https://github.com/elastic/elasticsearch/pull/55167#pullrequestreview-393915009", "createdAt": "2020-04-15T15:58:40Z", "commit": {"oid": "125f023d4fbc5cbf610150f64c28467668f11665"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3554, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}