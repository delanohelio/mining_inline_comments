{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE5MTIwNTA2", "number": 56870, "title": "Optimize complicated if-else in routing table.", "bodyText": "Optimize the complicated if-else logic in RoutingTable.", "createdAt": "2020-05-17T14:22:05Z", "url": "https://github.com/elastic/elasticsearch/pull/56870", "merged": true, "mergeCommit": {"oid": "e686d304f48d225f923e44fd786dec61fbd0f676"}, "closed": true, "closedAt": "2020-05-18T14:31:29Z", "author": {"login": "howardhuanghua"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABciNiESgFqTQxMzE3NTk2Mw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcifdvdgFqTQxMzU2ODU4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzMTc1OTYz", "url": "https://github.com/elastic/elasticsearch/pull/56870#pullrequestreview-413175963", "createdAt": "2020-05-17T16:02:57Z", "commit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNjowMjo1N1rOGWh46w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xN1QxNjowMjo1N1rOGWh46w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjI3NzA5OQ==", "bodyText": "Maybe just remove this condition as it's obviously always false and keep the rest the same (maybe also inline delta like we have in the \"add\" case). Seems to me that makes the logic easiest to digest if we want to change it?", "url": "https://github.com/elastic/elasticsearch/pull/56870#discussion_r426277099", "createdAt": "2020-05-17T16:02:57Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/RoutingTable.java", "diffHunk": "@@ -472,19 +474,12 @@ public Builder updateNumberOfReplicas(final int numberOfReplicas, final String[]\n                 for (IndexShardRoutingTable indexShardRoutingTable : indexRoutingTable) {\n                     builder.addIndexShard(indexShardRoutingTable);\n                 }\n-                if (currentNumberOfReplicas < numberOfReplicas) {\n-                    // now, add \"empty\" ones\n-                    for (int i = 0; i < (numberOfReplicas - currentNumberOfReplicas); i++) {\n+                int delta = Math.abs(numberOfReplicas - currentNumberOfReplicas);\n+                for (int i = 0; i < delta; i++) {\n+                    if (currentNumberOfReplicas < numberOfReplicas) {\n                         builder.addReplica();\n-                    }\n-                } else if (currentNumberOfReplicas > numberOfReplicas) {\n-                    int delta = currentNumberOfReplicas - numberOfReplicas;\n-                    if (delta <= 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bafe90483ccabf268b56b4556a7c1e2de66d86e"}, "originalPosition": 30}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46f44bd146f6ccf822f9d57f23ec030befaf374b", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/46f44bd146f6ccf822f9d57f23ec030befaf374b", "committedDate": "2020-05-18T11:39:06Z", "message": "Merge branch 'optimize_condition' of https://github.com/TencentCloudES/elasticsearch into optimize_condition"}, "afterCommit": {"oid": "6389d4bb3274a2d3db6226fa46941e451efa594e", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/6389d4bb3274a2d3db6226fa46941e451efa594e", "committedDate": "2020-05-18T09:21:51Z", "message": "remove abs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4ed1bf9903bc673f23e22a96d4fd5aaf7b0764c", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4ed1bf9903bc673f23e22a96d4fd5aaf7b0764c", "committedDate": "2020-05-18T11:52:18Z", "message": "optimize complicated if-else in routing table"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efd2f21a7574487be3a0d703ded3b8d2661f6032", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/efd2f21a7574487be3a0d703ded3b8d2661f6032", "committedDate": "2020-05-18T11:52:18Z", "message": "precompute delta and distinguish add and remove"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "committedDate": "2020-05-18T11:52:19Z", "message": "remove abs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6389d4bb3274a2d3db6226fa46941e451efa594e", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/6389d4bb3274a2d3db6226fa46941e451efa594e", "committedDate": "2020-05-18T09:21:51Z", "message": "remove abs"}, "afterCommit": {"oid": "2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bb15b2930b74a139b0267b87dc2d3b53e83ec60", "committedDate": "2020-05-18T11:52:19Z", "message": "remove abs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzNTY4NTg0", "url": "https://github.com/elastic/elasticsearch/pull/56870#pullrequestreview-413568584", "createdAt": "2020-05-18T12:59:03Z", "commit": {"oid": "2bb15b2930b74a139b0267b87dc2d3b53e83ec60"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4823, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}