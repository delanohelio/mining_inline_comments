{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDMwMDcz", "number": 50609, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTo0MzowOVrODVsADA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo0MDoxNlrODWVX9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MDY3NTk2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTo0MzowOVrOFaC7NQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTo0NToyOVrOFaC-pQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NTIyMQ==", "bodyText": "We don't actually serialize this Rounding but I believe I've got this bit right so I kept it. I'd like to move the other offset code over to this Rounding which means that we will eventually serialize it. At that point we'll get exhaustive tests for this code.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362855221", "createdAt": "2020-01-03T15:43:09Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().before(Version.V_8_0_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NjEwMQ==", "bodyText": "Modulo the version check which I discuss below.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362856101", "createdAt": "2020-01-03T15:45:29Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().before(Version.V_8_0_0)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NTIyMQ=="}, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 47}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MDY4MDYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/DateHistogramValuesSourceBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTo0NTowNlrOFaC-Hg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNjozNToxNFrOFaEHDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NTk2Ng==", "bodyText": "I think this is the way to do this, but it has been a long time. I want to land this change in master and 7.x, but these tests have no change of passing the bwc tests until I backport it.\nNow that I think about it, maybe this version check should be V_7_6_0 actually. Help!", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362855966", "createdAt": "2020-01-03T15:45:06Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/DateHistogramValuesSourceBuilder.java", "diffHunk": "@@ -80,12 +91,18 @@ protected DateHistogramValuesSourceBuilder(StreamInput in) throws IOException {\n         super(in);\n         dateHistogramInterval = new DateIntervalWrapper(in);\n         timeZone = in.readOptionalZoneId();\n+        if (in.getVersion().after(Version.V_8_0_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg3NDYzOQ==", "bodyText": "The tests caught an error - this at least be onOrAfter but I'll switch it to V_7_6_0 while I'm there.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362874639", "createdAt": "2020-01-03T16:35:14Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/composite/DateHistogramValuesSourceBuilder.java", "diffHunk": "@@ -80,12 +91,18 @@ protected DateHistogramValuesSourceBuilder(StreamInput in) throws IOException {\n         super(in);\n         dateHistogramInterval = new DateIntervalWrapper(in);\n         timeZone = in.readOptionalZoneId();\n+        if (in.getVersion().after(Version.V_8_0_0)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NTk2Ng=="}, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MDY4NDY2OnYy", "diffSide": "RIGHT", "path": "docs/reference/aggregations/bucket/composite-aggregation.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxNTo0Njo0OVrOFaDAjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODoyNTo0NlrOFaGWLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NjU4OA==", "bodyText": "I figured because the option is the same I should just include the docs from the normal date histogram.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362856588", "createdAt": "2020-01-03T15:46:49Z", "author": {"login": "nik9000"}, "path": "docs/reference/aggregations/bucket/composite-aggregation.asciidoc", "diffHunk": "@@ -287,6 +287,72 @@ Time zones may either be specified as an ISO 8601 UTC offset (e.g. `+01:00` or\n `-08:00`)  or as a timezone id, an identifier used in the TZ database like\n `America/Los_Angeles`.\n \n+*Offset*\n+\n+include::datehistogram-aggregation.asciidoc[tag=offset-explanation]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxMTI3OA==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362911278", "createdAt": "2020-01-03T18:25:46Z", "author": {"login": "polyfractal"}, "path": "docs/reference/aggregations/bucket/composite-aggregation.asciidoc", "diffHunk": "@@ -287,6 +287,72 @@ Time zones may either be specified as an ISO 8601 UTC offset (e.g. `+01:00` or\n `-08:00`)  or as a timezone id, an identifier used in the TZ database like\n `America/Los_Angeles`.\n \n+*Offset*\n+\n+include::datehistogram-aggregation.asciidoc[tag=offset-explanation]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjg1NjU4OA=="}, "originalCommit": {"oid": "3032d62a9f23c7650f40090823f5e456094f0782"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTA4NTE2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODo1MjowMFrOFaG3nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxOTo1NToyNlrOFaIIGQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTgzOQ==", "bodyText": "Is the intention to migrate the existing users of offsets (regular date histo agg, etc) over to this wrapper?  E.g. it seems a bit heavyweight to create a whole new rounding, but if the idea is to followup with changes to the existing users of offset (rather than baking the logic into the aggs) it makes sense to me.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362919839", "createdAt": "2020-01-03T18:52:00Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDIwMw==", "bodyText": "Also, we should probably add a javadoc explaining why/when to use this class", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362920203", "createdAt": "2020-01-03T18:53:11Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTgzOQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkzMTI1Mw==", "bodyText": "Yeah, I did intend to migrate the rest over of the uses of offset over to it.\nI added javadoc on the public interface to the class which is what the rest of the classes in this file do. Do you think I should duplicate it onto this one? Or add something maybe?", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362931253", "createdAt": "2020-01-03T19:27:17Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTgzOQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk0MDQ0MQ==", "bodyText": "Ah, missed that it was documented on the public method.  Since the rest of the class does it that way, fine with me :)\nThanks for the explanation!", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362940441", "createdAt": "2020-01-03T19:55:26Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkxOTgzOQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTA4NjU0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODo1Mjo0NFrOFaG4hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0MzoxMlrOFaJAXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDA2OA==", "bodyText": "maybe read/write ZLong instead?  I suspect offsets will be small-to-medium'ish sized and either positive or negative, so zlong might be a win?", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362920068", "createdAt": "2020-01-03T18:52:44Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkzMTQxMg==", "bodyText": "In other places offsets are written as long and I just copied it. But I'd be fine with zlong.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362931412", "createdAt": "2020-01-03T19:27:48Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDA2OA=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk1NDg0NA==", "bodyText": "Pushed the switch to zlong.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362954844", "createdAt": "2020-01-03T20:43:12Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDA2OA=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 42}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTA4OTc2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxODo1NDoxNFrOFaG6aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxOToyODowMVrOFaHlIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDU1NQ==", "bodyText": "\ud83d\ude4f for the cleanup here :)", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362920555", "createdAt": "2020-01-03T18:54:14Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().onOrAfter(Version.V_7_6_0)) {\n+                throw new IllegalArgumentException(\"Offset rounding not supported before 8.0.0\");\n+            }\n+            delegate.writeTo(out);\n+            out.writeLong(offset);\n+        }\n+\n+        @Override\n+        public byte id() {\n+            return ID;\n+        }\n+\n+        @Override\n+        public long round(long value) {\n+            return delegate.round(value - offset) + offset;\n+        }\n+\n+        @Override\n+        public long nextRoundingValue(long value) {\n+            // This isn't needed by the current users. We'll implement it when we migrate other users to it.\n+            throw new UnsupportedOperationException(\"not yet supported\");\n+        }\n+\n+        @Override\n+        public int hashCode() {\n+            return Objects.hash(delegate, offset);\n+        }\n+\n+        @Override\n+        public boolean equals(Object obj) {\n+            if (obj == null || getClass() != obj.getClass()) {\n+                return false;\n+            }\n+            OffsetRounding other = (OffsetRounding) obj;\n+            return delegate.equals(other.delegate) && offset == other.offset;\n+        }\n+    }\n+\n     public static Rounding read(StreamInput in) throws IOException {\n-        Rounding rounding;\n         byte id = in.readByte();\n         switch (id) {\n             case TimeUnitRounding.ID:\n-                rounding = new TimeUnitRounding(in);\n-                break;\n+                return new TimeUnitRounding(in);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 92}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkzMTQ5MA==", "bodyText": "I'm not sure everyone would consider that cleaner, but I sure do!", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362931490", "createdAt": "2020-01-03T19:28:01Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -556,19 +567,73 @@ public boolean equals(Object obj) {\n         }\n     }\n \n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            delegate = Rounding.read(in);\n+            offset = in.readLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().onOrAfter(Version.V_7_6_0)) {\n+                throw new IllegalArgumentException(\"Offset rounding not supported before 8.0.0\");\n+            }\n+            delegate.writeTo(out);\n+            out.writeLong(offset);\n+        }\n+\n+        @Override\n+        public byte id() {\n+            return ID;\n+        }\n+\n+        @Override\n+        public long round(long value) {\n+            return delegate.round(value - offset) + offset;\n+        }\n+\n+        @Override\n+        public long nextRoundingValue(long value) {\n+            // This isn't needed by the current users. We'll implement it when we migrate other users to it.\n+            throw new UnsupportedOperationException(\"not yet supported\");\n+        }\n+\n+        @Override\n+        public int hashCode() {\n+            return Objects.hash(delegate, offset);\n+        }\n+\n+        @Override\n+        public boolean equals(Object obj) {\n+            if (obj == null || getClass() != obj.getClass()) {\n+                return false;\n+            }\n+            OffsetRounding other = (OffsetRounding) obj;\n+            return delegate.equals(other.delegate) && offset == other.offset;\n+        }\n+    }\n+\n     public static Rounding read(StreamInput in) throws IOException {\n-        Rounding rounding;\n         byte id = in.readByte();\n         switch (id) {\n             case TimeUnitRounding.ID:\n-                rounding = new TimeUnitRounding(in);\n-                break;\n+                return new TimeUnitRounding(in);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMDU1NQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 92}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTEwOTM5OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxOTowMzo0OVrOFaHG1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0MzoyOFrOFaJAtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzczNA==", "bodyText": "Hmm, do you know if we have any serialization tests for Rounding?  I was looking to see if we test that the id() bytes are correct and don't accidentally change (similar to what we do with AbstractWriteableEnumTestCase enum tests)... but couldn't find any serialization tests at all.\nIf we have them somewhere, let's add a test for the id byte.  If not, probably too much to add to this PR but we should file a ticket so we don't forget to add some tests... makes me uneasy that such a widespread class doesn't have serialization tests :)", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362923734", "createdAt": "2020-01-03T19:03:49Z", "author": {"login": "polyfractal"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkzMTkxMA==", "bodyText": "I believe we end up testing serialization as part of testing things like extended bounds bucket response. Adding a unit test for just this class's serialization makes sense to me though. I figured I'd wait until I used it in a context where we serialized it but since I'm writing the serialization code now I probably ought to write the test now.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362931910", "createdAt": "2020-01-03T19:29:22Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzczNA=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk1NDkzMw==", "bodyText": "I pushed a wire test case.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362954933", "createdAt": "2020-01-03T20:43:28Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n ", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzczNA=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 3}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTExMDc2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QxOTowNDoyOVrOFaHHsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0NDowN1rOFaJBXQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzk1NQ==", "bodyText": "Let's add another test that does negative offsets too?", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362923955", "createdAt": "2020-01-03T19:04:29Z", "author": {"login": "polyfractal"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n \n+    public void testOffsetRounding() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkzMTk1OA==", "bodyText": "Sure!", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362931958", "createdAt": "2020-01-03T19:29:31Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n \n+    public void testOffsetRounding() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzk1NQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk1NTEwMQ==", "bodyText": "I pushed a test with negative offsets.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362955101", "createdAt": "2020-01-03T20:44:07Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingTests.java", "diffHunk": "@@ -195,6 +195,16 @@ public void testTimeUnitRoundingDST() {\n         assertThat(tzRounding_chg.round(time(\"2014-11-02T06:01:01\", chg)), isDate(time(\"2014-11-02T06:00:00\", chg), chg));\n     }\n \n+    public void testOffsetRounding() {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MjkyMzk1NQ=="}, "originalCommit": {"oid": "393388c25dc4bbdda70d8e4ac20f3b735e8b582d"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTMxNTMwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0NzozMFrOFaJE1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0NzozMFrOFaJE1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk1NTk4OQ==", "bodyText": "I'll revert this change. It snuck in because I thought the comparison was wrong.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362955989", "createdAt": "2020-01-03T20:47:30Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -418,24 +434,16 @@ public boolean equals(Object obj) {\n                 return false;\n             }\n             TimeUnitRounding other = (TimeUnitRounding) obj;\n-            return Objects.equals(unit, other.unit) && Objects.equals(timeZone, other.timeZone);\n+            return unit == other.unit && timeZone.equals(other.timeZone);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08fc2672277730ed1bef85db450f61dbf3b6b70c"}, "originalPosition": 91}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTMxODU5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0OToxOFrOFaJGvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMDo0OToxOFrOFaJGvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk1NjQ3OA==", "bodyText": "The toString implementations weren't consistent which made reading the error messages hard. So I changed them.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r362956478", "createdAt": "2020-01-03T20:49:18Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -552,23 +560,88 @@ public boolean equals(Object obj) {\n                 return false;\n             }\n             TimeIntervalRounding other = (TimeIntervalRounding) obj;\n-            return Objects.equals(interval, other.interval) && Objects.equals(timeZone, other.timeZone);\n+            return interval == other.interval && timeZone.equals(other.timeZone);\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return \"Rounding[\" + interval + \" in \" + timeZone + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "08fc2672277730ed1bef85db450f61dbf3b6b70c"}, "originalPosition": 151}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MzAxMTI1OnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/230_composite.yml", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQwODoxNjozN1rOFaXl1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo1MjoyM1rOFbCf9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MzgxNQ==", "bodyText": "Let's use the new format, this option should be removed soon.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363193815", "createdAt": "2020-01-06T08:16:37Z", "author": {"login": "jimczi"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/230_composite.yml", "diffHunk": "@@ -367,6 +367,40 @@ setup:\n   - match: { aggregations.test.buckets.0.key.date: \"2017-10-21\" }\n   - match: { aggregations.test.buckets.0.doc_count: 1 }\n \n+---\n+\"Composite aggregation with date_histogram offset\":\n+  - skip:\n+      version: \" - 7.99.99\" # after BWC merged revert to 7.5.99\n+      reason:  offset introduced in 8.0.0\n+\n+  - do:\n+      search:\n+        rest_total_hits_as_int: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5NjgyMA==", "bodyText": "Sure!", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363896820", "createdAt": "2020-01-07T18:52:23Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/230_composite.yml", "diffHunk": "@@ -367,6 +367,40 @@ setup:\n   - match: { aggregations.test.buckets.0.key.date: \"2017-10-21\" }\n   - match: { aggregations.test.buckets.0.doc_count: 1 }\n \n+---\n+\"Composite aggregation with date_histogram offset\":\n+  - skip:\n+      version: \" - 7.99.99\" # after BWC merged revert to 7.5.99\n+      reason:  offset introduced in 8.0.0\n+\n+  - do:\n+      search:\n+        rest_total_hits_as_int: true", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzE5MzgxNQ=="}, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NjkyNzQ2OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/common/RoundingWireTests.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxNTozNToxNVrOFa8--g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo1ODozNFrOFbCqJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwNjQ1OA==", "bodyText": "I'm a nervous nellie... would it be possible to explicitly test the \"short\" deprecated TZs from DateUtils, just to make sure we aren't breaking them?", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363806458", "createdAt": "2020-01-07T15:35:15Z", "author": {"login": "polyfractal"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingWireTests.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common;\n+\n+import org.elasticsearch.common.Rounding.DateTimeUnit;\n+import org.elasticsearch.common.io.stream.Writeable.Reader;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.test.AbstractWireSerializingTestCase;\n+\n+public class RoundingWireTests extends AbstractWireSerializingTestCase<Rounding> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg0Nzc2MQ==", "bodyText": "So I'm not 100% sure I can or should. Like, I can write a test that uses one of the short IDs, but I'm not super familiar with how to use them properly. The randomized testing doesn't like to generate them, presumably because they don't work on all jvms. I know one of them didn't work for me locally.\nThe class itself only takes ZoneId, not string. So it'd be fairly difficult to get one of those deprecated zone ids into it.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363847761", "createdAt": "2020-01-07T16:56:58Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingWireTests.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common;\n+\n+import org.elasticsearch.common.Rounding.DateTimeUnit;\n+import org.elasticsearch.common.io.stream.Writeable.Reader;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.test.AbstractWireSerializingTestCase;\n+\n+public class RoundingWireTests extends AbstractWireSerializingTestCase<Rounding> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwNjQ1OA=="}, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5OTQzMQ==", "bodyText": "Ah, I see.  And tracing backwards, DateHisto parses the input string with ZoneId.of() which should reject these deprecated short IDs as well.\nAnd the only other potential problem area is Rollup (which stored some short TZs before the javatime switch), but we have an alias lookup map for that use-case.\nRighto, carry on \ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363899431", "createdAt": "2020-01-07T18:58:34Z", "author": {"login": "polyfractal"}, "path": "server/src/test/java/org/elasticsearch/common/RoundingWireTests.java", "diffHunk": "@@ -0,0 +1,51 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.common;\n+\n+import org.elasticsearch.common.Rounding.DateTimeUnit;\n+import org.elasticsearch.common.io.stream.Writeable.Reader;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.test.AbstractWireSerializingTestCase;\n+\n+public class RoundingWireTests extends AbstractWireSerializingTestCase<Rounding> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzgwNjQ1OA=="}, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NzQ1NDYwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo0MDoxNlrOFbCLeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODo1MjozNVrOFbCgPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5MTU3Ng==", "bodyText": "should the message be before 7.6.0 ?", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363891576", "createdAt": "2020-01-07T18:40:16Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -554,21 +562,86 @@ public boolean equals(Object obj) {\n             TimeIntervalRounding other = (TimeIntervalRounding) obj;\n             return Objects.equals(interval, other.interval) && Objects.equals(timeZone, other.timeZone);\n         }\n+\n+        @Override\n+        public String toString() {\n+            return \"Rounding[\" + interval + \" in \" + timeZone + \"]\";\n+        }\n+    }\n+\n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            // Versions before 7.6.0 will never send this type of rounding.\n+            delegate = Rounding.read(in);\n+            offset = in.readZLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().before(Version.V_7_6_0)) {\n+                throw new IllegalArgumentException(\"Offset rounding not supported before 8.0.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 166}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5Njg5Mw==", "bodyText": "Yeah. I'll fix it.", "url": "https://github.com/elastic/elasticsearch/pull/50609#discussion_r363896893", "createdAt": "2020-01-07T18:52:35Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -554,21 +562,86 @@ public boolean equals(Object obj) {\n             TimeIntervalRounding other = (TimeIntervalRounding) obj;\n             return Objects.equals(interval, other.interval) && Objects.equals(timeZone, other.timeZone);\n         }\n+\n+        @Override\n+        public String toString() {\n+            return \"Rounding[\" + interval + \" in \" + timeZone + \"]\";\n+        }\n+    }\n+\n+    static class OffsetRounding extends Rounding {\n+        static final byte ID = 3;\n+\n+        private final Rounding delegate;\n+        private final long offset;\n+\n+        OffsetRounding(Rounding delegate, long offset) {\n+            this.delegate = delegate;\n+            this.offset = offset;\n+        }\n+\n+        OffsetRounding(StreamInput in) throws IOException {\n+            // Versions before 7.6.0 will never send this type of rounding.\n+            delegate = Rounding.read(in);\n+            offset = in.readZLong();\n+        }\n+\n+        @Override\n+        public void innerWriteTo(StreamOutput out) throws IOException {\n+            if (out.getVersion().before(Version.V_7_6_0)) {\n+                throw new IllegalArgumentException(\"Offset rounding not supported before 8.0.0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg5MTU3Ng=="}, "originalCommit": {"oid": "54f53edcd9b13ed659408d432b77a50eb7bbf448"}, "originalPosition": 166}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4967, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}