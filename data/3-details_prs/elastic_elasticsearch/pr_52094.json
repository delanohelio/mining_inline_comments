{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNjk3NTMx", "number": 52094, "title": "Support authentication without anonymous user", "bodyText": "This change adds a new parameter to the authenticate methods in the\nAuthenticationService to optionally exclude support for the anonymous\nuser (if an anonymous user exists).", "createdAt": "2020-02-08T09:18:58Z", "url": "https://github.com/elastic/elasticsearch/pull/52094", "merged": true, "mergeCommit": {"oid": "ec1afb9f7c292a332403c5458a03ff5f05a3c31e"}, "closed": true, "closedAt": "2020-02-12T06:03:08Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCQH1RAH2gAyMzcyNjk3NTMxOjdmYzE5MWRjNThlMmUxMDZiMmFmNGZmYWZkOGFmNzNmYWJlYTMwMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDfr_tAFqTM1NzIwMDQ4NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fc191dc58e2e106b2af4ffafd8af73fabea300c", "committedDate": "2020-02-08T09:00:58Z", "message": "Support authentication without anonymous user\n\nThis change adds a new parameter to the authenticate methods in the\nAuthenticationService to optionally exclude support for the anonymous\nuser (if an anonymous user exists)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2MzAxNzA0", "url": "https://github.com/elastic/elasticsearch/pull/52094#pullrequestreview-356301704", "createdAt": "2020-02-10T22:09:58Z", "commit": {"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMjowOTo1OVrOFn3anw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQyMjoxODo0NFrOFn3qIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0NjcxOQ==", "bodyText": "nit: Add the javadoc line here too\n\nThis method will optionally, authenticate as the anonymous user if the service is configured to allow anonymous access.", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377346719", "createdAt": "2020-02-10T22:09:59Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -149,7 +166,7 @@ public void authenticate(String action, TransportMessage message, User fallbackU\n      */\n     public void authenticate(String action, TransportMessage message,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM0Njc3MQ==", "bodyText": "request for change: Can we add the check for fallbackToAnonymous in shouldFallbackToAnonymous() instead so that we call one method instead of this ?", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377346771", "createdAt": "2020-02-10T22:10:07Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -205,18 +224,21 @@ long getNumInvalidation() {\n         private AuthenticationToken authenticationToken = null;\n         private AuthenticationResult authenticationResult = null;\n \n-        Authenticator(RestRequest request, ActionListener<Authentication> listener) {\n-            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, listener);\n+        Authenticator(RestRequest request, boolean fallbackToAnonymous, ActionListener<Authentication> listener) {\n+            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, fallbackToAnonymous, listener);\n         }\n \n-        Authenticator(String action, TransportMessage message, User fallbackUser, ActionListener<Authentication> listener) {\n-            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message\n-            ), fallbackUser, listener);\n+        Authenticator(String action, TransportMessage message, User fallbackUser, boolean fallbackToAnonymous,\n+                      ActionListener<Authentication> listener) {\n+            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message),\n+                fallbackUser, fallbackToAnonymous, listener);\n         }\n \n-        private Authenticator(AuditableRequest auditableRequest, User fallbackUser, ActionListener<Authentication> listener) {\n+        private Authenticator(AuditableRequest auditableRequest, User fallbackUser, boolean fallbackToAnonymous,\n+                              ActionListener<Authentication> listener) {\n             this.request = auditableRequest;\n             this.fallbackUser = fallbackUser;\n+            this.fallbackToAnonymous = fallbackToAnonymous && shouldFallbackToAnonymous();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzM1MDY5MQ==", "bodyText": "nit: fallback user is checked before the anonymous user so we would never end up with AnonymousUser even if we passed true here. Not sure if worth mentioning in the javadoc, I was just confused while reading the existing one. Maybe something like\n\nWe want to fallback to the SystemUser and this takes precedence, but we explicitly disallow AnonymousUser fallback in order to be future proof\n\nI don't like that much either tbh", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377350691", "createdAt": "2020-02-10T22:18:44Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/filter/SecurityActionFilter.java", "diffHunk": "@@ -150,9 +150,10 @@ the system itself (e.g. pings, update mappings, share relocation, etc...) and we\n          it to the action without an associated user (not via REST or transport - this is taken care of by\n          the {@link Rest} filter and the {@link ServerTransport} filter respectively), it's safe to assume a system user\n          here if a request is not associated with any other user.\n+         Because we want to fallback to the SystemUser, we don't allow anonymous (AnonymousUser) requests.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7fc191dc58e2e106b2af4ffafd8af73fabea300c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d51f863cee14b1003ec5f0b01a1c31cb4c47d99", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d51f863cee14b1003ec5f0b01a1c31cb4c47d99", "committedDate": "2020-02-10T23:54:49Z", "message": "Merge branch 'master' into authc-service-allow-anonymous"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/8404e9faff1b8e3c0bbf8120ea6ae4209959379c", "committedDate": "2020-02-11T02:57:03Z", "message": "Move \"fallbackToAnonymous\" checks to authc service"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NDI2MTQ0", "url": "https://github.com/elastic/elasticsearch/pull/52094#pullrequestreview-356426144", "createdAt": "2020-02-11T05:43:29Z", "commit": {"oid": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwNTo0MzoyOVrOFn97lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQwNTo0MzoyOVrOFn97lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzQ1MzQ2MA==", "bodyText": "Since fallbackToAnonymous makes no sense when fallbackUser is passed in and not null, I'm wondering if this is clearer to have a ctor and a #createAuthenticator() without the  fallbackToAnonymous parameter and Objects.notNull for the fallbackUser. It feels like it would be simpler to argue about or understand while reading the code.", "url": "https://github.com/elastic/elasticsearch/pull/52094#discussion_r377453460", "createdAt": "2020-02-11T05:43:29Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -208,18 +267,21 @@ long getNumInvalidation() {\n         private AuthenticationToken authenticationToken = null;\n         private AuthenticationResult authenticationResult = null;\n \n-        Authenticator(RestRequest request, ActionListener<Authentication> listener) {\n-            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, listener);\n+        Authenticator(RestRequest request, boolean fallbackToAnonymous, ActionListener<Authentication> listener) {\n+            this(new AuditableRestRequest(auditTrail, failureHandler, threadContext, request), null, fallbackToAnonymous, listener);\n         }\n \n-        Authenticator(String action, TransportMessage message, User fallbackUser, ActionListener<Authentication> listener) {\n-            this(new AuditableTransportRequest(auditTrail, failureHandler, threadContext, action, message\n-            ), fallbackUser, listener);\n+        Authenticator(String action, TransportMessage message, User fallbackUser, boolean fallbackToAnonymous,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8404e9faff1b8e3c0bbf8120ea6ae4209959379c"}, "originalPosition": 145}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03fbeb7d542ad98b8481b3dc1317ff75c3235341", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/03fbeb7d542ad98b8481b3dc1317ff75c3235341", "committedDate": "2020-02-11T10:19:50Z", "message": "Address feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MjAwNDg1", "url": "https://github.com/elastic/elasticsearch/pull/52094#pullrequestreview-357200485", "createdAt": "2020-02-12T05:42:58Z", "commit": {"oid": "03fbeb7d542ad98b8481b3dc1317ff75c3235341"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2716, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}