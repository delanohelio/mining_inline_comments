{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0OTA4MzE5", "number": 63813, "title": "[ML] Extract dependent variable's mapping correctly in case of a multi-field", "bodyText": "This PR fixes the way dependent variable's mapping is fetched in case of a multi-field.\nCloses elastic/machine-learning-qa#868", "createdAt": "2020-10-16T14:55:50Z", "url": "https://github.com/elastic/elasticsearch/pull/63813", "merged": true, "mergeCommit": {"oid": "8f4a2025361895697bcd61830f9264ba7d8f695c"}, "closed": true, "closedAt": "2020-10-28T12:05:24Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdWSmMtgBqjM5MjAyMDIzMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdW-OzRgFqTUxODcwNzQwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "560fcc41224944db692f8111d8dc005769dcb86b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/560fcc41224944db692f8111d8dc005769dcb86b", "committedDate": "2020-10-16T14:54:49Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}, "afterCommit": {"oid": "c04c4bd8163694fd7e8327b5aad5e640d0a62834", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c04c4bd8163694fd7e8327b5aad5e640d0a62834", "committedDate": "2020-10-26T11:23:16Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c04c4bd8163694fd7e8327b5aad5e640d0a62834", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c04c4bd8163694fd7e8327b5aad5e640d0a62834", "committedDate": "2020-10-26T11:23:16Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}, "afterCommit": {"oid": "c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "committedDate": "2020-10-26T11:32:23Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c302c5438ddbd0718ba2f23fe9466ac2d681f1cc", "committedDate": "2020-10-26T11:32:23Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}, "afterCommit": {"oid": "d71b5dd5ff4624bcbb48e1f20e200cf27283bc08", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/d71b5dd5ff4624bcbb48e1f20e200cf27283bc08", "committedDate": "2020-10-26T12:34:04Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "da14db39a480571d7edb67e83b90104904ea16a8", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/da14db39a480571d7edb67e83b90104904ea16a8", "committedDate": "2020-10-26T12:39:10Z", "message": "Import static"}, "afterCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/30f2edf3bffdedcece000b9bd8c89b15286165ab", "committedDate": "2020-10-26T12:41:15Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzM4MjI3", "url": "https://github.com/elastic/elasticsearch/pull/63813#pullrequestreview-516738227", "createdAt": "2020-10-26T12:44:33Z", "commit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0NDozNFrOHoNzew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMjo0NDozNFrOHoNzew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTI1OQ==", "bodyText": "I'm open to suggestions how this could be simplified.\nWe just want to fetch mapping by path. Should I be using FieldCapabilities API instead?", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511931259", "createdAt": "2020-10-26T12:44:34Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2NzUzNzkx", "url": "https://github.com/elastic/elasticsearch/pull/63813#pullrequestreview-516753791", "createdAt": "2020-10-26T13:04:57Z", "commit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzowNDo1N1rOHoOhHw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yNlQxMzoyMjoyNlrOHoPM-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Mjk0Mw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        if (currentAsMap.containsKey(\"properties\")) {\n          \n          \n            \n                            current = currentAsMap.get(\"properties\");\n          \n          \n            \n                            currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        } else if (currentAsMap.containsKey(\"fields\")) {\n          \n          \n            \n                            current = currentAsMap.get(\"fields\");\n          \n          \n            \n                            currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        } else {\n          \n          \n            \n                            return null;\n          \n          \n            \n                        }\n          \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n          \n            \n                        current = currentAsMap.get(\"properties\");\n          \n          \n            \n                        if (current == null) {\n          \n          \n            \n                            current = currentAsMap.get(\"fields\");\n          \n          \n            \n                        }\n          \n          \n            \n                        currentAsMap = (Map<String, Object>) current;\n          \n      \n    \n    \n  \n\nYou do a null check at the start of the loop. So, use that as your loop exit. Seems like only one branch is needed here.", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511942943", "createdAt": "2020-10-26T13:04:57Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n+        if (path.isEmpty()) {\n+            return mappingsProperties;\n+        }\n+        Object current = mappingsProperties;\n+        Map<String, Object> currentAsMap = mappingsProperties;\n+        String[] pathParts = path.split(\"\\\\.\");\n+        for (int i = 0; i < pathParts.length; ++i) {\n+            if (current == null) {\n+                return null;\n+            }\n+            String pathPart = pathParts[i];\n+            if (currentAsMap.containsKey(pathPart) == false) {\n+                return null;\n+            }\n+            current = currentAsMap.get(pathPart);\n+            if (i == pathParts.length - 1) {\n+                break;\n+            }\n+            currentAsMap = (Map<String, Object>) current;\n+            if (currentAsMap.containsKey(\"properties\")) {\n+                current = currentAsMap.get(\"properties\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else if (currentAsMap.containsKey(\"fields\")) {\n+                current = currentAsMap.get(\"fields\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else {\n+                return null;\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0NTM0Mw==", "bodyText": "Also, casting null ends up as null. So that should still be ok.", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511945343", "createdAt": "2020-10-26T13:09:01Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n+        if (path.isEmpty()) {\n+            return mappingsProperties;\n+        }\n+        Object current = mappingsProperties;\n+        Map<String, Object> currentAsMap = mappingsProperties;\n+        String[] pathParts = path.split(\"\\\\.\");\n+        for (int i = 0; i < pathParts.length; ++i) {\n+            if (current == null) {\n+                return null;\n+            }\n+            String pathPart = pathParts[i];\n+            if (currentAsMap.containsKey(pathPart) == false) {\n+                return null;\n+            }\n+            current = currentAsMap.get(pathPart);\n+            if (i == pathParts.length - 1) {\n+                break;\n+            }\n+            currentAsMap = (Map<String, Object>) current;\n+            if (currentAsMap.containsKey(\"properties\")) {\n+                current = currentAsMap.get(\"properties\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else if (currentAsMap.containsKey(\"fields\")) {\n+                current = currentAsMap.get(\"fields\");\n+                currentAsMap = (Map<String, Object>) current;\n+            } else {\n+                return null;\n+            }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk0Mjk0Mw=="}, "originalCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "originalPosition": 43}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTk1NDE2OQ==", "bodyText": "We probably should use field capabilities.\nIt returns nice objects that are like:\n  \"data.foo.bar\" : {\n      \"double\" : {\n        \"type\" : \"double\",\n        \"searchable\" : true,\n        \"aggregatable\" : true,\n        \"indices\" : [\n          \"fake-foo-2\"\n        ]\n      },\n      \"long\" : {\n        \"type\" : \"long\",\n        \"searchable\" : true,\n        \"aggregatable\" : true,\n        \"indices\" : [\n          \"fake-foo\"\n        ]\n      }\n    },\n\nWhere data.foo.bar would be this path variable.\nHere is another example:\nPUT complicated\n{\n  \"mappings\": {\n    \"properties\": {\n      \"foo\": {\n        \"type\": \"text\",\n        \"fields\": {\n          \"sub_foo\": {\n          \"type\": \"keyword\"\n          }\n        }\n      },\n      \"bar\": {\n        \"properties\": {\n          \"baz\": {\n            \"type\": \"long\"\n          }\n        }\n      }\n    }\n  }\n}\n\nReturns the following in the field caps:\n{\n  \"indices\" : [\n    \"complicated\"\n  ],\n  \"fields\" : {\n    \"foo.sub_foo\" : {\n      \"keyword\" : {\n        \"type\" : \"keyword\",\n        \"searchable\" : true,\n        \"aggregatable\" : true\n      }\n    },\n    \"bar.baz\" : {\n      \"long\" : {\n        \"type\" : \"long\",\n        \"searchable\" : true,\n        \"aggregatable\" : true\n      }\n    },\n    \"foo\" : {\n      \"text\" : {\n        \"type\" : \"text\",\n        \"searchable\" : true,\n        \"aggregatable\" : false\n      }\n    }\n    \"bar\" : {\n      \"object\" : {\n        \"type\" : \"object\",\n        \"searchable\" : false,\n        \"aggregatable\" : false\n      }\n    }\n  }\n}", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r511954169", "createdAt": "2020-10-26T13:22:26Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -406,8 +405,38 @@ public boolean supportsCategoricalFields() {\n         return additionalProperties;\n     }\n \n-    private static Object extractMapping(String path, Map<String, Object> mappingsProperties) {\n-        return extractValue(String.join(\".properties.\", path.split(\"\\\\.\")), mappingsProperties);\n+    // Visible for testing\n+    static Object extractMapping(String path, Map<String, Object> mappingsProperties) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMTkzMTI1OQ=="}, "originalCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5431ce86182def18dfde87e97dff02e8bc943623", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/5431ce86182def18dfde87e97dff02e8bc943623", "committedDate": "2020-10-28T06:19:14Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca79f72e5c67936fff537df807d906b3858a4738", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca79f72e5c67936fff537df807d906b3858a4738", "committedDate": "2020-10-28T07:57:07Z", "message": "Use FieldCapabilitiesAction to fetch dependent type mapping"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "30f2edf3bffdedcece000b9bd8c89b15286165ab", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/30f2edf3bffdedcece000b9bd8c89b15286165ab", "committedDate": "2020-10-26T12:41:15Z", "message": "Extract dependent variable's mapping correctly in case of a multi-field"}, "afterCommit": {"oid": "ca79f72e5c67936fff537df807d906b3858a4738", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca79f72e5c67936fff537df807d906b3858a4738", "committedDate": "2020-10-28T07:57:07Z", "message": "Use FieldCapabilitiesAction to fetch dependent type mapping"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54b23e3230c37424259fa83acfe057193ad4e888", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/54b23e3230c37424259fa83acfe057193ad4e888", "committedDate": "2020-10-28T10:54:54Z", "message": "Fix DestinationIndexTests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NTM5OTU4", "url": "https://github.com/elastic/elasticsearch/pull/63813#pullrequestreview-518539958", "createdAt": "2020-10-28T10:56:39Z", "commit": {"oid": "54b23e3230c37424259fa83acfe057193ad4e888"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzA3NDAw", "url": "https://github.com/elastic/elasticsearch/pull/63813#pullrequestreview-518707400", "createdAt": "2020-10-28T14:13:51Z", "commit": {"oid": "54b23e3230c37424259fa83acfe057193ad4e888"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoxMzo1MVrOHpsI5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNDoxMzo1MVrOHpsI5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzQ3NjgzNg==", "bodyText": "@przemekwitek  FieldCapabilitiesResponse is nullable. You need to do a null check here.", "url": "https://github.com/elastic/elasticsearch/pull/63813#discussion_r513476836", "createdAt": "2020-10-28T14:13:51Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -374,28 +374,19 @@ public boolean supportsCategoricalFields() {\n \n     @SuppressWarnings(\"unchecked\")\n     @Override\n-    public Map<String, Object> getExplicitlyMappedFields(Map<String, Object> mappingsProperties, String resultsFieldName) {\n+    public Map<String, Object> getExplicitlyMappedFields(String resultsFieldName, FieldCapabilitiesResponse fieldCapabilitiesResponse) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "54b23e3230c37424259fa83acfe057193ad4e888"}, "originalPosition": 30}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3889, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}