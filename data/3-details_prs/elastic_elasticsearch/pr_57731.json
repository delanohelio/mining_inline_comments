{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDU3OTY2", "number": 57731, "title": "[ML] add new circuit breaker for inference model caching", "bodyText": "This adds new plugin level circuit breaker for the ML plugin.\nmodel_inference is the circuit breaker qualified name.\nRight now it simply adds to the breaker when the model is loaded (and possibly breaking) and removing from the breaker when the model is unloaded.", "createdAt": "2020-06-05T13:43:46Z", "url": "https://github.com/elastic/elasticsearch/pull/57731", "merged": true, "mergeCommit": {"oid": "955afe3f81e0c55ed990074d00d6a808b368f70a"}, "closed": true, "closedAt": "2020-06-08T16:55:25Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoS0nigH2gAyNDI4NDU3OTY2OjQxYzQ2Y2IyMTUzYjlkOTYzNzFlNWFlOTZiYjljM2JmOTMwNDc1MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcpReqHgH2gAyNDI4NDU3OTY2Ojk2MzBkOWE4YWZlNzU2YTJkOTA1MTk5ZDVjZjExZjk5NTVhNzUzMGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/41c46cb2153b9d96371e5ae96bb9c3bf93047535", "committedDate": "2020-06-05T13:38:49Z", "message": "[ML] add new circuit breaker for inference model caching"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzMyNDM2", "url": "https://github.com/elastic/elasticsearch/pull/57731#pullrequestreview-425332436", "createdAt": "2020-06-05T14:05:17Z", "commit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDowNToxN1rOGfv-3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDowNToxN1rOGfv-3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0NTE4Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ===== Machine learning circuit breaker settings\n          \n          \n            \n            ==== {ml-cap} circuit breaker settings", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435945182", "createdAt": "2020-06-05T14:05:17Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MzM3NDU3", "url": "https://github.com/elastic/elasticsearch/pull/57731#pullrequestreview-425337457", "createdAt": "2020-06-05T14:11:16Z", "commit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoxMToxNlrOGfwNmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoxMToxNlrOGfwNmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0ODk1Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage\n          \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage,", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435948952", "createdAt": "2020-06-05T14:11:16Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings\n+\n+`breaker.model_inference.limit` (<<cluster-update-settings,Dynamic>>)\n+Limit for model inference breaker, defaults to 40% of JVM heap.\n+This means that it is bound by the limit configured for the parent circuit breaker.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.overhead` (<<cluster-update-settings,Dynamic>>)\n+A constant that all accounting estimations are multiplied with to determine\n+a final estimation. Defaults to 1.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.type`\n+The underlying type of the circuit breaker. There are two valid options:\n+`noop`, meaning the circuit breaker does nothing to prevent too much memory usage", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f46d06d14bad35a3287b129f0dfe11d5bf3ff52f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f46d06d14bad35a3287b129f0dfe11d5bf3ff52f", "committedDate": "2020-06-05T16:53:29Z", "message": "Applying doc changes\n\nCo-authored-by: Istv\u00e1n Zolt\u00e1n Szab\u00f3 <istvan.szabo@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e976f7937eeb8dba2742e29e83d70295dca5490c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/e976f7937eeb8dba2742e29e83d70295dca5490c", "committedDate": "2020-06-05T17:27:35Z", "message": "Merge branch 'master' into feature/ml-add-custom-circuit-breaker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f616ad99a8dd6f56a70889b766e74422e3984126", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f616ad99a8dd6f56a70889b766e74422e3984126", "committedDate": "2020-06-05T18:04:52Z", "message": "Merge branch 'feature/ml-add-custom-circuit-breaker' of github.com:benwtrent/elasticsearch into feature/ml-add-custom-circuit-breaker"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6", "committedDate": "2020-06-05T19:08:55Z", "message": "adjusting breaker behavior"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2MTYzMzU2", "url": "https://github.com/elastic/elasticsearch/pull/57731#pullrequestreview-426163356", "createdAt": "2020-06-08T12:09:50Z", "commit": {"oid": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowOTo1MFrOGgawqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowOTo1MFrOGgawqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NjA1Ng==", "bodyText": "Unused?\nThe ModelLoadedTracker is required to tell you when a model is loaded but that should not be necessary as assertBusys are used where behaviour is asserted", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r436646056", "createdAt": "2020-06-08T12:09:50Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingServiceTests.java", "diffHunk": "@@ -370,6 +374,55 @@ public void testGetModelEagerly() throws Exception {\n         verify(trainedModelStatsService, never()).queueStats(any(InferenceStats.class), anyBoolean());\n     }\n \n+    public void testCircuitBreakerBreak() throws Exception {\n+        String model1 = \"test-circuit-break-model-1\";\n+        String model2 = \"test-circuit-break-model-2\";\n+        String model3 = \"test-circuit-break-model-3\";\n+        withTrainedModel(model1, 5L);\n+        withTrainedModel(model2, 5L);\n+        withTrainedModel(model3, 12L);\n+        CircuitBreaker circuitBreaker = new CustomCircuitBreaker(11);\n+        ModelLoadingService modelLoadingService = new ModelLoadingService(trainedModelProvider,\n+            auditor,\n+            threadPool,\n+            clusterService,\n+            trainedModelStatsService,\n+            Settings.EMPTY,\n+            \"test-node\",\n+            circuitBreaker);\n+\n+        // We want to be notified when the models are loaded which happens in a background thread\n+        ModelLoadedTracker loadedTracker = new ModelLoadedTracker(Arrays.asList(model1, model2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6"}, "originalPosition": 148}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b9919da2da082f618926df16408d407a2e41766", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b9919da2da082f618926df16408d407a2e41766", "committedDate": "2020-06-08T13:55:28Z", "message": "fixing internal cluster tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58f2a0f70b8385389de16d5eded33c08dd1b09aa", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/58f2a0f70b8385389de16d5eded33c08dd1b09aa", "committedDate": "2020-06-08T14:17:16Z", "message": "fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9630d9a8afe756a2d905199d5cf11f9955a7530a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9630d9a8afe756a2d905199d5cf11f9955a7530a", "committedDate": "2020-06-08T14:38:51Z", "message": "Merge branch 'master' into feature/ml-add-custom-circuit-breaker"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3746, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}