{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2MDA0Nzkx", "number": 54473, "title": "Introduce autoscaling policies", "bodyText": "This commit is the first in a series of commits that introduces autoscaling policies, and APIs for working with them. For now, we introduce the basic infrastructure, and a single API for putting an autoscaling policy. We will follow in rapid succession with APIs for getting, and deleting autoscaling policies.", "createdAt": "2020-03-31T01:29:54Z", "url": "https://github.com/elastic/elasticsearch/pull/54473", "merged": true, "mergeCommit": {"oid": "6e35354f8e6d4332c3634eac37028f131041de42"}, "closed": true, "closedAt": "2020-04-01T11:35:46Z", "author": {"login": "jasontedor"}, "timelineItems": {"totalCount": 27, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcS4xYAAH2gAyMzk2MDA0NzkxOjBjZDYzMjFkMDY2MjBmOWE4MDdlZWY4YWI1ZjBmODc2YTZkMTZmMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTT1AOAFqTM4NTM4MTIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0cd6321d06620f9a807eef8ab5f0f876a6d16f10", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/0cd6321d06620f9a807eef8ab5f0f876a6d16f10", "committedDate": "2020-03-31T01:25:20Z", "message": "Introduce autoscaling policies\n\nThis commit is the first in a series of commits that introduces\nautoscaling policies, and APIs for working with them. For now, we\nintroduce the basic infrastructure, and a single API for putting an\nautoscaling policy. We will follow in rapid succession with APIs for\ngetting, and deleting autoscaling policies."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e102e91e190b74ece418dfe0a14e6c7bc895c3a", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e102e91e190b74ece418dfe0a14e6c7bc895c3a", "committedDate": "2020-03-31T01:40:24Z", "message": "Fix typo in file name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c731ca2d90cbcb550cd4a3b846a279d721fd1766", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c731ca2d90cbcb550cd4a3b846a279d721fd1766", "committedDate": "2020-03-31T02:10:29Z", "message": "Merge branch 'master' into autoscaling-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a46497136a6a63009b335d075c578196a60116", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/e8a46497136a6a63009b335d075c578196a60116", "committedDate": "2020-03-31T02:57:56Z", "message": "Revert inadvertent change to test runs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c83985f0084c2dff40ad8ba2a30a8c8981023890", "committedDate": "2020-03-31T03:07:36Z", "message": "Fix compilation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0NDc5NTA2", "url": "https://github.com/elastic/elasticsearch/pull/54473#pullrequestreview-384479506", "createdAt": "2020-03-31T07:47:52Z", "commit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "state": "COMMENTED", "comments": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNzo0Nzo1M1rOF-JRvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxMDoyMzo1N1rOF-PHEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcwODAzMA==", "bodyText": "I wonder if this needs to be a sorted map or if a plain map could work out? I think decisions should work the same regardless, favoring up over down over no scale.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400708030", "createdAt": "2020-03-31T07:47:53Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/AutoscalingMetadata.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diff;\n+import org.elasticsearch.cluster.DiffableUtils;\n+import org.elasticsearch.cluster.NamedDiff;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+public class AutoscalingMetadata implements MetaData.Custom {\n+\n+    public static final String NAME = \"autoscaling\";\n+\n+    public static final ParseField POLICIES_FIELD = new ParseField(\"policies\");\n+    public static final AutoscalingMetadata EMPTY = new AutoscalingMetadata(Collections.emptySortedMap());\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AutoscalingMetadata, Void> PARSER = new ConstructingObjectParser<>(\n+        NAME,\n+        c -> new AutoscalingMetadata(\n+            new TreeMap<>(\n+                ((List<AutoscalingPolicyMetadata>) c[0]).stream().collect(Collectors.toMap(p -> p.policy().name(), Function.identity()))\n+            )\n+        )\n+    );\n+\n+    static {\n+        PARSER.declareNamedObjects(\n+            ConstructingObjectParser.constructorArg(),\n+            (p, c, n) -> AutoscalingPolicyMetadata.parse(p, n),\n+            POLICIES_FIELD\n+        );\n+    }\n+\n+    public static AutoscalingMetadata parse(final XContentParser parser) {\n+        return PARSER.apply(parser, null);\n+    }\n+\n+    private final SortedMap<String, AutoscalingPolicyMetadata> policies;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcxODA4NA==", "bodyText": "I think we should check for metadata write block like we do elsewhere?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    return null;\n          \n          \n            \n                    return state.blocks().globalBlockedException(ClusterBlockLevel.METADATA_WRITE);", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400718084", "createdAt": "2020-03-31T08:05:00Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/TransportPutAutoscalingPolicyAction.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.TransportMasterNodeAction;\n+import org.elasticsearch.cluster.AckedClusterStateUpdateTask;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.block.ClusterBlockException;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.autoscaling.AutoscalingMetadata;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+public class TransportPutAutoscalingPolicyAction extends TransportMasterNodeAction<\n+    PutAutoscalingPolicyAction.Request,\n+    AcknowledgedResponse> {\n+\n+    private final Logger logger = LogManager.getLogger(TransportPutAutoscalingPolicyAction.class);\n+\n+    @Inject\n+    public TransportPutAutoscalingPolicyAction(\n+        final TransportService transportService,\n+        final ClusterService clusterService,\n+        final ThreadPool threadPool,\n+        final ActionFilters actionFilters,\n+        final IndexNameExpressionResolver indexNameExpressionResolver\n+    ) {\n+        super(\n+            PutAutoscalingPolicyAction.NAME,\n+            transportService,\n+            clusterService,\n+            threadPool,\n+            actionFilters,\n+            PutAutoscalingPolicyAction.Request::new,\n+            indexNameExpressionResolver\n+        );\n+    }\n+\n+    @Override\n+    protected String executor() {\n+        return ThreadPool.Names.SAME;\n+    }\n+\n+    @Override\n+    protected AcknowledgedResponse read(final StreamInput in) throws IOException {\n+        return new AcknowledgedResponse(in);\n+    }\n+\n+    @Override\n+    protected void masterOperation(\n+        final Task task,\n+        final PutAutoscalingPolicyAction.Request request,\n+        final ClusterState state,\n+        final ActionListener<AcknowledgedResponse> listener\n+    ) {\n+        clusterService.submitStateUpdateTask(\"put-autoscaling-policy\", new AckedClusterStateUpdateTask<>(request, listener) {\n+\n+            @Override\n+            protected AcknowledgedResponse newResponse(final boolean acknowledged) {\n+                return new AcknowledgedResponse(acknowledged);\n+            }\n+\n+            @Override\n+            public ClusterState execute(final ClusterState currentState) {\n+                return putAutoscalingPolicy(currentState, request.policy(), logger);\n+            }\n+\n+        });\n+    }\n+\n+    @Override\n+    protected ClusterBlockException checkBlock(final PutAutoscalingPolicyAction.Request request, final ClusterState state) {\n+        return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 93}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDcyNTY4NA==", "bodyText": "I think we should add a test to verify we get 400 back if pointing to a non-existing decider (think we will).", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400725684", "createdAt": "2020-03-31T08:17:59Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/qa/rest/src/test/resources/rest-api-spec/test/autoscaling/put_autoscaling_policy.yml", "diffHunk": "@@ -0,0 +1,11 @@\n+---\n+\"Test put autoscaling decision\":\n+  - do:\n+      autoscaling.put_autoscaling_policy:\n+        name: hot\n+        body:\n+          policy:\n+            deciders:\n+              always: {}\n+\n+  - match: { \"acknowledged\": true }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczMjA5NA==", "bodyText": "nit: typo, should be mutateAutoscalingDeciders", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400732094", "createdAt": "2020-03-31T08:28:12Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/test/java/org/elasticsearch/xpack/autoscaling/AutoscalingTestCase.java", "diffHunk": "@@ -53,4 +62,50 @@ static AutoscalingDecisions randomAutoscalingDecisions(\n         return new AutoscalingDecisions(decisions);\n     }\n \n+    public static List<AutoscalingDecider> randomAutoscalingDeciders() {\n+        return List.of(new AlwaysAutoscalingDecider());\n+    }\n+\n+    public static AutoscalingPolicy randomAutoscalingPolicy() {\n+        return randomAutoscalingPolicyOfName(randomAlphaOfLength(8));\n+    }\n+\n+    public static AutoscalingPolicy randomAutoscalingPolicyOfName(final String name) {\n+        return new AutoscalingPolicy(name, randomAutoscalingDeciders());\n+    }\n+\n+    public static AutoscalingPolicy mutateAutoscalingPolicy(final AutoscalingPolicy instance) {\n+        final List<AutoscalingDecider> deciders;\n+        if (randomBoolean()) {\n+            // if the policy name did not change, or randomly, use a mutated set of deciders\n+            deciders = mutateAutoscailngDeciders(instance.deciders());\n+        } else {\n+            deciders = instance.deciders();\n+        }\n+        return new AutoscalingPolicy(randomAlphaOfLength(8), deciders);\n+    }\n+\n+    public static List<AutoscalingDecider> mutateAutoscailngDeciders(final List<AutoscalingDecider> deciders) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 70}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDczOTEzNw==", "bodyText": "At the REST layer, we use a map from decider name to decider details, whereas here we use a list. I think we should align the two.\nI find it hard to imagine using the same decider twice in a single policy. The only case I can think of is a compound decider that decides based on the result of other more basic deciders, like \"only scale up if needed by all inner deciders\" or \"allow scale down if one of these deciders allow it\".\nI think I prefer the map style and not allowing such compound deciders in the future.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400739137", "createdAt": "2020-03-31T08:39:40Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicy.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.policy;\n+\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diffable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.decision.AutoscalingDecider;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class AutoscalingPolicy extends AbstractDiffable<AutoscalingPolicy> implements Diffable<AutoscalingPolicy>, ToXContentObject {\n+\n+    public static final String NAME = \"autoscaling_policy\";\n+\n+    public static final ParseField DECIDERS_FIELD = new ParseField(\"deciders\");\n+\n+    public static final ConstructingObjectParser<AutoscalingPolicy, String> PARSER;\n+\n+    static {\n+        PARSER = new ConstructingObjectParser<>(NAME, false, (c, name) -> {\n+            @SuppressWarnings(\"unchecked\")\n+            final List<AutoscalingDecider> deciders = (List<AutoscalingDecider>) c[0];\n+            return new AutoscalingPolicy(name, deciders);\n+        });\n+        PARSER.declareNamedObjects(\n+            ConstructingObjectParser.constructorArg(),\n+            (p, c, n) -> p.namedObject(AutoscalingDecider.class, n, null),\n+            DECIDERS_FIELD\n+        );\n+    }\n+\n+    public static AutoscalingPolicy parse(final XContentParser parser, final String name) {\n+        return PARSER.apply(parser, name);\n+    }\n+\n+    private final String name;\n+\n+    public String name() {\n+        return name;\n+    }\n+\n+    private final List<AutoscalingDecider> deciders;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc1NzMyOQ==", "bodyText": "Looking at other mutate functions, they seem to be more sure of returning an unequal instance. I guess it is very unlikely with 8 random chars, but think it would be more clear if we append something to the existing name instead?", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400757329", "createdAt": "2020-03-31T09:09:08Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/test/java/org/elasticsearch/xpack/autoscaling/AutoscalingTestCase.java", "diffHunk": "@@ -53,4 +62,50 @@ static AutoscalingDecisions randomAutoscalingDecisions(\n         return new AutoscalingDecisions(decisions);\n     }\n \n+    public static List<AutoscalingDecider> randomAutoscalingDeciders() {\n+        return List.of(new AlwaysAutoscalingDecider());\n+    }\n+\n+    public static AutoscalingPolicy randomAutoscalingPolicy() {\n+        return randomAutoscalingPolicyOfName(randomAlphaOfLength(8));\n+    }\n+\n+    public static AutoscalingPolicy randomAutoscalingPolicyOfName(final String name) {\n+        return new AutoscalingPolicy(name, randomAutoscalingDeciders());\n+    }\n+\n+    public static AutoscalingPolicy mutateAutoscalingPolicy(final AutoscalingPolicy instance) {\n+        final List<AutoscalingDecider> deciders;\n+        if (randomBoolean()) {\n+            // if the policy name did not change, or randomly, use a mutated set of deciders\n+            deciders = mutateAutoscailngDeciders(instance.deciders());\n+        } else {\n+            deciders = instance.deciders();\n+        }\n+        return new AutoscalingPolicy(randomAlphaOfLength(8), deciders);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 67}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc1ODQ3NA==", "bodyText": "Depending on the list vs map discussion (see other comment), we could maybe add a random number of always deciders here.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400758474", "createdAt": "2020-03-31T09:11:04Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/test/java/org/elasticsearch/xpack/autoscaling/AutoscalingTestCase.java", "diffHunk": "@@ -53,4 +62,50 @@ static AutoscalingDecisions randomAutoscalingDecisions(\n         return new AutoscalingDecisions(decisions);\n     }\n \n+    public static List<AutoscalingDecider> randomAutoscalingDeciders() {\n+        return List.of(new AlwaysAutoscalingDecider());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc2NzY4MQ==", "bodyText": "I think we write the policy name twice on the stream, both here and in AutoscalingPolicy.writeTo. It looks easy to avoid and if so, I would prefer that. Otherwise, it is not a big deal.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400767681", "createdAt": "2020-03-31T09:25:43Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/AutoscalingMetadata.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diff;\n+import org.elasticsearch.cluster.DiffableUtils;\n+import org.elasticsearch.cluster.NamedDiff;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+public class AutoscalingMetadata implements MetaData.Custom {\n+\n+    public static final String NAME = \"autoscaling\";\n+\n+    public static final ParseField POLICIES_FIELD = new ParseField(\"policies\");\n+    public static final AutoscalingMetadata EMPTY = new AutoscalingMetadata(Collections.emptySortedMap());\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AutoscalingMetadata, Void> PARSER = new ConstructingObjectParser<>(\n+        NAME,\n+        c -> new AutoscalingMetadata(\n+            new TreeMap<>(\n+                ((List<AutoscalingPolicyMetadata>) c[0]).stream().collect(Collectors.toMap(p -> p.policy().name(), Function.identity()))\n+            )\n+        )\n+    );\n+\n+    static {\n+        PARSER.declareNamedObjects(\n+            ConstructingObjectParser.constructorArg(),\n+            (p, c, n) -> AutoscalingPolicyMetadata.parse(p, n),\n+            POLICIES_FIELD\n+        );\n+    }\n+\n+    public static AutoscalingMetadata parse(final XContentParser parser) {\n+        return PARSER.apply(parser, null);\n+    }\n+\n+    private final SortedMap<String, AutoscalingPolicyMetadata> policies;\n+\n+    public SortedMap<String, AutoscalingPolicyMetadata> policies() {\n+        return policies;\n+    }\n+\n+    public AutoscalingMetadata(final SortedMap<String, AutoscalingPolicyMetadata> policies) {\n+        this.policies = policies;\n+    }\n+\n+    public AutoscalingMetadata(final StreamInput in) throws IOException {\n+        final int size = in.readVInt();\n+        final SortedMap<String, AutoscalingPolicyMetadata> policies = new TreeMap<>();\n+        for (int i = 0; i < size; i++) {\n+            policies.put(in.readString(), new AutoscalingPolicyMetadata(in));\n+        }\n+        this.policies = policies;\n+    }\n+\n+    @Override\n+    public void writeTo(final StreamOutput out) throws IOException {\n+        out.writeVInt(policies.size());\n+        for (final Map.Entry<String, AutoscalingPolicyMetadata> policy : policies.entrySet()) {\n+            out.writeString(policy.getKey());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3MDU5OA==", "bodyText": "I think this could be private?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final ParseField POLICIES_FIELD = new ParseField(\"policies\");\n          \n          \n            \n                private static final ParseField POLICIES_FIELD = new ParseField(\"policies\");", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400770598", "createdAt": "2020-03-31T09:30:21Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/AutoscalingMetadata.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diff;\n+import org.elasticsearch.cluster.DiffableUtils;\n+import org.elasticsearch.cluster.NamedDiff;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+public class AutoscalingMetadata implements MetaData.Custom {\n+\n+    public static final String NAME = \"autoscaling\";\n+\n+    public static final ParseField POLICIES_FIELD = new ParseField(\"policies\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3MTk0NQ==", "bodyText": "I think this could be private too? The usage in Autoscaling could use the AutoscalingMetadata.parse method instead.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400771945", "createdAt": "2020-03-31T09:32:31Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/AutoscalingMetadata.java", "diffHunk": "@@ -0,0 +1,169 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diff;\n+import org.elasticsearch.cluster.DiffableUtils;\n+import org.elasticsearch.cluster.NamedDiff;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.EnumSet;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Objects;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+import java.util.function.Function;\n+import java.util.stream.Collectors;\n+\n+public class AutoscalingMetadata implements MetaData.Custom {\n+\n+    public static final String NAME = \"autoscaling\";\n+\n+    public static final ParseField POLICIES_FIELD = new ParseField(\"policies\");\n+    public static final AutoscalingMetadata EMPTY = new AutoscalingMetadata(Collections.emptySortedMap());\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AutoscalingMetadata, Void> PARSER = new ConstructingObjectParser<>(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3NTA2Mw==", "bodyText": "It would be weird to have a policy with no deciders (and I think AutoscalingDecisions require at least one anyway). Maybe we should validate that here?", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400775063", "createdAt": "2020-03-31T09:37:26Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PutAutoscalingPolicyAction.java", "diffHunk": "@@ -0,0 +1,89 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.master.AcknowledgedRequest;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+import java.io.IOException;\n+\n+public class PutAutoscalingPolicyAction extends ActionType<AcknowledgedResponse> {\n+\n+    public static final PutAutoscalingPolicyAction INSTANCE = new PutAutoscalingPolicyAction();\n+    public static final String NAME = \"cluster:admin/autoscaling/put_autoscaling_policy\";\n+\n+    private PutAutoscalingPolicyAction() {\n+        super(NAME, AcknowledgedResponse::new);\n+    }\n+\n+    public static class Request extends AcknowledgedRequest<Request> implements ToXContentObject {\n+\n+        static final ParseField POLICY_FIELD = new ParseField(\"policy\");\n+\n+        @SuppressWarnings(\"unchecked\")\n+        private static final ConstructingObjectParser<Request, String> PARSER = new ConstructingObjectParser<>(\n+            \"put_autoscaling_policy_request\",\n+            a -> new Request((AutoscalingPolicy) a[0])\n+        );\n+\n+        static {\n+            PARSER.declareObject(ConstructingObjectParser.constructorArg(), AutoscalingPolicy::parse, POLICY_FIELD);\n+        }\n+\n+        public static Request parse(final XContentParser parser, final String name) {\n+            return PARSER.apply(parser, name);\n+        }\n+\n+        private final AutoscalingPolicy policy;\n+\n+        public AutoscalingPolicy policy() {\n+            return policy;\n+        }\n+\n+        public Request(final AutoscalingPolicy policy) {\n+            this.policy = policy;\n+        }\n+\n+        public Request(final StreamInput in) throws IOException {\n+            super(in);\n+            policy = new AutoscalingPolicy(in);\n+        }\n+\n+        @Override\n+        public void writeTo(final StreamOutput out) throws IOException {\n+            super.writeTo(out);\n+            policy.writeTo(out);\n+        }\n+\n+        @Override\n+        public ActionRequestValidationException validate() {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc3NjMyOA==", "bodyText": "nit: I think this could be static?", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400776328", "createdAt": "2020-03-31T09:39:30Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/TransportPutAutoscalingPolicyAction.java", "diffHunk": "@@ -0,0 +1,120 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.support.ActionFilters;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.TransportMasterNodeAction;\n+import org.elasticsearch.cluster.AckedClusterStateUpdateTask;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.block.ClusterBlockException;\n+import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n+import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.inject.Inject;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.tasks.Task;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.transport.TransportService;\n+import org.elasticsearch.xpack.autoscaling.AutoscalingMetadata;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicyMetadata;\n+\n+import java.io.IOException;\n+import java.util.SortedMap;\n+import java.util.TreeMap;\n+\n+public class TransportPutAutoscalingPolicyAction extends TransportMasterNodeAction<\n+    PutAutoscalingPolicyAction.Request,\n+    AcknowledgedResponse> {\n+\n+    private final Logger logger = LogManager.getLogger(TransportPutAutoscalingPolicyAction.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NDA1OQ==", "bodyText": "nit:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n             * Represents an autoscaling decider, a component that determines whether or not scale.\n          \n          \n            \n             * Represents an autoscaling decider, a component that determines whether or not to scale.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400784059", "createdAt": "2020-03-31T09:51:51Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/decision/AutoscalingDecider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.decision;\n+\n+import org.elasticsearch.common.io.stream.NamedWriteable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+\n+/**\n+ * Represents an autoscaling decider, a component that determines whether or not scale.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NjM3MQ==", "bodyText": "We can work out the details in follow-ups, but I think this might need to either be passed a suitable context or have some other way of being passed the current state. The current state includes cluster state and cluster info, but the decider will also require access to services like MetaDataRolloverService.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400786371", "createdAt": "2020-03-31T09:55:26Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/decision/AutoscalingDecider.java", "diffHunk": "@@ -0,0 +1,31 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.decision;\n+\n+import org.elasticsearch.common.io.stream.NamedWriteable;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+\n+/**\n+ * Represents an autoscaling decider, a component that determines whether or not scale.\n+ */\n+public interface AutoscalingDecider extends ToXContentObject, NamedWriteable {\n+\n+    /**\n+     * The name of the autoscaling decider.\n+     *\n+     * @return the name\n+     */\n+    String name();\n+\n+    /**\n+     * Whether or not to scale based on the current state.\n+     *\n+     * @return the autoscaling decision\n+     */\n+    AutoscalingDecision scale();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4NzA0NQ==", "bodyText": "I think this could be private?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final ConstructingObjectParser<AutoscalingPolicy, String> PARSER;\n          \n          \n            \n                private static final ConstructingObjectParser<AutoscalingPolicy, String> PARSER;", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400787045", "createdAt": "2020-03-31T09:56:33Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicy.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.policy;\n+\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diffable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.decision.AutoscalingDecider;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class AutoscalingPolicy extends AbstractDiffable<AutoscalingPolicy> implements Diffable<AutoscalingPolicy>, ToXContentObject {\n+\n+    public static final String NAME = \"autoscaling_policy\";\n+\n+    public static final ParseField DECIDERS_FIELD = new ParseField(\"deciders\");\n+\n+    public static final ConstructingObjectParser<AutoscalingPolicy, String> PARSER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4ODYzMA==", "bodyText": "Is empty deciders allowed? I think it is used by tests now.", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400788630", "createdAt": "2020-03-31T09:58:59Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicy.java", "diffHunk": "@@ -0,0 +1,106 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.policy;\n+\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diffable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.xpack.autoscaling.decision.AutoscalingDecider;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class AutoscalingPolicy extends AbstractDiffable<AutoscalingPolicy> implements Diffable<AutoscalingPolicy>, ToXContentObject {\n+\n+    public static final String NAME = \"autoscaling_policy\";\n+\n+    public static final ParseField DECIDERS_FIELD = new ParseField(\"deciders\");\n+\n+    public static final ConstructingObjectParser<AutoscalingPolicy, String> PARSER;\n+\n+    static {\n+        PARSER = new ConstructingObjectParser<>(NAME, false, (c, name) -> {\n+            @SuppressWarnings(\"unchecked\")\n+            final List<AutoscalingDecider> deciders = (List<AutoscalingDecider>) c[0];\n+            return new AutoscalingPolicy(name, deciders);\n+        });\n+        PARSER.declareNamedObjects(\n+            ConstructingObjectParser.constructorArg(),\n+            (p, c, n) -> p.namedObject(AutoscalingDecider.class, n, null),\n+            DECIDERS_FIELD\n+        );\n+    }\n+\n+    public static AutoscalingPolicy parse(final XContentParser parser, final String name) {\n+        return PARSER.apply(parser, name);\n+    }\n+\n+    private final String name;\n+\n+    public String name() {\n+        return name;\n+    }\n+\n+    private final List<AutoscalingDecider> deciders;\n+\n+    public List<AutoscalingDecider> deciders() {\n+        return deciders;\n+    }\n+\n+    public AutoscalingPolicy(final String name, final List<AutoscalingDecider> deciders) {\n+        this.name = name;\n+        this.deciders = deciders;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDc4OTQyMA==", "bodyText": "I think this could be private?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                public static final ConstructingObjectParser<AutoscalingPolicyMetadata, String> PARSER;\n          \n          \n            \n                private static final ConstructingObjectParser<AutoscalingPolicyMetadata, String> PARSER;", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400789420", "createdAt": "2020-03-31T10:00:15Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicyMetadata.java", "diffHunk": "@@ -0,0 +1,85 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.policy;\n+\n+import org.elasticsearch.cluster.AbstractDiffable;\n+import org.elasticsearch.cluster.Diffable;\n+import org.elasticsearch.common.ParseField;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.xcontent.ConstructingObjectParser;\n+import org.elasticsearch.common.xcontent.ToXContentObject;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class AutoscalingPolicyMetadata extends AbstractDiffable<AutoscalingPolicyMetadata>\n+    implements\n+        Diffable<AutoscalingPolicyMetadata>,\n+        ToXContentObject {\n+\n+    static final ParseField POLICY_FIELD = new ParseField(\"policy\");\n+\n+    @SuppressWarnings(\"unchecked\")\n+    public static final ConstructingObjectParser<AutoscalingPolicyMetadata, String> PARSER;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDgwMzYwMw==", "bodyText": "I am mildly mystified by how this works (same instance), given that we pick a random node's client in each of the calls and have multiple nodes running? Nevertheless, I ran the test 100 times, so this is purely for my education....", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r400803603", "createdAt": "2020-03-31T10:23:57Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/test/java/org/elasticsearch/xpack/autoscaling/action/TransportPutAutoscalingPolicyActionIT.java", "diffHunk": "@@ -0,0 +1,62 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.xpack.autoscaling.AutoscalingIntegTestCase;\n+import org.elasticsearch.xpack.autoscaling.AutoscalingMetadata;\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+import static org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertAcked;\n+import static org.elasticsearch.xpack.autoscaling.AutoscalingTestCase.mutateAutoscailngDeciders;\n+import static org.elasticsearch.xpack.autoscaling.AutoscalingTestCase.randomAutoscalingPolicy;\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasKey;\n+import static org.hamcrest.Matchers.sameInstance;\n+\n+public class TransportPutAutoscalingPolicyActionIT extends AutoscalingIntegTestCase {\n+\n+    public void testAddPolicy() {\n+        final AutoscalingPolicy policy = putRandomAutoscalingPolicy();\n+        final ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        final AutoscalingMetadata metadata = state.metaData().custom(AutoscalingMetadata.NAME);\n+        assertNotNull(metadata);\n+        assertThat(metadata.policies(), hasKey(policy.name()));\n+        assertThat(metadata.policies().get(policy.name()).policy(), equalTo(policy));\n+    }\n+\n+    public void testUpdatePolicy() {\n+        final AutoscalingPolicy policy = putRandomAutoscalingPolicy();\n+        final AutoscalingPolicy updatedPolicy = new AutoscalingPolicy(policy.name(), mutateAutoscailngDeciders(policy.deciders()));\n+        putAutoscalingPolicy(updatedPolicy);\n+        final ClusterState state = client().admin().cluster().prepareState().get().getState();\n+        final AutoscalingMetadata metadata = state.metaData().custom(AutoscalingMetadata.NAME);\n+        assertNotNull(metadata);\n+        assertThat(metadata.policies(), hasKey(policy.name()));\n+        assertThat(metadata.policies().get(policy.name()).policy(), equalTo(updatedPolicy));\n+    }\n+\n+    public void testNoOpPolicy() {\n+        final AutoscalingPolicy policy = putRandomAutoscalingPolicy();\n+        final ClusterState beforeState = client().admin().cluster().prepareState().get().getState();\n+        putAutoscalingPolicy(policy);\n+        final ClusterState afterState = client().admin().cluster().prepareState().get().getState();\n+        assertThat(beforeState.custom(AutoscalingMetadata.NAME), sameInstance(afterState.custom(AutoscalingMetadata.NAME)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c83985f0084c2dff40ad8ba2a30a8c8981023890"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3217c3f0a94031ebccc54e34b48da34b089c8e7", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3217c3f0a94031ebccc54e34b48da34b089c8e7", "committedDate": "2020-03-31T22:00:33Z", "message": "Merge remote-tracking branch 'elastic/master' into autoscaling-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b304130a56c3d8e790dd2fa42ab5ceb3969be6d", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b304130a56c3d8e790dd2fa42ab5ceb3969be6d", "committedDate": "2020-03-31T22:03:28Z", "message": "Make policies field private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bab7b9550220dfce1ba3f9d18aefa61a977fcd55", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/bab7b9550220dfce1ba3f9d18aefa61a977fcd55", "committedDate": "2020-03-31T22:15:06Z", "message": "Add test for bad request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b27f48d2a4e0ed39c4ce1fc9ae23b2c1f572a873", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/b27f48d2a4e0ed39c4ce1fc9ae23b2c1f572a873", "committedDate": "2020-03-31T22:16:08Z", "message": "Mark PARSER private"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bf3f00c4425133ff09adc97d95e1c1d7235c8b7", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/5bf3f00c4425133ff09adc97d95e1c1d7235c8b7", "committedDate": "2020-03-31T22:19:28Z", "message": "Simple validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26ec5b2235a6ddd7653f1cc5ce8a76eed4e026ab", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/26ec5b2235a6ddd7653f1cc5ce8a76eed4e026ab", "committedDate": "2020-03-31T22:20:17Z", "message": "Logger is static"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "673715aaa70f1e198647ead6da2bc56c8c57c7ca", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/673715aaa70f1e198647ead6da2bc56c8c57c7ca", "committedDate": "2020-03-31T22:20:42Z", "message": "State block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5433f729d746893c5f5cb9eaf608c9636135b93", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5433f729d746893c5f5cb9eaf608c9636135b93", "committedDate": "2020-03-31T22:30:30Z", "message": "Add write block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b354bb609b9f38c8991429747f962f9870ed3757", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/b354bb609b9f38c8991429747f962f9870ed3757", "committedDate": "2020-03-31T22:31:39Z", "message": "Update x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/decision/AutoscalingDecider.java\n\nCo-Authored-By: Henning Andersen <33268011+henningandersen@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c78bf35715106f33b4e6ef38f9821bbad8c70e7c", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c78bf35715106f33b4e6ef38f9821bbad8c70e7c", "committedDate": "2020-03-31T22:32:29Z", "message": "Remove unneeded variable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752f363c1bb351c3eab42af7b17a0a5857e1c5a1", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/752f363c1bb351c3eab42af7b17a0a5857e1c5a1", "committedDate": "2020-03-31T22:33:02Z", "message": "Fix name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd4020c73cbedf05f221f0128964c82ee4895c8e", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd4020c73cbedf05f221f0128964c82ee4895c8e", "committedDate": "2020-03-31T22:33:58Z", "message": "Ensure unique name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e0c43121d007a85f5f43492f46effdc14e0329f", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e0c43121d007a85f5f43492f46effdc14e0329f", "committedDate": "2020-03-31T22:36:37Z", "message": "Update x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicyMetadata.java\n\nCo-Authored-By: Henning Andersen <33268011+henningandersen@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55e8edc656a1acbd072083d2f758bf7c1ff41a0d", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/55e8edc656a1acbd072083d2f758bf7c1ff41a0d", "committedDate": "2020-03-31T22:37:13Z", "message": "Update x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/policy/AutoscalingPolicy.java\n\nCo-Authored-By: Henning Andersen <33268011+henningandersen@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2996709944071e205e9a237b04717e5b24de04a6", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/2996709944071e205e9a237b04717e5b24de04a6", "committedDate": "2020-03-31T23:28:21Z", "message": "Another blocks test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d4e108ee31ed2bd3878556c94fcd5abca2234a5", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d4e108ee31ed2bd3878556c94fcd5abca2234a5", "committedDate": "2020-04-01T01:28:04Z", "message": "Use map"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5f45905cd279c25d35bd1cf38e3c0eff9f01fef", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5f45905cd279c25d35bd1cf38e3c0eff9f01fef", "committedDate": "2020-04-01T01:41:06Z", "message": "Address serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e8f2792515bb16b7fe3f1f947a072730e70bdb2", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e8f2792515bb16b7fe3f1f947a072730e70bdb2", "committedDate": "2020-04-01T01:43:20Z", "message": "Add TODOs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e31a527b17cdc513a56845f0fda0791a93b8b51", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e31a527b17cdc513a56845f0fda0791a93b8b51", "committedDate": "2020-04-01T02:30:19Z", "message": "Fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "99fcd1687e1821b12e7ed6687802797b5011f588", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/99fcd1687e1821b12e7ed6687802797b5011f588", "committedDate": "2020-04-01T02:54:39Z", "message": "Spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzgxMjAz", "url": "https://github.com/elastic/elasticsearch/pull/54473#pullrequestreview-385381203", "createdAt": "2020-04-01T08:46:19Z", "commit": {"oid": "99fcd1687e1821b12e7ed6687802797b5011f588"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODo0NjoyMFrOF-2r-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMVQwODo0NjoyMFrOF-2r-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTQ1MjAyNw==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/54473#discussion_r401452027", "createdAt": "2020-04-01T08:46:20Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/Autoscaling.java", "diffHunk": "@@ -11,7 +11,7 @@\n import org.elasticsearch.action.ActionResponse;\n import org.elasticsearch.cluster.NamedDiff;\n import org.elasticsearch.cluster.metadata.IndexNameExpressionResolver;\n-import org.elasticsearch.cluster.metadata.MetaData;\n+import org.elasticsearch.cluster.metadata.Metadata;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99fcd1687e1821b12e7ed6687802797b5011f588"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1379, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}