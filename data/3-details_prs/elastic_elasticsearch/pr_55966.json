{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwOTEwMDMy", "number": 55966, "title": "Add geo_shape support for geotile_grid and geohash_grid", "bodyText": "this commit adds aggregation support for the geo_shape field\ntype on geo*_grid aggregations.\nit introduces a Tiler for both tiles and hashes that enables a new type of\nValuesSource to replace the GeoPoint's CellIdSource. This makes it possible\nfor the existing Aggregator to be re-used, so no new implementations of\nthe grid aggregators are added.", "createdAt": "2020-04-29T19:32:33Z", "url": "https://github.com/elastic/elasticsearch/pull/55966", "merged": true, "mergeCommit": {"oid": "f26ee1298d9b56a16d94538adaf5728625475cc7"}, "closed": true, "closedAt": "2020-05-05T15:00:17Z", "author": {"login": "talevy"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccdqNpgH2gAyNDEwOTEwMDMyOmIwZjMwYjcxZDM5OGEyNDM5YzQwNGU4OTgyYjRhOTk3MWIyNjRhYjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceGaizAH2gAyNDEwOTEwMDMyOjdlNGMyMGZkMzBjNjc0MzMyNDAzODZlNmZlY2E0OTUxYjk4ZDExMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b0f30b71d398a2439c404e8982b4a9971b264ab7", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0f30b71d398a2439c404e8982b4a9971b264ab7", "committedDate": "2020-04-29T19:29:19Z", "message": "Add geo_shape support for geotile_grid and geohash_grid\n\nthis commit adds aggregation support for the geo_shape field\ntype on geo*_grid aggregations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e4d8cbfe5f0caecd904d5ec38ffc3dae52b2193", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e4d8cbfe5f0caecd904d5ec38ffc3dae52b2193", "committedDate": "2020-04-29T19:42:10Z", "message": "Merge remote-tracking branch 'elastic/master' into ggrid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1dee6ebed310d1c53e7656ff462b6e10a7f41eb6", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/1dee6ebed310d1c53e7656ff462b6e10a7f41eb6", "committedDate": "2020-04-29T20:11:03Z", "message": "fix style"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2d9ed0c68d2e943c1ad6ff7984c4d48c2571b3f", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2d9ed0c68d2e943c1ad6ff7984c4d48c2571b3f", "committedDate": "2020-04-29T20:57:43Z", "message": "add missing mapped test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjkzODgw", "url": "https://github.com/elastic/elasticsearch/pull/55966#pullrequestreview-403293880", "createdAt": "2020-04-30T08:08:47Z", "commit": {"oid": "b2d9ed0c68d2e943c1ad6ff7984c4d48c2571b3f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODowODo0N1rOGOeZNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODowODo0N1rOGOeZNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzgzMTIyMw==", "bodyText": "Should be SPATIAL_GEO_GRID?", "url": "https://github.com/elastic/elasticsearch/pull/55966#discussion_r417831223", "createdAt": "2020-04-30T08:08:47Z", "author": {"login": "iverase"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java", "diffHunk": "@@ -110,13 +122,49 @@ public void registerGeoShapeCentroidAggregator(ValuesSourceRegistry.Builder buil\n             });\n     }\n \n-    public static void registerValueCountAggregator(ValuesSourceRegistry.Builder builder) {\n+    public void registerGeoShapeGridAggregators(ValuesSourceRegistry.Builder builder) {\n+        builder.register(GeoHashGridAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),\n+            (GeoGridAggregatorSupplier) (name, factories, valuesSource, precision, geoBoundingBox, requiredSize, shardSize,\n+                                         aggregationContext, parent, metadata) -> {\n+                if (getLicenseState().isAllowed(XPackLicenseState.Feature.SPATIAL_GEO_CENTROID)) {\n+                    final GeoGridTiler tiler;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2d9ed0c68d2e943c1ad6ff7984c4d48c2571b3f"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "59c8bcf27d9d750d397bbc120f5f4db326bfc940", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/59c8bcf27d9d750d397bbc120f5f4db326bfc940", "committedDate": "2020-04-30T14:41:21Z", "message": "Merge remote-tracking branch 'elastic/master' into ggrid"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTk0OTQz", "url": "https://github.com/elastic/elasticsearch/pull/55966#pullrequestreview-403594943", "createdAt": "2020-04-30T14:48:29Z", "commit": {"oid": "59c8bcf27d9d750d397bbc120f5f4db326bfc940"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0ODoyOVrOGOs04g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQxNDo0ODoyOVrOGOs04g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODA2NzY4Mg==", "bodyText": "Why other registers are static except this one? needs to be public?", "url": "https://github.com/elastic/elasticsearch/pull/55966#discussion_r418067682", "createdAt": "2020-04-30T14:48:29Z", "author": {"login": "iverase"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java", "diffHunk": "@@ -110,13 +122,49 @@ public void registerGeoShapeCentroidAggregator(ValuesSourceRegistry.Builder buil\n             });\n     }\n \n-    public static void registerValueCountAggregator(ValuesSourceRegistry.Builder builder) {\n+    public void registerGeoShapeGridAggregators(ValuesSourceRegistry.Builder builder) {\n+        builder.register(GeoHashGridAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59c8bcf27d9d750d397bbc120f5f4db326bfc940"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8198e0276474c63583cbd02c97039c22c948e1c", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8198e0276474c63583cbd02c97039c22c948e1c", "committedDate": "2020-04-30T14:53:23Z", "message": "fix scoping of registration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNjE0Mjk3", "url": "https://github.com/elastic/elasticsearch/pull/55966#pullrequestreview-403614297", "createdAt": "2020-04-30T15:08:49Z", "commit": {"oid": "c8198e0276474c63583cbd02c97039c22c948e1c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "368f5b6b63960a49db846a3fc47c97e18a14af74", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/368f5b6b63960a49db846a3fc47c97e18a14af74", "committedDate": "2020-04-30T20:52:38Z", "message": "Merge remote-tracking branch 'elastic/master' into ggrid"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7dbb6b03bf702a13bd4ab6eefb19db4d3bb45f3", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7dbb6b03bf702a13bd4ab6eefb19db4d3bb45f3", "committedDate": "2020-05-01T04:03:18Z", "message": "add circuit-breaking logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d0feb6026abf9ea78cdadc2c1ed1d5d3d32845b0", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/d0feb6026abf9ea78cdadc2c1ed1d5d3d32845b0", "committedDate": "2020-05-01T04:04:18Z", "message": "set initial breaker consumer to be a no-op"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0MDExNDQ3", "url": "https://github.com/elastic/elasticsearch/pull/55966#pullrequestreview-404011447", "createdAt": "2020-05-01T04:07:01Z", "commit": {"oid": "d0feb6026abf9ea78cdadc2c1ed1d5d3d32845b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwNDowNzowMVrOGPBleA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wMVQwNDowNzowMVrOGPBleA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxODQwNzgwMA==", "bodyText": "I think I figured out the circuit-breaking logic!\nthis is my least favorite part. a hack to give GeoShapeCellIdSource access to AggregatorBase's circuit-breaker logic, which must be created before the aggregator is created.", "url": "https://github.com/elastic/elasticsearch/pull/55966#discussion_r418407800", "createdAt": "2020-05-01T04:07:01Z", "author": {"login": "talevy"}, "path": "x-pack/plugin/spatial/src/main/java/org/elasticsearch/xpack/spatial/SpatialPlugin.java", "diffHunk": "@@ -110,13 +122,53 @@ public void registerGeoShapeCentroidAggregator(ValuesSourceRegistry.Builder buil\n             });\n     }\n \n-    public static void registerValueCountAggregator(ValuesSourceRegistry.Builder builder) {\n+    private void registerGeoShapeGridAggregators(ValuesSourceRegistry.Builder builder) {\n+        builder.register(GeoHashGridAggregationBuilder.NAME, GeoShapeValuesSourceType.instance(),\n+            (GeoGridAggregatorSupplier) (name, factories, valuesSource, precision, geoBoundingBox, requiredSize, shardSize,\n+                                         aggregationContext, parent, metadata) -> {\n+                if (getLicenseState().isAllowed(XPackLicenseState.Feature.SPATIAL_GEO_GRID)) {\n+                    final GeoGridTiler tiler;\n+                    if (geoBoundingBox.isUnbounded()) {\n+                        tiler = new GeoHashGridTiler();\n+                    } else {\n+                        tiler = new BoundedGeoHashGridTiler(geoBoundingBox);\n+                    }\n+                    GeoShapeCellIdSource cellIdSource = new GeoShapeCellIdSource((GeoShapeValuesSource) valuesSource, precision, tiler);\n+                    GeoShapeHashGridAggregator agg = new GeoShapeHashGridAggregator(name, factories, cellIdSource, requiredSize, shardSize,\n+                        aggregationContext, parent, metadata);\n+                    cellIdSource.setCircuitBreakerConsumer(agg::addRequestBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0feb6026abf9ea78cdadc2c1ed1d5d3d32845b0"}, "originalPosition": 79}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MTU2NzYy", "url": "https://github.com/elastic/elasticsearch/pull/55966#pullrequestreview-405156762", "createdAt": "2020-05-04T16:37:31Z", "commit": {"oid": "d0feb6026abf9ea78cdadc2c1ed1d5d3d32845b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83da59bf13777c315297b8a2f6df079950402dfa", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/83da59bf13777c315297b8a2f6df079950402dfa", "committedDate": "2020-05-04T21:31:55Z", "message": "fix bug in tiling optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e4c20fd30c67433240386e6feca4951b98d1114", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e4c20fd30c67433240386e6feca4951b98d1114", "committedDate": "2020-05-04T21:32:14Z", "message": "Merge remote-tracking branch 'elastic/master' into ggrid"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 323, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}