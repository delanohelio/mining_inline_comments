{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDczOTc2OTgy", "number": 61590, "title": "Allow metadata fields in the _source", "bodyText": "So far we don't allow metadata fields in the document _source. However, in the case of the _doc_count field mapper (#58339) we want to be able to set\nThis PR adds a method to the metadata field parsers that exposes if the field can be included in the document source or not.\nThis way each metadata field can configure if it can be included in the document _source", "createdAt": "2020-08-26T15:14:09Z", "url": "https://github.com/elastic/elasticsearch/pull/61590", "merged": true, "mergeCommit": {"oid": "55294e5c424e93efbe314b3f0a4bb610836ad570"}, "closed": true, "closedAt": "2020-09-18T06:45:33Z", "author": {"login": "csoulios"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdCtI6mgH2gAyNDczOTc2OTgyOjhhNjVkMWM0YmY3ZmMxZTJiMzE0MDBkNzJmOTgwYzMzMWRkMWY1Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJ3crBgFqTQ5MDk4NDIwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a65d1c4bf7fc1e2b31400d72f980c331dd1f5b7", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a65d1c4bf7fc1e2b31400d72f980c331dd1f5b7", "committedDate": "2020-08-26T15:00:33Z", "message": "Configurable metadata field mappers in the _source"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2Mjc0OTAy", "url": "https://github.com/elastic/elasticsearch/pull/61590#pullrequestreview-476274902", "createdAt": "2020-08-27T01:05:31Z", "commit": {"oid": "8a65d1c4bf7fc1e2b31400d72f980c331dd1f5b7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d83b67723679cb7900f468a738c7635ef5789620", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/d83b67723679cb7900f468a738c7635ef5789620", "committedDate": "2020-09-08T16:50:27Z", "message": "Changes to support metadata fields in _source\nAdded test testDocumentContainsAllowedMetadataField()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76f3dc36707ef36d438a3f48b768b14c5c5c13d8", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/76f3dc36707ef36d438a3f48b768b14c5c5c13d8", "committedDate": "2020-09-08T17:06:27Z", "message": "Merge branch 'master' into metadata-source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4934129da49025b3d3d314efe8d65d922053c9d1", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/4934129da49025b3d3d314efe8d65d922053c9d1", "committedDate": "2020-09-09T12:13:47Z", "message": "Merged DocumentParserTests from master\nFixed broken tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a168a1be2bea0f0a13765c93b7ebc19626559c76", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/a168a1be2bea0f0a13765c93b7ebc19626559c76", "committedDate": "2020-09-09T12:14:25Z", "message": "Merge branch 'master' into metadata-source"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg1MzQ5NzEx", "url": "https://github.com/elastic/elasticsearch/pull/61590#pullrequestreview-485349711", "createdAt": "2020-09-09T19:43:33Z", "commit": {"oid": "a168a1be2bea0f0a13765c93b7ebc19626559c76"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTo0MzozM1rOHPXUOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOVQxOTo1MDozOFrOHPXr-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3MjY5Ng==", "bodyText": "Maybe we should throw a parsing error if the token isn't a string instead of silently allowing it?", "url": "https://github.com/elastic/elasticsearch/pull/61590#discussion_r485872696", "createdAt": "2020-09-09T19:43:33Z", "author": {"login": "jtibshirani"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/MockMetadataMapperPlugin.java", "diffHunk": "@@ -0,0 +1,111 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.document.Field;\n+import org.apache.lucene.document.StringField;\n+import org.elasticsearch.common.xcontent.XContentParser;\n+import org.elasticsearch.plugins.MapperPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.Iterator;\n+import java.util.List;\n+import java.util.Map;\n+\n+/**\n+ * Mapper plugin providing a mock metadata field mapper implementation that supports setting its value\n+ * through the document source.\n+ */\n+public class MockMetadataMapperPlugin extends Plugin implements MapperPlugin {\n+\n+    /**\n+     * A mock metadata field mapper that supports being set from the document source.\n+     */\n+    public static class MockMetadataMapper extends MetadataFieldMapper {\n+\n+        static final String CONTENT_TYPE = \"_mock_metadata\";\n+        static final String FIELD_NAME = \"_mock_metadata\";\n+\n+        protected MockMetadataMapper() {\n+            super(new KeywordFieldMapper.KeywordFieldType(FIELD_NAME));\n+        }\n+\n+        @Override\n+        protected void parseCreateField(ParseContext context) throws IOException {\n+            if (context.parser().currentToken() == XContentParser.Token.VALUE_STRING) {\n+                context.doc().add(new StringField(FIELD_NAME, context.parser().text(), Field.Store.YES));\n+            } else {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a168a1be2bea0f0a13765c93b7ebc19626559c76"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3NjYxNA==", "bodyText": "I'm wondering if we really need this new flag isAllowedInSource. Maybe we could avoid adding a new flag and instead do the following:\n\nFor metadata fields that are not allowed in _source, make sure that MetadataFieldMapper#parse throws an descriptive error.\nMany metadata fields currently have logic in parse that's unrelated to _source parsing. We could make sure to move it into the special methods preParse or postParse.", "url": "https://github.com/elastic/elasticsearch/pull/61590#discussion_r485876614", "createdAt": "2020-09-09T19:48:07Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MetadataFieldMapper.java", "diffHunk": "@@ -45,6 +45,14 @@\n          * @param parserContext context that may be useful to build the field like analyzers\n          */\n         MetadataFieldMapper getDefault(ParserContext parserContext);\n+\n+        /**\n+         *  @return Whether a metadata field can be included in the document _source.\n+         */\n+        default boolean isAllowedInSource() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a168a1be2bea0f0a13765c93b7ebc19626559c76"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTg3ODc3OQ==", "bodyText": "What's the reasoning for rejecting null and non-leaf values here?", "url": "https://github.com/elastic/elasticsearch/pull/61590#discussion_r485878779", "createdAt": "2020-09-09T19:50:38Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -391,9 +391,21 @@ private static void innerParseObject(ParseContext context, ObjectMapper mapper,\n             if (token == XContentParser.Token.FIELD_NAME) {\n                 currentFieldName = parser.currentName();\n                 paths = splitAndValidatePath(currentFieldName);\n+\n                 if (context.mapperService().isMetadataField(context.path().pathAsText(currentFieldName))) {\n-                    throw new MapperParsingException(\"Field [\" + currentFieldName + \"] is a metadata field and cannot be added inside\"\n-                        + \" a document. Use the index API request parameters.\");\n+                    if (context.mapperService().isFieldAllowedInSource(context.path().pathAsText(currentFieldName))) {\n+                        // If token is a metadata field and is allowed in source, parse its value", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a168a1be2bea0f0a13765c93b7ebc19626559c76"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2effa2f46e16d7bd1a8f63113d71c39a1b023c2f", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/2effa2f46e16d7bd1a8f63113d71c39a1b023c2f", "committedDate": "2020-09-10T16:11:03Z", "message": "Handle non string values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f5aa63dc67bb78a7c34b79df34b6764b954f04d", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f5aa63dc67bb78a7c34b79df34b6764b954f04d", "committedDate": "2020-09-16T12:00:57Z", "message": "Allow metadata fields to parse values/objects/arrays/null"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78faca38b4b4e8eb0a40af4d6fc5d60343da36e3", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/78faca38b4b4e8eb0a40af4d6fc5d60343da36e3", "committedDate": "2020-09-16T16:55:17Z", "message": "Removed MetadataFieldMapper.isAllowedInSource() method\n\nDelegated this functionality to MetadataFieldMapper.parse()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13468659fd9907034c7d82cb4545c880fa6a56f6", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/13468659fd9907034c7d82cb4545c880fa6a56f6", "committedDate": "2020-09-16T17:01:43Z", "message": "Merge branch 'master' into metadata-source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39d19fe38d438bf5799dde3c5b1ff931e2fc1a1b", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/39d19fe38d438bf5799dde3c5b1ff931e2fc1a1b", "committedDate": "2020-09-16T19:57:42Z", "message": "Fixed bug that caused tests to break"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5OTkxNjMw", "url": "https://github.com/elastic/elasticsearch/pull/61590#pullrequestreview-489991630", "createdAt": "2020-09-16T20:22:06Z", "commit": {"oid": "39d19fe38d438bf5799dde3c5b1ff931e2fc1a1b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDoyMjowN1rOHTC2jw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQyMDoyMjowN1rOHTC2jw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTczMTcyNw==", "bodyText": "Instead of overriding parse here, could we override parseCreateField?\n@Override\nprotected void parseCreateField(ParseContext context) throws IOException {\n    throw new MapperParsingException(\"Field [\" + name() + \"] is a metadata field and cannot be added inside\"\n        + \" a document. Use the index API request parameters.\");\n}\n\nThen we could do the following:\n\nFor meta fields that cannot be specified in _source, move all the relevant logic out of parseCreateField and into preParse or postParse as appropriate.\nRemove the new doParse method, as it's no longer needed.", "url": "https://github.com/elastic/elasticsearch/pull/61590#discussion_r489731727", "createdAt": "2020-09-16T20:22:07Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MetadataFieldMapper.java", "diffHunk": "@@ -153,10 +153,35 @@ public final XContentBuilder toXContent(XContentBuilder builder, Params params)\n         return builder.endObject();\n     }\n \n+    /*\n+     * By default metadata fields cannot be set through the document source and parse() method\n+     * throws an exception. To enable a metadata field to parse the document source, this\n+     * method must be overridden and doParse() should be called.\n+     */\n+    @Override\n+    public void parse(ParseContext context) throws IOException {\n+        throw new MapperParsingException(\"Field [\" + name() + \"] is a metadata field and cannot be added inside\"\n+            + \" a document. Use the index API request parameters.\");\n+    }\n+\n+    /**\n+     * Do the actual parse of the field by calling {@link FieldMapper#parse(ParseContext)}\n+     */\n+    protected void doParse(ParseContext context) throws IOException {\n+        super.parse(context);\n+    }\n+\n+    @Override\n+    protected void parseCreateField(ParseContext context) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39d19fe38d438bf5799dde3c5b1ff931e2fc1a1b"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0bb9578d911b0ad4c80a755e9983904082eaa74", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0bb9578d911b0ad4c80a755e9983904082eaa74", "committedDate": "2020-09-17T15:41:05Z", "message": "Cleanup parsing for existing metadata fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a734ea888118bab84e2aa8af25ffd96eb4022a78", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/a734ea888118bab84e2aa8af25ffd96eb4022a78", "committedDate": "2020-09-17T18:20:54Z", "message": "Cleanup parsing for existing metadata fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8b3a9d4329ccadfa7332922047d6f205c0d7ccb", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8b3a9d4329ccadfa7332922047d6f205c0d7ccb", "committedDate": "2020-09-17T19:07:54Z", "message": "Remove doParse() method"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTI1Njk1", "url": "https://github.com/elastic/elasticsearch/pull/61590#pullrequestreview-490925695", "createdAt": "2020-09-17T19:34:15Z", "commit": {"oid": "b8b3a9d4329ccadfa7332922047d6f205c0d7ccb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTozNDoxNVrOHTydQw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxOTozNDoxNVrOHTydQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDUxMTY4Mw==", "bodyText": "I just noticed we're doing a linear scan through all the metadata mappers. Maybe we should make sure to store them as a map from name -> mapper to avoid this overhead?", "url": "https://github.com/elastic/elasticsearch/pull/61590#discussion_r490511683", "createdAt": "2020-09-17T19:34:15Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -881,7 +878,16 @@ private static void parseCopy(String field, ParseContext context) throws IOExcep\n     }\n \n     // looks up a child mapper, but takes into account field names that expand to objects\n-    private static Mapper getMapper(ObjectMapper objectMapper, String fieldName, String[] subfields) {\n+    private static Mapper getMapper(final ParseContext context, ObjectMapper objectMapper, String fieldName, String[] subfields) {\n+        String fieldPath = context.path().pathAsText(fieldName);\n+        if (context.mapperService().isMetadataField(fieldPath)) {\n+            for (MetadataFieldMapper metadataFieldMapper : context.docMapper().mapping().getMetadataMappers()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8b3a9d4329ccadfa7332922047d6f205c0d7ccb"}, "originalPosition": 56}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1560e732c1222c71ad0c2b64b5ae0dbeeb82bf84", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/1560e732c1222c71ad0c2b64b5ae0dbeeb82bf84", "committedDate": "2020-09-17T19:41:06Z", "message": "Fix broken test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c962c48fb24a46d42210c1bf98218d0cb278f1d", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c962c48fb24a46d42210c1bf98218d0cb278f1d", "committedDate": "2020-09-17T20:02:52Z", "message": "Lookup metadata mapper by name\n\nInstead of linear scan"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwOTg0MjAz", "url": "https://github.com/elastic/elasticsearch/pull/61590#pullrequestreview-490984203", "createdAt": "2020-09-17T20:58:39Z", "commit": {"oid": "0c962c48fb24a46d42210c1bf98218d0cb278f1d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4578, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}