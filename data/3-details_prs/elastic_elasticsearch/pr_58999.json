{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTU4NTkx", "number": 58999, "title": "[ML] handle broken setup with state alias being an index", "bodyText": ".ml-state-write is supposed to be an index alias, however by accident it can become an index. If\n.ml-state-write is a concrete index instead of an alias ML stops working. This change improves error\nhandling by setting the job to failed and properly log and audit the problem. The user still has to\nmanually fix the problem. This change should lead to a quicker resolution of the problem.\nfixes #58482", "createdAt": "2020-07-03T09:35:20Z", "url": "https://github.com/elastic/elasticsearch/pull/58999", "merged": true, "mergeCommit": {"oid": "8b5437010ce28df628d87b14c00e5c1cc33c91b1"}, "closed": true, "closedAt": "2020-07-03T13:24:33Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxQdKFAFqTQ0MjI5ODkwOA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxRNY_gBqjM1MTA1OTA2Nzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyMjk4OTA4", "url": "https://github.com/elastic/elasticsearch/pull/58999#pullrequestreview-442298908", "createdAt": "2020-07-03T09:58:18Z", "commit": {"oid": "599db9ff86f5a4069665831c357054940ba8e593"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTo1ODoxOFrOGsrEmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wM1QwOTo1ODoxOFrOGsrEmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTQ5NjIxNg==", "bodyText": "Might be best not to say \"your\" in the error, as the problem could be due to a bug and users might take offence that we're blaming them for it.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                String msg = \"Detected a problem with your setup of machine learning, the state index alias [\"\n          \n          \n            \n                                String msg = \"Detected a problem with the internal machine learning data: the state index alias [\"", "url": "https://github.com/elastic/elasticsearch/pull/58999#discussion_r449496216", "createdAt": "2020-07-03T09:58:18Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectProcessManager.java", "diffHunk": "@@ -426,7 +427,19 @@ protected void doRun() {\n                     e -> closeHandler.accept(e, true)\n                 ));\n             },\n-            e -> closeHandler.accept(e, true));\n+            e -> {\n+                if (ExceptionsHelper.unwrapCause(e) instanceof InvalidAliasNameException) {\n+                    String msg = \"Detected a problem with your setup of machine learning, the state index alias [\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "599db9ff86f5a4069665831c357054940ba8e593"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a1772f7e35ee3f7aee75e7e0cfbde8e6cac6144", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a1772f7e35ee3f7aee75e7e0cfbde8e6cac6144", "committedDate": "2020-07-03T10:51:02Z", "message": "handle the case that .ml-state-write is an index instead of an alias"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d26422c1f46b73633ac5062ec9a9d28edaa8b471", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/d26422c1f46b73633ac5062ec9a9d28edaa8b471", "committedDate": "2020-07-03T10:51:02Z", "message": "fix log message"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "3910a6c82e7046a49e7e976e467f4abf8c63d195", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/3910a6c82e7046a49e7e976e467f4abf8c63d195", "committedDate": "2020-07-03T10:07:34Z", "message": "Update x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectProcessManager.java\n\nCo-authored-by: David Roberts <dave.roberts@elastic.co>"}, "afterCommit": {"oid": "d26422c1f46b73633ac5062ec9a9d28edaa8b471", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/d26422c1f46b73633ac5062ec9a9d28edaa8b471", "committedDate": "2020-07-03T10:51:02Z", "message": "fix log message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2235, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}