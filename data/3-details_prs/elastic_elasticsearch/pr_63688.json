{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzNDg5MDky", "number": 63688, "title": "[ML] fix inference binary classification predication label and feature importance", "bodyText": "When calculating feature importance, the leaf values directly correlate the value of the importance.\nConsequently, positive leaf values -> positive feature importance\nnegative leaf values -> negative feature importance.\nIt follows that for binary classification, this is done such that the importance relates to the leaf values, which relate directly to the \"probability of class 1\".\nSo, the feature importance calculated is always for the importance as it relates to class 1.\nThe inverse is the importance as it relates to class 0.", "createdAt": "2020-10-14T16:16:59Z", "url": "https://github.com/elastic/elasticsearch/pull/63688", "merged": true, "mergeCommit": {"oid": "103dd26258c4039123826cc5d730a449ea2a5d6d"}, "closed": true, "closedAt": "2020-10-20T12:12:10Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSfewBgH2gAyNTAzNDg5MDkyOjQ3OTQxODNiODQwNzFmODY3MjczZTk2NzM0OGU3ZjQ3YTc5MzA2MjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdUXguggFqTUxMjYyNzM4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4794183b84071f867273e967348e7f47a7930626", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4794183b84071f867273e967348e7f47a7930626", "committedDate": "2020-10-14T16:08:31Z", "message": "[ML] fix feature importance calculation for binary classification"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19875609d0fbb62a77016a0ace9441c22459aa12", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/19875609d0fbb62a77016a0ace9441c22459aa12", "committedDate": "2020-10-15T14:10:27Z", "message": "fixing boolean lable transformation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b15d05d129719d3db13083437a55fbe76122862e", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b15d05d129719d3db13083437a55fbe76122862e", "committedDate": "2020-10-15T14:45:42Z", "message": "fixing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NDY0NDMw", "url": "https://github.com/elastic/elasticsearch/pull/63688#pullrequestreview-509464430", "createdAt": "2020-10-15T14:49:41Z", "commit": {"oid": "b15d05d129719d3db13083437a55fbe76122862e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNDo0OTo0MVrOHiLtVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNDo0OTo0MVrOHiLtVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYwNTQ2MA==", "bodyText": "There is one place where this might cause a mistake.\nLets assume the class labels are something that are NOT true or false, taco and hamburger for classes 0 and 1 respectively\nIf the user SPECIFICALLY selects the boolean prediction value type on inference, it will flag as follows:\ntaco will be false (since it starts with t but is not the word true)\nhamburger will be true (since it doesn't start with t or f, we revert to the class number).\nTo me, this is acceptable, as the user would have to specify the boolean result type. Knowing their classes labels were NOT actually boolean :/.", "url": "https://github.com/elastic/elasticsearch/pull/63688#discussion_r505605460", "createdAt": "2020-10-15T14:49:41Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/PredictionFieldType.java", "diffHunk": "@@ -52,22 +52,25 @@ public Object transformPredictedValue(Double value, String stringRep) {\n             case STRING:\n                 return stringRep == null ? value.toString() : stringRep;\n             case BOOLEAN:\n-                if ((areClose(value, 1.0D) || areClose(value, 0.0D)) == false) {\n-                    throw new IllegalArgumentException(\n-                        \"Cannot transform numbers other than 0.0 or 1.0 to boolean. Provided number [\" + value + \"]\");\n+                if (isNumberQuickCheck(stringRep)) {\n+                    try {\n+                        // 1 is true, 0 is false\n+                        return Integer.parseInt(stringRep) == 1;\n+                    } catch (NumberFormatException nfe) {\n+                        // do nothing, allow fall through to final fromDouble\n+                    }\n+                } else if (isBoolQuickCheck(stringRep)) { // if we start with t/f case insensitive, it indicates boolean string", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b15d05d129719d3db13083437a55fbe76122862e"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a9fbdff03ae20d73ac7c084ac4f786d8f7acf7", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/26a9fbdff03ae20d73ac7c084ac4f786d8f7acf7", "committedDate": "2020-10-15T15:24:57Z", "message": "fixing tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTAzNjIy", "url": "https://github.com/elastic/elasticsearch/pull/63688#pullrequestreview-509503622", "createdAt": "2020-10-15T15:26:13Z", "commit": {"oid": "26a9fbdff03ae20d73ac7c084ac4f786d8f7acf7"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTEyNjI3Mzgx", "url": "https://github.com/elastic/elasticsearch/pull/63688#pullrequestreview-512627381", "createdAt": "2020-10-20T11:59:17Z", "commit": {"oid": "26a9fbdff03ae20d73ac7c084ac4f786d8f7acf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3949, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}