{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTc5NDMw", "number": 59099, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNDo0MFrOEL1CoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjo0OVrOEL1FQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM4ODE3OnYy", "diffSide": "LEFT", "path": "docs/reference/aggregations/bucket/adjacency-matrix-aggregation.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNDo0MFrOGtlo5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQxNDozNzozOVrOGvUI_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NTc4MA==", "bodyText": "I don't believe this setting exists any more.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450455780", "createdAt": "2020-07-06T20:14:40Z", "author": {"login": "nik9000"}, "path": "docs/reference/aggregations/bucket/adjacency-matrix-aggregation.asciidoc", "diffHunk": "@@ -110,5 +110,4 @@ where examining interactions _over time_ becomes important.\n ==== Limitations\n For N filters the matrix of buckets produced can be N\u00b2/2 which can be costly.\n The circuit breaker settings prevent results producing too many buckets and to avoid excessive disk seeks\n-the `indices.query.bool.max_clause_count` setting is used to limit the number of filters. \n-imposed of 100 filters . This setting can be changed using the `index.max_adjacency_matrix_filters` index-level setting.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MjI2NjIzNg==", "bodyText": "Apologies for the delay in replying. We used to have a dedicated max_adjacency_matrix_filters setting with a default of 100 but changed it to piggy-back off the indices.query.bool.max_clause_count setting because they address the same concern - too many query clauses. The second line, \"imposed of 100 filters ...\" looks like something that should have been deleted when we made that changeover.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r452266236", "createdAt": "2020-07-09T14:37:39Z", "author": {"login": "markharwood"}, "path": "docs/reference/aggregations/bucket/adjacency-matrix-aggregation.asciidoc", "diffHunk": "@@ -110,5 +110,4 @@ where examining interactions _over time_ becomes important.\n ==== Limitations\n For N filters the matrix of buckets produced can be N\u00b2/2 which can be costly.\n The circuit breaker settings prevent results producing too many buckets and to avoid excessive disk seeks\n-the `indices.query.bool.max_clause_count` setting is used to limit the number of filters. \n-imposed of 100 filters . This setting can be changed using the `index.max_adjacency_matrix_filters` index-level setting.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NTc4MA=="}, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM4ODc3OnYy", "diffSide": "LEFT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNDo1NFrOGtlpSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNDo1NFrOGtlpSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NTg4Mg==", "bodyText": "These are just a little more compact.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450455882", "createdAt": "2020-07-06T20:14:54Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM5MDQyOnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNToyMFrOGtlqKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNToyMFrOGtlqKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjEwNw==", "bodyText": "And this is just a little more readable than sticking it all on one line.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456107", "createdAt": "2020-07-06T20:15:20Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:\n-          index: test\n-          id: 1\n-          body: { \"num\": [1, 2] }\n+      bulk:\n+        index: test\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": \"1\"}}\n+          { \"num\": [1, 2] }\n+          { \"index\": {\"_id\": \"2\"}}\n+          { \"num\": [2, 3] }\n+          { \"index\": {\"_id\": \"3\"}}\n+          { \"num\": [3, 4] }\n \n   - do:\n-      index:\n-        index: test\n-        id: 2\n-        body: { \"num\": [2, 3] }\n+      indices.refresh: {}\n+---\n+\"Filters intersections\":\n \n   - do:\n-      index:\n+      search:\n         index: test\n-        id: 3\n-        body: { \"num\": [3, 4] }\n+        body:\n+          size: 0\n+          aggs:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM5MDcyOnYy", "diffSide": "RIGHT", "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNToyN1rOGtlqWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNToyN1rOGtlqWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjE1Mg==", "bodyText": "This is the new test.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456152", "createdAt": "2020-07-06T20:15:27Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:\n-          index: test\n-          id: 1\n-          body: { \"num\": [1, 2] }\n+      bulk:\n+        index: test\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": \"1\"}}\n+          { \"num\": [1, 2] }\n+          { \"index\": {\"_id\": \"2\"}}\n+          { \"num\": [2, 3] }\n+          { \"index\": {\"_id\": \"3\"}}\n+          { \"num\": [3, 4] }\n \n   - do:\n-      index:\n-        index: test\n-        id: 2\n-        body: { \"num\": [2, 3] }\n+      indices.refresh: {}\n+---\n+\"Filters intersections\":\n \n   - do:\n-      index:\n+      search:\n         index: test\n-        id: 3\n-        body: { \"num\": [3, 4] }\n+        body:\n+          size: 0\n+          aggs:\n+            conns:\n+              adjacency_matrix:\n+                filters:\n+                  1:\n+                    term:\n+                      num: 1\n+                  2:\n+                    term:\n+                      num: 2\n+                  4:\n+                    term:\n+                      num: 4\n \n-  - do:\n-      indices.refresh: {}\n+  - match: { hits.total.value: 3 }\n \n+  - length: { aggregations.conns.buckets: 4 }\n \n----\n-\"Filters intersections\":\n+  - match: { aggregations.conns.buckets.0.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.0.key: \"1\" }\n \n+  - match: { aggregations.conns.buckets.1.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.1.key: \"1&2\" }\n+\n+  - match: { aggregations.conns.buckets.2.doc_count: 2 }\n+  - match: { aggregations.conns.buckets.2.key: \"2\" }\n+\n+  - match: { aggregations.conns.buckets.3.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.3.key: \"4\" }\n+\n+\n+---\n+\"Terms lookup\":\n+  - do:\n+      bulk:\n+        index: lookup\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": 1} }\n+          { \"num\": [1] }\n+          { \"index\": {\"_id\": 2} }\n+          { \"num\": [2] }\n+          { \"index\": {\"_id\": 4} }\n+          { \"num\": [4] }\n   - do:\n       search:\n-        rest_total_hits_as_int: true\n-        body: { \"size\": 0, \"aggs\": { \"conns\": { \"adjacency_matrix\": {  \"filters\": { \"1\": { \"term\": { \"num\": 1 } }, \"2\": { \"term\": { \"num\": 2 } }, \"4\": { \"term\": { \"num\": 4 } } } } } } }\n+        index: test\n+        body:\n+          size: 0\n+          aggs:\n+            conns:\n+              adjacency_matrix:\n+                filters:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 94}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM5Mzk3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjozMVrOGtlsbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjozMVrOGtlsbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjY4NQ==", "bodyText": "I just bumped into this when I was looking at the agg.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456685", "createdAt": "2020-07-06T20:16:31Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregator.java", "diffHunk": "@@ -123,7 +123,7 @@ public boolean equals(Object obj) {\n     }\n \n     private final String[] keys;\n-    private Weight[] filters;\n+    private final Weight[] filters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwODM5NDg5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregatorFactory.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjo0OVrOGtltAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjo0OVrOGtltAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjgzNA==", "bodyText": "These were confusing because above they are referred to without this but below they had it.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456834", "createdAt": "2020-07-06T20:16:49Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregatorFactory.java", "diffHunk": "@@ -50,9 +50,9 @@ public AdjacencyMatrixAggregatorFactory(String name, List<KeyedFilter> filters,\n         keys = new String[filters.size()];\n         for (int i = 0; i < filters.size(); ++i) {\n             KeyedFilter keyedFilter = filters.get(i);\n-            this.keys[i] = keyedFilter.key();\n+            keys[i] = keyedFilter.key();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2103, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}