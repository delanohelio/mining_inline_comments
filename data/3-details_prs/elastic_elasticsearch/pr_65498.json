{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NDk3NTk4", "number": 65498, "title": "Log warn when license does not permit auditing", "bodyText": "Security auditing only works on license levels GOLD or higher.\nThe license level can dynamically change while the node is running.\nThis PR logs a WARN message when license does not permit auditing,\nbut the static settings xpack.security.enabled and xpack.security.audit.enabled\nare true. The log warn message is outputed at most every 30 mins.\nExample:\nxpack.security.enabled: true\nxpack.security.audit.enabled: true\n\n[2020-11-25T15:12:42,991][INFO ][o.e.x.s.s.SecurityStatusChangeListener] [ElasticMBP2] Active license is now [BASIC]; Security is enabled\n[2020-11-25T15:12:42,994][WARN ][o.e.x.s.a.AuditTrailService] [ElasticMBP2] Security auditing is DISABLED because the currently active license [BASIC] does not permit it", "createdAt": "2020-11-25T14:45:42Z", "url": "https://github.com/elastic/elasticsearch/pull/65498", "merged": true, "mergeCommit": {"oid": "5414ad02edc2a14472eb31918f092e01a41e4b3e"}, "closed": true, "closedAt": "2020-12-09T18:03:58Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdf_KBNgH2gAyNTI3NDk3NTk4OjQyNzc0ZDIzNGEzY2NjODBlYjcxMGM0ZDc3NTZlMzRkNjZmZWJiZGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkHIRogH2gAyNTI3NDk3NTk4OjBhNzFiMjdkYTlmMjcxMjdkN2JmNDRjZjIxMGY5YThlOWEwNWM5MmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "42774d234a3ccc80eb710c4d7756e34d66febbdc", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/42774d234a3ccc80eb710c4d7756e34d66febbdc", "committedDate": "2020-11-25T14:23:51Z", "message": "Log when license does not permit audits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61b6be987e7077e465245d3a3c17e6d5641c444", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/b61b6be987e7077e465245d3a3c17e6d5641c444", "committedDate": "2020-11-25T14:34:05Z", "message": "More complex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e7175f068e5a303b06eed9ee2e8478edbc1701b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e7175f068e5a303b06eed9ee2e8478edbc1701b", "committedDate": "2020-11-25T20:23:05Z", "message": "Split test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQwNTQyNDQy", "url": "https://github.com/elastic/elasticsearch/pull/65498#pullrequestreview-540542442", "createdAt": "2020-11-30T00:37:22Z", "commit": {"oid": "9e7175f068e5a303b06eed9ee2e8478edbc1701b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDozNzoyMlrOH7oteg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQwMDo1NDo1MVrOH7o4rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTAzNA==", "bodyText": "Technically, the license level check is just licenseState.checkFeature, so I'd prefer to have the logic as\nif (compositeAuditTrail.isEmpty() == false && licenseState.isSecurityEnabled()) {\n    if (licenseState.checkFeature(Feature.SECURITY_AUDITING)) {\n    }\n}\n\nwhich is more accurate to the warning message.", "url": "https://github.com/elastic/elasticsearch/pull/65498#discussion_r532295034", "createdAt": "2020-11-30T00:37:22Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/AuditTrailService.java", "diffHunk": "@@ -16,24 +18,40 @@\n import org.elasticsearch.xpack.security.transport.filter.SecurityIpFilterRule;\n \n import java.net.InetAddress;\n+import java.time.Duration;\n+import java.time.Instant;\n import java.util.Collections;\n import java.util.List;\n \n public class AuditTrailService {\n \n+    private static final Logger logger = LogManager.getLogger(AuditTrailService.class);\n+\n     private static final AuditTrail NOOP_AUDIT_TRAIL = new NoopAuditTrail();\n     private final CompositeAuditTrail compositeAuditTrail;\n     private final XPackLicenseState licenseState;\n+    private final Duration minLogPeriod = Duration.ofMinutes(30);\n+    // protected for tests\n+    protected Instant lastLogInstant = Instant.EPOCH;\n \n     public AuditTrailService(List<AuditTrail> auditTrails, XPackLicenseState licenseState) {\n         this.compositeAuditTrail = new CompositeAuditTrail(Collections.unmodifiableList(auditTrails));\n         this.licenseState = licenseState;\n     }\n \n     public AuditTrail get() {\n-        if (compositeAuditTrail.isEmpty() == false &&\n-            licenseState.isSecurityEnabled() && licenseState.checkFeature(Feature.SECURITY_AUDITING)) {\n-            return compositeAuditTrail;\n+        if (compositeAuditTrail.isEmpty() == false) {\n+            if (licenseState.isSecurityEnabled() && licenseState.checkFeature(Feature.SECURITY_AUDITING)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7175f068e5a303b06eed9ee2e8478edbc1701b"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NTg0NA==", "bodyText": "Without volatile means we could end up logging more frequently than every 30 mins from different threads. Do we care?", "url": "https://github.com/elastic/elasticsearch/pull/65498#discussion_r532295844", "createdAt": "2020-11-30T00:42:50Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/AuditTrailService.java", "diffHunk": "@@ -16,24 +18,40 @@\n import org.elasticsearch.xpack.security.transport.filter.SecurityIpFilterRule;\n \n import java.net.InetAddress;\n+import java.time.Duration;\n+import java.time.Instant;\n import java.util.Collections;\n import java.util.List;\n \n public class AuditTrailService {\n \n+    private static final Logger logger = LogManager.getLogger(AuditTrailService.class);\n+\n     private static final AuditTrail NOOP_AUDIT_TRAIL = new NoopAuditTrail();\n     private final CompositeAuditTrail compositeAuditTrail;\n     private final XPackLicenseState licenseState;\n+    private final Duration minLogPeriod = Duration.ofMinutes(30);\n+    // protected for tests\n+    protected Instant lastLogInstant = Instant.EPOCH;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7175f068e5a303b06eed9ee2e8478edbc1701b"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjI5NzkwMw==", "bodyText": "Nit: should it be Auditing logging ... instead of Security auditing ...? It is true that auditing events are all security related, also this is how the feature Enum is named. But the feature is documented and marketed as \"audit logging\", which seems to be a better end-user oriented term.", "url": "https://github.com/elastic/elasticsearch/pull/65498#discussion_r532297903", "createdAt": "2020-11-30T00:54:51Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/audit/AuditTrailService.java", "diffHunk": "@@ -16,24 +18,40 @@\n import org.elasticsearch.xpack.security.transport.filter.SecurityIpFilterRule;\n \n import java.net.InetAddress;\n+import java.time.Duration;\n+import java.time.Instant;\n import java.util.Collections;\n import java.util.List;\n \n public class AuditTrailService {\n \n+    private static final Logger logger = LogManager.getLogger(AuditTrailService.class);\n+\n     private static final AuditTrail NOOP_AUDIT_TRAIL = new NoopAuditTrail();\n     private final CompositeAuditTrail compositeAuditTrail;\n     private final XPackLicenseState licenseState;\n+    private final Duration minLogPeriod = Duration.ofMinutes(30);\n+    // protected for tests\n+    protected Instant lastLogInstant = Instant.EPOCH;\n \n     public AuditTrailService(List<AuditTrail> auditTrails, XPackLicenseState licenseState) {\n         this.compositeAuditTrail = new CompositeAuditTrail(Collections.unmodifiableList(auditTrails));\n         this.licenseState = licenseState;\n     }\n \n     public AuditTrail get() {\n-        if (compositeAuditTrail.isEmpty() == false &&\n-            licenseState.isSecurityEnabled() && licenseState.checkFeature(Feature.SECURITY_AUDITING)) {\n-            return compositeAuditTrail;\n+        if (compositeAuditTrail.isEmpty() == false) {\n+            if (licenseState.isSecurityEnabled() && licenseState.checkFeature(Feature.SECURITY_AUDITING)) {\n+                return compositeAuditTrail;\n+            } else {\n+                Instant nowInstant = Instant.now();\n+                if (lastLogInstant.plus(minLogPeriod).isBefore(nowInstant)) {\n+                    lastLogInstant = nowInstant;\n+                    logger.warn(\"Security auditing is DISABLED because the currently active license [\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e7175f068e5a303b06eed9ee2e8478edbc1701b"}, "originalPosition": 45}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1aa3c134260a8219ba839dfcfb8176da5c98e530", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/1aa3c134260a8219ba839dfcfb8176da5c98e530", "committedDate": "2020-12-07T15:11:29Z", "message": "Merge branch 'master' into log_when_auditing_non_compliant"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39f7e9f00aed70939eedb3c21fd73034b7b18ec5", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/39f7e9f00aed70939eedb3c21fd73034b7b18ec5", "committedDate": "2020-12-07T18:10:38Z", "message": "Review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2NzQwMjE4", "url": "https://github.com/elastic/elasticsearch/pull/65498#pullrequestreview-546740218", "createdAt": "2020-12-08T04:40:10Z", "commit": {"oid": "39f7e9f00aed70939eedb3c21fd73034b7b18ec5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a71b27da9f27127d7bf44cf210f9a8e9a05c92c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a71b27da9f27127d7bf44cf210f9a8e9a05c92c", "committedDate": "2020-12-08T09:56:53Z", "message": "Merge branch 'master' into log_when_auditing_non_compliant"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4268, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}