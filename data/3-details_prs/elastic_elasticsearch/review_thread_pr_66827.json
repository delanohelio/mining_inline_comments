{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ1ODMzMzE4", "number": 66827, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozNToxNlrOFO9nOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQwMDoyNjo0M1rOFmPbpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjMzODQ5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozNToxNlrOIUB0SQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozNToxNlrOIUB0SQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg3MjIwMQ==", "bodyText": "I am not aware of anything that would replace this string with an autodetected version number.\nI think you'll need to use Version.CURRENT.major + \".\" + Version.CURRENT.minor", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r557872201", "createdAt": "2021-01-15T05:35:16Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -89,6 +95,11 @@ public void handleRequest(RestRequest request, RestChannel channel, NodeClient c\n                         e -> handleException(\"Secondary authentication\", request, channel, e)));\n                 }, e -> handleException(\"Authentication\", request, channel, e)));\n         } else {\n+            if (request.getHeaders() != null && request.getHeaders().containsKey(\"Authorization\")) {\n+                HeaderWarning.addWarning(\"Elasticsearch security features are not enabled, anyone can access your cluster without \" +\n+                    \"authentication. Read https://www.elastic.co/guide/en/elasticsearch/reference/<autodetected version number>/\" +\n+                    \"get-started-enable-security.html for more information.\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6b9626c4d6acdf8e7e43f1ab7afbffd63fd4af"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjM0NjA4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/qa/basic-enable-security/src/javaRestTest/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozOToxMFrOIUB4aw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozOToxMFrOIUB4aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg3MzI1OQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertThat (warningHeaders.isEmpty(), equalTo(true));\n          \n          \n            \n                        assertThat(warningHeaders, Matchers.empty());\n          \n      \n    \n    \n  \n\nUsing the more explicit matchers means we get more meaningful error messages when they fail.\nInstead of a simple\n\nexpected true but was false\n\n(which tells us almost nothing), we'd get\n\nExpected: an empty collection\nbut: <[foo]>", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r557873259", "createdAt": "2021-01-15T05:39:10Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/qa/basic-enable-security/src/javaRestTest/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -85,6 +97,21 @@ public void testSecuritySetup() throws Exception {\n         }\n     }\n \n+    public void testSecurityDisabledWarning() throws Exception {\n+        final Request request = new Request(\"GET\", \"/_cat/indices\");\n+        Response response = client().performRequest(request);\n+        List<String> warningHeaders = response.getWarnings();\n+        if (securityEnabled) {\n+            assertThat (warningHeaders.isEmpty(), equalTo(true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6b9626c4d6acdf8e7e43f1ab7afbffd63fd4af"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzUxMjM0NzM5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/qa/basic-enable-security/src/javaRestTest/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozOTo1OVrOIUB5JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMS0xNVQwNTozOTo1OVrOIUB5JA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1Nzg3MzQ0NA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        assertThat (warningHeaders.size(), equalTo(1));\n          \n          \n            \n                        assertThat(warningHeaders, hasSize(1));", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r557873444", "createdAt": "2021-01-15T05:39:59Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/qa/basic-enable-security/src/javaRestTest/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -85,6 +97,21 @@ public void testSecuritySetup() throws Exception {\n         }\n     }\n \n+    public void testSecurityDisabledWarning() throws Exception {\n+        final Request request = new Request(\"GET\", \"/_cat/indices\");\n+        Response response = client().performRequest(request);\n+        List<String> warningHeaders = response.getWarnings();\n+        if (securityEnabled) {\n+            assertThat (warningHeaders.isEmpty(), equalTo(true));\n+        } else {\n+            assertThat (warningHeaders.size(), equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bc6b9626c4d6acdf8e7e43f1ab7afbffd63fd4af"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc1MTM5NTM1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQwMjowNjoxOFrOI2fSOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNVQwMjowNjoxOFrOI2fSOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDAwNjU4NQ==", "bodyText": "I am concerned that the message is exclusively about \"third party security\" when it's only detecting a rest wrapper.\nI think we need to be more clear than that. Anyone who is using the plugin API to install a rest wrapper is going to be affected, and we need to be clear about that.\nI would propose a message like:\n\nThe {plugin-name} plugin installs a custom REST wrapper. This functionality is deprecated and will not be possible in Elasticsearch 8.0. If this plugin is intended to provide security features for Elasticsearch then you should switch to using the built-in Elasticsearch features instead.", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r594006585", "createdAt": "2021-03-15T02:06:18Z", "author": {"login": "tvernum"}, "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -436,6 +440,13 @@ public ActionModule(Settings settings, IndexNameExpressionResolver indexNameExpr\n                     throw new IllegalArgumentException(\"Cannot have more than one plugin implementing a REST wrapper\");\n                 }\n                 restWrapper = newRestWrapper;\n+                if (restWrapper.getClass().getCanonicalName() == null ||\n+                    restWrapper.getClass().getCanonicalName().startsWith(\"org.elasticsearch\") == false) {\n+                    deprecationLogger.deprecate(DeprecationCategory.SECURITY, \"3rd_party_sec_deprecation\", \"Use of third-party \" +\n+                        \"security plugins is deprecated and will not be possible in 8.0. You can use built-in Elasticsearch features \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e282484483daee49d84974edcbf1b91f0ec97d4"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc1NjQyNzg5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQwMDoyNTozMlrOI3OaPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQwMDoyNTozMlrOI3OaPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDc3ODY4Ng==", "bodyText": "I think DeprecationCategory.PLUGINS is more appropriate than DeprecationCategory.SECURITY, since as Tim pointed out, this isn't a security feature directly.", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r594778686", "createdAt": "2021-03-16T00:25:32Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -436,6 +440,15 @@ public ActionModule(Settings settings, IndexNameExpressionResolver indexNameExpr\n                     throw new IllegalArgumentException(\"Cannot have more than one plugin implementing a REST wrapper\");\n                 }\n                 restWrapper = newRestWrapper;\n+                if (restWrapper.getClass().getCanonicalName() == null ||\n+                    restWrapper.getClass().getCanonicalName().startsWith(\"org.elasticsearch\") == false) {\n+                    deprecationLogger.deprecate(DeprecationCategory.SECURITY, \"3rd_party_rest_deprecation\", \"The \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e488d11ebe5e7f37b4ded27dd98e09192f2479ab"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzc1NjQzMDQ1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQwMDoyNjo0M1rOI3Obvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMS0wMy0xNlQwMDoyNjo0M1rOI3Obvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU5NDc3OTA3MQ==", "bodyText": "We have avoided putting URLs in deprecation messages as they break too easily. In fact, I cannot find any other occurrence of one. Can we remove this?", "url": "https://github.com/elastic/elasticsearch/pull/66827#discussion_r594779071", "createdAt": "2021-03-16T00:26:43Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/action/ActionModule.java", "diffHunk": "@@ -436,6 +440,15 @@ public ActionModule(Settings settings, IndexNameExpressionResolver indexNameExpr\n                     throw new IllegalArgumentException(\"Cannot have more than one plugin implementing a REST wrapper\");\n                 }\n                 restWrapper = newRestWrapper;\n+                if (restWrapper.getClass().getCanonicalName() == null ||\n+                    restWrapper.getClass().getCanonicalName().startsWith(\"org.elasticsearch\") == false) {\n+                    deprecationLogger.deprecate(DeprecationCategory.SECURITY, \"3rd_party_rest_deprecation\", \"The \" +\n+                        plugin.getClass().getName() + \"plugin installs a custom REST wrapper. This functionality is deprecated and will \" +\n+                        \"not be possible in Elasticsearch 8.0. If this plugin is intended to provide security features for Elasticsearch \" +\n+                        \"then you should switch to using the built-in Elasticsearch features instead. \" +\n+                        \"Read https://www.elastic.co/guide/en/elasticsearch/reference/\" + Version.CURRENT.major + \".\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e488d11ebe5e7f37b4ded27dd98e09192f2479ab"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4372, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}