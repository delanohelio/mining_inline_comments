{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjk0MDc0", "number": 65778, "title": "Make it possible to use Stack logging in Docker", "bodyText": "Closes #62758.\nInclude the Stack log4j config in the Docker image, in order to make it\npossible to write logs in a container environment in the same way as for\nan archive or package deployment. This is useful in situations where the\nuser is bind-mounting the logs directory and has their own arrangements\nfor log shipping.\nTo use stack logging, set the environment variable ES_LOG_STYLE to\nfile. It can also be set to console, which is the same as not\nspecifying it at all.\nThe Docker logging config is now auto-generated at image build time, by\nrunning the default config through a transformer program when preparing\nthe distribution in an image builder step.\nImplementation notes:\n\nRegarding the docker config change -  The major constraint on the implementation here is the need to publish reproducible build files to Docker hub. It means that all you have to work with is the archive distro of ES and whatever you put in the build context. For that reason I opted for an executable jar, since the v8.0 image has almost nothing useful in it otherwise. Same thing goes for Iron Bank - they build the images, not us.\nIn the docker distribution build.gradle, I changed a helper closure into a class with a static method in order to work around an issue where the Docker image was always being rebuilt, even when there were no changes.", "createdAt": "2020-12-02T21:15:47Z", "url": "https://github.com/elastic/elasticsearch/pull/65778", "merged": true, "mergeCommit": {"oid": "68b546557544ff671ab0ed005318fc60fa3165bd"}, "closed": true, "closedAt": "2020-12-10T12:25:48Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiU-cZAH2gAyNTMxMjk0MDc0OmYwYjEyNDNkOWY1OTJhOWNkMWE2NDYxYzVjOTNmZGMwZmU2ZjdmNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdkxl8TAH2gAyNTMxMjk0MDc0OjRkMTIwZjMxM2I3ZWJlMzg3YzE4ZDU4NzBjYjJiYzc3N2FlNzEwZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f0b1243d9f592a9cd1a6461c5c93fdc0fe6f7f42", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0b1243d9f592a9cd1a6461c5c93fdc0fe6f7f42", "committedDate": "2020-12-02T20:56:58Z", "message": "Make it possible to use Stack logging in Docker\n\nCloses #62758.\n\nInclude the Stack log4j config in the Docker image, in order to make it\npossible to write logs in a container environment in the same way as for\nan archive or package deployment. This is useful in situations where the\nuser is bind-mounting the logs directory and has their own arrangements\nfor log shipping."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a978be7a589bef7c98c7a77c681c7177dd18aafc", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/a978be7a589bef7c98c7a77c681c7177dd18aafc", "committedDate": "2020-12-02T21:12:05Z", "message": "Add a note about the ES_LOG_STYLE env var"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjk3OTgx", "url": "https://github.com/elastic/elasticsearch/pull/65778#pullrequestreview-543297981", "createdAt": "2020-12-02T22:40:46Z", "commit": {"oid": "a978be7a589bef7c98c7a77c681c7177dd18aafc"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjo0MDo0N1rOH9xKvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjo0MDo0N1rOH9xKvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUzMDc0OQ==", "bodyText": "I'm not in love with this name. It doesn't really mean anything from a user perspective. I'd be more inclined to call this file or disk.", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r534530749", "createdAt": "2020-12-02T22:40:47Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/src/docker/bin/docker-entrypoint.sh", "diffHunk": "@@ -57,6 +57,21 @@ if [[ -f bin/elasticsearch-users ]]; then\n   fi\n fi\n \n+if [[ -n \"$ES_LOG_STYLE\" ]]; then\n+  case \"$ES_LOG_STYLE\" in\n+    docker)\n+      # This is the default. Nothing to do.\n+      ;;\n+    stack)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a978be7a589bef7c98c7a77c681c7177dd18aafc"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjk5NzIx", "url": "https://github.com/elastic/elasticsearch/pull/65778#pullrequestreview-543299721", "createdAt": "2020-12-02T22:43:57Z", "commit": {"oid": "a978be7a589bef7c98c7a77c681c7177dd18aafc"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74ab2749984e497f269a7fcbbb37c5096d59af4f", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/74ab2749984e497f269a7fcbbb37c5096d59af4f", "committedDate": "2020-12-03T12:01:51Z", "message": "Generate a Docker log4j config from the default config\n\nRather than maintaining a separate log4j config specifically for\nDocker, we can generate a config by processing the ES distribtution's\ndefault configuration so that everything is emitted to the console."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580bc0b656b32bee74dc9f0b07e9edacdf3aafe3", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/580bc0b656b32bee74dc9f0b07e9edacdf3aafe3", "committedDate": "2020-12-03T12:21:40Z", "message": "Strip out a redundant precommit check"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "288ac14108e678d4f0cb07de81b89a8d25cdab3c", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/288ac14108e678d4f0cb07de81b89a8d25cdab3c", "committedDate": "2020-12-03T14:55:19Z", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "044929f650dcad5ec3f3ad1197add2ea3a06e898", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/044929f650dcad5ec3f3ad1197add2ea3a06e898", "committedDate": "2020-12-03T15:35:01Z", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25207199706e39ac90e946774469e0982e104760", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/25207199706e39ac90e946774469e0982e104760", "committedDate": "2020-12-04T19:45:06Z", "message": "Convert jshell script to Java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f31d88492bb584cc215bca645c803db2198cfb1", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f31d88492bb584cc215bca645c803db2198cfb1", "committedDate": "2020-12-07T15:44:39Z", "message": "Add unit tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2e9b4761591178ab004de35d8fbf39a922c5c89", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/e2e9b4761591178ab004de35d8fbf39a922c5c89", "committedDate": "2020-12-07T15:44:58Z", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab7385049f0358daffb68304f1447ce04e0aa6c2", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab7385049f0358daffb68304f1447ce04e0aa6c2", "committedDate": "2020-12-08T13:29:29Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "96536fd6c59412c22de981948142762ae735543c", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/96536fd6c59412c22de981948142762ae735543c", "committedDate": "2020-12-09T15:25:44Z", "message": "Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1bb2427fb5a6bd62c7f0cde11ab486682e5e18d", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1bb2427fb5a6bd62c7f0cde11ab486682e5e18d", "committedDate": "2020-12-09T15:38:37Z", "message": "Tidy up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/6cff1aaf6b8bebe321014bff1d7551ad8ff0a373", "committedDate": "2020-12-09T15:59:14Z", "message": "More fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4NDA3OTI4", "url": "https://github.com/elastic/elasticsearch/pull/65778#pullrequestreview-548407928", "createdAt": "2020-12-09T17:10:50Z", "commit": {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNzoxMDo1MFrOICfzkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxNzoxMjozNlrOICf49w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ4OTE2OA==", "bodyText": "Can you elaborate what can't be cached here?", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539489168", "createdAt": "2020-12-09T17:10:50Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -21,13 +21,33 @@ configurations {\n   dockerSource\n   aarch64OssDockerSource\n   ossDockerSource\n+  transformLog4jJar\n }\n \n dependencies {\n   aarch64DockerSource project(path: \":distribution:archives:linux-aarch64-tar\", configuration:\"default\")\n   dockerSource project(path: \":distribution:archives:linux-tar\", configuration:\"default\")\n   aarch64OssDockerSource project(path: \":distribution:archives:oss-linux-aarch64-tar\", configuration:\"default\")\n   ossDockerSource project(path: \":distribution:archives:oss-linux-tar\", configuration:\"default\")\n+  transformLog4jJar project(path: \":distribution:docker:transform-log4j-config\", configuration: \"default\")\n+}\n+\n+/**\n+ * Used in the Dockerfile template to wrap commands in a retry loop. It can't be\n+ * a closure because Gradle can't effectively cache those.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MDE0NA==", "bodyText": "In general I'm in favour to have class definitions living in buildSrc somewhere no matter how small they are. To keep our build scripts a bit cleaner and smaller. Also these classes should change less often than the script itself.", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539490144", "createdAt": "2020-12-09T17:12:07Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -21,13 +21,33 @@ configurations {\n   dockerSource\n   aarch64OssDockerSource\n   ossDockerSource\n+  transformLog4jJar\n }\n \n dependencies {\n   aarch64DockerSource project(path: \":distribution:archives:linux-aarch64-tar\", configuration:\"default\")\n   dockerSource project(path: \":distribution:archives:linux-tar\", configuration:\"default\")\n   aarch64OssDockerSource project(path: \":distribution:archives:oss-linux-aarch64-tar\", configuration:\"default\")\n   ossDockerSource project(path: \":distribution:archives:oss-linux-tar\", configuration:\"default\")\n+  transformLog4jJar project(path: \":distribution:docker:transform-log4j-config\", configuration: \"default\")\n+}\n+\n+/**\n+ * Used in the Dockerfile template to wrap commands in a retry loop. It can't be\n+ * a closure because Gradle can't effectively cache those.\n+ */\n+class Retry {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTQ5MDU1MQ==", "bodyText": "I think the , is too much here", "url": "https://github.com/elastic/elasticsearch/pull/65778#discussion_r539490551", "createdAt": "2020-12-09T17:12:36Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -100,7 +108,7 @@ ${indent}${exitKeyword} \\$exit_code\"\"\"\n     'docker_base'         : base.name().toLowerCase(),\n     'version'             : VersionProperties.elasticsearch,\n     'major_minor_version' : \"${major}.${minor}\",\n-    'retry_loop'          : retry_loop\n+    'retry'               : Retry,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6cff1aaf6b8bebe321014bff1d7551ad8ff0a373"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bfc4748902f9151d02e27bc44485b72e36558226", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/bfc4748902f9151d02e27bc44485b72e36558226", "committedDate": "2020-12-09T21:08:43Z", "message": "Move shell retry class to buildSrc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9c420a588e6b8c8e4bcab16eb19f29b7f69681e", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9c420a588e6b8c8e4bcab16eb19f29b7f69681e", "committedDate": "2020-12-09T21:09:08Z", "message": "Merge remote-tracking branch 'upstream/master' into 62758-docker-stack-logging"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "199a550e8642bf48d668185229c69588d79a2950", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/199a550e8642bf48d668185229c69588d79a2950", "committedDate": "2020-12-09T21:20:50Z", "message": "I hate you, Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d120f313b7ebe387c18d5870cb2bc777ae710d5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d120f313b7ebe387c18d5870cb2bc777ae710d5", "committedDate": "2020-12-10T11:25:18Z", "message": "Merge branch 'master' into 62758-docker-stack-logging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4122, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}