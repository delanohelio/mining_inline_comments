{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTQ3Mzg3", "number": 60838, "title": "Disable sort optimization on search collapsing", "bodyText": "Collapse search queries that sort by a field can throw an ArrayStoreException due to a bug in the sort optimization introduced in 7.7.0.\nSearch collapsing were not supposed to be eligible for this sort optimization so this change explicitly filters them from this new feature.", "createdAt": "2020-08-06T16:55:43Z", "url": "https://github.com/elastic/elasticsearch/pull/60838", "merged": true, "mergeCommit": {"oid": "d86243f1d47b861a6852de7986d10119f70afb26"}, "closed": true, "closedAt": "2020-08-06T19:36:24Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8Sx1sAH2gAyNDY0MTQ3Mzg3OjA1NTVjM2Q5YTRkZWM5MDFiNTdmYzVhMjJiODYwNzdlZjQ1OTgyOTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc8UuPmgFqTQ2MjgwMjI1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0555c3d9a4dec901b57fc5a22b86077ef4598294", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/0555c3d9a4dec901b57fc5a22b86077ef4598294", "committedDate": "2020-08-06T16:54:16Z", "message": "Disable sort optimization on search collapsing\n\nCollapse search queries that sort by a field can throw\nan ArrayStoreException due to a bug in the [sort optimization](https://github.com/elastic/elasticsearch/pull/51852)\nintroduced in 7.7.0. Search collapsing were not supposed to\nbe eligible for this sort optimization so this change explicitly\nfilters them from this new feature."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzI5MTA2", "url": "https://github.com/elastic/elasticsearch/pull/60838#pullrequestreview-462729106", "createdAt": "2020-08-06T17:25:49Z", "commit": {"oid": "0555c3d9a4dec901b57fc5a22b86077ef4598294"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzoyNTo0OVrOG89O4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzoyNTo0OVrOG89O4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU3MDk3Nw==", "bodyText": "should it be equals instead, such as queryResult.topDocs().topDocs.getClass().equals(TopFieldDocs.class)) ?", "url": "https://github.com/elastic/elasticsearch/pull/60838#discussion_r466570977", "createdAt": "2020-08-06T17:25:49Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncAction.java", "diffHunk": "@@ -93,7 +93,8 @@ protected void onShardResult(SearchPhaseResult result, SearchShardIterator shard\n         if (queryResult.isNull() == false\n                 // disable sort optims for scroll requests because they keep track of the last bottom doc locally (per shard)\n                 && getRequest().scroll() == null\n-                && queryResult.topDocs().topDocs instanceof TopFieldDocs) {\n+                && queryResult.topDocs() != null\n+                && queryResult.topDocs().topDocs.getClass() == TopFieldDocs.class) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0555c3d9a4dec901b57fc5a22b86077ef4598294"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNzM3NDMy", "url": "https://github.com/elastic/elasticsearch/pull/60838#pullrequestreview-462737432", "createdAt": "2020-08-06T17:37:07Z", "commit": {"oid": "0555c3d9a4dec901b57fc5a22b86077ef4598294"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzozNzowN1rOG89oMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNzozNzowN1rOG89oMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjU3NzQ1OQ==", "bodyText": "Are we repeating these 2 lines here?", "url": "https://github.com/elastic/elasticsearch/pull/60838#discussion_r466577459", "createdAt": "2020-08-06T17:37:07Z", "author": {"login": "mayya-sharipova"}, "path": "server/src/test/java/org/elasticsearch/action/search/SearchQueryThenFetchAsyncActionTests.java", "diffHunk": "@@ -163,6 +188,8 @@ public void run() {\n         }\n         assertThat(phase.sortedTopDocs.scoreDocs.length, equalTo(1));\n         assertThat(phase.sortedTopDocs.scoreDocs[0], instanceOf(FieldDoc.class));\n+        assertThat(phase.sortedTopDocs.scoreDocs.length, equalTo(1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0555c3d9a4dec901b57fc5a22b86077ef4598294"}, "originalPosition": 96}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bef0730e7c6e97e66bfd7bdc5d9c9d285ee6e9db", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/bef0730e7c6e97e66bfd7bdc5d9c9d285ee6e9db", "committedDate": "2020-08-06T18:14:21Z", "message": "remove leftover"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyODAyMjUx", "url": "https://github.com/elastic/elasticsearch/pull/60838#pullrequestreview-462802251", "createdAt": "2020-08-06T19:10:09Z", "commit": {"oid": "bef0730e7c6e97e66bfd7bdc5d9c9d285ee6e9db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3446, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}