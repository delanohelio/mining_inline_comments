{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NzkxNjQ2", "number": 60029, "title": "Standardize script field's rejection error", "bodyText": "This standardizes the exception type thrown when attempting to build a\nquery on a script field that it doesn't support. It also replaces the\nfield type [script] in the error message with whatever the runtime type\nis.", "createdAt": "2020-07-21T23:10:02Z", "url": "https://github.com/elastic/elasticsearch/pull/60029", "merged": true, "mergeCommit": {"oid": "9a3fa4218984df30ff55f6272558aa811fceefae"}, "closed": true, "closedAt": "2020-07-22T18:44:25Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3Oh6pAH2gAyNDU0NzkxNjQ2OjQxMjYzNTU2YWM0OTEzMjI2MDhmYWYyNTc4Y2YxYjc4MzQ5MzViMzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3fLxfAFqTQ1MzU3OTg4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "41263556ac491322608faf2578cf1b7834935b34", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/41263556ac491322608faf2578cf1b7834935b34", "committedDate": "2020-07-21T23:07:38Z", "message": "Standardize script field's rejection error\n\nThis standardizes the exception type thrown when attempting to build a\nquery on a script field that it doesn't support. It also replaces the\nfield type `[script]` in the error message with whatever the runtime type\nis."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzMTUwMTUw", "url": "https://github.com/elastic/elasticsearch/pull/60029#pullrequestreview-453150150", "createdAt": "2020-07-22T09:29:57Z", "commit": {"oid": "41263556ac491322608faf2578cf1b7834935b34"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOToyOTo1N1rOG1ae1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQwOToyOTo1N1rOG1ae1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODY2MTU5MA==", "bodyText": "To be more accurate, the field is of type script and its runtime_type is keyword, long etc. Can we expand and say it is a script field with runtime_type etc. ?", "url": "https://github.com/elastic/elasticsearch/pull/60029#discussion_r458661590", "createdAt": "2020-07-22T09:29:57Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -49,6 +60,90 @@ public final boolean isAggregatable() {\n         return true;\n     }\n \n+    public abstract Query termsQuery(List<?> values, QueryShardContext context);\n+\n+    public abstract Query rangeQuery(\n+        Object lowerTerm,\n+        Object upperTerm,\n+        boolean includeLower,\n+        boolean includeUpper,\n+        ShapeRelation relation,\n+        ZoneId timeZone,\n+        DateMathParser parser,\n+        QueryShardContext context\n+    );\n+\n+    public Query fuzzyQuery(\n+        Object value,\n+        Fuzziness fuzziness,\n+        int prefixLength,\n+        int maxExpansions,\n+        boolean transpositions,\n+        QueryShardContext context\n+    ) {\n+        throw new IllegalArgumentException(\n+            \"Can only use fuzzy queries on keyword and text fields - not on [\" + name() + \"] which is of type [\" + runtimeType() + \"]\"\n+        );\n+    }\n+\n+    public Query prefixQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n+        throw new IllegalArgumentException(\n+            \"Can only use prefix queries on keyword, text and wildcard fields - not on [\"\n+                + name()\n+                + \"] which is of type [\"\n+                + runtimeType()\n+                + \"]\"\n+        );\n+    }\n+\n+    public Query wildcardQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n+        throw new IllegalArgumentException(\n+            \"Can only use wildcard queries on keyword, text and wildcard fields - not on [\"\n+                + name()\n+                + \"] which is of type [\"\n+                + runtimeType()\n+                + \"]\"\n+        );\n+    }\n+\n+    public Query regexpQuery(\n+        String value,\n+        int flags,\n+        int maxDeterminizedStates,\n+        MultiTermQuery.RewriteMethod method,\n+        QueryShardContext context\n+    ) {\n+        throw new IllegalArgumentException(\n+            \"Can only use regexp queries on keyword and text fields - not on [\" + name() + \"] which is of type [\" + runtimeType() + \"]\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41263556ac491322608faf2578cf1b7834935b34"}, "originalPosition": 82}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "098f6ddb9e24a163636e74d5e4f22be3cd5469f6", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/098f6ddb9e24a163636e74d5e4f22be3cd5469f6", "committedDate": "2020-07-22T17:59:37Z", "message": "Merge branch 'feature/runtime_fields' into script_field_consistent_rejection"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "628163c7575d9d42b07477e5c9eef3ca3b2790c0", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/628163c7575d9d42b07477e5c9eef3ca3b2790c0", "committedDate": "2020-07-22T18:12:59Z", "message": "Update error messages"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTc5NDg0", "url": "https://github.com/elastic/elasticsearch/pull/60029#pullrequestreview-453579484", "createdAt": "2020-07-22T18:31:18Z", "commit": {"oid": "628163c7575d9d42b07477e5c9eef3ca3b2790c0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODozMToxOFrOG1vEpQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMlQxODozMToxOFrOG1vEpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODk5ODk0OQ==", "bodyText": "don't hardcode script :) we are going to rename it and if you use the existing constant renaming will be easier", "url": "https://github.com/elastic/elasticsearch/pull/60029#discussion_r458998949", "createdAt": "2020-07-22T18:31:18Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptMappedFieldType.java", "diffHunk": "@@ -49,6 +60,71 @@ public final boolean isAggregatable() {\n         return true;\n     }\n \n+    public abstract Query termsQuery(List<?> values, QueryShardContext context);\n+\n+    public abstract Query rangeQuery(\n+        Object lowerTerm,\n+        Object upperTerm,\n+        boolean includeLower,\n+        boolean includeUpper,\n+        ShapeRelation relation,\n+        ZoneId timeZone,\n+        DateMathParser parser,\n+        QueryShardContext context\n+    );\n+\n+    public Query fuzzyQuery(\n+        Object value,\n+        Fuzziness fuzziness,\n+        int prefixLength,\n+        int maxExpansions,\n+        boolean transpositions,\n+        QueryShardContext context\n+    ) {\n+        throw new IllegalArgumentException(unsupported(\"fuzzy\", \"keyword and text\"));\n+    }\n+\n+    public Query prefixQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n+        throw new IllegalArgumentException(unsupported(\"prefix\", \"keyword, text and wildcard\"));\n+    }\n+\n+    public Query wildcardQuery(String value, MultiTermQuery.RewriteMethod method, QueryShardContext context) {\n+        throw new IllegalArgumentException(unsupported(\"wildcard\", \"keyword, text and wildcard\"));\n+    }\n+\n+    public Query regexpQuery(\n+        String value,\n+        int flags,\n+        int maxDeterminizedStates,\n+        MultiTermQuery.RewriteMethod method,\n+        QueryShardContext context\n+    ) {\n+        throw new IllegalArgumentException(unsupported(\"regexp\", \"keyword and text\"));\n+    }\n+\n+    public abstract Query existsQuery(QueryShardContext context);\n+\n+    public Query phraseQuery(TokenStream stream, int slop, boolean enablePositionIncrements) throws IOException {\n+        throw new IllegalArgumentException(unsupported(\"phrase\", \"text\"));\n+    }\n+\n+    public Query multiPhraseQuery(TokenStream stream, int slop, boolean enablePositionIncrements) throws IOException {\n+        throw new IllegalArgumentException(unsupported(\"phrase\", \"text\"));\n+    }\n+\n+    public Query phrasePrefixQuery(TokenStream stream, int slop, int maxExpansions) throws IOException {\n+        throw new IllegalArgumentException(unsupported(\"phrase prefix\", \"text\"));\n+    }\n+\n+    public SpanQuery spanPrefixQuery(String value, SpanMultiTermQueryWrapper.SpanRewriteMethod method, QueryShardContext context) {\n+        throw new IllegalArgumentException(unsupported(\"span prefix\", \"text\"));\n+    }\n+\n+    private String unsupported(String query, String supported) {\n+        String thisField = \"[\" + name() + \"] which is of type [script] with runtime_type [\" + runtimeType() + \"]\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "628163c7575d9d42b07477e5c9eef3ca3b2790c0"}, "originalPosition": 89}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNTc5ODgx", "url": "https://github.com/elastic/elasticsearch/pull/60029#pullrequestreview-453579881", "createdAt": "2020-07-22T18:31:50Z", "commit": {"oid": "628163c7575d9d42b07477e5c9eef3ca3b2790c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4818, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}