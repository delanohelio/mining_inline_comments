{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MjcwMzAz", "number": 58503, "title": "Index name expression resolver bwc layer for date parsing", "bodyText": "backports #34507\ncloses #58481\nalso closes general parsing issue (no date processors) #58602", "createdAt": "2020-06-24T15:05:59Z", "url": "https://github.com/elastic/elasticsearch/pull/58503", "merged": true, "mergeCommit": {"oid": "e49df55868f2ae0d4c0b6e738c3d801fc036cefc"}, "closed": true, "closedAt": "2020-07-02T20:06:16Z", "author": {"login": "pgomulka"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuaihLAH2gAyNDM5MjcwMzAzOmQyYTFhZmY1MTI5NDA2ZmVmZjQ3MWVhZmQ3YzMwZTQ5Njg4MDZlYWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcxEiBQgFqTQ0MTk4NjU1Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2a1aff5129406feff471eafd7c30e4968806eae", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2a1aff5129406feff471eafd7c30e4968806eae", "committedDate": "2020-06-24T14:01:50Z", "message": "backport index name resolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1eb41c831d67baf450c6f54038eee4429340f9ba", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/1eb41c831d67baf450c6f54038eee4429340f9ba", "committedDate": "2020-06-24T15:03:43Z", "message": "fix geting local date from week based date"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d12a2097b0085c43ba1d48d2094ab7ef5666e7ea", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d12a2097b0085c43ba1d48d2094ab7ef5666e7ea", "committedDate": "2020-06-25T06:36:48Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "662d3ac59e44a585e0754606efc48de00063a6e7", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/662d3ac59e44a585e0754606efc48de00063a6e7", "committedDate": "2020-06-25T07:18:35Z", "message": "Revert \"GlobalBuildInfo support packed-refs with work-tree (#50791)\"\n\nThis reverts commit 7bebc65cb2b398c87f4df3d61de50d98ec712916."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eccb89d4e385ac9150fe6f647cf2ada4d5ed9614", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/eccb89d4e385ac9150fe6f647cf2ada4d5ed9614", "committedDate": "2020-06-25T07:42:20Z", "message": "fix millis parsing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9febfc88a5f33620e85c549145749f5568c53e68", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/9febfc88a5f33620e85c549145749f5568c53e68", "committedDate": "2020-06-25T08:44:09Z", "message": "Revert \"Revert \"GlobalBuildInfo support packed-refs with work-tree (#50791)\"\"\n\nThis reverts commit 662d3ac5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73b9e08db9a3e9d6e4e757b0639aea320d9e65a1", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/73b9e08db9a3e9d6e4e757b0639aea320d9e65a1", "committedDate": "2020-06-25T09:36:45Z", "message": "draft test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1208847f3fb18abd33ca9f0ea5162954ca349ac", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1208847f3fb18abd33ca9f0ea5162954ca349ac", "committedDate": "2020-06-25T09:55:57Z", "message": "joda and java yml test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eed78b4df0d812bbe1c8353f8b3895c57ec379d", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/4eed78b4df0d812bbe1c8353f8b3895c57ec379d", "committedDate": "2020-06-25T12:02:44Z", "message": "remove unused test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7f1ba28d244bf12e23f26addc603400354b9212", "committedDate": "2020-06-26T14:01:39Z", "message": "add index and search test case"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTc3NjQ4", "url": "https://github.com/elastic/elasticsearch/pull/58503#pullrequestreview-440977648", "createdAt": "2020-07-01T15:29:15Z", "commit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNToyOToxNlrOGrq3Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNDoyMVrOGr3PcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0NDI1OA==", "bodyText": "nit: why is this moved here? i think setting a member variable shoudl be done on it's own line, like it was before, not hidden inside a list initialization", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448444258", "createdAt": "2020-07-01T15:29:16Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -64,12 +61,11 @@\n     private final DateMathExpressionResolver dateMathExpressionResolver;\n \n     public IndexNameExpressionResolver(Settings settings) {\n-        dateMathExpressionResolver = new DateMathExpressionResolver(settings);\n         expressionResolvers = Arrays.asList(\n-                dateMathExpressionResolver,\n-                new WildcardExpressionResolver());\n+            dateMathExpressionResolver = new DateMathExpressionResolver(settings),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NTM0Ng==", "bodyText": "Shouldn't this use the pattern in defaultDateFormatterPattern?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448645346", "createdAt": "2020-07-01T22:19:48Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");\n+            this.defaultDateFormatter = DateFormatters.forPattern(\"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjA1MQ==", "bodyText": "Since this is in 6.8, shouldn't this default format be prefixed with '8' since we still use joda by default here?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448646051", "createdAt": "2020-07-01T22:21:48Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzAyNA==", "bodyText": "We previously added the '8' prefix in date formats so that both joda and java formats could be distinguished. I have a vague memory that the zone identifiers do not completely match up between joda and java. Is this correct? If so, what happens if the format specified by the user is one not supported by java?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448647024", "createdAt": "2020-07-01T22:24:21Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -947,23 +943,25 @@ String resolveExpression(String expression, final Context context) {\n                                             inPlaceHolderString);\n                                     }\n                                     mathExpression = inPlaceHolderString.substring(0, dateTimeFormatLeftBoundIndex);\n-                                    String patternAndTZid =\n+                                    String dateFormatterPatternAndTimeZoneId =\n                                         inPlaceHolderString.substring(dateTimeFormatLeftBoundIndex + 1, inPlaceHolderString.length() - 1);\n-                                    int formatPatternTimeZoneSeparatorIndex = patternAndTZid.indexOf(TIME_ZONE_BOUND);\n+                                    int formatPatternTimeZoneSeparatorIndex = dateFormatterPatternAndTimeZoneId.indexOf(TIME_ZONE_BOUND);\n                                     if (formatPatternTimeZoneSeparatorIndex != -1) {\n-                                        dateFormatterPattern = patternAndTZid.substring(0, formatPatternTimeZoneSeparatorIndex);\n-                                        timeZone = DateTimeZone.forID(patternAndTZid.substring(formatPatternTimeZoneSeparatorIndex + 1));\n+                                        dateFormatterPattern\n+                                            = dateFormatterPatternAndTimeZoneId.substring(0, formatPatternTimeZoneSeparatorIndex);\n+                                        timeZone = ZoneId.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 106}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e773628aebbecdc56432b89d130d9f2905472749", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e773628aebbecdc56432b89d130d9f2905472749", "committedDate": "2020-07-02T06:49:48Z", "message": "code review fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed9e8c6ee24ba84f017bb522ec507450a418fcfa", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed9e8c6ee24ba84f017bb522ec507450a418fcfa", "committedDate": "2020-07-02T07:15:18Z", "message": "fix formatter creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de1067a1d943da49b4b21982d0e766666b6ab044", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/de1067a1d943da49b4b21982d0e766666b6ab044", "committedDate": "2020-07-02T08:09:46Z", "message": "add back dmath expresion resolver to a list"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e8cfe0f94b62d59eaefc471eca881462c4679e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/31e8cfe0f94b62d59eaefc471eca881462c4679e", "committedDate": "2020-07-02T08:24:36Z", "message": "Merge branch '6.8' into bp/index_name_expression_resolver"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a89df06b3f2446ff892e03fe51215849ab9bdcb", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a89df06b3f2446ff892e03fe51215849ab9bdcb", "committedDate": "2020-07-02T08:55:55Z", "message": "import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQxOTg2NTUy", "url": "https://github.com/elastic/elasticsearch/pull/58503#pullrequestreview-441986552", "createdAt": "2020-07-02T20:05:09Z", "commit": {"oid": "0a89df06b3f2446ff892e03fe51215849ab9bdcb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 392, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}