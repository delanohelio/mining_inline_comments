{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNTk3NjE4", "number": 52081, "title": "Filter empty lines from \"docker ls\" response", "bodyText": "In order to cut down on test time, our docker/vagrant tests build the\ndocker image outside of the vagrant VM. When we get around to launching\nthe Vagrant VM, we mount that already-built docker image to a known\nlocation. At that point, we need to load the docker image. But we only\nwant to load it once. As we're running tests, we use \"docker ls\" to\ncheck whether the local image is loaded for use. Empty output from the\nparticular ls invocation means no image is loaded.\nThere was a bug in how we checked this. In Java, splitting an empty\nstring will yield an array containing one empty string. So when we're\ncounting the output from the docker ls command, we need to filter out\nempty lines in order to proceed to loading the image for docker tests.\nThis isn't an issue in master because there we use a Java-13-only method\nthat doesn't have this problem.\nThis will fix some long-failing tests for the 7.x and 7.6 branches.\nCloses #51998", "createdAt": "2020-02-07T20:57:52Z", "url": "https://github.com/elastic/elasticsearch/pull/52081", "merged": true, "mergeCommit": {"oid": "2311bc62f7026a9dbc1b563475bfb7d6509c573d"}, "closed": true, "closedAt": "2020-02-14T16:39:14Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCFtjqgH2gAyMzcyNTk3NjE4OjliMmNiMjQwNDQzMGVmNGUyYTJmNzhkODMwYjM3NTA3MTFiYjQ1NWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcEQ4iigH2gAyMzcyNTk3NjE4OjY4MjI3YzVmNWE2YTE2MDlhYTM4NTVhODVkYTUyOWUyYTk0N2Q4Njk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b2cb2404430ef4e2a2f78d830b3750711bb455b", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b2cb2404430ef4e2a2f78d830b3750711bb455b", "committedDate": "2020-02-07T20:53:13Z", "message": "Filter empty lines from docker ls response\n\nIn order to cut down on test time, our docker/vagrant tests build the\ndocker image outside of the vagrant VM. When we get around to launching\nthe Vagrant VM, we mount that already-built docker image to a known\nlocation. At that point, we need to load the docker image. But we only\nwant to load it once. As we're running tests, we use \"docker ls\" to\ncheck whether the local image is loaded for use. Empty output from the\nparticular ls invocation means no image is loaded.\n\nThere was a bug in how we checked this. In Java, splitting an empty\nstring will yield an array containing one empty string. So when we're\ncounting the output from the docker ls command, we need to filter out\nempty lines in order to proceed to loading the image for docker tests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDM2MTIx", "url": "https://github.com/elastic/elasticsearch/pull/52081#pullrequestreview-355436121", "createdAt": "2020-02-07T21:05:15Z", "commit": {"oid": "9b2cb2404430ef4e2a2f78d830b3750711bb455b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMTowNToxNVrOFnKRVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMTowNToxNVrOFnKRVw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYwNzA2Mw==", "bodyText": "Figured I'd add the token \"this could be simpler\" comment \ud83d\ude09\nArrays.stream(result.stdout.split(\"\\n\"))\n                .map(String::trim)\n                .noneMatch(String::isEmpty);", "url": "https://github.com/elastic/elasticsearch/pull/52081#discussion_r376607063", "createdAt": "2020-02-07T21:05:15Z", "author": {"login": "mark-vieira"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Docker.java", "diffHunk": "@@ -76,7 +77,11 @@\n      * @param distribution details about the docker image to potentially load.\n      */\n     public static void ensureImageIsLoaded(Distribution distribution) {\n-        final long count = sh.run(\"docker image ls --format '{{.Repository}}' \" + distribution.flavor.name).stdout.split(\"\\n\").length;\n+        Shell.Result result = sh.run(\"docker image ls --format '{{.Repository}}' \" + distribution.flavor.name);\n+\n+        final long count = Arrays.stream(result.stdout.split(\"\\n\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b2cb2404430ef4e2a2f78d830b3750711bb455b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13c30626c6d26ca97eaa642e38d163ff4558096e", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/13c30626c6d26ca97eaa642e38d163ff4558096e", "committedDate": "2020-02-07T23:26:21Z", "message": "Slightly simplify stream logic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3eded282c2999c23af12f77dbc38c6ec45ced98", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3eded282c2999c23af12f77dbc38c6ec45ced98", "committedDate": "2020-02-07T23:31:56Z", "message": "Merge branch '7.x' into fix/51998/docker-ls-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3MDQ0NDIy", "url": "https://github.com/elastic/elasticsearch/pull/52081#pullrequestreview-357044422", "createdAt": "2020-02-11T22:29:06Z", "commit": {"oid": "b3eded282c2999c23af12f77dbc38c6ec45ced98"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68227c5f5a6a1609aa3855a85da529e2a947d869", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/68227c5f5a6a1609aa3855a85da529e2a947d869", "committedDate": "2020-02-14T15:02:01Z", "message": "Merge branch '7.x' into fix/51998/docker-ls-bug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2694, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}