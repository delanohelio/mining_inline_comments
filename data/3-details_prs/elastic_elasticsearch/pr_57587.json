{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MDI3NzMx", "number": 57587, "title": "Timeout health API on busy master", "bodyText": "Today GET _cluster/health?wait_for_events=...&timeout=... will wait\nindefinitely for the master to process the pending cluster health task,\nignoring the specified timeout. This could take a very long time if the master\nis overloaded. This commit fixes this by adding a timeout to the pending\ncluster health task.", "createdAt": "2020-06-03T07:54:41Z", "url": "https://github.com/elastic/elasticsearch/pull/57587", "merged": true, "mergeCommit": {"oid": "d81ea8e7c7350666b99ad8c9da74a986da718830"}, "closed": true, "closedAt": "2020-06-04T12:38:52Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcnkovwgH2gAyNDI3MDI3NzMxOmEzNDg1MzQxNTU4YjZmMTU3NGIzMWU0MWQ4YjJlY2QxNWZiYjYzMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcn9EXDAFqTQyNDM4MjA1OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a3485341558b6f1574b31e41d8b2ecd15fbb6303", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3485341558b6f1574b31e41d8b2ecd15fbb6303", "committedDate": "2020-06-03T07:50:13Z", "message": "Timeout health API on busy master\n\nToday `GET _cluster/health?wait_for_events=...&timeout=...` will wait\nindefinitely for the master to process the pending cluster health task,\nignoring the specified timeout. This could take a very long time if the master\nis overloaded. This commit fixes this by adding a timeout to the pending\ncluster health task."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzNjg0Nzc2", "url": "https://github.com/elastic/elasticsearch/pull/57587#pullrequestreview-423684776", "createdAt": "2020-06-03T15:42:55Z", "commit": {"oid": "a3485341558b6f1574b31e41d8b2ecd15fbb6303"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNTo0Mjo1NVrOGeh5lA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wM1QxNTo0Mjo1NVrOGeh5lA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNDY2NTg3Ng==", "bodyText": "We could maybe use a PlainActionFuture<Void> here and resolve it if keepSubmittingTasks.get() is false or on failure. Then we can just .get() on it at the end of the test and not leak the update task beyond the test time? (also I think we could get some strange test failures without that, where we set false for keep submitting, then leak the task, and get an onFailure when we shut down the cluster after the test?)", "url": "https://github.com/elastic/elasticsearch/pull/57587#discussion_r434665876", "createdAt": "2020-06-03T15:42:55Z", "author": {"login": "original-brownbear"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/ClusterHealthIT.java", "diffHunk": "@@ -311,4 +312,34 @@ public void testHealthOnMasterFailover() throws Exception {\n             assertSame(responseFuture.get().getStatus(), ClusterHealthStatus.GREEN);\n         }\n     }\n+\n+    public void testWaitForEventsTimesOutIfMasterBusy() {\n+        final AtomicBoolean keepSubmittingTasks = new AtomicBoolean(true);\n+        final ClusterService clusterService = internalCluster().getInstance(ClusterService.class, internalCluster().getMasterName());\n+        clusterService.submitStateUpdateTask(\"looping task\", new ClusterStateUpdateTask(Priority.LOW) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a3485341558b6f1574b31e41d8b2ecd15fbb6303"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40945b7b860c00b74b864e846ab375823736f351", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/40945b7b860c00b74b864e846ab375823736f351", "committedDate": "2020-06-03T16:54:51Z", "message": "Wait for publication loop to complete before finishing test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI0MzgyMDU4", "url": "https://github.com/elastic/elasticsearch/pull/57587#pullrequestreview-424382058", "createdAt": "2020-06-04T12:18:06Z", "commit": {"oid": "40945b7b860c00b74b864e846ab375823736f351"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3994, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}