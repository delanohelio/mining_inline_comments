{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0OTg5NTY5", "number": 53241, "title": "QL: constant_keyword support", "bodyText": "This PR adds support for constant_keyword data type following its addition in Elasticsearch with #49713.\nAddresses #53016", "createdAt": "2020-03-06T19:39:25Z", "url": "https://github.com/elastic/elasticsearch/pull/53241", "merged": true, "mergeCommit": {"oid": "d6cd4ce7849ba215407c8c5fa815c9b373fb8480"}, "closed": true, "closedAt": "2020-03-16T13:22:43Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcLFSzpgH2gAyMzg0OTg5NTY5Ojc1NDBmMDZiZDdlMDhiNTQyMGIwM2ZlNTExYzIxNjA3YTRmZGY2ZGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNRtPfAFqTM3NDM3Mzg1NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7540f06bd7e08b5420b03fe511c21607a4fdf6db", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/7540f06bd7e08b5420b03fe511c21607a4fdf6db", "committedDate": "2020-03-06T19:29:19Z", "message": "Support for constant_keyword data type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f92a65ca83aea22fd392a60cf733841ffc59462", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f92a65ca83aea22fd392a60cf733841ffc59462", "committedDate": "2020-03-06T19:34:29Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 53016_feature"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/23a1a7df44507bd8ed8bad9f59894812f43db275", "committedDate": "2020-03-06T19:36:17Z", "message": "Update"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNjUyNzQ1", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-370652745", "createdAt": "2020-03-06T21:59:37Z", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMTo1OTozOFrOFzIu1g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQyMjoxMzozMFrOFzJCWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2NDc1OA==", "bodyText": "Leftover comment?", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389164758", "createdAt": "2020-03-06T21:59:38Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/resources/constant-keyword.csv-spec", "diffHunk": "@@ -0,0 +1,131 @@\n+// To mute tests follow example in file: example.csv-spec\n+\n+//\n+// Tests testing field alias (introduced in ES 6.4)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2NjUyNA==", "bodyText": "Could you explain please, I don't get it.", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389166524", "createdAt": "2020-03-06T22:04:44Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/execution/search/extractor/AbstractFieldHitExtractor.java", "diffHunk": "@@ -213,6 +214,7 @@ protected Object unwrapMultiValue(Object values) {\n     protected boolean isFromDocValuesOnly(DataType dataType) {\n         return dataType == KEYWORD // because of ignore_above.\n                     || dataType == DATETIME\n+                    || dataType == CONSTANT_KEYWORD // because a non-existent value is considered the constant value itself", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2NzczMg==", "bodyText": "Personally I would prefer it to be in tha employees.csv file and have a different value from gender like Male and Female.", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389167732", "createdAt": "2020-03-06T22:08:11Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/DataLoader.java", "diffHunk": "@@ -198,6 +195,9 @@ private static void loadEmpDatasetIntoEs(RestClient client, String index, String\n                     }\n                     hadLastItem = true;\n                     bulk.append('\"').append(titles.get(f)).append(\"\\\":\\\"\").append(fields.get(f)).append('\"');\n+                    if (titles.get(f).equals(\"gender\") && extraFields) {\n+                        bulk.append(\",\\\"extra_gender\\\":\\\"M\\\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2ODQ4Mw==", "bodyText": "constant_keyword cannot be null, correct?", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389168483", "createdAt": "2020-03-06T22:09:58Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/resources/constant-keyword.csv-spec", "diffHunk": "@@ -0,0 +1,131 @@\n+// To mute tests follow example in file: example.csv-spec\n+\n+//\n+// Tests testing field alias (introduced in ES 6.4)\n+//\n+\n+// filtering\n+\n+filterEquals\n+SELECT extra_gender g FROM \"test_emp_copy\" WHERE g = 'M' LIMIT 5;\n+\n+    g     \n+---------------\n+M              \n+M              \n+M              \n+M              \n+M   \n+\n+;\n+\n+filterNotEquals\n+SELECT COUNT(*) AS c FROM \"test_emp_copy\" WHERE extra_gender <> 'M';\n+\n+    c:l     \n+---------------\n+0\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE extra_gender IS NOT NULL;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2ODY0NQ==", "bodyText": "If we have 2 values Male/Female that should be changed.", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389168645", "createdAt": "2020-03-06T22:10:32Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/resources/constant-keyword.csv-spec", "diffHunk": "@@ -0,0 +1,131 @@\n+// To mute tests follow example in file: example.csv-spec\n+\n+//\n+// Tests testing field alias (introduced in ES 6.4)\n+//\n+\n+// filtering\n+\n+filterEquals\n+SELECT extra_gender g FROM \"test_emp_copy\" WHERE g = 'M' LIMIT 5;\n+\n+    g     \n+---------------\n+M              \n+M              \n+M              \n+M              \n+M   \n+\n+;\n+\n+filterNotEquals\n+SELECT COUNT(*) AS c FROM \"test_emp_copy\" WHERE extra_gender <> 'M';\n+\n+    c:l     \n+---------------\n+0\n+;\n+\n+aggWithNullFilter\n+SELECT COUNT(*) count FROM test_emp_copy WHERE extra_gender IS NOT NULL;\n+\n+     count:l     \n+---------------\n+100\n+;\n+\n+functionOverAlias\n+SELECT BIT_LENGTH(extra_gender) bit FROM test_emp_copy ORDER BY extra_gender LIMIT 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTE2OTc1Mg==", "bodyText": "Numeric and constant_keyword not tasted in DataTypeConverterTests of QL.", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389169752", "createdAt": "2020-03-06T22:13:30Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/type/SqlDataTypeConverterTests.java", "diffHunk": "@@ -631,6 +632,7 @@ public void testCommonType() {\n         assertEquals(BOOLEAN, commonType(BOOLEAN, BOOLEAN));\n         assertEquals(NULL, commonType(NULL, NULL));\n         assertEquals(INTEGER, commonType(INTEGER, KEYWORD));\n+        assertEquals(DOUBLE, commonType(DOUBLE, CONSTANT_KEYWORD));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 12}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwODU4NDg3", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-370858487", "createdAt": "2020-03-08T21:15:19Z", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMToxNToxOVrOFzXdHQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQyMToxNToxOVrOFzXdHQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTQwNTk4MQ==", "bodyText": "Removing the type all together might remove useful information.\nFor example if a field a is mapped as keyword in index X and constant_keyword in index Y, the piece above will find the collision and remove the field from Y resulting in a mapping only in X.\nOn one hand it does indicate that there's only field a however each field has index information underneath so in this case it would be just for index X. I'm not sure though whether we take that into account or not.\nWhat happens is there's no removal?", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389405981", "createdAt": "2020-03-08T21:15:19Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/index/IndexResolver.java", "diffHunk": "@@ -344,6 +351,11 @@ public static IndexResolution mergedMappings(DataTypeRegistry typeRegistry, Stri\n                 }\n             }\n \n+            // if there are both a keyword and a constant_keyword type for this field, only keep the keyword as a common compatible type\n+            if (hasCompatibleKeywords) {\n+                types.remove(CONSTANT_KEYWORD.esType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 37}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMjYxNzEx", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-371261711", "createdAt": "2020-03-09T15:03:42Z", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzY4NTI5", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-371368529", "createdAt": "2020-03-09T17:09:16Z", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzowOToxNlrOFzxhPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzowOToxNlrOFzxhPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTgzMzAyMA==", "bodyText": "I guess the remaining is a combination of KEYWORD and CONSTANT_KEYWORD. If we want to prioritise a selection, wouldn't a || right == KEYWORD make sense here? If not, couldn't we just return right; right away?", "url": "https://github.com/elastic/elasticsearch/pull/53241#discussion_r389833020", "createdAt": "2020-03-09T17:09:16Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/type/DataTypeConverter.java", "diffHunk": "@@ -59,9 +60,12 @@ public static DataType commonType(DataType left, DataType right) {\n             return left;\n         }\n         if (isString(left) && isString(right)) {\n-            if (left == TEXT) {\n+            if (left == TEXT || right == TEXT) {\n                 return TEXT;\n             }\n+            if (left == KEYWORD) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzc0MDA3", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-371374007", "createdAt": "2020-03-09T17:16:13Z", "commit": {"oid": "23a1a7df44507bd8ed8bad9f59894812f43db275"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5376c99c562f60d1b9b8c7e1defb2a8254d2f7d", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5376c99c562f60d1b9b8c7e1defb2a8254d2f7d", "committedDate": "2020-03-13T09:54:08Z", "message": "Address reviews"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abad76cf18868487d1b94ba004efd5db54195596", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/abad76cf18868487d1b94ba004efd5db54195596", "committedDate": "2020-03-13T14:34:36Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1740adbcb60f10b6219b5ecd1bf4aca97e8ad39e", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1740adbcb60f10b6219b5ecd1bf4aca97e8ad39e", "committedDate": "2020-03-13T14:35:07Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 53016_feature"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0MzczODU0", "url": "https://github.com/elastic/elasticsearch/pull/53241#pullrequestreview-374373854", "createdAt": "2020-03-13T15:04:54Z", "commit": {"oid": "1740adbcb60f10b6219b5ecd1bf4aca97e8ad39e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1584, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}