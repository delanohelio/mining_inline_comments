{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMDIzMzYx", "number": 64417, "title": "Change deprecation indexing to use a custom template", "bodyText": "The implementation for indexing deprecation logs to a data stream (#58924) relied on the Stack template for logs-*-*. This meant that if the user disabled the stack templates, the templates would also be unavailable for the deprecation logs.\nChange the implementation so that:\n\nThere is a separate template for deprecation logging\nThe data stream is marked as hidden\nThe data stream name is prefixed with a period (.)", "createdAt": "2020-10-30T13:57:25Z", "url": "https://github.com/elastic/elasticsearch/pull/64417", "merged": true, "mergeCommit": {"oid": "39a86438cd4cf738f70c9807a0ae4fb0c16e0613"}, "closed": true, "closedAt": "2020-11-02T16:38:36Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdW9jjsgH2gAyNTEzMDIzMzYxOmQxYWUxZjMzMTM0NTk3MTIzZTNhMWIyYWQ3MGZlMTRlYzgxNzc3NTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdYnPdWAFqTUyMTc5Njc0Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1ae1f33134597123e3a1b2ad70fe14ec8177759", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1ae1f33134597123e3a1b2ad70fe14ec8177759", "committedDate": "2020-10-28T13:26:37Z", "message": "Change deprecation indexing to use its own templates, not the stack ones"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f54368f3abc3207c6fb0d2401adb0750cae2828", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f54368f3abc3207c6fb0d2401adb0750cae2828", "committedDate": "2020-10-30T12:08:57Z", "message": "Merge remote-tracking branch 'upstream/master' into deprecation-indexing-custom-template"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/64f4d292578728f3ff59815bdfc9b47cb5dea74e", "committedDate": "2020-10-30T13:53:41Z", "message": "Mark the deprecation logs data stream as hidden"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzQ0NDU4", "url": "https://github.com/elastic/elasticsearch/pull/64417#pullrequestreview-520744458", "createdAt": "2020-10-30T14:51:08Z", "commit": {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDo1MTowOFrOHrSflw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNDo1MTowOFrOHrSflw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE1MzgxNQ==", "bodyText": "we create more fields from our logs. Do we have to define them in the mappings too?", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r515153815", "createdAt": "2020-10-30T14:51:08Z", "author": {"login": "pgomulka"}, "path": "x-pack/plugin/core/src/main/resources/org/elasticsearch/xpack/deprecation/deprecation-indexing-mappings.json", "diffHunk": "@@ -0,0 +1,60 @@\n+{\n+  \"template\": {\n+    \"mappings\": {\n+      \"dynamic_templates\": [\n+        {\n+          \"strings_as_keyword\": {\n+            \"mapping\": {\n+              \"ignore_above\": 1024,\n+              \"type\": \"keyword\"\n+            },\n+            \"match_mapping_type\": \"string\"\n+          }\n+        }\n+      ],\n+      \"date_detection\": false,\n+      \"properties\": {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNzY5ODM4", "url": "https://github.com/elastic/elasticsearch/pull/64417#pullrequestreview-520769838", "createdAt": "2020-10-30T15:18:17Z", "commit": {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxODoxN1rOHrTvLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxNToxODoxN1rOHrTvLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTE3NDE5MQ==", "bodyText": "This should not be overridden to true, since in a rolling environment a 7.11 node could start logging deprecation messages that are indexed prior to the master node being upgraded (meaning that the templates would not be in place), so the messages could end up not being indexed correctly", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r515174191", "createdAt": "2020-10-30T15:18:17Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/logging/DeprecationIndexingTemplateRegistry.java", "diffHunk": "@@ -0,0 +1,97 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.deprecation.logging;\n+\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.cluster.service.ClusterService;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.xcontent.NamedXContentRegistry;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.template.IndexTemplateConfig;\n+import org.elasticsearch.xpack.core.template.IndexTemplateRegistry;\n+import org.elasticsearch.xpack.core.template.LifecyclePolicyConfig;\n+\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.core.ClientHelper.DEPRECATION_ORIGIN;\n+\n+/**\n+ * Manages the index template and associated ILM policy for deprecation log indexing.\n+ */\n+public class DeprecationIndexingTemplateRegistry extends IndexTemplateRegistry {\n+    // history (please add a comment why you increased the version here)\n+    // version 1: initial\n+    public static final int INDEX_TEMPLATE_VERSION = 1;\n+\n+    public static final String DEPRECATION_INDEXING_TEMPLATE_VERSION_VARIABLE = \"xpack.deprecation.indexing.template.version\";\n+\n+    public static final String DEPRECATION_INDEXING_MAPPINGS_NAME = \".deprecation-indexing-mappings\";\n+    public static final String DEPRECATION_INDEXING_SETTINGS_NAME = \".deprecation-indexing-settings\";\n+    public static final String DEPRECATION_INDEXING_TEMPLATE_NAME = \".deprecation-indexing-template\";\n+    public static final String DEPRECATION_INDEXING_POLICY_NAME = \".deprecation-indexing-ilm-policy\";\n+\n+    @Override\n+    protected boolean requiresMasterNode() {\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64f4d292578728f3ff59815bdfc9b47cb5dea74e"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780", "committedDate": "2020-10-30T16:57:40Z", "message": "Review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzQ5ODM2", "url": "https://github.com/elastic/elasticsearch/pull/64417#pullrequestreview-521749836", "createdAt": "2020-11-02T15:45:37Z", "commit": {"oid": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNTo0NTozN1rOHsKBoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxNTo0NTozN1rOHsKBoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjA2MzY0OQ==", "bodyText": "This is a breaking change now, since deprecation logging went into effect in 7.10, and we're changing the index name, are we sure we're okay with the breaking change in a minor release? I'm not sure we should?", "url": "https://github.com/elastic/elasticsearch/pull/64417#discussion_r516063649", "createdAt": "2020-11-02T15:45:37Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/resources/org/elasticsearch/xpack/deprecation/deprecation-indexing-template.json", "diffHunk": "@@ -0,0 +1,17 @@\n+{\n+  \"index_patterns\": [\".logs-deprecation-elasticsearch\"],", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNzk2NzQz", "url": "https://github.com/elastic/elasticsearch/pull/64417#pullrequestreview-521796743", "createdAt": "2020-11-02T16:34:36Z", "commit": {"oid": "a2ecfe1cbd2a9f80fbb3cd905c6f5a548fb7a780"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 876, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}