{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTc5NDMw", "number": 59099, "title": "Fix lookup support in adjacency matrix", "bodyText": "This request:\nPOST /_search\n{\n  \"aggs\": {\n    \"a\": {\n      \"adjacency_matrix\": {\n        \"filters\": {\n          \"1\": {\n            \"terms\": { \"t\": { \"index\": \"lookup\", \"id\": \"1\", \"path\": \"t\" } }\n          }\n        }\n      }\n    }\n  }\n}\n\nWould fail with a 500 error and a message like:\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"illegal_state_exception\",\n        \"reason\":\"async actions are left after rewrite\"\n      }\n    ]\n  }\n}\n\nThis fixes that by moving the query rewrite phase from a synchronous\ncall on the data nodes into the standard aggregation rewrite phase which\ncan properly handle the asynchronous actions.", "createdAt": "2020-07-06T20:13:53Z", "url": "https://github.com/elastic/elasticsearch/pull/59099", "merged": true, "mergeCommit": {"oid": "3b3ed4b4a7b599ae157cbe1ec782919f97ef914d"}, "closed": true, "closedAt": "2020-07-06T22:53:20Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyXCiYgH2gAyNDQ0OTc5NDMwOjY4ODhlYjg2NWJjOWNjMWUyMTU4YWZmZmZmYjliNTI5MTdmNTNkMmU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyYjYoAH2gAyNDQ0OTc5NDMwOmU4ZjhiZGNlMmY0OGJmY2U0YTRiNGRkNDZiYWE2OTZhNzc3NGIwZWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6888eb865bc9cc1e2158afffffb9b52917f53d2e", "committedDate": "2020-07-06T20:12:53Z", "message": "Fix lookup support in adjacency matrix\n\nThis request:\n```\nPOST /_search\n{\n  \"aggs\": {\n    \"a\": {\n      \"adjacency_matrix\": {\n        \"filters\": {\n          \"1\": {\n            \"terms\": { \"t\": { \"index\": \"lookup\", \"id\": \"1\", \"path\": \"t\" } }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nWould fail with a 500 error and a message like:\n```\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"illegal_state_exception\",\n        \"reason\":\"async actions are left after rewrite\"\n      }\n    ]\n  }\n}\n```\n\nThis fixes that by moving the query rewrite phase from a synchronous\ncall on the data nodes into the standard aggregation rewrite phase which\ncan properly handle the asynchronous actions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzc3NTU0", "url": "https://github.com/elastic/elasticsearch/pull/59099#pullrequestreview-443377554", "createdAt": "2020-07-06T20:14:40Z", "commit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNDo0MFrOGtlo5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMDoxNjo0OVrOGtltAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NTc4MA==", "bodyText": "I don't believe this setting exists any more.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450455780", "createdAt": "2020-07-06T20:14:40Z", "author": {"login": "nik9000"}, "path": "docs/reference/aggregations/bucket/adjacency-matrix-aggregation.asciidoc", "diffHunk": "@@ -110,5 +110,4 @@ where examining interactions _over time_ becomes important.\n ==== Limitations\n For N filters the matrix of buckets produced can be N\u00b2/2 which can be costly.\n The circuit breaker settings prevent results producing too many buckets and to avoid excessive disk seeks\n-the `indices.query.bool.max_clause_count` setting is used to limit the number of filters. \n-imposed of 100 filters . This setting can be changed using the `index.max_adjacency_matrix_filters` index-level setting.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NTg4Mg==", "bodyText": "These are just a little more compact.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450455882", "createdAt": "2020-07-06T20:14:54Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjEwNw==", "bodyText": "And this is just a little more readable than sticking it all on one line.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456107", "createdAt": "2020-07-06T20:15:20Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:\n-          index: test\n-          id: 1\n-          body: { \"num\": [1, 2] }\n+      bulk:\n+        index: test\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": \"1\"}}\n+          { \"num\": [1, 2] }\n+          { \"index\": {\"_id\": \"2\"}}\n+          { \"num\": [2, 3] }\n+          { \"index\": {\"_id\": \"3\"}}\n+          { \"num\": [3, 4] }\n \n   - do:\n-      index:\n-        index: test\n-        id: 2\n-        body: { \"num\": [2, 3] }\n+      indices.refresh: {}\n+---\n+\"Filters intersections\":\n \n   - do:\n-      index:\n+      search:\n         index: test\n-        id: 3\n-        body: { \"num\": [3, 4] }\n+        body:\n+          size: 0\n+          aggs:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjE1Mg==", "bodyText": "This is the new test.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456152", "createdAt": "2020-07-06T20:15:27Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/70_adjacency_matrix.yml", "diffHunk": "@@ -12,36 +12,100 @@ setup:\n                   type: integer\n \n   - do:\n-        index:\n-          index: test\n-          id: 1\n-          body: { \"num\": [1, 2] }\n+      bulk:\n+        index: test\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": \"1\"}}\n+          { \"num\": [1, 2] }\n+          { \"index\": {\"_id\": \"2\"}}\n+          { \"num\": [2, 3] }\n+          { \"index\": {\"_id\": \"3\"}}\n+          { \"num\": [3, 4] }\n \n   - do:\n-      index:\n-        index: test\n-        id: 2\n-        body: { \"num\": [2, 3] }\n+      indices.refresh: {}\n+---\n+\"Filters intersections\":\n \n   - do:\n-      index:\n+      search:\n         index: test\n-        id: 3\n-        body: { \"num\": [3, 4] }\n+        body:\n+          size: 0\n+          aggs:\n+            conns:\n+              adjacency_matrix:\n+                filters:\n+                  1:\n+                    term:\n+                      num: 1\n+                  2:\n+                    term:\n+                      num: 2\n+                  4:\n+                    term:\n+                      num: 4\n \n-  - do:\n-      indices.refresh: {}\n+  - match: { hits.total.value: 3 }\n \n+  - length: { aggregations.conns.buckets: 4 }\n \n----\n-\"Filters intersections\":\n+  - match: { aggregations.conns.buckets.0.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.0.key: \"1\" }\n \n+  - match: { aggregations.conns.buckets.1.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.1.key: \"1&2\" }\n+\n+  - match: { aggregations.conns.buckets.2.doc_count: 2 }\n+  - match: { aggregations.conns.buckets.2.key: \"2\" }\n+\n+  - match: { aggregations.conns.buckets.3.doc_count: 1 }\n+  - match: { aggregations.conns.buckets.3.key: \"4\" }\n+\n+\n+---\n+\"Terms lookup\":\n+  - do:\n+      bulk:\n+        index: lookup\n+        refresh: true\n+        body: |\n+          { \"index\": {\"_id\": 1} }\n+          { \"num\": [1] }\n+          { \"index\": {\"_id\": 2} }\n+          { \"num\": [2] }\n+          { \"index\": {\"_id\": 4} }\n+          { \"num\": [4] }\n   - do:\n       search:\n-        rest_total_hits_as_int: true\n-        body: { \"size\": 0, \"aggs\": { \"conns\": { \"adjacency_matrix\": {  \"filters\": { \"1\": { \"term\": { \"num\": 1 } }, \"2\": { \"term\": { \"num\": 2 } }, \"4\": { \"term\": { \"num\": 4 } } } } } } }\n+        index: test\n+        body:\n+          size: 0\n+          aggs:\n+            conns:\n+              adjacency_matrix:\n+                filters:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjY4NQ==", "bodyText": "I just bumped into this when I was looking at the agg.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456685", "createdAt": "2020-07-06T20:16:31Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregator.java", "diffHunk": "@@ -123,7 +123,7 @@ public boolean equals(Object obj) {\n     }\n \n     private final String[] keys;\n-    private Weight[] filters;\n+    private final Weight[] filters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDQ1NjgzNA==", "bodyText": "These were confusing because above they are referred to without this but below they had it.", "url": "https://github.com/elastic/elasticsearch/pull/59099#discussion_r450456834", "createdAt": "2020-07-06T20:16:49Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/adjacency/AdjacencyMatrixAggregatorFactory.java", "diffHunk": "@@ -50,9 +50,9 @@ public AdjacencyMatrixAggregatorFactory(String name, List<KeyedFilter> filters,\n         keys = new String[filters.size()];\n         for (int i = 0; i < filters.size(); ++i) {\n             KeyedFilter keyedFilter = filters.get(i);\n-            this.keys[i] = keyedFilter.key();\n+            keys[i] = keyedFilter.key();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMzk0NTY4", "url": "https://github.com/elastic/elasticsearch/pull/59099#pullrequestreview-443394568", "createdAt": "2020-07-06T20:43:55Z", "commit": {"oid": "6888eb865bc9cc1e2158afffffb9b52917f53d2e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8f8bdce2f48bfce4a4b4dd46baa696a7774b0eb", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e8f8bdce2f48bfce4a4b4dd46baa696a7774b0eb", "committedDate": "2020-07-06T21:58:40Z", "message": "Skip old"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2332, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}