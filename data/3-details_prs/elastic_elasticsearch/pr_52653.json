{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4Mzg1OTkz", "number": 52653, "title": "Allow freezing searchable snapshots", "bodyText": "Today it does not work to freeze an index restored as a searchable snapshot,\nbecause both features try and supply their own Engine implementation. However\na searchable snapshot works with both a ReadOnlyEngine and a FrozenEngine,\nso we can check to see if the searchable snapshot is frozen and, if so, avoid\nsupplying a second Engine in that case.\nRelates #50999", "createdAt": "2020-02-21T17:15:20Z", "url": "https://github.com/elastic/elasticsearch/pull/52653", "merged": true, "mergeCommit": {"oid": "050583ea3d52ea5c846846c736e4e26406ebe5ba"}, "closed": true, "closedAt": "2020-03-02T11:58:57Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGi69cAH2gAyMzc4Mzg1OTkzOjJjYTY3YTgwYjk4N2U5ZDFhMmY1OGFkNzVmOTQyZTE2MDY3OGU2YzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcJrbesAH2gAyMzc4Mzg1OTkzOmJjODVjMjU0OWI5MWQyNDRhZTIyYjU0ZDAxYmFmMzBiMDdjM2MxMTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ca67a80b987e9d1a2f58ad75f942e160678e6c5", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ca67a80b987e9d1a2f58ad75f942e160678e6c5", "committedDate": "2020-02-21T17:10:48Z", "message": "Allow freezing searchable snapshots\n\nToday it does not work to freeze an index restored as a searchable snapshot,\nbecause both features try and supply their own `Engine` implementation. However\na searchable snapshot works with both a `ReadOnlyEngine` and a `FrozenEngine`,\nso we can check to see if the searchable snapshot is frozen and, if so, avoid\nsupplying a second `Engine` in that case."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNzg2ODQ5", "url": "https://github.com/elastic/elasticsearch/pull/52653#pullrequestreview-362786849", "createdAt": "2020-02-21T17:16:20Z", "commit": {"oid": "2ca67a80b987e9d1a2f58ad75f942e160678e6c5"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxNjoyMFrOFs-adw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQxNzoxNzoyNVrOFs-cWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNDI0Nw==", "bodyText": "Not sure about introducing this string literal here, vs adding a dependency on the frozen-indices module and referring to the setting directly.", "url": "https://github.com/elastic/elasticsearch/pull/52653#discussion_r382704247", "createdAt": "2020-02-21T17:16:20Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshots.java", "diffHunk": "@@ -111,7 +111,8 @@ public void onRepositoriesModule(RepositoriesModule repositoriesModule) {\n \n     @Override\n     public Optional<EngineFactory> getEngineFactory(IndexSettings indexSettings) {\n-        if (SearchableSnapshotRepository.SNAPSHOT_DIRECTORY_FACTORY_KEY.equals(INDEX_STORE_TYPE_SETTING.get(indexSettings.getSettings()))) {\n+        if (SearchableSnapshotRepository.SNAPSHOT_DIRECTORY_FACTORY_KEY.equals(INDEX_STORE_TYPE_SETTING.get(indexSettings.getSettings()))\n+                && indexSettings.getSettings().getAsBoolean(\"index.frozen\", false) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca67a80b987e9d1a2f58ad75f942e160678e6c5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjcwNDczMA==", "bodyText": "Similarly, not sure this is appropriate in terms of dependencies but I figured these interdependencies were ok for tests.", "url": "https://github.com/elastic/elasticsearch/pull/52653#discussion_r382704730", "createdAt": "2020-02-21T17:17:25Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -21,14 +22,17 @@\n import org.elasticsearch.index.IndexSettings;\n import org.elasticsearch.indices.recovery.RecoveryState;\n import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.protocol.xpack.frozen.FreezeRequest;\n import org.elasticsearch.snapshots.SnapshotInfo;\n import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.xpack.core.frozen.action.FreezeIndexAction;\n+import org.elasticsearch.xpack.frozen.FrozenIndices;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2ca67a80b987e9d1a2f58ad75f942e160678e6c5"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2774b7fb103220e533213817ef627b2c702ef110", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/2774b7fb103220e533213817ef627b2c702ef110", "committedDate": "2020-02-21T17:32:15Z", "message": "Missed by git add"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "206856afbb63c689dd4639b695a2ef78259456d5", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/206856afbb63c689dd4639b695a2ef78259456d5", "committedDate": "2020-02-27T12:30:38Z", "message": "Move to  REST tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e0a73a897b4f27c9ae27f1a59e28d23569f3a49", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e0a73a897b4f27c9ae27f1a59e28d23569f3a49", "committedDate": "2020-02-27T12:31:04Z", "message": "Merge branch 'feature/searchable-snapshots' into 2020-02-21-freeze-searchable-snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f0cca1a69bf14d81ae042efe46605f1c75ed237", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f0cca1a69bf14d81ae042efe46605f1c75ed237", "committedDate": "2020-02-27T13:04:55Z", "message": "Revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e3d4bf3774803c19237df7edbd662e7d277b8f7", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e3d4bf3774803c19237df7edbd662e7d277b8f7", "committedDate": "2020-02-27T13:26:51Z", "message": "Merge branch 'feature/searchable-snapshots' into 2020-02-21-freeze-searchable-snapshots"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3MDc4MjM1", "url": "https://github.com/elastic/elasticsearch/pull/52653#pullrequestreview-367078235", "createdAt": "2020-03-02T10:07:25Z", "commit": {"oid": "9e3d4bf3774803c19237df7edbd662e7d277b8f7"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDowNzoyNVrOFwZ1rg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxMDowNzo0OFrOFwZ2gA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI5OTMxMA==", "bodyText": "Can you assertOK() this?", "url": "https://github.com/elastic/elasticsearch/pull/52653#discussion_r386299310", "createdAt": "2020-03-02T10:07:25Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/AbstractSearchableSnapshotsRestTestCase.java", "diffHunk": "@@ -154,6 +127,71 @@ public void testSearchableSnapshots() throws Exception {\n             searchableSnapshotStats.size(), equalTo(numberOfShards));\n     }\n \n+    public void testSearchResults() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            for (int i = 0; i < 10; i++) {\n+                assertSearchResults(restoredIndexName, numDocs, randomFrom(Boolean.TRUE, Boolean.FALSE, null));\n+            }\n+        });\n+    }\n+\n+    public void testSearchResultsWhenFrozen() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            final Request freezeRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_freeze\");\n+            client().performRequest(freezeRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e3d4bf3774803c19237df7edbd662e7d277b8f7"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI5OTQ4MQ==", "bodyText": "Can you assertOK() this?", "url": "https://github.com/elastic/elasticsearch/pull/52653#discussion_r386299481", "createdAt": "2020-03-02T10:07:44Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/AbstractSearchableSnapshotsRestTestCase.java", "diffHunk": "@@ -154,6 +127,71 @@ public void testSearchableSnapshots() throws Exception {\n             searchableSnapshotStats.size(), equalTo(numberOfShards));\n     }\n \n+    public void testSearchResults() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            for (int i = 0; i < 10; i++) {\n+                assertSearchResults(restoredIndexName, numDocs, randomFrom(Boolean.TRUE, Boolean.FALSE, null));\n+            }\n+        });\n+    }\n+\n+    public void testSearchResultsWhenFrozen() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            final Request freezeRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_freeze\");\n+            client().performRequest(freezeRequest);\n+            ensureGreen(restoredIndexName);\n+            for (int i = 0; i < 10; i++) {\n+                assertSearchResults(restoredIndexName, numDocs, Boolean.FALSE);\n+            }\n+        });\n+    }\n+\n+    public void testCloseAndReopen() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            final Request closeRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_close\");\n+            client().performRequest(closeRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e3d4bf3774803c19237df7edbd662e7d277b8f7"}, "originalPosition": 71}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjI5OTUyMA==", "bodyText": "Can you assertOK() this?", "url": "https://github.com/elastic/elasticsearch/pull/52653#discussion_r386299520", "createdAt": "2020-03-02T10:07:48Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/AbstractSearchableSnapshotsRestTestCase.java", "diffHunk": "@@ -154,6 +127,71 @@ public void testSearchableSnapshots() throws Exception {\n             searchableSnapshotStats.size(), equalTo(numberOfShards));\n     }\n \n+    public void testSearchResults() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            for (int i = 0; i < 10; i++) {\n+                assertSearchResults(restoredIndexName, numDocs, randomFrom(Boolean.TRUE, Boolean.FALSE, null));\n+            }\n+        });\n+    }\n+\n+    public void testSearchResultsWhenFrozen() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            final Request freezeRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_freeze\");\n+            client().performRequest(freezeRequest);\n+            ensureGreen(restoredIndexName);\n+            for (int i = 0; i < 10; i++) {\n+                assertSearchResults(restoredIndexName, numDocs, Boolean.FALSE);\n+            }\n+        });\n+    }\n+\n+    public void testCloseAndReopen() throws Exception {\n+        runSearchableSnapshotsTest((restoredIndexName, numDocs) -> {\n+            final Request closeRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_close\");\n+            client().performRequest(closeRequest);\n+            ensureGreen(restoredIndexName);\n+\n+            final Request openRequest = new Request(HttpPost.METHOD_NAME, restoredIndexName + \"/_open\");\n+            client().performRequest(openRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9e3d4bf3774803c19237df7edbd662e7d277b8f7"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b10dd743e969eb30a7b6699bab2525365ca2184f", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/b10dd743e969eb30a7b6699bab2525365ca2184f", "committedDate": "2020-03-02T10:15:38Z", "message": "AssertOK"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc85c2549b91d244ae22b54d01baf30b07c3c114", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/bc85c2549b91d244ae22b54d01baf30b07c3c114", "committedDate": "2020-03-02T10:47:20Z", "message": "Merge branch 'feature/searchable-snapshots' into 2020-02-21-freeze-searchable-snapshots"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2293, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}