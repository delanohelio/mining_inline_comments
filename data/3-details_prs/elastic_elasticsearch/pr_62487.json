{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MTA1MDM3", "number": 62487, "title": "Allow empty null values for date and IP field mappers", "bodyText": "In #57666 we changed when null_value was parsed for ip and date fields.  Previously,\nthe null value was stored as a string, and parsed into a date or InetAddress whenever\na document containing a null value was encountered.  Now, the values are parsed when\nthe mappings are built, which means that bad values are detected up front; if you try and\nadd a mapping with a badly-parsed ip or date for a null_value, the mapping will be\nrejected.\nThis causes problems for upgrades in the case when you have a badly-formed null_value\nin a pre-7.9 cluster.  This commit fixes the upgrade case by changing the logic to only\nfail on indexes created in 8x and later.  For earlier indexes, we log a warning on the\nbadly formed value and ignore it, replicating the earlier behaviour.\nFixes #62363", "createdAt": "2020-09-16T16:25:14Z", "url": "https://github.com/elastic/elasticsearch/pull/62487", "merged": true, "mergeCommit": {"oid": "7b50618d5540150adae59eba0665fdcd58a6c9a2"}, "closed": true, "closedAt": "2020-09-17T15:18:53Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJe0eEgH2gAyNDg4MTA1MDM3Ojk5ODczNmI4MzkwODU4NWIxYzZjZjI3NmI5MGNlMGRjNjk1NzM3ZGU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJyDjIgFqTQ5MDY2NTAyNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/998736b83908585b1c6cf276b90ce0dc695737de", "committedDate": "2020-09-16T16:17:01Z", "message": "Allow empty null values for date and ip field mappers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMzk0NzAw", "url": "https://github.com/elastic/elasticsearch/pull/62487#pullrequestreview-490394700", "createdAt": "2020-09-17T09:09:33Z", "commit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTowOTozM1rOHTYzFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOToxMTowNlrOHTY3LQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MTI4Ng==", "bodyText": "This also converts IpFieldMapperTests to MapperTestCase because it just makes testing so much easier...", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490091286", "createdAt": "2020-09-17T09:09:33Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -28,61 +28,28 @@\n import org.apache.lucene.util.BytesRef;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MTY2OQ==", "bodyText": "This is the part that is testing the new functionality", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490091669", "createdAt": "2020-09-17T09:10:05Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -265,33 +169,29 @@ public void testNullValue() throws IOException {\n         assertEquals(DocValuesType.SORTED_SET, dvField.fieldType().docValuesType());\n         assertEquals(new BytesRef(InetAddressPoint.encode(InetAddresses.forString(\"::1\"))), dvField.binaryValue());\n         assertFalse(dvField.fieldType().stored());\n-    }\n \n-    public void testSerializeDefaults() throws Exception {\n-        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n-            .startObject(\"properties\").startObject(\"field\").field(\"type\", \"ip\").endObject().endObject()\n-            .endObject().endObject());\n+        mapper = createDocumentMapper(fieldMapping(b -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "originalPosition": 255}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA5MjMzMw==", "bodyText": "testEmptyName and testSerializeDefaults are done as part of the parent class tests.  testMeta in the parent class discovered that IpFieldMapper wasn't correctly serializing its meta param, so the test cutover is definitely worth it!", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490092333", "createdAt": "2020-09-17T09:11:06Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/IpFieldMapperTests.java", "diffHunk": "@@ -265,33 +169,29 @@ public void testNullValue() throws IOException {\n         assertEquals(DocValuesType.SORTED_SET, dvField.fieldType().docValuesType());\n         assertEquals(new BytesRef(InetAddressPoint.encode(InetAddresses.forString(\"::1\"))), dvField.binaryValue());\n         assertFalse(dvField.fieldType().stored());\n-    }\n \n-    public void testSerializeDefaults() throws Exception {\n-        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\n-            .startObject(\"properties\").startObject(\"field\").field(\"type\", \"ip\").endObject().endObject()\n-            .endObject().endObject());\n+        mapper = createDocumentMapper(fieldMapping(b -> {\n+            b.field(\"type\", \"ip\");\n+            b.nullField(\"null_value\");\n+        }));\n \n-        DocumentMapper docMapper = parser.parse(\"type\", new CompressedXContent(mapping));\n-        IpFieldMapper mapper = (IpFieldMapper)docMapper.root().getMapper(\"field\");\n-        XContentBuilder builder = XContentFactory.jsonBuilder().startObject();\n-        mapper.doXContentBody(builder, true, ToXContent.EMPTY_PARAMS);\n-        String got = Strings.toString(builder.endObject());\n+        doc = mapper.parse(source(b -> b.nullField(\"field\")));\n+        assertArrayEquals(new IndexableField[0], doc.rootDoc().getFields(\"field\"));\n \n-        // it would be nice to check the entire serialized default mapper, but there are\n-        // a whole lot of bogus settings right now it picks up from calling super.doXContentBody...\n-        assertTrue(got, got.contains(\"\\\"ignore_malformed\\\":false\"));\n-    }\n+        mapper = createDocumentMapper(fieldMapping(b -> {\n+            b.field(\"type\", \"ip\");\n+            b.field(\"null_value\", \"\");\n+        }));\n \n-    public void testEmptyName() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "originalPosition": 277}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNDI0OTM4", "url": "https://github.com/elastic/elasticsearch/pull/62487#pullrequestreview-490424938", "createdAt": "2020-09-17T09:47:21Z", "commit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTo0NzoyMVrOHTaOfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwOTo0NzoyMVrOHTaOfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDExNDY4NA==", "bodyText": "nit: formatting", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490114684", "createdAt": "2020-09-17T09:47:21Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -90,14 +82,27 @@ public Builder(String name, boolean ignoreMalformedByDefault) {\n                 = Parameter.boolParam(\"ignore_malformed\", true, m -> toType(m).ignoreMalformed, ignoreMalformedByDefault);\n         }\n \n-        Builder nullValue(InetAddress nullValue) {\n+        Builder nullValue(String nullValue) {\n             this.nullValue.setValue(nullValue);\n             return this;\n         }\n \n+        private InetAddress parseNullValue() {\n+            String nullValueAsString = nullValue.getValue();\n+            if (nullValueAsString == null || Strings.isEmpty(nullValueAsString)) {\n+                return null;\n+            }\n+            try {\n+                return InetAddresses.forString(nullValueAsString);\n+            }\n+            catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "998736b83908585b1c6cf276b90ce0dc695737de"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf283cfd93a9cb04a73e609161a2ebbce2a276c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdf283cfd93a9cb04a73e609161a2ebbce2a276c", "committedDate": "2020-09-17T12:39:15Z", "message": "Only fail null_value parsing for pre-8x indexes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc6b8e57dc82c532a5a163790a79c6d273f9a75c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc6b8e57dc82c532a5a163790a79c6d273f9a75c", "committedDate": "2020-09-17T12:41:54Z", "message": "formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d995ee5cb64f0e89779c2cbb62cde65826b516a", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d995ee5cb64f0e89779c2cbb62cde65826b516a", "committedDate": "2020-09-17T13:37:14Z", "message": "fix settings for base testcase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed939be9c0b89816bc1a1e2317db362af5644653", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed939be9c0b89816bc1a1e2317db362af5644653", "committedDate": "2020-09-17T13:37:26Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/date-empty-null-value"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjY1MDI3", "url": "https://github.com/elastic/elasticsearch/pull/62487#pullrequestreview-490665027", "createdAt": "2020-09-17T14:32:49Z", "commit": {"oid": "ed939be9c0b89816bc1a1e2317db362af5644653"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDozMjo0OVrOHTlRCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDozMjo0OVrOHTlRCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI5NTU2MQ==", "bodyText": "I guess the missing \"meta\" was discovered by the test change?", "url": "https://github.com/elastic/elasticsearch/pull/62487#discussion_r490295561", "createdAt": "2020-09-17T14:32:49Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/IpFieldMapper.java", "diffHunk": "@@ -68,36 +71,48 @@ private static IpFieldMapper toType(FieldMapper in) {\n         private final Parameter<Boolean> stored = Parameter.storeParam(m -> toType(m).stored, false);\n \n         private final Parameter<Boolean> ignoreMalformed;\n-        private final Parameter<InetAddress> nullValue = new Parameter<>(\"null_value\", false, () -> null,\n-            (n, c, o) -> o == null ? null : InetAddresses.forString(o.toString()), m -> toType(m).nullValue)\n-            .setSerializer((b, f, v) -> {\n-                if (v == null) {\n-                    b.nullField(f);\n-                } else {\n-                    b.field(f, InetAddresses.toAddrString(v));\n-                }\n-            }, NetworkAddress::format)\n-            .acceptsNull();\n+        private final Parameter<String> nullValue\n+            = Parameter.stringParam(\"null_value\", false, m -> toType(m).nullValueAsString, null).acceptsNull();\n \n         private final Parameter<Map<String, String>> meta = Parameter.metaParam();\n \n         private final boolean ignoreMalformedByDefault;\n+        private final Version indexCreatedVersion;\n \n-        public Builder(String name, boolean ignoreMalformedByDefault) {\n+        public Builder(String name, boolean ignoreMalformedByDefault, Version indexCreatedVersion) {\n             super(name);\n             this.ignoreMalformedByDefault = ignoreMalformedByDefault;\n+            this.indexCreatedVersion = indexCreatedVersion;\n             this.ignoreMalformed\n                 = Parameter.boolParam(\"ignore_malformed\", true, m -> toType(m).ignoreMalformed, ignoreMalformedByDefault);\n         }\n \n-        Builder nullValue(InetAddress nullValue) {\n+        Builder nullValue(String nullValue) {\n             this.nullValue.setValue(nullValue);\n             return this;\n         }\n \n+        private InetAddress parseNullValue() {\n+            String nullValueAsString = nullValue.getValue();\n+            if (nullValueAsString == null) {\n+                return null;\n+            }\n+            try {\n+                return InetAddresses.forString(nullValueAsString);\n+            } catch (Exception e) {\n+                if (indexCreatedVersion.onOrAfter(Version.V_8_0_0)) {\n+                    throw new MapperParsingException(\"Error parsing [null_value] on field [\" + name() + \"]: \" + e.getMessage(), e);\n+                } else {\n+                    DEPRECATION_LOGGER.deprecate(\"ip_mapper_null_field\", \"Error parsing [\" + nullValue.getValue()\n+                        + \"] as IP in [null_value] on field [\" + name() + \"]); [null_value] will be ignored\");\n+                    return null;\n+                }\n+            }\n+        }\n+\n         @Override\n         protected List<Parameter<?>> getParameters() {\n-            return List.of(indexed, hasDocValues, stored, ignoreMalformed, nullValue);\n+            return List.of(indexed, hasDocValues, stored, ignoreMalformed, nullValue, meta);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed939be9c0b89816bc1a1e2317db362af5644653"}, "originalPosition": 80}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4521, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}