{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE2OTc2MzUz", "number": 64742, "title": "Do not wrap can_match searchers", "bodyText": "The can_match phase does not work with frozen indices that have document-level security enabled. Also, we should not wrap can_match searchers to reduce the load during the can_match phase.\nWe already fixed this in 7.10 or later in \n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/index/engine/Engine.java\n    \n    \n         Line 1195\n      in\n      6a92b3e\n    \n    \n    \n    \n\n        \n          \n           return CAN_MATCH_SEARCH_SOURCE.equals(source) ? searcher : wrapper.apply(searcher); \n        \n    \n  \n\n.", "createdAt": "2020-11-06T20:57:51Z", "url": "https://github.com/elastic/elasticsearch/pull/64742", "merged": true, "mergeCommit": {"oid": "0d448db1e2b4d61108846e048e304d5e8ee394e4"}, "closed": true, "closedAt": "2020-11-08T00:38:45Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdZ9RcKAH2gAyNTE2OTc2MzUzOjA0OWIwNDIyMWUzYzcwY2VjZGZhYTYxMjgwOWI4YzQwYjMyNTY2MmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdaTngkgH2gAyNTE2OTc2MzUzOmQwNzJiMmZjNWFkMTAwNWE0YzIzY2Q5ZTMyYjRiOWE2YmExNzE5NDQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "049b04221e3c70cecdfaa612809b8c40b325662f", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/049b04221e3c70cecdfaa612809b8c40b325662f", "committedDate": "2020-11-06T20:48:36Z", "message": "Do not wrap can_match searcher"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NTA5NTk1", "url": "https://github.com/elastic/elasticsearch/pull/64742#pullrequestreview-525509595", "createdAt": "2020-11-06T21:36:11Z", "commit": {"oid": "049b04221e3c70cecdfaa612809b8c40b325662f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6fed8491f74d26ce35f9ef33cfc50eeef397e85", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6fed8491f74d26ce35f9ef33cfc50eeef397e85", "committedDate": "2020-11-07T03:20:47Z", "message": "stylecheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b14cdf4f9cc3bc7bdadeeff5a4e9e01365b9688", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b14cdf4f9cc3bc7bdadeeff5a4e9e01365b9688", "committedDate": "2020-11-07T03:47:41Z", "message": "simplify"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3130b602c0e663c9e2a185cf5155d0739b512b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e3130b602c0e663c9e2a185cf5155d0739b512b", "committedDate": "2020-11-07T17:16:12Z", "message": "fix tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1NjcyOTk0", "url": "https://github.com/elastic/elasticsearch/pull/64742#pullrequestreview-525672994", "createdAt": "2020-11-07T18:47:02Z", "commit": {"oid": "2e3130b602c0e663c9e2a185cf5155d0739b512b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxODo0NzowMlrOHvJ0zQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wN1QxODo0NzowMlrOHvJ0zQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxOTIwNjA5Mw==", "bodyText": "AFAICS, this does not provoke a failure without the fix, can we somehow make it call getCoreCacheHelper? Or maybe just make the wrapper throw to proof that it is not used for the can match phase?", "url": "https://github.com/elastic/elasticsearch/pull/64742#discussion_r519206093", "createdAt": "2020-11-07T18:47:02Z", "author": {"login": "henningandersen"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/index/engine/FrozenIndexTests.java", "diffHunk": "@@ -241,6 +273,24 @@ public void testFreezePattern() throws ExecutionException, InterruptedException\n     }\n \n     public void testCanMatch() throws ExecutionException, InterruptedException, IOException {\n+        if (randomBoolean()) {\n+            readerWrapper.set(reader -> new FilterDirectoryReader(reader, new FilterDirectoryReader.SubReaderWrapper() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2e3130b602c0e663c9e2a185cf5155d0739b512b"}, "originalPosition": 84}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9581a0cd43f5c7f623c3673dd9c10a749c5911cb", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/9581a0cd43f5c7f623c3673dd9c10a749c5911cb", "committedDate": "2020-11-07T21:12:18Z", "message": "stricter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d072b2fc5ad1005a4c23cd9e32b4b9a6ba171944", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d072b2fc5ad1005a4c23cd9e32b4b9a6ba171944", "committedDate": "2020-11-07T22:50:37Z", "message": "imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1243, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}