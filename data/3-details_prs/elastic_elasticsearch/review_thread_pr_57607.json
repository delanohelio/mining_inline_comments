{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI3MjUxMTI1", "number": 57607, "reviewThreads": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMDozNDoyN1rOECgIZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTowNDowNVrOEmIUAQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxMDU5MDQ0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNFQxMDozNDoyN1rOGe_zcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xNVQyMjozNDowMVrOGkE_sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE1NTgyNw==", "bodyText": "I believe it should be omitNorms() || indexOptions() != IndexOptions.NONE", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r435155827", "createdAt": "2020-06-04T10:34:27Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -312,7 +314,21 @@ public Query regexpQuery(String value, int flags, int maxDeterminizedStates, @Nu\n             + \"] which is of type [\" + typeName() + \"]\");\n     }\n \n-    public abstract Query existsQuery(QueryShardContext context);\n+    /**\n+     * Create a query that matches any document that contains this field.\n+     * The default implementation works for most of the field types and creates a {@link DocValuesFieldExistsQuery} when doc_values\n+     * are available, otherwise a {@link NormsFieldExistsQuery} when norms are available, and in the worst case scenario it consists\n+     * of a {@link TermQuery} against the {@link FieldNamesFieldMapper}.\n+     */\n+    public Query existsQuery(QueryShardContext context) {\n+        if (hasDocValues()) {\n+            return new DocValuesFieldExistsQuery(name());\n+        } else if (omitNorms()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8336618ab9a513aa77a3dc1bfa1969de1b98572d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MDQ4Mzc2MA==", "bodyText": "I gave up on this, leaving the norms based impl where they are (it's only 3 of them). The standard impl only switches between doc_values and field_names", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r440483760", "createdAt": "2020-06-15T22:34:01Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -312,7 +314,21 @@ public Query regexpQuery(String value, int flags, int maxDeterminizedStates, @Nu\n             + \"] which is of type [\" + typeName() + \"]\");\n     }\n \n-    public abstract Query existsQuery(QueryShardContext context);\n+    /**\n+     * Create a query that matches any document that contains this field.\n+     * The default implementation works for most of the field types and creates a {@link DocValuesFieldExistsQuery} when doc_values\n+     * are available, otherwise a {@link NormsFieldExistsQuery} when norms are available, and in the worst case scenario it consists\n+     * of a {@link TermQuery} against the {@link FieldNamesFieldMapper}.\n+     */\n+    public Query existsQuery(QueryShardContext context) {\n+        if (hasDocValues()) {\n+            return new DocValuesFieldExistsQuery(name());\n+        } else if (omitNorms()) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTE1NTgyNw=="}, "originalCommit": {"oid": "8336618ab9a513aa77a3dc1bfa1969de1b98572d"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDk0MDQxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/mapper/HistogramFieldMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyMzowMFrOHUDDaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo1MzozOFrOHV-L4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzU5NQ==", "bodyText": "This looks like a bug in HistogramFieldMapper, can you open a separate issue for it? I wonder if we should revisit how we build the field names field, and maybe add something to MapperTestCase to ensure that it is always added properly.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490783595", "createdAt": "2020-09-18T08:23:00Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/mapper/HistogramFieldMapper.java", "diffHunk": "@@ -285,6 +285,8 @@ public Query existsQuery(QueryShardContext context) {\n             if (hasDocValues()) {\n                 return new DocValuesFieldExistsQuery(name());\n             } else {\n+                //TODO this field differs from all other fields as it never goes into _field_names, so the default impl would not work\n+                //though changing this is problematic for existing indices that don't have this field in _field_names?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwMDk5NQ==", "bodyText": "Hopefully the test that I added does this.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492800995", "createdAt": "2020-09-22T14:53:38Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/mapper/HistogramFieldMapper.java", "diffHunk": "@@ -285,6 +285,8 @@ public Query existsQuery(QueryShardContext context) {\n             if (hasDocValues()) {\n                 return new DocValuesFieldExistsQuery(name());\n             } else {\n+                //TODO this field differs from all other fields as it never goes into _field_names, so the default impl would not work\n+                //though changing this is problematic for existing indices that don't have this field in _field_names?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4MzU5NQ=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDk0ODA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyNDo1OVrOHUDIHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxMzo1NjoxNFrOHUOQRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA==", "bodyText": "The vector is stored in a BinaryDocValuesField, so I think this is fine.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490784798", "createdAt": "2020-09-18T08:24:59Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MDM5NA==", "bodyText": "ok but then shouldn't it pass doc_values set to true to the super class?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490790394", "createdAt": "2020-09-18T08:34:45Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5NjQ3Ng==", "bodyText": "It looks as though hasDocValues() is used exclusively for a) indexing (which should go away once everything is properly parametrized) and b) building exist queries; it's separate from isAggregatable which is used for field caps. So yes, the vector fields should probably set doc_values to true in the constructor.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490796476", "createdAt": "2020-09-18T08:45:45Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk2NzEwOA==", "bodyText": "I opened #62631 to fix this and add tests for it", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490967108", "createdAt": "2020-09-18T13:56:14Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/DenseVectorFieldMapper.java", "diffHunk": "@@ -126,6 +126,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NDc5OA=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDk1MTE0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyNTo1M1rOHUDKIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQxOToxNzoyOFrOHUZEsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg==", "bodyText": "Same as above", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490785312", "createdAt": "2020-09-18T08:25:53Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "diffHunk": "@@ -104,6 +104,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDk3MTQ0Ng==", "bodyText": "this is a bit tricky because the field is no longer supported, fielddataBuilder was removed yet there are doc_values in the index. I will figure it out", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490971446", "createdAt": "2020-09-18T14:02:55Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "diffHunk": "@@ -104,6 +104,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTE0NDM3MA==", "bodyText": "This is addressed by #62646", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491144370", "createdAt": "2020-09-18T19:17:28Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/vectors/src/main/java/org/elasticsearch/xpack/vectors/mapper/SparseVectorFieldMapper.java", "diffHunk": "@@ -104,6 +104,7 @@ public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n+            //TODO how can this work if this field never has doc_values?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NTMxMg=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDk1NzU1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "isResolved": false, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwODoyNzo0MFrOHUDOJQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQwOTo0ODo1N1rOHVIPMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ==", "bodyText": "Can you add some javadoc just to explain why we need this intermediate class?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490786341", "createdAt": "2020-09-18T08:27:40Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc5MDEzMg==", "bodyText": "I am still hoping that we don't need this class, do you have thoughts? :) I will add javadocs if we decide to keep it.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490790132", "createdAt": "2020-09-18T08:34:15Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwMTQ1Mg==", "bodyText": "I'm easy either way, I think.  It might be that adding a base class test would also act as a reminder to implementers?  Something like:\n\nbuild an existsQuery and parse a document with the relevant field\nif its a NormsFieldExistsQuery then check the doc contains a field with norms enabled\nif its a DocValuesFieldExistsQuery then check the doc contains a doc values field\nif its a TermQuery then check the doc contains a field_names field\notherwise we expect a MatchAllDocsQuery or MatchNoDocsQuery\n\nThen mapper implementations that don't actually index anything will throw an error if they don't return a MatchAllDocsQuery or MatchNoDocsQuery", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490801452", "createdAt": "2020-09-18T08:54:20Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDgwNDM0Mw==", "bodyText": "I like the idea!", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r490804343", "createdAt": "2020-09-18T08:59:10Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkxNzEwNA==", "bodyText": "I pushed an update that has a new test added to MapperTestCase for this. I think you'll have ideas around how to make it better, it still has some rough edges:\n\nbinary field is special because its exists query don't work unless the field is stored or has doc_values, we end up querying field_names even when it's not there, maybe we should change the implementation to return MatchNoDocsQuery in that case.\nwe are testing only the default settings for each field type. For this reason the inconsistency in Histogram field mapper is not currently caught. It would be nice to test the different combinations around omitNorms and hasDocValues but not all field types allow to set them which requires more specific methods to be overridden etc.\n\nI do still hope that this test is enough to not require the new base class that I added.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491917104", "createdAt": "2020-09-21T09:48:57Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ConcreteMappedFieldType.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.index.Term;\n+import org.apache.lucene.search.DocValuesFieldExistsQuery;\n+import org.apache.lucene.search.NormsFieldExistsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.search.TermQuery;\n+import org.elasticsearch.index.query.QueryShardContext;\n+\n+import java.util.Map;\n+\n+public abstract class ConcreteMappedFieldType extends MappedFieldType {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDc4NjM0MQ=="}, "originalCommit": {"oid": "ea244b88ab4d5c80757b2d81a64e3f75bbdbb121"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODQ2OTk0OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDowMzo1NVrOHVIvsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMTo1NzoyNFrOHVMgPQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTQyNg==", "bodyText": "I don't think you need to index the document, you can just look at the fields in the parsed doc?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491925426", "createdAt": "2020-09-21T10:03:55Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk4NzAwNQ==", "bodyText": "good point, thanks for raising this, will fix", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491987005", "createdAt": "2020-09-21T11:57:24Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkyNTQyNg=="}, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODUxNzU2OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoxNjoyMlrOHVJOOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNDo0NDoxMlrOHV9t9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMzI0MA==", "bodyText": "I think you can change this to just take MapperService.  Then we have the default testExistsQuery impl which calls this with a minimal mapping; and mappers which have norms or doc_values settings can then have their own tests that call this with the relevant configuration.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491933240", "createdAt": "2020-09-21T10:16:22Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {\n+            QueryShardContext queryShardContext = createQueryShardContext(mapperService);\n+            MappedFieldType fieldType = mapperService.fieldType(\"field\");\n+            assertExistsQuery(fieldType, queryShardContext, reader);\n+        });\n+        assertParseMinimalWarnings();\n+    }\n+\n+    protected void assertExistsQuery(MappedFieldType fieldType, QueryShardContext queryShardContext, IndexReader reader) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mjc5MzMzMw==", "bodyText": "this is implemented now, thanks for the tip.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492793333", "createdAt": "2020-09-22T14:44:12Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");\n+        fieldValue(builder);\n+    }\n+\n+    protected abstract void fieldValue(XContentBuilder builder) throws IOException;\n+\n+    public final void testExistsQuery() throws IOException {\n+        MapperService mapperService = createMapperService(fieldMapping(this::minimalMapping));\n+        ParsedDocument doc = mapperService.documentMapper().parse(source(this::field));\n+        withLuceneIndex(mapperService, iw -> iw.addDocument(doc.rootDoc()), reader -> {\n+            QueryShardContext queryShardContext = createQueryShardContext(mapperService);\n+            MappedFieldType fieldType = mapperService.fieldType(\"field\");\n+            assertExistsQuery(fieldType, queryShardContext, reader);\n+        });\n+        assertParseMinimalWarnings();\n+    }\n+\n+    protected void assertExistsQuery(MappedFieldType fieldType, QueryShardContext queryShardContext, IndexReader reader) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzMzI0MA=="}, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3ODU1OTAzOnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMDoyODo0MVrOHVJnOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxMToyNDoxMVrOHVLRuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg==", "bodyText": "I think the only mappers that need to override this are ones that do not extend ConcreteFieldType, so maybe we can add a check in the test and take a different branch if we know we need to do something different here?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491939642", "createdAt": "2020-09-21T10:28:41Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk1OTk2NQ==", "bodyText": "I am overriding this at the moment  in constant keyword and runtime field mapper. there are concrete field types (for instance the ones that throw when calling existsQuery) that don't subclass ConcreteFieldType, which is partly why I don't like to have that base class.\nThis method is really for the field types that should not write the field in the docs at all. Can you expand a bit on what you are suggesting, I am not sure I am getting it?", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491959965", "createdAt": "2020-09-21T11:10:26Z", "author": {"login": "javanna"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg=="}, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTk2NjkwNQ==", "bodyText": "there are concrete field types (for instance the ones that throw when calling existsQuery) that don't subclass ConcreteFieldType\n\nah ok, never mind then, I think I misunderstood what was going on", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r491966905", "createdAt": "2020-09-21T11:24:11Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperTestCase.java", "diffHunk": "@@ -53,6 +62,50 @@\n public abstract class MapperTestCase extends MapperServiceTestCase {\n     protected abstract void minimalMapping(XContentBuilder b) throws IOException;\n \n+    protected void field(XContentBuilder builder) throws IOException {\n+        builder.field(\"field\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MTkzOTY0Mg=="}, "originalCommit": {"oid": "07b114d95673b3e4ce809c4d208ad93127004251"}, "originalPosition": 37}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4NDE3NTM3OnYy", "diffSide": "RIGHT", "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTowNDowNVrOHV-tnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMlQxNTozNzoyOFrOHWAasQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ==", "bodyText": "It's annoying that neither this nor ParentJoinFieldMapper actually have tests for existsQuery, but they'll get them once we convert their test classes to MapperTestCase and it works by inspection now.", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492809629", "createdAt": "2020-09-22T15:04:05Z", "author": {"login": "romseygeek"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "diffHunk": "@@ -123,11 +121,6 @@ public Object valueForDisplay(Object value) {\n             BytesRef binaryValue = (BytesRef) value;\n             return binaryValue.utf8ToString();\n         }\n-\n-        @Override\n-        public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(name());\n-        }\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgzNTU0Mw==", "bodyText": "agreed", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492835543", "createdAt": "2020-09-22T15:34:49Z", "author": {"login": "javanna"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "diffHunk": "@@ -123,11 +121,6 @@ public Object valueForDisplay(Object value) {\n             BytesRef binaryValue = (BytesRef) value;\n             return binaryValue.utf8ToString();\n         }\n-\n-        @Override\n-        public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(name());\n-        }\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ=="}, "originalCommit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgzNzU1Mw==", "bodyText": "I opened #62774 to convert all the remaining test cases", "url": "https://github.com/elastic/elasticsearch/pull/57607#discussion_r492837553", "createdAt": "2020-09-22T15:37:28Z", "author": {"login": "romseygeek"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/mapper/ParentIdFieldMapper.java", "diffHunk": "@@ -123,11 +121,6 @@ public Object valueForDisplay(Object value) {\n             BytesRef binaryValue = (BytesRef) value;\n             return binaryValue.utf8ToString();\n         }\n-\n-        @Override\n-        public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(name());\n-        }\n     }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjgwOTYyOQ=="}, "originalCommit": {"oid": "478d270de64afb0d2c6e57186acf2124bff2e2f5"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3649, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}