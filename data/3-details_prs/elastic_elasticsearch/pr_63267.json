{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTk0ODM1", "number": 63267, "title": "Improve WriteScope in ir tree write phase", "bodyText": "This change moves loose ASM labels into the WriteScope as opposed to having these as member data on the nodes when they don't make sense for all executed phases. This adds the required scopes such as loop scope and try scope to the WriteScope to account for this.", "createdAt": "2020-10-05T17:07:40Z", "url": "https://github.com/elastic/elasticsearch/pull/63267", "merged": true, "mergeCommit": {"oid": "5b85d43cd581796461a4dd42ee7e2aaa80178e59"}, "closed": true, "closedAt": "2020-10-08T21:02:39Z", "author": {"login": "jdconrad"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMtIoegH2gAyNDk3OTk0ODM1OjBhMWI1ZWQwOTI3MDRhMWMyNWQxNTA5MjEzYjE2OTY2ZDI2M2M5YzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQncnxgH2gAyNDk3OTk0ODM1OjQ5Mzk3Zjc3ZjI2OWMwNjk0OWFmMjhkNmEwYjMzZThmNWQ2NTMwMTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a1b5ed092704a1c25d1509213b16966d263c9c1", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a1b5ed092704a1c25d1509213b16966d263c9c1", "committedDate": "2020-09-26T16:39:29Z", "message": "make location final in IRNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d62d0752fb2a99ae998fcab291c0f709bded0f5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d62d0752fb2a99ae998fcab291c0f709bded0f5", "committedDate": "2020-09-26T17:18:49Z", "message": "add scoping for script, class, and method to WriteScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712b0a8965bba0939acd0f8e73932796eddc7238", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/712b0a8965bba0939acd0f8e73932796eddc7238", "committedDate": "2020-09-26T17:36:01Z", "message": "update scope to include classwriter and methodwriter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "committedDate": "2020-09-26T17:56:22Z", "message": "move loop labels to writescope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65502b186dbd52a0c784a52a83b1fb659e3a6abc", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/65502b186dbd52a0c784a52a83b1fb659e3a6abc", "committedDate": "2020-09-26T18:22:52Z", "message": "move try/catch labels to WriteScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8d2a1f12069641171f0013205b5887c7dfcd6a", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae8d2a1f12069641171f0013205b5887c7dfcd6a", "committedDate": "2020-09-30T14:38:56Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760b9b940997249b18947d6da787d338f2a9dc38", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/760b9b940997249b18947d6da787d338f2a9dc38", "committedDate": "2020-10-05T16:36:09Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "committedDate": "2020-10-05T17:04:18Z", "message": "Merge branch 'proto' into proto2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjIyMjc0", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503222274", "createdAt": "2020-10-06T17:57:57Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1Nzo1N1rOHdTiIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxNzo1Nzo1N1rOHdTiIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MDc4Ng==", "bodyText": "This is weird.", "url": "https://github.com/elastic/elasticsearch/pull/63267#discussion_r500490786", "createdAt": "2020-10-06T17:57:57Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/CatchNode.java", "diffHunk": "@@ -96,15 +92,14 @@ protected void write(ClassWriter classWriter, MethodWriter methodWriter, WriteSc\n         methodWriter.visitVarInsn(variable.getAsmType().getOpcode(Opcodes.ISTORE), variable.getSlot());\n \n         if (blockNode != null) {\n-            blockNode.continueLabel = continueLabel;\n-            blockNode.breakLabel = breakLabel;\n-            blockNode.write(classWriter, methodWriter, writeScope);\n+            blockNode.write(writeScope.newTryScope(null, null, null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjI0MzEy", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503224312", "createdAt": "2020-10-06T18:00:27Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowMDoyN1rOHdToSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowMDoyN1rOHdToSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5MjM2Mg==", "bodyText": "Why does method stuff things into the write scope to just pull them out?  Maybe visitTryCatchBlock can take in a WriteScope?", "url": "https://github.com/elastic/elasticsearch/pull/63267#discussion_r500492362", "createdAt": "2020-10-06T18:00:27Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/CatchNode.java", "diffHunk": "@@ -96,15 +92,14 @@ protected void write(ClassWriter classWriter, MethodWriter methodWriter, WriteSc\n         methodWriter.visitVarInsn(variable.getAsmType().getOpcode(Opcodes.ISTORE), variable.getSlot());\n \n         if (blockNode != null) {\n-            blockNode.continueLabel = continueLabel;\n-            blockNode.breakLabel = breakLabel;\n-            blockNode.write(classWriter, methodWriter, writeScope);\n+            blockNode.write(writeScope.newTryScope(null, null, null));\n         }\n \n-        methodWriter.visitTryCatchBlock(begin, end, jump, variable.getAsmType().getInternalName());\n+        methodWriter.visitTryCatchBlock(\n+                writeScope.getTryBeginLabel(), writeScope.getTryEndLabel(), jump, variable.getAsmType().getInternalName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "originalPosition": 39}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjI5Mjc1", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503229275", "createdAt": "2020-10-06T18:06:52Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowNjo1MlrOHdT3PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODowNjo1MlrOHdT3PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5NjE4OA==", "bodyText": "This doesn't seem relevant to this PR.", "url": "https://github.com/elastic/elasticsearch/pull/63267#discussion_r500496188", "createdAt": "2020-10-06T18:06:52Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IRNode.java", "diffHunk": "@@ -19,15 +19,85 @@\n \n package org.elasticsearch.painless.ir;\n \n-import org.elasticsearch.painless.ClassWriter;\n import org.elasticsearch.painless.Location;\n-import org.elasticsearch.painless.MethodWriter;\n import org.elasticsearch.painless.phase.IRTreeVisitor;\n import org.elasticsearch.painless.symbol.WriteScope;\n \n+import java.util.HashMap;\n+import java.util.HashSet;\n+import java.util.Map;\n+import java.util.Set;\n+\n public abstract class IRNode {\n \n-    /* ---- begin node data ---- */\n+    /* ---- begin decorations ---- */\n+\n+    public interface IRDecoration {\n+\n+    }\n+\n+    private final Map<Class<? extends IRDecoration>, IRDecoration> decorations = new HashMap<>();\n+\n+    @SuppressWarnings(\"unchecked\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjMzNzA1", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503233705", "createdAt": "2020-10-06T18:12:20Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoxMjoyMFrOHdUEfg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoxMjoyMFrOHdUEfg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDQ5OTU4Mg==", "bodyText": "Why?", "url": "https://github.com/elastic/elasticsearch/pull/63267#discussion_r500499582", "createdAt": "2020-10-06T18:12:20Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -1727,6 +1727,7 @@ public void visitCall(ECall userCallNode, ScriptScope scriptScope) {\n             }\n \n             InvokeCallNode irInvokeCallNode = new InvokeCallNode(userCallNode.getLocation());\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjM0MzY1", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503234365", "createdAt": "2020-10-06T18:13:07Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoxMzowN1rOHdUGeA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxODoxMzowN1rOHdUGeA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDUwMDA4OA==", "bodyText": "jdoc for each of these protected constructors, just a line.", "url": "https://github.com/elastic/elasticsearch/pull/63267#discussion_r500500088", "createdAt": "2020-10-06T18:13:07Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/symbol/WriteScope.java", "diffHunk": "@@ -64,21 +66,138 @@ public int getSlot() {\n     }\n \n     protected final WriteScope parent;\n+    protected final ClassWriter classWriter;\n+    protected final MethodWriter methodWriter;\n+    protected final Label continueLabel;\n+    protected final Label breakLabel;\n+    protected final Label tryBeginLabel;\n+    protected final Label tryEndLabel;\n+    protected final Label catchesEndLabel;\n     protected final Map<String, Variable> variables = new HashMap<>();\n     protected int nextSlot;\n \n-    public WriteScope() {\n+    protected WriteScope() {\n         this.parent = null;\n+        this.classWriter = null;\n+        this.methodWriter = null;\n+        this.continueLabel = null;\n+        this.breakLabel = null;\n+        this.tryBeginLabel = null;\n+        this.tryEndLabel = null;\n+        this.catchesEndLabel = null;\n         this.nextSlot = 0;\n     }\n \n-    protected WriteScope(WriteScope parent, int nextSlot) {\n+    protected WriteScope(WriteScope parent, ClassWriter classWriter) {\n         this.parent = parent;\n-        this.nextSlot = nextSlot;\n+        this.classWriter = classWriter;\n+        this.methodWriter = parent.methodWriter;\n+        this.continueLabel = parent.continueLabel;\n+        this.breakLabel = parent.breakLabel;\n+        this.tryBeginLabel = parent.tryBeginLabel;\n+        this.tryEndLabel = parent.tryEndLabel;\n+        this.catchesEndLabel = parent.catchesEndLabel;\n+        this.nextSlot = parent.nextSlot;\n     }\n \n-    public WriteScope newScope() {\n-        return new WriteScope(this, nextSlot);\n+    protected WriteScope(WriteScope parent, MethodWriter methodWriter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzMjM0NTg0", "url": "https://github.com/elastic/elasticsearch/pull/63267#pullrequestreview-503234584", "createdAt": "2020-10-06T18:13:20Z", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "committedDate": "2020-10-08T19:53:15Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879afcac4496aa42f0d57c3485a94d11575bfe4c", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/879afcac4496aa42f0d57c3485a94d11575bfe4c", "committedDate": "2020-10-08T19:53:23Z", "message": "Merge branch 'proto' into proto2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49397f77f269c06949af28d6a0b33e8f5d653018", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/49397f77f269c06949af28d6a0b33e8f5d653018", "committedDate": "2020-10-08T20:17:35Z", "message": "response to pr comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4416, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}