{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTIzMTk3", "number": 61686, "title": "Cleanly Handle S3 SDK Exceptions in Request Counting", "bodyText": "It looks like it is possible for a request to throw an exception early\nbefore any API interaciton has happened. This can lead to the request count\nmap containing a null for the request count key.\nThe assertion is not correct and we should not NPE here\n(as that might also hide the original exception since we are running this code in\na finally block from within the S3 SDK).\nCloses #61670", "createdAt": "2020-08-30T15:09:26Z", "url": "https://github.com/elastic/elasticsearch/pull/61686", "merged": true, "mergeCommit": {"oid": "5ec4821c97f055577db797c6995feae48cf79258"}, "closed": true, "closedAt": "2020-08-31T08:07:24Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdD_mp_gH2gAyNDc1OTIzMTk3OjExMzk2MTRmM2JlODU4YjI0ODAxMTY2Y2U5NjUwMzA0ZjVlM2ViZTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEN6RmgFqTQ3ODM4OTM3Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1139614f3be858b24801166ce9650304f5e3ebe1", "committedDate": "2020-08-30T15:05:15Z", "message": "Cleanly Handle S3 SDK Exceptions in Request Counting\n\nIt looks like it is possible for a request to throw an exception early\nbefore any API interaciton has happened. This can lead to the request count\nmap containing a `null` for the request count key.\nThe assertion is not correct and we should not NPE here\n(as that might also hide the original exception since we are running this code in\na `finally` block from within the S3 SDK).\n\nCloses #61670"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4MjEzOTU5", "url": "https://github.com/elastic/elasticsearch/pull/61686#pullrequestreview-478213959", "createdAt": "2020-08-30T15:47:27Z", "commit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNTo0NzoyN1rOHJjw1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNTo0NzoyN1rOHJjw1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw==", "bodyText": "This has never happened on Cloud ever and I believe the original issue reporting this is likely some error with the credentials or an S3 SDK bug (can't reproduce it) but I still think we should log it as we really only get here if there's a problem.", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479785173", "createdAt": "2020-08-30T15:47:27Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "originalPosition": 25}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4Mzg5Mzc3", "url": "https://github.com/elastic/elasticsearch/pull/61686#pullrequestreview-478389377", "createdAt": "2020-08-31T07:42:54Z", "commit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNzo0Mjo1NVrOHJuDiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNzo0Mjo1NVrOHJuDiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk1MzgwMQ==", "bodyText": "Yes, that seems strange. I took a quick glance to the SDK code and it seems like AWSRequestMetrics is created before the request is executed \ud83e\udd14 as long as the collector is enabled for that request.", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479953801", "createdAt": "2020-08-31T07:42:55Z", "author": {"login": "fcofdez"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw=="}, "originalCommit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 34, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}