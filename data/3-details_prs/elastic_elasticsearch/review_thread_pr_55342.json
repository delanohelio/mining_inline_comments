{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0NjIyMTU4", "number": 55342, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToxNjoyM1rODyo-6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNTo0NDo0NVrODyxczw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NDI2ODU3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToxNjoyM1rOGGzpLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNlQxOToxNjoyM1rOGGzpLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTc5MDc2Nw==", "bodyText": "maybe statically import getBackingIndexName(...) for readability?", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r409790767", "createdAt": "2020-04-16T19:16:23Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexAbstraction.java", "diffHunk": "@@ -264,12 +264,15 @@ private boolean isNonEmpty(List<IndexMetadata> idxMetas) {\n         private final List<IndexMetadata> dataStreamIndices;\n         private final IndexMetadata writeIndex;\n \n-        public DataStream(org.elasticsearch.cluster.metadata.DataStream dataStream,\n-                          List<IndexMetadata> dataStreamIndices, IndexMetadata writeIndex) {\n+        public DataStream(org.elasticsearch.cluster.metadata.DataStream dataStream, List<IndexMetadata> dataStreamIndices) {\n             this.dataStream = dataStream;\n             this.dataStreamIndices = List.copyOf(dataStreamIndices);\n-            this.writeIndex = writeIndex;\n-            assert dataStreamIndices.contains(writeIndex);\n+            this.writeIndex =  dataStreamIndices.stream()\n+                .filter(index -> index.getIndex().getName().equals(\n+                    org.elasticsearch.cluster.metadata.DataStream.getBackingIndexName(dataStream.getName(), dataStream.getGeneration())))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "06a58ba709daf634db84b1b5515e087989648ab2"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTY1NTgzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwNTo0NDo0NVrOGHAqDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxMToyODo0OFrOGHKUwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAwMzk4MA==", "bodyText": "I wonder if we should simply keep this (and the IndexAbstraction.DataStream constructor) as it was, except to add an assertion that the generation we have should match the name of the last index in the list. I think we want that to hold true anyway?", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r410003980", "createdAt": "2020-04-17T05:44:45Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1384,7 +1384,7 @@ public Metadata build() {\n \n                     IndexMetadata writeIndex = backingIndices.get(backingIndices.size() - 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE1NjcwMw==", "bodyText": "I agree that the backing index list should have a defined order and that we can simplify the validation that the generation matches the last name in the list.\nIf you're also suggesting that we keep the separate writeIndex parameter on the IndexAbstraction.DataStream constructor, I don't see why that would continue to be necessary since the value for the writeIndex parameter would always be backingIndices.get(backingIndices.size() - 1)?", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r410156703", "createdAt": "2020-04-17T11:15:23Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1384,7 +1384,7 @@ public Metadata build() {\n \n                     IndexMetadata writeIndex = backingIndices.get(backingIndices.size() - 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAwMzk4MA=="}, "originalCommit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDE2MjM3MA==", "bodyText": "Ah yes, you are right, we do not need to keep that.", "url": "https://github.com/elastic/elasticsearch/pull/55342#discussion_r410162370", "createdAt": "2020-04-17T11:28:48Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/Metadata.java", "diffHunk": "@@ -1384,7 +1384,7 @@ public Metadata build() {\n \n                     IndexMetadata writeIndex = backingIndices.get(backingIndices.size() - 1);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDAwMzk4MA=="}, "originalCommit": {"oid": "4e8958a48e2b89ec4b0d0c7a18ecd0f108e9fe6d"}, "originalPosition": 2}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 969, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}