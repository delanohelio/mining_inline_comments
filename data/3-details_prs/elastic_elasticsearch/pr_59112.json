{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDg4NjAz", "number": 59112, "title": "Allow mixed usage of boolean and string when merging OIDC claims", "bodyText": "Certain OPs mix usage of boolean and string for boolean type OIDC claims. For example, the same \"email_verified\" field is presented as boolean in IdToken, but is a string of \"true\" in the response of user info. This inconsistency results in failures when we try to merge them during authorization.\nThis PR introduce a small leniency so that it will merge a boolean with a string that has value of the boolean's string representation. In another word, it will merge true with \"true\", also will merge false with \"false\", but nothing else.", "createdAt": "2020-07-07T01:36:16Z", "url": "https://github.com/elastic/elasticsearch/pull/59112", "merged": true, "mergeCommit": {"oid": "43cb283fe41858aca4c5b5451fb3982e84504694"}, "closed": true, "closedAt": "2020-07-14T09:34:28Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcybhHNAH2gAyNDQ1MDg4NjAzOjc4ZjU1ZjU1YTA3MWE4MGExNWM2NjkyOWNkOGZhYmQ4Y2QwZmUyNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc0yjzLAFqTQ0NzkzODgwMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "78f55f55a071a80a15c66929cd8fabd8cd0fe248", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/78f55f55a071a80a15c66929cd8fabd8cd0fe248", "committedDate": "2020-07-07T01:25:54Z", "message": "Support merging boolean oidc claims with mixed usage of boolean and string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62b5ed71f6d98928b1d0f958a985c4444830c408", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/62b5ed71f6d98928b1d0f958a985c4444830c408", "committedDate": "2020-07-07T01:35:16Z", "message": "retain value from idtoken"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d5727f0c5ab6657ee4c8d128e03734e37e74168", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d5727f0c5ab6657ee4c8d128e03734e37e74168", "committedDate": "2020-07-07T01:41:24Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzE5ODU2", "url": "https://github.com/elastic/elasticsearch/pull/59112#pullrequestreview-445319856", "createdAt": "2020-07-09T06:24:19Z", "commit": {"oid": "7d5727f0c5ab6657ee4c8d128e03734e37e74168"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoyNDoyMFrOGvDRHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOVQwNjoyNDoyMFrOGvDRHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTk4OTc5MA==", "bodyText": "I wonder if we should care whether they're the same logical value? We don't for other cases, but I think we should be.\nPerhaps:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                && (\"true\".equalsIgnoreCase((String)value2) || \"false\".equalsIgnoreCase((String)value2))) {\n          \n          \n            \n                                && String.valueOf(value1).equals(value2) ) {", "url": "https://github.com/elastic/elasticsearch/pull/59112#discussion_r451989790", "createdAt": "2020-07-09T06:24:20Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/oidc/OpenIdConnectAuthenticator.java", "diffHunk": "@@ -670,8 +670,18 @@ static JSONObject mergeObjects(JSONObject idToken, JSONObject userInfo) {\n             } else if (value1 instanceof JSONObject) {\n                 idToken.put(entry.getKey(), mergeObjects((JSONObject) value1, value2));\n             } else if (value1.getClass().equals(value2.getClass()) == false) {\n-                throw new IllegalStateException(\"Error merging ID token and userinfo claim value for claim [\" + entry.getKey() + \"]. \" +\n-                    \"Cannot merge [\" + value1.getClass().getName() + \"] with [\" + value2.getClass().getName() + \"]\");\n+                // A special handling for certain OPs that mix the usage of true and \"true\"\n+                // Retain value from idToken as all other primitive types\n+                if (value1 instanceof Boolean && value2 instanceof String\n+                    && (\"true\".equalsIgnoreCase((String)value2) || \"false\".equalsIgnoreCase((String)value2))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7d5727f0c5ab6657ee4c8d128e03734e37e74168"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9d312f9b23709386d433b334a9ecf3489174501", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9d312f9b23709386d433b334a9ecf3489174501", "committedDate": "2020-07-09T09:15:02Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc478c50dc390a87d4bf011d8a8e9429795e7b7d", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc478c50dc390a87d4bf011d8a8e9429795e7b7d", "committedDate": "2020-07-09T09:15:17Z", "message": "Merge remote-tracking branch 'origin/master' into es-oidc-boolean-merging-leniency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3ODQyOTA0", "url": "https://github.com/elastic/elasticsearch/pull/59112#pullrequestreview-447842904", "createdAt": "2020-07-14T07:08:22Z", "commit": {"oid": "dc478c50dc390a87d4bf011d8a8e9429795e7b7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ3OTM4ODAw", "url": "https://github.com/elastic/elasticsearch/pull/59112#pullrequestreview-447938800", "createdAt": "2020-07-14T09:24:30Z", "commit": {"oid": "dc478c50dc390a87d4bf011d8a8e9429795e7b7d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2167, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}