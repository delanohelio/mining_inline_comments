{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3OTQ5MTI0", "number": 63252, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNTo0ODo0N1rOEqYQJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNjo0MToxOFrOEqlfjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODcyOTk2OnYy", "diffSide": "RIGHT", "path": "docs/reference/settings/ml-settings.asciidoc", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNTo0ODo0N1rOHcjOOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNTo0ODo0N1rOHcjOOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTY5OTI1Ng==", "bodyText": "@szabosteve can you review this do update please. The setting has been around for a while we must have missed documenting it.", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499699256", "createdAt": "2020-10-05T15:48:47Z", "author": {"login": "davidkyle"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -100,6 +100,13 @@ dynamic setting in version 7.1. As a result, changes to its value after node\n startup are used only after every node in the cluster is running version 7.1 or\n higher. The maximum permitted value is `512`.\n \n+`xpack.ml.nightly_maintenance_requests_per_second`::", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 35}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyODc0MTAwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNTo1MToyNFrOHcjVLw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNTo1MToyNFrOHcjVLw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTcwMTAzOQ==", "bodyText": "The UI considers a message with a blank ID a system message for all jobs\nbool: {\n  should: [\n    {\n      term: {\n        job_id: '', // catch system messages\n      },\n    },\n    {\n      term: {\n        job_id: jobId, // messages for specified jobId\n      },\n    },\n  ],\n},", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499701039", "createdAt": "2020-10-05T15:51:24Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/common/notifications/AbstractAuditor.java", "diffHunk": "@@ -24,6 +24,9 @@\n \n public abstract class AbstractAuditor<T extends AbstractAuditMessage> {\n \n+    // The special ID that means the message applies to all jobs/resources.\n+    public static final String All_RESOURCES_ID = \"\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTEwMjkyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataActionTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoyOToyNVrOHcm4uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxNzoyOToyNVrOHcm4uw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTc1OTI5MQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499759291", "createdAt": "2020-10-05T17:29:25Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataActionTests.java", "diffHunk": "@@ -101,8 +110,43 @@ public void testDeleteExpiredDataIterationWithTimeout() {\n \n         Supplier<Boolean> isTimedOutSupplier = () -> (removersRemaining.getAndDecrement() <= 0);\n \n-        transportDeleteExpiredDataAction.deleteExpiredData(removers.iterator(), 1.0f, finalListener, isTimedOutSupplier, true);\n+        DeleteExpiredDataAction.Request request = new DeleteExpiredDataAction.Request(null, null);\n+        request.setJobId(\"_all\");\n+        transportDeleteExpiredDataAction.deleteExpiredData(request, removers.iterator(), 1.0f, finalListener, isTimedOutSupplier, true);\n+        assertFalse(succeeded.get());\n+\n+        verify(auditor, times(1)).warning(\"\",\n+            \"Deleting expired ML data was cancelled after the timeout period of [8h] was exceeded. \" +\n+                \"The setting [xpack.ml.nightly_maintenance_requests_per_second] \" +\n+                \"controls the deletion rate, consider increasing the value to assist in pruning old data\");\n+        verifyNoMoreInteractions(auditor);\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 66}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTU2MjY0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo0ODo1NVrOHcrYIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo0ODo1NVrOHcrYIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzMjg2NA==", "bodyText": "this should really be the request timeout OR the default max duration right?", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499832864", "createdAt": "2020-10-05T19:48:55Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "diffHunk": "@@ -164,7 +172,25 @@ void deleteExpiredData(Iterator<MlDataRemover> mlDataRemoversIterator,\n             if (haveAllPreviousDeletionsCompleted) {\n                 logger.info(\"Completed deletion of expired ML data\");\n             } else {\n-                logger.info(\"Halted deletion of expired ML data until next invocation\");\n+                if (isTimedOutSupplier.get()) {\n+                    String msg = \"Deleting expired ML data was cancelled after the timeout period of [\" +\n+                        MlDataRemover.DEFAULT_MAX_DURATION  + \"] was exceeded. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTU3MjA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo1MTo0M1rOHcrd6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo1MTo0M1rOHcrd6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzNDM0NA==", "bodyText": "There is a Strings#isAllOrWildcard(String)\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    || Strings.isAllOrWildcard(new String[]{request.getJobId()})\n          \n          \n            \n                                    || Strings.isAllOrWildcard(request.getJobId())", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499834344", "createdAt": "2020-10-05T19:51:43Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "diffHunk": "@@ -164,7 +172,25 @@ void deleteExpiredData(Iterator<MlDataRemover> mlDataRemoversIterator,\n             if (haveAllPreviousDeletionsCompleted) {\n                 logger.info(\"Completed deletion of expired ML data\");\n             } else {\n-                logger.info(\"Halted deletion of expired ML data until next invocation\");\n+                if (isTimedOutSupplier.get()) {\n+                    String msg = \"Deleting expired ML data was cancelled after the timeout period of [\" +\n+                        MlDataRemover.DEFAULT_MAX_DURATION  + \"] was exceeded. \" +\n+                        \"The setting [xpack.ml.nightly_maintenance_requests_per_second] \" +\n+                        \"controls the deletion rate, consider increasing the value to assist in pruning old data\";\n+                    logger.warn(msg);\n+\n+                    if (Strings.isNullOrEmpty(request.getJobId())\n+                        || Strings.isAllOrWildcard(new String[]{request.getJobId()})", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 104}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEyOTU3NTA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOTo1MjoyNlrOHcrfuQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQyMDo1MToyM1rOHctV9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzNDgwOQ==", "bodyText": "What would cause it to halt before completed for anything other than an expiration?", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499834809", "createdAt": "2020-10-05T19:52:26Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "diffHunk": "@@ -164,7 +172,25 @@ void deleteExpiredData(Iterator<MlDataRemover> mlDataRemoversIterator,\n             if (haveAllPreviousDeletionsCompleted) {\n                 logger.info(\"Completed deletion of expired ML data\");\n             } else {\n-                logger.info(\"Halted deletion of expired ML data until next invocation\");\n+                if (isTimedOutSupplier.get()) {\n+                    String msg = \"Deleting expired ML data was cancelled after the timeout period of [\" +\n+                        MlDataRemover.DEFAULT_MAX_DURATION  + \"] was exceeded. \" +\n+                        \"The setting [xpack.ml.nightly_maintenance_requests_per_second] \" +\n+                        \"controls the deletion rate, consider increasing the value to assist in pruning old data\";\n+                    logger.warn(msg);\n+\n+                    if (Strings.isNullOrEmpty(request.getJobId())\n+                        || Strings.isAllOrWildcard(new String[]{request.getJobId()})\n+                        || request.getExpandedJobIds() == null) {\n+                        auditor.warning(AbstractAuditor.All_RESOURCES_ID, msg);\n+                    } else {\n+                        for (String jobId : request.getExpandedJobIds()) {\n+                            auditor.warning(jobId, msg);\n+                        }\n+                    }\n+                } else {\n+                    logger.info(\"Halted deletion of expired ML data until next invocation\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTg2NTA3OA==", "bodyText": "Nothing, at the moment the data deleters will only return false on timeout. But that may not be the case forever and I didn't want to change the existing log messages too much", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r499865078", "createdAt": "2020-10-05T20:51:23Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteExpiredDataAction.java", "diffHunk": "@@ -164,7 +172,25 @@ void deleteExpiredData(Iterator<MlDataRemover> mlDataRemoversIterator,\n             if (haveAllPreviousDeletionsCompleted) {\n                 logger.info(\"Completed deletion of expired ML data\");\n             } else {\n-                logger.info(\"Halted deletion of expired ML data until next invocation\");\n+                if (isTimedOutSupplier.get()) {\n+                    String msg = \"Deleting expired ML data was cancelled after the timeout period of [\" +\n+                        MlDataRemover.DEFAULT_MAX_DURATION  + \"] was exceeded. \" +\n+                        \"The setting [xpack.ml.nightly_maintenance_requests_per_second] \" +\n+                        \"controls the deletion rate, consider increasing the value to assist in pruning old data\";\n+                    logger.warn(msg);\n+\n+                    if (Strings.isNullOrEmpty(request.getJobId())\n+                        || Strings.isAllOrWildcard(new String[]{request.getJobId()})\n+                        || request.getExpandedJobIds() == null) {\n+                        auditor.warning(AbstractAuditor.All_RESOURCES_ID, msg);\n+                    } else {\n+                        for (String jobId : request.getExpandedJobIds()) {\n+                            auditor.warning(jobId, msg);\n+                        }\n+                    }\n+                } else {\n+                    logger.info(\"Halted deletion of expired ML data until next invocation\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgzNDgwOQ=="}, "originalCommit": {"oid": "1761d2ad50b23a82141bcdebebc34940d79a9868"}, "originalPosition": 113}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzEzMDg5OTM1OnYy", "diffSide": "RIGHT", "path": "docs/reference/settings/ml-settings.asciidoc", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQwNjo0MToxOFrOHc36aQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMzoxNToxOVrOHdFz4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzODI0OQ==", "bodyText": "If I understand correctly, -1.0 means that the setting is disabled. If it's correct then I would add it to the docs.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Valid values must be greater than `0.0` or equal to `-1.0`. Defaults to `-1.0`\n          \n          \n            \n            Valid values must be greater than `0.0` or equal to `-1.0`. Defaults to `-1.0`, which means the setting is disabled.", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r500038249", "createdAt": "2020-10-06T06:41:18Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -100,6 +100,13 @@ dynamic setting in version 7.1. As a result, changes to its value after node\n startup are used only after every node in the cluster is running version 7.1 or\n higher. The maximum permitted value is `512`.\n \n+`xpack.ml.nightly_maintenance_requests_per_second`::\n+(<<cluster-update-settings,Dynamic>>) The rate at which the nightly maintenance task\n+deletes expired model snapshots and results. The setting is a proxy to the\n+[requests_per_second](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html#_throttling_delete_requests)\n+parameter used in the Delete by query requests and controls throttling.\n+Valid values must be greater than `0.0` or equal to `-1.0`. Defaults to `-1.0`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68be2da1deb97fbe039a7c9e6d90e8248873d6d2"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDI2NTk1NA==", "bodyText": "The setting is not exactly the same as the delete by query equivalent. For delete by query -1.0 means the setting is disabled. In this case -1.0 means ml performs a calculation and uses that value for requests_per_second. It is never completely disabled.\nI changed it to\nValid values must be greater than `0.0` or equal to `-1.0` where `-1.0` means a default value\nis used. Defaults to `-1.0`", "url": "https://github.com/elastic/elasticsearch/pull/63252#discussion_r500265954", "createdAt": "2020-10-06T13:15:19Z", "author": {"login": "davidkyle"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -100,6 +100,13 @@ dynamic setting in version 7.1. As a result, changes to its value after node\n startup are used only after every node in the cluster is running version 7.1 or\n higher. The maximum permitted value is `512`.\n \n+`xpack.ml.nightly_maintenance_requests_per_second`::\n+(<<cluster-update-settings,Dynamic>>) The rate at which the nightly maintenance task\n+deletes expired model snapshots and results. The setting is a proxy to the\n+[requests_per_second](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-delete-by-query.html#_throttling_delete_requests)\n+parameter used in the Delete by query requests and controls throttling.\n+Valid values must be greater than `0.0` or equal to `-1.0`. Defaults to `-1.0`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDAzODI0OQ=="}, "originalCommit": {"oid": "68be2da1deb97fbe039a7c9e6d90e8248873d6d2"}, "originalPosition": 40}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3189, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}