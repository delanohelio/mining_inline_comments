{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAzMzY2MTE0", "number": 63670, "title": "Add logging to AllocationRoutedStepTests", "bodyText": "Allocation rules can yield a deadlock, however, we can't prove the\nAllocationRoutedStepTests.testExecuteAllocateNotComplete\nflakiness comes from there (pretty sure though)\nThis PR adds logging in each test that generates the allocation rules in\nthe form of\nrunning test with routing configurations:\n\t includes: [{ogKS=BahCcncPbgvJQvXpeCg, KbINW=IHS, VJOvOsxQtBboYHqaCj=LHbPCEUEcBvm, lMUOtidZpQvqBsQjXP=HaZiuLVrefUB}]\n\t excludes: [{mjaG=AwHefuMqDryVdTKKs, mfRdkvccLotwrQUyIAXZ=AteNLfugdNJUpADSNt, eWDYApN=OFxafJ, DXS=ZjffIoJfnxBuIKz, tacSmahwMcrzuSSVxeJU=MrXwNihYWDxgd}]\n\t requires: [{OWpJuzaHmtHSYWQ=SsBQSFscCd}]\n\nto try to debug the flakiness of the test.\nRelates to #60520", "createdAt": "2020-10-14T13:16:39Z", "url": "https://github.com/elastic/elasticsearch/pull/63670", "merged": true, "mergeCommit": {"oid": "1a72a0ddf02ba841d71bcd82e726d06cdcd71ca9"}, "closed": true, "closedAt": "2020-10-27T06:45:26Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSc6XhAH2gAyNTAzMzY2MTE0OjcyZTlkOWVlNmMxMzc0OTgwYTI1NzAwOTRiY2JlOWQ5MGZkYTk4MzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWXgLcAH2gAyNTAzMzY2MTE0OjRjNGFmNGVlZTAwOWM2ZTJmOWNlZWUyMzE3NTRiODNmYmU4ZmJkNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "72e9d9ee6c1374980a2570094bcbe9d90fda9835", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/72e9d9ee6c1374980a2570094bcbe9d90fda9835", "committedDate": "2020-10-14T13:08:58Z", "message": "Tests: Remove unused expected settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60116cfade9ace418a9d6216fcf7ce8dbe32b511", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/60116cfade9ace418a9d6216fcf7ce8dbe32b511", "committedDate": "2020-10-14T13:09:56Z", "message": "Tests: log generated allocation rules used by test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1fae6f56ed3b684b595df3099bf389d52d8f5fd", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1fae6f56ed3b684b595df3099bf389d52d8f5fd", "committedDate": "2020-10-14T14:00:43Z", "message": "Merge branch 'master' into test-allocation-routed-step"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTk5NjQ2", "url": "https://github.com/elastic/elasticsearch/pull/63670#pullrequestreview-509599646", "createdAt": "2020-10-15T17:14:55Z", "commit": {"oid": "f1fae6f56ed3b684b595df3099bf389d52d8f5fd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzoxNDo1NVrOHiR_tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNzoxNDo1NVrOHiR_tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTcwODQ3MQ==", "bodyText": "We shouldn't need this function, Map.toString() already returns things in a format like {key=value, food=eggplant}", "url": "https://github.com/elastic/elasticsearch/pull/63670#discussion_r505708471", "createdAt": "2020-10-15T17:14:55Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/AllocationRoutedStepTests.java", "diffHunk": "@@ -267,11 +258,20 @@ public void testExecuteAllocateNotCompleteOnlyOneCopyAllocated() throws Exceptio\n                 .addShard(TestShardRouting.newShardRouting(new ShardId(index, 0), \"node2\", primaryOnNode1 == false,\n                         ShardRoutingState.STARTED));\n \n+\n         AllocationRoutedStep step = new AllocationRoutedStep(randomStepKey(), randomStepKey());\n+        logger.info(\"running test with routing configurations:\\n\\t includes: [{}]\\n\\t excludes: [{}]\\n\\t requires: [{}]\",\n+            mapToString(includes), mapToString(excludes), mapToString(requires));\n         assertAllocateStatus(index, 2, 0, step, existingSettings, node1Settings, node2Settings, indexRoutingTable,\n                 new ClusterStateWaitStep.Result(false, allShardsActiveAllocationInfo(0, 1)));\n     }\n \n+    private static String mapToString(Map<String, String> map) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f1fae6f56ed3b684b595df3099bf389d52d8f5fd"}, "originalPosition": 116}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee69032417371d0a36396d7d65d3e70162f5e56b", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee69032417371d0a36396d7d65d3e70162f5e56b", "committedDate": "2020-10-16T09:46:56Z", "message": "Drop `mapToString`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ea44b503dd13ccf35baf141c2b089efbc97b420", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ea44b503dd13ccf35baf141c2b089efbc97b420", "committedDate": "2020-10-26T15:15:09Z", "message": "Merge branch 'master' into test-allocation-routed-step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6f66ebcc15f3aebf3521efcbca73fa7c3b1b28b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6f66ebcc15f3aebf3521efcbca73fa7c3b1b28b", "committedDate": "2020-10-26T15:57:07Z", "message": "Merge branch 'master' into test-allocation-routed-step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c4af4eee009c6e2f9ceee231754b83fbe8fbd68", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c4af4eee009c6e2f9ceee231754b83fbe8fbd68", "committedDate": "2020-10-26T17:06:32Z", "message": "Merge branch 'master' into test-allocation-routed-step"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3946, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}