{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5Mjc0ODMw", "number": 64939, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTozNDowOFrOE3wXOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo1Nzo0NlrOE347Vg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI2ODk5NTE1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/aggregatemetric/AggregateMetricFeatureSetUsage.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTozNDowOFrOHxSSHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo0ODoyMFrOHxfhNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MTgyMg==", "bodyText": "@polyfractal I guess after this PR is merged, we should change the minimal supported version in master branch from V_8_0_0 to V_7_11_0. Right?", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521441822", "createdAt": "2020-11-11T15:34:08Z", "author": {"login": "csoulios"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/aggregatemetric/AggregateMetricFeatureSetUsage.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.aggregatemetric;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.xpack.core.XPackFeatureSet;\n+import org.elasticsearch.xpack.core.XPackField;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class AggregateMetricFeatureSetUsage extends XPackFeatureSet.Usage {\n+\n+    public AggregateMetricFeatureSetUsage(StreamInput input) throws IOException {\n+        super(input);\n+    }\n+\n+    public AggregateMetricFeatureSetUsage(boolean available, boolean enabled) {\n+        super(XPackField.AGGREGATE_METRIC, available, enabled);\n+    }\n+\n+    @Override public Version getMinimalSupportedVersion() {\n+        return Version.V_7_11_0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY1ODY3OA==", "bodyText": "Yes, I believe that is correct... we'll need to followup with a third PR in master to toggle over the BWC version.  And adjust any yaml/BWC tests as necessary too, if they had version skips added in master, etc.", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521658678", "createdAt": "2020-11-11T21:48:20Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/aggregatemetric/AggregateMetricFeatureSetUsage.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.aggregatemetric;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.xpack.core.XPackFeatureSet;\n+import org.elasticsearch.xpack.core.XPackField;\n+\n+import java.io.IOException;\n+import java.util.Objects;\n+\n+public class AggregateMetricFeatureSetUsage extends XPackFeatureSet.Usage {\n+\n+    public AggregateMetricFeatureSetUsage(StreamInput input) throws IOException {\n+        super(input);\n+    }\n+\n+    public AggregateMetricFeatureSetUsage(boolean available, boolean enabled) {\n+        super(XPackField.AGGREGATE_METRIC, available, enabled);\n+    }\n+\n+    @Override public Version getMinimalSupportedVersion() {\n+        return Version.V_7_11_0;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQ0MTgyMg=="}, "originalCommit": {"oid": "56ea6dd78606d5f833033992d96f2c9d35bc4806"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM5MTM3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/mapper-aggregate-metric/src/main/java/org/elasticsearch/xpack/aggregatemetric/AggregateMetricMapperPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo1NToyMVrOHxfuNA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo1NToyMVrOHxfuNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MjAwNA==", "bodyText": "I think we need to add a clause to check if this is running as a transport client, and not inject the plugin in that case.  See: https://github.com/elastic/elasticsearch/blob/7.x/x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/AnalyticsPlugin.java#L143\nI'm not 100 percent sure this is still necessary, but I skimmed the other 7x plugins and they seem to still have this structure so probably for the best to follow suit too :)", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521662004", "createdAt": "2020-11-11T21:55:21Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/mapper-aggregate-metric/src/main/java/org/elasticsearch/xpack/aggregatemetric/AggregateMetricMapperPlugin.java", "diffHunk": "@@ -0,0 +1,52 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.aggregatemetric;\n+\n+import org.elasticsearch.common.collect.List;\n+import org.elasticsearch.common.inject.Module;\n+import org.elasticsearch.index.mapper.Mapper;\n+import org.elasticsearch.plugins.ActionPlugin;\n+import org.elasticsearch.plugins.MapperPlugin;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.plugins.SearchPlugin;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceRegistry;\n+import org.elasticsearch.xpack.aggregatemetric.aggregations.metrics.AggregateMetricsAggregatorsRegistrar;\n+import org.elasticsearch.xpack.aggregatemetric.mapper.AggregateDoubleMetricFieldMapper;\n+import org.elasticsearch.xpack.core.XPackPlugin;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+import java.util.Map;\n+import java.util.function.Consumer;\n+\n+import static java.util.Collections.singletonMap;\n+\n+public class AggregateMetricMapperPlugin extends Plugin implements MapperPlugin, ActionPlugin, SearchPlugin {\n+\n+    public AggregateMetricMapperPlugin() {}\n+\n+    @Override\n+    public Collection<Module> createGuiceModules() {\n+        return Collections.singletonList(b -> { XPackPlugin.bindFeatureSet(b, AggregateMetricFeatureSet.class); });", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI3MDM5ODMwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/aggregate-metrics/10_basic.yml", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQyMTo1Nzo0NlrOHxfyUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNDoyOTozNlrOHx9Wjw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MzA1OA==", "bodyText": "I think we'll need to tweak the versions in all these yaml tests, right?", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521663058", "createdAt": "2020-11-11T21:57:46Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/aggregate-metrics/10_basic.yml", "diffHunk": "@@ -0,0 +1,292 @@\n+---\n+\"Test exists query on aggregate metric field\":\n+  - skip:\n+      version: \" - 7.99.99\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTk5MDMxMQ==", "bodyText": "Good catch. I totally missed that. Thanks!", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r521990311", "createdAt": "2020-11-12T10:13:58Z", "author": {"login": "csoulios"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/aggregate-metrics/10_basic.yml", "diffHunk": "@@ -0,0 +1,292 @@\n+---\n+\"Test exists query on aggregate metric field\":\n+  - skip:\n+      version: \" - 7.99.99\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MzA1OA=="}, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjE0NzQ3MQ==", "bodyText": "I only remember to check because I've forgotten do this many times :)", "url": "https://github.com/elastic/elasticsearch/pull/64939#discussion_r522147471", "createdAt": "2020-11-12T14:29:36Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/aggregate-metrics/10_basic.yml", "diffHunk": "@@ -0,0 +1,292 @@\n+---\n+\"Test exists query on aggregate metric field\":\n+  - skip:\n+      version: \" - 7.99.99\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTY2MzA1OA=="}, "originalCommit": {"oid": "e7312ae67634f8eff94b74357c7084894fbbb3b3"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2952, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}