{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ1MDM5NzAw", "number": 59106, "title": "Validate Data Streams reference a template on composable template update", "bodyText": "This commit adds validation that when a composable index template is updated, that the number\nof unreferenced data streams does not increase. While it is still possible to have data streams\nwithout a backing template (through snapshot restoration), this reduces the chance of getting\nin to that scenario.\nRelates to #53100", "createdAt": "2020-07-06T22:49:50Z", "url": "https://github.com/elastic/elasticsearch/pull/59106", "merged": true, "mergeCommit": {"oid": "ba1df5ab7680c51c1e8b89e946a13a178609a28a"}, "closed": true, "closedAt": "2020-07-07T20:38:15Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyZN3YAH2gAyNDQ1MDM5NzAwOmM5MzQ2Zjg0MDg1Nzk1OTVmNTcxNTQ5YzQ5MWM5YzUyMDAxM2Y4N2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyoZWLgH2gAyNDQ1MDM5NzAwOjE5OTUyMzVlNWE5NGU3NjViMzlkNzYzN2UwYmFkOTg3MWY1NzRhYmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c9346f8408579595f571549c491c9c520013f87b", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9346f8408579595f571549c491c9c520013f87b", "committedDate": "2020-07-06T22:45:04Z", "message": "Validate Data Streams reference a template on composable template update\n\nThis commit adds validation that when a composable index template is updated, there are no data\nstreams that are unreferenced by templates. While it is still possible to have data streams without\na backing template (through snapshot restoration), this reduces the chance of getting in to that\nscenario.\n\nRelates to #53100"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjAyMDU3", "url": "https://github.com/elastic/elasticsearch/pull/59106#pullrequestreview-443602057", "createdAt": "2020-07-07T06:42:30Z", "commit": {"oid": "c9346f8408579595f571549c491c9c520013f87b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNzA3MDc0", "url": "https://github.com/elastic/elasticsearch/pull/59106#pullrequestreview-443707074", "createdAt": "2020-07-07T09:11:56Z", "commit": {"oid": "c9346f8408579595f571549c491c9c520013f87b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzODM3Nzg4", "url": "https://github.com/elastic/elasticsearch/pull/59106#pullrequestreview-443837788", "createdAt": "2020-07-07T12:24:27Z", "commit": {"oid": "c9346f8408579595f571549c491c9c520013f87b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df9a48af23ce2fd5716ee4b78842bb473881be85", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/df9a48af23ce2fd5716ee4b78842bb473881be85", "committedDate": "2020-07-07T15:50:55Z", "message": "Only throw exception when number of unreferenced data streams increases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91dc38d378946036bccea6d6a0644bc57e5e7bc4", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/91dc38d378946036bccea6d6a0644bc57e5e7bc4", "committedDate": "2020-07-07T16:03:10Z", "message": "Merge branch 'master' into ds-validate-data-stream-still-referenced"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDQ1MjA2", "url": "https://github.com/elastic/elasticsearch/pull/59106#pullrequestreview-444045206", "createdAt": "2020-07-07T16:13:07Z", "commit": {"oid": "91dc38d378946036bccea6d6a0644bc57e5e7bc4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoxMzowN1rOGuF0PA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoxMzowN1rOGuF0PA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4Mjk3Mg==", "bodyText": "maybe add a unit test that tests with a cluster state with no templates, but a few data streams and then\nadding a template shoudl still work. This to simulate the restore scenario?", "url": "https://github.com/elastic/elasticsearch/pull/59106#discussion_r450982972", "createdAt": "2020-07-07T16:13:07Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateServiceTests.java", "diffHunk": "@@ -1062,6 +1064,83 @@ public void testPutExistingComposableTemplateIsNoop() throws Exception {\n         assertThat(metadataIndexTemplateService.addIndexTemplateV2(state, false, \"foo\", template), equalTo(state));\n     }\n \n+    public void testUnreferencedDataStreamsWhenAddingTemplate() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "91dc38d378946036bccea6d6a0644bc57e5e7bc4"}, "originalPosition": 20}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0MDUzMDY2", "url": "https://github.com/elastic/elasticsearch/pull/59106#pullrequestreview-444053066", "createdAt": "2020-07-07T16:22:41Z", "commit": {"oid": "df9a48af23ce2fd5716ee4b78842bb473881be85"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoyMjo0MVrOGuGLkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QxNjoyMjo0MVrOGuGLkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDk4ODk0Nw==", "bodyText": "If we read the data streams inside this function we can make it static. What do you think?", "url": "https://github.com/elastic/elasticsearch/pull/59106#discussion_r450988947", "createdAt": "2020-07-07T16:22:41Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -520,35 +521,43 @@ public ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n      */\n     private static void validateDataStreamsStillReferenced(ClusterState state, String templateName,\n                                                            ComposableIndexTemplate newTemplate) {\n-\n         final Set<String> dataStreams = state.metadata().dataStreams().keySet();\n \n-        // Generate a metadata as if the new template were actually in the cluster state\n-        final Metadata metadataWithoutTemplate = Metadata.builder(state.metadata()).put(templateName, newTemplate).build();\n-        final Set<String> dataStreamsWithoutTemplates = new HashSet<>();\n-        // For each data stream that we have, see whether it's covered by a different\n-        // template (which is great), or whether it's now uncovered by any template\n-        for (String dataStream : dataStreams) {\n-            final String matchingTemplate = findV2Template(metadataWithoutTemplate, dataStream, false);\n-            if (matchingTemplate == null) {\n-                dataStreamsWithoutTemplates.add(dataStream);\n-            } else {\n-                // We found a template that still matches, great! Buuuuttt... check whether it\n-                // is a data stream template, as it's only useful if it has a data stream definition\n-                if (metadataWithoutTemplate.templatesV2().get(matchingTemplate).getDataStreamTemplate() == null) {\n-                    dataStreamsWithoutTemplates.add(dataStream);\n+        Function<Metadata, Set<String>> findUnreferencedDataStreams = meta -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "df9a48af23ce2fd5716ee4b78842bb473881be85"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1995235e5a94e765b39d7637e0bad9871f574abe", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/1995235e5a94e765b39d7637e0bad9871f574abe", "committedDate": "2020-07-07T16:26:11Z", "message": "Re-organize test so that an existing unreferenced template is present\n\nWhen adding first template"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2340, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}