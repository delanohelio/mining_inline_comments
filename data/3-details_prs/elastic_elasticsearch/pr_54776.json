{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5MjQ0ODAx", "number": 54776, "title": "Fix scripted metric in ccs", "bodyText": "scripted_metric did not work with cross cluster search because it\nassumed that you'd never perform a partial reduction, serialize the\nresults, and then perform a final reduction. That\nserialized-after-partial-reduction step was broken.\nThis is also required to support #54758.", "createdAt": "2020-04-05T21:09:02Z", "url": "https://github.com/elastic/elasticsearch/pull/54776", "merged": true, "mergeCommit": {"oid": "171464626cfe34a8714eae9558c8ca5de5b263f7"}, "closed": true, "closedAt": "2020-04-07T12:44:10Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcUwpLHgH2gAyMzk5MjQ0ODAxOjk5ZWJkMTNlNGI0MmY3OTc3ZmYxOWI5NTY4NTY2YjMwZDAxOWRjNmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVE6dfAH2gAyMzk5MjQ0ODAxOmY1MjVkNGNlYzMzM2I1ZTE1NTc1NWY2N2U3MzFjOGVhYTVjZjZkN2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/99ebd13e4b42f7977ff19b9568566b30d019dc6b", "committedDate": "2020-04-05T21:04:59Z", "message": "Fix scripted metric in ccs\n\n`scripted_metric` did not work with cross cluster search because it\nassumed that you'd never perform a partial reduction, serialize the\nresults, and then perform a final reduction. That\nserialized-after-partial-reduction step was broken.\n\nThis is also required to support #54758."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg4MDc2Mjk5", "url": "https://github.com/elastic/elasticsearch/pull/54776#pullrequestreview-388076299", "createdAt": "2020-04-06T09:26:11Z", "commit": {"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQwOToyNjoxMVrOGBPI5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxNDo1OTowNlrOGBb9Qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMzk0OTc5Ng==", "bodyText": "let's use the new format for total hits ?", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r403949796", "createdAt": "2020-04-06T09:26:11Z", "author": {"login": "jimczi"}, "path": "qa/multi-cluster-search/src/test/resources/rest-api-spec/test/multi_cluster/10_basic.yml", "diffHunk": "@@ -196,6 +196,45 @@\n   - match: { aggregations.cluster.buckets.1.animal.buckets.1.s.value: 0 }\n   - match: { aggregations.cluster.buckets.1.average_sum.value: 1 }\n \n+  # scripted_metric\n+  - do:\n+      search:\n+        rest_total_hits_as_int: true", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1ODk1Nw==", "bodyText": "nit: a partial reduce", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r404158957", "createdAt": "2020-04-06T14:58:07Z", "author": {"login": "jimczi"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -296,7 +296,7 @@ public void testReduceRandom() {\n         ScriptService mockScriptService = mockScriptService();\n         MockBigArrays bigArrays = new MockBigArrays(new MockPageCacheRecycler(Settings.EMPTY), new NoneCircuitBreakerService());\n         if (randomBoolean() && toReduce.size() > 1) {\n-            // sometimes do an incremental reduce\n+            // sometimes do an partial reduce", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDE1OTgxMA==", "bodyText": "Should it simply say that we test the serialization of partially reduced result since you have another change that will make this possible in normal search ?", "url": "https://github.com/elastic/elasticsearch/pull/54776#discussion_r404159810", "createdAt": "2020-04-06T14:59:06Z", "author": {"login": "jimczi"}, "path": "test/framework/src/main/java/org/elasticsearch/test/InternalAggregationTestCase.java", "diffHunk": "@@ -312,6 +312,13 @@ public void testReduceRandom() {\n             //check that non final reduction never adds buckets\n             assertThat(reducedBucketCount, lessThanOrEqualTo(initialBucketCount));\n             toReduce = new ArrayList<>(toReduce.subList(r, toReduceSize));\n+            /*\n+             * sometimes simulate cross cluster search by serializing and\n+             * deserializing the partially reduced result.\n+             */", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "99ebd13e4b42f7977ff19b9568566b30d019dc6b"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "89439f9540542c7eaaa5d2dc8b9e3d72498df33b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/89439f9540542c7eaaa5d2dc8b9e3d72498df33b", "committedDate": "2020-04-06T15:33:32Z", "message": "itr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2906175c8970168bb8354c31b385d7cbf23aefdf", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2906175c8970168bb8354c31b385d7cbf23aefdf", "committedDate": "2020-04-06T20:30:56Z", "message": "Merge branch 'master' into ccs_scripted_metric"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f525d4cec333b5e155755f67e731c8eaa5cf6d7e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f525d4cec333b5e155755f67e731c8eaa5cf6d7e", "committedDate": "2020-04-06T20:41:58Z", "message": "Sneaky"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3861, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}