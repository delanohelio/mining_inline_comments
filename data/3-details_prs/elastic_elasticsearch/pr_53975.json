{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyMzgzNzU3", "number": 53975, "title": "CacheBufferedIndexInput should throw EOFException", "bodyText": "InputStream#read may return -1 if it reaches EOF. This is unexpected in a\nCacheBufferedIndexInput but may happen if, for instance, the underlying file\nis truncated. Today we don't handle this specially and an EOF can cause strange\nbehaviour, often throwing an ArrayIndexOutOfBoundsException. This commit adds\nbetter handling for EOF by throwing an EOFException.", "createdAt": "2020-03-23T13:26:15Z", "url": "https://github.com/elastic/elasticsearch/pull/53975", "merged": true, "mergeCommit": {"oid": "47ec08d3d8d3cf6a94d80ccb6f46907630e95e69"}, "closed": true, "closedAt": "2020-03-25T09:12:11Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQeOw-gH2gAyMzkyMzgzNzU3OmI2Y2E3ZGJhMzI2ZTVjMzUyZDhlNWZhMjEyMjM1ODhkODFlMWJlNWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRCz5_AFqTM4MDkyMDc1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6ca7dba326e5c352d8e5fa21223588d81e1be5a", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6ca7dba326e5c352d8e5fa21223588d81e1be5a", "committedDate": "2020-03-23T13:22:09Z", "message": "CacheBufferedIndexInput should throw EOFException\n\nInputStream#read may return -1 if it reaches EOF. This is unexpected in a\n`CacheBufferedIndexInput` but may happen if, for instance, the underlying file\nis truncated. Today we don't handle this specially and an EOF can cause strange\nbehaviour, often throwing an `ArrayIndexOutOfBoundsException`. This commit adds\nbetter handling for EOF by throwing an `EOFException`."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NDI1NjU4", "url": "https://github.com/elastic/elasticsearch/pull/53975#pullrequestreview-379425658", "createdAt": "2020-03-23T13:27:12Z", "commit": {"oid": "b6ca7dba326e5c352d8e5fa21223588d81e1be5a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzoyNzoxMlrOF6FTFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxMzoyNzoxMlrOF6FTFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjQ0ODUzMg==", "bodyText": "Replaces len with bytesRead in case of a partial read. I think this was technically ok before since we would proceed to overwrite the junk bytes with correct ones, but it was confusing.", "url": "https://github.com/elastic/elasticsearch/pull/53975#discussion_r396448532", "createdAt": "2020-03-23T13:27:12Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -214,7 +219,11 @@ private int readDirectly(long start, long end, byte[] buffer, int offset) throws\n             while (remaining > 0) {\n                 final int len = (remaining < copyBuffer.length) ? (int) remaining : copyBuffer.length;\n                 int bytesRead = input.read(copyBuffer, 0, len);\n-                System.arraycopy(copyBuffer, 0, buffer, offset + bytesCopied, len);\n+                if (bytesRead == -1) {\n+                    throw new EOFException(String.format(Locale.ROOT,\n+                        \"unexpected EOF reading [%d-%d] ([%d] bytes remaining) from %s\", start, end, remaining, cacheFileReference));\n+                }\n+                System.arraycopy(copyBuffer, 0, buffer, offset + bytesCopied, bytesRead);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6ca7dba326e5c352d8e5fa21223588d81e1be5a"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwOTIwNzUz", "url": "https://github.com/elastic/elasticsearch/pull/53975#pullrequestreview-380920753", "createdAt": "2020-03-25T07:59:18Z", "commit": {"oid": "b6ca7dba326e5c352d8e5fa21223588d81e1be5a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1778, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}