{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1OTIzMTk3", "number": 61686, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNTo0NzoyN1rOEeFKmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNTo0NzoyN1rOEeFKmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk5OTc3MzY4OnYy", "diffSide": "RIGHT", "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMFQxNTo0NzoyN1rOHJjw1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0zMVQwNzo1NTo1MFrOHJudBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw==", "bodyText": "This has never happened on Cloud ever and I believe the original issue reporting this is likely some error with the credentials or an S3 SDK bug (can't reproduce it) but I still think we should log it as we really only get here if there's a problem.", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479785173", "createdAt": "2020-08-30T15:47:27Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk1MzgwMQ==", "bodyText": "Yes, that seems strange. I took a quick glance to the SDK code and it seems like AWSRequestMetrics is created before the request is executed \ud83e\udd14 as long as the collector is enabled for that request.", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479953801", "createdAt": "2020-08-31T07:42:55Z", "author": {"login": "fcofdez"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw=="}, "originalCommit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTk2MDMyNg==", "bodyText": "seems like AWSRequestMetrics is created before the request is executed thinking\n\nThe problem is that the counter is only there if an actual request was executed. Now if there is some bug (like we had before with an NPE in some URL utility method in the SDK) or legitmate exception (maybe from auth/signing) before that we never get the expected counter itself.", "url": "https://github.com/elastic/elasticsearch/pull/61686#discussion_r479960326", "createdAt": "2020-08-31T07:55:50Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobStore.java", "diffHunk": "@@ -105,8 +109,10 @@ public void collectMetrics(Request<?> request, Response<?> response) {\n     private long getRequestCount(Request<?> request) {\n         Number requestCount = request.getAWSRequestMetrics().getTimingInfo()\n             .getCounter(AWSRequestMetrics.Field.RequestCount.name());\n-        assert requestCount != null;\n-\n+        if (requestCount == null) {\n+            logger.warn(\"Expected request count to be tracked for request [{}] but found not count.\", request);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3OTc4NTE3Mw=="}, "originalCommit": {"oid": "1139614f3be858b24801166ce9650304f5e3ebe1"}, "originalPosition": 25}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1868, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}