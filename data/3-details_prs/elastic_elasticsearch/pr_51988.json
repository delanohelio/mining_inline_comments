{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxODE0ODYx", "number": 51988, "title": "Don't allow null User.principal", "bodyText": "Some parts of the User class (e.g. equals/hashCode) assumed that\nprincipal could never be null, but the constructor didn't enforce\nthat.\nThis adds a null check into the constructor and fixes a few tests that\nrelied on being able to pass in null usernames.", "createdAt": "2020-02-06T10:14:42Z", "url": "https://github.com/elastic/elasticsearch/pull/51988", "merged": true, "mergeCommit": {"oid": "3c94f805d8fbc53863e5b916f04a54c625ab5756"}, "closed": true, "closedAt": "2020-02-07T06:15:02Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBn7tDgH2gAyMzcxODE0ODYxOjVkNDMzNjQzYTc2OWQwOTQ4Yzg5NjliMmJjNzhkZjI3ODIxMDg2M2Q=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB44OPAFqTM1NDk0MzI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d433643a769d0948c8969b2bc78df278210863d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d433643a769d0948c8969b2bc78df278210863d", "committedDate": "2020-02-06T10:11:31Z", "message": "Don't allow null User.principal\n\nSome parts of the User class (e.g. equals/hashCode) assumed that\nprincipal could never be null, but the constructor didn't enforce\nthat.\n\nThis adds a null check into the constructor and fixes a few tests that\nrelied on being able to pass in null usernames."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4893d81dcd138b4b47f1015a0ab908e2c51efee5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4893d81dcd138b4b47f1015a0ab908e2c51efee5", "committedDate": "2020-02-07T04:39:18Z", "message": "Merge branch 'master' into null-principal-user"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0OTQzMjk0", "url": "https://github.com/elastic/elasticsearch/pull/51988#pullrequestreview-354943294", "createdAt": "2020-02-07T05:53:30Z", "commit": {"oid": "4893d81dcd138b4b47f1015a0ab908e2c51efee5"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNTo1MzozMFrOFmy8dw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwNTo1NTozOFrOFmy-Aw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNDg4Nw==", "bodyText": "(need a mock, because a real user cannot have a null username)\n\nCould we just remove this test case instead?", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376224887", "createdAt": "2020-02-07T05:53:30Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessorTests.java", "diffHunk": "@@ -42,15 +43,21 @@ public void testProcessor() throws Exception {\n         assertThat(result.get(\"email\"), equalTo(\"_email\"));\n         assertThat(((Map) result.get(\"metadata\")).size(), equalTo(1));\n         assertThat(((Map) result.get(\"metadata\")).get(\"key\"), equalTo(\"value\"));\n+    }\n \n-        // test when user holds no data:\n-        threadContext = new ThreadContext(Settings.EMPTY);\n-        user = new User(null, null, null);\n-        threadContext.putTransient(AuthenticationField.AUTHENTICATION_KEY, new Authentication(user, realmRef, null));\n-        ingestDocument = new IngestDocument(new HashMap<>(), new HashMap<>());\n-        processor = new SetSecurityUserProcessor(\"_tag\", threadContext, \"_field\", EnumSet.allOf(Property.class));\n+    public void testProcessorWithEmptyUserData() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4893d81dcd138b4b47f1015a0ab908e2c51efee5"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjIyNTI4Mw==", "bodyText": "nit: I hate when I get NPE in a line that has many calls and it's not quite obvious what threw it so I prefer to add a message to requireNotNull. Not sure if this is worth rerunning CI here though, just a suggestion", "url": "https://github.com/elastic/elasticsearch/pull/51988#discussion_r376225283", "createdAt": "2020-02-07T05:55:38Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/User.java", "diffHunk": "@@ -49,7 +50,7 @@ public User(String username, String[] roles, String fullName, String email, Map<\n \n     private User(String username, String[] roles, String fullName, String email, Map<String, Object> metadata, boolean enabled,\n                 User authenticatedUser) {\n-        this.username = username;\n+        this.username = Objects.requireNonNull(username);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4893d81dcd138b4b47f1015a0ab908e2c51efee5"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2871, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}