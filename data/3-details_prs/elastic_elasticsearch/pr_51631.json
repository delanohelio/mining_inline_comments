{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NjY4NzU2", "number": 51631, "title": "Stop policy on last PhaseCompleteStep instead of TerminalPolic\u2026", "bodyText": "Currently when an ILM policy finishes its execution, the index moves into the TerminalPolicyStep,\ndenoted by a completed/completed/completed phase/action/step lifecycle execution state.\nThis commit changes the behavior so that the index lifecycle execution state halts at the last\nconfigured phase's PhaseCompleteStep, so for instance, if an index were configured with a policy\ncontaining a hot and cold phase, the index would stop at the cold/complete/complete\nPhaseCompleteStep. This allows an ILM user to update the policy to add any later phases and have\nindices configured to use that policy pick up execution at the newly added \"later\" phase. For\nexample, if a delete phase were added to the policy specified about, the index would then move\nfrom cold/complete/complete into the delete phase.\nRelates to #48431", "createdAt": "2020-01-29T17:05:40Z", "url": "https://github.com/elastic/elasticsearch/pull/51631", "merged": true, "mergeCommit": {"oid": "189ceb2983e66733303155679e3d3a43c1aa9d3c"}, "closed": true, "closedAt": "2020-01-31T16:27:57Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_I_yIAH2gAyMzY4NjY4NzU2OjNhZGYzYzc4MzY0M2RjOTA2ZmI1ODVmMjg1MmE2YjFlODIyYWI5Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_staZgFqTM1MTQxOTc3Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/3adf3c783643dc906fb585f2852a6b1e822ab9b7", "committedDate": "2020-01-29T17:01:04Z", "message": "Stop policy on last PhaseCompleteStep instead of TerminalPolicyStep\n\nCurrently when an ILM policy finishes its execution, the index moves into the `TerminalPolicyStep`,\ndenoted by a completed/completed/completed phase/action/step lifecycle execution state.\n\nThis commit changes the behavior so that the index lifecycle execution state halts at the last\nconfigured phase's `PhaseCompleteStep`, so for instance, if an index were configured with a policy\ncontaining a `hot` and `cold` phase, the index would stop at the `cold/complete/complete`\n`PhaseCompleteStep`. This allows an ILM user to update the policy to add any later phases and have\nindices configured to use that policy pick up execution at the newly added \"later\" phase. For\nexample, if a `delete` phase were added to the policy specified about, the index would then move\nfrom `cold/complete/complete` into the `delete` phase.\n\nRelates to #48431"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzAwMjE1", "url": "https://github.com/elastic/elasticsearch/pull/51631#pullrequestreview-350700215", "createdAt": "2020-01-30T09:58:23Z", "commit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQwOTo1ODoyM1rOFjlOAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQxMToxNjoxN1rOFjnfHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg1NDI3NA==", "bodyText": "nice catch", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372854274", "createdAt": "2020-01-30T09:58:23Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/ExecuteStepsUpdateTask.java", "diffHunk": "@@ -140,7 +140,7 @@ public ClusterState execute(final ClusterState currentState) throws IOException\n                         if (logger.isTraceEnabled()) {\n                             logger.trace(\"[{}] condition not met ({}) [{}], returning existing state (info: {})\",\n                                 index.getName(), currentStep.getClass().getSimpleName(), currentStep.getKey(),\n-                                Strings.toString(stepInfo));\n+                                stepInfo == null ? \"null\" : Strings.toString(stepInfo));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NjE5OA==", "bodyText": "I'm probably missing something, but why is the phase null in these CCR cases? Should this be the name of the phase that was completed? (ie. warm)", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372886198", "createdAt": "2020-01-30T11:04:09Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/qa/multi-cluster/src/test/java/org/elasticsearch/xpack/ilm/CCRIndexLifecycleIT.java", "diffHunk": "@@ -341,7 +342,7 @@ public void testAliasReplicatedOnShrink() throws Exception {\n             assertBusy(() -> assertOK(client().performRequest(new Request(\"HEAD\", \"/\" + shrunkenIndexName + \"/_alias/\" + indexName))));\n \n             // Wait for the index to complete its policy\n-            assertBusy(() -> assertILMPolicy(client(), shrunkenIndexName, policyName, \"completed\", \"completed\", \"completed\"));\n+            assertBusy(() -> assertILMPolicy(client(), shrunkenIndexName, policyName, null, \"complete\", \"complete\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg4NzAwOA==", "bodyText": "should we document this as it seems like a behavioural change for the move-to-step api?", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372887008", "createdAt": "2020-01-30T11:06:00Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycleTransition.java", "diffHunk": "@@ -78,7 +78,8 @@ public static void validateTransition(IndexMetaData idxMeta, Step.StepKey curren\n                 \"], currently: [\" + realKey + \"]\");\n         }\n \n-        if (stepRegistry.stepExists(indexPolicySetting, newStepKey) == false) {\n+        // Always allow moving to the terminal step, even if it doesn't exist in the policy", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Mjg5MTQyMA==", "bodyText": "was the deletion of this test intentional? if so shall we do it in a different commit so we have some semantics as to why it was removed?", "url": "https://github.com/elastic/elasticsearch/pull/51631#discussion_r372891420", "createdAt": "2020-01-30T11:16:17Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/ilm/IndexLifecycleInitialisationTests.java", "diffHunk": "@@ -374,80 +374,7 @@ public void testMasterDedicatedDataDedicated() throws Exception {\n         assertBusy(() -> {\n             LifecycleExecutionState lifecycleState = LifecycleExecutionState.fromIndexMetadata(client().admin().cluster()\n                 .prepareState().execute().actionGet().getState().getMetaData().index(\"test\"));\n-            assertThat(lifecycleState.getStep(), equalTo(TerminalPolicyStep.KEY.getName()));\n-        });\n-    }\n-\n-    public void testMasterFailover() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMTg3ODMx", "url": "https://github.com/elastic/elasticsearch/pull/51631#pullrequestreview-351187831", "createdAt": "2020-01-30T22:30:27Z", "commit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNDE5Nzcz", "url": "https://github.com/elastic/elasticsearch/pull/51631#pullrequestreview-351419773", "createdAt": "2020-01-31T10:37:35Z", "commit": {"oid": "3adf3c783643dc906fb585f2852a6b1e822ab9b7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3050, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}