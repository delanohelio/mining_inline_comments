{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgzOTk3NjE4", "number": 53144, "title": "Simplify SiblingPipelineAggregator", "bodyText": "This removes the instanceofs from SiblingPipelineAggregator by\nadding a rewriteBuckets method to InternalAggregation that can be\ncalled to, well, rewrite the buckets. The default implementation of\nrewriteBuckets throws the same exception that was thrown when you\nattempted to run a SiblingPipelineAggregator on an aggregation without\nbuckets. It is overridden by InternalSingleBucketAggregation and\nInternalMultiBucketAggregation to correctly rewrite their buckets.", "createdAt": "2020-03-05T00:18:48Z", "url": "https://github.com/elastic/elasticsearch/pull/53144", "merged": true, "mergeCommit": {"oid": "365b494934990746a2f44e1b2e54e2d4cf166f75"}, "closed": true, "closedAt": "2020-03-10T14:03:14Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKe_zZAH2gAyMzgzOTk3NjE4OmZkN2M3MjVhOTEwM2FkOGI2NTk1N2Y4MjcwODk2MGJkYTVkZjVmNWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMDFt6AFqTM3MTQ2NzQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fd7c725a9103ad8b65957f82708960bda5df5f5e", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd7c725a9103ad8b65957f82708960bda5df5f5e", "committedDate": "2020-03-04T22:52:10Z", "message": "Simplify SiblingPipelineAggregator\n\nThis removes the `instanceof`s from `SiblingPipelineAggregator` by\nadding a `rewriteBuckets` method to `InternalAggregation` that can be\ncalled to, well, rewrite the buckets. The default implementation of\n`rewriteBuckets` throws the same exception that was thrown when you\nattempted to run a `SiblingPipelineAggregator` on an aggregation without\nbuckets. It is overridden by `InternalSingleBucketAggregation` and\n`InternalMultiBucketAggregation` to correctly rewrite their buckets."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ae0c9d533f7c6b4969c5ef09e7f9ca137b4f8d8", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ae0c9d533f7c6b4969c5ef09e7f9ca137b4f8d8", "committedDate": "2020-03-05T00:18:57Z", "message": "Revert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4cd44217a9922aa3ba2a98790c0299d08152d6a2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cd44217a9922aa3ba2a98790c0299d08152d6a2", "committedDate": "2020-03-05T00:24:10Z", "message": "Ooops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfc9c2c9cafdf9c77e6c15447a26652a7978c72b", "committedDate": "2020-03-05T11:52:44Z", "message": "Merge branch 'master' into untwist_aggs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5Njc0NTgz", "url": "https://github.com/elastic/elasticsearch/pull/53144#pullrequestreview-369674583", "createdAt": "2020-03-05T15:37:54Z", "commit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNTozNzo1NFrOFyYfpA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNjo0MjowM1rOFybLnw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM3NDQzNg==", "bodyText": "I believe this only skips sibling pipeline aggs?  E.g. \"child\" pipeline aggs (those that extend PipelineAggregator directly) will be included in the internal agg list, iirc", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388374436", "createdAt": "2020-03-05T15:37:54Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregations.java", "diffHunk": "@@ -85,6 +85,15 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeNamedWriteableList(topLevelPipelineAggregators);\n     }\n \n+    /**\n+     * Make a mutable copy of the aggregation results.\n+     * <p>\n+     * IMPORTANT: The copy doesn't include any pipeline aggregations, if there are any.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzczOQ==", "bodyText": "Let's beef up the docs here, it took me a while to really understand what this is doing.\nE.g. an implementer of this will iterate over their internal buckets and apply the rewriter to each bucket, generating a modified/rewritten representation of their buckets which is then returned.\nAlso I think it's probably important to note that this returns a new version of the InternalAggregations... but the callee remains immutable and does not itself change.", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388403739", "createdAt": "2020-03-05T16:19:46Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java", "diffHunk": "@@ -127,6 +127,28 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * The default implementation throws an exception because most\n+     * aggregations don't <strong>have</strong> buckets in them. It\n+     * should be overridden by aggregations that contain buckets.\n+     */\n+    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwNDczNg==", "bodyText": "Does this gain us anything over just using Function<InternalAggregations, InternalAggregations>?  Shorter type signature, but it feels like it obfuscates what's going on?\nNot a strong opinion on this, just felt like extra boilerplate.", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388404736", "createdAt": "2020-03-05T16:21:21Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java", "diffHunk": "@@ -127,6 +127,28 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * The default implementation throws an exception because most\n+     * aggregations don't <strong>have</strong> buckets in them. It\n+     * should be overridden by aggregations that contain buckets.\n+     */\n+    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {\n+        throw new IllegalStateException(\n+                \"Aggregation [\" + getName() + \"] must be a bucket aggregation but was [\" + getWriteableName() + \"]\");\n+    }\n+    /**\n+     * Used with {@link InternalAggregation#rewriteBuckets(BucketRewriter)} to\n+     * rewrite the sub-aggregations within buckets.\n+     */\n+    public interface BucketRewriter {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQxODQ2Mw==", "bodyText": "Perhaps rename the method to copyAndRewriteBuckets() or similar, to help make it clear what's going on?", "url": "https://github.com/elastic/elasticsearch/pull/53144#discussion_r388418463", "createdAt": "2020-03-05T16:42:03Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/InternalAggregation.java", "diffHunk": "@@ -127,6 +127,28 @@ public String getName() {\n         return name;\n     }\n \n+    /**\n+     * Rewrite the sub-aggregations in the buckets in this aggregation.\n+     * The default implementation throws an exception because most\n+     * aggregations don't <strong>have</strong> buckets in them. It\n+     * should be overridden by aggregations that contain buckets.\n+     */\n+    public InternalAggregation rewriteBuckets(BucketRewriter rewriter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODQwMzczOQ=="}, "originalCommit": {"oid": "dfc9c2c9cafdf9c77e6c15447a26652a7978c72b"}, "originalPosition": 10}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dd0bca74240765b201bcc2ed7c0bf889d31d189", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/0dd0bca74240765b201bcc2ed7c0bf889d31d189", "committedDate": "2020-03-09T17:32:27Z", "message": "Merge branch 'master' into untwist_aggs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0", "committedDate": "2020-03-09T17:53:51Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxNDY3NDYy", "url": "https://github.com/elastic/elasticsearch/pull/53144#pullrequestreview-371467462", "createdAt": "2020-03-09T19:29:08Z", "commit": {"oid": "00e795ffa9d0f05aa45f0ff0720db5f4cce2d3b0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1776, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}