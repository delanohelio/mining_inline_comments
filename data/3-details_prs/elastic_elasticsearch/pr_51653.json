{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4ODExNTM3", "number": 51653, "title": "Fix SnapshotLifecycleServiceTests.testPolicyCRUD", "bodyText": "Resolves #44997", "createdAt": "2020-01-29T23:07:51Z", "url": "https://github.com/elastic/elasticsearch/pull/51653", "merged": true, "mergeCommit": {"oid": "8f9a87fa576a8a1c6ea3efb29bf1296d50d89ace"}, "closed": true, "closedAt": "2020-01-30T14:57:30Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_ONwJgH2gAyMzY4ODExNTM3OjRmNGQ4NjhkOWVkYzFlMDBiMGFlNWZmYjExZTk2N2Y1NWRmMzI5NTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_bvPwAFqTM1MDg4MTA3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f4d868d9edc1e00b0ae5ffb11e967f55df32958", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f4d868d9edc1e00b0ae5ffb11e967f55df32958", "committedDate": "2020-01-29T23:05:51Z", "message": "Fix SnapshotLifecycleServiceTests.testPolicyCRUD"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNTA0OTY4", "url": "https://github.com/elastic/elasticsearch/pull/51653#pullrequestreview-350504968", "createdAt": "2020-01-29T23:53:18Z", "commit": {"oid": "4f4d868d9edc1e00b0ae5ffb11e967f55df32958"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzo1MzoxOFrOFjbewA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMzo1MzoxOFrOFjbewA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY5NDcyMA==", "bodyText": "This will eventually fail, the contains matcher requires exact matching; so it'll fail and complain with:\njava.lang.AssertionError: \nExpected: iterable containing [\"foo-2\"]\n     but: item 0: was \"foo-1\"\n\nIt should be changed to check that it has \"foo-2\", but can have anything else also.", "url": "https://github.com/elastic/elasticsearch/pull/51653#discussion_r372694720", "createdAt": "2020-01-29T23:53:18Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SnapshotLifecycleServiceTests.java", "diffHunk": "@@ -206,13 +207,20 @@ public void testPolicyCRUD() throws Exception {\n             sls.clusterChanged(event);\n             assertThat(sls.getScheduler().scheduledJobIds(), equalTo(Collections.singleton(\"foo-2\")));\n \n+            CopyOnWriteArrayList<String> triggeredJobs = new CopyOnWriteArrayList<>();\n             trigger.set(e -> {\n-                // Make sure the job got updated\n-                assertThat(e.getJobName(), equalTo(\"foo-2\"));\n+                triggeredJobs.add(e.getJobName());\n                 triggerCount.incrementAndGet();\n             });\n             clock.fastForwardSeconds(1);\n \n+            // Let's make sure the job got updated\n+            // We don't simply assert that triggeredJobs has one element with value \"foo-2\" because of a race condition that can see the\n+            // list containing <foo-2, foo-1>. This can happen because when we update the policy to version 2 (ie. to foo-2) we will\n+            // cancel the existing policy (foo-1) without waiting for the thread executing foo-1 to actually interrupt\n+            // (see org.elasticsearch.common.util.concurrent.FutureUtils#cancel) which means that foo-1 could actually get to be\n+            // rescheduled and re-run before it is indeed cancelled.\n+            assertBusy(() -> assertThat(triggeredJobs, contains(\"foo-2\")));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f4d868d9edc1e00b0ae5ffb11e967f55df32958"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6175f89a4c77a059c65b2303694e5ad22525474", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6175f89a4c77a059c65b2303694e5ad22525474", "committedDate": "2020-01-30T09:07:22Z", "message": "Use hasItem instead of contains"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwODgxMDcw", "url": "https://github.com/elastic/elasticsearch/pull/51653#pullrequestreview-350881070", "createdAt": "2020-01-30T14:51:12Z", "commit": {"oid": "e6175f89a4c77a059c65b2303694e5ad22525474"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3080, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}