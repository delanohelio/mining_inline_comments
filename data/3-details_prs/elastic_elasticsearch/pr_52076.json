{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNTY4MDk1", "number": 52076, "title": "ILM fix the init step to actually be retryable", "bodyText": "We marked the init ILM step as retryable but our test used waitUntil\nwithout an assert so we didn\u2019t catch the fact that we were not actually\nable to retry this step as our ILM state didn\u2019t contain any information\nabout the policy execution (as we were in the process of initialising\nit).\nThis commit manually sets the current step to init when we\u2019re moving\nthe ilm policy into the ERROR step (this enables us to successfully\nmove to the error step and later retry the step)", "createdAt": "2020-02-07T19:37:34Z", "url": "https://github.com/elastic/elasticsearch/pull/52076", "merged": true, "mergeCommit": {"oid": "f78d4b3d91345a2a8fc0f48b90dd66c9959bd7ff"}, "closed": true, "closedAt": "2020-02-13T20:21:41Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCEjx_AH2gAyMzcyNTY4MDk1OjYzZjM3N2NmNjE4YzUwZGVlZDc5ZWQ5ZGEyZmZlY2EyYzk4NDQ4NWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDp8acgFqTM1NzY1MzcxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "63f377cf618c50deed79ed9da2ffeca2c984485c", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/63f377cf618c50deed79ed9da2ffeca2c984485c", "committedDate": "2020-02-07T19:32:38Z", "message": "ILM fix the init step to actually be retryable\n\nWe marked the `init` ILM step as retryable but our test used `waitUntil`\nwithout an assert so we didn\u2019t catch the fact that we were not actually\nable to retry this step as our ILM state didn\u2019t contain any information\nabout the policy execution (as we were in the process of initialising\nit). \n\nThis commit manually sets the current step to `init` when we\u2019re moving\nthe ilm policy into the ERROR step (this enables us to successfully\nmove to the error step and later retry the step)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af73584ccd13ce27390374c884ae9f7a1a469b78", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/af73584ccd13ce27390374c884ae9f7a1a469b78", "committedDate": "2020-02-07T19:34:04Z", "message": "ILM assert on the results of `waitUntil`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e46ae3519fad62717c1146b4386ec707337e66d", "committedDate": "2020-02-07T19:46:10Z", "message": "Add license header"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDExNzA0", "url": "https://github.com/elastic/elasticsearch/pull/52076#pullrequestreview-355411704", "createdAt": "2020-02-07T20:16:17Z", "commit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDoxNjoxOFrOFnJDjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDoxNjoxOFrOFnJDjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzE0OQ==", "bodyText": "I'd consider using assertTrue, we have long body here, it's hard to tell what we asserting here. The same applies to all instances below", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r376587149", "createdAt": "2020-02-07T20:16:18Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/ilm/qa/multi-node/src/test/java/org/elasticsearch/xpack/ilm/TimeSeriesLifecycleActionsIT.java", "diffHunk": "@@ -1120,26 +1120,26 @@ public void testRolloverStepRetriesUntilRolledOverIndexIsDeleted() throws Except\n         // {@link org.elasticsearch.xpack.core.ilm.ErrorStep} in order to retry the failing step. As {@link #assertBusy}\n         // increases the wait time between calls exponentially, we might miss the window where the policy is on\n         // {@link WaitForRolloverReadyStep} and the move to `attempt-rollover` request will not be successful.\n-        waitUntil(() -> {\n+        assertThat(waitUntil(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDQ0MTI2", "url": "https://github.com/elastic/elasticsearch/pull/52076#pullrequestreview-355444126", "createdAt": "2020-02-07T21:21:18Z", "commit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMToyMToxOFrOFnKpAQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMToyMzo0NFrOFnKsaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxMzEyMQ==", "bodyText": "What was the reason for wrapping this in an ElasticsearchException type exception?", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r376613121", "createdAt": "2020-02-07T21:21:18Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/InitializePolicyContextStep.java", "diffHunk": "@@ -47,13 +47,17 @@ public ClusterState performAction(Index index, ClusterState clusterState) {\n \n         IndexMetaData.Builder indexMetadataBuilder = IndexMetaData.builder(indexMetaData);\n         if (shouldParseIndexName(indexMetaData.getSettings())) {\n-            long parsedOriginationDate = parseIndexNameAndExtractDate(index.getName());\n-            indexMetadataBuilder.settingsVersion(indexMetaData.getSettingsVersion() + 1)\n-                .settings(Settings.builder()\n-                    .put(indexMetaData.getSettings())\n-                    .put(LifecycleSettings.LIFECYCLE_ORIGINATION_DATE, parsedOriginationDate)\n-                    .build()\n-                );\n+            try {\n+                long parsedOriginationDate = parseIndexNameAndExtractDate(index.getName());\n+                indexMetadataBuilder.settingsVersion(indexMetaData.getSettingsVersion() + 1)\n+                    .settings(Settings.builder()\n+                        .put(indexMetaData.getSettings())\n+                        .put(LifecycleSettings.LIFECYCLE_ORIGINATION_DATE, parsedOriginationDate)\n+                        .build()\n+                    );\n+            } catch (Exception e) {\n+                throw new InitializePolicyException(e.getMessage(), e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxMzY0MQ==", "bodyText": "It could be changed to just assertBusy(() -> {...}, 30, TimeUnit.SECONDS) also and use assertions to signal success/failure", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r376613641", "createdAt": "2020-02-07T21:22:46Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/qa/multi-node/src/test/java/org/elasticsearch/xpack/ilm/TimeSeriesLifecycleActionsIT.java", "diffHunk": "@@ -1120,26 +1120,26 @@ public void testRolloverStepRetriesUntilRolledOverIndexIsDeleted() throws Except\n         // {@link org.elasticsearch.xpack.core.ilm.ErrorStep} in order to retry the failing step. As {@link #assertBusy}\n         // increases the wait time between calls exponentially, we might miss the window where the policy is on\n         // {@link WaitForRolloverReadyStep} and the move to `attempt-rollover` request will not be successful.\n-        waitUntil(() -> {\n+        assertThat(waitUntil(() -> {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NzE0OQ=="}, "originalCommit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjYxMzk5Mw==", "bodyText": "I think the assertThat -> waitUntil -> is(true) is a little hard to follow, I think just a single assertBusy() would be better, since you can add the assertions in the body itself rather than returning a boolean?", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r376613993", "createdAt": "2020-02-07T21:23:44Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/qa/multi-node/src/test/java/org/elasticsearch/xpack/ilm/TimeSeriesLifecycleActionsIT.java", "diffHunk": "@@ -1120,26 +1120,26 @@ public void testRolloverStepRetriesUntilRolledOverIndexIsDeleted() throws Except\n         // {@link org.elasticsearch.xpack.core.ilm.ErrorStep} in order to retry the failing step. As {@link #assertBusy}\n         // increases the wait time between calls exponentially, we might miss the window where the policy is on\n         // {@link WaitForRolloverReadyStep} and the move to `attempt-rollover` request will not be successful.\n-        waitUntil(() -> {\n+        assertThat(waitUntil(() -> {\n             try {\n                 return client().performRequest(moveToStepRequest).getStatusLine().getStatusCode() == 200;\n             } catch (IOException e) {\n                 return false;\n             }\n-        }, 30, TimeUnit.SECONDS);\n+        }, 30, TimeUnit.SECONDS), is(true));\n \n         // Similar to above, using {@link #waitUntil} as we want to make sure the `attempt-rollover` step started failing and is being\n         // retried (which means ILM moves back and forth between the `attempt-rollover` step and the `error` step)\n-        waitUntil(() -> {\n+        assertThat(\"ILM did not start retrying the attempt-rollover step\", waitUntil(() -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6e46ae3519fad62717c1146b4386ec707337e66d"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26a18af8a740f49c0f419058940a33528d38a5af", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/26a18af8a740f49c0f419058940a33528d38a5af", "committedDate": "2020-02-10T10:34:32Z", "message": "Use assertTrue"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a180e61b5ab07555a40fc415ee643e2c2d1dc3c9", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a180e61b5ab07555a40fc415ee643e2c2d1dc3c9", "committedDate": "2020-02-10T10:52:22Z", "message": "Merge branch 'master' into ilm-init-step-retryable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzI0MDUx", "url": "https://github.com/elastic/elasticsearch/pull/52076#pullrequestreview-356724051", "createdAt": "2020-02-11T14:56:59Z", "commit": {"oid": "a180e61b5ab07555a40fc415ee643e2c2d1dc3c9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1Njo1OVrOFoMJkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNDo1ODo1NVrOFoMO_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NjQxOQ==", "bodyText": "I think we may want to move the try to surround more of the function (for example, the fromIndexMetadata(...) call", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r377686419", "createdAt": "2020-02-11T14:56:59Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/InitializePolicyContextStep.java", "diffHunk": "@@ -47,13 +47,17 @@ public ClusterState performAction(Index index, ClusterState clusterState) {\n \n         IndexMetaData.Builder indexMetadataBuilder = IndexMetaData.builder(indexMetaData);\n         if (shouldParseIndexName(indexMetaData.getSettings())) {\n-            long parsedOriginationDate = parseIndexNameAndExtractDate(index.getName());\n-            indexMetadataBuilder.settingsVersion(indexMetaData.getSettingsVersion() + 1)\n-                .settings(Settings.builder()\n-                    .put(indexMetaData.getSettings())\n-                    .put(LifecycleSettings.LIFECYCLE_ORIGINATION_DATE, parsedOriginationDate)\n-                    .build()\n-                );\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a180e61b5ab07555a40fc415ee643e2c2d1dc3c9"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NzE5Nw==", "bodyText": "Can we include the policy name in the exception somewhere? I think that might be helpful if the setting were to change but the error was still there", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r377687197", "createdAt": "2020-02-11T14:58:06Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/InitializePolicyException.java", "diffHunk": "@@ -0,0 +1,18 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.core.ilm;\n+\n+import org.elasticsearch.ElasticsearchException;\n+\n+/**\n+ * Exception thrown when a problem is encountered while initialising an ILM policy for an index.\n+ */\n+public class InitializePolicyException extends ElasticsearchException {\n+\n+    public InitializePolicyException(String msg, Throwable cause, Object... args) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a180e61b5ab07555a40fc415ee643e2c2d1dc3c9"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzY4NzgwNA==", "bodyText": "Can you add a comment about why we check for this particular exception here?", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r377687804", "createdAt": "2020-02-11T14:58:55Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycleTransition.java", "diffHunk": "@@ -133,8 +134,13 @@ static ClusterState moveClusterStateToErrorStep(Index index, ClusterState cluste\n         ElasticsearchException.generateThrowableXContent(causeXContentBuilder, STACKTRACE_PARAMS, cause);\n         causeXContentBuilder.endObject();\n         LifecycleExecutionState currentState = LifecycleExecutionState.fromIndexMetadata(idxMeta);\n-        Step.StepKey currentStep = Objects.requireNonNull(LifecycleExecutionState.getCurrentStepKey(currentState),\n-            \"unable to move to an error step where there is no current step, state: \" + currentState);\n+        Step.StepKey currentStep;\n+        if (cause instanceof InitializePolicyException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a180e61b5ab07555a40fc415ee643e2c2d1dc3c9"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27708dd32e0184e1e2a6ade8b2c7650bd2bdf99f", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/27708dd32e0184e1e2a6ade8b2c7650bd2bdf99f", "committedDate": "2020-02-12T12:24:54Z", "message": "Add policy and index in InitalizePolicyExeeption"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8523f21de8ceec8709b5a2938ec471a0dfac3aad", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/8523f21de8ceec8709b5a2938ec471a0dfac3aad", "committedDate": "2020-02-12T12:25:21Z", "message": "Document moving to error step from the init step"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b609366cdc67b21836d0e8488094ba9b64ce5b65", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b609366cdc67b21836d0e8488094ba9b64ce5b65", "committedDate": "2020-02-12T12:25:43Z", "message": "ShrunkenIndexCheckStep: Use correct logger"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3355825b3d4947d8fe6b8c55dedfda91aacaf985", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/3355825b3d4947d8fe6b8c55dedfda91aacaf985", "committedDate": "2020-02-12T12:42:26Z", "message": "break in case statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7f0828346f974817e8a8c48020a546911d97cd9", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7f0828346f974817e8a8c48020a546911d97cd9", "committedDate": "2020-02-12T13:11:03Z", "message": "Merge branch 'master' into ilm-init-step-retryable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NTg4NTA5", "url": "https://github.com/elastic/elasticsearch/pull/52076#pullrequestreview-357588509", "createdAt": "2020-02-12T16:16:03Z", "commit": {"oid": "d7f0828346f974817e8a8c48020a546911d97cd9"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjoxNjowNFrOFo1DoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxNjoxNzo0NVrOFo1IPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1NjY0MQ==", "bodyText": "We don't need to pass the policy in and store it in the step, we can get it directly out of the index metadata (the index.lifecycle.name setting)", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r378356641", "createdAt": "2020-02-12T16:16:04Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/InitializePolicyContextStep.java", "diffHunk": "@@ -25,8 +27,11 @@\n     public static final StepKey KEY = new StepKey(INITIALIZATION_PHASE, \"init\", \"init\");\n     private static final Logger logger = LogManager.getLogger(InitializePolicyContextStep.class);\n \n-    InitializePolicyContextStep(Step.StepKey key, StepKey nextStepKey) {\n+    private final String policy;\n+\n+    InitializePolicyContextStep(String policy, Step.StepKey key, StepKey nextStepKey) {\n         super(key, nextStepKey);\n+        this.policy = policy;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7f0828346f974817e8a8c48020a546911d97cd9"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODM1NzgyMw==", "bodyText": "If we get the policy id from the index metadata we don't need to add this stuff either, which will be nice.", "url": "https://github.com/elastic/elasticsearch/pull/52076#discussion_r378357823", "createdAt": "2020-02-12T16:17:45Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/InitializePolicyContextStep.java", "diffHunk": "@@ -72,4 +80,22 @@ public ClusterState performAction(Index index, ClusterState clusterState) {\n     public boolean isRetryable() {\n         return true;\n     }\n+\n+    String policy() {\n+        return policy;\n+    }\n+\n+    @Override\n+    public boolean equals(Object o) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d7f0828346f974817e8a8c48020a546911d97cd9"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c444c03d7add3ffea66ede07768d8c35eb8392", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/04c444c03d7add3ffea66ede07768d8c35eb8392", "committedDate": "2020-02-12T16:41:00Z", "message": "Derive the policy name from the index metadata"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "569509156640ae2fcad3f887314a63fe5524d14e", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/569509156640ae2fcad3f887314a63fe5524d14e", "committedDate": "2020-02-12T16:42:02Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU3NjUzNzE2", "url": "https://github.com/elastic/elasticsearch/pull/52076#pullrequestreview-357653716", "createdAt": "2020-02-12T17:39:57Z", "commit": {"oid": "569509156640ae2fcad3f887314a63fe5524d14e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2686, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}