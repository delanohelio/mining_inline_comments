{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMzc5NDQx", "number": 57044, "title": "Don't run sort optimization on size=0", "bodyText": "Sort optimization creates TopFieldCollector that errors\nwhen size=0. This ensures that sort optimization is not\nrun when size=0.\nCloses #56923", "createdAt": "2020-05-21T14:21:58Z", "url": "https://github.com/elastic/elasticsearch/pull/57044", "merged": true, "mergeCommit": {"oid": "bdfb137b340520218b88c1482d4d3fcc9718c9e6"}, "closed": true, "closedAt": "2020-05-21T18:49:44Z", "author": {"login": "mayya-sharipova"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjeZ4PgH2gAyNDIxMzc5NDQxOjIzYjE1MmQ0OGI1ZTM4MzE5YTBmMThmYTlmOWEyZmZhN2JhOWIzODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcjrkZJAFqTQxNjY1OTQ3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386", "author": {"user": {"login": "mayya-sharipova", "name": "Mayya Sharipova"}}, "url": "https://github.com/elastic/elasticsearch/commit/23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386", "committedDate": "2020-05-21T14:18:51Z", "message": "Don't run sort optimization on size=0\n\nSort optimization creates TopFieldCollector that errors\nwhen size=0. This ensures that sort optimization is not\nrun when size=0.\n\nCloses #56923"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2Mjg3MzMz", "url": "https://github.com/elastic/elasticsearch/pull/57044#pullrequestreview-416287333", "createdAt": "2020-05-21T16:08:56Z", "commit": {"oid": "23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjowODo1NlrOGY5M-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjowODo1NlrOGY5M-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc1NjIxNg==", "bodyText": "I'm wondering why we use a spy here, if we don't verify the calls after?", "url": "https://github.com/elastic/elasticsearch/pull/57044#discussion_r428756216", "createdAt": "2020-05-21T16:08:56Z", "author": {"login": "jtibshirani"}, "path": "server/src/test/java/org/elasticsearch/search/query/QueryPhaseTests.java", "diffHunk": "@@ -703,6 +703,23 @@ public void testNumericLongOrDateSortOptimization() throws Exception {\n         searchContext.sort(sortAndFormats);\n         QueryPhase.executeInternal(searchContext);\n         assertSortResults(searchContext.queryResult().topDocs().topDocs, (long) numDocs, true);\n+\n+        // 5. Test that sort optimization is NOT run with size 0\n+        {\n+            sortAndFormats = new SortAndFormats(longSort, new DocValueFormat[]{DocValueFormat.RAW});\n+            searchContext = spy(new TestSearchContext(null, indexShard, newContextSearcher(reader)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2NjU5NDcw", "url": "https://github.com/elastic/elasticsearch/pull/57044#pullrequestreview-416659470", "createdAt": "2020-05-22T05:39:06Z", "commit": {"oid": "23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNTozOTowNlrOGZLQKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMlQwNTozOTowNlrOGZLQKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTA1MTk0Nw==", "bodyText": "What if 'size' is 0 but 'from' is not, can this case uses sort optimization?  if it can, changing this place to \"from + size\" may be much better.\nFeel free about this, just an advice :P", "url": "https://github.com/elastic/elasticsearch/pull/57044#discussion_r429051947", "createdAt": "2020-05-22T05:39:06Z", "author": {"login": "yyff"}, "path": "server/src/main/java/org/elasticsearch/search/query/QueryPhase.java", "diffHunk": "@@ -244,7 +244,7 @@ static boolean executeInternal(SearchContext searchContext) throws QueryPhaseExe\n \n             CheckedConsumer<List<LeafReaderContext>, IOException> leafSorter = l -> {};\n             // try to rewrite numeric or date sort to the optimized distanceFeatureQuery\n-            if ((searchContext.sort() != null) && SYS_PROP_REWRITE_SORT) {\n+            if ((searchContext.sort() != null) && (searchContext.size() > 0) && SYS_PROP_REWRITE_SORT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "23b152d48b5e38319a0f18fa9f9a2ffa7ba9b386"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4772, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}