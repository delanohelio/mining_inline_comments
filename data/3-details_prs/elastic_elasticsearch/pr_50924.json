{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYyMTgzMTMx", "number": 50924, "title": "Allow installing multiple plugins as a transaction", "bodyText": "This commit allows the plugin installer to install multiple plugins in a single invocation. The installation will be treated as a transaction, so that all of the plugins are install successfully, or none of the plugins are installed.\nRelates #50443", "createdAt": "2020-01-13T15:39:36Z", "url": "https://github.com/elastic/elasticsearch/pull/50924", "merged": true, "mergeCommit": {"oid": "6b20a2c176e2211d3e35c8dbc0e0a22fc70303a1"}, "closed": true, "closedAt": "2020-01-14T17:12:20Z", "author": {"login": "jasontedor"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5-GuGAH2gAyMzYyMTgzMTMxOjQ2NGM2NjY5NWMyNzZhMmE0Y2MyYzM2MmE5MDYyNTYwYzg2ZGY0ODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6SaFRgFqTM0MjYwMzE4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "464c66695c276a2a4cc2c362a9062560c86df488", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/464c66695c276a2a4cc2c362a9062560c86df488", "committedDate": "2020-01-13T15:30:04Z", "message": "Allow installing multiple plugins as a transaction\n\nThis commit allows the plugin installer to install multiple plugins in a\nsingle invocation. The installation will be treated as a transaction, so\nthat all of the plugins are install successfully, or none of the plugins\nare installed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMjI5ODU2", "url": "https://github.com/elastic/elasticsearch/pull/50924#pullrequestreview-342229856", "createdAt": "2020-01-14T00:35:07Z", "commit": {"oid": "464c66695c276a2a4cc2c362a9062560c86df488"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDozNTowN1rOFdJDtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNFQwMDo1MDo1NlrOFdJSUw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwMTQyOA==", "bodyText": "Maybe \"At least one plugin id is required\"?", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366101428", "createdAt": "2020-01-14T00:35:07Z", "author": {"login": "rjernst"}, "path": "distribution/tools/plugin-cli/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java", "diffHunk": "@@ -206,24 +206,50 @@ protected void printAdditionalHelp(Terminal terminal) {\n \n     @Override\n     protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {\n-        String pluginId = arguments.value(options);\n+        List<String> pluginId = arguments.values(options);\n         final boolean isBatch = options.has(batchOption);\n         execute(terminal, pluginId, isBatch, env);\n     }\n \n     // pkg private for testing\n-    void execute(Terminal terminal, String pluginId, boolean isBatch, Environment env) throws Exception {\n-        if (pluginId == null) {\n-            throw new UserException(ExitCodes.USAGE, \"plugin id is required\");\n+    void execute(Terminal terminal, List<String> pluginIds, boolean isBatch, Environment env) throws Exception {\n+        if (pluginIds.isEmpty()) {\n+            throw new UserException(ExitCodes.USAGE, \"plugin ids are required\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464c66695c276a2a4cc2c362a9062560c86df488"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNDA2Mg==", "bodyText": "Maybe we should emit each as we go? Dumping at the end seems counter to giving progress, which is the intention of this message IMO.", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366104062", "createdAt": "2020-01-14T00:46:23Z", "author": {"login": "rjernst"}, "path": "distribution/tools/plugin-cli/src/main/java/org/elasticsearch/plugins/InstallPluginCommand.java", "diffHunk": "@@ -206,24 +206,50 @@ protected void printAdditionalHelp(Terminal terminal) {\n \n     @Override\n     protected void execute(Terminal terminal, OptionSet options, Environment env) throws Exception {\n-        String pluginId = arguments.value(options);\n+        List<String> pluginId = arguments.values(options);\n         final boolean isBatch = options.has(batchOption);\n         execute(terminal, pluginId, isBatch, env);\n     }\n \n     // pkg private for testing\n-    void execute(Terminal terminal, String pluginId, boolean isBatch, Environment env) throws Exception {\n-        if (pluginId == null) {\n-            throw new UserException(ExitCodes.USAGE, \"plugin id is required\");\n+    void execute(Terminal terminal, List<String> pluginIds, boolean isBatch, Environment env) throws Exception {\n+        if (pluginIds.isEmpty()) {\n+            throw new UserException(ExitCodes.USAGE, \"plugin ids are required\");\n         }\n \n-        if (\"x-pack\".equals(pluginId)) {\n-            handleInstallXPack(buildFlavor());\n+        final Set<String> uniquePluginIds = new HashSet<>();\n+        for (final String pluginId : pluginIds) {\n+            if (uniquePluginIds.add(pluginId) == false) {\n+                throw new UserException(ExitCodes.USAGE, \"duplicate plugin id [\" + pluginId + \"]\");\n+            }\n+        }\n+\n+        final List<Path> deleteOnFailure = new ArrayList<>();\n+        final Set<PluginInfo> pluginInfos = new HashSet<>();\n+        for (final String pluginId : pluginIds) {\n+            try {\n+                if (\"x-pack\".equals(pluginId)) {\n+                    handleInstallXPack(buildFlavor());\n+                }\n+\n+                final Path pluginZip = download(terminal, pluginId, env.tmpFile(), isBatch);\n+                final Path extractedZip = unzip(pluginZip, env.pluginsFile());\n+                deleteOnFailure.add(extractedZip);\n+                final PluginInfo pluginInfo = installPlugin(terminal, isBatch, extractedZip, env, deleteOnFailure);\n+                pluginInfos.add(pluginInfo);\n+            } catch (final Exception installProblem) {\n+                try {\n+                    IOUtils.rm(deleteOnFailure.toArray(new Path[0]));\n+                } catch (final IOException exceptionWhileRemovingFiles) {\n+                    installProblem.addSuppressed(exceptionWhileRemovingFiles);\n+                }\n+                throw installProblem;\n+            }\n         }\n \n-        Path pluginZip = download(terminal, pluginId, env.tmpFile(), isBatch);\n-        Path extractedZip = unzip(pluginZip, env.pluginsFile());\n-        install(terminal, isBatch, extractedZip, env);\n+        for (final PluginInfo pluginInfo : pluginInfos) {\n+            terminal.println(\"-> Installed \" + pluginInfo.getName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464c66695c276a2a4cc2c362a9062560c86df488"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NjEwNTE3MQ==", "bodyText": "Can we also add tests for the duplicate plugin detection, and failure case wiping the plugins (ie making sure the transactional behavior works)?", "url": "https://github.com/elastic/elasticsearch/pull/50924#discussion_r366105171", "createdAt": "2020-01-14T00:50:56Z", "author": {"login": "rjernst"}, "path": "distribution/tools/plugin-cli/src/test/java/org/elasticsearch/plugins/InstallPluginCommandTests.java", "diffHunk": "@@ -393,6 +401,16 @@ public void testSomethingWorks() throws Exception {\n         assertPlugin(\"fake\", pluginDir, env.v2());\n     }\n \n+    public void testMultipleWorks() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "464c66695c276a2a4cc2c362a9062560c86df488"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c15a98c48a02194f22da77caafb42fb05a4c65b4", "author": {"user": {"login": "jasontedor", "name": "Jason Tedor"}}, "url": "https://github.com/elastic/elasticsearch/commit/c15a98c48a02194f22da77caafb42fb05a4c65b4", "committedDate": "2020-01-14T12:48:31Z", "message": "Iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6892024ad7955599a7d5613d0a2e9034c6d955e5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6892024ad7955599a7d5613d0a2e9034c6d955e5", "committedDate": "2020-01-14T14:57:57Z", "message": "Merge branch 'master' into multiple-plugins"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNjAzMTg0", "url": "https://github.com/elastic/elasticsearch/pull/50924#pullrequestreview-342603184", "createdAt": "2020-01-14T15:09:19Z", "commit": {"oid": "6892024ad7955599a7d5613d0a2e9034c6d955e5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3198, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}