{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0NDY4NTEy", "number": 54309, "title": "Remove guava from transitive compile classpath", "bodyText": "Guava was removed from Elasticsearch many years ago, but remnants of it\nremain due to transitive dependencies. When a dependency pulls guava\ninto the compile classpath, devs can inadvertently begin using methods\nfrom guava without realizing it. This commit moves guava to a runtime\ndependency in the modules that it is needed.\nNote that one special case is the html sanitizer in watcher. The third\nparty dep uses guava in the PolicyFactory class signature. However, only\ncalling a method on the PolicyFactory actually causes the class to be\nloaded, a reference alone does not trigger compilation to look at the\nclass implementation. There we utilize a MethodHandle for invoking the\nrelevant method at runtime, where guava will continue to exist.\nAdditionally, this commit adds a build time check that we do not add any compile dependency on guava.", "createdAt": "2020-03-26T23:12:57Z", "url": "https://github.com/elastic/elasticsearch/pull/54309", "merged": true, "mergeCommit": {"oid": "9191c933caa268cd1254086fb895e63470a29c28"}, "closed": true, "closedAt": "2020-04-02T19:54:40Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRkdXRgH2gAyMzk0NDY4NTEyOmEyM2NlOThhMzkyNGY1OTYyOGQ1MWYyZDNmOWI5ZTMzMWUyYmQxODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTw3brAH2gAyMzk0NDY4NTEyOmMxMGQwMTM2MTdhYjE5NGE2NzRhNjM2MThjN2EzZmViYTZjNGUwYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a23ce98a3924f59628d51f2d3f9b9e331e2bd185", "committedDate": "2020-03-26T23:11:27Z", "message": "Remove guava from transitive compile classpath\n\nGuava was removed from Elasticsearch many years ago, but remnants of it\nremain due to transitive dependencies. When a dependency pulls guava\ninto the compile classpath, devs can inadvertently begin using methods\nfrom guava without realizing it. This commit moves guava to a runtime\ndependency in the modules that it is needed.\n\nNote that one special case is the html sanitizer in watcher. The third\nparty dep uses guava in the PolicyFactory class signature. However, only\ncalling a method on the PolicyFactory actually causes the class to be\nloaded, a reference alone does not trigger compilation to look at the\nclass implementation. There we utilize a MethodHandle for invoking the\nrelevant method at runtime, where guava will continue to exist."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNDg1MjEy", "url": "https://github.com/elastic/elasticsearch/pull/54309#pullrequestreview-382485212", "createdAt": "2020-03-26T23:19:26Z", "commit": {"oid": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzoxOToyNlrOF8d4Xw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQyMzoyMDoxM1rOF8d5WQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODQ0Nw==", "bodyText": "We might want to include the full path to the configuration here as just saying \"compileClasspath\" isn't going to be particularly helpful.", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r398948447", "createdAt": "2020-03-26T23:19:26Z", "author": {"login": "mark-vieira"}, "path": "gradle/forbidden-dependencies.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+\n+// we do not want any of these dependencies on the compilation classpath\n+// because they could then be used within Elasticsearch\n+List<String> FORBIDDEN_DEPENDENCIES = [\n+  'guava'\n+]\n+\n+Closure checkDeps = { Configuration configuration -> \n+  configuration.resolutionStrategy.eachDependency {\n+    String artifactName = it.target.name\n+    if (FORBIDDEN_DEPENDENCIES.contains(artifactName)) {\n+      throw new GradleException(\"Dependency '${artifactName}' on configuration '${configuration.name}' is not allowed. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODk0ODY5Nw==", "bodyText": "It's worth nothing that standalone QA projects do no apply the java plugin but only java-base.", "url": "https://github.com/elastic/elasticsearch/pull/54309#discussion_r398948697", "createdAt": "2020-03-26T23:20:13Z", "author": {"login": "mark-vieira"}, "path": "gradle/forbidden-dependencies.gradle", "diffHunk": "@@ -0,0 +1,23 @@\n+\n+// we do not want any of these dependencies on the compilation classpath\n+// because they could then be used within Elasticsearch\n+List<String> FORBIDDEN_DEPENDENCIES = [\n+  'guava'\n+]\n+\n+Closure checkDeps = { Configuration configuration -> \n+  configuration.resolutionStrategy.eachDependency {\n+    String artifactName = it.target.name\n+    if (FORBIDDEN_DEPENDENCIES.contains(artifactName)) {\n+      throw new GradleException(\"Dependency '${artifactName}' on configuration '${configuration.name}' is not allowed. \" +\n+        \"If it is needed as a transitive depenency, try adding it to the runtime classpath\")\n+    }\n+  }\n+}\n+\n+subprojects {\n+  pluginManager.withPlugin('java') {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a23ce98a3924f59628d51f2d3f9b9e331e2bd185"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8cc49bbd92079c4dc99f8e0917efd2a5214cbb2e", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/8cc49bbd92079c4dc99f8e0917efd2a5214cbb2e", "committedDate": "2020-03-27T03:47:12Z", "message": "don't check fixtures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b656248dda743937f50222ab31f98222cdb1de3b", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/b656248dda743937f50222ab31f98222cdb1de3b", "committedDate": "2020-03-27T21:37:23Z", "message": "Merge branch 'master' into guava_runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c80ca8cf0268ba9a16428cdb1381464d8e9ff5c", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c80ca8cf0268ba9a16428cdb1381464d8e9ff5c", "committedDate": "2020-03-27T21:49:12Z", "message": "apply no-transitive rules to runtimeOnly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e538db2ec241d4b449e14b1f7b75a17149db35b2", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/e538db2ec241d4b449e14b1f7b75a17149db35b2", "committedDate": "2020-03-27T21:58:26Z", "message": "use correct runtime classpath for third party audit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04ded15cc75c0d27a8516788be6093edcc4b0f58", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/04ded15cc75c0d27a8516788be6093edcc4b0f58", "committedDate": "2020-03-27T22:19:06Z", "message": "ignore build tools"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eab13256e99f75f67a92f58c0c396cc590539e63", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/eab13256e99f75f67a92f58c0c396cc590539e63", "committedDate": "2020-03-27T22:33:11Z", "message": "use runtimeClasspath in plugin building"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42341444c96f5e75fb84aacad7e165002ed683ec", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/42341444c96f5e75fb84aacad7e165002ed683ec", "committedDate": "2020-03-30T20:29:47Z", "message": "fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c5bdc264b402903df5a90f0b5a5ed8671d58318", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c5bdc264b402903df5a90f0b5a5ed8671d58318", "committedDate": "2020-04-01T19:36:08Z", "message": "use sourcesets instead of configurations directly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2323d6f2e0f4cdd1cb65a0d22301fb4c5905fb34", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/2323d6f2e0f4cdd1cb65a0d22301fb4c5905fb34", "committedDate": "2020-04-01T19:55:47Z", "message": "add back filtering of compileOnly in plugin zips"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3eb71523f82681f0984aa30d60f9a68f22bb92a4", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/3eb71523f82681f0984aa30d60f9a68f22bb92a4", "committedDate": "2020-04-01T19:58:47Z", "message": "Merge branch 'master' into guava_runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cf1fe363e2389344172dffee97e45769dc76da85", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf1fe363e2389344172dffee97e45769dc76da85", "committedDate": "2020-04-01T21:01:17Z", "message": "don't use guava Sets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24b2c2ce68f199cb3dc67c0b7fb28b746bd40d9b", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/24b2c2ce68f199cb3dc67c0b7fb28b746bd40d9b", "committedDate": "2020-04-01T22:14:33Z", "message": "dont use guava charsets"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a3007e92cd0fce3a2a0ef2a3cb388b9c2e5b8cf", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a3007e92cd0fce3a2a0ef2a3cb388b9c2e5b8cf", "committedDate": "2020-04-02T01:06:44Z", "message": "more eradication from tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ab3abe408abd65673bfae9b74bb5578212656fb", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ab3abe408abd65673bfae9b74bb5578212656fb", "committedDate": "2020-04-02T18:07:44Z", "message": "add guava explicitly to test runtime"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c10d013617ab194a674a63618c7a3feba6c4e0ad", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/c10d013617ab194a674a63618c7a3feba6c4e0ad", "committedDate": "2020-04-02T18:46:38Z", "message": "Merge branch 'master' into guava_runtime"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1434, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}