{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzczNzMzNzQy", "number": 52218, "title": "[ML] Adds feature importance option to inference processor", "bodyText": "This adds machine learning model feature importance calculations to the inference processor.\nThe new flag in the configuration matches the analytics parameter name: num_top_feature_importance_values\nExample:\n\"inference\": {\n   \"field_mappings\": {},\n   \"model_id\": \"my_model\",\n   \"inference_config\": {\n      \"regression\": {\n         \"num_top_feature_importance_values\": 3\n      }\n   }\n}\n\nThis will write to the document as follows:\n\"inference\" : {\n   \"feature_importance\" : { \n      \"FlightTimeMin\" : -76.90955548511226,\n      \"FlightDelayType\" : 114.13514762158526,\n      \"DistanceMiles\" : 13.731580450792187\n   },\n   \"predicted_value\" : 108.33165831875137,\n   \"model_id\" : \"my_model\"\n}\n\nThis is done through calculating the SHAP values.\nIt requires that models have populated number_samples for each tree node. This is not available to models that were created before 7.7.\nAdditionally, if the inference config is requesting feature_importance, and not all nodes have been upgraded yet, it will not allow the pipeline to be created. This is to safe-guard in a mixed-version environment where only some ingest nodes have been upgraded.\nNOTE: the algorithm is a Java port of the one laid out in ml-cpp: https://github.com/elastic/ml-cpp/blob/master/lib/maths/CTreeShapFeatureImportance.cc\nusability blocked by: elastic/ml-cpp#991", "createdAt": "2020-02-11T15:48:37Z", "url": "https://github.com/elastic/elasticsearch/pull/52218", "merged": true, "mergeCommit": {"oid": "20f54272f0aaf6a56516823cb6baab0648fe19cd"}, "closed": true, "closedAt": "2020-02-21T21:36:22Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcDTqT8AH2gAyMzczNzMzNzQyOmNkNDFjODNiN2ZjOGZkNzYwMmZlMzBhYjIyMzNjNzcxNTA4YWQyYjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGl1KbgH2gAyMzczNzMzNzQyOjAxNjM4ZjgwNTY2Y2ExMzcxMTAzZDk2YzBhNmU0MTY0OTc3ZTQ4ZmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cd41c83b7fc8fd7602fe30ab2233c771508ad2b9", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd41c83b7fc8fd7602fe30ab2233c771508ad2b9", "committedDate": "2020-02-11T15:42:16Z", "message": "[ML] Adds feature importance to models via SHAP value calculations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "83ec74ddafa12d3547f33b4143f5f5c991673cdb", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/83ec74ddafa12d3547f33b4143f5f5c991673cdb", "committedDate": "2020-02-11T15:59:10Z", "message": "updating inference processor doc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6162b49543578710c96e44ee3e095b8772d10dbf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/6162b49543578710c96e44ee3e095b8772d10dbf", "committedDate": "2020-02-11T19:08:01Z", "message": "Merge branch 'master' into feature/ml-inference-feature-importance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3761a6fe18ec0edb9af48b5a33d06483900d8c06", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/3761a6fe18ec0edb9af48b5a33d06483900d8c06", "committedDate": "2020-02-12T19:03:53Z", "message": "minor fix ups"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ca4875d52c5c4f8f196907dbf8fde8af289a81b", "committedDate": "2020-02-12T19:04:02Z", "message": "Merge branch 'feature/ml-inference-feature-importance' of github.com:benwtrent/elasticsearch into feature/ml-inference-feature-importance"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4MjQ2MDk3", "url": "https://github.com/elastic/elasticsearch/pull/52218#pullrequestreview-358246097", "createdAt": "2020-02-13T14:12:43Z", "commit": {"oid": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNDoxMjo0M1rOFpVPVw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xM1QxNDo1NTo1M1rOFpW6Ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODg4MzkyNw==", "bodyText": "You might be able to use the macro from https://github.com/elastic/elasticsearch/pull/52283/files#diff-876579125ed69329aeee2dff00706206R909 to avoid duplicating this text.", "url": "https://github.com/elastic/elasticsearch/pull/52218#discussion_r378883927", "createdAt": "2020-02-13T14:12:43Z", "author": {"login": "droberts195"}, "path": "docs/reference/ingest/processors/inference.asciidoc", "diffHunk": "@@ -44,6 +44,12 @@ include::common-options.asciidoc[]\n Specifies the field to which the inference prediction is written. Defaults to \n `predicted_value`.\n \n+`num_top_feature_importance_values`::\n+(Optional, integer)\n+If set, feature importance for the top\n+most important features will be computed. Importance is calculated\n+using the SHAP (SHapley Additive exPlanations) method as described in", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODkxMTMxNA==", "bodyText": "If it is possible that this can be called from two different threads around the same time then there is a bigger problem that making this synchronized will not solve.  In the private featureImportance(List<Double>, Map<String, String> featureDecoder) method above it would be possible for a simultaneous call to calculateNodeEstimatesIfNeeded() has changed maxDepth but not nodeEstimates at the time when these members are being read in featureImportance().\nIf multithreaded access to Tree objects is possible then the featureImportance(List<Double>, Map<String, String> featureDecoder) method needs to be synchronized and this method needs a comment saying it must only be called from featureImportance(List<Double>, Map<String, String> featureDecoder).  Then nodeEstimates and maxDepth wouldn't need to be volatile.", "url": "https://github.com/elastic/elasticsearch/pull/52218#discussion_r378911314", "createdAt": "2020-02-13T14:55:53Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/trainedmodel/tree/Tree.java", "diffHunk": "@@ -261,12 +267,146 @@ public void validate() {\n         detectCycle();\n     }\n \n+    @Override\n+    public Map<String, Double> featureImportance(Map<String, Object> fields, Map<String, String> featureDecoder) {\n+        if (nodes.stream().allMatch(n -> n.getNumberSamples() == 0)) {\n+            throw ExceptionsHelper.badRequestException(\"[tree_structure.number_samples] must be greater than zero for feature importance\");\n+        }\n+        List<Double> features = featureNames.stream()\n+            .map(f -> InferenceHelpers.toDouble(MapHelper.dig(f, fields)))\n+            .collect(Collectors.toList());\n+        return featureImportance(features, featureDecoder);\n+    }\n+\n+    private Map<String, Double> featureImportance(List<Double> fieldValues, Map<String, String> featureDecoder) {\n+        calculateNodeEstimatesIfNeeded();\n+        double[] featureImportance = new double[fieldValues.size()];\n+        ShapPath initialPath = new ShapPath(this.maxDepth + 1);\n+        shapRecursive(fieldValues, this.nodeEstimates, initialPath, 0, 1.0, 1.0, -1, featureImportance);\n+        return InferenceHelpers.decodeFeatureImportances(featureDecoder,\n+            IntStream.range(0, featureImportance.length)\n+                .boxed()\n+                .collect(Collectors.toMap(featureNames::get, i -> featureImportance[i])));\n+    }\n+\n+    //TODO synchronized?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7ca4875d52c5c4f8f196907dbf8fde8af289a81b"}, "originalPosition": 110}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d14185f8c5e6ec5a033903055edfeecdc4054ac", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d14185f8c5e6ec5a033903055edfeecdc4054ac", "committedDate": "2020-02-13T19:47:05Z", "message": "synchronizing depth and estimation calculation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU4OTQ3MjEw", "url": "https://github.com/elastic/elasticsearch/pull/52218#pullrequestreview-358947210", "createdAt": "2020-02-14T13:42:50Z", "commit": {"oid": "2d14185f8c5e6ec5a033903055edfeecdc4054ac"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ae4e03462ca4c580b19958327c113586be99079", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ae4e03462ca4c580b19958327c113586be99079", "committedDate": "2020-02-20T21:11:53Z", "message": "adjusting algorithm for faster performance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9cec51f2266f8609205dfb441baefe869825c7fa", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/9cec51f2266f8609205dfb441baefe869825c7fa", "committedDate": "2020-02-20T21:14:57Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-inference-feature-importance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a672238e28f8d188cd29c6c454f0686f557b0cd", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a672238e28f8d188cd29c6c454f0686f557b0cd", "committedDate": "2020-02-21T15:06:25Z", "message": "fixing initialization and copy forward"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65c798a297d48935e0e80ffef7642aaf5916c498", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/65c798a297d48935e0e80ffef7642aaf5916c498", "committedDate": "2020-02-21T15:12:04Z", "message": "Merge branch 'master' into feature/ml-inference-feature-importance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc761612fb517de8654b42866b04c1270520f0ca", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc761612fb517de8654b42866b04c1270520f0ca", "committedDate": "2020-02-21T19:15:48Z", "message": "fixing docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8b7fd0c735060da37a7b170836e7f4fce62e89a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8b7fd0c735060da37a7b170836e7f4fce62e89a", "committedDate": "2020-02-21T19:15:59Z", "message": "erge branch 'feature/ml-inference-feature-importance' of github.com:benwtrent/elasticsearch into feature/ml-inference-feature-importance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01638f80566ca1371103d96c0a6e4164977e48fc", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/01638f80566ca1371103d96c0a6e4164977e48fc", "committedDate": "2020-02-21T20:34:11Z", "message": "making infer MT safe"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2568, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}