{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1NTk0ODMy", "number": 58214, "title": "Fix Snapshot Abort Not Waiting for Data Nodes", "bodyText": "This was a really subtle bug that we introduced a long time ago.\nIf a shard snapshot is in aborted state but hasn't started snapshotting on a node\nwe can only send the failed notification for it if the shard was actually supposed\nto execute on the local node.\nWithout this fix, if shard snapshots were spread out across at least two data nodes\n(so that each data node does not have all the primaries) the abort would actually\nnever wait on the data nodes. This isn't a big deal with uuid shard generations\nbut could lead to potential corruption on S3 when using numeric shard generations\n(albeit very unlikely now that we have the 3 minute wait there).\nAnother negative side-effect of this bug was that master would receive a lot more\nshard status update messages for aborted shards since each data node not assigned\na primary would send one message for that primary.", "createdAt": "2020-06-17T04:26:54Z", "url": "https://github.com/elastic/elasticsearch/pull/58214", "merged": true, "mergeCommit": {"oid": "1d3032faa90d60173593817eb167e1d330e65a3b"}, "closed": true, "closedAt": "2020-06-17T08:37:26Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsCGoOAH2gAyNDM1NTk0ODMyOjk3NDIwNjU5NTZiYzJmY2I0MmVhMTUwZmI0NDlhMmZkMTJhMzQzMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsFUMeAFqTQzMjE1OTk0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9742065956bc2fcb42ea150fb449a2fd12a3432a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9742065956bc2fcb42ea150fb449a2fd12a3432a", "committedDate": "2020-06-17T04:25:48Z", "message": "Fix Snapshot Abort Not Waiting for all Data Nodes\n\nThis was a really subtle bug that we introduced a long time ago.\nIf a shard snapshot is in aborted state but hasn't started snapshotting on a node\nwe can only send the failed notification for it if the shard was actually supposed\nto execute on the local node.\nWithout this fix, if shard snapshots were spread out across at least two data nodes\n(so that each data node does not have all the primaries) the abort would actually\nnever wait on the data nodes. This isn't a big deal with uuid shard generations\nbut could lead to potential corruption on S3 when using numeric shard generations\n(albeit very unlikely now that we have the 3 minute wait there).\nAnother negative side-effect of this bug was that master would receive a lot more\nshard status update messages for aborted shards since each data node not assigned\na primary would send one message for that primary."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMDkwNzk5", "url": "https://github.com/elastic/elasticsearch/pull/58214#pullrequestreview-432090799", "createdAt": "2020-06-17T06:23:03Z", "commit": {"oid": "9742065956bc2fcb42ea150fb449a2fd12a3432a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjoyMzowM1rOGk3OVg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QwNjoyMzowM1rOGk3OVg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTMwNjcxMA==", "bodyText": "Can we avoid the sleep here? For example by waiting for the data node to have applied the cluster state with the aborted snapshots, and showing that no outgoing message was sent to the master?", "url": "https://github.com/elastic/elasticsearch/pull/58214#discussion_r441306710", "createdAt": "2020-06-17T06:23:03Z", "author": {"login": "ywelsch"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/DedicatedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -1415,6 +1415,36 @@ public void testRetentionLeasesClearedOnRestore() throws Exception {\n         assertFalse(restoredRetentionLeases.toString() + \" has no \" + leaseId, restoredRetentionLeases.contains(leaseId));\n     }\n \n+    public void testAbortWaitsOnDataNode() throws Exception {\n+        internalCluster().startMasterOnlyNode();\n+        final String dataNodeName = internalCluster().startDataOnlyNode();\n+        final String indexName = \"test-index\";\n+        createIndex(indexName);\n+        indexDoc(indexName, \"some_id\", \"foo\", \"bar\");\n+\n+        internalCluster().startDataOnlyNode();\n+\n+        final String repoName = \"test-repo\";\n+        createRepository(repoName, \"mock\", randomRepoPath());\n+        blockAllDataNodes(repoName);\n+        final String snapshotName = \"test-snap\";\n+        final ActionFuture<CreateSnapshotResponse> snapshotResponse =\n+                client().admin().cluster().prepareCreateSnapshot(repoName, snapshotName).setWaitForCompletion(true).execute();\n+        waitForBlock(dataNodeName, repoName, TimeValue.timeValueSeconds(30L));\n+\n+        logger.info(\"--> abort snapshot\");\n+        final ActionFuture<AcknowledgedResponse> deleteResponse =\n+                client().admin().cluster().prepareDeleteSnapshot(repoName, snapshotName).execute();\n+\n+        logger.info(\"--> wait for 5s to give data nodes some time to process the updated shard snapshot status\");\n+        TimeUnit.SECONDS.sleep(5L);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9742065956bc2fcb42ea150fb449a2fd12a3432a"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "192508cc964672c7abbf6001c9ecc30da1ecf4d3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/192508cc964672c7abbf6001c9ecc30da1ecf4d3", "committedDate": "2020-06-17T07:39:12Z", "message": "nicer test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b260f987a7155a5be56b1f21de7efbde220894d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b260f987a7155a5be56b1f21de7efbde220894d", "committedDate": "2020-06-17T07:39:29Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-abort-bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMTU5OTQ5", "url": "https://github.com/elastic/elasticsearch/pull/58214#pullrequestreview-432159949", "createdAt": "2020-06-17T08:10:20Z", "commit": {"oid": "7b260f987a7155a5be56b1f21de7efbde220894d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 561, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}