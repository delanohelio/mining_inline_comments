{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0NTE0MDYz", "number": 53192, "title": "[ML] fixing data frame analysis test when two jobs are started in succession quickly", "bodyText": "A previous change (#53029) is causing analysis jobs to wait for certain indices to be made available. While this it is good for jobs to wait, they could fail early on _start.\nThis change will cause the persistent task to continually retry node assignment when the failure is due to shards not being available.\nIf the shards are not available by the time timeout is reached by the predicate, it is treated as a _start failure and the task is canceled.\nFor tasks seeking a new assignment after a node failure, that behavior is unchanged.\ncloses #53188", "createdAt": "2020-03-05T21:39:32Z", "url": "https://github.com/elastic/elasticsearch/pull/53192", "merged": true, "mergeCommit": {"oid": "d2740c2cfdd6c7c10d1a5a300ce8651f8a586e29"}, "closed": true, "closedAt": "2020-03-10T11:28:41Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKyhPQgH2gAyMzg0NTE0MDYzOmJjYWE0MjU1ZjQzMmYyNjBhYTc0ODJkNWJmNjJhZWE3MzUzMjA5YjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMPcKxgFqTM3MTgwODExMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcaa4255f432f260aa7482d5bf62aea7353209b2", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcaa4255f432f260aa7482d5bf62aea7353209b2", "committedDate": "2020-03-05T21:36:53Z", "message": "[ML] fixing data frame analysis test when two jobs are started in succession quickly"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "603d23d033bc4ad224ab3f865684b920c7e76c34", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/603d23d033bc4ad224ab3f865684b920c7e76c34", "committedDate": "2020-03-06T13:51:12Z", "message": "allow multiple assignment attempts when primary shards are inactive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04909d3a2998f3cfb3a8a4d375606c217978f00b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/04909d3a2998f3cfb3a8a4d375606c217978f00b", "committedDate": "2020-03-06T15:47:04Z", "message": "Merge branch 'master' into feature/ml-dataframe-fix-test-53188"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "150a5211809cbd04c6c6eb135fab2ce45f7058b0", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/150a5211809cbd04c6c6eb135fab2ce45f7058b0", "committedDate": "2020-03-06T15:47:41Z", "message": "unmuting classificationit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwNDMxOTU2", "url": "https://github.com/elastic/elasticsearch/pull/53192#pullrequestreview-370431956", "createdAt": "2020-03-06T15:59:06Z", "commit": {"oid": "150a5211809cbd04c6c6eb135fab2ce45f7058b0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo1OTowNlrOFy936g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNlQxNTo1OTowNlrOFy936g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODk4Njg1OA==", "bodyText": "The risk of mistakes in future maintenance would be reduced if the string \"], because not all primary shards are active for the following indices [\" from old line 587 was put in a constant and that same constant was used here too.", "url": "https://github.com/elastic/elasticsearch/pull/53192#discussion_r388986858", "createdAt": "2020-03-06T15:59:06Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -450,9 +470,15 @@ public boolean test(PersistentTasksCustomMetaData.PersistentTask<?> persistentTa\n                 return true;\n             }\n \n-            if (assignment != null && assignment.equals(PersistentTasksCustomMetaData.INITIAL_ASSIGNMENT) == false &&\n-                assignment.isAssigned() == false) {\n-                // Assignment has failed despite passing our \"fast fail\" validation\n+            if (assignment != null\n+                && assignment.equals(PersistentTasksCustomMetaData.INITIAL_ASSIGNMENT) == false\n+                && assignment.isAssigned() == false) {\n+                assignmentExplanation = assignment.getExplanation();\n+                // Assignment failed due to primary shard check.\n+                // This is hopefully intermittent and we should allow another assignment attempt.\n+                if (assignmentExplanation.contains(\"not all primary shards are active\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "150a5211809cbd04c6c6eb135fab2ce45f7058b0"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65aac0a611b0e5d5a483a36a87c8c55fb5376ea3", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/65aac0a611b0e5d5a483a36a87c8c55fb5376ea3", "committedDate": "2020-03-06T18:02:15Z", "message": "Merge branch 'master' into feature/ml-dataframe-fix-test-53188"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "41826834c47bc0ef6c1ea9b279fb25fce09f4ee5", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/41826834c47bc0ef6c1ea9b279fb25fce09f4ee5", "committedDate": "2020-03-06T18:06:04Z", "message": "extracting active shards message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "235638e54a43be870fdc08f5b30bd91f58bd6b4a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/235638e54a43be870fdc08f5b30bd91f58bd6b4a", "committedDate": "2020-03-09T12:56:16Z", "message": "Merge branch 'master' into feature/ml-dataframe-fix-test-53188"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e1084bc68f981ddb9f1bde89daf71f3bd4568fb", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e1084bc68f981ddb9f1bde89daf71f3bd4568fb", "committedDate": "2020-03-09T17:03:33Z", "message": "Merge branch 'master' into feature/ml-dataframe-fix-test-53188"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxODA4MTEz", "url": "https://github.com/elastic/elasticsearch/pull/53192#pullrequestreview-371808113", "createdAt": "2020-03-10T09:52:31Z", "commit": {"oid": "8e1084bc68f981ddb9f1bde89daf71f3bd4568fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1815, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}