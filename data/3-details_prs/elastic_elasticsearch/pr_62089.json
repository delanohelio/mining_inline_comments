{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgxOTcwMDU3", "number": 62089, "title": "Convert some more mapping tests to MapperServiceTestCase", "bodyText": "We don't need to extend ESSingleNodeTestCase for all these tests.", "createdAt": "2020-09-08T11:17:21Z", "url": "https://github.com/elastic/elasticsearch/pull/62089", "merged": true, "mergeCommit": {"oid": "98590517f5ecb504874ca24c9d01b5d092b79360"}, "closed": true, "closedAt": "2020-09-08T16:25:02Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdGlXLTgH2gAyNDgxOTcwMDU3OjdiNjYyODY5ZmYzN2UwNWY5MWQ2MDYyYzYxMmViYmU0ZWU5OWMwYjA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdG5c7ZAH2gAyNDgxOTcwMDU3OjA3NWQ2NDc3MDQxNmI3MDQwODBhNTdlMDRlNDE4MjQ0NmU3NmJlN2Q=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7b662869ff37e05f91d6062c612ebbe4ee99c0b0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b662869ff37e05f91d6062c612ebbe4ee99c0b0", "committedDate": "2020-09-07T16:12:35Z", "message": "Convert CopyToMapperTests to MappingServiceTestCase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a", "committedDate": "2020-09-08T11:15:25Z", "message": "Convert a bunch of mapping tests to MapperServiceTestCase"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDM0OTQx", "url": "https://github.com/elastic/elasticsearch/pull/62089#pullrequestreview-484034941", "createdAt": "2020-09-08T11:18:55Z", "commit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMToxODo1NlrOHOYUTw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMToyMTo0N1rOHOYZzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MDUyNw==", "bodyText": "This one is used by some tests in DocumentParserTests which load mappings defined in an external file.  I'm also open to just rewriting it so that it's all done in java code.", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484840527", "createdAt": "2020-09-08T11:18:56Z", "author": {"login": "romseygeek"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperServiceTestCase.java", "diffHunk": "@@ -91,6 +91,12 @@ protected final DocumentMapper createDocumentMapper(XContentBuilder mappings) th\n         return createMapperService(mappings).documentMapper();\n     }\n \n+    protected final DocumentMapper createDocumentMapper(String mappings) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MTMwMw==", "bodyText": "Your wish is my command!", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484841303", "createdAt": "2020-09-08T11:20:28Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentParserTests.java", "diffHunk": "@@ -57,103 +48,89 @@\n import static org.hamcrest.Matchers.not;\n import static org.hamcrest.Matchers.notNullValue;\n \n-// TODO: make this a real unit test", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MTkzMg==", "bodyText": "There are a bunch of tests here that check that if you have a field called foo it doesn't get confused if you also have a type called foo.  Seeing as we don't have types anymore, apart from _doc, and I don't think that you can actually create a field called _doc I'm not sure they're strictly necessary any more, but I've kept them in for now.", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484841932", "createdAt": "2020-09-08T11:21:47Z", "author": {"login": "romseygeek"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentParserTests.java", "diffHunk": "@@ -1211,88 +1005,66 @@ public void testSimpleParserNoTypeNoId() throws Exception {\n \n     public void testAttributes() throws Exception {\n         String mapping = copyToStringFromClasspath(\"/org/elasticsearch/index/mapper/simple/test-mapping.json\");\n-        DocumentMapperParser parser = createIndex(\"test\").mapperService().documentMapperParser();\n-        DocumentMapper docMapper = parser.parse(\"person\", new CompressedXContent(mapping));\n+\n+        DocumentMapper docMapper = createDocumentMapper(mapping);\n \n         assertThat((String) docMapper.meta().get(\"param1\"), equalTo(\"value1\"));\n \n         String builtMapping = docMapper.mappingSource().string();\n-        DocumentMapper builtDocMapper = parser.parse(\"person\", new CompressedXContent(builtMapping));\n+        DocumentMapper builtDocMapper = createDocumentMapper(builtMapping);\n         assertThat((String) builtDocMapper.meta().get(\"param1\"), equalTo(\"value1\"));\n     }\n \n     public void testNoDocumentSent() throws Exception {\n-        IndexService indexService = createIndex(\"test\");\n-        DocumentMapper docMapper = new DocumentMapper.Builder(\n-                new RootObjectMapper.Builder(\"person\")\n-                        .add(new ObjectMapper.Builder(\"name\")\n-                            .add(new TextFieldMapper.Builder(\"first\").store(true).index(false))),\n-            indexService.mapperService()).build(indexService.mapperService());\n-\n+        DocumentMapper docMapper = createDocumentMapper(mapping(b -> {}));\n         BytesReference json = new BytesArray(\"\".getBytes(StandardCharsets.UTF_8));\n-        try {\n-            docMapper.parse(new SourceToParse(\"test\", \"1\", json, XContentType.JSON)).rootDoc();\n-            fail(\"this point is never reached\");\n-        } catch (MapperParsingException e) {\n-            assertThat(e.getMessage(), equalTo(\"failed to parse, document is empty\"));\n-        }\n+        MapperParsingException e = expectThrows(MapperParsingException.class,\n+            () -> docMapper.parse(new SourceToParse(\"test\", \"1\", json, XContentType.JSON)));\n+        assertThat(e.getMessage(), equalTo(\"failed to parse, document is empty\"));\n     }\n \n     public void testNoLevel() throws Exception {\n-        String defaultMapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\").endObject().endObject());\n-\n-        DocumentMapper defaultMapper = createIndex(\"test\").mapperService().documentMapperParser()\n-            .parse(\"type\", new CompressedXContent(defaultMapping));\n-\n-        ParsedDocument doc = defaultMapper.parse(new SourceToParse(\"test\", \"1\", BytesReference\n-                .bytes(XContentFactory.jsonBuilder()\n-                        .startObject()\n-                        .field(\"test1\", \"value1\")\n-                        .field(\"test2\", \"value2\")\n-                        .startObject(\"inner\").field(\"inner_field\", \"inner_value\").endObject()\n-                        .endObject()),\n-                XContentType.JSON));\n-\n+        DocumentMapper defaultMapper = createDocumentMapper(mapping(b -> {}));\n+        ParsedDocument doc = defaultMapper.parse(source(b -> {\n+            b.field(\"test1\", \"value1\");\n+            b.field(\"test2\", \"value2\");\n+            b.startObject(\"inner\").field(\"inner_field\", \"inner_value\").endObject();\n+        }));\n         assertThat(doc.rootDoc().get(\"test1\"), equalTo(\"value1\"));\n         assertThat(doc.rootDoc().get(\"test2\"), equalTo(\"value2\"));\n         assertThat(doc.rootDoc().get(\"inner.inner_field\"), equalTo(\"inner_value\"));\n     }\n \n-    public void testTypeLevel() throws Exception {\n-        String defaultMapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\").endObject().endObject());\n+    // TODO do we still need all this tests for 'type' at the bottom level now that\n+    // we no longer have types?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "originalPosition": 1651}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7c886ed29417f32e4aeb00679edb6669eeaf8f0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7c886ed29417f32e4aeb00679edb6669eeaf8f0", "committedDate": "2020-09-08T11:40:44Z", "message": "checkstyle dammit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0MDgzODAw", "url": "https://github.com/elastic/elasticsearch/pull/62089#pullrequestreview-484083800", "createdAt": "2020-09-08T12:30:58Z", "commit": {"oid": "e7c886ed29417f32e4aeb00679edb6669eeaf8f0"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjozMDo1OVrOHOanhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQxMjozNTozNlrOHOaxyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg3ODIxMg==", "bodyText": "I'm not sure! we do still support indices from 7.x which have types, right?", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484878212", "createdAt": "2020-09-08T12:30:59Z", "author": {"login": "nik9000"}, "path": "server/src/test/java/org/elasticsearch/index/mapper/DocumentParserTests.java", "diffHunk": "@@ -1211,88 +1005,66 @@ public void testSimpleParserNoTypeNoId() throws Exception {\n \n     public void testAttributes() throws Exception {\n         String mapping = copyToStringFromClasspath(\"/org/elasticsearch/index/mapper/simple/test-mapping.json\");\n-        DocumentMapperParser parser = createIndex(\"test\").mapperService().documentMapperParser();\n-        DocumentMapper docMapper = parser.parse(\"person\", new CompressedXContent(mapping));\n+\n+        DocumentMapper docMapper = createDocumentMapper(mapping);\n \n         assertThat((String) docMapper.meta().get(\"param1\"), equalTo(\"value1\"));\n \n         String builtMapping = docMapper.mappingSource().string();\n-        DocumentMapper builtDocMapper = parser.parse(\"person\", new CompressedXContent(builtMapping));\n+        DocumentMapper builtDocMapper = createDocumentMapper(builtMapping);\n         assertThat((String) builtDocMapper.meta().get(\"param1\"), equalTo(\"value1\"));\n     }\n \n     public void testNoDocumentSent() throws Exception {\n-        IndexService indexService = createIndex(\"test\");\n-        DocumentMapper docMapper = new DocumentMapper.Builder(\n-                new RootObjectMapper.Builder(\"person\")\n-                        .add(new ObjectMapper.Builder(\"name\")\n-                            .add(new TextFieldMapper.Builder(\"first\").store(true).index(false))),\n-            indexService.mapperService()).build(indexService.mapperService());\n-\n+        DocumentMapper docMapper = createDocumentMapper(mapping(b -> {}));\n         BytesReference json = new BytesArray(\"\".getBytes(StandardCharsets.UTF_8));\n-        try {\n-            docMapper.parse(new SourceToParse(\"test\", \"1\", json, XContentType.JSON)).rootDoc();\n-            fail(\"this point is never reached\");\n-        } catch (MapperParsingException e) {\n-            assertThat(e.getMessage(), equalTo(\"failed to parse, document is empty\"));\n-        }\n+        MapperParsingException e = expectThrows(MapperParsingException.class,\n+            () -> docMapper.parse(new SourceToParse(\"test\", \"1\", json, XContentType.JSON)));\n+        assertThat(e.getMessage(), equalTo(\"failed to parse, document is empty\"));\n     }\n \n     public void testNoLevel() throws Exception {\n-        String defaultMapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\").endObject().endObject());\n-\n-        DocumentMapper defaultMapper = createIndex(\"test\").mapperService().documentMapperParser()\n-            .parse(\"type\", new CompressedXContent(defaultMapping));\n-\n-        ParsedDocument doc = defaultMapper.parse(new SourceToParse(\"test\", \"1\", BytesReference\n-                .bytes(XContentFactory.jsonBuilder()\n-                        .startObject()\n-                        .field(\"test1\", \"value1\")\n-                        .field(\"test2\", \"value2\")\n-                        .startObject(\"inner\").field(\"inner_field\", \"inner_value\").endObject()\n-                        .endObject()),\n-                XContentType.JSON));\n-\n+        DocumentMapper defaultMapper = createDocumentMapper(mapping(b -> {}));\n+        ParsedDocument doc = defaultMapper.parse(source(b -> {\n+            b.field(\"test1\", \"value1\");\n+            b.field(\"test2\", \"value2\");\n+            b.startObject(\"inner\").field(\"inner_field\", \"inner_value\").endObject();\n+        }));\n         assertThat(doc.rootDoc().get(\"test1\"), equalTo(\"value1\"));\n         assertThat(doc.rootDoc().get(\"test2\"), equalTo(\"value2\"));\n         assertThat(doc.rootDoc().get(\"inner.inner_field\"), equalTo(\"inner_value\"));\n     }\n \n-    public void testTypeLevel() throws Exception {\n-        String defaultMapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\").endObject().endObject());\n+    // TODO do we still need all this tests for 'type' at the bottom level now that\n+    // we no longer have types?", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MTkzMg=="}, "originalCommit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "originalPosition": 1651}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg4MDI2NA==", "bodyText": "Its cool.", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484880264", "createdAt": "2020-09-08T12:34:36Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperServiceTestCase.java", "diffHunk": "@@ -91,6 +91,12 @@ protected final DocumentMapper createDocumentMapper(XContentBuilder mappings) th\n         return createMapperService(mappings).documentMapper();\n     }\n \n+    protected final DocumentMapper createDocumentMapper(String mappings) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg0MDUyNw=="}, "originalCommit": {"oid": "919d9a0b2d86d44286c5dabf9ec097f31c4a7c9a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDg4MDg0MQ==", "bodyText": "This one might should be private. Or we should document why you'd want to call this one rather than the other one.", "url": "https://github.com/elastic/elasticsearch/pull/62089#discussion_r484880841", "createdAt": "2020-09-08T12:35:36Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/index/mapper/MapperServiceTestCase.java", "diffHunk": "@@ -155,7 +161,23 @@ protected final SourceToParse source(CheckedConsumer<XContentBuilder, IOExceptio\n      * Merge a new mapping into the one in the provided {@link MapperService}.\n      */\n     protected final void merge(MapperService mapperService, XContentBuilder mapping) throws IOException {\n-        mapperService.merge(null, new CompressedXContent(BytesReference.bytes(mapping)), MapperService.MergeReason.MAPPING_UPDATE);\n+        merge(mapperService, MapperService.MergeReason.MAPPING_UPDATE, mapping);\n+    }\n+\n+    protected final void merge(MapperService mapperService, String mapping) throws IOException {\n+        mapperService.merge(null, new CompressedXContent(mapping), MapperService.MergeReason.MAPPING_UPDATE);\n+    }\n+\n+    protected final void merge(MapperService mapperService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7c886ed29417f32e4aeb00679edb6669eeaf8f0"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c255471efe8747a87976fedd8d62374046fda7c0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/c255471efe8747a87976fedd8d62374046fda7c0", "committedDate": "2020-09-08T12:43:01Z", "message": "Merge remote-tracking branch 'origin/master' into mapper/copytomappertests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a87f3aa4a356206fccc082e813fa66fb6f7e771", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a87f3aa4a356206fccc082e813fa66fb6f7e771", "committedDate": "2020-09-08T12:48:22Z", "message": "javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "349de0cf4c983eb29066ab55523832b16c27b0a4", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/349de0cf4c983eb29066ab55523832b16c27b0a4", "committedDate": "2020-09-08T13:56:05Z", "message": "Merge branch 'master' into mapper/copytomappertests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "075d64770416b704080a57e04e4182446e76be7d", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/075d64770416b704080a57e04e4182446e76be7d", "committedDate": "2020-09-08T15:36:58Z", "message": "Merge branch 'master' into mapper/copytomappertests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4751, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}