{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MzU0NjE5", "number": 55598, "title": "Make AsyncSearchIndexService reusable", "bodyText": "EQL will require very similar functionality to async search. This PR refactors\nAsyncSearchIndexService to make it reusable for EQL.\nSupersedes #55119\nRelates to #49638", "createdAt": "2020-04-22T15:10:31Z", "url": "https://github.com/elastic/elasticsearch/pull/55598", "merged": true, "mergeCommit": {"oid": "3bf2df6037ae2d67132aed5714af3ce137c3ab01"}, "closed": true, "closedAt": "2020-04-23T18:23:48Z", "author": {"login": "imotov"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcaJs-ZgH2gAyNDA3MzU0NjE5OmRlYWVhZTFhNWEwYWVmMjE4YTAxOWY5NTZlZTQ2ODJjN2RlOTU1Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcadQcJgH2gAyNDA3MzU0NjE5OjA1OWU3YTc4NGNlNTkzM2M1Y2JmODA4MDM0ZGRiNDNkMzk2NmIzZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/deaeae1a5a0aef218a019f956ee4682c7de955b9", "committedDate": "2020-04-22T15:06:23Z", "message": "Make AsyncSearchIndexService reusable\n\nEQL will require very similar functionality to async search. This PR refactors\nAsyncSearchIndexService to make it reusable for EQL.\n\nSupersedes #55119\nRelates to #49638"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4NTA5MjEz", "url": "https://github.com/elastic/elasticsearch/pull/55598#pullrequestreview-398509213", "createdAt": "2020-04-22T19:30:06Z", "commit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxOTozMDowNlrOGKHaig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMlQxOTo1NjozMVrOGKIyWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2MDQyNg==", "bodyText": "will expire? Can you add javadocs at the class level too?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413260426", "createdAt": "2020-04-22T19:30:06Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncResponse.java", "diffHunk": "@@ -0,0 +1,19 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+public interface AsyncResponse extends Writeable {\n+    /**\n+     * When this response will expired as a timestamp in milliseconds since epoch.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2MzYwOA==", "bodyText": "given that it's not part of the interface, maybe storing results should not be mentioned?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413263608", "createdAt": "2020-04-22T19:33:50Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTask.java", "diffHunk": "@@ -0,0 +1,24 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import java.util.Map;\n+\n+/**\n+ * A task that supports asynchronous execution and safe temporary storage of results", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI2Nzg4NA==", "bodyText": "does this need to be abstract and do we really need two implementers for it? Could we rather make it final and have two different instances of this same class, with a different underlying index service?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413267884", "createdAt": "2020-04-22T19:38:24Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskMaintenanceService.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterChangedEvent;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateListener;\n+import org.elasticsearch.cluster.routing.IndexRoutingTable;\n+import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n+import org.elasticsearch.gateway.GatewayService;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.reindex.DeleteByQueryAction;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.elasticsearch.threadpool.Scheduler;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.elasticsearch.xpack.core.async.AsyncTaskIndexService.EXPIRATION_TIME_FIELD;\n+\n+/**\n+ * A service that runs a periodic cleanup over the async execution index.\n+ */\n+public abstract class AsyncTaskMaintenanceService implements Releasable, ClusterStateListener {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3Mjc4OA==", "bodyText": "shall we make this final?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413272788", "createdAt": "2020-04-22T19:46:19Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskIndexService.java", "diffHunk": "@@ -50,16 +51,13 @@\n \n import static org.elasticsearch.common.xcontent.XContentFactory.jsonBuilder;\n import static org.elasticsearch.index.mapper.MapperService.SINGLE_MAPPING_NAME;\n-import static org.elasticsearch.xpack.core.ClientHelper.ASYNC_SEARCH_ORIGIN;\n import static org.elasticsearch.xpack.core.security.authc.AuthenticationField.AUTHENTICATION_KEY;\n \n /**\n- * A service that exposes the CRUD operations for the async-search index.\n+ * A service that exposes the CRUD operations for the async task-specific index.\n  */\n-class AsyncSearchIndexService {\n-    private static final Logger logger = LogManager.getLogger(AsyncSearchIndexService.class);\n-\n-    public static final String INDEX = \".async-search\";\n+public class AsyncTaskIndexService<R extends AsyncResponse> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3MzAwNw==", "bodyText": "make it final?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413273007", "createdAt": "2020-04-22T19:46:36Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncExecutionId.java", "diffHunk": "@@ -17,14 +17,14 @@\n import java.util.Objects;\n \n /**\n- * A class that contains all information related to a submitted async search.\n+ * A class that contains all information related to a submitted async execution.\n  */\n-class AsyncSearchId {\n+public class AsyncExecutionId {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI3NjczNw==", "bodyText": "should it be the index service that provides that index name rather than having to provide it to both?", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413276737", "createdAt": "2020-04-22T19:50:39Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskMaintenanceService.java", "diffHunk": "@@ -0,0 +1,126 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.async;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.cluster.ClusterChangedEvent;\n+import org.elasticsearch.cluster.ClusterState;\n+import org.elasticsearch.cluster.ClusterStateListener;\n+import org.elasticsearch.cluster.routing.IndexRoutingTable;\n+import org.elasticsearch.common.lease.Releasable;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.concurrent.EsRejectedExecutionException;\n+import org.elasticsearch.gateway.GatewayService;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.index.reindex.DeleteByQueryAction;\n+import org.elasticsearch.index.reindex.DeleteByQueryRequest;\n+import org.elasticsearch.threadpool.Scheduler;\n+import org.elasticsearch.threadpool.ThreadPool;\n+\n+import java.util.concurrent.atomic.AtomicBoolean;\n+\n+import static org.elasticsearch.xpack.core.async.AsyncTaskIndexService.EXPIRATION_TIME_FIELD;\n+\n+/**\n+ * A service that runs a periodic cleanup over the async execution index.\n+ */\n+public abstract class AsyncTaskMaintenanceService implements Releasable, ClusterStateListener {\n+    private static final Logger logger = LogManager.getLogger(AsyncTaskMaintenanceService.class);\n+\n+    private final String index;\n+    private final String localNodeId;\n+    private final ThreadPool threadPool;\n+    private final AsyncTaskIndexService<?> indexService;\n+    private final TimeValue delay;\n+\n+    private boolean isCleanupRunning;\n+    private final AtomicBoolean isClosed = new AtomicBoolean(false);\n+    private volatile Scheduler.Cancellable cancellable;\n+\n+    public AsyncTaskMaintenanceService(String index,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzI4MjkwNQ==", "bodyText": "funny that this is what Jim had in his original PR and I made him change the constructor to accept an additional expiration time.", "url": "https://github.com/elastic/elasticsearch/pull/55598#discussion_r413282905", "createdAt": "2020-04-22T19:56:31Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/async/AsyncTaskIndexService.java", "diffHunk": "@@ -273,7 +279,8 @@ void getResponse(AsyncSearchId searchId,\n \n                 long expirationTime = (long) get.getSource().get(EXPIRATION_TIME_FIELD);\n                 String encoded = (String) get.getSource().get(RESULT_FIELD);\n-                AsyncSearchResponse response = decodeResponse(encoded, expirationTime);\n+                R response = decodeResponse(encoded);\n+                response.setExpirationTime(expirationTime);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "deaeae1a5a0aef218a019f956ee4682c7de955b9"}, "originalPosition": 247}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b803e0ef9340560b5acd216b87d82af40218049b", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/b803e0ef9340560b5acd216b87d82af40218049b", "committedDate": "2020-04-23T13:52:34Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "059e7a784ce5933c5cbf808034ddb43d3966b3df", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/059e7a784ce5933c5cbf808034ddb43d3966b3df", "committedDate": "2020-04-23T13:53:19Z", "message": "Merge remote-tracking branch 'elastic/master' into make-async-index-service-reusable-again"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 677, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}