{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMDg2ODcw", "number": 55147, "title": "Fix testCreateAndRestoreSearchableSnapshot", "bodyText": "Fixes a couple of related failures in SearchableSnapshotsIntegTests.\nFirstly, we were not correctly accounting for the case where the cache was so\nsmall that some/all files were read directly; fixed this by only asserting that\nthe cache is definitely used if the corresponding node has a cache that's large\nenough to hold the whole index.\nSecondly, we were not permitting shards to be completely empty, which might be\nthe case (rarely) if there were not many documents indexed and the distribution\nof IDs was a bit unlucky; fixed this by asserting that we get stats for at\nleast one file for the whole index, rather than for each shard separately.\nCloses #55126", "createdAt": "2020-04-14T09:59:58Z", "url": "https://github.com/elastic/elasticsearch/pull/55147", "merged": true, "mergeCommit": {"oid": "9ba3c16208fa1542d5293180a75ad88692ef2c8d"}, "closed": true, "closedAt": "2020-04-14T10:54:13Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXf9KOAH2gAyNDAzMDg2ODcwOjU3ZjkxNGYyOTNmYmQ5MDFjNzI2MzI0YmFkMmU0OTZhMDdmNTBiOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXg-vfAFqTM5Mjc5ODkyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "57f914f293fbd901c726324bad2e496a07f50b99", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/57f914f293fbd901c726324bad2e496a07f50b99", "committedDate": "2020-04-14T09:20:12Z", "message": "Allow cache skipping when cache is too small"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "523012cc74d9081e537dee15ec2f4b0c1c699b7e", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/523012cc74d9081e537dee15ec2f4b0c1c699b7e", "committedDate": "2020-04-14T09:20:13Z", "message": "Include shard ID in stats JSON"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af9ac6b5b7b168e8f40755d22d0d71746cb48f83", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/af9ac6b5b7b168e8f40755d22d0d71746cb48f83", "committedDate": "2020-04-14T09:21:58Z", "message": "More small cache tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "898532814ebc268e8aa0fd95c61b74f4a9fbed7b", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/898532814ebc268e8aa0fd95c61b74f4a9fbed7b", "committedDate": "2020-04-14T09:48:38Z", "message": "Permit empty shards"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "27e7076f666d9fed2772173c832b8a8aefc10eb3", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/27e7076f666d9fed2772173c832b8a8aefc10eb3", "committedDate": "2020-04-14T09:48:39Z", "message": "Remove AwaitsFix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad34e21a6e0fed5f92368e30fc59cbe2d40d6738", "committedDate": "2020-04-14T09:54:54Z", "message": "Fix testCreateAndRestoreSearchableSnapshot\n\nFixes a couple of related failures in SearchableSnapshotsIntegTests.\n\nFirstly, we were not correctly accounting for the case where the cache was so\nsmall that some/all files were read directly; fixed this by only asserting that\nthe cache is definitely used if the corresponding node has a cache that's large\nenough to hold the whole index.\n\nSecondly, we were not permitting shards to be completely empty, which might be\nthe case (rarely) if there were not many documents indexed and the distribution\nof IDs was a bit unlucky; fixed this by asserting that we get stats for at\nleast one file for the whole index, rather than for each shard separately.\n\nCloses #55126"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88aa9c5d9baa93da8c20858db1e216d136070bd9", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/88aa9c5d9baa93da8c20858db1e216d136070bd9", "committedDate": "2020-04-14T10:00:29Z", "message": "Imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzgwNjAy", "url": "https://github.com/elastic/elasticsearch/pull/55147#pullrequestreview-392780602", "createdAt": "2020-04-14T10:00:51Z", "commit": {"oid": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMDowMDo1MVrOGFHUuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMDowMTo0OFrOGFHWyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxNjA1Ng==", "bodyText": "Kinda unrelated change, but this was useful for debugging.", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408016056", "createdAt": "2020-04-14T10:00:51Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/searchablesnapshots/SearchableSnapshotShardStats.java", "diffHunk": "@@ -77,6 +77,7 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n             builder.field(\"index_uuid\", getIndexId().getId());\n             builder.startObject(\"shard\");\n             {\n+                builder.field(\"id\", shardRouting.shardId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAxNjU4NA==", "bodyText": "Prior to this change the smallest nonzero cache size was 1kB which was typically larger than many of the files seen in this test, so I thought this might improve coverage a bit.", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408016584", "createdAt": "2020-04-14T10:01:48Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/BaseSearchableSnapshotsIntegTestCase.java", "diffHunk": "@@ -55,7 +55,9 @@ protected Settings nodeSettings(int nodeOrdinal) {\n             builder.put(\n                 CacheService.SNAPSHOT_CACHE_SIZE_SETTING.getKey(),\n                 rarely()\n-                    ? new ByteSizeValue(randomIntBetween(0, 10), ByteSizeUnit.KB)\n+                    ? randomBoolean()\n+                        ? new ByteSizeValue(randomIntBetween(0, 10), ByteSizeUnit.KB)\n+                        : new ByteSizeValue(randomIntBetween(0, 1000), ByteSizeUnit.BYTES)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad34e21a6e0fed5f92368e30fc59cbe2d40d6738"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "951cdfaebd4b97db50f23c093c13d329c773c736", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/951cdfaebd4b97db50f23c093c13d329c773c736", "committedDate": "2020-04-14T10:05:06Z", "message": "Whitespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyNzk4OTI5", "url": "https://github.com/elastic/elasticsearch/pull/55147#pullrequestreview-392798929", "createdAt": "2020-04-14T10:27:01Z", "commit": {"oid": "951cdfaebd4b97db50f23c093c13d329c773c736"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMDoyNzowMVrOGFIRFA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xNFQxMDoyNzowMVrOGFIRFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwODAzMTUwOA==", "bodyText": "\ud83d\ude37", "url": "https://github.com/elastic/elasticsearch/pull/55147#discussion_r408031508", "createdAt": "2020-04-14T10:27:01Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -261,11 +265,33 @@ private void assertSearchableSnapshotStats(String indexName, boolean cacheEnable\n         final NumShards restoredNumShards = getNumShards(indexName);\n         assertThat(statsResponse.getStats(), hasSize(restoredNumShards.totalNumShards));\n \n+        final long totalSize = statsResponse.getStats()\n+            .stream()\n+            .flatMap(s -> s.getStats().stream())\n+            .mapToLong(SearchableSnapshotShardStats.CacheIndexInputStats::getFileLength)\n+            .sum();\n+        final Set<String> nodeIdsWithLargeEnoughCache = new HashSet<>();\n+        for (ObjectCursor<DiscoveryNode> nodeCursor : client().admin()\n+            .cluster()\n+            .prepareState()\n+            .clear()\n+            .setNodes(true)\n+            .get()\n+            .getState()\n+            .nodes()\n+            .getDataNodes()\n+            .values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "951cdfaebd4b97db50f23c093c13d329c773c736"}, "originalPosition": 60}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3538, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}