{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNTMxNTkw", "number": 52069, "title": "QL: move query AST from SQL to QL", "bodyText": "", "createdAt": "2020-02-07T17:57:45Z", "url": "https://github.com/elastic/elasticsearch/pull/52069", "merged": true, "mergeCommit": {"oid": "59368968b698652352be1bb2a60d5a357a01b978"}, "closed": true, "closedAt": "2020-02-08T21:10:09Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCDLNCgH2gAyMzcyNTMxNTkwOmUzN2Y1NGRiYmIzOGZmMjM2OWU5ZGYzOWM5YTc0MTkwNDU4ZDJhYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCE_z7gFqTM1NTQwNTAzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e37f54dbbb38ff2369e9df39c9a74190458d2aa1", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/e37f54dbbb38ff2369e9df39c9a74190458d2aa1", "committedDate": "2020-02-07T17:55:53Z", "message": "QL: move query AST from SQL to QL"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MzM2MTgx", "url": "https://github.com/elastic/elasticsearch/pull/52069#pullrequestreview-355336181", "createdAt": "2020-02-07T18:04:17Z", "commit": {"oid": "e37f54dbbb38ff2369e9df39c9a74190458d2aa1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxODowNDoxN1rOFnFeqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxODowNDoxN1rOFnFeqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjUyODU1NQ==", "bodyText": "I guess this would be the case of something like:\nSELECT * FROM test WHERE test.a = test.b\n\n\nIsn't this caught earlier?\n\nShould we add a test for this exception?", "url": "https://github.com/elastic/elasticsearch/pull/52069#discussion_r376528555", "createdAt": "2020-02-07T18:04:17Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/querydsl/query/TermsQuery.java", "diffHunk": "@@ -31,7 +34,16 @@ public TermsQuery(Source source, String term, List<Expression> values) {\n         if (values.isEmpty()) {\n             this.values = Collections.emptySet();\n         } else {\n-            this.values = new LinkedHashSet<>(Foldables.valuesOf(values, values.get(0).dataType()));\n+            DataType dt = values.get(0).dataType();\n+            Set<Object> set = new LinkedHashSet<>(CollectionUtils.mapSize(values.size()));\n+            for (Expression e : values) {\n+                if (e.foldable()) {\n+                    set.add(DataTypeConverter.convert(e.fold(), dt));\n+                } else {\n+                    throw new QlIllegalArgumentException(\"Cannot determine value for {}\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e37f54dbbb38ff2369e9df39c9a74190458d2aa1"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1Mzk2NDI3", "url": "https://github.com/elastic/elasticsearch/pull/52069#pullrequestreview-355396427", "createdAt": "2020-02-07T19:48:18Z", "commit": {"oid": "e37f54dbbb38ff2369e9df39c9a74190458d2aa1"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb55e153029c955a734324592b516503efd1782e", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb55e153029c955a734324592b516503efd1782e", "committedDate": "2020-02-07T19:59:58Z", "message": "Rework TermsQuery translation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDA1MDM2", "url": "https://github.com/elastic/elasticsearch/pull/52069#pullrequestreview-355405036", "createdAt": "2020-02-07T20:03:14Z", "commit": {"oid": "fb55e153029c955a734324592b516503efd1782e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDowMzoxNVrOFnIvfA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDowMzoxNVrOFnIvfA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MjAxMg==", "bodyText": "@matriv This case of eliminating nulls need to be moved from the query to the optimizer (maybe in a dedicated rule).\nIt seems to be inconsistent with the foldable method - currently In has a fairly scattered behavior when it comes to list that would be good to centralize.", "url": "https://github.com/elastic/elasticsearch/pull/52069#discussion_r376582012", "createdAt": "2020-02-07T20:03:15Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryTranslator.java", "diffHunk": "@@ -584,9 +590,17 @@ protected QueryTranslation asQuery(In in, boolean onAggs) {\n             else {\n                 Query q = null;\n                 if (in.value() instanceof FieldAttribute) {\n-                    FieldAttribute fa = (FieldAttribute) in.value();\n                     // equality should always be against an exact match (which is important for strings)\n-                    q = new TermsQuery(in.source(), fa.exactAttribute().name(), in.list());\n+                    FieldAttribute fa = (FieldAttribute) in.value();\n+                    List<Expression> list = in.list();\n+                    // TODO: this needs to be handled inside the optimizer", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb55e153029c955a734324592b516503efd1782e"}, "originalPosition": 67}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2679, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}