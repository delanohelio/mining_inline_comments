{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3Mzc4Njcx", "number": 61093, "title": "Use native Gradle support for --release flag", "bodyText": "With Gradle 6.6 we can use the native support for the --release compile options", "createdAt": "2020-08-13T13:16:52Z", "url": "https://github.com/elastic/elasticsearch/pull/61093", "merged": true, "mergeCommit": {"oid": "ad69f4d060cd1e0913137f0a9483169f0801941e"}, "closed": true, "closedAt": "2020-08-14T13:31:37Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-f27_gH2gAyNDY3Mzc4NjcxOmIzZjliMjlmMWVjZmRmY2Q1ZDEwNzQ0ZDMxNGM1ODdjZWI0NjhlOWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-z7ujgH2gAyNDY3Mzc4NjcxOjczZTI2NTViNzE3NzY5ZjkyMzJmM2ZlNjk3YzFiOWZjYjcwYTIzZjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b3f9b29f1ecfdfcd5d10744d314c587ceb468e9c", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3f9b29f1ecfdfcd5d10744d314c587ceb468e9c", "committedDate": "2020-08-13T13:16:27Z", "message": "Use native Gradle support for --release flag\n\n- With Gradle 6.6 we can use the native support for the --release compile options"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MDAwNDIx", "url": "https://github.com/elastic/elasticsearch/pull/61093#pullrequestreview-467000421", "createdAt": "2020-08-13T17:52:10Z", "commit": {"oid": "b3f9b29f1ecfdfcd5d10744d314c587ceb468e9c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNzo1MjoxMFrOHAXCig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNzo1MjoxMFrOHAXCig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDEzOTUzMA==", "bodyText": "Should we use a Provider here so we an avoid any future issues of configuration ordering if individual modules override target compatibility version?", "url": "https://github.com/elastic/elasticsearch/pull/61093#discussion_r470139530", "createdAt": "2020-08-13T17:52:10Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -173,21 +173,14 @@ public static void configureCompile(Project project) {\n                 compileOptions.setEncoding(\"UTF-8\");\n                 compileOptions.setIncremental(true);\n \n-                // TODO: use native Gradle support for --release when available (cf. https://github.com/gradle/gradle/issues/2510)\n                 final JavaVersion targetCompatibilityVersion = JavaVersion.toVersion(compileTask.getTargetCompatibility());\n-                compilerArgs.add(\"--release\");\n-                compilerArgs.add(targetCompatibilityVersion.getMajorVersion());\n-\n+                compileOptions.getRelease().set(Integer.parseInt(targetCompatibilityVersion.getMajorVersion()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3f9b29f1ecfdfcd5d10744d314c587ceb468e9c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47", "committedDate": "2020-08-13T20:33:39Z", "message": "Add test coverage for release flag handling\n\n- use provider api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTEwNjUy", "url": "https://github.com/elastic/elasticsearch/pull/61093#pullrequestreview-467110652", "createdAt": "2020-08-13T20:35:10Z", "commit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNToxMFrOHAcrsw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNToxMFrOHAcrsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzMTk4Nw==", "bodyText": "just removed unused code", "url": "https://github.com/elastic/elasticsearch/pull/61093#discussion_r470231987", "createdAt": "2020-08-13T20:35:10Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -140,14 +139,6 @@ public static void configureCompile(Project project) {\n         java.setSourceCompatibility(BuildParams.getMinimumRuntimeVersion());\n         java.setTargetCompatibility(BuildParams.getMinimumRuntimeVersion());\n \n-        Function<File, String> canonicalPath = file -> {\n-            try {\n-                return file.getCanonicalPath();\n-            } catch (IOException e) {\n-                throw new GradleException(\"Failed to get canonical path for \" + file, e);\n-            }\n-        };\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTEwOTEy", "url": "https://github.com/elastic/elasticsearch/pull/61093#pullrequestreview-467110912", "createdAt": "2020-08-13T20:35:35Z", "commit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNTozNVrOHAcsjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNTozNVrOHAcsjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzMjIwNQ==", "bodyText": "TODO: discuss workaround and fix for the need with gradle core team", "url": "https://github.com/elastic/elasticsearch/pull/61093#discussion_r470232205", "createdAt": "2020-08-13T20:35:35Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -172,26 +163,26 @@ public static void configureCompile(Project project) {\n \n                 compileOptions.setEncoding(\"UTF-8\");\n                 compileOptions.setIncremental(true);\n-\n-                // TODO: use native Gradle support for --release when available (cf. https://github.com/gradle/gradle/issues/2510)\n-                final JavaVersion targetCompatibilityVersion = JavaVersion.toVersion(compileTask.getTargetCompatibility());\n-                compilerArgs.add(\"--release\");\n-                compilerArgs.add(targetCompatibilityVersion.getMajorVersion());\n-\n+                compileTask.getConventionMapping().map(\"sourceCompatibility\", () -> java.getSourceCompatibility().toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTEyMTUx", "url": "https://github.com/elastic/elasticsearch/pull/61093#pullrequestreview-467112151", "createdAt": "2020-08-13T20:37:36Z", "commit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNzozNlrOHAcw1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozNzozNlrOHAcw1w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzMzMwMw==", "bodyText": "TODO: the only left reason for this afterEvaluate is that compileOptions.get/setArguments(...) is not using the provider api. Discuss this and maybe raise a ticket at gradle core.", "url": "https://github.com/elastic/elasticsearch/pull/61093#discussion_r470233303", "createdAt": "2020-08-13T20:37:36Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -140,14 +139,6 @@ public static void configureCompile(Project project) {\n         java.setSourceCompatibility(BuildParams.getMinimumRuntimeVersion());\n         java.setTargetCompatibility(BuildParams.getMinimumRuntimeVersion());\n \n-        Function<File, String> canonicalPath = file -> {\n-            try {\n-                return file.getCanonicalPath();\n-            } catch (IOException e) {\n-                throw new GradleException(\"Failed to get canonical path for \" + file, e);\n-            }\n-        };\n-\n         project.afterEvaluate(p -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd0ce06b08e1245b8387011d1c3ef67043f2dba5", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd0ce06b08e1245b8387011d1c3ef67043f2dba5", "committedDate": "2020-08-13T20:38:20Z", "message": "Minor cleanup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3MTEzMDU0", "url": "https://github.com/elastic/elasticsearch/pull/61093#pullrequestreview-467113054", "createdAt": "2020-08-13T20:39:05Z", "commit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozOTowNVrOHAczqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QyMDozOTowNVrOHAczqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDIzNDAyNw==", "bodyText": "What is this line doing exactly? Are we just overriding the default convention mapping?", "url": "https://github.com/elastic/elasticsearch/pull/61093#discussion_r470234027", "createdAt": "2020-08-13T20:39:05Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -172,26 +163,26 @@ public static void configureCompile(Project project) {\n \n                 compileOptions.setEncoding(\"UTF-8\");\n                 compileOptions.setIncremental(true);\n-\n-                // TODO: use native Gradle support for --release when available (cf. https://github.com/gradle/gradle/issues/2510)\n-                final JavaVersion targetCompatibilityVersion = JavaVersion.toVersion(compileTask.getTargetCompatibility());\n-                compilerArgs.add(\"--release\");\n-                compilerArgs.add(targetCompatibilityVersion.getMajorVersion());\n-\n+                compileTask.getConventionMapping().map(\"sourceCompatibility\", () -> java.getSourceCompatibility().toString());\n+                compileTask.getConventionMapping().map(\"targetCompatibility\", () -> java.getTargetCompatibility().toString());\n+                compileOptions.getRelease().set(releaseVersionProviderFromCompileTask(project, compileTask));\n             });\n             // also apply release flag to groovy, which is used in build-tools\n             project.getTasks().withType(GroovyCompile.class).configureEach(compileTask -> {\n-\n                 // TODO: this probably shouldn't apply to groovy at all?\n-                // TODO: use native Gradle support for --release when available (cf. https://github.com/gradle/gradle/issues/2510)\n-                final JavaVersion targetCompatibilityVersion = JavaVersion.toVersion(compileTask.getTargetCompatibility());\n-                final List<String> compilerArgs = compileTask.getOptions().getCompilerArgs();\n-                compilerArgs.add(\"--release\");\n-                compilerArgs.add(targetCompatibilityVersion.getMajorVersion());\n+                compileTask.setSourceCompatibility(compileTask.getSourceCompatibility());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4bbb01ea8616e3bc7e50c770d21b3a6e0b02dc47"}, "originalPosition": 69}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7858358c4fc511c31d5fa90ebb1a8427d53c2d5", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7858358c4fc511c31d5fa90ebb1a8427d53c2d5", "committedDate": "2020-08-13T20:40:07Z", "message": "Add todo comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f48e1f601939b548cb04d1d8d928ab4fcb0863e2", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/f48e1f601939b548cb04d1d8d928ab4fcb0863e2", "committedDate": "2020-08-13T20:59:10Z", "message": "Fix formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08fcda928d94138d5fe1a0eb48822e0846e9b228", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/08fcda928d94138d5fe1a0eb48822e0846e9b228", "committedDate": "2020-08-14T09:27:10Z", "message": "Update comment with gradle bug reference"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73e2655b717769f9232f3fe697c1b9fcb70a23f5", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/73e2655b717769f9232f3fe697c1b9fcb70a23f5", "committedDate": "2020-08-14T12:39:47Z", "message": "Fix imports"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3278, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}