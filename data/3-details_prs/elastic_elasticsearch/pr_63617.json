{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzgzNTcx", "number": 63617, "title": "Add supports for upper and lower values on boxplot based on the IQR value", "bodyText": "Resolves #60466\nThis PR expands the functionality of the box plot aggregation to support an upper and lower \"whisker\" value based on the inter-quartile range.  In theory, the upper whisker should be the highest observed value less than or equal to Q3 + (1.5 * IQR), and the lower bound should be the lowest observed value greater than Q1 - (1.5 * IQR).  Like all our quantile based aggregations, this will provide an approximation of those values, based on the centroids in the t-digest backing the aggregation.", "createdAt": "2020-10-13T14:24:16Z", "url": "https://github.com/elastic/elasticsearch/pull/63617", "merged": true, "mergeCommit": {"oid": "f666ccb3bc8b3c3e683df7c223d86016ac3728f4"}, "closed": true, "closedAt": "2020-11-04T19:39:06Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdESn1aAH2gAyNTAyMzgzNTcxOmJjZDI5YTJmM2M5NWVlNzAxMzUwOWM3OTdjOGQ1NDNmOTM1ZDFmOTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZSNSmgH2gAyNTAyMzgzNTcxOjcyMTZjNDlkOGFjMTA5Mzk4N2E0OWVhMGVkZmZhZmFhZjFiN2YzMTk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcd29a2f3c95ee7013509c797c8d543f935d1f99", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcd29a2f3c95ee7013509c797c8d543f935d1f99", "committedDate": "2020-08-31T13:14:44Z", "message": "experimenting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bad48b3b340ab259906acfabe2052ab9c7a0b25a", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/bad48b3b340ab259906acfabe2052ab9c7a0b25a", "committedDate": "2020-09-14T15:17:35Z", "message": "function to find IQR based whisker values"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05e6d1f9c7cd66d4d85096b5e8cb0992442a7a22", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/05e6d1f9c7cd66d4d85096b5e8cb0992442a7a22", "committedDate": "2020-09-15T13:22:47Z", "message": "replace enum switch with abstract method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ad2e6ff7925b5ad71758af719207c1fccc480c1", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ad2e6ff7925b5ad71758af719207c1fccc480c1", "committedDate": "2020-09-15T17:42:24Z", "message": "null handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ef7773611ed5d434f54423bfd47bebb1a505ab6", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ef7773611ed5d434f54423bfd47bebb1a505ab6", "committedDate": "2020-09-24T18:40:22Z", "message": "add output format testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b8549470f3fd5d5f0a18a8bc1c011153488b97d", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b8549470f3fd5d5f0a18a8bc1c011153488b97d", "committedDate": "2020-10-12T20:04:43Z", "message": "Merge branch 'master' into boxplot_iqr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "940ff1e447ff74e37e9e7bc7a686f418d268d38e", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/940ff1e447ff74e37e9e7bc7a686f418d268d38e", "committedDate": "2020-10-19T19:29:43Z", "message": "Update docs and fix doc tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c5e4459112098a3db0dd34a3c4d1702665a4f66f", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c5e4459112098a3db0dd34a3c4d1702665a4f66f", "committedDate": "2020-10-19T19:48:47Z", "message": "Merge branch 'master' into boxplot_iqr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fef801bb3a7a4ad038f971d37477544bcd73fdc", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fef801bb3a7a4ad038f971d37477544bcd73fdc", "committedDate": "2020-11-02T17:40:29Z", "message": "Merge branch 'master' into boxplot_iqr\n\n Conflicts:\n\tx-pack/plugin/analytics/src/test/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplotTests.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzUwODIx", "url": "https://github.com/elastic/elasticsearch/pull/63617#pullrequestreview-522750821", "createdAt": "2020-11-03T18:01:26Z", "commit": {"oid": "4fef801bb3a7a4ad038f971d37477544bcd73fdc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxODowMToyNlrOHs6fgw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxODowNDoxMlrOHs6lZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1NzczMQ==", "bodyText": "Nice!", "url": "https://github.com/elastic/elasticsearch/pull/63617#discussion_r516857731", "createdAt": "2020-11-03T18:01:26Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplot.java", "diffHunk": "@@ -25,8 +27,83 @@\n public class InternalBoxplot extends InternalNumericMetricsAggregation.MultiValue implements Boxplot {\n \n     enum Metrics {\n+        MIN {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fef801bb3a7a4ad038f971d37477544bcd73fdc"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg1OTIzNg==", "bodyText": "I think it might be a good idea to make this a constant and give it a short explanation....", "url": "https://github.com/elastic/elasticsearch/pull/63617#discussion_r516859236", "createdAt": "2020-11-03T18:04:12Z", "author": {"login": "imotov"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/boxplot/InternalBoxplot.java", "diffHunk": "@@ -36,39 +113,48 @@ public String value() {\n             return name().toLowerCase(Locale.ROOT);\n         }\n \n-        double value(InternalBoxplot boxplot) {\n-            switch (this) {\n-                case MIN:\n-                    return boxplot.getMin();\n-                case MAX:\n-                    return boxplot.getMax();\n-                case Q1:\n-                    return boxplot.getQ1();\n-                case Q2:\n-                    return boxplot.getQ2();\n-                case Q3:\n-                    return boxplot.getQ3();\n-                default:\n-                    throw new IllegalArgumentException(\"Unknown value [\" + this.value() + \"] in the boxplot aggregation\");\n-            }\n+        abstract double value(InternalBoxplot boxplot);\n+\n+        abstract double value(TDigestState state);\n+    }\n+\n+    /**\n+     * For a given TDigest, find the \"whisker\" valeus, such that the upper whisker is (close to) the highest observed value less than\n+     * q3 + 1.5 * IQR and the lower whisker is (close to) the lowest observed value greater than q1 - 1.5 * IQR.  Since we don't track\n+     * observed values directly, this function returns the centroid according to the above logic.\n+     *\n+     * @param state - an initialized TDigestState representing the observed data.\n+     * @return - two doubles in an array, where whiskers[0] is the lower whisker and whiskers[1] is the upper whisker.\n+     */\n+    public static double[] whiskers(TDigestState state) {\n+        double[] results = new double[2];\n+        results[0] = Double.NaN;\n+        results[1] = Double.NaN;\n+        if (state == null) {\n+            return results;\n         }\n \n-        double value(TDigestState state) {\n-            switch (this) {\n-                case MIN:\n-                    return state == null ? Double.NEGATIVE_INFINITY : state.getMin();\n-                case MAX:\n-                    return state == null ? Double.POSITIVE_INFINITY : state.getMax();\n-                case Q1:\n-                    return state == null ? Double.NaN : state.quantile(0.25);\n-                case Q2:\n-                    return state == null ? Double.NaN : state.quantile(0.5);\n-                case Q3:\n-                    return state == null ? Double.NaN : state.quantile(0.75);\n-                default:\n-                    throw new IllegalArgumentException(\"Unknown value [\" + this.value() + \"] in the boxplot aggregation\");\n+        double q3 = state.quantile(0.75);\n+        double q1 = state.quantile(0.25);\n+        double iqr = q3 - q1;\n+        double upper = q3 + (1.5 * iqr);\n+        double lower = q1 - (1.5 * iqr);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4fef801bb3a7a4ad038f971d37477544bcd73fdc"}, "originalPosition": 152}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d78449be213b6981313a69c751be97654f261b7", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d78449be213b6981313a69c751be97654f261b7", "committedDate": "2020-11-04T16:31:55Z", "message": "response to PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7216c49d8ac1093987a49ea0edffafaaf1b7f319", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/7216c49d8ac1093987a49ea0edffafaaf1b7f319", "committedDate": "2020-11-04T18:38:09Z", "message": "Merge branch 'master' into boxplot_iqr"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4106, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}