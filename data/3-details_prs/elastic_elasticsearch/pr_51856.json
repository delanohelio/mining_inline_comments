{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcwNzYyMTM2", "number": 51856, "title": "SQL: Handle uberjar scenario where the ES jdbc driver file is bundled in another jar", "bodyText": "Implementation for #50201", "createdAt": "2020-02-04T10:36:42Z", "url": "https://github.com/elastic/elasticsearch/pull/51856", "merged": true, "mergeCommit": {"oid": "6247b0793c9db19a8a9fa6f0164cc14d0debed6e"}, "closed": true, "closedAt": "2020-02-07T01:07:13Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBAqZfgH2gAyMzcwNzYyMTM2OmExMzIxMzhmMThiMDY0YWE1NGExOTNhMGRhMWQ2NWVjOGIzNTgzMWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcB0Td6AH2gAyMzcwNzYyMTM2OmQ4ZjY0YjhmZTMyY2FkZDMyY2Q3NWFjOGEyM2U5MDcxMThlZTVkNjU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a132138f18b064aa54a193a0da1d65ec8b35831d", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/a132138f18b064aa54a193a0da1d65ec8b35831d", "committedDate": "2020-02-04T12:26:19Z", "message": "Handle uberjar scenario where the ES jdbc driver file is bundled\ninside another jar file."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "46eef87c63f7bdd00c6527aa1e5094f027a33265", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/46eef87c63f7bdd00c6527aa1e5094f027a33265", "committedDate": "2020-02-04T10:34:42Z", "message": "Handle uberjar scenario where the ES jdbc driver file is bundled\ninside another jar file."}, "afterCommit": {"oid": "a132138f18b064aa54a193a0da1d65ec8b35831d", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/a132138f18b064aa54a193a0da1d65ec8b35831d", "committedDate": "2020-02-04T12:26:19Z", "message": "Handle uberjar scenario where the ES jdbc driver file is bundled\ninside another jar file."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77cb232a107de761031afbbe68799610a28c1c28", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/77cb232a107de761031afbbe68799610a28c1c28", "committedDate": "2020-02-04T12:27:55Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0035ed2e1f52c17aadf4c6b9710b5897d2fd3e4d", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/0035ed2e1f52c17aadf4c6b9710b5897d2fd3e4d", "committedDate": "2020-02-04T14:35:45Z", "message": "Disable caches for jar url connection creation, to prevent locks being\nkept alive in Windows"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1423fda171ebde1b08298fc769617a87403f003e", "committedDate": "2020-02-04T14:36:24Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDMxMzM5", "url": "https://github.com/elastic/elasticsearch/pull/51856#pullrequestreview-353031339", "createdAt": "2020-02-04T14:46:26Z", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNDo0NjoyNlrOFlWo2Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNDo0NjoyNlrOFlWo2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDcxMjUzNw==", "bodyText": "Should we add a finally block to close the conn ?\n(Maybe JarInputStream 's close() takes care of that, just wondering if we should be extra safe here)", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374712537", "createdAt": "2020-02-04T14:46:26Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -86,26 +87,34 @@ public static Version fromString(String version) {\n         // This is similar to how Elasticsearch's Build class digs up its build information.\n         // Since version info is not critical, the parsing is lenient\n         URL url = Version.class.getProtectionDomain().getCodeSource().getLocation();\n-        String urlStr = url.toString();\n+        CURRENT = extractVersion(url);\n+    }\n \n+    static Version extractVersion(URL url) {\n+        String urlStr = url.toString();\n         byte maj = 0, min = 0, rev = 0;\n         String ver = \"Unknown\";\n         String hash = ver;\n-\n-        if (urlStr.endsWith(\".jar\")) {\n-            try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                Manifest manifest = jar.getManifest();\n-                hash = manifest.getMainAttributes().getValue(\"Change\");\n-                ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                byte[] vers = from(ver);\n-                maj = vers[0];\n-                min = vers[1];\n-                rev = vers[2];\n+        \n+        if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n+            try {\n+                URLConnection conn = url.openConnection();\n+                conn.setUseCaches(false);\n+                \n+                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                    Manifest manifest = jar.getManifest();\n+                    hash = manifest.getMainAttributes().getValue(\"Change\");\n+                    ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n+                    byte[] vers = from(ver);\n+                    maj = vers[0];\n+                    min = vers[1];\n+                    rev = vers[2];\n+                }\n             } catch (Exception ex) {\n                 throw new IllegalArgumentException(\"Detected Elasticsearch JDBC jar but cannot retrieve its version\", ex);\n             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "originalPosition": 48}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMDk4Njg1", "url": "https://github.com/elastic/elasticsearch/pull/51856#pullrequestreview-353098685", "createdAt": "2020-02-04T16:04:25Z", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTc2MjIx", "url": "https://github.com/elastic/elasticsearch/pull/51856#pullrequestreview-353176221", "createdAt": "2020-02-04T17:48:02Z", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzo0ODowM1rOFlddwA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzo0ODowM1rOFlddwA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyNDM4NA==", "bodyText": "I know this is unmodified code, however, it's noteworthy that server/src/main/java/org/elasticsearch/Version.java parses ints, not bytes. Not sure if that's because it later does some int maths with the components, or because it reserves the possibility to use some tagging values at some point (like 7.2.222 for a special release). Just mentioning it, should we ever want to align this.", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374824384", "createdAt": "2020-02-04T17:48:03Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/Version.java", "diffHunk": "@@ -86,26 +87,34 @@ public static Version fromString(String version) {\n         // This is similar to how Elasticsearch's Build class digs up its build information.\n         // Since version info is not critical, the parsing is lenient\n         URL url = Version.class.getProtectionDomain().getCodeSource().getLocation();\n-        String urlStr = url.toString();\n+        CURRENT = extractVersion(url);\n+    }\n \n+    static Version extractVersion(URL url) {\n+        String urlStr = url.toString();\n         byte maj = 0, min = 0, rev = 0;\n         String ver = \"Unknown\";\n         String hash = ver;\n-\n-        if (urlStr.endsWith(\".jar\")) {\n-            try (JarInputStream jar = new JarInputStream(url.openStream())) {\n-                Manifest manifest = jar.getManifest();\n-                hash = manifest.getMainAttributes().getValue(\"Change\");\n-                ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                byte[] vers = from(ver);\n-                maj = vers[0];\n-                min = vers[1];\n-                rev = vers[2];\n+        \n+        if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n+            try {\n+                URLConnection conn = url.openConnection();\n+                conn.setUseCaches(false);\n+                \n+                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                    Manifest manifest = jar.getManifest();\n+                    hash = manifest.getMainAttributes().getValue(\"Change\");\n+                    ver = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n+                    byte[] vers = from(ver);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "originalPosition": 41}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTc2MzE5", "url": "https://github.com/elastic/elasticsearch/pull/51856#pullrequestreview-353176319", "createdAt": "2020-02-04T17:48:13Z", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzo0ODoxM1rOFldeFQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNFQxNzo0ODoxM1rOFldeFQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NDgyNDQ2OQ==", "bodyText": "Given it's a test, this is completely optional: extract the \"es-sql-jdbc.jar\" into a final var and reuse that below.", "url": "https://github.com/elastic/elasticsearch/pull/51856#discussion_r374824469", "createdAt": "2020-02-04T17:48:13Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/VersionTests.java", "diffHunk": "@@ -43,4 +53,44 @@ public void testInvalidVersion() {\n         IllegalArgumentException err = expectThrows(IllegalArgumentException.class, () -> Version.from(\"7.1\"));\n         assertEquals(\"Invalid version 7.1\", err.getMessage());\n     }\n+    \n+    public void testVersionFromJarInJar() throws IOException {\n+        Path dir = createTempDir();\n+        Path jarPath = dir.resolve(\"foo.jar\");              // simulated uberjar containing the jdbc driver\n+        Path innerJarPath = dir.resolve(\"es-sql-jdbc.jar\"); // simulated ES JDBC driver file", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzMTc2NzI0", "url": "https://github.com/elastic/elasticsearch/pull/51856#pullrequestreview-353176724", "createdAt": "2020-02-04T17:48:50Z", "commit": {"oid": "1423fda171ebde1b08298fc769617a87403f003e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "265430471233fc829d129d711bec6a3cd6a05f79", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/265430471233fc829d129d711bec6a3cd6a05f79", "committedDate": "2020-02-06T16:41:21Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aa653ef460565c7f801f6309cf4b963bb0d50f25", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa653ef460565c7f801f6309cf4b963bb0d50f25", "committedDate": "2020-02-06T16:41:35Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 50201_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f64b8fe32cadd32cd75ac8a23e907118ee5d65", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8f64b8fe32cadd32cd75ac8a23e907118ee5d65", "committedDate": "2020-02-07T00:36:20Z", "message": "Merge branch 'master' into 50201_impl"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3001, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}