{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1OTc1OTcy", "number": 51325, "title": "Fix TransportMasterNodeAction not Retrying NodeClosedException", "bodyText": "Added node closed exception to the retryable remote exceptions.\nFollow up to the discussion in #51270 (review).\nI'd still like to keep the workaround from #51270 though just in case we missed a spot. Otherwise any exception on the failed master that arrives with a delay and is not retried will dead-lock the snapshot.\nI'll open a follow-up to deal with the possibility of this happening due to the circuit breaker killing the status update on master.", "createdAt": "2020-01-22T17:29:16Z", "url": "https://github.com/elastic/elasticsearch/pull/51325", "merged": true, "mergeCommit": {"oid": "db480292eebdf9868e53c10ee07abae5e6a45bc7"}, "closed": true, "closedAt": "2020-01-24T17:19:55Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb85JaHgH2gAyMzY1OTc1OTcyOjZiZWU5NjE5NWE3N2I3ZDdmOWY3MGU4NTczODFiY2I5ZDBjZmUzMjY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9iPJ1AFqTM0ODEwMjY2Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "6bee96195a77b7d7f9f70e857381bcb9d0cfe326", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6bee96195a77b7d7f9f70e857381bcb9d0cfe326", "committedDate": "2020-01-22T17:25:15Z", "message": "Fix TransportMasterNodeAction not Retrying NodeClosedException\n\nAdded node closed exception to the retryable remote exceptions."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjAyMjQ1", "url": "https://github.com/elastic/elasticsearch/pull/51325#pullrequestreview-347202245", "createdAt": "2020-01-23T10:42:08Z", "commit": {"oid": "6bee96195a77b7d7f9f70e857381bcb9d0cfe326"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDo0MjowOFrOFg5yMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMDo0MjowOFrOFg5yMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA0NTQ4OA==", "bodyText": "Can you write an integration test that shows that this solves an issue?\nPerhaps a test that restarts the current master while concurrently sending some TransportMasterNodeReadAction (e.g. cluster health).\nI'm surprised that we have not seen this issue in any of our integration tests, where we sometimes restart nodes (but perhaps don't do this to concurrently issuing master-level requests).", "url": "https://github.com/elastic/elasticsearch/pull/51325#discussion_r370045488", "createdAt": "2020-01-23T10:42:08Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java", "diffHunk": "@@ -178,7 +178,7 @@ protected void doStart(ClusterState clusterState) {\n                                 @Override\n                                 public void handleException(final TransportException exp) {\n                                     Throwable cause = exp.unwrapCause();\n-                                    if (cause instanceof ConnectTransportException) {\n+                                    if (cause instanceof ConnectTransportException || cause instanceof NodeClosedException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6bee96195a77b7d7f9f70e857381bcb9d0cfe326"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "323f0d5ee6417b724a9cc595201c735b78a5aa64", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/323f0d5ee6417b724a9cc595201c735b78a5aa64", "committedDate": "2020-01-23T10:48:47Z", "message": "Merge remote-tracking branch 'elastic/master' into retry-sending-snapshot-shard-status-updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3378d3de2a248e87e30c4f67315842322c90f432", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3378d3de2a248e87e30c4f67315842322c90f432", "committedDate": "2020-01-23T15:55:32Z", "message": "test via healthcheck"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3ODA4NDE5", "url": "https://github.com/elastic/elasticsearch/pull/51325#pullrequestreview-347808419", "createdAt": "2020-01-24T08:40:24Z", "commit": {"oid": "3378d3de2a248e87e30c4f67315842322c90f432"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwODo0MDoyNFrOFhW0pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQwODo0MDoyNFrOFhW0pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDUyMTI1NA==", "bodyText": "I think we should separate out cases where the NodeClosedException originate on the local node (for isntance the case where transport stopped, which is also relayed as a NodeClosedException). There should be no need to retry those.\nAdding a check that the NodeClosedException is wrapped in a RemoteTransportException would ensure we only retry in true client cases.", "url": "https://github.com/elastic/elasticsearch/pull/51325#discussion_r370521254", "createdAt": "2020-01-24T08:40:24Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/support/master/TransportMasterNodeAction.java", "diffHunk": "@@ -178,7 +178,7 @@ protected void doStart(ClusterState clusterState) {\n                                 @Override\n                                 public void handleException(final TransportException exp) {\n                                     Throwable cause = exp.unwrapCause();\n-                                    if (cause instanceof ConnectTransportException) {\n+                                    if (cause instanceof ConnectTransportException || cause instanceof NodeClosedException) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3378d3de2a248e87e30c4f67315842322c90f432"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3b05a1b0374b968b5cf55cce24fea62696f9c0a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3b05a1b0374b968b5cf55cce24fea62696f9c0a", "committedDate": "2020-01-24T08:52:20Z", "message": "Merge remote-tracking branch 'elastic/master' into retry-sending-snapshot-shard-status-updates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1d07a269a00d6899f129c79f9a9c63bbdfbdb5d7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/1d07a269a00d6899f129c79f9a9c63bbdfbdb5d7", "committedDate": "2020-01-24T08:58:56Z", "message": "only retry remote node closed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646823d17d0f1cd972d9dd2b6c316674ba23a572", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/646823d17d0f1cd972d9dd2b6c316674ba23a572", "committedDate": "2020-01-24T11:02:56Z", "message": "better repro"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTAyNjYz", "url": "https://github.com/elastic/elasticsearch/pull/51325#pullrequestreview-348102663", "createdAt": "2020-01-24T17:17:38Z", "commit": {"oid": "646823d17d0f1cd972d9dd2b6c316674ba23a572"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2858, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}