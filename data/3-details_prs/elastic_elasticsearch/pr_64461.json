{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzOTI5NjUz", "number": 64461, "title": "Limit the Number of Snapshots in a BlobStoreRepository", "bodyText": "Motivated by a number of recent SDHs that resulted from incorrect SLM settings creating repositories that contained thousands of snapshots and eventually destabilised master nodes.\nAdds a limit to the maximum number of snapshots that are allowed\nto be added to a snapshot repository as a safety measure of last resort\nagainst repositories that grow to an unmanagable size due to e.g. incorrect SLM\nsettings.\nNOTE: This is just intended as a last ditch safety measure to avoid destabilising master nodes. It hooks into the last step of the snapshot state machine so a lot of redundant work is performed for snapshots that won't make it into the repository in the end. I chose this approach since it was significantly simpler to implement than the alternative of exposing a limit to the SnapshotsService which would then work out whether to start a snapshot based on the size of the repo and already running snapshots. The later would have required a number of changes which did not seem justified when to date all cases where this would have kicked in where the result of SLM issues (especially when the known ones are pratically fixed by #62284 for now).", "createdAt": "2020-11-02T09:40:31Z", "url": "https://github.com/elastic/elasticsearch/pull/64461", "merged": true, "mergeCommit": {"oid": "692423611860388375b7b0361d2543b86b1694e6"}, "closed": true, "closedAt": "2020-11-03T17:02:11Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdYhLPpAH2gAyNTEzOTI5NjUzOjRhMjkwYzg0MWI5YTc3Y2I4NmJlYzYzZmE0MDI1OTNiMzI4ZjgwNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdY3603gH2gAyNTEzOTI5NjUzOmFlZWQ1M2I1MWI0NjgxM2VmM2RmNGRlYmRmM2YwNTQxZTViM2E0Y2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4a290c841b9a77cb86bec63fa402593b328f8059", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a290c841b9a77cb86bec63fa402593b328f8059", "committedDate": "2020-11-02T09:30:34Z", "message": "Limit the Number of Snapshots in a BlobStoreRepository\n\nAdds a limit to the maximum number of snapshots that are allowed\nto be added to a snapshot repository as a safety measure of last resort\nagainst repositories that grow to an unmanagable size due to e.g. incorrect SLM\nsettings."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTIwNzA4", "url": "https://github.com/elastic/elasticsearch/pull/64461#pullrequestreview-521520708", "createdAt": "2020-11-02T10:49:45Z", "commit": {"oid": "4a290c841b9a77cb86bec63fa402593b328f8059"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDo0OTo0NVrOHr_Uog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMDo0OTo0NVrOHr_Uog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTg4ODI5MA==", "bodyText": "This setting name might be confusing.  I would rename to max_number_of_snapshots.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515888290", "createdAt": "2020-11-02T10:49:45Z", "author": {"login": "fcofdez"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`size_limit`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4a290c841b9a77cb86bec63fa402593b328f8059"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a39d31341333382a9b1b177774c2d0c67bb5633", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a39d31341333382a9b1b177774c2d0c67bb5633", "committedDate": "2020-11-02T11:37:37Z", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8", "committedDate": "2020-11-02T11:43:02Z", "message": "CR: rename setting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNTgyNDU3", "url": "https://github.com/elastic/elasticsearch/pull/64461#pullrequestreview-521582457", "createdAt": "2020-11-02T12:26:24Z", "commit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNjAxODE1", "url": "https://github.com/elastic/elasticsearch/pull/64461#pullrequestreview-521601815", "createdAt": "2020-11-02T12:55:40Z", "commit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1NTo0MVrOHsDNYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQxMjo1ODo1NlrOHsDUfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MTk2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n          \n          \n            \n                            listener.onFailure(new RepositoryException(metadata.name(), \"Cannot add another snapshot to this repository as it \" +", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515951968", "createdAt": "2020-11-02T12:55:41Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MjU3MA==", "bodyText": "I think we should name the setting in the message (as done here) but think we shouldn't recommend increasing it if you hit the limit and should instead suggest deleting some snapshots and/or adjusting retention settings to bring the snapshot count below the limit.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515952570", "createdAt": "2020-11-02T12:56:47Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1081,6 +1094,14 @@ public void finalizeSnapshot(final ShardGenerations shardGenerations,\n         final StepListener<RepositoryData> repoDataListener = new StepListener<>();\n         getRepositoryData(repoDataListener);\n         repoDataListener.whenComplete(existingRepositoryData -> {\n+            final int existingSnapshotCount = existingRepositoryData.getSnapshotIds().size();\n+            if (existingSnapshotCount >= maxSnapshotCount) {\n+                listener.onFailure(new RepositoryException(metadata.name(), \"Can not add another snapshot to this repository as it \" +\n+                        \"already contains [\" + existingSnapshotCount + \"] snapshots and is configured to hold up to [\" + maxSnapshotCount +\n+                        \"] snapshots only. Please increase repository setting [\" + MAX_SNAPSHOTS_SETTING.getKey() +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1MzA3OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n          \n          \n            \n            scale indefinitely in size and might lead to master node performance and stability issues if they grow past a certain size. We do not recommend increasing this setting.", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953078", "createdAt": "2020-11-02T12:57:35Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTk1Mzc5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.\n          \n          \n            \n            Instead you should delete older snapshots or use multiple repositories.\n          \n      \n    \n    \n  \n\nIs creating multiple repositories really a solution?", "url": "https://github.com/elastic/elasticsearch/pull/64461#discussion_r515953791", "createdAt": "2020-11-02T12:58:56Z", "author": {"login": "DaveCTurner"}, "path": "docs/reference/snapshot-restore/register-repository.asciidoc", "diffHunk": "@@ -162,6 +162,9 @@ unit, for example: `1GB`, `10MB`, `5KB`, `500B`. Defaults to `null` (unlimited c\n `max_restore_bytes_per_sec`:: Throttles per node restore rate. Defaults to unlimited. Note that restores are also throttled through <<recovery,recovery settings>>.\n `max_snapshot_bytes_per_sec`:: Throttles per node snapshot rate. Defaults to `40mb` per second.\n `readonly`:: Makes repository read-only.  Defaults to `false`.\n+`max_number_of_snapshots`:: Limits the maximum number of snapshots that the repository may contain. Defaults to `500`. Note that snapshot repositories do not\n+scale indefinitely in size and might lead to master node performance and stability issues if grown past a certain size. Increasing this setting\n+is generally not advisable and should be weighted carefully against alternatives such as deleting older snapshots or creating multiple repositories.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9836cba8f55f94f2b9fc946fb05f41ca7b1d1c8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2463271da49c4f8dd3229d6ebc24ed662d96101c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2463271da49c4f8dd3229d6ebc24ed662d96101c", "committedDate": "2020-11-02T13:03:13Z", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/de3199c75f38385988cf6de4d3cfe8aaaf6abbf5", "committedDate": "2020-11-02T13:03:26Z", "message": "Update docs/reference/snapshot-restore/register-repository.asciidoc\n\nCo-authored-by: David Turner <david.turner@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da46ccb71c280207c7429260101ce37904765b6c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/da46ccb71c280207c7429260101ce37904765b6c", "committedDate": "2020-11-02T13:03:42Z", "message": "Update server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java\n\nCo-authored-by: David Turner <david.turner@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "990d83bafc710d5b1347d1036d6a1375f6380569", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/990d83bafc710d5b1347d1036d6a1375f6380569", "committedDate": "2020-11-02T13:05:58Z", "message": "adjust exception msg"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNjEwNDEx", "url": "https://github.com/elastic/elasticsearch/pull/64461#pullrequestreview-521610411", "createdAt": "2020-11-02T13:07:04Z", "commit": {"oid": "da46ccb71c280207c7429260101ce37904765b6c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80510e2810aca06673d98b6a48ee1c8bfd15e131", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/80510e2810aca06673d98b6a48ee1c8bfd15e131", "committedDate": "2020-11-02T13:46:53Z", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/aeed53b51b46813ef3df4debdf3f0541e5b3a4cc", "committedDate": "2020-11-03T12:00:27Z", "message": "Merge remote-tracking branch 'elastic/master' into limit-snapshots-per-blobstore-repository"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 904, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}