{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2NDE0MTAz", "number": 53375, "title": "Fix sporadic failures in AsyncSearchAsyncTests", "bodyText": "This change fixes a race condition in shard group failure callbacks and ensures that we set the correct flag on initial stored responses.\nRelates #49931\nCloses #53360", "createdAt": "2020-03-10T23:38:18Z", "url": "https://github.com/elastic/elasticsearch/pull/53375", "merged": true, "mergeCommit": {"oid": "ab66529021464e57d3f4a1acd10c7718b6fb242e"}, "closed": true, "closedAt": "2020-03-11T16:14:16Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMaBXmAH2gAyMzg2NDE0MTAzOjg2MTJiNzU0MTMyMmMyNjM1MTA2MDM1YzMxZDkxM2RhNjQ1YmFlNTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMnm0IAH2gAyMzg2NDE0MTAzOjRlMjRhYzYyMGVhYWQ1NDczYTZkNDE1NjllNjJmN2Q4NWQwMjg5ZmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8612b7541322c2635106035c31d913da645bae59", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/8612b7541322c2635106035c31d913da645bae59", "committedDate": "2020-03-10T22:12:12Z", "message": "Fix race condition in shard group failure callback\n\nShard group failure callbacks should be executed before incrementing\nthe total operations. This is required to ensure that we don't notify\na shard group failure **after** the completion callback."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da65d6f97064ac08e7bcb7a9af6bcd8a912ca7c8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/da65d6f97064ac08e7bcb7a9af6bcd8a912ca7c8", "committedDate": "2020-03-10T22:34:46Z", "message": "Fix the initial response stored in async search index\n\nThis change ensures that we set the isRunning flag to `false`\nwhen storing the initial response of an async search request."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77dd1310bc001ead7eb1266a66a273f359fdf3fd", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/77dd1310bc001ead7eb1266a66a273f359fdf3fd", "committedDate": "2020-03-10T23:16:21Z", "message": "Remove the awaits fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55e59705d137999f03d9b0a9af60f447e813f2d8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/55e59705d137999f03d9b0a9af60f447e813f2d8", "committedDate": "2020-03-10T23:32:27Z", "message": "disable cacheability of BlockQueryBuilder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2f8278100849d992753bfead768948612655bb1", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2f8278100849d992753bfead768948612655bb1", "committedDate": "2020-03-11T07:50:35Z", "message": "Merge branch 'master' into async_search_action_tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyNjAxNzQ3", "url": "https://github.com/elastic/elasticsearch/pull/53375#pullrequestreview-372601747", "createdAt": "2020-03-11T09:42:00Z", "commit": {"oid": "a2f8278100849d992753bfead768948612655bb1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOTo0MjowMFrOF0vfug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMVQwOTo0MzowNlrOF0viFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg0ODQ0Mg==", "bodyText": "do we ever clone it providing true as isRunning argument?", "url": "https://github.com/elastic/elasticsearch/pull/53375#discussion_r390848442", "createdAt": "2020-03-11T09:42:00Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/AsyncSearchResponse.java", "diffHunk": "@@ -99,7 +99,7 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeLong(expirationTimeMillis);\n     }\n \n-    public AsyncSearchResponse clone(String id) {\n+    public AsyncSearchResponse clone(String id, boolean isRunning) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2f8278100849d992753bfead768948612655bb1"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDg0OTA0NA==", "bodyText": "can you elaborate on this TODO? does it revolve around resiliency?", "url": "https://github.com/elastic/elasticsearch/pull/53375#discussion_r390849044", "createdAt": "2020-03-11T09:43:06Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/TransportSubmitAsyncSearchAction.java", "diffHunk": "@@ -83,7 +83,10 @@ public void onResponse(AsyncSearchResponse searchResponse) {\n                                 onFatalFailure(searchTask, cause, false, submitListener);\n                             } else {\n                                 final String docId = searchTask.getSearchId().getDocId();\n-                                store.storeInitialResponse(docId, searchTask.getOriginHeaders(), searchResponse,\n+                                // creates the fallback response if the node crashes/restarts in the middle of the request\n+                                // TODO: store intermediate results ?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a2f8278100849d992753bfead768948612655bb1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ccb2f9b0d465f7fbd69d437fb3cc89834c64b82a", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/ccb2f9b0d465f7fbd69d437fb3cc89834c64b82a", "committedDate": "2020-03-11T10:24:19Z", "message": "Merge branch 'master' into async_search_action_tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0afc8c17602de78633d74848f7b5f088e13d7e1", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0afc8c17602de78633d74848f7b5f088e13d7e1", "committedDate": "2020-03-11T11:44:13Z", "message": "address review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ae60998e5beb0d66cd031b2df3555ef29d6c33f", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ae60998e5beb0d66cd031b2df3555ef29d6c33f", "committedDate": "2020-03-11T14:00:51Z", "message": "Merge branch 'master' into async_search_action_tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e24ac620eaad5473a6d41569e62f7d85d0289fa", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/4e24ac620eaad5473a6d41569e62f7d85d0289fa", "committedDate": "2020-03-11T14:01:52Z", "message": "Merge branch 'master' into async_search_action_tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1463, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}