{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5MzEzNzcx", "number": 61255, "title": "Report more details of unobtainable ShardLock", "bodyText": "Today a common reason for a ShardLockObtainFailedException is when a\nshard is removed from a node and then assigned straight back to it again\nbefore the node has had a chance to shut the previous shard instance\ndown. For instance, this can happen if a node briefly leaves the cluster\nholding a primary with no in-sync replicas.\nThe message in this case is typically as follows:\nobtaining shard lock timed out after 5000ms, previous lock details: [shard creation] trying to lock for [shard creation]\n\nThis is pretty hard to interpret, and doesn't raise the important\nquestion: \"why didn't the shard shut down sooner?\"\nWith this change we reword the message a bit, report the age of the\nshard lock, and adjust the details to report that the lock is held by a\nclosing shard:\nobtaining shard lock for [starting shard] timed out after [5000ms], lock already held for [closing shard] with age [12345ms]\n\nRelates #38807", "createdAt": "2020-08-18T09:03:12Z", "url": "https://github.com/elastic/elasticsearch/pull/61255", "merged": true, "mergeCommit": {"oid": "98213df9462ccae9b672bb6256208a0374b64306"}, "closed": true, "closedAt": "2020-08-19T05:35:56Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdADKopAH2gAyNDY5MzEzNzcxOjAwNjY2ZjRhMmYyYTg5ODU1NjE0M2ZmOWMzYzUwYjNjMjI3NjA2YjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdAMZo3AFqTQ2OTc2ODkzMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "00666f4a2f2a898556143ff9c3c50b3c227606b5", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/00666f4a2f2a898556143ff9c3c50b3c227606b5", "committedDate": "2020-08-18T08:58:34Z", "message": "Report more details of unobtainable ShardLock\n\nToday a common reason for a `ShardLockObtainFailedException` is when a\nshard is removed from a node and then assigned straight back to it again\nbefore the node has had a chance to shut the previous shard instance\ndown. For instance, this can happen if a node briefly leaves the cluster\nholding a primary with no in-sync replicas.\n\nThe message in this case is typically as follows:\n\n    obtaining shard lock timed out after 5000ms, previous lock details: [shard creation] trying to lock for [shard creation]\n\nThis is pretty hard to interpret, and doesn't raise the important\nquestion: \"why didn't the shard shut down sooner?\"\n\nWith this change we reword the message a bit, report the age of the\nshard lock, and adjust the details to report that the lock is held by a\nclosing shard:\n\n    obtaining shard lock for [starting shard] timed out after [5000ms], lock already held for [closing shard] with age [12345ms]\n\nRelates #38807"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5MTcxMzA0", "url": "https://github.com/elastic/elasticsearch/pull/61255#pullrequestreview-469171304", "createdAt": "2020-08-18T09:55:00Z", "commit": {"oid": "00666f4a2f2a898556143ff9c3c50b3c227606b5"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo1NTowMFrOHCMNwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOFQwOTo1NTowMFrOHCMNwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MjA1OTMzMA==", "bodyText": "NIT: setDetails(details);", "url": "https://github.com/elastic/elasticsearch/pull/61255#discussion_r472059330", "createdAt": "2020-08-18T09:55:00Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/env/NodeEnvironment.java", "diffHunk": "@@ -854,17 +860,23 @@ private void decWaitCount() {\n         void acquire(long timeoutInMillis, final String details) throws ShardLockObtainFailedException {\n             try {\n                 if (mutex.tryAcquire(timeoutInMillis, TimeUnit.MILLISECONDS)) {\n-                    lockDetails = details;\n+                    lockDetails = Tuple.tuple(System.nanoTime(), details);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "00666f4a2f2a898556143ff9c3c50b3c227606b5"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab94d42dbbc66c46405d911a4483593b0c0acb4a", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab94d42dbbc66c46405d911a4483593b0c0acb4a", "committedDate": "2020-08-18T09:59:49Z", "message": "Merge branch 'master' into 2020-08-18-log-shard-lock-age"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48bf874ec27eb0a8debd30d6a798331c155249e8", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/48bf874ec27eb0a8debd30d6a798331c155249e8", "committedDate": "2020-08-18T10:00:42Z", "message": "CR"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY5NzY4OTMx", "url": "https://github.com/elastic/elasticsearch/pull/61255#pullrequestreview-469768931", "createdAt": "2020-08-18T19:44:06Z", "commit": {"oid": "48bf874ec27eb0a8debd30d6a798331c155249e8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4904, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}