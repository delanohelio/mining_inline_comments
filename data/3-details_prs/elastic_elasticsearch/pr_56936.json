{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIwMDE4ODIw", "number": 56936, "title": "Track PUT/PUT_BLOCK operations on AzureBlobStore.", "bodyText": "Add tracking for regular and block uploads on AzureBlobStore", "createdAt": "2020-05-19T10:15:14Z", "url": "https://github.com/elastic/elasticsearch/pull/56936", "merged": true, "mergeCommit": {"oid": "007ab1b846f0133a575b46e2bfabf0ff7a2c0051"}, "closed": true, "closedAt": "2020-05-25T10:53:18Z", "author": {"login": "fcofdez"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcixn2dgH2gAyNDIwMDE4ODIwOjQ4NzM5YTY2NWMxNzdhZWZlMTQ4MGJjYWNmMjBiODZhMDBhZjM5Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcktD5-gH2gAyNDIwMDE4ODIwOjFlZDUyZTM0YmQyYTk0MGM1MGM5MzUwN2QyNWViOGNjYmJjNjg3OGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48739a665c177aefe1480bcacf20b86a00af39f7", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/48739a665c177aefe1480bcacf20b86a00af39f7", "committedDate": "2020-05-19T10:08:23Z", "message": "Track PUT/PUT_BLOCK operations on AzureBlobStore."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0ODE2MDU5", "url": "https://github.com/elastic/elasticsearch/pull/56936#pullrequestreview-414816059", "createdAt": "2020-05-19T20:55:21Z", "commit": {"oid": "48739a665c177aefe1480bcacf20b86a00af39f7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMDo1NToyMVrOGXySNg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOVQyMTowMDozMFrOGXyc7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDI5NA==", "bodyText": "queryParams.contains(\"comp=blocklist\") is redundant isn't it?\nMight be safer to require a blockid= as well if we just see a comp=block just to make sure we're in line with expectations on the API requests we'll see here?", "url": "https://github.com/elastic/elasticsearch/pull/56936#discussion_r427594294", "createdAt": "2020-05-19T20:55:21Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -101,15 +102,26 @@ public AzureBlobStore(RepositoryMetadata metadata, AzureStorageService service,\n         final Map<String, AzureStorageSettings> prevSettings = this.service.refreshAndClearCache(emptyMap());\n         final Map<String, AzureStorageSettings> newSettings = AzureStorageSettings.overrideLocationMode(prevSettings, this.locationMode);\n         this.service.refreshAndClearCache(newSettings);\n-        this.getMetricsCollector = (requestMethod) -> {\n-            if (requestMethod.equalsIgnoreCase(\"HEAD\")) {\n+        this.getMetricsCollector = (httpURLConnection) -> {\n+            if (httpURLConnection.getRequestMethod().equalsIgnoreCase(\"HEAD\")) {\n                 stats.headOperations.incrementAndGet();\n                 return;\n             }\n \n             stats.getOperations.incrementAndGet();\n         };\n-        this.listMetricsCollector = (requestMethod) -> stats.listOperations.incrementAndGet();\n+        this.listMetricsCollector = (httpURLConnection) -> stats.listOperations.incrementAndGet();\n+        this.uploadMetricsCollector = (httpURLConnection -> {\n+           assert httpURLConnection.getRequestMethod().equals(\"PUT\");\n+            String queryParams = httpURLConnection.getURL().getQuery();\n+            // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block\n+            // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list\n+            if (queryParams != null && (queryParams.contains(\"comp=block\") || queryParams.contains(\"comp=blocklist\"))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48739a665c177aefe1480bcacf20b86a00af39f7"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NDgyNA==", "bodyText": "Sam as in the production code, matching on comp=blocklist seems redundant when matching comp=block?", "url": "https://github.com/elastic/elasticsearch/pull/56936#discussion_r427594824", "createdAt": "2020-05-19T20:56:22Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/test/java/org/elasticsearch/repositories/azure/AzureBlobStoreRepositoryTests.java", "diffHunk": "@@ -186,7 +186,18 @@ protected void maybeTrack(String request, Headers headers) {\n                 trackRequest(\"HEAD\");\n             } else if (listPattern.test(request)) {\n                 trackRequest(\"LIST\");\n+            } else if (isBlockUpload(request)) {\n+                trackRequest(\"PUT_BLOCK\");\n+            } else if (Regex.simpleMatch(\"PUT /*/*\", request)) {\n+                trackRequest(\"PUT\");\n             }\n         }\n+\n+        // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block\n+        // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list\n+        private boolean isBlockUpload(String request) {\n+            return Regex.simpleMatch(\"PUT /*/*?*comp=blocklist*\", request)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48739a665c177aefe1480bcacf20b86a00af39f7"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNzU5NzAzNg==", "bodyText": "Semi-related to this PR since you did it in the new collector, let's add assertions in spots like this one to make sure, we're actually seeing a GET here :) Can probably do the same for the list collector also.", "url": "https://github.com/elastic/elasticsearch/pull/56936#discussion_r427597036", "createdAt": "2020-05-19T21:00:30Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -101,15 +102,26 @@ public AzureBlobStore(RepositoryMetadata metadata, AzureStorageService service,\n         final Map<String, AzureStorageSettings> prevSettings = this.service.refreshAndClearCache(emptyMap());\n         final Map<String, AzureStorageSettings> newSettings = AzureStorageSettings.overrideLocationMode(prevSettings, this.locationMode);\n         this.service.refreshAndClearCache(newSettings);\n-        this.getMetricsCollector = (requestMethod) -> {\n-            if (requestMethod.equalsIgnoreCase(\"HEAD\")) {\n+        this.getMetricsCollector = (httpURLConnection) -> {\n+            if (httpURLConnection.getRequestMethod().equalsIgnoreCase(\"HEAD\")) {\n                 stats.headOperations.incrementAndGet();\n                 return;\n             }\n \n             stats.getOperations.incrementAndGet();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48739a665c177aefe1480bcacf20b86a00af39f7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "513cb090ce13ed7ffb1c1acad379d6c16c8f1bd8", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/513cb090ce13ed7ffb1c1acad379d6c16c8f1bd8", "committedDate": "2020-05-20T08:22:52Z", "message": "Include blockid on isBlockUpload matcher."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "509f4594f924b0475c8e949eb5cd092267c04b07", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/509f4594f924b0475c8e949eb5cd092267c04b07", "committedDate": "2020-05-20T09:38:36Z", "message": "Don't rely on query params order for testing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NTY0ODYw", "url": "https://github.com/elastic/elasticsearch/pull/56936#pullrequestreview-417564860", "createdAt": "2020-05-25T08:58:20Z", "commit": {"oid": "509f4594f924b0475c8e949eb5cd092267c04b07"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ed52e34bd2a940c50c93507d25eb8ccbbc6878a", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ed52e34bd2a940c50c93507d25eb8ccbbc6878a", "committedDate": "2020-05-25T09:57:21Z", "message": "Merge remote-tracking branch 'origin/master' into azure-post-put-api-calls-tracking"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4899, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}