{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzMzk1Mjk5", "number": 60742, "title": "Add UBI docker builds", "bodyText": "This PR resurrects support for building Docker images based on one of Red Hat's UBI images. It also adds support for running the existing Docker tests against the image.\nNotes:\n\nI changed the Docker build file uses enums instead strings in a lot of places, for added rigour", "createdAt": "2020-08-05T13:46:29Z", "url": "https://github.com/elastic/elasticsearch/pull/60742", "merged": true, "mergeCommit": {"oid": "2e3ed6171e06c9f487a0bd3c5b0f2423efd45d21"}, "closed": true, "closedAt": "2020-08-18T08:27:24Z", "author": {"login": "pugnascotia"}, "timelineItems": {"totalCount": 35, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5skDVAH2gAyNDYzMzk1Mjk5OmU3MDNiMTc1NmQxZTU0ODdkMDdiOTNiMmJlZmJiMDEzYzM3ZDdmYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_y207gH2gAyNDYzMzk1Mjk5OmJlNjVlZTc3MDUwMzAzZmIwYjJkYjQ3MzVkN2FlYjlkZTAxYTAyMmU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e703b1756d1e5487d07b93b2befbb013c37d7fc1", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/e703b1756d1e5487d07b93b2befbb013c37d7fc1", "committedDate": "2020-07-29T15:14:58Z", "message": "Reinstate UBI builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/20e8e5976e21b9fa67f50bfd27047ecf7f0954a0", "committedDate": "2020-07-30T11:37:21Z", "message": "Only provide a task to build a UBI context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a3f3bc47471c59fd6dfb49f324a839a0273c109", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a3f3bc47471c59fd6dfb49f324a839a0273c109", "committedDate": "2020-07-30T13:56:39Z", "message": "Generate UBI downloads.json during context build (badly)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff2ecd7534173e56f0003541d6bb1a55d8e8786c", "committedDate": "2020-07-30T14:15:13Z", "message": "Revert unnecessary changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad9140f8021fcef9944a8fd194cf14648bd9f98e", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad9140f8021fcef9944a8fd194cf14648bd9f98e", "committedDate": "2020-07-30T14:22:26Z", "message": "Fix UBI version in archive name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0", "committedDate": "2020-07-30T15:19:34Z", "message": "Hack around gradle issues with configurations and project context"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "10247102e6cf11b0d9462d57e8720bff28cadaf9", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/10247102e6cf11b0d9462d57e8720bff28cadaf9", "committedDate": "2020-07-30T15:41:51Z", "message": "Revert \"Hack around gradle issues with configurations and project context\"\n\nThis reverts commit 2171b241f1e92c8d5cdfadf899bbc5a5f0e99dd0."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a87d279010d91135f468b90bd1fc271066bde19", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a87d279010d91135f468b90bd1fc271066bde19", "committedDate": "2020-07-31T10:28:05Z", "message": "Support ubi and ubi-minimal"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0d3ace8c198f916f828ce675bbf4334482b6f87", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0d3ace8c198f916f828ce675bbf4334482b6f87", "committedDate": "2020-07-31T11:30:32Z", "message": "Make it possible to run tests on UBI image"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "06a4d2ed13b999e1aa1e02d23144be05cbd16888", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/06a4d2ed13b999e1aa1e02d23144be05cbd16888", "committedDate": "2020-08-05T11:45:10Z", "message": "Only support ubi-minimal and rename it ubi"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5dc83ec8a89e86efd9d9f5f69472fec934f9d319", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/5dc83ec8a89e86efd9d9f5f69472fec934f9d319", "committedDate": "2020-08-05T12:40:16Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2db70916aa340ba8e0a703658446ede5bcca1ef2", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/2db70916aa340ba8e0a703658446ede5bcca1ef2", "committedDate": "2020-08-05T13:19:37Z", "message": "Fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a95b295efe2c9769c04249dcb3b9702d21f0201", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a95b295efe2c9769c04249dcb3b9702d21f0201", "committedDate": "2020-08-05T13:27:24Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4e9f7ac1d001aa2417f582490762d8f62d6b893", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4e9f7ac1d001aa2417f582490762d8f62d6b893", "committedDate": "2020-08-05T13:39:29Z", "message": "Tweaks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f25d7683415e7891f265244c7fd542e0b3500aa", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f25d7683415e7891f265244c7fd542e0b3500aa", "committedDate": "2020-08-05T19:53:40Z", "message": "Fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxODg1NDUx", "url": "https://github.com/elastic/elasticsearch/pull/60742#pullrequestreview-461885451", "createdAt": "2020-08-05T17:41:14Z", "commit": {"oid": "b4e9f7ac1d001aa2417f582490762d8f62d6b893"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzo0MToxNFrOG8T_Xg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNVQxNzo0NDoyOFrOG8UG2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NTI2Mg==", "bodyText": "Maybe DOCKER_UBI then?", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r465895262", "createdAt": "2020-08-05T17:41:14Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -50,7 +50,9 @@ public String toString() {\n         ARCHIVE,\n         RPM,\n         DEB,\n-        DOCKER;\n+        DOCKER,\n+        // This is a different flavour of Docker image\n+        UBI;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e9f7ac1d001aa2417f582490762d8f62d6b893"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTg5NzE3Nw==", "bodyText": "I assume you decided that introducing yet another axis on ElasticsearchDistribution was folly and therefore this isn't actually used? ;)", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r465897177", "createdAt": "2020-08-05T17:44:28Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/Variant.java", "diffHunk": "@@ -0,0 +1,29 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle;\n+\n+/**\n+ * Models the different varieties of Docker image that the build can create.\n+ */\n+public enum Variant {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b4e9f7ac1d001aa2417f582490762d8f62d6b893"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc13ddd374ef11d411f0a1856ee2d124c9041c3b", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc13ddd374ef11d411f0a1856ee2d124c9041c3b", "committedDate": "2020-08-06T14:36:30Z", "message": "Change UBI type to DOCKER_UBI"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b83b2b571553d643a36ef2170dcd6c2239f8fd63", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/b83b2b571553d643a36ef2170dcd6c2239f8fd63", "committedDate": "2020-08-06T14:37:31Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3d0396ee389a41b5272361ac5f483deb3d425e6", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3d0396ee389a41b5272361ac5f483deb3d425e6", "committedDate": "2020-08-06T15:20:32Z", "message": "Add UBI image testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8cfd28ff28fc3e5e4ee0d9cecbb1fe509b55cf5", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8cfd28ff28fc3e5e4ee0d9cecbb1fe509b55cf5", "committedDate": "2020-08-10T09:16:01Z", "message": "Fix UBI label test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4593ef5afc32ff4b02b1878ece8155c6f1fbf89", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4593ef5afc32ff4b02b1878ece8155c6f1fbf89", "committedDate": "2020-08-10T09:22:06Z", "message": "Formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "064bb2e38a5d4c215d28fe9d32b2582c88e7569e", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/064bb2e38a5d4c215d28fe9d32b2582c88e7569e", "committedDate": "2020-08-10T20:35:18Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "724117c5fe526d08dd294e34f95fc351f0116426", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/724117c5fe526d08dd294e34f95fc351f0116426", "committedDate": "2020-08-12T11:23:11Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2MzA3MjA2", "url": "https://github.com/elastic/elasticsearch/pull/60742#pullrequestreview-466307206", "createdAt": "2020-08-12T22:01:08Z", "commit": {"oid": "724117c5fe526d08dd294e34f95fc351f0116426"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f89a2b63a64bc275eceaa77c50c82b2ad9066a75", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/f89a2b63a64bc275eceaa77c50c82b2ad9066a75", "committedDate": "2020-08-13T12:57:24Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY2OTM4OTUy", "url": "https://github.com/elastic/elasticsearch/pull/60742#pullrequestreview-466938952", "createdAt": "2020-08-13T16:46:56Z", "commit": {"oid": "724117c5fe526d08dd294e34f95fc351f0116426"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNjo0Njo1NlrOHAT2GQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xM1QxNjo0Njo1NlrOHAT2GQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDA4NzE5Mw==", "bodyText": "We should actually add some validation in here so you can't choose DOCKER_UBI along with the OSS flavor.", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470087193", "createdAt": "2020-08-13T16:46:56Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -283,7 +289,7 @@ void finalizeValues() {\n                     \"platform cannot be set on elasticsearch distribution [\" + name + \"] of type [\" + getType() + \"]\"\n                 );\n             }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "724117c5fe526d08dd294e34f95fc351f0116426"}, "originalPosition": 54}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d80c484638b5ba24b9a9904d79bcd8d4f6b591f", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d80c484638b5ba24b9a9904d79bcd8d4f6b591f", "committedDate": "2020-08-14T09:53:46Z", "message": "Remove Variant enum, introduce DockerBase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8574daa5e634ffb45bad542f3c4ec4cff05eee7b", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/8574daa5e634ffb45bad542f3c4ec4cff05eee7b", "committedDate": "2020-08-14T09:53:59Z", "message": "Merge remote-tracking branch 'upstream/master' into add-ubi-docker-builds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4d250f2a369c28d5f1f4d851edd8e24459c0c6b", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4d250f2a369c28d5f1f4d851edd8e24459c0c6b", "committedDate": "2020-08-14T10:04:53Z", "message": "Avoid OSS + UBI in ElasticsearchDistribution"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a4ecf8393571163868124102a013c3dd8cc50a2", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a4ecf8393571163868124102a013c3dd8cc50a2", "committedDate": "2020-08-14T10:27:24Z", "message": "Formatting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NzE1MDQx", "url": "https://github.com/elastic/elasticsearch/pull/60742#pullrequestreview-467715041", "createdAt": "2020-08-14T16:35:25Z", "commit": {"oid": "6a4ecf8393571163868124102a013c3dd8cc50a2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNToyNVrOHA7NAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxNjozNToyNVrOHA7NAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDczMjAzMg==", "bodyText": "Let's just add a comment here explaining we only ship a default distribution version of the UBI image.", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470732032", "createdAt": "2020-08-14T16:35:25Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -239,9 +252,14 @@ void addBuildDockerImage(Architecture architecture, Variant variant) {\n }\n \n for (final Architecture architecture : Architecture.values()) {\n-  for (Variant variant : Variant.values()) {\n-    addCopyDockerContextTask(architecture, variant)\n-    addBuildDockerImage(architecture, variant)\n+  for (final DockerBase base : DockerBase.values()) {\n+    for (final boolean oss : [false, true]) {\n+      if (oss && base != DockerBase.CENTOS) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6a4ecf8393571163868124102a013c3dd8cc50a2"}, "originalPosition": 185}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eea1bacf7a4c38c2f891f166c7db9618cd2afc2e", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/eea1bacf7a4c38c2f891f166c7db9618cd2afc2e", "committedDate": "2020-08-14T19:06:19Z", "message": "Add explanatory comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3ODY1Mjgw", "url": "https://github.com/elastic/elasticsearch/pull/60742#pullrequestreview-467865280", "createdAt": "2020-08-14T20:46:05Z", "commit": {"oid": "eea1bacf7a4c38c2f891f166c7db9618cd2afc2e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMDo0NjowNlrOHBC2Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQyMDo0NjowNlrOHBC2Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDg1NzIzNQ==", "bodyText": "This doesn't appear to be used, since the same condition is written in isDocker above?", "url": "https://github.com/elastic/elasticsearch/pull/60742#discussion_r470857235", "createdAt": "2020-08-14T20:46:06Z", "author": {"login": "rjernst"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/util/Distribution.java", "diffHunk": "@@ -92,6 +95,10 @@ public boolean isDocker() {\n             this.extension = extension;\n             this.compatible = compatible;\n         }\n+\n+        public boolean isDocker() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "eea1bacf7a4c38c2f891f166c7db9618cd2afc2e"}, "originalPosition": 33}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a964cdb701978fe1ac20957cce11748d096a1aa2", "author": {"user": {"login": "pugnascotia", "name": "Rory Hunter"}}, "url": "https://github.com/elastic/elasticsearch/commit/a964cdb701978fe1ac20957cce11748d096a1aa2", "committedDate": "2020-08-17T11:36:48Z", "message": "Remove unnecessary isDocker method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "be65ee77050303fb0b2db4735d7aeb9de01a022e", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/be65ee77050303fb0b2db4735d7aeb9de01a022e", "committedDate": "2020-08-17T13:58:27Z", "message": "Merge branch 'master' into add-ubi-docker-builds"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3411, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}