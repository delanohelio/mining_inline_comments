{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMTQ0NjIw", "number": 64428, "title": "Configure Autoscaling deciders using settings", "bodyText": "Autoscaling deciders are now configured using settings, allowing an\neasy way to add default values as well as building upon the existing\nsetting code. This makes it easier to add new deciders since there\nis no need for a separate configuration object.\nThis PR will like have a few minor conflicts with #64222 , will fix them\nup when that is merged.", "createdAt": "2020-10-30T17:03:14Z", "url": "https://github.com/elastic/elasticsearch/pull/64428", "merged": true, "mergeCommit": {"oid": "5df609d31ba9d7a95c48a1832ffccc5f173c19c2"}, "closed": true, "closedAt": "2020-11-23T20:17:19Z", "author": {"login": "henningandersen"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXpmwaAH2gAyNTEzMTQ0NjIwOjU1MmY1Njg1ZTQ4MTAxNDRkZjQ2NTFkYjg5NDJhNjJjZjRkYjI3ZWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfaGOSgH2gAyNTEzMTQ0NjIwOjQ5MzAzYWEyZjQ3MjA2ZjJhZTliMDQyZjg2NTIwMzJlOWYxZDdhNGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "552f5685e4810144df4651db8942a62cf4db27ed", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/552f5685e4810144df4651db8942a62cf4db27ed", "committedDate": "2020-10-30T16:45:56Z", "message": "Configure Autoscaling deciders using settings\n\nAutoscaling deciders are now configured using settings, allowing an\neasy way to add default values as well as building upon the existing\nsetting code. This makes it easier to add new deciders since there\nis no need for a separate configuration object."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff5c609b3ec4649d1ff14b53cad9c9b5334138b5", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff5c609b3ec4649d1ff14b53cad9c9b5334138b5", "committedDate": "2020-11-02T07:52:29Z", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "656d474fcf23b3fd689d9244b7dad8bcda4df292", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/656d474fcf23b3fd689d9244b7dad8bcda4df292", "committedDate": "2020-11-02T08:10:00Z", "message": "Validate setting parse failure\n\nAlso ensure that ByteSizeValue always has the setting name in validation\nfailure message."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIxNDA0MjYz", "url": "https://github.com/elastic/elasticsearch/pull/64428#pullrequestreview-521404263", "createdAt": "2020-11-02T08:11:06Z", "commit": {"oid": "656d474fcf23b3fd689d9244b7dad8bcda4df292"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODoxMTowN1rOHr500w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wMlQwODoxMTowN1rOHr500w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5ODIyNw==", "bodyText": "I left this in this PR, but can certainly split it out for greater visibility if you prefer.", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r515798227", "createdAt": "2020-11-02T08:11:07Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/common/unit/ByteSizeValue.java", "diffHunk": "@@ -264,7 +264,7 @@ private static ByteSizeValue parse(final String initialInput, final String norma\n                          initialInput, settingName);\n                     return new ByteSizeValue((long) (doubleValue * unit.toBytes(1)));\n                 } catch (final NumberFormatException ignored) {\n-                    throw new ElasticsearchParseException(\"failed to parse [{}]\", e, initialInput);\n+                    throw new ElasticsearchParseException(\"failed to parse setting [{}] with value [{}]\", e, settingName, initialInput);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "656d474fcf23b3fd689d9244b7dad8bcda4df292"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11ed729eddec9b7fe137188e59cd1ac486ac7e21", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/11ed729eddec9b7fe137188e59cd1ac486ac7e21", "committedDate": "2020-11-04T09:44:39Z", "message": "Fix test failure due to better validation message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "905c877433cf5701ec6aa29d457b56ee9afc6427", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/905c877433cf5701ec6aa29d457b56ee9afc6427", "committedDate": "2020-11-04T09:44:59Z", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a9e91d4b15fa583353166377b373df4b07fb4a8", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a9e91d4b15fa583353166377b373df4b07fb4a8", "committedDate": "2020-11-06T16:21:22Z", "message": "Merge branch 'master' into enhance_autoscaling_configure_using_settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8289167a3a80ccba893cacc10f1d67862a05b220", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8289167a3a80ccba893cacc10f1d67862a05b220", "committedDate": "2020-11-06T16:35:36Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/69b0ac8153d54d5c693ecc4bfa68d702dac80d32", "committedDate": "2020-11-11T09:16:54Z", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MTQ1ODAz", "url": "https://github.com/elastic/elasticsearch/pull/64428#pullrequestreview-536145803", "createdAt": "2020-11-23T02:00:56Z", "commit": {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMjowMDo1NlrOH39idw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QwMjowMzo1N1rOH39kBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MTk3NQ==", "bodyText": "Yeah, let's take this to another PR so that the core/infra team can have visibility on the change.", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528441975", "createdAt": "2020-11-23T02:00:56Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/common/unit/ByteSizeValue.java", "diffHunk": "@@ -264,7 +264,7 @@ private static ByteSizeValue parse(final String initialInput, final String norma\n                          initialInput, settingName);\n                     return new ByteSizeValue((long) (doubleValue * unit.toBytes(1)));\n                 } catch (final NumberFormatException ignored) {\n-                    throw new ElasticsearchParseException(\"failed to parse [{}]\", e, initialInput);\n+                    throw new ElasticsearchParseException(\"failed to parse setting [{}] with value [{}]\", e, settingName, initialInput);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTc5ODIyNw=="}, "originalCommit": {"oid": "656d474fcf23b3fd689d9244b7dad8bcda4df292"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjIxMw==", "bodyText": "Can you add a Javadoc describing the purpose of this interface?", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442213", "createdAt": "2020-11-23T02:02:28Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java", "diffHunk": "@@ -0,0 +1,13 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+public interface PolicyValidator {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjI0Mw==", "bodyText": "Could you add a Javadoc for this method?", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442243", "createdAt": "2020-11-23T02:02:42Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/action/PolicyValidator.java", "diffHunk": "@@ -0,0 +1,13 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.autoscaling.action;\n+\n+import org.elasticsearch.xpack.autoscaling.policy.AutoscalingPolicy;\n+\n+public interface PolicyValidator {\n+    void validate(AutoscalingPolicy policy);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODQ0MjM3NA==", "bodyText": "Maybe a comment to indicate this method throws when there's an issue with the setting, and that's what we are testing for here? That is, make the purpose of this line clear?", "url": "https://github.com/elastic/elasticsearch/pull/64428#discussion_r528442374", "createdAt": "2020-11-23T02:03:57Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/autoscaling/src/main/java/org/elasticsearch/xpack/autoscaling/capacity/AutoscalingCalculateCapacityService.java", "diffHunk": "@@ -30,14 +33,40 @@\n import java.util.stream.Collectors;\n import java.util.stream.StreamSupport;\n \n-public class AutoscalingCalculateCapacityService {\n-    private Map<String, AutoscalingDeciderService<? extends AutoscalingDeciderConfiguration>> deciderByName;\n+public class AutoscalingCalculateCapacityService implements PolicyValidator {\n+    private final Map<String, AutoscalingDeciderService> deciderByName;\n \n-    public AutoscalingCalculateCapacityService(Set<AutoscalingDeciderService<? extends AutoscalingDeciderConfiguration>> deciders) {\n+    public AutoscalingCalculateCapacityService(Set<AutoscalingDeciderService> deciders) {\n         assert deciders.size() >= 1; // always have fixed\n         this.deciderByName = deciders.stream().collect(Collectors.toMap(AutoscalingDeciderService::name, Function.identity()));\n     }\n \n+    public void validate(AutoscalingPolicy policy) {\n+        policy.deciders().forEach(this::validate);\n+    }\n+\n+    private void validate(final String deciderName, final Settings configuration) {\n+        AutoscalingDeciderService deciderService = deciderByName.get(deciderName);\n+        if (deciderService == null) {\n+            throw new IllegalArgumentException(\"unknown decider [\" + deciderName + \"]\");\n+        }\n+\n+        Map<String, Setting<?>> deciderSettings = deciderService.deciderSettings()\n+            .stream()\n+            .collect(Collectors.toMap(s -> s.getKey(), Function.identity()));\n+\n+        configuration.keySet().forEach(key -> validateSetting(key, configuration, deciderSettings, deciderName));\n+    }\n+\n+    private void validateSetting(String key, Settings configuration, Map<String, Setting<?>> deciderSettings, String decider) {\n+        Setting<?> setting = deciderSettings.get(key);\n+        if (setting == null) {\n+            throw new IllegalArgumentException(\"unknown setting [\" + key + \"] for decider [\" + decider + \"]\");\n+        }\n+\n+        setting.get(configuration);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69b0ac8153d54d5c693ecc4bfa68d702dac80d32"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d090c21d3e5bb9052be9f3814ffd46280f76e1", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7d090c21d3e5bb9052be9f3814ffd46280f76e1", "committedDate": "2020-11-23T10:45:03Z", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07632c3b34bdb40ecb9fc0eef939ec83751d2791", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/07632c3b34bdb40ecb9fc0eef939ec83751d2791", "committedDate": "2020-11-23T12:04:56Z", "message": "Update ML to use settings\n\nML now uses settings for autoscaling configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7d40eb110d68e25bfa3101c2b8da06ce667056d", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7d40eb110d68e25bfa3101c2b8da06ce667056d", "committedDate": "2020-11-23T12:15:46Z", "message": "Add linebreak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9d87c5676afe7cf730559423767849443df61db", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9d87c5676afe7cf730559423767849443df61db", "committedDate": "2020-11-23T12:50:54Z", "message": "Add javadoc and comment."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2NTE5NzU0", "url": "https://github.com/elastic/elasticsearch/pull/64428#pullrequestreview-536519754", "createdAt": "2020-11-23T14:25:45Z", "commit": {"oid": "b9d87c5676afe7cf730559423767849443df61db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49303aa2f47206f2ae9b042f8652032e9f1d7a4f", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/49303aa2f47206f2ae9b042f8652032e9f1d7a4f", "committedDate": "2020-11-23T19:13:13Z", "message": "Merge remote-tracking branch 'origin/master' into enhance_autoscaling_configure_using_settings"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 887, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}