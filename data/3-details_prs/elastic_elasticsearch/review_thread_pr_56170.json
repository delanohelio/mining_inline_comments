{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMjMxNjEz", "number": 56170, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMTo0M1rOD5UwIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTozNDowOFrOD5XMLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDM1NDI3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMTo0M1rOGQhgHA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMTo0M1rOGQhgHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3OTI5Mg==", "bodyText": "Would it make sense to extract this in a separate method and use it in both validate CT/TemplateV2 methods?", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419979292", "createdAt": "2020-05-05T09:31:43Z", "author": {"login": "andreidan"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDM2OTU5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozNTo0NVrOGQhpTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNDoxNjoxM1rOGQri1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4MTY0NA==", "bodyText": "These two methods are nearly identical so they can be refactored to avoid duplication\nprivate void validate(String name, ComponentTemplate template) {\n    validate(name, template.template(), Collections.emptyList());\n}\n\nprivate void validate(String name, IndexTemplateV2 template) {\n    validate(name, template.template(), template.indexPatterns());\n}\n\nprivate void validate(String name, Template template1, List<String> indexPatterns) {\n    Optional<Template> maybeTemplate = Optional.ofNullable(template1);\n    validate(name,\n        maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n        indexPatterns,\n        maybeTemplate.map(Template::aliases)\n            .orElse(Collections.emptyMap())\n            .values().stream()\n            .map(this::toAlias)\n            .collect(Collectors.toList()));\n}\n\nprivate Alias toAlias(AliasMetadata aliasMeta) {\n    Alias a = new Alias(aliasMeta.alias());\n    if (aliasMeta.filter() != null) {\n        a.filter(aliasMeta.filter().string());\n    }\n    a.searchRouting(aliasMeta.searchRouting());\n    a.indexRouting(aliasMeta.indexRouting());\n    a.isHidden(aliasMeta.isHidden());\n    a.writeIndex(aliasMeta.writeIndex());\n    return a;\n}", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419981644", "createdAt": "2020-05-05T09:35:45Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDE0MzgzMA==", "bodyText": "Good call, did this, thanks!", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r420143830", "createdAt": "2020-05-05T14:16:13Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4MTY0NA=="}, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDM3MDc2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozNjowN1rOGQhqBw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozNjowN1rOGQhqBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk4MTgzMQ==", "bodyText": "This block should be refactored to its own method", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419981831", "createdAt": "2020-05-05T09:36:07Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDQyMzA5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1MTowNlrOGQiKYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTo1MTowNlrOGQiKYg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk5MDExNA==", "bodyText": "This code can be made less nested if we get out of Optional early\n.map(Template::aliases)\n.orElse(Collections.emptyMap())", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r419990114", "createdAt": "2020-05-05T09:51:06Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNDc1Mzc0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTozNDowOFrOGQlTKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMTozNToyOVrOGQlV2Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0MTUxMw==", "bodyText": "Sorry for drive-by commenting, but this might touch another small issue I recently read (#55606) which points out that we allow asterisks in index patterns, the error message contaisn the character though (\"template must not contain the following characters [ , \", *, , <, |, ,, >, /, ?];]\") because we use Strings.INVALID_FILENAME_CHARS without removing the asterisk here. Might be worth fixing as well, just wanted to point it out.", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r420041513", "createdAt": "2020-05-05T11:34:08Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(PutRequest putRequest) {\n+        validate(putRequest.name, putRequest.settings, putRequest.indexPatterns, putRequest.aliases);\n+    }\n+\n+    private void validate(String name, @Nullable Settings settings, List<String> indexPatterns, List<Alias> aliases) {\n         List<String> validationErrors = new ArrayList<>();\n-        if (request.name.contains(\" \")) {\n+        if (name.contains(\" \")) {\n             validationErrors.add(\"name must not contain a space\");\n         }\n-        if (request.name.contains(\",\")) {\n+        if (name.contains(\",\")) {\n             validationErrors.add(\"name must not contain a ','\");\n         }\n-        if (request.name.contains(\"#\")) {\n+        if (name.contains(\"#\")) {\n             validationErrors.add(\"name must not contain a '#'\");\n         }\n-        if (request.name.startsWith(\"_\")) {\n+        if (name.contains(\"*\")) {\n+            validationErrors.add(\"name must not contain a '*'\");\n+        }\n+        if (name.startsWith(\"_\")) {\n             validationErrors.add(\"name must not start with '_'\");\n         }\n-        if (!request.name.toLowerCase(Locale.ROOT).equals(request.name)) {\n+        if (name.toLowerCase(Locale.ROOT).equals(name) == false) {\n             validationErrors.add(\"name must be lower cased\");\n         }\n-        for(String indexPattern : request.indexPatterns) {\n+        for(String indexPattern : indexPatterns) {\n             if (indexPattern.contains(\" \")) {\n-                validationErrors.add(\"template must not contain a space\");\n+                validationErrors.add(\"index_patterns [\" + indexPattern + \"] must not contain a space\");\n             }\n             if (indexPattern.contains(\",\")) {\n-                validationErrors.add(\"template must not contain a ','\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ','\");\n             }\n             if (indexPattern.contains(\"#\")) {\n-                validationErrors.add(\"template must not contain a '#'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a '#'\");\n+            }\n+            if (indexPattern.contains(\":\")) {\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ':'\");\n             }\n             if (indexPattern.startsWith(\"_\")) {\n-                validationErrors.add(\"template must not start with '_'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not start with '_'\");\n             }\n-            if (!Strings.validFileNameExcludingAstrix(indexPattern)) {\n-                validationErrors.add(\"template must not contain the following characters \" + Strings.INVALID_FILENAME_CHARS);\n+            if (Strings.validFileNameExcludingAstrix(indexPattern) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 117}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0MjIwMQ==", "bodyText": "@dakrone sorry, just see you are already aware of that issue. Nevermind.", "url": "https://github.com/elastic/elasticsearch/pull/56170#discussion_r420042201", "createdAt": "2020-05-05T11:35:29Z", "author": {"login": "cbuescher"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexTemplateService.java", "diffHunk": "@@ -922,70 +924,129 @@ private static void validateTemplate(Settings validateSettings, String mappings,\n         }\n     }\n \n-    private void validate(PutRequest request) {\n+    private void validate(String name, ComponentTemplate template) {\n+        validate(name,\n+            template.template().settings(),\n+            Collections.emptyList(),\n+            Optional.ofNullable(template.template().aliases())\n+                .map(aliases -> aliases.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(String name, IndexTemplateV2 template) {\n+        Optional<Template> maybeTemplate = Optional.ofNullable(template.template());\n+        validate(name,\n+            maybeTemplate.map(Template::settings).orElse(Settings.EMPTY),\n+            template.indexPatterns(),\n+            maybeTemplate\n+                .map(Template::aliases)\n+                .map(aliasMap -> aliasMap.values().stream()\n+                    .map(aliasMeta -> {\n+                        Alias a = new Alias(aliasMeta.alias());\n+                        if (aliasMeta.filter() != null) {\n+                            a.filter(aliasMeta.filter().string());\n+                        }\n+                        a.searchRouting(aliasMeta.searchRouting());\n+                        a.indexRouting(aliasMeta.indexRouting());\n+                        a.isHidden(aliasMeta.isHidden());\n+                        a.writeIndex(aliasMeta.writeIndex());\n+                        return a;\n+                    })\n+                    .collect(Collectors.toList()))\n+                .orElse(Collections.emptyList()));\n+    }\n+\n+    private void validate(PutRequest putRequest) {\n+        validate(putRequest.name, putRequest.settings, putRequest.indexPatterns, putRequest.aliases);\n+    }\n+\n+    private void validate(String name, @Nullable Settings settings, List<String> indexPatterns, List<Alias> aliases) {\n         List<String> validationErrors = new ArrayList<>();\n-        if (request.name.contains(\" \")) {\n+        if (name.contains(\" \")) {\n             validationErrors.add(\"name must not contain a space\");\n         }\n-        if (request.name.contains(\",\")) {\n+        if (name.contains(\",\")) {\n             validationErrors.add(\"name must not contain a ','\");\n         }\n-        if (request.name.contains(\"#\")) {\n+        if (name.contains(\"#\")) {\n             validationErrors.add(\"name must not contain a '#'\");\n         }\n-        if (request.name.startsWith(\"_\")) {\n+        if (name.contains(\"*\")) {\n+            validationErrors.add(\"name must not contain a '*'\");\n+        }\n+        if (name.startsWith(\"_\")) {\n             validationErrors.add(\"name must not start with '_'\");\n         }\n-        if (!request.name.toLowerCase(Locale.ROOT).equals(request.name)) {\n+        if (name.toLowerCase(Locale.ROOT).equals(name) == false) {\n             validationErrors.add(\"name must be lower cased\");\n         }\n-        for(String indexPattern : request.indexPatterns) {\n+        for(String indexPattern : indexPatterns) {\n             if (indexPattern.contains(\" \")) {\n-                validationErrors.add(\"template must not contain a space\");\n+                validationErrors.add(\"index_patterns [\" + indexPattern + \"] must not contain a space\");\n             }\n             if (indexPattern.contains(\",\")) {\n-                validationErrors.add(\"template must not contain a ','\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ','\");\n             }\n             if (indexPattern.contains(\"#\")) {\n-                validationErrors.add(\"template must not contain a '#'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a '#'\");\n+            }\n+            if (indexPattern.contains(\":\")) {\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not contain a ':'\");\n             }\n             if (indexPattern.startsWith(\"_\")) {\n-                validationErrors.add(\"template must not start with '_'\");\n+                validationErrors.add(\"index_pattern [\" + indexPattern + \"] must not start with '_'\");\n             }\n-            if (!Strings.validFileNameExcludingAstrix(indexPattern)) {\n-                validationErrors.add(\"template must not contain the following characters \" + Strings.INVALID_FILENAME_CHARS);\n+            if (Strings.validFileNameExcludingAstrix(indexPattern) == false) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDA0MTUxMw=="}, "originalCommit": {"oid": "25ee3ced9469205c234a0c900900963b324d01f2"}, "originalPosition": 117}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2367, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}