{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExNzE4OTMz", "number": 64308, "title": "EQL: [Tests] enable server side debugging", "bodyText": "Register a new task runEqlCorrectnessNode which enables developers to\nstart an ES node in debug mode, properly restore the correctness data\nand then run queries against it.", "createdAt": "2020-10-28T17:30:19Z", "url": "https://github.com/elastic/elasticsearch/pull/64308", "merged": true, "mergeCommit": {"oid": "fc8c6dd56d602b4a62ee1ff484f00caab92dc6e2"}, "closed": true, "closedAt": "2020-10-30T21:26:22Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXBBVDgH2gAyNTExNzE4OTMzOmQ4ZDA0OGM3OTUyMDg0M2Q2OTljYWJiMDEwNzExZGNjM2U2Njc2Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXsciMgFqTUyMDk5ODA1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8d048c79520843d699cabb010711dcc3e667668", "committedDate": "2020-10-28T17:28:51Z", "message": "EQL: [Tests] enable server side debugging\n\nRegister a new task `runEqlCorrectnessNode` which enables developers to\nstart an ES node in debug mode, properly restore the correctness data\nand then run queries against it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5MzgxNjA1", "url": "https://github.com/elastic/elasticsearch/pull/64308#pullrequestreview-519381605", "createdAt": "2020-10-29T07:06:22Z", "commit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzowNjoyM1rOHqOh0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOVQwNzozMDo0MVrOHqPRyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA0MDI3Mw==", "bodyText": "Why removing this method?", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514040273", "createdAt": "2020-10-29T07:06:23Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EsEQLCorrectnessIT.java", "diffHunk": "@@ -105,18 +77,6 @@ public static void logTotalExecutionTime() {\n         LOGGER.info(\"Total time: {} ms\", totalTime);\n     }\n \n-    @AfterClass", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDExMQ==", "bodyText": "You could load the Properties inside the try() { .... } block.", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514050111", "createdAt": "2020-10-29T07:24:46Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EqlDataLoader.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.elasticsearch.action.admin.cluster.repositories.put.PutRepositoryRequest;\n+import org.elasticsearch.action.admin.cluster.snapshots.restore.RestoreSnapshotRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.Properties;\n+\n+public class EqlDataLoader {\n+\n+    private static final String PROPERTIES_FILENAME = \"config.properties\";\n+\n+    public static void main(String[] args) throws IOException {\n+        // Need to setup the log configuration properly to avoid messages when creating a new RestClient\n+        PluginManager.addPackage(LogConfigurator.class.getPackage().getName());\n+\n+        Properties configuration = loadConfiguration();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MDcxOA==", "bodyText": "To be 100% correct, I think it should be EqlDataLoader's class loader to load the properties file.", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514050718", "createdAt": "2020-10-29T07:26:23Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EqlDataLoader.java", "diffHunk": "@@ -0,0 +1,80 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql;\n+\n+import org.apache.http.HttpHost;\n+import org.apache.logging.log4j.core.config.plugins.util.PluginManager;\n+import org.elasticsearch.action.admin.cluster.repositories.put.PutRepositoryRequest;\n+import org.elasticsearch.action.admin.cluster.snapshots.restore.RestoreSnapshotRequest;\n+import org.elasticsearch.client.Request;\n+import org.elasticsearch.client.RequestOptions;\n+import org.elasticsearch.client.RestClient;\n+import org.elasticsearch.client.RestHighLevelClient;\n+import org.elasticsearch.common.logging.LogConfigurator;\n+import org.elasticsearch.common.settings.Settings;\n+\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.util.List;\n+import java.util.Properties;\n+\n+public class EqlDataLoader {\n+\n+    private static final String PROPERTIES_FILENAME = \"config.properties\";\n+\n+    public static void main(String[] args) throws IOException {\n+        // Need to setup the log configuration properly to avoid messages when creating a new RestClient\n+        PluginManager.addPackage(LogConfigurator.class.getPackage().getName());\n+\n+        Properties configuration = loadConfiguration();\n+        try (\n+            RestClient client = RestClient.builder(new HttpHost(\"localhost\", 9200))\n+                .setRequestConfigCallback(\n+                    requestConfigBuilder -> requestConfigBuilder.setConnectTimeout(30000000)\n+                        .setConnectionRequestTimeout(30000000)\n+                        .setSocketTimeout(30000000)\n+                )\n+                .setStrictDeprecationMode(true)\n+                .build()\n+        ) {\n+            restoreSnapshot(client, new RestHighLevelClient(client, ignore -> {}, List.of()) {\n+            }, configuration);\n+        }\n+    }\n+\n+    static Properties loadConfiguration() throws IOException {\n+        try (InputStream is = EsEQLCorrectnessIT.class.getClassLoader().getResourceAsStream(PROPERTIES_FILENAME)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MTI5NQ==", "bodyText": "Typo: can ber run", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514051295", "createdAt": "2020-10-29T07:27:52Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/README.md", "diffHunk": "@@ -66,3 +66,22 @@ or\n ./gradlew ':x-pack:plugin:eql:qa:correctness:javaRestTest' --tests \"org.elasticsearch.xpack.eql.EsEQLCorrectnessIT.test {<queryNo>}\" -Dtests.eql_correctness_debug=true\n ```\n \n+### Run an ES node manually and run the tests against it \n+\n+If one wants to run an ES node manually (most probably to be able to debug the server), needs to run the following:\n+\n+```shell script\n+./gradlew -p x-pack/plugin/eql/qa/correctness runEqlCorrectnessNode --debug-jvm\n+```\n+\n+**Set the `eql_test_credentials_file` environmental variable correctly in the shell before running the command above,**\n+\n+Once the ES node is up and running, the data can be restored from the snapshot by running the `main` of the \n+`EqlDataLoader` class.\n+\n+Once the data is loaded, a specific query can ber run against the running ES node with:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MjQyNg==", "bodyText": "If below you provided an example gradlew command without using -p, I think it's better to be consistent and either use here the same format as the other command or use -p in both places. Not sure of the differences though, but I've been advised lately to stop using the -p format in favor of something like gradlew :x-pack:plugin:eql:qa:correctness:runEqlCorrectness --debug-jvm", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514052426", "createdAt": "2020-10-29T07:30:20Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/README.md", "diffHunk": "@@ -66,3 +66,22 @@ or\n ./gradlew ':x-pack:plugin:eql:qa:correctness:javaRestTest' --tests \"org.elasticsearch.xpack.eql.EsEQLCorrectnessIT.test {<queryNo>}\" -Dtests.eql_correctness_debug=true\n ```\n \n+### Run an ES node manually and run the tests against it \n+\n+If one wants to run an ES node manually (most probably to be able to debug the server), needs to run the following:\n+\n+```shell script\n+./gradlew -p x-pack/plugin/eql/qa/correctness runEqlCorrectnessNode --debug-jvm", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNDA1MjU1Mw==", "bodyText": "The highLevelClient has a reference to the rest client already (through getLowLevelClient()), I don't think you need to pass client() here.", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r514052553", "createdAt": "2020-10-29T07:30:41Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/java/org/elasticsearch/xpack/eql/EsEQLCorrectnessIT.java", "diffHunk": "@@ -72,27 +64,7 @@ public static void init() throws IOException {\n \n     @Before\n     public void restoreDataFromGcsRepo() throws Exception {\n-        if (client().performRequest(new Request(\"HEAD\", \"/\" + CFG.getProperty(\"index_name\"))).getStatusLine().getStatusCode() == 404) {\n-            highLevelClient().snapshot()\n-                .createRepository(\n-                    new PutRepositoryRequest(CFG.getProperty(\"gcs_repo_name\")).type(\"gcs\")\n-                        .settings(\n-                            Settings.builder()\n-                                .put(\"bucket\", CFG.getProperty(\"gcs_bucket_name\"))\n-                                .put(\"base_path\", CFG.getProperty(\"gcs_base_path\"))\n-                                .put(\"client\", CFG.getProperty(\"gcs_client_name\"))\n-                                .build()\n-                        ),\n-                    RequestOptions.DEFAULT\n-                );\n-            highLevelClient().snapshot()\n-                .restore(\n-                    new RestoreSnapshotRequest(CFG.getProperty(\"gcs_repo_name\"), CFG.getProperty(\"gcs_snapshot_name\")).waitForCompletion(\n-                        true\n-                    ),\n-                    RequestOptions.DEFAULT\n-                );\n-        }\n+        EqlDataLoader.restoreSnapshot(client(), highLevelClient(), CFG);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d8d048c79520843d699cabb010711dcc3e667668"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb02aa1701493fc4cfaf73ecb0c32ba36b3595c5", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb02aa1701493fc4cfaf73ecb0c32ba36b3595c5", "committedDate": "2020-10-29T10:39:17Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE5NjU1NjAz", "url": "https://github.com/elastic/elasticsearch/pull/64308#pullrequestreview-519655603", "createdAt": "2020-10-29T13:20:50Z", "commit": {"oid": "bb02aa1701493fc4cfaf73ecb0c32ba36b3595c5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "350748dd51e016f496a210f671def9291c5abc1c", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/350748dd51e016f496a210f671def9291c5abc1c", "committedDate": "2020-10-30T13:00:01Z", "message": "assert index restored, use new snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwNjgxMDIw", "url": "https://github.com/elastic/elasticsearch/pull/64308#pullrequestreview-520681020", "createdAt": "2020-10-30T13:45:19Z", "commit": {"oid": "350748dd51e016f496a210f671def9291c5abc1c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMzo0NToyMFrOHrPrIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQxMzo0NToyMFrOHrPrIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTEwNzYxNg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r515107616", "createdAt": "2020-10-30T13:45:20Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/correctness/src/javaRestTest/resources/config.properties", "diffHunk": "@@ -5,10 +5,11 @@\n #\n \n index_name=mitre\n+index_doc_count=3950632", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "350748dd51e016f496a210f671def9291c5abc1c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68f3040122fd4252a91664a4a92e8e914a88c6f0", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/68f3040122fd4252a91664a4a92e8e914a88c6f0", "committedDate": "2020-10-30T13:48:10Z", "message": "Merge remote-tracking branch 'upstream/master' into debug-eql-correctness"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIwOTk4MDU3", "url": "https://github.com/elastic/elasticsearch/pull/64308#pullrequestreview-520998057", "createdAt": "2020-10-30T20:04:06Z", "commit": {"oid": "68f3040122fd4252a91664a4a92e8e914a88c6f0"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMDowNDowN1rOHreb-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0zMFQyMDowNDowN1rOHreb-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNTM0OTQ5Nw==", "bodyText": "\ud83d\udc4d LGTM", "url": "https://github.com/elastic/elasticsearch/pull/64308#discussion_r515349497", "createdAt": "2020-10-30T20:04:07Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/eql/qa/correctness/build.gradle", "diffHunk": "@@ -36,3 +44,8 @@ tasks.named('javaRestTest').configure {\n     showStandardStreams = true\n   }\n }\n+\n+tasks.register(\"runEqlCorrectnessNode\", RunTask) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "68f3040122fd4252a91664a4a92e8e914a88c6f0"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 946, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}