{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxOTM1MTU4", "number": 65835, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNjoyM1rOFAhYWQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNjoyM1rOFAhYWQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM2MDkxMjI1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNjoyM1rOH-3iaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wNFQwODozOToxM1rOH_GVMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzY4OA==", "bodyText": "nit: I assume this would be a programmers error, if so can this just be a Java assert instead of an assertThat to help differentiate between something that is being tested and a self documenting sanity check. Also, why Less ? should be it be not equal ?", "url": "https://github.com/elastic/elasticsearch/pull/65835#discussion_r535683688", "createdAt": "2020-12-03T22:16:23Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "diffHunk": "@@ -70,18 +75,23 @@ public final void stopWatcher() throws Exception {\n                     throw new AssertionError(\"unknown state[\" + state + \"]\");\n             }\n         }, 60, TimeUnit.SECONDS);\n+        deleteAllWatcherData();\n+    }\n+\n+    public static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n \n-        Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n-        deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n-        deleteWatchesIndexRequest.setOptions(\n-            expectWarnings(\n-                \"this request accesses system indices: [.watches], but in a future major \"\n-                    + \"version, direct access to system indices will be prevented by default\"\n-            )\n-        );\n-        ESRestTestCase.adminClient().performRequest(deleteWatchesIndexRequest);\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assertThat(\"Less watches requested than exist in total\", watches.size(), equalTo(totalCount));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTkyNjA2NA==", "bodyText": "Right, I will adjust the worden and turn this into an assert.", "url": "https://github.com/elastic/elasticsearch/pull/65835#discussion_r535926064", "createdAt": "2020-12-04T08:39:13Z", "author": {"login": "martijnvg"}, "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "diffHunk": "@@ -70,18 +75,23 @@ public final void stopWatcher() throws Exception {\n                     throw new AssertionError(\"unknown state[\" + state + \"]\");\n             }\n         }, 60, TimeUnit.SECONDS);\n+        deleteAllWatcherData();\n+    }\n+\n+    public static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n \n-        Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n-        deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n-        deleteWatchesIndexRequest.setOptions(\n-            expectWarnings(\n-                \"this request accesses system indices: [.watches], but in a future major \"\n-                    + \"version, direct access to system indices will be prevented by default\"\n-            )\n-        );\n-        ESRestTestCase.adminClient().performRequest(deleteWatchesIndexRequest);\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assertThat(\"Less watches requested than exist in total\", watches.size(), equalTo(totalCount));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzY4OA=="}, "originalCommit": {"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf"}, "originalPosition": 36}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1846, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}