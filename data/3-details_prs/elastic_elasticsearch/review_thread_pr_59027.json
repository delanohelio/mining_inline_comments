{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MTUwNzEz", "number": 59027, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMDo0NlrOELlk-A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMjowMFrOELlmlg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNTg1NDY0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMDo0NlrOGtNcyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMDo0NlrOGtNcyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA1OTQ2NA==", "bodyText": "I think you could replace this call with a more concise client.admin().cluster()::health.", "url": "https://github.com/elastic/elasticsearch/pull/59027#discussion_r450059464", "createdAt": "2020-07-06T08:20:46Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "diffHunk": "@@ -69,13 +72,38 @@ private MlIndexAndAlias() {}\n      * Adds an {@code alias} to that index if it was created,\n      * or to the index with the highest suffix if the index did not have to be created.\n      * The listener is notified with a {@code boolean} that informs whether the index or the alias were created.\n+     * If the index is created, the listener is not called until the index is ready to use via the supplied alias,\n+     * so that a method that receives a success response from this method can safely use the index immediately.\n      */\n     public static void createIndexAndAliasIfNecessary(Client client,\n                                                       ClusterState clusterState,\n                                                       IndexNameExpressionResolver resolver,\n                                                       String indexPatternPrefix,\n                                                       String alias,\n-                                                      ActionListener<Boolean> listener) {\n+                                                      ActionListener<Boolean> finalListener) {\n+\n+        // If the index and alias were successfully created then wait for the shards of the index that the alias points to be ready\n+        ActionListener<Boolean> waitForShardsListener = ActionListener.wrap(\n+            created -> {\n+                if (created) {\n+                    ClusterHealthRequest healthRequest = Requests.clusterHealthRequest(alias)\n+                        .waitForNoRelocatingShards(true)\n+                        .waitForNoInitializingShards(true);\n+                    executeAsyncWithOrigin(\n+                        client.threadPool().getThreadContext(),\n+                        ML_ORIGIN,\n+                        healthRequest,\n+                        ActionListener.<ClusterHealthResponse>wrap(\n+                            response -> finalListener.onResponse(response.isTimedOut() == false),\n+                            finalListener::onFailure),\n+                        (request, listener) -> client.admin().cluster().health(request, listener)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6758c963dec619a94637bfce94683bac72a87566"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgwNTg1ODc4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMjowMFrOGtNfTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwODoyMjowMFrOGtNfTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDA2MDEwOQ==", "bodyText": "TBH it is always unclear to me how should I name the listener variable: after the action that takes place inside the listener or after the action that invokes the listener in the end?\nIs there any codebase-wide guideline for that?", "url": "https://github.com/elastic/elasticsearch/pull/59027#discussion_r450060109", "createdAt": "2020-07-06T08:22:00Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/utils/MlIndexAndAlias.java", "diffHunk": "@@ -69,13 +72,38 @@ private MlIndexAndAlias() {}\n      * Adds an {@code alias} to that index if it was created,\n      * or to the index with the highest suffix if the index did not have to be created.\n      * The listener is notified with a {@code boolean} that informs whether the index or the alias were created.\n+     * If the index is created, the listener is not called until the index is ready to use via the supplied alias,\n+     * so that a method that receives a success response from this method can safely use the index immediately.\n      */\n     public static void createIndexAndAliasIfNecessary(Client client,\n                                                       ClusterState clusterState,\n                                                       IndexNameExpressionResolver resolver,\n                                                       String indexPatternPrefix,\n                                                       String alias,\n-                                                      ActionListener<Boolean> listener) {\n+                                                      ActionListener<Boolean> finalListener) {\n+\n+        // If the index and alias were successfully created then wait for the shards of the index that the alias points to be ready\n+        ActionListener<Boolean> waitForShardsListener = ActionListener.wrap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6758c963dec619a94637bfce94683bac72a87566"}, "originalPosition": 33}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2036, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}