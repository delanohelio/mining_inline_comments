{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMzcxODQ2", "number": 63614, "title": "Maybe fix DiskThresholdDeciderIT", "bodyText": "This is another attempt to fix #62326 as my previous attempts failed (#63112, #63385).", "createdAt": "2020-10-13T14:15:04Z", "url": "https://github.com/elastic/elasticsearch/pull/63614", "merged": true, "mergeCommit": {"oid": "65c983a745afc0cfe57e30b979122848d09b82e0"}, "closed": true, "closedAt": "2020-10-14T13:26:53Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSJK1TgH2gAyNTAyMzcxODQ2OjM4Mjc1YWZkNzZiOWE2MTIxM2E4ZTY3NTc3MmJlMTYzMzY2YWU2NzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdSbnJWAFqTUwODI1NTE5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "38275afd76b9a61213a8e675772be163366ae670", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/38275afd76b9a61213a8e675772be163366ae670", "committedDate": "2020-10-13T14:08:51Z", "message": "Maybe fix DiskThresholdDeciderIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTc3Mjgy", "url": "https://github.com/elastic/elasticsearch/pull/63614#pullrequestreview-508177282", "createdAt": "2020-10-14T09:47:44Z", "commit": {"oid": "38275afd76b9a61213a8e675772be163366ae670"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0Nzo0NFrOHhLFbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0Nzo0NFrOHhLFbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NjY2OQ==", "bodyText": "Aren't we potentially introducing all kinds of races here when we run this concurrently and update a bunch of maps in parallel? It seems that the logic in this method doesn't really expect this to happen and it could actually have functional impact with all the various checks we do on those maps in the computations below?", "url": "https://github.com/elastic/elasticsearch/pull/63614#discussion_r504546669", "createdAt": "2020-10-14T09:47:44Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/routing/allocation/DiskThresholdMonitor.java", "diffHunk": "@@ -99,15 +99,23 @@ public DiskThresholdMonitor(Settings settings, Supplier<ClusterState> clusterSta\n         this.client = client;\n     }\n \n+    private boolean checkInProgress(final boolean expectedValue, final boolean newValue) {\n+        if (diskThresholdSettings.allowForcedUpdate()) {\n+            assert checkInProgress.get() == false;\n+            return true;\n+        }\n+        return checkInProgress.compareAndSet(expectedValue, newValue);\n+    }\n+\n     private void checkFinished() {\n-        final boolean checkFinished = checkInProgress.compareAndSet(true, false);\n+        final boolean checkFinished = checkInProgress(true, false);\n         assert checkFinished;\n         logger.trace(\"checkFinished\");\n     }\n \n     public void onNewInfo(ClusterInfo info) {\n \n-        if (checkInProgress.compareAndSet(false, true) == false) {\n+        if (checkInProgress(false, true) == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "38275afd76b9a61213a8e675772be163366ae670"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "375cde9080a23d22a51d20ccb31e641303fa9561", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/375cde9080a23d22a51d20ccb31e641303fa9561", "committedDate": "2020-10-14T10:52:36Z", "message": "Revert \"Maybe fix DiskThresholdDeciderIT\"\n\nThis reverts commit 38275afd76b9a61213a8e675772be163366ae670."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7cddec2a83bddac8bb12b26c0543398efc0a89e5", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cddec2a83bddac8bb12b26c0543398efc0a89e5", "committedDate": "2020-10-14T11:21:43Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4dc73a94f03672cb1bb95635a909bb60f1ea1c7c", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/4dc73a94f03672cb1bb95635a909bb60f1ea1c7c", "committedDate": "2020-10-14T11:21:50Z", "message": "Merge branch 'master' into maybe-DiskThresholdDeciderIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MjU1MTk1", "url": "https://github.com/elastic/elasticsearch/pull/63614#pullrequestreview-508255195", "createdAt": "2020-10-14T11:38:04Z", "commit": {"oid": "4dc73a94f03672cb1bb95635a909bb60f1ea1c7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4098, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}