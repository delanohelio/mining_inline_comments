{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMwNDIxNjQ0", "number": 65687, "title": "Abort sorting in case of local agg sort queue overflow", "bodyText": "In case the local agg sorter queue gets full and no limit has been provided, the local sorter will now erroneously call the failure callback for every single row in the original rowset that's left over the local queue limit (instead for just the first one).\nThe failure response is dispatched in any case, so this is relatively harmless.\nThe sorter continues iterating on the original response fetching subsequent pages. In case of correct Elasticsearch behaviour, this is also harmless, it'll just trigger a number of internal exceptions. However, in case of a pagination defect in Elasticsearch (like #65685, where the same search_after is returned), this will result in an effective spin loop, potentially rendering eventually the node unresponsive.\nThis PR simply breaks both the inner loop iterating over the current unsorted rowset, as well as the outer one, iterating over the left pages.\nIt also fixes an outdated documentation limitation.", "createdAt": "2020-12-01T16:23:39Z", "url": "https://github.com/elastic/elasticsearch/pull/65687", "merged": true, "mergeCommit": {"oid": "638402c387faf79bba38fcc95f371a73146efc0b"}, "closed": true, "closedAt": "2020-12-03T18:19:16Z", "author": {"login": "bpintea"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdh8KYpgH2gAyNTMwNDIxNjQ0OmU4ZTMyNDlmNTI5MDhhYTM1MjZhYzYwZjc0NGU3YTdiM2RhNjRmMjM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiml8jAH2gAyNTMwNDIxNjQ0OmViMDQyYWJkZjM4OTNjNGRiNzEyYzI4M2M5OGEzNTc1ZjhhMTkxYmM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8e3249f52908aa3526ac60f744e7a7b3da64f23", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/e8e3249f52908aa3526ac60f744e7a7b3da64f23", "committedDate": "2020-12-01T16:02:23Z", "message": "Abort sorting in case of local sort overflow\n\nIn case the local agg sorter queue gets full, stop iterating on current\nresult set and fetching next page."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyMTAxOTIy", "url": "https://github.com/elastic/elasticsearch/pull/65687#pullrequestreview-542101922", "createdAt": "2020-12-01T16:53:18Z", "commit": {"oid": "e8e3249f52908aa3526ac60f744e7a7b3da64f23"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44a839e7b6ebc3e758b14702b3e148d40f3b11f1", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/44a839e7b6ebc3e758b14702b3e148d40f3b11f1", "committedDate": "2020-12-02T12:02:00Z", "message": "Slight refactor of the fix. Add testing\n\n- Raise an exception on queue insertion failure, instead of running the\n  failure callback.\n- Add testing for the change.\n- Correct stale documentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abc652ea7660c66a21b78a6a6db0a58c066b7c9f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/abc652ea7660c66a21b78a6a6db0a58c066b7c9f", "committedDate": "2020-12-02T12:04:44Z", "message": "Merge branch 'master' into fix/bail_on_local_sort_overflow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f881a489967cf47a32498ba37f1364e804daf78d", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/f881a489967cf47a32498ba37f1364e804daf78d", "committedDate": "2020-12-02T17:11:23Z", "message": "Minor refactoring of testing\n\n- drop Mockito use, not needed in current test form."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc0da4a065699b699fa9944450518fd790b03584", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc0da4a065699b699fa9944450518fd790b03584", "committedDate": "2020-12-02T17:22:56Z", "message": "Merge branch 'master' into fix/bail_on_local_sort_overflow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMTU5MjM0", "url": "https://github.com/elastic/elasticsearch/pull/65687#pullrequestreview-543159234", "createdAt": "2020-12-02T19:16:29Z", "commit": {"oid": "44a839e7b6ebc3e758b14702b3e148d40f3b11f1"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToxNjozMFrOH9qWuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQxOToxNjozMFrOH9qWuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDQxOTEyOA==", "bodyText": "We should backport this to reflect the change that happened quite some time ago.", "url": "https://github.com/elastic/elasticsearch/pull/65687#discussion_r534419128", "createdAt": "2020-12-02T19:16:30Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/limitations.asciidoc", "diffHunk": "@@ -105,8 +105,8 @@ When multiple values are returned for a field, by default, {es-sql} will throw a\n === Sorting by aggregation\n \n When doing aggregations (`GROUP BY`) {es-sql} relies on {es}'s `composite` aggregation for its support for paginating results.\n-However this type of aggregation does come with a limitation: sorting can only be applied on the key used for the aggregation's buckets. \n-{es-sql} overcomes this limitation by doing client-side sorting however as a safety measure, allows only up to *512* rows.\n+However this type of aggregation does come with a limitation: sorting can only be applied on the key used for the aggregation's buckets.\n+{es-sql} overcomes this limitation by doing client-side sorting however as a safety measure, allows only up to *65535* rows.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "44a839e7b6ebc3e758b14702b3e148d40f3b11f1"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNDQyOTU1", "url": "https://github.com/elastic/elasticsearch/pull/65687#pullrequestreview-543442955", "createdAt": "2020-12-03T04:41:43Z", "commit": {"oid": "dc0da4a065699b699fa9944450518fd790b03584"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNDo0MTo0M1rOH95RqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QwNDo0MTo0M1rOH95RqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDY2MzU5Mw==", "bodyText": "No need for this one to be public. Also, the method should be moved last in the class.", "url": "https://github.com/elastic/elasticsearch/pull/65687#discussion_r534663593", "createdAt": "2020-12-03T04:41:43Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/execution/search/QuerierTests.java", "diffHunk": "@@ -171,4 +184,85 @@ public void testAggSorting_Randomized() {\n         });\n         assertEquals(expected.subList(0, queueSize), results);\n     }\n+\n+    public Tuple<Integer, Integer> runLocalAggSorterWithNoLimit(int dataSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc0da4a065699b699fa9944450518fd790b03584"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzNDQzNzA5", "url": "https://github.com/elastic/elasticsearch/pull/65687#pullrequestreview-543443709", "createdAt": "2020-12-03T04:42:16Z", "commit": {"oid": "dc0da4a065699b699fa9944450518fd790b03584"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9532d67035c20765cb16ee5c00d1ac163bc2a9b6", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/9532d67035c20765cb16ee5c00d1ac163bc2a9b6", "committedDate": "2020-12-03T12:51:45Z", "message": "Address review comments\n\n- remove \"public\" method attr and move it to the bottom of class."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "987bc80f0b77d2c20c77c44e1312f0074b5cc350", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/987bc80f0b77d2c20c77c44e1312f0074b5cc350", "committedDate": "2020-12-03T12:52:46Z", "message": "Merge branch 'fix/bail_on_local_sort_overflow' of github.com:bpintea/elasticsearch into fix/bail_on_local_sort_overflow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bca7a849317fe2fad39a893081bf5fbbe7cd938b", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/bca7a849317fe2fad39a893081bf5fbbe7cd938b", "committedDate": "2020-12-03T12:53:17Z", "message": "Merge remote-tracking branch 'upstream/master' into fix/bail_on_local_sort_overflow"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0MTIxMDU1", "url": "https://github.com/elastic/elasticsearch/pull/65687#pullrequestreview-544121055", "createdAt": "2020-12-03T16:06:39Z", "commit": {"oid": "bca7a849317fe2fad39a893081bf5fbbe7cd938b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjowNjo0MFrOH-kSsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxNjowODo1OVrOH-kZSA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2ODM3MA==", "bodyText": "Since we already have access to the listener, how about returning a bool instead of throwing an exception.\nThere's nothing wrong with it yet consumeRowSet is used only internally so promoting the condition to an exception only to catch it later  looks a bit wasteful to me.\nsuggestion:\nif (consumeRowSet(page.rowSet()) == false) {\n   return;\n}", "url": "https://github.com/elastic/elasticsearch/pull/65687#discussion_r535368370", "createdAt": "2020-12-03T16:06:40Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/execution/search/Querier.java", "diffHunk": "@@ -225,8 +226,13 @@ public void onResponse(Page page) {\n                 }\n             }\n \n-            // 1. consume all pages received\n-            consumeRowSet(page.rowSet());\n+            try {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca7a849317fe2fad39a893081bf5fbbe7cd938b"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM2OTI1NA==", "bodyText": "Static imports?", "url": "https://github.com/elastic/elasticsearch/pull/65687#discussion_r535369254", "createdAt": "2020-12-03T16:07:51Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/execution/search/QuerierTests.java", "diffHunk": "@@ -171,4 +184,85 @@ public void testAggSorting_Randomized() {\n         });\n         assertEquals(expected.subList(0, queueSize), results);\n     }\n+\n+    public void testFullQueueSortingOnLocalSort() {\n+        Tuple<Integer, Integer> actions = runLocalAggSorterWithNoLimit(MultiBucketConsumerService.DEFAULT_MAX_BUCKETS);\n+\n+        assertEquals(\"Exactly one response expected\", 1, actions.v1().intValue());\n+        assertEquals(\"No failures expected\", 0, actions.v2().intValue());\n+    }\n+\n+    public void testQueueOverflowSortingOnLocalSort() {\n+        Tuple<Integer, Integer> actions = runLocalAggSorterWithNoLimit(MultiBucketConsumerService.DEFAULT_MAX_BUCKETS + 2);\n+\n+        assertEquals(\"No response expected\", 0, actions.v1().intValue());\n+        assertEquals(\"Exactly one failure expected\", 1, actions.v2().intValue());\n+    }\n+\n+    Tuple<Integer, Integer> runLocalAggSorterWithNoLimit(int dataSize) {\n+        class TestResultRowSet<E extends NamedWriteable> extends ResultRowSet<E> implements SchemaRowSet {\n+\n+            private int rowCounter = 0;\n+            private final int dataSize;\n+\n+            TestResultRowSet(List<E> extractors, BitSet mask, int dataSize) {\n+                super(extractors, mask);\n+                this.dataSize = dataSize;\n+            }\n+\n+            @Override\n+            protected Object extractValue(NamedWriteable namedWriteable) {\n+                return rowCounter++;\n+            }\n+\n+            @Override\n+            protected boolean doHasCurrent() {\n+                return true;\n+            }\n+\n+            @Override\n+            protected boolean doNext() {\n+                return rowCounter < dataSize;\n+            }\n+\n+            @Override\n+            protected void doReset() {\n+            }\n+\n+            @Override\n+            public Schema schema() {\n+                return new Schema(Collections.<String>emptyList(), Collections.<DataType>emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca7a849317fe2fad39a893081bf5fbbe7cd938b"}, "originalPosition": 80}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTM3MDA1Ng==", "bodyText": "Nice", "url": "https://github.com/elastic/elasticsearch/pull/65687#discussion_r535370056", "createdAt": "2020-12-03T16:08:59Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/execution/search/QuerierTests.java", "diffHunk": "@@ -171,4 +184,85 @@ public void testAggSorting_Randomized() {\n         });\n         assertEquals(expected.subList(0, queueSize), results);\n     }\n+\n+    public void testFullQueueSortingOnLocalSort() {\n+        Tuple<Integer, Integer> actions = runLocalAggSorterWithNoLimit(MultiBucketConsumerService.DEFAULT_MAX_BUCKETS);\n+\n+        assertEquals(\"Exactly one response expected\", 1, actions.v1().intValue());\n+        assertEquals(\"No failures expected\", 0, actions.v2().intValue());\n+    }\n+\n+    public void testQueueOverflowSortingOnLocalSort() {\n+        Tuple<Integer, Integer> actions = runLocalAggSorterWithNoLimit(MultiBucketConsumerService.DEFAULT_MAX_BUCKETS + 2);\n+\n+        assertEquals(\"No response expected\", 0, actions.v1().intValue());\n+        assertEquals(\"Exactly one failure expected\", 1, actions.v2().intValue());\n+    }\n+\n+    Tuple<Integer, Integer> runLocalAggSorterWithNoLimit(int dataSize) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bca7a849317fe2fad39a893081bf5fbbe7cd938b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12bc667c2c27b7b6c6bb64f10e5e39417e517340", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/12bc667c2c27b7b6c6bb64f10e5e39417e517340", "committedDate": "2020-12-03T17:16:06Z", "message": "Address review comments\n\n- revert back to bool-based flow control.\n- import static methods where possible."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d60a892cdfaff12e3d330328fa82ea4dd131d46d", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/d60a892cdfaff12e3d330328fa82ea4dd131d46d", "committedDate": "2020-12-03T17:27:38Z", "message": "Style fix\n\n- unused import removed."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eb042abdf3893c4db712c283c98a3575f8a191bc", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/eb042abdf3893c4db712c283c98a3575f8a191bc", "committedDate": "2020-12-03T17:28:30Z", "message": "Merge branch 'master' into fix/bail_on_local_sort_overflow"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4210, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}