{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAyMjE2NDM5", "number": 63603, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyODozNFrOEs_hxg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyNTowNlrOEtCbWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NjEzNjM4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMToyODozNFrOHgiCdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMTozNzo1OVrOHgiYFA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ==", "bodyText": "the supplier feels weird, yet I believe we need to distinguish between a null document mapper and a null type, hence simply providing the type as an argument did not feel right to me. Happy to be proven wrong.", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503874165", "createdAt": "2020-10-13T11:28:34Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -85,13 +85,13 @@ public Status needsField(FieldInfo fieldInfo) {\n         // All these fields are single-valued so we can stop when the set is\n         // empty\n         return requiredFields.isEmpty()\n-                ? Status.STOP\n-                : Status.NO;\n+            ? Status.STOP\n+            : Status.NO;\n     }\n \n-    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable DocumentMapper mapper) {\n-        if (mapper != null) {\n-            type = mapper.type();\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable Supplier<String> typeSupplier) {\n+        if (typeSupplier != null) {\n+            type = typeSupplier.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3ODc0Ng==", "bodyText": "The only time you would have a null type is if no mappings were configured; in which case there would be no documents in the index, and FieldsVisitor would not be able to load any data.  So I think you can just replace this with a straight String - it might even be worth adding an assertion that the type is not null here?", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503878746", "createdAt": "2020-10-13T11:36:23Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -85,13 +85,13 @@ public Status needsField(FieldInfo fieldInfo) {\n         // All these fields are single-valued so we can stop when the set is\n         // empty\n         return requiredFields.isEmpty()\n-                ? Status.STOP\n-                : Status.NO;\n+            ? Status.STOP\n+            : Status.NO;\n     }\n \n-    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable DocumentMapper mapper) {\n-        if (mapper != null) {\n-            type = mapper.type();\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable Supplier<String> typeSupplier) {\n+        if (typeSupplier != null) {\n+            type = typeSupplier.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ=="}, "originalCommit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3OTcwMA==", "bodyText": "ok will do thanks for the feedback", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503879700", "createdAt": "2020-10-13T11:37:59Z", "author": {"login": "javanna"}, "path": "server/src/main/java/org/elasticsearch/index/fieldvisitor/FieldsVisitor.java", "diffHunk": "@@ -85,13 +85,13 @@ public Status needsField(FieldInfo fieldInfo) {\n         // All these fields are single-valued so we can stop when the set is\n         // empty\n         return requiredFields.isEmpty()\n-                ? Status.STOP\n-                : Status.NO;\n+            ? Status.STOP\n+            : Status.NO;\n     }\n \n-    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable DocumentMapper mapper) {\n-        if (mapper != null) {\n-            type = mapper.type();\n+    public final void postProcess(Function<String, MappedFieldType> fieldTypeLookup, @Nullable Supplier<String> typeSupplier) {\n+        if (typeSupplier != null) {\n+            type = typeSupplier.get();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzg3NDE2NQ=="}, "originalCommit": {"oid": "64154908546aae1f6b7ecfc3f243097be7e03d64"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1NjYxMTQ2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzoyNTowNlrOHgmlvw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QxMzozMTo0NlrOHgm5og==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ==", "bodyText": "I took a shortcut here, to avoid having to expose typeText from MapperService. Is it reasonable?", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503948735", "createdAt": "2020-10-13T13:25:06Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "diffHunk": "@@ -237,7 +237,8 @@ protected MultiSearchResponse shardOperation(Request request, ShardId shardId) t\n                     () -> { throw new UnsupportedOperationException(); },\n                     null\n                 );\n-                final Text typeText = context.getMapperService().documentMapper().typeText();\n+                final String type = context.getType();\n+                final Text typeText = new Text(type);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk1MzgyNg==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/63603#discussion_r503953826", "createdAt": "2020-10-13T13:31:46Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/enrich/src/main/java/org/elasticsearch/xpack/enrich/action/EnrichShardMultiSearchAction.java", "diffHunk": "@@ -237,7 +237,8 @@ protected MultiSearchResponse shardOperation(Request request, ShardId shardId) t\n                     () -> { throw new UnsupportedOperationException(); },\n                     null\n                 );\n-                final Text typeText = context.getMapperService().documentMapper().typeText();\n+                final String type = context.getType();\n+                final Text typeText = new Text(type);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzk0ODczNQ=="}, "originalCommit": {"oid": "7c79179f7c6cd0587ee7fac2fb160a9d6beffef5"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2962, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}