{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxNDgwMTIw", "number": 57855, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzozNTowNVrOED4W9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzozNTowNVrOED4W9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyNTA0NTY3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxMzozNTowNVrOGhKD-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQxNTozMjoyMVrOGhQXMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMTA1MQ==", "bodyText": "I'd prefer to avoid this one day, but for now it is cool. And, I think it'd be a bit overboard to try and avoid it now. If I did want to avoid it maybe something like:\npublic Function<Object, String> sourceParser(String format);\n\nI don't know. Just thinking out loud. Not needed now.", "url": "https://github.com/elastic/elasticsearch/pull/57855#discussion_r437421051", "createdAt": "2020-06-09T13:35:05Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -628,12 +628,16 @@ protected void parseCreateField(ParseContext context) throws IOException {\n     }\n \n     @Override\n-    public String parseSourceValue(Object value) {\n+    public String parseSourceValue(Object value, String format) {\n         String date = value.toString();\n         long timestamp = fieldType().parse(date);\n-\n         ZonedDateTime dateTime = fieldType().resolution().toInstant(timestamp).atZone(ZoneOffset.UTC);\n-        return fieldType().dateTimeFormatter().format(dateTime);\n+\n+        DateFormatter dateTimeFormatter = fieldType().dateTimeFormatter();\n+        if (format != null) {\n+            dateTimeFormatter = DateFormatter.forPattern(format).withLocale(dateTimeFormatter.locale());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "51b7de7954546c576001b683e2f724974143abc0"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzUyNDI3NA==", "bodyText": "I agree, instead of a function we could even introduce an object like SourceValueParser. This could also help clean up some of the fragility around the dual lookupValues and parseSourceValue methods. It did feel like overkill to do this refactor now, though.", "url": "https://github.com/elastic/elasticsearch/pull/57855#discussion_r437524274", "createdAt": "2020-06-09T15:32:21Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -628,12 +628,16 @@ protected void parseCreateField(ParseContext context) throws IOException {\n     }\n \n     @Override\n-    public String parseSourceValue(Object value) {\n+    public String parseSourceValue(Object value, String format) {\n         String date = value.toString();\n         long timestamp = fieldType().parse(date);\n-\n         ZonedDateTime dateTime = fieldType().resolution().toInstant(timestamp).atZone(ZoneOffset.UTC);\n-        return fieldType().dateTimeFormatter().format(dateTime);\n+\n+        DateFormatter dateTimeFormatter = fieldType().dateTimeFormatter();\n+        if (format != null) {\n+            dateTimeFormatter = DateFormatter.forPattern(format).withLocale(dateTimeFormatter.locale());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzQyMTA1MQ=="}, "originalCommit": {"oid": "51b7de7954546c576001b683e2f724974143abc0"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1717, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}