{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNTE0MDE5", "number": 54926, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo0NToxNFrODwE51A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyNDoyNlrODwbYXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNzM4NTgwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNjo0NToxNFrOGC323w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQxNzoxMjoyMlrOGC46ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NTUwMw==", "bodyText": "Hmm, I think these exception messages are a bit confusing.  If I understand correctly, this path theoretically should never happen because e.g. InternalAggregations won't serialize pipelines in 7.8+, so read/write on the aggregator 7.8+ should never be invoked.\nI think we should probably change the message to \"Cannot (de)serialize pipeline aggregator from stream because pipelines are not serialized after 7.8\" or something to that effect.  That way if a user does see this, it won't confuse them; the current message may make them think the aggregation itself is no longer supported (due to the node being 7.8+ to reach that statement, but the message saying \"before 7.8\").\nI think we need to throw a 5xx error too, because if we get here we are firmly in the server-side going pear shaped and not the fault of a client/user.  Perhaps IllegalStateException?", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r405665503", "createdAt": "2020-04-08T16:45:14Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalArgumentException(\"[\" + getClass() + \"] is not supported on versions before 7.8.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY4Mjg3NA==", "bodyText": "Makes sense to me!", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r405682874", "createdAt": "2020-04-08T17:12:22Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalArgumentException(\"[\" + getClass() + \"] is not supported on versions before 7.8.0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTY2NTUwMw=="}, "originalCommit": {"oid": "761ba29cba4a7878af05375cc250a85f23fd89f7"}, "originalPosition": 24}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyMTA2ODQ2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDoyNDoyNlrOGDbEyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOVQxNDo0MTowMFrOGDbzpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjUwNA==", "bodyText": "Typo: \"because it 7.8.0\" :)", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r406242504", "createdAt": "2020-04-09T14:24:26Z", "author": {"login": "polyfractal"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalStateException(\"Cannot deserialize pipeline [\" + getClass() + \"] because it 7.8.0\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI1NDUwMA==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/54926#discussion_r406254500", "createdAt": "2020-04-09T14:41:00Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/pipeline/PipelineAggregator.java", "diffHunk": "@@ -113,22 +114,54 @@ protected PipelineAggregator(String name, String[] bucketsPaths, Map<String, Obj\n \n     /**\n      * Read from a stream.\n+     * @deprecated pipeline aggregations added after 7.8.0 shouldn't call this\n      */\n+    @Deprecated\n     protected PipelineAggregator(StreamInput in) throws IOException {\n-        name = in.readString();\n-        bucketsPaths = in.readStringArray();\n-        metadata = in.readMap();\n+        if (in.getVersion().before(Version.V_7_8_0)) {\n+            name = in.readString();\n+            bucketsPaths = in.readStringArray();\n+            metadata = in.readMap();\n+        } else {\n+           throw new IllegalStateException(\"Cannot deserialize pipeline [\" + getClass() + \"] because it 7.8.0\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjI0MjUwNA=="}, "originalCommit": {"oid": "bbbc216507c26406c2a8a3475754b1a89b870d7d"}, "originalPosition": 24}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1167, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}