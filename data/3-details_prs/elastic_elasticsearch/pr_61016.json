{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY2NjcxNDQ1", "number": 61016, "title": "Do not access snapshot repo on dedicated voting-only master node", "bodyText": "Today a snapshot repository verification ensures that all master-eligible and data nodes have write access to the snapshot repository (and can see each other's data) since taking a snapshot requires data nodes and the currently-elected master to write to the repository. However, a dedicated voting-only master-eligible node is not a data node and will never be the elected master so we should not require it to have write access to the repository.\nCloses #59649", "createdAt": "2020-08-12T10:23:25Z", "url": "https://github.com/elastic/elasticsearch/pull/61016", "merged": true, "mergeCommit": {"oid": "b2ee4749cc611e8c1d7bf8d29e4d30f51910673f"}, "closed": true, "closedAt": "2020-08-12T14:36:24Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-IuZHAH2gAyNDY2NjcxNDQ1OjhlMzEyN2I2MTNjZDliYmRhYmYwODAzNmUxYzk3Yzk2NDdjNjQxN2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-KrdBAFqTQ2NTg3Mjg3NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e3127b613cd9bbdabf08036e1c97c9647c6417e", "committedDate": "2020-08-12T10:19:18Z", "message": "Do not access snapshot repo on dedicated voting-only master node"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1NzkwMTM5", "url": "https://github.com/elastic/elasticsearch/pull/61016#pullrequestreview-465790139", "createdAt": "2020-08-12T10:33:35Z", "commit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMDozMzozNVrOG_bhnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMDozMzozNVrOG_bhnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2NDQ0NA==", "bodyText": "Maybe we could just not add the applier in the first place in the constructor where we check if the node is a master or data node (we should have the information that this is a voting only node there already from the settings?)?", "url": "https://github.com/elastic/elasticsearch/pull/61016#discussion_r469164444", "createdAt": "2020-08-12T10:33:35Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoriesService.java", "diffHunk": "@@ -290,6 +294,9 @@ protected void doRun() {\n     public void applyClusterState(ClusterChangedEvent event) {\n         try {\n             final ClusterState state = event.state();\n+            if (isDedicatedVotingOnlyNode(state.nodes().getLocalNode())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODMwMjU3", "url": "https://github.com/elastic/elasticsearch/pull/61016#pullrequestreview-465830257", "createdAt": "2020-08-12T11:41:06Z", "commit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTo0MTowNlrOG_dc9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xMlQxMTo0MzowOFrOG_dguA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5NjAyMg==", "bodyText": "We need to be able to compute this from a DiscoveryNode since we need to know it for remote nodes too, and we won't have a DiscoveryNode in the constructor so would have to implement it two different ways. I think I prefer this.", "url": "https://github.com/elastic/elasticsearch/pull/61016#discussion_r469196022", "createdAt": "2020-08-12T11:41:06Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoriesService.java", "diffHunk": "@@ -290,6 +294,9 @@ protected void doRun() {\n     public void applyClusterState(ClusterChangedEvent event) {\n         try {\n             final ClusterState state = event.state();\n+            if (isDedicatedVotingOnlyNode(state.nodes().getLocalNode())) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE2NDQ0NA=="}, "originalCommit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2OTE5Njk4NA==", "bodyText": "Can we establish that this is the same string as used in VotingOnlyNodePlugin#VOTING_ONLY_NODE_ROLE by extracting the string as a field and adding an assertion in VotingOnlyNodePlugin saying that they match?", "url": "https://github.com/elastic/elasticsearch/pull/61016#discussion_r469196984", "createdAt": "2020-08-12T11:43:08Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/RepositoriesService.java", "diffHunk": "@@ -279,6 +279,10 @@ protected void doRun() {\n         });\n     }\n \n+    static boolean isDedicatedVotingOnlyNode(DiscoveryNode node) {\n+        return node.isMasterNode() && node.isDataNode() == false &&\n+            node.getRoles().stream().anyMatch(role -> role.roleName().equals(\"voting_only\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e3127b613cd9bbdabf08036e1c97c9647c6417e"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "143fc1cf83eda362ad00d7bb5b9700a514414db6", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/143fc1cf83eda362ad00d7bb5b9700a514414db6", "committedDate": "2020-08-12T12:01:10Z", "message": "make everyone happy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0fdd6135a61fcbe010bc5ef63c81a9948ecc110", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0fdd6135a61fcbe010bc5ef63c81a9948ecc110", "committedDate": "2020-08-12T12:06:23Z", "message": "my nemesis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY1ODcyODc0", "url": "https://github.com/elastic/elasticsearch/pull/61016#pullrequestreview-465872874", "createdAt": "2020-08-12T12:35:54Z", "commit": {"oid": "e0fdd6135a61fcbe010bc5ef63c81a9948ecc110"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3249, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}