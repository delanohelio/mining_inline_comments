{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4NjMyODQ0", "number": 58451, "title": "Replace compile configuration usage with api", "bodyText": "This replaces the usage of the deprecated compile configuration with api\nin order to remove the usage of deprecated gradle api\nThis work is related to #57920\nGradle differs between api and implementation and we will revisit the usage of api once we revisit the overall classpath setup. The distinction between api\nand implementation allows differentation of which dependencies a module want to expose of its api.\nBy replacing compile with api we ensure previously exposed dependencies are still exposed as before.\nAs runtime extends compile this PR also fixes some direct usages of the runtime configuration to use runtimeElements in order to keep building things correctly. This has the nice sideeffect of also fixing another gradle deprecation warning about using a deprecated configuration ('runtime')", "createdAt": "2020-06-23T15:03:52Z", "url": "https://github.com/elastic/elasticsearch/pull/58451", "merged": true, "mergeCommit": {"oid": "9526c7a4b340782892a2e4a57238f990c2ca2f42"}, "closed": true, "closedAt": "2020-06-30T07:37:10Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuG2HKAFqTQzNTg3ODI3Ng==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwFunEgFqTQzOTQxNTA3OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1ODc4Mjc2", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-435878276", "createdAt": "2020-06-23T15:05:07Z", "commit": {"oid": "a399d7139fe5cf636d9e9ce018e61086a05c39f2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowNTowN1rOGntsog==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxNTowNTowN1rOGntsog==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDI5NjM1NA==", "bodyText": "required to use the api configuration. Another benefit is that with the java library plugin the compile dependencies will not require jar tasks to be build but rely on classes instead. runtime will still use jars. This could probably make some build job scenarios faster / utilise parallelisation better", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r444296354", "createdAt": "2020-06-23T15:05:07Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchJavaPlugin.java", "diffHunk": "@@ -83,7 +84,7 @@ public void apply(Project project) {\n         // apply global test task failure listener\n         project.getRootProject().getPluginManager().apply(TestFailureReportingPlugin.class);\n \n-        project.getPluginManager().apply(JavaPlugin.class);\n+        project.getPluginManager().apply(JavaLibraryPlugin.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a399d7139fe5cf636d9e9ce018e61086a05c39f2"}, "originalPosition": 13}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "cf18f02651f044ef528d21e30923699109e4651e", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf18f02651f044ef528d21e30923699109e4651e", "committedDate": "2020-06-23T17:54:33Z", "message": "Fix distribution packaging"}, "afterCommit": {"oid": "00cff9e3399c8abe02ae203c883982e0697b0772", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/00cff9e3399c8abe02ae203c883982e0697b0772", "committedDate": "2020-06-24T14:20:45Z", "message": "Make test runtime classpath input for testing convetion\n\n- required as java library will by default not have build jar file\n- jar file is now explicit input of the task and gradle will ensure its properly build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTQ5NjM4", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-437549638", "createdAt": "2020-06-25T14:27:10Z", "commit": {"oid": "306c263245b8f5b6c9982c7f696357857853f4f9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDoyNzoxMFrOGo9SJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDoyNzoxMFrOGo9SJw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYwMDI5NQ==", "bodyText": "with compile tasks only depending on dependent projects compile tasks, the task input here needs to be explicit as it depends on jars that could not have been build before.", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445600295", "createdAt": "2020-06-25T14:27:10Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/precommit/TestingConventionsTasks.java", "diffHunk": "@@ -348,7 +349,8 @@ private boolean isAnnotated(Method method, Class<?> annotation) {\n         return false;\n     }\n \n-    private FileCollection getTestsClassPath() {\n+    @Classpath\n+    public FileCollection getTestsClassPath() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "306c263245b8f5b6c9982c7f696357857853f4f9"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTY2NjAw", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-437566600", "createdAt": "2020-06-25T14:43:46Z", "commit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0Mzo0NlrOGo-CzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0Mzo0NlrOGo-CzA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxMjc0OA==", "bodyText": "We should always fail on resolution. no matter if the configuration actually contains a dependency or not.", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445612748", "createdAt": "2020-06-25T14:43:46Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/EnforceDeprecationFailuresPlugin.java", "diffHunk": "@@ -78,15 +78,13 @@ private void failOnCompileConfigurationResolution(SourceSet sourceSet) {\n             .getByName(sourceSet.getCompileConfigurationName())\n             .getIncoming()\n             .beforeResolve(resolvableDependencies -> {\n-                if (resolvableDependencies.getDependencies().size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTY4NzIx", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-437568721", "createdAt": "2020-06-25T14:45:50Z", "commit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0NTo1MFrOGo-Izg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0NTo1MFrOGo-Izg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNDI4Ng==", "bodyText": "This is actually necessary as the previously used runtime configuration extends compile and is therefore now empty. Using the correct runtimeClasspath configuration here has also the nice effect of removing another deprecated behaviour (of using \"runtime\")", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445614286", "createdAt": "2020-06-25T14:45:50Z", "author": {"login": "breskeby"}, "path": "distribution/build.gradle", "diffHunk": "@@ -287,21 +287,21 @@ configure(subprojects.findAll { ['archives', 'packages'].contains(it.name) }) {\n       copySpec {\n         // delay by using closures, since they have not yet been configured, so no jar task exists yet\n         from { project(':server').jar }\n-        from { project(':server').configurations.runtime }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTcxNzYy", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-437571762", "createdAt": "2020-06-25T14:48:58Z", "commit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0ODo1OFrOGo-SBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxNDo0ODo1OFrOGo-SBQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTYxNjY0NQ==", "bodyText": "we need to use runtimeElements as runtime is a) empty because it extends compile and is therefore empty now and 2) runtime is deprecated for consumption by other projects (see https://docs.gradle.org/6.5/userguide/java_library_plugin.html#sec:java_library_configurations_graph for details)", "url": "https://github.com/elastic/elasticsearch/pull/58451#discussion_r445616645", "createdAt": "2020-06-25T14:48:58Z", "author": {"login": "breskeby"}, "path": "modules/kibana/build.gradle", "diffHunk": "@@ -23,7 +23,7 @@ esplugin {\n }\n \n dependencies {\n-  compile project(path: ':modules:reindex', configuration: 'runtime')\n+  api project(path: ':modules:reindex', configuration: 'runtimeElements')", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b"}, "originalPosition": 5}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b297965bf141004a7bb6384a425b9dd75faea35b", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b297965bf141004a7bb6384a425b9dd75faea35b", "committedDate": "2020-06-25T14:28:38Z", "message": "Further cleanup"}, "afterCommit": {"oid": "b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "committedDate": "2020-06-26T07:13:36Z", "message": "Replace compile configuration usage with api\n\nFix distribution packaging\n\nMake test runtime classpath input for testing convetion\n\n- required as java library will by default not have build jar file\n- jar file is now explicit input of the task and gradle will ensure its properly build\n\nSimplify project depenencies\n\n- remove explicit runtimeElements usage and rely on default configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "769cbc7781737a3f249f6e43f5e0e25c37caab9d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/769cbc7781737a3f249f6e43f5e0e25c37caab9d", "committedDate": "2020-06-26T08:45:54Z", "message": "Replace compile configuration usage with api\n\n- Use java-library instead of plugin to allow api configuration usage\n- Remove explicit references to runtime configurations in dependency declarations\n- Make test runtime classpath input for testing convention\n  - required as java library will by default not have build jar file\n  - jar file is now explicit input of the task and gradle will ensure its properly build"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5e42e7bf0969312ec97ff8831400871ba8a5fd4", "committedDate": "2020-06-26T07:13:36Z", "message": "Replace compile configuration usage with api\n\nFix distribution packaging\n\nMake test runtime classpath input for testing convetion\n\n- required as java library will by default not have build jar file\n- jar file is now explicit input of the task and gradle will ensure its properly build\n\nSimplify project depenencies\n\n- remove explicit runtimeElements usage and rely on default configuration"}, "afterCommit": {"oid": "769cbc7781737a3f249f6e43f5e0e25c37caab9d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/769cbc7781737a3f249f6e43f5e0e25c37caab9d", "committedDate": "2020-06-26T08:45:54Z", "message": "Replace compile configuration usage with api\n\n- Use java-library instead of plugin to allow api configuration usage\n- Remove explicit references to runtime configurations in dependency declarations\n- Make test runtime classpath input for testing convention\n  - required as java library will by default not have build jar file\n  - jar file is now explicit input of the task and gradle will ensure its properly build"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDE1MDc4", "url": "https://github.com/elastic/elasticsearch/pull/58451#pullrequestreview-439415078", "createdAt": "2020-06-29T18:54:53Z", "commit": {"oid": "769cbc7781737a3f249f6e43f5e0e25c37caab9d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 362, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}