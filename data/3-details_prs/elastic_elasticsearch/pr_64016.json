{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA3ODI1ODAw", "number": 64016, "title": "Remove aggregation's postCollect phase", "bodyText": "After #63811 it became clear to me that postCollect is kind of\ndangerous and not all that useful. So this removes it.\nThe trouble with postCollect is that it all happened right after we\nfinished calling collect on the LeafBucketCollectors but before we\nbuilt the aggregation results. But in #63811 we found out that we can't\ncall postCollect on the children of parent or child aggregators\nuntil we know which which aggregation results we're building.\nSo this removes postCollect and moves all of the things we did at\npost-collect phase into buildAggregations or into hooks called in\nthose methods.", "createdAt": "2020-10-21T19:51:31Z", "url": "https://github.com/elastic/elasticsearch/pull/64016", "merged": true, "mergeCommit": {"oid": "3af540b50dd526ee035c20d691d8ec32e8b5068a"}, "closed": true, "closedAt": "2020-10-28T21:33:28Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdUy3lMgH2gAyNTA3ODI1ODAwOjMxYmJmNTM2NTk2MDljYjUxMTUxMjg2Njg4MmExMDlhODUwNjIyOWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXDoeUgH2gAyNTA3ODI1ODAwOmE5YWUzZDczN2M1NGEyNmMzMzZkMDg5OWUyODRlNTJkNjI1MjY1ODA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "31bbf53659609cb511512866882a109a8506229f", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/31bbf53659609cb511512866882a109a8506229f", "committedDate": "2020-10-21T19:51:41Z", "message": "Remove aggregation's postCollect phase\n\nAfter #63811 it became clear to me that `postCollect` is kind of\ndangerous and not all that useful. So this removes it.\n\nThe trouble with `postCollect` is that it all happened right after we\nfinished calling `collect` on the `LeafBucketCollectors` but before we\nbuilt the aggregation results. But in #63811 we found out that we can't\ncall `postCollect` on the children of `parent` or `child` aggregators\nuntil we know which *which* aggregation results we're building.\n\nSo this removes `postCollect` and moves all of the things we did at\npost-collect phase into `buildAggregations` or into hooks called in\nthose methods."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTMzMTg3", "url": "https://github.com/elastic/elasticsearch/pull/64016#pullrequestreview-514133187", "createdAt": "2020-10-21T19:51:55Z", "commit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo1MTo1NVrOHmBIqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMVQxOTo1NTozNVrOHmBbDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNjUzNw==", "bodyText": "I renamed this method to make it a bit more clear what it is for.", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509626537", "createdAt": "2020-10-21T19:51:55Z", "author": {"login": "nik9000"}, "path": "modules/parent-join/src/main/java/org/elasticsearch/join/aggregations/ParentJoinAggregator.java", "diffHunk": "@@ -113,12 +113,7 @@ public void collect(int docId, long owningBucketOrd) throws IOException {\n     }\n \n     @Override\n-    public void postCollection() throws IOException {\n-        // Delaying until beforeBuildingBuckets\n-    }\n-\n-    @Override\n-    protected void beforeBuildingBuckets(long[] ordsToCollect) throws IOException {\n+    protected void prepareSubAggs(long[] bucketOrdsToCollect) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyNzcwMQ==", "bodyText": "I think this is a more clear variable name. I made this change in a dead end when I was working on this change locally but I kind of like it.", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509627701", "createdAt": "2020-10-21T19:52:50Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/Aggregator.java", "diffHunk": "@@ -142,12 +142,12 @@ public BucketComparator bucketComparator(String key, SortOrder order) {\n \n     /**\n      * Build the results of this aggregation.\n-     * @param owningBucketOrds the ordinals of the buckets that we want to\n+     * @param ordsToCollect the ordinals of the buckets that we want to\n      *        collect from this aggregation\n      * @return the results for each ordinal, in the same order as the array\n      *         of ordinals\n      */\n-    public abstract InternalAggregation[] buildAggregations(long[] owningBucketOrds) throws IOException;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYyODkyOA==", "bodyText": "I'm pretty happy about how this turned out! No more finished to check on. It's just all built in now.", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509628928", "createdAt": "2020-10-21T19:53:34Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/BestBucketsDeferringCollector.java", "diffHunk": "@@ -136,20 +135,12 @@ public void preCollection() throws IOException {\n         collector.preCollection();\n     }\n \n-    @Override\n-    public void postCollection() throws IOException {\n-        finishLeaf();\n-        finished = true;\n-    }\n-\n     /**\n      * Replay the wrapped collector, but only on a selection of buckets.\n      */\n     @Override\n     public void prepareSelectedBuckets(long... selectedBuckets) throws IOException {\n-        if (finished == false) {\n-            throw new IllegalStateException(\"Cannot replay yet, collection is not finished: postCollect() has not been called\");\n-        }\n+        finishLeaf();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwOTYzMTI0NA==", "bodyText": "This is kind of an unfortunate loss here. Now we'll end up having post_collection in the build_aggregation debug phase. I'm wondering if I can have aggregations that do \"interesting\" things opt in to make their own timers or something.", "url": "https://github.com/elastic/elasticsearch/pull/64016#discussion_r509631244", "createdAt": "2020-10-21T19:55:35Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/profile/aggregation/ProfilingAggregator.java", "diffHunk": "@@ -124,17 +124,6 @@ public void preCollection() throws IOException {\n         profiler.pollLastElement();\n     }\n \n-    @Override\n-    public void postCollection() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "93db73904a8c4f25404036a149f7a9dd7764ab53", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/93db73904a8c4f25404036a149f7a9dd7764ab53", "committedDate": "2020-10-21T19:56:11Z", "message": "Better words"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d588ddad9003a3061d3a64cf5515f4dc0c2a919b", "committedDate": "2020-10-21T19:42:18Z", "message": "Remove aggregation's postCollect phase\n\nAfter #63811 it became clear to me that `postCollect` is kind of\ndangerous and not all that useful. So this removes it.\n\nThe trouble with `postCollect` is that it all happened right after we\nfinished calling `collect` on the `LeafBucketCollectors` but before we\nbuilt the aggregation results. But in #63811 we found out that we can't\ncall `postCollect` on the children of `parent` or `child` aggregators\nuntil we know which *which* aggregation results we're building.\n\nSo this removes `postCollect` and moves all of the things we did at\npost-collect phase into `buildAggregations` or into hooks called in\nthose methods."}, "afterCommit": {"oid": "93db73904a8c4f25404036a149f7a9dd7764ab53", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/93db73904a8c4f25404036a149f7a9dd7764ab53", "committedDate": "2020-10-21T19:56:11Z", "message": "Better words"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9c80e8d4ab9ebfe055b8d0101b9df74c40dd866", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9c80e8d4ab9ebfe055b8d0101b9df74c40dd866", "committedDate": "2020-10-21T20:35:17Z", "message": "Fixup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0MTg2Mzk2", "url": "https://github.com/elastic/elasticsearch/pull/64016#pullrequestreview-514186396", "createdAt": "2020-10-21T21:07:18Z", "commit": {"oid": "e9c80e8d4ab9ebfe055b8d0101b9df74c40dd866"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1e8647478094f1e7d533cd87c4aa6812172a5395", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1e8647478094f1e7d533cd87c4aa6812172a5395", "committedDate": "2020-10-26T13:56:33Z", "message": "Merge branch 'master' into aggregration_drop_post_collect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b8f630cb9e84ce484e5bebf3a3a80aa24de4361", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b8f630cb9e84ce484e5bebf3a3a80aa24de4361", "committedDate": "2020-10-26T18:42:29Z", "message": "Merge branch 'master' into aggregration_drop_post_collect"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9ea6f51f98c8f8031dce816b2a5debe3df1ad426", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ea6f51f98c8f8031dce816b2a5debe3df1ad426", "committedDate": "2020-10-26T18:57:12Z", "message": "Remove extra"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4NzU0MTkz", "url": "https://github.com/elastic/elasticsearch/pull/64016#pullrequestreview-518754193", "createdAt": "2020-10-28T14:54:58Z", "commit": {"oid": "9ea6f51f98c8f8031dce816b2a5debe3df1ad426"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9ae3d737c54a26c336d0899e284e52d62526580", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9ae3d737c54a26c336d0899e284e52d62526580", "committedDate": "2020-10-28T20:31:25Z", "message": "Merge branch 'master' into aggregration_drop_post_collect"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1081, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}