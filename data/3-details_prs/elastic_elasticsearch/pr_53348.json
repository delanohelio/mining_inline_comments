{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg2MjIyNzYx", "number": 53348, "title": "Move AStatement mutable members into isolated Input/Output objects", "bodyText": "This is the follow up to #53075, isolating the mutable data on the statement nodes as the referenced change did the expression nodes.\nThis is a step toward the long-term goal of making the \"user\" trees nodes immutable. This change isolates the mutable data for statement nodes in the \"user\" tree during the semantic (analysis) phase by moving the mutable data into Input and Output objects. These objects are created locally during the semantic phase to share information required for semantic checking between parent-child nodes.\nNote that for this change, Input and Output are still stored in a mutable way on the statement nodes. This will not be the case once the semantic (analysis) phase and ir generation (write) phase are combined in a future change.\nRelates #49869", "createdAt": "2020-03-10T16:01:52Z", "url": "https://github.com/elastic/elasticsearch/pull/53348", "merged": true, "mergeCommit": {"oid": "1cdb5b3ecfd6c09a1588fdae90e4422f63c15768"}, "closed": true, "closedAt": "2020-03-13T21:51:13Z", "author": {"login": "jdconrad"}, "timelineItems": {"totalCount": 31, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcILU4BAH2gAyMzg2MjIyNzYxOjBiNzllZjZjY2UxZjEwNGRjYWUzNDgwNjRlMGY0ZTZhZTdjMDAyMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNWZdWgH2gAyMzg2MjIyNzYxOmU3Y2JhYWEyYTRjNTNmMjQzYWNlNTQ3NTViZGY2MDRhMmU4ZDRjYzU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0b79ef6cce1f104dcae348064e0f4e6ae7c00202", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b79ef6cce1f104dcae348064e0f4e6ae7c00202", "committedDate": "2020-02-26T18:49:14Z", "message": "remove isNull from AExpression"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73256422481516411cbb40a9b5b4c5adf3251bbd", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/73256422481516411cbb40a9b5b4c5adf3251bbd", "committedDate": "2020-02-26T18:54:14Z", "message": "remove explicit cast optimization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e414972a159844347bc414fb1b124d5335b1f58", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e414972a159844347bc414fb1b124d5335b1f58", "committedDate": "2020-02-26T19:51:51Z", "message": "remove modification of semantic tree for casting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "247080b292a621c41b4c8c360f40378e2bff2ea4", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/247080b292a621c41b4c8c360f40378e2bff2ea4", "committedDate": "2020-02-26T20:07:16Z", "message": "remove ECast node"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63e904f6abf0a97b2269df137f8123d4d1094775", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/63e904f6abf0a97b2269df137f8123d4d1094775", "committedDate": "2020-02-26T20:24:37Z", "message": "Merge branch 'master' into trees11"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e126117911dfadc1f60c01540c225d4f913b9e8", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e126117911dfadc1f60c01540c225d4f913b9e8", "committedDate": "2020-02-26T20:29:20Z", "message": "start of input/output in expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7ae0e7303c495099bec1a1e8e1318c1bd70e9e0", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7ae0e7303c495099bec1a1e8e1318c1bd70e9e0", "committedDate": "2020-02-26T20:32:20Z", "message": "partial change for input and output in expression nodes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a2b443237d5dc86a460ea842c9baa7efb7aacb7", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a2b443237d5dc86a460ea842c9baa7efb7aacb7", "committedDate": "2020-02-26T21:05:07Z", "message": "add input/output objects for expressions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8dfb933a3dd14f1224a2b1929604efd27a2c074b", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/8dfb933a3dd14f1224a2b1929604efd27a2c074b", "committedDate": "2020-02-26T21:05:27Z", "message": "fix shift bug in EBinary"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a811decb652cf458aa603da9d80b6b8e922bdd1", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a811decb652cf458aa603da9d80b6b8e922bdd1", "committedDate": "2020-02-26T22:21:10Z", "message": "add input/output to statements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07180d922b792873c2c782e5173db2fea614a463", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/07180d922b792873c2c782e5173db2fea614a463", "committedDate": "2020-03-02T16:28:13Z", "message": "Merge branch 'master' into trees11"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02f7bb96bc10203e3c55228dfcb4bb711f0f3705", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/02f7bb96bc10203e3c55228dfcb4bb711f0f3705", "committedDate": "2020-03-02T16:28:28Z", "message": "Merge branch 'trees11' into trees12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ab9c2c7a5d151a402326e1e4e71058c5b9cee7cc", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab9c2c7a5d151a402326e1e4e71058c5b9cee7cc", "committedDate": "2020-03-02T20:17:29Z", "message": "Merge branch 'trees12' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "115c8e0dabfd8add0e5615c436543eeb6df8b876", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/115c8e0dabfd8add0e5615c436543eeb6df8b876", "committedDate": "2020-03-02T23:51:02Z", "message": "response to pr comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a96289a5b29bfe1eec5dd5e9a6cd7322b09c8ac", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a96289a5b29bfe1eec5dd5e9a6cd7322b09c8ac", "committedDate": "2020-03-03T00:53:27Z", "message": "Merge branch 'master' into trees11"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d23d394638cbf67bd66b476327eb2eecd2c3da4e", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/d23d394638cbf67bd66b476327eb2eecd2c3da4e", "committedDate": "2020-03-03T00:58:37Z", "message": "Merge branch 'trees11' into trees12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d6018ca222f19d9a96496cd71245bec3f515ab5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d6018ca222f19d9a96496cd71245bec3f515ab5", "committedDate": "2020-03-03T00:58:51Z", "message": "Merge branch 'trees12' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "39a8806da415ba1691046c659f214a7300b34681", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/39a8806da415ba1691046c659f214a7300b34681", "committedDate": "2020-03-03T19:36:31Z", "message": "Merge branch 'master' into trees12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "55364296b579d118849ddac36c8fa1541a05b467", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/55364296b579d118849ddac36c8fa1541a05b467", "committedDate": "2020-03-03T19:38:35Z", "message": "Merge branch 'trees12' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ceb8967dc45e72e37cc22ac9e0dbcbbaacd8cd42", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/ceb8967dc45e72e37cc22ac9e0dbcbbaacd8cd42", "committedDate": "2020-03-09T16:35:00Z", "message": "t Merge branch 'master' into trees12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f65d4a76e9e40d4da236932fed508897efa16c84", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/f65d4a76e9e40d4da236932fed508897efa16c84", "committedDate": "2020-03-09T16:35:19Z", "message": "Merge branch 'trees12' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d9061478d29eb56148cda18350fc039fbceeaf4d", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/d9061478d29eb56148cda18350fc039fbceeaf4d", "committedDate": "2020-03-09T20:52:46Z", "message": "Merge branch 'master' into trees12"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08cf4768313147b745df85e77dff2f1bba8928cb", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/08cf4768313147b745df85e77dff2f1bba8928cb", "committedDate": "2020-03-09T20:53:04Z", "message": "Merge branch 'trees12' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ef8186149cc5f6c8f26609e7f2866b286b223c8", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ef8186149cc5f6c8f26609e7f2866b286b223c8", "committedDate": "2020-03-09T22:02:34Z", "message": "Merge branch 'master' into trees13"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a92f642274a0784be6c0ee44f983c0a97969e3d9", "committedDate": "2020-03-10T15:57:19Z", "message": "Merge branch 'master' into trees13"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTUwNjUy", "url": "https://github.com/elastic/elasticsearch/pull/53348#pullrequestreview-372150652", "createdAt": "2020-03-10T17:05:28Z", "commit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNToyOFrOF0Yd_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNToyOFrOF0Yd_g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3MTE2Ng==", "bodyText": "Can you ref issues in TODO's like this? eg TODO: ..., see #12345.", "url": "https://github.com/elastic/elasticsearch/pull/53348#discussion_r390471166", "createdAt": "2020-03-10T17:05:28Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/AStatement.java", "diffHunk": "@@ -30,66 +30,76 @@\n  */\n public abstract class AStatement extends ANode {\n \n-    /**\n-     * Set to true when the final statement in an {@link SClass} is reached.\n-     * Used to determine whether or not an auto-return is necessary.\n-     */\n-    boolean lastSource = false;\n-\n-    /**\n-     * Set to true when a loop begins.  Used by {@link SBlock} to help determine\n-     * when the final statement of a loop is reached.\n-     */\n-    boolean beginLoop = false;\n-\n-    /**\n-     * Set to true when inside a loop.  Used by {@link SBreak} and {@link SContinue}\n-     * to determine if a break/continue statement is legal.\n-     */\n-    boolean inLoop = false;\n-\n-    /**\n-     * Set to true when on the last statement of a loop.  Used by {@link SContinue}\n-     * to prevent extraneous continue statements.\n-     */\n-    boolean lastLoop = false;\n-\n-    /**\n-     * Set to true if a statement would cause the method to exit.  Used to\n-     * determine whether or not an auto-return is necessary.\n-     */\n-    boolean methodEscape = false;\n-\n-    /**\n-     * Set to true if a statement would cause a loop to exit.  Used to\n-     * prevent unreachable statements.\n-     */\n-    boolean loopEscape = false;\n-\n-    /**\n-     * Set to true if all current paths escape from the current {@link SBlock}.\n-     * Used during the analysis phase to prevent unreachable statements and\n-     * the writing phase to prevent extraneous bytecode gotos from being written.\n-     */\n-    boolean allEscape = false;\n-\n-    /**\n-     * Set to true if any continue statement occurs in a loop.  Used to prevent\n-     * unnecessary infinite loops.\n-     */\n-    boolean anyContinue = false;\n+    public static class Input {\n+\n+        /**\n+         * Set to true when the final statement in an {@link SClass} is reached.\n+         * Used to determine whether or not an auto-return is necessary.\n+         */\n+        boolean lastSource = false;\n+\n+        /**\n+         * Set to true when a loop begins.  Used by {@link SBlock} to help determine\n+         * when the final statement of a loop is reached.\n+         */\n+        boolean beginLoop = false;\n+\n+        /**\n+         * Set to true when inside a loop.  Used by {@link SBreak} and {@link SContinue}\n+         * to determine if a break/continue statement is legal.\n+         */\n+        boolean inLoop = false;\n+\n+        /**\n+         * Set to true when on the last statement of a loop.  Used by {@link SContinue}\n+         * to prevent extraneous continue statements.\n+         */\n+        boolean lastLoop = false;\n+    }\n \n-    /**\n-     * Set to true if any break statement occurs in a loop.  Used to prevent\n-     * extraneous loops.\n-     */\n-    boolean anyBreak = false;\n+    public static class Output {\n+\n+        /**\n+         * Set to true if a statement would cause the method to exit.  Used to\n+         * determine whether or not an auto-return is necessary.\n+         */\n+        boolean methodEscape = false;\n+\n+        /**\n+         * Set to true if a statement would cause a loop to exit.  Used to\n+         * prevent unreachable statements.\n+         */\n+        boolean loopEscape = false;\n+\n+        /**\n+         * Set to true if all current paths escape from the current {@link SBlock}.\n+         * Used during the analysis phase to prevent unreachable statements and\n+         * the writing phase to prevent extraneous bytecode gotos from being written.\n+         */\n+        boolean allEscape = false;\n+\n+        /**\n+         * Set to true if any continue statement occurs in a loop.  Used to prevent\n+         * unnecessary infinite loops.\n+         */\n+        boolean anyContinue = false;\n+\n+        /**\n+         * Set to true if any break statement occurs in a loop.  Used to prevent\n+         * extraneous loops.\n+         */\n+        boolean anyBreak = false;\n+\n+        /**\n+         * Set to the approximate number of statements in a loop block to prevent\n+         * infinite loops during runtime.\n+         */\n+        int statementCount = 0;\n+    }\n \n-    /**\n-     * Set to the approximate number of statements in a loop block to prevent\n-     * infinite loops during runtime.\n-     */\n-    int statementCount = 0;\n+    // TODO: remove placeholders once analysis and write are combined into build", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "originalPosition": 129}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTUyMjYx", "url": "https://github.com/elastic/elasticsearch/pull/53348#pullrequestreview-372152261", "createdAt": "2020-03-10T17:07:23Z", "commit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNzoyM1rOF0YjMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowNzoyM1rOF0YjMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3MjQ5OA==", "bodyText": "Consider creating output close to it's first use, at line 68.", "url": "https://github.com/elastic/elasticsearch/pull/53348#discussion_r390472498", "createdAt": "2020-03-10T17:07:23Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SExpression.java", "diffHunk": "@@ -44,36 +44,40 @@ public SExpression(Location location, AExpression expression) {\n     }\n \n     @Override\n-    void analyze(ScriptRoot scriptRoot, Scope scope) {\n+    Output analyze(ScriptRoot scriptRoot, Scope scope, Input input) {\n+        this.input = input;\n+        output = new Output();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTUyODUz", "url": "https://github.com/elastic/elasticsearch/pull/53348#pullrequestreview-372152853", "createdAt": "2020-03-10T17:08:06Z", "commit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowODowN1rOF0YlDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzowODowN1rOF0YlDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3Mjk3Mw==", "bodyText": "Same as above, consider changing where this creation occurs.  It's about ~50 lines away from actual use.", "url": "https://github.com/elastic/elasticsearch/pull/53348#discussion_r390472973", "createdAt": "2020-03-10T17:08:07Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/node/SFor.java", "diffHunk": "@@ -52,12 +52,15 @@ public SFor(Location location, ANode initializer, AExpression condition, AExpres\n     }\n \n     @Override\n-    void analyze(ScriptRoot scriptRoot, Scope scope) {\n+    Output analyze(ScriptRoot scriptRoot, Scope scope, Input input) {\n+        this.input = input;\n+        output = new Output();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc0NDI4MTQ0", "url": "https://github.com/elastic/elasticsearch/pull/53348#pullrequestreview-374428144", "createdAt": "2020-03-13T16:10:52Z", "commit": {"oid": "a92f642274a0784be6c0ee44f983c0a97969e3d9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b79c54c1eb7fa0531e4d2f95b4bd5bb114870170", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/b79c54c1eb7fa0531e4d2f95b4bd5bb114870170", "committedDate": "2020-03-13T20:11:08Z", "message": "response to pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7cbaaa2a4c53f243ace54755bdf604a2e8d4cc5", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7cbaaa2a4c53f243ace54755bdf604a2e8d4cc5", "committedDate": "2020-03-13T20:32:49Z", "message": "Merge branch 'master' into trees13"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1691, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}