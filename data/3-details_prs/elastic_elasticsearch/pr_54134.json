{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkzMjc5MTk5", "number": 54134, "title": "Define lifecycle tasks for running different types of packaging tests", "bodyText": "We want to try and cut down the pull request feedback times even more. Right now the long pole is our packaging tests, which take nearly an hour, vs most other checks which are 30 minutes or less. Right now our packaging test builds are structured in a monolithic way, in which we serially test each distribution type for a given target operating system. We could significantly reduce feedback times by splitting these jobs up, and running a job per distribution type.\nThis PR modifies our distribution testing plugin to add per-type lifecycle tasks which will allow us to structure our CI jobs in the same way. We now create a docker, archives and packages lifecycle task such that we can run all tests for a give distribution type with a single task, or run the whole enchilada with distructiveDistroTest as we have always done.", "createdAt": "2020-03-24T22:05:22Z", "url": "https://github.com/elastic/elasticsearch/pull/54134", "merged": true, "mergeCommit": {"oid": "fd54cb087413d0247f5b60df381d6229e96227d8"}, "closed": true, "closedAt": "2020-03-25T23:43:29Z", "author": {"login": "mark-vieira"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQ6OtjAH2gAyMzkzMjc5MTk5OmY4YzdiZDI2NDViODdkZTY3NWQwZjJlNTdlMjRjY2Q1ZTMzNzBhNDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRPaXRAH2gAyMzkzMjc5MTk5OjI4MDEzZTZhMDI5OTAwZmUzYjUxZDhkM2Y2NmVhMjQzZTA3YWYxZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f8c7bd2645b87de675d0f2e57e24ccd5e3370a41", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/f8c7bd2645b87de675d0f2e57e24ccd5e3370a41", "committedDate": "2020-03-24T21:59:26Z", "message": "Define lifecycle tasks for running different types of packaging tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzM0MzY4", "url": "https://github.com/elastic/elasticsearch/pull/54134#pullrequestreview-380734368", "createdAt": "2020-03-24T22:12:12Z", "commit": {"oid": "f8c7bd2645b87de675d0f2e57e24ccd5e3370a41"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjoxMjoxMlrOF7FDZw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQyMjoxMzowM1rOF7FE4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MzA5NQ==", "bodyText": "When would this not be present? Shouldn't that be an error?", "url": "https://github.com/elastic/elasticsearch/pull/54134#discussion_r397493095", "createdAt": "2020-03-24T22:12:12Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -108,10 +109,18 @@ public void apply(Project project) {\n         TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n         TaskProvider<Copy> copyPluginsTask = configureCopyPluginsTask(project, pluginsDir);\n \n+        // Create lifecycle tasks so we can run all tests of a given type\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = new HashMap<>();\n+        lifecyleTasks.put(Type.DOCKER, project.getTasks().register(\"destructiveDistroTest#docker\"));\n+        lifecyleTasks.put(Type.ARCHIVE, project.getTasks().register(\"destructiveDistroTest#archives\"));\n+        lifecyleTasks.put(Type.DEB, project.getTasks().register(\"destructiveDistroTest#packages\"));\n+        lifecyleTasks.put(Type.RPM, lifecyleTasks.get(Type.DEB));\n+\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n         for (ElasticsearchDistribution distribution : distributions) {\n             TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport);\n             destructiveDistroTest.configure(t -> t.dependsOn(destructiveTask));\n+            Optional.ofNullable(lifecyleTasks.get(distribution.getType())).ifPresent(p -> p.configure(t -> t.dependsOn(destructiveTask)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8c7bd2645b87de675d0f2e57e24ccd5e3370a41"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzQ5MzQ3NA==", "bodyText": "We've used . as the separator in the rest of the tasks in this plugin. Can we reuse that here? It is easier when typing out the task name to not need to add quotes as # requires.", "url": "https://github.com/elastic/elasticsearch/pull/54134#discussion_r397493474", "createdAt": "2020-03-24T22:13:03Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -108,10 +109,18 @@ public void apply(Project project) {\n         TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n         TaskProvider<Copy> copyPluginsTask = configureCopyPluginsTask(project, pluginsDir);\n \n+        // Create lifecycle tasks so we can run all tests of a given type\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = new HashMap<>();\n+        lifecyleTasks.put(Type.DOCKER, project.getTasks().register(\"destructiveDistroTest#docker\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f8c7bd2645b87de675d0f2e57e24ccd5e3370a41"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328837a41044073756dff5bab5ef562899fe8d1e", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/328837a41044073756dff5bab5ef562899fe8d1e", "committedDate": "2020-03-24T22:17:54Z", "message": "Address review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f64c4b590b638050db0823e156f5beb5376d737", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f64c4b590b638050db0823e156f5beb5376d737", "committedDate": "2020-03-24T22:24:11Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgwNzQyMDE4", "url": "https://github.com/elastic/elasticsearch/pull/54134#pullrequestreview-380742018", "createdAt": "2020-03-24T22:28:08Z", "commit": {"oid": "328837a41044073756dff5bab5ef562899fe8d1e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMDcyNjQ2", "url": "https://github.com/elastic/elasticsearch/pull/54134#pullrequestreview-381072646", "createdAt": "2020-03-25T11:45:05Z", "commit": {"oid": "6f64c4b590b638050db0823e156f5beb5376d737"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1735f52e8e360b97549a73e264c42c9f656623f", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1735f52e8e360b97549a73e264c42c9f656623f", "committedDate": "2020-03-25T22:26:00Z", "message": "Add lifecycle tasks for Vagrant distro tests as well"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28013e6a029900fe3b51d8d3f66ea243e07af1d5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/28013e6a029900fe3b51d8d3f66ea243e07af1d5", "committedDate": "2020-03-25T22:40:10Z", "message": "Merge branch 'master' into distro-test-lifecycle-tasks"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1721, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}