{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4ODYxMjcz", "number": 59530, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowODo1M1rOEOQCGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoyMzoxNFrOEOR-4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzc4MjAyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzowODo1M1rOGxS5lg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzozNzoyMlrOGxUBig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MzA2Mg==", "bodyText": "Does this stop really high privilege users from using inference?  For example, the actions permitted by manage_ml are a subset of those permitted by manage (which means manage everything except security), but literally checking for manage_ml might not return true for a user who has manage.  I may be wrong as I haven't tested it, but it seems likely that the security code will resolve high level cluster privilege names to sets of actions they allow, but not to other high level cluster privilege names.\nYou could check for just GetTrainedModelsAction.NAME here instead to solve that potential problem and also make the later code simpler as you'll only be testing for one privilege:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n          \n          \n            \n                                privRequest.clusterPrivileges(GetTrainedModelsAction.NAME);", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454343062", "createdAt": "2020-07-14T13:08:53Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0cdf0af596975ac32b45490f8ddeb6876467530"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM2MTQ4Mg==", "bodyText": "Yes that works", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454361482", "createdAt": "2020-07-14T13:37:22Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0MzA2Mg=="}, "originalCommit": {"oid": "d0cdf0af596975ac32b45490f8ddeb6876467530"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzc5NTI0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxMjoxOVrOGxTB4Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxMjoxOVrOGxTB4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NTE4NQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                                \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n          \n          \n            \n                                                    \"to use ml inference\"));\n          \n          \n            \n                                                \"user [\" + username + \"] does not have the privilege to get trained models \" +\n          \n          \n            \n                                                    \"so cannot use ml inference\"));", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454345185", "createdAt": "2020-07-14T13:12:19Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});\n+                    privRequest.applicationPrivileges(new RoleDescriptor.ApplicationResourcePrivileges[]{});\n+\n+                    ActionListener<HasPrivilegesResponse> privResponseListener = ActionListener.wrap(\n+                        r -> {\n+                            if (hasMlPrivilege(r)) {\n+                                modelLoadAction.accept(client, listener);\n+                            } else {\n+                                listener.onFailure(Exceptions.authorizationError(\n+                                    \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n+                                        \"to use ml inference\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0cdf0af596975ac32b45490f8ddeb6876467530"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMzgwNzI0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxNToxNFrOGxTJMg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxMzoxNToxNFrOGxTJMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM0NzA1OA==", "bodyText": "This method won't be needed if just checking one privilege.", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454347058", "createdAt": "2020-07-14T13:15:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,10 +210,47 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(\"manage_ml\", \"monitor_ml\");\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});\n+                    privRequest.applicationPrivileges(new RoleDescriptor.ApplicationResourcePrivileges[]{});\n+\n+                    ActionListener<HasPrivilegesResponse> privResponseListener = ActionListener.wrap(\n+                        r -> {\n+                            if (hasMlPrivilege(r)) {\n+                                modelLoadAction.accept(client, listener);\n+                            } else {\n+                                listener.onFailure(Exceptions.authorizationError(\n+                                    \"user [\" + username + \"] is not an ml user and does not have sufficient privilege \" +\n+                                        \"to use ml inference\"));\n+                            }\n+                        },\n+                        listener::onFailure);\n+\n+                    client.execute(HasPrivilegesAction.INSTANCE, privRequest, privResponseListener);\n+                });\n+            } else {\n+                modelLoadAction.accept(client, listener);\n+            }\n         });\n         return new InferencePipelineAggregationBuilder(name, bucketPathMap, loadedModel::get, modelId, inferenceConfig, licenseState);\n     }\n \n+    static boolean hasMlPrivilege(HasPrivilegesResponse privilegesResponse) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d0cdf0af596975ac32b45490f8ddeb6876467530"}, "originalPosition": 88}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDA4NDk3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoxOTozNVrOGxV2wA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoxOTozNVrOGxV2wA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MTQ4OA==", "bodyText": "nit: space after equals", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454391488", "createdAt": "2020-07-14T14:19:35Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,6 +211,37 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 63}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDA4NzMzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoyMDowNFrOGxV4MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoyMDowNFrOGxV4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MTg1Ng==", "bodyText": "Ah, nice! That's what to use when in need to return more than a single thing. I'll use that onwards!", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454391856", "createdAt": "2020-07-14T14:20:04Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -186,8 +197,9 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n         if (model != null) {\n             return this;\n         }\n+\n         SetOnce<LocalModel> loadedModel = new SetOnce<>();\n-        context.registerAsyncAction((client, listener) -> {\n+        BiConsumer<Client, ActionListener<?>> modelLoadAction = (client, listener) ->", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDA5MTgxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoyMTowNFrOGxV69w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjowMzowNFrOGxag4g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjU2Nw==", "bodyText": "Do we need to set index and application privileges even though they're empty?", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454392567", "createdAt": "2020-07-14T14:21:04Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,6 +211,37 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(GetTrainedModelsAction.NAME);\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2NzgxMA==", "bodyText": "Yes because of this validation\nhttps://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/user/HasPrivilegesRequest.java#L46", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454467810", "createdAt": "2020-07-14T16:03:04Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/aggs/InferencePipelineAggregationBuilder.java", "diffHunk": "@@ -199,6 +211,37 @@ public InferencePipelineAggregationBuilder rewrite(QueryRewriteContext context)\n                     delegate.onFailure(LicenseUtils.newComplianceException(XPackField.MACHINE_LEARNING));\n                 }\n             }));\n+\n+\n+        context.registerAsyncAction((client, listener) -> {\n+            if (licenseState.isSecurityEnabled()) {\n+                // check the user has ml privileges\n+                SecurityContext securityContext =new SecurityContext(Settings.EMPTY, client.threadPool().getThreadContext());\n+                useSecondaryAuthIfAvailable(securityContext, () -> {\n+                    final String username = securityContext.getUser().principal();\n+                    final HasPrivilegesRequest privRequest = new HasPrivilegesRequest();\n+                    privRequest.username(username);\n+                    privRequest.clusterPrivileges(GetTrainedModelsAction.NAME);\n+                    privRequest.indexPrivileges(new RoleDescriptor.IndicesPrivileges[]{});", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5MjU2Nw=="}, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzNDEwMTQ1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/ml-with-security/src/test/java/org/elasticsearch/smoketest/MlWithSecurityInsufficientRoleIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNDoyMzoxNFrOGxWBGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjowMzoyMlrOGxahoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDEzNw==", "bodyText": "Isn't this the same as doing if (mapOfMaps.contains(key)) return true; ?", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454394137", "createdAt": "2020-07-14T14:23:14Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/ml-with-security/src/test/java/org/elasticsearch/smoketest/MlWithSecurityInsufficientRoleIT.java", "diffHunk": "@@ -60,5 +80,27 @@ public void test() throws IOException {\n     protected String[] getCredentials() {\n         return new String[]{\"no_ml\", \"x-pack-test-password\"};\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    static boolean containsKey(String key, Map<String, Object> mapOfMaps) {\n+        Set<String> keys = mapOfMaps.keySet();\n+        for (String keyEntry : keys) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ2ODAwMQ==", "bodyText": "Ha yeah that might be a simpler way of doing it", "url": "https://github.com/elastic/elasticsearch/pull/59530#discussion_r454468001", "createdAt": "2020-07-14T16:03:22Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/qa/ml-with-security/src/test/java/org/elasticsearch/smoketest/MlWithSecurityInsufficientRoleIT.java", "diffHunk": "@@ -60,5 +80,27 @@ public void test() throws IOException {\n     protected String[] getCredentials() {\n         return new String[]{\"no_ml\", \"x-pack-test-password\"};\n     }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    static boolean containsKey(String key, Map<String, Object> mapOfMaps) {\n+        Set<String> keys = mapOfMaps.keySet();\n+        for (String keyEntry : keys) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDM5NDEzNw=="}, "originalCommit": {"oid": "567ee1b4fc2f4aa96d07dcddc01f634591f10d96"}, "originalPosition": 63}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2402, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}