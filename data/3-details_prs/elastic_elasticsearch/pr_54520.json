{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDQ3MjM0", "number": 54520, "title": "[TEST] rename AsyncSearchActionTests to IT and move it out of unit tests", "bodyText": "AsyncSearchActionTests currently fails quite often. That is since the introduction of RestSubmitAsyncSearchActionTests which indirectly manipulates the channels being tracked in RestCancellableNodeClient. There are channels left in the map after RestSubmitAsyncSearchActionTests  is run, and later AsyncSearchActionTests checks that there are no channels in the map which makes each test method fail. This is particularily hard to reproduce as the order in which tests are run appears to be platform dependent.\nThe test cluster assertion that there are no channels in the map only makes sense in the context of internal cluster tests, while there may be collisions with unit tests that register http channels as part of their testing.\nThis can be solved by renaming AsyncSearchActionTests to AsyncSearchActionIT. This way it won't be run as part of unit tests but rather within another JVM where the number of channels is 0 and such assumption holds, because there are no expected manual manipulation of the channels.\nRelates to #54180", "createdAt": "2020-03-31T16:24:56Z", "url": "https://github.com/elastic/elasticsearch/pull/54520", "merged": true, "mergeCommit": {"oid": "02772ca55b83563d8015c3df42d62b5f06a53e1f"}, "closed": true, "closedAt": "2020-04-01T09:21:43Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcTFl1xAH2gAyMzk2NDQ3MjM0OjAyZmFmNDJhNGU2ZjAzYWUwYjAyM2JhYTNiYWQ4NTljMTU3MWU1MDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcTT6lpAFqTM4NTM5Mzc3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "02faf42a4e6f03ae0b023baa3bad859c1571e508", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/02faf42a4e6f03ae0b023baa3bad859c1571e508", "committedDate": "2020-03-31T16:21:30Z", "message": "[TEST] rename AsyncSearchActionTests to IT and move it out of unit tests\n\n`AsyncSearchActionTests` currently fails quite often. That is since the introduction of `RestSubmitAsyncSearchActionTests` which indirectly manipulates the channels being tracked in `RestCancellableNodeClient`. There are channels left in the map after `RestSubmitAsyncSearchActionTests`  is run, and later `AsyncSearchActionTests` checks that there are no channels in the map which makes each test method fail. This is particularily hard to reproduce as the order in which tests are run appears to be platform dependent.\n\nThe test cluster assertion that there are no channels in the map only makes sense in the context of internal cluster tests, while there may be collisions with unit tests that register http channels as part of their testing.\n\nThis can be solved by renaming `AsyncSearchActionTests` to `AsyncSearchActionIT`. This way it won't be run as part of unit tests but rather within another JVM where the number of channels is `0` and such assumption holds, because there are no expected manual manipulation of the channels.\n\nRelates to #54180"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg0OTAzMDYy", "url": "https://github.com/elastic/elasticsearch/pull/54520#pullrequestreview-384903062", "createdAt": "2020-03-31T16:26:55Z", "commit": {"oid": "02faf42a4e6f03ae0b023baa3bad859c1571e508"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoyNjo1NVrOF-eFAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQxNjoyNjo1NVrOF-eFAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMTA0ODgzMg==", "bodyText": "it would be cleaner to also clean up the channels being tracked due to the dispatchRequest calls from this test. I gave it a try though and it was not trivial, and the same should be done in RestCancellableNodeClientTests where we actually assume that we may have channels in the map already, hence we only check the delta since the test has started. I wonder if it's worth looking into cleaning the channels up after both tests have executed, or not.", "url": "https://github.com/elastic/elasticsearch/pull/54520#discussion_r401048832", "createdAt": "2020-03-31T16:26:55Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/RestSubmitAsyncSearchActionTests.java", "diffHunk": "@@ -72,8 +72,8 @@ public void testParameters() throws IOException {\n         boolean requestCache = randomBoolean();\n         doTestParameter(\"request_cache\", Boolean.toString(requestCache), requestCache,\n                 r -> r.getSearchRequest().requestCache());\n-        Integer batchReduceSize = randomIntBetween(2, 50);\n-        doTestParameter(\"batched_reduce_size\", Integer.toString(batchReduceSize), batchReduceSize,\n+        int batchedReduceSize = randomIntBetween(2, 50);\n+        doTestParameter(\"batched_reduce_size\", Integer.toString(batchedReduceSize), batchedReduceSize,\n                 r -> r.getSearchRequest().getBatchedReduceSize());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "02faf42a4e6f03ae0b023baa3bad859c1571e508"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a073fc5eb91ba268d5cb9893b41b93960f908516", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/a073fc5eb91ba268d5cb9893b41b93960f908516", "committedDate": "2020-04-01T07:56:52Z", "message": "Merge branch 'master' into test/async_search_action_tests_channels"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg1MzkzNzcw", "url": "https://github.com/elastic/elasticsearch/pull/54520#pullrequestreview-385393770", "createdAt": "2020-04-01T09:02:50Z", "commit": {"oid": "a073fc5eb91ba268d5cb9893b41b93960f908516"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1398, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}