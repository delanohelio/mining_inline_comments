{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzODY1Mzg5", "number": 62225, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOEiMCRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOEiMCRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA0Mjg0MjI4OnYy", "diffSide": "RIGHT", "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOHP7Iig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOHP7Iig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1OTUzMA==", "bodyText": "This is a somewhat confusing comment IMO :) It nicely explains the diff here actually but doesn't really explain why it's ok to count this kind of request as a PUT.\nWhat does this kind of request without relevant query portion do? Can we add whatever it does as a comment to justify this logic?", "url": "https://github.com/elastic/elasticsearch/pull/62225#discussion_r486459530", "createdAt": "2020-09-10T16:02:57Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -117,18 +117,18 @@ public AzureBlobStore(RepositoryMetadata metadata, AzureStorageService service,\n         };\n         this.uploadMetricsCollector = (httpURLConnection -> {\n            assert httpURLConnection.getRequestMethod().equals(\"PUT\");\n-            String queryParams = httpURLConnection.getURL().getQuery();\n-            if (queryParams == null) {\n-                stats.putOperations.incrementAndGet();\n-                return;\n-            }\n+            String queryParams = httpURLConnection.getURL().getQuery() == null ? \"\" : httpURLConnection.getURL().getQuery();\n \n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block\n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list\n             if (queryParams.contains(\"comp=block\") && queryParams.contains(\"blockid=\")) {\n                 stats.putBlockOperations.incrementAndGet();\n             } else if (queryParams.contains(\"comp=blocklist\")) {\n                 stats.putBlockListOperations.incrementAndGet();\n+            } else {\n+                // if a sas token is used, it's possible that the query params contain\n+                // additional parameters unrelated to the upload type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6"}, "originalPosition": 19}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1619, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}