{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIxMDI2OTIw", "number": 57017, "title": "Include vendored code notices in distribution notice files", "bodyText": "The PR updates our distribution NOTICE file generation such that notices from vendored code are included in the final NOTICE file. Vendored code notices are annotated with @notice in the header. We also no long accept generic Apache 2.0 license headers in our codebase. Anything but the Elasticsearch attributing header will trigger an error requiring the developer to add the @notice annotation or use the correct header when appropriate.\nAn example of the new NOTICE file:\nNOTICE.txt\ncc @tomcallahan\nCloses #45161", "createdAt": "2020-05-20T21:23:09Z", "url": "https://github.com/elastic/elasticsearch/pull/57017", "merged": true, "mergeCommit": {"oid": "627ef279fd29f8af63303bcaafd641aef0ffc586"}, "closed": true, "closedAt": "2020-06-01T22:23:42Z", "author": {"login": "mark-vieira"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcjPzy_gH2gAyNDIxMDI2OTIwOjczN2I3M2RkYTI3OTI4ODJjNjZiNmRiOTE2NTRiZTU1YzViZTY5Yjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnFASVAH2gAyNDIxMDI2OTIwOjdjNmE3MmY2NGVhNTU3YTQ5MWRhMmExOTU5NTg4OGMyNGExMTI1MjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "737b73dda2792882c66b6db91654be55c5be69b9", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/737b73dda2792882c66b6db91654be55c5be69b9", "committedDate": "2020-05-20T21:18:35Z", "message": "Included vendored code notices in distribution notice files"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cca9badb6e778d543f364c54855892f555e22eb", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/2cca9badb6e778d543f364c54855892f555e22eb", "committedDate": "2020-05-20T21:28:58Z", "message": "Handle projects with no license file directory"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE1OTczMTIy", "url": "https://github.com/elastic/elasticsearch/pull/57017#pullrequestreview-415973122", "createdAt": "2020-05-21T08:36:20Z", "commit": {"oid": "2cca9badb6e778d543f364c54855892f555e22eb"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODozNjoyMFrOGYq0hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQwODozNjoyMFrOGYq0hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODUyMDU4MA==", "bodyText": "No big deal, but might this be a little easier to grok as follows?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String name = file.name.substring(0, file.name.length() - '-NOTICE.txt'.length())\n          \n          \n            \n                        String name = file.name.replaceFirst(\"-NOTICE\\.txt$\", \"\")", "url": "https://github.com/elastic/elasticsearch/pull/57017#discussion_r428520580", "createdAt": "2020-05-21T08:36:20Z", "author": {"login": "pugnascotia"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/NoticeTask.groovy", "diffHunk": "@@ -50,46 +55,122 @@ public class NoticeTask extends DefaultTask {\n     }\n \n     /** Add notices from the specified directory. */\n-    public void licensesDir(File licensesDir) {\n+    void licensesDir(File licensesDir) {\n         licensesDirs.add(licensesDir)\n     }\n \n+    void source(Object source) {\n+        if (sources == null) {\n+            sources = project.fileTree(source)\n+        } else {\n+            sources += project.fileTree(source)\n+        }\n+    }\n+\n+    void source(SourceDirectorySet source) {\n+        if (sources == null) {\n+            sources = source\n+        } else {\n+            sources += source\n+        }\n+    }\n+\n     @TaskAction\n-    public void generateNotice() {\n+    void generateNotice() {\n         StringBuilder output = new StringBuilder()\n         output.append(inputFile.getText('UTF-8'))\n         output.append('\\n\\n')\n         // This is a map rather than a set so that the sort order is the 3rd\n         // party component names, unaffected by the full path to the various files\n         Map<String, File> seen = new TreeMap<>()\n-        for (File licensesDir : licensesDirs) {\n-            licensesDir.eachFileMatch({ it ==~ /.*-NOTICE\\.txt/ }) { File file ->\n-                String name = file.name.substring(0, file.name.length() - '-NOTICE.txt'.length())\n-                if (seen.containsKey(name)) {\n-                    File prevFile = seen.get(name)\n-                    if (prevFile.text != file.text) {\n-                        throw new RuntimeException(\"Two different notices exist for dependency '\" +\n-                                name + \"': \" + prevFile + \" and \" + file)\n-                    }\n-                } else {\n-                    seen.put(name, file)\n+        noticeFiles.each { File file ->\n+            String name = file.name.substring(0, file.name.length() - '-NOTICE.txt'.length())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2cca9badb6e778d543f364c54855892f555e22eb"}, "originalPosition": 92}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6593346749d79c6697d7dd3f46fcbd279d330ad", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6593346749d79c6697d7dd3f46fcbd279d330ad", "committedDate": "2020-05-21T13:49:41Z", "message": "Apply review suggestion\n\nCo-authored-by: Rory Hunter <pugnascotia@users.noreply.github.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6", "committedDate": "2020-05-21T13:58:56Z", "message": "Use regex literal"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjY1OTE1", "url": "https://github.com/elastic/elasticsearch/pull/57017#pullrequestreview-416265915", "createdAt": "2020-05-21T15:42:07Z", "commit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTo0MjowOFrOGY4A1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNTo0MjowOFrOGY4A1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODczNjcyNA==", "bodyText": "I think you have a rogue quote in there.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        String name = file.name.replaceFirst(/-NOTICE\\.txt$\"/, \"\")\n          \n          \n            \n                        String name = file.name.replaceFirst(/-NOTICE\\.txt$/, \"\")", "url": "https://github.com/elastic/elasticsearch/pull/57017#discussion_r428736724", "createdAt": "2020-05-21T15:42:08Z", "author": {"login": "pugnascotia"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/NoticeTask.groovy", "diffHunk": "@@ -84,7 +84,7 @@ class NoticeTask extends DefaultTask {\n         // party component names, unaffected by the full path to the various files\n         Map<String, File> seen = new TreeMap<>()\n         noticeFiles.each { File file ->\n-            String name = file.name.replaceFirst(\"-NOTICE\\.txt$\", \"\")\n+            String name = file.name.replaceFirst(/-NOTICE\\.txt$\"/, \"\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MjkwNzQ1", "url": "https://github.com/elastic/elasticsearch/pull/57017#pullrequestreview-416290745", "createdAt": "2020-05-21T16:13:19Z", "commit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjoxMzoxOVrOGY5WuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjoxMzoxOVrOGY5WuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc1ODcxMg==", "bodyText": "One challenge here is that we have made modifications to these files, and my understanding is that we're suppose to indicate that. That is, this is not a direct copy of EvictingQueue from Guava, but rather the starting point, and then we made some modifications in place which are of course not copyright the Guava authors.", "url": "https://github.com/elastic/elasticsearch/pull/57017#discussion_r428758712", "createdAt": "2020-05-21T16:13:19Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/common/collect/EvictingQueue.java", "diffHunk": "@@ -1,20 +1,17 @@\n-/*\n- * Licensed to Elasticsearch under one or more contributor\n- * license agreements. See the NOTICE file distributed with\n- * this work for additional information regarding copyright\n- * ownership. Elasticsearch licenses this file to you under\n- * the Apache License, Version 2.0 (the \"License\"); you may\n- * not use this file except in compliance with the License.\n+/* @notice\n+ * Copyright (C) 2012 The Guava Authors", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE2MzAyMjUw", "url": "https://github.com/elastic/elasticsearch/pull/57017#pullrequestreview-416302250", "createdAt": "2020-05-21T16:28:20Z", "commit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjoyODoyMVrOGY54sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yMVQxNjozNDoxMVrOGY6F6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc2NzQxMA==", "bodyText": "nit: this comment block should be before the package statement, for consistency with the rest of our files", "url": "https://github.com/elastic/elasticsearch/pull/57017#discussion_r428767410", "createdAt": "2020-05-21T16:28:21Z", "author": {"login": "rjernst"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authc/support/BCrypt.java", "diffHunk": "@@ -1,18 +1,20 @@\n package org.elasticsearch.xpack.core.security.authc.support;\n \n-// Copyright (c) 2006 Damien Miller <djm@mindrot.org>\n-//\n-// Permission to use, copy, modify, and distribute this software for any\n-// purpose with or without fee is hereby granted, provided that the above\n-// copyright notice and this permission notice appear in all copies.\n-//\n-// THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES\n-// WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF\n-// MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR\n-// ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES\n-// WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN\n-// ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF\n-// OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.\n+/* @notice", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyODc3MDc5NQ==", "bodyText": "Shouldn't this always be not-null since we set it above?", "url": "https://github.com/elastic/elasticsearch/pull/57017#discussion_r428770795", "createdAt": "2020-05-21T16:34:11Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/NoticeTask.groovy", "diffHunk": "@@ -50,46 +55,122 @@ public class NoticeTask extends DefaultTask {\n     }\n \n     /** Add notices from the specified directory. */\n-    public void licensesDir(File licensesDir) {\n+    void licensesDir(File licensesDir) {\n         licensesDirs.add(licensesDir)\n     }\n \n+    void source(Object source) {\n+        if (sources == null) {\n+            sources = project.fileTree(source)\n+        } else {\n+            sources += project.fileTree(source)\n+        }\n+    }\n+\n+    void source(SourceDirectorySet source) {\n+        if (sources == null) {\n+            sources = source\n+        } else {\n+            sources += source\n+        }\n+    }\n+\n     @TaskAction\n-    public void generateNotice() {\n+    void generateNotice() {\n         StringBuilder output = new StringBuilder()\n         output.append(inputFile.getText('UTF-8'))\n         output.append('\\n\\n')\n         // This is a map rather than a set so that the sort order is the 3rd\n         // party component names, unaffected by the full path to the various files\n         Map<String, File> seen = new TreeMap<>()\n-        for (File licensesDir : licensesDirs) {\n-            licensesDir.eachFileMatch({ it ==~ /.*-NOTICE\\.txt/ }) { File file ->\n-                String name = file.name.substring(0, file.name.length() - '-NOTICE.txt'.length())\n-                if (seen.containsKey(name)) {\n-                    File prevFile = seen.get(name)\n-                    if (prevFile.text != file.text) {\n-                        throw new RuntimeException(\"Two different notices exist for dependency '\" +\n-                                name + \"': \" + prevFile + \" and \" + file)\n-                    }\n-                } else {\n-                    seen.put(name, file)\n+        noticeFiles.each { File file ->\n+            String name = file.name.replaceFirst(/-NOTICE\\.txt$\"/, \"\")\n+            if (seen.containsKey(name)) {\n+                File prevFile = seen.get(name)\n+                if (prevFile.text != file.text) {\n+                    throw new RuntimeException(\"Two different notices exist for dependency '\" +\n+                            name + \"': \" + prevFile + \" and \" + file)\n                 }\n+            } else {\n+                seen.put(name, file)\n             }\n         }\n+\n+        // Add all LICENSE and NOTICE files in licenses directory\n         for (Map.Entry<String, File> entry : seen.entrySet()) {\n             String name = entry.getKey()\n             File file = entry.getValue()\n             appendFile(file, name, 'NOTICE', output)\n             appendFile(new File(file.parentFile, \"${name}-LICENSE.txt\"), name, 'LICENSE', output)\n         }\n+\n+        // Find any source files with \"@notice\" annotated license header\n+        for (File sourceFile : sources.files) {\n+            boolean isPackageInfo = sourceFile.name == 'package-info.java'\n+            boolean foundNotice = false\n+            boolean inNotice = false\n+            StringBuilder header = new StringBuilder()\n+            String packageDeclaration\n+\n+            for (String line : sourceFile.readLines()) {\n+                if (isPackageInfo && packageDeclaration == null && line.startsWith('package')) {\n+                    packageDeclaration = line\n+                }\n+\n+                if (foundNotice == false) {\n+                    foundNotice = line.contains('@notice')\n+                    inNotice = true\n+                } else {\n+                    if (line.contains('*/')) {\n+                        inNotice = false\n+\n+                        if (!isPackageInfo) {\n+                            break\n+                        }\n+                    } else if (inNotice) {\n+                        header.append(line.stripMargin('*'))\n+                        header.append('\\n')\n+                    }\n+                }\n+            }\n+\n+            if (foundNotice) {\n+                appendText(header.toString(), isPackageInfo ? packageDeclaration : sourceFile.name, '', output)\n+            }\n+        }\n         outputFile.setText(output.toString(), 'UTF-8')\n     }\n \n+    @InputFiles\n+    @Optional\n+    FileCollection getNoticeFiles() {\n+        FileTree tree\n+        licensesDirs.each { dir ->\n+            if (tree == null) {\n+                tree = project.fileTree(dir)\n+            } else {\n+                tree += project.fileTree(dir)\n+            }\n+        }\n+\n+        return tree?.matching { include '**/*-NOTICE.txt' }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6a73cf2a8eb1c5511722037c1b76b7c5f4f8cc6"}, "originalPosition": 161}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "95ba23b710bd38db552a587b5f1ddf965ecf254b", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/95ba23b710bd38db552a587b5f1ddf965ecf254b", "committedDate": "2020-05-21T19:40:10Z", "message": "Move license header"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2e3f2c679d202faa0f3c3b0969622367cd80a433", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e3f2c679d202faa0f3c3b0969622367cd80a433", "committedDate": "2020-05-21T19:40:20Z", "message": "Fix regex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebbe657b0e466551943dc78af331bcb60a2f3e33", "author": {"user": {"login": "mark-vieira", "name": "Mark Vieira"}}, "url": "https://github.com/elastic/elasticsearch/commit/ebbe657b0e466551943dc78af331bcb60a2f3e33", "committedDate": "2020-06-01T18:37:18Z", "message": "Add modifications copyright notice on vendored code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c6a72f64ea557a491da2a19595888c24a112524", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c6a72f64ea557a491da2a19595888c24a112524", "committedDate": "2020-06-01T18:58:58Z", "message": "Merge branch 'master' into vendored-code-notices"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4742, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}