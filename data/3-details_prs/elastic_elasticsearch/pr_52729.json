{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc5MjE2MjU1", "number": 52729, "title": "Soft immutability for VSConfig", "bodyText": "This PR makes the mutator methods on VSConfig private, which is a good first step for immutability.  In the course of this, I added a few new constructor cases to support setting fields at constructor time and the particulars of how Parent and Child aggregations interact with VSConfig.\nAlso include other small clean ups in VSConfig.", "createdAt": "2020-02-24T20:29:09Z", "url": "https://github.com/elastic/elasticsearch/pull/52729", "merged": true, "mergeCommit": {"oid": "678164ba464f1f1ad887c1c7642362f5f51d086f"}, "closed": true, "closedAt": "2020-02-26T14:32:54Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF8qE7AH2gAyMzc5MjE2MjU1OjYwZDJiZTc0ZGY0MTcyZWQ4MTgyZTE5MzM3MzIwOTE0N2RhOGVlNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHzJiuAH2gAyMzc5MjE2MjU1OmJjNzkyOTYxZDJiMzQxMzFhZTE3NWI2ZTliYmY1M2JmZGQwN2QyNDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "60d2be74df4172ed8182e193373209147da8ee48", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/60d2be74df4172ed8182e193373209147da8ee48", "committedDate": "2020-02-19T20:35:58Z", "message": "Narrow scope and requirements"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04475e26efa0a3c58c8dd2415ff9584992c8fc3e", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/04475e26efa0a3c58c8dd2415ff9584992c8fc3e", "committedDate": "2020-02-20T15:46:43Z", "message": "indentation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3aadb4b84e6cfb463fffcc90466911ea653283c2", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3aadb4b84e6cfb463fffcc90466911ea653283c2", "committedDate": "2020-02-20T16:22:35Z", "message": "fix typo"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "052a2d0c59bd2a8dd3331429088b74581e8c19fa", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/052a2d0c59bd2a8dd3331429088b74581e8c19fa", "committedDate": "2020-02-20T21:53:18Z", "message": "Don't mutate ValuesSourceConfig in Parent & Child aggregations"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1a947edfb6e38b81c18e1af01ccb9787634f7cbf", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a947edfb6e38b81c18e1af01ccb9787634f7cbf", "committedDate": "2020-02-20T22:35:21Z", "message": "remove setters for several fields on VSConfig"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1cf006f96fc1db9f6eff1ee95a9c0fc272c7c312", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1cf006f96fc1db9f6eff1ee95a9c0fc272c7c312", "committedDate": "2020-02-24T19:03:19Z", "message": "Merge branch 'feature/extensible-values-source' into vs-refactor-config-clean-up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "646408090524b8f9e6d87f7a729b9455d356fee2", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/646408090524b8f9e6d87f7a729b9455d356fee2", "committedDate": "2020-02-24T20:17:51Z", "message": "Restrict access on remaining mutators"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d36cfd3679f79a6906fe59713ccaeadfbe19793b", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d36cfd3679f79a6906fe59713ccaeadfbe19793b", "committedDate": "2020-02-24T20:24:55Z", "message": "remove some outdated TODO notes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960", "committedDate": "2020-02-24T20:37:29Z", "message": "Remove redundant parameter to toValuesSource"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNjg5MTky", "url": "https://github.com/elastic/elasticsearch/pull/52729#pullrequestreview-363689192", "createdAt": "2020-02-24T20:47:24Z", "commit": {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDo0NzoyNFrOFtvSjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQyMDo1MDowM1rOFtvXjQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTAzOQ==", "bodyText": "Maybe a static method would be better for these two?", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383505039", "createdAt": "2020-02-24T20:47:24Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -152,21 +137,55 @@ private static DocValueFormat resolveFormat(@Nullable String format, @Nullable V\n         return valuesSourceType.getFormatter(format, tz);\n     }\n \n-    private final ValuesSourceType valueSourceType;\n+    private final ValuesSourceType valuesSourceType;\n     private FieldContext fieldContext;\n     private AggregationScript.LeafFactory script;\n     private ValueType scriptValueType;\n-    private boolean unmapped = false;\n+    private boolean unmapped;\n     private DocValueFormat format = DocValueFormat.RAW;\n     private Object missing;\n     private ZoneId timeZone;\n+    private LongSupplier now;\n+\n+\n+    /**\n+     * Config instances which only need to specify a field should use this constructor\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              QueryShardContext queryShardContext) {\n+        this(valuesSourceType, fieldType, false, null, null, queryShardContext);\n+    }\n+\n+    /**\n+     * Convenience method for creating unmapped configs\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTEzNA==", "bodyText": "They'd have names, at least.", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383505134", "createdAt": "2020-02-24T20:47:33Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -152,21 +137,55 @@ private static DocValueFormat resolveFormat(@Nullable String format, @Nullable V\n         return valuesSourceType.getFormatter(format, tz);\n     }\n \n-    private final ValuesSourceType valueSourceType;\n+    private final ValuesSourceType valuesSourceType;\n     private FieldContext fieldContext;\n     private AggregationScript.LeafFactory script;\n     private ValueType scriptValueType;\n-    private boolean unmapped = false;\n+    private boolean unmapped;\n     private DocValueFormat format = DocValueFormat.RAW;\n     private Object missing;\n     private ZoneId timeZone;\n+    private LongSupplier now;\n+\n+\n+    /**\n+     * Config instances which only need to specify a field should use this constructor\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              QueryShardContext queryShardContext) {\n+        this(valuesSourceType, fieldType, false, null, null, queryShardContext);\n+    }\n+\n+    /**\n+     * Convenience method for creating unmapped configs\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNTAzOQ=="}, "originalCommit": {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960"}, "originalPosition": 141}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzUwNjMxNw==", "bodyText": "nowSupplier?", "url": "https://github.com/elastic/elasticsearch/pull/52729#discussion_r383506317", "createdAt": "2020-02-24T20:50:03Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -152,21 +137,55 @@ private static DocValueFormat resolveFormat(@Nullable String format, @Nullable V\n         return valuesSourceType.getFormatter(format, tz);\n     }\n \n-    private final ValuesSourceType valueSourceType;\n+    private final ValuesSourceType valuesSourceType;\n     private FieldContext fieldContext;\n     private AggregationScript.LeafFactory script;\n     private ValueType scriptValueType;\n-    private boolean unmapped = false;\n+    private boolean unmapped;\n     private DocValueFormat format = DocValueFormat.RAW;\n     private Object missing;\n     private ZoneId timeZone;\n+    private LongSupplier now;\n+\n+\n+    /**\n+     * Config instances which only need to specify a field should use this constructor\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              QueryShardContext queryShardContext) {\n+        this(valuesSourceType, fieldType, false, null, null, queryShardContext);\n+    }\n+\n+    /**\n+     * Convenience method for creating unmapped configs\n+     */\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType, QueryShardContext queryShardContext) {\n+        this(valuesSourceType, null, true, null, null, queryShardContext);\n+    }\n+\n+    public ValuesSourceConfig(ValuesSourceType valuesSourceType,\n+                              MappedFieldType fieldType,\n+                              boolean unmapped,\n+                              AggregationScript.LeafFactory script,\n+                              ValueType scriptValueType,\n+                              QueryShardContext queryShardContext) {\n+        if (unmapped && fieldType != null) {\n+            throw new IllegalStateException(\"value source config is invalid; marked as unmapped but specified a mapped field\");\n+        }\n+        this.valuesSourceType = valuesSourceType;\n+        if (fieldType != null) {\n+            this.fieldContext = new FieldContext(fieldType.name(), queryShardContext.getForField(fieldType), fieldType);\n+        }\n+        this.unmapped = unmapped;\n+        this.script = script;\n+        this.scriptValueType = scriptValueType;\n+        this.now = queryShardContext::nowInMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0ecc7d9f26bf8c64df7f4a38f9b44acf5bbf1960"}, "originalPosition": 161}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c293a8aa988f641e04183048cdb17f732973dfb5", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c293a8aa988f641e04183048cdb17f732973dfb5", "committedDate": "2020-02-24T21:54:28Z", "message": "Response to PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNzQ5ODAy", "url": "https://github.com/elastic/elasticsearch/pull/52729#pullrequestreview-363749802", "createdAt": "2020-02-24T22:32:56Z", "commit": {"oid": "c293a8aa988f641e04183048cdb17f732973dfb5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc792961d2b34131ae175b6e9bbf53bfdd07d245", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/bc792961d2b34131ae175b6e9bbf53bfdd07d245", "committedDate": "2020-02-25T14:39:08Z", "message": "Ampersands in javadoc are compile errors"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2129, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}