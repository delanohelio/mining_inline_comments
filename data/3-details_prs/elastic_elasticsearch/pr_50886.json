{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNzQzMTk3", "number": 50886, "title": "Fix ActionListener.map exception handling", "bodyText": "map would call listener.onFailure for exceptions from\nlistener.onResponse, but this means we could double trigger some\nlisteners which is generally unexpected. Instead, we should assume that\na listener's onResponse (and onFailure) implementation is responsible\nfor its own exception handling.\nThis affects many APIs across the code base. This is the first of a series\nof PRs changing exception handling to adhere to the principle that an\nActionListener implementation is responsible for its own exception handling.\nThe demo program test here illustrates the current inconsistencies in how exceptions in listeners are handled.", "createdAt": "2020-01-11T16:21:36Z", "url": "https://github.com/elastic/elasticsearch/pull/50886", "merged": true, "mergeCommit": {"oid": "92ee0f70f480bcd8e415a5e12253e9ae46ad9507"}, "closed": true, "closedAt": "2020-01-29T17:17:58Z", "author": {"login": "henningandersen"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5VettAH2gAyMzYxNzQzMTk3OjA5YjU1NzY5ZTllM2FhYjQ1Nzg5YjAxOWQzNjIxMTFmNTFmYzhlMzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb801AqgFqTM0NjU0NzI5MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "09b55769e9e3aab45789b019d362111f51fc8e35", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/09b55769e9e3aab45789b019d362111f51fc8e35", "committedDate": "2020-01-11T16:10:10Z", "message": "Fix ActionListener.map exception handling\n\nmap would call listener.onFailure for exceptions from\nlistener.onResponse, but this means we could double trigger some\nlisteners which is generally unexpected. Instead, we should assume that\na listener's onResponse (and onFailure) implementation is responsible\nfor its own exception handling."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "308798111695b0d9004524aa63718108b0c169c3", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/308798111695b0d9004524aa63718108b0c169c3", "committedDate": "2020-01-11T20:12:39Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNzM1MjU1", "url": "https://github.com/elastic/elasticsearch/pull/50886#pullrequestreview-341735255", "createdAt": "2020-01-13T10:03:57Z", "commit": {"oid": "308798111695b0d9004524aa63718108b0c169c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxNzQzNDE5", "url": "https://github.com/elastic/elasticsearch/pull/50886#pullrequestreview-341743419", "createdAt": "2020-01-13T10:18:35Z", "commit": {"oid": "308798111695b0d9004524aa63718108b0c169c3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMDoxODozNVrOFcyPIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxMDoxODozNVrOFcyPIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTcyNzUyMQ==", "bodyText": "I see the point in this change, but note that I added the .map shortcut back when I added it to dry up a bunch of ActionListener.wrap(..., listener::onFailure) spots.\nI think we'd basically have to audit every spot that we use .map in now and make sure that the listener/delegate will actually handle it's own onResponse failures (from a quick read over the spots we use map in this may already hold true).\nMaybe we should assert this and do something like:\ntry {\n   delegate.onResponse(mapped);\n} catch (Exception e) {\n   assert false: e;\n   throw e;\n}", "url": "https://github.com/elastic/elasticsearch/pull/50886#discussion_r365727521", "createdAt": "2020-01-13T10:18:35Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/ActionListener.java", "diffHunk": "@@ -136,14 +136,27 @@ public void onFailure(Exception e) {\n      * Creates a listener that wraps another listener, mapping response values via the given mapping function and passing along\n      * exceptions to the delegate.\n      *\n+     * Notice that if the listener onResponse handler fails, the exception will bubble out, whereas if the function fails, the listeners\n+     * onFailure handler will be called. The principle is that the code using this is responsible for the function, whereas the listener\n+     * should do its own exception handling since it is a different component.\n+     *\n      * @param listener Listener to delegate to\n      * @param fn Function to apply to listener response\n      * @param <Response> Response type of the new listener\n      * @param <T> Response type of the wrapped listener\n      * @return a listener that maps the received response and then passes it to its delegate listener\n      */\n     static <T, Response> ActionListener<Response> map(ActionListener<T> listener, CheckedFunction<Response, T, Exception> fn) {\n-        return wrap(r -> listener.onResponse(fn.apply(r)), listener::onFailure);\n+        return delegateFailure(listener, (ActionListener<T> delegate, Response response) -> {\n+            T mapped;\n+            try {\n+                mapped = fn.apply(response);\n+            } catch (Exception e) {\n+                delegate.onFailure(e);\n+                return;\n+            }\n+            delegate.onResponse(mapped);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "308798111695b0d9004524aa63718108b0c169c3"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "198651b22672b353955779eb074074686e46e7e5", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/198651b22672b353955779eb074074686e46e7e5", "committedDate": "2020-01-13T15:15:12Z", "message": "Add javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62eaedc6ec4d44ca8d9f3281e119cf9818e61253", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/62eaedc6ec4d44ca8d9f3281e119cf9818e61253", "committedDate": "2020-01-13T16:09:43Z", "message": "Fix SearchTransportService DFS action\n\nThe DFS action relied on map notifying onFailure (sort of, at least this\nway it is bwc). But there seems to be no reason it cannot simply use\nthe ChannelActionListener, so change it into using that."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "15e4199dd398035893e790d67c73ad5f1509baeb", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/15e4199dd398035893e790d67c73ad5f1509baeb", "committedDate": "2020-01-16T15:32:23Z", "message": "Try assert"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b24d570b14087a644a14cae135c4494323f10f3", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b24d570b14087a644a14cae135c4494323f10f3", "committedDate": "2020-01-16T15:32:37Z", "message": "Adapt to asserting on failure."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0dae4f47ddf4f4e64d4095f7873873f3e79af7ea", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0dae4f47ddf4f4e64d4095f7873873f3e79af7ea", "committedDate": "2020-01-16T15:32:46Z", "message": "Remove test that cannot live with assertion error."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b62a2b71d5c713495d17bd897c6935de7814006f", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b62a2b71d5c713495d17bd897c6935de7814006f", "committedDate": "2020-01-16T15:46:13Z", "message": "Merge remote-tracking branch 'origin/master' into fix_map_exception_handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65ba493a87952ad4528f07592bf91a61df7b1abf", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/65ba493a87952ad4528f07592bf91a61df7b1abf", "committedDate": "2020-01-17T13:43:01Z", "message": "Merge remote-tracking branch 'origin/master' into fix_map_exception_handling"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NzEwODM2", "url": "https://github.com/elastic/elasticsearch/pull/50886#pullrequestreview-344710836", "createdAt": "2020-01-17T16:53:18Z", "commit": {"oid": "65ba493a87952ad4528f07592bf91a61df7b1abf"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjo1MzoxOFrOFe_JkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxNjo1NzoyMVrOFe_QuQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzNjI0MA==", "bodyText": "why assert here but not when calling delegate.onFailure(e);?", "url": "https://github.com/elastic/elasticsearch/pull/50886#discussion_r368036240", "createdAt": "2020-01-17T16:53:18Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/ActionListener.java", "diffHunk": "@@ -136,14 +136,32 @@ public void onFailure(Exception e) {\n      * Creates a listener that wraps another listener, mapping response values via the given mapping function and passing along\n      * exceptions to the delegate.\n      *\n+     * Notice that if the listener onResponse handler fails, the exception will bubble out, whereas if the function fails, the listeners\n+     * onFailure handler will be called. The principle is that the code using this is responsible for the function, whereas the listener\n+     * should do its own exception handling since it is a different component.\n+     *\n      * @param listener Listener to delegate to\n      * @param fn Function to apply to listener response\n      * @param <Response> Response type of the new listener\n      * @param <T> Response type of the wrapped listener\n      * @return a listener that maps the received response and then passes it to its delegate listener\n      */\n     static <T, Response> ActionListener<Response> map(ActionListener<T> listener, CheckedFunction<Response, T, Exception> fn) {\n-        return wrap(r -> listener.onResponse(fn.apply(r)), listener::onFailure);\n+        return delegateFailure(listener, (ActionListener<T> delegate, Response response) -> {\n+            T mapped;\n+            try {\n+                mapped = fn.apply(response);\n+            } catch (Exception e) {\n+                delegate.onFailure(e);\n+                return;\n+            }\n+            try {\n+                delegate.onResponse(mapped);\n+            } catch (RuntimeException e) {\n+                assert false : new AssertionError(\"map: listener.onResponse failed\", e);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65ba493a87952ad4528f07592bf91a61df7b1abf"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzNjg5NA==", "bodyText": "ChannelActionListener also has this weird double-sending logic.", "url": "https://github.com/elastic/elasticsearch/pull/50886#discussion_r368036894", "createdAt": "2020-01-17T16:54:48Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/search/SearchTransportService.java", "diffHunk": "@@ -306,27 +305,11 @@ public static void registerRequestHandler(TransportService transportService, Sea\n             (in) -> TransportResponse.Empty.INSTANCE);\n \n         transportService.registerRequestHandler(DFS_ACTION_NAME, ThreadPool.Names.SAME, ShardSearchRequest::new,\n-            (request, channel, task) -> {\n-                searchService.executeDfsPhase(request, (SearchShardTask) task, new ActionListener<SearchPhaseResult>() {\n-                    @Override\n-                    public void onResponse(SearchPhaseResult searchPhaseResult) {\n-                        try {\n-                            channel.sendResponse(searchPhaseResult);\n-                        } catch (IOException e) {\n-                            throw new UncheckedIOException(e);\n-                        }\n-                    }\n-\n-                    @Override\n-                    public void onFailure(Exception e) {\n-                        try {\n-                            channel.sendResponse(e);\n-                        } catch (IOException e1) {\n-                            throw new UncheckedIOException(e1);\n-                        }\n-                    }\n-                });\n-            });\n+            (request, channel, task) ->\n+                searchService.executeDfsPhase(request, (SearchShardTask) task,\n+                    new ChannelActionListener<>(channel, DFS_ACTION_NAME, request))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65ba493a87952ad4528f07592bf91a61df7b1abf"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODAzODA3Mw==", "bodyText": "undo", "url": "https://github.com/elastic/elasticsearch/pull/50886#discussion_r368038073", "createdAt": "2020-01-17T16:57:21Z", "author": {"login": "ywelsch"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/create/CreateIndexIT.java", "diffHunk": "@@ -378,5 +378,4 @@ public void testIndexNameInResponse() {\n \n         assertEquals(\"Should have index name in response\", \"foo\", response.index());\n     }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "65ba493a87952ad4528f07592bf91a61df7b1abf"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca31964870ea47b1391fa0cae78ee3c9272a7dcd", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca31964870ea47b1391fa0cae78ee3c9272a7dcd", "committedDate": "2020-01-20T09:31:30Z", "message": "Review comments\n\nAlso assert that onFailure does not fail."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDg4MjQw", "url": "https://github.com/elastic/elasticsearch/pull/50886#pullrequestreview-346488240", "createdAt": "2020-01-22T10:35:45Z", "commit": {"oid": "ca31964870ea47b1391fa0cae78ee3c9272a7dcd"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDozNTo0NVrOFgXeYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDozNTo0NVrOFgXeYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4MzM2Mw==", "bodyText": "Maybe word this a little differently, this reads somewhat confusing (IMO):\nThe principle is that the mapped listener will handle exceptions from the mapping function {@code fn} but it is the responsibility of {@code delegate} to handle its own exceptions inside `onResponse` and `onFailure`.\n\n?", "url": "https://github.com/elastic/elasticsearch/pull/50886#discussion_r369483363", "createdAt": "2020-01-22T10:35:45Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/ActionListener.java", "diffHunk": "@@ -136,14 +136,49 @@ public void onFailure(Exception e) {\n      * Creates a listener that wraps another listener, mapping response values via the given mapping function and passing along\n      * exceptions to the delegate.\n      *\n-     * @param listener Listener to delegate to\n+     * Notice that it is considered a bug if the listener's onResponse or onFailure fails. onResponse failures will not call onFailure.\n+     *\n+     * If the function fails, the listener's onFailure handler will be called. The principle is that the code using this is responsible for", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca31964870ea47b1391fa0cae78ee3c9272a7dcd"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "084790e7153bdf9440d0d1f4fbce31a804a9bcfc", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/084790e7153bdf9440d0d1f4fbce31a804a9bcfc", "committedDate": "2020-01-22T11:45:11Z", "message": "Merge remote-tracking branch 'origin/master' into fix_map_exception_handling"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "534c2bc4acc7b2bd546e0b516becc6037b15d215", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/534c2bc4acc7b2bd546e0b516becc6037b15d215", "committedDate": "2020-01-22T11:55:02Z", "message": "Armins improved javadoc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NTQ3Mjkw", "url": "https://github.com/elastic/elasticsearch/pull/50886#pullrequestreview-346547290", "createdAt": "2020-01-22T12:23:21Z", "commit": {"oid": "534c2bc4acc7b2bd546e0b516becc6037b15d215"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3151, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}