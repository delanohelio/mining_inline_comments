{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEwMTc1MjQ4", "number": 64177, "title": "Improve decoration system in ir nodes", "bodyText": "This change creates consistency in the decorations added for the ir nodes by adding addtional methods getValue and toString to the base IRDecoration class. This also add getDecorationValue and getDecorationString as convenience methods to IRNode where getDecoration(IRDExpressionType.class).getType() becomes getDecorationValue(IRDExpressionType.class). The BinaryMathNode is used an example of conversion to the new methods. The rest of the nodes will change in a follow up.", "createdAt": "2020-10-26T17:02:37Z", "url": "https://github.com/elastic/elasticsearch/pull/64177", "merged": true, "mergeCommit": {"oid": "e0c7fe8e3d8444c54ea1f318ee24c2e2017ce0e9"}, "closed": true, "closedAt": "2020-10-30T16:25:21Z", "author": {"login": "jdconrad"}, "timelineItems": {"totalCount": 34, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdMtIoegH2gAyNTEwMTc1MjQ4OjBhMWI1ZWQwOTI3MDRhMWMyNWQxNTA5MjEzYjE2OTY2ZDI2M2M5YzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXoj--AH2gAyNTEwMTc1MjQ4Ojc5Y2I5N2M3OTg1MDZkZTY5MTYwM2IwY2E4OTkwMjczMTRkODE1YmY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0a1b5ed092704a1c25d1509213b16966d263c9c1", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a1b5ed092704a1c25d1509213b16966d263c9c1", "committedDate": "2020-09-26T16:39:29Z", "message": "make location final in IRNode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d62d0752fb2a99ae998fcab291c0f709bded0f5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d62d0752fb2a99ae998fcab291c0f709bded0f5", "committedDate": "2020-09-26T17:18:49Z", "message": "add scoping for script, class, and method to WriteScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "712b0a8965bba0939acd0f8e73932796eddc7238", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/712b0a8965bba0939acd0f8e73932796eddc7238", "committedDate": "2020-09-26T17:36:01Z", "message": "update scope to include classwriter and methodwriter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e38647855a1c5cca0c30a3f7e43f71c5d164edf", "committedDate": "2020-09-26T17:56:22Z", "message": "move loop labels to writescope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65502b186dbd52a0c784a52a83b1fb659e3a6abc", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/65502b186dbd52a0c784a52a83b1fb659e3a6abc", "committedDate": "2020-09-26T18:22:52Z", "message": "move try/catch labels to WriteScope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7231b5ebd24838d08a18b46615849ab7842667eb", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/7231b5ebd24838d08a18b46615849ab7842667eb", "committedDate": "2020-09-26T20:26:14Z", "message": "move write to an external phase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18098089e58987981be7c35788a1a8b93e3bcbb5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/18098089e58987981be7c35788a1a8b93e3bcbb5", "committedDate": "2020-09-26T21:42:15Z", "message": "convert expression type to ir decoration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fab7ab346732b15568ad76fbb2ac6f70310a9dfa", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/fab7ab346732b15568ad76fbb2ac6f70310a9dfa", "committedDate": "2020-09-27T19:33:17Z", "message": "update ir decoration system"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ae8d2a1f12069641171f0013205b5887c7dfcd6a", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/ae8d2a1f12069641171f0013205b5887c7dfcd6a", "committedDate": "2020-09-30T14:38:56Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760b9b940997249b18947d6da787d338f2a9dc38", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/760b9b940997249b18947d6da787d338f2a9dc38", "committedDate": "2020-10-05T16:36:09Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0320fe53e81db05b2d0b571bb34fb92af6e57c5", "committedDate": "2020-10-05T17:04:18Z", "message": "Merge branch 'proto' into proto2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/527afc40f1b3a96f97b63aaf64c0f2c908b9b97f", "committedDate": "2020-10-08T19:53:15Z", "message": "Merge branch 'master' into proto"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "879afcac4496aa42f0d57c3485a94d11575bfe4c", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/879afcac4496aa42f0d57c3485a94d11575bfe4c", "committedDate": "2020-10-08T19:53:23Z", "message": "Merge branch 'proto' into proto2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49397f77f269c06949af28d6a0b33e8f5d653018", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/49397f77f269c06949af28d6a0b33e8f5d653018", "committedDate": "2020-10-08T20:17:35Z", "message": "response to pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c8082f74654dccabbb2ee339e9089623f445fb3", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c8082f74654dccabbb2ee339e9089623f445fb3", "committedDate": "2020-10-08T21:21:07Z", "message": "Merge branch 'master' into proto2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "883486155e6f1c304fe53b5c8ef09ee255964141", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/883486155e6f1c304fe53b5c8ef09ee255964141", "committedDate": "2020-10-08T21:32:23Z", "message": "Merge branch 'proto2' into proto3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e31faeae9f99ed35a64d812596604b342fbc63f1", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/e31faeae9f99ed35a64d812596604b342fbc63f1", "committedDate": "2020-10-16T19:07:24Z", "message": "Merge branch 'master' into proto2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16031ac02038b84fd67bdc650a3f374ba9c8b927", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/16031ac02038b84fd67bdc650a3f374ba9c8b927", "committedDate": "2020-10-16T19:07:32Z", "message": "Merge branch 'proto2' into proto3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "902b2ba328e4f9e3fc0a3d5f3809e257e396d2a4", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/902b2ba328e4f9e3fc0a3d5f3809e257e396d2a4", "committedDate": "2020-10-16T19:51:59Z", "message": "response to pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c245ddd2784cc981bfa207bbb5074ae73f4b5422", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/c245ddd2784cc981bfa207bbb5074ae73f4b5422", "committedDate": "2020-10-16T20:53:25Z", "message": "Merge branch 'master' into proto3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4bfe0db6687dfe3269ef82b771f11269c0702b57", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/4bfe0db6687dfe3269ef82b771f11269c0702b57", "committedDate": "2020-10-19T16:32:50Z", "message": "Merge branch 'master' into proto3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e025b887a4018c746f944293b59f4276a6d43170", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/e025b887a4018c746f944293b59f4276a6d43170", "committedDate": "2020-10-19T16:49:40Z", "message": "Merge branch 'proto3' into proto4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d09de9a0acb7fd9e7f8dcff97f62745412310fe3", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/d09de9a0acb7fd9e7f8dcff97f62745412310fe3", "committedDate": "2020-10-22T17:01:04Z", "message": "Merge branch 'master' into proto3"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b22e832b888257ab748b0191a868171928c09629", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/b22e832b888257ab748b0191a868171928c09629", "committedDate": "2020-10-22T17:01:14Z", "message": "Merge branch 'proto3' into proto4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "376eda6647a7ce28433183830d3956c7faab513f", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/376eda6647a7ce28433183830d3956c7faab513f", "committedDate": "2020-10-22T18:09:32Z", "message": "response to pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a66b3936a904f5591cb5899edf3618faa8415b47", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/a66b3936a904f5591cb5899edf3618faa8415b47", "committedDate": "2020-10-22T22:06:32Z", "message": "Merge branch 'master' into proto4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "084cfe10473577b0c093fb1ff5db6e006950ed2b", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/084cfe10473577b0c093fb1ff5db6e006950ed2b", "committedDate": "2020-10-26T15:58:17Z", "message": "Merge branch 'master' into proto4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/40f3e98230120f60bc2e4717dd866630a5f4ab5e", "committedDate": "2020-10-26T16:55:35Z", "message": "Merge branch 'proto4' into proto5"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODM1NjMx", "url": "https://github.com/elastic/elasticsearch/pull/64177#pullrequestreview-518835631", "createdAt": "2020-10-28T16:08:45Z", "commit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjowODo0NVrOHpx7Gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjowODo0NVrOHpx7Gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3MTYxMA==", "bodyText": "This is a substantional enough class that it should be pulled out into it's own file.", "url": "https://github.com/elastic/elasticsearch/pull/64177#discussion_r513571610", "createdAt": "2020-10-28T16:08:45Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IRNode.java", "diffHunk": "@@ -31,40 +31,56 @@\n \n     /* ---- begin decorations ---- */\n \n-    public interface IRDecoration {\n+    public abstract static class IRDecoration<V> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODM2NzIy", "url": "https://github.com/elastic/elasticsearch/pull/64177#pullrequestreview-518836722", "createdAt": "2020-10-28T16:09:44Z", "commit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjowOTo0NFrOHpx-Sg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yOFQxNjowOTo0NFrOHpx-Sg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMzU3MjQyNg==", "bodyText": "getDecorationValueOrDefault", "url": "https://github.com/elastic/elasticsearch/pull/64177#discussion_r513572426", "createdAt": "2020-10-28T16:09:44Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/ir/IRNode.java", "diffHunk": "@@ -31,40 +31,56 @@\n \n     /* ---- begin decorations ---- */\n \n-    public interface IRDecoration {\n+    public abstract static class IRDecoration<V> {\n \n+        private final V value;\n+\n+        public IRDecoration(V value) {\n+            this.value = value;\n+        }\n+\n+        public V getValue() {\n+            return value;\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return value.toString();\n+        }\n     }\n \n-    private final Map<Class<? extends IRDecoration>, IRDecoration> decorations = new HashMap<>();\n+    private final Map<Class<? extends IRDecoration<?>>, IRDecoration<?>> decorations = new HashMap<>();\n \n     @SuppressWarnings(\"unchecked\")\n-    public <T extends IRDecoration> T attachDecoration(T decoration) {\n-        return (T)decorations.put(decoration.getClass(), decoration);\n+    public <V> V attachDecoration(IRDecoration<V> decoration) {\n+        IRDecoration<V> previous = (IRDecoration<V>)decorations.put((Class<? extends IRDecoration<?>>)decoration.getClass(), decoration);\n+        return previous == null ? null : previous.getValue();\n     }\n \n-    public <T extends IRDecoration> T removeDecoration(Class<T> type) {\n+    public <T extends IRDecoration<?>> T removeDecoration(Class<T> type) {\n         return type.cast(decorations.remove(type));\n     }\n \n-    public <T extends IRDecoration> T getDecoration(Class<T> type) {\n-        return type.cast(decorations.get(type));\n-    }\n-\n-    public boolean hasDecoration(Class<? extends IRDecoration> type) {\n+    public boolean hasDecoration(Class<? extends IRDecoration<?>> type) {\n         return decorations.containsKey(type);\n     }\n \n-    public <T extends IRDecoration> boolean copyDecorationFrom(IRNode copyFromIRNode, Class<T> type) {\n-        T decoration = copyFromIRNode.getDecoration(type);\n-\n+    public <T extends IRDecoration<?>> T getDecoration(Class<T> type) {\n+        return type.cast(decorations.get(type));\n+    }\n \n-        if (decoration != null) {\n-            attachDecoration(decoration);\n+    public <T extends IRDecoration<V>, V> V getDecorationValue(Class<T> type) {\n+        return getDecorationValueOrDefaultValue(type, null);\n+    }\n \n-            return true;\n-        }\n+    public <T extends IRDecoration<V>, V> V getDecorationValueOrDefaultValue(Class<T> type, V defaultValue) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e"}, "originalPosition": 63}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE4ODQwNjg3", "url": "https://github.com/elastic/elasticsearch/pull/64177#pullrequestreview-518840687", "createdAt": "2020-10-28T16:13:31Z", "commit": {"oid": "40f3e98230120f60bc2e4717dd866630a5f4ab5e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b80b1f16c4c4d1324d0f7fa135dab422ac54f411", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/b80b1f16c4c4d1324d0f7fa135dab422ac54f411", "committedDate": "2020-10-30T15:29:52Z", "message": "Merge branch 'master' into proto4"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0959d19140ce68754367fe9235218f2bd5dc9bc3", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/0959d19140ce68754367fe9235218f2bd5dc9bc3", "committedDate": "2020-10-30T15:29:59Z", "message": "Merge branch 'proto4' into proto5"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "79cb97c798506de691603b0ca899027314d815bf", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/79cb97c798506de691603b0ca899027314d815bf", "committedDate": "2020-10-30T15:33:00Z", "message": "response to pr comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 976, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}