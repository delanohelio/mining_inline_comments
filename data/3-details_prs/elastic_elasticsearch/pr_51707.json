{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MzAwNTU3", "number": 51707, "title": "Improve docker error message", "bodyText": "Adds more information to docker failures, so instead of not very helpful\nProcess 'command '/usr/bin/docker'' finished with non-zero exit value 1\n\nit now prints a more actionable message such as\n* What went wrong:\na problem occurred while using Docker from [/usr/bin/docker] yet it is required \nto run the following tasks: \n  :distribution:docker:buildDockerImage\n  :distribution:docker:buildOssDockerImage\nthe problem is that Docker exited with exit code [1] with standard error output:\nGot permission denied while trying to connect to the Docker daemon socket at uni\nx:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v1.40/version: d\nial unix /var/run/docker.sock: connect: permission denied\nyou can address this by attending to the reported issue, removing the offending \ntasks from being executed, or by passing -Dbuild.docker=false", "createdAt": "2020-01-30T21:37:59Z", "url": "https://github.com/elastic/elasticsearch/pull/51707", "merged": true, "mergeCommit": {"oid": "b676fa33c7c3d14adbadb47033c68699b6131095"}, "closed": true, "closedAt": "2020-02-03T21:33:55Z", "author": {"login": "imotov"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_he_4gH2gAyMzY5MzAwNTU3OmE2YWI3M2MzNzUzNWI5YzU5YjQ3ZTQyMDEyM2JmNGQ0ZTg5NWI4M2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcAub1VgH2gAyMzY5MzAwNTU3OmU2ZmQ4Y2M1Njc2Y2M1OGM5MDhmNWE0YjRmYjI5OWIxNDEwNzU0MmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a6ab73c37535b9c59b47e420123bf4d4e895b83e", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/a6ab73c37535b9c59b47e420123bf4d4e895b83e", "committedDate": "2020-01-30T21:32:53Z", "message": "Improve docker error message\n\nAdds more information to docker failures, so instead of not very helpful\n```\nProcess 'command '/usr/bin/docker'' finished with non-zero exit value 1\n```\nit now prints a more actionable message such as\n```\nError occurred running command [/usr/bin/docker version --format {{.Server.Versi\non}}] stderr: [Got permission denied while trying to connect to the Docker daemo\nn socket at unix:///var/run/docker.sock: Get http://%2Fvar%2Frun%2Fdocker.sock/v\n1.40/version: dial unix /var/run/docker.sock: connect: permission denied] stdout\n: []\n```"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjQ5OTU2", "url": "https://github.com/elastic/elasticsearch/pull/51707#pullrequestreview-351249956", "createdAt": "2020-01-31T01:30:54Z", "commit": {"oid": "a6ab73c37535b9c59b47e420123bf4d4e895b83e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMTozMDo1NFrOFj_Mhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQwMTozMDo1NFrOFj_Mhg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI3OTg3OA==", "bodyText": "I think it would be more readable with stderr and stdout moved to their own lines.", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373279878", "createdAt": "2020-01-31T01:30:54Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -208,14 +208,24 @@ private static Result runCommand(Project project, String... args) {\n         ByteArrayOutputStream stdout = new ByteArrayOutputStream();\n         ByteArrayOutputStream stderr = new ByteArrayOutputStream();\n \n-        final ExecResult execResult = project.exec(spec -> {\n-            // The redundant cast is to silence a compiler warning.\n-            spec.setCommandLine((Object[]) args);\n-            spec.setStandardOutput(stdout);\n-            spec.setErrorOutput(stderr);\n-        });\n-\n-        return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        try {\n+            final ExecResult execResult = project.exec(spec -> {\n+                // The redundant cast is to silence a compiler warning.\n+                spec.setCommandLine((Object[]) args);\n+                spec.setStandardOutput(stdout);\n+                spec.setErrorOutput(stderr);\n+            });\n+            return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        } catch (GradleException ex) {\n+            final String message = String.format(\n+                Locale.ROOT,\n+                \"Error occurred running command [%s] stderr: [%s] stdout: [%s]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a6ab73c37535b9c59b47e420123bf4d4e895b83e"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMzc1MTY5", "url": "https://github.com/elastic/elasticsearch/pull/51707#pullrequestreview-351375169", "createdAt": "2020-01-31T09:17:14Z", "commit": {"oid": "a6ab73c37535b9c59b47e420123bf4d4e895b83e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "844d0f8c74987b00b90aa91faf1bb51247ba5577", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/844d0f8c74987b00b90aa91faf1bb51247ba5577", "committedDate": "2020-01-31T16:01:11Z", "message": "Improve error format"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNjIxNzU0", "url": "https://github.com/elastic/elasticsearch/pull/51707#pullrequestreview-351621754", "createdAt": "2020-01-31T16:26:18Z", "commit": {"oid": "844d0f8c74987b00b90aa91faf1bb51247ba5577"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNjoyNjoxOFrOFkQudw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQxNjoyNjoxOFrOFkQudw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzU2NzA5NQ==", "bodyText": "Rather than doing this via generic exception handling let's set spec.setIgnoreExitValue(true) and throw our own exception if the result is a non-zero exit value. That way if we blow up for some other reason (bad config, Gradle issue) we aren't returning a potentially misleading exception message.", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373567095", "createdAt": "2020-01-31T16:26:18Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -208,14 +208,26 @@ private static Result runCommand(Project project, String... args) {\n         ByteArrayOutputStream stdout = new ByteArrayOutputStream();\n         ByteArrayOutputStream stderr = new ByteArrayOutputStream();\n \n-        final ExecResult execResult = project.exec(spec -> {\n-            // The redundant cast is to silence a compiler warning.\n-            spec.setCommandLine((Object[]) args);\n-            spec.setStandardOutput(stdout);\n-            spec.setErrorOutput(stderr);\n-        });\n-\n-        return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        try {\n+            final ExecResult execResult = project.exec(spec -> {\n+                // The redundant cast is to silence a compiler warning.\n+                spec.setCommandLine((Object[]) args);\n+                spec.setStandardOutput(stdout);\n+                spec.setErrorOutput(stderr);\n+            });\n+            return new Result(execResult.getExitValue(), stdout.toString(), stderr.toString());\n+        } catch (GradleException ex) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "844d0f8c74987b00b90aa91faf1bb51247ba5577"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "853f192ef7bce1595617f4411fbb56a64954ed67", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/853f192ef7bce1595617f4411fbb56a64954ed67", "committedDate": "2020-01-31T19:27:39Z", "message": "Use error code instead of generic exception interception"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f117cbb97bd1e29568dd8447c617ab0a8c00b74", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f117cbb97bd1e29568dd8447c617ab0a8c00b74", "committedDate": "2020-01-31T19:38:52Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-docker-error-message"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxNzc2MTEz", "url": "https://github.com/elastic/elasticsearch/pull/51707#pullrequestreview-351776113", "createdAt": "2020-01-31T21:03:47Z", "commit": {"oid": "5f117cbb97bd1e29568dd8447c617ab0a8c00b74"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMTowMzo0OFrOFkX4Wg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMVQyMTowMzo0OFrOFkX4Wg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzY4NDMxNA==", "bodyText": "This seems unnecessary to me. This final message is meant to be a catch-all anyway so I don't think there's much benefit in trying to be any more specific in the error message.", "url": "https://github.com/elastic/elasticsearch/pull/51707#discussion_r373684314", "createdAt": "2020-01-31T21:03:48Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/tool/DockerUtils.java", "diffHunk": "@@ -165,11 +155,19 @@ public static void assertDockerIsAvailable(Project project, List<String> tasks)\n             throwDockerRequiredException(message);\n         }\n \n+        final String operation;\n+        if (availability.version == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f117cbb97bd1e29568dd8447c617ab0a8c00b74"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f394b775d03081826e7efc3ec29df9a72e1495ca", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/f394b775d03081826e7efc3ec29df9a72e1495ca", "committedDate": "2020-02-03T15:11:48Z", "message": "Remove operation from the error log message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6fd8cc5676cc58c908f5a4b4fb299b14107542d", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6fd8cc5676cc58c908f5a4b4fb299b14107542d", "committedDate": "2020-02-03T15:12:07Z", "message": "Merge remote-tracking branch 'elastic/master' into fix-docker-error-message"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3118, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}