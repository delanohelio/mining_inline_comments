{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3Mzk2NzA4", "number": 52538, "title": "[ML] rewrite deprecated datafeed configs to use new date_histogram interval fields", "bodyText": "interval was deprecated back in 7.2.0. It was replaced with calendar_interval and fixed_interval.\nThis change automatically rewrites datafeed configurations that contain the old interval field. The rewrite occurs when the configuration is read from the index. It is NOT then written back to the index.\nThis PR also re-enables the long disabled BWC tests for datafeeds. I did my best to cover all the flakiness. Definitely want to run through multiple times locally once #52383 is fixed.\nPartially addresses: #51606", "createdAt": "2020-02-19T21:07:03Z", "url": "https://github.com/elastic/elasticsearch/pull/52538", "merged": true, "mergeCommit": {"oid": "b49b8dbb1dd85c9231f7988c5771b9b45f4c92ab"}, "closed": true, "closedAt": "2020-02-24T17:42:59Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcF9B2aAH2gAyMzc3Mzk2NzA4OjRmMTc2MDMyMjY0ZGNlY2I4NWQzOWViNDQ3ZTFiOTI4YTE0NWEyMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHhGIbgFqTM2MzU3MzMxOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f176032264dcecb85d39eb447e1b928a145a211", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f176032264dcecb85d39eb447e1b928a145a211", "committedDate": "2020-02-19T21:01:56Z", "message": "[ML] rewrite deprecated datafeed aggs to use new [fixed|calendar]interval"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "612b900397cf45aa762be8d230a671d148e254ba", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/612b900397cf45aa762be8d230a671d148e254ba", "committedDate": "2020-02-20T12:46:10Z", "message": "fixing bwc test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00367ea646351e3576532098b64e6483d3895d63", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/00367ea646351e3576532098b64e6483d3895d63", "committedDate": "2020-02-20T13:02:49Z", "message": "Update 40_ml_datafeed_crud.yml"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/c60f8c5f706dbd3cefc55e36d17cff67c2cc1eae", "committedDate": "2020-02-20T13:57:07Z", "message": "adjusting bwc tests for rolling upgrade from 8.0.0"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/efe0664294a7a14cf7e8231abbcc951fd49bc285", "committedDate": "2020-02-20T13:58:20Z", "message": "Merge branch 'feature/ml-datafeed-date_histo-migration' of github.com:benwtrent/elasticsearch into feature/ml-datafeed-date_histo-migration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMzg1MzA3", "url": "https://github.com/elastic/elasticsearch/pull/52538#pullrequestreview-363385307", "createdAt": "2020-02-24T13:26:02Z", "commit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxMzoyNjowMlrOFtgfYA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQxNDowMTo0N1rOFthl8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2MjU2MA==", "bodyText": "Could it be version: \"8.0.0 - \" for 8.0.0 and above?", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383262560", "createdAt": "2020-02-24T13:26:02Z", "author": {"login": "droberts195"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -121,10 +124,85 @@ setup:\n   - is_false: datafeeds.0.node\n \n ---\n-\"Put job and datafeed with aggs in old cluster - deprecated interval with warning\":\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning before 8.0.0\":\n+  - skip:\n+      version: \"7.99.99 - \"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI2NjMyMw==", "bodyText": "At the moment this test is unconditionally skipped, so I wondered about deleting it completely.  But I guess the reason for keeping it is that eventually it can be reenabled.  You could add a comment #\u00a0TODO: remove skip section from master when version is bumped to 9.0.0 here to prompt us to do that.", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383266323", "createdAt": "2020-02-24T13:33:35Z", "author": {"login": "droberts195"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/mixed_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -23,7 +26,9 @@ setup:\n ---\n \"Test old cluster datafeed with aggs\":\n   - skip:\n-      features: \"warnings\"\n+      features: warnings\n+      version: \"all\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI3NDA5OA==", "bodyText": "I think this should still be a valid test.  It's testing the code in \n  \n    \n      elasticsearch/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/datafeed/extractor/ExtractorUtils.java\n    \n    \n        Lines 179 to 189\n      in\n      290c8b8\n    \n    \n    \n    \n\n        \n          \n               if (interval.days() > 7) { \n        \n\n        \n          \n                   throw ExceptionsHelper.badRequestException(invalidDateHistogramCalendarIntervalMessage(calendarInterval)); \n        \n\n        \n          \n               } \n        \n\n        \n          \n               return interval.millis(); \n        \n\n        \n          \n           } \n        \n\n        \n          \n            \n        \n\n        \n          \n           private static String invalidDateHistogramCalendarIntervalMessage(String interval) { \n        \n\n        \n          \n               throw ExceptionsHelper.badRequestException(\"When specifying a date_histogram calendar interval [\" \n        \n\n        \n          \n                       + interval + \"], ML does not accept intervals longer than a week because of \" + \n        \n\n        \n          \n                       \"variable lengths of periods greater than a week\"); \n        \n\n        \n          \n           } \n        \n    \n  \n\n\nDid this test fail after the other changes in this PR?  If so that might be a sign of a problem.\nEven though histograms in general can plot variable length time buckets (e.g. months), it's still reasonable for ML to prohibit such bucket spans as they would make the modelling much more complex.", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383274098", "createdAt": "2020-02-24T13:49:11Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ml/datafeed/DatafeedConfigTests.java", "diffHunk": "@@ -566,13 +584,6 @@ public void testBuild_GivenValidDateHistogram() {\n                 equalTo(7 * millisInDay + 1));\n     }\n \n-    public void testBuild_GivenDateHistogramWithMoreThanCalendarWeek() {\n-        ElasticsearchException e = expectThrows(ElasticsearchException.class,\n-                () -> createDatafeedWithDateHistogram(\"8d\"));\n-\n-        assertThat(e.getMessage(), containsString(\"When specifying a date_histogram calendar interval [8d]\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285"}, "originalPosition": 135}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzI4MDYyNQ==", "bodyText": "I think we will run into a problem with this in the future, because at some point before 8.0.0-beta1 is released the master branch will start to treat interval as a syntax error.  This test seems to be designed for the day when there is a version beyond 8.0.0 and the old cluster is 8.0.0.  But when this combination of versions is being tested this test will be forced to use \"fixed_interval\" : \"30s\" instead of \"interval\" : \"30s\", so will not test the rewrite functionality.  Since it's also testing other things it's worth keeping the test, but you might as well change it to say \"fixed_interval\" : \"30s\" now.", "url": "https://github.com/elastic/elasticsearch/pull/52538#discussion_r383280625", "createdAt": "2020-02-24T14:01:47Z", "author": {"login": "droberts195"}, "path": "x-pack/qa/rolling-upgrade/src/test/resources/rest-api-spec/test/old_cluster/40_ml_datafeed_crud.yml", "diffHunk": "@@ -121,10 +124,85 @@ setup:\n   - is_false: datafeeds.0.node\n \n ---\n-\"Put job and datafeed with aggs in old cluster - deprecated interval with warning\":\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning before 8.0.0\":\n+  - skip:\n+      version: \"7.99.99 - \"\n+      reason:  at version 8.0.0, deprecation warnings don't occur on get_stats\n+      features: warnings\n+\n+  - do:\n+      ml.put_job:\n+        job_id: old-cluster-datafeed-job-with-aggs\n+        body:  >\n+          {\n+            \"description\":\"Cluster upgrade\",\n+            \"analysis_config\" : {\n+                \"bucket_span\": \"60s\",\n+                \"summary_count_field_name\": \"doc_count\",\n+                \"detectors\" :[{\"function\":\"count\"}]\n+            },\n+            \"analysis_limits\" : {\n+                \"model_memory_limit\": \"50mb\"\n+            },\n+            \"data_description\" : {\n+                \"format\":\"xcontent\",\n+                \"time_field\":\"time\"\n+            }\n+          }\n+  - match: { job_id: old-cluster-datafeed-job-with-aggs }\n+\n+  - do:\n+      warnings:\n+        - '[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.'\n+      ml.put_datafeed:\n+        datafeed_id: old-cluster-datafeed-with-aggs\n+        body:  >\n+          {\n+            \"job_id\":\"old-cluster-datafeed-job-with-aggs\",\n+            \"indices\":[\"airline-data\"],\n+            \"scroll_size\": 2000,\n+            \"aggregations\": {\n+              \"buckets\": {\n+                \"date_histogram\": {\n+                  \"field\": \"time\",\n+                  \"interval\": \"30s\",\n+                  \"time_zone\": \"UTC\"\n+                },\n+                \"aggregations\": {\n+                  \"time\": {\n+                    \"max\": {\"field\": \"time\"}\n+                  },\n+                  \"airline\": {\n+                    \"terms\": {\n+                      \"field\": \"airline\",\n+                      \"size\": 100\n+                    },\n+                    \"aggregations\": {\n+                      \"responsetime\": {\n+                        \"avg\": {\n+                          \"field\": \"responsetime\"\n+                        }\n+                      }\n+                    }\n+                  }\n+                }\n+              }\n+            }\n+          }\n+\n+  - do:\n+      warnings:\n+        - '[interval] on [date_histogram] is deprecated, use [fixed_interval] or [calendar_interval] in the future.'\n+      ml.get_datafeed_stats:\n+        datafeed_id: old-cluster-datafeed-with-aggs\n+  - match: { datafeeds.0.state: stopped}\n+  - is_false: datafeeds.0.node\n+\n+---\n+\"Put job and datafeed with aggs in old cluster - deprecated interval with warning after 8.0.0\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "efe0664294a7a14cf7e8231abbcc951fd49bc285"}, "originalPosition": 94}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b2d978a07261ec1fe88d4f18227eb710c38681c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b2d978a07261ec1fe88d4f18227eb710c38681c", "committedDate": "2020-02-24T14:40:30Z", "message": "fixing bwc tests + adding back large calendar interval test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252297fe0f41de1dc75ed19f9022a19df1471181", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/252297fe0f41de1dc75ed19f9022a19df1471181", "committedDate": "2020-02-24T14:40:41Z", "message": "Merge branch 'master' into feature/ml-datafeed-date_histo-migration"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzNTczMzE4", "url": "https://github.com/elastic/elasticsearch/pull/52538#pullrequestreview-363573318", "createdAt": "2020-02-24T17:37:07Z", "commit": {"oid": "252297fe0f41de1dc75ed19f9022a19df1471181"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2191, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}