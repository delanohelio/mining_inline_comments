{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwMjA5OTA1", "number": 54874, "title": "[ML] Cancel reindex task from correct thread context", "bodyText": "When a data frame analytics job is stopped, if the reindexing\ntask was still in progress we cancel it. Cancelling it should\nbe done from the same context as when we executed the reindexing\ntask. That means from a thread context with ML origin.", "createdAt": "2020-04-07T11:31:19Z", "url": "https://github.com/elastic/elasticsearch/pull/54874", "merged": true, "mergeCommit": {"oid": "b0933539d12694dcf4b130179a6f78bb71370dcb"}, "closed": true, "closedAt": "2020-04-07T14:24:10Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVRlHUgH2gAyNDAwMjA5OTA1Ojk0ZDdhNzVlMWMwZGE5ODFmZTZhNGQ0OTk5Njk1MzM5ZDliZWJjMTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcVTeb-AH2gAyNDAwMjA5OTA1OjhlNmY0OTE3MTM2ZjhiMGI4NWZlMTRkOGU2ZTJhYjMwOGUzMTkxMjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/94d7a75e1c0da981fe6a4d4999695339d9bebc15", "committedDate": "2020-04-07T11:27:25Z", "message": "[ML] Cancel reindex task from correct thread context\n\nWhen a data frame analytics job is stopped, if the reindexing\ntask was still in progress we cancel it. Cancelling it should\nbe done from the same context as when we executed the reindexing\ntask. That means from a thread context with ML origin."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDU4MTU4", "url": "https://github.com/elastic/elasticsearch/pull/54874#pullrequestreview-389058158", "createdAt": "2020-04-07T12:19:13Z", "commit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoxOToxM1rOGCAyrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMjoxOToxM1rOGCAyrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MzMxMA==", "bodyText": "I guess I need to learn more about context/origins etc.\nWhat are the rules one should follow when spawning requests from ML code?\nI've seen at least two ways of setting ML_ORIGIN, namely threadContext.stashWithOrigin(ML_ORIGIN) and using OriginSettingClient.\nAlso, it is possible not to set the origin (like this code before your fix). Could we make it so that all ML calls set the origin?", "url": "https://github.com/elastic/elasticsearch/pull/54874#discussion_r404763310", "createdAt": "2020-04-07T12:19:13Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -161,7 +162,11 @@ private void cancelReindexingTask(String reason, TimeValue timeout) {\n         cancelReindex.setTaskId(reindexTaskId);\n         cancelReindex.setReason(reason);\n         cancelReindex.setTimeout(timeout);\n-        CancelTasksResponse cancelReindexResponse = client.admin().cluster().cancelTasks(cancelReindex).actionGet();\n+\n+        // We need to cancel the reindexing task within context with ML origin as we started the task\n+        // from the same context\n+        CancelTasksResponse cancelReindexResponse = cancelTaskWithinMlOriginContext(cancelReindex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDcwMjE5", "url": "https://github.com/elastic/elasticsearch/pull/54874#pullrequestreview-389070219", "createdAt": "2020-04-07T12:35:34Z", "commit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MDk4MTIw", "url": "https://github.com/elastic/elasticsearch/pull/54874#pullrequestreview-389098120", "createdAt": "2020-04-07T13:09:56Z", "commit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowOTo1NlrOGCCvRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxMzowOTo1NlrOGCCvRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc5NTIwNQ==", "bodyText": "Ok, thanks!", "url": "https://github.com/elastic/elasticsearch/pull/54874#discussion_r404795205", "createdAt": "2020-04-07T13:09:56Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/DataFrameAnalyticsTask.java", "diffHunk": "@@ -161,7 +162,11 @@ private void cancelReindexingTask(String reason, TimeValue timeout) {\n         cancelReindex.setTaskId(reindexTaskId);\n         cancelReindex.setReason(reason);\n         cancelReindex.setTimeout(timeout);\n-        CancelTasksResponse cancelReindexResponse = client.admin().cluster().cancelTasks(cancelReindex).actionGet();\n+\n+        // We need to cancel the reindexing task within context with ML origin as we started the task\n+        // from the same context\n+        CancelTasksResponse cancelReindexResponse = cancelTaskWithinMlOriginContext(cancelReindex);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDc2MzMxMA=="}, "originalCommit": {"oid": "94d7a75e1c0da981fe6a4d4999695339d9bebc15"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e6f4917136f8b0b85fe14d8e6e2ab308e319126", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e6f4917136f8b0b85fe14d8e6e2ab308e319126", "committedDate": "2020-04-07T13:39:56Z", "message": "Merge branch 'master' into cancel-reindex-task-from-correct-thread-context"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3747, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}