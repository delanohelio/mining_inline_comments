{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3OTMyOTU5", "number": 62444, "title": "Add WARN Logging on Slow Transport Message Handling", "bodyText": "Add simple WARN logging on slow inbound TCP messages.\nThis approach differs from the one used by the test slow logging in that it is more high level, logging the concrete request that was slow instead of the stack trace.\nIt allows tracking down slowness on TCP inbound (which is the most likely route to experience problematic slowness IMO). The same approach can be added to REST inbound handling and with additional effort also to TCP outbound handling.\nI think this approach is much more suitable for finding things like #57937 quickly, has negligible overhead and is a small change that can go into 7.10 already. Building the same logic we use in tests would require much larger changes to our Netty code-base and would not add much beyond the ability to track down dead-locked transport threads.", "createdAt": "2020-09-16T11:49:58Z", "url": "https://github.com/elastic/elasticsearch/pull/62444", "merged": true, "mergeCommit": {"oid": "cb5f1048544d8609e5a084766d1afcfbc5d1eb57"}, "closed": true, "closedAt": "2020-09-17T06:46:47Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJa4iDAH2gAyNDg3OTMyOTU5OmJlMWQwYjNkMDg4NGYxZDc0ZDdmZTQzZDYxNmJjMTE0MDk0YmMwZWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJq-rvAFqTQ5MDI3NzIzNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/be1d0b3d0884f1d74d7fe43d616bc114094bc0ea", "committedDate": "2020-09-16T11:41:50Z", "message": "Add WARN Logging on Slow Transport Message Handling\n\nAdd simple WARN logging on slow inbound tcp messages."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTQ1Njkx", "url": "https://github.com/elastic/elasticsearch/pull/62444#pullrequestreview-489545691", "createdAt": "2020-09-16T11:52:52Z", "commit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo1Mjo1MlrOHStN_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo1Mjo1MlrOHStN_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3NzI3Ng==", "bodyText": "Admittedly the chain of setters here is a little hacky but:\n\nDoing it this way made this a much much smaller change than passing the cluster settings directly to the InboundHandler\nI'd do a follow-up of this logic for the outbound path and that would require handling the threshold setting in the TransportService anyway.", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489377276", "createdAt": "2020-09-16T11:52:52Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -71,6 +74,10 @@ void setMessageListener(TransportMessageListener listener) {\n         }\n     }\n \n+    void setSlowLogThreshold(TimeValue slowLogThreshold) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTQ3MzAx", "url": "https://github.com/elastic/elasticsearch/pull/62444#pullrequestreview-489547301", "createdAt": "2020-09-16T11:55:06Z", "commit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo1NTowNlrOHStTIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMTo1NTowNlrOHStTIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw==", "bodyText": "300ms since our default resolution on the timer thread is 200ms. This is already plenty IMO (3 requests per second isn't great on a transport thread) but not so low that any cgroup throttling or other system slowness instantly results in massive log spam.", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489378593", "createdAt": "2020-09-16T11:55:06Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/transport/TransportSettings.java", "diffHunk": "@@ -132,6 +132,12 @@\n             Arrays.asList(\"internal:coordination/fault_detection/*\"),\n             Function.identity(), Setting.Property.Dynamic, Setting.Property.NodeScope);\n \n+    // Time that processing an inbound message on a transport thread may take at the most before a warning is logged\n+    public static final Setting<TimeValue> SLOW_OPERATION_THRESHOLD_SETTING =\n+            Setting.positiveTimeSetting(\"transport.slow_operation_logging_threshold\", TimeValue.timeValueMillis(300),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTc3Nzc2", "url": "https://github.com/elastic/elasticsearch/pull/62444#pullrequestreview-489577776", "createdAt": "2020-09-16T12:36:26Z", "commit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMjozNjoyN1rOHSuumg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxMzowNzoxOVrOHSv8Cw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwMjAxMA==", "bodyText": "It'd be useful to include the phrase warn threshold as this is a useful search term for the logs when investigating general slowness/instability problems:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            logger.warn(\"Slow handling of transport message [{}] took [{}ms]\", message, took);\n          \n          \n            \n                            logger.warn(\"handling inbound transport message [{}] took [{}ms] which is above the warn threshold of [{}ms]\", message, took, logThreshold);", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489402010", "createdAt": "2020-09-16T12:36:27Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -138,6 +146,12 @@ private void messageReceived(TcpChannel channel, InboundMessage message) throws\n                     }\n                 }\n             }\n+        } finally {\n+            final long took = threadPool.relativeTimeInMillis() - startTime;\n+            final long logThreshold = slowLogThresholdMs;\n+            if (logThreshold > 0 && took > logThreshold) {\n+                logger.warn(\"Slow handling of transport message [{}] took [{}ms]\", message, took);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQwOTUwMA==", "bodyText": "Could we move the timing up to this level, since the logging on this line may also be a source of slowness?", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489409500", "createdAt": "2020-09-16T12:48:32Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/transport/InboundHandler.java", "diffHunk": "@@ -71,6 +74,10 @@ void setMessageListener(TransportMessageListener listener) {\n         }\n     }\n \n+    void setSlowLogThreshold(TimeValue slowLogThreshold) {\n+        this.slowLogThresholdMs = slowLogThreshold.getMillis();\n+    }\n+\n     void inboundMessage(TcpChannel channel, InboundMessage message) throws Exception {\n         channel.getChannelStats().markAccessed(threadPool.relativeTimeInMillis());\n         TransportLogger.logInboundMessage(channel, message);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTQyMTgzNQ==", "bodyText": "I'm still a bit concerned about log spam -- we aren't aware of anything that blocks the transport threads for so long today but that might just be because we don't surface it yet, and some configs might be hitting this a lot. #processors threads times 3 messages per second is too much for my taste. WDYT about a simple rate limit to avoid logging more than one of these per ten seconds or something? That'd be enough to point us in the right direction.", "url": "https://github.com/elastic/elasticsearch/pull/62444#discussion_r489421835", "createdAt": "2020-09-16T13:07:19Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/transport/TransportSettings.java", "diffHunk": "@@ -132,6 +132,12 @@\n             Arrays.asList(\"internal:coordination/fault_detection/*\"),\n             Function.identity(), Setting.Property.Dynamic, Setting.Property.NodeScope);\n \n+    // Time that processing an inbound message on a transport thread may take at the most before a warning is logged\n+    public static final Setting<TimeValue> SLOW_OPERATION_THRESHOLD_SETTING =\n+            Setting.positiveTimeSetting(\"transport.slow_operation_logging_threshold\", TimeValue.timeValueMillis(300),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTM3ODU5Mw=="}, "originalCommit": {"oid": "be1d0b3d0884f1d74d7fe43d616bc114094bc0ea"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a336d1f3f5a9eaa41f56cc9b5b2d03ffff76755", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a336d1f3f5a9eaa41f56cc9b5b2d03ffff76755", "committedDate": "2020-09-16T14:14:54Z", "message": "CR: comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df849144407f28e83a6cc6b8873a6e348d44bcb9", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/df849144407f28e83a6cc6b8873a6e348d44bcb9", "committedDate": "2020-09-16T15:28:23Z", "message": "5s it is"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwMjc3MjM2", "url": "https://github.com/elastic/elasticsearch/pull/62444#pullrequestreview-490277236", "createdAt": "2020-09-17T06:27:02Z", "commit": {"oid": "df849144407f28e83a6cc6b8873a6e348d44bcb9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4482, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}