{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA1Nzk3NDY5", "number": 63865, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1MjowNFrOEvNiBQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToxNToyMFrOEvOIHA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTQwMjI5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1MjowNFrOHkEMtA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1MjowNFrOHkEMtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU3OTU3Mg==", "bodyText": "nit: I think the indenting is one space off on this line", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507579572", "createdAt": "2020-10-19T08:52:04Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "diffHunk": "@@ -350,4 +357,17 @@ private void buildFieldConfig(List<String> command) throws IOException {\n             command.add(fieldConfig);\n         }\n     }\n+\n+    private void buildJobConfig(List<String> command) throws IOException {\n+        Path configFile = Files.createTempFile(env.tmpFile(), \"config\", JSON_EXTENSION);\n+        filesToDelete.add(configFile);\n+        try (OutputStreamWriter osw = new OutputStreamWriter(Files.newOutputStream(configFile),StandardCharsets.UTF_8);\n+             XContentBuilder jsonBuilder = JsonXContent.contentBuilder()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTQwNjE2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1Mjo1M1rOHkEO6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOTo0MDoxMFrOHkGFFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ==", "bodyText": "Is the (Class) cast really necessary here?", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507580139", "createdAt": "2020-10-19T08:52:53Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -36,11 +41,14 @@\n     private Settings settings;\n     private NativeController nativeController;\n     private ProcessPipes processPipes;\n+    private ArgumentCaptor<List<String>> commandCaptor;\n \n+    @SuppressWarnings(\"unchecked\")\n     @Before\n     public void setUpTests() {\n         logger = mock(Logger.class);\n-        filesToDelete = Collections.emptyList();\n+        filesToDelete = new ArrayList<>();\n+        commandCaptor = ArgumentCaptor.forClass((Class)List.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYwNjcyOQ==", "bodyText": "Sadly it is yes. Without it we get the compilation error\njava: incompatible types: inference variable T has incompatible equality constraints java.util.List<java.lang.String>,java.util.List\n\nAdmittedly the cast isn't nice but there is precedence in e.g. AnalyticsBuilder.java", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507606729", "createdAt": "2020-10-19T09:34:16Z", "author": {"login": "edsavage"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -36,11 +41,14 @@\n     private Settings settings;\n     private NativeController nativeController;\n     private ProcessPipes processPipes;\n+    private ArgumentCaptor<List<String>> commandCaptor;\n \n+    @SuppressWarnings(\"unchecked\")\n     @Before\n     public void setUpTests() {\n         logger = mock(Logger.class);\n-        filesToDelete = Collections.emptyList();\n+        filesToDelete = new ArrayList<>();\n+        commandCaptor = ArgumentCaptor.forClass((Class)List.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ=="}, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzYxMDM5MA==", "bodyText": "OK cool, I didn't realise that", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507610390", "createdAt": "2020-10-19T09:40:10Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -36,11 +41,14 @@\n     private Settings settings;\n     private NativeController nativeController;\n     private ProcessPipes processPipes;\n+    private ArgumentCaptor<List<String>> commandCaptor;\n \n+    @SuppressWarnings(\"unchecked\")\n     @Before\n     public void setUpTests() {\n         logger = mock(Logger.class);\n-        filesToDelete = Collections.emptyList();\n+        filesToDelete = new ArrayList<>();\n+        commandCaptor = ArgumentCaptor.forClass((Class)List.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4MDEzOQ=="}, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTQzODExOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1OTo1N1rOHkEhrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwODo1OTo1N1rOHkEhrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU4NDk0MQ==", "bodyText": "Please add a comment on the buildJobConfig line to say that it's providing duplicate information as an interim measure while the C++ code is switched over from the old format to the new format.\nAlso maybe group the buildLimits, buildModelPlotConfig and buildFieldConfig lines together and add a comment to say that they will be removed once the C++ is just using the full job config.", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507584941", "createdAt": "2020-10-19T08:59:57Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilder.java", "diffHunk": "@@ -172,12 +177,14 @@ public AutodetectBuilder scheduledEvents(List<ScheduledEvent> scheduledEvents) {\n     public void build() throws IOException, InterruptedException {\n \n         List<String> command = buildAutodetectCommand();\n-\n         buildLimits(command);\n         buildModelPlotConfig(command);\n \n         buildQuantiles(command);\n         buildFieldConfig(command);\n+\n+        buildJobConfig(command);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 31}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3OTQ5OTgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToxNToyMFrOHkFHeg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xOVQwOToxNToyMFrOHkFHeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNzU5NDYxOA==", "bodyText": "The current assertion is relying on the way Java chooses to print a List.  This is more precise:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    String commandString = command.toString();\n          \n          \n            \n                    assertTrue(commandString.contains(\" --config=\"));\n          \n          \n            \n                    assertThat(command, hasItem(matchesPattern(\"--config=.*\\\\.json\")));\n          \n      \n    \n    \n  \n\nPlus you'll need extra imports to go with that.  IntelliJ should add them automatically but if not then add:\nimport static org.hamcrest.Matchers.hasItem;\nimport static org.hamcrest.Matchers.matchesPattern;", "url": "https://github.com/elastic/elasticsearch/pull/63865#discussion_r507594618", "createdAt": "2020-10-19T09:15:20Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectBuilderTests.java", "diffHunk": "@@ -126,4 +134,19 @@ public void testBuildAutodetectCommand_givenPersistModelState() {\n     private AutodetectBuilder autodetectBuilder(Job job) {\n         return new AutodetectBuilder(job, filesToDelete, logger, env, settings, nativeController, processPipes);\n     }\n+\n+    public void testBuildAutodetect() throws Exception {\n+        Job.Builder job = buildJobBuilder(\"unit-test-job\");\n+\n+        autodetectBuilder(job.build()).build();\n+\n+        assertThat(filesToDelete, hasSize(3));\n+\n+        verify(nativeController).startProcess(commandCaptor.capture());\n+        verifyNoMoreInteractions(nativeController);\n+\n+        List<String> command = commandCaptor.getValue();\n+        String commandString = command.toString();\n+        assertTrue(commandString.contains(\" --config=\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "36a6b3daa407f6d8f2abced90f13a38f6f5d6a37"}, "originalPosition": 53}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2840, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}