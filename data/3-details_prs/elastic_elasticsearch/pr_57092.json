{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIyMzgzMDMw", "number": 57092, "title": "Flatten ReleaseableBytesReference Object Trees", "bodyText": "When slicing a releasable bytes reference we would create a new counter\nevery time and pass the original reference chain to the new slice on every\nslice invocation. This would lead to extremely deep reference chains and\nneedlessly uses a dedicated counter for every slice when all the slices\neventually just refer to the same underlying bytes and Releasable.\nThis commit tracks the ref count wrapper with its releasable in a separate\nobject that can be passed around on every slicing, making the slices' tree\nas flat as the original releasable bytes reference.\nAlso, we were needlessly creating a redundant releasable bytes reference from\na releasable bytes-stream-output that we never actually used for releasing (all code\nthat uses it just releases the stream itself instead).\nSee e.g. the kind reference created by InboundPipeline when reading messages and repeatedly slicing:", "createdAt": "2020-05-24T08:47:40Z", "url": "https://github.com/elastic/elasticsearch/pull/57092", "merged": true, "mergeCommit": {"oid": "2787eadb1ac4b9064376afd5fbbfd4c5e89fe437"}, "closed": true, "closedAt": "2020-05-25T09:50:36Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABckXXU1gH2gAyNDIyMzgzMDMwOjVhOGIyMzgyMDAzNDQ5YTA2MDkxYzQwYTNhMzIyOTljM2Y1OTE0MGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcksDf6AH2gAyNDIyMzgzMDMwOmU3ZDQxOWNhM2RjYjUwOWM1ODU4MzgyZWE4MjNjYTliNzFmNDg0Mjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5a8b2382003449a06091c40a3a32299c3f59140a", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a8b2382003449a06091c40a3a32299c3f59140a", "committedDate": "2020-05-24T08:40:39Z", "message": "Flatten ReleaseableBytesReference Object Trees\n\nWhen slicing a releasable bytes reference we would create a new counter\nevery time and pass the original reference chain to the new slice on every\nslice invocation. This would lead to extremely deep reference chains and\nneedlessly uses a dedicated counter for every slice when all the slices\neventually just refer to the same underlying bytes and `Releasable`.\nThis commit tracks the ref count wrapper with its releasable in a separate\nobject that can be passed around on every slicing, making the slices' tree\nas flat as the original releasable bytes reference.\n\nAlso, we were needlessly creating a redundant releasable bytes reference from\na releasable bytes-stream-output that we never actually used for releasing (all code\nthat uses it just releases the stream itself instead)."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3NTUyMDE1", "url": "https://github.com/elastic/elasticsearch/pull/57092#pullrequestreview-417552015", "createdAt": "2020-05-25T08:37:48Z", "commit": {"oid": "5a8b2382003449a06091c40a3a32299c3f59140a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwODozNzo0OFrOGZ5ZTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNVQwODozNzo0OFrOGZ5ZTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyOTgwNzk0OQ==", "bodyText": "I would prefer to move this call to the private ReleasableBytesReference constructor.", "url": "https://github.com/elastic/elasticsearch/pull/57092#discussion_r429807949", "createdAt": "2020-05-25T08:37:48Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/common/bytes/ReleasableBytesReference.java", "diffHunk": "@@ -34,41 +33,44 @@\n  * An extension to {@link BytesReference} that requires releasing its content. This\n  * class exists to make it explicit when a bytes reference needs to be released, and when not.\n  */\n-public final class ReleasableBytesReference extends AbstractRefCounted implements Releasable, BytesReference {\n+public final class ReleasableBytesReference implements Releasable, BytesReference {\n \n     public static final Releasable NO_OP = () -> {};\n     private final BytesReference delegate;\n-    private final Releasable releasable;\n+    private final AbstractRefCounted refCounted;\n \n     public ReleasableBytesReference(BytesReference delegate, Releasable releasable) {\n-        super(\"bytes-reference\");\n         this.delegate = delegate;\n-        this.releasable = releasable;\n+        this.refCounted = new RefCountedReleasable(releasable);\n+    }\n+\n+    private ReleasableBytesReference(BytesReference delegate, AbstractRefCounted refCounted) {\n+        this.delegate = delegate;\n+        this.refCounted = refCounted;\n     }\n \n     public static ReleasableBytesReference wrap(BytesReference reference) {\n         return new ReleasableBytesReference(reference, NO_OP);\n     }\n \n-    @Override\n-    protected void closeInternal() {\n-        Releasables.close(releasable);\n+    public int refCount() {\n+        return refCounted.refCount();\n     }\n \n     public ReleasableBytesReference retain() {\n-        incRef();\n+        refCounted.incRef();\n         return this;\n     }\n \n     public ReleasableBytesReference retainedSlice(int from, int length) {\n         BytesReference slice = delegate.slice(from, length);\n-        incRef();\n-        return new ReleasableBytesReference(slice, this);\n+        refCounted.incRef();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a8b2382003449a06091c40a3a32299c3f59140a"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "483911044ce6319601fa98c6041d75b6963b58df", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/483911044ce6319601fa98c6041d75b6963b58df", "committedDate": "2020-05-25T08:41:30Z", "message": "Merge remote-tracking branch 'elastic/master' into flatten-releaseable-bytes-refs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7d419ca3dcb509c5858382ea823ca9b71f48427", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7d419ca3dcb509c5858382ea823ca9b71f48427", "committedDate": "2020-05-25T08:47:00Z", "message": "CR: increse ref elsewhere"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4237, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}