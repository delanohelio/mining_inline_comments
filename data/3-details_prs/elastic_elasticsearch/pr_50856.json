{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNDY5Mzk0", "number": 50856, "title": "Fix testSkipRefreshIfShardIsRefreshingAlready", "bodyText": "The test checked queue size and active count, however,\nThreadPoolExecutor pulls out the request from the queue before marking\nthe worker active, risking that we think all tasks are done when they\nare not. Now check on completed-tasks metric instead, which is\nguaranteed to be monotonic.\nRelates #50769\nGiven that the original issue has not yet been backported, this should likely be backported together with that.", "createdAt": "2020-01-10T14:15:15Z", "url": "https://github.com/elastic/elasticsearch/pull/50856", "merged": true, "mergeCommit": {"oid": "57518a0d9fe05617a1befd24d9b85f6b7c0d5922"}, "closed": true, "closedAt": "2020-01-10T16:29:01Z", "author": {"login": "henningandersen"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb4_L3WAH2gAyMzYxNDY5Mzk0OjY2YTZkZWU3MjFlYTNhNDM4YjhkNDM2NzM4YmY1YjEyZTBjNzcyOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4_ZkTAFqTM0MTE5MzYxNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "66a6dee721ea3a438b8d436738bf5b12e0c7729e", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/66a6dee721ea3a438b8d436738bf5b12e0c7729e", "committedDate": "2020-01-10T14:11:40Z", "message": "Fix testSkipRefreshIfShardIsRefreshingAlready\n\nThe test checked queue size and active count, however,\nThreadPoolExecutor pulls out the request from the queue before marking\nthe worker active, risking that we think all tasks are done when they\nare not. Now check on completed-tasks metric instead, which is\nguaranteed to be monotonic.\n\nRelates #50769"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b8867eba3c804db2852bed662c16248c5b0d79c", "author": {"user": {"login": "henningandersen", "name": "Henning Andersen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b8867eba3c804db2852bed662c16248c5b0d79c", "committedDate": "2020-01-10T14:14:34Z", "message": "Removed print statement."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQxMTkzNjE3", "url": "https://github.com/elastic/elasticsearch/pull/50856#pullrequestreview-341193617", "createdAt": "2020-01-10T14:25:13Z", "commit": {"oid": "66a6dee721ea3a438b8d436738bf5b12e0c7729e"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNDoyNToxNFrOFcVhtg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xMFQxNDoyNToxNFrOFcVhtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTI1NzE0Mg==", "bodyText": "I guess this is a leftover.", "url": "https://github.com/elastic/elasticsearch/pull/50856#discussion_r365257142", "createdAt": "2020-01-10T14:25:14Z", "author": {"login": "dnhatn"}, "path": "server/src/test/java/org/elasticsearch/indices/IndexingMemoryControllerTests.java", "diffHunk": "@@ -432,20 +432,20 @@ protected long getShardWritingBytes(IndexShard shard) {\n             }\n         };\n         int iterations = randomIntBetween(10, 100);\n+        ThreadPoolStats.Stats beforeStats = getRefreshThreadPoolStats();\n         for (int i = 0; i < iterations; i++) {\n             controller.forceCheck();\n         }\n         assertBusy(() -> {\n             ThreadPoolStats.Stats stats = getRefreshThreadPoolStats();\n-            assertThat(stats.getQueue(), equalTo(0));\n-            assertThat(stats.getActive(), equalTo(1));\n+            assertThat(stats.getCompleted(), equalTo(beforeStats.getCompleted() + iterations - 1));\n         });\n         refreshLatch.get().countDown(); // allow refresh\n         assertBusy(() -> {\n             ThreadPoolStats.Stats stats = getRefreshThreadPoolStats();\n-            assertThat(stats.getQueue(), equalTo(0));\n-            assertThat(stats.getActive(), equalTo(0));\n+            assertThat(stats.getCompleted(), equalTo(beforeStats.getCompleted() + iterations));\n         });\n+        System.out.println(shard.refreshStats().getTotal());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "66a6dee721ea3a438b8d436738bf5b12e0c7729e"}, "originalPosition": 21}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3771, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}