{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMzU0MDkx", "number": 51072, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTo1NDo0NlrODYckhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDowNTowOVrODYcxZw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2OTYwNTE3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/TransformMessages.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTo1NDo0NlrOFeTuuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQwOTo1NDo0NlrOFeTuuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyNDg1Ng==", "bodyText": "I wonder if we dangling is a bit vague here for users. Should we rephrase to Detected transforms [{0}] without matching configs?", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367324856", "createdAt": "2020-01-16T09:54:46Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/TransformMessages.java", "diffHunk": "@@ -17,6 +17,7 @@\n             \"Interrupted while waiting for transform [{0}] to stop\";\n     public static final String REST_PUT_TRANSFORM_EXISTS = \"Transform with id [{0}] already exists\";\n     public static final String REST_UNKNOWN_TRANSFORM = \"Transform with id [{0}] could not be found\";\n+    public static final String REST_STOP_TRANSFORM_WITHOUT_CONFIG = \"Detected dangling transforms [{0}]. Use force to stop/delete them.\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2OTYyNTU1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDowMDo1NFrOFeT7Cw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMjozNjoxNFrOFeX8tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ==", "bodyText": "Could transformId be \"foo-*\"? If yes, then this is not going to work.", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367328011", "createdAt": "2020-01-16T10:00:54Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -127,6 +134,25 @@ static void validateTaskState(ClusterState state, List<String> transformIds, boo\n         }\n     }\n \n+    static Tuple<Set<String>, Set<String>> findTasksWithoutConfig(ClusterState state, String transformId) {\n+        PersistentTasksCustomMetaData tasks = state.metaData().custom(PersistentTasksCustomMetaData.TYPE);\n+\n+        Set<String> taskIds = new HashSet<>();\n+        Set<String> executorNodes = new HashSet<>();\n+\n+        Predicate<PersistentTask<?>> taskMatcher = Strings.isAllOrWildcard(new String[] { transformId }) ? t -> true : t -> {\n+            TransformTaskParams transformParams = (TransformTaskParams) t.getParams();\n+            return transformParams.getId().equals(transformId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM4OTU5NQ==", "bodyText": "yes, that was my intention. In this situation I think you either have 1 transform that is broken or you want to rest everything. Supporting such patterns makes it very complicated and its dangerous, too.\nHowever, I will add a check and throw an exception if someone tries to call it with \"my_id*\".", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367389595", "createdAt": "2020-01-16T12:24:52Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -127,6 +134,25 @@ static void validateTaskState(ClusterState state, List<String> transformIds, boo\n         }\n     }\n \n+    static Tuple<Set<String>, Set<String>> findTasksWithoutConfig(ClusterState state, String transformId) {\n+        PersistentTasksCustomMetaData tasks = state.metaData().custom(PersistentTasksCustomMetaData.TYPE);\n+\n+        Set<String> taskIds = new HashSet<>();\n+        Set<String> executorNodes = new HashSet<>();\n+\n+        Predicate<PersistentTask<?>> taskMatcher = Strings.isAllOrWildcard(new String[] { transformId }) ? t -> true : t -> {\n+            TransformTaskParams transformParams = (TransformTaskParams) t.getParams();\n+            return transformParams.getId().equals(transformId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ=="}, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM5Mzk3NQ==", "bodyText": "hmm, this gets complicated. I changed my mind and will allow it.", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367393975", "createdAt": "2020-01-16T12:36:14Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -127,6 +134,25 @@ static void validateTaskState(ClusterState state, List<String> transformIds, boo\n         }\n     }\n \n+    static Tuple<Set<String>, Set<String>> findTasksWithoutConfig(ClusterState state, String transformId) {\n+        PersistentTasksCustomMetaData tasks = state.metaData().custom(PersistentTasksCustomMetaData.TYPE);\n+\n+        Set<String> taskIds = new HashSet<>();\n+        Set<String> executorNodes = new HashSet<>();\n+\n+        Predicate<PersistentTask<?>> taskMatcher = Strings.isAllOrWildcard(new String[] { transformId }) ? t -> true : t -> {\n+            TransformTaskParams transformParams = (TransformTaskParams) t.getParams();\n+            return transformParams.getId().equals(transformId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMyODAxMQ=="}, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI2OTYzODE1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDowNTowOVrOFeUDCg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDowNTowOVrOFeUDCg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzMzMDA1OA==", "bodyText": "Rename to runningTasksAndNodes? Just so it's clear what's what when we later get each part of the tuple.", "url": "https://github.com/elastic/elasticsearch/pull/51072#discussion_r367330058", "createdAt": "2020-01-16T10:05:09Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/action/TransportStopTransformAction.java", "diffHunk": "@@ -160,7 +186,31 @@ protected void doExecute(Task task, Request request, ActionListener<Response> li\n                     request.setExpandedIds(new HashSet<>(hitsAndIds.v2()));\n                     request.setNodes(TransformNodes.transformTaskNodes(hitsAndIds.v2(), state));\n                     super.doExecute(task, request, finalListener);\n-                }, listener::onFailure)\n+                }, e -> {\n+                    if (e instanceof ResourceNotFoundException) {\n+                        Tuple<Set<String>, Set<String>> runningTasks = findTasksWithoutConfig(state, request.getId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "77df1c75c3edcef04fe723e1266a82f3522efe5a"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4623, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}