{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5NzY0NjA3", "number": 64981, "title": "Add support for script-less runtime fields", "bodyText": "This commit adds the ability to specify a runtime field that fetches values\ndirectly from its corresponding position in _source.\nSource-only fields are defined in the runtime mappings by adding a field\nwith no 'script' parameter.  Fields that look into objects can be defined\nusing the usual dot notation.\n\"runtime\" : {\n    \"field\" : { \n        \"type\" : \"keyword\"\n    },\n    \"object.field\" : {\n        \"type\" : \"integer\"\n    }\n}", "createdAt": "2020-11-12T09:59:11Z", "url": "https://github.com/elastic/elasticsearch/pull/64981", "merged": true, "mergeCommit": {"oid": "082e2a6df531ca75cef899503287d673f4342da1"}, "closed": true, "closedAt": "2020-11-26T09:59:49Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 40, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbvJnhAH2gAyNTE5NzY0NjA3OmRjYTNjY2E3ZjlkNDEwODg4MDY1NDFhNGI3YzZhNTUwOTg1NDkyMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgPNssgH2gAyNTE5NzY0NjA3OmQyNjQxNzYwYTlkMmIzN2IwNjBhY2QxYzJjMjc4ZGVmMTI1YTg4ZjE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dca3cca7f9d41088806541a4b7c6a55098549207", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/dca3cca7f9d41088806541a4b7c6a55098549207", "committedDate": "2020-11-12T09:29:14Z", "message": "Examples of how to build source-only fields using runtime scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e330861ab089c2b51c29a925fb9ef10fcc4e843a", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/e330861ab089c2b51c29a925fb9ef10fcc4e843a", "committedDate": "2020-11-12T09:29:34Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MTI3Nzc0", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-529127774", "createdAt": "2020-11-12T14:16:45Z", "commit": {"oid": "e330861ab089c2b51c29a925fb9ef10fcc4e843a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNDoxNjo0NlrOHx8wmg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNDoxNjo0NlrOHx8wmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjEzNzc1NA==", "bodyText": "we already have a parse function for dates haven't we? Could we use it here?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r522137754", "createdAt": "2020-11-12T14:16:46Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/41_date_parsing.yml", "diffHunk": "@@ -0,0 +1,86 @@\n+---\n+setup:\n+  - do:\n+      indices.create:\n+        index: sensor\n+        body:\n+          settings:\n+            number_of_shards: 1\n+            number_of_replicas: 0\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+              temperature:\n+                type: long\n+              voltage:\n+                type: double\n+              node:\n+                type: keyword\n+              installed:\n+                type: runtime\n+                runtime_type: date\n+                script:\n+                  source: |\n+\n+                    long parseDate(Object obj) {\n+                      if (obj instanceof String) {\n+                        DateFormatter formatter = DateFormatter.forPattern(\"yyyy-MM-dd\");\n+                        return formatter.parseMillis((String)obj);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e330861ab089c2b51c29a925fb9ef10fcc4e843a"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI5MjM5MDg2", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-529239086", "createdAt": "2020-11-12T16:02:47Z", "commit": {"oid": "e330861ab089c2b51c29a925fb9ef10fcc4e843a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNjowMjo0N1rOHyBz6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQxNjowMjo0N1rOHyBz6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjIyMDUyMA==", "bodyText": "i think it'd be nice to handle a field at, say, sensor.output.voltage or something. So we can make sure we handle when sensor is an object or when it is an array. Or when output is an object or an array. I'm not familiar with what we do in the normal mapping when someone sends a field named sensor.output.voltage too. Or an object fields named sensor.output with a voltage field inside it. I think \"source only\" fields, however we build them, should handle all of those cases in the same way as the parsing infra.", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r522220520", "createdAt": "2020-11-12T16:02:47Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/61_boolean_parsing.yml", "diffHunk": "@@ -0,0 +1,93 @@\n+---\n+setup:\n+  - do:\n+      indices.create:\n+        index: sensor\n+        body:\n+          settings:\n+            number_of_shards: 1\n+            number_of_replicas: 0\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+              temperature:\n+                type: long\n+              voltage:\n+                type: double\n+              node:\n+                type: keyword\n+              active:\n+                type: runtime\n+                runtime_type: boolean\n+                script:\n+                  source: |\n+\n+                    boolean parseBoolean(Object obj) {\n+                      if (obj instanceof Boolean) {\n+                        return (Boolean) obj;\n+                      }\n+                      if (obj instanceof String) {\n+                        return Booleans.parseBoolean((String)obj);\n+                      }\n+                      throw new IllegalArgumentException();\n+                    }\n+\n+                    def vs = params._source.active;\n+                    if (vs instanceof List) {\n+                      for (def v : vs) {\n+                        try {\n+                          emit(parseBoolean(v));\n+                        }\n+                        catch (IllegalArgumentException e) {\n+                           // do nothing\n+                        }\n+                      }\n+                    }\n+                    else {\n+                      try {\n+                        emit(parseBoolean(vs));\n+                      }\n+                      catch (IllegalArgumentException e) {\n+                        // do nothing\n+                      }\n+                    }\n+\n+\n+\n+  - do:\n+      bulk:\n+        index: sensor\n+        refresh: true\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\": 1516729294000, \"temperature\": 200, \"voltage\": 5.2, \"node\": \"a\", \"active\" : true }\n+          {\"index\":{}}\n+          {\"timestamp\": 1516642894000, \"temperature\": 201, \"voltage\": 5.8, \"node\": \"b\", \"active\" : [ true ] }\n+          {\"index\":{}}\n+          {\"timestamp\": 1516556494000, \"temperature\": 202, \"voltage\": 5.1, \"node\": \"a\", \"active\" : [ false, \"false\", true ] }\n+          {\"index\":{}}\n+          {\"timestamp\": 1516470094000, \"temperature\": 198, \"voltage\": 5.6, \"node\": \"b\", \"active\" : \"wibble\" }\n+          {\"index\":{}}\n+          {\"timestamp\": 1516383694000, \"temperature\": 200, \"voltage\": 4.2, \"node\": \"c\", \"active\" : [ 9, true, \"manglewurzle\" ] }\n+          {\"index\":{}}\n+          {\"timestamp\": 1516297294000, \"temperature\": 202, \"voltage\": 4.0, \"node\": \"c\", \"active\" : \"false\" }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e330861ab089c2b51c29a925fb9ef10fcc4e843a"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd12224c78830f0b19fd625e2e2e006c1437295b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd12224c78830f0b19fd625e2e2e006c1437295b", "committedDate": "2020-11-17T10:41:07Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f2ee0ad041d74178e269312f866d44f8084ffc4", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f2ee0ad041d74178e269312f866d44f8084ffc4", "committedDate": "2020-11-17T11:36:08Z", "message": "Simplify booleans"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfab592acb2043278815f49a4626501035026bb0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfab592acb2043278815f49a4626501035026bb0", "committedDate": "2020-11-17T14:00:19Z", "message": "test objects"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0516000e38bb65e947b547a8898c82c24f840130", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0516000e38bb65e947b547a8898c82c24f840130", "committedDate": "2020-11-17T14:11:49Z", "message": "keywords"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3381d380cd8beb7c18ee55430693a2137ffc5ae6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/3381d380cd8beb7c18ee55430693a2137ffc5ae6", "committedDate": "2020-11-17T14:19:22Z", "message": "longs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fe918f25b89c525bb4398e12a501ab5075867b87", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe918f25b89c525bb4398e12a501ab5075867b87", "committedDate": "2020-11-17T14:25:53Z", "message": "doubles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d05373d9b60e1eb882c1ea104798252dc0cb7fd", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d05373d9b60e1eb882c1ea104798252dc0cb7fd", "committedDate": "2020-11-17T14:33:27Z", "message": "dates"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ed3ee6a3e26cf4374d7957eb856bcfe4152d055", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ed3ee6a3e26cf4374d7957eb856bcfe4152d055", "committedDate": "2020-11-17T14:43:46Z", "message": "ips"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "61599db916648683fecd24b6c4831c7fd55ef197", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/61599db916648683fecd24b6c4831c7fd55ef197", "committedDate": "2020-11-17T16:30:48Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04e08092e1aedeeb844761fef20c82d0e55e481d", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/04e08092e1aedeeb844761fef20c82d0e55e481d", "committedDate": "2020-11-18T11:26:32Z", "message": "emitValues for keyword script fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e76eaedffce68cf7c8d2d6fa1356b8d0e6124065", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/e76eaedffce68cf7c8d2d6fa1356b8d0e6124065", "committedDate": "2020-11-23T17:19:35Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b2ef188cab24ddf4535a25906bd4583ba505e0", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/35b2ef188cab24ddf4535a25906bd4583ba505e0", "committedDate": "2020-11-24T10:31:25Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4fecb3611477dbcbb3238f525c0be739d4d988a7", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/4fecb3611477dbcbb3238f525c0be739d4d988a7", "committedDate": "2020-11-24T12:28:18Z", "message": "Go to source if no script specified for a runtime field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b1e2ab95a991bde9d478ce50a7c6df64966516", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2b1e2ab95a991bde9d478ce50a7c6df64966516", "committedDate": "2020-11-24T12:28:22Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e8d7a667a08b40dc73d913ed396011594f9c90c", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e8d7a667a08b40dc73d913ed396011594f9c90c", "committedDate": "2020-11-24T12:39:51Z", "message": "precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7f5693a34f00bb30fc070211029091f7aea1cd4", "committedDate": "2020-11-24T13:39:24Z", "message": "Remove no-script test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTI5MDk0", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537529094", "createdAt": "2020-11-24T14:11:55Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoxMTo1NVrOH5Comg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoxMTo1NVrOH5Comg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU3NDA0Mg==", "bodyText": "Just a though, a bit controversial I reckon: although we are not documenting emitValues, I wonder if it's worth iterating on it and making it closer to what we will need in the long run. I see that the function is context dependent in how it extracts values from source. Would it make sense to instead have parse* functions that are independent of the context and can potentially be used in any context? I would be ok even if the default script loops over the returned values.", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529574042", "createdAt": "2020-11-24T14:11:55Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptFieldType.java", "diffHunk": "@@ -239,6 +235,10 @@ protected final void doXContentBody(XContentBuilder builder, boolean includeDefa\n \n         protected abstract AbstractScriptFieldType<?> buildFieldType();\n \n+        protected final Script defaultScript() {\n+            return new Script(\"emitValues(\\\"\" + name + \"\\\")\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTMxNDQ0", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537531444", "createdAt": "2020-11-24T14:14:19Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoxNDoxOVrOH5CvgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoxNDoxOVrOH5CvgA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU3NTgwOA==", "bodyText": "what exception may we get here? IllegalArgumentException because the value is neither \"true\" nor \"false\"?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529575808", "createdAt": "2020-11-24T14:14:19Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/BooleanFieldScript.java", "diffHunk": "@@ -84,4 +86,26 @@ public void value(boolean v) {\n             script.emit(v);\n         }\n     }\n+\n+    public static class EmitValues {\n+        private final BooleanFieldScript script;\n+\n+        public EmitValues(BooleanFieldScript script) {\n+            this.script = script;\n+        }\n+\n+        public void emitFromPath(String path) {\n+            for (Object v : script.extractFromSource(path)) {\n+                if (v instanceof Boolean) {\n+                    script.emit((Boolean) v);\n+                } else if (v instanceof String) {\n+                    try {\n+                        script.emit(Booleans.parseBoolean((String) v));\n+                    } catch (Exception e) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjQ2MTI4", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537646128", "createdAt": "2020-11-24T15:45:00Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0NTowMFrOH5H1CA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0NTowMFrOH5H1CA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1OTE0NA==", "bodyText": "Can we add a comment to make it clear that this is temporary and only exposed through script-less runtime fields, undocumented on purpose?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529659144", "createdAt": "2020-11-24T15:45:00Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/BooleanFieldScript.java", "diffHunk": "@@ -84,4 +86,26 @@ public void value(boolean v) {\n             script.emit(v);\n         }\n     }\n+\n+    public static class EmitValues {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjQ3NDIy", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537647422", "createdAt": "2020-11-24T15:46:17Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0NjoxN1rOH5H8Jg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0NjoxN1rOH5H8Jg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2MDk2Ng==", "bodyText": "shall we call these new test files differently e.g. source_only_keywords ?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529660966", "createdAt": "2020-11-24T15:46:17Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/src/test/resources/rest-api-spec/test/runtime_fields/11_keyword_parsing.yml", "diffHunk": "@@ -0,0 +1,71 @@\n+---", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 1}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjUwMTI0", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537650124", "createdAt": "2020-11-24T15:49:06Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0OTowNlrOH5ILEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo0OTowNlrOH5ILEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2NDc4NA==", "bodyText": "why not casting to string at this point?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529664784", "createdAt": "2020-11-24T15:49:06Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/IpFieldScript.java", "diffHunk": "@@ -111,4 +114,24 @@ public void emit(String v) {\n             script.emit(v);\n         }\n     }\n+\n+    public static class EmitValues {\n+        private final IpFieldScript script;\n+\n+        public EmitValues(IpFieldScript script) {\n+            this.script = script;\n+        }\n+\n+        public void emitFromPath(String path) {\n+            for (Object v : script.extractFromSource(path)) {\n+                if (v instanceof String) {\n+                    try {\n+                        script.emit(v.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 28}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjU0MDg2", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537654086", "createdAt": "2020-11-24T15:52:59Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo1Mjo1OVrOH5Ig1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTo1Mjo1OVrOH5Ig1A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY3MDM1Ng==", "bodyText": "does this mean that we can remove the parse function from the date context @nik9000 ?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529670356", "createdAt": "2020-11-24T15:52:59Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/DateFieldScript.java", "diffHunk": "@@ -75,4 +75,24 @@ public long parse(Object str) {\n             return script.formatter.parseMillis(str.toString());\n         }\n     }\n+\n+    public static class EmitValues {\n+        private final DateFieldScript script;\n+\n+        public EmitValues(DateFieldScript script) {\n+            this.script = script;\n+        }\n+\n+        public void emitFromPath(String path) {\n+            for (Object v : script.extractFromSource(path)) {\n+                if (v instanceof String) {\n+                    try {\n+                        script.emit(script.formatter.parseMillis((String) v));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3Nzg1ODMw", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-537785830", "createdAt": "2020-11-24T18:17:09Z", "commit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODoxNzoxMFrOH5Pcjw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxODoxOToxM1rOH5Ph7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4Mzk1MQ==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529783951", "createdAt": "2020-11-24T18:17:10Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/BooleanFieldScript.java", "diffHunk": "@@ -84,4 +86,26 @@ public void value(boolean v) {\n             script.emit(v);\n         }\n     }\n+\n+    public static class EmitValues {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1OTE0NA=="}, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4NDkwNA==", "bodyText": "May as well cast if you've already instaceofed", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529784904", "createdAt": "2020-11-24T18:18:38Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/IpFieldScript.java", "diffHunk": "@@ -111,4 +114,24 @@ public void emit(String v) {\n             script.emit(v);\n         }\n     }\n+\n+    public static class EmitValues {\n+        private final IpFieldScript script;\n+\n+        public EmitValues(IpFieldScript script) {\n+            this.script = script;\n+        }\n+\n+        public void emitFromPath(String path) {\n+            for (Object v : script.extractFromSource(path)) {\n+                if (v instanceof String) {\n+                    try {\n+                        script.emit(v.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY2NDc4NA=="}, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTc4NTMyNA==", "bodyText": "I think this needs updating and a note that it is teporary.", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r529785324", "createdAt": "2020-11-24T18:19:13Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/resources/org/elasticsearch/xpack/runtimefields/mapper/boolean_whitelist.txt", "diffHunk": "@@ -15,5 +15,7 @@ class org.elasticsearch.xpack.runtimefields.mapper.BooleanFieldScript$Factory @n\n static_import {\n     # The `emit` callback to collect values for the field\n     void emit(org.elasticsearch.xpack.runtimefields.mapper.BooleanFieldScript, boolean) bound_to org.elasticsearch.xpack.runtimefields.mapper.BooleanFieldScript$Emit\n+    # The `values` callback to find values for the field in the source", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a7f5693a34f00bb30fc070211029091f7aea1cd4"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e465b9bff6112a8d29f4c5b830b4783415ec311", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e465b9bff6112a8d29f4c5b830b4783415ec311", "committedDate": "2020-11-25T12:30:04Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f41911847e07b6b0f9a5b652a3e634e813a88941", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/f41911847e07b6b0f9a5b652a3e634e813a88941", "committedDate": "2020-11-25T14:01:17Z", "message": "implement as native scripts"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "edabd56adbb8b6396537b4a836919f4e5da88f38", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/edabd56adbb8b6396537b4a836919f4e5da88f38", "committedDate": "2020-11-25T14:07:52Z", "message": "spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NTYzNzgy", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-538563782", "createdAt": "2020-11-25T14:38:23Z", "commit": {"oid": "edabd56adbb8b6396537b4a836919f4e5da88f38"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDozODoyM1rOH52Vmw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNDo0MDoyOVrOH52bkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMTE0Nw==", "bodyText": "this is no longer needed right?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530421147", "createdAt": "2020-11-25T14:38:23Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/DateFieldScript.java", "diffHunk": "@@ -75,4 +96,24 @@ public long parse(Object str) {\n             return script.formatter.parseMillis(str.toString());\n         }\n     }\n+\n+    public static class EmitValues {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edabd56adbb8b6396537b4a836919f4e5da88f38"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMTk2NA==", "bodyText": "let's remove the parse function that's exposed for dates?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530421964", "createdAt": "2020-11-25T14:39:28Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/DateFieldScript.java", "diffHunk": "@@ -35,6 +35,27 @@\n         DateFieldScript newInstance(LeafReaderContext ctx);\n     }\n \n+    public static final Factory PARSE_FROM_SOURCE = (field, params, lookup, formatter) -> (LeafFactory) ctx -> new DateFieldScript(\n+        field,\n+        params,\n+        lookup,\n+        formatter,\n+        ctx\n+    ) {\n+        @Override\n+        public void execute() {\n+            for (Object v : extractFromSource(field)) {\n+                if (v instanceof String) {\n+                    try {\n+                        emit(formatter.parseMillis((String) v));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edabd56adbb8b6396537b4a836919f4e5da88f38"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQyMjY3NQ==", "bodyText": "was this missing?", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530422675", "createdAt": "2020-11-25T14:40:29Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/resources/org/elasticsearch/xpack/runtimefields/mapper/ip_whitelist.txt", "diffHunk": "@@ -12,6 +12,9 @@ class org.elasticsearch.xpack.runtimefields.mapper.IpFieldScript @no_import {\n class org.elasticsearch.xpack.runtimefields.mapper.IpFieldScript$Factory @no_import {\n }\n \n+class java.net.InetAddress {\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "edabd56adbb8b6396537b4a836919f4e5da88f38"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "065cbbb198602b5bac51f34c40baee0b9b912401", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/065cbbb198602b5bac51f34c40baee0b9b912401", "committedDate": "2020-11-25T14:50:31Z", "message": "leftovers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a139edd228e8a5bdb76cbe686e2027230082a467", "committedDate": "2020-11-25T14:57:00Z", "message": "Remove date Parse function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NTg1ODg1", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-538585885", "createdAt": "2020-11-25T15:00:21Z", "commit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTowMDoyMVrOH53U-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTowMDoyMVrOH53U-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQzNzM3MA==", "bodyText": "Oh this is tricky! Could we use null here instead? I'm not a big of making a Script that no one can compile. It'll have stuff like engine=painless which is isn't.", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530437370", "createdAt": "2020-11-25T15:00:21Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/AbstractScriptFieldType.java", "diffHunk": "@@ -206,6 +206,9 @@ protected final void doXContentBody(XContentBuilder builder, boolean includeDefa\n         toXContent.accept(builder, includeDefaults);\n     }\n \n+    // Placeholder Script for source-only fields\n+    private static final Script DEFAULT_SCRIPT = new Script(\"\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4NjMxOTg4", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-538631988", "createdAt": "2020-11-25T15:48:36Z", "commit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0ODozNlrOH55dxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQxNTo0ODozNlrOH55dxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3MjM4OA==", "bodyText": "do we need to check for the result of toString? emit(null) will cause an error and we are not catching exceptions here", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530472388", "createdAt": "2020-11-25T15:48:36Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/StringFieldScript.java", "diffHunk": "@@ -41,6 +41,22 @@\n         StringFieldScript newInstance(LeafReaderContext ctx);\n     }\n \n+    public static final Factory PARSE_FROM_SOURCE = (field, params, lookup) -> (LeafFactory) ctx -> new StringFieldScript(\n+        field,\n+        params,\n+        lookup,\n+        ctx\n+    ) {\n+        @Override\n+        public void execute() {\n+            for (Object v : extractFromSource(field)) {\n+                if (v != null) {\n+                    emit(v.toString());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "68a00c4c3e48e857ffa27ef41e3e34d9c4e1f19b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/68a00c4c3e48e857ffa27ef41e3e34d9c4e1f19b", "committedDate": "2020-11-25T17:02:31Z", "message": "Revert \"Remove date Parse function\"\n\nThis reverts commit a139edd228e8a5bdb76cbe686e2027230082a467."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODAzNDk4", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-538803498", "createdAt": "2020-11-25T19:46:22Z", "commit": {"oid": "68a00c4c3e48e857ffa27ef41e3e34d9c4e1f19b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM4ODIwOTUz", "url": "https://github.com/elastic/elasticsearch/pull/64981#pullrequestreview-538820953", "createdAt": "2020-11-25T20:18:02Z", "commit": {"oid": "68a00c4c3e48e857ffa27ef41e3e34d9c4e1f19b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMDoxODowMlrOH6CnDQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNVQyMDoxODowMlrOH6CnDQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDYyMjIyMQ==", "bodyText": "If toString returns null we're in a sad place.", "url": "https://github.com/elastic/elasticsearch/pull/64981#discussion_r530622221", "createdAt": "2020-11-25T20:18:02Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/StringFieldScript.java", "diffHunk": "@@ -41,6 +41,22 @@\n         StringFieldScript newInstance(LeafReaderContext ctx);\n     }\n \n+    public static final Factory PARSE_FROM_SOURCE = (field, params, lookup) -> (LeafFactory) ctx -> new StringFieldScript(\n+        field,\n+        params,\n+        lookup,\n+        ctx\n+    ) {\n+        @Override\n+        public void execute() {\n+            for (Object v : extractFromSource(field)) {\n+                if (v != null) {\n+                    emit(v.toString());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMDQ3MjM4OA=="}, "originalCommit": {"oid": "a139edd228e8a5bdb76cbe686e2027230082a467"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394634f47cc4372ad2a4ee5557e443d7742cdbcb", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/394634f47cc4372ad2a4ee5557e443d7742cdbcb", "committedDate": "2020-11-26T09:05:18Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/parse-functions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2641760a9d2b37b060acd1c2c278def125a88f1", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2641760a9d2b37b060acd1c2c278def125a88f1", "committedDate": "2020-11-26T09:06:21Z", "message": "Add TODO"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1055, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}