{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxODk3NTU0", "number": 65832, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoxNTozM1rOFBs3TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoyOToxM1rOFBtQHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzI3OTQ4OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/AntFixtureStop.groovy", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoxNTozM1rOIAfa5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1NTowOVrOIBQ0Rw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NTcwMg==", "bodyText": "My Groovy knowledge is weak - does this result in a lazily-evaluated string that returns a PID?", "url": "https://github.com/elastic/elasticsearch/pull/65832#discussion_r537385702", "createdAt": "2020-12-07T10:15:33Z", "author": {"login": "pugnascotia"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/AntFixtureStop.groovy", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle\n+\n+import org.apache.tools.ant.taskdefs.condition.Os\n+import org.elasticsearch.gradle.test.AntFixture\n+import org.gradle.api.file.FileSystemOperations\n+import org.gradle.api.tasks.Internal\n+\n+import javax.inject.Inject\n+\n+class AntFixtureStop extends LoggedExec implements FixtureStop {\n+\n+    @Internal\n+    AntFixture fixture\n+\n+    @Internal\n+    FileSystemOperations fileSystemOperations\n+\n+    @Inject\n+    AntFixtureStop(FileSystemOperations fileSystemOperations) {\n+        super(fileSystemOperations)\n+        this.fileSystemOperations = fileSystemOperations\n+    }\n+\n+    void setFixture(AntFixture fixture) {\n+        assert this.fixture == null\n+        this.fixture = fixture;\n+        final Object pid = \"${ -> this.fixture.pid }\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39c67ec7126477ed6f7d1ac8fb3796311dde03af"}, "originalPosition": 46}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5NTAxNQ==", "bodyText": "exactly. Ultimately we want these tasks to be java and not rely on those groovy \"hacks\", but porting AntFixture requires a bit more work to remove the ant bit.", "url": "https://github.com/elastic/elasticsearch/pull/65832#discussion_r538195015", "createdAt": "2020-12-08T09:55:09Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/AntFixtureStop.groovy", "diffHunk": "@@ -0,0 +1,66 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle\n+\n+import org.apache.tools.ant.taskdefs.condition.Os\n+import org.elasticsearch.gradle.test.AntFixture\n+import org.gradle.api.file.FileSystemOperations\n+import org.gradle.api.tasks.Internal\n+\n+import javax.inject.Inject\n+\n+class AntFixtureStop extends LoggedExec implements FixtureStop {\n+\n+    @Internal\n+    AntFixture fixture\n+\n+    @Internal\n+    FileSystemOperations fileSystemOperations\n+\n+    @Inject\n+    AntFixtureStop(FileSystemOperations fileSystemOperations) {\n+        super(fileSystemOperations)\n+        this.fileSystemOperations = fileSystemOperations\n+    }\n+\n+    void setFixture(AntFixture fixture) {\n+        assert this.fixture == null\n+        this.fixture = fixture;\n+        final Object pid = \"${ -> this.fixture.pid }\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM4NTcwMg=="}, "originalCommit": {"oid": "39c67ec7126477ed6f7d1ac8fb3796311dde03af"}, "originalPosition": 46}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzM3MzM0MzAyOnYy", "diffSide": "RIGHT", "path": "plugins/discovery-ec2/qa/amazon-ec2/build.gradle", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMDoyOToxM1rOIAf_WA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOFQwOTo1MzozMlrOIBQvpA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5NTAzMg==", "bodyText": "Does your editor not insert a trailing newline?", "url": "https://github.com/elastic/elasticsearch/pull/65832#discussion_r537395032", "createdAt": "2020-12-07T10:29:13Z", "author": {"login": "pugnascotia"}, "path": "plugins/discovery-ec2/qa/amazon-ec2/build.gradle", "diffHunk": "@@ -64,61 +66,66 @@ yamlRestTest.enabled = false\n  * custom Java security policy to work.\n  */\n ['KeyStore', 'EnvVariables', 'SystemProperties', 'ContainerCredentials', 'InstanceProfile'].forEach { action ->\n-  AntFixture fixture = tasks.create(name: \"ec2Fixture${action}\", type: AntFixture) {\n+  TaskProvider<AntFixture> fixture = tasks.register(\"ec2Fixture${action}\", AntFixture) {\n     dependsOn project.sourceSets.yamlRestTest.runtimeClasspath\n     env 'CLASSPATH', \"${-> project.sourceSets.yamlRestTest.runtimeClasspath.asPath}\"\n     executable = \"${BuildParams.runtimeJavaHome}/bin/java\"\n     args 'org.elasticsearch.discovery.ec2.AmazonEC2Fixture', baseDir, \"${buildDir}/testclusters/yamlRestTest${action}-1/config/unicast_hosts.txt\"\n   }\n \n-  tasks.create(name: \"yamlRestTest${action}\", type: RestIntegTestTask) {\n+  def yamlRestTestTask = tasks.register(\"yamlRestTest${action}\", RestIntegTestTask) {\n     dependsOn fixture\n+    SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+    SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n+    testClassesDirs = yamlRestTestSourceSet.getOutput().getClassesDirs()\n+    classpath = yamlRestTestSourceSet.getRuntimeClasspath()\n   }\n-  SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n-  SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n-  \"yamlRestTest${action}\" {\n-    setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n-    setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n+\n+  tasks.named(\"check\").configure {\n+    dependsOn(yamlRestTestTask)\n   }\n-  check.dependsOn(\"yamlRestTest${action}\")\n \n-  testClusters.\"yamlRestTest${action}\" {\n+  testClusters.matching { it.name == yamlRestTestTask.name}.configureEach {\n     numberOfNodes = ec2NumberOfNodes\n     plugin ':plugins:discovery-ec2'\n \n     setting 'discovery.seed_providers', 'ec2'\n     setting 'network.host', '_ec2_'\n-    setting 'discovery.ec2.endpoint', { \"http://${-> fixture.addressAndPort}\" }, IGNORE_VALUE\n+    setting 'discovery.ec2.endpoint', { \"http://${-> fixture.get().addressAndPort}\" }, IGNORE_VALUE\n \n-    systemProperty \"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\", { \"http://${-> fixture.addressAndPort}\" }, IGNORE_VALUE\n+    systemProperty \"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\", { \"http://${-> fixture.get().addressAndPort}\" }, IGNORE_VALUE\n   }\n }\n \n // Extra config for KeyStore\n-testClusters.yamlRestTestKeyStore {\n+testClusters.matching { it.name == \"yamlRestTestKeyStore\" }.configureEach {\n   keystore 'discovery.ec2.access_key', 'ec2_integration_test_access_key'\n   keystore 'discovery.ec2.secret_key', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for EnvVariables\n-testClusters.yamlRestTestEnvVariables {\n+testClusters.matching { it.name == \"yamlRestTestEnvVariables\" }.configureEach {\n   environment 'AWS_ACCESS_KEY_ID', 'ec2_integration_test_access_key'\n   environment 'AWS_SECRET_ACCESS_KEY', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for SystemProperties\n-testClusters.yamlRestTestSystemProperties {\n+testClusters.matching { it.name == \"yamlRestTestSystemProperties\" }.configureEach {\n   systemProperty 'aws.accessKeyId', 'ec2_integration_test_access_key'\n   systemProperty 'aws.secretKey', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for ContainerCredentials\n-ec2FixtureContainerCredentials.env 'ACTIVATE_CONTAINER_CREDENTIALS', true\n+tasks.named(\"ec2FixtureContainerCredentials\").configure {\n+  env 'ACTIVATE_CONTAINER_CREDENTIALS', true\n+}\n \n-testClusters.yamlRestTestContainerCredentials {\n+testClusters.matching { it.name == \"yamlRestTestContainerCredentials\" }.configureEach {\n   environment 'AWS_CONTAINER_CREDENTIALS_FULL_URI',\n     { \"http://${-> tasks.findByName(\"ec2FixtureContainerCredentials\").addressAndPort}/ecs_credentials_endpoint\" }, IGNORE_VALUE\n }\n \n // Extra config for InstanceProfile\n-ec2FixtureInstanceProfile.env 'ACTIVATE_INSTANCE_PROFILE', true\n+tasks.named(\"ec2FixtureInstanceProfile\").configure {\n+  env 'ACTIVATE_INSTANCE_PROFILE', true\n+}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39c67ec7126477ed6f7d1ac8fb3796311dde03af"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzODE5MzgyOA==", "bodyText": "nope. should it?", "url": "https://github.com/elastic/elasticsearch/pull/65832#discussion_r538193828", "createdAt": "2020-12-08T09:53:32Z", "author": {"login": "breskeby"}, "path": "plugins/discovery-ec2/qa/amazon-ec2/build.gradle", "diffHunk": "@@ -64,61 +66,66 @@ yamlRestTest.enabled = false\n  * custom Java security policy to work.\n  */\n ['KeyStore', 'EnvVariables', 'SystemProperties', 'ContainerCredentials', 'InstanceProfile'].forEach { action ->\n-  AntFixture fixture = tasks.create(name: \"ec2Fixture${action}\", type: AntFixture) {\n+  TaskProvider<AntFixture> fixture = tasks.register(\"ec2Fixture${action}\", AntFixture) {\n     dependsOn project.sourceSets.yamlRestTest.runtimeClasspath\n     env 'CLASSPATH', \"${-> project.sourceSets.yamlRestTest.runtimeClasspath.asPath}\"\n     executable = \"${BuildParams.runtimeJavaHome}/bin/java\"\n     args 'org.elasticsearch.discovery.ec2.AmazonEC2Fixture', baseDir, \"${buildDir}/testclusters/yamlRestTest${action}-1/config/unicast_hosts.txt\"\n   }\n \n-  tasks.create(name: \"yamlRestTest${action}\", type: RestIntegTestTask) {\n+  def yamlRestTestTask = tasks.register(\"yamlRestTest${action}\", RestIntegTestTask) {\n     dependsOn fixture\n+    SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n+    SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n+    testClassesDirs = yamlRestTestSourceSet.getOutput().getClassesDirs()\n+    classpath = yamlRestTestSourceSet.getRuntimeClasspath()\n   }\n-  SourceSetContainer sourceSets = project.getExtensions().getByType(SourceSetContainer.class);\n-  SourceSet yamlRestTestSourceSet = sourceSets.getByName(YamlRestTestPlugin.SOURCE_SET_NAME)\n-  \"yamlRestTest${action}\" {\n-    setTestClassesDirs(yamlRestTestSourceSet.getOutput().getClassesDirs())\n-    setClasspath(yamlRestTestSourceSet.getRuntimeClasspath())\n+\n+  tasks.named(\"check\").configure {\n+    dependsOn(yamlRestTestTask)\n   }\n-  check.dependsOn(\"yamlRestTest${action}\")\n \n-  testClusters.\"yamlRestTest${action}\" {\n+  testClusters.matching { it.name == yamlRestTestTask.name}.configureEach {\n     numberOfNodes = ec2NumberOfNodes\n     plugin ':plugins:discovery-ec2'\n \n     setting 'discovery.seed_providers', 'ec2'\n     setting 'network.host', '_ec2_'\n-    setting 'discovery.ec2.endpoint', { \"http://${-> fixture.addressAndPort}\" }, IGNORE_VALUE\n+    setting 'discovery.ec2.endpoint', { \"http://${-> fixture.get().addressAndPort}\" }, IGNORE_VALUE\n \n-    systemProperty \"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\", { \"http://${-> fixture.addressAndPort}\" }, IGNORE_VALUE\n+    systemProperty \"com.amazonaws.sdk.ec2MetadataServiceEndpointOverride\", { \"http://${-> fixture.get().addressAndPort}\" }, IGNORE_VALUE\n   }\n }\n \n // Extra config for KeyStore\n-testClusters.yamlRestTestKeyStore {\n+testClusters.matching { it.name == \"yamlRestTestKeyStore\" }.configureEach {\n   keystore 'discovery.ec2.access_key', 'ec2_integration_test_access_key'\n   keystore 'discovery.ec2.secret_key', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for EnvVariables\n-testClusters.yamlRestTestEnvVariables {\n+testClusters.matching { it.name == \"yamlRestTestEnvVariables\" }.configureEach {\n   environment 'AWS_ACCESS_KEY_ID', 'ec2_integration_test_access_key'\n   environment 'AWS_SECRET_ACCESS_KEY', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for SystemProperties\n-testClusters.yamlRestTestSystemProperties {\n+testClusters.matching { it.name == \"yamlRestTestSystemProperties\" }.configureEach {\n   systemProperty 'aws.accessKeyId', 'ec2_integration_test_access_key'\n   systemProperty 'aws.secretKey', 'ec2_integration_test_secret_key'\n }\n \n // Extra config for ContainerCredentials\n-ec2FixtureContainerCredentials.env 'ACTIVATE_CONTAINER_CREDENTIALS', true\n+tasks.named(\"ec2FixtureContainerCredentials\").configure {\n+  env 'ACTIVATE_CONTAINER_CREDENTIALS', true\n+}\n \n-testClusters.yamlRestTestContainerCredentials {\n+testClusters.matching { it.name == \"yamlRestTestContainerCredentials\" }.configureEach {\n   environment 'AWS_CONTAINER_CREDENTIALS_FULL_URI',\n     { \"http://${-> tasks.findByName(\"ec2FixtureContainerCredentials\").addressAndPort}/ecs_credentials_endpoint\" }, IGNORE_VALUE\n }\n \n // Extra config for InstanceProfile\n-ec2FixtureInstanceProfile.env 'ACTIVATE_INSTANCE_PROFILE', true\n+tasks.named(\"ec2FixtureInstanceProfile\").configure {\n+  env 'ACTIVATE_INSTANCE_PROFILE', true\n+}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzM5NTAzMg=="}, "originalCommit": {"oid": "39c67ec7126477ed6f7d1ac8fb3796311dde03af"}, "originalPosition": 101}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1844, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}