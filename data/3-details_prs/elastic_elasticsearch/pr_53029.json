{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgyNTY3NTU2", "number": 53029, "title": "[ML] Fix minor race condition in dataframe analytics _stop", "bodyText": "Tests have been periodically failing due to a race condition on checking a recently STOPPED task's state. The .ml-state index is not created until the task has already been transitioned to STARTED. This allows the _start API call to return. But, if a user (or test) immediately attempts to _stop that job, the job could stop and the task removed BEFORE the .ml-state|stats indices are created/updated.\nThis change moves towards the task cleaning up itself in its main execution thread. stop flips the flag of the task to isStopping and now we check isStopping at every necessary method. Allowing the task to gracefully stop.\ncloses #53007", "createdAt": "2020-03-02T19:34:32Z", "url": "https://github.com/elastic/elasticsearch/pull/53029", "merged": true, "mergeCommit": {"oid": "932f81bc66402a6d7c30abaed74d4d8592ab643d"}, "closed": true, "closedAt": "2020-03-05T13:31:42Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJy1bsgH2gAyMzgyNTY3NTU2OmNhN2I2ZjllYzM0MGUzZDk0Y2NlZmQ3Njc0MmZhYTYwNThmNGQyMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKpXk1gFqTM2OTQ3MzM4MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca7b6f9ec340e3d94ccefd76742faa6058f4d22f", "committedDate": "2020-03-02T19:25:01Z", "message": "[ML] Fix minor race condition in dataframe analytics _start"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3NzU1OTAw", "url": "https://github.com/elastic/elasticsearch/pull/53029#pullrequestreview-367755900", "createdAt": "2020-03-03T07:41:01Z", "commit": {"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo0MTowMlrOFw7BAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwNzo0MTowMlrOFw7BAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4Njg0Mjg4MA==", "bodyText": "Should we wait the same way for .ml-state*?", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386842880", "createdAt": "2020-03-03T07:41:02Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -572,7 +582,10 @@ protected AllocatedPersistentTask createTask(\n             String id = params.getId();\n \n             List<String> unavailableIndices =\n-                verifyIndicesPrimaryShardsAreActive(clusterState, resolver, AnomalyDetectorsIndex.configIndexName());\n+                verifyIndicesPrimaryShardsAreActive(clusterState,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY3ODI4Nzgz", "url": "https://github.com/elastic/elasticsearch/pull/53029#pullrequestreview-367828783", "createdAt": "2020-03-03T09:42:06Z", "commit": {"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTo0MjowNlrOFw-jdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwOTo0MjowNlrOFw-jdw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjkwMDg1NQ==", "bodyText": "I feel like I'm missing something obvious here. The .ml-stats index is created by  DataFrameAnalyticsManager.execute called from TaskExecutor.nodeOperation.   But TaskExecutor.getAssignment which runs first is expecting the index to exist and as far as I can tell it hasn't been created yet. Could that be because of the leniency in verifyIndicesPrimaryShardsAreActive\nresolver.concreteIndexNames(clusterState, IndicesOptions.lenientExpandOpen(), indexNames);", "url": "https://github.com/elastic/elasticsearch/pull/53029#discussion_r386900855", "createdAt": "2020-03-03T09:42:06Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportStartDataFrameAnalyticsAction.java", "diffHunk": "@@ -572,7 +582,10 @@ protected AllocatedPersistentTask createTask(\n             String id = params.getId();\n \n             List<String> unavailableIndices =\n-                verifyIndicesPrimaryShardsAreActive(clusterState, resolver, AnomalyDetectorsIndex.configIndexName());\n+                verifyIndicesPrimaryShardsAreActive(clusterState,\n+                    resolver,\n+                    AnomalyDetectorsIndex.configIndexName(),\n+                    MlStatsIndex.indexPattern());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ca7b6f9ec340e3d94ccefd76742faa6058f4d22f"}, "originalPosition": 55}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8af55ceff2d12ba717013d378431bf4eba06306b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/8af55ceff2d12ba717013d378431bf4eba06306b", "committedDate": "2020-03-04T13:14:16Z", "message": "fixing _stop race condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "32706def39a245beeae9e43a353cd5b79ab764ae", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/32706def39a245beeae9e43a353cd5b79ab764ae", "committedDate": "2020-03-04T13:23:19Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-dataframe-fix-start-race-condition"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17d3067bd04e12e1cc2ad3e4cc6e990a95de23cf", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/17d3067bd04e12e1cc2ad3e4cc6e990a95de23cf", "committedDate": "2020-03-04T16:11:59Z", "message": "fixing test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3544450337d1794cdf2664f2640406a95dc45a67", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/3544450337d1794cdf2664f2640406a95dc45a67", "committedDate": "2020-03-04T19:41:16Z", "message": "fixing bad handling of stop during reindex"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa633bc73cedfcb3795f1d0fb86ab8d5206d599a", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa633bc73cedfcb3795f1d0fb86ab8d5206d599a", "committedDate": "2020-03-04T19:51:08Z", "message": "Merge branch 'master' into feature/ml-dataframe-fix-start-race-condition"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDM4ODU1", "url": "https://github.com/elastic/elasticsearch/pull/53029#pullrequestreview-369438855", "createdAt": "2020-03-05T10:06:53Z", "commit": {"oid": "fa633bc73cedfcb3795f1d0fb86ab8d5206d599a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5NDczMzgw", "url": "https://github.com/elastic/elasticsearch/pull/53029#pullrequestreview-369473380", "createdAt": "2020-03-05T10:57:11Z", "commit": {"oid": "fa633bc73cedfcb3795f1d0fb86ab8d5206d599a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1904, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}