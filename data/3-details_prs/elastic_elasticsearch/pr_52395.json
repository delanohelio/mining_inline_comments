{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc1ODMxMjkw", "number": 52395, "title": "Optimize FilterStreamInput for Network Reads", "bodyText": "When FilterStreamInput wraps a Netty ByteBuf based stream it\ndid not forward the bulk primitive reads to the delegate.\nThese are optimized on the delegate but if they're not forwarded\nthen the delegate will be called e.g. 4 times to read an int.\nThis happens for essentially all network reads prior to this\nchange because they all run from a NamedWritableAwareStreamInput.\nThis also required optimising BufferedChecksumStreamInput individually to use bulk reads from the buffer because it implicitly assumed that the filter stream input  wouldn't override any of the bulk operations.", "createdAt": "2020-02-16T14:19:49Z", "url": "https://github.com/elastic/elasticsearch/pull/52395", "merged": true, "mergeCommit": {"oid": "403d1ff70088b041ad1a9f3d319d11340fea3b48"}, "closed": true, "closedAt": "2020-02-17T09:59:37Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcE5bSBAH2gAyMzc1ODMxMjkwOmQ0NjEzMzNmMjA3YmVmYjBjNDhlMDMwZjU5MzQ0Y2Y0ZTJkMGM2NDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcFKRxdAFqTM1OTYwODU5Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d461333f207befb0c48e030f59344cf4e2d0c641", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d461333f207befb0c48e030f59344cf4e2d0c641", "committedDate": "2020-02-16T14:16:10Z", "message": "Optimize FilterStreamInput for Network Reads\n\nWhen `FilterStreamInput` wraps a Netty `ByteBuf` based stream it\ndid not forward the bulk primitive reads to the delegate.\nThese are optimized on the delegate but if they're not forwarded\nthen the delegate will be called e.g. 4 times to read an `int`.\nThis happens for essentially all network reads prior to this\nchange because they all run from a `NamedWritableAwareStreamInput`."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc7bb78cd97eef42d9a73045f0bd2085094bf4f6", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc7bb78cd97eef42d9a73045f0bd2085094bf4f6", "committedDate": "2020-02-16T15:01:01Z", "message": "fix buffer check sum stream"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NDA5NjA3", "url": "https://github.com/elastic/elasticsearch/pull/52395#pullrequestreview-359409607", "createdAt": "2020-02-16T15:06:25Z", "commit": {"oid": "fc7bb78cd97eef42d9a73045f0bd2085094bf4f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTowNjoyNVrOFqT3FA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xNlQxNTowNjoyNVrOFqT3FA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3OTkwOTkwOA==", "bodyText": "I think even for short this is better than the previous solution. It certainly is when reading from a Netty ByteBuf backed buffer since we save one round of bounds checks.", "url": "https://github.com/elastic/elasticsearch/pull/52395#discussion_r379909908", "createdAt": "2020-02-16T15:06:25Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/index/translog/BufferedChecksumStreamInput.java", "diffHunk": "@@ -70,6 +70,30 @@ public void readBytes(byte[] b, int offset, int len) throws IOException {\n         digest.update(b, offset, len);\n     }\n \n+    private static final ThreadLocal<byte[]> buffer = ThreadLocal.withInitial(() -> new byte[8]);\n+\n+    @Override\n+    public short readShort() throws IOException {\n+        final byte[] buf = buffer.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc7bb78cd97eef42d9a73045f0bd2085094bf4f6"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c8ee9ef54783a0ee916b7219f60c46d5331b9d03", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c8ee9ef54783a0ee916b7219f60c46d5331b9d03", "committedDate": "2020-02-16T15:12:06Z", "message": "fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU5NjA4NTk2", "url": "https://github.com/elastic/elasticsearch/pull/52395#pullrequestreview-359608596", "createdAt": "2020-02-17T09:54:10Z", "commit": {"oid": "c8ee9ef54783a0ee916b7219f60c46d5331b9d03"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2330, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}