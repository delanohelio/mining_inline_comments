{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYzMjYzNTQ5", "number": 51061, "title": "Calculate results and model snapshot retention using latest bucket timestamps", "bodyText": "The retention period is calculated relative to the last bucket result or model snapshot. For example if results retention is set to 30 days and the last bucket result was from 10 days ago then only results older than 40 days will be deleted. The same logic applies to model snapshots, but measured from the timestamp of the most recent model snapshot.\nPreviously retention was calculated relative to wall clock time, which was surprising for jobs that were not running continuously.\nThere is still an element of confusion, because model snapshot timestamps record the wall clock time that the model snapshot was created, not the model time.  However, this change is still an improvement in that if you stop a real-time job for a period of days then you don't lose all model snapshots other than the active one.", "createdAt": "2020-01-15T17:54:29Z", "url": "https://github.com/elastic/elasticsearch/pull/51061", "merged": true, "mergeCommit": {"oid": "7978f0b8ef1626f13161b242868fc95d92c3fe2a"}, "closed": true, "closedAt": "2020-01-22T10:08:41Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb6pfvlgFqTM0MzQxNDMxOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABb8eO80AH2gAyMzYzMjYzNTQ5Ojc1NjlhMmFkZGZhZjc1MDYyNThkYzViYTE2OWQ0MTY1YTZiODIxYmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzNDE0MzE5", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-343414319", "createdAt": "2020-01-15T18:03:18Z", "commit": {"oid": "fdd99d3908a02cdb3d5b876e5061bb014f789d99"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowMzoxOVrOFeBaDw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNVQxODowMzoxOVrOFeBaDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzAyNDY1NQ==", "bodyText": "There is no way to create a job without a model snapshot retention policy. If you set modelSnapshotRetentionDays to null then the builder will automatically default it back to 1 when the job is read back from xcontent.\nNegative numbers are not tolerated and throw a validation exception so the only way of not having a retention policy is setting it to a large value", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r367024655", "createdAt": "2020-01-15T18:03:19Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -45,114 +43,97 @@\n import static org.mockito.Matchers.same;\n import static org.mockito.Mockito.doAnswer;\n import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.times;\n import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n \n public class ExpiredModelSnapshotsRemoverTests extends ESTestCase {\n \n     private Client client;\n     private OriginSettingClient originSettingClient;\n-    private ThreadPool threadPool;\n     private List<SearchRequest> capturedSearchRequests;\n     private List<DeleteModelSnapshotAction.Request> capturedDeleteModelSnapshotRequests;\n-    private List<SearchResponse> searchResponsesPerCall;\n     private TestListener listener;\n \n     @Before\n     public void setUpTests() {\n         capturedSearchRequests = new ArrayList<>();\n         capturedDeleteModelSnapshotRequests = new ArrayList<>();\n-        searchResponsesPerCall = new ArrayList<>();\n \n         client = mock(Client.class);\n         originSettingClient = MockOriginSettingClient.mockOriginSettingClient(client, ClientHelper.ML_ORIGIN);\n \n         listener = new TestListener();\n-\n-        // Init thread pool\n-        Settings settings = Settings.builder()\n-                .put(\"node.name\", \"expired_model_snapshots_remover_test\")\n-                .build();\n-        threadPool = new ThreadPool(settings,\n-                new FixedExecutorBuilder(settings, MachineLearning.UTILITY_THREAD_POOL_NAME, 1, 1000, \"\"));\n-    }\n-\n-    @After\n-    public void shutdownThreadPool() {\n-        terminate(threadPool);\n-    }\n-\n-    public void testRemove_GivenJobsWithoutRetentionPolicy() throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fdd99d3908a02cdb3d5b876e5061bb014f789d99"}, "originalPosition": 74}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fdd99d3908a02cdb3d5b876e5061bb014f789d99", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdd99d3908a02cdb3d5b876e5061bb014f789d99", "committedDate": "2020-01-15T17:07:53Z", "message": "Fix the tests"}, "afterCommit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3", "committedDate": "2020-01-16T10:34:56Z", "message": "Rework docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQzODE2OTU4", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-343816958", "createdAt": "2020-01-16T10:36:35Z", "commit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDozNjozNVrOFeU-gg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xNlQxMDozNjozNVrOFeU-gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzM0NTI4Mg==", "bodyText": "@szabosteve can you look over these docs changes please. Do they make sense?", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r367345282", "createdAt": "2020-01-16T10:36:35Z", "author": {"login": "davidkyle"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c0161a4c02000bed885294a723b6779bbb849ed", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c0161a4c02000bed885294a723b6779bbb849ed", "committedDate": "2020-01-16T13:47:59Z", "message": "Calculate the results retention period based on the latest bucket time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7ca8db9d6610516ed415718d7db0c02be1841401", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/7ca8db9d6610516ed415718d7db0c02be1841401", "committedDate": "2020-01-16T13:47:59Z", "message": "Define retention period in docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f620d6b1071b18c37af33f72b87beecd532b048b", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/f620d6b1071b18c37af33f72b87beecd532b048b", "committedDate": "2020-01-16T13:47:59Z", "message": "Start expired snapshots"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c56dda250b1f3cdf59da1c3e2ed19dc1dfde66d", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/6c56dda250b1f3cdf59da1c3e2ed19dc1dfde66d", "committedDate": "2020-01-16T13:47:59Z", "message": "Adapt for origin setting client"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11fa81bd8467c8b6c086c763d6af69bb95778f17", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/11fa81bd8467c8b6c086c763d6af69bb95778f17", "committedDate": "2020-01-16T13:47:59Z", "message": "Fix the tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/aee2d136a65b62dbd462fe4e57e12c0194d02f7c", "committedDate": "2020-01-16T13:47:59Z", "message": "Rework docs"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1fc8f8a00cfc4d82758c4bc2be61ef68c3013e3", "committedDate": "2020-01-16T10:34:56Z", "message": "Rework docs"}, "afterCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/aee2d136a65b62dbd462fe4e57e12c0194d02f7c", "committedDate": "2020-01-16T13:47:59Z", "message": "Rework docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzE5MjIx", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345319221", "createdAt": "2020-01-20T13:49:10Z", "commit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1MzI4MzEy", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345328312", "createdAt": "2020-01-20T14:03:34Z", "commit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDowMzozNFrOFffUbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNDo0ODoxNFrOFfgq1g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2MzMxMQ==", "bodyText": "typo: lastest -> latest", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368563311", "createdAt": "2020-01-20T14:03:34Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 2 days of data starting 24 hrs ago\n+        long lastestBucketTime = System.currentTimeMillis() - TimeValue.timeValueHours(1).millis();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU2NTg3Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // We are going to create 2 days of data starting 24 hrs ago\n          \n          \n            \n                    // We are going to create 3 days of data ending 1 hour ago", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368565872", "createdAt": "2020-01-20T14:09:08Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 2 days of data starting 24 hrs ago", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU3MDA5NA==", "bodyText": "Could this method be abstract instead of providing a default based on wall clock time?  It seems that now we've made deletion of model snapshots and results relative to latest bucket time rather than wall clock time we should do that for all job related documents that have a timestamp.  So having a default implementation of this method that uses wall clock time just seems like a way that we'll introduce a bug by accidentally deleting some other type of document based on wall clock time.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368570094", "createdAt": "2020-01-20T14:17:54Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {\n         long nowEpochMs = Instant.now(Clock.systemDefaultZone()).toEpochMilli();\n-        return nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis();\n+        listener.onResponse(nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis());\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU3ODY5Mg==", "bodyText": "Looks like this is indented more than the line above.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368578692", "createdAt": "2020-01-20T14:35:04Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemoverTests.java", "diffHunk": "@@ -82,10 +82,10 @@ static SearchResponse createSearchResponse(List<? extends ToXContent> toXContent\n     static void givenJobs(Client client, List<Job> jobs) throws IOException {\n         SearchResponse response = AbstractExpiredJobDataRemoverTests.createSearchResponse(jobs);\n \n-        doAnswer(invocationOnMock -> {\n-            ActionListener<SearchResponse> listener = (ActionListener<SearchResponse>) invocationOnMock.getArguments()[2];\n-            listener.onResponse(response);\n-            return null;\n+            doAnswer(invocationOnMock -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 8}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODU4NTQzMA==", "bodyText": "The other methods that extending classes are expected to override are protected, even though the actual classes that do extend this class are all in the same package.  But then this class's constructor is package private so it would be impossible to have a derived class in another package despite the abstract methods being set up for that.  I think for consistency they should all be the same - either protected or package private.  Certainly with a default implementation here I think protected makes it clearer that we expect derived classes to modify it rather than it's just been made accessible for testing.  But then if you agree with my other suggestion and make this abstract then that also makes that clear.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368585430", "createdAt": "2020-01-20T14:48:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,19 +68,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n+    void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "aee2d136a65b62dbd462fe4e57e12c0194d02f7c"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498f5b0adea88ab5e7d8e50d45147946a0f8f69c", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/498f5b0adea88ab5e7d8e50d45147946a0f8f69c", "committedDate": "2020-01-20T17:00:59Z", "message": "Address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/580c51765c28ea3d23112ea6e044f505f9ad68ea", "committedDate": "2020-01-20T17:24:47Z", "message": "Make package-private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDU4NzAx", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345458701", "createdAt": "2020-01-20T17:39:07Z", "commit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzozOTowOFrOFfljhA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxNzo0MTo0OVrOFflnFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2NTQ3Ng==", "bodyText": "The next two methods (removeDataBefore and createQuery) might as well be package private too for consistency with the other abstract methods.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368665476", "createdAt": "2020-01-20T17:39:08Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -68,22 +64,29 @@ private void removeData(WrappedBatchedJobsIterator jobIterator, ActionListener<B\n             removeData(jobIterator, listener, isTimedOutSupplier);\n             return;\n         }\n-        long cutoffEpochMs = calcCutoffEpochMs(retentionDays);\n-        removeDataBefore(job, cutoffEpochMs,\n-            ActionListener.wrap(response -> removeData(jobIterator, listener, isTimedOutSupplier), listener::onFailure));\n+\n+        calcCutoffEpochMs(job.getId(), retentionDays, ActionListener.wrap(\n+                cutoffEpochMs -> {\n+                    if (cutoffEpochMs == null) {\n+                        removeData(jobIterator, listener, isTimedOutSupplier);\n+                    } else {\n+                        removeDataBefore(job, cutoffEpochMs, ActionListener.wrap(\n+                                response -> removeData(jobIterator, listener, isTimedOutSupplier),\n+                                listener::onFailure));\n+                    }\n+                },\n+                listener::onFailure\n+        ));\n     }\n \n     private WrappedBatchedJobsIterator newJobIterator() {\n         BatchedJobsIterator jobsIterator = new BatchedJobsIterator(client, AnomalyDetectorsIndex.configIndexName());\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    private long calcCutoffEpochMs(long retentionDays) {\n-        long nowEpochMs = Instant.now(Clock.systemDefaultZone()).toEpochMilli();\n-        return nowEpochMs - new TimeValue(retentionDays, TimeUnit.DAYS).getMillis();\n-    }\n+    abstract void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener);\n \n-    protected abstract Long getRetentionDays(Job job);\n+    abstract Long getRetentionDays(Job job);\n \n     /**\n      * Template method to allow implementation details of various types of data (e.g. results, model snapshots).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea"}, "originalPosition": 58}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY2NjM5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // We are going to create 3 days of data starting 1 hr ago\n          \n          \n            \n                    // We are going to create 3 days of data ending 1 hr ago", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368666391", "createdAt": "2020-01-20T17:41:49Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/DeleteExpiredDataIT.java", "diffHunk": "@@ -57,15 +57,15 @@ public void setUpData() throws IOException {\n                 .setMapping(\"time\", \"type=date,format=epoch_millis\")\n                 .get();\n \n-        // We are going to create data for last 2 days\n-        long nowMillis = System.currentTimeMillis();\n+        // We are going to create 3 days of data starting 1 hr ago", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "580c51765c28ea3d23112ea6e044f505f9ad68ea"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/e7724b9e6a57bf6a4f499ae75e197ba11b5fef60", "committedDate": "2020-01-20T17:50:34Z", "message": "nits"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDY3NjM5", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345467639", "createdAt": "2020-01-20T18:01:34Z", "commit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowMTozNVrOFfmAUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowMTozNVrOFfmAUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3Mjg1MA==", "bodyText": "If this property is still a number that represents days, I think it's worth keeping that in the definition.  For example:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Advanced configuration option. Denotes the period for which model snapshots\n          \n          \n            \n            Advanced configuration option. The period of time (in days) that model snapshots are retained.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368672850", "createdAt": "2020-01-20T18:01:35Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5026ee0babea5c6291a5f6c7781942272b2ddb6", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5026ee0babea5c6291a5f6c7781942272b2ddb6", "committedDate": "2020-01-20T18:05:02Z", "message": "Update docs/reference/ml/ml-shared.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDY5OTI1", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345469925", "createdAt": "2020-01-20T18:07:53Z", "commit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowNzo1M1rOFfmHYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowNzo1M1rOFfmHYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NDY1OQ==", "bodyText": "Not mandatory, but I try to avoid possessives:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            will be retained. Age is calculated as the time from the newest model snapshot's\n          \n          \n            \n            Age is calculated relative to the timestamp of the newest model snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368674659", "createdAt": "2020-01-20T18:07:53Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots\n+will be retained. Age is calculated as the time from the newest model snapshot's", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/8bd4f993144a97a513938a81fd4cedaa2acc9e77", "committedDate": "2020-01-20T18:08:39Z", "message": "Add \u2018in days\u2019"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDcwNDYz", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345470463", "createdAt": "2020-01-20T18:09:21Z", "commit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowOToyMVrOFfmJMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODowOToyMVrOFfmJMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NTEyMA==", "bodyText": "Maybe move the deletion info here?:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            which means snapshots are retained for one day (twenty-four hours).\n          \n          \n            \n            which means snapshots that are one day (twenty-four hours) older than the newest snapshot are deleted.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368675120", "createdAt": "2020-01-20T18:09:21Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -863,9 +863,10 @@ example, `1575402236000 `.\n end::model-snapshot-id[]\n \n tag::model-snapshot-retention-days[]\n-The time in days that model snapshots are retained for the job. Older snapshots\n-are deleted. The default value is `1`, which means snapshots are retained for\n-one day (twenty-four hours).\n+Advanced configuration option. Denotes the period for which model snapshots\n+will be retained. Age is calculated as the time from the newest model snapshot's\n+timestamp, older snapshots are automatically deleted. The default value is `1`,\n+which means snapshots are retained for one day (twenty-four hours).", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7724b9e6a57bf6a4f499ae75e197ba11b5fef60"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDcyODQ4", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345472848", "createdAt": "2020-01-20T18:16:04Z", "commit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxNjowNFrOFfmQ0Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxNjowNFrOFfmQ0Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3NzA3Mw==", "bodyText": "I'm not sure I understand why we're making the descriptions diverge like this (focus on pruning vs retaining). I'd recommend keeping them in synch unless I'm missing something important here. For example:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Advanced configuration option. When set this option will prune results older\n          \n          \n            \n            Advanced configuration option. The period of time (in days) that results are retained.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368677073", "createdAt": "2020-01-20T18:16:04Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDc0MTM0", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345474134", "createdAt": "2020-01-20T18:19:33Z", "commit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxOTozM1rOFfmUwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoxOTozM1rOFfmUwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3ODA4Mg==", "bodyText": "Note sure if newest or latest is correct, bit I think it should be used similarly in both definitions:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            than this age in days. Age is calculated as the difference between the latest\n          \n          \n            \n            Age is calculated relative to the timestamp of the latest bucket result.", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368678082", "createdAt": "2020-01-20T18:19:33Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDc0ODg5", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345474889", "createdAt": "2020-01-20T18:21:29Z", "commit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMToyOVrOFfmXDA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMToyOVrOFfmXDA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3ODY2OA==", "bodyText": "Moving the \"when set this option...\" here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            bucket result's timestamp and the result's timestamp. Once per day at 00:30\n          \n          \n            \n            If this property has a non-null value, once per day at 00:30", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368678668", "createdAt": "2020-01-20T18:21:29Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest\n+bucket result's timestamp and the result's timestamp. Once per day at 00:30", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ1NDc1Njkw", "url": "https://github.com/elastic/elasticsearch/pull/51061#pullrequestreview-345475690", "createdAt": "2020-01-20T18:23:41Z", "commit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMzo0MVrOFfmZnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMFQxODoyMzo0MVrOFfmZnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2ODY3OTMyNQ==", "bodyText": "Trying to match suggestion in the other definition :) :\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            (server time), results older than this are deleted from {es}. The default\n          \n          \n            \n            (server time), results that are the specified number of days older than the latest bucket result are deleted from {es}. The default", "url": "https://github.com/elastic/elasticsearch/pull/51061#discussion_r368679325", "createdAt": "2020-01-20T18:23:41Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -963,10 +964,11 @@ is `shared`, which generates an index named `.ml-anomalies-shared`.\n end::results-index-name[]\n \n tag::results-retention-days[]\n-Advanced configuration option. The number of days for which job results are \n-retained. Once per day at 00:30 (server time), results older than this period\n-are deleted from {es}. The default value is null, which means results are\n-retained.\n+Advanced configuration option. When set this option will prune results older\n+than this age in days. Age is calculated as the difference between the latest\n+bucket result's timestamp and the result's timestamp. Once per day at 00:30\n+(server time), results older than this are deleted from {es}. The default", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bd4f993144a97a513938a81fd4cedaa2acc9e77"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "542869a73322a5d1c98c7101344d27c85ab71efe", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/542869a73322a5d1c98c7101344d27c85ab71efe", "committedDate": "2020-01-21T09:57:21Z", "message": "Apply docs suggestions from code review\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c553a425e51801ed2707f8fcd3acf34cc75d940a", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/c553a425e51801ed2707f8fcd3acf34cc75d940a", "committedDate": "2020-01-21T09:57:57Z", "message": "Update docs/reference/ml/ml-shared.asciidoc\n\nCo-Authored-By: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7569a2addfaf7506258dc5ba169d4165a6b821bd", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/7569a2addfaf7506258dc5ba169d4165a6b821bd", "committedDate": "2020-01-21T10:03:52Z", "message": "Remove duplicated line"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3116, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}