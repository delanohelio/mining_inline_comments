{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NzIyODc2", "number": 59063, "title": "EQL: Introduce sequencing fetch size", "bodyText": "The current internal sequence algorithm relies on fetching multiple results and then paginating through the dataset. Depending on the dataset and memory, setting a larger page size can yield better performance at the expense of memory.\nThis PR makes this behavior explicit by decoupling the fetch size from size, the maximum number of results desired.\nAs such, use in testing a minimum fetch size which exposed a number of bugs:\n\nJumping across data across queries causing valid data to be seen as a gap.\nIncorrectly resuming searching across pages (again causing data to be discarded).\n\nwhich have been addressed.", "createdAt": "2020-07-06T11:47:04Z", "url": "https://github.com/elastic/elasticsearch/pull/59063", "merged": true, "mergeCommit": {"oid": "2f389a7724790d7b0bda67264d6eafcfa8b2116e"}, "closed": true, "closedAt": "2020-07-06T15:50:41Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyPsQugH2gAyNDQ0NzIyODc2OjdiZmJjYzY4YzJlNTFjM2QzY2MwOWRlZDU3YWU5Nzc5OTQ0ODUzMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyTrqbgFqTQ0MzIyMDg3NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7bfbcc68c2e51c3d3cc09ded57ae97799448532d", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bfbcc68c2e51c3d3cc09ded57ae97799448532d", "committedDate": "2020-07-06T11:39:13Z", "message": "First attempt in adding fetchSize alongside size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d2238637686567c93950f2943609db5f3f71d8fe", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2238637686567c93950f2943609db5f3f71d8fe", "committedDate": "2020-07-06T11:39:14Z", "message": "Integrate size/fetch size as LimitWithOffset within the planExecutor\n\nCombine the request size and pipe declaration with the query into one\nFor eventQuery push the limit into the query, for sequences keep the\nlimit on the sequence but push the fetch size in the queries."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7a467731f64ad765b6fc16a8b3572a5f804d7d8", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7a467731f64ad765b6fc16a8b3572a5f804d7d8", "committedDate": "2020-07-06T11:39:14Z", "message": "Add fetch size parameter in the rest client API"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0d8c04b2ff3d133a3e8b9d01eb8888c0498f9c47", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/0d8c04b2ff3d133a3e8b9d01eb8888c0498f9c47", "committedDate": "2020-07-06T11:39:14Z", "message": "skip stages only when there are no candidates on the current stage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e15b4f51992a6762b32513c48bab96ef8bbe832", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e15b4f51992a6762b32513c48bab96ef8bbe832", "committedDate": "2020-07-06T11:39:15Z", "message": "Don't set beginning of follow-up query to avoid them jumping over data"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6c5ca1fea8495c0d7bbee2ed196c335e14ff2272", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/6c5ca1fea8495c0d7bbee2ed196c335e14ff2272", "committedDate": "2020-07-06T11:39:15Z", "message": "Update query next only when at least one result has been returned"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b3f7efb86104da2abbf16f8592cbb98db219013", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b3f7efb86104da2abbf16f8592cbb98db219013", "committedDate": "2020-07-06T11:39:15Z", "message": "Reinitialize pointer when doing desc/asc queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e0d2f7d3ef45f961b659cf69a5b6ef1852be351f", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/e0d2f7d3ef45f961b659cf69a5b6ef1852be351f", "committedDate": "2020-07-06T11:39:16Z", "message": "Increase the default size of results in testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c9c8b2b921a57516320e62b676db5c65f8711f9", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c9c8b2b921a57516320e62b676db5c65f8711f9", "committedDate": "2020-07-06T12:50:10Z", "message": "Update EQL client test"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "323310fa598d9eebd1be459c232d6c30ea48b78c", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/323310fa598d9eebd1be459c232d6c30ea48b78c", "committedDate": "2020-07-06T12:51:19Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/match-size"}, "afterCommit": {"oid": "9c9c8b2b921a57516320e62b676db5c65f8711f9", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c9c8b2b921a57516320e62b676db5c65f8711f9", "committedDate": "2020-07-06T12:50:10Z", "message": "Update EQL client test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a108555d478a526c208cb4e25bc6ce85b14c8fe8", "committedDate": "2020-07-06T14:12:04Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/match-size"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMTcxODUz", "url": "https://github.com/elastic/elasticsearch/pull/59063#pullrequestreview-443171853", "createdAt": "2020-07-06T15:17:18Z", "commit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNToxNzoxOFrOGtbySQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNToxODoyMVrOGtb1HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NDM0NQ==", "bodyText": "I would rename the arg to fetchSize", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450294345", "createdAt": "2020-07-06T15:17:18Z", "author": {"login": "matriv"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -172,14 +175,26 @@ public EqlSearchRequest implicitJoinKeyField(String implicitJoinKeyField) {\n         return this;\n     }\n \n+    public int size() {\n+        return this.size;\n+    }\n+\n+    public EqlSearchRequest size(int size) {\n+        this.size = size;\n+        if (fetchSize <= 0) {\n+            throw new IllegalArgumentException(\"size must be greater than 0\");\n+        }\n+        return this;\n+    }\n+\n     public int fetchSize() {\n         return this.fetchSize;\n     }\n \n     public EqlSearchRequest fetchSize(int size) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDI5NTA2OA==", "bodyText": "Does it make sense to make it a random between let's say 1 and 10?", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450295068", "createdAt": "2020-07-06T15:18:21Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -144,6 +144,9 @@ protected EqlSearchResponse runQuery(String index, String query, boolean isCaseS\n         EqlSearchRequest request = new EqlSearchRequest(testIndexName, query);\n         request.isCaseSensitive(isCaseSensitive);\n         request.tiebreakerField(\"event.sequence\");\n+        // some queries return more than 10 results\n+        request.size(50);\n+        request.fetchSize(2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzMjIwODc1", "url": "https://github.com/elastic/elasticsearch/pull/59063#pullrequestreview-443220875", "createdAt": "2020-07-06T16:16:27Z", "commit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjoxNjoyN1rOGteILg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQxNjoxNzo1MFrOGteLhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMjcxOA==", "bodyText": "@jrodewig A heads-up on these two parameters.\nThe default size of the response changed to 10 from 50 (aligned with that of the search api).\nAdditionally the fetch_size parameters has been introduced to indicate how large the page for sequence matching is. A large page means faster results and less search calls but it does so at the expense of memory (more data needs to be returned).", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450332718", "createdAt": "2020-07-06T16:16:27Z", "author": {"login": "costin"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/eql/EqlSearchRequest.java", "diffHunk": "@@ -60,6 +61,7 @@\n     static final String KEY_IMPLICIT_JOIN_KEY_FIELD = \"implicit_join_key_field\";\n     static final String KEY_CASE_SENSITIVE = \"case_sensitive\";\n     static final String KEY_SIZE = \"size\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDMzMzU3Mg==", "bodyText": "@jrodewig tail and pipe should now work for all type of queries; if you encountered problems when trying to use them in the docs let me know since that would be a bug.", "url": "https://github.com/elastic/elasticsearch/pull/59063#discussion_r450333572", "createdAt": "2020-07-06T16:17:50Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/test/resources/queryfolder_tests.txt", "diffHunk": "@@ -534,3 +534,27 @@ process where subtract(43, serial_event_id) == 41\n InternalQlScriptUtils.sub(params.v0,InternalQlScriptUtils.docValue(doc,params.v1)),params.v2))\",\n \"params\":{\"v0\":43,\"v1\":\"serial_event_id\",\"v2\":41}\n ;\n+\n+eventQueryDefaultLimit", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a108555d478a526c208cb4e25bc6ce85b14c8fe8"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2280, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}