{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY3OTQzMTY2", "number": 61143, "title": "Respect ML upgrade mode in TrainedModelStatsService", "bodyText": "When in upgrade mode the stats service should not write to the stats index.\nThe change is simple - don't persist the stats and works nicely as new stats increment the existing stats so there isn't an accumulation of objects in memory. Unfortunately upgrade mode means the node has either been upgraded already or is about to be taken down in which case some stat updates will be lost", "createdAt": "2020-08-14T11:55:59Z", "url": "https://github.com/elastic/elasticsearch/pull/61143", "merged": true, "mergeCommit": {"oid": "2a1e8e306817e30e80079662900deba02f386ce2"}, "closed": true, "closedAt": "2020-08-17T08:53:31Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-zJ9AgH2gAyNDY3OTQzMTY2OjliYTk0Yzk5OGYyN2MxZTgwYTBhMTUyNzlkM2ExNWE4ZWM3MzVmZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc-z-9lgH2gAyNDY3OTQzMTY2OjA1NzQwMWZkODllYWRkOGZhNGZiMTVkZTFjMjA3YTZkMzJmMGUzYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9ba94c998f27c1e80a0a15279d3a15a8ec735fe2", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/9ba94c998f27c1e80a0a15279d3a15a8ec735fe2", "committedDate": "2020-08-14T11:45:25Z", "message": "Don't persist model stats in upgrade mode"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NTM2NDQ0", "url": "https://github.com/elastic/elasticsearch/pull/61143#pullrequestreview-467536444", "createdAt": "2020-08-14T12:31:00Z", "commit": {"oid": "9ba94c998f27c1e80a0a15279d3a15a8ec735fe2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjozMTowMFrOHAy00Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQxMjozMTowMFrOHAy00Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDU5NDc2OQ==", "bodyText": "debug logging? Might be helpful for troublshooting issues where stats are mysteriously not being persisted.", "url": "https://github.com/elastic/elasticsearch/pull/61143#discussion_r470594769", "createdAt": "2020-08-14T12:31:00Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/TrainedModelStatsService.java", "diffHunk": "@@ -146,6 +153,12 @@ void updateStats() {\n         if (clusterState == null || statsQueue.isEmpty() || stopped) {\n             return;\n         }\n+\n+        boolean isInUpgradeMode = MlMetadata.getMlMetadata(clusterState).isUpgradeMode();\n+        if (isInUpgradeMode) {\n+            return;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9ba94c998f27c1e80a0a15279d3a15a8ec735fe2"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "057401fd89eadd8fa4fb15de1c207a6d32f0e3ad", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/057401fd89eadd8fa4fb15de1c207a6d32f0e3ad", "committedDate": "2020-08-14T12:43:19Z", "message": "logging"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4916, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}