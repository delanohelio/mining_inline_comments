{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3NjMxNTE5", "number": 52556, "title": "Separate translog from index deletion conditions", "bodyText": "Separates the translog from the index deletion conditions (allowing the translog to be cleaned up more eagerly), and avoids taking the write lock on the translog if no clean-up is actually necessary.", "createdAt": "2020-02-20T09:02:53Z", "url": "https://github.com/elastic/elasticsearch/pull/52556", "merged": true, "mergeCommit": {"oid": "16af0472a983ac89bc739591ddc922e54d640c7a"}, "closed": true, "closedAt": "2020-02-20T14:55:34Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGHNblAH2gAyMzc3NjMxNTE5OmI5MjI3ZTIzYzRhY2YyYWYwOTdjOGUxOTI4ZWU3NWM4MjU3Nzc2MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcGMJjBgFqTM2MTk1MzE3MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b9227e23c4acf2af097c8e1928ee75c825777634", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9227e23c4acf2af097c8e1928ee75c825777634", "committedDate": "2020-02-20T08:53:38Z", "message": "Separate translog deletion policy conditions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxNzQwMTQ4", "url": "https://github.com/elastic/elasticsearch/pull/52556#pullrequestreview-361740148", "createdAt": "2020-02-20T09:18:42Z", "commit": {"oid": "b9227e23c4acf2af097c8e1928ee75c825777634"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOToxODo0MlrOFsLpaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQwOToxODo0MlrOFsLpaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTg3MjQ5MQ==", "bodyText": "NIT: Maybe dry this up with the lines below via something like:\n    private long getMinReferencedGen() {\n        long minReferencedGen = Math.min(\n            deletionPolicy.getMinTranslogGenRequiredByLocks(),\n            minGenerationForSeqNo(deletionPolicy.getLocalCheckpointOfSafeCommit() + 1, current, readers));\n        assert minReferencedGen >= getMinFileGeneration() :\n            \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] but the lowest gen available is [\"\n                + getMinFileGeneration() + \"]\";\n        assert minReferencedGen <= currentFileGeneration() :\n            \"deletion policy requires a minReferenceGen of [\" + minReferencedGen + \"] which is higher than the current generation [\"\n                + currentFileGeneration() + \"]\";\n        return minReferencedGen;\n    }", "url": "https://github.com/elastic/elasticsearch/pull/52556#discussion_r381872491", "createdAt": "2020-02-20T09:18:42Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/index/translog/Translog.java", "diffHunk": "@@ -1646,7 +1646,24 @@ public void rollGeneration() throws IOException {\n      * required generation\n      */\n     public void trimUnreferencedReaders() throws IOException {\n-        // move most of the data to disk to reduce the time the lock is held\n+        // first check under read lock if any readers can be trimmed\n+        try (ReleasableLock ignored = readLock.acquire()) {\n+            ensureOpen();\n+            long minReferencedGen = Math.min(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9227e23c4acf2af097c8e1928ee75c825777634"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98bdba27bfa6502c3abc28c484f833028cfd67c2", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/98bdba27bfa6502c3abc28c484f833028cfd67c2", "committedDate": "2020-02-20T10:07:25Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYxOTUzMTcw", "url": "https://github.com/elastic/elasticsearch/pull/52556#pullrequestreview-361953170", "createdAt": "2020-02-20T14:38:55Z", "commit": {"oid": "98bdba27bfa6502c3abc28c484f833028cfd67c2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2218, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}