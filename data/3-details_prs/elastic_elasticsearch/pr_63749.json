{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0MTY3NTI0", "number": 63749, "title": "Preserve backing index ordering for data streams", "bodyText": "The resolve index API incorrectly sorts the backing indices returned for data streams. The backing indices on a data stream are an ordered list in which the last index is always the write index so sorting them may produce incorrect results once migration of existing indices to data streams is permitted.", "createdAt": "2020-10-15T14:54:42Z", "url": "https://github.com/elastic/elasticsearch/pull/63749", "merged": true, "mergeCommit": {"oid": "98e3ac357f77c601ae9cb7450e59e38aeec7df8e"}, "closed": true, "closedAt": "2020-10-16T16:26:04Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdSy9OcAH2gAyNTA0MTY3NTI0OmNiZjA3OGM4ZjljMDExN2IzOGIzZDJiNzhkYzE1MDM4Y2M0MDhjMDc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdTIPDqgH2gAyNTA0MTY3NTI0OjUzZGMyYzk2ZjY4NzdjOTUxY2QyMWQxOGU3NmZhMmEzZGVlZjdlMDk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cbf078c8f9c0117b38b3d2b78dc15038cc408c07", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/cbf078c8f9c0117b38b3d2b78dc15038cc408c07", "committedDate": "2020-10-15T14:50:00Z", "message": "Preserve backing index ordering for data streams"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA5NTAyMzQ3", "url": "https://github.com/elastic/elasticsearch/pull/63749#pullrequestreview-509502347", "createdAt": "2020-10-15T15:24:55Z", "commit": {"oid": "cbf078c8f9c0117b38b3d2b78dc15038cc408c07"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNToyNDo1NVrOHiNckg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNVQxNToyNTowN1rOHiNdQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzMzkzOA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    backingIndices.add(createIndexMetadata(\"not-in-order-2\", true));\n          \n          \n            \n                    backingIndices.add(createIndexMetadata(\"not-in-order-1\", true));\n          \n          \n            \n                    backingIndices.add(createIndexMetadata(DataStream.getDefaultBackingIndexName(dataStreamName, 3), true));\n          \n          \n            \n                    String[] names = new String[]{\"not-in-order-2\", \"not-in-order-1\", DataStream.getDefaultBackingIndexName(dataStreamName, 3)};\n          \n          \n            \n                    List<IndexMetadata> backingIndices = Arrays.stream(names).map(n -> createIndexMetadata(n, true)).collect(Collectors.toList());", "url": "https://github.com/elastic/elasticsearch/pull/63749#discussion_r505633938", "createdAt": "2020-10-15T15:24:55Z", "author": {"login": "probakowski"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/resolve/ResolveIndexTests.java", "diffHunk": "@@ -169,6 +169,34 @@ public void testResolveWithMultipleNames() {\n         validateDataStreams(dataStreams, \"logs-mysql-test\");\n     }\n \n+    public void testResolvePreservesBackingIndexOrdering() {\n+        Metadata.Builder builder = Metadata.builder();\n+        String dataStreamName = \"my-data-stream\";\n+        List<IndexMetadata> backingIndices = new ArrayList<>();\n+        backingIndices.add(createIndexMetadata(\"not-in-order-2\", true));\n+        backingIndices.add(createIndexMetadata(\"not-in-order-1\", true));\n+        backingIndices.add(createIndexMetadata(DataStream.getDefaultBackingIndexName(dataStreamName, 3), true));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf078c8f9c0117b38b3d2b78dc15038cc408c07"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNTYzNDExMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(dataStreams.get(0).getBackingIndices().length, equalTo(3));\n          \n          \n            \n                    assertThat(dataStreams.get(0).getBackingIndices()[0], equalTo(backingIndices.get(0).getIndex().getName()));\n          \n          \n            \n                    assertThat(dataStreams.get(0).getBackingIndices()[1], equalTo(backingIndices.get(1).getIndex().getName()));\n          \n          \n            \n                    assertThat(dataStreams.get(0).getBackingIndices()[2], equalTo(backingIndices.get(2).getIndex().getName()));\n          \n          \n            \n                    assertThat(dataStreams.get(0).getBackingIndices(), arrayContaining(names));", "url": "https://github.com/elastic/elasticsearch/pull/63749#discussion_r505634112", "createdAt": "2020-10-15T15:25:07Z", "author": {"login": "probakowski"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/resolve/ResolveIndexTests.java", "diffHunk": "@@ -169,6 +169,34 @@ public void testResolveWithMultipleNames() {\n         validateDataStreams(dataStreams, \"logs-mysql-test\");\n     }\n \n+    public void testResolvePreservesBackingIndexOrdering() {\n+        Metadata.Builder builder = Metadata.builder();\n+        String dataStreamName = \"my-data-stream\";\n+        List<IndexMetadata> backingIndices = new ArrayList<>();\n+        backingIndices.add(createIndexMetadata(\"not-in-order-2\", true));\n+        backingIndices.add(createIndexMetadata(\"not-in-order-1\", true));\n+        backingIndices.add(createIndexMetadata(DataStream.getDefaultBackingIndexName(dataStreamName, 3), true));\n+        for (IndexMetadata index : backingIndices) {\n+            builder.put(index, false);\n+        }\n+\n+        DataStream ds = new DataStream(dataStreamName, createTimestampField(\"@timestamp\"),\n+            backingIndices.stream().map(IndexMetadata::getIndex).collect(Collectors.toList()));\n+        builder.put(ds);\n+\n+        IndicesOptions indicesOptions = IndicesOptions.LENIENT_EXPAND_OPEN_CLOSED_HIDDEN;\n+        List<ResolvedIndex> indices = new ArrayList<>();\n+        List<ResolvedAlias> aliases = new ArrayList<>();\n+        List<ResolvedDataStream> dataStreams = new ArrayList<>();\n+        TransportAction.resolveIndices(new String[]{\"*\"}, indicesOptions, builder.build(), resolver, indices, aliases, dataStreams, true);\n+\n+        assertThat(dataStreams.size(), equalTo(1));\n+        assertThat(dataStreams.get(0).getBackingIndices().length, equalTo(3));\n+        assertThat(dataStreams.get(0).getBackingIndices()[0], equalTo(backingIndices.get(0).getIndex().getName()));\n+        assertThat(dataStreams.get(0).getBackingIndices()[1], equalTo(backingIndices.get(1).getIndex().getName()));\n+        assertThat(dataStreams.get(0).getBackingIndices()[2], equalTo(backingIndices.get(2).getIndex().getName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cbf078c8f9c0117b38b3d2b78dc15038cc408c07"}, "originalPosition": 29}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53dc2c96f6877c951cd21d18e76fa2a3deef7e09", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/53dc2c96f6877c951cd21d18e76fa2a3deef7e09", "committedDate": "2020-10-16T15:37:29Z", "message": "review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4002, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}