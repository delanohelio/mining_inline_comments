{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2MDIzNTU2", "number": 51330, "title": "[ML][Inference] add tags url param to GET", "bodyText": "Adds a new URL parameter, tags to the GET _ml/inference/<model_id> endpoint.\nThis parameter allows the list of models to be further reduced to those who contain all the provided tags.", "createdAt": "2020-01-22T19:26:42Z", "url": "https://github.com/elastic/elasticsearch/pull/51330", "merged": true, "mergeCommit": {"oid": "c9e285c1e6854fdd3a0a97c75906ea691d5e10ee"}, "closed": true, "closedAt": "2020-01-24T12:30:57Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb861m7AH2gAyMzY2MDIzNTU2Ojk0MWNiNDg5YzdiYzM4NTczOTkzM2E5MWExYzVkNmE2MTA0MDcwMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9ZjH5AFqTM0Nzc3ODcyNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "941cb489c7bc385739933a91a1c5d6a610407008", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/941cb489c7bc385739933a91a1c5d6a610407008", "committedDate": "2020-01-22T19:23:26Z", "message": "[ML][Inference] add tags url param to GET"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "260fa074864847fd9db3990aa0aacb6fecc64b6b", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/260fa074864847fd9db3990aa0aacb6fecc64b6b", "committedDate": "2020-01-22T19:50:08Z", "message": "removing unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3MjY4Njk0", "url": "https://github.com/elastic/elasticsearch/pull/51330#pullrequestreview-347268694", "createdAt": "2020-01-23T12:46:16Z", "commit": {"oid": "260fa074864847fd9db3990aa0aacb6fecc64b6b"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0NjoxN1rOFg86BQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yM1QxMjo0OToxNFrOFg8-4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NjY0NQ==", "bodyText": "Why do we need to verify that it has all the tags?\nIsn't the bool query with tag filters enough?", "url": "https://github.com/elastic/elasticsearch/pull/51330#discussion_r370096645", "createdAt": "2020-01-23T12:46:17Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -404,13 +414,23 @@ public void expandIds(String idExpression,\n                 indicesOptions.expandWildcardsClosed(),\n                 indicesOptions))\n             .source(sourceBuilder);\n+        Set<String> foundResourceIds = new LinkedHashSet<>();\n+        if (tags.isEmpty()) {\n+            foundResourceIds.addAll(matchedResourceIds(tokens));\n+        } else {\n+            for(String resourceId : matchedResourceIds(tokens)) {\n+                // Does the model as a resource have all the tags?\n+                if (Sets.newHashSet(loadModelFromResource(resourceId, true).getTags()).containsAll(tags)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260fa074864847fd9db3990aa0aacb6fecc64b6b"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5NzczNQ==", "bodyText": "Alternatively you could drop this filter part altogether if there are no tags.\nOne more thought: would the following query be equivalent to what you have right now:\nQueryBuilder query = QueryBuilders.boolQuery()\n    .filter(buildQueryIdExpressionQuery(tokens, TrainedModelConfig.MODEL_ID.getPreferredName())));\nfor (String tag : tags) {\n  query.filter(QueryBuilders.termQuery(TrainedModelConfig.TAGS.getPreferredName(), tag));\n}\n\n?\nThis way we can get rid of the ternary operator ? altogether.", "url": "https://github.com/elastic/elasticsearch/pull/51330#discussion_r370097735", "createdAt": "2020-01-23T12:48:53Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -381,14 +381,24 @@ public void deleteTrainedModel(String modelId, ActionListener<Boolean> listener)\n     public void expandIds(String idExpression,\n                           boolean allowNoResources,\n                           @Nullable PageParams pageParams,\n+                          Set<String> tags,\n                           ActionListener<Tuple<Long, Set<String>>> idsListener) {\n         String[] tokens = Strings.tokenizeToStringArray(idExpression, \",\");\n+        BoolQueryBuilder tagQuery = QueryBuilders.boolQuery();\n+        for(String tag : tags) {\n+            tagQuery.filter(QueryBuilders.termQuery(TrainedModelConfig.TAGS.getPreferredName(), tag));\n+        }\n+\n+        QueryBuilder query = QueryBuilders.constantScoreQuery(\n+            QueryBuilders.boolQuery()\n+                .filter(tagQuery.hasClauses() ? tagQuery : QueryBuilders.matchAllQuery())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260fa074864847fd9db3990aa0aacb6fecc64b6b"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDA5Nzg4OA==", "bodyText": "Could you add a unit test to TrainedModelProviderTests for the new functionality?", "url": "https://github.com/elastic/elasticsearch/pull/51330#discussion_r370097888", "createdAt": "2020-01-23T12:49:14Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/persistence/TrainedModelProvider.java", "diffHunk": "@@ -381,14 +381,24 @@ public void deleteTrainedModel(String modelId, ActionListener<Boolean> listener)\n     public void expandIds(String idExpression,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "260fa074864847fd9db3990aa0aacb6fecc64b6b"}, "originalPosition": 1}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cdf61cffbb34df69ab582f3c113311e4b8f39217", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/cdf61cffbb34df69ab582f3c113311e4b8f39217", "committedDate": "2020-01-23T19:08:46Z", "message": "addressing PR comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ3Nzc4NzI2", "url": "https://github.com/elastic/elasticsearch/pull/51330#pullrequestreview-347778726", "createdAt": "2020-01-24T07:10:18Z", "commit": {"oid": "cdf61cffbb34df69ab582f3c113311e4b8f39217"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2869, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}