{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0NDE4NjEx", "number": 57274, "title": "[ML] Adds setting to configure threads used by DF analytics job", "bodyText": "This commit adds a max_num_threads setting to data frame analytics\njobs. The setting value defaults to 1 which, for now, preserves\nbehaviour. Setting it to a higher value allows the analytics process\nto utilize more threads in order to speed up the analysis.\nWe introduce this setting here in order to be able to test node load\nwhen multiple threads are used. Depending on the feedback the setting\nmay be changed. Thus, this commit adds the minimum to allow testing.", "createdAt": "2020-05-28T11:16:16Z", "url": "https://github.com/elastic/elasticsearch/pull/57274", "merged": true, "mergeCommit": {"oid": "105b5853360cf159934cc58883a6afac3626401a"}, "closed": true, "closedAt": "2020-05-28T12:51:39Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclr5GbAH2gAyNDI0NDE4NjExOjg0YzZmYTRmYmFlMDcyN2ZiN2UxNTU0OGUwYTQwMDBlOWExZTVhNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclsfwDgFqTQyMDAyOTg4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71", "committedDate": "2020-05-28T11:09:34Z", "message": "[ML] Adds setting to configure threads used by DF analytics job\n\nThis commit adds a `max_num_threads` setting to data frame analytics\njobs. The setting value defaults to 1 which, for now, preserves\nbehaviour. Setting it to a higher value allows the analytics process\nto utilize more threads in order to speed up the analysis.\n\nWe introduce this setting here in order to be able to test node load\nwhen multiple threads are used. Depending on the feedback the setting\nmay be changed. Thus, this commit adds the minimum to allow testing."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDEwNjA5", "url": "https://github.com/elastic/elasticsearch/pull/57274#pullrequestreview-420010609", "createdAt": "2020-05-28T11:19:51Z", "commit": {"oid": "84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMToxOTo1MVrOGbwq_A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMToxOTo1MVrOGbwq_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc2MjE3Mg==", "bodyText": "We should validate that this setting is >= 1 when it is provided. I did not see this check anywhere (unless you were planning on adding it to the rest layer).", "url": "https://github.com/elastic/elasticsearch/pull/57274#discussion_r431762172", "createdAt": "2020-05-28T11:19:51Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/DataFrameAnalyticsConfig.java", "diffHunk": "@@ -142,6 +146,7 @@ private DataFrameAnalyticsConfig(String id, String description, DataFrameAnalyti\n         this.createTime = createTime == null ? null : Instant.ofEpochMilli(createTime.toEpochMilli());\n         this.version = version;\n         this.allowLazyStart = allowLazyStart;\n+        this.maxNumThreads = maxNumThreads;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71"}, "originalPosition": 35}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMDI5ODg4", "url": "https://github.com/elastic/elasticsearch/pull/57274#pullrequestreview-420029888", "createdAt": "2020-05-28T11:50:12Z", "commit": {"oid": "84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMTo1MDoxMlrOGbxliA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxMTo1MDoxMlrOGbxliA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTc3NzE2MA==", "bodyText": "I'm wondering where we should apply the default: here or in DataFrameAnalyticsConfig.\nIf the calling code doesn't care whether the user has set max_num_threads, the default of 1 could be as well applied in DataFrameAnalyticsConfig's constructor.\nThen we wouldn't need null handling here.\nI don't have a strong opinion though so feel free to disregard the comment.", "url": "https://github.com/elastic/elasticsearch/pull/57274#discussion_r431777160", "createdAt": "2020-05-28T11:50:12Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java", "diffHunk": "@@ -438,12 +443,13 @@ private AnalyticsProcessConfig createProcessConfig(DataFrameDataExtractor dataEx\n                                                            ExtractedFields extractedFields) {\n             DataFrameDataExtractor.DataSummary dataSummary = dataExtractor.collectDataSummary();\n             Set<String> categoricalFields = dataExtractor.getCategoricalFields(config.getAnalysis());\n+            int threads = config.getMaxNumThreads() == null ? 1 : Math.min(config.getMaxNumThreads(), numAllocatedProcessors);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84c6fa4fbae0727fb7e15548e0a4000e9a1e5a71"}, "originalPosition": 58}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4103, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}