{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYyMTQwMzIw", "number": 60585, "title": "Rework checking if a year is a leap year", "bodyText": "This way is faster, saving about 8% on the microbenchmark that rounds to\nthe nearest month. That is in the hot path for date_histogram which is\na very popular aggregation so it seems worth it to at least try and\nspeed it up a little.", "createdAt": "2020-08-03T12:10:05Z", "url": "https://github.com/elastic/elasticsearch/pull/60585", "merged": true, "mergeCommit": {"oid": "1af8d9f228960a62c9b29e920a184a6b6a8f8cf2"}, "closed": true, "closedAt": "2020-08-05T20:09:52Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc7Q8lQAH2gAyNDYyMTQwMzIwOmQyYmE1OTM4ZWY0NzI1MGMwYTFlY2EzMGEyMWZhYTkzZjA5NWIyYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7n-OugFqTQ2MDkwMTAzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d2ba5938ef47250c0a1eca30a21faa93f095b2b2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2ba5938ef47250c0a1eca30a21faa93f095b2b2", "committedDate": "2020-08-03T12:12:16Z", "message": "Rework checking if a year is a leap year\n\nThis way is faster, saving about 8% on the microbenchmark that rounds to\nthe nearest month. That is in the hot path for `date_histogram` which is\na very popular aggregation so it seems worth it to at least try and\nspeed it up a little."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6e833513b5054664973c497b3d971c433d57af6a", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e833513b5054664973c497b3d971c433d57af6a", "committedDate": "2020-08-03T12:06:14Z", "message": "Rework checking if a year is a leap year\n\nThis way is faster, saving about 8% on the microbenchmark that rounds to\nthe nearest month. That is in the hot path for `date_histogram` which is\na very popular aggregation so it seems worth it to at least try and\nspeed it up a little."}, "afterCommit": {"oid": "d2ba5938ef47250c0a1eca30a21faa93f095b2b2", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/d2ba5938ef47250c0a1eca30a21faa93f095b2b2", "committedDate": "2020-08-03T12:12:16Z", "message": "Rework checking if a year is a leap year\n\nThis way is faster, saving about 8% on the microbenchmark that rounds to\nthe nearest month. That is in the hot path for `date_histogram` which is\na very popular aggregation so it seems worth it to at least try and\nspeed it up a little."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU5OTc3Mjk2", "url": "https://github.com/elastic/elasticsearch/pull/60585#pullrequestreview-459977296", "createdAt": "2020-08-03T12:16:09Z", "commit": {"oid": "6e833513b5054664973c497b3d971c433d57af6a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjoxNjoxOFrOG63Ofw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMjoxNjoxOFrOG63Ofw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM3NTQyMw==", "bodyText": "I wrote all this while I was working on this because I couldn't figure out how to get actual intel assembly instructions. It turns out that if you install the hsdis that they build as part of the openjdk you'll just get jvm opcodes. Those are neat, but not useful to me. Instead you need the hsdis from the \"Free Code Manipulation Library\". Which you have to build. And it isn't a simple as git clone foo && cd foo && ./configure && make && sudo make install. You need to do what I did.\nI can separate this out into a separate change if either change is controversial.", "url": "https://github.com/elastic/elasticsearch/pull/60585#discussion_r464375423", "createdAt": "2020-08-03T12:16:18Z", "author": {"login": "nik9000"}, "path": "benchmarks/README.md", "diffHunk": "@@ -63,3 +63,29 @@ To get realistic results, you should exercise care when running benchmarks. Here\n * Blindly believe the numbers that your microbenchmark produces but verify them by measuring e.g. with `-prof perfasm`.\n * Run more threads than your number of CPU cores (in case you run multi-threaded microbenchmarks).\n * Look only at the `Score` column and ignore `Error`. Instead take countermeasures to keep `Error` low / variance explainable.\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d2ba5938ef47250c0a1eca30a21faa93f095b2b2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414", "committedDate": "2020-08-03T12:30:04Z", "message": "no indent"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMDI0Mzg3", "url": "https://github.com/elastic/elasticsearch/pull/60585#pullrequestreview-460024387", "createdAt": "2020-08-03T13:27:15Z", "commit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMzoyNzoxNVrOG65d7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxMzoyNzoxNVrOG65d7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQxMjE0MA==", "bodyText": "This seems like a good candidate for randomized testing, since we have an alternative (slower) implementation that the new implementation should match exactly.  Then again, that might be overkill.", "url": "https://github.com/elastic/elasticsearch/pull/60585#discussion_r464412140", "createdAt": "2020-08-03T13:27:15Z", "author": {"login": "not-napoleon"}, "path": "server/src/test/java/org/elasticsearch/common/time/DateUtilsRoundingTests.java", "diffHunk": "@@ -46,4 +46,14 @@ public void testDateUtilsRounding() {\n             }\n         }\n     }\n+\n+    public void testIsLeapYear() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTExOTcw", "url": "https://github.com/elastic/elasticsearch/pull/60585#pullrequestreview-460111970", "createdAt": "2020-08-03T15:14:47Z", "commit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNToxNDo0OFrOG69lLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNToxNDo0OFrOG69lLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3OTUzMw==", "bodyText": "Seems helpful to me... I would appreciate instructions like this if I were getting started :)", "url": "https://github.com/elastic/elasticsearch/pull/60585#discussion_r464479533", "createdAt": "2020-08-03T15:14:48Z", "author": {"login": "polyfractal"}, "path": "benchmarks/README.md", "diffHunk": "@@ -63,3 +63,29 @@ To get realistic results, you should exercise care when running benchmarks. Here\n * Blindly believe the numbers that your microbenchmark produces but verify them by measuring e.g. with `-prof perfasm`.\n * Run more threads than your number of CPU cores (in case you run multi-threaded microbenchmarks).\n * Look only at the `Score` column and ignore `Error`. Instead take countermeasures to keep `Error` low / variance explainable.\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDM3NTQyMw=="}, "originalCommit": {"oid": "d2ba5938ef47250c0a1eca30a21faa93f095b2b2"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwODg1Njcz", "url": "https://github.com/elastic/elasticsearch/pull/60585#pullrequestreview-460885673", "createdAt": "2020-08-04T14:46:12Z", "commit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwOTAxMDM1", "url": "https://github.com/elastic/elasticsearch/pull/60585#pullrequestreview-460901035", "createdAt": "2020-08-04T15:01:52Z", "commit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTowMTo1M1rOG7kjZQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxNTowMTo1M1rOG7kjZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTExODA1Mw==", "bodyText": "Something I was thinking about - do we see the difference because of the change from year % 400 to (year / 100) & 3, or because of unrolling the short circuit logic?  And if it's only the former, does it make more sense to leave this as a one-liner and let the optimizer short circuit it as necessary?  I'm more asking out of curiosity about how the optimizer works than out of a need to see this changed.", "url": "https://github.com/elastic/elasticsearch/pull/60585#discussion_r465118053", "createdAt": "2020-08-04T15:01:53Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/common/time/DateUtilsRounding.java", "diffHunk": "@@ -92,8 +92,27 @@ static long utcMillisAtStartOfYear(final int year) {\n         return (year * 365L + (leapYears - DAYS_0000_TO_1970)) * MILLIS_PER_DAY; // millis per day\n     }\n \n-    private static boolean isLeapYear(final int year) {\n-        return ((year & 3) == 0) && ((year % 100) != 0 || (year % 400) == 0);\n+    static boolean isLeapYear(final int year) {\n+        // Joda had\n+        // return ((year & 3) == 0) && ((year % 100) != 0 || (year % 400) == 0);\n+        // But we've replaced that with this:\n+        if ((year & 3) != 0) {\n+            return false;\n+        }\n+        if (year % 100 != 0) {\n+            return true;\n+        }\n+        return ((year / 100) & 3) == 0;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fc5734da3bb2b8a3d8e0ffe07cada23a8faaf414"}, "originalPosition": 16}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3612, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}