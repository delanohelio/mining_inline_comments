{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNTEyNjcz", "number": 57185, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjozNzo0NFrOEBbyBg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjozNzo0NFrOEBbyBg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjY5OTM5MjA2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjozNzo0NFrOGdRxEQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNzozMzo0N1rOGdTlLg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw==", "bodyText": "The way I read this, the resource will be marked as dirty any time the node becomes master, not just when it has become master after a mixed cluster upgrade. Am I reading that wrong or is that acceptable?", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433352977", "createdAt": "2020-06-01T16:37:44Z", "author": {"login": "danhermann"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -424,6 +425,14 @@ public HttpExporter(final Config config, final SSLService sslService, final Thre\n \n         // mark resources as dirty after any node failure or license change\n         listener.setResource(resource);\n+\n+        //for a mixed cluster upgrade, ensure that if master changes and this is the master, allow the resources to re-publish\n+        onLocalMasterListener = clusterChangedEvent -> {\n+            if (clusterChangedEvent.nodesDelta().masterNodeChanged() && clusterChangedEvent.localNodeMaster()) {\n+                resource.markDirty();\n+            }\n+        };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8319cf467fa2f56bcec3d5e67075368b1edb5591"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM3MTU4MQ==", "bodyText": "the resource will be marked as dirty any time the node becomes master\n\nThat is correct. However, I am not concerned about the overhead since marking it dirty it will only check to see if the resource exists (and the license level is OK). It will not re-put the watch... even it if it did, it would be functional no-op (putting the same thing that already exists). This all happens on the monitoring thread too, so no worry about extra work (except setting a boolean) on the cluster state applier thread.", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433371581", "createdAt": "2020-06-01T17:13:05Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -424,6 +425,14 @@ public HttpExporter(final Config config, final SSLService sslService, final Thre\n \n         // mark resources as dirty after any node failure or license change\n         listener.setResource(resource);\n+\n+        //for a mixed cluster upgrade, ensure that if master changes and this is the master, allow the resources to re-publish\n+        onLocalMasterListener = clusterChangedEvent -> {\n+            if (clusterChangedEvent.nodesDelta().masterNodeChanged() && clusterChangedEvent.localNodeMaster()) {\n+                resource.markDirty();\n+            }\n+        };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw=="}, "originalCommit": {"oid": "8319cf467fa2f56bcec3d5e67075368b1edb5591"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM4MjcwMg==", "bodyText": "Thanks! LGTM.", "url": "https://github.com/elastic/elasticsearch/pull/57185#discussion_r433382702", "createdAt": "2020-06-01T17:33:47Z", "author": {"login": "danhermann"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporter.java", "diffHunk": "@@ -424,6 +425,14 @@ public HttpExporter(final Config config, final SSLService sslService, final Thre\n \n         // mark resources as dirty after any node failure or license change\n         listener.setResource(resource);\n+\n+        //for a mixed cluster upgrade, ensure that if master changes and this is the master, allow the resources to re-publish\n+        onLocalMasterListener = clusterChangedEvent -> {\n+            if (clusterChangedEvent.nodesDelta().masterNodeChanged() && clusterChangedEvent.localNodeMaster()) {\n+                resource.markDirty();\n+            }\n+        };", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzM1Mjk3Nw=="}, "originalCommit": {"oid": "8319cf467fa2f56bcec3d5e67075368b1edb5591"}, "originalPosition": 27}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3917, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}