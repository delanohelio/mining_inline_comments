{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3MTkzNjEz", "number": 61805, "title": "EQL: Introduce filter pipe", "bodyText": "Allow filtering through a pipe, across events and sequences. Filter\npipes are pushed down to base queries.\nFor now filtering after limit (head/tail) is forbidden as in that case\nthe filter semantics are still up for debate.\nFix #59763", "createdAt": "2020-09-01T16:18:14Z", "url": "https://github.com/elastic/elasticsearch/pull/61805", "merged": true, "mergeCommit": {"oid": "80569a388b76cecb5f55037fe989c8b6f140761b"}, "closed": true, "closedAt": "2020-09-02T12:47:07Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEt8wEgH2gAyNDc3MTkzNjEzOmE4MTE0ZDY2Y2IxZTZkNzVmOTM1MDNjYTMzNTg3NTczNWU2YTM2NTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdE5acIAH2gAyNDc3MTkzNjEzOjkyYjJkZjllZWQ1ZjU4NzRmNmZjZWYyZWYzYzk5ZjFkNTUzMzc1ZDA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8114d66cb1e6d75f93503ca335875735e6a3654", "committedDate": "2020-09-01T21:05:01Z", "message": "EQL: Introduce filter pipe\n\nAllow filtering through a pipe, across events and sequences. Filter\npipes are pushed down to base queries.\nFor now filtering after limit (head/tail) is forbidden as in that case\nthe filter semantics are still up for debate.\n\nFix #59763"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "94a737d65e8089798f3a0a7c3d3d50cca5ef7f0c", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/94a737d65e8089798f3a0a7c3d3d50cca5ef7f0c", "committedDate": "2020-09-01T16:15:30Z", "message": "EQL: Introduce filter pipe\n\nAllow filtering through a pipe, across events and sequences. Filter\npipes are pushed down to base queries.\nFor now filtering after limit (head/tail) is forbidden as in that case\nthe filter semantics are still up for debate.\n\nFix #59763"}, "afterCommit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8114d66cb1e6d75f93503ca335875735e6a3654", "committedDate": "2020-09-01T21:05:01Z", "message": "EQL: Introduce filter pipe\n\nAllow filtering through a pipe, across events and sequences. Filter\npipes are pushed down to base queries.\nFor now filtering after limit (head/tail) is forbidden as in that case\nthe filter semantics are still up for debate.\n\nFix #59763"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNTI2MzQ1", "url": "https://github.com/elastic/elasticsearch/pull/61805#pullrequestreview-480526345", "createdAt": "2020-09-02T06:45:29Z", "commit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwNjo0NToyOVrOHLegyQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwODowMzoxMFrOHLibSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTc5NjI5Nw==", "bodyText": "I am not sure why was this test removed?", "url": "https://github.com/elastic/elasticsearch/pull/61805#discussion_r481796297", "createdAt": "2020-09-02T06:45:29Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries.toml", "diffHunk": "@@ -248,16 +248,6 @@ case_insensitive = true\n query = 'process where process_name >= \"SYSTE\" and process_name <= \"systex\"'\n expected_event_ids  = [1, 2]\n \n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTg2MDQyNg==", "bodyText": "Why 0 now?", "url": "https://github.com/elastic/elasticsearch/pull/61805#discussion_r481860426", "createdAt": "2020-09-02T08:03:10Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/planner/QueryFolderOkTests.java", "diffHunk": "@@ -121,7 +121,7 @@ public void test() {\n         PhysicalPlan p = plan(query);\n         assertEquals(EsQueryExec.class, p.getClass());\n         EsQueryExec eqe = (EsQueryExec) p;\n-        assertEquals(1, eqe.output().size());\n+        assertEquals(0, eqe.output().size());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgwNjI0NTgz", "url": "https://github.com/elastic/elasticsearch/pull/61805#pullrequestreview-480624583", "createdAt": "2020-09-02T09:03:36Z", "commit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowMzozNlrOHLlxlA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQwOTowNjo1NFrOHLl8pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxNTI4NA==", "bodyText": "Can we have a test for this case? (even though it might change in the future)", "url": "https://github.com/elastic/elasticsearch/pull/61805#discussion_r481915284", "createdAt": "2020-09-02T09:03:36Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/analysis/Verifier.java", "diffHunk": "@@ -223,4 +240,12 @@ public Verifier(Metrics metrics) {\n \n         return failures;\n     }\n+\n+    private void checkNoPipesAfterLimit(LogicalPlan p, Set<Failure> localFailures) {\n+        if ((p instanceof LimitWithOffset) == false) {\n+            if (p.anyMatch(LimitWithOffset.class::isInstance)) {\n+                localFailures.add(fail(p, \"Pipe [{}] not allowed (yet) after head/tail\", p.nodeName()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "originalPosition": 100}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTkxODExOA==", "bodyText": "nit: empty line could be removed.", "url": "https://github.com/elastic/elasticsearch/pull/61805#discussion_r481918118", "createdAt": "2020-09-02T09:06:54Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/optimizer/OptimizerTests.java", "diffHunk": "@@ -299,9 +295,63 @@ private void assertOrder(UnaryPlan plan, OrderDirection direction) {\n     }\n \n     private LogicalPlan defaultPipes(LogicalPlan plan) {\n+        assertTrue(plan instanceof Project);\n+        plan = ((Project) plan).child();\n         assertTrue(plan instanceof LimitWithOffset);\n         plan = ((LimitWithOffset) plan).child();\n         assertTrue(plan instanceof OrderBy);\n         return ((OrderBy) plan).child();\n     }\n+\n+\n+    public void testFilterPipePushdownEventQuery() {\n+        Filter filter = new Filter(EMPTY, rel(), new IsNull(EMPTY, Literal.TRUE));\n+        Filter pipe = new Filter(EMPTY, filter, new Equals(EMPTY, timestamp(), Literal.TRUE));\n+\n+        LogicalPlan optimized = new Optimizer.PushDownFilterPipe().rule(pipe);\n+        assertEquals(Filter.class, optimized.getClass());\n+        Filter f = (Filter) optimized;\n+        Expression exp = f.condition();\n+        assertEquals(And.class, exp.getClass());\n+\n+        And and = (And) exp;\n+        assertEquals(filter.condition(), and.left());\n+        assertEquals(pipe.condition(), and.right());\n+    }\n+\n+    public void testFilterPipePushdownSequence() {\n+        Filter filter = new Filter(EMPTY, rel(), new IsNull(EMPTY, Literal.TRUE));\n+        KeyedFilter rule1 = keyedFilter(filter);\n+        KeyedFilter rule2 = keyedFilter(filter);\n+        KeyedFilter until = keyedFilter(filter);\n+        Sequence s = new Sequence(EMPTY, asList(rule1, rule2), until, TimeValue.MINUS_ONE, timestamp(), tiebreaker(), OrderDirection.ASC);\n+        Filter pipe = new Filter(EMPTY, s, new Equals(EMPTY, timestamp(), Literal.TRUE));\n+\n+        // apply it once to push down the filter\n+        LogicalPlan optimized = new Optimizer.PushDownFilterPipe().apply(pipe);\n+        // second to combine the filters\n+        optimized = new Optimizer.PushDownFilterPipe().apply(optimized);\n+        assertEquals(Sequence.class, optimized.getClass());\n+\n+        Sequence seq = (Sequence) optimized;\n+        assertEquals(filter.condition(), condition(seq.until()));\n+\n+        Expression rule1Condition = condition(seq.children().get(0));\n+        And and = (And) rule1Condition;\n+        assertEquals(filter.condition(), and.left());\n+        assertEquals(pipe.condition(), and.right());\n+\n+        Expression rule2Condition = condition(seq.children().get(1));\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a8114d66cb1e6d75f93503ca335875735e6a3654"}, "originalPosition": 142}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "92b2df9eed5f5874f6fcef2ef3c99f1d553375d0", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/92b2df9eed5f5874f6fcef2ef3c99f1d553375d0", "committedDate": "2020-09-02T10:26:24Z", "message": "Address feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4962, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}