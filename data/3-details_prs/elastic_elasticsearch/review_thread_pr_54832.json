{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk5Nzk0MDQ0", "number": 54832, "reviewThreads": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxMTo0NFrODvRIbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDoxNjozNlrODvyZQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODkwMzQ5OnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/functions/date-time.asciidoc", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxMTo0NFrOGBmFpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QyMDozNToyMVrOGCVE6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNTc5OQ==", "bodyText": "drop a : is string null is returned.\nIf the pattern is empty, null be returned - is that the behavior of the other DBs?", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404325799", "createdAt": "2020-04-06T19:11:44Z", "author": {"login": "costin"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`\n+\n+.Synopsis:\n+[source, sql]\n+--------------------------------------------------\n+DATE_FORMAT(\n+    datetime_exp/time_exp, <1>\n+    string_exp) <2>\n+--------------------------------------------------\n+\n+*Input*:\n+\n+<1> date/datetime/time expression\n+<2> format pattern\n+\n+*Output*: string\n+\n+*Description*: Returns the date/datetime/time as a string using the format specified in the 2nd argument. The formatting\n+pattern used is the one from\n+https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/time/format/DateTimeFormatter.html[`java.time.format.DateTimeFormatter`].\n+If any of the two arguments is `null` or the pattern is an empty string a `null` is returned.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MDIzNA==", "bodyText": "MySQL and PostgreSQL return null for empty pattern, SQL Server returns string in the default format.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404350234", "createdAt": "2020-04-06T19:56:16Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`\n+\n+.Synopsis:\n+[source, sql]\n+--------------------------------------------------\n+DATE_FORMAT(\n+    datetime_exp/time_exp, <1>\n+    string_exp) <2>\n+--------------------------------------------------\n+\n+*Input*:\n+\n+<1> date/datetime/time expression\n+<2> format pattern\n+\n+*Output*: string\n+\n+*Description*: Returns the date/datetime/time as a string using the format specified in the 2nd argument. The formatting\n+pattern used is the one from\n+https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/time/format/DateTimeFormatter.html[`java.time.format.DateTimeFormatter`].\n+If any of the two arguments is `null` or the pattern is an empty string a `null` is returned.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNTc5OQ=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTA5NTY1Nw==", "bodyText": "Let's go with the PostgreSQL.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405095657", "createdAt": "2020-04-07T20:35:21Z", "author": {"login": "costin"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`\n+\n+.Synopsis:\n+[source, sql]\n+--------------------------------------------------\n+DATE_FORMAT(\n+    datetime_exp/time_exp, <1>\n+    string_exp) <2>\n+--------------------------------------------------\n+\n+*Input*:\n+\n+<1> date/datetime/time expression\n+<2> format pattern\n+\n+*Output*: string\n+\n+*Description*: Returns the date/datetime/time as a string using the format specified in the 2nd argument. The formatting\n+pattern used is the one from\n+https://docs.oracle.com/en/java/javase/14/docs/api/java.base/java/time/format/DateTimeFormatter.html[`java.time.format.DateTimeFormatter`].\n+If any of the two arguments is `null` or the pattern is an empty string a `null` is returned.", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNTc5OQ=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 25}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODkwNTUxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/qa/src/main/resources/command.csv-spec", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxMjoyMlrOGBmG8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTo1NToyOFrOGBnjaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjEzMA==", "bodyText": "FORMAT seems a bit too generic - is there any DB that uses it?", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404326130", "createdAt": "2020-04-06T19:12:22Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/src/main/resources/command.csv-spec", "diffHunk": "@@ -60,7 +61,8 @@ DAY_OF_WEEK      |SCALAR\n DAY_OF_YEAR      |SCALAR\n DOM              |SCALAR\n DOW              |SCALAR         \n-DOY              |SCALAR         \n+DOY              |SCALAR\n+FORMAT           |SCALAR", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0OTgwMQ==", "bodyText": "SQL Server", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404349801", "createdAt": "2020-04-06T19:55:28Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/resources/command.csv-spec", "diffHunk": "@@ -60,7 +61,8 @@ DAY_OF_WEEK      |SCALAR\n DAY_OF_YEAR      |SCALAR\n DOM              |SCALAR\n DOW              |SCALAR         \n-DOY              |SCALAR         \n+DOY              |SCALAR\n+FORMAT           |SCALAR", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjEzMA=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODkwOTc2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/ToChar.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToxMzoyN1rOGBmJgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOTo1NzoyNVrOGBnneA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjc4NA==", "bodyText": "Why is the function called ToChar and not DateFormat?", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404326784", "createdAt": "2020-04-06T19:13:27Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/ToChar.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.BinaryScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.time.ZoneId;\n+\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+import static org.elasticsearch.xpack.sql.expression.SqlTypeResolutions.isDateOrTime;\n+\n+public class ToChar extends BinaryDateTimeFunction {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0NjQ0Ng==", "bodyText": "No real reason, I just started with the to_char from PostgreSQL.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404346446", "createdAt": "2020-04-06T19:49:30Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/ToChar.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.BinaryScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.time.ZoneId;\n+\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+import static org.elasticsearch.xpack.sql.expression.SqlTypeResolutions.isDateOrTime;\n+\n+public class ToChar extends BinaryDateTimeFunction {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjc4NA=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM1MDg0MA==", "bodyText": "Will rename it according to the name of the function we decide to use finally.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404350840", "createdAt": "2020-04-06T19:57:25Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/ToChar.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.BinaryScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.time.ZoneId;\n+\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+import static org.elasticsearch.xpack.sql.expression.SqlTypeResolutions.isDateOrTime;\n+\n+public class ToChar extends BinaryDateTimeFunction {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMyNjc4NA=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUwODkzOTEyOnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/functions/date-time.asciidoc", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wNlQxOToyMTo1NFrOGBmb-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODo1MzowMlrOGCRlAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTUxMw==", "bodyText": "Do all the function names exist in other DBs? I'd like one which is unique to us due to the Java time format - maybe datetime_format (and datetime_parse) - or vice-versa - format_datetime and parse_datetime.\nMy point is, I think going forward it would be good to have our own function which uses Java time and then support the rest of the DB functions as translating implementation for the given arguments to our class.\nFor example DATE_FORMAT which is MySQL specific would exist as such but the MySQL arguments would then be converted into the java.time pattern.\nOtherwise looking like MySQL but not supporting its pattern is confusing.\nSince the pattern support is tedious, I'm fine with doing that in a separate support for the future. However I'd like to clarify the approach in the docs.\nMySQL DATE_FORMAT: https://dev.mysql.com/doc/refman/8.0/en/date-and-time-functions.html#function_date-format\nSQL Server FORMAT: https://docs.microsoft.com/en-us/sql/t-sql/functions/format-transact-sql?view=sql-server-ver15#ExampleD\nPostgres TO_CHAR: https://www.postgresql.org/docs/9.1/functions-formatting.html\nOracle TOCHAR: https://docs.oracle.com/cd/B19306_01/server.102/b14200/sql_elements004.htm#i34510\nNote that outside MySQL, the rest of the functions accept multiple formats and data types so to avoid confusion, I would not create aliases for them yet.\nBut rather treat them separately since if we are to introduce such functions, we would essentially have to obey their semantics rather then ours.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404331513", "createdAt": "2020-04-06T19:21:54Z", "author": {"login": "costin"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDM0NzY4Mg==", "bodyText": "All of DATE_FORMAT, FORMAT and TO_CHAR and TOCHAR are used in DBs and I agree with the confusion regarding the patterns so I'd go for datetime_format/parse with our own ES-SQL impl (java.time).\n@astefan @bpintea Do you agree with the naming?", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r404347682", "createdAt": "2020-04-06T19:51:49Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTUxMw=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNTg5Mg==", "bodyText": "Renamed to DATETIME_FORMAT", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405005892", "createdAt": "2020-04-07T17:59:44Z", "author": {"login": "matriv"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTUxMw=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAzODMzOA==", "bodyText": "Changed now, but it seems sane to me, \ud83d\udc4d.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405038338", "createdAt": "2020-04-07T18:53:02Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-dateformat]]\n+==== `DATE_FORMAT/FORMAT/TO_CHAR/TOCHAR`", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNDMzMTUxMw=="}, "originalCommit": {"oid": "dfa65155d03f5a28bc4c845984c3bebfc8b5cf60"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxMzM0MDQ5OnYy", "diffSide": "RIGHT", "path": "docs/reference/sql/functions/date-time.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODozNjowNlrOGCQ8kw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxODozNjowNlrOGCQ8kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAyNzk4Nw==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                datetime_exp/time_exp, <1>\n          \n          \n            \n                date_exp/datetime_exp/time_exp, <1>", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405027987", "createdAt": "2020-04-07T18:36:06Z", "author": {"login": "bpintea"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -404,6 +404,48 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateTimeMinutes]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateDiffDateMinutes]\n --------------------------------------------------\n \n+[[sql-functions-datetime-datetimeformat]]\n+==== `DATETIME_FORMAT`\n+\n+.Synopsis:\n+[source, sql]\n+--------------------------------------------------\n+DATETIME_FORMAT(\n+    datetime_exp/time_exp, <1>", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "525fc28f59b0d134a226addd9b3bd2474136d016"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDMzNTMzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/SqlFunctionRegistry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDowNzozOVrOGCafUw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo0NzozMVrOGClM5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NDMzOQ==", "bodyText": "Any particular reason for not using the alphabetical order (as it is now in the registry)?", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405184339", "createdAt": "2020-04-08T00:07:39Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/SqlFunctionRegistry.java", "diffHunk": "@@ -177,6 +178,7 @@ public SqlFunctionRegistry() {\n                 def(MonthName.class, MonthName::new, \"MONTH_NAME\", \"MONTHNAME\"),\n                 def(MonthOfYear.class, MonthOfYear::new, \"MONTH_OF_YEAR\", \"MONTH\"),\n                 def(SecondOfMinute.class, SecondOfMinute::new, \"SECOND_OF_MINUTE\", \"SECOND\"),\n+                def(DateTimeFormat.class, DateTimeFormat::new, \"DATETIME_FORMAT\"),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43af070ef31013db03dd301ff283b84e119d2b96"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM1OTg0NQ==", "bodyText": "Good catch, will fix, It was because of the original name ToChar.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405359845", "createdAt": "2020-04-08T08:47:31Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/SqlFunctionRegistry.java", "diffHunk": "@@ -177,6 +178,7 @@ public SqlFunctionRegistry() {\n                 def(MonthName.class, MonthName::new, \"MONTH_NAME\", \"MONTHNAME\"),\n                 def(MonthOfYear.class, MonthOfYear::new, \"MONTH_OF_YEAR\", \"MONTH\"),\n                 def(SecondOfMinute.class, SecondOfMinute::new, \"SECOND_OF_MINUTE\", \"SECOND\"),\n+                def(DateTimeFormat.class, DateTimeFormat::new, \"DATETIME_FORMAT\"),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NDMzOQ=="}, "originalCommit": {"oid": "43af070ef31013db03dd301ff283b84e119d2b96"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM0MTk1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/BinaryDateTimeDatePartFunction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDoxMTowM1rOGCajRQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDoxMTowM1rOGCajRQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NTM0OQ==", "bodyText": ":-(", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405185349", "createdAt": "2020-04-08T00:11:03Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/BinaryDateTimeDatePartFunction.java", "diffHunk": "@@ -0,0 +1,92 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.logging.LoggerMessageFormat.format;\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+\n+/**\n+ * Abstract super class for functions like {@link DateTrunc} and {@link DatePart}\n+ * which require an argument denoting a unit of date/time.\n+ */\n+public abstract class BinaryDateTimeDatePartFunction extends BinaryDateTimeFunction {\n+\n+    public BinaryDateTimeDatePartFunction(Source source, Expression datePart, Expression timestamp, ZoneId zoneId) {\n+        super(source, datePart, timestamp, zoneId);\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        TypeResolution resolution = isString(left(), sourceText(), Expressions.ParamOrdinal.FIRST);\n+        if (resolution.unresolved()) {\n+            return resolution;\n+        }\n+\n+        if (left().foldable()) {\n+            String datePartValue = (String) left().fold();\n+            if (datePartValue != null && resolveDateTimeField(datePartValue) == false) {\n+                List<String> similar = findSimilarDateTimeFields(datePartValue);\n+                if (similar.isEmpty()) {\n+                    return new TypeResolution(\n+                        format(\n+                            null,\n+                            \"first argument of [{}] must be one of {} or their aliases; found value [{}]\",\n+                            sourceText(),\n+                            validDateTimeFieldValues(),\n+                            Expressions.name(left())\n+                        )", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43af070ef31013db03dd301ff283b84e119d2b96"}, "originalPosition": 48}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUxNDM1MzMxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/DateTimeFormat.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwMDoxNjozNlrOGCap9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQwODo1OToyNlrOGClq9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NzA2MQ==", "bodyText": "isString is enough here? (vs. isStringAndExact)", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405187061", "createdAt": "2020-04-08T00:16:36Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/DateTimeFormat.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.BinaryScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.time.ZoneId;\n+\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+import static org.elasticsearch.xpack.sql.expression.SqlTypeResolutions.isDateOrTime;\n+\n+public class DateTimeFormat extends BinaryDateTimeFunction {\n+\n+    public DateTimeFormat(Source source, Expression timestamp, Expression pattern, ZoneId zoneId) {\n+        super(source, timestamp, pattern, zoneId);\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return DataTypes.KEYWORD;\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        TypeResolution resolution = isDateOrTime(left(), sourceText(), Expressions.ParamOrdinal.FIRST);\n+        if (resolution.unresolved()) {\n+            return resolution;\n+        }\n+        resolution = isString(right(), sourceText(), Expressions.ParamOrdinal.SECOND);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43af070ef31013db03dd301ff283b84e119d2b96"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTM2NzU0MQ==", "bodyText": "Yep, it's enough, tried for example:\nSELECT * FROM test WHERE DATETIME_FORMAT(field1, 'uuuu-MM-dd') = '2020-04-08';\nSELECT DATETIME_FORMAT(field1, 'uuuu-MM-dd') FROM test;\n\non an index:\n{\n    \"mappings\": {\n    \"properties\": {\n      \"field1\": {\n        \"type\": \"date\"\n      },\n      \"field2\": {\n      \t\"type\": \"text\"\n      }\n    }\n  }\n}\n\nand data:\n{\n    \"field1\": \"05/04/2020 10:20:30\",\n    \"field2\": \"uuuu-MM-dd\"\n}\n\nand it works.", "url": "https://github.com/elastic/elasticsearch/pull/54832#discussion_r405367541", "createdAt": "2020-04-08T08:59:26Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/DateTimeFormat.java", "diffHunk": "@@ -0,0 +1,70 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.sql.expression.function.scalar.datetime;\n+\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.function.scalar.BinaryScalarFunction;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.type.DataType;\n+import org.elasticsearch.xpack.ql.type.DataTypes;\n+\n+import java.time.ZoneId;\n+\n+import static org.elasticsearch.xpack.ql.expression.TypeResolutions.isString;\n+import static org.elasticsearch.xpack.sql.expression.SqlTypeResolutions.isDateOrTime;\n+\n+public class DateTimeFormat extends BinaryDateTimeFunction {\n+\n+    public DateTimeFormat(Source source, Expression timestamp, Expression pattern, ZoneId zoneId) {\n+        super(source, timestamp, pattern, zoneId);\n+    }\n+\n+    @Override\n+    public DataType dataType() {\n+        return DataTypes.KEYWORD;\n+    }\n+\n+    @Override\n+    protected TypeResolution resolveType() {\n+        TypeResolution resolution = isDateOrTime(left(), sourceText(), Expressions.ParamOrdinal.FIRST);\n+        if (resolution.unresolved()) {\n+            return resolution;\n+        }\n+        resolution = isString(right(), sourceText(), Expressions.ParamOrdinal.SECOND);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTE4NzA2MQ=="}, "originalCommit": {"oid": "43af070ef31013db03dd301ff283b84e119d2b96"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1251, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}