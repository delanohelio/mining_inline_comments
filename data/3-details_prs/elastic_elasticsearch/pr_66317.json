{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMDAzMDY1", "number": 66317, "title": "Deprecate the id field for the InvalidateApiKey API ", "bodyText": "This PR deprecates the usage of the id field in the payload for the InvalidateApiKey API. The ids field introduced in #63224 is now the recommended way for performing (bulk) API key invalidation. I will have another PR to remove the id field from v8.0 once this one is merged.\nRelevant doc changes:\n\nhttps://elasticsearch_66317.docs-preview.app.elstc.co/guide/en/elasticsearch/client/java-rest/master/java-rest-high-security-invalidate-api-key.html\nhttps://elasticsearch_66317.docs-preview.app.elstc.co/guide/en/elasticsearch/reference/master/security-api-invalidate-api-key.html", "createdAt": "2020-12-15T06:10:02Z", "url": "https://github.com/elastic/elasticsearch/pull/66317", "merged": true, "mergeCommit": {"oid": "00c953346f27c4647ddd2429da9a85fc5a64d34c"}, "closed": true, "closedAt": "2020-12-20T23:45:59Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmUAgsgH2gAyNTQwMDAzMDY1OmUxMWE4YTM2N2FjMmI5Nzg4ZjI1OTVkYmUyZjU4MjUwOGU3NTkwYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnPvgkgH2gAyNTQwMDAzMDY1OjBjZjM5ZmMxNTExNmQ4YWI5NGQwMWRlYjljNGUzZDZlMWUyOWIzNDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/e11a8a367ac2b9788f2595dbe2f582508e7590b4", "committedDate": "2020-12-15T06:05:01Z", "message": "working"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTMzNDY4", "url": "https://github.com/elastic/elasticsearch/pull/66317#pullrequestreview-552133468", "createdAt": "2020-12-15T06:12:52Z", "commit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxMjo1M1rOIF6l3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxMjo1M1rOIF6l3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw==", "bodyText": "I changed this to have an empty name so that the deprecation message generated by LoggingDeprecationHandler does not include the location of the deprecated id field. The value of location is somehow random in the yml test and makes it impossible to match with the warnings directive. Please let me know if there is another preferred solution.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543073757", "createdAt": "2020-12-15T06:12:53Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyMTM1OTUw", "url": "https://github.com/elastic/elasticsearch/pull/66317#pullrequestreview-552135950", "createdAt": "2020-12-15T06:19:08Z", "commit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoxOTowOFrOIF6vDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQwNjoyNjowOVrOIF66Sw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NjExMA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when there are multiple of them\");\n          \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + Arrays.toString(ids));", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543076110", "createdAt": "2020-12-15T06:19:08Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -78,8 +104,19 @@ public String getUserName() {\n         return userName;\n     }\n \n+    @Deprecated\n     public String getId() {\n-        return id;\n+        if (ids == null) {\n+            return null;\n+        } else if (ids.length == 1) {\n+            return ids[0];\n+        } else {\n+            throw new IllegalArgumentException(\"Cannot get a single api key id when there are multiple of them\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3NjM2NQ==", "bodyText": "Should this be a List instead? Then it can be truly immutable.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543076365", "createdAt": "2020-12-15T06:19:42Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -34,38 +36,62 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n+    private final String[] ids;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3ODk4Nw==", "bodyText": "I don't think we should remove location information that would be useful to clients just to help a yml test.\nDoes the yml test need to care?", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r543078987", "createdAt": "2020-12-15T06:26:09Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/action/apikey/RestInvalidateApiKeyAction.java", "diffHunk": "@@ -31,7 +32,7 @@\n  * Rest action to invalidate one or more API keys\n  */\n public final class RestInvalidateApiKeyAction extends ApiKeyBaseRestHandler {\n-    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"invalidate_api_key\",\n+    static final ConstructingObjectParser<InvalidateApiKeyRequest, Void> PARSER = new ConstructingObjectParser<>(\"\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzA3Mzc1Nw=="}, "originalCommit": {"oid": "e11a8a367ac2b9788f2595dbe2f582508e7590b4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66457d03ebc08bad04a07fb247f325cd4eee4cb4", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/66457d03ebc08bad04a07fb247f325cd4eee4cb4", "committedDate": "2020-12-15T23:52:36Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc8fe17e73a658a603139ca676f8e431f87547ff", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/bc8fe17e73a658a603139ca676f8e431f87547ff", "committedDate": "2020-12-16T00:41:55Z", "message": "Merge remote-tracking branch 'origin/master' into deprecate-id-for-invalidate-api-keys"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42675fc5cdaa855cc3d789f320b8631f457a1d5b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/42675fc5cdaa855cc3d789f320b8631f457a1d5b", "committedDate": "2020-12-16T01:06:11Z", "message": "Fix test failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c074d0358ef73aa0b00a72bad3c57a834645cf7e", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c074d0358ef73aa0b00a72bad3c57a834645cf7e", "committedDate": "2020-12-16T04:29:55Z", "message": "Getting deprecation warning working first before change route"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c18071675823f04aba3a3e8df8c7d02a7754fc", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5c18071675823f04aba3a3e8df8c7d02a7754fc", "committedDate": "2020-12-16T04:52:58Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abbc63f1806595fb8de7defc528fca9463ccf746", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/abbc63f1806595fb8de7defc528fca9463ccf746", "committedDate": "2020-12-16T05:11:17Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73a9aa139f951b4a1cd9421c70e277ad2c357e1c", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/73a9aa139f951b4a1cd9421c70e277ad2c357e1c", "committedDate": "2020-12-16T05:18:30Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dcb7f9957f9c2ea9e4d352f4d1feeec5efd09d94", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/dcb7f9957f9c2ea9e4d352f4d1feeec5efd09d94", "committedDate": "2020-12-16T05:42:55Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51097f484487a3b67285ca1a3d819a563a8da293", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/51097f484487a3b67285ca1a3d819a563a8da293", "committedDate": "2020-12-16T06:10:19Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/b0f91816ae97aedd3afd477177e4cb2b0984fde9", "committedDate": "2020-12-17T04:37:26Z", "message": "Restore location info for deprecated field"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1MTIxNTAz", "url": "https://github.com/elastic/elasticsearch/pull/66317#pullrequestreview-555121503", "createdAt": "2020-12-18T01:56:26Z", "commit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NjoyN1rOIIQESQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQwMTo1NzowOFrOIIQFDw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMjc2MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + ids);\n          \n          \n            \n                        throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set [\" + Strings.collectionToCommaDelimitedString(ids) + \"]\");\n          \n      \n    \n    \n  \n\nThere's no guarantee that List.toString will be what we want.", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r545522761", "createdAt": "2020-12-18T01:56:27Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -78,8 +105,19 @@ public String getUserName() {\n         return userName;\n     }\n \n+    @Deprecated\n     public String getId() {\n-        return id;\n+        if (ids == null) {\n+            return null;\n+        } else if (ids.size() == 1) {\n+            return ids.get(0);\n+        } else {\n+            throw new IllegalArgumentException(\"Cannot get a single api key id when multiple ids have been set \" + ids);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "originalPosition": 94}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTUyMjk1OQ==", "bodyText": "Should this be an immutable copy?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    this.ids = apiKeyIds;\n          \n          \n            \n                    this.ids = List.copyOf(apiKeyIds);", "url": "https://github.com/elastic/elasticsearch/pull/66317#discussion_r545522959", "createdAt": "2020-12-18T01:57:08Z", "author": {"login": "tvernum"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/security/InvalidateApiKeyRequest.java", "diffHunk": "@@ -34,38 +37,62 @@\n \n     private final String realmName;\n     private final String userName;\n-    private final String id;\n+    private final List<String> ids;\n     private final String name;\n     private final boolean ownedByAuthenticatedUser;\n \n     // pkg scope for testing\n+    @Deprecated\n     InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName, @Nullable String apiKeyId,\n                             @Nullable String apiKeyName, boolean ownedByAuthenticatedUser) {\n-        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && Strings.hasText(apiKeyId) == false\n-                && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n-            throwValidationError(\"One of [api key id, api key name, username, realm name] must be specified if [owner] flag is false\");\n+        this(realmName, userName, apiKeyName, ownedByAuthenticatedUser, apiKeyIdToIds(apiKeyId));\n+    }\n+\n+    InvalidateApiKeyRequest(@Nullable String realmName, @Nullable String userName,\n+                            @Nullable String apiKeyName, boolean ownedByAuthenticatedUser, @Nullable List<String> apiKeyIds) {\n+        validateApiKeyIds(apiKeyIds);\n+        if (Strings.hasText(realmName) == false && Strings.hasText(userName) == false && apiKeyIds == null\n+            && Strings.hasText(apiKeyName) == false && ownedByAuthenticatedUser == false) {\n+            throwValidationError(\"One of [api key id(s), api key name, username, realm name] must be specified if [owner] flag is false\");\n         }\n-        if (Strings.hasText(apiKeyId) || Strings.hasText(apiKeyName)) {\n+        if (apiKeyIds != null || Strings.hasText(apiKeyName)) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\n-                        \"username or realm name must not be specified when the api key id or api key name is specified\");\n+                    \"username or realm name must not be specified when the api key id(s) or api key name is specified\");\n             }\n         }\n         if (ownedByAuthenticatedUser) {\n             if (Strings.hasText(realmName) || Strings.hasText(userName)) {\n                 throwValidationError(\"neither username nor realm-name may be specified when invalidating owned API keys\");\n             }\n         }\n-        if (Strings.hasText(apiKeyId) && Strings.hasText(apiKeyName)) {\n-            throwValidationError(\"only one of [api key id, api key name] can be specified\");\n+        if (apiKeyIds != null && Strings.hasText(apiKeyName)) {\n+            throwValidationError(\"only one of [api key id(s), api key name] can be specified\");\n         }\n         this.realmName = realmName;\n         this.userName = userName;\n-        this.id = apiKeyId;\n+        this.ids = apiKeyIds;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b0f91816ae97aedd3afd477177e4cb2b0984fde9"}, "originalPosition": 57}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "908ec464588b2f6b5b32d1dbd7ef0ffed7622799", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/908ec464588b2f6b5b32d1dbd7ef0ffed7622799", "committedDate": "2020-12-18T02:54:37Z", "message": "Apply suggestions from code review\n\nCo-authored-by: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "57d9e3e0a38f8919b1fa20fd45765621c3b12449", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/57d9e3e0a38f8919b1fa20fd45765621c3b12449", "committedDate": "2020-12-18T02:57:25Z", "message": "more tweak"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0cf39fc15116d8ab94d01deb9c4e3d6e1e29b348", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0cf39fc15116d8ab94d01deb9c4e3d6e1e29b348", "committedDate": "2020-12-18T03:40:45Z", "message": "fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4511, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}