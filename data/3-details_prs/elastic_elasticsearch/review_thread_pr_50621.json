{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDcxNjAz", "number": 50621, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo0OTozM1rODVwjKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODoyOToxNlrODWVNoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQyMTIyOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo0OTozM1rOFaKF6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo0OTozM1rOFaKF6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3MjY1MQ==", "bodyText": "Should we rename this to just testConcurrentConnects? It doesn't obviously do any disconnecting.", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362972651", "createdAt": "2020-01-03T21:49:33Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca1456a47e5e98dbad741824d83756689dbe559"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQyMjA4OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo1MDoxMlrOFaKGdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo1MDoxMlrOFaKGdQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3Mjc4OQ==", "bodyText": "Could we keep track of all of these connections and assert that all but one of them has been closed when the dust has settled?", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362972789", "createdAt": "2020-01-03T21:50:12Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {\n         DiscoveryNode node = new DiscoveryNode(\"\", new TransportAddress(InetAddress.getLoopbackAddress(), 0), Version.CURRENT);\n-        Transport.Connection connection = new TestConnect(node);\n         doAnswer(invocationOnMock -> {\n+            Transport.Connection connection = new TestConnect(node);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca1456a47e5e98dbad741824d83756689dbe559"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0MTQyODIzOnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo1NDowNFrOFaKKUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wM1QyMTo1NDowNFrOFaKKUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mjk3Mzc3Nw==", "bodyText": "I think it would be good to have these three branches chosen with more equal probabilities (and similarly for the connection validator lambda). As it is, we only complete both listeners on the same thread one in every 10,000 runs I think.", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r362973777", "createdAt": "2020-01-03T21:54:04Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -124,11 +124,10 @@ public void onNodeDisconnected(DiscoveryNode node, Transport.Connection connecti\n         assertEquals(1, nodeDisconnectedCount.get());\n     }\n \n-    @AwaitsFix(bugUrl = \"https://github.com/elastic/elasticsearch/issues/49903\")\n     public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException, InterruptedException {\n         DiscoveryNode node = new DiscoveryNode(\"\", new TransportAddress(InetAddress.getLoopbackAddress(), 0), Version.CURRENT);\n-        Transport.Connection connection = new TestConnect(node);\n         doAnswer(invocationOnMock -> {\n+            Transport.Connection connection = new TestConnect(node);\n             ActionListener<Transport.Connection> listener = (ActionListener<Transport.Connection>) invocationOnMock.getArguments()[2];\n             if (rarely()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cca1456a47e5e98dbad741824d83756689dbe559"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NzQyNzA3OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODoyODo1NFrOFbB5bA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODoyODo1NFrOFbB5bA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg4Njk1Ng==", "bodyText": "Sorry, I misled you, this can be zero if all 10 connection attempts fail.", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r363886956", "createdAt": "2020-01-07T18:28:54Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -198,6 +207,16 @@ public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException\n         });\n \n         assertEquals(10, nodeConnectedCount.get() + nodeFailureCount.get());\n+\n+        // Only a single connection attempt should be open.\n+        long size = connections.stream().filter(c -> !c.isClosed()).count();\n+        assertEquals(1, size);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb4cf03904b0563976e9c58db5e5a0dbed5bce5"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0NzQyODE3OnYy", "diffSide": "RIGHT", "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODoyOToxNlrOFbB6Ew==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wN1QxODoyOToxNlrOFbB6Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2Mzg4NzEyMw==", "bodyText": "== false \u2620\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/50621#discussion_r363887123", "createdAt": "2020-01-07T18:29:16Z", "author": {"login": "DaveCTurner"}, "path": "server/src/test/java/org/elasticsearch/transport/ConnectionManagerTests.java", "diffHunk": "@@ -198,6 +207,16 @@ public void testConcurrentConnectsAndDisconnects() throws BrokenBarrierException\n         });\n \n         assertEquals(10, nodeConnectedCount.get() + nodeFailureCount.get());\n+\n+        // Only a single connection attempt should be open.\n+        long size = connections.stream().filter(c -> !c.isClosed()).count();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ffb4cf03904b0563976e9c58db5e5a0dbed5bce5"}, "originalPosition": 48}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4859, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}