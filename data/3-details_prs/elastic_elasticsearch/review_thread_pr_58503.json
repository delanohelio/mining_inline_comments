{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM5MjcwMzAz", "number": 58503, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNToyOToxNlrOEKjv1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNDoyMVrOEKrifw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NTA2OTAzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNToyOToxNlrOGrq3Yg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo0Mjo1NlrOGr_bZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0NDI1OA==", "bodyText": "nit: why is this moved here? i think setting a member variable shoudl be done on it's own line, like it was before, not hidden inside a list initialization", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448444258", "createdAt": "2020-07-01T15:29:16Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -64,12 +61,11 @@\n     private final DateMathExpressionResolver dateMathExpressionResolver;\n \n     public IndexNameExpressionResolver(Settings settings) {\n-        dateMathExpressionResolver = new DateMathExpressionResolver(settings);\n         expressionResolvers = Arrays.asList(\n-                dateMathExpressionResolver,\n-                new WildcardExpressionResolver());\n+            dateMathExpressionResolver = new DateMathExpressionResolver(settings),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MTE1Ng==", "bodyText": "++ agree. It was moved because I just cherrypicked the changes from https://github.com/elastic/elasticsearch/pull/34507/files and there was no conflict on this one\nwill fix", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448781156", "createdAt": "2020-07-02T06:42:56Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -64,12 +61,11 @@\n     private final DateMathExpressionResolver dateMathExpressionResolver;\n \n     public IndexNameExpressionResolver(Settings settings) {\n-        dateMathExpressionResolver = new DateMathExpressionResolver(settings);\n         expressionResolvers = Arrays.asList(\n-                dateMathExpressionResolver,\n-                new WildcardExpressionResolver());\n+            dateMathExpressionResolver = new DateMathExpressionResolver(settings),", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ0NDI1OA=="}, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 41}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjMzMzk3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoxOTo0OFrOGr3I4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo0NDo0M1rOGr_eRg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NTM0Ng==", "bodyText": "Shouldn't this use the pattern in defaultDateFormatterPattern?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448645346", "createdAt": "2020-07-01T22:19:48Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");\n+            this.defaultDateFormatter = DateFormatters.forPattern(\"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 74}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MTg5NA==", "bodyText": "good catch, this should use the defaultDateFormatterPattern", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448781894", "createdAt": "2020-07-02T06:44:43Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");\n+            this.defaultDateFormatter = DateFormatters.forPattern(\"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NTM0Ng=="}, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 74}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjMzODg3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyMTo0OFrOGr3Low==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo0NTo0MVrOGr_f-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjA1MQ==", "bodyText": "Since this is in 6.8, shouldn't this default format be prefixed with '8' since we still use joda by default here?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448646051", "createdAt": "2020-07-01T22:21:48Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4MjMyOQ==", "bodyText": "yes, should be with 8. will fix", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448782329", "createdAt": "2020-07-02T06:45:41Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -848,22 +844,23 @@ private boolean isEmptyOrTrivialWildcard(List<String> expressions) {\n \n     static final class DateMathExpressionResolver implements ExpressionResolver {\n \n+        private static final DateFormatter DEFAULT_DATE_FORMATTER = DateFormatters.forPattern(\"uuuu.MM.dd\");\n         private static final String EXPRESSION_LEFT_BOUND = \"<\";\n         private static final String EXPRESSION_RIGHT_BOUND = \">\";\n         private static final char LEFT_BOUND = '{';\n         private static final char RIGHT_BOUND = '}';\n         private static final char ESCAPE_CHAR = '\\\\';\n         private static final char TIME_ZONE_BOUND = '|';\n \n-        private final DateTimeZone defaultTimeZone;\n+        private final ZoneId defaultTimeZone;\n         private final String defaultDateFormatterPattern;\n-        private final DateTimeFormatter defaultDateFormatter;\n+        private final DateFormatter defaultDateFormatter;\n \n         DateMathExpressionResolver(Settings settings) {\n             String defaultTimeZoneId = settings.get(\"date_math_expression_resolver.default_time_zone\", \"UTC\");\n-            this.defaultTimeZone = DateTimeZone.forID(defaultTimeZoneId);\n-            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"YYYY.MM.dd\");\n-            this.defaultDateFormatter = DateTimeFormat.forPattern(defaultDateFormatterPattern);\n+            this.defaultTimeZone = ZoneId.of(defaultTimeZoneId);\n+            defaultDateFormatterPattern = settings.get(\"date_math_expression_resolver.default_date_format\", \"uuuu.MM.dd\");", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NjA1MQ=="}, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc5NjM0NTU5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQyMjoyNDoyMVrOGr3PcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMlQwNjo0OToyNFrOGr_mSQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzAyNA==", "bodyText": "We previously added the '8' prefix in date formats so that both joda and java formats could be distinguished. I have a vague memory that the zone identifiers do not completely match up between joda and java. Is this correct? If so, what happens if the format specified by the user is one not supported by java?", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448647024", "createdAt": "2020-07-01T22:24:21Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -947,23 +943,25 @@ String resolveExpression(String expression, final Context context) {\n                                             inPlaceHolderString);\n                                     }\n                                     mathExpression = inPlaceHolderString.substring(0, dateTimeFormatLeftBoundIndex);\n-                                    String patternAndTZid =\n+                                    String dateFormatterPatternAndTimeZoneId =\n                                         inPlaceHolderString.substring(dateTimeFormatLeftBoundIndex + 1, inPlaceHolderString.length() - 1);\n-                                    int formatPatternTimeZoneSeparatorIndex = patternAndTZid.indexOf(TIME_ZONE_BOUND);\n+                                    int formatPatternTimeZoneSeparatorIndex = dateFormatterPatternAndTimeZoneId.indexOf(TIME_ZONE_BOUND);\n                                     if (formatPatternTimeZoneSeparatorIndex != -1) {\n-                                        dateFormatterPattern = patternAndTZid.substring(0, formatPatternTimeZoneSeparatorIndex);\n-                                        timeZone = DateTimeZone.forID(patternAndTZid.substring(formatPatternTimeZoneSeparatorIndex + 1));\n+                                        dateFormatterPattern\n+                                            = dateFormatterPatternAndTimeZoneId.substring(0, formatPatternTimeZoneSeparatorIndex);\n+                                        timeZone = ZoneId.of(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 106}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODc4Mzk0NQ==", "bodyText": "we test against this discrepancies in https://github.com/elastic/elasticsearch/blob/6.8/server/src/test/java/org/elasticsearch/common/time/DateUtilsTests.java#L38\nas long as timezone dbs are the same in both joda and java (and we make sure about this with this test) then there should always be a match", "url": "https://github.com/elastic/elasticsearch/pull/58503#discussion_r448783945", "createdAt": "2020-07-02T06:49:24Z", "author": {"login": "pgomulka"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -947,23 +943,25 @@ String resolveExpression(String expression, final Context context) {\n                                             inPlaceHolderString);\n                                     }\n                                     mathExpression = inPlaceHolderString.substring(0, dateTimeFormatLeftBoundIndex);\n-                                    String patternAndTZid =\n+                                    String dateFormatterPatternAndTimeZoneId =\n                                         inPlaceHolderString.substring(dateTimeFormatLeftBoundIndex + 1, inPlaceHolderString.length() - 1);\n-                                    int formatPatternTimeZoneSeparatorIndex = patternAndTZid.indexOf(TIME_ZONE_BOUND);\n+                                    int formatPatternTimeZoneSeparatorIndex = dateFormatterPatternAndTimeZoneId.indexOf(TIME_ZONE_BOUND);\n                                     if (formatPatternTimeZoneSeparatorIndex != -1) {\n-                                        dateFormatterPattern = patternAndTZid.substring(0, formatPatternTimeZoneSeparatorIndex);\n-                                        timeZone = DateTimeZone.forID(patternAndTZid.substring(formatPatternTimeZoneSeparatorIndex + 1));\n+                                        dateFormatterPattern\n+                                            = dateFormatterPatternAndTimeZoneId.substring(0, formatPatternTimeZoneSeparatorIndex);\n+                                        timeZone = ZoneId.of(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODY0NzAyNA=="}, "originalCommit": {"oid": "e7f1ba28d244bf12e23f26addc603400354b9212"}, "originalPosition": 106}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1406, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}