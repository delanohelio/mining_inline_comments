{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQ0NjIyNjM0", "number": 66769, "title": "Fix azure repo stream exhaust check for multipart uploads", "bodyText": "This PR fixes the validation of the conversion from an input stream to a flux in the\nAzureBlobStore's multipart update logic, which erroneously checked that the upload\ninput stream is exhausted after each part's flux is completed. It should instead check\nthat the stream is only exhausted after the lat part's flux is completed.\nI couldn't spot any unit tests for the AzureBlobStore's upload logic, so I've not added any\ntests for this PR either.", "createdAt": "2020-12-23T07:28:33Z", "url": "https://github.com/elastic/elasticsearch/pull/66769", "merged": true, "mergeCommit": {"oid": "a1844863629684c8abb9673b8bc4fcab98934ca7"}, "closed": true, "closedAt": "2021-01-04T15:49:41Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdo5xNugH2gAyNTQ0NjIyNjM0OmI1ODQ2YTdkODM2NzA0NjdkNzA3OTU3YWJlYzZiOTBhMDhkZDFmOTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABds23A6AH2gAyNTQ0NjIyNjM0OjE3YTczNWUxYmU2MGU4N2ZhMWViMDAwMGMzMmVjMTQ3MWVlNzQyOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b5846a7d83670467d707957abec6b90a08dd1f92", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5846a7d83670467d707957abec6b90a08dd1f92", "committedDate": "2020-12-23T07:12:33Z", "message": "Fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMDM3MjM3", "url": "https://github.com/elastic/elasticsearch/pull/66769#pullrequestreview-560037237", "createdAt": "2020-12-30T12:56:10Z", "commit": {"oid": "b5846a7d83670467d707957abec6b90a08dd1f92"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMjo1NjoxMVrOIMsroA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0zMFQxMjo1NjoxMVrOIMsroA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU1MDE4NTg4OA==", "bodyText": "I wonder if we should just drop this check altogether instead? It seems kind of weird to check that we drained the stream fully when we also give the size we want to write (and the check relies on the fact that the stream reports available() as well which is not guaranteed).\nMaybe we should just drop this check and only check that currentTotalLength == blobSize at the end? I think I'd prefer that option and it simplifies things?", "url": "https://github.com/elastic/elasticsearch/pull/66769#discussion_r550185888", "createdAt": "2020-12-30T12:56:11Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -438,8 +449,21 @@ private void executeMultipartUpload(String blobName, InputStream inputStream, lo\n             final List<String> blockIds = new ArrayList<>(nbParts);\n             for (int i = 0; i < nbParts; i++) {\n                 final long length = i < nbParts - 1 ? partSize : lastPartSize;\n-                final Flux<ByteBuffer> byteBufferFlux =\n-                    convertStreamToByteBuffer(inputStream, length, DEFAULT_UPLOAD_BUFFERS_SIZE);\n+                Flux<ByteBuffer> byteBufferFlux = convertStreamToByteBuffer(inputStream, length, DEFAULT_UPLOAD_BUFFERS_SIZE);\n+                if (i == nbParts - 1) {\n+                    byteBufferFlux.doOnComplete(() -> {\n+                        try {\n+                            if (inputStream.available() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b5846a7d83670467d707957abec6b90a08dd1f92"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cd6048967e703cbd97de19123126fbfee297d333", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/cd6048967e703cbd97de19123126fbfee297d333", "committedDate": "2020-12-31T07:13:24Z", "message": "Merge branch 'master' into fix-azure-repo-flux-ensure-exhausted-stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "491d348e5d3b8c15c782e2b42bfea6daff0feba9", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/491d348e5d3b8c15c782e2b42bfea6daff0feba9", "committedDate": "2020-12-31T07:36:57Z", "message": "Remove doOnComplete that stream is exhausted"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "50d3abd30fd383cdb7b317240da871ddd0a944a6", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/50d3abd30fd383cdb7b317240da871ddd0a944a6", "committedDate": "2020-12-31T07:33:22Z", "message": "Remove doOnComplete that stream is exhausted"}, "afterCommit": {"oid": "491d348e5d3b8c15c782e2b42bfea6daff0feba9", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/491d348e5d3b8c15c782e2b42bfea6daff0feba9", "committedDate": "2020-12-31T07:36:57Z", "message": "Remove doOnComplete that stream is exhausted"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwMzA4OTg0", "url": "https://github.com/elastic/elasticsearch/pull/66769#pullrequestreview-560308984", "createdAt": "2020-12-31T09:45:26Z", "commit": {"oid": "491d348e5d3b8c15c782e2b42bfea6daff0feba9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTYwODcxMDU1", "url": "https://github.com/elastic/elasticsearch/pull/66769#pullrequestreview-560871055", "createdAt": "2021-01-04T09:09:00Z", "commit": {"oid": "491d348e5d3b8c15c782e2b42bfea6daff0feba9"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17a735e1be60e87fa1eb0000c32ec1471ee74296", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/17a735e1be60e87fa1eb0000c32ec1471ee74296", "committedDate": "2021-01-04T14:04:52Z", "message": "Merge branch 'master' into fix-azure-repo-flux-ensure-exhausted-stream"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4315, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}