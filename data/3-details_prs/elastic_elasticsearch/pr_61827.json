{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NTI4MjU0", "number": 61827, "title": "Support point in time cross cluster search", "bodyText": "This commit integrates point in time into cross cluster search.\n0a99df6 -> Closes #61790\nRelates #61062", "createdAt": "2020-09-02T02:27:36Z", "url": "https://github.com/elastic/elasticsearch/pull/61827", "merged": true, "mergeCommit": {"oid": "161ec69f77608c446ece3102f7c83dd21a3c8263"}, "closed": true, "closedAt": "2020-09-10T00:55:45Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdEyabRgH2gAyNDc3NTI4MjU0OjIyODUwZmE1YTQ0MzViNTZiODBlOTRhNWM3MTMyZDM0MWEyNjc3Zjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHUtPIgH2gAyNDc3NTI4MjU0OmIzZjY2MjQ4M2I0MTc5YzM3ZjY2N2NjNmUzZDI2YzFjOWQzYjdkNWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "22850fa5a4435b56b80e94a5c7132d341a2677f8", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/22850fa5a4435b56b80e94a5c7132d341a2677f8", "committedDate": "2020-09-02T02:17:03Z", "message": "Support point in time cross cluster search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e207090bbbada80349a69dd734a7d62aa6eb5065", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e207090bbbada80349a69dd734a7d62aa6eb5065", "committedDate": "2020-09-02T02:45:42Z", "message": "stylecheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81d6b49be1c7be37bf2af420555d3a059c156d85", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/81d6b49be1c7be37bf2af420555d3a059c156d85", "committedDate": "2020-09-02T03:41:20Z", "message": "leftover"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxMjIyNTE4", "url": "https://github.com/elastic/elasticsearch/pull/61827#pullrequestreview-481222518", "createdAt": "2020-09-02T19:20:05Z", "commit": {"oid": "81d6b49be1c7be37bf2af420555d3a059c156d85"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToyMDowNVrOHL_EOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMlQxOToyMDozN1rOHL_F-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMyOTY1OA==", "bodyText": "I think we should still accept the param if it is set to false ?", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r482329658", "createdAt": "2020-09-02T19:20:05Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/rest/action/search/RestSearchAction.java", "diffHunk": "@@ -308,6 +309,11 @@ static void preparePointInTime(SearchRequest request, NamedWriteableRegistry nam\n         if (request.preference() != null) {\n             validationException = addValidationError(\"[preference] cannot be used with point in time\", validationException);\n         }\n+        if (restRequest.hasParam(\"ccs_minimize_roundtrips\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81d6b49be1c7be37bf2af420555d3a059c156d85"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MjMzMDEwNg==", "bodyText": "Why is it needed ?", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r482330106", "createdAt": "2020-09-02T19:20:37Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/search/action/TransportOpenPointInTimeAction.java", "diffHunk": "@@ -72,6 +72,7 @@ protected void doExecute(Task task, OpenPointInTimeRequest request, ActionListen\n             .preference(request.preference())\n             .routing(request.routing())\n             .allowPartialSearchResults(false);\n+        searchRequest.setCcsMinimizeRoundtrips(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "81d6b49be1c7be37bf2af420555d3a059c156d85"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "293869407ae0e9bcb89c8e93ecc03a0821aa8652", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/293869407ae0e9bcb89c8e93ecc03a0821aa8652", "committedDate": "2020-09-06T18:13:41Z", "message": "Merge branch 'master' into ccs-with-pit"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg0NTM5Mzcy", "url": "https://github.com/elastic/elasticsearch/pull/61827#pullrequestreview-484539372", "createdAt": "2020-09-08T22:43:52Z", "commit": {"oid": "293869407ae0e9bcb89c8e93ecc03a0821aa8652"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjo0Mzo1MlrOHOwZ3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wOFQyMjo0Mzo1MlrOHOwZ3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NTIzNTE2NA==", "bodyText": "While this is something that we'll need in the future I don't think we can afford adding replicas other than the original one now. There's no chance that the query succeeds there so that's confusing for users (and could faild some tests) if we return a search context missing exception every time there's an exception on the matching node.", "url": "https://github.com/elastic/elasticsearch/pull/61827#discussion_r485235164", "createdAt": "2020-09-08T22:43:52Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java", "diffHunk": "@@ -535,13 +567,33 @@ private void executeLocalSearch(Task task, SearchTimeProvider timeProvider, Sear\n                 remoteShardIterators.add(shardIterator);\n             }\n         }\n-        return (clusterAlias, nodeId) -> {\n-                Map<String, DiscoveryNode> clusterNodes = clusterToNode.get(clusterAlias);\n-                if (clusterNodes == null) {\n-                    throw new IllegalArgumentException(\"unknown remote cluster: \" + clusterAlias);\n+        return remoteShardIterators;\n+    }\n+\n+    static List<SearchShardIterator> getRemoteShardsIteratorFromPointInTime(Map<String, ClusterSearchShardsResponse> searchShardsResponses,\n+                                                                            SearchContextId searchContextId,\n+                                                                            TimeValue searchContextKeepAlive,\n+                                                                            Map<String, OriginalIndices> remoteClusterIndices) {\n+        final List<SearchShardIterator> remoteShardIterators = new ArrayList<>();\n+        for (Map.Entry<String, ClusterSearchShardsResponse> entry : searchShardsResponses.entrySet()) {\n+            for (ClusterSearchShardsGroup group : entry.getValue().getGroups()) {\n+                final ShardId shardId = group.getShardId();\n+                final String clusterAlias = entry.getKey();\n+                final SearchContextIdForNode perNode = searchContextId.shards().get(shardId);\n+                assert clusterAlias.equals(perNode.getClusterAlias()) : clusterAlias + \" != \" + perNode.getClusterAlias();\n+                final List<String> nodeIds = new ArrayList<>();\n+                nodeIds.add(perNode.getNode()); // always search with the matching node first\n+                for (ShardRouting shard : group.getShards()) {\n+                    if (perNode.getNode().equals(shard.currentNodeId()) == false) {\n+                        nodeIds.add(shard.currentNodeId());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "293869407ae0e9bcb89c8e93ecc03a0821aa8652"}, "originalPosition": 129}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc88c83234526df53fc7adf36f77076367a55509", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc88c83234526df53fc7adf36f77076367a55509", "committedDate": "2020-09-09T15:50:32Z", "message": "Merge branch 'master' into ccs-with-pit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f83433bbca3640d23dd8b988d5646553dc3b334b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f83433bbca3640d23dd8b988d5646553dc3b334b", "committedDate": "2020-09-09T16:06:36Z", "message": "Fix NPE"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "44f14d3785db37de1fa33ec197e3501523d220de", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/44f14d3785db37de1fa33ec197e3501523d220de", "committedDate": "2020-09-09T18:52:22Z", "message": "feedback rest params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0a99df6e9a3cf1834b19e23bc9f2076358ab94ed", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0a99df6e9a3cf1834b19e23bc9f2076358ab94ed", "committedDate": "2020-09-09T19:02:47Z", "message": "Do not add unmatched shard routing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "af61fcbceb5928a1440f0b6b3b4020eb93a27574", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/af61fcbceb5928a1440f0b6b3b4020eb93a27574", "committedDate": "2020-09-09T19:13:00Z", "message": "stylecheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e0180448815d3e0ee463e02f9d5be6974b687a7", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e0180448815d3e0ee463e02f9d5be6974b687a7", "committedDate": "2020-09-09T20:19:01Z", "message": "accept no params or false for ccs_minimize_roundtrips"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e8a94e95ca9cdc450ec15ade7973705afa3cf0c3", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e8a94e95ca9cdc450ec15ade7973705afa3cf0c3", "committedDate": "2020-09-09T20:33:40Z", "message": "remove AwaitsFix in async search"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b5658a1368f459ca3a1692c27111b2667a8b1dfa", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b5658a1368f459ca3a1692c27111b2667a8b1dfa", "committedDate": "2020-09-09T21:31:10Z", "message": "oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3f662483b4179c37f667cc6e3d26c1c9d3b7d5c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3f662483b4179c37f667cc6e3d26c1c9d3b7d5c", "committedDate": "2020-09-09T23:22:13Z", "message": "check if index exists"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4980, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}