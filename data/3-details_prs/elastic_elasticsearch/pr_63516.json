{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMjM3Njc2", "number": 63516, "title": "Add precommit check for the layout pattern for security auditing", "bodyText": "x-pack:plugin:core contains a log4j2.properties conf file that must be used for the ES Security audit logs (the audit log uses the log4j2 library and also requires a special layout pattern, which is defined in the conf file). We have unit tests that validate this layout pattern, which is used in the archive builds.\nThe problem is that the log4j2.properties conf file has to be slightly different for docker builds. Probably the most important reason for that is that in a docker environment the logs are all outputted to the console. But the layout pattern should not be different in the two situations. Whenever the layout pattern changes to accommodate new audit record fields, the changes must be reflected to both files.\nThis PR adds the audit record fields from #58928 to the docker build's layout pattern config. This was a mistake, those changes should've been replicated back then.\nIt also adds a verification task to the distribution:docker project which would catch future such problems.", "createdAt": "2020-10-08T22:52:06Z", "url": "https://github.com/elastic/elasticsearch/pull/63516", "merged": true, "mergeCommit": {"oid": "1d7525f5c2e334de05f667f86a3b8d56b8edc415"}, "closed": true, "closedAt": "2020-10-14T13:40:33Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQpTfMgH2gAyNTAwMjM3Njc2OjRkZWEwMzJiODViYzUxZjA0NDY4MjNlNmNiMGQxZmViYjQ1NWNiYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdScb2ZAFqTUwODI5NzE0OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/4dea032b85bc51f0446823e6cb0d1febb455cbac", "committedDate": "2020-10-08T22:27:25Z", "message": "Done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA1MjM0MzE1", "url": "https://github.com/elastic/elasticsearch/pull/63516#pullrequestreview-505234315", "createdAt": "2020-10-08T23:01:58Z", "commit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMTo1OFrOHezYaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMzoxM1rOHezbMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTE2MA==", "bodyText": "I wonder if we should wire this to precommit so it fails early. Otherwise this will only fail when we actually go to build these docker images.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061160", "createdAt": "2020-10-08T23:01:58Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTg3Mw==", "bodyText": "We should give some indication as to where \"this task's declaration\" lives. Perhaps provide the relative path to this build.gradle file in the exception message? Or instead externalize the checksum in a file (like we do for dependency artifacts) and just point to that so folks don't actually have to change build scripts.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061873", "createdAt": "2020-10-08T23:03:13Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {\n+  /*\n+   * Whenever the x-pack/plugin/core/src/main/config/log4j2.properties is changed it might be that the\n+   * distribution/docker/src/docker/config/log4j2.properties file needs changing as well.\n+   *\n+   * This task fails if the x-pack/plugin/core/src/main/config/log4j2.properties file\n+   * has been modified. Please ensure that the distribution/docker/src/docker/config/log4j2.properties\n+   * file is also modified such that it reflects the same changes.\n+   *\n+   * SET THIS to the value of checksumOriginalLog4j after the two files have been confirmed as equivalent\n+   */\n+  def validatedChecksumOriginalLog4j = \"+GJ/QjaApSAiejScjiwFEg==\"\n+  doLast {\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties').getBytes()\n+    def checksumOriginalLog4j = Base64.getEncoder().encodeToString(MessageDigest.getInstance(\"MD5\").digest(originalLog4j))\n+    if (false == validatedChecksumOriginalLog4j.equals(checksumOriginalLog4j)) {\n+      throw new GradleException(\"The src/main/config/log4j2.properties file from the x-pack:plugin:core has been changed. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a46ca0f1e03c6d2ee1c206c90bf05218f14768ed", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a46ca0f1e03c6d2ee1c206c90bf05218f14768ed", "committedDate": "2020-10-13T13:59:31Z", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74cfcff4d434b10f786ec4026391f889ce35bb42", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/74cfcff4d434b10f786ec4026391f889ce35bb42", "committedDate": "2020-10-13T15:41:16Z", "message": "check by property name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/584a59060e7f196a25f460dccde7b750b1601f25", "committedDate": "2020-10-13T15:43:48Z", "message": "Revert prev"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA3ODYyMzY0", "url": "https://github.com/elastic/elasticsearch/pull/63516#pullrequestreview-507862364", "createdAt": "2020-10-13T22:06:44Z", "commit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowNjo0NVrOHg7LNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowODowNFrOHg7NFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjAwNw==", "bodyText": "We should define the properties files as inputs so that this task can be UP-TO-DATE when nothing changes.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286007", "createdAt": "2020-10-13T22:06:45Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjQ4Ng==", "bodyText": "This is Groovy, so need to do string concatination, just use groovy string interpolation (ex: \"The [${originalLog4j.path}] file...\").", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286486", "createdAt": "2020-10-13T22:08:04Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [\" + originalLog4j.getPath() + \"] file changed such that the layout pattern is not \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2cf6ceaa7e68fb3b1b183c105204c9d808efd3c4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2cf6ceaa7e68fb3b1b183c105204c9d808efd3c4", "committedDate": "2020-10-14T08:09:16Z", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1af98251bc87bc934691f221ce71bc2a8020c47", "committedDate": "2020-10-14T08:50:37Z", "message": "Inputs to task as per Mark's review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4MTc0NTU0", "url": "https://github.com/elastic/elasticsearch/pull/63516#pullrequestreview-508174554", "createdAt": "2020-10-14T09:44:25Z", "commit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0NDoyNVrOHhK8vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0NDozMFrOHhK86Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ0Ng==", "bodyText": "you can just do project.file(\"src/docker/config/log4j2.properties\")", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544446", "createdAt": "2020-10-14T09:44:25Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ4OQ==", "bodyText": "Please use tasks.named(\"precommit\").configure { it.dependsOn('checkSecurityAuditLayoutPatternIdentical') } to make use of gradles \"task avoidance api\" to avoid creating tasks early. see https://docs.gradle.org/current/userguide/task_configuration_avoidance.html for further information", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544489", "createdAt": "2020-10-14T09:44:30Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()\n+  inputs.files(originalLog4j, dockerLog4j)\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${originalLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    def dockerLog4jProperties = new Properties()\n+    dockerLog4j.withInputStream { input ->\n+      dockerLog4jProperties.load(input)\n+    }\n+\n+    if (false == dockerLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${dockerLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    if (false == coreLog4jProperties.getProperty(patternPropertyKey).equals(dockerLog4jProperties.getProperty(patternPropertyKey))) {\n+      throw new GradleException(\"The property value for the layout pattern [${patternPropertyKey}] is NOT identical \" +\n+              \"between the [${originalLog4j.getPath()}] and the [${dockerLog4j.getPath()}] files.\")\n+    }\n+  }\n+}\n+precommit.dependsOn 'checkSecurityAuditLayoutPatternIdentical'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b978af324a2e224769e7e88fdc3c686add0c213a", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/b978af324a2e224769e7e88fdc3c686add0c213a", "committedDate": "2020-10-14T11:21:51Z", "message": "rene's review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2d77aa38c4805bb3f5fd31c7a473f906b3298f86", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d77aa38c4805bb3f5fd31c7a473f906b3298f86", "committedDate": "2020-10-14T11:22:00Z", "message": "Merge branch 'master' into audit_log4j_configuration_sync_up"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA4Mjk3MTQ5", "url": "https://github.com/elastic/elasticsearch/pull/63516#pullrequestreview-508297149", "createdAt": "2020-10-14T12:35:38Z", "commit": {"oid": "2d77aa38c4805bb3f5fd31c7a473f906b3298f86"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4274, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}