{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk4MzA4MDM5", "number": 63302, "title": "[ML] Validate that AucRoc has the data necessary to be calculated", "bodyText": "When AucRoc is evaluated in the context of multiclass classification evaluation, it must require that the probability of the class in question (class_name) is known for every document. Otherwise, the results will not be correct.\nThis PR tightens the validation so that when the probability of the class in question is not known for at least one document, the evaluation request fails rather than returning erroneous results.\nConsequently, AbstractAucRoc.Result.doc_count field is no longer needed so it is removed in this PR as well.\nMarking this PR >non-issue as the AucRoc metric is not released yet.\nRelates #63306", "createdAt": "2020-10-06T06:39:46Z", "url": "https://github.com/elastic/elasticsearch/pull/63302", "merged": true, "mergeCommit": {"oid": "b0019bd0a6c565309f8f97b59e2e3b6c755165fe"}, "closed": true, "closedAt": "2020-10-08T06:19:44Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPzGLEABqjM4NDM4NDM2NTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQL96KABqjM4NTAyMTQyMzg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2d4e6c2b9b2c89b98cf0bfe8adf507b3f44aafa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2d4e6c2b9b2c89b98cf0bfe8adf507b3f44aafa", "committedDate": "2020-10-06T06:39:00Z", "message": "Remove AbstractAucRoc.Result.doc_count field"}, "afterCommit": {"oid": "13cd18b8f277a254bd75c32e95d8a695b92dce48", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/13cd18b8f277a254bd75c32e95d8a695b92dce48", "committedDate": "2020-10-06T07:17:28Z", "message": "Remove AbstractAucRoc.Result.doc_count field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08045f5530ff8e3435144c0fcd6921aa11c16b09", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/08045f5530ff8e3435144c0fcd6921aa11c16b09", "committedDate": "2020-10-06T08:05:31Z", "message": "Remove"}, "afterCommit": {"oid": "08a3942e819ced0f3218779914268bb4388e6f5b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/08a3942e819ced0f3218779914268bb4388e6f5b", "committedDate": "2020-10-06T08:05:58Z", "message": "Remove AbstractAucRoc.Result.doc_count field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "08a3942e819ced0f3218779914268bb4388e6f5b", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/08a3942e819ced0f3218779914268bb4388e6f5b", "committedDate": "2020-10-06T08:05:58Z", "message": "Remove AbstractAucRoc.Result.doc_count field"}, "afterCommit": {"oid": "f41a7f55afe011341b6166e914bd17bc3d5687d2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f41a7f55afe011341b6166e914bd17bc3d5687d2", "committedDate": "2020-10-06T08:27:21Z", "message": "Validate that AucRoc has the data necessary to be calculated\nRemove AbstractAucRoc.Result.doc_count field"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f41a7f55afe011341b6166e914bd17bc3d5687d2", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/f41a7f55afe011341b6166e914bd17bc3d5687d2", "committedDate": "2020-10-06T08:27:21Z", "message": "Validate that AucRoc has the data necessary to be calculated\nRemove AbstractAucRoc.Result.doc_count field"}, "afterCommit": {"oid": "b3c872774c36eb03366c289d6cbaf544b52c3efa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3c872774c36eb03366c289d6cbaf544b52c3efa", "committedDate": "2020-10-06T09:09:41Z", "message": "Validate that AucRoc has the data necessary to be calculated\nRemove AbstractAucRoc.Result.doc_count field"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyODQ2MTY3", "url": "https://github.com/elastic/elasticsearch/pull/63302#pullrequestreview-502846167", "createdAt": "2020-10-06T11:37:35Z", "commit": {"oid": "16d8a2464021824a734a001d20359536e3318432"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTozNzozNVrOHdCHqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNlQxMTo0Mzo0M1rOHdCUtA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIwNTQ4Mg==", "bodyText": "\"well actually\" 1-p doesn't seem correct here as there could be more than two classes.\nBut, from what I tell, this doesn't effect the testing, right?", "url": "https://github.com/elastic/elasticsearch/pull/63302#discussion_r500205482", "createdAt": "2020-10-06T11:37:35Z", "author": {"login": "benwtrent"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/MachineLearningIT.java", "diffHunk": "@@ -2143,15 +2142,19 @@ private static XContentBuilder mappingForClassification() throws IOException {\n         .endObject();\n     }\n \n-    private static IndexRequest docForClassification(String indexName, String actualClass, String predictedClass, double p) {\n+    private static IndexRequest docForClassification(String indexName,\n+                                                     String actualClass,\n+                                                     String predictedClass,\n+                                                     double p,\n+                                                     String otherClass) {\n         return new IndexRequest()\n             .index(indexName)\n             .source(XContentType.JSON,\n                 actualClassField, actualClass,\n                 predictedClassField, predictedClass,\n                 topClassesField, List.of(\n                     Map.of(\"class_name\", predictedClass, \"class_probability\", p),\n-                    Map.of(\"class_name\", \"other\", \"class_probability\", 1 - p)));\n+                    Map.of(\"class_name\", otherClass, \"class_probability\", 1 - p)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d8a2464021824a734a001d20359536e3318432"}, "originalPosition": 55}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIwNjU2Ng==", "bodyText": "Honestly, I think it would be good to have more than two classes here to really represent the multi-class case.", "url": "https://github.com/elastic/elasticsearch/pull/63302#discussion_r500206566", "createdAt": "2020-10-06T11:39:39Z", "author": {"login": "benwtrent"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/documentation/MlClientDocumentationIT.java", "diffHunk": "@@ -3466,28 +3466,28 @@ public void testEvaluateDataFrame_Classification() throws Exception {\n                         .endObject()\n                     .endObject()\n                     .endObject());\n-        TriFunction<String, String, Double, IndexRequest> indexRequest = (actualClass, predictedClass, p) -> {\n+        TriFunction<String, String, String, IndexRequest> indexRequest = (actualClass, predictedClass, otherClass) -> {\n             return new IndexRequest()\n                 .source(XContentType.JSON,\n                     \"actual_class\", actualClass,\n                     \"predicted_class\", predictedClass,\n                     \"ml.top_classes\", List.of(\n-                        Map.of(\"class_name\", predictedClass, \"class_probability\", p),\n-                        Map.of(\"class_name\", \"other\", \"class_probability\", 1 - p)));\n+                        Map.of(\"class_name\", predictedClass, \"class_probability\", 0.9),\n+                        Map.of(\"class_name\", otherClass, \"class_probability\", 0.1)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d8a2464021824a734a001d20359536e3318432"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMDIwODgyMA==", "bodyText": "Do you think it would be good to give the potential solution for the analytics case? Maybe something like \"This is probably caused by the num_top_classes value being less than the total number of classes in the data frame analytics training configuration\"\nI am sure there is better wording :).", "url": "https://github.com/elastic/elasticsearch/pull/63302#discussion_r500208820", "createdAt": "2020-10-06T11:43:43Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/evaluation/classification/AucRoc.java", "diffHunk": "@@ -182,42 +182,43 @@ public void process(Aggregations aggs) {\n         Filter classAgg = aggs.get(TRUE_AGG_NAME);\n         Nested classNested = classAgg.getAggregations().get(NESTED_AGG_NAME);\n         Filter classNestedFilter = classNested.getAggregations().get(NESTED_FILTER_AGG_NAME);\n+\n+        Filter restAgg = aggs.get(NON_TRUE_AGG_NAME);\n+        Nested restNested = restAgg.getAggregations().get(NESTED_AGG_NAME);\n+        Filter restNestedFilter = restNested.getAggregations().get(NESTED_FILTER_AGG_NAME);\n+\n+        long filteredDocCount = classNestedFilter.getDocCount() + restNestedFilter.getDocCount();\n+        long totalDocCount = classAgg.getDocCount() + restAgg.getDocCount();\n+\n         if (classAgg.getDocCount() == 0) {\n             throw ExceptionsHelper.badRequestException(\n                 \"[{}] requires at least one [{}] to have the value [{}]\",\n                 getName(), fields.get().getActualField(), className);\n         }\n-        if (classNestedFilter.getDocCount() == 0) {\n+        if (classNestedFilter.getDocCount() < classAgg.getDocCount()) {\n             throw ExceptionsHelper.badRequestException(\n-                \"[{}] requires at least one [{}] to have the value [{}]\",\n-                getName(), fields.get().getPredictedClassField(), className);\n+                \"[{}] requires that [{}] appears as one of the [{}] for every document (appeared for {} out of {})\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "16d8a2464021824a734a001d20359536e3318432"}, "originalPosition": 22}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "16d8a2464021824a734a001d20359536e3318432", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/16d8a2464021824a734a001d20359536e3318432", "committedDate": "2020-10-06T09:38:10Z", "message": "Fix failing tests"}, "afterCommit": {"oid": "0fe60e4bfdf077c39061d741722e09fa56b9a7aa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0fe60e4bfdf077c39061d741722e09fa56b9a7aa", "committedDate": "2020-10-07T08:22:34Z", "message": "Apply review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAzNzc4OTE0", "url": "https://github.com/elastic/elasticsearch/pull/63302#pullrequestreview-503778914", "createdAt": "2020-10-07T11:26:48Z", "commit": {"oid": "0fe60e4bfdf077c39061d741722e09fa56b9a7aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65db1db39093aaf6f18d659a35b468e54be886aa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/65db1db39093aaf6f18d659a35b468e54be886aa", "committedDate": "2020-10-07T12:16:19Z", "message": "Validate that AucRoc has the data necessary to be calculated\nRemove AbstractAucRoc.Result.doc_count field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1503a78c849345b9b4bd8c961b177ff368133cbc", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/1503a78c849345b9b4bd8c961b177ff368133cbc", "committedDate": "2020-10-07T12:16:19Z", "message": "Fix failing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "175f2a77c27e05972a98986f4f0cb9398f290025", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/175f2a77c27e05972a98986f4f0cb9398f290025", "committedDate": "2020-10-07T12:16:19Z", "message": "Apply review comments"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "0fe60e4bfdf077c39061d741722e09fa56b9a7aa", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/0fe60e4bfdf077c39061d741722e09fa56b9a7aa", "committedDate": "2020-10-07T08:22:34Z", "message": "Apply review comments"}, "afterCommit": {"oid": "175f2a77c27e05972a98986f4f0cb9398f290025", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/175f2a77c27e05972a98986f4f0cb9398f290025", "committedDate": "2020-10-07T12:16:19Z", "message": "Apply review comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4301, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}