{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4MzE4NDc0", "number": 59429, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoxNzo0NVrOEN7yYg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyNjo0M1rOEN7_AQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDQ2NDk4OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoxNzo0NVrOGw0PTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoxNzo0NVrOGw0PTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MDcxNw==", "bodyText": "I'd prefer to drop these if we can manage it. Or to rename it to public static Builder millisecondResolution(String name) or something.", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r453840717", "createdAt": "2020-07-13T18:17:45Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -178,79 +159,64 @@ public static Resolution ofOrdinal(int ord) {\n         }\n     }\n \n-    public static class Builder extends FieldMapper.Builder<Builder> {\n-\n-        private Boolean ignoreMalformed;\n-        private Explicit<String> format = new Explicit<>(DEFAULT_DATE_TIME_FORMATTER.pattern(), false);\n-        private Locale locale;\n-        private Resolution resolution = Resolution.MILLISECONDS;\n-        String nullValue;\n+    private static DateFieldMapper toType(FieldMapper in) {\n+        return (DateFieldMapper) in;\n+    }\n \n-        public Builder(String name) {\n-            super(name, Defaults.FIELD_TYPE);\n-            builder = this;\n-            locale = Locale.ROOT;\n-        }\n+    public static class Builder extends ParametrizedFieldMapper.Builder {\n \n-        public Builder ignoreMalformed(boolean ignoreMalformed) {\n-            this.ignoreMalformed = ignoreMalformed;\n-            return builder;\n-        }\n+        private final Parameter<Boolean> index = Parameter.indexParam(m -> toType(m).indexed, true);\n+        private final Parameter<Boolean> docValues = Parameter.docValuesParam(m -> toType(m).hasDocValues, true);\n+        private final Parameter<Boolean> store = Parameter.storeParam(m -> toType(m).store, false);\n \n-        protected Explicit<Boolean> ignoreMalformed(BuilderContext context) {\n-            if (ignoreMalformed != null) {\n-                return new Explicit<>(ignoreMalformed, true);\n-            }\n-            if (context.indexSettings() != null) {\n-                return new Explicit<>(IGNORE_MALFORMED_SETTING.get(context.indexSettings()), false);\n-            }\n-            return Defaults.IGNORE_MALFORMED;\n-        }\n+        private final Parameter<Float> boost = Parameter.boostParam();\n+        private final Parameter<Map<String, String>> meta = Parameter.metaParam();\n \n-        public Builder locale(Locale locale) {\n-            this.locale = locale;\n-            return this;\n-        }\n+        private final Parameter<String> format\n+            = Parameter.stringParam(\"format\", false, m -> toType(m).format, DEFAULT_DATE_TIME_FORMATTER.pattern());\n+        private final Parameter<Locale> locale = new Parameter<>(\"locale\", false, Locale.ROOT,\n+            (n, c, o) -> LocaleUtils.parse(o.toString()), m -> toType(m).locale);\n \n-        public Builder nullValue(String nullValue) {\n-            this.nullValue = nullValue;\n-            return this;\n-        }\n+        private final Parameter<String> nullValue\n+            = Parameter.stringParam(\"null_value\", false, m -> toType(m).nullValueAsString, null);\n+        private final Parameter<Boolean> ignoreMalformed;\n \n-        public Locale locale() {\n-            return locale;\n-        }\n-\n-        public String format() {\n-            return format.value();\n-        }\n-\n-        public Builder format(String format) {\n-            this.format = new Explicit<>(format, true);\n-            return this;\n-        }\n+        private final Resolution resolution;\n \n-        public Builder withResolution(Resolution resolution) {\n+        public Builder(String name, Resolution resolution, DateFormatter dateFormatter, boolean ignoreMalformedByDefault) {\n+            super(name);\n             this.resolution = resolution;\n-            return this;\n+            this.ignoreMalformed\n+                = Parameter.boolParam(\"ignore_malformed\", true, m -> toType(m).ignoreMalformed, ignoreMalformedByDefault);\n+            if (dateFormatter != null) {\n+                this.format.setValue(dateFormatter.pattern());\n+                this.locale.setValue(dateFormatter.locale());\n+            }\n         }\n \n-        public boolean isFormatterSet() {\n-            return format.explicit();\n+        // for testing\n+        public Builder(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 154}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDQ3MTAwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoxOToyOFrOGw0S_g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQxODozOTozMlrOGyLDhA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MTY2Mg==", "bodyText": "Do you think it'd be cleaner to use the builder to get these in tests?", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r453841662", "createdAt": "2020-07-13T18:19:28Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -311,6 +254,14 @@ public DateFieldType(String name) {\n             this(name, true, true, DEFAULT_DATE_TIME_FORMATTER, Resolution.MILLISECONDS, Collections.emptyMap());\n         }\n \n+        public DateFieldType(String name, DateFormatter dateFormatter) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDk0ODM1NA==", "bodyText": "Builders give us field mappers though, not field types, so it feels like an extra unnecessary step.", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r454948354", "createdAt": "2020-07-15T10:22:15Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -311,6 +254,14 @@ public DateFieldType(String name) {\n             this(name, true, true, DEFAULT_DATE_TIME_FORMATTER, Resolution.MILLISECONDS, Collections.emptyMap());\n         }\n \n+        public DateFieldType(String name, DateFormatter dateFormatter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MTY2Mg=="}, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 225}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTI2MzEwOA==", "bodyText": "Yeah. I can see that. I'm just not a big fan of having a bunch of ctors, especially when we have a fancy builder system already that makes it super clear what you are doing. Oh well. Its cool.", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r455263108", "createdAt": "2020-07-15T18:39:32Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -311,6 +254,14 @@ public DateFieldType(String name) {\n             this(name, true, true, DEFAULT_DATE_TIME_FORMATTER, Resolution.MILLISECONDS, Collections.emptyMap());\n         }\n \n+        public DateFieldType(String name, DateFormatter dateFormatter) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MTY2Mg=="}, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 225}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDQ4MTc3OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyMjoyNVrOGw0Zkg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyMjoyNVrOGw0Zkg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0MzM0Ng==", "bodyText": "\u2764\ufe0f", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r453843346", "createdAt": "2020-07-13T18:22:25Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocumentParser.java", "diffHunk": "@@ -681,17 +679,15 @@ private static void parseNullValue(ParseContext context, ObjectMapper parentMapp\n                         // failure to parse this, continue\n                         continue;\n                     }\n-                    Mapper.Builder builder = context.root().findTemplateBuilder(context, currentFieldName, XContentFieldType.DATE);\n+                    Mapper.Builder builder\n+                        = context.root().findTemplateBuilder(context, currentFieldName, XContentFieldType.DATE, dateTimeFormatter);\n                     if (builder == null) {\n-                        builder = newDateBuilder(currentFieldName, dateTimeFormatter);\n-                    }\n-                    if (builder instanceof DateFieldMapper.Builder) {\n-                        DateFieldMapper.Builder dateBuilder = (DateFieldMapper.Builder) builder;\n-                        if (dateBuilder.isFormatterSet() == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgzMDQ5NzI5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/Mapper.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyNjo0M1rOGw0jPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xM1QxODoyNjo0M1rOGw0jPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1Mzg0NTgyMA==", "bodyText": "Probably worth javadoc - this is the format used for dynamic date detection and the default date format for date fields that don't have one set. Right?", "url": "https://github.com/elastic/elasticsearch/pull/59429#discussion_r453845820", "createdAt": "2020-07-13T18:26:43Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/Mapper.java", "diffHunk": "@@ -122,6 +129,14 @@ public Version indexVersionCreated() {\n                 return queryShardContextSupplier;\n             }\n \n+            public DateFormatter getDateFormatter() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "88821ada4b41e5c27e418148d7f92bbe15c4f525"}, "originalPosition": 32}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2340, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}