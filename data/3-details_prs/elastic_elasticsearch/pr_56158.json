{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMTU4NDg1", "number": 56158, "title": "SQL: Fix DATETIME_PARSE behaviour regarding timezones", "bodyText": "Previously, when the timezone was missing from the datetime string\nand the pattern, UTC was used, instead of the session defined timezone.\nMoreover, if a timezone was included in the datetime string and the\npattern then this timezone was used. To have a consistent behaviour\nthe resulting datetime will always be converted to the session defined\ntimezone, e.g.:\nSELECT DATETIME_PARSE('2020-05-04 10:20:30.123 +02:00', 'HH:mm:ss dd/MM/uuuu VV') AS datetime;\n\nwith time_zone set to -03:00 will result in\n2020-05-04T05:20:40.123-03:00\n\nFollows: #54960", "createdAt": "2020-05-04T20:08:19Z", "url": "https://github.com/elastic/elasticsearch/pull/56158", "merged": true, "mergeCommit": {"oid": "8810ed03a209cc8fe1bad309a81e85b56a39da27"}, "closed": true, "closedAt": "2020-05-05T09:13:48Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceFGKaAH2gAyNDEzMTU4NDg1OjkzNDU4OGExOTU5MDQwZDUzYWUxNDFiOGVhZjFmNDFlMTJlZjgwNTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcePxnngH2gAyNDEzMTU4NDg1Ojk5MDk5ODhmYWRjMzg0NzdkOWYyNDFlOWRlMTUwYThhNzY1YjliY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "934588a1959040d53ae141b8eaf1f41e12ef8056", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/934588a1959040d53ae141b8eaf1f41e12ef8056", "committedDate": "2020-05-04T20:00:04Z", "message": "SQL: Fix DATETIME_PARSE behaviour regarding timezones\n\nPreviously, when the timezone was missing from the datetime string\nand the pattern, UTC was used, instead of the session defined timezone.\nMoreover, if a timezone was included in the datetime string and the\npattern then this timezone was used. To have a consistent behaviour\nthe resulting datetime will always be converted to the session defined\ntimezone, e.g.:\n```\nSELECT DATETIME_PARSE('2020-05-04 10:20:30.123 +02:00', 'HH:mm:ss dd/MM/uuuu VV') AS datetime;\n```\nwith `time_zone` set to `-03:00` will result in\n```\n2020-05-04T05:20:40.123-03:00\n```\n\nFollows: #54960"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MzMyMDc0", "url": "https://github.com/elastic/elasticsearch/pull/56158#pullrequestreview-405332074", "createdAt": "2020-05-04T20:43:17Z", "commit": {"oid": "934588a1959040d53ae141b8eaf1f41e12ef8056"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDo0MzoxN1rOGQRbmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQyMDo0MzoxN1rOGQRbmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTcxNTk5Mg==", "bodyText": "The get(0) seems optimistic - please extract this into a (date) utils method (maybe there's some utility in ES we could use).", "url": "https://github.com/elastic/elasticsearch/pull/56158#discussion_r419715992", "createdAt": "2020-05-04T20:43:17Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/function/scalar/datetime/DateTimeParseProcessor.java", "diffHunk": "@@ -55,9 +53,9 @@ public static Object process(Object timestampStr, Object pattern) {\n             TemporalAccessor ta = DateTimeFormatter.ofPattern((String) pattern, Locale.ROOT)\n                 .parseBest((String) timestampStr, ZonedDateTime::from, LocalDateTime::from);\n             if (ta instanceof LocalDateTime) {\n-                return ZonedDateTime.ofInstant((LocalDateTime) ta, ZoneOffset.UTC, UTC);\n+                return ZonedDateTime.ofInstant((LocalDateTime) ta, zoneId.getRules().getValidOffsets(((LocalDateTime) ta)).get(0), zoneId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "934588a1959040d53ae141b8eaf1f41e12ef8056"}, "originalPosition": 39}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c930f474d1da2f20749312a8dc7cf5340e995bfd", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c930f474d1da2f20749312a8dc7cf5340e995bfd", "committedDate": "2020-05-04T21:02:08Z", "message": "address comments, revert test - doesn't work due to random timezone"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NTQ0Mzg0", "url": "https://github.com/elastic/elasticsearch/pull/56158#pullrequestreview-405544384", "createdAt": "2020-05-05T07:19:32Z", "commit": {"oid": "c930f474d1da2f20749312a8dc7cf5340e995bfd"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzoxOTozMlrOGQdN6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwNzoxOTozMlrOGQdN6w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTkwOTA5OQ==", "bodyText": "As an improvement, I would add links to REST and jdbc driver params documentation where these parameters are defined.", "url": "https://github.com/elastic/elasticsearch/pull/56158#discussion_r419909099", "createdAt": "2020-05-05T07:19:32Z", "author": {"login": "astefan"}, "path": "docs/reference/sql/functions/date-time.asciidoc", "diffHunk": "@@ -487,6 +484,16 @@ include-tagged::{sql-specs}/docs/docs.csv-spec[dateTimeParse1]\n include-tagged::{sql-specs}/docs/docs.csv-spec[dateTimeParse2]\n --------------------------------------------------\n \n+[NOTE]\n+====\n+If timezone is not specified in the datetime string expression and the parsing pattern, the resulting `datetime` will have the\n+time zone specified by the user through the `time_zone`/`timezone` REST/driver parameters with no conversion applied.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c930f474d1da2f20749312a8dc7cf5340e995bfd"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9909988fadc38477d9f241e9de150a8a765b9bcb", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/9909988fadc38477d9f241e9de150a8a765b9bcb", "committedDate": "2020-05-05T08:26:35Z", "message": "Address docs comment"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 84, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}