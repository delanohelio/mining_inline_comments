{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEyNzcyNjg4", "number": 56094, "title": "Stop Redundantly Serializing ShardId in BulkShardResponse", "bodyText": "When reading/writing the individual doc responses in the context\nof a bulk shard response there is no need to serialize the ShardId\nover and over. This can waste a lot of memory when handling large bulk\nrequests.", "createdAt": "2020-05-04T07:03:17Z", "url": "https://github.com/elastic/elasticsearch/pull/56094", "merged": true, "mergeCommit": {"oid": "c0ee6d2d5283d5d37f2aa60cd76d2c1b5fe30b7f"}, "closed": true, "closedAt": "2020-05-04T14:00:24Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcd58NDAH2gAyNDEyNzcyNjg4OjNmN2I4ZTZmZjYwOTAxOTE5YWFiODc1MDYzNDNmZDRmZTVjNGFmNzc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcd_PYFAH2gAyNDEyNzcyNjg4OjMyOGUwNzhmNDRiNDlmNGNhZGExODYwYTg4ZTVhYjI2ZTM4NTNmMzI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f7b8e6ff60901919aab87506343fd4fe5c4af77", "committedDate": "2020-05-04T07:00:14Z", "message": "Stop Redundantly Serializing ShardId in BulkShardResponse\n\nWhen reading/writing the individual doc responses in the context\nof a bulk shard response there is no need to serialize the `ShardId`\nover and over. This can waste a lot of memory when handling large bulk\nrequests."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0ODg4MjMy", "url": "https://github.com/elastic/elasticsearch/pull/56094#pullrequestreview-404888232", "createdAt": "2020-05-04T11:02:23Z", "commit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMTowMjoyNFrOGP7mXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxMToxNToxMlrOGP776g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1ODMwMA==", "bodyText": "else fail (if type != 2)?", "url": "https://github.com/elastic/elasticsearch/pull/56094#discussion_r419358300", "createdAt": "2020-05-04T11:02:24Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkItemResponse.java", "diffHunk": "@@ -359,6 +360,24 @@ public String toString() {\n \n     BulkItemResponse() {}\n \n+    BulkItemResponse(ShardId shardId, StreamInput in) throws IOException {\n+        id = in.readVInt();\n+        opType = OpType.fromId(in.readByte());\n+\n+        byte type = in.readByte();\n+        if (type == 0) {\n+            response = new IndexResponse(shardId, in);\n+        } else if (type == 1) {\n+            response = new DeleteResponse(shardId, in);\n+        } else if (type == 3) { // make 3 instead of 2, because 2 is already in use for 'no responses'\n+            response = new UpdateResponse(shardId, in);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1ODMzOQ==", "bodyText": "else fail?", "url": "https://github.com/elastic/elasticsearch/pull/56094#discussion_r419358339", "createdAt": "2020-05-04T11:02:30Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkItemResponse.java", "diffHunk": "@@ -489,4 +508,28 @@ public void writeTo(StreamOutput out) throws IOException {\n             failure.writeTo(out);\n         }\n     }\n+\n+    public void writeThin(StreamOutput out) throws IOException {\n+        out.writeVInt(id);\n+        out.writeByte(opType.getId());\n+\n+        if (response == null) {\n+            out.writeByte((byte) 2);\n+        } else {\n+            if (response instanceof IndexResponse) {\n+                out.writeByte((byte) 0);\n+            } else if (response instanceof DeleteResponse) {\n+                out.writeByte((byte) 1);\n+            } else if (response instanceof UpdateResponse) {\n+                out.writeByte((byte) 3); // make 3 instead of 2, because 2 is already in use for 'no responses'\n+            }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM1OTY0Mg==", "bodyText": "Can we assert anything about in.getVersion() here? Not looked in detail, but I hope that this constructor will become obsolete after this change is complete.", "url": "https://github.com/elastic/elasticsearch/pull/56094#discussion_r419359642", "createdAt": "2020-05-04T11:05:33Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/DocWriteResponse.java", "diffHunk": "@@ -130,6 +130,22 @@ public DocWriteResponse(ShardId shardId, String id, long seqNo, long primaryTerm\n         this.result = Objects.requireNonNull(result);\n     }\n \n+    // needed for deserialization\n+    protected DocWriteResponse(ShardId shardId, StreamInput in) throws IOException {\n+        super(in);\n+        this.shardId = shardId;\n+        if (in.getVersion().before(Version.V_8_0_0)) {\n+            String type = in.readString();\n+            assert MapperService.SINGLE_MAPPING_NAME.equals(type) : \"Expected [_doc] but received [\" + type + \"]\";\n+        }\n+        id = in.readString();\n+        version = in.readZLong();\n+        seqNo = in.readZLong();\n+        primaryTerm = in.readVLong();\n+        forcedRefresh = in.readBoolean();\n+        result = Result.readFrom(in);\n+    }\n+\n     // needed for deserialization\n     protected DocWriteResponse(StreamInput in) throws IOException {\n         super(in);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2MDk2NQ==", "bodyText": "How about something more descriptive than doWrite? writeWithoutShardId? writeDetails?", "url": "https://github.com/elastic/elasticsearch/pull/56094#discussion_r419360965", "createdAt": "2020-05-04T11:08:41Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/DocWriteResponse.java", "diffHunk": "@@ -258,10 +274,19 @@ public String getLocation(@Nullable String routing) {\n         return location.toString();\n     }\n \n+    public void writeThin(StreamOutput out) throws IOException {\n+        super.writeTo(out);\n+        doWrite(out);\n+    }\n+\n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n         super.writeTo(out);\n         shardId.writeTo(out);\n+        doWrite(out);\n+    }\n+\n+    private void doWrite(StreamOutput out) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTM2MzgxOA==", "bodyText": "This seems to leave BulkItemResponse#writeTo() as dead code that mostly duplicates this. Does that mean that we don't need BulkItemResponse implements Writeable? If so, can you remove that and rename these methods more appropriately?", "url": "https://github.com/elastic/elasticsearch/pull/56094#discussion_r419363818", "createdAt": "2020-05-04T11:15:12Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/BulkItemResponse.java", "diffHunk": "@@ -489,4 +508,28 @@ public void writeTo(StreamOutput out) throws IOException {\n             failure.writeTo(out);\n         }\n     }\n+\n+    public void writeThin(StreamOutput out) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3f7b8e6ff60901919aab87506343fd4fe5c4af77"}, "originalPosition": 38}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c70fb36f96262a0f8040bc4450ab376bead0b51e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c70fb36f96262a0f8040bc4450ab376bead0b51e", "committedDate": "2020-05-04T11:39:54Z", "message": "Merge remote-tracking branch 'elastic/master' into more-compact-serialization-replication-response"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9b083a77a4aaeb0bcf42145d7e89cbf4735abe9b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b083a77a4aaeb0bcf42145d7e89cbf4735abe9b", "committedDate": "2020-05-04T12:13:20Z", "message": "CR: comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "478595f34d8f2cae3f88f377182b9f803479347f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/478595f34d8f2cae3f88f377182b9f803479347f", "committedDate": "2020-05-04T12:14:42Z", "message": "rename"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e2e09612bd5aa90fa42797b5f96ad5b3fb9954b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e2e09612bd5aa90fa42797b5f96ad5b3fb9954b", "committedDate": "2020-05-04T13:04:57Z", "message": "Merge remote-tracking branch 'elastic/master' into more-compact-serialization-replication-response"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA0OTY2OTYz", "url": "https://github.com/elastic/elasticsearch/pull/56094#pullrequestreview-404966963", "createdAt": "2020-05-04T13:05:20Z", "commit": {"oid": "478595f34d8f2cae3f88f377182b9f803479347f"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "328e078f44b49f4cada1860a88e5ab26e3853f32", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/328e078f44b49f4cada1860a88e5ab26e3853f32", "committedDate": "2020-05-04T13:10:42Z", "message": "javadoc with link"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 205, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}