{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2MjEyNzMw", "number": 56527, "title": "Don't omit empty arrays when filtering _source", "bodyText": "When using source filtering exclusions, empty arrays are not preserved in documents, and no empty arrays are returned if arrays are empty after applying exclusions. What I find surprising is that we have special treatment to make sure that we preserve empty objects, but the behaviour for arrays is different.\nPUT /test/_doc/1\n{\n  \"field\" : \"value\",\n  \"array\": [],\n  \"object\" : {}\n}\n\nPUT /test/_doc/2\n{\n  \"field\" : \"value\",\n  \"array\": [{ \"exclude\": \"bar\"}],\n  \"object\": { \"exclude\": \"bar\" }\n}\n\nPUT /test/_doc/3\n{\n  \"field\" : \"value\",\n  \"array\": [{ \"exclude\": \"bar\"}, {\"include\" : \"bar\"}],\n  \"object\": { \"exclude\": \"bar\", \"include\" : \"bar\" }\n}\n\nPOST /test/_search?pretty\n{\n  \"_source\": {\n    \"excludes\": [\n      \"array.exclude\", \"object.exclude\"\n    ]\n  }\n}\n\n\"hits\" : [\n      {\n        \"_index\" : \"test\",\n        \"_id\" : \"1\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"field\" : \"value\",\n          \"object\" : { }\n        }\n      },\n      {\n        \"_index\" : \"test\",\n        \"_id\" : \"2\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"field\" : \"value\",\n          \"object\" : { }\n        }\n      },\n      {\n        \"_index\" : \"test\",\n        \"_id\" : \"3\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"field\" : \"value\",\n          \"array\" : [\n            {\n              \"include\" : \"bar\"\n            }\n          ],\n          \"object\" : {\n            \"include\" : \"bar\"\n          }\n        }\n      }\n]\n\nIt looks like this regression was introduced by #22593, shortly after we refactored source filtering to use automata (#20736).\nNote that this affects what the search API returns when using source exclusions, as well as what gets indexed when using source exclusions for the _source field.\nCloses #23796", "createdAt": "2020-05-11T16:31:14Z", "url": "https://github.com/elastic/elasticsearch/pull/56527", "merged": true, "mergeCommit": {"oid": "cba99dcd95068336d878d844a3ed83c85c903924"}, "closed": true, "closedAt": "2020-05-13T20:21:15Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgSOwWAH2gAyNDE2MjEyNzMwOjFhODNjOGNlNGI2Zjk4MTJmM2E2MDMyYTM3ZDliMjZlZWRkNWUwNzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg8T4sgFqTQxMTE0MzExNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a83c8ce4b6f9812f3a6032a37d9b26eedd5e070", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a83c8ce4b6f9812f3a6032a37d9b26eedd5e070", "committedDate": "2020-05-11T16:26:04Z", "message": "Don't omit empty arrays when filtering _source"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f10e2028d5e990a5e39d858c2be4000ca6791650", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/f10e2028d5e990a5e39d858c2be4000ca6791650", "committedDate": "2020-05-11T19:49:24Z", "message": "unused imports"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzkyNzA4", "url": "https://github.com/elastic/elasticsearch/pull/56527#pullrequestreview-410792708", "createdAt": "2020-05-13T10:27:45Z", "commit": {"oid": "f10e2028d5e990a5e39d858c2be4000ca6791650"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b325bc2eb0272dd5c3587c0144a48466c037cc4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b325bc2eb0272dd5c3587c0144a48466c037cc4", "committedDate": "2020-05-13T12:41:04Z", "message": "Merge branch 'master' into fix/xcontent_map_values_filter_empty_arrays"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7944243278c9876fa4914a8ba0fa9aadcce889a4", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/7944243278c9876fa4914a8ba0fa9aadcce889a4", "committedDate": "2020-05-13T12:58:50Z", "message": "adadt filtering tests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwOTY5MTY2", "url": "https://github.com/elastic/elasticsearch/pull/56527#pullrequestreview-410969166", "createdAt": "2020-05-13T14:15:17Z", "commit": {"oid": "7944243278c9876fa4914a8ba0fa9aadcce889a4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDoxNToxN1rOGUzujQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNDoxNToxN1rOGUzujQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDQ3MjIwNQ==", "bodyText": "I have not changed anything in the json, only made it a protected static member.", "url": "https://github.com/elastic/elasticsearch/pull/56527#discussion_r424472205", "createdAt": "2020-05-13T14:15:17Z", "author": {"login": "javanna"}, "path": "server/src/test/java/org/elasticsearch/common/xcontent/support/AbstractFilteringTestCase.java", "diffHunk": "@@ -484,70 +484,70 @@ public void testSimpleArrayOfObjectsInclusive() throws Exception {\n         testFilter(expected, SAMPLE, singleton(\"authors.*name\"), emptySet());\n     }\n \n-    public void testSimpleArrayOfObjectsExclusive() throws Exception {\n-        final Builder expected = builder -> builder.startObject()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7944243278c9876fa4914a8ba0fa9aadcce889a4"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDExMTQzMTE3", "url": "https://github.com/elastic/elasticsearch/pull/56527#pullrequestreview-411143117", "createdAt": "2020-05-13T17:25:38Z", "commit": {"oid": "7944243278c9876fa4914a8ba0fa9aadcce889a4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyNTozOVrOGU7_iw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QxNzoyNTozOVrOGU7_iw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDYwNzYyNw==", "bodyText": "I guess our map-based filtering will now behave differently than direct xContent filtering. This seems okay to me, since I think it already diverged -- map-based filtering preserves empty objects, whereas xContent filtering doesn't?", "url": "https://github.com/elastic/elasticsearch/pull/56527#discussion_r424607627", "createdAt": "2020-05-13T17:25:39Z", "author": {"login": "jtibshirani"}, "path": "server/src/test/java/org/elasticsearch/common/xcontent/support/XContentMapValuesTests.java", "diffHunk": "@@ -479,6 +482,79 @@ public void testSharedPrefixes() {\n         assertEquals(Collections.singletonMap(\"foobaz\", 3), XContentMapValues.filter(map, new String[0], new String[] {\"foobar\"}));\n     }\n \n+    @Override\n+    public void testSimpleArrayOfObjectsExclusive() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7944243278c9876fa4914a8ba0fa9aadcce889a4"}, "originalPosition": 22}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 148, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}