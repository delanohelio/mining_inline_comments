{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxNjc2MzQ1", "number": 51973, "reviewThreads": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMjoyNzoxNVrODhgWTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMjoxNTo1OVrODjDa6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDU5NTk3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/fielddata/MultiGeoValues.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMjoyNzoxNVrOFsReOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMjoyNzoxNVrOFsReOg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk2NzkzMA==", "bodyText": "I seems the javadocs are inaccurate in the way the explain how to iterate the values?", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381967930", "createdAt": "2020-02-20T12:27:15Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/MultiGeoValues.java", "diffHunk": "@@ -58,7 +59,7 @@\n  * The set of values associated with a document might contain duplicates and\n  * comes in a non-specified order.\n  */\n-public abstract class MultiGeoValues {\n+public abstract class MultiGeoValues <G extends MultiGeoValues.GeoValue> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDY2ODk3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMjo1MzoxM1rOFsSMAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMjo1MzoxM1rOFsSMAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk3OTY1MA==", "bodyText": "Are we doing this because of the bounded case? It is unfortunate that we need to build the rectangle in all cases?", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381979650", "createdAt": "2020-02-20T12:53:13Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -71,18 +71,22 @@ public int setValues(GeoShapeCellValues values, MultiGeoValues.GeoValue geoValue\n             long count = (numLonCells + 1) * (numLatCells + 1);\n             if (count == 1) {\n                 String hash = Geohash.stringEncode(bounds.minX(), bounds.minY(), precision);\n-                values.resizeCell(1);\n-                values.add(0, Geohash.longEncode(hash));\n-                return 1;\n+                Rectangle rectangle = Geohash.toBoundingBox(hash);\n+                GeoRelation relation = geoValue.relate(rectangle);\n+                if (relation != GeoRelation.QUERY_DISJOINT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 39}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDcxMDgyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowNjozN1rOFsSkuA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowNjozN1rOFsSkuA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NTk3Ng==", "bodyText": "I guess I am missing something but I do not understand the benefits of having this two instances?", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381985976", "createdAt": "2020-02-20T13:06:37Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -147,8 +150,9 @@ private int setValuesForFullyContainedTile(String hash, GeoShapeCellValues value\n         }\n     }\n \n-    class GeoTileGridTiler implements GeoGridTiler {\n-        public static final GeoTileGridTiler INSTANCE = new GeoTileGridTiler();\n+    class GeoTileGridTiler<G extends MultiGeoValues.GeoValue> implements GeoGridTiler<G> {\n+        public static final GeoTileGridTiler INSTANCE = new GeoTileGridTiler<>();\n+        public static final GeoTileGridTiler BOUNDED_INSTANCE = new GeoTileGridTiler<BoundedGeoShapeCellValues.BoundedGeoValue>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDcxNTQ2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowODowOVrOFsSnkw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowODowOVrOFsSnkw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NjcwNw==", "bodyText": "Don't we need to filter out  the tiles that do not intersect with the provided bounds (if provided)", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381986707", "createdAt": "2020-02-20T13:08:09Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -259,8 +268,8 @@ protected int setValuesByRasterization(int xTile, int yTile, int zTile, GeoShape\n             return valuesIndex;\n         }\n \n-        private int setValuesForFullyContainedTile(int xTile, int yTile, int zTile,\n-                                                   GeoShapeCellValues values, int valuesIndex, int targetPrecision) {\n+        private int setValuesForFullyContainedTile(int xTile, int yTile, int zTile, CellValues values, int valuesIndex,\n+                                                   int targetPrecision) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDcxNzkyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowODo1MlrOFsSpAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzowODo1MlrOFsSpAw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4NzA3NQ==", "bodyText": "It is unfortunate that we need to build the rectangle evening the unbounded case", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381987075", "createdAt": "2020-02-20T13:08:52Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -189,17 +193,21 @@ public int setValues(GeoShapeCellValues values, MultiGeoValues.GeoValue geoValue\n                 return 0;\n             }\n \n-\n             final double tiles = 1 << precision;\n             int minXTile = GeoTileUtils.getXTile(bounds.minX(), (long) tiles);\n             int minYTile = GeoTileUtils.getYTile(bounds.maxY(), (long) tiles);\n             int maxXTile = GeoTileUtils.getXTile(bounds.maxX(), (long) tiles);\n             int maxYTile = GeoTileUtils.getYTile(bounds.minY(), (long) tiles);\n             int count = (maxXTile - minXTile + 1) * (maxYTile - minYTile + 1);\n             if (count == 1) {\n-                values.resizeCell(1);\n-                values.add(0, GeoTileUtils.longEncodeTiles(precision, minXTile, minYTile));\n-                return 1;\n+                Rectangle rectangle = GeoTileUtils.toBoundingBox(minXTile, minYTile, precision);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 122}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDcyNDMwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/fielddata/MultiGeoValues.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMTowMlrOFsSsvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMTowMlrOFsSsvQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4ODAyOQ==", "bodyText": "I think the javadocs do not reflect the way the object is iterated?", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381988029", "createdAt": "2020-02-20T13:11:02Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/MultiGeoValues.java", "diffHunk": "@@ -58,7 +59,7 @@\n  * The set of values associated with a document might contain duplicates and\n  * comes in a non-specified order.\n  */\n-public abstract class MultiGeoValues {\n+public abstract class MultiGeoValues <G extends MultiGeoValues.GeoValue> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDcyODA0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMjowNVrOFsSu2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMjowNVrOFsSu2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4ODU3MA==", "bodyText": "It is unfortunate that we need to build the rectangle even in the Unbounded case.", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381988570", "createdAt": "2020-02-20T13:12:05Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -189,17 +193,21 @@ public int setValues(GeoShapeCellValues values, MultiGeoValues.GeoValue geoValue\n                 return 0;\n             }\n \n-\n             final double tiles = 1 << precision;\n             int minXTile = GeoTileUtils.getXTile(bounds.minX(), (long) tiles);\n             int minYTile = GeoTileUtils.getYTile(bounds.maxY(), (long) tiles);\n             int maxXTile = GeoTileUtils.getXTile(bounds.maxX(), (long) tiles);\n             int maxYTile = GeoTileUtils.getYTile(bounds.minY(), (long) tiles);\n             int count = (maxXTile - minXTile + 1) * (maxYTile - minYTile + 1);\n             if (count == 1) {\n-                values.resizeCell(1);\n-                values.add(0, GeoTileUtils.longEncodeTiles(precision, minXTile, minYTile));\n-                return 1;\n+                Rectangle rectangle = GeoTileUtils.toBoundingBox(minXTile, minYTile, precision);\n+                GeoRelation relation = geoValue.relate(rectangle);\n+                if (relation != GeoRelation.QUERY_DISJOINT) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 124}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDczMDYzOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMjo1MlrOFsSwYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMjo1MlrOFsSwYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4ODk2Mw==", "bodyText": "I think we need to filter out here tiles that do not intersect with the provided bounds (if provided)", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381988963", "createdAt": "2020-02-20T13:12:52Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -259,8 +268,8 @@ protected int setValuesByRasterization(int xTile, int yTile, int zTile, GeoShape\n             return valuesIndex;\n         }\n \n-        private int setValuesForFullyContainedTile(int xTile, int yTile, int zTile,\n-                                                   GeoShapeCellValues values, int valuesIndex, int targetPrecision) {\n+        private int setValuesForFullyContainedTile(int xTile, int yTile, int zTile, CellValues values, int valuesIndex,\n+                                                   int targetPrecision) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM2NDczMzQ0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMzo0NFrOFsSyAg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMFQxMzoxMzo0NFrOFsSyAg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MTk4OTM3OA==", "bodyText": "I guess I am missing something but I cannot tell the benefits of having two instances, they seem to be used the same way?", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r381989378", "createdAt": "2020-02-20T13:13:44Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -147,8 +150,9 @@ private int setValuesForFullyContainedTile(String hash, GeoShapeCellValues value\n         }\n     }\n \n-    class GeoTileGridTiler implements GeoGridTiler {\n-        public static final GeoTileGridTiler INSTANCE = new GeoTileGridTiler();\n+    class GeoTileGridTiler<G extends MultiGeoValues.GeoValue> implements GeoGridTiler<G> {\n+        public static final GeoTileGridTiler INSTANCE = new GeoTileGridTiler<>();\n+        public static final GeoTileGridTiler BOUNDED_INSTANCE = new GeoTileGridTiler<BoundedGeoShapeCellValues.BoundedGeoValue>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0d60301c76a82b0d5d44b1b13de33cd2428b9f1c"}, "originalPosition": 85}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDgyNjU5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "isResolved": true, "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMjoxNTozNFrOFupRjQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxNTo1NjozMFrOFuxWmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTA1Mw==", "bodyText": "I think in the case of a point, we can just check that the point is in bounds? We save having to compute the rectangle point can be out of the bounds but cell can still intersects", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384455053", "createdAt": "2020-02-26T12:15:34Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDUzMjI2MQ==", "bodyText": "I believe we discussed this and decided we would like to keep a consistent definition between points and shapes where we only filter which cells we consider with regards to the geoBoundingBox. this means the point need not be within the geoBoundingBox", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384532261", "createdAt": "2020-02-26T14:38:02Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTA1Mw=="}, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0ODU2OQ==", "bodyText": "yes, yes, my bad :(", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384548569", "createdAt": "2020-02-26T15:01:32Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTA1Mw=="}, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU0ODk0OQ==", "bodyText": "It is exactly how we spoke and I think it should be", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384548949", "createdAt": "2020-02-26T15:02:08Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTA1Mw=="}, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 56}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDU4NzQxNg==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384587416", "createdAt": "2020-02-26T15:56:30Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTA1Mw=="}, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 56}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4MDgyNzkyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMjoxNTo1OVrOFupSUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNlQxMjoxNTo1OVrOFupSUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NDQ1NTI0OQ==", "bodyText": "+1", "url": "https://github.com/elastic/elasticsearch/pull/51973#discussion_r384455249", "createdAt": "2020-02-26T12:15:59Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/BoundedGeoTileGridTiler.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+package org.elasticsearch.search.aggregations.bucket.geogrid;\n+\n+import org.elasticsearch.common.geo.GeoBoundingBox;\n+import org.elasticsearch.common.geo.GeoRelation;\n+import org.elasticsearch.geometry.Rectangle;\n+import org.elasticsearch.index.fielddata.MultiGeoValues;\n+\n+public class BoundedGeoTileGridTiler extends GeoTileGridTiler {\n+    private final double boundsTop;\n+    private final double boundsBottom;\n+    private final double boundsWestLeft;\n+    private final double boundsWestRight;\n+    private final double boundsEastLeft;\n+    private final double boundsEastRight;\n+    private final boolean crossesDateline;\n+\n+    public BoundedGeoTileGridTiler(GeoBoundingBox geoBoundingBox) {\n+        // split geoBoundingBox into west and east boxes\n+        boundsTop = geoBoundingBox.top();\n+        boundsBottom = geoBoundingBox.bottom();\n+        if (geoBoundingBox.right() < geoBoundingBox.left()) {\n+            boundsWestLeft = -180;\n+            boundsWestRight = geoBoundingBox.right();\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = 180;\n+            crossesDateline = true;\n+        } else { // only set east bounds\n+            boundsEastLeft = geoBoundingBox.left();\n+            boundsEastRight = geoBoundingBox.right();\n+            boundsWestLeft = 0;\n+            boundsWestRight = 0;\n+            crossesDateline = false;\n+        }\n+    }\n+\n+    public int advancePointValue(long[] values, double x, double y, int precision, int valuesIdx) {\n+        long hash = encode(x, y, precision);\n+        if (cellIntersectsGeoBoundingBox(GeoTileUtils.toBoundingBox(hash))) {\n+            values[valuesIdx] = hash;\n+            return valuesIdx + 1;\n+        }\n+        return valuesIdx;\n+    }\n+\n+    boolean cellIntersectsGeoBoundingBox(Rectangle rectangle) {\n+        return (boundsTop >= rectangle.getMinY() && boundsBottom <= rectangle.getMaxY()\n+            && (boundsEastLeft <= rectangle.getMaxX() && boundsEastRight >= rectangle.getMinX()\n+            || (crossesDateline && boundsWestLeft <= rectangle.getMaxX() && boundsWestRight >= rectangle.getMinX())));\n+    }\n+\n+    @Override\n+    public GeoRelation relateTile(MultiGeoValues.GeoValue geoValue, int xTile, int yTile, int precision) {\n+        Rectangle rectangle = GeoTileUtils.toBoundingBox(xTile, yTile, precision);\n+        if (cellIntersectsGeoBoundingBox(rectangle)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cedc60d256c2f9d83a27a882a0898d83e90655b2"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4944, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}