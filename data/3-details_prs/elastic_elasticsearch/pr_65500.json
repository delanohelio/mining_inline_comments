{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI3NTAyNDgy", "number": 65500, "title": "Support response content-type with versioned media type", "bodyText": "So far response content-type could only have values from XContent - JSON, CBOR, YAML, SMILE (plus text/plain and SQL's media types)\nRequesting a versioned media type in a form of application/vnd.elasticsearch+json;compatible-with=7 would return with application/json\nThis PR allows to return a versioned media types.\nWe do this by adding new vendor specific instances to XContent and TextFormat enums. These instances can then \"format\" the response content type string when provided with parameters. This is similar to what SQL plugin does at the moment.\nrelates #51816", "createdAt": "2020-11-25T14:53:12Z", "url": "https://github.com/elastic/elasticsearch/pull/65500", "merged": true, "mergeCommit": {"oid": "5e74f79e22c4df1edaa224219453c01215cbabee"}, "closed": true, "closedAt": "2021-01-05T08:23:23Z", "author": {"login": "pgomulka"}, "timelineItems": {"totalCount": 39, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABddWt4gAH2gAyNTI3NTAyNDgyOjI3ZDVkMzA5MTNhODk4OTc3MjZkZmUzZDMxOTA1MWVlZDRmYjc5Y2U=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnUvaNAH2gAyNTI3NTAyNDgyOmUwMjk3MGNjNzQzNWE4YjViMzc5ZTVjMzQ0ZmJhNTYwODQ2ZjljYWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "27d5d30913a89897726dfe3d319051eed4fb79ce", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/27d5d30913a89897726dfe3d319051eed4fb79ce", "committedDate": "2020-11-17T10:09:04Z", "message": "draft"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6e349a9bcfe0bc54f80fba98db8e9e6dac7fb367", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/6e349a9bcfe0bc54f80fba98db8e9e6dac7fb367", "committedDate": "2020-11-17T14:15:55Z", "message": "include in tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca9aa4d28d1728151ee5f6d75ad8abb24188619d", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca9aa4d28d1728151ee5f6d75ad8abb24188619d", "committedDate": "2020-11-17T15:30:11Z", "message": "checkstyle'"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d396dbf5b196d01349b1024902a2ddb0ea2dc4ed", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d396dbf5b196d01349b1024902a2ddb0ea2dc4ed", "committedDate": "2020-11-17T16:20:36Z", "message": "line wrap"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea066f4d943b2633dc8c998009eba34ef3ae533e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea066f4d943b2633dc8c998009eba34ef3ae533e", "committedDate": "2020-11-20T09:29:34Z", "message": "guess  what was the  response type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51ade0842f0d1f26edb04f472be12bbe5bcd2548", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/51ade0842f0d1f26edb04f472be12bbe5bcd2548", "committedDate": "2020-11-20T10:12:04Z", "message": "take media type from  provided xconttenttype"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8315bec7a55e6010722b39dcb5e1360d311ff08", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8315bec7a55e6010722b39dcb5e1360d311ff08", "committedDate": "2020-11-20T16:24:14Z", "message": "remove redudnant ifs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c65c5eff80bcf0a897d465994c5427aa5e82ce8e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/c65c5eff80bcf0a897d465994c5427aa5e82ce8e", "committedDate": "2020-11-24T07:49:02Z", "message": "removed unused code"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48db8766deced54b3dd708c773854dd46cb0367b", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/48db8766deced54b3dd708c773854dd46cb0367b", "committedDate": "2020-11-25T14:39:59Z", "message": "format response content type basing on params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78e3f1c32e332dabe0b7021e8e9df5d662f52078", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/78e3f1c32e332dabe0b7021e8e9df5d662f52078", "committedDate": "2020-11-25T14:40:04Z", "message": "Merge branch 'master' into compat/xcontent_responsetype_format_params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "227e0f8d7943deabd55428ffe810f1a2e2dea247", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/227e0f8d7943deabd55428ffe810f1a2e2dea247", "committedDate": "2020-12-01T13:57:43Z", "message": "xcontent factory for vnd"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d94b4dc73a2f5e656e750ec7c79ef801762c70cf", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d94b4dc73a2f5e656e750ec7c79ef801762c70cf", "committedDate": "2020-12-02T15:29:48Z", "message": "text fixtures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "91fcf3a3c59692e64372f57a1c4cea8269402066", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/91fcf3a3c59692e64372f57a1c4cea8269402066", "committedDate": "2020-12-02T15:44:27Z", "message": "precommit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04b44ce8831166085ec23072437b2668ae9ebd2d", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/04b44ce8831166085ec23072437b2668ae9ebd2d", "committedDate": "2020-12-03T07:44:26Z", "message": "Merge branch 'master' into compat/xcontent_responsetype_format_params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a085dc6c33a355db06b99f541e41958f1168aec4", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/a085dc6c33a355db06b99f541e41958f1168aec4", "committedDate": "2020-12-03T14:36:48Z", "message": "test fixes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7aeabf7a09505778be0fe134d758e501e0627fe2", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/7aeabf7a09505778be0fe134d758e501e0627fe2", "committedDate": "2020-12-03T20:14:08Z", "message": "fix serialisation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d59449538248b66676e4fe501e0ab0f0d905cc20", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d59449538248b66676e4fe501e0ab0f0d905cc20", "committedDate": "2020-12-07T13:56:07Z", "message": "fixing restcontroller"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e3c446391cf06192c6d22d6d107c15a003ac333", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e3c446391cf06192c6d22d6d107c15a003ac333", "committedDate": "2020-12-08T12:00:06Z", "message": "Merge remote-tracking branch 'upstream/master' into compat/xcontent_responsetype_format_params"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c520ce91822c59324463063b6a131208588c794", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c520ce91822c59324463063b6a131208588c794", "committedDate": "2020-12-08T12:36:22Z", "message": "spotless"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "521b5ad5e580ddedd30be5f948bfbc33a9ec0480", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/521b5ad5e580ddedd30be5f948bfbc33a9ec0480", "committedDate": "2020-12-08T13:35:09Z", "message": "small cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "261df305596e234ec96acdb929e4dfed091af20e", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/261df305596e234ec96acdb929e4dfed091af20e", "committedDate": "2020-12-08T15:46:41Z", "message": "tests relying on xcontent being in cannonical form - not chaning"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/48200e2762c66f69391e27e3eb727dc11af18d72", "committedDate": "2020-12-09T08:13:16Z", "message": "test fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTY1MzQ0", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-548165344", "createdAt": "2020-12-09T13:09:49Z", "commit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowOTo0OVrOICTzhQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzowOTo0OVrOICTzhQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTI5MjU0OQ==", "bodyText": "this is to assert that during bulk api all requests have the same contentype. Used by rest HLRC", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r539292549", "createdAt": "2020-12-09T13:09:49Z", "author": {"login": "pgomulka"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/RequestConverters.java", "diffHunk": "@@ -1177,14 +1177,14 @@ Params withWaitForEvents(Priority waitForEvents) {\n      */\n     static XContentType enforceSameContentType(IndexRequest indexRequest, @Nullable XContentType xContentType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "originalPosition": 2}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ4MTc1NDA4", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-548175408", "createdAt": "2020-12-09T13:22:15Z", "commit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzoyMjoxNlrOICUT5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wOVQxMzoyMjoxNlrOICUT5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzOTMwMDgzOQ==", "bodyText": "mapParser keeps the original provided contentType - for instance VND_JSON\nparser.contentType in this test is created from createParser(xContentType.xContent() which looses the information about the original VND_JSON", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r539300839", "createdAt": "2020-12-09T13:22:16Z", "author": {"login": "pgomulka"}, "path": "libs/x-content/src/test/java/org/elasticsearch/common/xcontent/MapXContentParserTests.java", "diffHunk": "@@ -91,7 +91,7 @@ public void compareTokens(CheckedConsumer<XContentBuilder, IOException> consumer\n             try (XContentParser parser = createParser(xContentType.xContent(), BytesReference.bytes(builder))) {\n                 try (XContentParser mapParser = new MapXContentParser(\n                     xContentRegistry(), LoggingDeprecationHandler.INSTANCE, map, xContentType)) {\n-                    assertEquals(parser.contentType(), mapParser.contentType());\n+//                    assertEquals(parser.contentType(), mapParser.contentType());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ5MTk5MDM4", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-549199038", "createdAt": "2020-12-10T13:34:21Z", "commit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMzozNDoyMlrOIDJe3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xMFQxMzozNDoyMlrOIDJe3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE3MTk5Nw==", "bodyText": "do we care about versioned media types in watcher's HttpRequest?", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r540171997", "createdAt": "2020-12-10T13:34:22Z", "author": {"login": "pgomulka"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/common/http/HttpRequest.java", "diffHunk": "@@ -499,17 +498,17 @@ public Builder fromUrl(String supposedUrl) {\n      * Write a request via toXContent, but filter certain parts of it - this is needed to not expose secrets\n      *\n      * @param request        The HttpRequest object to serialize\n-     * @param xContent       The xContent from the parent outputstream builder\n+     * @param xContentType   The XContentType from the parent outputstream builder\n      * @param params         The ToXContentParams from the parent write\n      * @param excludeField   The field to exclude\n      * @return               A bytearrayinputstream that contains the serialized request\n      * @throws IOException   if an IOException is triggered in the underlying toXContent method\n      */\n-    public static InputStream filterToXContent(HttpRequest request, XContent xContent, ToXContent.Params params,\n+    public static InputStream filterToXContent(HttpRequest request, XContentType xContentType, Params params,\n                                                String excludeField) throws IOException {\n         try (ByteArrayOutputStream bos = new ByteArrayOutputStream();\n-             XContentBuilder filteredBuilder = new XContentBuilder(xContent, bos,\n-                     Collections.emptySet(), Collections.singleton(excludeField))) {\n+             XContentBuilder filteredBuilder = new XContentBuilder(xContentType.xContent(), bos,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "originalPosition": 25}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5030a572289367684fb81d0680cb3408d5190820", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/5030a572289367684fb81d0680cb3408d5190820", "committedDate": "2020-12-10T13:47:01Z", "message": "inline read and javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ce88adeacb07035cb38a1dceb7aed6d195fd478", "committedDate": "2020-12-10T14:45:23Z", "message": "use canonical in mapxcontentparsertests"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUxNDU2ODQ5", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-551456849", "createdAt": "2020-12-14T15:05:23Z", "commit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "state": "COMMENTED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNFQxNTowNToyM1rOIFU0uw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQwMDo0Mjo1MlrOIGmc1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ1NDk3MQ==", "bodyText": "Can this be more explicit ? if (vnd_json) then return json.ordinal ? (just for readability)", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r542454971", "createdAt": "2020-12-14T15:05:23Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/common/xcontent/XContentHelper.java", "diffHunk": "@@ -453,4 +455,18 @@ public static BytesReference childBytes(XContentParser parser) throws IOExceptio\n         builder.copyCurrentStructure(parser);\n         return BytesReference.bytes(builder);\n     }\n+\n+    /**\n+     * Serialises new XContentType vnd values in a bwc manner\n+     * TODO remove in ES v9\n+     * @param out stream output of the destination node\n+     * @param xContentType an instance to serialise\n+     */\n+    public static void writeTo(StreamOutput out, XContentType xContentType) throws IOException {\n+        if (out.getVersion().before(Version.V_8_0_0)) {\n+            out.writeVInt(xContentType.ordinal() % 4);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjQ1NjIxOA==", "bodyText": "no, at least not for now.", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r542456218", "createdAt": "2020-12-14T15:06:57Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/common/http/HttpRequest.java", "diffHunk": "@@ -499,17 +498,17 @@ public Builder fromUrl(String supposedUrl) {\n      * Write a request via toXContent, but filter certain parts of it - this is needed to not expose secrets\n      *\n      * @param request        The HttpRequest object to serialize\n-     * @param xContent       The xContent from the parent outputstream builder\n+     * @param xContentType   The XContentType from the parent outputstream builder\n      * @param params         The ToXContentParams from the parent write\n      * @param excludeField   The field to exclude\n      * @return               A bytearrayinputstream that contains the serialized request\n      * @throws IOException   if an IOException is triggered in the underlying toXContent method\n      */\n-    public static InputStream filterToXContent(HttpRequest request, XContent xContent, ToXContent.Params params,\n+    public static InputStream filterToXContent(HttpRequest request, XContentType xContentType, Params params,\n                                                String excludeField) throws IOException {\n         try (ByteArrayOutputStream bos = new ByteArrayOutputStream();\n-             XContentBuilder filteredBuilder = new XContentBuilder(xContent, bos,\n-                     Collections.emptySet(), Collections.singleton(excludeField))) {\n+             XContentBuilder filteredBuilder = new XContentBuilder(xContentType.xContent(), bos,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MDE3MTk5Nw=="}, "originalCommit": {"oid": "48200e2762c66f69391e27e3eb727dc11af18d72"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MjU0MTEwMQ==", "bodyText": "can you add java doc ?", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r542541101", "createdAt": "2020-12-14T16:52:28Z", "author": {"login": "jakelandis"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentType.java", "diffHunk": "@@ -207,4 +324,19 @@ public String mediaType() {\n     public abstract XContent xContent();\n \n     public abstract String mediaTypeWithoutParameters();\n+\n+    public String responseContentTypeHeader(Map<String,String> parameters) {\n+        return this.mediaTypeWithoutParameters() + formatParameters(parameters);\n+    }\n+\n+    private String formatParameters(Map<String, String> parameters) {\n+        String joined = parameters.entrySet().stream()\n+            .map(e -> e.getKey() + \"=\" + e.getValue())\n+            .collect(Collectors.joining(\";\"));\n+        return joined.isEmpty() ? \"\" : \";\" + joined;\n+    }\n+\n+    public XContentType canonical(){", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4MzQ5OA==", "bodyText": "Can you add an java assert to StreamOutput#.writeEnum to ensure that XContentType is not being serialized there ?", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r543783498", "createdAt": "2020-12-16T00:19:56Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/common/xcontent/XContentHelper.java", "diffHunk": "@@ -453,4 +455,18 @@ public static BytesReference childBytes(XContentParser parser) throws IOExceptio\n         builder.copyCurrentStructure(parser);\n         return BytesReference.bytes(builder);\n     }\n+\n+    /**\n+     * Serialises new XContentType vnd values in a bwc manner", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NDQwNA==", "bodyText": "can you update the javadoc ?", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r543784404", "createdAt": "2020-12-16T00:22:18Z", "author": {"login": "jakelandis"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -77,8 +75,8 @@ public static XContentBuilder builder(XContent xContent) throws IOException {\n      * @param excludes the exclusive filters: only fields and objects that don't match the exclusive filters will be written to the output.\n      * @throws IOException if an {@link IOException} occurs while building the content\n      */\n-    public static XContentBuilder builder(XContent xContent, Set<String> includes, Set<String> excludes) throws IOException {\n-        return new XContentBuilder(xContent, new ByteArrayOutputStream(), includes, excludes);\n+    public static XContentBuilder builder(XContentType xContent, Set<String> includes, Set<String> excludes) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc4NjkwNQ==", "bodyText": "something to consider for later ... but I wonder if there is any overlap between the responseContentTypeString set here and ParsedMediaType. Meaning that ParsedMediaType is essentially  String -> Parts... I wonder if there is the opposite where we could pass a ResponseMediaType that would be Parts -> String. It would clean up the contract abit since String as parameters is a fairly loose contract.", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r543786905", "createdAt": "2020-12-16T00:28:53Z", "author": {"login": "jakelandis"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentBuilder.java", "diffHunk": "@@ -191,16 +193,22 @@ public XContentBuilder(XContent xContent, OutputStream bos, Set<String> includes\n      * remaining fields against the inclusive filters.\n      * <p>\n      * Make sure to call {@link #close()} when the builder is done with.\n-     *\n-     * @param os       the output stream\n+     *  @param os       the output stream\n      * @param includes the inclusive filters: only fields and objects that match the inclusive filters will be written to the output.\n      * @param excludes the exclusive filters: only fields and objects that don't match the exclusive filters will be written to the output.\n+     * @param responseContentTypeString  a content-type header value to be send back on a response\n      */\n-    public XContentBuilder(XContent xContent, OutputStream os, Set<String> includes, Set<String> excludes) throws IOException {\n+    public XContentBuilder(XContent xContent, OutputStream os, Set<String> includes, Set<String> excludes,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5MTUzMw==", "bodyText": "I think the MediaTypeRegistry class level java doc could use a minor update with this change.", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r543791533", "createdAt": "2020-12-16T00:41:03Z", "author": {"login": "jakelandis"}, "path": "libs/x-content/src/main/java/org/elasticsearch/common/xcontent/XContentType.java", "diffHunk": "@@ -144,10 +137,134 @@ public XContent xContent() {\n         @Override\n         public Set<HeaderValue> headerValues() {\n             return Set.of(\n-                new HeaderValue(\"application/cbor\"),\n+                new HeaderValue(\"application/cbor\"));\n+        }\n+    },\n+    /**\n+     * A versioned JSON based content type.\n+     */\n+    VND_JSON(4) {\n+        @Override\n+        public String mediaTypeWithoutParameters() {\n+            return VENDOR_APPLICATION_PREFIX + \"json\";\n+        }\n+\n+        @Override\n+        public String queryParameter() {\n+            return \"vnd_json\";\n+        }\n+\n+        @Override\n+        public XContent xContent() {\n+            return JsonXContent.jsonXContent;\n+        }\n+\n+        @Override\n+        public Set<HeaderValue> headerValues() {\n+            return Set.of(\n+                new HeaderValue(VENDOR_APPLICATION_PREFIX + \"json\",\n+                    Map.of(COMPATIBLE_WITH_PARAMETER_NAME, VERSION_PATTERN)),\n+                new HeaderValue(VENDOR_APPLICATION_PREFIX + \"x-ndjson\",\n+                    Map.of(COMPATIBLE_WITH_PARAMETER_NAME, VERSION_PATTERN)));\n+        }\n+\n+        @Override\n+        public XContentType canonical() {\n+            return JSON;\n+        }\n+    },\n+    /**\n+     * Versioned jackson based smile binary format. Fast and compact binary format.\n+     */\n+    VND_SMILE(5) {\n+        @Override\n+        public String mediaTypeWithoutParameters() {\n+            return VENDOR_APPLICATION_PREFIX + \"smile\";\n+        }\n+\n+        @Override\n+        public String queryParameter() {\n+            return \"vnd_smile\";\n+        }\n+\n+        @Override\n+        public XContent xContent() {\n+            return SmileXContent.smileXContent;\n+        }\n+\n+        @Override\n+        public Set<HeaderValue> headerValues() {\n+            return Set.of(\n+                new HeaderValue(VENDOR_APPLICATION_PREFIX + \"smile\",\n+                    Map.of(COMPATIBLE_WITH_PARAMETER_NAME, VERSION_PATTERN)));\n+        }\n+\n+        @Override\n+        public XContentType canonical() {\n+            return SMILE;\n+        }\n+    },\n+    /**\n+     * A Versioned YAML based content type.\n+     */\n+    VND_YAML(6) {\n+        @Override\n+        public String mediaTypeWithoutParameters() {\n+            return VENDOR_APPLICATION_PREFIX + \"yaml\";\n+        }\n+\n+        @Override\n+        public String queryParameter() {\n+            return \"vnd_yaml\";\n+        }\n+\n+        @Override\n+        public XContent xContent() {\n+            return YamlXContent.yamlXContent;\n+        }\n+\n+        @Override\n+        public Set<HeaderValue> headerValues() {\n+            return Set.of(\n+                new HeaderValue(VENDOR_APPLICATION_PREFIX + \"yaml\",\n+                    Map.of(COMPATIBLE_WITH_PARAMETER_NAME, VERSION_PATTERN)));\n+        }\n+\n+        @Override\n+        public XContentType canonical() {\n+            return YAML;\n+        }\n+    },\n+    /**\n+     * A Versioned CBOR based content type.\n+     */\n+    VND_CBOR(7) {\n+        @Override\n+        public String mediaTypeWithoutParameters() {\n+            return VENDOR_APPLICATION_PREFIX + \"cbor\";\n+        }\n+\n+        @Override\n+        public String queryParameter() {\n+            return \"vnd_cbor\";\n+        }\n+\n+        @Override\n+        public XContent xContent() {\n+            return CborXContent.cborXContent;\n+        }\n+\n+        @Override\n+        public Set<HeaderValue> headerValues() {\n+            return Set.of(\n                 new HeaderValue(VENDOR_APPLICATION_PREFIX + \"cbor\",\n                     Map.of(COMPATIBLE_WITH_PARAMETER_NAME, VERSION_PATTERN)));\n         }\n+\n+        @Override\n+        public XContentType canonical() {\n+            return CBOR;\n+        }\n     };\n \n     public static final MediaTypeRegistry<XContentType> MEDIA_TYPE_REGISTRY = new MediaTypeRegistry<XContentType>()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 178}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0Mzc5MjM0MQ==", "bodyText": "nit: if want to leave this todo, can you make it TODO:  and add a possible reason ... i guess i don't see how would belong in XContentType ?", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r543792341", "createdAt": "2020-12-16T00:42:52Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/rest/RestController.java", "diffHunk": "@@ -237,7 +237,9 @@ private void dispatchRequest(RestRequest request, RestChannel channel, RestHandl\n                 sendContentTypeErrorMessage(request.getAllHeaderValues(\"Content-Type\"), channel);\n                 return;\n             }\n-            if (handler.supportsContentStream() && xContentType != XContentType.JSON && xContentType != XContentType.SMILE) {\n+            //todo consider moving to XContentType", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ce88adeacb07035cb38a1dceb7aed6d195fd478"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f97f0c4796806af2cbe780aba39695121d42e4ae", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/f97f0c4796806af2cbe780aba39695121d42e4ae", "committedDate": "2020-12-16T12:08:02Z", "message": "javadocs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "752968cc833edac449659d6219dfcb9fd5b6d019", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/752968cc833edac449659d6219dfcb9fd5b6d019", "committedDate": "2020-12-17T10:47:01Z", "message": "response media type to be a ParsedMediaType instead of just a string"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01ce0f4914a433f15a231cf7af0b4a9acdd2aef6", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/01ce0f4914a433f15a231cf7af0b4a9acdd2aef6", "committedDate": "2020-12-17T15:45:20Z", "message": "fix tests and new test for request/response headers"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3ebf1f49fdff8551d00846de0c479f87ec5678f", "committedDate": "2020-12-17T17:03:22Z", "message": "replace application/json;charset=utf-8"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODA2MDE0", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-554806014", "createdAt": "2020-12-17T17:05:14Z", "commit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzowNToxNFrOIH_kdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzowNToxNFrOIH_kdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1MjQ2OA==", "bodyText": "I replaced this one to be consistent with what ES will now return.\nno space after media type\nand lowercased parameters", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r545252468", "createdAt": "2020-12-17T17:05:14Z", "author": {"login": "pgomulka"}, "path": "modules/lang-mustache/src/main/java/org/elasticsearch/script/mustache/CustomMustacheFactory.java", "diffHunk": "@@ -52,7 +52,7 @@\n \n public class CustomMustacheFactory extends DefaultMustacheFactory {\n \n-    static final String JSON_MIME_TYPE_WITH_CHARSET = \"application/json; charset=UTF-8\";\n+    static final String JSON_MIME_TYPE_WITH_CHARSET = \"application/json;charset=utf-8\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODExODI2", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-554811826", "createdAt": "2020-12-17T17:12:02Z", "commit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzoxMjowMlrOIH_3Ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzoxMjowMlrOIH_3Ag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1NzIxOA==", "bodyText": "only if charset was on a request it will be returned back", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r545257218", "createdAt": "2020-12-17T17:12:02Z", "author": {"login": "pgomulka"}, "path": "server/src/test/java/org/elasticsearch/rest/action/document/RestGetSourceActionTests.java", "diffHunk": "@@ -63,7 +63,7 @@ public void testRestGetSourceAction() throws Exception {\n         final RestResponse restResponse = listener.buildResponse(response);\n \n         assertThat(restResponse.status(), equalTo(OK));\n-        assertThat(restResponse.contentType(), equalTo(\"application/json; charset=UTF-8\"));\n+        assertThat(restResponse.contentType(), equalTo(\"application/json\"));//dropping charset as it was not on a request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODE0MDY2", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-554814066", "createdAt": "2020-12-17T17:14:44Z", "commit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzoxNDo0NFrOIH_-KQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxNzoxNDo0NFrOIH_-KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTI1OTA0OQ==", "bodyText": "just to make it consistent with other usages of charset in our codebase, but it actually is not relevant to the PR", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r545259049", "createdAt": "2020-12-17T17:14:44Z", "author": {"login": "pgomulka"}, "path": "x-pack/plugin/watcher/src/test/java/org/elasticsearch/xpack/watcher/input/http/HttpInputTests.java", "diffHunk": "@@ -267,7 +267,7 @@ public void testThatExpectedContentTypeOverridesReturnedContentType() throws Exc\n         ExecutableHttpInput input = new ExecutableHttpInput(httpInput, httpClient, templateEngine);\n \n         Map<String, String[]> headers = new HashMap<>(1);\n-        String contentType = randomFrom(\"application/json\", \"application/json; charset=UTF-8\", \"text/html\", \"application/yaml\",\n+        String contentType = randomFrom(\"application/json\", \"application/json;charset=utf-8\", \"text/html\", \"application/yaml\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3ebf1f49fdff8551d00846de0c479f87ec5678f"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1d0463bf7f0fcf8a7d12afe02a2bc9c5c0db9db", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1d0463bf7f0fcf8a7d12afe02a2bc9c5c0db9db", "committedDate": "2020-12-17T17:16:26Z", "message": "file header and ;;"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODc5NDQ2", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-554879446", "createdAt": "2020-12-17T18:34:04Z", "commit": {"oid": "01ce0f4914a433f15a231cf7af0b4a9acdd2aef6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODozNDowNVrOIIDPoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxODozNDowNVrOIIDPoQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTMxMjY3Mw==", "bodyText": "Can you change this apply plugin: 'elasticsearch.java-rest-test' and move the test from src/test to src/javaRestTest (once you refresh the Grade project src/javaRestTest will show up as a normal source folder)\nThis helps to disambiguate which kind of REST test allowing for different configurations if needed.", "url": "https://github.com/elastic/elasticsearch/pull/65500#discussion_r545312673", "createdAt": "2020-12-17T18:34:05Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/rest-compatibility/build.gradle", "diffHunk": "@@ -18,6 +18,7 @@\n  */\n \n apply plugin: 'elasticsearch.esplugin'\n+apply plugin: 'elasticsearch.rest-test'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ce0f4914a433f15a231cf7af0b4a9acdd2aef6"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0ODgxNzI4", "url": "https://github.com/elastic/elasticsearch/pull/65500#pullrequestreview-554881728", "createdAt": "2020-12-17T18:37:13Z", "commit": {"oid": "e1d0463bf7f0fcf8a7d12afe02a2bc9c5c0db9db"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e02970cc7435a8b5b379e5c344fba560846f9caa", "author": {"user": {"login": "pgomulka", "name": "Przemyslaw Gomulka"}}, "url": "https://github.com/elastic/elasticsearch/commit/e02970cc7435a8b5b379e5c344fba560846f9caa", "committedDate": "2020-12-18T09:30:10Z", "message": "javadoc, it test in javaRestTest and scripting response about charset"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4273, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}