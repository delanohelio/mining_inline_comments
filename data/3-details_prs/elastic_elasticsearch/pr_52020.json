{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMTQzNjI4", "number": 52020, "title": "GeoShape Doc Values: Fix and document tiling semantics for shapes", "bodyText": "This commit resolves an issue in the geogrid shape tiler\n\nfixes geohash brute-force-tiling to be equivalent to recursive geohash\ntiling\nResolves geotile tiling so that shapes outside of the geotile bounds are\ndiscarded\nTriangleTree#relate is changed to be a specific relation against tiles\nsuch that intersections of tiles on the southern and western bounds\nof the shape are counted\nFix Extent -> BoundingBox edge-case on the dateline\nmute some tests for further debugging", "createdAt": "2020-02-06T22:28:53Z", "url": "https://github.com/elastic/elasticsearch/pull/52020", "merged": true, "mergeCommit": {"oid": "c95396db0582f664a3b1e948261430c86f8caf99"}, "closed": true, "closedAt": "2020-02-11T18:08:53Z", "author": {"login": "talevy"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcB8O2kAFqTM1NTAzNjc4OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABcDUvSAAH2gAyMzcyMTQzNjI4OmZhNGIzNTJiNjIzZTAyYTNiMGQwMjhlMjBlYWNlZmEzMzcxZmMxYzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1MDM2Nzg5", "url": "https://github.com/elastic/elasticsearch/pull/52020#pullrequestreview-355036789", "createdAt": "2020-02-07T09:44:28Z", "commit": {"oid": "fff54653ef36ad69a27c8cfa85443b8bee86be8c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo0NDoyOVrOFm3fKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QwOTo0NDo1OFrOFm3f9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5OTMwNg==", "bodyText": "We need to do a similar change for Tile2D#contains and Tile2D#relateLine", "url": "https://github.com/elastic/elasticsearch/pull/52020#discussion_r376299306", "createdAt": "2020-02-07T09:44:29Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/common/geo/TriangleTreeReader.java", "diffHunk": "@@ -311,22 +314,23 @@ private boolean intersectsLine(int aX, int aY, int bX, int bY) {\n          * Checks if the rectangle intersects the provided triangle\n          **/\n         private GeoRelation relateTriangle(int aX, int aY, boolean ab, int bX, int bY, boolean bc, int cX, int cY, boolean ca) {\n-            // 1. query contains any triangle points\n-            if (contains(aX, aY) || contains(bX, bY) || contains(cX, cY)) {\n-                return GeoRelation.QUERY_CROSSES;\n-            }\n-\n             // compute bounding box of triangle\n             int tMinX = StrictMath.min(StrictMath.min(aX, bX), cX);\n             int tMaxX = StrictMath.max(StrictMath.max(aX, bX), cX);\n             int tMinY = StrictMath.min(StrictMath.min(aY, bY), cY);\n             int tMaxY = StrictMath.max(StrictMath.max(aY, bY), cY);\n \n-            // 2. check bounding boxes are disjoint\n-            if (tMaxX < minX || tMinX > maxX || tMinY > maxY || tMaxY < minY) {\n+\n+            // 1. check bounding boxes are disjoint, where north and east boundaries are not considered as crossing\n+            if (tMaxX <= minX || tMinX > maxX || tMinY > maxY || tMaxY <= minY) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff54653ef36ad69a27c8cfa85443b8bee86be8c"}, "originalPosition": 184}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjI5OTUxMQ==", "bodyText": "+1", "url": "https://github.com/elastic/elasticsearch/pull/52020#discussion_r376299511", "createdAt": "2020-02-07T09:44:58Z", "author": {"login": "iverase"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -200,19 +226,13 @@ protected int setValuesByBruteForceScan(GeoShapeCellValues values, MultiGeoValue\n         }\n \n         protected int setValuesByRasterization(int xTile, int yTile, int zTile, GeoShapeCellValues values,\n-                                               int valuesIndex, int targetPrecision, MultiGeoValues.GeoValue geoValue,\n-                                               MultiGeoValues.BoundingBox shapeBounds) {\n+                                               int valuesIndex, int targetPrecision, MultiGeoValues.GeoValue geoValue) {\n             zTile++;\n             for (int i = 0; i < 2; i++) {\n                 for (int j = 0; j < 2; j++) {\n                     int nextX = 2 * xTile + i;\n                     int nextY = 2 * yTile + j;\n                     Rectangle rectangle = GeoTileUtils.toBoundingBox(nextX, nextY, zTile);\n-                    // TODO: this looks hacky, maybe the relate method should handle it?\n-                    if (shapeBounds.minX() == rectangle.getMaxX() ||\n-                        shapeBounds.maxY() == rectangle.getMinY()) {\n-                        continue;\n-                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fff54653ef36ad69a27c8cfa85443b8bee86be8c"}, "originalPosition": 119}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d718d38ec125ec1f7787db4d2ba58b5a14eb709a", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/d718d38ec125ec1f7787db4d2ba58b5a14eb709a", "committedDate": "2020-02-10T20:50:45Z", "message": "Fix and document tiling semantics for shapes\n\nThis commit resolves an issue in the geogrid shape tiler\n\n1. fixes geohash brute-force-tiling to be equivalent to recursive geohash\n   tiling\n2. Resolves geotile tiling so that shapes outside of the geotile bounds are\n   discarded\n3. TriangleTree#relate is changed to be a specific relation against tiles\n   such that intersections of tiles on the southern and western bounds\n   of the shape are counted"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f87ea0f0e5c39a5ca9836bbc68c836a675cbbf35", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/f87ea0f0e5c39a5ca9836bbc68c836a675cbbf35", "committedDate": "2020-02-10T20:50:45Z", "message": "more cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5842a5df32e893bc5668d5e9b5cd503100d1f8fe", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/5842a5df32e893bc5668d5e9b5cd503100d1f8fe", "committedDate": "2020-02-10T20:50:45Z", "message": "in silico"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad89be5871c824b228111bd21df43aa638f3ec06", "committedDate": "2020-02-11T16:12:00Z", "message": "fix a few more edge cases and mute tests for more debugging\n\n- Extent -> BoundingBox had a bug where 180/-180 and 90/-90 were\n  treated as infinities.\n- awaitfixed a few edge-case tests\n- added muted test for checking that tile hashes of points along a\n  tile reflect the same tiles returned by the tiler's setValues"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fff54653ef36ad69a27c8cfa85443b8bee86be8c", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/fff54653ef36ad69a27c8cfa85443b8bee86be8c", "committedDate": "2020-02-06T23:47:02Z", "message": "more cleanup"}, "afterCommit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad89be5871c824b228111bd21df43aa638f3ec06", "committedDate": "2020-02-11T16:12:00Z", "message": "fix a few more edge cases and mute tests for more debugging\n\n- Extent -> BoundingBox had a bug where 180/-180 and 90/-90 were\n  treated as infinities.\n- awaitfixed a few edge-case tests\n- added muted test for checking that tile hashes of points along a\n  tile reflect the same tiles returned by the tiler's setValues"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2NzkzMjY2", "url": "https://github.com/elastic/elasticsearch/pull/52020#pullrequestreview-356793266", "createdAt": "2020-02-11T16:16:13Z", "commit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjoxNjoxM1rOFoPbTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMVQxNjoxNjoxM1rOFoPbTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3Nzc0MDEwOA==", "bodyText": "I believe this can be improved, maybe there can be a way to wrap the shape such that all the latitudes above the map can be normalized down to the edge tile", "url": "https://github.com/elastic/elasticsearch/pull/52020#discussion_r377740108", "createdAt": "2020-02-11T16:16:13Z", "author": {"login": "talevy"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/geogrid/GeoGridTiler.java", "diffHunk": "@@ -156,10 +157,37 @@ public long encode(double x, double y, int precision) {\n             return GeoTileUtils.longEncode(x, y, precision);\n         }\n \n+        /**\n+         * Sets the values of the long[] underlying {@link GeoShapeCellValues}.\n+         *\n+         * If the shape resides between <code>GeoTileUtils.LATITUDE_MASK</code> and 90 degree latitudes, then\n+         * the shape is not accounted for since geo-tiles are only defined within those bounds.\n+         *\n+         * @param values     the bucket values\n+         * @param geoValue   the input shape\n+         * @param precision  the tile zoom-level\n+         *\n+         * @return the number of tiles set by the shape\n+         */\n         @Override\n         public int setValues(GeoShapeCellValues values, MultiGeoValues.GeoValue geoValue, int precision) {\n             MultiGeoValues.BoundingBox bounds = geoValue.boundingBox();\n             assert bounds.minX() <= bounds.maxX();\n+\n+            if (precision == 0) {\n+                values.resizeCell(1);\n+                values.add(0, GeoTileUtils.longEncodeTiles(0, 0, 0));\n+                return 1;\n+            }\n+\n+            // geo tiles are not defined at the extreme latitudes due to them\n+            // tiling the world as a square.\n+            if ((bounds.top > GeoTileUtils.LATITUDE_MASK && bounds.bottom > GeoTileUtils.LATITUDE_MASK)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06"}, "originalPosition": 86}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Nzk5NDY2", "url": "https://github.com/elastic/elasticsearch/pull/52020#pullrequestreview-356799466", "createdAt": "2020-02-11T16:23:32Z", "commit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU2Nzk5NzEy", "url": "https://github.com/elastic/elasticsearch/pull/52020#pullrequestreview-356799712", "createdAt": "2020-02-11T16:23:49Z", "commit": {"oid": "ad89be5871c824b228111bd21df43aa638f3ec06"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1024396949e7c1811b91d4ea5180f24d1fd8aafd", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/1024396949e7c1811b91d4ea5180f24d1fd8aafd", "committedDate": "2020-02-11T16:32:55Z", "message": "fix checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa4b352b623e02a3b0d028e20eacefa3371fc1c7", "author": {"user": {"login": "talevy", "name": "Tal Levy"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa4b352b623e02a3b0d028e20eacefa3371fc1c7", "committedDate": "2020-02-11T16:57:36Z", "message": "Merge remote-tracking branch 'elastic/geoshape-doc-values' into gdv-tiler-relate"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2911, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}