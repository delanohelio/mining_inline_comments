{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMzEwNzc4", "number": 66356, "title": "ILM: make the unfollow action and CCR related steps retryable", "bodyText": "This makes the unfollow action and the CCR related steps\nretryable.\nWe already test the retryability infrastructure in several integration tests\nin TimeseriesLifecycleIT (ie. testILMRolloverOnManuallyRolledIndex,\ntestILMRolloverRetriesOnReadOnlyBlock, testRolloverStepRetriesUntilRolledOverIndexIsDeleted,\ntestSetSingleNodeAllocationRetriesUntilItSucceeds etc.) so this PR doesn't\ncontain additional tests.\nRelates to #48183", "createdAt": "2020-12-15T14:54:55Z", "url": "https://github.com/elastic/elasticsearch/pull/66356", "merged": true, "mergeCommit": {"oid": "cda7b614d335ecad543f5c4a7697c8f77d3a8b5c"}, "closed": true, "closedAt": "2021-01-12T14:51:40Z", "author": {"login": "andreidan"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmbZXZAH2gAyNTQwMzEwNzc4OmI4MzQwYTFmNDBjODkxOGM4YjdiYzMyNDNlNWNhNzYzMzg3MjExZjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdvMrqvAFqTU2NTcxODEwMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8340a1f40c8918c8b7bc3243e5ca763387211f9", "committedDate": "2020-12-15T14:41:30Z", "message": "ILM: make the unfollow action and CCR related steps retryable"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNjQwMDkx", "url": "https://github.com/elastic/elasticsearch/pull/66356#pullrequestreview-552640091", "createdAt": "2020-12-15T16:28:09Z", "commit": {"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNjoyODowOVrOIGUPVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxODowODoxNVrOIHSc9A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQ5Mzk3Mw==", "bodyText": "I just realized that we could remove this step entirely in favor of the OpenIndexStep, because as far as I can see, they're identical. (definitely as a followup though)", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r543493973", "createdAt": "2020-12-15T16:28:09Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/OpenFollowerIndexStep.java", "diffHunk": "@@ -20,6 +20,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMjE0NQ==", "bodyText": "Is there any way that we can check whether the pause has already happened and skip it here? Here's the scenario I'm concerned about:\n\nPause gets executed\nRequest is not acknowledged\nAssertion is thrown (I think I've seen users run with assertions enabled before)\nIndex enters the ERROR state\nRetries the pause\nBecause the pause has already occurred, the TransportPauseFollowAction throws an exception as pausing twice throws an exception\nNow we're stuck in an ERROR loop\n\nI think we should also handle the case where the index is manually paused and then the pause-follower-index step runs, it should skip the index.", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r544512145", "createdAt": "2020-12-16T18:06:28Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/PauseFollowerIndexStep.java", "diffHunk": "@@ -17,6 +17,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {\n+        return true;\n+    }\n+\n     @Override\n     void innerPerformAction(String followerIndex, Listener listener) {\n         PauseFollowAction.Request request = new PauseFollowAction.Request(followerIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDUxMzI2OA==", "bodyText": "Same comment here about skipping if the index is already unfollowed, a double unfollow throws an error so we'd just be retrying forever if it were executed after the index was already unfollowed", "url": "https://github.com/elastic/elasticsearch/pull/66356#discussion_r544513268", "createdAt": "2020-12-16T18:08:15Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/UnfollowFollowIndexStep.java", "diffHunk": "@@ -23,6 +23,11 @@\n         super(key, nextStepKey, client);\n     }\n \n+    @Override\n+    public boolean isRetryable() {\n+        return true;\n+    }\n+\n     @Override\n     void innerPerformAction(String followerIndex, Listener listener) {\n         UnfollowAction.Request request = new UnfollowAction.Request(followerIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b8340a1f40c8918c8b7bc3243e5ca763387211f9"}, "originalPosition": 11}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26d71af33ff6f97b7674431740849890d63396ea", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/26d71af33ff6f97b7674431740849890d63396ea", "committedDate": "2020-12-17T15:35:08Z", "message": "Merge branch 'master' into ilm-unfollow-retryable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f30984de970a3c5b04dba587ec3dd8aa609efa12", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/f30984de970a3c5b04dba587ec3dd8aa609efa12", "committedDate": "2020-12-18T16:22:27Z", "message": "Rename UnfollowFollowIndexStep to UnfollowFollowerIndexStep"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2a5f923349b5c6f7f94d468cc1d4c025ace7cdf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2a5f923349b5c6f7f94d468cc1d4c025ace7cdf", "committedDate": "2020-12-22T11:04:45Z", "message": "Merge branch 'master' into ilm-unfollow-retryable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "77e06d253ff49b79e041e1f39ad221d92dd25d44", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/77e06d253ff49b79e041e1f39ad221d92dd25d44", "committedDate": "2021-01-05T13:50:39Z", "message": "Merge branch 'master' into ilm-unfollow-retryable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6729ed03b00adf9b462abe83d6990674c7ff4823", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/6729ed03b00adf9b462abe83d6990674c7ff4823", "committedDate": "2021-01-07T14:50:11Z", "message": "Move ShardFollowTask to `xpack.core`"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9f57a86b86486815036644266a71b2cec3a31f18", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/9f57a86b86486815036644266a71b2cec3a31f18", "committedDate": "2021-01-07T15:51:36Z", "message": "AbstractUnfollowIndexStep skips if the managed index is not a follower index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ad2d3f7c5470153a7abcd9cb562ac158253bdc5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ad2d3f7c5470153a7abcd9cb562ac158253bdc5", "committedDate": "2021-01-07T15:52:40Z", "message": "Merge branch 'master' into ilm-unfollow-retryable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b8a7ce7784ac4a740b386df2cee1eadd34369e5", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b8a7ce7784ac4a740b386df2cee1eadd34369e5", "committedDate": "2021-01-07T17:35:38Z", "message": "Make PauseFollowerIndexStep idempotent\n\nThis moves the idempotency checkes from AbstractUnfollowIndexStep to\nPauseFollowerIndexStep as the UnfollowFollowerIndexStep was already\nidemptotent"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "482647f1656cecbd8a9c4060662abb585adb2b91", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/482647f1656cecbd8a9c4060662abb585adb2b91", "committedDate": "2021-01-07T17:44:49Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f20e9f4cf4e70bf75b856616971056cfd5dad473", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/f20e9f4cf4e70bf75b856616971056cfd5dad473", "committedDate": "2021-01-11T12:23:59Z", "message": "Convert response isAcknoledged checks from assertion to exceptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4ea8e782e02d2f6bbd99cacc4edd2c0c052a0fab", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4ea8e782e02d2f6bbd99cacc4edd2c0c052a0fab", "committedDate": "2021-01-11T12:24:33Z", "message": "Merge branch 'master' into ilm-unfollow-retryable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c69e313ad1b010d58aaed470b2085a9464a700d5", "author": {"user": {"login": "andreidan", "name": "Andrei Dan"}}, "url": "https://github.com/elastic/elasticsearch/commit/c69e313ad1b010d58aaed470b2085a9464a700d5", "committedDate": "2021-01-11T12:34:43Z", "message": "Convert isAcknowledged assertion to exception"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTY1NzE4MTAz", "url": "https://github.com/elastic/elasticsearch/pull/66356#pullrequestreview-565718103", "createdAt": "2021-01-11T20:38:14Z", "commit": {"oid": "c69e313ad1b010d58aaed470b2085a9464a700d5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4540, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}