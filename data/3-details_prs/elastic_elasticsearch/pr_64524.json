{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE0Njk4Mzc2", "number": 64524, "title": "Remove ValueFetcher depedendency from MapperService", "bodyText": "ValueFetcher needs only one method from MapperService: sourcePaths. The signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\nThis can be easily removed by having a specific lightweight object to carry around instead of the MapperService, that exposes only the needed method.\nThis change is marked breaking-java because it changes the signature of the MappedFieldType#valueFetcher method to take QueryShardContext as argument instead of MapperService. MapperPlugins that plug in a custom field type implementation will have to adapt their code to make it compile with Elasticsearch 7.11 and following versions.", "createdAt": "2020-11-03T12:24:50Z", "url": "https://github.com/elastic/elasticsearch/pull/64524", "merged": true, "mergeCommit": {"oid": "344ad33a16523a05c403a3a94cfc57087d41c98e"}, "closed": true, "closedAt": "2020-11-04T11:08:35Z", "author": {"login": "javanna"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY4WZhAFqTUyMjQ0ODI3OQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZop59gFqTUyNDY1MzI5NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDQ4Mjc5", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-522448279", "createdAt": "2020-11-03T12:30:34Z", "commit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDU3NzQw", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-522457740", "createdAt": "2020-11-03T12:43:21Z", "commit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo0MzoyMVrOHstGUQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo0MzoyMVrOHstGUQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjYzODI4OQ==", "bodyText": "Why not using QueryShardContext ? We could also remove the SearchLookup argument.", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516638289", "createdAt": "2020-11-03T12:43:21Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MappedFieldType.java", "diffHunk": "@@ -105,7 +105,7 @@ public MappedFieldType(String name, boolean isIndexed, boolean isStored,\n      * for metadata fields, field types should not throw {@link UnsupportedOperationException} since this\n      * could cause a search retrieving multiple fields (like \"fields\": [\"*\"]) to fail.\n      */\n-    public abstract ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, @Nullable String format);\n+    public abstract ValueFetcher valueFetcher(ValueFetcher.Context valueFetcherContext, SearchLookup searchLookup, @Nullable String format);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNDYwMTY4", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-522460168", "createdAt": "2020-11-03T12:46:46Z", "commit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo0Njo0NlrOHstNnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxMjo0Njo0NlrOHstNnA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjY0MDE1Ng==", "bodyText": "I'm not sure that this is better than my last attempt. I think it's up to @jtibshirani to make the call on this one.", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516640156", "createdAt": "2020-11-03T12:46:46Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/ValueFetcher.java", "diffHunk": "@@ -50,4 +51,8 @@\n      * Update the leaf reader used to fetch values.\n      */\n     default void setNextReader(LeafReaderContext context) {}\n+\n+    interface Context {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "committedDate": "2020-11-03T16:28:36Z", "message": "Remove ValueFetcher depedendency from MapperService\n\nThe signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\n\nSuch use of MapperService can be replaced with exposing the QueryShardContext which encapsulates the MapperService."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "362aceb76c8625d3d9d1df01c8a49421196826c0", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/362aceb76c8625d3d9d1df01c8a49421196826c0", "committedDate": "2020-11-03T12:23:14Z", "message": "Remove ValueFetcher depedendency from MapperService\n\nValueFetcher needs only one method from MapperService: sourcePaths. The signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\n\nThis can be easily removed by having a specific lightweight object to carry around instead of the MapperService, that exposes only the needed method."}, "afterCommit": {"oid": "e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/e2462f5a1eafc6e400d87baa2cb41b774b5759d5", "committedDate": "2020-11-03T16:28:36Z", "message": "Remove ValueFetcher depedendency from MapperService\n\nThe signature of MappedFieldType#valueFetcher requires MapperService as an argument which is unfortunate as that is one of the reasons why FetchContext exposes the whole MapperService.\n\nSuch use of MapperService can be replaced with exposing the QueryShardContext which encapsulates the MapperService."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530", "author": {"user": {"login": "javanna", "name": "Luca Cavanna"}}, "url": "https://github.com/elastic/elasticsearch/commit/db473a53a3deca5ffd864f3be823a268d1dd7530", "committedDate": "2020-11-03T16:42:43Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyNzMyNjU1", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-522732655", "createdAt": "2020-11-03T17:37:51Z", "commit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzozNzo1MVrOHs5nfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QxNzozNzo1MVrOHs5nfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjg0MzM4OQ==", "bodyText": "If we're passing QueryShardContext I think that means we can avoid passing SearchLookup here?", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r516843389", "createdAt": "2020-11-03T17:37:51Z", "author": {"login": "romseygeek"}, "path": "modules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/RankFeatureFieldMapper.java", "diffHunk": "@@ -114,11 +114,11 @@ public Query existsQuery(QueryShardContext context) {\n         }\n \n         @Override\n-        public ValueFetcher valueFetcher(MapperService mapperService, SearchLookup searchLookup, String format) {\n+        public ValueFetcher valueFetcher(QueryShardContext context, SearchLookup searchLookup, String format) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIzMjEwNzk5", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-523210799", "createdAt": "2020-11-04T10:05:28Z", "commit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowNToyOVrOHtRK1Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNFQxMDowNToyOVrOHtRK1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzIyOTI2OQ==", "bodyText": "One nit: maybe this should be sourcePaths, given that it can return more than one?", "url": "https://github.com/elastic/elasticsearch/pull/64524#discussion_r517229269", "createdAt": "2020-11-04T10:05:29Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/query/QueryShardContext.java", "diffHunk": "@@ -270,6 +270,14 @@ public ObjectMapper getObjectMapper(String name) {\n         return mapperService.getObjectMapper(name);\n     }\n \n+    public boolean isMetadataField(String field) {\n+        return mapperService.isMetadataField(field);\n+    }\n+\n+    public Set<String> sourcePath(String fullName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NjUzMjk0", "url": "https://github.com/elastic/elasticsearch/pull/64524#pullrequestreview-524653294", "createdAt": "2020-11-05T20:47:19Z", "commit": {"oid": "db473a53a3deca5ffd864f3be823a268d1dd7530"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 779, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}