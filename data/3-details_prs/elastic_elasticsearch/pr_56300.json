{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE0Mjg0MjYx", "number": 56300, "title": "EQL: Introduce support for sequences", "bodyText": "Initial support for EQL sequences\nThe current algorithm is focused on correctness and does not contain\nany optimization which is left for the future.\nThe current implementation uses a state machine approach which moves\nascending and runs each query one after the other working on computing\nsequences as the data comes in.\nFor each result, the key and its timestamp are being extracted which are\nthen used for matching/building a sequence.", "createdAt": "2020-05-06T19:17:31Z", "url": "https://github.com/elastic/elasticsearch/pull/56300", "merged": true, "mergeCommit": {"oid": "4f3e18c894a1841d333022361ad9d1fdf1477dc3"}, "closed": true, "closedAt": "2020-05-13T12:14:22Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 25, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcetqvEgH2gAyNDE0Mjg0MjYxOjcwZDdjZThmNDFlMmIwMjJiNzJmOGNmZmQ1Y2VkZjQ3YmE3Njg5MGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcg3e5TgFqTQxMDg0NTExNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/70d7ce8f41e2b022b72f8cffd5cedf47ba76890b", "committedDate": "2020-05-06T19:16:13Z", "message": "EQL: Introduce support for sequences\n\nInitial support for EQL sequences\nThe current algorithm is focused on correctness and does not contain\nany optimization which is left for the future.\n\nThe current implementation uses a state machine approach which moves\nascending and runs each query one after the other working on computing\nsequences as the data comes in.\nFor each result, the key and its timestamp are being extracted which are\nthen used for matching/building a sequence."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "309f9ec5f68eff8d377907191a730b6e6a860635", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/309f9ec5f68eff8d377907191a730b6e6a860635", "committedDate": "2020-05-06T18:50:07Z", "message": "EQL: Introduce support for sequences\n\nInitial support for EQL sequences\nThe current algorithm is focused on correctness and does not contain\nany optimization which is left for the future.\n\nThe current implementation uses a state machine approach which moves\nascending and runs each query one after the other working on computing\nsequences as the data comes in.\nFor each result, the key and its timestamp are being extracted which are\nthen used for matching/building a sequence."}, "afterCommit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/70d7ce8f41e2b022b72f8cffd5cedf47ba76890b", "committedDate": "2020-05-06T19:16:13Z", "message": "EQL: Introduce support for sequences\n\nInitial support for EQL sequences\nThe current algorithm is focused on correctness and does not contain\nany optimization which is left for the future.\n\nThe current implementation uses a state machine approach which moves\nascending and runs each query one after the other working on computing\nsequences as the data comes in.\nFor each result, the key and its timestamp are being extracted which are\nthen used for matching/building a sequence."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTIyODYy", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-406922862", "createdAt": "2020-05-06T19:29:58Z", "commit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToyOTo1OVrOGRiNcw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxOToyOTo1OVrOGRiNcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTAzOTQ3NQ==", "bodyText": "Since this doesn't precisely mirror the grammar, what errors will it cause if you do this?\nby substring(field)\nI completely agree with this restriction for Elasticsearch, even though Endpoint isn't bound by it. Will this raise a good error message or does it get buried in an uncaught exception?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r421039475", "createdAt": "2020-05-06T19:29:59Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/parser/ExpressionBuilder.java", "diffHunk": "@@ -73,8 +74,8 @@ public Expression visitSingleExpression(EqlBaseParser.SingleExpressionContext ct\n     }\n \n     @Override\n-    public List<Expression> visitJoinKeys(JoinKeysContext ctx) {\n-        return ctx != null ? expressions(ctx.expression()) : emptyList();\n+    public List<Attribute> visitJoinKeys(JoinKeysContext ctx) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2OTY3MzUx", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-406967351", "createdAt": "2020-05-06T20:36:49Z", "commit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDozNjo0OVrOGRkcvg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQyMDozNjo0OVrOGRkcvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTA3NjE1OA==", "bodyText": "Thanks for this fix! Looks like this resolves\n#53237", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r421076158", "createdAt": "2020-05-06T20:36:49Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRules.java", "diffHunk": "@@ -1030,9 +1029,7 @@ protected LogicalPlan rule(Filter filter) {\n                     return filter.child();\n                 }\n                 if (FALSE.equals(condition) || Expressions.isNull(condition)) {\n-                    //TODO: re-visit this branch when it's decided if EQL needs a LocalRelation-like class\n-                    //return new LocalRelation(filter.source(), new EmptyExecutable(filter.output()));\n-                    throw new RuleExecutionException(\"Does not know how to handle a local relation\");\n+                    return nonMatchingFilter(filter);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "70d7ce8f41e2b022b72f8cffd5cedf47ba76890b"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d1ead0fda5d291b07964be5180d0b0a19c7dd7d", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/9d1ead0fda5d291b07964be5180d0b0a19c7dd7d", "committedDate": "2020-05-07T12:48:48Z", "message": "Break eventQuery into two bits\n\nAdd Projection to restrict the field extraction only to higher-level\nconstructs like join/sequence"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb8239c7ff27f768c88cf322b7b8426afc6fb3d", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb8239c7ff27f768c88cf322b7b8426afc6fb3d", "committedDate": "2020-05-07T13:13:59Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/seqence-pr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/3515f88388cf337e90245f2a907025bb6191f835", "committedDate": "2020-05-07T13:31:37Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA3NDgxMzAx", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-407481301", "createdAt": "2020-05-07T13:39:58Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxMzo0MjoxMlrOGR_HgA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wN1QxMzo1NToxM1rOGR_vOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxMzA4OA==", "bodyText": "why AtomicInteger where int will do just fine?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r421513088", "createdAt": "2020-05-07T13:42:12Z", "author": {"login": "aleksmaus"}, "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -140,18 +145,25 @@ public void cleanup() throws Exception {\n             }\n \n             if (supported) {\n-                String name = spec.description();\n-                if (Strings.isNullOrEmpty(name)) {\n-                    name = spec.note();\n-                }\n-                if (Strings.isNullOrEmpty(name)) {\n-                    name = spec.query();\n-                }\n-\n-                testSpecs.add(new Object[]{++counter, name, spec});\n+                filteredSpecs.add(spec);\n             }\n         }\n-        return testSpecs;\n+        counter = specs.size();\n+        return asArray(filteredSpecs);\n+    }\n+\n+    public static List<Object[]> asArray(List<EqlSpec> specs) {\n+        AtomicInteger counter = new AtomicInteger();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxODU4MQ==", "bodyText": "did you mean ExecutionManager.class here?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r421518581", "createdAt": "2020-05-07T13:49:22Z", "author": {"login": "aleksmaus"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/ExecutionManager.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.assembler;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.tasks.TaskCancelledException;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils;\n+import org.elasticsearch.xpack.eql.execution.payload.Payload;\n+import org.elasticsearch.xpack.eql.execution.payload.SearchResponsePayload;\n+import org.elasticsearch.xpack.eql.execution.search.Querier;\n+import org.elasticsearch.xpack.eql.execution.search.SourceGenerator;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.FieldHitExtractor;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.TimestampFieldHitExtractor;\n+import org.elasticsearch.xpack.eql.plan.physical.EsQueryExec;\n+import org.elasticsearch.xpack.eql.plan.physical.PhysicalPlan;\n+import org.elasticsearch.xpack.eql.plan.physical.SequenceExec;\n+import org.elasticsearch.xpack.eql.querydsl.container.FieldExtractorRegistry;\n+import org.elasticsearch.xpack.eql.querydsl.container.QueryContainer;\n+import org.elasticsearch.xpack.eql.session.Configuration;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+import org.elasticsearch.xpack.ql.expression.Attribute;\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.util.Check;\n+import org.elasticsearch.xpack.ql.util.StringUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils.prepareRequest;\n+\n+public class ExecutionManager implements QueryClient {\n+\n+    private static final Logger log = LogManager.getLogger(Querier.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUyMzI1Nw==", "bodyText": "do we need to assert the assumption on sizes of the plans and listOfKeys here? not obvious in the scope of this function", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r421523257", "createdAt": "2020-05-07T13:55:13Z", "author": {"login": "aleksmaus"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/ExecutionManager.java", "diffHunk": "@@ -0,0 +1,122 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.assembler;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.tasks.TaskCancelledException;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils;\n+import org.elasticsearch.xpack.eql.execution.payload.Payload;\n+import org.elasticsearch.xpack.eql.execution.payload.SearchResponsePayload;\n+import org.elasticsearch.xpack.eql.execution.search.Querier;\n+import org.elasticsearch.xpack.eql.execution.search.SourceGenerator;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.FieldHitExtractor;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.TimestampFieldHitExtractor;\n+import org.elasticsearch.xpack.eql.plan.physical.EsQueryExec;\n+import org.elasticsearch.xpack.eql.plan.physical.PhysicalPlan;\n+import org.elasticsearch.xpack.eql.plan.physical.SequenceExec;\n+import org.elasticsearch.xpack.eql.querydsl.container.FieldExtractorRegistry;\n+import org.elasticsearch.xpack.eql.querydsl.container.QueryContainer;\n+import org.elasticsearch.xpack.eql.session.Configuration;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+import org.elasticsearch.xpack.ql.expression.Attribute;\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.util.Check;\n+import org.elasticsearch.xpack.ql.util.StringUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils.prepareRequest;\n+\n+public class ExecutionManager implements QueryClient {\n+\n+    private static final Logger log = LogManager.getLogger(Querier.class);\n+\n+    private final Configuration cfg;\n+    private final Client client;\n+    private final TimeValue keepAlive;\n+    private final String indices;\n+\n+    public ExecutionManager(EqlSession eqlSession) {\n+        this.cfg = eqlSession.configuration();\n+        this.client = eqlSession.client();\n+        this.keepAlive = cfg.requestTimeout();\n+        this.indices = cfg.indexAsWildcard();\n+    }\n+\n+    public Executable from(SequenceExec seqExec) {\n+        FieldExtractorRegistry extractorRegistry = new FieldExtractorRegistry();\n+        \n+        List<List<Attribute>> listOfKeys = seqExec.keys();\n+        List<PhysicalPlan> plans = seqExec.children();\n+        List<Criterion> criteria = new ArrayList<>(plans.size() - 1);\n+        \n+        // build a criterion for each query\n+        for (int i = 0; i < plans.size() - 1; i++) {\n+            List<Attribute> keys = listOfKeys.get(i);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 70}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTYyMTA3", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409562107", "createdAt": "2020-05-11T22:00:39Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowMDozOVrOGTu7MA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjowMDozOVrOGTu7MA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0NDk0NA==", "bodyText": "Can you add clarity to what \"Instance  of a sequence\" means, and how it relates to other classes like SequenceRuntime?\n\nResult of a sequence\nA pending sequence that contains its current state as it progresses from pos 0 to pos N-1\nNode for the AST\nSequence physical plan\nQuery within a sequence\netc", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423344944", "createdAt": "2020-05-11T22:00:39Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/Sequence.java", "diffHunk": "@@ -0,0 +1,116 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.ql.util.Check;\n+\n+import java.text.NumberFormat;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.logging.LoggerMessageFormat.format;\n+\n+/**\n+ * Instance of a sequence. Defined by its key and stage.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTY3MDk1", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409567095", "createdAt": "2020-05-11T22:10:33Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoxMDozM1rOGTvLXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoxMDozM1rOGTvLXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM0OTA4NA==", "bodyText": "I just started switching over to this notation for tracking results of sequences. It makes it a little easier to read each result at a time.\nhttps://github.com/endgameinc/eql/blob/8c47601e32fac0523dd639d0b1a6d087d59814b6/eql/etc/test_queries.toml#L398-L407\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            expected_event_ids  = [1, 2, 2, 3]\n          \n          \n            \n            expected_event_ids  = [1, 2,\n          \n          \n            \n                                   2, 3]", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423349084", "createdAt": "2020-05-11T22:10:33Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries_supported.toml", "diffHunk": "@@ -118,3 +118,26 @@ query = \"file where 66.0 / serial_event_id == 1\"\n [[queries]]\n expected_event_ids = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 46]\n query = \"process where serial_event_id + ((1 + 3) * 2 / (3 - 1)) * 2 == 54 or 70 + serial_event_id < 100\"\n+\n+[[queries]]\n+query = '''\n+sequence\n+  [process where serial_event_id = 1]\n+  [process where serial_event_id = 2]\n+'''\n+expected_event_ids  = [1, 2]\n+\n+[[queries]]\n+query = '''\n+sequence\n+  [process where serial_event_id=1] by unique_pid\n+  [process where true] by unique_ppid'''\n+expected_event_ids  = [1, 2]\n+\n+[[queries]]\n+query = '''\n+sequence\n+  [process where serial_event_id<3] by unique_pid\n+  [process where true] by unique_ppid\n+'''\n+expected_event_ids  = [1, 2, 2, 3]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 26}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTcxMzM2", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409571336", "createdAt": "2020-05-11T22:19:44Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoxOTo0NVrOGTvZTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoxOTo0NVrOGTvZTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1MjY1Mg==", "bodyText": "Should we also add another test where the by is after sequence?\nsequence by unique_ppid\n  [process where serial_event_id=1]\n  [process where true]", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423352652", "createdAt": "2020-05-11T22:19:45Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries_supported.toml", "diffHunk": "@@ -118,3 +118,26 @@ query = \"file where 66.0 / serial_event_id == 1\"\n [[queries]]\n expected_event_ids = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 46]\n query = \"process where serial_event_id + ((1 + 3) * 2 / (3 - 1)) * 2 == 54 or 70 + serial_event_id < 100\"\n+\n+[[queries]]\n+query = '''\n+sequence\n+  [process where serial_event_id = 1]\n+  [process where serial_event_id = 2]\n+'''\n+expected_event_ids  = [1, 2]\n+\n+[[queries]]\n+query = '''\n+sequence", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTczODE3", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409573817", "createdAt": "2020-05-11T22:25:07Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoyNTowN1rOGTvhiQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMjoyNTowN1rOGTvhiQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM1NDc2MQ==", "bodyText": "Apparently these are getting dropped  by CommonEqlActionTestCase.readTestSpecs.\nAny idea why @aleksmaus?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423354761", "createdAt": "2020-05-11T22:25:07Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/qa/common/src/main/resources/test_queries_supported.toml", "diffHunk": "@@ -118,3 +118,26 @@ query = \"file where 66.0 / serial_event_id == 1\"\n [[queries]]\n expected_event_ids = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 46]\n query = \"process where serial_event_id + ((1 + 3) * 2 / (3 - 1)) * 2 == 54 or 70 + serial_event_id < 100\"\n+\n+[[queries]]\n+query = '''\n+sequence", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 7}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTg3NjU3", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409587657", "createdAt": "2020-05-11T22:57:45Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5NTk2NjY4", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409596668", "createdAt": "2020-05-11T23:20:55Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzoyMDo1NVrOGTwtEw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQyMzoyMDo1NVrOGTwtEw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzM3NDA5OQ==", "bodyText": "Inverting this might simplify the frame() function: List<Map<SequenceKey, SequenceFrame>>", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423374099", "createdAt": "2020-05-11T23:20:55Z", "author": {"login": "rw-access"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/KeyToSequences.java", "diffHunk": "@@ -0,0 +1,48 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.List;\n+import java.util.Map;\n+\n+/** Dedicated collection for mapping a key to a list of sequences */\n+/** The list represents the sequence for each stage (based on its index) and is fixed in size */\n+\n+class KeyToSequences {\n+\n+    private final int listSize;\n+    private final Map<SequenceKey, List<SequenceFrame>> keyToSequences;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2b608e484722493866802c68d417dcec9f8ec2e1", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b608e484722493866802c68d417dcec9f8ec2e1", "committedDate": "2020-05-12T10:48:38Z", "message": "Address feedback\n\nAdd documentation and hook up integration tests again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/e6386bf32c49c1b2a68b81672b6250abe8fc7807", "committedDate": "2020-05-12T11:29:36Z", "message": "Merge branch 'master' into eql/seqence-pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTgwNTkx", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409980591", "createdAt": "2020-05-12T12:17:05Z", "commit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjoxNzowNVrOGUDwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjoxNzowNVrOGUDwAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4NjE0NA==", "bodyText": "The projection was introduced since:\n\nthe results only care about the hits, not individual fields.\nhaving each field extracted, due to the number of exact types, causes the doc values limit to be reached.\n\nBefore this PR the event filters did not return any attributes but now, as inputs to sequences they have to otherwise the key or timestamp field resolution for them fails.\nHence why the visitEventQuery now wraps the visitEventFilter - the latter creates the proper plan for internal use while the former wraps it up for external consumption. Note that sequence and join use the same idea - they don't output any attribute since their entire content is needed.", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423686144", "createdAt": "2020-05-12T12:17:05Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/parser/LogicalPlanBuilder.java", "diffHunk": "@@ -44,8 +52,17 @@ public LogicalPlanBuilder(ParserParams params) {\n         super(params);\n     }\n \n+    private Attribute fieldTimestamp() {\n+        return new UnresolvedAttribute(Source.EMPTY, params.fieldTimestamp());\n+    }\n+\n     @Override\n     public LogicalPlan visitEventQuery(EqlBaseParser.EventQueryContext ctx) {\n+        return new Project(source(ctx), visitEventFilter(ctx.eventFilter()), emptyList());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 49}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5MTM4NTQx", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409138541", "createdAt": "2020-05-11T12:47:56Z", "commit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "state": "COMMENTED", "comments": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMVQxMjo0Nzo1NlrOGTauVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjoyMToxN1rOGUD5KQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxMzk3Mg==", "bodyText": "minor: can be final", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423013972", "createdAt": "2020-05-11T12:47:56Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/test/java/org/elasticsearch/xpack/eql/planner/QueriesUtils.java", "diffHunk": "@@ -0,0 +1,95 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.planner;\n+\n+import org.elasticsearch.common.Strings;\n+\n+import java.io.BufferedReader;\n+import java.io.InputStreamReader;\n+import java.nio.charset.StandardCharsets;\n+import java.util.ArrayList;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+\n+class QueriesUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzAxNzgxOA==", "bodyText": "Why not create an ArrayList and if necessary make it immutable before returning?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423017818", "createdAt": "2020-05-11T12:54:59Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceKey.java", "diffHunk": "@@ -0,0 +1,56 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.common.util.CollectionUtils;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+import java.util.Objects;\n+\n+public class SequenceKey {\n+\n+    public static final SequenceKey NONE = new SequenceKey();\n+\n+    private final Object[] keys;\n+\n+    public SequenceKey(Object... keys) {\n+        this.keys = keys;\n+    }\n+\n+    public List<String> asStringList() {\n+        String[] s = new String[keys.length];", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY2OTA4NQ==", "bodyText": "It's a bit of misuse for AtomicInteger only for a Holder functionality but since it's a test it's not important.", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423669085", "createdAt": "2020-05-12T11:45:31Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -140,18 +145,25 @@ public void cleanup() throws Exception {\n             }\n \n             if (supported) {\n-                String name = spec.description();\n-                if (Strings.isNullOrEmpty(name)) {\n-                    name = spec.note();\n-                }\n-                if (Strings.isNullOrEmpty(name)) {\n-                    name = spec.query();\n-                }\n-\n-                testSpecs.add(new Object[]{++counter, name, spec});\n+                filteredSpecs.add(spec);\n             }\n         }\n-        return testSpecs;\n+        counter = specs.size();\n+        return asArray(filteredSpecs);\n+    }\n+\n+    public static List<Object[]> asArray(List<EqlSpec> specs) {\n+        AtomicInteger counter = new AtomicInteger();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMTUxMzA4OA=="}, "originalCommit": {"oid": "3515f88388cf337e90245f2a907025bb6191f835"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3MDY5Mg==", "bodyText": "Is it ok to use only the 1st one?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423670692", "createdAt": "2020-05-12T11:48:42Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/listener/BasicListener.java", "diffHunk": "@@ -0,0 +1,67 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.listener;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.search.ShardSearchFailure;\n+import org.elasticsearch.common.util.CollectionUtils;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.session.Results;\n+\n+import java.util.Arrays;\n+import java.util.List;\n+\n+import static org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils.logSearchResponse;\n+\n+public class BasicListener implements ActionListener<SearchResponse> {\n+\n+    private static final Logger log = LogManager.getLogger(BasicListener.class);\n+\n+    private final ActionListener<Results> listener;\n+    private final SearchRequest request;\n+\n+    public BasicListener(ActionListener<Results> listener,\n+                               SearchRequest request) {\n+\n+        this.listener = listener;\n+        this.request = request;\n+    }\n+\n+    @Override\n+    public void onResponse(SearchResponse response) {\n+        try {\n+            ShardSearchFailure[] failures = response.getShardFailures();\n+            if (CollectionUtils.isEmpty(failures) == false) {\n+                listener.onFailure(new EqlIllegalArgumentException(failures[0].reason(), failures[0].getCause()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3MzE4MQ==", "bodyText": "Maybe extract this to a static method so that the string is also more \"static\".", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423673181", "createdAt": "2020-05-12T11:53:34Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/parser/LogicalPlanBuilder.java", "diffHunk": "@@ -62,27 +79,31 @@ public LogicalPlan visitEventQuery(EqlBaseParser.EventQueryContext ctx) {\n \n         Filter filter = new Filter(source, RELATION, condition);\n         // add implicit sorting - when pipes are added, this would better sit there (as a default pipe)\n-        Order order = new Order(source, new UnresolvedAttribute(source, params.fieldTimestamp()), Order.OrderDirection.ASC,\n-                Order.NullsPosition.FIRST);\n+        Order order = new Order(source, fieldTimestamp(), Order.OrderDirection.ASC, Order.NullsPosition.FIRST);\n         OrderBy orderBy = new OrderBy(source, filter, singletonList(order));\n         return orderBy;\n     }\n \n     @Override\n     public Join visitJoin(JoinContext ctx) {\n-        List<Expression> parentJoinKeys = visitJoinKeys(ctx.by);\n+        List<Attribute> parentJoinKeys = visitJoinKeys(ctx.by);\n+\n+        Source source = source(ctx);\n+\n+        KeyedFilter until;\n \n-        LogicalPlan until;\n-        \n         if (ctx.until != null) {\n             until = visitJoinTerm(ctx.until, parentJoinKeys);\n         } else {\n-            // no until declared means the condition never gets executed and thus folds to false\n-            until = new Filter(source(ctx), RELATION, new Literal(source(ctx), Boolean.FALSE, DataTypes.BOOLEAN));\n+            // no until declared means no results\n+            // create a dummy keyed filter\n+            String notUsed = \"<not-used>\";\n+            Attribute tsField = new FieldAttribute(source, notUsed, new UnsupportedEsField(notUsed, notUsed));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3MzY4OQ==", "bodyText": "minor: empty line.", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423673689", "createdAt": "2020-05-12T11:54:34Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plan/physical/SequenceExec.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.plan.physical;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.assembler.ExecutionManager;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.eql.session.Results;\n+import org.elasticsearch.xpack.ql.expression.Attribute;\n+import org.elasticsearch.xpack.ql.expression.Expressions;\n+import org.elasticsearch.xpack.ql.expression.NamedExpression;\n+import org.elasticsearch.xpack.ql.tree.NodeInfo;\n+import org.elasticsearch.xpack.ql.tree.Source;\n+import org.elasticsearch.xpack.ql.util.CollectionUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Objects;\n+\n+import static java.util.Collections.singletonList;\n+\n+public class SequenceExec extends PhysicalPlan {\n+\n+    private final List<List<Attribute>> keys;\n+    private final Attribute timestamp;\n+\n+    public SequenceExec(Source source,\n+                        List<List<Attribute>> keys,\n+                        List<PhysicalPlan> matches,\n+                        List<Attribute> untilKeys,\n+                        PhysicalPlan until,\n+                        Attribute timestampField) {\n+        this(source, CollectionUtils.combine(matches, until), CollectionUtils.combine(keys, singletonList(untilKeys)), timestampField);\n+    }\n+\n+    private SequenceExec(Source source, List<PhysicalPlan> children, List<List<Attribute>> keys, Attribute timestampField) {\n+        super(source, children);\n+        this.keys = keys;\n+        this.timestamp = timestampField;\n+    }\n+\n+    @Override\n+    protected NodeInfo<SequenceExec> info() {\n+        return NodeInfo.create(this, SequenceExec::new, children(), keys, timestamp);\n+    }\n+\n+    @Override\n+    public PhysicalPlan replaceChildren(List<PhysicalPlan> newChildren) {\n+        if (newChildren.size() != children().size()) {\n+            throw new EqlIllegalArgumentException(\"Expected the same number of children [{}] but got [{}]\", children().size(), newChildren\n+                    .size());\n+        }\n+        return new SequenceExec(source(), newChildren, keys, timestamp);\n+    }\n+\n+    @Override\n+    public List<Attribute> output() {\n+        List<Attribute> attrs = new ArrayList<>();\n+        attrs.add(timestamp);\n+        for (List<? extends NamedExpression> ne : keys) {\n+            attrs.addAll(Expressions.asAttributes(ne));\n+        }\n+        return attrs;\n+    }\n+\n+    public List<List<Attribute>> keys() {\n+        return keys;\n+    }\n+\n+    public Attribute timestamp() {\n+        return timestamp;\n+    }\n+\n+    @Override\n+    public void execute(EqlSession session, ActionListener<Results> listener) {\n+        new ExecutionManager(session).from(this).execute(listener);\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(timestamp, keys, children());\n+    }\n+\n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+\n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+\n+        SequenceExec other = (SequenceExec) obj;\n+        return Objects.equals(timestamp, other.timestamp)\n+                && Objects.equals(children(), other.children())\n+                && Objects.equals(keys, other.keys);\n+                ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3NTkwMg==", "bodyText": "I don't get this, sorry.", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423675902", "createdAt": "2020-05-12T11:58:33Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/Sequence.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.ql.util.Check;\n+\n+import java.text.NumberFormat;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.logging.LoggerMessageFormat.format;\n+\n+/**\n+ * Holder class representing the instance of a sequence. Used at runtime by the engine to track sequences.\n+ * Defined by its key and stage.\n+ * This class is NOT immutable (to optimize memory) which means its associations need to be managed.\n+ */\n+public class Sequence {\n+\n+    private final SequenceKey key;\n+    private final int stages;\n+    private final Match[] matches;\n+\n+    private int currentStage = 0;\n+\n+    public Sequence(SequenceKey key, int stages, long timestamp, SearchHit firstHit) {\n+        Check.isTrue(stages >= 2, \"A sequence requires at least 2 criteria, given [{}]\", stages);\n+        this.key = key;\n+        this.stages = stages;\n+        this.matches = new Match[stages];\n+        this.matches[0] = new Match(timestamp, firstHit);\n+    }\n+\n+    public int putMatch(int stage, SearchHit hit, long timestamp) {\n+        if (stage == currentStage + 1) {\n+            int previousStage = currentStage;\n+            currentStage = stage;\n+            matches[currentStage] = new Match(timestamp, hit);\n+            return previousStage;\n+        }\n+        throw new EqlIllegalArgumentException(\"Incorrect stage [{}] specified for Sequence[key={}, stage=]\", stage, key, currentStage);\n+    }\n+\n+    public SequenceKey key() {\n+        return key;\n+    }\n+\n+    public int currentStage() {\n+        return currentStage;\n+    }\n+\n+    public long currentTimestamp() {\n+        return matches[currentStage].timestamp();\n+    }\n+\n+    public long timestamp(int stage) {\n+        if (stage > currentStage) {\n+            return Long.MAX_VALUE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY3NjY0NA==", "bodyText": "You could use String.valueOf(stages).length().", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423676644", "createdAt": "2020-05-12T11:59:58Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/Sequence.java", "diffHunk": "@@ -0,0 +1,117 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.ql.util.Check;\n+\n+import java.text.NumberFormat;\n+import java.util.ArrayList;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Objects;\n+\n+import static org.elasticsearch.common.logging.LoggerMessageFormat.format;\n+\n+/**\n+ * Holder class representing the instance of a sequence. Used at runtime by the engine to track sequences.\n+ * Defined by its key and stage.\n+ * This class is NOT immutable (to optimize memory) which means its associations need to be managed.\n+ */\n+public class Sequence {\n+\n+    private final SequenceKey key;\n+    private final int stages;\n+    private final Match[] matches;\n+\n+    private int currentStage = 0;\n+\n+    public Sequence(SequenceKey key, int stages, long timestamp, SearchHit firstHit) {\n+        Check.isTrue(stages >= 2, \"A sequence requires at least 2 criteria, given [{}]\", stages);\n+        this.key = key;\n+        this.stages = stages;\n+        this.matches = new Match[stages];\n+        this.matches[0] = new Match(timestamp, firstHit);\n+    }\n+\n+    public int putMatch(int stage, SearchHit hit, long timestamp) {\n+        if (stage == currentStage + 1) {\n+            int previousStage = currentStage;\n+            currentStage = stage;\n+            matches[currentStage] = new Match(timestamp, hit);\n+            return previousStage;\n+        }\n+        throw new EqlIllegalArgumentException(\"Incorrect stage [{}] specified for Sequence[key={}, stage=]\", stage, key, currentStage);\n+    }\n+\n+    public SequenceKey key() {\n+        return key;\n+    }\n+\n+    public int currentStage() {\n+        return currentStage;\n+    }\n+\n+    public long currentTimestamp() {\n+        return matches[currentStage].timestamp();\n+    }\n+\n+    public long timestamp(int stage) {\n+        if (stage > currentStage) {\n+            return Long.MAX_VALUE;\n+        }\n+        return matches[stage].timestamp();\n+    }\n+\n+    public List<SearchHit> hits() {\n+        List<SearchHit> hits = new ArrayList<>(matches.length);\n+        for (Match m : matches) {\n+            hits.add(m.hit());\n+        }\n+        return hits;\n+    }\n+\n+    @Override\n+    public int hashCode() {\n+        return Objects.hash(currentStage, key);\n+    }\n+    \n+    @Override\n+    public boolean equals(Object obj) {\n+        if (this == obj) {\n+            return true;\n+        }\n+        \n+        if (obj == null || getClass() != obj.getClass()) {\n+            return false;\n+        }\n+        \n+        Sequence other = (Sequence) obj;\n+        return Objects.equals(currentStage, other.currentStage)\n+                && Objects.equals(key, other.key);\n+    }\n+    \n+    @Override\n+    public String toString() {\n+        int numberOfDigits = stages > 100 ? 3 : stages > 10 ? 2 : 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY4ODQ4OQ==", "bodyText": "could be also final", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423688489", "createdAt": "2020-05-12T12:21:17Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/listener/RuntimeUtils.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.listener;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.search.aggregations.Aggregation;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.FieldHitExtractor;\n+import org.elasticsearch.xpack.eql.querydsl.container.ComputedRef;\n+import org.elasticsearch.xpack.eql.querydsl.container.SearchHitFieldRef;\n+import org.elasticsearch.xpack.eql.session.Configuration;\n+import org.elasticsearch.xpack.ql.execution.search.FieldExtraction;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.ComputingExtractor;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.HitExtractorInput;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.ReferenceInput;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class RuntimeUtils {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 34}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d3e2671d9f17d9fd393e22e56c3a98883b091ffc", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3e2671d9f17d9fd393e22e56c3a98883b091ffc", "committedDate": "2020-05-12T12:50:16Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/seqence-pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA5OTkzODU1", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-409993855", "createdAt": "2020-05-12T12:34:40Z", "commit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMjozNDo0MVrOGUEYgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxMzoxMzo0NlrOGUF7dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5NjUxNA==", "bodyText": "This method exists in the same form in SQL's Querier. Can you extract it from both places in a common location in QL?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423696514", "createdAt": "2020-05-12T12:34:41Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/listener/RuntimeUtils.java", "diffHunk": "@@ -0,0 +1,105 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.listener;\n+\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.search.aggregations.Aggregation;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.FieldHitExtractor;\n+import org.elasticsearch.xpack.eql.querydsl.container.ComputedRef;\n+import org.elasticsearch.xpack.eql.querydsl.container.SearchHitFieldRef;\n+import org.elasticsearch.xpack.eql.session.Configuration;\n+import org.elasticsearch.xpack.ql.execution.search.FieldExtraction;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.ComputingExtractor;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.HitExtractorInput;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.Pipe;\n+import org.elasticsearch.xpack.ql.expression.gen.pipeline.ReferenceInput;\n+import org.elasticsearch.xpack.ql.index.IndexResolver;\n+\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.LinkedHashSet;\n+import java.util.List;\n+import java.util.Set;\n+\n+public class RuntimeUtils {\n+\n+    private RuntimeUtils() {}\n+\n+    static void logSearchResponse(SearchResponse response, Logger logger) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzY5ODM2Mg==", "bodyText": "You don't seem to do anything with keepAlive. I assume it will be added later?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423698362", "createdAt": "2020-05-12T12:37:42Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/ExecutionManager.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.assembler;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.tasks.TaskCancelledException;\n+import org.elasticsearch.xpack.eql.EqlIllegalArgumentException;\n+import org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils;\n+import org.elasticsearch.xpack.eql.execution.payload.Payload;\n+import org.elasticsearch.xpack.eql.execution.payload.SearchResponsePayload;\n+import org.elasticsearch.xpack.eql.execution.search.SourceGenerator;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.FieldHitExtractor;\n+import org.elasticsearch.xpack.eql.execution.search.extractor.TimestampFieldHitExtractor;\n+import org.elasticsearch.xpack.eql.plan.physical.EsQueryExec;\n+import org.elasticsearch.xpack.eql.plan.physical.PhysicalPlan;\n+import org.elasticsearch.xpack.eql.plan.physical.SequenceExec;\n+import org.elasticsearch.xpack.eql.querydsl.container.FieldExtractorRegistry;\n+import org.elasticsearch.xpack.eql.querydsl.container.QueryContainer;\n+import org.elasticsearch.xpack.eql.session.Configuration;\n+import org.elasticsearch.xpack.eql.session.EqlSession;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+import org.elasticsearch.xpack.ql.expression.Attribute;\n+import org.elasticsearch.xpack.ql.expression.Expression;\n+import org.elasticsearch.xpack.ql.util.Check;\n+import org.elasticsearch.xpack.ql.util.StringUtils;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.eql.execution.listener.RuntimeUtils.prepareRequest;\n+\n+public class ExecutionManager implements QueryClient {\n+\n+    private static final Logger log = LogManager.getLogger(ExecutionManager.class);\n+\n+    private final Configuration cfg;\n+    private final Client client;\n+    private final TimeValue keepAlive;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcwMTI2NQ==", "bodyText": "Newline?", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423701265", "createdAt": "2020-05-12T12:42:25Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceStateMachine.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.search.SearchHit;\n+\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+/**\n+ * State machine that holds and manages all in-flight sequences.\n+ */\n+public class SequenceStateMachine {\n+\n+    /** Current sequences for each key */\n+    /** Note will be multiple sequences for the same key and the same stage with different timestamps */\n+    private final KeyToSequences keyToSequences;\n+    /** Current keys on each stage */\n+    private final StageToKeys stageToKeys;\n+\n+    /** minimum timestamp per stage */\n+    /** this ignores the key */\n+    private final long[] timestampMarkers;\n+\n+    private final int completionStage;\n+\n+    /** list of completed sequences - separate to avoid polluting the other stages */\n+    private final List<Sequence> completed;\n+\n+    public SequenceStateMachine(int stages) {\n+        this.completionStage = stages - 1;\n+        this.stageToKeys = new StageToKeys(completionStage);\n+        this.keyToSequences = new KeyToSequences(completionStage);\n+        this.timestampMarkers = new long[completionStage];\n+        this.completed = new LinkedList<>();\n+    }\n+\n+    public List<Sequence> completeSequences() {\n+        return completed;\n+    }\n+\n+    public long getTimestampMarker(int stage) {\n+        return timestampMarkers[stage];\n+    }\n+\n+    public void setTimestampMarker(int stage, long timestamp) {\n+        timestampMarkers[stage] = timestamp;\n+    }\n+\n+    public void trackSequence(Sequence sequence, long tMin, long tMax) {\n+        SequenceKey key = sequence.key();\n+\n+        stageToKeys.keys(0).add(key);\n+        SequenceFrame frame = keyToSequences.frame(0, key);\n+        frame.setTimeFrame(tMin, tMax);\n+        frame.add(sequence);\n+    }\n+\n+    /** Match the given hit (based on key and timestamp) with any potential sequence from the previous", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e6386bf32c49c1b2a68b81672b6250abe8fc7807"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzcyMTg0Nw==", "bodyText": "This sounds like an incomplete sentence.", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r423721847", "createdAt": "2020-05-12T13:13:46Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceFrame.java", "diffHunk": "@@ -0,0 +1,108 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.sequence;\n+\n+import org.elasticsearch.common.collect.Tuple;\n+\n+import java.util.LinkedList;\n+import java.util.List;\n+\n+import static org.elasticsearch.common.logging.LoggerMessageFormat.format;\n+\n+/** List of sequences (typically in a stage) used for finding continuous events within a time-frame */\n+public class SequenceFrame {\n+\n+    // NB: since the size varies significantly, use a LinkedList\n+    // Considering the order it might make sense to use a B-Tree+ for faster lookups which should work well with\n+    // timestamp compression (which is known for the group", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d3e2671d9f17d9fd393e22e56c3a98883b091ffc"}, "originalPosition": 21}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45250f8cdaa0d7341f0b1ef2dc5f6301940244a3", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/45250f8cdaa0d7341f0b1ef2dc5f6301940244a3", "committedDate": "2020-05-12T20:10:24Z", "message": "Addressing the next round of feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71", "committedDate": "2020-05-12T20:11:25Z", "message": "Merge remote-tracking branch 'remotes/upstream/master' into eql/seqence-pr"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNTI2NjI2", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-410526626", "createdAt": "2020-05-13T01:24:13Z", "commit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMToyNDoxM1rOGUeVdw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xM1QwMTozODozNlrOGUejTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyMTcxOQ==", "bodyText": "this is an odd formatting for if else if .... seems like the same line is more common in the current code", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r424121719", "createdAt": "2020-05-13T01:24:13Z", "author": {"login": "aleksmaus"}, "path": "x-pack/plugin/eql/qa/common/src/main/java/org/elasticsearch/test/eql/CommonEqlActionTestCase.java", "diffHunk": "@@ -165,9 +179,29 @@ public CommonEqlActionTestCase(int num, String name, EqlSpec spec) {\n     }\n \n     public void test() throws Exception {\n-        EqlSearchRequest request = new EqlSearchRequest(testIndexName, spec.query());\n-        EqlSearchResponse response = highLevelClient().eql().search(request, RequestOptions.DEFAULT);\n-        assertSpec(response.hits().events());\n+        assertResponse(runQuery(testIndexName, spec.query()));\n+    }\n+\n+    protected void assertResponse(EqlSearchResponse response) {\n+        Hits hits = response.hits();\n+        if (hits.events() != null) {\n+            assertSearchHits(hits.events());\n+        }\n+        else if (hits.sequences() != null) {\n+            assertSequences(hits.sequences());\n+        }\n+        else {\n+            fail(\"No events or sequences found\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71"}, "originalPosition": 103}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDEyNTI2MQ==", "bodyText": "nit: slightly shorter\n        SequenceKey key = SequenceKey.NONE;\n        if (!criterion.keyExtractors().isEmpty()) {\n            Object[] docKeys = new Object[keyExtractors.size()];\n            for (int i = 0; i < docKeys.length; i++) {\n                docKeys[i] = keyExtractors.get(i).extract(hit);\n            }\n            key = new SequenceKey(docKeys);\n        }", "url": "https://github.com/elastic/elasticsearch/pull/56300#discussion_r424125261", "createdAt": "2020-05-13T01:38:36Z", "author": {"login": "aleksmaus"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/SequenceRuntime.java", "diffHunk": "@@ -0,0 +1,139 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.eql.execution.assembler;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.xpack.eql.execution.payload.Payload;\n+import org.elasticsearch.xpack.eql.execution.sequence.Sequence;\n+import org.elasticsearch.xpack.eql.execution.sequence.SequenceKey;\n+import org.elasticsearch.xpack.eql.execution.sequence.SequenceStateMachine;\n+import org.elasticsearch.xpack.eql.session.Results;\n+import org.elasticsearch.xpack.ql.execution.search.extractor.HitExtractor;\n+\n+import java.util.ArrayList;\n+import java.util.List;\n+\n+import static org.elasticsearch.action.ActionListener.wrap;\n+\n+/**\n+ * Executable tracking sequences at runtime.\n+ */\n+class SequenceRuntime implements Executable {\n+\n+    private final List<Criterion> criteria;\n+    // NB: just like in a list, this represents the total number of stages yet counting starts at 0\n+    private final int numberOfStages;\n+    private final SequenceStateMachine stateMachine;\n+    private final QueryClient queryClient;\n+    private long startTime;\n+\n+    SequenceRuntime(List<Criterion> criteria, QueryClient queryClient) {\n+        this.criteria = criteria;\n+        this.numberOfStages = criteria.size();\n+        this.stateMachine = new SequenceStateMachine(numberOfStages);\n+        this.queryClient = queryClient;\n+    }\n+\n+    @Override\n+    public void execute(ActionListener<Results> resultsListener) {\n+        startTime = System.currentTimeMillis();\n+        startSequencing(resultsListener);\n+    }\n+\n+    private void startSequencing(ActionListener<Results> resultsListener) {\n+        Criterion firstStage = criteria.get(0);\n+        queryClient.query(firstStage.searchSource(), wrap(payload -> {\n+\n+            // 1. execute last stage (find keys)\n+            startTracking(payload);\n+\n+            // 2. go descending through the rest of the stages, while adjusting the query\n+            inspectStage(1, resultsListener);\n+\n+        }, resultsListener::onFailure));\n+    }\n+\n+    private void startTracking(Payload<SearchHit> payload) {\n+        Criterion lastCriterion = criteria.get(0);\n+        List<SearchHit> hits = payload.values();\n+\n+        long tMin = Long.MAX_VALUE;\n+        long tMax = Long.MIN_VALUE;\n+        // we could have extracted that in the hit loop but that if would have been evaluated\n+        // for every document\n+        if (hits.isEmpty() == false) {\n+            tMin = (Long) lastCriterion.timestampExtractor().extract(hits.get(0));\n+            tMax = (Long) lastCriterion.timestampExtractor().extract(hits.get(hits.size() - 1));\n+        }\n+\n+        for (SearchHit hit : hits) {\n+            KeyWithTime keyAndTime = findKey(hit, lastCriterion);\n+            Sequence seq = new Sequence(keyAndTime.key, numberOfStages, keyAndTime.timestamp, hit);\n+            stateMachine.trackSequence(seq, tMin, tMax);\n+        }\n+        // TB: change\n+        stateMachine.setTimestampMarker(0, tMin);\n+    }\n+\n+    private void inspectStage(int stage, ActionListener<Results> resultsListener) {\n+        // sequencing is done, return results\n+        if (stage == numberOfStages) {\n+            resultsListener.onResponse(assembleResults());\n+            return;\n+        }\n+        // else continue finding matches\n+        Criterion currentCriterion = criteria.get(stage);\n+        // narrow by the previous stage timestamp marker\n+        currentCriterion.fromTimestamp(stateMachine.getTimestampMarker(stage - 1));\n+        \n+        queryClient.query(currentCriterion.searchSource(), wrap(payload -> {\n+            findMatches(stage, payload);\n+            inspectStage(stage + 1, resultsListener);\n+        }, resultsListener::onFailure));\n+    }\n+\n+    private void findMatches(int currentStage, Payload<SearchHit> payload) {\n+        Criterion currentCriterion = criteria.get(currentStage);\n+        List<SearchHit> hits = payload.values();\n+        \n+        // break the results per key\n+        for (SearchHit hit : hits) {\n+            KeyWithTime kt = findKey(hit, currentCriterion);\n+            stateMachine.match(currentStage, kt.key, kt.timestamp, hit);\n+        }\n+    }\n+\n+    private KeyWithTime findKey(SearchHit hit, Criterion criterion) {\n+        List<HitExtractor> keyExtractors = criterion.keyExtractors();\n+\n+        SequenceKey key;\n+        if (criterion.keyExtractors().isEmpty()) {\n+            key = SequenceKey.NONE;\n+        } else {\n+            Object[] docKeys = new Object[keyExtractors.size()];\n+            for (int i = 0; i < docKeys.length; i++) {\n+                docKeys[i] = keyExtractors.get(i).extract(hit);\n+            }\n+            key = new SequenceKey(docKeys);\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71"}, "originalPosition": 124}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwNzk5Mzcy", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-410799372", "createdAt": "2020-05-13T10:38:07Z", "commit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwODQ1MTE2", "url": "https://github.com/elastic/elasticsearch/pull/56300#pullrequestreview-410845116", "createdAt": "2020-05-13T11:50:11Z", "commit": {"oid": "f58a5a84e395ea4f96c9767aa0f0230f7b6b4c71"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 315, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}