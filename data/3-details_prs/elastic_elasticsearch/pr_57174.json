{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNDAwODA0", "number": 57174, "title": "[6.8] Fix delete_expired_data/nightly maintenance when many model snapshots need deleting ", "bodyText": "The queries performed by the expired data removers pull back entire documents where only a few fields are required. For ModelSnapshots in particular this is a problem as they contain quantiles which may be 100s of KB and the search size is set to 10,000.\nIf the user is suffering with many accumulated snapshots that were not cleaned up due to #47103 the size of this search response could be very large. This change makes the search more efficient by only requesting the fields needed to work out which expired data should be deleted.\nBackport of #57041", "createdAt": "2020-05-26T19:12:36Z", "url": "https://github.com/elastic/elasticsearch/pull/57174", "merged": true, "mergeCommit": {"oid": "f371e66c2c488e6c94fea8b44b032e3d5706fe79"}, "closed": true, "closedAt": "2020-05-27T11:30:50Z", "author": {"login": "davidkyle"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclJiwFgH2gAyNDIzNDAwODA0OmI2NjA4ZmNhMGQxNTZjMzFjYTA2ODlhY2MxN2M0NjAwMzJlMjE3MjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclWiboAFqTQxOTA1MjQyMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b6608fca0d156c31ca0689acc17c460032e21725", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6608fca0d156c31ca0689acc17c460032e21725", "committedDate": "2020-05-26T19:08:23Z", "message": "Only request required fields in expired data removers"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTU0NzA5", "url": "https://github.com/elastic/elasticsearch/pull/57174#pullrequestreview-418954709", "createdAt": "2020-05-27T08:10:54Z", "commit": {"oid": "b6608fca0d156c31ca0689acc17c460032e21725"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoxMDo1NVrOGa-KdA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoxMDo1NVrOGa-KdA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNDY0NA==", "bodyText": "The logic here is different to the later branches as it doesn't have the new model snapshot retention options added in #56125", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430934644", "createdAt": "2020-05-27T08:10:55Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemover.java", "diffHunk": "@@ -99,11 +106,18 @@ protected void removeDataBefore(Job job, long cutoffEpochMs, ActionListener<Bool\n             @Override\n             public void onResponse(SearchResponse searchResponse) {\n                 try {\n-                    List<ModelSnapshot> modelSnapshots = new ArrayList<>();\n+                    List<JobSnapshotId> snapshotIds = new ArrayList<>();\n                     for (SearchHit hit : searchResponse.getHits()) {\n-                        modelSnapshots.add(ModelSnapshot.fromJson(hit.getSourceRef()));\n+                        JobSnapshotId idPair = new JobSnapshotId(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6608fca0d156c31ca0689acc17c460032e21725"}, "originalPosition": 24}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTU2MzQw", "url": "https://github.com/elastic/elasticsearch/pull/57174#pullrequestreview-418956340", "createdAt": "2020-05-27T08:13:06Z", "commit": {"oid": "b6608fca0d156c31ca0689acc17c460032e21725"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoxMzowN1rOGa-PQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwODoxMzowN1rOGa-PQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDkzNTg3NA==", "bodyText": "In 6.8 the doc value could be a Long rather than a String.  It's why TimeField has this case: \n  \n    \n      elasticsearch/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/extractor/TimeField.java\n    \n    \n         Line 49\n      in\n      cde2026\n    \n    \n    \n    \n\n        \n          \n           } else if (value[0] instanceof Long == false) { // pre-6.0 field \n        \n    \n  \n\n\nWhat this means in practice is that a user running 6.8 who first used ML in 5.x will end up seeing the warning on lines 139-140 repeatedly and won't get any cleanup.\nIt's still OK to use stringFieldValueOrNull() to extract fields mapped as keyword or text from hits, but for fields mapped as date in 6.8 the code needs to handle both Long and String.", "url": "https://github.com/elastic/elasticsearch/pull/57174#discussion_r430935874", "createdAt": "2020-05-27T08:13:07Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredForecastsRemover.java", "diffHunk": "@@ -129,39 +125,49 @@ public void onFailure(Exception e) {\n         });\n     }\n \n-    private List<ForecastRequestStats> findForecastsToDelete(SearchResponse searchResponse) throws IOException {\n-        List<ForecastRequestStats> forecastsToDelete = new ArrayList<>();\n+    private List<JobForecastId> findForecastsToDelete(SearchResponse searchResponse) {\n+        List<JobForecastId> forecastsToDelete = new ArrayList<>();\n \n         SearchHits hits = searchResponse.getHits();\n         if (hits.getTotalHits() > MAX_FORECASTS) {\n             LOGGER.info(\"More than [{}] forecasts were found. This run will only delete [{}] of them\", MAX_FORECASTS, MAX_FORECASTS);\n         }\n \n         for (SearchHit hit : hits.getHits()) {\n-            try (InputStream stream = hit.getSourceRef().streamInput();\n-                 XContentParser parser = XContentFactory.xContent(XContentType.JSON).createParser(\n-                         NamedXContentRegistry.EMPTY, LoggingDeprecationHandler.INSTANCE, stream)) {\n-                ForecastRequestStats forecastRequestStats = ForecastRequestStats.LENIENT_PARSER.apply(parser, null);\n-                if (forecastRequestStats.getExpiryTime().toEpochMilli() < cutoffEpochMs) {\n-                    forecastsToDelete.add(forecastRequestStats);\n+            String expiryTime = stringFieldValueOrNull(hit, ForecastRequestStats.EXPIRY_TIME.getPreferredName());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6608fca0d156c31ca0689acc17c460032e21725"}, "originalPosition": 73}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19efa8cbcdf9a945b179b15b2241ccec997e23a7", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/19efa8cbcdf9a945b179b15b2241ccec997e23a7", "committedDate": "2020-05-27T09:16:52Z", "message": "Revert TimeUtils"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8a32d639a106c31ff0fb37dbe05131163eecbd44", "author": {"user": {"login": "davidkyle", "name": "David Kyle"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a32d639a106c31ff0fb37dbe05131163eecbd44", "committedDate": "2020-05-27T09:48:55Z", "message": "Parse date as long or string"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDUyNDIx", "url": "https://github.com/elastic/elasticsearch/pull/57174#pullrequestreview-419052421", "createdAt": "2020-05-27T10:16:48Z", "commit": {"oid": "8a32d639a106c31ff0fb37dbe05131163eecbd44"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4202, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}