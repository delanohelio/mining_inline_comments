{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMyNTM3NTE5", "number": 57936, "reviewThreads": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0NToxN1rOETa5fA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjozMTowMlrOEUx1bw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4Nzk5MTAwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/IndicesService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0NToxN1rOG5Jfiw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo0NToxN1rOG5Jfiw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU3NzU0Nw==", "bodyText": "This variable is currently unused, possibly left over from a previous revision?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r462577547", "createdAt": "2020-07-29T20:45:17Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesService.java", "diffHunk": "@@ -231,8 +231,8 @@\n     private final EsThreadPoolExecutor danglingIndicesThreadPoolExecutor;\n     private final Set<Index> danglingIndicesToWrite = Sets.newConcurrentHashSet();\n     private final boolean nodeWriteDanglingIndicesInfo;\n-    private ValuesSourceRegistry valuesSourceRegistry;\n-\n+    private final ValuesSourceRegistry valuesSourceRegistry;\n+    private final SystemIndices systemIndices;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODA0MDA2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMDo1OToyNlrOG5J9Ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODozNDoxOFrOG5vF5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4NTE3OQ==", "bodyText": "Isn't it possible to check the metadata to retrieve this information through the already provided IndexSettings ?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r462585179", "createdAt": "2020-07-29T20:59:26Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "diffHunk": "@@ -296,7 +297,8 @@ public IndexShard(\n             final List<IndexingOperationListener> listeners,\n             final Runnable globalCheckpointSyncer,\n             final RetentionLeaseSyncer retentionLeaseSyncer,\n-            final CircuitBreakerService circuitBreakerService) throws IOException {\n+            final CircuitBreakerService circuitBreakerService,\n+            final boolean isSystem) throws IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE5MzU3Mw==", "bodyText": "Yes it is; I missed that metadata was available. Addressed in cffb69d", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463193573", "createdAt": "2020-07-30T18:34:18Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "diffHunk": "@@ -296,7 +297,8 @@ public IndexShard(\n             final List<IndexingOperationListener> listeners,\n             final Runnable globalCheckpointSyncer,\n             final RetentionLeaseSyncer retentionLeaseSyncer,\n-            final CircuitBreakerService circuitBreakerService) throws IOException {\n+            final CircuitBreakerService circuitBreakerService,\n+            final boolean isSystem) throws IOException {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4NTE3OQ=="}, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODA0ODAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMTowMTo0OVrOG5KCXQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODozMDo0MlrOG5u-yg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4NjQ2MQ==", "bodyText": "Since search should be fast on these indices I wonder if a queue size of 1000 is not enough ?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r462586461", "createdAt": "2020-07-29T21:01:49Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -180,6 +182,7 @@ public ThreadPool(final Settings settings, final ExecutorBuilder<?>... customBui\n         builders.put(Names.FORCE_MERGE, new FixedExecutorBuilder(settings, Names.FORCE_MERGE, 1, -1, false));\n         builders.put(Names.FETCH_SHARD_STORE,\n                 new ScalingExecutorBuilder(Names.FETCH_SHARD_STORE, 1, 2 * allocatedProcessors, TimeValue.timeValueMinutes(5)));\n+        builders.put(Names.SYSTEM_READ, new FixedExecutorBuilder(settings, Names.SYSTEM_READ, halfProcMaxAt5, 2000, false));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4NzQ4Mw==", "bodyText": "I combined the queue size for get and search here since we share the threadpool for both types of operations", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463187483", "createdAt": "2020-07-30T18:23:05Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -180,6 +182,7 @@ public ThreadPool(final Settings settings, final ExecutorBuilder<?>... customBui\n         builders.put(Names.FORCE_MERGE, new FixedExecutorBuilder(settings, Names.FORCE_MERGE, 1, -1, false));\n         builders.put(Names.FETCH_SHARD_STORE,\n                 new ScalingExecutorBuilder(Names.FETCH_SHARD_STORE, 1, 2 * allocatedProcessors, TimeValue.timeValueMinutes(5)));\n+        builders.put(Names.SYSTEM_READ, new FixedExecutorBuilder(settings, Names.SYSTEM_READ, halfProcMaxAt5, 2000, false));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4NjQ2MQ=="}, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE5MTc1NA==", "bodyText": "ok thanks for explaining. The query and get request are lightweight so 2000 should be ok.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463191754", "createdAt": "2020-07-30T18:30:42Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -180,6 +182,7 @@ public ThreadPool(final Settings settings, final ExecutorBuilder<?>... customBui\n         builders.put(Names.FORCE_MERGE, new FixedExecutorBuilder(settings, Names.FORCE_MERGE, 1, -1, false));\n         builders.put(Names.FETCH_SHARD_STORE,\n                 new ScalingExecutorBuilder(Names.FETCH_SHARD_STORE, 1, 2 * allocatedProcessors, TimeValue.timeValueMinutes(5)));\n+        builders.put(Names.SYSTEM_READ, new FixedExecutorBuilder(settings, Names.SYSTEM_READ, halfProcMaxAt5, 2000, false));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4NjQ2MQ=="}, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 22}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg4ODA1OTQ2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOVQyMTowNTowOFrOG5KJag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxODozMTowNlrOG5u_nA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4ODI2Ng==", "bodyText": "nit: I like SEARCH_SYSTEM better but that's just a preference...", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r462588266", "createdAt": "2020-07-29T21:05:08Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -82,6 +82,7 @@\n         public static final String FORCE_MERGE = \"force_merge\";\n         public static final String FETCH_SHARD_STARTED = \"fetch_shard_started\";\n         public static final String FETCH_SHARD_STORE = \"fetch_shard_store\";\n+        public static final String SYSTEM_READ = \"system_read\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE4NzgyOQ==", "bodyText": "Do you still like that since this also affects both search and get operations?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463187829", "createdAt": "2020-07-30T18:23:39Z", "author": {"login": "jaymode"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -82,6 +82,7 @@\n         public static final String FORCE_MERGE = \"force_merge\";\n         public static final String FETCH_SHARD_STARTED = \"fetch_shard_started\";\n         public static final String FETCH_SHARD_STORE = \"fetch_shard_store\";\n+        public static final String SYSTEM_READ = \"system_read\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4ODI2Ng=="}, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzE5MTk2NA==", "bodyText": "Right, SYSTEM_READ sounds good then, thanks", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463191964", "createdAt": "2020-07-30T18:31:06Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/threadpool/ThreadPool.java", "diffHunk": "@@ -82,6 +82,7 @@\n         public static final String FORCE_MERGE = \"force_merge\";\n         public static final String FETCH_SHARD_STARTED = \"fetch_shard_started\";\n         public static final String FETCH_SHARD_STORE = \"fetch_shard_store\";\n+        public static final String SYSTEM_READ = \"system_read\";", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MjU4ODI2Ng=="}, "originalCommit": {"oid": "e14bb7e097abed042cb4732cffaaccb66db67922"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjYxOTc5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowOTozOFrOG51jMA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjowOTozOFrOG51jMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzI5OTM3Ng==", "bodyText": "I've found that using a constant (e.g. SYSTEM_INDEX_FLAG_ADDED=V_8_0_0) makes serialization logic easier to follow when reading, and also easier to change on a backport. Especially so when that version is used in several streaming methods, as is the case here.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463299376", "createdAt": "2020-07-30T22:09:38Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexMetadata.java", "diffHunk": "@@ -761,6 +770,11 @@ public XContentBuilder toXContent(XContentBuilder builder, Params params) throws\n                 DiffableUtils.StringSetValueSerializer.getInstance());\n             rolloverInfos = DiffableUtils.readImmutableOpenMapDiff(in, DiffableUtils.getStringKeySerializer(), RolloverInfo::new,\n                 RolloverInfo::readDiffFrom);\n+            if (in.getVersion().onOrAfter(Version.V_8_0_0)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjYzMDQ0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexMetadata.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxMzo1M1rOG51pUg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxMzo1M1rOG51pUg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwMDk0Ng==", "bodyText": "Nit: Could we make this a constant, like the other field keys here?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463300946", "createdAt": "2020-07-30T22:13:53Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexMetadata.java", "diffHunk": "@@ -1337,6 +1378,7 @@ public static void toXContent(IndexMetadata indexMetadata, XContentBuilder build\n                 cursor.value.toXContent(builder, params);\n             }\n             builder.endObject();\n+            builder.field(\"system\", indexMetadata.isSystem);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 168}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY0MzUxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxODo1MlrOG51wwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoxODo1MlrOG51wwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwMjg0OQ==", "bodyText": "It looks like this version of this method is just used in a single test, so I think we should delete this version of this method and just add the extra false to the call in testBuildIndexMetadata()", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463302849", "createdAt": "2020-07-30T22:18:52Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -773,7 +777,14 @@ static ClusterState clusterStateCreateIndex(ClusterState currentState, Set<Clust\n     static IndexMetadata buildIndexMetadata(String indexName, List<AliasMetadata> aliases,\n                                             Supplier<DocumentMapper> documentMapperSupplier, Settings indexSettings, int routingNumShards,\n                                             @Nullable IndexMetadata sourceMetadata) {\n+        return buildIndexMetadata(indexName, aliases, documentMapperSupplier, indexSettings, routingNumShards, sourceMetadata, false);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 98}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY2MTAyOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyNTo0NVrOG517IQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyNTo0NVrOG517IQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwNTUwNQ==", "bodyText": "Could we add some Javadoc here? I like to have at least a summary on new classes. Something like:\nThis class contains the {@link SystemIndexDescriptor}s from loaded {@link SystemIndexPlugin}s, and is responsible for determining which descriptors match a given index name.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463305505", "createdAt": "2020-07-30T22:25:45Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.indices;\n+\n+import org.apache.lucene.util.automaton.Automata;\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.MinimizationOperations;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.index.Index;\n+\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static java.util.stream.Collectors.toUnmodifiableList;\n+\n+public class SystemIndices {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY2Mjk0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyNjo0NFrOG518Tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyNjo0NFrOG518Tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwNTgwNw==", "bodyText": "Javadoc:\nDetermines whether a given index is a system index by comparing its name to the collection of loaded SystemIndexDescriptors.\n\nI think this one is good to call out, as most other places this is determined do it by inspecting a property of the index.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463305807", "createdAt": "2020-07-30T22:26:44Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.indices;\n+\n+import org.apache.lucene.util.automaton.Automata;\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.MinimizationOperations;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.index.Index;\n+\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static java.util.stream.Collectors.toUnmodifiableList;\n+\n+public class SystemIndices {\n+\n+    private final CharacterRunAutomaton runAutomaton;\n+    private final Collection<SystemIndexDescriptor> systemIndexDescriptors;\n+\n+    public SystemIndices(Map<String, Collection<SystemIndexDescriptor>> systemIndexDescriptorMap) {\n+        this.systemIndexDescriptors = systemIndexDescriptorMap.values()\n+            .stream()\n+            .flatMap(Collection::stream)\n+            .collect(Collectors.toUnmodifiableList());\n+        this.runAutomaton = buildCharacterRunAutomaton(systemIndexDescriptors);\n+    }\n+\n+    public boolean isSystemIndex(Index index) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 53}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY3MDA0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyOTozMVrOG52AYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjoyOTozMVrOG52AYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwNjg1MQ==", "bodyText": "Do you think it might be worth moving the logic (currently in MetadataCreateIndexService) that verifies 0-1 matching descriptors here?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463306851", "createdAt": "2020-07-30T22:29:31Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/indices/SystemIndices.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.indices;\n+\n+import org.apache.lucene.util.automaton.Automata;\n+import org.apache.lucene.util.automaton.Automaton;\n+import org.apache.lucene.util.automaton.CharacterRunAutomaton;\n+import org.apache.lucene.util.automaton.MinimizationOperations;\n+import org.apache.lucene.util.automaton.Operations;\n+import org.elasticsearch.common.collect.Tuple;\n+import org.elasticsearch.common.regex.Regex;\n+import org.elasticsearch.index.Index;\n+\n+import java.util.Collection;\n+import java.util.Comparator;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.stream.Collectors;\n+\n+import static java.util.stream.Collectors.toUnmodifiableList;\n+\n+public class SystemIndices {\n+\n+    private final CharacterRunAutomaton runAutomaton;\n+    private final Collection<SystemIndexDescriptor> systemIndexDescriptors;\n+\n+    public SystemIndices(Map<String, Collection<SystemIndexDescriptor>> systemIndexDescriptorMap) {\n+        this.systemIndexDescriptors = systemIndexDescriptorMap.values()\n+            .stream()\n+            .flatMap(Collection::stream)\n+            .collect(Collectors.toUnmodifiableList());\n+        this.runAutomaton = buildCharacterRunAutomaton(systemIndexDescriptors);\n+    }\n+\n+    public boolean isSystemIndex(Index index) {\n+        return runAutomaton.run(index.getName());\n+    }\n+\n+    public Collection<SystemIndexDescriptor> findMatchingDescriptors(String name) {\n+        return systemIndexDescriptors.stream()\n+            .filter(descriptor -> descriptor.matchesIndexPattern(name))\n+            .collect(toUnmodifiableList());\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 61}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjg5MjY4MTI3OnYy", "diffSide": "LEFT", "path": "server/src/main/java/org/elasticsearch/node/Node.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozMjo0N1rOG52Hag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQyMjozMjo0N1rOG52Hag==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzMwODY1MA==", "bodyText": "This call to checkForOverlappingPatterns got dropped in the change - did you mean to move it into the SystemIndices constructor?", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r463308650", "createdAt": "2020-07-30T22:32:47Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/node/Node.java", "diffHunk": "@@ -467,18 +468,13 @@ protected Node(final Environment initialEnvironment,\n                 .collect(Collectors.toUnmodifiableMap(\n                     plugin -> plugin.getClass().getSimpleName(),\n                     plugin -> plugin.getSystemIndexDescriptors(settings)));\n-            SystemIndexDescriptor.checkForOverlappingPatterns(systemIndexDescriptorMap);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cffb69de2b255e28d4ce3953765fb28a8c2b7edd"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjkwMjIzNDcxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjozMTowMlrOG7KyYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjozNzo1MVrOG7K7Ew==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5NTkwNQ==", "bodyText": "This if/else, as currently written, will cause hidden indices to be marked as system indices. When a hidden index is created, matchingDescriptor is null and isHidden is true, which does not match the if clause, and so falls triggers the else, which marks the index as a system index.\nChanging this to the following fixes the issue:\n        if (index.charAt(0) == '.') {\n            SystemIndexDescriptor matchingDescriptor = systemIndices.findMatchingDescriptor(index);\n            if (matchingDescriptor != null) {\n                logger.trace(\"index [{}] is a system index because it matches index pattern [{}] with description [{}]\",\n                    index, matchingDescriptor.getIndexPattern(), matchingDescriptor.getDescription());\n                isSystem = true;\n            } else if (isHidden) {\n                logger.trace(\"index [{}] is a hidden index\", index);\n            } else {\n                deprecationLogger.deprecate(\"index_name_starts_with_dot\",\n                    \"index name [{}] starts with a dot '.', in the next major version, index names \" +\n                        \"starting with a dot are reserved for hidden indices and system indices\", index);\n            }\n        }\nAdding asserts to check the boolean returned by this method in testValidateDotIndex catches the issue as well.\nIt might be a good idea to throw an exception or at least emit a warning if (isHidden && isSystem) as well.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r464695905", "createdAt": "2020-08-03T22:31:02Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -180,32 +180,21 @@ public void validateIndexName(String index, ClusterState state) {\n     /**\n      * Validates (if this index has a dot-prefixed name) whether it follows the rules for dot-prefixed indices.\n      * @param index The name of the index in question\n-     * @param state The current cluster state\n      * @param isHidden Whether or not this is a hidden index\n      */\n-    public void validateDotIndex(String index, ClusterState state, @Nullable Boolean isHidden) {\n+    public boolean validateDotIndex(String index, @Nullable Boolean isHidden) {\n+        boolean isSystem = false;\n         if (index.charAt(0) == '.') {\n-            List<SystemIndexDescriptor> matchingDescriptors = systemIndexDescriptors.stream()\n-                .filter(descriptor -> descriptor.matchesIndexPattern(index))\n-                .collect(toList());\n-            if (matchingDescriptors.isEmpty() && (isHidden == null || isHidden == Boolean.FALSE)) {\n+            SystemIndexDescriptor matchingDescriptor = systemIndices.findMatchingDescriptor(index);\n+            if (matchingDescriptor == null && (isHidden == null || isHidden == Boolean.FALSE)) {\n                 deprecationLogger.deprecate(\"index_name_starts_with_dot\",\n                     \"index name [{}] starts with a dot '.', in the next major version, index names \" +\n                     \"starting with a dot are reserved for hidden indices and system indices\", index);\n-            } else if (matchingDescriptors.size() > 1) {\n-                // This should be prevented by erroring on overlapping patterns at startup time, but is here just in case.\n-                StringBuilder errorMessage = new StringBuilder()\n-                    .append(\"index name [\")\n-                    .append(index)\n-                    .append(\"] is claimed as a system index by multiple system index patterns: [\")\n-                    .append(matchingDescriptors.stream()\n-                        .map(descriptor -> \"pattern: [\" + descriptor.getIndexPattern() +\n-                            \"], description: [\" + descriptor.getDescription() + \"]\").collect(Collectors.joining(\"; \")));\n-                // Throw AssertionError if assertions are enabled, or a regular exception otherwise:\n-                assert false : errorMessage.toString();\n-                throw new IllegalStateException(errorMessage.toString());\n+            } else {\n+                isSystem = true;\n             }\n         }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d882e45a29b1471e32556ac5121e4f3638e660dc"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5ODEzMQ==", "bodyText": "Here is a commit with the fix + test adjustments if you want to cherry-pick that.", "url": "https://github.com/elastic/elasticsearch/pull/57936#discussion_r464698131", "createdAt": "2020-08-03T22:37:51Z", "author": {"login": "gwbrown"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -180,32 +180,21 @@ public void validateIndexName(String index, ClusterState state) {\n     /**\n      * Validates (if this index has a dot-prefixed name) whether it follows the rules for dot-prefixed indices.\n      * @param index The name of the index in question\n-     * @param state The current cluster state\n      * @param isHidden Whether or not this is a hidden index\n      */\n-    public void validateDotIndex(String index, ClusterState state, @Nullable Boolean isHidden) {\n+    public boolean validateDotIndex(String index, @Nullable Boolean isHidden) {\n+        boolean isSystem = false;\n         if (index.charAt(0) == '.') {\n-            List<SystemIndexDescriptor> matchingDescriptors = systemIndexDescriptors.stream()\n-                .filter(descriptor -> descriptor.matchesIndexPattern(index))\n-                .collect(toList());\n-            if (matchingDescriptors.isEmpty() && (isHidden == null || isHidden == Boolean.FALSE)) {\n+            SystemIndexDescriptor matchingDescriptor = systemIndices.findMatchingDescriptor(index);\n+            if (matchingDescriptor == null && (isHidden == null || isHidden == Boolean.FALSE)) {\n                 deprecationLogger.deprecate(\"index_name_starts_with_dot\",\n                     \"index name [{}] starts with a dot '.', in the next major version, index names \" +\n                     \"starting with a dot are reserved for hidden indices and system indices\", index);\n-            } else if (matchingDescriptors.size() > 1) {\n-                // This should be prevented by erroring on overlapping patterns at startup time, but is here just in case.\n-                StringBuilder errorMessage = new StringBuilder()\n-                    .append(\"index name [\")\n-                    .append(index)\n-                    .append(\"] is claimed as a system index by multiple system index patterns: [\")\n-                    .append(matchingDescriptors.stream()\n-                        .map(descriptor -> \"pattern: [\" + descriptor.getIndexPattern() +\n-                            \"], description: [\" + descriptor.getDescription() + \"]\").collect(Collectors.joining(\"; \")));\n-                // Throw AssertionError if assertions are enabled, or a regular exception otherwise:\n-                assert false : errorMessage.toString();\n-                throw new IllegalStateException(errorMessage.toString());\n+            } else {\n+                isSystem = true;\n             }\n         }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY5NTkwNQ=="}, "originalCommit": {"oid": "d882e45a29b1471e32556ac5121e4f3638e660dc"}, "originalPosition": 78}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1674, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}