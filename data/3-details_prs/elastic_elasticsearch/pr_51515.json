{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3ODMxMzkx", "number": 51515, "title": "Add warnings for invalid realm order config (#51195)", "bodyText": "The changes are to help users prepare for migration to next major\nrelease (v8.0.0) regarding to the break change of realm order config.\nWarnings are added for when:\n\nA realm does not have an order config\nMultiple realms have the same order config\n\nThe warning messages are added to both deprecation API and loggings.\nThe main reasons for doing this are: 1) there is currently no automatic relay\nbetween the two; 2) deprecation API is under basic and we need logging\nfor OSS.", "createdAt": "2020-01-28T05:18:33Z", "url": "https://github.com/elastic/elasticsearch/pull/51515", "merged": true, "mergeCommit": {"oid": "77b00fc0c0390260e23c55586ca372c93836cbf3"}, "closed": true, "closedAt": "2020-01-31T01:32:37Z", "author": {"login": "ywangd"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-qQybgH2gAyMzY3ODMxMzkxOjgwM2JkYWE2NjJiMjczZmVmNmFmOGE3ODkyM2Q3MDBhY2RlYjQ1Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_kGbtAH2gAyMzY3ODMxMzkxOmQ5NTM1M2RhNDI3Njg2YzAzNjVjYTYzNTUwMGZmYmNlMGZiNjVlNzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/803bdaa662b273fef6af8a78923d700acdeb45f7", "committedDate": "2020-01-28T05:12:35Z", "message": "Add warnings for invalid realm order config (#51195)\n\nIssue warnings for both missing realm order and duplicated realm orders.\nThe changes are to help users prepare for migration to next major\nrelease."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5MjY2OTk4", "url": "https://github.com/elastic/elasticsearch/pull/51515#pullrequestreview-349266998", "createdAt": "2020-01-28T10:26:08Z", "commit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDoyNjowOFrOFif77A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQxMDoyNjowOFrOFif77A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTcxOTE0OA==", "bodyText": "Not sure what url should be used here. The breaking change page will only be available once 8.0 is released?", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r371719148", "createdAt": "2020-01-28T10:26:08Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -35,6 +41,61 @@ static DeprecationIssue checkProcessors(final Settings settings , final PluginsA\n             \"https://www.elastic.co/guide/en/elasticsearch/reference/7.4/breaking-changes-7.4.html#deprecate-processors\");\n     }\n \n+    static DeprecationIssue checkMissingRealmOrders(final Settings settings, final PluginsAndModules pluginsAndModules) {\n+        final String orderNotConfiguredRealms = RealmSettings.getRealmSettings(settings).entrySet()\n+                .stream()\n+                .filter(e -> Objects.isNull(e.getValue().get(RealmSettings.ORDER_SETTING_KEY)))\n+                .map(e -> e.getKey().getName())\n+                .collect(Collectors.joining(\"; \"));\n+\n+        if (false == Strings.hasText(orderNotConfiguredRealms)) {\n+            return null;\n+        }\n+\n+        final String details = String.format(\n+            Locale.ROOT,\n+            \"Found realms without order config: [%s]. In next major release, node will fail to start with missing realm order\",\n+            orderNotConfiguredRealms);\n+        return new DeprecationIssue(\n+            DeprecationIssue.Level.CRITICAL,\n+            \"Realm order will be required in next major release.\",\n+            \"\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 42}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5ODUwNzg0", "url": "https://github.com/elastic/elasticsearch/pull/51515#pullrequestreview-349850784", "createdAt": "2020-01-29T04:06:38Z", "commit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "state": "COMMENTED", "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNDowNjozOVrOFi8DIw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQwNDozMToyNVrOFi8VfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE3OTc0Nw==", "bodyText": "I think you want to use Settings.hasValue instead here.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372179747", "createdAt": "2020-01-29T04:06:39Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -35,6 +41,61 @@ static DeprecationIssue checkProcessors(final Settings settings , final PluginsA\n             \"https://www.elastic.co/guide/en/elasticsearch/reference/7.4/breaking-changes-7.4.html#deprecate-processors\");\n     }\n \n+    static DeprecationIssue checkMissingRealmOrders(final Settings settings, final PluginsAndModules pluginsAndModules) {\n+        final String orderNotConfiguredRealms = RealmSettings.getRealmSettings(settings).entrySet()\n+                .stream()\n+                .filter(e -> Objects.isNull(e.getValue().get(RealmSettings.ORDER_SETTING_KEY)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4MTQ1MQ==", "bodyText": "We would typically refer to the whole setting key in these sorts of deprecation warnings.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            .map(e -> e.getKey().getName())\n          \n          \n            \n                            .map(e -> RealmSettings.realmSettingPrefix(e.getKey()) + RealmSettings.ORDER_SETTING_KEY)", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372181451", "createdAt": "2020-01-29T04:17:58Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -35,6 +41,61 @@ static DeprecationIssue checkProcessors(final Settings settings , final PluginsA\n             \"https://www.elastic.co/guide/en/elasticsearch/reference/7.4/breaking-changes-7.4.html#deprecate-processors\");\n     }\n \n+    static DeprecationIssue checkMissingRealmOrders(final Settings settings, final PluginsAndModules pluginsAndModules) {\n+        final String orderNotConfiguredRealms = RealmSettings.getRealmSettings(settings).entrySet()\n+                .stream()\n+                .filter(e -> Objects.isNull(e.getValue().get(RealmSettings.ORDER_SETTING_KEY)))\n+                .map(e -> e.getKey().getName())", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4Mjc2Mg==", "bodyText": "I'd prefer to collect them in a Set instead of a String. No signficant reason, it just seems \"cleaner\" to me.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372182762", "createdAt": "2020-01-29T04:26:06Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -35,6 +41,61 @@ static DeprecationIssue checkProcessors(final Settings settings , final PluginsA\n             \"https://www.elastic.co/guide/en/elasticsearch/reference/7.4/breaking-changes-7.4.html#deprecate-processors\");\n     }\n \n+    static DeprecationIssue checkMissingRealmOrders(final Settings settings, final PluginsAndModules pluginsAndModules) {\n+        final String orderNotConfiguredRealms = RealmSettings.getRealmSettings(settings).entrySet()\n+                .stream()\n+                .filter(e -> Objects.isNull(e.getValue().get(RealmSettings.ORDER_SETTING_KEY)))\n+                .map(e -> e.getKey().getName())\n+                .collect(Collectors.joining(\"; \"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4MzY3Mg==", "bodyText": "Per comments on the PR itself, we'll need to provide a URL here.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372183672", "createdAt": "2020-01-29T04:29:48Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java", "diffHunk": "@@ -35,6 +41,61 @@ static DeprecationIssue checkProcessors(final Settings settings , final PluginsA\n             \"https://www.elastic.co/guide/en/elasticsearch/reference/7.4/breaking-changes-7.4.html#deprecate-processors\");\n     }\n \n+    static DeprecationIssue checkMissingRealmOrders(final Settings settings, final PluginsAndModules pluginsAndModules) {\n+        final String orderNotConfiguredRealms = RealmSettings.getRealmSettings(settings).entrySet()\n+                .stream()\n+                .filter(e -> Objects.isNull(e.getValue().get(RealmSettings.ORDER_SETTING_KEY)))\n+                .map(e -> e.getKey().getName())\n+                .collect(Collectors.joining(\"; \"));\n+\n+        if (false == Strings.hasText(orderNotConfiguredRealms)) {\n+            return null;\n+        }\n+\n+        final String details = String.format(\n+            Locale.ROOT,\n+            \"Found realms without order config: [%s]. In next major release, node will fail to start with missing realm order\",\n+            orderNotConfiguredRealms);\n+        return new DeprecationIssue(\n+            DeprecationIssue.Level.CRITICAL,\n+            \"Realm order will be required in next major release.\",\n+            \"\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NDI0Nw==", "bodyText": "I'd like an inverse test as well - that realms with an order don't trigger an issue.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372184247", "createdAt": "2020-01-29T04:30:55Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/test/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecksTests.java", "diffHunk": "@@ -60,4 +62,48 @@ public void testCheckProcessors() {\n         assertSettingDeprecationsAndWarnings(new Setting<?>[]{EsExecutors.PROCESSORS_SETTING});\n     }\n \n+    public void testCheckMissingRealmOrders() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjE4NDQ0NQ==", "bodyText": "Can we add another realm with order + 1 and verify that it isn't reported.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r372184445", "createdAt": "2020-01-29T04:31:25Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/deprecation/src/test/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecksTests.java", "diffHunk": "@@ -60,4 +62,48 @@ public void testCheckProcessors() {\n         assertSettingDeprecationsAndWarnings(new Setting<?>[]{EsExecutors.PROCESSORS_SETTING});\n     }\n \n+    public void testCheckMissingRealmOrders() {\n+        String realmName = randomAlphaOfLengthBetween(4, 12);\n+        String realmType = randomAlphaOfLengthBetween(4, 12);\n+        final Settings settings =\n+            Settings.builder()\n+                .put(\"xpack.security.authc.realms.\" + realmType + \".\" + realmName + \".enabled\", \"true\").build();\n+\n+        final PluginsAndModules pluginsAndModules = new PluginsAndModules(Collections.emptyList(), Collections.emptyList());\n+        final List<DeprecationIssue> deprecationIssues =\n+            DeprecationChecks.filterChecks(DeprecationChecks.NODE_SETTINGS_CHECKS, c -> c.apply(settings, pluginsAndModules));\n+\n+        assertEquals(1, deprecationIssues.size());\n+        assertEquals(new DeprecationIssue(\n+            DeprecationIssue.Level.CRITICAL,\n+            \"Realm order will be required in next major release.\",\n+            \"\",\n+            String.format(\n+                Locale.ROOT,\n+                \"Found realms without order config: [%s]. In next major release, node will fail to start with missing realm order\",\n+                realmName\n+            )\n+        ), deprecationIssues.get(0));\n+    }\n+\n+    public void testCheckUniqueRealmOrders() {\n+        final int order = randomInt();\n+        final Settings settings = Settings.builder()\n+            .put(\"xpack.security.authc.realms.\"\n+                + randomAlphaOfLengthBetween(4, 12) + \".\" + randomAlphaOfLengthBetween(4, 12) + \".order\", order)\n+            .put(\"xpack.security.authc.realms.\" \n+                + randomAlphaOfLengthBetween(4, 12) + \".\" + randomAlphaOfLengthBetween(4, 12) + \".order\", order)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "803bdaa662b273fef6af8a78923d700acdeb45f7"}, "originalPosition": 46}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c7790c1c9957856ee2751786a6cbdcdf091fe1b", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c7790c1c9957856ee2751786a6cbdcdf091fe1b", "committedDate": "2020-01-29T10:54:55Z", "message": "Merge branch '7.x' into es-37614-realm-order-7.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0afe29951390c27bbc54f76295fd5d6fe0555e46", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/0afe29951390c27bbc54f76295fd5d6fe0555e46", "committedDate": "2020-01-29T11:04:50Z", "message": "Update x-pack/plugin/deprecation/src/main/java/org/elasticsearch/xpack/deprecation/NodeDeprecationChecks.java\n\nCo-Authored-By: Tim Vernum <tim@adjective.org>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7ee0a537a85e329d068e2dfdc61d14c1dcb7d8e", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7ee0a537a85e329d068e2dfdc61d14c1dcb7d8e", "committedDate": "2020-01-29T11:05:34Z", "message": "Merge branch 'es-37614-realm-order-7.x' of github.com:ywangd/elasticsearch into es-37614-realm-order-7.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "661d554a3f8a2a413503e855caf9014d645c9754", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/661d554a3f8a2a413503e855caf9014d645c9754", "committedDate": "2020-01-29T12:17:02Z", "message": "Address feedbacks"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNzE2NjI4", "url": "https://github.com/elastic/elasticsearch/pull/51515#pullrequestreview-350716628", "createdAt": "2020-01-30T10:23:43Z", "commit": {"oid": "661d554a3f8a2a413503e855caf9014d645c9754"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3aa41ec091f1bb46c91616ed29d92751c1a1009", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3aa41ec091f1bb46c91616ed29d92751c1a1009", "committedDate": "2020-01-30T13:19:52Z", "message": "Merge remote-tracking branch 'origin/7.x' into es-37614-realm-order-7.x"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc45614884f5310207bd84de22b219745e87481f", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc45614884f5310207bd84de22b219745e87481f", "committedDate": "2020-01-30T13:20:28Z", "message": "Add deprecation loggings for realm order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUxMjIyMzUw", "url": "https://github.com/elastic/elasticsearch/pull/51515#pullrequestreview-351222350", "createdAt": "2020-01-30T23:57:50Z", "commit": {"oid": "cc45614884f5310207bd84de22b219745e87481f"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMzo1Nzo1MFrOFj9y6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0zMFQyMzo1Nzo1MFrOFj9y6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MzI1NjkzNw==", "bodyText": "One comment if we keep this: Generally we create one static DeprecationLogger for each class similar to the regular logger. It's not too much overhead to create new ones but it's still creating a few unnecessary objects.", "url": "https://github.com/elastic/elasticsearch/pull/51515#discussion_r373256937", "createdAt": "2020-01-30T23:57:50Z", "author": {"login": "gwbrown"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/Realms.java", "diffHunk": "@@ -236,6 +247,25 @@ public Realm realm(String name) {\n         if (Strings.hasText(duplicateRealms)) {\n             throw new IllegalArgumentException(\"Found multiple realms configured with the same name: \" + duplicateRealms + \"\");\n         }\n+\n+        if (missingOrderRealmSettingKeys.size() > 0) {\n+            new DeprecationLogger(logger).deprecated(\"Found realms without order config: [{}]. \" +\n+                \"In next major release, node will fail to start with missing realm order.\",\n+                String.join(\"; \", missingOrderRealmSettingKeys)\n+            );\n+        }\n+        final List<String> duplicatedRealmOrderSettingKeys = orderToRealmOrderSettingKeys.entrySet()\n+                .stream()\n+                .filter(e -> e.getValue().size() > 1)\n+                .map(e -> e.getKey() + \": \" + String.join(\",\", e.getValue()))\n+                .sorted()\n+                .collect(Collectors.toList());\n+        if (false == duplicatedRealmOrderSettingKeys.isEmpty()) {\n+            new DeprecationLogger(logger).deprecated(\"Found multiple realms configured with the same order: [{}]. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc45614884f5310207bd84de22b219745e87481f"}, "originalPosition": 52}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d95353da427686c0365ca635500ffbce0fb65e77", "author": {"user": {"login": "ywangd", "name": "Yang Wang"}}, "url": "https://github.com/elastic/elasticsearch/commit/d95353da427686c0365ca635500ffbce0fb65e77", "committedDate": "2020-01-31T00:35:46Z", "message": "Update to address feedback"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3163, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}