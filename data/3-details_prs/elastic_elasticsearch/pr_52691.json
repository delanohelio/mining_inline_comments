{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4ODE5MTMx", "number": 52691, "title": "Avoid NPE in set_security_user without security", "bodyText": "If security was disabled (explicitly), then the SecurityContext would\nbe null, but the set_security_user processor was still registered.\nAttempting to define a pipeline that used that processor would fail\nwith an (intentional) NPE. This behaviour, introduced in #52032, is a\nregression from previous releases where the pipeline was allowed, but\nwas no usable.\nThis change restores the previous behaviour (with a new warning).\nResolves: #52474", "createdAt": "2020-02-24T05:38:48Z", "url": "https://github.com/elastic/elasticsearch/pull/52691", "merged": true, "mergeCommit": {"oid": "cc0fdaf3e34ddcc8f68abe557a25198670a1806f"}, "closed": true, "closedAt": "2020-03-05T05:43:43Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcHWwtYAH2gAyMzc4ODE5MTMxOjlhM2Q5NmNlZGE2OTJhNjg4ZTRkMmE5YzE5MzgxMGM3MWYxNTNkMDQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKjyt-AH2gAyMzc4ODE5MTMxOmI1NmNkZDkzYTgwYTc5YTYxOTE0M2YxZjBiNjBhZTI0ODE5YTIxN2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9a3d96ceda692a688e4d2a9c193810c71f153d04", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a3d96ceda692a688e4d2a9c193810c71f153d04", "committedDate": "2020-02-24T05:34:40Z", "message": "Avoid NPE in set_security_user without security\n\nIf security was disabled (explicitly), then the SecurityContext would\nbe null, but the set_security_user processor was still registered.\n\nAttempting to define a pipeline that used that processor would fail\nwith an (intentional) NPE. This behaviour, introduced in #52032, is a\nregression from previous releases where the pipeline was allowed, but\nwas no usable.\n\nThis change restores the previous behaviour (with a new warning)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/de04ed950f80368c4ba966ed396b1a595bfb9115", "committedDate": "2020-02-24T05:42:43Z", "message": "Remove unnecessary users/roles"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMTgwNDY5", "url": "https://github.com/elastic/elasticsearch/pull/52691#pullrequestreview-363180469", "createdAt": "2020-02-24T06:03:56Z", "commit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNjowMzo1NlrOFtWUfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yNFQwNjoxOTowOFrOFtWeeg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5NTkzMw==", "bodyText": "Are these two settings necessary?", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r383095933", "createdAt": "2020-02-24T06:03:56Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/qa/security-not-enabled/build.gradle", "diffHunk": "@@ -0,0 +1,30 @@\n+/*\n+ * This QA project tests the security plugin when security is not enabled.\n+ * It is intended to cover security functionality which is supposed to \n+ * function in a specific way even if security is not enabled on the cluster\n+ * For example: If a cluster has a pipeline with the set_security_user processor\n+ *              defined, it should be not fail\n+ */\n+ \n+apply plugin: 'elasticsearch.testclusters'\n+apply plugin: 'elasticsearch.standalone-rest-test'\n+apply plugin: 'elasticsearch.rest-test'\n+\n+dependencies {\n+  testCompile project(path: xpackModule('core'), configuration: 'default')\n+  testCompile project(path: xpackModule('security'), configuration: 'testArtifacts')\n+  testCompile project(path: xpackModule('core'), configuration: 'testArtifacts')\n+}\n+\n+testClusters.integTest {\n+  testDistribution = 'DEFAULT'\n+  numberOfNodes = 2\n+\n+  setting 'xpack.ilm.enabled', 'false'\n+  setting 'xpack.ml.enabled', 'false'\n+  // We run with a trial license, but do not enable security.\n+  // This means the security plugin is loaded and all feature are permitted, but they are not enabled\n+  setting 'xpack.license.self_generated.type', 'trial'\n+  setting 'xpack.security.authc.token.enabled', 'true'\n+  setting 'xpack.security.authc.api_key.enabled', 'true'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MzA5ODQ5MA==", "bodyText": "Not sure how feasible or necessary it is to test the warning message. Another nitpick is maybe change \"no security context is available\" to something like \"security is not enabled\" for consistency with other exception message and easier to understand for users.", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r383098490", "createdAt": "2020-02-24T06:19:08Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -34,20 +35,29 @@\n \n     public static final String TYPE = \"set_security_user\";\n \n+    private final Logger logger = LogManager.getLogger();\n+\n     private final SecurityContext securityContext;\n     private final String field;\n     private final Set<Property> properties;\n \n     public\n     SetSecurityUserProcessor(String tag, SecurityContext securityContext, String field, Set<Property> properties) {\n         super(tag);\n-        this.securityContext = Objects.requireNonNull(securityContext, \"security context must be provided\");\n+        this.securityContext = securityContext;\n+        if (this.securityContext == null) {\n+            logger.warn(\"Creating processor [{}] (tag [{}]) on field [{}] but no security context is available\" +\n+                \" - this processor will fail at runtime if it is used\", TYPE, tag, field);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NTQ1MjA1", "url": "https://github.com/elastic/elasticsearch/pull/52691#pullrequestreview-365545205", "createdAt": "2020-02-27T09:54:19Z", "commit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY1NTQ1NzM0", "url": "https://github.com/elastic/elasticsearch/pull/52691#pullrequestreview-365545734", "createdAt": "2020-02-27T09:55:04Z", "commit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOTo1NTowNFrOFvLw7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yN1QwOTo1NTowNFrOFvLw7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTAyMDE0MA==", "bodyText": "If we are sure, we could state instead of frame it as a Q", "url": "https://github.com/elastic/elasticsearch/pull/52691#discussion_r385020140", "createdAt": "2020-02-27T09:55:04Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/ingest/SetSecurityUserProcessor.java", "diffHunk": "@@ -34,20 +35,29 @@\n \n     public static final String TYPE = \"set_security_user\";\n \n+    private final Logger logger = LogManager.getLogger();\n+\n     private final SecurityContext securityContext;\n     private final String field;\n     private final Set<Property> properties;\n \n     public\n     SetSecurityUserProcessor(String tag, SecurityContext securityContext, String field, Set<Property> properties) {\n         super(tag);\n-        this.securityContext = Objects.requireNonNull(securityContext, \"security context must be provided\");\n+        this.securityContext = securityContext;\n+        if (this.securityContext == null) {\n+            logger.warn(\"Creating processor [{}] (tag [{}]) on field [{}] but no security context is available\" +\n+                \" - this processor will fail at runtime if it is used\", TYPE, tag, field);\n+        }\n         this.field = field;\n         this.properties = properties;\n     }\n \n     @Override\n     public IngestDocument execute(IngestDocument ingestDocument) throws Exception {\n+        if (this.securityContext == null) {\n+            throw new IllegalStateException(\"No security context available (is security enabled on this cluster?)\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "de04ed950f80368c4ba966ed396b1a595bfb9115"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b1847d479d1fc90ca20209399b8e395a838330d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b1847d479d1fc90ca20209399b8e395a838330d", "committedDate": "2020-02-27T23:38:16Z", "message": "Merge branch 'master' into fix/52474-NPE-set-sec-user-processor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3068a9ebfe35fb58b20bc9407fbb398145ab0f29", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/3068a9ebfe35fb58b20bc9407fbb398145ab0f29", "committedDate": "2020-02-28T04:29:55Z", "message": "Improve error messages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4aec1e6ce714772345ef348570d79102ac4f394", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4aec1e6ce714772345ef348570d79102ac4f394", "committedDate": "2020-02-28T04:34:02Z", "message": "Remove unnecessary test cluster config"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4448f5187f3b95fe43e7fabed507e1a4bbd6bbcb", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/4448f5187f3b95fe43e7fabed507e1a4bbd6bbcb", "committedDate": "2020-02-28T04:57:23Z", "message": "Fix line length"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b56cdd93a80a79a619143f1f0b60ae24819a217b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b56cdd93a80a79a619143f1f0b60ae24819a217b", "committedDate": "2020-03-05T04:27:24Z", "message": "Merge branch 'master' into fix/52474-NPE-set-sec-user-processor"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2109, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}