{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0NDI5ODA5", "number": 59041, "title": "Ensure authz role for API key is named after owner role", "bodyText": "The composite role that is used for authz, following the authn with an API key, is an intersection of the privileges from the owner role and the key privileges defined when the key has been created.\nThis change ensures that the #names property of such a role equals the names of the owner role.\nRelates #58928 (comment)", "createdAt": "2020-07-05T16:27:46Z", "url": "https://github.com/elastic/elasticsearch/pull/59041", "merged": true, "mergeCommit": {"oid": "d40ab54e452ec92b34ac59586f3add06d77b2e66"}, "closed": true, "closedAt": "2020-07-07T10:32:21Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcx-TzdgH2gAyNDQ0NDI5ODA5OjJkNWJiMWUxNzZlMWNjMTQ4MDVlZTQyMzE5NjNkY2ZmMzg2YjAwNzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcyiZhugH2gAyNDQ0NDI5ODA5OjVmNDRkZWNhOTczNzQ5MjEyZmRlOWFkOGY1ODc4MjBmY2Y1ZmNlNTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2d5bb1e176e1cc14805ee4231963dcff386b0071", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/2d5bb1e176e1cc14805ee4231963dcff386b0071", "committedDate": "2020-07-05T15:24:07Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a2b3655eb323619a2d942d7979840c54e0731e8e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a2b3655eb323619a2d942d7979840c54e0731e8e", "committedDate": "2020-07-05T15:39:49Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a867338ef7caeea6584fae070e5d6c0a7395851e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a867338ef7caeea6584fae070e5d6c0a7395851e", "committedDate": "2020-07-05T15:52:42Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f3df69f6a5f0e8fdfbfe8bfee6304f9b9ebf1ba", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f3df69f6a5f0e8fdfbfe8bfee6304f9b9ebf1ba", "committedDate": "2020-07-05T16:13:44Z", "message": "Done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1435148b5281173032e054f4cb9817f189a7a7e1", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/1435148b5281173032e054f4cb9817f189a7a7e1", "committedDate": "2020-07-05T16:42:10Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58e325d8dd9dc1eddeed57a85785301dfb15883d", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/58e325d8dd9dc1eddeed57a85785301dfb15883d", "committedDate": "2020-07-05T17:04:52Z", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/b21a79778ec9484c02e882c67e46bcb732721bae", "committedDate": "2020-07-05T18:39:01Z", "message": "Bug"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyNzY4Mzc3", "url": "https://github.com/elastic/elasticsearch/pull/59041#pullrequestreview-442768377", "createdAt": "2020-07-06T04:33:07Z", "commit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNDozMzowOFrOGtIhFw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNDozNzo0NFrOGtIlHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3ODY0Nw==", "bodyText": "Gosh! Is this a bug!?", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449978647", "createdAt": "2020-07-06T04:33:08Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -86,7 +81,7 @@ public IndicesAccessControl authorize(String action, Set<String> requestedIndice\n     @Override\n     public Automaton allowedActionsMatcher(String index) {\n         final Automaton allowedMatcher = super.allowedActionsMatcher(index);\n-        final Automaton limitedByMatcher = super.allowedActionsMatcher(index);\n+        final Automaton limitedByMatcher = limitedBy.allowedActionsMatcher(index);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "originalPosition": 26}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0OTk3OTY3OA==", "bodyText": "I understand fromRole.names() is close to non-sense. But I wonder whether it is marginally justifiable to still keep them around just in case? I can be easily persuaded. :)", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r449979678", "createdAt": "2020-07-06T04:37:44Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/permission/LimitedRole.java", "diffHunk": "@@ -187,7 +182,6 @@ public boolean checkRunAs(String runAs) {\n      */\n     public static LimitedRole createLimitedRole(Role fromRole, Role limitedByRole) {\n         Objects.requireNonNull(limitedByRole, \"limited by role is required to create limited role\");\n-        return new LimitedRole(fromRole.names(), fromRole.cluster(), fromRole.indices(), fromRole.application(), fromRole.runAs(),\n-                limitedByRole);\n+        return new LimitedRole(fromRole.cluster(), fromRole.indices(), fromRole.application(), fromRole.runAs(), limitedByRole);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "originalPosition": 36}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODE3NzU2", "url": "https://github.com/elastic/elasticsearch/pull/59041#pullrequestreview-442817756", "createdAt": "2020-07-06T07:00:10Z", "commit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzowMDoxMFrOGtLDfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzowMDo1NFrOGtLEsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMDIyMQ==", "bodyText": "Something doesn't feel quite right about this.\nLet's chat, but I'd prefer a public static method on the ApiKeyService (like createKeyForTesting) rather than making existing methods public.", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450020221", "createdAt": "2020-07-06T07:00:10Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/test/SecurityTestsUtils.java", "diffHunk": "@@ -65,6 +83,17 @@ public static void assertThrowsAuthorizationException(LuceneTestCase.ThrowingRun\n         assertAuthorizationException(securityException, messageMatcher);\n     }\n \n+    public static Authentication createApiKeyAuthentication(ApiKeyService apiKeyService, Authentication authentication,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "originalPosition": 33}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAyMDUzMA==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/59041#discussion_r450020530", "createdAt": "2020-07-06T07:00:54Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/AuthenticationService.java", "diffHunk": "@@ -346,10 +346,9 @@ private void authenticateAsync() {\n         private void checkForApiKey() {\n             apiKeyService.authenticateWithApiKeyIfPresent(threadContext, ActionListener.wrap(authResult -> {\n                     if (authResult.isAuthenticated()) {\n-                        final User user = authResult.getUser();\n-                        authenticatedBy = new RealmRef(ApiKeyService.API_KEY_REALM_NAME, ApiKeyService.API_KEY_REALM_TYPE, nodeName);\n-                        writeAuthToContext(new Authentication(user, authenticatedBy, null, Version.CURRENT,\n-                            Authentication.AuthenticationType.API_KEY, authResult.getMetadata()));\n+                        final Authentication authentication = apiKeyService.createApiKeyAuthentication(authResult, nodeName);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "originalPosition": 8}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODU5Mjky", "url": "https://github.com/elastic/elasticsearch/pull/59041#pullrequestreview-442859292", "createdAt": "2020-07-06T08:08:51Z", "commit": {"oid": "b21a79778ec9484c02e882c67e46bcb732721bae"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "103609e65edfdf8fc48830bfdccc96addf4350e8", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/103609e65edfdf8fc48830bfdccc96addf4350e8", "committedDate": "2020-07-06T09:58:15Z", "message": "Review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7fb790f230fe32017b0e5cb9e9c43404b5bad354", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/7fb790f230fe32017b0e5cb9e9c43404b5bad354", "committedDate": "2020-07-06T10:07:45Z", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff712c93fe875bda345470c4f6d0fedbf52dc544", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff712c93fe875bda345470c4f6d0fedbf52dc544", "committedDate": "2020-07-06T10:52:26Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "973896352f00623f0383ea15977970ff1494692b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/973896352f00623f0383ea15977970ff1494692b", "committedDate": "2020-07-06T11:50:54Z", "message": "Allowed actions matcher test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f2c6bfaeb4a34554bffb5336f851d2f976a46a4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f2c6bfaeb4a34554bffb5336f851d2f976a46a4", "committedDate": "2020-07-06T12:26:58Z", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjU1OTE2", "url": "https://github.com/elastic/elasticsearch/pull/59041#pullrequestreview-443655916", "createdAt": "2020-07-07T08:05:59Z", "commit": {"oid": "0f2c6bfaeb4a34554bffb5336f851d2f976a46a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f44deca973749212fde9ad8f587820fcf5fce50", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f44deca973749212fde9ad8f587820fcf5fce50", "committedDate": "2020-07-07T09:26:57Z", "message": "Merge branch 'master' into audit_owner_role_names_for_api_key_authn"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2276, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}