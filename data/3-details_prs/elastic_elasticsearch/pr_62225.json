{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgzODY1Mzg5", "number": 62225, "title": "Take into account sas tokens while metering put object requests on azure", "bodyText": "Fixes #62208", "createdAt": "2020-09-10T13:36:48Z", "url": "https://github.com/elastic/elasticsearch/pull/62225", "merged": true, "mergeCommit": {"oid": "0c782bc12db41b3e3d069540ac5295b85d2beecd"}, "closed": true, "closedAt": "2020-09-10T16:54:33Z", "author": {"login": "fcofdez"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHhKXvABqjM3NTExODQyMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHjLStgFqTQ4NjA5ODg4Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d878102781b7dc0c9c73965c0e396d69af3cbc40", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/d878102781b7dc0c9c73965c0e396d69af3cbc40", "committedDate": "2020-09-10T13:33:10Z", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208"}, "afterCommit": {"oid": "fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "committedDate": "2020-09-10T13:52:40Z", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "committedDate": "2020-09-10T13:53:24Z", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/fcfbdcd768ed58a8653fcbe0dcca6b010a49b26b", "committedDate": "2020-09-10T13:52:40Z", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208"}, "afterCommit": {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/498552ba74e4286e8fa8daaa12126bb94ab6a3f6", "committedDate": "2020-09-10T13:53:24Z", "message": "Take into account sas tokens while metering put object requests on azure\n\nCloses #62208"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDg5NzAx", "url": "https://github.com/elastic/elasticsearch/pull/62225#pullrequestreview-486089701", "createdAt": "2020-09-10T16:02:57Z", "commit": {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOHP7Iig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xMFQxNjowMjo1N1rOHP7Iig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NjQ1OTUzMA==", "bodyText": "This is a somewhat confusing comment IMO :) It nicely explains the diff here actually but doesn't really explain why it's ok to count this kind of request as a PUT.\nWhat does this kind of request without relevant query portion do? Can we add whatever it does as a comment to justify this logic?", "url": "https://github.com/elastic/elasticsearch/pull/62225#discussion_r486459530", "createdAt": "2020-09-10T16:02:57Z", "author": {"login": "original-brownbear"}, "path": "plugins/repository-azure/src/main/java/org/elasticsearch/repositories/azure/AzureBlobStore.java", "diffHunk": "@@ -117,18 +117,18 @@ public AzureBlobStore(RepositoryMetadata metadata, AzureStorageService service,\n         };\n         this.uploadMetricsCollector = (httpURLConnection -> {\n            assert httpURLConnection.getRequestMethod().equals(\"PUT\");\n-            String queryParams = httpURLConnection.getURL().getQuery();\n-            if (queryParams == null) {\n-                stats.putOperations.incrementAndGet();\n-                return;\n-            }\n+            String queryParams = httpURLConnection.getURL().getQuery() == null ? \"\" : httpURLConnection.getURL().getQuery();\n \n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block\n             // https://docs.microsoft.com/en-us/rest/api/storageservices/put-block-list\n             if (queryParams.contains(\"comp=block\") && queryParams.contains(\"blockid=\")) {\n                 stats.putBlockOperations.incrementAndGet();\n             } else if (queryParams.contains(\"comp=blocklist\")) {\n                 stats.putBlockListOperations.incrementAndGet();\n+            } else {\n+                // if a sas token is used, it's possible that the query params contain\n+                // additional parameters unrelated to the upload type", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "498552ba74e4286e8fa8daaa12126bb94ab6a3f6"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f28026940e3f34330c9b8fae61b3f61cdd45b78b", "author": {"user": {"login": "fcofdez", "name": "Francisco Fern\u00e1ndez Casta\u00f1o"}}, "url": "https://github.com/elastic/elasticsearch/commit/f28026940e3f34330c9b8fae61b3f61cdd45b78b", "committedDate": "2020-09-10T16:09:42Z", "message": "Improve comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg2MDk4ODg2", "url": "https://github.com/elastic/elasticsearch/pull/62225#pullrequestreview-486098886", "createdAt": "2020-09-10T16:13:43Z", "commit": {"oid": "f28026940e3f34330c9b8fae61b3f61cdd45b78b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4688, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}