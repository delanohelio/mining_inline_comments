{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU5MzAzNjQ0", "number": 60465, "title": "Format support for script doc fields", "bodyText": "Adds format and locale support to runtime_script fields,\nspecifically those with the runtime_type of date. Others\nruntime_types will return an error if provided with those parameters.\nRelates to #59332", "createdAt": "2020-07-30T15:26:06Z", "url": "https://github.com/elastic/elasticsearch/pull/60465", "merged": true, "mergeCommit": {"oid": "0e91859bd9ff7345a8b668d6f18724c4812353a2"}, "closed": true, "closedAt": "2020-08-03T12:18:20Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6BRGEAH2gAyNDU5MzAzNjQ0OjFlZjIzYzZmOTQ2OTBlNTQ2MzcwZGFjN2Q3ZjM4ZmQzM2E1NGYxMDM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6XtlnAH2gAyNDU5MzAzNjQ0OjhmNDBjYjQ0NmJmMWU2YzUxZTU1MmM4ZjAwMmI4NTA3MzUwOGFmNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1ef23c6f94690e546370dac7d7f38fd33a54f103", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ef23c6f94690e546370dac7d7f38fd33a54f103", "committedDate": "2020-07-30T15:22:16Z", "message": "format support for script doc fields\n\nAdds `format` and `locale` support to `runtime_script` fields,\nspecifically those with the `runtime_type` of `date`. Others\n`runtime_type`s will return an error if provided with those parameters."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4OTg4MDUw", "url": "https://github.com/elastic/elasticsearch/pull/60465#pullrequestreview-458988050", "createdAt": "2020-07-31T08:03:02Z", "commit": {"oid": "1ef23c6f94690e546370dac7d7f38fd33a54f103"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODowMzowMlrOG5_oRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMVQwODowNDowMlrOG5_p_Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2NDUxOQ==", "bodyText": "nit: I think that looking at this error message, there is a slight change that it makes users think that the specific value they provided for the format parameter is not supported, more than providing any format. same for locale. Maybe we can rephrase it?", "url": "https://github.com/elastic/elasticsearch/pull/60465#discussion_r463464519", "createdAt": "2020-07-31T08:03:02Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeScriptFieldMapperTests.java", "diffHunk": "@@ -145,6 +148,51 @@ public void testDate() throws IOException {\n         assertEquals(Strings.toString(mapping(\"date\")), Strings.toString(mapperService.documentMapper()));\n     }\n \n+    public void testDateWithFormat() throws IOException {\n+        CheckedSupplier<XContentBuilder, IOException> mapping = () -> mapping(\"date\", b -> b.field(\"format\", \"yyyy-MM-dd\"));\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping.get()).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(RuntimeScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping.get()), Strings.toString(mapperService.documentMapper()));\n+    }\n+\n+    public void testDateWithLocale() throws IOException {\n+        CheckedSupplier<XContentBuilder, IOException> mapping = () -> mapping(\"date\", b -> b.field(\"locale\", \"en_GB\"));\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping.get()).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(RuntimeScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping.get()), Strings.toString(mapperService.documentMapper()));\n+    }\n+\n+    public void testDateWithLocaleAndFormat() throws IOException {\n+        CheckedSupplier<XContentBuilder, IOException> mapping = () -> mapping(\n+            \"date\",\n+            b -> b.field(\"format\", \"yyyy-MM-dd\").field(\"locale\", \"en_GB\")\n+        );\n+        MapperService mapperService = createIndex(\"test\", Settings.EMPTY, mapping.get()).mapperService();\n+        FieldMapper mapper = (FieldMapper) mapperService.documentMapper().mappers().getMapper(\"field\");\n+        assertThat(mapper, instanceOf(RuntimeScriptFieldMapper.class));\n+        assertEquals(Strings.toString(mapping.get()), Strings.toString(mapperService.documentMapper()));\n+    }\n+\n+    public void testNonDateWithFormat() throws IOException {\n+        String runtimeType = randomValueOtherThan(\"date\", () -> randomFrom(runtimeTypes));\n+        Exception e = expectThrows(\n+            MapperParsingException.class,\n+            () -> createIndex(\"test\", Settings.EMPTY, mapping(runtimeType, b -> b.field(\"format\", \"yyyy-MM-dd\")))\n+        );\n+        assertThat(e.getMessage(), equalTo(\"Failed to parse mapping: format not supported by runtime_type [\" + runtimeType + \"]\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef23c6f94690e546370dac7d7f38fd33a54f103"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzQ2NDk1Nw==", "bodyText": "would it make sense to have some duel tests between concrete dates and runtime dates to make sure that formatting and locale are applied the same way?", "url": "https://github.com/elastic/elasticsearch/pull/60465#discussion_r463464957", "createdAt": "2020-07-31T08:04:02Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/test/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptDateMappedFieldTypeTests.java", "diffHunk": "@@ -373,4 +430,9 @@ private void checkExpensiveQuery(BiConsumer<ScriptDateMappedFieldType, QueryShar\n             equalTo(\"queries cannot be executed against [runtime_script] fields while [search.allow_expensive_queries] is set to [false].\")\n         );\n     }\n+\n+    private void checkBadDate(ThrowingRunnable queryBuilder) {\n+        Exception e = expectThrows(ElasticsearchParseException.class, queryBuilder);\n+        assertThat(e.getMessage(), containsString(\"failed to parse date field\"));\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1ef23c6f94690e546370dac7d7f38fd33a54f103"}, "originalPosition": 140}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b1c02f6b189cc60a771c6b184e4199b169718107", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b1c02f6b189cc60a771c6b184e4199b169718107", "committedDate": "2020-07-31T17:14:01Z", "message": "Change error message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8f40cb446bf1e6c51e552c8f002b85073508af68", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/8f40cb446bf1e6c51e552c8f002b85073508af68", "committedDate": "2020-07-31T17:31:18Z", "message": "Add duel tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3670, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}