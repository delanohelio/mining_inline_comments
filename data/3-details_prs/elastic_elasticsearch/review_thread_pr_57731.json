{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4NDU3OTY2", "number": 57731, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDowNToxN1rOEC-E1w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowOTo1MFrOEDagvw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTQ5NjU1OnYy", "diffSide": "RIGHT", "path": "docs/reference/settings/ml-settings.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDowNToxN1rOGfv-3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoxNDoyMVrOGfwVIQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0NTE4Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            ===== Machine learning circuit breaker settings\n          \n          \n            \n            ==== {ml-cap} circuit breaker settings", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435945182", "createdAt": "2020-06-05T14:05:17Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk1MDg4MQ==", "bodyText": "This should fix the docs build.", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435950881", "createdAt": "2020-06-05T14:14:21Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0NTE4Mg=="}, "originalCommit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcxNTUyMDYzOnYy", "diffSide": "RIGHT", "path": "docs/reference/settings/ml-settings.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoxMToxNlrOGfwNmA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQxNDoxMToxNlrOGfwNmA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTk0ODk1Mg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage\n          \n          \n            \n            `noop`, meaning the circuit breaker does nothing to prevent too much memory usage,", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r435948952", "createdAt": "2020-06-05T14:11:16Z", "author": {"login": "szabosteve"}, "path": "docs/reference/settings/ml-settings.asciidoc", "diffHunk": "@@ -137,3 +138,23 @@ to the {es} JVM. When such processes are started they must connect to the {es}\n JVM. If such a process does not connect within the time period specified by this\n setting then the process is assumed to have failed. Defaults to `10s`. The minimum\n value for this setting is `5s`.\n+\n+[[model-inference-circuit-breaker]]\n+===== Machine learning circuit breaker settings\n+\n+`breaker.model_inference.limit` (<<cluster-update-settings,Dynamic>>)\n+Limit for model inference breaker, defaults to 40% of JVM heap.\n+This means that it is bound by the limit configured for the parent circuit breaker.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.overhead` (<<cluster-update-settings,Dynamic>>)\n+A constant that all accounting estimations are multiplied with to determine\n+a final estimation. Defaults to 1.\n+See <<circuit-breaker>>.\n+\n+`breaker.model_inference.type`\n+The underlying type of the circuit breaker. There are two valid options:\n+`noop`, meaning the circuit breaker does nothing to prevent too much memory usage", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "41c46cb2153b9d96371e5ae96bb9c3bf93047535"}, "originalPosition": 28}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjcyMDE1NTUxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingServiceTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowOTo1MFrOGgawqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOFQxMjowOTo1MFrOGgawqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNjY0NjA1Ng==", "bodyText": "Unused?\nThe ModelLoadedTracker is required to tell you when a model is loaded but that should not be necessary as assertBusys are used where behaviour is asserted", "url": "https://github.com/elastic/elasticsearch/pull/57731#discussion_r436646056", "createdAt": "2020-06-08T12:09:50Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/loadingservice/ModelLoadingServiceTests.java", "diffHunk": "@@ -370,6 +374,55 @@ public void testGetModelEagerly() throws Exception {\n         verify(trainedModelStatsService, never()).queueStats(any(InferenceStats.class), anyBoolean());\n     }\n \n+    public void testCircuitBreakerBreak() throws Exception {\n+        String model1 = \"test-circuit-break-model-1\";\n+        String model2 = \"test-circuit-break-model-2\";\n+        String model3 = \"test-circuit-break-model-3\";\n+        withTrainedModel(model1, 5L);\n+        withTrainedModel(model2, 5L);\n+        withTrainedModel(model3, 12L);\n+        CircuitBreaker circuitBreaker = new CustomCircuitBreaker(11);\n+        ModelLoadingService modelLoadingService = new ModelLoadingService(trainedModelProvider,\n+            auditor,\n+            threadPool,\n+            clusterService,\n+            trainedModelStatsService,\n+            Settings.EMPTY,\n+            \"test-node\",\n+            circuitBreaker);\n+\n+        // We want to be notified when the models are loaded which happens in a background thread\n+        ModelLoadedTracker loadedTracker = new ModelLoadedTracker(Arrays.asList(model1, model2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ba79ba945eb5c76f1a644a4e3b76e8ed9488cce6"}, "originalPosition": 148}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3571, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}