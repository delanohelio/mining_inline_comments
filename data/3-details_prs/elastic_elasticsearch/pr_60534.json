{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwMzA2OTYx", "number": 60534, "title": "Increase timeout in testFollowIndexWithConcurrentMappingChanges", "bodyText": "The test failed because the leader was taking a lot of CPUs to process many mapping updates. This commit reduces the mapping updates, increases timeout, and adds more debug info.\nCloses #59832", "createdAt": "2020-07-31T16:41:01Z", "url": "https://github.com/elastic/elasticsearch/pull/60534", "merged": true, "mergeCommit": {"oid": "c87050c1ca47d67ee0542e850f5df3c167e7b3c3"}, "closed": true, "closedAt": "2020-08-04T03:09:53Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6W6fGgH2gAyNDYwMzA2OTYxOjAxMGI4NDQ5ZWZkZjdjODM0ZDgwOTYxNGQxYzBmMDI2Mjc4ZmEyYzE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7T3iGAH2gAyNDYwMzA2OTYxOmE0NzY3ZjQ1OGVkNWRiMmMxYjhmZDFkYTAxMWNjZmIwZjJmOTQxNjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "010b8449efdf7c834d809614d1c0f026278fa2c1", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/010b8449efdf7c834d809614d1c0f026278fa2c1", "committedDate": "2020-07-31T16:35:29Z", "message": "Increase timeout in testFollowIndexWithConcurrentMappingChanges"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28df2179221d568c563c2c57c4bc693b03d88e33", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/28df2179221d568c563c2c57c4bc693b03d88e33", "committedDate": "2020-07-31T16:41:57Z", "message": "oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19fd2badcb18bbe3831815840086d7cad50aac99", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/19fd2badcb18bbe3831815840086d7cad50aac99", "committedDate": "2020-08-02T17:03:59Z", "message": "fix logging"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMTA3MDE0", "url": "https://github.com/elastic/elasticsearch/pull/60534#pullrequestreview-460107014", "createdAt": "2020-08-03T15:08:27Z", "commit": {"oid": "19fd2badcb18bbe3831815840086d7cad50aac99"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODoyOFrOG69WbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxNTowODoyOFrOG69WbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDQ3NTc1Nw==", "bodyText": "This is not blocking for the result?", "url": "https://github.com/elastic/elasticsearch/pull/60534#discussion_r464475757", "createdAt": "2020-08-03T15:08:28Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/ccr/src/internalClusterTest/java/org/elasticsearch/xpack/ccr/IndexFollowingIT.java", "diffHunk": "@@ -248,38 +248,23 @@ public void testFollowIndexWithConcurrentMappingChanges() throws Exception {\n         final int firstBatchNumDocs = randomIntBetween(2, 64);\n         logger.info(\"Indexing [{}] docs as first batch\", firstBatchNumDocs);\n         for (int i = 0; i < firstBatchNumDocs; i++) {\n-            final String source = String.format(Locale.ROOT, \"{\\\"f\\\":%d}\", i);\n-            leaderClient().prepareIndex(\"index1\").setId(Integer.toString(i)).setSource(source, XContentType.JSON).get();\n+            leaderClient().prepareIndex(\"index1\").setId(Integer.toString(i)).setSource(\"f\", i).get();\n         }\n \n         AtomicBoolean isRunning = new AtomicBoolean(true);\n \n         // Concurrently index new docs with mapping changes\n+        int numFields = between(10, 20);\n         Thread thread = new Thread(() -> {\n-            int docID = 10000;\n-            char[] chars = \"abcdeghijklmnopqrstuvwxyz\".toCharArray();\n-            for (char c : chars) {\n+            int numDocs = between(10, 200);\n+            for (int i = 0; i < numDocs; i++) {\n                 if (isRunning.get() == false) {\n                     break;\n                 }\n-                final String source;\n-                long valueToPutInDoc = randomLongBetween(0, 50000);\n-                if (randomBoolean()) {\n-                    source = String.format(Locale.ROOT, \"{\\\"%c\\\":%d}\", c, valueToPutInDoc);\n-                } else {\n-                    source = String.format(Locale.ROOT, \"{\\\"%c\\\":\\\"%d\\\"}\", c, valueToPutInDoc);\n-                }\n-                for (int i = 1; i < 10; i++) {\n-                    if (isRunning.get() == false) {\n-                        break;\n-                    }\n-                    leaderClient().prepareIndex(\"index1\").setId(Long.toString(docID++)).setSource(source, XContentType.JSON).get();\n-                    if (rarely()) {\n-                        leaderClient().admin().indices().prepareFlush(\"index1\").setForce(true).get();\n-                    }\n-                }\n-                if (between(0, 100) < 20) {\n-                    leaderClient().admin().indices().prepareFlush(\"index1\").setForce(false).setWaitIfOngoing(false).get();\n+                final String field = \"f-\" + between(1, numFields);\n+                leaderClient().prepareIndex(\"index1\").setSource(field, between(0, 1000)).get();\n+                if (rarely()) {\n+                    leaderClient().admin().indices().prepareFlush(\"index1\").setWaitIfOngoing(false).setForce(false).execute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19fd2badcb18bbe3831815840086d7cad50aac99"}, "originalPosition": 43}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c59db7ce65d81d21b9e68a7a3e7770baf22d7a57", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c59db7ce65d81d21b9e68a7a3e7770baf22d7a57", "committedDate": "2020-08-03T15:35:52Z", "message": "Merge branch 'master' into fix-ccr-mapping-test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4767f458ed5db2c1b8fd1da011ccfb0f2f94167", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4767f458ed5db2c1b8fd1da011ccfb0f2f94167", "committedDate": "2020-08-03T15:36:28Z", "message": "blocking flush"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3584, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}