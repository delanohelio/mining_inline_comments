{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwOTYwNTI3", "number": 55982, "title": "Handle merging dotted object names when merging V2 template mappings", "bodyText": "When merging component template, index template, and request mappings, we now treat any declaration\nof a top-level field the same as replacing all sub-objects. For example, assuming two component\ntemplates with mappings and template B taking precedence:\nA: {foo: {...}}\nB: {foo.bar: {...}}\nResult: {foo.bar: {...}}\n\nA: {foo.bar: {...}}\nB: {foo: {...}}\nResult: {foo: {...}}\n\nA: {foo.bar: {...}}\nB: {foo.baz: {...}}\nResult: {foo.baz: {...}}\n\nRelates to #53101", "createdAt": "2020-04-29T21:21:53Z", "url": "https://github.com/elastic/elasticsearch/pull/55982", "merged": true, "mergeCommit": {"oid": "89b538f857b14b109c1daeec93619e3855f9df54"}, "closed": true, "closedAt": "2020-04-30T15:12:25Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcceyZxAH2gAyNDEwOTYwNTI3OmY1YTA4NTFlMzM0NmNlNmM0YjJmM2EzNWIwOGJmYmU3YWQzMTFhODM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccuDRTAFqTQwMzU4MTg4NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5a0851e3346ce6c4b2f3a35b08bfbe7ad311a83", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5a0851e3346ce6c4b2f3a35b08bfbe7ad311a83", "committedDate": "2020-04-29T20:48:10Z", "message": "Handle merging dotted object names when merging V2 template mappings\n\nWhen merging component template, index template, and request mappings, we now treat any declaration\nof a top-level field the same as replacing all sub-objects. For example, assuming two component\ntemplates with mappings and template B taking precedence:\n\n```\nA: {foo: {...}}\nB: {foo.bar: {...}}\nResult: {foo.bar: {...}}\n\nA: {foo.bar: {...}}\nB: {foo: {...}}\nResult: {foo: {...}}\n\nA: {foo.bar: {...}}\nB: {foo.baz: {...}}\nResult: {foo.baz: {...}}\n```\n\nRelates to #53101"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMzI3NDE0", "url": "https://github.com/elastic/elasticsearch/pull/55982#pullrequestreview-403327414", "createdAt": "2020-04-30T08:54:38Z", "commit": {"oid": "f5a0851e3346ce6c4b2f3a35b08bfbe7ad311a83"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODo1NDozOFrOGOgB-w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0zMFQwODo1NDozOFrOGOgB-w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzg1ODA0Mw==", "bodyText": "If I understand this correctly it can be simplified:\nstatic Map<String, Object> mergeIgnoringDots(Map<String, Object> first, Map<String, Object> second) {\n    Objects.requireNonNull(first, \"merging requires two non-null maps but the first map was null\");\n    Objects.requireNonNull(second, \"merging requires two non-null maps but the second map was null\");\n    Map<String, Object> results = new HashMap<>(first);\n    Set<String> prefixes = second.keySet().stream().map(MetadataCreateIndexService::prefix).collect(Collectors.toSet());\n    results.keySet().removeIf(k -> prefixes.contains(prefix(k)));\n    results.putAll(second);\n    return results;\n}\n\nprivate static String prefix(String s) {\n    return s.split(\"\\\\.\", 2)[0];\n}", "url": "https://github.com/elastic/elasticsearch/pull/55982#discussion_r417858043", "createdAt": "2020-04-30T08:54:38Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -596,6 +597,52 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n         return Collections.singletonMap(MapperService.SINGLE_MAPPING_NAME, finalMappings);\n     }\n \n+    /**\n+     * Add the objects in the second map to the first, where the keys in the {@code second} map have\n+     * higher predecence and overwrite the keys in the {@code first} map. In the event of a key with\n+     * a dot in it (ie, \"foo.bar\"), the keys are treated as only the prefix counting towards\n+     * equality. If the {@code second} map has a key such as \"foo\", all keys starting from \"foo.\" in\n+     * the {@code first} map are discarded.\n+     */\n+    static Map<String, Object> mergeIgnoringDots(Map<String, Object> first, Map<String, Object> second) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5a0851e3346ce6c4b2f3a35b08bfbe7ad311a83"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a08f44a277323999aca45db01b9052916f5f432", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a08f44a277323999aca45db01b9052916f5f432", "committedDate": "2020-04-30T14:29:29Z", "message": "Use simplified function"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzNTgxODg0", "url": "https://github.com/elastic/elasticsearch/pull/55982#pullrequestreview-403581884", "createdAt": "2020-04-30T14:35:10Z", "commit": {"oid": "6a08f44a277323999aca45db01b9052916f5f432"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 330, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}