{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE5MTkzNzA1", "number": 64922, "title": "[Transform] make state handling more robust when stop is called while indexer shuts down", "bodyText": "fix a version conflict exception if stop is called while indexer is\nshutting down. Report the overall transform stats STOPPED if and only\nif there is no task (and therefore no indexer)\nrelates #62204\nTesting\nThe issue is hard to test. The result of the problem is a wrong indexer state in the\nstate document of the internal transform index and errors in the log. Both are not accessible\nfrom the test. Using the _stats API the state reports STOPPED independent of the\nstate document in the index, because there is no task. This works by design.\n(Because of the above I came to the conclusion that the severity of this issue is only\nlog spam. I think there is no functional problem. If the wrong state causes the indexer to\nimmediately start when _start is called, however we call start() on the indexer anyway)\nManual test:\n./gradlew ':x-pack:plugin:transform:qa:multi-node-tests:javaRestTest' --tests \"org.elasticsearch.xpack.transform.integration.TransformIT.testTransformCrud\" -Dtests.iters=50\n\nfollowed by grep on the logs for VersionConflictEngineException", "createdAt": "2020-11-11T13:20:02Z", "url": "https://github.com/elastic/elasticsearch/pull/64922", "merged": true, "mergeCommit": {"oid": "71095afe26789d5ec7c78b6dca3b6d063d452690"}, "closed": true, "closedAt": "2020-11-12T08:46:19Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbf7SGAFqTUyODI3NzUxNg==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbt08kgBqjM5ODcyOTI4NDM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4Mjc3NTE2", "url": "https://github.com/elastic/elasticsearch/pull/64922#pullrequestreview-528277516", "createdAt": "2020-11-11T15:29:52Z", "commit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNToyOTo1MlrOHxSFpw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNTozMTo0NFrOHxSK9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODYzMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                            onFinishResponse -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                            onFinishFailure -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438631", "createdAt": "2020-11-11T15:29:52Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -222,8 +222,8 @@ public synchronized boolean maybeTriggerAsyncJob(long now) {\n                             nextSearch();\n                         } else {\n                             onFinish(ActionListener.wrap(\n-                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                                onFinishResponse -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                                onFinishFailure -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzODkyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521438923", "createdAt": "2020-11-11T15:30:15Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTEzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                    doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure);", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439132", "createdAt": "2020-11-11T15:30:34Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -396,18 +402,19 @@ protected void onStop() {\n     private void finishWithSearchFailure(Exception exc) {\n         stats.incrementSearchFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});\n     }\n \n     private void finishWithIndexingFailure(Exception exc) {\n         stats.incrementIndexingFailures();\n         onFailure(exc);\n-        doSaveState(finishAndSetState(), position.get(), () -> {});\n+        doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTY4OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));\n          \n          \n            \n                                    r -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure),\n          \n          \n            \n                                    e -> doSaveState(finishAndSetState(), position.get(), this::afterFinishOrFailure)));", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439689", "createdAt": "2020-11-11T15:31:21Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -478,8 +485,8 @@ private void onSearchResponse(SearchResponse searchResponse) {\n                 stats.markEndProcessing();\n                 // execute finishing tasks\n                 onFinish(ActionListener.wrap(\n-                        r -> doSaveState(finishAndSetState(), position.get(), () -> {}),\n-                        e -> doSaveState(finishAndSetState(), position.get(), () -> {})));\n+                        r -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();}),\n+                        e -> doSaveState(finishAndSetState(), position.get(), () -> {afterFinishOrFailure();})));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "originalPosition": 53}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTQzOTk5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});\n          \n          \n            \n                        doSaveState(finishAndSetState(), getPosition(), this::afterFinishOrFailure);", "url": "https://github.com/elastic/elasticsearch/pull/64922#discussion_r521439991", "createdAt": "2020-11-11T15:31:44Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/indexing/AsyncTwoPhaseIndexer.java", "diffHunk": "@@ -610,7 +617,7 @@ private boolean checkState(IndexerState currentState) {\n \n         case STOPPING:\n             logger.info(\"Indexer job encountered [\" + IndexerState.STOPPING + \"] state, halting indexer.\");\n-            doSaveState(finishAndSetState(), getPosition(), () -> {});\n+            doSaveState(finishAndSetState(), getPosition(), () -> {afterFinishOrFailure();});", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa"}, "originalPosition": 62}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/ade15afaa9c4393cacfcfc59ba6663e6ed58604f", "committedDate": "2020-11-12T07:54:46Z", "message": "fix a version conflict exception if stop is called while indexer is\nshutting down. Report the overall transform stats STOPPED iff there is no\ntask (and therefore no indexer)\n\nrelates #62204"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "committedDate": "2020-11-12T07:54:47Z", "message": "apply review suggestions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/ade808d8dd6b49cdcdc0c048d0fd47b5dfc902fa", "committedDate": "2020-11-11T13:04:23Z", "message": "fix a version conflict exception if stop is called while indexer is\nshutting down. Report the overall transform stats STOPPED iff there is no\ntask (and therefore no indexer)\n\nrelates #62204"}, "afterCommit": {"oid": "674a4d397ed17537d8cdb8dac9f74510aa926c81", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/674a4d397ed17537d8cdb8dac9f74510aa926c81", "committedDate": "2020-11-12T07:54:47Z", "message": "apply review suggestions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1198, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}