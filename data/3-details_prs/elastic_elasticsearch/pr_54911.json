{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAwNDEwNTE5", "number": 54911, "title": "Add analytics plugin usage stats to _xpack/usage", "bodyText": "Adds analytics plugin usage stats to _xpack/usage. It looks like the usage\ndidn't report the actual usage in the previous versions. So, while it looks\nlike it is reported in 7.7, the numbers are always 0. Because code between 7.7\nand 7.x/master is significantly different, I can open a separate PR for 7.7 if\nwe want to fix it there.\nCloses #54847", "createdAt": "2020-04-07T17:43:21Z", "url": "https://github.com/elastic/elasticsearch/pull/54911", "merged": true, "mergeCommit": {"oid": "e593f3eaeb95f52d1792c51c880a0bd099a236bd"}, "closed": true, "closedAt": "2020-04-13T17:16:13Z", "author": {"login": "imotov"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcVW1uSgH2gAyNDAwNDEwNTE5OmI4NmJkNTc3MmQyY2I0ZTcxOWRlMDNlYzAwNzU5YzU3NzUwZjQ3Njk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcXQkcvAH2gAyNDAwNDEwNTE5Ojk1MGJlMGYwMmM4YzY5YjkxMTViYzI0NGUzNWNjOGI3NGYyMGU2NTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b86bd5772d2cb4e719de03ec00759c57750f4769", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/b86bd5772d2cb4e719de03ec00759c57750f4769", "committedDate": "2020-04-07T17:35:05Z", "message": "Add analytics plugin usage stats to _xpack/usage\n\nAdds analytics plugin usage stats to _xpack/usage.\n\nCloses #54847"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzg5MzU2NjIw", "url": "https://github.com/elastic/elasticsearch/pull/54911#pullrequestreview-389356620", "createdAt": "2020-04-07T17:54:35Z", "commit": {"oid": "b86bd5772d2cb4e719de03ec00759c57750f4769"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1NDozNlrOGCPZeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wN1QxNzo1OTo1OVrOGCPm7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwMjYxNw==", "bodyText": "Ouch.", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r405002617", "createdAt": "2020-04-07T17:54:36Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/AnalyticsPlugin.java", "diffHunk": "@@ -137,7 +137,7 @@ public AnalyticsPlugin() { }\n             ResourceWatcherService resourceWatcherService, ScriptService scriptService, NamedXContentRegistry xContentRegistry,\n             Environment environment, NodeEnvironment nodeEnvironment, NamedWriteableRegistry namedWriteableRegistry,\n             IndexNameExpressionResolver indexNameExpressionResolver) {\n-        return singletonList(new AnalyticsUsage());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b86bd5772d2cb4e719de03ec00759c57750f4769"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTAwNjA2MQ==", "bodyText": "I feel like we might be better off using an EnumMap<AnalyticsStatsAction.Item, AtomicLong> than this string based thing. Serialization would have to be a bit more explicit, but I don't mind that too much.", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r405006061", "createdAt": "2020-04-07T17:59:59Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/AnalyticsUsage.java", "diffHunk": "@@ -9,53 +9,35 @@\n import org.elasticsearch.cluster.node.DiscoveryNode;\n import org.elasticsearch.common.xcontent.ContextParser;\n import org.elasticsearch.xpack.core.analytics.action.AnalyticsStatsAction;\n+import org.elasticsearch.xpack.core.watcher.common.stats.Counters;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b86bd5772d2cb4e719de03ec00759c57750f4769"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e1bb698a50b19139feee6a3e9734b44ca25b2fe", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e1bb698a50b19139feee6a3e9734b44ca25b2fe", "committedDate": "2020-04-07T20:41:21Z", "message": "Address review comments by replacing String based counters with enum based counters"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/c6818b96a9c7c4524079bc63835b3c1284eec523", "committedDate": "2020-04-07T20:41:34Z", "message": "Fix usage docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkwMzQ3MzMx", "url": "https://github.com/elastic/elasticsearch/pull/54911#pullrequestreview-390347331", "createdAt": "2020-04-08T21:32:01Z", "commit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTozMjowMVrOGDBwAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wOFQyMTozNDozMFrOGDB0tQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNzU4NA==", "bodyText": "So, like, we have to add enum entries to the end and they'll come through as 0 if they aren't set. Right?", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r405827584", "createdAt": "2020-04-08T21:32:01Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/EnumCounters.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.analytics;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLongArray;\n+\n+/**\n+ * Utility class similar to org.elasticsearch.xpack.core.watcher.common.stats.Counters, but it is using Enum instead\n+ * of string to identify the counter.\n+ */\n+public class EnumCounters<E extends Enum<E>> implements Writeable {\n+    private final AtomicLongArray counters;\n+    private final E[] enums;\n+\n+    public EnumCounters(Class<E> enumClass) {\n+        counters = new AtomicLongArray(enumClass.getEnumConstants().length);\n+        enums = enumClass.getEnumConstants();\n+    }\n+\n+    public EnumCounters(StreamInput in, Class<E> enumClass) throws IOException {\n+        int size = in.readVInt();\n+        enums = enumClass.getEnumConstants();\n+        long[] vals = new long[enums.length];\n+        for (int i = 0; i < size; i++) {\n+            long val = in.readVLong();\n+            if (i < vals.length) {\n+                vals[i] = val;\n+            }\n+        }\n+        counters = new AtomicLongArray(vals);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODQ4Ng==", "bodyText": "I think it is worth adding comments about that, both to the enum class and to this one.", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r405828486", "createdAt": "2020-04-08T21:33:54Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/EnumCounters.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.analytics;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLongArray;\n+\n+/**\n+ * Utility class similar to org.elasticsearch.xpack.core.watcher.common.stats.Counters, but it is using Enum instead\n+ * of string to identify the counter.\n+ */\n+public class EnumCounters<E extends Enum<E>> implements Writeable {\n+    private final AtomicLongArray counters;\n+    private final E[] enums;\n+\n+    public EnumCounters(Class<E> enumClass) {\n+        counters = new AtomicLongArray(enumClass.getEnumConstants().length);\n+        enums = enumClass.getEnumConstants();\n+    }\n+\n+    public EnumCounters(StreamInput in, Class<E> enumClass) throws IOException {\n+        int size = in.readVInt();\n+        enums = enumClass.getEnumConstants();\n+        long[] vals = new long[enums.length];\n+        for (int i = 0; i < size; i++) {\n+            long val = in.readVLong();\n+            if (i < vals.length) {\n+                vals[i] = val;\n+            }\n+        }\n+        counters = new AtomicLongArray(vals);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNzU4NA=="}, "originalCommit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyODc4OQ==", "bodyText": "Nice trick!", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r405828789", "createdAt": "2020-04-08T21:34:30Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/analytics/EnumCountersTests.java", "diffHunk": "@@ -0,0 +1,112 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.analytics;\n+\n+import org.elasticsearch.Version;\n+import org.elasticsearch.common.io.stream.BytesStreamOutput;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.test.AbstractWireTestCase;\n+import org.elasticsearch.xpack.core.analytics.EnumCounters;\n+\n+import java.io.IOException;\n+import java.util.Map;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.hamcrest.Matchers.hasSize;\n+\n+public class EnumCountersTests extends AbstractWireTestCase<EnumCounters<EnumCountersTests.TestV2>> {\n+\n+    enum TestV1 {A, B, C}\n+\n+    enum TestV2 {A, B, C, D}\n+\n+    @Override\n+    protected EnumCounters<TestV2> createTestInstance() {\n+        EnumCounters<TestV2> inst = new EnumCounters<>(TestV2.class);\n+        inst.inc(TestV2.A, randomNonNegativeLong());\n+        inst.inc(TestV2.B, randomNonNegativeLong());\n+        inst.inc(TestV2.C, randomNonNegativeLong());\n+        inst.inc(TestV2.D, randomNonNegativeLong());\n+        return inst;\n+    }\n+\n+    @Override\n+    protected EnumCounters<TestV2> copyInstance(EnumCounters<TestV2> instance, Version version) throws IOException {\n+        return serialize(instance, in -> new EnumCounters<>(in, TestV2.class));\n+    }\n+\n+    public void testIncrements() {\n+        EnumCounters<TestV1> counters = new EnumCounters<>(TestV1.class);\n+        int a = randomIntBetween(0, 100);\n+        int b = randomIntBetween(0, 100);\n+        int c = randomIntBetween(0, 100);\n+        incrementRandomly(counters, TestV1.A, a);\n+        incrementRandomly(counters, TestV1.B, b);\n+        incrementRandomly(counters, TestV1.C, c);\n+        assertEquals(a, counters.get(TestV1.A));\n+        assertEquals(b, counters.get(TestV1.B));\n+        assertEquals(c, counters.get(TestV1.C));\n+        Map<String, Object> map = counters.toMap();\n+        assertThat(map.keySet(), hasSize(3));\n+        assertThat(map.get(\"a\"), equalTo((long) a));\n+        assertThat(map.get(\"b\"), equalTo((long) b));\n+        assertThat(map.get(\"c\"), equalTo((long) c));\n+    }\n+\n+    public void testBackwardCompatibility() throws Exception {\n+        EnumCounters<TestV2> counters = new EnumCounters<>(TestV2.class);\n+        counters.inc(TestV2.A, 1);\n+        counters.inc(TestV2.B, 2);\n+        counters.inc(TestV2.C, 3);\n+        counters.inc(TestV2.D, 4);\n+        EnumCounters<TestV1> oldCounters = serialize(counters, in -> new EnumCounters<>(in, TestV1.class));\n+        assertEquals(counters.get(TestV2.A), oldCounters.get(TestV1.A));\n+        assertEquals(counters.get(TestV2.B), oldCounters.get(TestV1.B));\n+        assertEquals(counters.get(TestV2.C), oldCounters.get(TestV1.C));\n+    }\n+\n+\n+    public void testForwardCompatibility() throws Exception {\n+        EnumCounters<TestV1> counters = new EnumCounters<>(TestV1.class);\n+        counters.inc(TestV1.A, 1);\n+        counters.inc(TestV1.B, 2);\n+        counters.inc(TestV1.C, 3);\n+        EnumCounters<TestV2> newCounters = serialize(counters, in -> new EnumCounters<>(in, TestV2.class));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523"}, "originalPosition": 79}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c22680e0e8eed8228b9fada2c1c055d9fcf1965a", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/c22680e0e8eed8228b9fada2c1c055d9fcf1965a", "committedDate": "2020-04-10T13:08:26Z", "message": "Add comment about underlying EnumCounters assumptions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67eb9fa5e0d8e1bb502f555ef6b0e1279aa0a1ec", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/67eb9fa5e0d8e1bb502f555ef6b0e1279aa0a1ec", "committedDate": "2020-04-10T13:10:25Z", "message": "Merge remote-tracking branch 'elastic/master' into issue-54847-analytics-xpack-usage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/684cbc3c0d895587eddfdba48b0c6e5c1d1707e2", "committedDate": "2020-04-10T13:31:34Z", "message": "Fix checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkxNTc3NjY0", "url": "https://github.com/elastic/elasticsearch/pull/54911#pullrequestreview-391577664", "createdAt": "2020-04-10T17:57:13Z", "commit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkyMTY4MjE3", "url": "https://github.com/elastic/elasticsearch/pull/54911#pullrequestreview-392168217", "createdAt": "2020-04-13T14:11:35Z", "commit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoxMTozNVrOGEns8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xM1QxNDoyMDoyMlrOGEn-YQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5Nzk3MA==", "bodyText": "Oof, just noticed \"DataScience\"... we should probably change that at some point \ud83d\ude13  Not for this PR though :)", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r407497970", "createdAt": "2020-04-13T14:11:35Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/action/AnalyticsUsageTransportAction.java", "diffHunk": "@@ -20,26 +21,49 @@\n import org.elasticsearch.xpack.core.action.XPackUsageFeatureResponse;\n import org.elasticsearch.xpack.core.action.XPackUsageFeatureTransportAction;\n import org.elasticsearch.xpack.core.analytics.AnalyticsFeatureSetUsage;\n+import org.elasticsearch.xpack.core.analytics.EnumCounters;\n+import org.elasticsearch.xpack.core.analytics.action.AnalyticsStatsAction;\n+\n+import java.util.Collections;\n+import java.util.List;\n+import java.util.stream.Collectors;\n \n public class AnalyticsUsageTransportAction extends XPackUsageFeatureTransportAction {\n     private final XPackLicenseState licenseState;\n+    private final Client client;\n \n     @Inject\n     public AnalyticsUsageTransportAction(TransportService transportService, ClusterService clusterService, ThreadPool threadPool,\n                                          ActionFilters actionFilters, IndexNameExpressionResolver indexNameExpressionResolver,\n-                                         XPackLicenseState licenseState) {\n+                                         XPackLicenseState licenseState, Client client) {\n         super(XPackUsageFeatureAction.ANALYTICS.name(), transportService, clusterService,\n             threadPool, actionFilters, indexNameExpressionResolver);\n         this.licenseState = licenseState;\n+        this.client = client;\n     }\n \n     @Override\n     protected void masterOperation(Task task, XPackUsageRequest request, ClusterState state,\n                                    ActionListener<XPackUsageFeatureResponse> listener) {\n         boolean available = licenseState.isDataScienceAllowed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzQ5ODczNw==", "bodyText": "\ud83d\udc4d", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r407498737", "createdAt": "2020-04-13T14:13:19Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/EnumCounters.java", "diffHunk": "@@ -0,0 +1,136 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.core.analytics;\n+\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+import org.elasticsearch.common.io.stream.Writeable;\n+\n+import java.io.IOException;\n+import java.util.Arrays;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Locale;\n+import java.util.Map;\n+import java.util.concurrent.atomic.AtomicLongArray;\n+\n+/**\n+ * Utility class similar to org.elasticsearch.xpack.core.watcher.common.stats.Counters, but it is using Enum instead\n+ * of string to identify the counter.\n+ */\n+public class EnumCounters<E extends Enum<E>> implements Writeable {\n+    private final AtomicLongArray counters;\n+    private final E[] enums;\n+\n+    public EnumCounters(Class<E> enumClass) {\n+        counters = new AtomicLongArray(enumClass.getEnumConstants().length);\n+        enums = enumClass.getEnumConstants();\n+    }\n+\n+    public EnumCounters(StreamInput in, Class<E> enumClass) throws IOException {\n+        int size = in.readVInt();\n+        enums = enumClass.getEnumConstants();\n+        long[] vals = new long[enums.length];\n+        for (int i = 0; i < size; i++) {\n+            long val = in.readVLong();\n+            if (i < vals.length) {\n+                vals[i] = val;\n+            }\n+        }\n+        counters = new AtomicLongArray(vals);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNTgyNzU4NA=="}, "originalCommit": {"oid": "c6818b96a9c7c4524079bc63835b3c1284eec523"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUwMDgyMA==", "bodyText": "I think this should be a readVLong() instead of readLong()?", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r407500820", "createdAt": "2020-04-13T14:17:21Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/action/AnalyticsStatsAction.java", "diffHunk": "@@ -96,110 +107,52 @@ public Response(ClusterName clusterName, List<NodeResponse> nodes, List<FailedNo\n         protected void writeNodesTo(StreamOutput out, List<NodeResponse> nodes) throws IOException {\n             out.writeList(nodes);\n         }\n-\n-        @Override\n-        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n-            builder.startArray(\"stats\");\n-            for (NodeResponse node : getNodes()) {\n-                node.toXContent(builder, params);\n-            }\n-            builder.endArray();\n-\n-            return builder;\n-        }\n     }\n \n-    public static class NodeResponse extends BaseNodeResponse implements ToXContentObject {\n-        static final ParseField BOXPLOT_USAGE = new ParseField(\"boxplot_usage\");\n-        static final ParseField CUMULATIVE_CARDINALITY_USAGE = new ParseField(\"cumulative_cardinality_usage\");\n-        static final ParseField STRING_STATS_USAGE = new ParseField(\"string_stats_usage\");\n-        static final ParseField TOP_METRICS_USAGE = new ParseField(\"top_metrics_usage\");\n-        static final ParseField T_TEST_USAGE = new ParseField(\"t_test_usage\");\n-\n-        private final long boxplotUsage;\n-        private final long cumulativeCardinalityUsage;\n-        private final long stringStatsUsage;\n-        private final long topMetricsUsage;\n-        private final long ttestUsage;\n-\n-        public NodeResponse(DiscoveryNode node, long boxplotUsage, long cumulativeCardinalityUsage, long stringStatsUsage,\n-                long topMetricsUsage, long ttestUsage) {\n+    public static class NodeResponse extends BaseNodeResponse {\n+        private final EnumCounters<Item> counters;\n+\n+        public NodeResponse(DiscoveryNode node, EnumCounters<Item> counters) {\n             super(node);\n-            this.boxplotUsage = boxplotUsage;\n-            this.cumulativeCardinalityUsage = cumulativeCardinalityUsage;\n-            this.stringStatsUsage = stringStatsUsage;\n-            this.topMetricsUsage = topMetricsUsage;\n-            this.ttestUsage = ttestUsage;\n+            this.counters = counters;\n         }\n \n         public NodeResponse(StreamInput in) throws IOException {\n             super(in);\n-            if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                boxplotUsage = in.readVLong();\n-            } else {\n-                boxplotUsage = 0;\n-            }\n-            cumulativeCardinalityUsage = in.readZLong();\n-            if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n-                stringStatsUsage = in.readVLong();\n-                topMetricsUsage = in.readVLong();\n-            } else {\n-                stringStatsUsage = 0;\n-                topMetricsUsage = 0;\n-            }\n             if (in.getVersion().onOrAfter(Version.V_7_8_0)) {\n-                ttestUsage = in.readVLong();\n+                counters = new EnumCounters<>(in, Item.class);\n             } else {\n-                ttestUsage = 0;\n+                counters = new EnumCounters<>(Item.class);\n+                if (in.getVersion().onOrAfter(Version.V_7_7_0)) {\n+                    counters.inc(Item.BOXPLOT, in.readLong());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2"}, "originalPosition": 109}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNzUwMjQzMw==", "bodyText": "Should we have a test somewhere that enforces this?  E.g. enums that extend writeable directly can implement AbstractWriteableEnumTestCase.  Not the same situation here, but having something conceptually similar to testValidOrdinals() would be nice.  Just verifies that BOXPLOT == 0, etc etc", "url": "https://github.com/elastic/elasticsearch/pull/54911#discussion_r407502433", "createdAt": "2020-04-13T14:20:22Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/analytics/action/AnalyticsStatsAction.java", "diffHunk": "@@ -33,6 +33,17 @@ private AnalyticsStatsAction() {\n         super(NAME, Response::new);\n     }\n \n+    /**\n+     * Items to track. Serialized by ordinals. Append only, don't remove or change order of items in this list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "684cbc3c0d895587eddfdba48b0c6e5c1d1707e2"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7f5e89e136e5d0be32ff770751d6163aec15ee33", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/7f5e89e136e5d0be32ff770751d6163aec15ee33", "committedDate": "2020-04-13T14:33:57Z", "message": "Fix boxplot stats serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "950be0f02c8c69b9115bc244e35cc8b74f20e652", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/950be0f02c8c69b9115bc244e35cc8b74f20e652", "committedDate": "2020-04-13T15:24:38Z", "message": "Add node response tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3561, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}