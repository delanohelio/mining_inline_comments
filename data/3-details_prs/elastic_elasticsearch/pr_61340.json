{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMjc5MDI1", "number": 61340, "title": "[ML] Update ML mappings upgrade test and extend to config index", "bodyText": "The ML mappings upgrade test had become useless as it was\nchecking a field that has been the same since 6.5. This\ncommit switches to a field that was changed in 7.9.\nAdditionally, the test only used to check the results index\nmappings.  This commit also adds checking for the config\nindex.\nRelates #61157", "createdAt": "2020-08-19T16:23:07Z", "url": "https://github.com/elastic/elasticsearch/pull/61340", "merged": true, "mergeCommit": {"oid": "0a135a358e4736ee54d76bad0932cab1b5cc1a74"}, "closed": true, "closedAt": "2020-09-02T07:37:14Z", "author": {"login": "droberts195"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAeDiVgH2gAyNDcwMjc5MDI1OjhhNmVjMzc0ODRkMjZlNTU5OTNmOTZmZGNjM2NhODMyNGY1ZjUyNmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEoonhAFqTQ3OTgyNDQyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/8a6ec37484d26e55993f96fdcc3ca8324f5f526c", "committedDate": "2020-08-19T16:18:15Z", "message": "[ML] Update ML mappings upgrade test and extend to config index\n\nThe ML mappings upgrade test had become useless as it was\nchecking a field that has been the same since 6.5. This\ncommit switches to a field that was changed in 7.9.\n\nAdditionally, the test only used to check the results index\nmappings.  This commit also adds checking for the config\nindex.\n\nRelates #61157"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcxMzcxNzE4", "url": "https://github.com/elastic/elasticsearch/pull/61340#pullrequestreview-471371718", "createdAt": "2020-08-20T08:24:12Z", "commit": {"oid": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyNDoxMlrOHDzt8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yMFQwODoyNToxM1rOHDzxow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NTEyMg==", "bodyText": "Could using XContentMapValues::extractValue method make this more concise?", "url": "https://github.com/elastic/elasticsearch/pull/61340#discussion_r473755122", "createdAt": "2020-08-20T08:24:12Z", "author": {"login": "przemekwitek"}, "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "diffHunk": "@@ -105,8 +120,40 @@ private void assertUpgradedMappings() throws Exception {\n             assertNotNull(propertiesLevel);\n             // TODO: as the years go by, the field we assert on here should be changed\n             // to the most recent field we've added that is NOT of type \"keyword\"\n-            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel.get(\"multi_bucket_impact\");\n-            assertEquals(Collections.singletonMap(\"type\", \"double\"), fieldLevel);\n+            Map<String, Object> objectLevel = (Map<String, Object>) propertiesLevel.get(\"model_size_stats\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3Mzc1NjA2Nw==", "bodyText": "The same here, could XContentMapValues::extractValue be used instead of this sequence of gets and casts?", "url": "https://github.com/elastic/elasticsearch/pull/61340#discussion_r473756067", "createdAt": "2020-08-20T08:25:13Z", "author": {"login": "przemekwitek"}, "path": "x-pack/qa/rolling-upgrade/src/test/java/org/elasticsearch/upgrades/MlMappingsUpgradeIT.java", "diffHunk": "@@ -105,8 +120,40 @@ private void assertUpgradedMappings() throws Exception {\n             assertNotNull(propertiesLevel);\n             // TODO: as the years go by, the field we assert on here should be changed\n             // to the most recent field we've added that is NOT of type \"keyword\"\n-            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel.get(\"multi_bucket_impact\");\n-            assertEquals(Collections.singletonMap(\"type\", \"double\"), fieldLevel);\n+            Map<String, Object> objectLevel = (Map<String, Object>) propertiesLevel.get(\"model_size_stats\");\n+            assertNotNull(objectLevel);\n+            Map<String, Object> propertiesLevel2 = (Map<String, Object>) objectLevel.get(\"properties\");\n+            assertNotNull(propertiesLevel2);\n+            Map<String, Object> fieldLevel = (Map<String, Object>) propertiesLevel2.get(\"peak_model_bytes\");\n+            assertEquals(Collections.singletonMap(\"type\", \"long\"), fieldLevel);\n+        });\n+    }\n+\n+    @SuppressWarnings(\"unchecked\")\n+    private void assertUpgradedConfigMappings() throws Exception {\n+\n+        assertBusy(() -> {\n+            Request getMappings = new Request(\"GET\", \".ml-config/_mappings\");\n+            Response response = client().performRequest(getMappings);\n+\n+            Map<String, Object> responseLevel = entityAsMap(response);\n+            assertNotNull(responseLevel);\n+            Map<String, Object> indexLevel = (Map<String, Object>) responseLevel.get(\".ml-config\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8a6ec37484d26e55993f96fdcc3ca8324f5f526c"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c946272eb0ddb2c7aac814dcd652775520c62833", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/c946272eb0ddb2c7aac814dcd652775520c62833", "committedDate": "2020-09-01T09:51:00Z", "message": "Merge remote-tracking branch 'origin/master' into validate_mappings_after_upgrade"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fa55e0c1ce0615c4a007664412c7c95c03fa3837", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/fa55e0c1ce0615c4a007664412c7c95c03fa3837", "committedDate": "2020-09-01T11:32:20Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODI0NDIy", "url": "https://github.com/elastic/elasticsearch/pull/61340#pullrequestreview-479824422", "createdAt": "2020-09-01T14:53:30Z", "commit": {"oid": "fa55e0c1ce0615c4a007664412c7c95c03fa3837"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4772, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}