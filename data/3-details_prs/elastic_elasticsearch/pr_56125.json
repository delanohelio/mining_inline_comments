{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzMDQ4Mjc4", "number": 56125, "title": "[ML] More advanced model snapshot retention options", "bodyText": "This PR implements the following changes to make ML model snapshot\nretention more flexible in advance of adding a UI for the feature in\nan upcoming release.\n\nThe default for model_snapshot_retention_days for new jobs is now\n10 instead of 1\nThere is a new job setting, daily_model_snapshot_retention_after_days,\nthat defaults to 1 for new jobs and model_snapshot_retention_days\nfor pre-7.8 jobs\nFor days that are older than model_snapshot_retention_days, all\nmodel snapshots are deleted as before\nFor days that are in between daily_model_snapshot_retention_after_days\nand model_snapshot_retention_days all but the first model snapshot\nfor that day are deleted\nThe retain setting of model snapshots is still respected to allow\nselected model snapshots to be retained indefinitely\n\nCloses #52150", "createdAt": "2020-05-04T16:16:02Z", "url": "https://github.com/elastic/elasticsearch/pull/56125", "merged": true, "mergeCommit": {"oid": "c99021cdcbff4d364adee7208b6204548a7c4c12"}, "closed": true, "closedAt": "2020-05-05T11:55:51Z", "author": {"login": "droberts195"}, "timelineItems": {"totalCount": 16, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceB36NgH2gAyNDEzMDQ4Mjc4OjhkMDMxMjRiYTM2YjI0N2YwZDdmODU4MjQ2OWU0MDY4ZDEyNmRiNzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABceSbtXAFqTQwNTcwMjQ0OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8d03124ba36b247f0d7f8582469e4068d126db79", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d03124ba36b247f0d7f8582469e4068d126db79", "committedDate": "2020-05-04T16:14:47Z", "message": "[ML] More advanced model snapshot retention options\n\nThis PR implements the following changes to make ML model snapshot\nretention more flexible in advance of adding a UI for the feature in\nan upcoming release.\n\n- The default for `model_snapshot_retention_days` for new jobs is now\n  10 instead of 1\n- There is a new job setting, `daily_model_snapshot_retention_after_days`,\n  that defaults to 1 for new jobs and `model_snapshot_retention_days`\n  for pre-7.8 jobs\n- For days that are older than `model_snapshot_retention_days`, all\n  model snapshots are deleted as before\n- For days that are in between `daily_model_snapshot_retention_after_days`\n  and `model_snapshot_retention_days` all but the first model snapshot\n  for that day are deleted\n- The `retain` setting of model snapshots is still respected to allow\n  selected model snapshots to be retained indefinitely\n\nCloses #52150"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjM2ODA2", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405236806", "createdAt": "2020-05-04T18:24:59Z", "commit": {"oid": "8d03124ba36b247f0d7f8582469e4068d126db79"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODoyNDo1OVrOGQMoMw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxODozMjoxM1rOGQM5sQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTYzNzI5OQ==", "bodyText": "Docs should be updated for tag::model-snapshot-retention-days[] as it says the default value is 1.", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r419637299", "createdAt": "2020-05-04T18:24:59Z", "author": {"login": "benwtrent"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -361,6 +361,19 @@ example, it can contain custom URL information as shown in\n {ml-docs}/ml-configuring-url.html[Adding custom URLs to {ml} results].\n end::custom-settings[]\n \n+tag::daily-model-snapshot-retention-after-days[]\n+Advanced configuration option. A number of days in between 0 and the value of\n+`model_snapshot_retention_days` after which only one model snapshot per day\n+is retained instead of all model snapshots. Age is calculated relative to the\n+timestamp of the newest model snapshot. The default value is `1` for newly\n+created jobs, which means that all snapshots are retained for one day but\n+older snapshots are thinned out such that only one per day is retained until\n+`model_snapshot_retention_days`. For jobs that were created before this\n+setting was available, the default is the same as that job's\n+`model_snapshot_retention_days` setting, to preserve the original behavior\n+that no thinning out of model snapshots is done.\n+end::daily-model-snapshot-retention-after-days[]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d03124ba36b247f0d7f8582469e4068d126db79"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY0MTc3Nw==", "bodyText": "#nit, do these tests NEED to be the native-multi-node-tests? These take a while to spin-up and run.", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r419641777", "createdAt": "2020-05-04T18:32:13Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ModelSnapshotRetentionIT.java", "diffHunk": "@@ -0,0 +1,234 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.integration;\n+\n+import org.elasticsearch.action.DocWriteResponse;\n+import org.elasticsearch.action.bulk.BulkAction;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.bulk.BulkResponse;\n+import org.elasticsearch.action.index.IndexAction;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.index.IndexResponse;\n+import org.elasticsearch.action.search.SearchAction;\n+import org.elasticsearch.action.search.SearchRequest;\n+import org.elasticsearch.action.search.SearchResponse;\n+import org.elasticsearch.action.support.WriteRequest;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.xcontent.ToXContent;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.json.JsonXContent;\n+import org.elasticsearch.index.query.QueryBuilder;\n+import org.elasticsearch.index.query.QueryBuilders;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.search.builder.SearchSourceBuilder;\n+import org.elasticsearch.xpack.core.ml.action.PutJobAction;\n+import org.elasticsearch.xpack.core.ml.action.UpdateJobAction;\n+import org.elasticsearch.xpack.core.ml.job.config.AnalysisConfig;\n+import org.elasticsearch.xpack.core.ml.job.config.DataDescription;\n+import org.elasticsearch.xpack.core.ml.job.config.Detector;\n+import org.elasticsearch.xpack.core.ml.job.config.Job;\n+import org.elasticsearch.xpack.core.ml.job.config.JobUpdate;\n+import org.elasticsearch.xpack.core.ml.job.persistence.AnomalyDetectorsIndex;\n+import org.elasticsearch.xpack.core.ml.job.process.autodetect.state.ModelSnapshot;\n+import org.elasticsearch.xpack.core.ml.job.process.autodetect.state.ModelState;\n+import org.junit.After;\n+\n+import java.io.IOException;\n+import java.util.ArrayList;\n+import java.util.Collections;\n+import java.util.Date;\n+import java.util.List;\n+\n+import static org.hamcrest.Matchers.greaterThan;\n+import static org.hamcrest.Matchers.is;\n+import static org.hamcrest.Matchers.notNullValue;\n+\n+public class ModelSnapshotRetentionIT extends MlNativeAutodetectIntegTestCase {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8d03124ba36b247f0d7f8582469e4068d126db79"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1Mjg0OTI1", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405284925", "createdAt": "2020-05-04T19:32:35Z", "commit": {"oid": "8d03124ba36b247f0d7f8582469e4068d126db79"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a", "author": {"user": {"login": "lcawl", "name": "Lisa Cawley"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e7bf0e0a6c26886920e968367795e41d1c0d52a", "committedDate": "2020-05-04T19:40:07Z", "message": "[DOCS] Updates retention descriptions"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjkxMjUx", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405291251", "createdAt": "2020-05-04T19:42:00Z", "commit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTo0MjowMFrOGQPYLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTo0MjowMFrOGQPYLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MjM0OQ==", "bodyText": "Should we clarify which snapshot is retained?\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            value of `model_snapshot_retention_days`. After this period of time, only one\n          \n          \n            \n            value of `model_snapshot_retention_days`. After this period of time, only the first", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r419682349", "createdAt": "2020-05-04T19:42:00Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -361,6 +361,18 @@ example, it can contain custom URL information as shown in\n {ml-docs}/ml-configuring-url.html[Adding custom URLs to {ml} results].\n end::custom-settings[]\n \n+tag::daily-model-snapshot-retention-after-days[]\n+Advanced configuration option. Specifies a number of days between 0 and the\n+value of `model_snapshot_retention_days`. After this period of time, only one", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1MjkyMjY0", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405292264", "createdAt": "2020-05-04T19:43:30Z", "commit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTo0MzozMFrOGQPbsg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNFQxOTo0MzozMFrOGQPbsg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTY4MzI1MA==", "bodyText": "Age is calculated relative to the timestamp of the newest model snapshot...\n\nIs this sentence needed?  If yes, it's unclear to me what this age affects.", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r419683250", "createdAt": "2020-05-04T19:43:30Z", "author": {"login": "lcawl"}, "path": "docs/reference/ml/ml-shared.asciidoc", "diffHunk": "@@ -361,6 +361,18 @@ example, it can contain custom URL information as shown in\n {ml-docs}/ml-configuring-url.html[Adding custom URLs to {ml} results].\n end::custom-settings[]\n \n+tag::daily-model-snapshot-retention-after-days[]\n+Advanced configuration option. Specifies a number of days between 0 and the\n+value of `model_snapshot_retention_days`. After this period of time, only one\n+model snapshot per day is retained for this job. Age is calculated relative to", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee14fd324c0be7fb244975499d34700bf0fd7b4c", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee14fd324c0be7fb244975499d34700bf0fd7b4c", "committedDate": "2020-05-05T08:32:49Z", "message": "Update docs/reference/ml/ml-shared.asciidoc\n\nCo-authored-by: Lisa Cawley <lcawley@elastic.co>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7951a77f19af480e2375218944eba18e2c3d0679", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/7951a77f19af480e2375218944eba18e2c3d0679", "committedDate": "2020-05-05T08:37:59Z", "message": "Fixing tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "394be6dd213a6f6b96b0aeedc945ea37d5e7dbd7", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/394be6dd213a6f6b96b0aeedc945ea37d5e7dbd7", "committedDate": "2020-05-05T09:09:12Z", "message": "Merge branch 'master' into daily_model_snapshot_retention"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjI3NjQ1", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405627645", "createdAt": "2020-05-05T09:30:31Z", "commit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMDozMVrOGQhdaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQwOTozMDozMVrOGQhdaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxOTk3ODYwMA==", "bodyText": "It might be worth replacing the tuple with a struct-like class that better explains what each value is.", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r419978600", "createdAt": "2020-05-05T09:30:31Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -84,15 +87,15 @@ private WrappedBatchedJobsIterator newJobIterator() {\n         return new WrappedBatchedJobsIterator(jobsIterator);\n     }\n \n-    abstract void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Long> listener);\n+    abstract void calcCutoffEpochMs(String jobId, long retentionDays, ActionListener<Tuple<Long, Long>> listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3e7bf0e0a6c26886920e968367795e41d1c0d52a"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3201549168e5524398a96b6db160a92419339403", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/3201549168e5524398a96b6db160a92419339403", "committedDate": "2020-05-05T09:58:31Z", "message": "Use a dedicated class instead of Tuple"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjcxNTM4", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405671538", "createdAt": "2020-05-05T10:39:32Z", "commit": {"oid": "3201549168e5524398a96b6db160a92419339403"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozOTozMlrOGQjrwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxMDozOTozMlrOGQjrwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDAxNTA0Mg==", "bodyText": "Make those two members final?", "url": "https://github.com/elastic/elasticsearch/pull/56125#discussion_r420015042", "createdAt": "2020-05-05T10:39:32Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/AbstractExpiredJobDataRemover.java", "diffHunk": "@@ -147,4 +145,39 @@ public Job next() {\n             return new VolatileCursorIterator<>(jobs);\n         }\n     }\n+\n+    /**\n+     * The latest time that cutoffs are measured from is not wall clock time,\n+     * but some other reference point that makes sense for the type of data\n+     * being removed.  This class groups the cutoff time with it's \"latest\"\n+     * reference point.\n+     */\n+    protected static final class CutoffDetails {\n+\n+        public long latestTimeMs;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3201549168e5524398a96b6db160a92419339403"}, "originalPosition": 58}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bb92d995240ba59f1187571bd10260f34d5d420", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/0bb92d995240ba59f1187571bd10260f34d5d420", "committedDate": "2020-05-05T10:48:46Z", "message": "Merge branch 'master' into daily_model_snapshot_retention"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f6a8477a99e16633c08c9f07ff2d9f70e1d71a", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3f6a8477a99e16633c08c9f07ff2d9f70e1d71a", "committedDate": "2020-05-05T10:51:16Z", "message": "Make members final"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NjgwMTcw", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405680170", "createdAt": "2020-05-05T10:54:05Z", "commit": {"oid": "c3f6a8477a99e16633c08c9f07ff2d9f70e1d71a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA1NzAyNDQ4", "url": "https://github.com/elastic/elasticsearch/pull/56125#pullrequestreview-405702448", "createdAt": "2020-05-05T11:32:22Z", "commit": {"oid": "c3f6a8477a99e16633c08c9f07ff2d9f70e1d71a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 232, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}