{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzgxOTU0NjAz", "number": 52985, "title": "Resolve runtime SP model from index doc", "bodyText": "This change adds a SamlServiceProviderResolver that can build a\nSamlServiceProvider object for a given entity-id, based on the\ndocument model stored in SamlServiceProviderDocument.\nThis resolver includes a cache that is aware of document versioning\n(seqNo, primaryTerm) and avoids JSON parsing and object construction\nif the document has not changed since last use.", "createdAt": "2020-02-29T23:05:38Z", "url": "https://github.com/elastic/elasticsearch/pull/52985", "merged": true, "mergeCommit": {"oid": "2f2853740a65c3ba0ddfe65acd9cb3c671c3c7aa"}, "closed": true, "closedAt": "2020-03-05T12:40:28Z", "author": {"login": "tvernum"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcJEGZ6gH2gAyMzgxOTU0NjAzOjczZjFkNDYzOWNhYjE5MmI3ZWUxZmNiMjQ3OGY2ZTAwYjQ0M2EwOWU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcKmZLSgH2gAyMzgxOTU0NjAzOjZhNmI2ZjY0Y2E0NTc2NTE4MzQyOWJiZjdkNTk2ZGVjMWY2NGY5NmQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "73f1d4639cab192b7ee1fcb2478f6e00b443a09e", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/73f1d4639cab192b7ee1fcb2478f6e00b443a09e", "committedDate": "2020-02-29T12:58:01Z", "message": "Resolve runtime SP model from index doc\n\nThis change adds a `SamlServiceProviderResolver` that can build a\n`SamlServiceProvider` object for a given entity-id, based on the\ndocument model stored in `SamlServiceProviderDocument`.\n\nThis resolver includes a cache that is aware of document versioning\n(seqNo, primaryTerm) and avoids JSON parsing and object construction\nif the document has not changed since last use."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/422baf56a083c610d3f9770e0e9736956f0ee0cd", "committedDate": "2020-02-29T23:57:48Z", "message": "Merge branch 'feature-internal-idp' into idp/sp-resolve\n\n# Conflicts:\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/CloudIdp.java\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/idp/SamlIdentityProvider.java\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/CloudServiceProvider.java\n#\tx-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProvider.java\n#\tx-pack/plugin/identity-provider/src/test/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidatorTests.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4MjkzMTUz", "url": "https://github.com/elastic/elasticsearch/pull/52985#pullrequestreview-368293153", "createdAt": "2020-03-03T20:16:49Z", "commit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMDoxNjo0OVrOFxVBxA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTowODo1NVrOFxWltg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI2OTA2MA==", "bodyText": "I like that we throw specifically on urlencode errors now but I find the two very similar methods with almost identical signatures confusing. I think that changing the parameter names in the other method accordingly will help alleviate some of that - in any case I'm nitpicking, these are private methods eitherway", "url": "https://github.com/elastic/elasticsearch/pull/52985#discussion_r387269060", "createdAt": "2020-03-03T20:16:49Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/authn/SamlAuthnRequestValidator.java", "diffHunk": "@@ -170,22 +174,38 @@ private void validateAuthnRequest(AuthnRequest authnRequest, SamlServiceProvider\n         checkAcs(authnRequest, sp);\n     }\n \n-    private boolean validateSignature(String samlRequest, String sigAlg, String signature, X509Credential credential,\n+    private boolean validateSignature(String samlRequest, String sigAlg, String signature, Collection<X509Credential> credentials,\n                                       @Nullable String relayState) {\n         try {\n             final String queryParam = relayState == null ?\n                 \"SAMLRequest=\" + urlEncode(samlRequest) + \"&SigAlg=\" + urlEncode(sigAlg) :\n                 \"SAMLRequest=\" + urlEncode(samlRequest) + \"&RelayState=\" + urlEncode(relayState) + \"&SigAlg=\" + urlEncode(sigAlg);\n-            Signature sig = Signature.getInstance(samlFactory.getJavaAlorithmNameFromUri(sigAlg));\n-            sig.initVerify(credential.getEntityCertificate().getPublicKey());\n-            sig.update(queryParam.getBytes(StandardCharsets.UTF_8));\n-            return sig.verify(Base64.getDecoder().decode(signature));\n-        } catch (Exception e) {\n-            throw new ElasticsearchSecurityException(\"Unable to validate signature of authentication request using credentials [{}]\",\n-                samlFactory.describeCredentials(Collections.singletonList(credential)), e);\n+            return validateSignature(queryParam.getBytes(StandardCharsets.UTF_8), sigAlg, signature, credentials);\n+        } catch (UnsupportedEncodingException e) {\n+            throw new ElasticsearchSecurityException(\"Cannot reconstruct query for signature verification\", e);\n         }\n     }\n \n+    private boolean validateSignature(byte[] content, String algorithm, String base64Signature, Collection<X509Credential> credentials) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI4NjIwMQ==", "bodyText": "I do feel we have discussed this already but it evades me now. Why did we select this approach over i.e returning the cached version of the ServiceProvider if one exists without hitting the index and invalidate entries when an sp document changes ?", "url": "https://github.com/elastic/elasticsearch/pull/52985#discussion_r387286201", "createdAt": "2020-03-03T20:52:03Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderResolver.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.sp;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.iterable.Iterables;\n+import org.elasticsearch.xpack.idp.privileges.ServiceProviderPrivileges;\n+import org.elasticsearch.xpack.idp.saml.idp.SamlIdentityProvider;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProviderIndex.DocumentSupplier;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProviderIndex.DocumentVersion;\n+import org.joda.time.ReadableDuration;\n+import org.opensaml.security.x509.BasicX509Credential;\n+import org.opensaml.security.x509.X509Credential;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class SamlServiceProviderResolver {\n+\n+    private static final int CACHE_SIZE_DEFAULT = 1000;\n+    private static final TimeValue CACHE_TTL_DEFAULT = TimeValue.timeValueMinutes(60);\n+\n+    public static final Setting<Integer> CACHE_SIZE\n+        = Setting.intSetting(\"xpack.idp.sp.cache.size\", CACHE_SIZE_DEFAULT, Setting.Property.NodeScope);\n+    public static final Setting<TimeValue> CACHE_TTL\n+        = Setting.timeSetting(\"xpack.idp.sp.cache.ttl\", CACHE_TTL_DEFAULT, Setting.Property.NodeScope);\n+\n+    private final Cache<String, CachedServiceProvider> cache;\n+    private final SamlServiceProviderIndex index;\n+    private final SamlIdentityProvider identityProvider;\n+\n+    public SamlServiceProviderResolver(Settings settings, SamlServiceProviderIndex index, SamlIdentityProvider identityProvider) {\n+        this.cache = CacheBuilder.<String, CachedServiceProvider>builder()\n+            .setMaximumWeight(CACHE_SIZE.get(settings))\n+            .setExpireAfterAccess(CACHE_TTL.get(settings))\n+            .build();\n+        this.index = index;\n+        this.identityProvider = identityProvider;\n+    }\n+\n+    /**\n+     * Find a {@link SamlServiceProvider} by entity-id.\n+     *\n+     * @param listener Callback for the service provider object. Calls {@link ActionListener#onResponse} with a {@code null} value if the\n+     *                 service provider does not exist.\n+     */\n+    public void resolve(String entityId, ActionListener<SamlServiceProvider> listener) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzI5NDY0Ng==", "bodyText": "Are those placeholder values mostly?\nI feel the answer is \"the latter\", but asking either way: should we try to determine some sane numbers relevant to the number of SPs we estimate or leave this entirely up to the administrators?", "url": "https://github.com/elastic/elasticsearch/pull/52985#discussion_r387294646", "createdAt": "2020-03-03T21:08:55Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/SamlServiceProviderResolver.java", "diffHunk": "@@ -0,0 +1,156 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.idp.saml.sp;\n+\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.common.util.iterable.Iterables;\n+import org.elasticsearch.xpack.idp.privileges.ServiceProviderPrivileges;\n+import org.elasticsearch.xpack.idp.saml.idp.SamlIdentityProvider;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProviderIndex.DocumentSupplier;\n+import org.elasticsearch.xpack.idp.saml.sp.SamlServiceProviderIndex.DocumentVersion;\n+import org.joda.time.ReadableDuration;\n+import org.opensaml.security.x509.BasicX509Credential;\n+import org.opensaml.security.x509.X509Credential;\n+\n+import java.net.MalformedURLException;\n+import java.net.URL;\n+import java.util.Map;\n+import java.util.Optional;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+\n+public class SamlServiceProviderResolver {\n+\n+    private static final int CACHE_SIZE_DEFAULT = 1000;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY4Njc3MTE0", "url": "https://github.com/elastic/elasticsearch/pull/52985#pullrequestreview-368677114", "createdAt": "2020-03-04T10:49:17Z", "commit": {"oid": "422baf56a083c610d3f9770e0e9736956f0ee0cd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ae0373af3ea3930de4756db5636dfb9790d4311", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ae0373af3ea3930de4756db5636dfb9790d4311", "committedDate": "2020-03-05T06:21:03Z", "message": "Merge branch 'feature-internal-idp' into idp/sp-resolve"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a6b6f64ca45765183429bbf7d596dec1f64f96d", "author": {"user": {"login": "tvernum", "name": "Tim Vernum"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a6b6f64ca45765183429bbf7d596dec1f64f96d", "committedDate": "2020-03-05T07:29:13Z", "message": "Minor cleanup"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1878, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}