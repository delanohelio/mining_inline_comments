{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDIzNjIzNzU1", "number": 57187, "title": "Fix trimUnsafeCommits for indices created before 6.2", "bodyText": "If an upgraded node is restarted multiple times without flushing a new index commit, then we will wrongly exclude all commits from the starting commits. This bug is reproducible with these minimal steps: (1) create an empty index on 6.1.4 with translog retention disabled, (2) upgrade the cluster to 7.7.0, (3) restart the upgraded the cluster. The problem is that with the new translog policy can trim translog without having a new index commit, while the existing commit still refers to the previous translog generation.\nCloses #57091", "createdAt": "2020-05-27T05:51:12Z", "url": "https://github.com/elastic/elasticsearch/pull/57187", "merged": true, "mergeCommit": {"oid": "ba5a085d05b8a2e5e815879f60fa68cf3ad7fbdb"}, "closed": true, "closedAt": "2020-05-27T15:05:19Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABclSqz-AH2gAyNDIzNjIzNzU1OmM2MDA4MmIzOTMxZGNhY2JiMzE4Y2U2MjFhZDYzMDY2YjRiNThkOWE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclZ7MrAFqTQxOTI1MTQ1OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c60082b3931dcacbb318ce621ad63066b4b58d9a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c60082b3931dcacbb318ce621ad63066b4b58d9a", "committedDate": "2020-05-27T05:46:20Z", "message": "Fix trimUnsafeCommits for indices created before 6.2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4ODc3OTEx", "url": "https://github.com/elastic/elasticsearch/pull/57187#pullrequestreview-418877911", "createdAt": "2020-05-27T06:00:13Z", "commit": {"oid": "c60082b3931dcacbb318ce621ad63066b4b58d9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNjowMDoxM1rOGa6ftA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNjowMDoxM1rOGa6ftA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg3NDU0OA==", "bodyText": "The new test found this issue where the index is synced flush, but the global checkpoint is still unassigned.", "url": "https://github.com/elastic/elasticsearch/pull/57187#discussion_r430874548", "createdAt": "2020-05-27T06:00:13Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "diffHunk": "@@ -1411,14 +1411,16 @@ public long recoverLocallyUpToGlobalCheckpoint() {\n             logger.debug(\"skip local recovery as failed to find the safe commit\", e);\n             return UNASSIGNED_SEQ_NO;\n         }\n-        if (safeCommit.isPresent() == false) {\n-            logger.trace(\"skip local recovery as no safe commit found\");\n-            return UNASSIGNED_SEQ_NO;\n-        }\n-        assert safeCommit.get().localCheckpoint <= globalCheckpoint : safeCommit.get().localCheckpoint + \" > \" + globalCheckpoint;\n         try {\n             maybeCheckIndex(); // check index here and won't do it again if ops-based recovery occurs\n             recoveryState.setStage(RecoveryState.Stage.TRANSLOG);\n+            if (safeCommit.isPresent() == false) {\n+                assert globalCheckpoint == UNASSIGNED_SEQ_NO || indexSettings.getIndexVersionCreated().before(Version.V_6_2_0) :", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c60082b3931dcacbb318ce621ad63066b4b58d9a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE4OTA1MTQ5", "url": "https://github.com/elastic/elasticsearch/pull/57187#pullrequestreview-418905149", "createdAt": "2020-05-27T06:57:30Z", "commit": {"oid": "c60082b3931dcacbb318ce621ad63066b4b58d9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNjo1NzozMFrOGa70FQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QwNjo1NzozMFrOGa70FQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg5NjE0OQ==", "bodyText": "I'm not sure I understand what issue is being addressed here. How is moving this condition further down (after maybeCheckIndex) helping?\nIs the issue that we have not properly moved to the translog stage?", "url": "https://github.com/elastic/elasticsearch/pull/57187#discussion_r430896149", "createdAt": "2020-05-27T06:57:30Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/shard/IndexShard.java", "diffHunk": "@@ -1411,14 +1411,16 @@ public long recoverLocallyUpToGlobalCheckpoint() {\n             logger.debug(\"skip local recovery as failed to find the safe commit\", e);\n             return UNASSIGNED_SEQ_NO;\n         }\n-        if (safeCommit.isPresent() == false) {\n-            logger.trace(\"skip local recovery as no safe commit found\");\n-            return UNASSIGNED_SEQ_NO;\n-        }\n-        assert safeCommit.get().localCheckpoint <= globalCheckpoint : safeCommit.get().localCheckpoint + \" > \" + globalCheckpoint;\n         try {\n             maybeCheckIndex(); // check index here and won't do it again if ops-based recovery occurs\n             recoveryState.setStage(RecoveryState.Stage.TRANSLOG);\n+            if (safeCommit.isPresent() == false) {\n+                assert globalCheckpoint == UNASSIGNED_SEQ_NO || indexSettings.getIndexVersionCreated().before(Version.V_6_2_0) :", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDg3NDU0OA=="}, "originalCommit": {"oid": "c60082b3931dcacbb318ce621ad63066b4b58d9a"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5d40773c316deb0605a8c3672e67e166eba3f73", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5d40773c316deb0605a8c3672e67e166eba3f73", "committedDate": "2020-05-27T13:03:04Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21a302a47604cf18c701e194190dfd2b186976d4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/21a302a47604cf18c701e194190dfd2b186976d4", "committedDate": "2020-05-27T13:39:08Z", "message": "add test to full cluster restart"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MjUxNDU5", "url": "https://github.com/elastic/elasticsearch/pull/57187#pullrequestreview-419251459", "createdAt": "2020-05-27T14:13:35Z", "commit": {"oid": "21a302a47604cf18c701e194190dfd2b186976d4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4215, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}