{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM3NDI2ODEz", "number": 58390, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDowNzozMlrOEJFBCw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDoxNDo0NVrOEJFIyA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTU0ODI3OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/status/TransportSnapshotsStatusAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDowNzozMlrOGpbW6A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDozMDozNlrOGpb_7w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzAzMg==", "bodyText": "why create a copy here?", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093032", "createdAt": "2020-06-26T10:07:32Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/status/TransportSnapshotsStatusAction.java", "diffHunk": "@@ -199,7 +204,20 @@ private void buildResponse(SnapshotsInProgress snapshotsInProgress, SnapshotsSta\n                         default:\n                             throw new IllegalArgumentException(\"Unknown snapshot state \" + shardEntry.value.state());\n                     }\n-                    SnapshotIndexShardStatus shardStatus = new SnapshotIndexShardStatus(shardEntry.key, stage);\n+                    final SnapshotIndexShardStatus shardStatus;\n+                    if (stage == SnapshotIndexShardStage.DONE) {\n+                        // Shard snapshot completed successfully so we should be able to load the exact statistics for this\n+                        // shard from the repository already.\n+                        if (indexIdLookup == null) {\n+                            indexIdLookup = entry.indices().stream().collect(Collectors.toMap(IndexId::getName, Function.identity()));\n+                        }\n+                        final ShardId shardId = shardEntry.key;\n+                        shardStatus = new SnapshotIndexShardStatus(shardId, repositoriesService.repository(entry.repository())\n+                            .getShardSnapshotStatus(entry.snapshot().getSnapshotId(), indexIdLookup.get(shardId.getIndexName()),\n+                                shardId).asCopy());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjEwMzUzNQ==", "bodyText": "It's just how the constructor org.elasticsearch.action.admin.cluster.snapshots.status.SnapshotIndexShardStatus#SnapshotIndexShardStatus(org.elasticsearch.index.shard.ShardId, org.elasticsearch.index.snapshots.IndexShardSnapshotStatus.Copy) works. Copy is a different type here it's not an object clone or anything like that. We could definitely look into cleaning this up, there is no need for this complication with the way IndexShardSnapshotStatus works these days.", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446103535", "createdAt": "2020-06-26T10:30:36Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/status/TransportSnapshotsStatusAction.java", "diffHunk": "@@ -199,7 +204,20 @@ private void buildResponse(SnapshotsInProgress snapshotsInProgress, SnapshotsSta\n                         default:\n                             throw new IllegalArgumentException(\"Unknown snapshot state \" + shardEntry.value.state());\n                     }\n-                    SnapshotIndexShardStatus shardStatus = new SnapshotIndexShardStatus(shardEntry.key, stage);\n+                    final SnapshotIndexShardStatus shardStatus;\n+                    if (stage == SnapshotIndexShardStage.DONE) {\n+                        // Shard snapshot completed successfully so we should be able to load the exact statistics for this\n+                        // shard from the repository already.\n+                        if (indexIdLookup == null) {\n+                            indexIdLookup = entry.indices().stream().collect(Collectors.toMap(IndexId::getName, Function.identity()));\n+                        }\n+                        final ShardId shardId = shardEntry.key;\n+                        shardStatus = new SnapshotIndexShardStatus(shardId, repositoriesService.repository(entry.repository())\n+                            .getShardSnapshotStatus(entry.snapshot().getSnapshotId(), indexIdLookup.get(shardId.getIndexName()),\n+                                shardId).asCopy());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzAzMg=="}, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 34}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTU1MzIwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDowOToyNlrOGpbaTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDowOToyNlrOGpbaTA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5MzkwMA==", "bodyText": "space missing", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446093900", "createdAt": "2020-06-26T10:09:26Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -1796,6 +1796,10 @@ public void snapshotShard(Store store, MapperService mapperService, SnapshotId s\n                     }\n                 }\n             } else {\n+                for (BlobStoreIndexShardSnapshot.FileInfo fileInfo : filesFromSegmentInfos) {\n+                    indexTotalNumberOfFiles++;\n+                    indexTotalFileSize+= fileInfo.length();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc3OTU2ODA4OnYy", "diffSide": "RIGHT", "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDoxNDo0NVrOGpbj3Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNlQxMDoxNDo0NVrOGpbj3Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NjA5NjM0OQ==", "bodyText": "can you add some javadocs to this method to describe what exact situation is being tested here? There are a large number of steps in the test, and it might be easier to have a high-level  description of what's  going on  here.", "url": "https://github.com/elastic/elasticsearch/pull/58390#discussion_r446096349", "createdAt": "2020-06-26T10:14:45Z", "author": {"login": "ywelsch"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SnapshotStatusApisIT.java", "diffHunk": "@@ -189,4 +193,102 @@ public void testGetSnapshotsWithoutIndices() {\n         assertThat(found.snapshotId(), is(snapshotInfo.snapshotId()));\n         assertThat(found.state(), is(SnapshotState.SUCCESS));\n     }\n+\n+    public void testCorrectCountsForDoneShards() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dc805a747d34c22f5e34cfe8774dd5b40d6e5332"}, "originalPosition": 20}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1359, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}