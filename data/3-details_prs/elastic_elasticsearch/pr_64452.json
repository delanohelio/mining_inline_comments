{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEzMzMwOTk5", "number": 64452, "title": "Add validation of the SLM schedule frequency", "bodyText": "Closes #55450\nAdds the new slm.minimum_interval setting (default: 15 minutes) and validates that SLM policies are not more frequent than that minimum interval.\n/cc @original-brownbear", "createdAt": "2020-10-30T23:35:00Z", "url": "https://github.com/elastic/elasticsearch/pull/64452", "merged": true, "mergeCommit": {"oid": "43529e86dadf682c2fd2a0edbdbcfd0583d199bf"}, "closed": true, "closedAt": "2020-11-06T16:57:03Z", "author": {"login": "joegallo"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdY9jTLgH2gAyNTEzMzMwOTk5OmM3OWMzZDljNjBhYzU3ZDc5ZGEzMWYwZWFlZjQ4MjQ0Njg0NWNkNjE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdZ5vLsAFqTUyNTMxODM4MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c79c3d9c60ac57d79da31f0eaef482446845cd61", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/c79c3d9c60ac57d79da31f0eaef482446845cd61", "committedDate": "2020-11-03T18:34:11Z", "message": "Reorganize testValidation a bit\n\nmostly just whitespace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6f24be4afb667a7c213eae8378ae89e446c08c7", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6f24be4afb667a7c213eae8378ae89e446c08c7", "committedDate": "2020-11-03T18:34:54Z", "message": "Add a happy path test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb45477fe57441d48bd776d8a13921014ae8dad", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fb45477fe57441d48bd776d8a13921014ae8dad", "committedDate": "2020-11-03T18:35:41Z", "message": "Add the slm.minimum_interval setting\n\nIt represents the minimum allowable scheduled time from when one\nsnapshot starts to when the next snapshot following it will\nstart. Defaults to 15 minutes."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b7b737658cd33ee3595b80e1cbd02203fdc3a65", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b7b737658cd33ee3595b80e1cbd02203fdc3a65", "committedDate": "2020-11-03T18:50:31Z", "message": "Add a method for getting the interval of a policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1f321e0c89adc30b63c64fa7be3d98469bbebf90", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f321e0c89adc30b63c64fa7be3d98469bbebf90", "committedDate": "2020-11-03T18:51:05Z", "message": "Validate slm policies against the minimum interval"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4d4cfc2f620e830f77f575a1f2c45009e1d17b6", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4d4cfc2f620e830f77f575a1f2c45009e1d17b6", "committedDate": "2020-11-03T18:51:38Z", "message": "Make the tests pass again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "committedDate": "2020-11-03T18:51:38Z", "message": "Add a test of the minimum interval validation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ff5aeb57f3d2aa57e3b2620426a9663d17cfb655", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff5aeb57f3d2aa57e3b2620426a9663d17cfb655", "committedDate": "2020-10-30T23:31:47Z", "message": "Add validation of the SLM schedule frequency\n\nCurrently hardcoded to a expect at least five minutes between\nsnapshots."}, "afterCommit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/a931f11d2e01deb2d5e43e36da0a1290dd73dd2d", "committedDate": "2020-11-03T18:51:38Z", "message": "Add a test of the minimum interval validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTIyOTI1ODA4", "url": "https://github.com/elastic/elasticsearch/pull/64452#pullrequestreview-522925808", "createdAt": "2020-11-03T22:39:18Z", "commit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMjozOToxOFrOHtC_1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wM1QyMzowNTo1MFrOHtDoGA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5NzA3Ng==", "bodyText": "Since this is public, can you add javadocs and perhaps rather than returning a long we could take this opportunity and return a TimeValue so that we never have unit mismatch issues?", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r516997076", "createdAt": "2020-11-03T22:39:18Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/slm/SnapshotLifecyclePolicy.java", "diffHunk": "@@ -133,6 +133,17 @@ public long calculateNextExecution() {\n         return schedule.getNextValidTimeAfter(System.currentTimeMillis());\n     }\n \n+    public long calculateNextInterval() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNjk5Nzc3Ng==", "bodyText": "We should include what the limit for frequency is in the error message, and perhaps something like:\ninvalid schedule [*/1 * * * ?]: schedule would be too frequent, executing more frequently than [15m] interval\n\n(the wording doesn't have to be exactly that, just an example)", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r516997776", "createdAt": "2020-11-03T22:40:58Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotLifecycleService.java", "diffHunk": "@@ -234,6 +236,20 @@ public static void validateRepositoryExists(final String repository, final Clust\n             .orElseThrow(() -> new IllegalArgumentException(\"no such repository [\" + repository + \"]\"));\n     }\n \n+    /**\n+     * Validates that the interval between snapshots is not smaller than the minimum interval\n+     * (see {@link LifecycleSettings#SLM_MINIMUM_INTERVAL_SETTING})\n+     * @throws IllegalArgumentException if the interval is less than the minimum\n+     */\n+    public static void validateMinimumInterval(final SnapshotLifecyclePolicy lifecycle, final ClusterState state) {\n+        TimeValue minimumInterval = LifecycleSettings.SLM_MINIMUM_INTERVAL_SETTING.get(state.metadata().settings());\n+        long minimumIntervalMillis = minimumInterval.getMillis();\n+        long nextInterval = lifecycle.calculateNextInterval();\n+        if (nextInterval >= 0 && minimumIntervalMillis > 0 && nextInterval < minimumIntervalMillis) {\n+            throw new IllegalArgumentException(\"invalid schedule [\" + lifecycle.getSchedule() + \"]: too frequent\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNjQyMA==", "bodyText": "Since it's static (yay), can you add a unit test for this method to SnapshotLifecycleServiceTests?", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517006420", "createdAt": "2020-11-03T23:03:04Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/slm/SnapshotLifecycleService.java", "diffHunk": "@@ -234,6 +236,20 @@ public static void validateRepositoryExists(final String repository, final Clust\n             .orElseThrow(() -> new IllegalArgumentException(\"no such repository [\" + repository + \"]\"));\n     }\n \n+    /**\n+     * Validates that the interval between snapshots is not smaller than the minimum interval\n+     * (see {@link LifecycleSettings#SLM_MINIMUM_INTERVAL_SETTING})\n+     * @throws IllegalArgumentException if the interval is less than the minimum\n+     */\n+    public static void validateMinimumInterval(final SnapshotLifecyclePolicy lifecycle, final ClusterState state) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d"}, "originalPosition": 19}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxNzAwNzM4NA==", "bodyText": "We should catch the actual exception here with something like:\ncatch: /invalid schedule \\[0 * * * * ?\\]: too frequent/\n\n(with whatever the final message ends up being)", "url": "https://github.com/elastic/elasticsearch/pull/64452#discussion_r517007384", "createdAt": "2020-11-03T23:05:50Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/ilm/qa/rest/src/yamlRestTest/resources/rest-api-spec/test/ilm/11_basic_slm.yml", "diffHunk": "@@ -24,6 +24,20 @@ setup:\n           settings:\n             location: \"my-snaps\"\n \n+  - do:\n+      catch: bad_request", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a931f11d2e01deb2d5e43e36da0a1290dd73dd2d"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2798b78608197e770d3bbf02e2639076da30de1c", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/2798b78608197e770d3bbf02e2639076da30de1c", "committedDate": "2020-11-04T14:57:54Z", "message": "Make the error message more specific\n\nand check for that message in the test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4526dc70c1f13659fb0a0c5ef596c8a660280098", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/4526dc70c1f13659fb0a0c5ef596c8a660280098", "committedDate": "2020-11-04T15:50:24Z", "message": "Add tests for validateMinimumInterval"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f766e94552081052681296341e601cf64f1752fb", "author": {"user": {"login": "joegallo", "name": "Joe Gallo"}}, "url": "https://github.com/elastic/elasticsearch/commit/f766e94552081052681296341e601cf64f1752fb", "committedDate": "2020-11-04T17:03:41Z", "message": "Change return type and add a docstring"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0033bc74728f3d44d7083fea3456d513f0b84c16", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/0033bc74728f3d44d7083fea3456d513f0b84c16", "committedDate": "2020-11-04T17:19:16Z", "message": "Merge branch 'master' into validate-slm-schedule-frequency"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI1MzE4Mzgx", "url": "https://github.com/elastic/elasticsearch/pull/64452#pullrequestreview-525318381", "createdAt": "2020-11-06T16:41:28Z", "commit": {"oid": "0033bc74728f3d44d7083fea3456d513f0b84c16"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 899, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}