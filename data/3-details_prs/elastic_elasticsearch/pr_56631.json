{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODg2ODky", "number": 56631, "title": "EQL: Adds an ability to start an asynchronous EQL search", "bodyText": "Adds support for async searches to eql search API. This commit is limited to\nonly submitting search API requests and doesn't provide APIs to get results\nnor delete the results. These functions will be added in follow up PRs.\nRelates to #49638\nSupersedes #56147", "createdAt": "2020-05-12T18:10:06Z", "url": "https://github.com/elastic/elasticsearch/pull/56631", "merged": true, "mergeCommit": {"oid": "fcebd4fd02358ea9632242f113ca2b498ccb661a"}, "closed": true, "closedAt": "2020-05-13T13:50:16Z", "author": {"login": "imotov"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcgoRQzgH2gAyNDE2ODg2ODkyOmI3NzAwMjI5MTRkNWU4MjI2ZjYzNTAwMmNjNjZmMDk4YzUyNmNjMmQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcgqJgHgFqTQxMDM4OTI3Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d", "author": {"user": {"login": "imotov", "name": "Igor Motov"}}, "url": "https://github.com/elastic/elasticsearch/commit/b770022914d5e8226f635002cc66f098c526cc2d", "committedDate": "2020-05-12T18:06:43Z", "message": "EQL: Adds an ability to start an asynchronous EQL search\n\nAdds support for async searches to eql search API. This commit is limited to\nonly submitting search API requests and doesn't provide APIs to get results\nnor delete the results. These functions will be added in follow up PRs.\n\nRelates to #49638"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzU5Mjg4", "url": "https://github.com/elastic/elasticsearch/pull/56631#pullrequestreview-410359288", "createdAt": "2020-05-12T19:33:05Z", "commit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOTozMzowNVrOGUV2UQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQxOTozNDoxN1rOGUV6Kw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MjY3Mw==", "bodyText": "We should share this in core next to AsyncTaskMaintenanceService ?\nI also wonder who should be responsible to start the AsyncTaskMaintenanceService since we don't need to start it twice ?", "url": "https://github.com/elastic/elasticsearch/pull/56631#discussion_r423982673", "createdAt": "2020-05-12T19:33:05Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/EqlPlugin.java", "diffHunk": "@@ -46,6 +46,8 @@\n import java.util.function.Supplier;\n \n public class EqlPlugin extends Plugin implements ActionPlugin {\n+    // We are going to reuse the same index as normal async search until system indices are implemented\n+    public static final String INDEX = \".async-search\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMzk4MzY1OQ==", "bodyText": "You should use RestCancellableNodeClient in order to get the automatic cancellation if the user closes the rest channel ?", "url": "https://github.com/elastic/elasticsearch/pull/56631#discussion_r423983659", "createdAt": "2020-05-12T19:34:17Z", "author": {"login": "jimczi"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/RestEqlSearchAction.java", "diffHunk": "@@ -46,6 +46,14 @@ protected RestChannelConsumer prepareRequest(RestRequest request, NodeClient cli\n             eqlRequest = EqlSearchRequest.fromXContent(parser);\n             eqlRequest.indices(Strings.splitStringByCommaToArray(request.param(\"index\")));\n             eqlRequest.indicesOptions(IndicesOptions.fromRequest(request, eqlRequest.indicesOptions()));\n+            if (request.hasParam(\"wait_for_completion_timeout\")) {\n+                eqlRequest.waitForCompletionTimeout(\n+                    request.paramAsTime(\"wait_for_completion_timeout\", eqlRequest.waitForCompletionTimeout()));\n+            }\n+            if (request.hasParam(\"keep_alive\")) {\n+                eqlRequest.keepAlive(request.paramAsTime(\"keep_alive\", eqlRequest.keepAlive()));\n+            }\n+            eqlRequest.keepOnCompletion(request.paramAsBoolean(\"keep_on_completion\", eqlRequest.keepOnCompletion()));\n         }\n \n         return channel -> client.execute(EqlSearchAction.INSTANCE, eqlRequest, new RestResponseListener<>(channel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d"}, "originalPosition": 14}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEwMzg5Mjc2", "url": "https://github.com/elastic/elasticsearch/pull/56631#pullrequestreview-410389276", "createdAt": "2020-05-12T20:17:06Z", "commit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMDoxNzowNlrOGUXWow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xMlQyMDoxNzowNlrOGUXWow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNDAwNzMzMQ==", "bodyText": "PlanExecutor already has a Client and NamedWriteableRegistry injected - unless they are different, you could get them from there.", "url": "https://github.com/elastic/elasticsearch/pull/56631#discussion_r424007331", "createdAt": "2020-05-12T20:17:06Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/plugin/TransportEqlSearchAction.java", "diffHunk": "@@ -29,32 +34,72 @@\n import org.elasticsearch.xpack.eql.session.EqlConfiguration;\n import org.elasticsearch.xpack.eql.session.Results;\n \n+import java.io.IOException;\n import java.time.ZoneId;\n+import java.util.Map;\n \n import static org.elasticsearch.action.ActionListener.wrap;\n+import static org.elasticsearch.xpack.core.ClientHelper.ASYNC_SEARCH_ORIGIN;\n+\n+public class TransportEqlSearchAction extends HandledTransportAction<EqlSearchRequest, EqlSearchResponse>\n+    implements AsyncTaskManagementService.AsyncOperation<EqlSearchRequest, EqlSearchResponse, EqlSearchTask> {\n \n-public class TransportEqlSearchAction extends HandledTransportAction<EqlSearchRequest, EqlSearchResponse> {\n     private final SecurityContext securityContext;\n     private final ClusterService clusterService;\n     private final PlanExecutor planExecutor;\n+    private final ThreadPool threadPool;\n+    private final AsyncTaskManagementService<EqlSearchRequest, EqlSearchResponse, EqlSearchTask> asyncTaskManagementService;\n \n     @Inject\n     public TransportEqlSearchAction(Settings settings, ClusterService clusterService, TransportService transportService,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b770022914d5e8226f635002cc66f098c526cc2d"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 46, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}