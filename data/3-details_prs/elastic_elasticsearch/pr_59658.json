{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ5NjkzOTE2", "number": 59658, "title": "Mark all scripted field queries as expensive", "bodyText": "This will cause them to fail if you don't have permission to execute\nexpensive queries.\nRelates to #59332", "createdAt": "2020-07-15T19:43:24Z", "url": "https://github.com/elastic/elasticsearch/pull/59658", "merged": true, "mergeCommit": {"oid": "4ba86b1cb77e1478e5e197f07fbe5dfbe143844b"}, "closed": true, "closedAt": "2020-07-16T14:18:58Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc1P-cbgH2gAyNDQ5NjkzOTE2OjA0YjMyMGRlMzY3MWMwMGI1ODNiYzExOGM3ZTc0YmIwYTE2ZWQzN2I=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc1fJFhgH2gAyNDQ5NjkzOTE2OjAxYWE2OWQ2ODI3MDJmNjJlOGY3N2NlZTBlYzYyMzY1OTExNWRiNjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "04b320de3671c00b583bc118c7e74bb0a16ed37b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/04b320de3671c00b583bc118c7e74bb0a16ed37b", "committedDate": "2020-07-15T19:40:51Z", "message": "Mark all scripted field queries as expensive\n\nThis will cause them to fail if you don't have permission to execute\nexpensive queries."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ5MzA4MDAz", "url": "https://github.com/elastic/elasticsearch/pull/59658#pullrequestreview-449308003", "createdAt": "2020-07-15T20:32:09Z", "commit": {"oid": "04b320de3671c00b583bc118c7e74bb0a16ed37b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMDozMjoxMFrOGyOyaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNVQyMDozNDo0MFrOGyO3XA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyNDI2NQ==", "bodyText": "nit: use the constant from the mapper? content type I think it is called", "url": "https://github.com/elastic/elasticsearch/pull/59658#discussion_r455324265", "createdAt": "2020-07-15T20:32:10Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeKeywordMappedFieldType.java", "diffHunk": "@@ -77,8 +78,17 @@ public String typeName() {\n         return scriptFactory.newFactory(script.getParams(), context.lookup());\n     }\n \n+    private void checkAllowExpensiveQueries(QueryShardContext context) {\n+        if (context.allowExpensiveQueries() == false) {\n+            throw new IllegalArgumentException(\n+                \"queries cannot be executed against [script] fields while [\" + ALLOW_EXPENSIVE_QUERIES.getKey() + \"] is set to [false].\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b320de3671c00b583bc118c7e74bb0a16ed37b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyNTA2Ng==", "bodyText": "should we rather throw ElasticsearchException also, and why doesn't the context expose a check method instead that accepts for instance a message? :)", "url": "https://github.com/elastic/elasticsearch/pull/59658#discussion_r455325066", "createdAt": "2020-07-15T20:33:46Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeKeywordMappedFieldType.java", "diffHunk": "@@ -77,8 +78,17 @@ public String typeName() {\n         return scriptFactory.newFactory(script.getParams(), context.lookup());\n     }\n \n+    private void checkAllowExpensiveQueries(QueryShardContext context) {\n+        if (context.allowExpensiveQueries() == false) {\n+            throw new IllegalArgumentException(\n+                \"queries cannot be executed against [script] fields while [\" + ALLOW_EXPENSIVE_QUERIES.getKey() + \"] is set to [false].\"", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyNDI2NQ=="}, "originalCommit": {"oid": "04b320de3671c00b583bc118c7e74bb0a16ed37b"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NTMyNTUzMg==", "bodyText": "maybe one day we will a base class for runtime mapper field types that does this in one place.", "url": "https://github.com/elastic/elasticsearch/pull/59658#discussion_r455325532", "createdAt": "2020-07-15T20:34:40Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/RuntimeKeywordMappedFieldType.java", "diffHunk": "@@ -77,8 +78,17 @@ public String typeName() {\n         return scriptFactory.newFactory(script.getParams(), context.lookup());\n     }\n \n+    private void checkAllowExpensiveQueries(QueryShardContext context) {\n+        if (context.allowExpensiveQueries() == false) {\n+            throw new IllegalArgumentException(\n+                \"queries cannot be executed against [script] fields while [\" + ALLOW_EXPENSIVE_QUERIES.getKey() + \"] is set to [false].\"\n+            );\n+        }\n+    }\n+\n     @Override\n     public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "04b320de3671c00b583bc118c7e74bb0a16ed37b"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "01aa69d682702f62e8f77cee0ec623659115db66", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/01aa69d682702f62e8f77cee0ec623659115db66", "committedDate": "2020-07-16T13:21:03Z", "message": "Update exception type"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4404, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}