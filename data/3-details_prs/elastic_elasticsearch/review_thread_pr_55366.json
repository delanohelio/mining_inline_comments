{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA0ODczNTYx", "number": 55366, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo0ODozOVrODywX5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MzowNVrODywafw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ3OTQyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/IndicesAliasesRequestInterceptor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo0ODozOVrOGG-_Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo0ODozOVrOGG-_Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NjU5NA==", "bodyText": "The isSecurityEnabled is covered in the enclosing if", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409976594", "createdAt": "2020-04-17T03:48:39Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/IndicesAliasesRequestInterceptor.java", "diffHunk": "@@ -51,7 +51,7 @@ public void intercept(RequestInfo requestInfo, AuthorizationEngine authorization\n             final XPackLicenseState frozenLicenseState = licenseState.copyCurrentLicenseState();\n             final AuditTrail auditTrail = auditTrailService.get();\n             if (frozenLicenseState.isSecurityEnabled()) {\n-                if (frozenLicenseState.isDocumentAndFieldLevelSecurityAllowed()) {\n+                if (frozenLicenseState.isSecurityEnabled() && frozenLicenseState.isDocumentAndFieldLevelSecurityAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4MTQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/ResizeRequestInterceptor.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo0OTozOFrOGG_ANQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo0OTozOFrOGG_ANQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3Njg4NQ==", "bodyText": "isSecurityEnabled is covered in the enclosing if", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409976885", "createdAt": "2020-04-17T03:49:38Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/interceptor/ResizeRequestInterceptor.java", "diffHunk": "@@ -47,7 +47,7 @@ public void intercept(RequestInfo requestInfo, AuthorizationEngine authorization\n             final XPackLicenseState frozenLicenseState = licenseState.copyCurrentLicenseState();\n             final AuditTrail auditTrail = auditTrailService.get();\n             if (frozenLicenseState.isSecurityEnabled()) {\n-                if (frozenLicenseState.isDocumentAndFieldLevelSecurityAllowed()) {\n+                if (frozenLicenseState.isSecurityEnabled() && frozenLicenseState.isDocumentAndFieldLevelSecurityAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4MzE1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/CompositeRolesStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MTowMFrOGG_BTg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MTowMFrOGG_BTg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzE2Ng==", "bodyText": "I think in this context we should ignore isSecurityEnabled()\nIt's a check to disable roles with DLS/FLS is the license does not permit it. I think it confuses the code to explicitly include enabled in that check.", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409977166", "createdAt": "2020-04-17T03:51:00Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/CompositeRolesStore.java", "diffHunk": "@@ -165,7 +165,7 @@ public void roles(Set<String> roleNames, ActionListener<Role> roleActionListener\n                                     rolesRetrievalResult.getMissingRoles()));\n                         }\n                         final Set<RoleDescriptor> effectiveDescriptors;\n-                        if (licenseState.isDocumentAndFieldLevelSecurityAllowed()) {\n+                        if (licenseState.isSecurityEnabled() && licenseState.isDocumentAndFieldLevelSecurityAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4NDY2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/CompositeRolesStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjowNFrOGG_CQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjowNFrOGG_CQQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzQwOQ==", "bodyText": "As above, I'd skip the enabled check here. It's not clear why we'd prefer one behaviour over another if we ended up in deep in this method but security was disabled.", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409977409", "createdAt": "2020-04-17T03:52:04Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/CompositeRolesStore.java", "diffHunk": "@@ -319,8 +319,9 @@ private void roleDescriptors(Set<String> roleNames, ActionListener<RolesRetrieva\n \n     private void loadRoleDescriptorsAsync(Set<String> roleNames, ActionListener<RolesRetrievalResult> listener) {\n         final RolesRetrievalResult rolesResult = new RolesRetrievalResult();\n+        boolean allAllowed = licenseState.isSecurityEnabled() && licenseState.isCustomRoleProvidersAllowed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4NTE4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/FileRolesStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjoyOFrOGG_Ciw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MjoyOFrOGG_Ciw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzQ4Mw==", "bodyText": "As above, I'd skip enabled", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409977483", "createdAt": "2020-04-17T03:52:28Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/FileRolesStore.java", "diffHunk": "@@ -175,7 +175,7 @@ public static Path resolveFile(Environment env) {\n         if (Files.exists(path)) {\n             try {\n                 List<String> roleSegments = roleSegments(path);\n-                final boolean flsDlsLicensed = licenseState.isDocumentAndFieldLevelSecurityAllowed();\n+                final boolean flsDlsLicensed = licenseState.isSecurityEnabled() && licenseState.isDocumentAndFieldLevelSecurityAllowed();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4NTgwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/NativeRolesStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1Mjo0OVrOGG_C5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1Mjo0OVrOGG_C5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzU3NQ==", "bodyText": "As above.", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409977575", "createdAt": "2020-04-17T03:52:49Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/NativeRolesStore.java", "diffHunk": "@@ -188,7 +188,7 @@ public void onFailure(Exception e) {\n     }\n \n     public void putRole(final PutRoleRequest request, final RoleDescriptor role, final ActionListener<Boolean> listener) {\n-        if (licenseState.isDocumentAndFieldLevelSecurityAllowed()) {\n+        if (licenseState.isSecurityEnabled() && licenseState.isDocumentAndFieldLevelSecurityAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU0NTQ4NjA3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/NativeRolesStore.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MzowNVrOGG_DHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwMzo1MzowNVrOGG_DHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwOTk3NzYzMA==", "bodyText": "As above.", "url": "https://github.com/elastic/elasticsearch/pull/55366#discussion_r409977630", "createdAt": "2020-04-17T03:53:05Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/store/NativeRolesStore.java", "diffHunk": "@@ -369,7 +369,7 @@ static RoleDescriptor transformRole(String id, BytesReference sourceBytes, Logge\n             // we pass true as last parameter because we do not want to reject permissions if the field permissions\n             // are given in 2.x syntax\n             RoleDescriptor roleDescriptor = RoleDescriptor.parse(name, sourceBytes, true, XContentType.JSON);\n-            if (licenseState.isDocumentAndFieldLevelSecurityAllowed()) {\n+            if (licenseState.isSecurityEnabled() && licenseState.isDocumentAndFieldLevelSecurityAllowed()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6ecc6d4930ff2a69265b991ff6613ddb5bbb7618"}, "originalPosition": 14}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 988, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}