{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg0MjkzMzYx", "number": 53167, "title": "[Transform] add support for script in group_by", "bodyText": "add the possibility to base the group_by on the output of a script.\ncloses #43152\nExample usecase:\nPOST _transform/_preview\n{\n  \"source\": {\n    \"index\": [\n      \"kibana_sample_data_logs\"\n    ]\n  },\n  \"pivot\": {\n    \"group_by\": {\n      \"agent\": {\n        \"terms\": {\n          \"script\": {\n            \"source\": \"\"\"String agent = doc['agent.keyword'].value; \n            if (agent.contains(\"MSIE\")) { \n              return \"internet explorer\";\n            } else if (agent.contains(\"AppleWebKit\")) { \n              return \"safari\"; \n            } else if (agent.contains('Firefox')) { \n              return \"firefox\";\n            } else { return agent }\"\"\",\n            \"lang\": \"painless\"\n          }\n        }\n      }\n    },\n    \"aggregations\": {\n      \"200\": {\n        \"filter\": {\n          \"term\": {\n            \"response\": \"200\"\n          }\n        }\n      },\n      \"404\": {\n        \"filter\": {\n          \"term\": {\n            \"response\": \"404\"\n          }\n        }\n      },\n      \"503\": {\n        \"filter\": {\n          \"term\": {\n            \"response\": \"503\"\n          }\n        }\n      }\n    }\n  },\n  \"dest\": {\n    \"index\": \"pivot_logs\"\n  }\n}\n\noutputs\n{\n  \"preview\" : [\n    {\n      \"agent\" : \"firefox\",\n      \"200\" : 4931,\n      \"404\" : 259,\n      \"503\" : 172\n    },\n    {\n      \"agent\" : \"internet explorer\",\n      \"200\" : 3674,\n      \"404\" : 210,\n      \"503\" : 126\n    },\n    {\n      \"agent\" : \"safari\",\n      \"200\" : 4227,\n      \"404\" : 332,\n      \"503\" : 143\n    }\n  ],\n  \"mappings\" : {\n    \"properties\" : {\n      \"200\" : {\n        \"type\" : \"long\"\n      },\n      \"agent\" : {\n        \"type\" : \"keyword\"\n      },\n      \"404\" : {\n        \"type\" : \"long\"\n      },\n      \"503\" : {\n        \"type\" : \"long\"\n      }\n    }\n  }\n}", "createdAt": "2020-03-05T14:02:40Z", "url": "https://github.com/elastic/elasticsearch/pull/53167", "merged": true, "mergeCommit": {"oid": "e4f45db4c2669b9fd62ef56eab2d6c8f48f9aebe"}, "closed": true, "closedAt": "2020-03-09T08:59:35Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcKtfdggH2gAyMzg0MjkzMzYxOjMyYTJhZTdlZDZlNTVkYTI3ZjE5OGM1OGFiNjZlNWJkNDMyMWM0MTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcK_XrAAFqTM3MDI4OTUxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "32a2ae7ed6e55da27f198c58ab66e5bd4321c416", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/32a2ae7ed6e55da27f198c58ab66e5bd4321c416", "committedDate": "2020-03-05T15:45:25Z", "message": "add support for script in group_by"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc7db8bee0e69c558a3d2cac5a6717bec21eabe5", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc7db8bee0e69c558a3d2cac5a6717bec21eabe5", "committedDate": "2020-03-05T15:45:25Z", "message": "remove debug log"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c261c85725207f7ce78365de1d6466272c91ded7", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/c261c85725207f7ce78365de1d6466272c91ded7", "committedDate": "2020-03-05T15:43:27Z", "message": "remove debug log"}, "afterCommit": {"oid": "cc7db8bee0e69c558a3d2cac5a6717bec21eabe5", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc7db8bee0e69c558a3d2cac5a6717bec21eabe5", "committedDate": "2020-03-05T15:45:25Z", "message": "remove debug log"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzY5Njk0NDQ0", "url": "https://github.com/elastic/elasticsearch/pull/53167#pullrequestreview-369694444", "createdAt": "2020-03-05T15:58:46Z", "commit": {"oid": "cc7db8bee0e69c558a3d2cac5a6717bec21eabe5"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNTo1ODo0NlrOFyZYVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wNVQxNTo1ODo0NlrOFyZYVA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4ODM4ODk0OA==", "bodyText": "left over logging?", "url": "https://github.com/elastic/elasticsearch/pull/53167#discussion_r388388948", "createdAt": "2020-03-05T15:58:46Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/Pivot.java", "diffHunk": "@@ -128,6 +133,8 @@ public SearchRequest buildSearchRequest(SourceConfig sourceConfig, Map<String, O\n         sourceBuilder.query(queryBuilder);\n         searchRequest.source(sourceBuilder);\n         searchRequest.indicesOptions(IndicesOptions.LENIENT_EXPAND_OPEN);\n+\n+        logger.info(\"Running query {}\", searchRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cc7db8bee0e69c558a3d2cac5a6717bec21eabe5"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c34c928cd2144fdfa7b34abc4281705baeb8e7a", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c34c928cd2144fdfa7b34abc4281705baeb8e7a", "committedDate": "2020-03-06T07:20:48Z", "message": "turn info log into trace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcwMjg5NTEx", "url": "https://github.com/elastic/elasticsearch/pull/53167#pullrequestreview-370289511", "createdAt": "2020-03-06T12:35:12Z", "commit": {"oid": "7c34c928cd2144fdfa7b34abc4281705baeb8e7a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1797, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}