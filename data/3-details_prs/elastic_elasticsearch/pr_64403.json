{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTEyOTE0MzUy", "number": 64403, "title": "Change finalization of elasticsearch distribution", "bodyText": "Avoid to rely on afterEvaluate lifecycle hook in DistributionDownloadPlugin\nAllows us to define test cluster only in the task creation which can be later than afterevaluate which allows us to move tasks that rely on test clusters using task avoidance api.\nThis should result in test clusters only being defined when actually used in the build\nThis unblocks further progress on #56610", "createdAt": "2020-10-30T10:53:04Z", "url": "https://github.com/elastic/elasticsearch/pull/64403", "merged": true, "mergeCommit": {"oid": "65e760fc5805e6a276118dc35678056a92f884e2"}, "closed": true, "closedAt": "2020-11-11T09:31:33Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdXmZPFgBqjM5NDEwOTI5ODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbOA83AFqTUyNzUxMTk2Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "23d1cff0455ac1f2999e1a7d001f1df3d8f7a219", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/23d1cff0455ac1f2999e1a7d001f1df3d8f7a219", "committedDate": "2020-10-30T10:34:32Z", "message": "Change finalization of elasticsearch distribution\n\n- avoid to rely on afterEvaluate lifecycle hook\n- allows us to define test cluster only in the task creation which can be later than afterevaluate"}, "afterCommit": {"oid": "d8f5f87b05b14b0d11f1e24c273dc826391d564f", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8f5f87b05b14b0d11f1e24c273dc826391d564f", "committedDate": "2020-10-30T13:01:09Z", "message": "Fix multi node integ tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d8f5f87b05b14b0d11f1e24c273dc826391d564f", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8f5f87b05b14b0d11f1e24c273dc826391d564f", "committedDate": "2020-10-30T13:01:09Z", "message": "Fix multi node integ tests"}, "afterCommit": {"oid": "08cb078ab98a61b9b8d4b265a616d17b8ce06e59", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/08cb078ab98a61b9b8d4b265a616d17b8ce06e59", "committedDate": "2020-11-02T09:36:45Z", "message": "Minor polishing and cleanup"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "17306386c96b14ec04517d8f24b0a0b38a7a091a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/17306386c96b14ec04517d8f24b0a0b38a7a091a", "committedDate": "2020-11-02T13:47:05Z", "message": "Fix ElasticsearchDistribution#getFilepath"}, "afterCommit": {"oid": "b7675dc5caa69206915ea4da035cce3bfdc97f09", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7675dc5caa69206915ea4da035cce3bfdc97f09", "committedDate": "2020-11-03T07:40:41Z", "message": "Fix ElasticsearchDistribution#getFilepath"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "b7675dc5caa69206915ea4da035cce3bfdc97f09", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/b7675dc5caa69206915ea4da035cce3bfdc97f09", "committedDate": "2020-11-03T07:40:41Z", "message": "Fix ElasticsearchDistribution#getFilepath"}, "afterCommit": {"oid": "1f1b370280d6d1bf0d69063b02c1d1da2a78ca9a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/1f1b370280d6d1bf0d69063b02c1d1da2a78ca9a", "committedDate": "2020-11-04T13:16:37Z", "message": "Fix ElasticsearchDistribution#getFilepath"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI0NDE3Mjgw", "url": "https://github.com/elastic/elasticsearch/pull/64403#pullrequestreview-524417280", "createdAt": "2020-11-05T16:04:57Z", "commit": {"oid": "587c796a0270d06428cc8cbbb0882f67cf5c0059"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNDo1N1rOHuKdqQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNVQxNjowNDo1N1rOHuKdqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODE2Nzk3Nw==", "bodyText": "One scenario we wanna support with this PR", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r518167977", "createdAt": "2020-11-05T16:04:57Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/TestClustersPluginFuncTest.groovy", "diffHunk": "@@ -75,6 +75,31 @@ class TestClustersPluginFuncTest extends AbstractGradleFuncTest {\n         assertNoCustomDistro('myCluster')\n     }\n \n+    def \"can declare test cluster in lazy evaluated task configuration block\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "587c796a0270d06428cc8cbbb0882f67cf5c0059"}, "originalPosition": 4}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "587c796a0270d06428cc8cbbb0882f67cf5c0059", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/587c796a0270d06428cc8cbbb0882f67cf5c0059", "committedDate": "2020-11-04T15:50:31Z", "message": "Allow to declare an explicit dependency on distribution archive"}, "afterCommit": {"oid": "999d39c4a369089012433a913d02b793425a8910", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/999d39c4a369089012433a913d02b793425a8910", "committedDate": "2020-11-05T16:06:50Z", "message": "Change finalization of elasticsearch distribution\n\n- avoid to rely on afterEvaluate lifecycle hook\n- allows us to define test cluster only in the task creation which can be later than afterevaluate"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c2a6997538513c9499d86f9b192adff3718257f3", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2a6997538513c9499d86f9b192adff3718257f3", "committedDate": "2020-11-05T17:04:32Z", "message": "Minor polishing"}, "afterCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d821451e6553473422fc2e258848e4c55aa7fbc1", "committedDate": "2020-11-09T09:54:01Z", "message": "Minor polishing"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI2NjIzNjA3", "url": "https://github.com/elastic/elasticsearch/pull/64403#pullrequestreview-526623607", "createdAt": "2020-11-09T20:21:42Z", "commit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMDoyMTo0MlrOHwAKXw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wOVQyMjowOToxN1rOHwDkwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDA5NjM1MQ==", "bodyText": "Do we actually ever want to do this? Seems a bit fragile and generally task configure should be as side-effect free as possible no? Is there any real significant overhead in simply declaring a cluster that would be worthwhile avoiding if the cluster is never subsequently started?", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r520096351", "createdAt": "2020-11-09T20:21:42Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/integTest/groovy/org/elasticsearch/gradle/TestClustersPluginFuncTest.groovy", "diffHunk": "@@ -75,6 +75,31 @@ class TestClustersPluginFuncTest extends AbstractGradleFuncTest {\n         assertNoCustomDistro('myCluster')\n     }\n \n+    def \"can declare test cluster in lazy evaluated task configuration block\"() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE0OTEwNw==", "bodyText": "This doesn't seem right. In both scenarios we return what is effectively an empty set of dependencies. If docker is available, or we don't consider this to be optional, we should return the configuration's build dependencies.", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r520149107", "createdAt": "2020-11-09T22:02:51Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -217,22 +238,36 @@ public Configuration getExtracted() {\n \n     @Override\n     public TaskDependency getBuildDependencies() {\n-        // For non-required Docker distributions, skip building the distribution is Docker is unavailable\n-        if (isDocker() && getFailIfUnavailable() == false && dockerSupport.get().getDockerAvailability().isAvailable == false) {\n-            return task -> Collections.emptySet();\n-        }\n+        Optional<TaskDependency> dockerBuildDependencies = dockerBuildDependencies();\n+        return dockerBuildDependencies.orElseGet(() -> {\n+            maybeFreeze();\n+            return getType().shouldExtract() ? extracted.getBuildDependencies() : configuration.getBuildDependencies();\n+        });\n+    }\n \n-        return configuration.getBuildDependencies();\n+    public TaskDependency getArchiveBuildDependencies() {\n+        Optional<TaskDependency> dockerBuildDependencies = dockerBuildDependencies();\n+        return dockerBuildDependencies.orElseGet(() -> {\n+            maybeFreeze();\n+            return configuration.getBuildDependencies();\n+        });\n+    }\n+\n+    private Optional<TaskDependency> dockerBuildDependencies() {\n+        // For non-required Docker distributions, skip building the distribution is Docker is unavailable\n+        return (isDocker() && getFailIfUnavailable() == false && dockerSupport.get().getDockerAvailability().isAvailable == false)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "originalPosition": 84}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDA3Mw==", "bodyText": "I don't think either of these methods should be public. If I need to wire up dependencies I should depend on either the Distribution itself or getExtracted depending on what I'm using and then just rely on implicit dependencies.", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r520150073", "createdAt": "2020-11-09T22:04:51Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -217,22 +238,36 @@ public Configuration getExtracted() {\n \n     @Override\n     public TaskDependency getBuildDependencies() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MDkwMg==", "bodyText": "Couldn't this just be Action<Distribution>? I don't see where we ever actually use the returned result of this function.", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r520150902", "createdAt": "2020-11-09T22:06:30Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/ElasticsearchDistribution.java", "diffHunk": "@@ -103,13 +105,16 @@ public String toString() {\n     private final Property<Boolean> bundledJdk;\n     private final Property<Boolean> failIfUnavailable;\n     private final Configuration extracted;\n+    private Function<ElasticsearchDistribution, ElasticsearchDistribution> distributionFinalizer;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDE1MjI1Nw==", "bodyText": "Looking at this more, now that we make the default behavior to return the extracted archive, perhaps instead of exposing a getExtracted() method on ElasticsearchDistribution we should replace that with getArchive()?", "url": "https://github.com/elastic/elasticsearch/pull/64403#discussion_r520152257", "createdAt": "2020-11-09T22:09:17Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -113,7 +113,8 @@ public void apply(Project project) {\n         for (ElasticsearchDistribution distribution : testDistributions) {\n             String taskname = destructiveDistroTestTaskName(distribution);\n             TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");\n-            depsTask.configure(t -> t.dependsOn(distribution, examplePlugin, quotaAwareFsPlugin));\n+            // explicitly depend on the archive not on the implicit extracted distribution\n+            depsTask.configure(t -> t.dependsOn(distribution.getArchiveBuildDependencies(), examplePlugin, quotaAwareFsPlugin));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d821451e6553473422fc2e258848e4c55aa7fbc1"}, "originalPosition": 6}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "78e5faba5aac797195de63518dc5f17243640ba2", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/78e5faba5aac797195de63518dc5f17243640ba2", "committedDate": "2020-11-10T18:24:01Z", "message": "Change finalization of elasticsearch distribution\n\n- avoid to rely on afterEvaluate lifecycle hook\n- allows us to define test cluster only in the task creation which can be later than afterevaluate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60b4e0de96dc70b645464fa1550b4fc3fea7a0c3", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/60b4e0de96dc70b645464fa1550b4fc3fea7a0c3", "committedDate": "2020-11-10T18:24:01Z", "message": "Minor polishing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb199cfe43f92d3b7e528af76af615d8cf7ede15", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb199cfe43f92d3b7e528af76af615d8cf7ede15", "committedDate": "2020-11-10T18:24:02Z", "message": "Address review feedback"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7a8f58e4a8cfd26e22c806b210cbac35389b4f05", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a8f58e4a8cfd26e22c806b210cbac35389b4f05", "committedDate": "2020-11-10T14:18:08Z", "message": "Address review feedback"}, "afterCommit": {"oid": "bb199cfe43f92d3b7e528af76af615d8cf7ede15", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb199cfe43f92d3b7e528af76af615d8cf7ede15", "committedDate": "2020-11-10T18:24:02Z", "message": "Address review feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NTExOTY2", "url": "https://github.com/elastic/elasticsearch/pull/64403#pullrequestreview-527511966", "createdAt": "2020-11-10T18:52:54Z", "commit": {"oid": "bb199cfe43f92d3b7e528af76af615d8cf7ede15"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 860, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}