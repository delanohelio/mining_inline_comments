{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NzE4Mjky", "number": 53298, "title": "ValuesSource Refactor: move histo VSType into XPack module", "bodyText": "Whew!  Finally :)\n\nIntroduces a new API (getBareAggregatorRegistrar()) which allows plugins to register aggregations against existing agg definitions defined in Core.  Naming TBD, please suggest something better! :)\nThis moves the histogram VSType over to XPack where it belongs. getHistogramValues() still remains as a Core concept\nMoves the histo-specific bits over to xpack (e.g. the actual aggregator logic).  This requires extra boilerplate since we need to create a new \"Analytics\" Percentile/Rank aggregators to deal with the histo field.  Doubly-so since percentiles/ranks are extra boiler-plate'y... should be much lighter for other aggs", "createdAt": "2020-03-09T17:25:46Z", "url": "https://github.com/elastic/elasticsearch/pull/53298", "merged": true, "mergeCommit": {"oid": "ba2210e7f2e2bcabba9208446ff94d62dd449bd4"}, "closed": true, "closedAt": "2020-03-12T19:52:56Z", "author": {"login": "polyfractal"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcMAYzgAH2gAyMzg1NzE4MjkyOmFhODY1Mjk2MTM2ZTcwZjVkY2Y5NjgxNjQyYzU2ZjBjOTM4YWQzMmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcNAQHZAH2gAyMzg1NzE4MjkyOjdkNTExYzQ2MDBjZTQ1YTUwNGRjY2M0MzIyMDgwN2JmMjcyODc3NTA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa865296136e70f5dcf9681642c56f0c938ad32f", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa865296136e70f5dcf9681642c56f0c938ad32f", "committedDate": "2020-03-09T16:20:16Z", "message": "Move histogram field to XPack"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f6ef81920bdbe11e1a64ad06556d9a98db7b9cac", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/f6ef81920bdbe11e1a64ad06556d9a98db7b9cac", "committedDate": "2020-03-09T17:14:27Z", "message": "Merge branch 'feature/extensible-values-source' into vs_move_histo_vstype"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMzgzMzQ4", "url": "https://github.com/elastic/elasticsearch/pull/53298#pullrequestreview-371383348", "createdAt": "2020-03-09T17:27:46Z", "commit": {"oid": "f6ef81920bdbe11e1a64ad06556d9a98db7b9cac"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyNzo0N1rOFzyPpg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNzoyNzo0N1rOFzyPpg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NDkwMg==", "bodyText": "Unfortunately I think we can't get around this if/else situation like we did in Core.  We could \"wrap\" the core percentilesConfig with an xpack config... but internally it'd do essentially the same if/else to delegate to the appropriate agg.\nI don't see us extending this code anywhere further so the extra wrapper didn't seem useful.  If we ever decide to build more xpack percentiles/ranks stuff it might make sense though.", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r389844902", "createdAt": "2020-03-09T17:27:47Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AnalyticsPercentilesAggregatorFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import org.elasticsearch.search.aggregations.metrics.PercentileRanksAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesConfig;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesMethod;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceRegistry;\n+import org.elasticsearch.xpack.analytics.aggregations.support.HistogramValuesSourceType;\n+\n+public class AnalyticsPercentilesAggregatorFactory {\n+    public static void registerPercentilesAggregator(ValuesSourceRegistry valuesSourceRegistry) {\n+        valuesSourceRegistry.register(PercentilesAggregationBuilder.NAME,\n+            HistogramValuesSourceType.HISTOGRAM,\n+            (AnalyticsPercentilesAggregatorSupplier) (name, valuesSource, context, parent, percents, percentilesConfig, keyed,\n+                                                      formatter, pipelineAggregators, metaData) -> {\n+\n+                if (percentilesConfig.getMethod().equals(PercentilesMethod.TDIGEST)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f6ef81920bdbe11e1a64ad06556d9a98db7b9cac"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d8f32a71841e6d17d2a792bf8e4bb03b635c6a30", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/d8f32a71841e6d17d2a792bf8e4bb03b635c6a30", "committedDate": "2020-03-09T17:36:32Z", "message": "Add supported type tests\n\nThis got lost during git merge fiddling somehow"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f054043abe6d6cfd6dd4dafd1b609fa16fbd3c5", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f054043abe6d6cfd6dd4dafd1b609fa16fbd3c5", "committedDate": "2020-03-09T17:52:46Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/29fe8989c7059776de26f69d4702c6a9c0cd2196", "committedDate": "2020-03-09T21:48:10Z", "message": "Merge branch 'feature/extensible-values-source' into vs_move_histo_vstype"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTYwMTU2", "url": "https://github.com/elastic/elasticsearch/pull/53298#pullrequestreview-372160156", "createdAt": "2020-03-10T17:16:41Z", "commit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "state": "APPROVED", "comments": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxNjo0MVrOF0Y8AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxODowNzo0NVrOF0a9hg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3ODg0OA==", "bodyText": "Just double checking - It's okay to remove this here because nothing legacy (multi, array, top metrics, composite) supports histogram fields anyway.", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390478848", "createdAt": "2020-03-10T17:16:41Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -200,8 +199,6 @@ private static ValuesSourceType getLegacyMapping(\n             return CoreValuesSourceType.GEOPOINT;\n         } else if (fieldType instanceof RangeFieldMapper.RangeFieldType) {\n             return CoreValuesSourceType.RANGE;\n-        } else if (indexFieldData instanceof IndexHistogramFieldData) {\n-            return CoreValuesSourceType.HISTOGRAM;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ4NDU0MQ==", "bodyText": "the nittiest of nits: multi-line comments should use /* notation", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390484541", "createdAt": "2020-03-10T17:25:21Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AbstractHistoBackedHDRPercentilesAggregator.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import org.HdrHistogram.DoubleHistogram;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.search.ScoreMode;\n+import org.elasticsearch.common.lease.Releasables;\n+import org.elasticsearch.common.util.ArrayUtils;\n+import org.elasticsearch.common.util.BigArrays;\n+import org.elasticsearch.common.util.ObjectArray;\n+import org.elasticsearch.index.fielddata.HistogramValue;\n+import org.elasticsearch.index.fielddata.HistogramValues;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.elasticsearch.search.aggregations.LeafBucketCollectorBase;\n+import org.elasticsearch.search.aggregations.metrics.NumericMetricsAggregator;\n+import org.elasticsearch.search.aggregations.pipeline.PipelineAggregator;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.xpack.analytics.aggregations.support.HistogramValuesSource;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+abstract class AbstractHistoBackedHDRPercentilesAggregator extends NumericMetricsAggregator.MultiValue {\n+\n+    private static int indexOfKey(double[] keys, double key) {\n+        return ArrayUtils.binarySearch(keys, key, 0.001);\n+    }\n+\n+    protected final double[] keys;\n+    protected final ValuesSource valuesSource;\n+    protected final DocValueFormat format;\n+    protected ObjectArray<DoubleHistogram> states;\n+    protected final int numberOfSignificantValueDigits;\n+    protected final boolean keyed;\n+\n+    AbstractHistoBackedHDRPercentilesAggregator(String name, ValuesSource valuesSource, SearchContext context, Aggregator parent,\n+                                     double[] keys, int numberOfSignificantValueDigits, boolean keyed, DocValueFormat formatter,\n+                                     List<PipelineAggregator> pipelineAggregators, Map<String, Object> metaData) throws IOException {\n+        super(name, context, parent, pipelineAggregators, metaData);\n+        this.valuesSource = valuesSource;\n+        this.keyed = keyed;\n+        this.format = formatter;\n+        this.states = context.bigArrays().newObjectArray(1);\n+        this.keys = keys;\n+        this.numberOfSignificantValueDigits = numberOfSignificantValueDigits;\n+    }\n+\n+    @Override\n+    public ScoreMode scoreMode() {\n+        return valuesSource != null && valuesSource.needsScores() ? ScoreMode.COMPLETE : ScoreMode.COMPLETE_NO_SCORES;\n+    }\n+\n+    @Override\n+    public LeafBucketCollector getLeafCollector(LeafReaderContext ctx,\n+                                                final LeafBucketCollector sub) throws IOException {\n+        if (valuesSource == null) {\n+            return LeafBucketCollector.NO_OP_COLLECTOR;\n+        }\n+        final BigArrays bigArrays = context.bigArrays();\n+        assert valuesSource instanceof HistogramValuesSource.Histogram;\n+        final HistogramValues values = ((HistogramValuesSource.Histogram)valuesSource).getHistogramValues(ctx);\n+\n+        return new LeafBucketCollectorBase(sub, values) {\n+            @Override\n+            public void collect(int doc, long bucket) throws IOException {\n+                DoubleHistogram state = getExistingOrNewHistogram(bigArrays, bucket);\n+                if (values.advanceExact(doc)) {\n+                    final HistogramValue sketch = values.histogram();\n+                    while (sketch.next()) {\n+                        state.recordValueWithCount(sketch.value(), sketch.count());\n+                    }\n+                }\n+            }\n+        };\n+    }\n+\n+    private DoubleHistogram getExistingOrNewHistogram(final BigArrays bigArrays, long bucket) {\n+        states = bigArrays.grow(states, bucket + 1);\n+        DoubleHistogram state = states.get(bucket);\n+        if (state == null) {\n+            state = new DoubleHistogram(numberOfSignificantValueDigits);\n+            // Set the histogram to autosize so it can resize itself as\n+            // the data range increases. Resize operations should be\n+            // rare as the histogram buckets are exponential (on the top\n+            // level). In the future we could expose the range as an\n+            // option on the request so the histogram can be fixed at\n+            // initialisation and doesn't need resizing.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ5MDkwOQ==", "bodyText": "Just curious, why did you choose an assert here instead of an if/throw check?  And do you think we should do that for other places we cast ValuesSources?", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390490909", "createdAt": "2020-03-10T17:34:58Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AbstractHistoBackedHDRPercentilesAggregator.java", "diffHunk": "@@ -0,0 +1,121 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import org.HdrHistogram.DoubleHistogram;\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.search.ScoreMode;\n+import org.elasticsearch.common.lease.Releasables;\n+import org.elasticsearch.common.util.ArrayUtils;\n+import org.elasticsearch.common.util.BigArrays;\n+import org.elasticsearch.common.util.ObjectArray;\n+import org.elasticsearch.index.fielddata.HistogramValue;\n+import org.elasticsearch.index.fielddata.HistogramValues;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.LeafBucketCollector;\n+import org.elasticsearch.search.aggregations.LeafBucketCollectorBase;\n+import org.elasticsearch.search.aggregations.metrics.NumericMetricsAggregator;\n+import org.elasticsearch.search.aggregations.pipeline.PipelineAggregator;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.internal.SearchContext;\n+import org.elasticsearch.xpack.analytics.aggregations.support.HistogramValuesSource;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+abstract class AbstractHistoBackedHDRPercentilesAggregator extends NumericMetricsAggregator.MultiValue {\n+\n+    private static int indexOfKey(double[] keys, double key) {\n+        return ArrayUtils.binarySearch(keys, key, 0.001);\n+    }\n+\n+    protected final double[] keys;\n+    protected final ValuesSource valuesSource;\n+    protected final DocValueFormat format;\n+    protected ObjectArray<DoubleHistogram> states;\n+    protected final int numberOfSignificantValueDigits;\n+    protected final boolean keyed;\n+\n+    AbstractHistoBackedHDRPercentilesAggregator(String name, ValuesSource valuesSource, SearchContext context, Aggregator parent,\n+                                     double[] keys, int numberOfSignificantValueDigits, boolean keyed, DocValueFormat formatter,\n+                                     List<PipelineAggregator> pipelineAggregators, Map<String, Object> metaData) throws IOException {\n+        super(name, context, parent, pipelineAggregators, metaData);\n+        this.valuesSource = valuesSource;\n+        this.keyed = keyed;\n+        this.format = formatter;\n+        this.states = context.bigArrays().newObjectArray(1);\n+        this.keys = keys;\n+        this.numberOfSignificantValueDigits = numberOfSignificantValueDigits;\n+    }\n+\n+    @Override\n+    public ScoreMode scoreMode() {\n+        return valuesSource != null && valuesSource.needsScores() ? ScoreMode.COMPLETE : ScoreMode.COMPLETE_NO_SCORES;\n+    }\n+\n+    @Override\n+    public LeafBucketCollector getLeafCollector(LeafReaderContext ctx,\n+                                                final LeafBucketCollector sub) throws IOException {\n+        if (valuesSource == null) {\n+            return LeafBucketCollector.NO_OP_COLLECTOR;\n+        }\n+        final BigArrays bigArrays = context.bigArrays();\n+        assert valuesSource instanceof HistogramValuesSource.Histogram;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwNTE3OQ==", "bodyText": "That seems fine.   I'm a lot more okay with doing this type of thing when it's serving to maintain isolation between components.", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390505179", "createdAt": "2020-03-10T17:57:04Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AnalyticsPercentilesAggregatorFactory.java", "diffHunk": "@@ -0,0 +1,60 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import org.elasticsearch.search.aggregations.metrics.PercentileRanksAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesAggregationBuilder;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesConfig;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesMethod;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceRegistry;\n+import org.elasticsearch.xpack.analytics.aggregations.support.HistogramValuesSourceType;\n+\n+public class AnalyticsPercentilesAggregatorFactory {\n+    public static void registerPercentilesAggregator(ValuesSourceRegistry valuesSourceRegistry) {\n+        valuesSourceRegistry.register(PercentilesAggregationBuilder.NAME,\n+            HistogramValuesSourceType.HISTOGRAM,\n+            (AnalyticsPercentilesAggregatorSupplier) (name, valuesSource, context, parent, percents, percentilesConfig, keyed,\n+                                                      formatter, pipelineAggregators, metaData) -> {\n+\n+                if (percentilesConfig.getMethod().equals(PercentilesMethod.TDIGEST)) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTg0NDkwMg=="}, "originalCommit": {"oid": "f6ef81920bdbe11e1a64ad06556d9a98db7b9cac"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUwODY4NA==", "bodyText": "Why do we need a new AggregatorSupplier here? Shouldn't we just implement the existing one from core?", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390508684", "createdAt": "2020-03-10T18:02:40Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/metrics/AnalyticsPercentilesAggregatorSupplier.java", "diffHunk": "@@ -0,0 +1,32 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.analytics.aggregations.metrics;\n+\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.Aggregator;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesAggregatorSupplier;\n+import org.elasticsearch.search.aggregations.metrics.PercentilesConfig;\n+import org.elasticsearch.search.aggregations.pipeline.PipelineAggregator;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.internal.SearchContext;\n+\n+import java.io.IOException;\n+import java.util.List;\n+import java.util.Map;\n+\n+public interface AnalyticsPercentilesAggregatorSupplier extends PercentilesAggregatorSupplier {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxMDg2Mw==", "bodyText": "Ugh, this is such a mess.  This is all going away in #53198, thank goodness.  I'll try to get that merged today.", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390510863", "createdAt": "2020-03-10T18:05:54Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/support/HistogramValuesSourceType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.analytics.aggregations.support;\n+\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexHistogramFieldData;\n+import org.elasticsearch.script.AggregationScript;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.AggregationExecutionException;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.FieldContext;\n+import org.elasticsearch.search.aggregations.support.ValueType;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+\n+import java.util.Locale;\n+import java.util.function.LongSupplier;\n+\n+public enum HistogramValuesSourceType implements ValuesSourceType {\n+    HISTOGRAM() {\n+        @Override\n+        public ValuesSource getEmpty() {\n+            // TODO: Is this the correct exception type here?\n+            throw new IllegalArgumentException(\"Can't deal with unmapped HistogramValuesSource type \" + this.value());\n+        }\n+\n+        @Override\n+        public ValuesSource getScript(AggregationScript.LeafFactory script, ValueType scriptValueType) {\n+            throw new AggregationExecutionException(\"value source of type [\" + this.value() + \"] is not supported by scripts\");\n+        }\n+\n+        @Override\n+        public ValuesSource getField(FieldContext fieldContext, AggregationScript.LeafFactory script) {\n+            final IndexFieldData<?> indexFieldData = fieldContext.indexFieldData();\n+\n+            if (!(indexFieldData instanceof IndexHistogramFieldData)) {\n+                throw new IllegalArgumentException(\"Expected histogram type on field [\" + fieldContext.field() +\n+                    \"], but got [\" + fieldContext.fieldType().typeName() + \"]\");\n+            }\n+            return new HistogramValuesSource.Histogram.Fielddata((IndexHistogramFieldData) indexFieldData);\n+        }\n+\n+        @Override\n+        public ValuesSource replaceMissing(ValuesSource valuesSource, Object rawMissing, DocValueFormat docValueFormat, LongSupplier now) {\n+            throw new IllegalArgumentException(\"Can't apply missing values on a \" + valuesSource.getClass());\n+        }\n+    };\n+\n+\n+    @Override\n+    public boolean isCastableTo(ValuesSourceType valuesSourceType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDUxMjAwNg==", "bodyText": "+1 for using an enum here.  I'm actually about to update the documentation on ValuesSourceType to recommend this pattern.  That said, I'd suggest AnalyticsValuesSourceType as the name, in case we want to add another here later.", "url": "https://github.com/elastic/elasticsearch/pull/53298#discussion_r390512006", "createdAt": "2020-03-10T18:07:45Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/aggregations/support/HistogramValuesSourceType.java", "diffHunk": "@@ -0,0 +1,71 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+package org.elasticsearch.xpack.analytics.aggregations.support;\n+\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexHistogramFieldData;\n+import org.elasticsearch.script.AggregationScript;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.aggregations.AggregationExecutionException;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.FieldContext;\n+import org.elasticsearch.search.aggregations.support.ValueType;\n+import org.elasticsearch.search.aggregations.support.ValuesSource;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+\n+import java.util.Locale;\n+import java.util.function.LongSupplier;\n+\n+public enum HistogramValuesSourceType implements ValuesSourceType {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "29fe8989c7059776de26f69d4702c6a9c0cd2196"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d144aa500b62d5793f95327d234f4e67c1bd391b", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/d144aa500b62d5793f95327d234f4e67c1bd391b", "committedDate": "2020-03-11T18:40:51Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "665566f696606f9397f8dd0316729af3d404a030", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/665566f696606f9397f8dd0316729af3d404a030", "committedDate": "2020-03-12T18:36:11Z", "message": "Merge branch 'feature/extensible-values-source' into vs_move_histo_vstype"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d511c4600ce45a504dccc43220807bf27287750", "author": {"user": {"login": "polyfractal", "name": "Zachary Tong"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d511c4600ce45a504dccc43220807bf27287750", "committedDate": "2020-03-12T18:44:42Z", "message": "Remove outdated CoreValuesSourceType.HISTOGRAM"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1660, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}