{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1ODA1MDQ4", "number": 58244, "title": "Do not wrap CacheFile reentrant r/w locks with ReleasableLock", "bodyText": "Today the read/write locks used internally by CacheFile object are wrapped into a ReleasableLock. This is not strictly required and also prevents usage of the tryLock() methods which we would like to use for early releasing of read operations (#58164).", "createdAt": "2020-06-17T12:01:59Z", "url": "https://github.com/elastic/elasticsearch/pull/58244", "merged": true, "mergeCommit": {"oid": "ce85e28dff7b912ba6724323f547373aec2c59ae"}, "closed": true, "closedAt": "2020-06-18T09:00:34Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcsIjfEgH2gAyNDM1ODA1MDQ4OjQ1YWYxYjA0MTg1NGExMDYyYjAyMWIxMDUwZmEwMDA2ZDM3NzA4ZTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcsMYBdgH2gAyNDM1ODA1MDQ4OmE1ZDVjNWFiZmM1M2IxMDFkZmVjZjJiMWUwNDA2ZTNmODM4OTYwZTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/45af1b041854a1062b021b1050fa0006d37708e0", "committedDate": "2020-06-17T11:56:45Z", "message": "Do not wrap CacheFile reentrant rw locks with ReleasableLock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyMzMyMDI1", "url": "https://github.com/elastic/elasticsearch/pull/58244#pullrequestreview-432332025", "createdAt": "2020-06-17T12:05:02Z", "commit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNTowM1rOGlCo6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNzo0MVrOGlCuQA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzczOQ==", "bodyText": "Can we return fileLock::close if we make this method return Releasable instead?", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441493739", "createdAt": "2020-06-17T12:05:03Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -85,7 +85,8 @@ public Path getFile() {\n \n     ReleasableLock fileLock() {\n         boolean success = false;\n-        final ReleasableLock fileLock = readLock.acquire();\n+        final ReleasableLock fileLock = new ReleasableLock(readLock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTEwNA==", "bodyText": "Before this change we released evictionLock after calling refCounter.decRef(), but this change reverses the order. Can we keep the order the same?", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441495104", "createdAt": "2020-06-17T12:07:41Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -122,9 +124,11 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n                     listeners = Collections.unmodifiableSet(newListeners);\n                     success = true;\n                 } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+                    evictionLock.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebae53d76e70a2b3282273377e4c85c26f06b301", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/ebae53d76e70a2b3282273377e4c85c26f06b301", "committedDate": "2020-06-17T12:49:41Z", "message": "Releasable"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/2180f565b935dca6ddbbcb55d2abb26a77ba857e", "committedDate": "2020-06-17T13:03:17Z", "message": "unlock"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNDg4MTE0", "url": "https://github.com/elastic/elasticsearch/pull/58244#pullrequestreview-432488114", "createdAt": "2020-06-17T14:55:42Z", "commit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1NTo0M1rOGlJuKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1NTo0M1rOGlJuKg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA==", "bodyText": "Looks like refCounter.decRef() can throw an UncheckedIOException so we need another finally here.", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441609770", "createdAt": "2020-06-17T14:55:43Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -112,20 +112,20 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n-            try (ReleasableLock ignored = evictionLock.acquire()) {\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+            evictionLock.lock();\n+            try {\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n+            } finally {\n+                if (success == false) {\n+                    refCounter.decRef();\n                 }\n+                evictionLock.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e"}, "originalPosition": 87}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0e6db7e6a794f38d3da6b85138785d153ebe7a2", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0e6db7e6a794f38d3da6b85138785d153ebe7a2", "committedDate": "2020-06-17T15:02:47Z", "message": "yet another finally"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDMyNTEwMjI0", "url": "https://github.com/elastic/elasticsearch/pull/58244#pullrequestreview-432510224", "createdAt": "2020-06-17T15:16:44Z", "commit": {"oid": "a0e6db7e6a794f38d3da6b85138785d153ebe7a2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5d5c5abfc53b101dfecf2b1e0406e3f838960e2", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5d5c5abfc53b101dfecf2b1e0406e3f838960e2", "committedDate": "2020-06-17T16:23:51Z", "message": "Merge branch 'master' into remove-releasable"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 609, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}