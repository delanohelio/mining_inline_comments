{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYzOTA3MzM2", "number": 60809, "title": "Improve error message for non append-only writes that target data stream", "bodyText": "When a write op with op_type not equal to create targets a data streams then the following error is returned: no such index [null]. This isn't a meaningful error message. Also the the used exception (IndexNotFoundException) will result in a 404 response code.\nThis PR adds exception handling logic, so that a IllegalArgumentException is returned with a better error message.\nThis exception will return a 400 response code instead.\nCloses #60581", "createdAt": "2020-08-06T09:27:25Z", "url": "https://github.com/elastic/elasticsearch/pull/60809", "merged": true, "mergeCommit": {"oid": "f3b305aa443c534e586bc887c741dd6637ebdaef"}, "closed": true, "closedAt": "2020-08-10T08:45:51Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8MSpbAH2gAyNDYzOTA3MzM2OjFhNzlkMDI2YTNkYzc4Y2E3NGFhNTlmYTQyY2VhYzMzYzM1ZGM1Y2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc9dUzfAH2gAyNDYzOTA3MzM2OjM3NzQ5NjBkMzkwZDMzMWMwN2Q2NDU2NjNlOTAwNmYxZTk3NGYwZjI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc", "committedDate": "2020-08-06T09:20:46Z", "message": "Improve error message for non append-only writes that target data stream\n\nCloses #60581"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNDIxNDk5", "url": "https://github.com/elastic/elasticsearch/pull/60809#pullrequestreview-462421499", "createdAt": "2020-08-06T11:09:36Z", "commit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTowOTozNlrOG8u_pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMTowOTozNlrOG8u_pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjMzNzcwMw==", "bodyText": "Maybe refactor es.excluded_ds to named constant?", "url": "https://github.com/elastic/elasticsearch/pull/60809#discussion_r466337703", "createdAt": "2020-08-06T11:09:36Z", "author": {"login": "probakowski"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/IndexNameExpressionResolver.java", "diffHunk": "@@ -272,6 +274,10 @@\n         if (options.allowNoIndices() == false && concreteIndices.isEmpty()) {\n             IndexNotFoundException infe = new IndexNotFoundException((String)null);\n             infe.setResources(\"index_expression\", indexExpressions);\n+            if (excludedDataStreams) {\n+                // Allows callers to handle IndexNotFoundException differently based on whether data streams were excluded.\n+                infe.addMetadata(\"es.excluded_ds\", \"true\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNDgyMTYx", "url": "https://github.com/elastic/elasticsearch/pull/60809#pullrequestreview-462482161", "createdAt": "2020-08-06T12:45:18Z", "commit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMjo0NToxOVrOG8x4vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxMjo0OTowM1rOG8yAtg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4NTA4Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                    throw new IllegalArgumentException(\"only write ops with op_type=create are allowed in data streams\");\n          \n          \n            \n                                    throw new IllegalArgumentException(\"only write ops with an op_type of create are allowed in data streams\");", "url": "https://github.com/elastic/elasticsearch/pull/60809#discussion_r466385086", "createdAt": "2020-08-06T12:45:19Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/action/support/single/instance/TransportInstanceSingleOperationAction.java", "diffHunk": "@@ -143,7 +144,15 @@ protected void doStart(ClusterState clusterState) {\n                         throw blockException;\n                     }\n                 }\n-                request.concreteIndex(indexNameExpressionResolver.concreteWriteIndex(clusterState, request).getName());\n+                try {\n+                    request.concreteIndex(indexNameExpressionResolver.concreteWriteIndex(clusterState, request).getName());\n+                } catch (IndexNotFoundException e) {\n+                    if (request.includeDataStreams() == false && e.getMetadataKeys().contains(\"es.excluded_ds\")) {\n+                        throw new IllegalArgumentException(\"only write ops with op_type=create are allowed in data streams\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjM4NzEyNg==", "bodyText": "Just a question -- I don't understand why includeDataStreams == false is here. I would have thought it would be the opposite if it were addressing the case of indexing into data streams though it does seem to work according to the tests you added.", "url": "https://github.com/elastic/elasticsearch/pull/60809#discussion_r466387126", "createdAt": "2020-08-06T12:49:03Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/action/bulk/TransportBulkAction.java", "diffHunk": "@@ -636,8 +636,16 @@ Index resolveIfAbsent(DocWriteRequest<?> request) {\n             Index concreteIndex = indices.get(request.index());\n             if (concreteIndex == null) {\n                 boolean includeDataStreams = request.opType() == DocWriteRequest.OpType.CREATE;\n-                concreteIndex = indexNameExpressionResolver.concreteWriteIndex(state, request.indicesOptions(), request.indices()[0],\n-                    false, includeDataStreams);\n+                try {\n+                    concreteIndex = indexNameExpressionResolver.concreteWriteIndex(state, request.indicesOptions(),\n+                        request.indices()[0], false, includeDataStreams);\n+                } catch (IndexNotFoundException e) {\n+                    if (includeDataStreams == false && e.getMetadataKeys().contains(\"es.excluded_ds\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a79d026a3dc78ca74aa59fa42ceac33c35dc5cc"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64270008f0bd80b7736d4d2bf9e342ecd67b1db3", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/64270008f0bd80b7736d4d2bf9e342ecd67b1db3", "committedDate": "2020-08-10T07:23:48Z", "message": "Merge remote-tracking branch 'es/master' into better_error_message_for_non_append_only_writes_targeting_ds"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3774960d390d331c07d645663e9006f1e974f0f2", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3774960d390d331c07d645663e9006f1e974f0f2", "committedDate": "2020-08-10T07:45:26Z", "message": "iter"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3427, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}