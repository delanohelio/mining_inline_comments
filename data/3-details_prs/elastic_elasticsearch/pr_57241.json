{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI0MDQxMjY1", "number": 57241, "title": "Make global ords terms simpler to understand", "bodyText": "When the terms enum operates on non-numeric data it can collect it via\nglobal ordinals. It actually has two separate collection strategies for this,\none \"dense\" and one \"remapping\". Each of those strategies has two\n\"iteration\" strategies that it uses to build buckets, depending on\nwhether or not we need buckets with 0 docs in them. Previously this\nwas done with several null checks and never really explained. This\nchange replaces those checks with two CollectionStrategy classes which\nhave good stuff like Javadocs.\nIt also adds the name of the strategy used to the debugging information.\nRelated to #56487", "createdAt": "2020-05-27T18:34:00Z", "url": "https://github.com/elastic/elasticsearch/pull/57241", "merged": true, "mergeCommit": {"oid": "974d236fbca84758576404c2128ba19277a0ff4f"}, "closed": true, "closedAt": "2020-05-28T19:29:32Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcldnoggH2gAyNDI0MDQxMjY1OmM0NjQwNGZhNDQ2NzNkNTNkZGI3OWNiZjA0YjYxMjU2NmM5ODliODU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABclyHibAH2gAyNDI0MDQxMjY1OmIyZWIzOTQxMTRiYjQ3YjQ0ODY3M2JmMDQ2OTRkZGQxMjQzYTBkY2U=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c46404fa44673d53ddb79cbf04b612566c989b85", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c46404fa44673d53ddb79cbf04b612566c989b85", "committedDate": "2020-05-27T18:31:49Z", "message": "Make global ords terms simpler to understand\n\nWhen the `terms` enum operates on non-numeric data it can collect it via\nglobal ordinals. It actually has two separate collection strategies for,\none \"dense\" and one \"remapping\". Each of *those* strategies has two\n\"iteration\" strategies that it uses to build buckets, depending on\nwhether or not we need buckets with `0` docs in them. Previously this\nwas done with several `null` checks and never really explained. This\nchange replaces those checks with two `CollectionStrategy` classes which\nhave good stuff like documentation."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f15258ea2b5e1a5b1c50ceb184c27b775d9ebf50", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f15258ea2b5e1a5b1c50ceb184c27b775d9ebf50", "committedDate": "2020-05-27T20:43:20Z", "message": "fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8e42d86848526ce50fdf1182103505561ca662d4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/8e42d86848526ce50fdf1182103505561ca662d4", "committedDate": "2020-05-28T13:08:16Z", "message": "Merge branch 'master' into global_ords_terms_collection_strategy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/11f0beaa2faf77a8fadc3d22c84c744f8317d829", "committedDate": "2020-05-28T13:18:12Z", "message": "Be good now!"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIwMTYxMzU0", "url": "https://github.com/elastic/elasticsearch/pull/57241#pullrequestreview-420161354", "createdAt": "2020-05-28T14:23:09Z", "commit": {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNDoyMzowOVrOGb3fqw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yOFQxNTowNDowNVrOGb5m4A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTg3Mzk2Mw==", "bodyText": "I presume this is what gets called by the collector, but I think it'd help to make this javadoc a little more explicit.", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431873963", "createdAt": "2020-05-28T14:23:09Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -420,4 +392,141 @@ public boolean advanceExact(int target) throws IOException {\n             return false;\n         }\n     }\n+\n+    /**\n+     * Strategy for collecting global ordinals.\n+     */\n+    abstract class CollectionStrategy implements Releasable {\n+        /**\n+         * Short description of the collection mechanism added to the profile\n+         * output to help with debugging.\n+         */\n+        abstract String describe();\n+        /**\n+         * Called when the global ordinals are ready.\n+         */\n+        abstract void globalOrdsReady(SortedSetDocValues globalOrds);\n+        /**\n+         * Collect a global ordinal.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829"}, "originalPosition": 313}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwMTgwNA==", "bodyText": "Is there a reason not to just pass the collection strategy in directly?", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431901804", "createdAt": "2020-05-28T14:55:01Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -89,32 +88,17 @@ public GlobalOrdinalsStringTermsAggregator(String name, AggregatorFactories fact\n                                                Map<String, Object> metadata) throws IOException {\n         super(name, factories, context, parent, order, format, bucketCountThresholds, collectionMode, showTermDocCountError, metadata);\n         this.valuesSource = valuesSource;\n-        this.includeExclude = includeExclude;\n         final IndexReader reader = context.searcher().getIndexReader();\n         final SortedSetDocValues values = reader.leaves().size() > 0 ?\n             valuesSource.globalOrdinalsValues(context.searcher().getIndexReader().leaves().get(0)) : DocValues.emptySortedSet();\n         this.valueCount = values.getValueCount();\n         this.lookupGlobalOrd = values::lookupOrd;\n-        this.acceptedGlobalOrdinals = includeExclude != null ? includeExclude.acceptedGlobalOrdinals(values) : null;\n-        this.bucketOrds = remapGlobalOrds ? new LongHash(1, context.bigArrays()) : null;\n-    }\n-\n-    boolean remapGlobalOrds() {\n-        return bucketOrds != null;\n+        this.acceptedGlobalOrdinals = includeExclude == null ? l -> true : includeExclude.acceptedGlobalOrdinals(values)::get;\n+        this.collectionStrategy = remapGlobalOrds ? new RemapGlobalOrds() : new DenseGlobalOrds();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829"}, "originalPosition": 66}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTkwODU3Ng==", "bodyText": "I think your comment from the PR description that we have two collection strategies and each has two iteration strategies would fit well in the javadoc for this class.  Or at the very least, a note on forEach that it should account for both iteration cases.", "url": "https://github.com/elastic/elasticsearch/pull/57241#discussion_r431908576", "createdAt": "2020-05-28T15:04:05Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/GlobalOrdinalsStringTermsAggregator.java", "diffHunk": "@@ -420,4 +392,141 @@ public boolean advanceExact(int target) throws IOException {\n             return false;\n         }\n     }\n+\n+    /**\n+     * Strategy for collecting global ordinals.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "11f0beaa2faf77a8fadc3d22c84c744f8317d829"}, "originalPosition": 300}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4a8e3aa90c55e31d64de0587864119e34707c903", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/4a8e3aa90c55e31d64de0587864119e34707c903", "committedDate": "2020-05-28T18:06:39Z", "message": "Javadoc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2eb394114bb47b448673bf04694ddd1243a0dce", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2eb394114bb47b448673bf04694ddd1243a0dce", "committedDate": "2020-05-28T18:24:46Z", "message": "Fix bug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4079, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}