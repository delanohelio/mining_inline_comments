{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE3NTEyNzUy", "number": 64756, "title": "Fail force-merges on read-only engines", "bodyText": "In our customer's production cluster, customer complains that some of the indices cannot do force merge to clean deleted docs.\nhealth status index                           uuid                   pri rep docs.count docs.deleted store.size pri.store.size\ngreen open  waf_log-2020.08.26              DblUYrcfQA2DsJzUH53QOg 12 0     13555 24101243   2.7gb   2.7gb\ngreen open  waf_log-2020.08.28              mLv9TizPSuSFRwE0Y08vpQ 12 0     23456 30183641  12.7gb  12.7gb\ngreen open  waf_log-2020.08.24              Iej4DBqcQPS7xdF1U6UZcA 12 0     55171 32343532   7.1gb   7.1gb\ngreen open  waf_log-2020.08.23              qI51D1ObRTCNq84UnX9kEQ 12 0     27153 35677246   7.7gb   7.7gb\n\nHere is the output of force merge api call:\nPOST /waf_log-2020.08.23/_forcemerge?max_num_segments=1&only_expunge_deletes=true&pretty\n{\n  \"_shards\" : {\n    \"total\" : 12,\n    \"successful\" : 12,\n    \"failed\" : 0\n  }\n}\n\nFrom _cat/segments api, we could see this index has more than one segments in each shard:\nGET _cat/segments/waf_log-2020.08.23?v \nindex              shard prirep ip            segment generation docs.count docs.deleted    size size.memory committed searchable version compound\nwaf_log-2020.08.23 0     p      172.16.138.28 _7lh          9845        421      1536889  16.1mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 0     p      172.16.138.28 _7lm          9850       1799      1767111    20mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 1     p      172.16.138.2  _7lu          9858       2261            0   5.7mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 2     p      172.16.138.28 _7h1          9685        547      1453000  15.7mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 2     p      172.16.138.28 _7h4          9688       1848      3775021 260.7mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 3     p      172.16.138.39 _7kd          9805        489      1601900  17.1mb           0 true      false      8.3.0   false\nwaf_log-2020.08.23 3     p      172.16.138.39 _7ki          9810       1843      1977995  33.7mb           0 true      false      8.3.0   false\n\n\nWe try to open low level log to check why force merge could not be executed:\nPUT /_cluster/settings?pretty\n{\n  \"transient\": {\n    \"logger.org.elasticsearch.index.engine\": \"trace\"\n  }\n}\n'\n\nBut we got nothing output about the above index force merge operation. We cost long time to add extra log to figure out that the index has been frozen^^.\nCurrently even index has write block, we still allow user to execute force merge api, but I think we at least need to add some trace level log to let user know why the merge cannot be executed. So this PR add some useful low level log info to indicate index is read only during refresh, flush and force merge operations.", "createdAt": "2020-11-09T06:31:18Z", "url": "https://github.com/elastic/elasticsearch/pull/64756", "merged": true, "mergeCommit": {"oid": "642b530def8fddf86f501a7cc5219fa4241dc579"}, "closed": true, "closedAt": "2020-12-17T08:23:06Z", "author": {"login": "howardhuanghua"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdauozYAH2gAyNTE3NTEyNzUyOjJhYjkyNmJjYzhhZDJlZTBmYTQzYWE4NGRhODg2MWJiZmU5YjMwNDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdm-fu-AFqTU1NDM0MDY5OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2ab926bcc8ad2ee0fa43aa84da8861bbfe9b3048", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ab926bcc8ad2ee0fa43aa84da8861bbfe9b3048", "committedDate": "2020-11-09T06:19:28Z", "message": "Add low level log info to indicate read only index blocking operations."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f66faa116428dabc861c144a157169981b4898db", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/f66faa116428dabc861c144a157169981b4898db", "committedDate": "2020-11-09T15:33:20Z", "message": "Support index write block for force merge."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8ba6b7cbab55262c26c5db29e715c0a2ee53b4ff", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ba6b7cbab55262c26c5db29e715c0a2ee53b4ff", "committedDate": "2020-11-09T15:52:22Z", "message": "add test case."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "40ee1ef3a9ecd019eca53b985a10310b1c579324", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/40ee1ef3a9ecd019eca53b985a10310b1c579324", "committedDate": "2020-11-11T02:38:07Z", "message": "unsupport force merge for frozen index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b6ca7fe597958d9f740bbdb118cf6cb9d0b5399", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b6ca7fe597958d9f740bbdb118cf6cb9d0b5399", "committedDate": "2020-11-13T01:08:42Z", "message": "Merge branch 'master' into frozen_merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0c3470b7184c3e23c2fd4d90cb646c67b945732", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0c3470b7184c3e23c2fd4d90cb646c67b945732", "committedDate": "2020-11-13T08:10:58Z", "message": "Reject force merge if it's going to do real merge."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88674810e132a10793a172318d03411417f572a0", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/88674810e132a10793a172318d03411417f572a0", "committedDate": "2020-11-13T08:14:02Z", "message": "revert write block"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3a6eb12c66e06080cf847ed7ad7e3abc4091302", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3a6eb12c66e06080cf847ed7ad7e3abc4091302", "committedDate": "2020-12-12T13:15:06Z", "message": "Merge master"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f41b425901d8cd6bae810c012c0ee7764181e1c0", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/f41b425901d8cd6bae810c012c0ee7764181e1c0", "committedDate": "2020-12-12T13:17:17Z", "message": "Remove unsued version"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e", "committedDate": "2020-12-16T11:44:09Z", "message": "Merge remote-tracking branch 'upstream/master' into frozen_merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUzNjQwNzc3", "url": "https://github.com/elastic/elasticsearch/pull/64756#pullrequestreview-553640777", "createdAt": "2020-12-16T12:31:05Z", "commit": {"oid": "c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMjozMTowNVrOIHDCmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNlQxMjozMTowNVrOIHDCmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NDI2MDc2MQ==", "bodyText": "This rejects force-merge requests that do not specify the maxNumSegments parameter at all, since that comes through to here as maxNumSegments == ForceMergeSegments.Defaults.MAX_NUM_SEGMENTS == -1. We should accept these requests too, it's ok for them to do nothing.", "url": "https://github.com/elastic/elasticsearch/pull/64756#discussion_r544260761", "createdAt": "2020-12-16T12:31:05Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/index/engine/ReadOnlyEngine.java", "diffHunk": "@@ -375,6 +375,14 @@ public void flush(boolean force, boolean waitIfOngoing) throws EngineException {\n     @Override\n     public void forceMerge(boolean flush, int maxNumSegments, boolean onlyExpungeDeletes,\n                            boolean upgrade, boolean upgradeOnlyAncientSegments, String forceMergeUUID) {\n+        if (maxNumSegments < lastCommittedSegmentInfos.size()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4a70a2e05e5cb5940d17fcba3b4fca4058ac21e"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "971790f978c9ae2de685b6b4243d33d6ef7cb8ed", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/971790f978c9ae2de685b6b4243d33d6ef7cb8ed", "committedDate": "2020-12-16T15:06:31Z", "message": "Support default max num segments."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f9327ba6f678c89b6db0119bfa5823fedc2ad008", "author": {"user": {"login": "howardhuanghua", "name": "Howard"}}, "url": "https://github.com/elastic/elasticsearch/commit/f9327ba6f678c89b6db0119bfa5823fedc2ad008", "committedDate": "2020-12-16T15:07:48Z", "message": "Merge remote-tracking branch 'upstream/master' into frozen_merge"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0MzQwNjk5", "url": "https://github.com/elastic/elasticsearch/pull/64756#pullrequestreview-554340699", "createdAt": "2020-12-17T07:35:08Z", "commit": {"oid": "f9327ba6f678c89b6db0119bfa5823fedc2ad008"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1260, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}