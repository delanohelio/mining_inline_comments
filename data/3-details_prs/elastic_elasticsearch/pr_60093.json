{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MzYwNzY4", "number": 60093, "title": "Allow CCR on nodes with legacy roles only", "bodyText": "CCR will stop functioning if the master node is on 7.8, but data nodes are before that version because the master node considers that all data nodes do not have the remote cluster client role. This commit allows CCR work on data nodes with legacy roles only.\nRelates #54146\nRelates #59375", "createdAt": "2020-07-22T21:18:53Z", "url": "https://github.com/elastic/elasticsearch/pull/60093", "merged": true, "mergeCommit": {"oid": "9d4a64e749a41e2f755178d3a345e8171ccd20da"}, "closed": true, "closedAt": "2020-07-29T14:57:31Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3hj24gH2gAyNDU1MzYwNzY4OjUyNzk5ODA3NTg2OGM1NTQ4NjczYzQyMzMzODc1ODc4OTRkNjg4OTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5iJm_AH2gAyNDU1MzYwNzY4OmVhY2UxMzA4MDEwMWM5YjQ2YzNiOGFhZDY4NDNlMmZhNDExNDFkZGY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "527998075868c5548673c4233387587894d68891", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/527998075868c5548673c4233387587894d68891", "committedDate": "2020-07-22T21:17:57Z", "message": "Assume old nodes have remote cluster client role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUzNzI0ODM5", "url": "https://github.com/elastic/elasticsearch/pull/60093#pullrequestreview-453724839", "createdAt": "2020-07-22T22:19:04Z", "commit": {"oid": "527998075868c5548673c4233387587894d68891"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "990ea086af13407247b7a5bea80750313ca51113", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/990ea086af13407247b7a5bea80750313ca51113", "committedDate": "2020-07-23T00:46:47Z", "message": "Merge branch '7.x' into 7x-remote-cluster-role"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "104ff8721176841ef525c6e367e2a4bf93c93a95", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/104ff8721176841ef525c6e367e2a4bf93c93a95", "committedDate": "2020-07-23T00:55:45Z", "message": "do not add roles"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "839c46de8dd80c06bb4a6e51ceafadfc978bccce", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/839c46de8dd80c06bb4a6e51ceafadfc978bccce", "committedDate": "2020-07-23T02:37:14Z", "message": "oops"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c75f661934bb2321d1ad0418f532a657efb0d7c3", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c75f661934bb2321d1ad0418f532a657efb0d7c3", "committedDate": "2020-07-23T03:43:11Z", "message": "move the assumption to ccr"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bafccbcd3faaef7d5b1d01a324e0e14579f37865", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/bafccbcd3faaef7d5b1d01a324e0e14579f37865", "committedDate": "2020-07-23T04:12:33Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f43fdd17ac900408a1abff95de59c30fbe1ce11e", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f43fdd17ac900408a1abff95de59c30fbe1ce11e", "committedDate": "2020-07-23T04:12:52Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4", "committedDate": "2020-07-28T17:56:55Z", "message": "avoid hotspot in a mixed cluster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2069e529e5b4021c9aaaaba5812a3b057b426827", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2069e529e5b4021c9aaaaba5812a3b057b426827", "committedDate": "2020-07-28T17:57:04Z", "message": "Merge branch '7.x' into 7x-remote-cluster-role"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MDE4NDcy", "url": "https://github.com/elastic/elasticsearch/pull/60093#pullrequestreview-457018472", "createdAt": "2020-07-28T21:15:15Z", "commit": {"oid": "2069e529e5b4021c9aaaaba5812a3b057b426827"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMToxNToxNVrOG4fKYw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQyMToxNjo0OVrOG4fNSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDAwMw==", "bodyText": "Assigning to a node that is a data node but before version 7.3.0 could still fail (if the node doesn't have the remote cluster client role). I wonder if we should implement this as a last resort? So try to select the least loaded node that is a data node and is a remote cluster client. If that doesn't turn up any nodes, try to assign to a node that is a data node and is before the version that we formalized the remote cluster client role. Note that that is a different version than when we made roles pluggable.", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r461884003", "createdAt": "2020-07-28T21:15:15Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/action/ShardFollowTasksExecutor.java", "diffHunk": "@@ -124,14 +123,14 @@ public void validate(ShardFollowTask params, ClusterState clusterState) {\n \n     @Override\n     public Assignment getAssignment(final ShardFollowTask params, final ClusterState clusterState) {\n-        final DiscoveryNode node = selectLeastLoadedNode(\n+        final DiscoveryNode selectedNode = selectLeastLoadedNode(\n             clusterState,\n-            ((Predicate<DiscoveryNode>) DiscoveryNode::isDataNode).and(DiscoveryNode::isRemoteClusterClient)\n+            node -> node.isDataNode() && (node.isRemoteClusterClient() || node.getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2069e529e5b4021c9aaaaba5812a3b057b426827"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTg4NDc0Ng==", "bodyText": "I wonder if this should be the version that we introduced the remote cluster client role in as opposed to the version that we made node roles pluggable.", "url": "https://github.com/elastic/elasticsearch/pull/60093#discussion_r461884746", "createdAt": "2020-07-28T21:16:49Z", "author": {"login": "jasontedor"}, "path": "x-pack/plugin/ccr/src/main/java/org/elasticsearch/xpack/ccr/allocation/CcrPrimaryFollowerAllocationDecider.java", "diffHunk": "@@ -57,11 +58,14 @@ public Decision canAllocate(ShardRouting shardRouting, RoutingNode node, Routing\n             return allocation.decision(Decision.YES, NAME,\n                 \"shard is a primary follower but was bootstrapped already; hence is not under the purview of this decider\");\n         }\n-        if (node.node().isRemoteClusterClient() == false) {\n-            return allocation.decision(Decision.NO, NAME, \"shard is a primary follower and being bootstrapped, but node does not have the \"\n-                + DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE.roleName() + \" role\");\n+        if (node.node().isRemoteClusterClient()) {\n+            return allocation.decision(Decision.YES, NAME,\n+                \"shard is a primary follower and node has the \" + DiscoveryNodeRole.REMOTE_CLUSTER_CLIENT_ROLE.roleName() + \" role\");\n+        }\n+        if (node.node().getVersion().before(DiscoveryNode.PLUGGABLE_ROLES_VERSION)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2069e529e5b4021c9aaaaba5812a3b057b426827"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7eeaa145c13f8c389e195683335d4e26bf206b7d", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7eeaa145c13f8c389e195683335d4e26bf206b7d", "committedDate": "2020-07-28T23:50:37Z", "message": "Revert \"avoid hotspot in a mixed cluster\"\n\nThis reverts commit fda3927f8d904c4fa7ef16f07c87e2b866fcbbb4."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a33f0acd69337e5437dcb911e237582f3a821c6", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a33f0acd69337e5437dcb911e237582f3a821c6", "committedDate": "2020-07-29T02:53:03Z", "message": "correct version"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU3MTYwOTQ4", "url": "https://github.com/elastic/elasticsearch/pull/60093#pullrequestreview-457160948", "createdAt": "2020-07-29T02:57:57Z", "commit": {"oid": "3a33f0acd69337e5437dcb911e237582f3a821c6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "eace13080101c9b46c3b8aad6843e2fa41141ddf", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/eace13080101c9b46c3b8aad6843e2fa41141ddf", "committedDate": "2020-07-29T03:07:02Z", "message": "remove unused import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4085, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}