{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM1ODA1MDQ4", "number": 58244, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNTowM1rOEGUeTA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1NTo0M1rOEGYyvg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDYyMzQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNTowM1rOGlCo6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzowNDoyNFrOGlEu-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzczOQ==", "bodyText": "Can we return fileLock::close if we make this method return Releasable instead?", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441493739", "createdAt": "2020-06-17T12:05:03Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -85,7 +85,8 @@ public Path getFile() {\n \n     ReleasableLock fileLock() {\n         boolean success = false;\n-        final ReleasableLock fileLock = readLock.acquire();\n+        final ReleasableLock fileLock = new ReleasableLock(readLock);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUyODA1Ng==", "bodyText": "Sure, in that case we don't need the ReleasableLock at all and can return readLock::unlock: I pushed ebae53d", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441528056", "createdAt": "2020-06-17T13:04:24Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -85,7 +85,8 @@ public Path getFile() {\n \n     ReleasableLock fileLock() {\n         boolean success = false;\n-        final ReleasableLock fileLock = readLock.acquire();\n+        final ReleasableLock fileLock = new ReleasableLock(readLock);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5MzczOQ=="}, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 27}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MDYzMjM5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMjowNzo0MVrOGlCuQA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxMzowNDo1MFrOGlEv_w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTEwNA==", "bodyText": "Before this change we released evictionLock after calling refCounter.decRef(), but this change reverses the order. Can we keep the order the same?", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441495104", "createdAt": "2020-06-17T12:07:41Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -122,9 +124,11 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n                     listeners = Collections.unmodifiableSet(newListeners);\n                     success = true;\n                 } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+                    evictionLock.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 49}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTUyODMxOQ==", "bodyText": "Good catch - I've been a bit quick on this. I pushed 2180f56", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441528319", "createdAt": "2020-06-17T13:04:50Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -122,9 +124,11 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n                     listeners = Collections.unmodifiableSet(newListeners);\n                     success = true;\n                 } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+                    evictionLock.unlock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTQ5NTEwNA=="}, "originalCommit": {"oid": "45af1b041854a1062b021b1050fa0006d37708e0"}, "originalPosition": 49}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjc1MTMzMTE4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNDo1NTo0M1rOGlJuKg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0xN1QxNTowMzo1MFrOGlKH7Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA==", "bodyText": "Looks like refCounter.decRef() can throw an UncheckedIOException so we need another finally here.", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441609770", "createdAt": "2020-06-17T14:55:43Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -112,20 +112,20 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n-            try (ReleasableLock ignored = evictionLock.acquire()) {\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+            evictionLock.lock();\n+            try {\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n+            } finally {\n+                if (success == false) {\n+                    refCounter.decRef();\n                 }\n+                evictionLock.unlock();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxNTczMg==", "bodyText": "Good catch (bis)", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441615732", "createdAt": "2020-06-17T15:03:05Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -112,20 +112,20 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n-            try (ReleasableLock ignored = evictionLock.acquire()) {\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+            evictionLock.lock();\n+            try {\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n+            } finally {\n+                if (success == false) {\n+                    refCounter.decRef();\n                 }\n+                evictionLock.unlock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA=="}, "originalCommit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e"}, "originalPosition": 87}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYxNjM2NQ==", "bodyText": "I pushed a0e6db7", "url": "https://github.com/elastic/elasticsearch/pull/58244#discussion_r441616365", "createdAt": "2020-06-17T15:03:50Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/cache/CacheFile.java", "diffHunk": "@@ -112,20 +112,20 @@ public boolean acquire(final EvictionListener listener) throws IOException {\n         ensureOpen();\n         boolean success = false;\n         if (refCounter.tryIncRef()) {\n-            try (ReleasableLock ignored = evictionLock.acquire()) {\n-                try {\n-                    ensureOpen();\n-                    final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n-                    final boolean added = newListeners.add(listener);\n-                    assert added : \"listener already exists \" + listener;\n-                    maybeOpenFileChannel(newListeners);\n-                    listeners = Collections.unmodifiableSet(newListeners);\n-                    success = true;\n-                } finally {\n-                    if (success == false) {\n-                        refCounter.decRef();\n-                    }\n+            evictionLock.lock();\n+            try {\n+                ensureOpen();\n+                final Set<EvictionListener> newListeners = new HashSet<>(listeners);\n+                final boolean added = newListeners.add(listener);\n+                assert added : \"listener already exists \" + listener;\n+                maybeOpenFileChannel(newListeners);\n+                listeners = Collections.unmodifiableSet(newListeners);\n+                success = true;\n+            } finally {\n+                if (success == false) {\n+                    refCounter.decRef();\n                 }\n+                evictionLock.unlock();", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0MTYwOTc3MA=="}, "originalCommit": {"oid": "2180f565b935dca6ddbbcb55d2abb26a77ba857e"}, "originalPosition": 87}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1561, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}