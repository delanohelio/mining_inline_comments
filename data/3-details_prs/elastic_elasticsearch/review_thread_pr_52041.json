{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNDAyMTM2", "number": 52041, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo0ODo1NFrODecM0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDozMzowM1rODfIB5A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjQ1OTA2OnYy", "diffSide": "LEFT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo0ODo1NFrOFnk1Eg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDoyMzo0NlrOFopFxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjE5NA==", "bodyText": "^ this is basically the main change", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377042194", "createdAt": "2020-02-10T12:48:54Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -361,9 +361,8 @@ protected void onFinish(ActionListener<Void> listener) {\n             if (progress != null && progress.getPercentComplete() != null && progress.getPercentComplete() < 100.0) {\n                 progress.incrementDocsProcessed(progress.getTotalDocs() - progress.getDocumentsProcessed());\n             }\n-            // If the last checkpoint is now greater than 1, that means that we have just processed the first\n-            // continuous checkpoint and should start recording the exponential averages\n-            if (lastCheckpoint != null && lastCheckpoint.getCheckpoint() > 1) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2MDU4Mw==", "bodyText": "\ud83d\ude01  ha it took a lot of reviewing to get here and it's a one liner", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378160583", "createdAt": "2020-02-12T10:23:46Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/TransformIndexer.java", "diffHunk": "@@ -361,9 +361,8 @@ protected void onFinish(ActionListener<Void> listener) {\n             if (progress != null && progress.getPercentComplete() != null && progress.getPercentComplete() < 100.0) {\n                 progress.incrementDocsProcessed(progress.getTotalDocs() - progress.getDocumentsProcessed());\n             }\n-            // If the last checkpoint is now greater than 1, that means that we have just processed the first\n-            // continuous checkpoint and should start recording the exponential averages\n-            if (lastCheckpoint != null && lastCheckpoint.getCheckpoint() > 1) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjE5NA=="}, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 6}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjQ2MTI0OnYy", "diffSide": "LEFT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformIndexerStats.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo0OTozN1rOFnk2Tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo0OTozN1rOFnk2Tg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MjUxMA==", "bodyText": "^ removed this constructor", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377042510", "createdAt": "2020-02-10T12:49:37Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformIndexerStats.java", "diffHunk": "@@ -73,37 +85,62 @@\n     private double expAvgCheckpointDurationMs;\n     private double expAvgDocumentsIndexed;\n     private double expAvgDocumentsProcessed;\n+\n     /**\n      * Create with all stats set to zero\n      */\n     public TransformIndexerStats() {\n         super();\n     }\n \n-    public TransformIndexerStats(long numPages, long numInputDocuments, long numOutputDocuments,\n-                                          long numInvocations, long indexTime, long searchTime, long indexTotal, long searchTotal,\n-                                          long indexFailures, long searchFailures, Double expAvgCheckpointDurationMs,\n-                                          Double expAvgDocumentsIndexed, Double expAvgDocumentsProcessed ) {\n-        super(numPages, numInputDocuments, numOutputDocuments, numInvocations, indexTime, searchTime, indexTotal, searchTotal,\n-            indexFailures, searchFailures);\n+    public TransformIndexerStats(\n+        long numPages,\n+        long numInputDocuments,\n+        long numOutputDocuments,\n+        long numInvocations,\n+        long indexTime,\n+        long searchTime,\n+        long indexTotal,\n+        long searchTotal,\n+        long indexFailures,\n+        long searchFailures,\n+        Double expAvgCheckpointDurationMs,\n+        Double expAvgDocumentsIndexed,\n+        Double expAvgDocumentsProcessed\n+    ) {\n+        super(\n+            numPages,\n+            numInputDocuments,\n+            numOutputDocuments,\n+            numInvocations,\n+            indexTime,\n+            searchTime,\n+            indexTotal,\n+            searchTotal,\n+            indexFailures,\n+            searchFailures\n+        );\n         this.expAvgCheckpointDurationMs = expAvgCheckpointDurationMs == null ? 0.0 : expAvgCheckpointDurationMs;\n         this.expAvgDocumentsIndexed = expAvgDocumentsIndexed == null ? 0.0 : expAvgDocumentsIndexed;\n         this.expAvgDocumentsProcessed = expAvgDocumentsProcessed == null ? 0.0 : expAvgDocumentsProcessed;\n     }\n \n-    public TransformIndexerStats(long numPages, long numInputDocuments, long numOutputDocuments,\n-                                          long numInvocations, long indexTime, long searchTime, long indexTotal, long searchTotal,\n-                                          long indexFailures, long searchFailures) {\n-        this(numPages, numInputDocuments, numOutputDocuments, numInvocations, indexTime, searchTime, indexTotal, searchTotal,\n-            indexFailures, searchFailures, 0.0, 0.0, 0.0);\n-    }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 110}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjQ2NDkxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/transform/transforms/TransformStatsTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1MDo1NlrOFnk4mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1MDo1NlrOFnk4mQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0MzA5Nw==", "bodyText": "do not get confused, testBwcWith73: this test BWC with 7.3 where we had no exponential averages, so its ok to construct the stats with 0.0", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377043097", "createdAt": "2020-02-10T12:50:56Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/transform/transforms/TransformStatsTests.java", "diffHunk": "@@ -69,7 +69,7 @@ public void testBwcWith73() throws IOException {\n                 STARTED,\n                 randomBoolean() ? null : randomAlphaOfLength(100),\n                 randomBoolean() ? null : NodeAttributeTests.randomNodeAttributes(),\n-                new TransformIndexerStats(1, 2, 3, 4, 5, 6, 7, 8, 9, 10),\n+                new TransformIndexerStats(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 0.0, 0.0, 0.0),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjQ3MDU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/TransformInfoTransportAction.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1Mjo1MVrOFnk8AA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1Mjo1MVrOFnk8AA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0Mzk2OA==", "bodyText": "^ a bug uncovered by this change: no telemetry for the exponential averages", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377043968", "createdAt": "2020-02-10T12:52:51Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/TransformInfoTransportAction.java", "diffHunk": "@@ -56,11 +55,17 @@\n         TransformIndexerStats.SEARCH_TOTAL.getPreferredName(),\n         TransformIndexerStats.INDEX_FAILURES.getPreferredName(),\n         TransformIndexerStats.SEARCH_FAILURES.getPreferredName(),\n-    };\n+        TransformIndexerStats.EXPONENTIAL_AVG_CHECKPOINT_DURATION_MS.getPreferredName(),\n+        TransformIndexerStats.EXPONENTIAL_AVG_DOCUMENTS_INDEXED.getPreferredName(),\n+        TransformIndexerStats.EXPONENTIAL_AVG_DOCUMENTS_PROCESSED.getPreferredName(), };", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 15}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzMjQ3NTQyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1NDoyMVrOFnk-ug==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMFQxMjo1NDoyMVrOFnk-ug==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NzA0NDY2Ng==", "bodyText": "^ foolish test, due to the alternative constructor, the test was incomplete", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r377044666", "createdAt": "2020-02-10T12:54:21Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "diffHunk": "@@ -90,12 +101,16 @@ public void testParseSearchAggs() {\n             7,  // indexTotal\n             8,  // searchTotal\n             9,  // indexFailures\n-            10); // searchFailures\n+            10, // searchFailures\n+            11.0,  // exponential_avg_checkpoint_duration_ms\n+            12.0,  // exponential_avg_documents_indexed\n+            13.0   // exponential_avg_documents_processed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f9029b04e47690f0103b4718ccb9a298f117cd7f"}, "originalPosition": 55}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTU1MzE1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/transform/integration/TransformGetAndGetStatsIT.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDowODowN1rOFookOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDowODowN1rOFookOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE1MTk5Mw==", "bodyText": "nit: the message should change '.. is not > 0.0'", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378151993", "createdAt": "2020-02-12T10:08:07Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/test/java/org/elasticsearch/xpack/transform/integration/TransformGetAndGetStatsIT.java", "diffHunk": "@@ -251,20 +253,28 @@ public void testGetStatsWithContinuous() throws Exception {\n \n         Request getRequest = createRequestWithAuth(\"GET\", getTransformEndpoint() + transformId + \"/_stats\", null);\n         Map<String, Object> stats = entityAsMap(client().performRequest(getRequest));\n-        List<Map<String, Object>> transformsStats = (List<Map<String, Object>>)XContentMapValues.extractValue(\"transforms\", stats);\n+        List<Map<String, Object>> transformsStats = (List<Map<String, Object>>) XContentMapValues.extractValue(\"transforms\", stats);\n         assertEquals(1, transformsStats.size());\n-        // No continuous checkpoints have been seen and thus all exponential averages should be 0.0\n+        // No continuous checkpoints have been seen and thus all exponential averages should be equal to the batch stats\n         for (Map<String, Object> transformStats : transformsStats) {\n-            transformStats = (Map<String, Object>)transformStats.get(\"stats\");\n-            assertThat(\"exponential_avg_checkpoint_duration_ms is not 0.0\",\n-                transformStats.get(\"exponential_avg_checkpoint_duration_ms\"),\n-                equalTo(0.0));\n-            assertThat(\"exponential_avg_documents_indexed is not 0.0\",\n-                transformStats.get(\"exponential_avg_documents_indexed\"),\n-                equalTo(0.0));\n-            assertThat(\"exponential_avg_documents_processed is not 0.0\",\n+            transformStats = (Map<String, Object>) transformStats.get(\"stats\");\n+            assertThat(transformStats.get(\"documents_processed\"), equalTo(1000));\n+            assertThat(transformStats.get(\"documents_indexed\"), equalTo(27));\n+            assertThat(\n+                \"exponential_avg_checkpoint_duration_ms is not 0.0\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ba947d3452068d281acdb97e1d1960289c6ffa2"}, "originalPosition": 149}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjMzOTY0MDA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDozMzowM1rOFopZ5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0xMlQxMDo0NzoyNFrOFop3qg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NTczNA==", "bodyText": "The var is great I'm looking forward to using it. Expecting a backport problem I looked for this class in the 7.x branch and couldn't find it, instead there is TransformFeatureSetTests which looks very similar. Up to you but you might want to sync the 2 branches to make future backports easier.", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378165734", "createdAt": "2020-02-12T10:33:03Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "diffHunk": "@@ -115,8 +130,16 @@ public void testUsageDisabled() throws IOException, InterruptedException, Execut\n         when(licenseState.isTransformAllowed()).thenReturn(true);\n         Settings.Builder settings = Settings.builder();\n         settings.put(\"xpack.transform.enabled\", false);\n-        var usageAction = new TransformUsageTransportAction(mock(TransportService.class), null, null,\n-            mock(ActionFilters.class), null, settings.build(), licenseState, mock(Client.class));\n+        var usageAction = new TransformUsageTransportAction(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ba947d3452068d281acdb97e1d1960289c6ffa2"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE3MzM1NA==", "bodyText": "this file/class does not exist in 7.x, its based on a re-factoring that was only done on master: #43563\nI stumbled upon this several times (e.g. when renaming the feature to transform) and its indeed a troublemaker for backports. The code for 7.x is different, every time I change something here, I need to re-work the PR for 7.x. Fortunately this file doesn't change that often.", "url": "https://github.com/elastic/elasticsearch/pull/52041#discussion_r378173354", "createdAt": "2020-02-12T10:47:24Z", "author": {"login": "hendrikmuhs"}, "path": "x-pack/plugin/transform/src/test/java/org/elasticsearch/xpack/transform/TransformInfoTransportActionTests.java", "diffHunk": "@@ -115,8 +130,16 @@ public void testUsageDisabled() throws IOException, InterruptedException, Execut\n         when(licenseState.isTransformAllowed()).thenReturn(true);\n         Settings.Builder settings = Settings.builder();\n         settings.put(\"xpack.transform.enabled\", false);\n-        var usageAction = new TransformUsageTransportAction(mock(TransportService.class), null, null,\n-            mock(ActionFilters.class), null, settings.build(), licenseState, mock(Client.class));\n+        var usageAction = new TransformUsageTransportAction(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3ODE2NTczNA=="}, "originalCommit": {"oid": "8ba947d3452068d281acdb97e1d1960289c6ffa2"}, "originalPosition": 72}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4819, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}