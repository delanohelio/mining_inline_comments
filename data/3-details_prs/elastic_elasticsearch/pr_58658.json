{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQxMzE2NzIx", "number": 58658, "title": "Account for recovery throttling when restoring snapshot", "bodyText": "Restoring from a snapshot (which is a particular form of recovery) does not currently take recovery throttling into account (i.e. the indices.recovery.max_bytes_per_sec setting). While restores are subject to their own throttling (repository setting max_restore_bytes_per_sec), this repository setting does not allow for values to be configured differently on a per-node basis. As restores are very similar in nature to peer recoveries (streaming bytes to the node), it makes sense to configure throttling in a single place.\nThe max_restore_bytes_per_sec setting is also changed to default to unlimited now, whereas previously it was set to  40mb, which is the current default of indices.recovery.max_bytes_per_sec). This means that no behavioral change will be observed by clusters where the recovery and restore settings were not adapted.\nRelates #57023", "createdAt": "2020-06-29T11:01:21Z", "url": "https://github.com/elastic/elasticsearch/pull/58658", "merged": true, "mergeCommit": {"oid": "118521d0223eb5474ff9705f343e238d8d2155a9"}, "closed": true, "closedAt": "2020-06-30T11:08:22Z", "author": {"login": "ywelsch"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcv-GjuAH2gAyNDQxMzE2NzIxOjNmZTdhYTU2OTZiZjJlYWZkOGNhY2IxNDhkMmJlZDQ5M2Y1YTgwYjU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwSQOyAH2gAyNDQxMzE2NzIxOjIwZTM2NGZhNjAyMDU1ODNkNjhlN2I2Y2I2ZGM3NDVlOTdkYzgwN2E=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "3fe7aa5696bf2eafd8cacb148d2bed493f5a80b5", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/3fe7aa5696bf2eafd8cacb148d2bed493f5a80b5", "committedDate": "2020-06-29T10:01:48Z", "message": "Use recovery settings for restore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c224cd8287ff1cd19af47b8affcaaa55f00a72d6", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/c224cd8287ff1cd19af47b8affcaaa55f00a72d6", "committedDate": "2020-06-29T10:12:39Z", "message": "Add docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f454a442c09e297d9e4d316fff1898af7996fd93", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/f454a442c09e297d9e4d316fff1898af7996fd93", "committedDate": "2020-06-29T10:58:16Z", "message": "default max_restore_bytes_per_sec to unlimited"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35a1f569752bed83e481b602f201f9fae87f499b", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/35a1f569752bed83e481b602f201f9fae87f499b", "committedDate": "2020-06-29T13:36:26Z", "message": "checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MTY1NjQ3", "url": "https://github.com/elastic/elasticsearch/pull/58658#pullrequestreview-439165647", "createdAt": "2020-06-29T13:52:55Z", "commit": {"oid": "35a1f569752bed83e481b602f201f9fae87f499b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzo1Mjo1NVrOGqSA5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxMzo1Mjo1NVrOGqSA5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Njk4ODUxOA==", "bodyText": "This file is used in the Plugins and Integrations book, which is separate from the Elasticsearch Reference. Because an internal xref is used, the system assumes the reference exists in Plugins and Integrations.\nYou can fix this by using an external link instead:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                Note that restores are also throttled through <<recovery,recovery settings>>.\n          \n          \n            \n                Note that restores are also throttled through {ref}/recovery.html[recovery settings].", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r446988518", "createdAt": "2020-06-29T13:52:55Z", "author": {"login": "jrodewig"}, "path": "docs/plugins/repository-shared-settings.asciidoc", "diffHunk": "@@ -1,11 +1,12 @@\n `max_restore_bytes_per_sec`::\n \n-    Throttles per node restore rate. Defaults to `40mb` per second.\n+    Throttles per node restore rate. Defaults to unlimited.\n+    Note that restores are also throttled through <<recovery,recovery settings>>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35a1f569752bed83e481b602f201f9fae87f499b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f44ad38b27545db9fcda958cb27a34ff0af879a6", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/f44ad38b27545db9fcda958cb27a34ff0af879a6", "committedDate": "2020-06-29T13:58:55Z", "message": "Update docs/plugins/repository-shared-settings.asciidoc\r\n\r\ndoc fix\n\nCo-authored-by: James Rodewig <james.rodewig@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjM3Mjcx", "url": "https://github.com/elastic/elasticsearch/pull/58658#pullrequestreview-439237271", "createdAt": "2020-06-29T15:05:16Z", "commit": {"oid": "f44ad38b27545db9fcda958cb27a34ff0af879a6"}, "state": "DISMISSED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MjQ1NjE5", "url": "https://github.com/elastic/elasticsearch/pull/58658#pullrequestreview-439245619", "createdAt": "2020-06-29T15:13:36Z", "commit": {"oid": "f44ad38b27545db9fcda958cb27a34ff0af879a6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxMzozNlrOGqVogQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yOVQxNToxMzozNlrOGqVogQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzA0NzgwOQ==", "bodyText": "recoverySettings.rateLimiter() doesn't stay constant if you completely enable/disable recovery rate limiting. In peer recovery we get it anew for each file chunk sent/received, whereas here a change may only take effect at the start of a blob.", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447047809", "createdAt": "2020-06-29T15:13:36Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java", "diffHunk": "@@ -2032,7 +2037,8 @@ private static InputStream maybeRateLimit(InputStream stream, @Nullable RateLimi\n     }\n \n     public InputStream maybeRateLimitRestores(InputStream stream) {\n-        return maybeRateLimit(stream, restoreRateLimiter, restoreRateLimitingTimeInNanos);\n+        return maybeRateLimit(maybeRateLimit(stream, restoreRateLimiter, restoreRateLimitingTimeInNanos),\n+            recoverySettings.rateLimiter(), restoreRateLimitingTimeInNanos);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f44ad38b27545db9fcda958cb27a34ff0af879a6"}, "originalPosition": 40}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a576d8d77ff6b77a04e41011591498d7dc9bc04b", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/a576d8d77ff6b77a04e41011591498d7dc9bc04b", "committedDate": "2020-06-30T07:30:44Z", "message": "More dynamic rate limiting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NzY2NTI3", "url": "https://github.com/elastic/elasticsearch/pull/58658#pullrequestreview-439766527", "createdAt": "2020-06-30T08:02:26Z", "commit": {"oid": "a576d8d77ff6b77a04e41011591498d7dc9bc04b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwODowMjoyNlrOGqwluA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQwODowMjoyNlrOGqwluA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzQ4OTQ2NA==", "bodyText": "I think this test would have passed before this change, although maybe a bit slower. Doesn't seem to be much slower, however. Can we somehow assert that it really does run at full speed at the end?\n(I couldn't think of a simple way to do this, we can leave it as-is if you can't either)", "url": "https://github.com/elastic/elasticsearch/pull/58658#discussion_r447489464", "createdAt": "2020-06-30T08:02:26Z", "author": {"login": "DaveCTurner"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -2072,6 +2072,57 @@ public void testThrottling() throws Exception {\n             .putNull(INDICES_RECOVERY_MAX_BYTES_PER_SEC_SETTING.getKey()).build()).get();\n     }\n \n+    public void testDynamicRestoreThrottling() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a576d8d77ff6b77a04e41011591498d7dc9bc04b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c576b18c4f552cc99ffdceef169f6b11932eaa", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5c576b18c4f552cc99ffdceef169f6b11932eaa", "committedDate": "2020-06-30T09:07:53Z", "message": "stronger assertions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9b5b148ed354750a144f1f0af7c76d65fab2bf7", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9b5b148ed354750a144f1f0af7c76d65fab2bf7", "committedDate": "2020-06-30T09:08:15Z", "message": "Merge remote-tracking branch 'elastic/master' into use-recovery-settings-for-restore"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5ODIxMjc3", "url": "https://github.com/elastic/elasticsearch/pull/58658#pullrequestreview-439821277", "createdAt": "2020-06-30T09:08:57Z", "commit": {"oid": "e9b5b148ed354750a144f1f0af7c76d65fab2bf7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "20e364fa60205583d68e7b6cb6dc745e97dc807a", "author": {"user": {"login": "ywelsch", "name": "Yannick Welsch"}}, "url": "https://github.com/elastic/elasticsearch/commit/20e364fa60205583d68e7b6cb6dc745e97dc807a", "committedDate": "2020-06-30T09:30:28Z", "message": "checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2527, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}