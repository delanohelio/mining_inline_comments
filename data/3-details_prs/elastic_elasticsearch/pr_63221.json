{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk3NDIzNTg1", "number": 63221, "title": "API Key id part of transport request body", "bodyText": "When auditing API key creation, it is useful to show the id of the key together with its other parameters (such as name and expiration, etc). Because auditing shows request bodies of security transport actions (see #62916), the id must be part of the request body for it to be audited.\nBecause the API Key id is the doc id of the key doc in the .security index, this change moves the id generation from \n  \n    \n      elasticsearch/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java\n    \n    \n         Line 608\n      in\n      ce649d0\n    \n    \n    \n    \n\n        \n          \n           String uid = UUIDs.base64UUID(); \n        \n    \n  \n\n to the request constructor.", "createdAt": "2020-10-04T12:15:31Z", "url": "https://github.com/elastic/elasticsearch/pull/63221", "merged": true, "mergeCommit": {"oid": "5fa5e8176d77d5f3d139d697c7d239e5161b1ae7"}, "closed": true, "closedAt": "2020-10-05T20:31:44Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdPN4oHgH2gAyNDk3NDIzNTg1OjVlYTEzOWM3M2QxMTgwM2YxMGIyMWNlYTE2ZGI2YmMwZDg1OGYwMzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdPo43igH2gAyNDk3NDIzNTg1OmU5NzYwYjE0OTM5N2JlM2MxMWEzMTgxZjY1NDY0MDFlNjllOTAzZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5ea139c73d11803f10b21cea16db6bc0d858f038", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ea139c73d11803f10b21cea16db6bc0d858f038", "committedDate": "2020-10-04T11:56:43Z", "message": "Done"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTMzNTE2", "url": "https://github.com/elastic/elasticsearch/pull/63221#pullrequestreview-501933516", "createdAt": "2020-10-05T10:47:53Z", "commit": {"oid": "5ea139c73d11803f10b21cea16db6bc0d858f038"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMDo0Nzo1M1rOHcXiwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMDo0Nzo1M1rOHcXiwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUwNzkwNQ==", "bodyText": "nit: I would add a comment as it is not obvious why we would generate the id ( in the same way it would be autogenerated as the doc id ) here", "url": "https://github.com/elastic/elasticsearch/pull/63221#discussion_r499507905", "createdAt": "2020-10-05T10:47:53Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/action/CreateApiKeyRequest.java", "diffHunk": "@@ -45,13 +49,19 @@ public CreateApiKeyRequest() {}\n      * @param expiration to specify expiration for the API key\n      */\n     public CreateApiKeyRequest(String name, @Nullable List<RoleDescriptor> roleDescriptors, @Nullable TimeValue expiration) {\n+        this.id = UUIDs.base64UUID();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea139c73d11803f10b21cea16db6bc0d858f038"}, "originalPosition": 29}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxOTUyODkw", "url": "https://github.com/elastic/elasticsearch/pull/63221#pullrequestreview-501952890", "createdAt": "2020-10-05T11:16:54Z", "commit": {"oid": "5ea139c73d11803f10b21cea16db6bc0d858f038"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMToxNjo1NFrOHcYb8g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxMToxNjo1NFrOHcYb8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTUyMjU0Ng==", "bodyText": "Uncomment the randomBoolean()?", "url": "https://github.com/elastic/elasticsearch/pull/63221#discussion_r499522546", "createdAt": "2020-10-05T11:16:54Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/action/CreateApiKeyRequestTests.java", "diffHunk": "@@ -96,11 +97,22 @@ public void testSerialization() throws IOException {\n         }\n         request.setRoleDescriptors(descriptorList);\n \n+        boolean testV710Bwc = true;// randomBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5ea139c73d11803f10b21cea16db6bc0d858f038"}, "originalPosition": 12}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "323792ff529333426420912afd49a338c7d5095e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/323792ff529333426420912afd49a338c7d5095e", "committedDate": "2020-10-05T14:02:28Z", "message": "Merge branch 'master' into create_api_key_id_part_of_request"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4e50cdb125d3641a247d6725640238bfb6218f4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4e50cdb125d3641a247d6725640238bfb6218f4", "committedDate": "2020-10-05T14:19:22Z", "message": "Review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "823056503c2f8a9af77eab158b92a2d40ea63086", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/823056503c2f8a9af77eab158b92a2d40ea63086", "committedDate": "2020-10-05T18:24:45Z", "message": "Merge branch 'master' into create_api_key_id_part_of_request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAyMzUyNDM5", "url": "https://github.com/elastic/elasticsearch/pull/63221#pullrequestreview-502352439", "createdAt": "2020-10-05T19:24:16Z", "commit": {"oid": "823056503c2f8a9af77eab158b92a2d40ea63086"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOToyNDoxNlrOHcqmiA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wNVQxOToyNDoxNlrOHcqmiA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5OTgyMDE2OA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                                        assert indexResponse.getId() == request.getId();\n          \n          \n            \n                                        assert request.getId().equals(indexResponse.getId());", "url": "https://github.com/elastic/elasticsearch/pull/63221#discussion_r499820168", "createdAt": "2020-10-05T19:24:16Z", "author": {"login": "albertzaharovits"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ApiKeyService.java", "diffHunk": "@@ -232,15 +232,19 @@ private void createApiKeyAndIndexIt(Authentication authentication, CreateApiKeyR\n             final IndexRequest indexRequest =\n                 client.prepareIndex(SECURITY_MAIN_ALIAS)\n                     .setSource(builder)\n+                    .setId(request.getId())\n                     .setRefreshPolicy(request.getRefreshPolicy())\n                     .request();\n             final BulkRequest bulkRequest = toSingleItemBulkRequest(indexRequest);\n \n             securityIndex.prepareIndexIfNeededThenExecute(listener::onFailure, () ->\n                 executeAsyncWithOrigin(client, SECURITY_ORIGIN, BulkAction.INSTANCE, bulkRequest,\n                     TransportSingleItemBulkWriteAction.<IndexResponse>wrapBulkResponse(ActionListener.wrap(\n-                        indexResponse -> listener.onResponse(\n-                            new CreateApiKeyResponse(request.getName(), indexResponse.getId(), apiKey, expiration)),\n+                        indexResponse -> {\n+                            assert indexResponse.getId() == request.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "823056503c2f8a9af77eab158b92a2d40ea63086"}, "originalPosition": 15}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9760b149397be3c11a3181f6546401e69e903ea", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9760b149397be3c11a3181f6546401e69e903ea", "committedDate": "2020-10-05T19:24:25Z", "message": "Update x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/ApiKeyService.java"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4388, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}