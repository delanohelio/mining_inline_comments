{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1MTgxMzQ2", "number": 53260, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNjo0Mzo0OVrODmEw7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNjo0NjoyNFrODmExRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjUwNTQwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNjo0Mzo0OVrOFzTeig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMzo0MjozNFrOFzVTPw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA==", "bodyText": "It seems this default is only used in tests (and the interface is only implemented once anyways), should we maybe just extract some utility method into tests to build these listeners?\nE.g.\n    public static GlobalCheckpointListeners.GlobalCheckpointListener syncListener(BiConsumer<Long, Exception> consumer) {\n        return new GlobalCheckpointListeners.GlobalCheckpointListener() {\n            @Override\n            public Executor executor() {\n                return Runnable::run;\n            }\n\n            @Override\n            public void accept(long globalCheckpoint, Exception e) {\n                consumer.accept(globalCheckpoint, e);\n            }\n        };\n    }\nIt seems a little strange to mark this as a @FunctionalInterface when it really only is one in tests?", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340810", "createdAt": "2020-03-08T06:43:49Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -53,6 +53,16 @@\n      */\n     @FunctionalInterface\n     public interface GlobalCheckpointListener {\n+\n+        /**\n+         * The executor on which the listener is notified. Defaults to the calling thread.\n+         *\n+         * @return the executor\n+         */\n+        default Executor executor() {\n+            return Runnable::run;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e086753926e4940cb4d165412230073187015de1"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY4Nw==", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370687", "createdAt": "2020-03-08T13:42:34Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -53,6 +53,16 @@\n      */\n     @FunctionalInterface\n     public interface GlobalCheckpointListener {\n+\n+        /**\n+         * The executor on which the listener is notified. Defaults to the calling thread.\n+         *\n+         * @return the executor\n+         */\n+        default Executor executor() {\n+            return Runnable::run;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDgxMA=="}, "originalCommit": {"oid": "e086753926e4940cb4d165412230073187015de1"}, "originalPosition": 11}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQxMjUwNjMxOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQwNjo0NjoyNFrOFzTe-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOFQxMzo0Mjo0NFrOFzVTSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg==", "bodyText": "Maybe move the wrapping listener.executor().execute(() ... into notifyListener to dry things up? We only ever invoke notifyListener from listener.executor().execute(() -> ... anyway.", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389340922", "createdAt": "2020-03-08T06:46:24Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -214,16 +220,15 @@ private void notifyListeners(final long globalCheckpoint, final IndexShardClosed\n             listeners.clear();\n         }\n         if (listenersToNotify.isEmpty() == false) {\n-            executor.execute(() ->\n-                    listenersToNotify\n-                            .forEach((listener, t) -> {\n-                                /*\n-                                 * We do not want to interrupt any timeouts that fired, these will detect that the listener has been\n-                                 * notified and not trigger the timeout.\n-                                 */\n-                                FutureUtils.cancel(t.v2());\n-                                notifyListener(listener, globalCheckpoint, e);\n-                            }));\n+            listenersToNotify\n+                .forEach((listener, t) -> {\n+                    /*\n+                     * We do not want to interrupt any timeouts that fired, these will detect that the listener has been notified and not\n+                     * trigger the timeout.\n+                     */\n+                    FutureUtils.cancel(t.v2());\n+                    listener.executor().execute(() -> notifyListener(listener, globalCheckpoint, e));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e086753926e4940cb4d165412230073187015de1"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM3MDY5OQ==", "bodyText": "I pushed b565820. I mistakenly combined your two suggestions into a single commit, sorry.", "url": "https://github.com/elastic/elasticsearch/pull/53260#discussion_r389370699", "createdAt": "2020-03-08T13:42:44Z", "author": {"login": "jasontedor"}, "path": "server/src/main/java/org/elasticsearch/index/shard/GlobalCheckpointListeners.java", "diffHunk": "@@ -214,16 +220,15 @@ private void notifyListeners(final long globalCheckpoint, final IndexShardClosed\n             listeners.clear();\n         }\n         if (listenersToNotify.isEmpty() == false) {\n-            executor.execute(() ->\n-                    listenersToNotify\n-                            .forEach((listener, t) -> {\n-                                /*\n-                                 * We do not want to interrupt any timeouts that fired, these will detect that the listener has been\n-                                 * notified and not trigger the timeout.\n-                                 */\n-                                FutureUtils.cancel(t.v2());\n-                                notifyListener(listener, globalCheckpoint, e);\n-                            }));\n+            listenersToNotify\n+                .forEach((listener, t) -> {\n+                    /*\n+                     * We do not want to interrupt any timeouts that fired, these will detect that the listener has been notified and not\n+                     * trigger the timeout.\n+                     */\n+                    FutureUtils.cancel(t.v2());\n+                    listener.executor().execute(() -> notifyListener(listener, globalCheckpoint, e));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTM0MDkyMg=="}, "originalCommit": {"oid": "e086753926e4940cb4d165412230073187015de1"}, "originalPosition": 91}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3356, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}