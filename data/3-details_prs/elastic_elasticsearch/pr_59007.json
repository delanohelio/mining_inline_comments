{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0MDA0MDIy", "number": 59007, "title": "Skip unnecessary directory iteration", "bodyText": "Today NodeEnvironment#findAllShardIds enumerates the index directories\nin each data path in order to find one with a specific name. Since we\nalready know the name of the folder we seek we can construct the path\ndirectly and avoid this directory listing. This commit does that.", "createdAt": "2020-07-03T11:16:54Z", "url": "https://github.com/elastic/elasticsearch/pull/59007", "merged": true, "mergeCommit": {"oid": "ed80a00116635b68695b65f2169eb07dabbf0e32"}, "closed": true, "closedAt": "2020-07-09T10:43:13Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxRkGHgH2gAyNDQ0MDA0MDIyOjliZmIwZThkMzA2ZjkwYjhiNmE5ZmVhMGVmZDE5MjIyMjgyZWZjMDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy_LCLAFqTQ0NTA0NjM1Ng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9bfb0e8d306f90b8b6a9fea0efd19222282efc02", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/9bfb0e8d306f90b8b6a9fea0efd19222282efc02", "committedDate": "2020-07-03T11:16:11Z", "message": "Skip unnecessary directory iteration\n\nToday `NodeEnvironment#findAllShardIds` enumerates the index directories\nin each data path in order to find one with a specific name. Since we\nalready know the name of the folder we seek we can construct the path\ndirectly and avoid this directory listing. This commit does that."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0Mjg0MzM3", "url": "https://github.com/elastic/elasticsearch/pull/59007#pullrequestreview-444284337", "createdAt": "2020-07-07T22:08:36Z", "commit": {"oid": "9bfb0e8d306f90b8b6a9fea0efd19222282efc02"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowODozNlrOGuRV2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QyMjowODozNlrOGuRV2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTE3MTgwMg==", "bodyText": "Shouldn't this be checking nodePath.indicesPath.resolve(indexUniquePathId)?", "url": "https://github.com/elastic/elasticsearch/pull/59007#discussion_r451171802", "createdAt": "2020-07-07T22:08:36Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/env/NodeEnvironment.java", "diffHunk": "@@ -1044,15 +1044,8 @@ public String nodeId() {\n         final Set<ShardId> shardIds = new HashSet<>();\n         final String indexUniquePathId = index.getUUID();\n         for (final NodePath nodePath : nodePaths) {\n-            Path location = nodePath.indicesPath;\n-            if (Files.isDirectory(location)) {\n-                try (DirectoryStream<Path> indexStream = Files.newDirectoryStream(location)) {\n-                    for (Path indexPath : indexStream) {\n-                        if (indexUniquePathId.equals(indexPath.getFileName().toString())) {\n-                            shardIds.addAll(findAllShardsForIndex(indexPath, index));\n-                        }\n-                    }\n-                }\n+            if (Files.isDirectory(nodePath.indicesPath)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9bfb0e8d306f90b8b6a9fea0efd19222282efc02"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43a12399c73e00c4b782e07e1ae81072b33d189f", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/43a12399c73e00c4b782e07e1ae81072b33d189f", "committedDate": "2020-07-08T13:00:28Z", "message": "Merge branch 'master' into 2020-07-03-skip-unnecessary-directory-iteration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "29a9b59f7f53495036d2887b928dfcd1512673aa", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/29a9b59f7f53495036d2887b928dfcd1512673aa", "committedDate": "2020-07-08T13:01:08Z", "message": "Remove unnecessary guard"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MDQ2MzU2", "url": "https://github.com/elastic/elasticsearch/pull/59007#pullrequestreview-445046356", "createdAt": "2020-07-08T18:58:22Z", "commit": {"oid": "29a9b59f7f53495036d2887b928dfcd1512673aa"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2238, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}