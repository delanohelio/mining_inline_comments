{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTQ3Njc4", "number": 56206, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo1MDowOFrOD5fZbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoyMzoyN1rOD56vAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYxNjA5ODM3OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "isResolved": false, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxNjo1MDowOFrOGQyeSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQyMjozMjo0OFrOGQ9-8w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA==", "bodyText": "I think we should rethrow as an UncheckedIOException. If we aren't able to determine BWC versions this is likely to cause all sorts of build issues so we should treat this as a fatal error. I believe this might already be the case as BuildParams will validate we aren't setting the value to null, but then we end up losing the original exception cause which is not ideal.", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420257354", "createdAt": "2020-05-05T16:50:08Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDc3OQ==", "bodyText": "I thought about it but didn\u2019t want to fail fatal here to make testing easier. I needed to touch the testkit Test builds and wanted to keep the ability to direct configure the bwcVersion in via BuildParamd there instead of introducing sth like a test only override property in the plugin itself to pass a configurable file path to resolve versions from", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420370779", "createdAt": "2020-05-05T20:00:01Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA=="}, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3MDc5OQ==", "bodyText": "I thought about it but didn\u2019t want to fail fatal here to make testing easier. I needed to touch the testkit Test builds and wanted to keep the ability to direct configure the bwcVersion in via BuildParamd there instead of introducing sth like a test only override property in the plugin itself to pass a configurable file path to resolve versions from", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420370799", "createdAt": "2020-05-05T20:00:03Z", "author": {"login": "breskeby"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA=="}, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM3NzY3Mg==", "bodyText": "Gotcha, we should at least log the original exception then, so if it does barf we get a better message than just bwcVersions cannot be null or whatever.", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420377672", "createdAt": "2020-05-05T20:13:09Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA=="}, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NDg0NQ==", "bodyText": "Why does not failing with an exception make this easier to test? Tests can use expectThrows to catch an exception?", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420444845", "createdAt": "2020-05-05T22:30:09Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA=="}, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDQ0NTkzOQ==", "bodyText": "That doesn't work with testKit tests since it's not the test that's throwing the exception, it's the build and those don't get propagated to the test. You just get a \"your build failed\" type exception returned by teskit.", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420445939", "createdAt": "2020-05-05T22:32:48Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -92,12 +97,26 @@ public void apply(Project project) {\n             params.setDefaultParallel(findDefaultParallel(project));\n             params.setInFipsJvm(Util.getBooleanProperty(\"tests.fips.enabled\", false));\n             params.setIsSnapshotBuild(Util.getBooleanProperty(\"build.snapshot\", true));\n+            params.setBwcVersions(resolveBwcVersions(rootDir));\n         });\n \n         // Print global build info header just before task execution\n         project.getGradle().getTaskGraph().whenReady(graph -> logGlobalBuildInfo());\n     }\n \n+    /* Introspect all versions of ES that may be tested against for backwards\n+     * compatibility. It is *super* important that this logic is the same as the\n+     * logic in VersionUtils.java. */\n+    private static BwcVersions resolveBwcVersions(File root) {\n+        File versionsFile = new File(root, DEFAULT_VERSION_JAVA_FILE_PATH);\n+        try {\n+            List<String> versionLines = IOUtils.readLines(new FileInputStream(versionsFile), \"UTF-8\");\n+            return new BwcVersions(versionLines);\n+        } catch (IOException e) {\n+            return null;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDI1NzM1NA=="}, "originalCommit": {"oid": "db91d30680b88abf878c063f34b1133f599e5f0f"}, "originalPosition": 54}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjYyMDU3NzI4OnYy", "diffSide": "RIGHT", "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoyMzoyOFrOGRdeWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQxNzoyMzoyOFrOGRdeWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDk2MTg4MA==", "bodyText": "nit: I would name this isInternal since that is the property we are setting", "url": "https://github.com/elastic/elasticsearch/pull/56206#discussion_r420961880", "createdAt": "2020-05-06T17:23:28Z", "author": {"login": "rjernst"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/info/GlobalBuildInfoPlugin.java", "diffHunk": "@@ -69,10 +73,13 @@ public void apply(Project project) {\n         File compilerJavaHome = findCompilerJavaHome();\n         File runtimeJavaHome = findRuntimeJavaHome(compilerJavaHome);\n \n-        GitInfo gitInfo = gitInfo(project.getRootProject().getRootDir());\n+        File rootDir = project.getRootDir();\n+        GitInfo gitInfo = gitInfo(rootDir);\n \n-        // Initialize global build parameters\n         BuildParams.init(params -> {\n+            // Initialize global build parameters\n+            boolean internalUse = GlobalBuildInfoPlugin.class.getResource(\"/buildSrc.marker\") != null;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5825ac6a5892fb10e7b76027147f2bf512efb7aa"}, "originalPosition": 35}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2381, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}