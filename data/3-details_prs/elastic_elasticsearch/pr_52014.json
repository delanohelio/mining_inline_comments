{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyMDY0ODk5", "number": 52014, "title": "[ML] Better error when persistent task assignment disabled", "bodyText": "Changes the misleading error message when attempting to open\na job while the \"cluster.persistent_tasks.allocation.enable\"\nsetting is set to \"none\" to a clearer message that names the\nsetting.\nCloses #51956", "createdAt": "2020-02-06T19:12:13Z", "url": "https://github.com/elastic/elasticsearch/pull/52014", "merged": true, "mergeCommit": {"oid": "ec9d04405cf5d2287c9005ce94f62b83b3b7cf19"}, "closed": true, "closedAt": "2020-02-11T15:22:22Z", "author": {"login": "droberts195"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBvklJAH2gAyMzcyMDY0ODk5OjFjYzI2NjVlZWY4ZjgzODhkOTgzNjllOWQ5OWIxYzZmN2E0M2ZjMTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCB7-ugH2gAyMzcyMDY0ODk5OjNlM2RlODI1NGVmOWJlNTBkMzE0NTUwYmI3MWJkNTQzMjk2YzhkNWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/1cc2665eef8f8388d98369e9d99b1c6f7a43fc11", "committedDate": "2020-02-06T19:05:30Z", "message": "[ML] Better error when persistent task assignment disabled\n\nChanges the misleading error message when attempting to open\na job while the \"cluster.persistent_tasks.allocation.enable\"\nsetting is set to \"none\" to a clearer message that names the\nsetting.\n\nCloses #51956"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzA0Mzk2", "url": "https://github.com/elastic/elasticsearch/pull/52014#pullrequestreview-354704396", "createdAt": "2020-02-06T19:15:48Z", "commit": {"oid": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOToxNTo0OVrOFmnDAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxOToxNTo0OVrOFmnDAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjAyOTk1Mg==", "bodyText": "It's not ideal that this is done using contains.  The better solution would be to make Assignments contain a reason number or enum value as well as a text reason.  Then we could check that.  But that's obviously a pretty far-reaching change.  It may be worth waiting until there are more use cases for a reason code so that any implementation can take all the use cases into account.", "url": "https://github.com/elastic/elasticsearch/pull/52014#discussion_r376029952", "createdAt": "2020-02-06T19:15:49Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportOpenJobAction.java", "diffHunk": "@@ -560,7 +561,13 @@ public boolean test(PersistentTasksCustomMetaData.PersistentTask<?> persistentTa\n                         assignment.isAssigned() == false) {\n                     OpenJobAction.JobParams params = (OpenJobAction.JobParams) persistentTask.getParams();\n                     // Assignment has failed on the master node despite passing our \"fast fail\" validation\n-                    exception = makeNoSuitableNodesException(logger, params.getJobId(), assignment.getExplanation());\n+                    if (assignment.equals(AWAITING_UPGRADE)) {\n+                        exception = makeCurrentlyBeingUpgradedException(logger, params.getJobId(), assignment.getExplanation());\n+                    } else if (assignment.getExplanation().contains(\"[\" + EnableAssignmentDecider.ALLOCATION_NONE_EXPLANATION + \"]\")) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzA2MjY5", "url": "https://github.com/elastic/elasticsearch/pull/52014#pullrequestreview-354706269", "createdAt": "2020-02-06T19:18:50Z", "commit": {"oid": "1cc2665eef8f8388d98369e9d99b1c6f7a43fc11"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4eed227c9dccd7f2e8b4c2a839e6b081e0999bab", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/4eed227c9dccd7f2e8b4c2a839e6b081e0999bab", "committedDate": "2020-02-07T15:47:26Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3e3de8254ef9be50d314550bb71bd543296c8d5e", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/3e3de8254ef9be50d314550bb71bd543296c8d5e", "committedDate": "2020-02-07T16:29:21Z", "message": "Merge branch 'master' into improve_assignment_disabled_error"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2895, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}