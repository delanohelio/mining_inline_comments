{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEzNTYxMzI0", "number": 56209, "title": "Save Shard ID Serializations in Bulk Requests", "bodyText": "Just like #56094 but for the request side.\nRemoves a lot of redundant ShardId instances from bulk shard requests as well as stops serializing index names when they're not needed because they're not different from what is in the shard id.\nEven ignoring the index name serialization savings here, this change saves one ShardId instance per bulk shard request at least. This means it saves approximately:\n\n8 bytes for the ShardId object (itself + one field)\n\n\n\nanother 4 bytes for the int in the ShardId\n\n\n\n\n16 bytes (two fields + the instance itself + the padding) for the Index object\n\n\n\n30 bytes for the Index uuid string\n\n\n\n\nall the bytes in the index name string\n\n\n\n\n\n=> 60+ bytes per bulk request item saved on heap and over the wire", "createdAt": "2020-05-05T14:44:36Z", "url": "https://github.com/elastic/elasticsearch/pull/56209", "merged": true, "mergeCommit": {"oid": "63922dfcbdb37663859e9946d764e29392cb26d4"}, "closed": true, "closedAt": "2020-06-23T09:24:24Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 28, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABceD4vVAH2gAyNDEzNTYxMzI0OmM1OWVhNmMyNGI3MTk2YjVhZjc2MDQ4MjFkMWE4NTNkZWI2NDBkNTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuBwPsAFqTQzNTU5MDA4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c59ea6c24b7196b5af7604821d1a853deb640d51", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c59ea6c24b7196b5af7604821d1a853deb640d51", "committedDate": "2020-05-04T18:35:30Z", "message": "indices request IT missing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60d83def8280136070f78c19030a3405886cbfa0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/60d83def8280136070f78c19030a3405886cbfa0", "committedDate": "2020-05-05T07:55:19Z", "message": "works but not bwc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6d12182c5b8f667b9bc6ce9c8992918e2059036d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6d12182c5b8f667b9bc6ce9c8992918e2059036d", "committedDate": "2020-05-05T07:58:47Z", "message": "works but not bwc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c8d01d3f57419dc6101966ae5dc68e5cf937e81", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c8d01d3f57419dc6101966ae5dc68e5cf937e81", "committedDate": "2020-05-05T14:15:41Z", "message": "bck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f4c66745fe866ed497e690acbca7c1ed6cf4d3f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f4c66745fe866ed497e690acbca7c1ed6cf4d3f", "committedDate": "2020-05-05T14:28:30Z", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0d2b716130f16b9e51ebde4b3ecfff017890fdb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0d2b716130f16b9e51ebde4b3ecfff017890fdb", "committedDate": "2020-05-05T15:19:13Z", "message": "nope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9fc460a93607960e55cdd170009b9f79ee0ddbb7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/9fc460a93607960e55cdd170009b9f79ee0ddbb7", "committedDate": "2020-05-05T15:53:01Z", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e9fbff726a70d56b3aa8b0a3dffa397fbe6bdcfb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e9fbff726a70d56b3aa8b0a3dffa397fbe6bdcfb", "committedDate": "2020-05-05T16:01:13Z", "message": "shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6a7b2a57647d6ba31592f0f91ce1de29c3e7451", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6a7b2a57647d6ba31592f0f91ce1de29c3e7451", "committedDate": "2020-05-05T16:10:19Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "385d8cc3be5da7511848e1aa4e8d48f10ddc5b93", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/385d8cc3be5da7511848e1aa4e8d48f10ddc5b93", "committedDate": "2020-05-05T16:18:45Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9b61113e458326e1b7b1ac18bf9dcf10c27ef26", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9b61113e458326e1b7b1ac18bf9dcf10c27ef26", "committedDate": "2020-05-05T16:22:09Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ad1d244782cb3e2563697cbc86177d94389aa1c0", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/ad1d244782cb3e2563697cbc86177d94389aa1c0", "committedDate": "2020-05-05T16:25:17Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "94663644610ccce658e8a45d5b2209392ceb6f7d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/94663644610ccce658e8a45d5b2209392ceb6f7d", "committedDate": "2020-05-05T16:29:23Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "900e01364fc0d5d96e62c3bc39b7a62bb714570b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/900e01364fc0d5d96e62c3bc39b7a62bb714570b", "committedDate": "2020-05-05T16:30:40Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c5b6eac71aeed886ccc38fd51f82aa935e99a66", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c5b6eac71aeed886ccc38fd51f82aa935e99a66", "committedDate": "2020-05-05T16:32:05Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828da53fc5c0e14d5695d958664d43fd73eb6988", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/828da53fc5c0e14d5695d958664d43fd73eb6988", "committedDate": "2020-05-05T16:32:53Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1b5ef1589e6694d4627c0b2b55e8494632f653b", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1b5ef1589e6694d4627c0b2b55e8494632f653b", "committedDate": "2020-05-05T16:38:13Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b145a7441be895fbd95fa0665801c0dcc9bb0548", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/b145a7441be895fbd95fa0665801c0dcc9bb0548", "committedDate": "2020-05-05T16:39:11Z", "message": "much shorter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c1dd9c2aa81aa75209afdc96b2deced9e4f69f43", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1dd9c2aa81aa75209afdc96b2deced9e4f69f43", "committedDate": "2020-05-05T19:06:32Z", "message": "docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7e6aaea3bae3a9c44defe4145b26494644779539", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7e6aaea3bae3a9c44defe4145b26494644779539", "committedDate": "2020-05-05T19:06:49Z", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MDc5NTU3", "url": "https://github.com/elastic/elasticsearch/pull/56209#pullrequestreview-406079557", "createdAt": "2020-05-05T19:11:56Z", "commit": {"oid": "7e6aaea3bae3a9c44defe4145b26494644779539"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxOToxMTo1N1rOGQ3yfQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNVQxOToxMTo1N1rOGQ3yfQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDQ0NQ==", "bodyText": "Having to maintain the old format for 8.x (here and all throughout this change set pretty much) is quite annoying but I think unavoidable because we need to continue to support a 7.x TransportClient sending us a BulkRequest.", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420344445", "createdAt": "2020-05-05T19:11:57Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/DocWriteRequest.java", "diffHunk": "@@ -195,16 +197,22 @@ public static OpType fromString(String sOpType) {\n         }\n     }\n \n-    /** read a document write (index/delete/update) request */\n-    static DocWriteRequest<?> readDocumentRequest(StreamInput in) throws IOException {\n+    /**\n+     * Read a document write (index/delete/update) request\n+     *\n+     * @param shardId shard id of the request. {@code null} when reading as part of a {@link org.elasticsearch.action.bulk.BulkRequest}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7e6aaea3bae3a9c44defe4145b26494644779539"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "04c770b9661c0fdb0f80b3cfd2041cb1ae051f2e", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/04c770b9661c0fdb0f80b3cfd2041cb1ae051f2e", "committedDate": "2020-05-05T19:14:01Z", "message": "simpler"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/84e3912f6930f26e2fd41b73a573402a35c4e423", "committedDate": "2020-05-05T20:24:19Z", "message": "cs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzM2NDA4", "url": "https://github.com/elastic/elasticsearch/pull/56209#pullrequestreview-406336408", "createdAt": "2020-05-06T06:39:59Z", "commit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjozOTo1OVrOGRFx-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjozOTo1OVrOGRFx-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3MzY4OQ==", "bodyText": "This null check is kind of annoying. In many cases we logically wouldn't need it (technically) because we are serializing a request instance that doesn't have the shard id set yet as part of a bulk request (but is known) on the coordinating node (when first sorting the various bulk request parts per shard). We can make a follow-up improvement here to make use of the known ShardId in these cases so that we don't needlessly serialize the index name if it isn't an alias.", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420573689", "createdAt": "2020-05-06T06:39:59Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/support/replication/ReplicationRequest.java", "diffHunk": "@@ -197,6 +210,23 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeVLong(routedBasedOnClusterVersion);\n     }\n \n+    /**\n+     * Thin serialization that does not write {@link #shardId} and will only write {@link #index} if it is different from the index name in\n+     * {@link #shardId}.\n+     */\n+    public void writeThin(StreamOutput out) throws IOException {\n+        super.writeTo(out);\n+        waitForActiveShards.writeTo(out);\n+        out.writeTimeValue(timeout);\n+        if (shardId != null && index.equals(shardId.getIndexName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDA2MzM3MDg0", "url": "https://github.com/elastic/elasticsearch/pull/56209#pullrequestreview-406337084", "createdAt": "2020-05-06T06:41:26Z", "commit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MToyNlrOGRF0DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0wNlQwNjo0MToyNlrOGRF0DQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDU3NDIyMQ==", "bodyText": "Same here, the ShardId is often known on the coordinating node, we can improve this situation to less often serialize the actual name.", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r420574221", "createdAt": "2020-05-06T06:41:26Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/action/support/single/instance/InstanceShardOperationRequest.java", "diffHunk": "@@ -130,5 +141,16 @@ public void writeTo(StreamOutput out) throws IOException {\n         out.writeOptionalString(concreteIndex);\n     }\n \n+    public void writeThin(StreamOutput out) throws IOException {\n+        super.writeTo(out);\n+        if (shardId != null && index.equals(shardId.getIndexName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423"}, "originalPosition": 50}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE5MDUwMTIw", "url": "https://github.com/elastic/elasticsearch/pull/56209#pullrequestreview-419050120", "createdAt": "2020-05-27T10:13:34Z", "commit": {"oid": "84e3912f6930f26e2fd41b73a573402a35c4e423"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMDoxMzozNFrOGbCrHg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yN1QxMDoxMzozNFrOGbCrHg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMTAwODU0Mg==", "bodyText": "That sounds suspicious. The transport client is deprecated in 7.x, do we expect it to work at all against a cluster containing v8 nodes? Even if we do, do we expect it to work even if the client version is earlier than 7.last? Perhaps I'm missing something here...", "url": "https://github.com/elastic/elasticsearch/pull/56209#discussion_r431008542", "createdAt": "2020-05-27T10:13:34Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/action/DocWriteRequest.java", "diffHunk": "@@ -195,16 +197,22 @@ public static OpType fromString(String sOpType) {\n         }\n     }\n \n-    /** read a document write (index/delete/update) request */\n-    static DocWriteRequest<?> readDocumentRequest(StreamInput in) throws IOException {\n+    /**\n+     * Read a document write (index/delete/update) request\n+     *\n+     * @param shardId shard id of the request. {@code null} when reading as part of a {@link org.elasticsearch.action.bulk.BulkRequest}", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyMDM0NDQ0NQ=="}, "originalCommit": {"oid": "7e6aaea3bae3a9c44defe4145b26494644779539"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d65a698652f6f7b441d02ae1fa6f760c106c9a18", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/d65a698652f6f7b441d02ae1fa6f760c106c9a18", "committedDate": "2020-06-23T07:23:13Z", "message": "Merge remote-tracking branch 'elastic/master' into save-shard-id-serialization"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NTkwMDgy", "url": "https://github.com/elastic/elasticsearch/pull/56209#pullrequestreview-435590082", "createdAt": "2020-06-23T09:09:12Z", "commit": {"oid": "d65a698652f6f7b441d02ae1fa6f760c106c9a18"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 115, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}