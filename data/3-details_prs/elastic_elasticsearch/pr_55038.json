{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAxNjk3MjMw", "number": 55038, "title": "Scripting: Deprecate general cache settings", "bodyText": "Deprecate and remove as fallback settings:\n\nscript.cache.max_size in favor of script.context.$CONTEXT.cache_max_size\nscript.cache.expire in favor of script.context.$CONTEXT.cache_expire\nscript.max_compilations_rate in favor of script.context.$CONTEXT.max_compilations_rate\n\nDefault to context cache.\nAdd script.disable_max_compilations_rate, default false to totally disable compilation rates.  This setting is intended for integration tests.\nRefs: #50152", "createdAt": "2020-04-09T23:54:07Z", "url": "https://github.com/elastic/elasticsearch/pull/55038", "merged": true, "mergeCommit": {"oid": "bd64da096088af2a52cea7b9e48252a27294d27b"}, "closed": true, "closedAt": "2020-04-22T18:33:34Z", "author": {"login": "stu-elastic"}, "timelineItems": {"totalCount": 30, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcT0VqVAH2gAyNDAxNjk3MjMwOmZlYWFiNzFmNWQyMjc5ZTcyNzM0YmEwYTZjOWU5ZjljN2VjM2E4NTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaKJgkgH2gAyNDAxNjk3MjMwOjZjZWI5MjMzY2NkMTIxY2Y3Mjg1YWJmMzRhYmRjZGIyOThkMjM4MTI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "feaab71f5d2279e72734ba0a6c9e9f9c7ec3a853", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/feaab71f5d2279e72734ba0a6c9e9f9c7ec3a853", "committedDate": "2020-04-02T22:49:22Z", "message": "Scripting: Deprecate general cache settings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1542a26407bec46ae63e21ed06139737ec4cc1c3", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/1542a26407bec46ae63e21ed06139737ec4cc1c3", "committedDate": "2020-04-09T15:37:10Z", "message": "Add script.disable_max_compilations_rate setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "260cea3653b6fc604e8076e389d4ed2db51ee652", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/260cea3653b6fc604e8076e389d4ed2db51ee652", "committedDate": "2020-04-09T15:37:17Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d586a3421de7e4da5620a707cf8d00b49771a9dc", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/d586a3421de7e4da5620a707cf8d00b49771a9dc", "committedDate": "2020-04-09T17:52:53Z", "message": "Move construction to ScriptCache"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "601c58720c2d8112a1d5c229d6a6ef1ba4355064", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/601c58720c2d8112a1d5c229d6a6ef1ba4355064", "committedDate": "2020-04-09T17:53:40Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dabdcb408b5dc3e76e2cbfe336c52c9b354f193d", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/dabdcb408b5dc3e76e2cbfe336c52c9b354f193d", "committedDate": "2020-04-09T18:18:56Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "816047a36150a0bf06ec46c75068d89e3af11469", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/816047a36150a0bf06ec46c75068d89e3af11469", "committedDate": "2020-04-09T23:30:48Z", "message": "Use ScriptService to do updates of CacheHolder"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2a824765b82da021e09489314d609979a3a88e55", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/2a824765b82da021e09489314d609979a3a88e55", "committedDate": "2020-04-09T23:53:57Z", "message": "Remove fallbacks"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16888fb7ca6bd944cfd4f80a52d8cd7635e4ed98", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/16888fb7ca6bd944cfd4f80a52d8cd7635e4ed98", "committedDate": "2020-04-10T17:33:16Z", "message": "Add SCRIPT_DISABLE_MAX_COMPILATIONS_RATE_SETTING to ClusterSettings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "76ebe3a78adc03f989fda797ec937ce4fa1c1a5a", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/76ebe3a78adc03f989fda797ec937ce4fa1c1a5a", "committedDate": "2020-04-10T18:53:07Z", "message": "Node scope"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c2e723f36c5eecee046419711d39c611fb711c8", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c2e723f36c5eecee046419711d39c611fb711c8", "committedDate": "2020-04-10T19:07:49Z", "message": "Use back compat"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "98b6bb41b1906815dbc900c1419ef9769fea005d", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/98b6bb41b1906815dbc900c1419ef9769fea005d", "committedDate": "2020-04-10T19:32:21Z", "message": "8.0 for bwc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b6497e5760084fb0440e31f3ea175cd7b2c930ba", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/b6497e5760084fb0440e31f3ea175cd7b2c930ba", "committedDate": "2020-04-14T20:01:00Z", "message": "script.max_compilations_rate=2048/1m -> script.disable_max_compilations_rate=true in docker compose"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2373a6bbab40c818e1838bcf7885be23a24b5a13", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/2373a6bbab40c818e1838bcf7885be23a24b5a13", "committedDate": "2020-04-14T20:18:39Z", "message": "do not guard in esnode"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1436177705fa7f628ecc774e92c29c135522864", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1436177705fa7f628ecc774e92c29c135522864", "committedDate": "2020-04-14T20:24:08Z", "message": "Doc update"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/b61dd0647de95bc8f67044ce92bb0cb89655e40c", "committedDate": "2020-04-14T21:57:33Z", "message": "isSnapshotBuild() -> systemProperty 'es.script.disable_max_compilations_rate', 'true'"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjM4Mjcx", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-395638271", "createdAt": "2020-04-17T17:23:29Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzoyMzoyOVrOGHWphA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNzoyMzoyOVrOGHWphA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM2NDI5Mg==", "bodyText": "Rename to cache", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r410364292", "createdAt": "2020-04-17T17:23:29Z", "author": {"login": "stu-elastic"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -688,25 +691,25 @@ ScriptCacheStats cacheStats() {\n                 return new ScriptCacheStats(general.stats());\n             }\n             Map<String, ScriptStats> context = new HashMap<>(contextCache.size());\n-            for (ScriptContext<?> ctx: contexts) {\n-                context.put(ctx.name, contextCache.get(ctx.name).get().stats());\n+            for (String name: contextCache.keySet()) {\n+                context.put(name, contextCache.get(name).get().stats());\n             }\n             return new ScriptCacheStats(context);\n         }\n \n         /**\n-         * Update settings for the context cache, if we're in the context cache mode otherwise no-op.\n+         * Update a single context cache if we're in the context cache mode otherwise no-op.\n          */\n-        void updateContextSettings(Settings settings, ScriptContext<?> context) {\n+        void set(String name, ScriptCache context) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "originalPosition": 326}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjQzMjI0", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-395643224", "createdAt": "2020-04-17T17:30:40Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk2ODA4MjQ0", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-396808244", "createdAt": "2020-04-20T20:59:29Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDo1OToyOVrOGIndCA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMFQyMDo1OToyOVrOGIndCA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMTY4ODIwMA==", "bodyText": "Make this package protected.", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r411688200", "createdAt": "2020-04-20T20:59:29Z", "author": {"login": "stu-elastic"}, "path": "server/src/main/java/org/elasticsearch/script/ScriptService.java", "diffHunk": "@@ -576,89 +583,85 @@ public void applyClusterState(ClusterChangedEvent event) {\n         clusterState = event.state();\n     }\n \n-    /**\n-     * Container for the ScriptCache(s).  This class operates in two modes:\n-     * 1) general mode, if the general script cache is configured.  There are no context caches in this case.\n-     * 2) context mode, if the context script cache is configured.  There is no general cache in this case.\n-     */\n-    static class CacheHolder {\n-        final ScriptCache general;\n-        final Map<String, AtomicReference<ScriptCache>> contextCache;\n+    void setCacheHolder(Settings settings, AtomicReference<CacheHolder> cacheHolder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "originalPosition": 163}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "58077162ccff688a0cb926c6f13aab026762228e", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/58077162ccff688a0cb926c6f13aab026762228e", "committedDate": "2020-04-20T23:36:11Z", "message": "Do not use snapshot in gradle to set max_compilations_rate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4532e51f4020691783802bb6b264e39822072d5b", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/4532e51f4020691783802bb6b264e39822072d5b", "committedDate": "2020-04-20T23:37:45Z", "message": "Merge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36eff0682e6dfad19418a9b3710288bb5c8aae50", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/36eff0682e6dfad19418a9b3710288bb5c8aae50", "committedDate": "2020-04-21T01:10:33Z", "message": "Expose cacheHolder as package private"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTA1ODIw", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-397505820", "createdAt": "2020-04-21T17:10:09Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDowOVrOGJPEwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMDowOVrOGJPEwg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzNzM0Ng==", "bodyText": "We typically monospace input text.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                that are allowed to be compiled for a given context. Defaults to 75/5m,\n          \n          \n            \n                that are allowed to be compiled for a given context. Defaults to `75/5m`,", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r412337346", "createdAt": "2020-04-21T17:10:09Z", "author": {"login": "jrodewig"}, "path": "docs/reference/modules/indices/circuit_breaker.asciidoc", "diffHunk": "@@ -111,8 +111,8 @@ within a period of time.\n See the \"prefer-parameters\" section of the <<modules-scripting-using,scripting>>\n documentation for more information.\n \n-`script.max_compilations_rate`::\n+`script.context.$CONTEXT.max_compilations_rate`::\n \n     Limit for the number of unique dynamic scripts within a certain interval\n-    that are allowed to be compiled. Defaults to 75/5m, meaning 75 every 5 \n-    minutes.\n+    that are allowed to be compiled for a given context. Defaults to 75/5m,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTA2OTc3", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-397506977", "createdAt": "2020-04-21T17:11:37Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMTozN1rOGJPI0A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yMVQxNzoxMTozN1rOGJPI0A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMjMzODM4NA==", "bodyText": "We do single space between sentences.\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            for ingest contexts.  You can change these settings dynamically by setting\n          \n          \n            \n            for ingest contexts. You can change these settings dynamically by setting", "url": "https://github.com/elastic/elasticsearch/pull/55038#discussion_r412338384", "createdAt": "2020-04-21T17:11:37Z", "author": {"login": "jrodewig"}, "path": "docs/reference/scripting/using.asciidoc", "diffHunk": "@@ -98,9 +98,11 @@ second version is only compiled once.\n \n If you compile too many unique scripts within a small amount of time,\n Elasticsearch will reject the new dynamic scripts with a\n-`circuit_breaking_exception` error. By default, up to 15 inline scripts per\n-minute will be compiled. You can change this setting dynamically by setting\n-`script.max_compilations_rate`.\n+`circuit_breaking_exception` error. By default, up to 75 scripts per\n+5 minutes will be compiled for most contexts and 375 scripts per 5 minutes\n+for ingest contexts.  You can change these settings dynamically by setting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "originalPosition": 9}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk3NTA3MDc0", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-397507074", "createdAt": "2020-04-21T17:11:44Z", "commit": {"oid": "b61dd0647de95bc8f67044ce92bb0cb89655e40c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "760fdb76192efced0fb0dae770b4afe2cb321cb7", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/760fdb76192efced0fb0dae770b4afe2cb321cb7", "committedDate": "2020-04-21T17:20:08Z", "message": "monospace 75/5m in cbreaker docs, single space in using"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d2c9ea88c9183b45fcdd66f679a17d6e8718d12", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d2c9ea88c9183b45fcdd66f679a17d6e8718d12", "committedDate": "2020-04-21T20:10:14Z", "message": "More detail in general compilation rate error"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2fdbaab3917971d6664f968dedf90bb0b7dbae", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb2fdbaab3917971d6664f968dedf90bb0b7dbae", "committedDate": "2020-04-21T23:39:16Z", "message": "Test: don't modify defaultConfig on upgrade"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzkzMjA1MzEz", "url": "https://github.com/elastic/elasticsearch/pull/55038#pullrequestreview-393205313", "createdAt": "2020-04-14T18:52:30Z", "commit": {"oid": "98b6bb41b1906815dbc900c1419ef9769fea005d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6ceb9233ccd121cf7285abf34abdcdb298d23812", "author": {"user": {"login": "stu-elastic", "name": "Stuart Tettemer"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ceb9233ccd121cf7285abf34abdcdb298d23812", "committedDate": "2020-04-22T15:37:33Z", "message": "Merge 58ec9c3\n\nMerge branch 'master' of github.com:elastic/elasticsearch into fix/50152-painless-limit-per-context__05__deprecate"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3440, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}