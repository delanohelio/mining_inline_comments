{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyOTY3ODc5", "number": 58877, "reviewThreads": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzo1Nzo0MFrOEMX_YQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo1NDo1OVrOEMb1vw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDExNDI1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionEvaluationIT.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzo1Nzo0MFrOGucerg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwNzo1Nzo0MFrOGucerg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1NDI4Ng==", "bodyText": "Why is this set to true for RegressionEvaluationIT but false for ClassificationEvaluationIT?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451354286", "createdAt": "2020-07-08T07:57:40Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionEvaluationIT.java", "diffHunk": "@@ -148,4 +148,9 @@ private static void indexHousesData(String indexName) {\n             fail(\"Failed to index data: \" + bulkResponse.buildFailureMessage());\n         }\n     }\n+\n+    @Override\n+    boolean supportsInference() {\n+        return true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDEzOTAzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/CrossValidationSplitterFactory.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowNDozMVrOGucucA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODowNDozMVrOGucucA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM1ODMyMA==", "bodyText": "[nit] You can drop the parentheses here", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451358320", "createdAt": "2020-07-08T08:04:31Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/CrossValidationSplitterFactory.java", "diffHunk": "@@ -47,7 +47,7 @@ public CrossValidationSplitter create() {\n         if (config.getAnalysis() instanceof Classification) {\n             return createStratifiedSplitter((Classification) config.getAnalysis());\n         }\n-        return (row, incrementTrainingDocs, incrementTestDocs) -> incrementTrainingDocs.run();\n+        return (row) -> true;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 5}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDI2MzQxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoiner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODozNzo1NVrOGud8Fg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODozNzo1NVrOGud8Fg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM3ODE5OA==", "bodyText": "IMO the logic would be simpler (less comparisons with false) if this method was negated.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451378198", "createdAt": "2020-07-08T08:37:55Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoiner.java", "diffHunk": "@@ -162,17 +162,21 @@ public boolean hasNext() {\n         @Override\n         public DataFrameDataExtractor.Row next() {\n             DataFrameDataExtractor.Row row = null;\n-            while ((row == null || row.shouldSkip()) && hasNext()) {\n+            while (shouldHaveMatch(row) == false && hasNext()) {\n                 advanceToNextBatchIfNecessary();\n                 row = currentDataFrameRows.get(currentDataFrameRowsIndex++);\n             }\n \n-            if (row == null || row.shouldSkip()) {\n+            if (shouldHaveMatch(row) == false) {\n                 throw ExceptionsHelper.serverError(\"no more data frame rows could be found while joining results\");\n             }\n             return row;\n         }\n \n+        private boolean shouldHaveMatch(DataFrameDataExtractor.Row row) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDI3MjA2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoinerTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0MDoxNVrOGueBkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0MDoxNVrOGueBkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM3OTYwMA==", "bodyText": "I think there is no need to mix List.of and Arrays.asList here. Could you choose one of them (probably Arrays.asList as the code below suggests you want to make it backportable to 7.x)?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451379600", "createdAt": "2020-07-08T08:40:15Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/DataFrameRowsJoinerTests.java", "diffHunk": "@@ -188,12 +188,72 @@ public void testProcess_GivenTwoBatchesWhereFirstEndsWithSkippedRow() throws IOE\n         assertThat(indexedDocSource.get(\"b\"), equalTo(\"2\"));\n     }\n \n+    public void testProcess_GivenSingleBatchWithTestRows() throws IOException {\n+        givenClientHasNoFailures();\n+\n+        String dataDoc = \"{\\\"f_1\\\": \\\"foo\\\", \\\"f_2\\\": 42.0}\";\n+        String[] dataValues = {\"42.0\"};\n+        DataFrameDataExtractor.Row testRow = newTestRow(newHit(dataDoc), dataValues, 1);\n+        DataFrameDataExtractor.Row normalRow = newTrainingRow(newHit(dataDoc), dataValues, 2);\n+        givenDataFrameBatches(List.of(Arrays.asList(testRow, normalRow)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 69}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDI5MzAxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitterTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0NTo0MlrOGuePJA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0NTo0MlrOGuePJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4MzA3Ng==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                            boolean istraining = crossValidationSplitter.isTraining(processedRow);\n          \n          \n            \n                            boolean isTraining = crossValidationSplitter.isTraining(processedRow);", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451383076", "createdAt": "2020-07-08T08:45:42Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/process/crossvalidation/StratifiedCrossValidationSplitterTests.java", "diffHunk": "@@ -211,9 +199,10 @@ public void testProcess_SelectsTrainingRowsUniformly() {\n                 }\n \n                 String[] processedRow = Arrays.copyOf(row, row.length);\n-                crossValidationSplitter.process(processedRow, this::incrementTrainingDocsCount, this::incrementTestDocsCount);\n+                boolean istraining = crossValidationSplitter.isTraining(processedRow);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 129}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDI5ODM2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsResultProcessor.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0NzoxMVrOGueSrA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0NzoxMVrOGueSrA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4Mzk4MA==", "bodyText": "I think current and latest mean the same thing here.\nCould you use the same word for method name and variable name?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451383980", "createdAt": "2020-07-08T08:47:11Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsResultProcessor.java", "diffHunk": "@@ -190,4 +191,9 @@ private void processMemoryUsage(MemoryUsage memoryUsage) {\n         statsHolder.setMemoryUsage(memoryUsage);\n         statsPersister.persistWithRetry(memoryUsage, memoryUsage::documentId);\n     }\n+\n+    @Nullable\n+    public String getLatestModelId() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 32}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDI5OTkzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo0NzozM1rOGueToA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNjoxNDowMlrOGuvYWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDIyNA==", "bodyText": "nit: this is a very generic message can we be more precise. Is this testing?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451384224", "createdAt": "2020-07-08T08:47:33Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;\n+    private static final int RESULTS_BATCH_SIZE = 1000;\n+\n+    private final Client client;\n+    private final ModelLoadingService modelLoadingService;\n+    private final ResultsPersisterService resultsPersisterService;\n+    private final TaskId parentTaskId;\n+    private final DataFrameAnalyticsConfig config;\n+    private final ProgressTracker progressTracker;\n+    private final DataCountsTracker dataCountsTracker;\n+    private volatile boolean isCancelled;\n+\n+    public InferenceRunner(Client client, ModelLoadingService modelLoadingService, ResultsPersisterService resultsPersisterService,\n+                           TaskId parentTaskId, DataFrameAnalyticsConfig config, ProgressTracker progressTracker,\n+                           DataCountsTracker dataCountsTracker) {\n+        this.client = Objects.requireNonNull(client);\n+        this.modelLoadingService = Objects.requireNonNull(modelLoadingService);\n+        this.resultsPersisterService = Objects.requireNonNull(resultsPersisterService);\n+        this.parentTaskId = Objects.requireNonNull(parentTaskId);\n+        this.config = Objects.requireNonNull(config);\n+        this.progressTracker = Objects.requireNonNull(progressTracker);\n+        this.dataCountsTracker = Objects.requireNonNull(dataCountsTracker);\n+    }\n+\n+    public void cancel() {\n+        isCancelled = true;\n+    }\n+\n+    public void run(String modelId) {\n+        if (isCancelled) {\n+            return;\n+        }\n+\n+        LOGGER.info(\"[{}] Running inference on model [{}]\", config.getId(), modelId);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 73}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY2Mzk2MA==", "bodyText": "I have reworded this one and removed the \"finished\" one.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451663960", "createdAt": "2020-07-08T16:14:02Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;\n+    private static final int RESULTS_BATCH_SIZE = 1000;\n+\n+    private final Client client;\n+    private final ModelLoadingService modelLoadingService;\n+    private final ResultsPersisterService resultsPersisterService;\n+    private final TaskId parentTaskId;\n+    private final DataFrameAnalyticsConfig config;\n+    private final ProgressTracker progressTracker;\n+    private final DataCountsTracker dataCountsTracker;\n+    private volatile boolean isCancelled;\n+\n+    public InferenceRunner(Client client, ModelLoadingService modelLoadingService, ResultsPersisterService resultsPersisterService,\n+                           TaskId parentTaskId, DataFrameAnalyticsConfig config, ProgressTracker progressTracker,\n+                           DataCountsTracker dataCountsTracker) {\n+        this.client = Objects.requireNonNull(client);\n+        this.modelLoadingService = Objects.requireNonNull(modelLoadingService);\n+        this.resultsPersisterService = Objects.requireNonNull(resultsPersisterService);\n+        this.parentTaskId = Objects.requireNonNull(parentTaskId);\n+        this.config = Objects.requireNonNull(config);\n+        this.progressTracker = Objects.requireNonNull(progressTracker);\n+        this.dataCountsTracker = Objects.requireNonNull(dataCountsTracker);\n+    }\n+\n+    public void cancel() {\n+        isCancelled = true;\n+    }\n+\n+    public void run(String modelId) {\n+        if (isCancelled) {\n+            return;\n+        }\n+\n+        LOGGER.info(\"[{}] Running inference on model [{}]\", config.getId(), modelId);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NDIyNA=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 73}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMxODQwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1MjoxMlrOGuee3g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1MjoxMlrOGuee3g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4NzEwMg==", "bodyText": "Why is it 98 rather than 99?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451387102", "createdAt": "2020-07-08T08:52:12Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMyNDY1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunnerTests.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1Mzo0OFrOGuei2g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1Mzo0OFrOGuei2g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4ODEyMg==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451388122", "createdAt": "2020-07-08T08:53:48Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunnerTests.java", "diffHunk": "@@ -0,0 +1,165 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.elasticsearch.ElasticsearchException;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.common.bytes.BytesReference;\n+import org.elasticsearch.common.xcontent.XContentBuilder;\n+import org.elasticsearch.common.xcontent.XContentFactory;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.test.ESTestCase;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsDest;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsSource;\n+import org.elasticsearch.xpack.core.ml.dataframe.analyses.RegressionTests;\n+import org.elasticsearch.xpack.core.ml.inference.results.ClassificationInferenceResults;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.inference.trainedmodel.ClassificationConfig;\n+import org.elasticsearch.xpack.core.ml.inference.trainedmodel.InferenceConfig;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+import org.junit.Before;\n+import org.mockito.ArgumentCaptor;\n+import org.mockito.Mockito;\n+\n+import java.io.IOException;\n+import java.util.ArrayDeque;\n+import java.util.Arrays;\n+import java.util.Collections;\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.stream.Collectors;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+import static org.mockito.Matchers.any;\n+import static org.mockito.Mockito.mock;\n+import static org.mockito.Mockito.verify;\n+import static org.mockito.Mockito.when;\n+\n+public class InferenceRunnerTests extends ESTestCase {\n+\n+    private Client client;\n+    private ResultsPersisterService resultsPersisterService;\n+    private ModelLoadingService modelLoadingService;\n+    private DataFrameAnalyticsConfig config;\n+    private ProgressTracker progressTracker;\n+    private TaskId parentTaskId;\n+\n+    @Before\n+    public void setupTests() {\n+        client = mock(Client.class);\n+        resultsPersisterService = mock(ResultsPersisterService.class);\n+        config = new DataFrameAnalyticsConfig.Builder()\n+            .setId(\"test\")\n+            .setAnalysis(RegressionTests.createRandom())\n+            .setSource(new DataFrameAnalyticsSource(new String[] {\"source_index\"}, null, null))\n+            .setDest(new DataFrameAnalyticsDest(\"dest_index\", \"test_results_field\"))\n+            .build();\n+        progressTracker = ProgressTracker.fromZeroes(config.getAnalysis().getProgressPhases(), config.getAnalysis().supportsInference());\n+        parentTaskId = new TaskId(randomAlphaOfLength(10), randomLong());\n+        modelLoadingService = mock(ModelLoadingService.class);\n+    }\n+\n+    public void testInferTestDocs() {\n+        Map<String, Object> doc1 = new HashMap<>();\n+        doc1.put(\"key\", 1);\n+        Map<String, Object> doc2 = new HashMap<>();\n+        doc2.put(\"key\", 2);\n+        TestDocsIterator testDocsIterator = mock(TestDocsIterator.class);\n+        when(testDocsIterator.hasNext()).thenReturn(true, false);\n+        when(testDocsIterator.next()).thenReturn(buildSearchHits(Arrays.asList(doc1, doc2)));\n+        when(testDocsIterator.getTotalHits()).thenReturn(2L);\n+        InferenceConfig config = ClassificationConfig.EMPTY_PARAMS;\n+\n+        LocalModel localModel = localModelInferences(new ClassificationInferenceResults(1.0,\n+        \"foo\",\n+            Collections.emptyList(),\n+            config),\n+            new ClassificationInferenceResults(0.0,\n+                \"bar\",\n+                Collections.emptyList(),\n+                config));\n+\n+        InferenceRunner inferenceRunner = createInferenceRunner();\n+\n+        inferenceRunner.inferTestDocs(localModel, testDocsIterator);\n+\n+        ArgumentCaptor<BulkRequest> argumentCaptor = ArgumentCaptor.forClass(BulkRequest.class);\n+\n+        verify(resultsPersisterService).bulkIndexWithHeadersWithRetry(any(), argumentCaptor.capture(), any(), any(), any());\n+        assertThat(progressTracker.getInferenceProgressPercent(), equalTo(100));\n+\n+        BulkRequest bulkRequest = argumentCaptor.getAllValues().get(0);\n+        List<DocWriteRequest<?>> indexRequests = bulkRequest.requests();\n+        Map<String, Object> doc1Source = ((IndexRequest)indexRequests.get(0)).sourceAsMap();\n+        Map<String, Object> doc2Source = ((IndexRequest)indexRequests.get(1)).sourceAsMap();\n+\n+        assertThat(doc1Source.get(\"test_results_field\"),\n+            equalTo(new HashMap<>(){{\n+                put(\"predicted_value\", \"foo\");\n+                put(\"is_training\", false);\n+        }}));\n+        assertThat(doc2Source.get(\"test_results_field\"),\n+            equalTo(new HashMap<>(){{\n+                put(\"predicted_value\", \"bar\");\n+                put(\"is_training\", false);\n+            }}));\n+    }\n+\n+    public void testInferTestDocs_GivenCancelWasCalled() {\n+\n+        LocalModel localModel = mock(LocalModel.class);\n+\n+        TestDocsIterator infiniteDocsIterator = mock(TestDocsIterator.class);\n+        when(infiniteDocsIterator.hasNext()).thenReturn(true);\n+\n+        InferenceRunner inferenceRunner = createInferenceRunner();\n+        inferenceRunner.cancel();\n+\n+        inferenceRunner.inferTestDocs(localModel, infiniteDocsIterator);\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 134}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMyODExOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "isResolved": true, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1NDozNlrOGuek9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMjozMjowMVrOGul3gg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4ODY2Mw==", "bodyText": "I'm pleased you've implemented the progress meter gets to fixed number then stalls for ages feature", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451388663", "createdAt": "2020-07-08T08:54:36Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ4MzAzMA==", "bodyText": "Hehe! It's not what it looks like!\n@przemekwitek This answer should also cover your question about the magic 98.\nSo, this is a fairly linear progress here. We go through the test docs, infer, and bulk index when we have a batch. The only reason we want to hold the progress from going 100, is that after we infer the last doc there's still a bulk index action pending and we don't want to appear completed before that.\nWhy 98 instead of 99, just to make room for a slow bulk index. :-)", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451483030", "createdAt": "2020-07-08T11:51:37Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4ODY2Mw=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 40}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUwODA5OA==", "bodyText": "Can we make it 97.5 instead", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451508098", "createdAt": "2020-07-08T12:32:01Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/InferenceRunner.java", "diffHunk": "@@ -0,0 +1,149 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.ml.dataframe.inference;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.elasticsearch.action.DocWriteRequest;\n+import org.elasticsearch.action.bulk.BulkRequest;\n+import org.elasticsearch.action.index.IndexRequest;\n+import org.elasticsearch.action.support.PlainActionFuture;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.search.SearchHit;\n+import org.elasticsearch.tasks.TaskId;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n+import org.elasticsearch.xpack.core.ml.inference.results.InferenceResults;\n+import org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper;\n+import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.dataframe.stats.DataCountsTracker;\n+import org.elasticsearch.xpack.ml.dataframe.stats.ProgressTracker;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.LocalModel;\n+import org.elasticsearch.xpack.ml.inference.loadingservice.ModelLoadingService;\n+import org.elasticsearch.xpack.ml.utils.persistence.ResultsPersisterService;\n+\n+import java.util.Deque;\n+import java.util.HashMap;\n+import java.util.LinkedHashMap;\n+import java.util.Map;\n+import java.util.Objects;\n+\n+public class InferenceRunner {\n+\n+    private static final Logger LOGGER = LogManager.getLogger(InferenceRunner.class);\n+\n+    private static final int MAX_PROGRESS_BEFORE_COMPLETION = 98;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM4ODY2Mw=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 40}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDMzODc1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1NzowMlrOGuerWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQwODo1NzowMlrOGuerWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTM5MDI5OA==", "bodyText": "Please make it final.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451390298", "createdAt": "2020-07-08T08:57:02Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -44,12 +46,19 @@\n \n     private final OriginSettingClient client;\n     private final String index;\n+    private final boolean trackTotalHits;\n+    private AtomicLong totalHits = new AtomicLong();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 21}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDcxODA0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo0NTo1NlrOGuiXLA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMTo1Mjo0MlrOGukXoA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1MDY2OA==", "bodyText": "Looks like a partial refactoring, a public method should not be called internalX.\nThis does not update the stats fields as infer() does is that intentional?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451450668", "createdAt": "2020-07-08T10:45:56Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -80,6 +80,15 @@ void persistStats(boolean flush) {\n         }\n     }\n \n+    public InferenceResults internalInfer(Map<String, Object> fields) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ4MzU1Mg==", "bodyText": "I agree. I'll rename this to inferNoStats. Indeed, we intentionally don't want to account stats here as it's not an explicit user action but rather the implicit consequence of running the job that trains the model in the first place.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451483552", "createdAt": "2020-07-08T11:52:42Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/inference/loadingservice/LocalModel.java", "diffHunk": "@@ -80,6 +80,15 @@ void persistStats(boolean flush) {\n         }\n     }\n \n+    public InferenceResults internalInfer(Map<String, Object> fields) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1MDY2OA=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjgxNDc0NDk1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "isResolved": true, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDo1NDo1OVrOGuioZA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxNjoyODowNFrOGuv7dQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1NTA3Ng==", "bodyText": "Whats the behaviour here if the documents in the index change between batches e.g. if more are added or removed? Will the value getTotalHits() change?", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451455076", "createdAt": "2020-07-08T10:54:59Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -88,6 +97,9 @@ public boolean hasNext() {\n         }\n \n         SearchResponse searchResponse = doSearch(searchAfterFields());\n+        if (trackTotalHits && totalHits.get() == 0) {\n+            totalHits.set(searchResponse.getHits().getTotalHits().value);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ4NTI4MQ==", "bodyText": "Good point. I only track total hits in the first search to avoid possible overhead after the first time. But in an index that is receiving new docs that number may become outdated. Not sure what's the best way to go about this though. I could make an extra search request just for getting the total hits count instead of adding this here. But I'm not sure.\nAn alternative design would be for the SearchAfterDocumentsIterator to allow for a sub-class to add this and then take care of it only in the TestDocsIterator where we know we're dealing with a static index.\nOpen to ideas.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451485281", "createdAt": "2020-07-08T11:55:54Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -88,6 +97,9 @@ public boolean hasNext() {\n         }\n \n         SearchResponse searchResponse = doSearch(searchAfterFields());\n+        if (trackTotalHits && totalHits.get() == 0) {\n+            totalHits.set(searchResponse.getHits().getTotalHits().value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1NTA3Ng=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTUxODc1MQ==", "bodyText": "You could used BatchedDocumentsIterator which uses scroll but testing may take a while and you have to keep the context alive.\nDo you expect any changes to the underlying index when this is running? TBH this is only used in the progress meter which are notoriously imprecise. Embrace the imprecision and let that progress meter bounce up and down", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451518751", "createdAt": "2020-07-08T12:50:05Z", "author": {"login": "davidkyle"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -88,6 +97,9 @@ public boolean hasNext() {\n         }\n \n         SearchResponse searchResponse = doSearch(searchAfterFields());\n+        if (trackTotalHits && totalHits.get() == 0) {\n+            totalHits.set(searchResponse.getHits().getTotalHits().value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1NTA3Ng=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTY3Mjk0OQ==", "bodyText": "I ended up adding a comment that explains how total hits are tracked.", "url": "https://github.com/elastic/elasticsearch/pull/58877#discussion_r451672949", "createdAt": "2020-07-08T16:28:04Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/utils/persistence/SearchAfterDocumentsIterator.java", "diffHunk": "@@ -88,6 +97,9 @@ public boolean hasNext() {\n         }\n \n         SearchResponse searchResponse = doSearch(searchAfterFields());\n+        if (trackTotalHits && totalHits.get() == 0) {\n+            totalHits.set(searchResponse.getHits().getTotalHits().value);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQ1NTA3Ng=="}, "originalCommit": {"oid": "e7775048eb7f3d7ff4ee973e6dec9f10e2ffb81f"}, "originalPosition": 41}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2116, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}