{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc5OTg4Njc1", "number": 62007, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxOTo1NzoyM1rOEgujqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjozMjo0MVrOEg_R6A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNzUyNjgyOnYy", "diffSide": "RIGHT", "path": "plugins/transport-nio/src/main/java/org/elasticsearch/http/nio/HttpReadWriteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxOTo1NzoyM1rOHNrmtw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQxOTo1NzoyM1rOHNrmtw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEwNzk1OQ==", "bodyText": "NIT: Maybe move this to CorsHandler as well since we duplicate it across both implementations? (unless my suggestion works and we can just move the whole handling to org.elasticsearch.http.AbstractHttpServerTransport#incomingRequest)", "url": "https://github.com/elastic/elasticsearch/pull/62007#discussion_r484107959", "createdAt": "2020-09-06T19:57:23Z", "author": {"login": "original-brownbear"}, "path": "plugins/transport-nio/src/main/java/org/elasticsearch/http/nio/HttpReadWriteHandler.java", "diffHunk": "@@ -185,4 +196,12 @@ private static boolean assertMessageTypes(Object message) {\n                 \". Found type: \" + ((HttpPipelinedResponse) message).getDelegateRequest().getClass() + \".\";\n         return true;\n     }\n+\n+    private static ActionListener<Void> earlyResponseListener(HttpRequest request, HttpChannel httpChannel) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39393dca43b5444fd46405a55734273c455ba01d"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNzUyOTcwOnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/http/CorsHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMDowMToxMVrOHNroEA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMDowMToxMVrOHNroEA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDEwODMwNA==", "bodyText": "NIT: extra empty line", "url": "https://github.com/elastic/elasticsearch/pull/62007#discussion_r484108304", "createdAt": "2020-09-06T20:01:11Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/http/CorsHandler.java", "diffHunk": "@@ -71,12 +78,175 @@\n     public static final String ORIGIN = \"origin\";\n     public static final String DATE = \"date\";\n     public static final String VARY = \"vary\";\n+    public static final String HOST = \"host\";\n     public static final String ACCESS_CONTROL_REQUEST_METHOD = \"access-control-request-method\";\n+    public static final String ACCESS_CONTROL_ALLOW_HEADERS = \"access-control-allow-headers\";\n+    public static final String ACCESS_CONTROL_ALLOW_CREDENTIALS = \"access-control-allow-credentials\";\n+    public static final String ACCESS_CONTROL_ALLOW_METHODS = \"access-control-allow-methods\";\n     public static final String ACCESS_CONTROL_ALLOW_ORIGIN = \"access-control-allow-origin\";\n+    public static final String ACCESS_CONTROL_MAX_AGE = \"access-control-max-age\";\n \n-    private CorsHandler() {\n+    private static final Pattern SCHEME_PATTERN = Pattern.compile(\"^https?://\");\n+    private static final DateTimeFormatter dateTimeFormatter = DateTimeFormatter.ofPattern(\"EEE, dd MMM yyyy HH:mm:ss O\", Locale.ENGLISH);\n+    private final Config config;\n+\n+    public CorsHandler(Config config) {\n+        this.config = config;\n+    }\n+\n+    public HttpResponse handleInbound(HttpRequest request) {\n+        if (config.isCorsSupportEnabled()) {\n+            if (isPreflightRequest(request)) {\n+                return handlePreflight(request);\n+            }\n+\n+            if (validateOrigin(request) == false) {\n+                return forbidden(request);\n+            }\n+        }\n+        return null;\n+    }\n+\n+    public void setCorsResponseHeaders(final HttpRequest httpRequest, final HttpResponse httpResponse) {\n+        if (!config.isCorsSupportEnabled()) {\n+            return;\n+        }\n+        if (setOrigin(httpRequest, httpResponse)) {\n+            setAllowCredentials(httpResponse);\n+        }\n+    }\n+\n+    private HttpResponse handlePreflight(final HttpRequest request) {\n+        final HttpResponse response = request.createResponse(RestStatus.OK, BytesArray.EMPTY);\n+        if (setOrigin(request, response)) {\n+            setAllowMethods(response);\n+            setAllowHeaders(response);\n+            setAllowCredentials(response);\n+            setMaxAge(response);\n+            setPreflightHeaders(response);\n+            return response;\n+        } else {\n+            return forbidden(request);\n+        }\n+    }\n+\n+    private static HttpResponse forbidden(final HttpRequest request) {\n+        HttpResponse response = request.createResponse(RestStatus.FORBIDDEN, BytesArray.EMPTY);\n+        response.addHeader(\"content-length\", \"0\");\n+        return response;\n+    }\n+\n+    private static boolean isSameOrigin(final String origin, final String host) {\n+        if (Strings.isNullOrEmpty(host) == false) {\n+            // strip protocol from origin\n+            final String originDomain = SCHEME_PATTERN.matcher(origin).replaceFirst(\"\");\n+            if (host.equals(originDomain)) {\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private void setPreflightHeaders(final HttpResponse response) {\n+        response.addHeader(CorsHandler.DATE, dateTimeFormatter.format(ZonedDateTime.now(ZoneOffset.UTC)));\n+        response.addHeader(\"content-length\", \"0\");\n+    }\n+\n+    private boolean setOrigin(final HttpRequest request, final HttpResponse response) {\n+        String origin = getOrigin(request);\n+        if (!Strings.isNullOrEmpty(origin)) {\n+            if (config.isAnyOriginSupported()) {\n+                if (config.isCredentialsAllowed()) {\n+                    setAllowOrigin(response, origin);\n+                    setVaryHeader(response);\n+                } else {\n+                    setAllowOrigin(response, ANY_ORIGIN);\n+                }\n+                return true;\n+            } else if (config.isOriginAllowed(origin) || isSameOrigin(origin, getHost(request))) {\n+                setAllowOrigin(response, origin);\n+                setVaryHeader(response);\n+                return true;\n+            }\n+        }\n+        return false;\n+    }\n+\n+    private boolean validateOrigin(final HttpRequest request) {\n+        if (config.isAnyOriginSupported()) {\n+            return true;\n+        }\n+\n+        final String origin = getOrigin(request);\n+        if (Strings.isNullOrEmpty(origin)) {\n+            // Not a CORS request so we cannot validate it. It may be a non CORS request.\n+            return true;\n+        }\n+\n+        // if the origin is the same as the host of the request, then allow\n+        if (isSameOrigin(origin, getHost(request))) {\n+            return true;\n+        }\n+\n+        return config.isOriginAllowed(origin);\n+    }\n+\n+    private static String getOrigin(HttpRequest request) {\n+        List<String> headers = request.getHeaders().get(ORIGIN);\n+        if (headers == null || headers.isEmpty()) {\n+            return null;\n+        } else {\n+            return headers.get(0);\n+        }\n+    }\n+\n+    private static String getHost(HttpRequest request) {\n+        List<String> headers = request.getHeaders().get(HOST);\n+        if (headers == null || headers.isEmpty()) {\n+            return null;\n+        } else {\n+            return headers.get(0);\n+        }\n+    }\n+\n+    private static boolean isPreflightRequest(final HttpRequest request) {\n+        final Map<String, List<String>> headers = request.getHeaders();\n+        return request.method().equals(RestRequest.Method.OPTIONS) &&\n+            headers.containsKey(ORIGIN) &&\n+            headers.containsKey(ACCESS_CONTROL_REQUEST_METHOD);\n+    }\n+\n+    private static void setVaryHeader(final HttpResponse response) {\n+        response.addHeader(VARY, ORIGIN);\n     }\n \n+    private static void setAllowOrigin(final HttpResponse response, final String origin) {\n+        response.addHeader(ACCESS_CONTROL_ALLOW_ORIGIN, origin);\n+    }\n+\n+    private void setAllowMethods(final HttpResponse response) {\n+        for (RestRequest.Method method : config.allowedRequestMethods()) {\n+            response.addHeader(ACCESS_CONTROL_ALLOW_METHODS, method.name().trim());\n+        }\n+    }\n+\n+    private void setAllowHeaders(final HttpResponse response) {\n+        for (String header : config.allowedRequestHeaders) {\n+            response.addHeader(ACCESS_CONTROL_ALLOW_HEADERS, header);\n+        }\n+    }\n+\n+    private void setAllowCredentials(final HttpResponse response) {\n+        if (config.isCredentialsAllowed()) {\n+            response.addHeader(ACCESS_CONTROL_ALLOW_CREDENTIALS, \"true\");\n+        }\n+    }\n+\n+    private void setMaxAge(final HttpResponse response) {\n+        response.addHeader(ACCESS_CONTROL_MAX_AGE, Long.toString(config.maxAge));\n+    }\n+\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39393dca43b5444fd46405a55734273c455ba01d"}, "originalPosition": 206}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAyNzU0OTI1OnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/http/netty4/Netty4HttpRequestHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMDoyODowNVrOHNrxMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNlQyMDoyODowNVrOHNrxMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDExMDY0MQ==", "bodyText": "Maybe we could just move this whole logic into org.elasticsearch.http.AbstractHttpServerTransport#incomingRequest to make things even drier?", "url": "https://github.com/elastic/elasticsearch/pull/62007#discussion_r484110641", "createdAt": "2020-09-06T20:28:05Z", "author": {"login": "original-brownbear"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/http/netty4/Netty4HttpRequestHandler.java", "diffHunk": "@@ -23,23 +23,40 @@\n import io.netty.channel.ChannelHandlerContext;\n import io.netty.channel.SimpleChannelInboundHandler;\n import org.elasticsearch.ExceptionsHelper;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.common.network.CloseableChannel;\n+import org.elasticsearch.http.CorsHandler;\n+import org.elasticsearch.http.HttpChannel;\n import org.elasticsearch.http.HttpPipelinedRequest;\n+import org.elasticsearch.http.HttpRequest;\n+import org.elasticsearch.http.HttpResponse;\n+import org.elasticsearch.http.HttpUtils;\n \n @ChannelHandler.Sharable\n class Netty4HttpRequestHandler extends SimpleChannelInboundHandler<HttpPipelinedRequest> {\n \n+    private static final ActionListener<Void> NO_OP = ActionListener.wrap(() -> {});\n+\n     private final Netty4HttpServerTransport serverTransport;\n+    private final CorsHandler corsHandler;\n \n-    Netty4HttpRequestHandler(Netty4HttpServerTransport serverTransport) {\n+    Netty4HttpRequestHandler(Netty4HttpServerTransport serverTransport, CorsHandler corsHandler) {\n         this.serverTransport = serverTransport;\n+        this.corsHandler = corsHandler;\n     }\n \n     @Override\n     protected void channelRead0(ChannelHandlerContext ctx, HttpPipelinedRequest httpRequest) {\n         final Netty4HttpChannel channel = ctx.channel().attr(Netty4HttpServerTransport.HTTP_CHANNEL_KEY).get();\n         boolean success = false;\n         try {\n-            serverTransport.incomingRequest(httpRequest, channel);\n+            HttpResponse earlyResponse = corsHandler.handleInbound(httpRequest);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "39393dca43b5444fd46405a55734273c455ba01d"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzAzMDI2NjY0OnYy", "diffSide": "RIGHT", "path": "plugins/transport-nio/src/main/java/org/elasticsearch/http/nio/HttpReadWriteHandler.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjozMjo0MlrOHOEgqA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wN1QxNjozMjo0MlrOHOEgqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NDUxNjAwOA==", "bodyText": "I guess we can revert changes to this method now?", "url": "https://github.com/elastic/elasticsearch/pull/62007#discussion_r484516008", "createdAt": "2020-09-07T16:32:42Z", "author": {"login": "original-brownbear"}, "path": "plugins/transport-nio/src/main/java/org/elasticsearch/http/nio/HttpReadWriteHandler.java", "diffHunk": "@@ -150,16 +145,15 @@ public void close() throws IOException {\n         }\n     }\n \n-    @SuppressWarnings(\"unchecked\")\n     private void handleRequest(Object msg) {\n-        final HttpPipelinedRequest pipelinedRequest = (HttpPipelinedRequest) msg;\n+        final HttpPipelinedRequest httpRequest = (HttpPipelinedRequest) msg;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "328d243cccb82c4536b92a33a2592ced8b0727e6"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1771, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}