{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE4MjY0MDky", "number": 56797, "title": "SQL: JDBC: fix access to the Manifest for non-entry JAR URLs", "bodyText": "The JDBC driver will attempt to read its version from the Manifest file\nembedded into its JAR. The URL pointing to the JAR can be provided in a\nfew ways.\nSo far, accessing the Manfiest was attempted by getting a URLConnection\nout of the URL and then getting an input stream out of this connection.\nFor file JAR URLs, this only works however if the URL points to the\ndriver as a JAR file entry (i.e. <sub-url>!/jdbc-driver.jar!/). If\nthat's not the case, the JarURLConnection will throw an IOException.\nThis PR fixes that: in case the URL points to a JAR entry\n(jar:file:<path>/jdbc-driver.jar!/), the manifest is read directly with\nJarURLConnection#getManifest().\nFixes #56759.", "createdAt": "2020-05-14T21:49:49Z", "url": "https://github.com/elastic/elasticsearch/pull/56797", "merged": true, "mergeCommit": {"oid": "2175b7b01cf5fcf3ab2bb21404a9bd454a8df3f0"}, "closed": true, "closedAt": "2020-05-15T16:14:35Z", "author": {"login": "bpintea"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchUZtdAH2gAyNDE4MjY0MDkyOmNmNDViOWE5ZWYwZWNiMDY1ZTcxYTY4ZTJkN2VlNzc2NjcwMGVmMTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABchizkegH2gAyNDE4MjY0MDkyOjRmMjRkM2Y1ZTc0Yjk3MWVhYmU3YjdhM2MxNGE0NmNiY2RmYmI3NWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "cf45b9a9ef0ecb065e71a68e2d7ee7766700ef17", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/cf45b9a9ef0ecb065e71a68e2d7ee7766700ef17", "committedDate": "2020-05-14T21:31:46Z", "message": "JDBC: fix access to the Manifest for non-entry JAR\n\nThe JDBC driver will attempt to read its version from the Manifest file\nembedded into its JAR. The URL pointing to the JAR can be provided in a\nfew ways.\n\nSo far, accessing the Manfiest was attempted by getting a URLConnection\nout of the URL and then getting an input stream out of this connection.\nFor file JAR URLs, this only works however if the URL points to the\ndriver as a JAR file entry (i.e. <sub-url>!/jdbc-driver.jar!/). If\nthat's not the case, the JarURLConnection will throw an IOException.\n\nThis commit fixes that: in case the URL points to a JAR entry\n(jar:file:<path>/jdbc-driver.jar!/), the manifest is read directly with\nJarURLConnection#getManifest()."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/0bfdee6473a573641c01e4ffdc40299f2300190c", "committedDate": "2020-05-14T22:03:25Z", "message": "Fix style errors\n\nRemove unused import."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyMzkzNzU0", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412393754", "createdAt": "2020-05-15T07:00:41Z", "commit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzowMDo0MVrOGV41ag==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwNzoyMzoyN1rOGV5bWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYwNDQ1OA==", "bodyText": ":-)", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425604458", "createdAt": "2020-05-15T07:00:41Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/VersionTests.java", "diffHunk": "@@ -31,27 +31,74 @@ public void testInvalidVersion() {\n         assertEquals(\"Invalid version format [7.1]\", err.getMessage());\n     }\n \n-    public void testVersionFromJarInJar() throws IOException {\n+\n+    private static final String JAR_PATH_SEPARATOR = \"!/\";\n+\n+    private static String versionString(byte[] parts) {\n+        StringBuffer version = new StringBuffer();\n+        for (byte part : parts) {\n+            if (version.length() > 0) {\n+                version.append(\".\");\n+            }\n+            version.append(part);\n+        }\n+        return version.toString();\n+    }\n+\n+    private static Path createDriverJar(byte[] parts) throws IOException {\n         final String JDBC_JAR_NAME = \"es-sql-jdbc.jar\";\n-        final String JAR_PATH_SEPARATOR = \"!/\";\n \n         Path dir = createTempDir();\n-        Path jarPath = dir.resolve(\"uberjar.jar\");          // simulated uberjar containing the jdbc driver\n-        Path innerJarPath = dir.resolve(JDBC_JAR_NAME); // simulated ES JDBC driver file\n+        Path jarPath = dir.resolve(JDBC_JAR_NAME); // simulated ES JDBC driver file\n \n         Manifest jdbcJarManifest = new Manifest();\n         Attributes attributes = jdbcJarManifest.getMainAttributes();\n         attributes.put(Attributes.Name.MANIFEST_VERSION, \"1.0.0\");\n         attributes.put(new Attributes.Name(\"Change\"), \"abc\");\n-        attributes.put(new Attributes.Name(\"X-Compile-Elasticsearch-Version\"), \"1.2.3\");\n+        attributes.put(new Attributes.Name(\"X-Compile-Elasticsearch-Version\"), versionString(parts));\n \n         // create the jdbc driver file\n-        try (JarOutputStream jdbc = new JarOutputStream(Files.newOutputStream(innerJarPath, StandardOpenOption.CREATE), jdbcJarManifest)) {}\n+        try (JarOutputStream __ = new JarOutputStream(Files.newOutputStream(jarPath, StandardOpenOption.CREATE), jdbcJarManifest)) {}", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 37}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYwNzcyMw==", "bodyText": "do { } while (false) or use a function with the same break conditions (but using return to \"jump\" at the end)?", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425607723", "createdAt": "2020-05-15T07:08:54Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -71,23 +72,36 @@\n         CURRENT = extractVersion(url);\n     }\n \n+    // There are three main types of provided URLs:\n+    // (1) a file URL: file:<path><FS separator><driver name>.jar\n+    // (2) jar file URL pointing to a JAR file: jar:<sub-url><separator><driver name>.jar!/\n+    // (3) jar file URL pointing to a JAR file entry (likely a fat JAR, but other types are possible): jar:<sub-url>!/driver name>.jar!/\n     static SqlVersion extractVersion(URL url) {\n+        Manifest manifest = null;\n         String urlStr = url.toString();\n         if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n             try {\n                 URLConnection conn = url.openConnection();\n-                conn.setUseCaches(false);\n-\n-                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n-                    Manifest manifest = jar.getManifest();\n-                    String version = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                    return SqlVersion.fromString(version);\n-                }\n+                do {\n+                    // For a jar protocol, the implementing java.base/sun.net.www.protocol.jar.JarUrlConnection#getInputStream() will only\n+                    // return a stream (vs. throw an IOException) if the JAR file URL points to a JAR file entry and not a JAR file.\n+                    if (url.getProtocol().equals(\"jar\")) {\n+                        JarURLConnection jarConn = (JarURLConnection) conn;\n+                        if (jarConn.getEntryName() == null) { // the URL points to a JAR file\n+                            manifest = jarConn.getManifest(); // in case of a fat JAR, this would return the outermost JAR's manifest\n+                            break;\n+                        }\n+                    }\n+                    try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                        manifest = jar.getManifest();\n+                    }\n+                } while (false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYxNDE3MA==", "bodyText": "Why is this {1, 2, 3} and the previous test is {0, 1, 2}. It is relevant for these tests to have different versions to test? If not, and for the sake of using whatever versions, can you use a random value?", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425614170", "createdAt": "2020-05-15T07:23:27Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/sql-client/src/test/java/org/elasticsearch/xpack/sql/client/VersionTests.java", "diffHunk": "@@ -31,27 +31,74 @@ public void testInvalidVersion() {\n         assertEquals(\"Invalid version format [7.1]\", err.getMessage());\n     }\n \n-    public void testVersionFromJarInJar() throws IOException {\n+\n+    private static final String JAR_PATH_SEPARATOR = \"!/\";\n+\n+    private static String versionString(byte[] parts) {\n+        StringBuffer version = new StringBuffer();\n+        for (byte part : parts) {\n+            if (version.length() > 0) {\n+                version.append(\".\");\n+            }\n+            version.append(part);\n+        }\n+        return version.toString();\n+    }\n+\n+    private static Path createDriverJar(byte[] parts) throws IOException {\n         final String JDBC_JAR_NAME = \"es-sql-jdbc.jar\";\n-        final String JAR_PATH_SEPARATOR = \"!/\";\n \n         Path dir = createTempDir();\n-        Path jarPath = dir.resolve(\"uberjar.jar\");          // simulated uberjar containing the jdbc driver\n-        Path innerJarPath = dir.resolve(JDBC_JAR_NAME); // simulated ES JDBC driver file\n+        Path jarPath = dir.resolve(JDBC_JAR_NAME); // simulated ES JDBC driver file\n \n         Manifest jdbcJarManifest = new Manifest();\n         Attributes attributes = jdbcJarManifest.getMainAttributes();\n         attributes.put(Attributes.Name.MANIFEST_VERSION, \"1.0.0\");\n         attributes.put(new Attributes.Name(\"Change\"), \"abc\");\n-        attributes.put(new Attributes.Name(\"X-Compile-Elasticsearch-Version\"), \"1.2.3\");\n+        attributes.put(new Attributes.Name(\"X-Compile-Elasticsearch-Version\"), versionString(parts));\n \n         // create the jdbc driver file\n-        try (JarOutputStream jdbc = new JarOutputStream(Files.newOutputStream(innerJarPath, StandardOpenOption.CREATE), jdbcJarManifest)) {}\n+        try (JarOutputStream __ = new JarOutputStream(Files.newOutputStream(jarPath, StandardOpenOption.CREATE), jdbcJarManifest)) {}\n+\n+        return jarPath;\n+    }\n+\n+    public void testVersionFromFileJar() throws IOException {\n+        byte[] parts = {0, 1, 2};\n+        Path jarPath = createDriverJar(parts);\n+\n+        URL fileUrl = new URL(jarPath.toUri().toURL().toString());\n+        SqlVersion version = ClientVersion.extractVersion(fileUrl);\n+\n+        assertEquals(parts[0], version.major);\n+        assertEquals(parts[1], version.minor);\n+        assertEquals(parts[2], version.revision);\n+        assertEquals(versionString(parts), version.version);\n+    }\n+\n+    public void testVersionFromJar() throws IOException {\n+        byte[] parts = {1, 2, 3};", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 56}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNDQ5MzE5", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412449319", "createdAt": "2020-05-15T08:30:39Z", "commit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODozMDozOVrOGV7ezw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwODozMDozOVrOGV7ezw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY0NzgyMw==", "bodyText": "I think there was a reason for that, but can't remember. @astefan do you ?", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425647823", "createdAt": "2020-05-15T08:30:39Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -71,23 +72,36 @@\n         CURRENT = extractVersion(url);\n     }\n \n+    // There are three main types of provided URLs:\n+    // (1) a file URL: file:<path><FS separator><driver name>.jar\n+    // (2) jar file URL pointing to a JAR file: jar:<sub-url><separator><driver name>.jar!/\n+    // (3) jar file URL pointing to a JAR file entry (likely a fat JAR, but other types are possible): jar:<sub-url>!/driver name>.jar!/\n     static SqlVersion extractVersion(URL url) {\n+        Manifest manifest = null;\n         String urlStr = url.toString();\n         if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n             try {\n                 URLConnection conn = url.openConnection();\n-                conn.setUseCaches(false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNDgwNTQx", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412480541", "createdAt": "2020-05-15T09:15:13Z", "commit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOToxNToxNFrOGV8_DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQwOToxNjoxOVrOGV9BmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3MjQ2MQ==", "bodyText": "This section needs improving.\nthe do {} while (false) is unnecessary. The break can also be removed by checking if the manifest is still null before the try block:\nif (url.getProtocol()...) {\n}\n\nif (manifest == null) {\n try (JarInputStream...)\n}\n\nFurther more, if the entry is not-null what would be the returned manifest?\nif (url.getProtocol().equals(\"jar\")) {\n   JarURLConnection jarConn = (JarURLConnection) conn;\n   manifest = jarConn.getManifest(); <-- ? what would this return?", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425672461", "createdAt": "2020-05-15T09:15:14Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -71,23 +72,36 @@\n         CURRENT = extractVersion(url);\n     }\n \n+    // There are three main types of provided URLs:\n+    // (1) a file URL: file:<path><FS separator><driver name>.jar\n+    // (2) jar file URL pointing to a JAR file: jar:<sub-url><separator><driver name>.jar!/\n+    // (3) jar file URL pointing to a JAR file entry (likely a fat JAR, but other types are possible): jar:<sub-url>!/driver name>.jar!/\n     static SqlVersion extractVersion(URL url) {\n+        Manifest manifest = null;\n         String urlStr = url.toString();\n         if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n             try {\n                 URLConnection conn = url.openConnection();\n-                conn.setUseCaches(false);\n-\n-                try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n-                    Manifest manifest = jar.getManifest();\n-                    String version = manifest.getMainAttributes().getValue(\"X-Compile-Elasticsearch-Version\");\n-                    return SqlVersion.fromString(version);\n-                }\n+                do {\n+                    // For a jar protocol, the implementing java.base/sun.net.www.protocol.jar.JarUrlConnection#getInputStream() will only\n+                    // return a stream (vs. throw an IOException) if the JAR file URL points to a JAR file entry and not a JAR file.\n+                    if (url.getProtocol().equals(\"jar\")) {\n+                        JarURLConnection jarConn = (JarURLConnection) conn;\n+                        if (jarConn.getEntryName() == null) { // the URL points to a JAR file\n+                            manifest = jarConn.getManifest(); // in case of a fat JAR, this would return the outermost JAR's manifest\n+                            break;\n+                        }\n+                    }\n+                    try (JarInputStream jar = new JarInputStream(conn.getInputStream())) {\n+                        manifest = jar.getManifest();\n+                    }\n+                } while (false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTYwNzcyMw=="}, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY3MzExMw==", "bodyText": "Not sure why my previous comment doesn't show up but it's because it avoids file locking on Windows as it frees the stream early on.", "url": "https://github.com/elastic/elasticsearch/pull/56797#discussion_r425673113", "createdAt": "2020-05-15T09:16:19Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/sql-client/src/main/java/org/elasticsearch/xpack/sql/client/ClientVersion.java", "diffHunk": "@@ -71,23 +72,36 @@\n         CURRENT = extractVersion(url);\n     }\n \n+    // There are three main types of provided URLs:\n+    // (1) a file URL: file:<path><FS separator><driver name>.jar\n+    // (2) jar file URL pointing to a JAR file: jar:<sub-url><separator><driver name>.jar!/\n+    // (3) jar file URL pointing to a JAR file entry (likely a fat JAR, but other types are possible): jar:<sub-url>!/driver name>.jar!/\n     static SqlVersion extractVersion(URL url) {\n+        Manifest manifest = null;\n         String urlStr = url.toString();\n         if (urlStr.endsWith(\".jar\") || urlStr.endsWith(\".jar!/\")) {\n             try {\n                 URLConnection conn = url.openConnection();\n-                conn.setUseCaches(false);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTY0NzgyMw=="}, "originalCommit": {"oid": "0bfdee6473a573641c01e4ffdc40299f2300190c"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "988b9b366d390ea4b84797a52383a95302858551", "author": {"user": {"login": "bpintea", "name": "Bogdan Pintea"}}, "url": "https://github.com/elastic/elasticsearch/commit/988b9b366d390ea4b84797a52383a95302858551", "committedDate": "2020-05-15T12:27:01Z", "message": "Address review comments\n\n- turn frame loop into function call\n- make version randomized\n- readd conn caching disabling, unintentionally removed."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjM4ODk1", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412638895", "createdAt": "2020-05-15T13:16:42Z", "commit": {"oid": "988b9b366d390ea4b84797a52383a95302858551"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjQyMTU4", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412642158", "createdAt": "2020-05-15T13:20:39Z", "commit": {"oid": "988b9b366d390ea4b84797a52383a95302858551"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNjUwMjYw", "url": "https://github.com/elastic/elasticsearch/pull/56797#pullrequestreview-412650260", "createdAt": "2020-05-15T13:30:02Z", "commit": {"oid": "988b9b366d390ea4b84797a52383a95302858551"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4f24d3f5e74b971eabe7b7a3c14a46cbcdfbb75f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f24d3f5e74b971eabe7b7a3c14a46cbcdfbb75f", "committedDate": "2020-05-15T14:18:41Z", "message": "Merge branch 'master' into fix/jdbc_version_read"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}