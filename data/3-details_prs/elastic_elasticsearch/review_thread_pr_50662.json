{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5NTg2MDg2", "number": 50662, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1MjozOFrODWiDsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1ODo0MlrODWiJLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTUzMjY0OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1MjozOFrOFbV8Pg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1MjozOFrOFbV8Pg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxNTM1OA==", "bodyText": "nit: I think this is a leftover?", "url": "https://github.com/elastic/elasticsearch/pull/50662#discussion_r364215358", "createdAt": "2020-01-08T12:52:38Z", "author": {"login": "romseygeek"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -20,6 +20,7 @@\n package org.elasticsearch.index.mapper;\n \n import com.carrotsearch.hppc.ObjectHashSet;\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e695a788e46101bc6e3ceca032d5ae6fe83a82d5"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTUzNTAwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1Mzo0NFrOFbV9yQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1Mzo0NFrOFbV9yQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxNTc1Mw==", "bodyText": "Given that this is reused in three different tests now, I wonder if it's worth extracting it as a separate method?", "url": "https://github.com/elastic/elasticsearch/pull/50662#discussion_r364215753", "createdAt": "2020-01-08T12:53:44Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "diffHunk": "@@ -126,6 +122,74 @@ public void testSynonymsUpdateable() throws FileNotFoundException, IOException {\n         assertHitCount(response, 1L);\n     }\n \n+    public void testSynonymsInMultiplexerUpdateable() throws FileNotFoundException, IOException {\n+        String synonymsFileName = \"synonyms.txt\";\n+        Path configDir = node().getEnvironment().configFile();\n+        if (Files.exists(configDir) == false) {\n+            Files.createDirectory(configDir);\n+        }\n+        Path synonymsFile = configDir.resolve(synonymsFileName);\n+        if (Files.exists(synonymsFile) == false) {\n+            Files.createFile(synonymsFile);\n+        }\n+        try (PrintWriter out = new PrintWriter(\n+                new OutputStreamWriter(Files.newOutputStream(synonymsFile, StandardOpenOption.WRITE), StandardCharsets.UTF_8))) {\n+            out.println(\"foo, baz\");\n+        }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e695a788e46101bc6e3ceca032d5ae6fe83a82d5"}, "originalPosition": 68}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTU0MTQ4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1NjozNVrOFbWBsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxNTo1NjozN1rOFbba8g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxNjc1Mw==", "bodyText": "This compression of multiple settings onto single lines seems to me to make test more difficult to follow, can we keep the indentation as it was before?", "url": "https://github.com/elastic/elasticsearch/pull/50662#discussion_r364216753", "createdAt": "2020-01-08T12:56:35Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "diffHunk": "@@ -143,20 +207,15 @@ public void testUpdateableSynonymsRejectedAtIndexTime() throws FileNotFoundExcep\n \n         final String indexName = \"test\";\n         final String analyzerName = \"my_synonym_analyzer\";\n-        MapperException ex = expectThrows(MapperException.class, () -> client().admin().indices().prepareCreate(indexName)\n-                .setSettings(Settings.builder()\n-                .put(\"index.number_of_shards\", 5)\n-                .put(\"index.number_of_replicas\", 0)\n-                .put(\"analysis.analyzer.\" + analyzerName + \".tokenizer\", \"standard\")\n-                .putList(\"analysis.analyzer.\" + analyzerName + \".filter\", \"lowercase\", \"synonym_filter\")\n-                .put(\"analysis.filter.synonym_filter.type\", \"synonym\")\n-                .put(\"analysis.filter.synonym_filter.updateable\", \"true\")\n-                .put(\"analysis.filter.synonym_filter.synonyms_path\", synonymsFileName))\n-                .addMapping(\"_doc\", \"field\", \"type=text,analyzer=\" + analyzerName).get());\n-\n-        assertEquals(\n-                \"Failed to parse mapping: analyzer [my_synonym_analyzer] \"\n-                + \"contains filters [synonym_filter] that are not allowed to run in all mode.\",\n-                ex.getMessage());\n+        MapperException ex = expectThrows(MapperException.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e695a788e46101bc6e3ceca032d5ae6fe83a82d5"}, "originalPosition": 145}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDMwNTEzOA==", "bodyText": "Good point, this was not intended, must be the new Eclipse installation doing some autoformatting.", "url": "https://github.com/elastic/elasticsearch/pull/50662#discussion_r364305138", "createdAt": "2020-01-08T15:56:37Z", "author": {"login": "cbuescher"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "diffHunk": "@@ -143,20 +207,15 @@ public void testUpdateableSynonymsRejectedAtIndexTime() throws FileNotFoundExcep\n \n         final String indexName = \"test\";\n         final String analyzerName = \"my_synonym_analyzer\";\n-        MapperException ex = expectThrows(MapperException.class, () -> client().admin().indices().prepareCreate(indexName)\n-                .setSettings(Settings.builder()\n-                .put(\"index.number_of_shards\", 5)\n-                .put(\"index.number_of_replicas\", 0)\n-                .put(\"analysis.analyzer.\" + analyzerName + \".tokenizer\", \"standard\")\n-                .putList(\"analysis.analyzer.\" + analyzerName + \".filter\", \"lowercase\", \"synonym_filter\")\n-                .put(\"analysis.filter.synonym_filter.type\", \"synonym\")\n-                .put(\"analysis.filter.synonym_filter.updateable\", \"true\")\n-                .put(\"analysis.filter.synonym_filter.synonyms_path\", synonymsFileName))\n-                .addMapping(\"_doc\", \"field\", \"type=text,analyzer=\" + analyzerName).get());\n-\n-        assertEquals(\n-                \"Failed to parse mapping: analyzer [my_synonym_analyzer] \"\n-                + \"contains filters [synonym_filter] that are not allowed to run in all mode.\",\n-                ex.getMessage());\n+        MapperException ex = expectThrows(MapperException.class,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxNjc1Mw=="}, "originalCommit": {"oid": "e695a788e46101bc6e3ceca032d5ae6fe83a82d5"}, "originalPosition": 145}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjI0OTU0NjY5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1ODo0MlrOFbWE3A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wOFQxMjo1ODo0MlrOFbWE3A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NDIxNzU2NA==", "bodyText": "Maybe also add a test asserting that a multiplexer containing updateable synonyms is rejected as an index-time analyzer as well?", "url": "https://github.com/elastic/elasticsearch/pull/50662#discussion_r364217564", "createdAt": "2020-01-08T12:58:42Z", "author": {"login": "romseygeek"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/action/ReloadSynonymAnalyzerTests.java", "diffHunk": "@@ -126,6 +122,74 @@ public void testSynonymsUpdateable() throws FileNotFoundException, IOException {\n         assertHitCount(response, 1L);\n     }\n \n+    public void testSynonymsInMultiplexerUpdateable() throws FileNotFoundException, IOException {\n+        String synonymsFileName = \"synonyms.txt\";\n+        Path configDir = node().getEnvironment().configFile();\n+        if (Files.exists(configDir) == false) {\n+            Files.createDirectory(configDir);\n+        }\n+        Path synonymsFile = configDir.resolve(synonymsFileName);\n+        if (Files.exists(synonymsFile) == false) {\n+            Files.createFile(synonymsFile);\n+        }\n+        try (PrintWriter out = new PrintWriter(\n+                new OutputStreamWriter(Files.newOutputStream(synonymsFile, StandardOpenOption.WRITE), StandardCharsets.UTF_8))) {\n+            out.println(\"foo, baz\");\n+        }\n+\n+        final String indexName = \"test\";\n+        final String synonymAnalyzerName = \"synonym_in_multiplexer_analyzer\";\n+        assertAcked(client().admin().indices().prepareCreate(indexName)\n+                .setSettings(Settings.builder().put(\"index.number_of_shards\", 5).put(\"index.number_of_replicas\", 0)\n+                        .put(\"analysis.analyzer.\" + synonymAnalyzerName + \".tokenizer\", \"whitespace\")\n+                        .putList(\"analysis.analyzer.\" + synonymAnalyzerName + \".filter\", \"my_multiplexer\")\n+                        .put(\"analysis.filter.synonym_filter.type\", \"synonym\").put(\"analysis.filter.synonym_filter.updateable\", \"true\")\n+                        .put(\"analysis.filter.synonym_filter.synonyms_path\", synonymsFileName)\n+                        .put(\"analysis.filter.my_multiplexer.type\", \"multiplexer\")\n+                        .putList(\"analysis.filter.my_multiplexer.filters\", \"synonym_filter\"))\n+                .addMapping(\"_doc\", \"field\", \"type=text,analyzer=standard,search_analyzer=\" + synonymAnalyzerName));\n+\n+        client().prepareIndex(indexName).setId(\"1\").setSource(\"field\", \"foo\").get();\n+        assertNoFailures(client().admin().indices().prepareRefresh(indexName).execute().actionGet());\n+\n+        SearchResponse response = client().prepareSearch(indexName).setQuery(QueryBuilders.matchQuery(\"field\", \"baz\")).get();\n+        assertHitCount(response, 1L);\n+        response = client().prepareSearch(indexName).setQuery(QueryBuilders.matchQuery(\"field\", \"buzz\")).get();\n+        assertHitCount(response, 0L);\n+\n+        Response analyzeResponse = client().admin().indices().prepareAnalyze(indexName, \"foo\").setAnalyzer(synonymAnalyzerName).get();\n+        assertEquals(2, analyzeResponse.getTokens().size());\n+        final Set<String> tokens = new HashSet<>();\n+        analyzeResponse.getTokens().stream().map(AnalyzeToken::getTerm).forEach(t -> tokens.add(t));\n+        assertTrue(tokens.contains(\"foo\"));\n+        assertTrue(tokens.contains(\"baz\"));\n+\n+        // now update synonyms file and trigger reloading\n+        try (PrintWriter out = new PrintWriter(\n+                new OutputStreamWriter(Files.newOutputStream(synonymsFile, StandardOpenOption.WRITE), StandardCharsets.UTF_8))) {\n+            out.println(\"foo, baz, buzz\");\n+        }\n+        ReloadAnalyzersResponse reloadResponse = client().execute(ReloadAnalyzerAction.INSTANCE, new ReloadAnalyzersRequest(indexName))\n+                .actionGet();\n+        assertNoFailures(reloadResponse);\n+        Set<String> reloadedAnalyzers = reloadResponse.getReloadDetails().get(indexName).getReloadedAnalyzers();\n+        assertEquals(1, reloadedAnalyzers.size());\n+        assertTrue(reloadedAnalyzers.contains(synonymAnalyzerName));\n+\n+        analyzeResponse = client().admin().indices().prepareAnalyze(indexName, \"foo\").setAnalyzer(synonymAnalyzerName).get();\n+        assertEquals(3, analyzeResponse.getTokens().size());\n+        tokens.clear();\n+        analyzeResponse.getTokens().stream().map(AnalyzeToken::getTerm).forEach(t -> tokens.add(t));\n+        assertTrue(tokens.contains(\"foo\"));\n+        assertTrue(tokens.contains(\"baz\"));\n+        assertTrue(tokens.contains(\"buzz\"));\n+\n+        response = client().prepareSearch(indexName).setQuery(QueryBuilders.matchQuery(\"field\", \"baz\")).get();\n+        assertHitCount(response, 1L);\n+        response = client().prepareSearch(indexName).setQuery(QueryBuilders.matchQuery(\"field\", \"buzz\")).get();\n+        assertHitCount(response, 1L);\n+    }\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e695a788e46101bc6e3ceca032d5ae6fe83a82d5"}, "originalPosition": 122}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4883, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}