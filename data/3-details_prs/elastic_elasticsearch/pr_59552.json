{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ4OTc1NDIx", "number": 59552, "title": "EQL: Improve retrieval of results", "bodyText": "Instead of retrieving whole SearchHit, get just a reference and postpone\nthe document retrieval when assembling the final results.\nRemove sort information from results to make them consistent\nMove TumblingWindow under the sequence package.", "createdAt": "2020-07-14T16:07:34Z", "url": "https://github.com/elastic/elasticsearch/pull/59552", "merged": true, "mergeCommit": {"oid": "bccfbcd81f2f1d3552e95e4a9ee2618fb3059bd9"}, "closed": true, "closedAt": "2020-07-14T20:26:26Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc04QdEAH2gAyNDQ4OTc1NDIxOmZiOWE1MTY4YjJmMWFjOTFhZDVmNDQ0OGEyYmQyYmEwMzQwMjc5ZTc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc06EwbAH2gAyNDQ4OTc1NDIxOmM5NTk4YzdiYjM0OThiMjgyMThhNWE5YWM3MzBlYjM1MjQ0ZDdhN2Y=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7", "committedDate": "2020-07-14T16:02:48Z", "message": "EQL: Improve retrieval of results\n\nInstead of retrieving whole SearchHit, get just a reference and postpone\nthe document retrieval when assembling the final results.\nRemove sort information from results to make them consistent\nMove TumblingWindow under the sequence package"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjU0NzUx", "url": "https://github.com/elastic/elasticsearch/pull/59552#pullrequestreview-448254751", "createdAt": "2020-07-14T16:10:18Z", "commit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMDoxOFrOGxazKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMDoxOFrOGxazKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MjQ5MQ==", "bodyText": "@jrodewig removed return of sort.", "url": "https://github.com/elastic/elasticsearch/pull/59552#discussion_r454472491", "createdAt": "2020-07-14T16:10:18Z", "author": {"login": "costin"}, "path": "docs/reference/eql/eql-search-api.asciidoc", "diffHunk": "@@ -564,10 +564,7 @@ the events in ascending, lexicographic order.\n             \"name\": \"cmd.exe\",\n             \"path\": \"C:\\\\Windows\\\\System32\\\\cmd.exe\"\n           }\n-        },\n-        \"sort\": [", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjU1OTA4", "url": "https://github.com/elastic/elasticsearch/pull/59552#pullrequestreview-448255908", "createdAt": "2020-07-14T16:11:39Z", "commit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMTozOVrOGxa2tw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMTozOVrOGxa2tw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3MzM5OQ==", "bodyText": "@jrodewig since I've removed the fields from the results, I had to remove this whole section (the two fields are essentially used only internally and get removed before being returned).", "url": "https://github.com/elastic/elasticsearch/pull/59552#discussion_r454473399", "createdAt": "2020-07-14T16:11:39Z", "author": {"login": "costin"}, "path": "docs/reference/eql/search.asciidoc", "diffHunk": "@@ -495,15 +477,7 @@ GET /sec_logs/_eql/search\n ----\n // TEST[s/search/search\\?filter_path\\=\\-\\*\\.events\\.\\*fields/]\n \n-The API returns the following response. Note the `sort` property of each\n-matching event contains an array of two items:\n-\n-* The first item is the event's <<eql-search-api-timestamp-field,timestamp>>,\n-converted to milliseconds since the https://en.wikipedia.org/wiki/Unix_time[Unix\n-epoch].\n-\n-* The second item is the event's `event.id` value. This value is used as a sort\n-tiebreaker for events with the same timestamp.\n+The API returns the following response.\n ", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "originalPosition": 95}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjU2OTI0", "url": "https://github.com/elastic/elasticsearch/pull/59552#pullrequestreview-448256924", "createdAt": "2020-07-14T16:12:58Z", "commit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMjo1OFrOGxa6CQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMjo1OFrOGxa6CQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3NDI0OQ==", "bodyText": "@jrodewig Normally these need to be set as well however I didn't want to make this PR longer. For event queries we do return these fields however the docs doesn't include them for sequences.\nConsidering the tight deadline, not sure what's the easiest fix until the next release?", "url": "https://github.com/elastic/elasticsearch/pull/59552#discussion_r454474249", "createdAt": "2020-07-14T16:12:58Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/search/BasicQueryClient.java", "diffHunk": "@@ -49,4 +67,69 @@ public void query(QueryRequest request, ActionListener<Payload> listener) {\n         SearchRequest search = prepareRequest(client, searchSource, false, indices);\n         client.search(search, new BasicListener(listener));\n     }\n-}\n+\n+    @Override\n+    public void get(Iterable<List<HitReference>> refs, ActionListener<List<List<SearchHit>>> listener) {\n+        MultiGetRequestBuilder requestBuilder = client.prepareMultiGet();\n+        // no need for real-time\n+        requestBuilder.setRealtime(false)\n+                      .setRefresh(false);\n+\n+        int sz = 0;\n+\n+        for (List<HitReference> list : refs) {\n+            sz = list.size();\n+            for (HitReference ref : list) {\n+                Item item = new Item(ref.index(), ref.id());\n+                // make sure to get the whole source\n+                item.fetchSourceContext(FetchSourceContext.FETCH_SOURCE);\n+                requestBuilder.add(item);\n+            }\n+        }\n+        \n+        final int listSize = sz;\n+        client.multiGet(requestBuilder.request(), wrap(r -> {\n+            List<List<SearchHit>> hits = new ArrayList<>(r.getResponses().length / listSize);\n+            \n+            List<SearchHit> sequence = new ArrayList<>(listSize);\n+            \n+            // copy streams - reused across the whole loop\n+            PipedInputStream in = new PipedInputStream();\n+            PipedOutputStream out = new PipedOutputStream(in);\n+            StreamOutput so = new OutputStreamStreamOutput(out);\n+            StreamInput si = new InputStreamStreamInput(in);\n+\n+            int counter = 0;\n+            for (MultiGetItemResponse mgr : r.getResponses()) {\n+                if (mgr.isFailed()) {\n+                    listener.onFailure(mgr.getFailure().getFailure());\n+                    return;\n+                }\n+                // HACK: the only way to get GetResult is to serialize it and then load it back :(\n+                mgr.getResponse().writeTo(so);\n+                GetResult result = new GetResult(si);\n+\n+                SearchHit hit = new SearchHit(-1, result.getId(), result.getDocumentFields(), result.getMetadataFields());\n+                hit.sourceRef(result.internalSourceRef());\n+                // need to create these objects to set the index\n+                hit.shard(new SearchShardTarget(null, new ShardId(result.getIndex(), \"\", -1), null, null));\n+\n+                //hit.setSeqNo(result.getSeqNo());\n+                //hit.setPrimaryTerm(result.getPrimaryTerm());\n+                //hit.version(result.getVersion());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "originalPosition": 88}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MjU3MjI1", "url": "https://github.com/elastic/elasticsearch/pull/59552#pullrequestreview-448257225", "createdAt": "2020-07-14T16:13:20Z", "commit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMzoyMFrOGxa67g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0xNFQxNjoxMzoyMFrOGxa67g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1NDQ3NDQ3OA==", "bodyText": "Need to remove this as well.", "url": "https://github.com/elastic/elasticsearch/pull/59552#discussion_r454474478", "createdAt": "2020-07-14T16:13:20Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceMatcher.java", "diffHunk": "@@ -207,14 +206,19 @@ public boolean hasCandidates(int stage) {\n         return false;\n     }\n \n-    public Payload payload(long startTime) {\n-        TimeValue tookTime = new TimeValue(System.currentTimeMillis() - startTime);\n-        List<Sequence> view = limit != null ? limit.view(completed) : completed;\n-        Payload p = new SequencePayload(view, false, tookTime);\n-        clear();\n-        return p;\n+\n+    public List<Sequence> completed() {\n+        return limit != null ? limit.view(completed) : completed;\n     }\n \n+    //    public Payload payload(long startTime) {\n+    //        TimeValue tookTime = new TimeValue(System.currentTimeMillis() - startTime);\n+    //\n+    //        Payload p = new SequencePayload(view, false, tookTime);\n+    //        clear();\n+    //        return p;\n+    //    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fb9a5168b2f1ac91ad5f4448a2bd2ba0340279e7"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e61a1fd69517c39aee51bb2a2652fd890b732747", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/e61a1fd69517c39aee51bb2a2652fd890b732747", "committedDate": "2020-07-14T16:17:46Z", "message": "Remove left-over comment\nExplicitly drop the state machine before returning the results"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4c3a6bfb44213d3d159df3c793674082dc9bd3dc", "author": {"user": {"login": "jrodewig", "name": "James Rodewig"}}, "url": "https://github.com/elastic/elasticsearch/commit/4c3a6bfb44213d3d159df3c793674082dc9bd3dc", "committedDate": "2020-07-14T16:39:04Z", "message": "Skip several EQL responses"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f77818123509fe51e5fed983d3de5859970a4c65", "author": {"user": {"login": "jrodewig", "name": "James Rodewig"}}, "url": "https://github.com/elastic/elasticsearch/commit/f77818123509fe51e5fed983d3de5859970a4c65", "committedDate": "2020-07-14T16:49:18Z", "message": "Move misplaced test comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ4MzE3OTIw", "url": "https://github.com/elastic/elasticsearch/pull/59552#pullrequestreview-448317920", "createdAt": "2020-07-14T17:31:17Z", "commit": {"oid": "f77818123509fe51e5fed983d3de5859970a4c65"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c2d463e359afbe86651985e6c567a881328b5356", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/c2d463e359afbe86651985e6c567a881328b5356", "committedDate": "2020-07-14T17:33:53Z", "message": "Field extractors are used only for ordinals so make them use docvalues\nby default\n\nDon't retrieve source while matching"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e3fa94f319ca717884d49d74a810e71cf47e9f", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/31e3fa94f319ca717884d49d74a810e71cf47e9f", "committedDate": "2020-07-14T17:33:53Z", "message": "Improve source exclusion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "303891fec0859167be0fa2da0c8332db9df26bc7", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/303891fec0859167be0fa2da0c8332db9df26bc7", "committedDate": "2020-07-14T18:09:24Z", "message": "Move fetch source handling inside SourceGenerator"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9598c7bb3498b28218a5a9ac730eb35244d7a7f", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9598c7bb3498b28218a5a9ac730eb35244d7a7f", "committedDate": "2020-07-14T18:09:50Z", "message": "Add more fields to generated SearchHit"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4345, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}