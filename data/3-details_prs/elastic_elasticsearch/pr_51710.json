{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY5MzE5NjE1", "number": 51710, "title": "Plumb ValuesSourceRegistry through to QuerySearchContext", "bodyText": "This PR gets rid of the singleton implementation of the ValuesSourceRegistry I had been using for prototyping, and replaces it with something that behaves like we generally expect a registry to behave.  SearchModule creates an instance of ValuesSourceRegistry, which then gets pulled down through the various index management classes, until it gets made available to the aggregations framework via QueryShardContext.\nThis also lets us get rid of the atomic initialization guards on the aggregation builders, since tests creating multiple SearchModule instances now get isolated ValuesSourceRegistry instances.\nSpecial thanks to @nik9000 for pointing me in the right direction on this!", "createdAt": "2020-01-30T22:25:09Z", "url": "https://github.com/elastic/elasticsearch/pull/51710", "merged": true, "mergeCommit": {"oid": "77b87a10785f543fed9704c6ceefbc0fa1f01e77"}, "closed": true, "closedAt": "2020-02-07T17:26:35Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_e2zPAH2gAyMzY5MzE5NjE1OmY5NjFiNDg3MzQ5OTUxYTAxMDE1MTM5NmU3ODkyYWI1ODkyMDU4NmY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCBy8mgH2gAyMzY5MzE5NjE1OjFmYjBjMjllZDAzYTA3MGI5NDM2M2QxNTZlN2NlMGMwZjY3MzUzYWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f961b487349951a010151396e7892ab58920586f", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f961b487349951a010151396e7892ab58920586f", "committedDate": "2020-01-30T18:29:10Z", "message": "Get the VSRegistry from QueryShardContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6a91c43c435f49a7d6fdbb9ec829417f177118c", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d6a91c43c435f49a7d6fdbb9ec829417f177118c", "committedDate": "2020-01-30T20:03:17Z", "message": "Pass VSRegistry into QueryShardContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "716781dd994e7e7fe55b2ec0b44103ac92e5c617", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/716781dd994e7e7fe55b2ec0b44103ac92e5c617", "committedDate": "2020-01-30T20:57:18Z", "message": "Wire all the way back to search module"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb82478d23d7fac5df2104eb7ffd312caa3399b", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb82478d23d7fac5df2104eb7ffd312caa3399b", "committedDate": "2020-01-30T21:26:58Z", "message": "ValuesSourceRegistry member for SearchModule"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd1286601096be4a9ec59bd169296b113e886185", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd1286601096be4a9ec59bd169296b113e886185", "committedDate": "2020-01-30T22:03:09Z", "message": "Clean up other uses of VSRegistry.getInstance"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/80797fa3c204127b8922960986ad627ac881fd31", "committedDate": "2020-01-30T22:18:10Z", "message": "Get rid of singleton & weird atomic init guards"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzODk5Nzg1", "url": "https://github.com/elastic/elasticsearch/pull/51710#pullrequestreview-353899785", "createdAt": "2020-02-05T17:22:59Z", "commit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzoyMjo1OVrOFmAaoA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQxNzoyNToxMlrOFmAe4w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5NzAyNA==", "bodyText": "I think the old indentation was easier to read.", "url": "https://github.com/elastic/elasticsearch/pull/51710#discussion_r375397024", "createdAt": "2020-02-05T17:22:59Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/IndexModule.java", "diffHunk": "@@ -382,21 +383,21 @@ public static Type defaultStoreType(final boolean allowMmap) {\n     }\n \n     public IndexService newIndexService(\n-            IndexService.IndexCreationContext indexCreationContext,\n-            NodeEnvironment environment,\n-            NamedXContentRegistry xContentRegistry,\n-            IndexService.ShardStoreDeleter shardStoreDeleter,\n-            CircuitBreakerService circuitBreakerService,\n-            BigArrays bigArrays,\n-            ThreadPool threadPool,\n-            ScriptService scriptService,\n-            ClusterService clusterService,\n-            Client client,\n-            IndicesQueryCache indicesQueryCache,\n-            MapperRegistry mapperRegistry,\n-            IndicesFieldDataCache indicesFieldDataCache,\n-            NamedWriteableRegistry namedWriteableRegistry,\n-            BooleanSupplier idFieldDataEnabled)\n+        IndexService.IndexCreationContext indexCreationContext,\n+        NodeEnvironment environment,\n+        NamedXContentRegistry xContentRegistry,\n+        IndexService.ShardStoreDeleter shardStoreDeleter,\n+        CircuitBreakerService circuitBreakerService,\n+        BigArrays bigArrays,\n+        ThreadPool threadPool,\n+        ScriptService scriptService,\n+        ClusterService clusterService,\n+        Client client,\n+        IndicesQueryCache indicesQueryCache,\n+        MapperRegistry mapperRegistry,\n+        IndicesFieldDataCache indicesFieldDataCache,\n+        NamedWriteableRegistry namedWriteableRegistry,\n+        BooleanSupplier idFieldDataEnabled, ValuesSourceRegistry valuesSourceRegistry)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31"}, "originalPosition": 41}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5NzQ0Ng==", "bodyText": "It look like someone was going with one arg per line here.", "url": "https://github.com/elastic/elasticsearch/pull/51710#discussion_r375397446", "createdAt": "2020-02-05T17:23:48Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/indices/IndicesService.java", "diffHunk": "@@ -239,12 +241,13 @@ public IndicesService(Settings settings, PluginsService pluginsService, NodeEnvi\n                           IndexScopedSettings indexScopedSettings, CircuitBreakerService circuitBreakerService, BigArrays bigArrays,\n                           ScriptService scriptService, ClusterService clusterService, Client client, MetaStateService metaStateService,\n                           Collection<Function<IndexSettings, Optional<EngineFactory>>> engineFactoryProviders,\n-                          Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories) {\n+                          Map<String, IndexStorePlugin.DirectoryFactory> directoryFactories, ValuesSourceRegistry valuesSourceRegistry) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5NzYwNg==", "bodyText": "Leftover TODO?", "url": "https://github.com/elastic/elasticsearch/pull/51710#discussion_r375397606", "createdAt": "2020-02-05T17:24:06Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -298,6 +299,8 @@\n      */\n     public SearchModule(Settings settings, List<SearchPlugin> plugins) {\n         this.settings = settings;\n+        //TODO: constructor call goes here", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTM5ODExNQ==", "bodyText": "Do you still like the idea of changing the ctor to take an Iterable? Is that a thing for a follow up change?", "url": "https://github.com/elastic/elasticsearch/pull/51710#discussion_r375398115", "createdAt": "2020-02-05T17:25:12Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/SearchModule.java", "diffHunk": "@@ -298,6 +299,8 @@\n      */\n     public SearchModule(Settings settings, List<SearchPlugin> plugins) {\n         this.settings = settings;\n+        //TODO: constructor call goes here\n+        this.valuesSourceRegistry = new ValuesSourceRegistry();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "80797fa3c204127b8922960986ad627ac881fd31"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0fcb81accb4067db488800ce6d53257b83eef787", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/0fcb81accb4067db488800ce6d53257b83eef787", "committedDate": "2020-02-05T18:25:27Z", "message": "response to PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NzAyNjEy", "url": "https://github.com/elastic/elasticsearch/pull/51710#pullrequestreview-354702612", "createdAt": "2020-02-06T19:12:53Z", "commit": {"oid": "0fcb81accb4067db488800ce6d53257b83eef787"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f342c4c09f4b57b88fa556e7e2194cde369cef0c", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f342c4c09f4b57b88fa556e7e2194cde369cef0c", "committedDate": "2020-02-07T15:34:05Z", "message": "Merge feature branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1fb0c29ed03a070b94363d156e7ce0c0f67353aa", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/1fb0c29ed03a070b94363d156e7ce0c0f67353aa", "committedDate": "2020-02-07T16:19:29Z", "message": "fix percentiles"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3125, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}