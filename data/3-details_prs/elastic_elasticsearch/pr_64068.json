{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA4MzI4Nzc3", "number": 64068, "title": "Limit blast redius of SearchContext in aggs", "bodyText": "This takes away access to the SearchContext from all subclasses of\nAggregator. Now they have access to three things:\n\nBigArrays\nThe top level Query\nThe IndexSearcher\n\nThese are used by a whole bunch of aggs.\nThis is a useful change because SearchContext is very large and\ndifficult to mock in tests and difficult to reason about in general.\nLimiting what aggs can use when they are being collected helps with\nthis.\nWe still pass SearchContext to AggregatorBase's ctor so the thing is\nstill around. But we can remove that access in a follow up.", "createdAt": "2020-10-22T14:20:11Z", "url": "https://github.com/elastic/elasticsearch/pull/64068", "merged": true, "mergeCommit": {"oid": "6ef0e5f5e8b73dcce542ba18d9931350a8219c13"}, "closed": true, "closedAt": "2020-10-27T13:12:59Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdVBqzRAH2gAyNTA4MzI4Nzc3OmYzNDg0ZmRmZmM4MDNkMzY5OWYyZTYyMGMzYmU4M2IzYTA4MGMyZDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdWWBMVgFqTUxNjg5MTIyOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f3484fdffc803d3699f2e620c3be83b3a080c2d8", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3484fdffc803d3699f2e620c3be83b3a080c2d8", "committedDate": "2020-10-22T13:06:18Z", "message": "Limit blast redius of SearchContext in aggs\n\nThis takes away access to the `SearchContext` from all subclasses of\n`Aggregator`. Now they have access to three things:\n* BigArrays\n* The top level Query\n* The IndexSearcher\n\nThese are used by a whole bunch of aggs.\n\nThis is a useful change because `SearchContext` is very large and\ndifficult to mock in tests and difficult to reason about in general.\nLimiting what aggs can use when they are being collected helps with\nthis.\n\nWe still pass `SearchContext` to `AggregatorBase`'s ctor so the thing is\nstill around. But we can remove that access in a follow up."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE0Nzg0MjU0", "url": "https://github.com/elastic/elasticsearch/pull/64068#pullrequestreview-514784254", "createdAt": "2020-10-22T14:23:11Z", "commit": {"oid": "f3484fdffc803d3699f2e620c3be83b3a080c2d8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDoyMzoxMVrOHmkXkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0yMlQxNDoyMzoxMVrOHmkXkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxMDIwMzc5Mg==", "bodyText": "I expect this method call to get inlined. It is a chain of a few method calls, one of which is bimorphic, but the bimorphic call is on a final field so I think the compiler can inline that too. My guess is that this is going to end up compiled to a field access so running it once and putting it in a local isn't going to help.", "url": "https://github.com/elastic/elasticsearch/pull/64068#discussion_r510203792", "createdAt": "2020-10-22T14:23:11Z", "author": {"login": "nik9000"}, "path": "modules/aggs-matrix-stats/src/main/java/org/elasticsearch/search/aggregations/matrix/stats/MatrixStatsAggregator.java", "diffHunk": "@@ -83,7 +81,7 @@ public LeafBucketCollector getLeafCollector(LeafReaderContext ctx,\n             public void collect(int doc, long bucket) throws IOException {\n                 // get fields\n                 if (includeDocument(doc)) {\n-                    stats = bigArrays.grow(stats, bucket + 1);\n+                    stats = bigArrays().grow(stats, bucket + 1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f3484fdffc803d3699f2e620c3be83b3a080c2d8"}, "originalPosition": 21}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTE2ODkxMjI5", "url": "https://github.com/elastic/elasticsearch/pull/64068#pullrequestreview-516891229", "createdAt": "2020-10-26T15:22:47Z", "commit": {"oid": "f3484fdffc803d3699f2e620c3be83b3a080c2d8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1127, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}