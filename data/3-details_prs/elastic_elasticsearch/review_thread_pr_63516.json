{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAwMjM3Njc2", "number": 63516, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMTo1OFrOEr0iDg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0NDozMFrOEtZ0iQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Mzg0OTEwOnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMTo1OFrOHezYaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMTo1OFrOHezYaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTE2MA==", "bodyText": "I wonder if we should wire this to precommit so it fails early. Otherwise this will only fail when we actually go to build these docker images.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061160", "createdAt": "2020-10-08T23:01:58Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE0Mzg1MzczOnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMzoxM1rOHezbMQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQyMzowMzoxM1rOHezbMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMjA2MTg3Mw==", "bodyText": "We should give some indication as to where \"this task's declaration\" lives. Perhaps provide the relative path to this build.gradle file in the exception message? Or instead externalize the checksum in a file (like we do for dependency artifacts) and just point to that so folks don't actually have to change build scripts.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r502061873", "createdAt": "2020-10-08T23:03:13Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +168,30 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"ensureLog4jConfigurationSync\") {\n+  /*\n+   * Whenever the x-pack/plugin/core/src/main/config/log4j2.properties is changed it might be that the\n+   * distribution/docker/src/docker/config/log4j2.properties file needs changing as well.\n+   *\n+   * This task fails if the x-pack/plugin/core/src/main/config/log4j2.properties file\n+   * has been modified. Please ensure that the distribution/docker/src/docker/config/log4j2.properties\n+   * file is also modified such that it reflects the same changes.\n+   *\n+   * SET THIS to the value of checksumOriginalLog4j after the two files have been confirmed as equivalent\n+   */\n+  def validatedChecksumOriginalLog4j = \"+GJ/QjaApSAiejScjiwFEg==\"\n+  doLast {\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties').getBytes()\n+    def checksumOriginalLog4j = Base64.getEncoder().encodeToString(MessageDigest.getInstance(\"MD5\").digest(originalLog4j))\n+    if (false == validatedChecksumOriginalLog4j.equals(checksumOriginalLog4j)) {\n+      throw new GradleException(\"The src/main/config/log4j2.properties file from the x-pack:plugin:core has been changed. \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4dea032b85bc51f0446823e6cb0d1febb455cbac"}, "originalPosition": 30}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1ODc0NTI0OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowNjo0NVrOHg7LNw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwODo1MjozNVrOHhI79w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjAwNw==", "bodyText": "We should define the properties files as inputs so that this task can be UP-TO-DATE when nothing changes.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286007", "createdAt": "2020-10-13T22:06:45Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDUxMTQ3OQ==", "bodyText": "Thanks Mark.", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504511479", "createdAt": "2020-10-14T08:52:35Z", "author": {"login": "albertzaharovits"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjAwNw=="}, "originalCommit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "originalPosition": 4}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1ODc0ODMzOnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowODowNFrOHg7NFg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xM1QyMjowODowNFrOHg7NFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDI4NjQ4Ng==", "bodyText": "This is Groovy, so need to do string concatination, just use groovy string interpolation (ex: \"The [${originalLog4j.path}] file...\").", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504286486", "createdAt": "2020-10-13T22:08:04Z", "author": {"login": "mark-vieira"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,41 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [\" + originalLog4j.getPath() + \"] file changed such that the layout pattern is not \" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "584a59060e7f196a25f460dccde7b750b1601f25"}, "originalPosition": 14}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDQ0Mzk5OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0NDoyNVrOHhK8vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMTowNjo0OFrOHhNyqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ0Ng==", "bodyText": "you can just do project.file(\"src/docker/config/log4j2.properties\")", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544446", "createdAt": "2020-10-14T09:44:25Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5MTAxOA==", "bodyText": "Thanks \ud83e\udd26", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504591018", "createdAt": "2020-10-14T11:06:48Z", "author": {"login": "albertzaharovits"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ0Ng=="}, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 7}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE2MDQ0NDI1OnYy", "diffSide": "RIGHT", "path": "distribution/docker/build.gradle", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQwOTo0NDozMFrOHhK86Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNFQxMToyNDoxNVrOHhOVgg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ4OQ==", "bodyText": "Please use tasks.named(\"precommit\").configure { it.dependsOn('checkSecurityAuditLayoutPatternIdentical') } to make use of gradles \"task avoidance api\" to avoid creating tasks early. see https://docs.gradle.org/current/userguide/task_configuration_avoidance.html for further information", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504544489", "createdAt": "2020-10-14T09:44:30Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()\n+  inputs.files(originalLog4j, dockerLog4j)\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${originalLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    def dockerLog4jProperties = new Properties()\n+    dockerLog4j.withInputStream { input ->\n+      dockerLog4jProperties.load(input)\n+    }\n+\n+    if (false == dockerLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${dockerLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    if (false == coreLog4jProperties.getProperty(patternPropertyKey).equals(dockerLog4jProperties.getProperty(patternPropertyKey))) {\n+      throw new GradleException(\"The property value for the layout pattern [${patternPropertyKey}] is NOT identical \" +\n+              \"between the [${originalLog4j.getPath()}] and the [${dockerLog4j.getPath()}] files.\")\n+    }\n+  }\n+}\n+precommit.dependsOn 'checkSecurityAuditLayoutPatternIdentical'", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU5OTkzOA==", "bodyText": "Ha, I was wondering what's up with the register methods, thanks for the link!\nI've changed it to:\ntasks.named(\"precommit\").configure {\n  dependsOn 'checkSecurityAuditLayoutPatternIdentical'\n}", "url": "https://github.com/elastic/elasticsearch/pull/63516#discussion_r504599938", "createdAt": "2020-10-14T11:24:15Z", "author": {"login": "albertzaharovits"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -165,6 +165,43 @@ tasks.register(\"copyKeystore\", Sync) {\n   }\n }\n \n+tasks.register(\"checkSecurityAuditLayoutPatternIdentical\") {\n+  // the two log4j2.properties files containing security audit configuration for archive and docker builds respectively\n+  def originalLog4j = project(\":x-pack:plugin:core\").file('src/main/config/log4j2.properties')\n+  def dockerLog4j = project.projectDir.toPath().resolve(\"src/docker/config/log4j2.properties\").toFile()\n+  inputs.files(originalLog4j, dockerLog4j)\n+  def patternPropertyKey = \"appender.audit_rolling.layout.pattern\"\n+  doLast {\n+    def coreLog4jProperties = new Properties()\n+    originalLog4j.withInputStream { input ->\n+      coreLog4jProperties.load(input)\n+    }\n+\n+    if (false == coreLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${originalLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    def dockerLog4jProperties = new Properties()\n+    dockerLog4j.withInputStream { input ->\n+      dockerLog4jProperties.load(input)\n+    }\n+\n+    if (false == dockerLog4jProperties.containsKey(patternPropertyKey)) {\n+      throw new GradleException(\"The [${dockerLog4j.getPath()}] file changed such that the layout pattern is not \" +\n+              \"referred to by the property named [${patternPropertyKey}]. Please update the task [${name}] \" +\n+              \"definition from project [${path}] to reflect the new name for the layout pattern property.\")\n+    }\n+\n+    if (false == coreLog4jProperties.getProperty(patternPropertyKey).equals(dockerLog4jProperties.getProperty(patternPropertyKey))) {\n+      throw new GradleException(\"The property value for the layout pattern [${patternPropertyKey}] is NOT identical \" +\n+              \"between the [${originalLog4j.getPath()}] and the [${dockerLog4j.getPath()}] files.\")\n+    }\n+  }\n+}\n+precommit.dependsOn 'checkSecurityAuditLayoutPatternIdentical'", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNDU0NDQ4OQ=="}, "originalCommit": {"oid": "c1af98251bc87bc934691f221ce71bc2a8020c47"}, "originalPosition": 39}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3092, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}