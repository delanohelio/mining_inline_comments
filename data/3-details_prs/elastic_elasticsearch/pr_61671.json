{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc1MzU4ODgy", "number": 61671, "title": "Preserve grok pattern ordering and add sort option", "bodyText": "The grok processor REST endpoint returns the bundled grok patterns in an undetermined order. This PR changes the default behavior to return them in the order in which they were read from disk which preserves the natural grouping of related patterns such as \"S3_ACCESS_LOG\" and \"ELB_URI\" for AWS-related patterns though they share no common prefix. An option to return all patterns sorted by key was also added.\nResolves #40819.", "createdAt": "2020-08-28T11:46:10Z", "url": "https://github.com/elastic/elasticsearch/pull/61671", "merged": true, "mergeCommit": {"oid": "9dcab76427b62d69fdb411e849b4ff643f049a68"}, "closed": true, "closedAt": "2020-09-08T12:10:27Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDTarwgH2gAyNDc1MzU4ODgyOmFhNmYxODYxZWUyMjg3NWY2OTgxMzI1NTE0YWRhYzY5OWM4Yjg1OWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGqmQngFqTQ4MzcxNzk2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "aa6f1861ee22875f6981325514adac699c8b859f", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/aa6f1861ee22875f6981325514adac699c8b859f", "committedDate": "2020-08-28T11:36:21Z", "message": "preserve pattern ordering and add sort option"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "26294d9cb34de1dd5772fafb082d5a30407a771f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/26294d9cb34de1dd5772fafb082d5a30407a771f", "committedDate": "2020-08-28T13:09:37Z", "message": "Merge branch 'master' into 40819_sort_grok_patterns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyMjMwMzA0", "url": "https://github.com/elastic/elasticsearch/pull/61671#pullrequestreview-482230304", "createdAt": "2020-09-03T21:57:26Z", "commit": {"oid": "26294d9cb34de1dd5772fafb082d5a30407a771f"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1NzoyNlrOHM4zVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QyMTo1ODo1OFrOHM41lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NTYwNQ==", "bodyText": "Should this be guarded with version check? What will happen if we receive request from older node where there where no sorted field?", "url": "https://github.com/elastic/elasticsearch/pull/61671#discussion_r483275605", "createdAt": "2020-09-03T21:57:26Z", "author": {"login": "probakowski"}, "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/GrokProcessorGetAction.java", "diffHunk": "@@ -55,16 +56,31 @@ private GrokProcessorGetAction() {\n \n     public static class Request extends ActionRequest {\n \n-        public Request() {}\n+        private final boolean sorted;\n+\n+        public Request(boolean sorted) {\n+            this.sorted = sorted;\n+        }\n \n         Request(StreamInput in) throws IOException {\n             super(in);\n+            this.sorted = in.readBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26294d9cb34de1dd5772fafb082d5a30407a771f"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzI3NjE4Mw==", "bodyText": "We could extract this new TreeMap<>(patterns) to a field to only sort all patterns once as they are constant. We could then skip this method completely.", "url": "https://github.com/elastic/elasticsearch/pull/61671#discussion_r483276183", "createdAt": "2020-09-03T21:58:58Z", "author": {"login": "probakowski"}, "path": "modules/ingest-common/src/main/java/org/elasticsearch/ingest/common/GrokProcessorGetAction.java", "diffHunk": "@@ -108,11 +124,15 @@ public TransportAction(TransportService transportService, ActionFilters actionFi\n         @Override\n         protected void doExecute(Task task, Request request, ActionListener<Response> listener) {\n             try {\n-                listener.onResponse(new Response(GROK_PATTERNS));\n+                listener.onResponse(new Response(getGrokPatternsResponse(GROK_PATTERNS, request.sorted())));\n             } catch (Exception e) {\n                 listener.onFailure(e);\n             }\n         }\n+\n+        static Map<String, String> getGrokPatternsResponse(Map<String, String> patterns, boolean sorted) {\n+            return sorted ? new TreeMap<>(patterns) : patterns;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "26294d9cb34de1dd5772fafb082d5a30407a771f"}, "originalPosition": 53}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6473729f77562215da544b55c11969d5fc643b8", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/d6473729f77562215da544b55c11969d5fc643b8", "committedDate": "2020-09-04T14:18:16Z", "message": "version-aware serialization"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9d3a31a02b16699572e9ebd5a8bde2ed192f6607", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/9d3a31a02b16699572e9ebd5a8bde2ed192f6607", "committedDate": "2020-09-04T15:18:34Z", "message": "sort the patterns only once"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "503ebd534c636b08a498e6267aa5f325d666ffcf", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/503ebd534c636b08a498e6267aa5f325d666ffcf", "committedDate": "2020-09-04T15:31:36Z", "message": "Merge branch 'master' into 40819_sort_grok_patterns"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgzNzE3OTY1", "url": "https://github.com/elastic/elasticsearch/pull/61671#pullrequestreview-483717965", "createdAt": "2020-09-07T22:18:35Z", "commit": {"oid": "503ebd534c636b08a498e6267aa5f325d666ffcf"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4628, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}