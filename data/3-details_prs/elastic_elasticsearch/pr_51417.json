{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY2ODQ0NTU2", "number": 51417, "title": "Remove translog retention policy", "bodyText": "We no longer need to retain the extra translog for peer recovery as we have switched using Lucene index exclusively in 8.0. This change removes the translog retention policy.\nI think we can also remove the async trim translog task. I will do it in a separate PR.\nRelates #50775", "createdAt": "2020-01-24T13:48:51Z", "url": "https://github.com/elastic/elasticsearch/pull/51417", "merged": true, "mergeCommit": {"oid": "b034d1e2ef81bcf150ea7d7c115009d2e71545f6"}, "closed": true, "closedAt": "2020-01-24T20:13:53Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb9fAyzAH2gAyMzY2ODQ0NTU2OmQxYzA4NjMyN2ExMTM1MjM3NDhkMDY0YmMzNjU0MTcyZTc0YjMyMDg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb9ijZugFqTM0ODExNDgwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d1c086327a113523748d064bc3654172e74b3208", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1c086327a113523748d064bc3654172e74b3208", "committedDate": "2020-01-24T13:32:14Z", "message": "Remove translog retention policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f0118f20e8b8b3229e12d856a6483f721ee857f1", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f0118f20e8b8b3229e12d856a6483f721ee857f1", "committedDate": "2020-01-24T14:42:12Z", "message": "fix translog policy in truncate translog"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MDk1Nzkw", "url": "https://github.com/elastic/elasticsearch/pull/51417#pullrequestreview-348095790", "createdAt": "2020-01-24T17:05:43Z", "commit": {"oid": "f0118f20e8b8b3229e12d856a6483f721ee857f1"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNzowNTo0M1rOFhkTcQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNFQxNzoxMzo0MVrOFhkhFw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc0MjEyOQ==", "bodyText": "should we deprecate these settings in 7 and disallow setting them on 8.x indices?\nWe should also add docs in this PR saying that these settings are no longer supported and are effectively ignored", "url": "https://github.com/elastic/elasticsearch/pull/51417#discussion_r370742129", "createdAt": "2020-01-24T17:05:43Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/IndexSettings.java", "diffHunk": "@@ -248,8 +248,7 @@\n      * This setting will be ignored if soft-deletes is used in peer recoveries (default in 7.4).\n      **/\n     public static final Setting<TimeValue> INDEX_TRANSLOG_RETENTION_AGE_SETTING =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0118f20e8b8b3229e12d856a6483f721ee857f1"}, "originalPosition": 3}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc0NTA1NA==", "bodyText": "\ud83d\udcaf", "url": "https://github.com/elastic/elasticsearch/pull/51417#discussion_r370745054", "createdAt": "2020-01-24T17:12:17Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/translog/TranslogDeletionPolicy.java", "diffHunk": "@@ -156,66 +134,9 @@ private synchronized void releaseTranslogGen(long translogGen) {\n     /**\n      * returns the minimum translog generation that is still required by the system. Any generation below\n      * the returned value may be safely deleted\n-     *\n-     * @param readers current translog readers\n-     * @param writer  current translog writer\n      */\n-    synchronized long minTranslogGenRequired(List<TranslogReader> readers, TranslogWriter writer) throws IOException {\n-        long minByLocks = getMinTranslogGenRequiredByLocks();\n-        long minByAge = getMinTranslogGenByAge(readers, writer, retentionAgeInMillis, currentTime());\n-        long minBySize = getMinTranslogGenBySize(readers, writer, retentionSizeInBytes);\n-        final long minByAgeAndSize;\n-        if (minBySize == Long.MIN_VALUE && minByAge == Long.MIN_VALUE) {\n-            // both size and age are disabled;\n-            minByAgeAndSize = Long.MAX_VALUE;\n-        } else {\n-            minByAgeAndSize = Math.max(minByAge, minBySize);\n-        }\n-        long minByNumFiles = getMinTranslogGenByTotalFiles(readers, writer, retentionTotalFiles);\n-        return Math.min(Math.max(minByAgeAndSize, minByNumFiles), Math.min(minByLocks, minTranslogGenerationForRecovery));\n-    }\n-\n-    static long getMinTranslogGenBySize(List<TranslogReader> readers, TranslogWriter writer, long retentionSizeInBytes) {\n-        if (retentionSizeInBytes >= 0) {\n-            long totalSize = writer.sizeInBytes();\n-            long minGen = writer.getGeneration();\n-            for (int i = readers.size() - 1; i >= 0 && totalSize < retentionSizeInBytes; i--) {\n-                final TranslogReader reader = readers.get(i);\n-                totalSize += reader.sizeInBytes();\n-                minGen = reader.getGeneration();\n-            }\n-            return minGen;\n-        } else {\n-            return Long.MIN_VALUE;\n-        }\n-    }\n-\n-    static long getMinTranslogGenByAge(List<TranslogReader> readers, TranslogWriter writer, long maxRetentionAgeInMillis, long now)\n-        throws IOException {\n-        if (maxRetentionAgeInMillis >= 0) {\n-            for (TranslogReader reader: readers) {\n-                if (now - reader.getLastModifiedTime() <= maxRetentionAgeInMillis) {\n-                    return reader.getGeneration();\n-                }\n-            }\n-            return writer.getGeneration();\n-        } else {\n-            return Long.MIN_VALUE;\n-        }\n-    }\n-\n-    static long getMinTranslogGenByTotalFiles(List<TranslogReader> readers, TranslogWriter writer, final int maxTotalFiles) {\n-        long minGen = writer.generation;\n-        int totalFiles = 1; // for the current writer\n-        for (int i = readers.size() - 1; i >= 0 && totalFiles < maxTotalFiles; i--) {\n-            totalFiles++;\n-            minGen = readers.get(i).generation;\n-        }\n-        return minGen;\n-    }\n-\n-    protected long currentTime() {\n-        return System.currentTimeMillis();\n+    synchronized long minTranslogGenRequired() {\n+        return Math.min(getMinTranslogGenRequiredByLocks(), minTranslogGenerationForRecovery);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0118f20e8b8b3229e12d856a6483f721ee857f1"}, "originalPosition": 118}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MDc0NTYyMw==", "bodyText": "why remove this test (and the one below)? We have not removed this functionality and still need it, no?", "url": "https://github.com/elastic/elasticsearch/pull/51417#discussion_r370745623", "createdAt": "2020-01-24T17:13:41Z", "author": {"login": "ywelsch"}, "path": "server/src/test/java/org/elasticsearch/index/IndexServiceTests.java", "diffHunk": "@@ -367,70 +361,6 @@ public void testRescheduleAsyncFsync() throws Exception {\n         assertNotNull(indexService.getFsyncTask());\n     }\n \n-    public void testAsyncTranslogTrimActuallyWorks() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f0118f20e8b8b3229e12d856a6483f721ee857f1"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "82255aae678c57e1b0ab4c67d7e21be7266cfb7f", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/82255aae678c57e1b0ab4c67d7e21be7266cfb7f", "committedDate": "2020-01-24T17:25:18Z", "message": "revert async trim task test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "975b8e46bac37eae858732f582f4af8037f85c4d", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/975b8e46bac37eae858732f582f4af8037f85c4d", "committedDate": "2020-01-24T17:25:50Z", "message": "Merge branch 'master' into remove-translog-deletion-policy"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4MTE0ODAx", "url": "https://github.com/elastic/elasticsearch/pull/51417#pullrequestreview-348114801", "createdAt": "2020-01-24T17:39:45Z", "commit": {"oid": "975b8e46bac37eae858732f582f4af8037f85c4d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2703, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}