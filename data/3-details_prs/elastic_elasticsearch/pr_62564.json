{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NzgzNjg2", "number": 62564, "title": "[ML] Handle data frame analytics state spreading over multiple docs", "bodyText": "When state persistence was first implemented for data frame analytics\nwe had the assumption that state would always fit in a single document.\nHowever this is not the case any more.\nThis commit adds handling of state that spreads over multiple documents.\nCloses #52476", "createdAt": "2020-09-17T16:15:07Z", "url": "https://github.com/elastic/elasticsearch/pull/62564", "merged": true, "mergeCommit": {"oid": "2723a119ffc7cb9765ac2283f4f187ca5368f277"}, "closed": true, "closedAt": "2020-09-23T12:21:31Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJzPiagH2gAyNDg4NzgzNjg2OmJjZGI2YjVkNzZhMGU3OTE4OTk3YmZhNWU2YWZhYzlmOTYwNzFlODY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdLrlJvAFqTQ5NDU5NTE2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/bcdb6b5d76a0e7918997bfa5e6afac9f96071e86", "committedDate": "2020-09-17T16:04:41Z", "message": "[ML] Handle data frame analytics state spreading over multiple docs\n\nWhen state persistence was first implemented for data frame analytics\nwe had the assumption that state would always fit in a single document.\nHowever this is not the case any more.\n\nThis commit adds handling of state that spreads over multiple documents."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwODAyNDg3", "url": "https://github.com/elastic/elasticsearch/pull/62564#pullrequestreview-490802487", "createdAt": "2020-09-17T16:52:59Z", "commit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjo1MzowMFrOHTseYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNjo1MzoyMVrOHTsfNw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMzY2NQ==", "bodyText": "nit...as this is technically not a suffix any longer :D\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String STATE_DOC_ID_SUFFIX = \"_classification_state#\";\n          \n          \n            \n                private static final String STATE_DOC_ID_INFIX = \"_classification_state#\";", "url": "https://github.com/elastic/elasticsearch/pull/62564#discussion_r490413665", "createdAt": "2020-09-17T16:53:00Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java", "diffHunk": "@@ -55,7 +55,7 @@\n     public static final ParseField RANDOMIZE_SEED = new ParseField(\"randomize_seed\");\n     public static final ParseField FEATURE_PROCESSORS = new ParseField(\"feature_processors\");\n \n-    private static final String STATE_DOC_ID_SUFFIX = \"_classification_state#1\";\n+    private static final String STATE_DOC_ID_SUFFIX = \"_classification_state#\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDQxMzg3OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                private static final String STATE_DOC_ID_SUFFIX = \"_regression_state#\";\n          \n          \n            \n                private static final String STATE_DOC_ID_INFIX = \"_regression_state#\";", "url": "https://github.com/elastic/elasticsearch/pull/62564#discussion_r490413879", "createdAt": "2020-09-17T16:53:21Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Regression.java", "diffHunk": "@@ -51,7 +51,7 @@\n     public static final ParseField LOSS_FUNCTION_PARAMETER = new ParseField(\"loss_function_parameter\");\n     public static final ParseField FEATURE_PROCESSORS = new ParseField(\"feature_processors\");\n \n-    private static final String STATE_DOC_ID_SUFFIX = \"_regression_state#1\";\n+    private static final String STATE_DOC_ID_SUFFIX = \"_regression_state#\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxMTgyOTgy", "url": "https://github.com/elastic/elasticsearch/pull/62564#pullrequestreview-491182982", "createdAt": "2020-09-18T06:29:08Z", "commit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjoyOTowOFrOHT_vcg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjozNTowMlrOHT_4XQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyOTMzMA==", "bodyText": "Is this recursion needed? Would it be possible to delete all the #1, #2, etc. in one deleteByQuery request?\nI know we don't know the number of state docs in advance, but maybe we could apply some id pattern?", "url": "https://github.com/elastic/elasticsearch/pull/62564#discussion_r490729330", "createdAt": "2020-09-18T06:29:08Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteDataFrameAnalyticsAction.java", "diffHunk": "@@ -242,17 +241,46 @@ private void deleteState(ParentTaskAssigningClient parentTaskClient,\n                              DataFrameAnalyticsConfig config,\n                              TimeValue timeout,\n                              ActionListener<BulkByScrollResponse> listener) {\n-        List<String> ids = new ArrayList<>();\n-        ids.add(StoredProgress.documentId(config.getId()));\n-        if (config.getAnalysis().persistsState()) {\n-            ids.add(config.getAnalysis().getStateDocId(config.getId()));\n+        ActionListener<Boolean> deleteModelStateListener = ActionListener.wrap(\n+            r -> executeDeleteByQuery(\n+                    parentTaskClient,\n+                    AnomalyDetectorsIndex.jobStateIndexPattern(),\n+                    QueryBuilders.idsQuery().addIds(StoredProgress.documentId(config.getId())),\n+                    timeout,\n+                    listener\n+                )\n+            , listener::onFailure\n+        );\n+\n+        deleteModelState(parentTaskClient, config, timeout, 1, deleteModelStateListener);\n+    }\n+\n+    private void deleteModelState(ParentTaskAssigningClient parentTaskClient,\n+                                  DataFrameAnalyticsConfig config,\n+                                  TimeValue timeout,\n+                                  int docNum,\n+                                  ActionListener<Boolean> listener) {\n+        if (config.getAnalysis().persistsState() == false) {\n+            listener.onResponse(true);\n+            return;\n         }\n+\n+        IdsQueryBuilder query = QueryBuilders.idsQuery().addIds(config.getAnalysis().getStateDocIdPrefix(config.getId()) + docNum);\n         executeDeleteByQuery(\n             parentTaskClient,\n             AnomalyDetectorsIndex.jobStateIndexPattern(),\n-            QueryBuilders.idsQuery().addIds(ids.toArray(String[]::new)),\n+            query,\n             timeout,\n-            listener\n+            ActionListener.wrap(\n+                response -> {\n+                    if (response.getDeleted() > 0) {\n+                        deleteModelState(parentTaskClient, config, timeout, docNum + 1, listener);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyOTgyNQ==", "bodyText": "Does UnusedStateRemover class need to be changed too?", "url": "https://github.com/elastic/elasticsearch/pull/62564#discussion_r490729825", "createdAt": "2020-09-18T06:30:21Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteDataFrameAnalyticsAction.java", "diffHunk": "@@ -242,17 +241,46 @@ private void deleteState(ParentTaskAssigningClient parentTaskClient,\n                              DataFrameAnalyticsConfig config,\n                              TimeValue timeout,\n                              ActionListener<BulkByScrollResponse> listener) {\n-        List<String> ids = new ArrayList<>();\n-        ids.add(StoredProgress.documentId(config.getId()));\n-        if (config.getAnalysis().persistsState()) {\n-            ids.add(config.getAnalysis().getStateDocId(config.getId()));\n+        ActionListener<Boolean> deleteModelStateListener = ActionListener.wrap(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDczMTYxMw==", "bodyText": "This comment is somewhat related to the one about using recursion. Could we fetch all the state docs at once using some pattern-matched query?\nIf not, and if\nwe expect  many state docs to exist, we could try to fetch them in batches (by adding ids #1, #2, ..., #10 to one ids query) to reduce the number of queries.\nPlease disregard the above if we expect the number of docs to be small so there is no need for premature optimization.", "url": "https://github.com/elastic/elasticsearch/pull/62564#discussion_r490731613", "createdAt": "2020-09-18T06:35:02Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/NativeAnalyticsProcess.java", "diffHunk": "@@ -56,10 +59,23 @@ public AnalyticsProcessConfig getConfig() {\n     }\n \n     @Override\n-    public void restoreState(BytesReference state) throws IOException {\n-        Objects.requireNonNull(state);\n+    public void restoreState(Client client, String stateDocIdPrefix) throws IOException {\n+        Objects.requireNonNull(stateDocIdPrefix);\n         try (OutputStream restoreStream = processRestoreStream()) {\n-            StateToProcessWriterHelper.writeStateToStream(state, restoreStream);\n+            int docNum = 0;\n+            while (true) {\n+                if (isProcessKilled()) {\n+                    return;\n+                }\n+\n+                SearchResponse stateResponse = client.prepareSearch(AnomalyDetectorsIndex.jobStateIndexPattern())\n+                    .setSize(1)\n+                    .setQuery(QueryBuilders.idsQuery().addIds(stateDocIdPrefix + ++docNum)).get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bcdb6b5d76a0e7918997bfa5e6afac9f96071e86"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "11150afea4c91b32647eeac127c85ff864da623d", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/11150afea4c91b32647eeac127c85ff864da623d", "committedDate": "2020-09-22T13:00:46Z", "message": "Update x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Classification.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ea697fb8713f44de7e70be40aa0f0e6960f0b851", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/ea697fb8713f44de7e70be40aa0f0e6960f0b851", "committedDate": "2020-09-22T13:00:54Z", "message": "Update x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/analyses/Regression.java\n\nCo-authored-by: Benjamin Trent <ben.w.trent@gmail.com>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "888a6e7468dfe48f4006ffefb5fa96d197e5852f", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/888a6e7468dfe48f4006ffefb5fa96d197e5852f", "committedDate": "2020-09-22T13:34:38Z", "message": "Add comment and useful debug statement"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97ac021262151d54d886ead3a4df718eaad99ac3", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/97ac021262151d54d886ead3a4df718eaad99ac3", "committedDate": "2020-09-22T13:35:01Z", "message": "Merge branch 'master' into handle-dfa-state-spreading-multiple-docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cb4af575b36c28d5ff30be6803bb1ab8acdc3205", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/cb4af575b36c28d5ff30be6803bb1ab8acdc3205", "committedDate": "2020-09-22T13:52:57Z", "message": "Fix compile errors"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a7b8a0f67223f4e98f92d27165b881090f44a4a5", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/a7b8a0f67223f4e98f92d27165b881090f44a4a5", "committedDate": "2020-09-23T06:58:30Z", "message": "Merge branch 'master' into handle-dfa-state-spreading-multiple-docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk0NTk1MTY1", "url": "https://github.com/elastic/elasticsearch/pull/62564#pullrequestreview-494595165", "createdAt": "2020-09-23T12:16:54Z", "commit": {"oid": "a7b8a0f67223f4e98f92d27165b881090f44a4a5"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3656, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}