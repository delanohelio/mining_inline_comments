{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc4MjUzOTI2", "number": 52636, "reviewThreads": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1ODowMlrODjtBKA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0NDozNVrODkwJxw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM4NzY0MzI4OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1ODowMlrOFvqQ8Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yOFQwNTo1ODowMlrOFvqQ8Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NTUxOTg1Nw==", "bodyText": "We never call out what scripting features are related to which types of templates so \"corresponding\" might be confusing here. What's more,  we never call out the fact that you can reference a stored script in a template by id in any of the examples. Maybe something like:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            NOTE: Role templates require corresponding scripting feature to be enabled.\n          \n          \n            \n            Otherwise, role mapping with role templates will fail to create. See\n          \n          \n            \n            <<allowed-script-types-setting>>.\n          \n          \n            \n            NOTE: Role templates require the relevant scripting feature to be enabled, otherwise the creation of a role mapping with role templates will fail. See <<allowed-script-types-setting>>.\n          \n      \n    \n    \n  \n\nand add an example where we reference a stored script template by id ?", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r385519857", "createdAt": "2020-02-28T05:58:02Z", "author": {"login": "jkakavas"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require corresponding scripting feature to be enabled.\n+Otherwise, role mapping with role templates will fail to create. See\n+<<allowed-script-types-setting>>.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d58a4c8ea60a5d3d33ea708f9d7b0befacbda4e5"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5MjI2MTIxOnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": false, "comments": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQwNDo1MDoxMFrOFwTjoQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNFQxMTozNDoxNFrOF6sJhw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ==", "bodyText": "Can we think carefully about whether we really want to document & support this?\nWhat's the use case? Why do we want to elevate this to \"officially supported\"?", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386196385", "createdAt": "2020-03-02T04:50:10Z", "author": {"login": "tvernum"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjIwMDYxMw==", "bodyText": "hmm good question. One issue of using stored script is consistency, i.e. the script can change without the role-mapping being aware of it. This could potentially creates confusion and support time frustration.  Is this the reason why we may not want to \"officially\" support it? (I assume adding it to official docs means offical support).", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386200613", "createdAt": "2020-03-02T05:14:58Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxOTE4NA==", "bodyText": "What's the use case? Why do we want to elevate this to \"officially supported\"?\n\nCan I flip the question ? Why do we \"unofficially' support this already ? Why not disallow it instead ?", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r387319184", "createdAt": "2020-03-03T21:58:52Z", "author": {"login": "jkakavas"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MTk3NzE3Mg==", "bodyText": "I undersetand there are cases where we intentionally left them as a grey area, i.e. \"unofficially supported\". But I feel this is not the case here because:\n\nStored script support is not an unique feature for this API. It is available and documented elsewhere. So in some sense, it is already officially supported. There could be issues with stored scripts in general, which should be a separate discussion.\nIf we decide to disable the support here, it will be a breaking change even it is \"unofficially\" supported. So keeping it \"unofficial\" does not really buy us anything from this perspective.\nGeneral gain of clarity when something is clearly documented\n\nSo overall, I'd prefer to have it documented. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r391977172", "createdAt": "2020-03-13T00:51:06Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjgzNjg2Ng==", "bodyText": "I'm not convinced.\nWhat reason do we have for people to do this? Why should we spend time and effort maintaining the docs for this, when it has no clear value to anyone?", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r396836866", "createdAt": "2020-03-24T00:25:51Z", "author": {"login": "tvernum"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg1MDA5OA==", "bodyText": "Is there some context that I am not aware of, e.g. any past discussions about not having this documented in the first place? I admit that I don't have a strong reason other than \"completeness\" to add this in. But are there strong reasons to not add it? I can think of a few candidates:\n\nWe don't want people to use stored script for authentication related stuff since a missing script is more devastating\nWe don't encourage stored script usage in general\nWe may want disable stored script for role template in future and by not documenting it we could avoid a breaking change\nNo user requires it\nWe don't spend the extra time and effort because of 4\n\nI'd be happy to go with item 1, 2, 3, but not particularly convinced by 4 and 5. I cannot say user would see value in this, but cannot say they would not either, unless there are past evidents of this being no value. Also the time and effort for this additional docs are not really significant.\nI am not really attached to this snippet of docs. I am happy to either remove or keep it. Just like to clear my thought process. I'd appreicate if you could elaborate it a bit.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r396850098", "createdAt": "2020-03-24T01:14:05Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg3OTIyMQ==", "bodyText": "Less is more.\nThere's a temptation toward more docs (and lots of places where our docs are too brief) but it isn't always better.\nOne of our recurring experiences is that people try and configure ES security based on blogs because they seem simpler. The official docs have \"more steps\" so they follow a blog and then get stuck because those steps were actually necessarily and the blog skipped over them (or made assumptions that allowed them to ignore the steps) to keep it short.\nDocumenting something, tells people \"this might be helpful to you\" and also \"you should read this if you want to understand how to use this feature\". But I don't see any argument for why either of those are true here. So what's the reason to do it?\nOr, put another way, if a customer raises a support ticket saying \"I'm trying to use a role mapping with a stored script as the template\" my immediate reaction would be \"Why on earth would you do that? That's a terrible idea!\"\nAnd their (entirely reasonable) answer will be because you documented it.\n\nI cannot say user would see value in this\n\nThen don't do it.\nIt's easy - if we cannot work out a reason why users would want to do it, then don't recommend it to them. Don't waste time writing and maintaining the docs. Don't waste their time by asking them to read those docs.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r396879221", "createdAt": "2020-03-24T03:11:02Z", "author": {"login": "tvernum"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Njg4NDUwMA==", "bodyText": "if a customer raises a support ticket saying \"I'm trying to use a role mapping with a stored script as the template\" my immediate reaction would be \"Why on earth would you do that? That's a terrible idea!\"\n\nI can resonate with this argument. I do agree it's not a good idea to make a role template depend on external stuff. Since we cannot or don't want to recommend this usage ourselves, it makes sense to leave it out. Will update accordingly. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r396884500", "createdAt": "2020-03-24T03:33:24Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzAzNjk2NA==", "bodyText": "For what it\u2019s worth, the role mapping UI in Kibana attempts to support the entire API surface. In other words, any valid role mapping created via the API should render and be editable in the UI. We of course default to inline scripts for these templates in the interface, but since stored scripts are technically available, we have to know how to render those as well, so there are UI controls to edit them.\nI personally agree that these stored templates don\u2019t make a lot of sense. Even if they aren\u2019t documented, they\u2019re more discoverable than they used to be because we now have a dedicated UI. For some folks, the UI will become the documentation, so like it or not, I fear we end up (currently) with the appearance that this is a first-class feature of role mappings.\nWe can consider changes to the UI which only surface these controls when editing an exiting mapping which already contains a stored script, but not without additional complexity", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r397036964", "createdAt": "2020-03-24T10:10:22Z", "author": {"login": "legrego"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzA4NTA2Mw==", "bodyText": "Thanks for the insights @legrego\nYou are right that the UI could be considered as documentation or even source of truth for some users. The UI also has a link to the doco ... it is possible that users would notice the difference and ask \"why is there no document for this feature\".\nFor now, we are trying to not actively promote it. I wonder whether we could afford to disable it in 8.0. But I suspect that the solution could end up being adding more machinery to make this feature more robust, e.g. reference counting a stored script.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r397085063", "createdAt": "2020-03-24T11:34:14Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the\n+`template` field. Above role mapping can also be created with the follows:\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_scripts/derive-roles\n+{\n+  \"script\": {\n+      \"lang\": \"mustache\",\n+      \"source\" : \"{{#tojson}}groups{{/tojson}}\"\n+  }\n+}\n+------------------------------------------------------------\n+\n+[source,console]\n+------------------------------------------------------------\n+POST /_security/role_mapping/mapping5\n+{\n+  \"role_templates\": [\n+    {\n+      \"template\": { \"id\": \"derive-roles\" },\n+      \"format\" : \"json\"\n+    }\n+  ],\n+  \"rules\": {\n+    \"field\" : { \"realm.name\" : \"saml1\" }\n+  },\n+  \"enabled\": true\n+}\n+------------------------------------------------------------\n+// TEST[continued]\n+", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjE5NjM4NQ=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 60}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NDc3NDc5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxODo1NTo0NFrOFwrN0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxODo1NTo0NFrOFwrN0w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NDAxOQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            In addition to inline script, we can also use stored script for the\n          \n          \n            \n            In addition to an inline script, you can also use a stored script for the", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386584019", "createdAt": "2020-03-02T18:55:44Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -233,6 +237,38 @@ POST /_security/role_mapping/mapping5\n <2> Because the template produces a JSON array, the format must be\n     set to `json`.\n \n+In addition to inline script, we can also use stored script for the", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NDc4MTI5OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxODo1NzoyNlrOFwrRzg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QwMDo0MzoyOVrOFw0kvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NTAzOA==", "bodyText": "I think this NOTE should move below the introductory paragraph, since at this point we haven't defined role templates yet.  I actually also think this whole \"Role templates\" subsection should be moved into the \"Description\" section.  If you're willing to let me add that change to this PR, let me know and I'll push a commit.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386585038", "createdAt": "2020-03-02T18:57:26Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require the relevant scripting feature to be enabled,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjcyMjI0MA==", "bodyText": "Thanks Lisa. Please make changes as you see fit. Thanks a lot.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386722240", "createdAt": "2020-03-02T23:55:07Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require the relevant scripting feature to be enabled,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NTAzOA=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjczNzM0MA==", "bodyText": "Done, thanks!", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386737340", "createdAt": "2020-03-03T00:43:29Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require the relevant scripting feature to be enabled,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NTAzOA=="}, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NDc4OTE1OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxODo1OTozM1rOFwrWcA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxODo1OTozM1rOFwrWcA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NjIyNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            NOTE: Role templates require the relevant scripting feature to be enabled,\n          \n          \n            \n            NOTE: To use role templates successfully, the relevant scripting feature must be enabled.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386586224", "createdAt": "2020-03-02T18:59:33Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require the relevant scripting feature to be enabled,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 18}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5NDc5MjA4OnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOTowMDoyNVrOFwrYTQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wMlQxOTowMDoyNVrOFwrYTQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NjU4NjcwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            otherwise the creation of a role mapping with role templates will fail.\n          \n          \n            \n            Otherwise, all attempts to create a role mapping with role templates fail.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r386586701", "createdAt": "2020-03-02T19:00:25Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -77,10 +77,14 @@ _Exactly one of `roles` or `role_templates` must be specified_.\n `rules`::\n (Required, object) The rules that determine which users should be matched by the\n mapping. A rule is a logical condition that is expressed by using a JSON DSL.\n-See  <<role-mapping-resources>>. \n+See  <<role-mapping-resources>>.\n \n ==== Role Templates\n \n+NOTE: Role templates require the relevant scripting feature to be enabled,\n+otherwise the creation of a role mapping with role templates will fail.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "59b840550c0605d54476fca8072384af34031bd2"}, "originalPosition": 19}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjM5ODY0MjYzOnYy", "diffSide": "RIGHT", "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QxNzo0NDozNVrOFxQAVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wM1QyMTo1NjoxMFrOFxYAYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Njc3Mg==", "bodyText": "It's a bad practice to link to the auto-generated anchors, so it's unfortunate that one in the Kibana docs snuck through.  I think by explicitly defining that anchor, however, we should avoid breaking the link:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            [[security-api-put-role-mapping-desc-templates]]\n          \n          \n            \n            [[_role_templates]]", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r387186772", "createdAt": "2020-03-03T17:44:35Z", "author": {"login": "lcawl"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -37,6 +37,31 @@ roles API>> or <<roles-management-file,roles files>>.\n \n For more information, see <<mapping-roles>>.\n \n+[[security-api-put-role-mapping-desc-templates]]", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b6f68ba2c54575f985f207d79e181a93c012742f"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzMxNzg1Nw==", "bodyText": "Thanks Lisa. This is a clever way to solve the issue.", "url": "https://github.com/elastic/elasticsearch/pull/52636#discussion_r387317857", "createdAt": "2020-03-03T21:56:10Z", "author": {"login": "ywangd"}, "path": "x-pack/docs/en/rest-api/security/create-role-mappings.asciidoc", "diffHunk": "@@ -37,6 +37,31 @@ roles API>> or <<roles-management-file,roles files>>.\n \n For more information, see <<mapping-roles>>.\n \n+[[security-api-put-role-mapping-desc-templates]]", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4NzE4Njc3Mg=="}, "originalCommit": {"oid": "b6f68ba2c54575f985f207d79e181a93c012742f"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3876, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}