{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcyNTQwODMz", "number": 52073, "title": "Allow forcemerge in the hot phase for ILM policies", "bodyText": "This commit changes the forcemerge action to also be allowed in the hot phase for policies. The\nforcemerge will occur after a rollover, and allows users to take advantage of higher disk speeds for\nperforming the force merge (on a separate node type, for example).\nOn caveat with this is that a forcemerge in the hot phase MUST be accompanied by a rollover\naction. ILM validates policies to ensure this is the case.\nResolves #43165", "createdAt": "2020-02-07T18:23:50Z", "url": "https://github.com/elastic/elasticsearch/pull/52073", "merged": true, "mergeCommit": {"oid": "e95cc14d13aee8b0349ff2cb622587a4ddec3612"}, "closed": true, "closedAt": "2020-02-07T22:26:01Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcCDhRJgH2gAyMzcyNTQwODMzOmFiYWRiYTk1ZTIxZjQxZWMzZjEyZDA2ZGNmZjZkZGFkZjlhNDEyM2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcCGCbmgH2gAyMzcyNTQwODMzOjcwNWYzOWI0MzBiMTQ1ODlhYTE4MWJjMzc0NGQ1MDQ4ODJiN2FhZDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/abadba95e21f41ec3f12d06dcff6ddadf9a4123f", "committedDate": "2020-02-07T18:19:59Z", "message": "Allow forcemerge in the hot phase for ILM policies\n\nThis commit changes the `forcemerge` action to also be allowed in the `hot` phase for policies. The\nforcemerge will occur after a rollover, and allows users to take advantage of higher disk speeds for\nperforming the force merge (on a separate node type, for example).\n\nOn caveat with this is that a `forcemerge` in the `hot` phase *MUST* be accompanied by a `rollover`\naction. ILM validates policies to ensure this is the case.\n\nResolves #43165"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDAwMDk4", "url": "https://github.com/elastic/elasticsearch/pull/52073#pullrequestreview-355400098", "createdAt": "2020-02-07T19:54:35Z", "commit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxOTo1NDozNlrOFnIglg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxOTo1NDozNlrOFnIglg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3ODE5OA==", "bodyText": "Would it be a bit faster to validate when generating the random policy that if we added forcemerge we will add rollover?", "url": "https://github.com/elastic/elasticsearch/pull/52073#discussion_r376578198", "createdAt": "2020-02-07T19:54:36Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/LifecyclePolicyTests.java", "diffHunk": "@@ -145,6 +146,24 @@ public static LifecyclePolicy randomTimeseriesLifecyclePolicyWithAllPhases(@Null\n     }\n \n     public static LifecyclePolicy randomTimeseriesLifecyclePolicy(@Nullable String lifecycleName) {\n+        LifecyclePolicy policy = null;\n+\n+        // Keep generating a random policy until it passes the validation,\n+        // ignoring known specific invalid states\n+        while (policy == null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1NDA2ODI0", "url": "https://github.com/elastic/elasticsearch/pull/52073#pullrequestreview-355406824", "createdAt": "2020-02-07T20:06:35Z", "commit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDowNjozNVrOFnI0ww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QyMDoxMDowOFrOFnI6dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4MzM2Mw==", "bodyText": "Can be simplified slightly:\nif (phases.stream()\n    // Is there a hot phase\n    .filter(phase -> HOT_PHASE.equals(phase.getName()))\n    // That contains the 'forcemerge' action\n    .filter(phase -> phase.getActions().containsKey(ForceMergeAction.NAME))\n    // But does *not* contain the 'rollover' action?\n    .anyMatch(phase -> phase.getActions().containsKey(RolloverAction.NAME) == false)) {\n    // If there is, throw an exception\n    throw new IllegalArgumentException(\"the [\" + ForceMergeAction.NAME +\n        \"] action may not be used in the [\" + HOT_PHASE +\n        \"] phase without an accompanying [\" + RolloverAction.NAME + \"] action\");\n}", "url": "https://github.com/elastic/elasticsearch/pull/52073#discussion_r376583363", "createdAt": "2020-02-07T20:06:35Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ilm/TimeseriesLifecycleType.java", "diffHunk": "@@ -195,5 +200,21 @@ public void validate(Collection<Phase> phases) {\n                 }\n             });\n         });\n+\n+        // Check for forcemerge in 'hot' without a rollover action\n+        phases.stream()\n+            // Is there a hot phase\n+            .filter(phase -> HOT_PHASE.equals(phase.getName()))\n+            // That contains the 'forcemerge' action\n+            .filter(phase -> phase.getActions().containsKey(ForceMergeAction.NAME))\n+            // But does *not* contain the 'rollover' action?\n+            .filter(phase -> phase.getActions().containsKey(RolloverAction.NAME) == false)\n+            // If there is, throw an exception\n+            .findAny()\n+            .ifPresent(phase -> {\n+                throw new IllegalArgumentException(\"the [\" + ForceMergeAction.NAME +\n+                    \"] action may not be used in the [\" + phase.getName() +\n+                    \"] phase without an accompanying [\" + RolloverAction.NAME + \"] action\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f"}, "originalPosition": 96}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU4NDgyMw==", "bodyText": "+1 for @andreidan idea, currently we risk potentially very long running tests (or random timeouts) if we can't generate correct policy", "url": "https://github.com/elastic/elasticsearch/pull/52073#discussion_r376584823", "createdAt": "2020-02-07T20:10:08Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/ilm/LifecyclePolicyTests.java", "diffHunk": "@@ -145,6 +146,24 @@ public static LifecyclePolicy randomTimeseriesLifecyclePolicyWithAllPhases(@Null\n     }\n \n     public static LifecyclePolicy randomTimeseriesLifecyclePolicy(@Nullable String lifecycleName) {\n+        LifecyclePolicy policy = null;\n+\n+        // Keep generating a random policy until it passes the validation,\n+        // ignoring known specific invalid states\n+        while (policy == null) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjU3ODE5OA=="}, "originalCommit": {"oid": "abadba95e21f41ec3f12d06dcff6ddadf9a4123f"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a64757c0e77307cdf516e63ddb1bf29ded897aa3", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/a64757c0e77307cdf516e63ddb1bf29ded897aa3", "committedDate": "2020-02-07T21:12:17Z", "message": "Use anyMatch instead of findAny in validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "705f39b430b14589aa181bc3744d504882b7aad8", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/705f39b430b14589aa181bc3744d504882b7aad8", "committedDate": "2020-02-07T21:16:01Z", "message": "Make randomTimeseriesLifecyclePolicy single-pass"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2683, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}