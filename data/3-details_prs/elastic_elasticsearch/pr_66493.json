{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQxNzM1OTMy", "number": 66493, "title": "EQL: Fix early trimming of in-flight data", "bodyText": "Rework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point.", "createdAt": "2020-12-17T09:42:18Z", "url": "https://github.com/elastic/elasticsearch/pull/66493", "merged": true, "mergeCommit": {"oid": "4f55749072b39f89822bdd52c67998f7bed890a9"}, "closed": true, "closedAt": "2020-12-17T15:19:31Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnAVFtgBqjQxMjQxODgzODg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdnEhP0gFqTU1NDY2MjE1Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "6fc9ba0b174272f808764ae600f267409d78d5fb", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/6fc9ba0b174272f808764ae600f267409d78d5fb", "committedDate": "2020-12-17T09:40:56Z", "message": "EQL: Fix early trimming of in-flight data\n\nRework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point."}, "afterCommit": {"oid": "2e0d4657100886b25cbd0717e1f7c531f897dd83", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e0d4657100886b25cbd0717e1f7c531f897dd83", "committedDate": "2020-12-17T09:42:55Z", "message": "EQL: Fix early trimming of in-flight data\n\nRework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a633834c4b724ac7714ec76a33e87526d81b230", "committedDate": "2020-12-17T11:52:54Z", "message": "EQL: Fix early trimming of in-flight data\n\nRework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2e0d4657100886b25cbd0717e1f7c531f897dd83", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/2e0d4657100886b25cbd0717e1f7c531f897dd83", "committedDate": "2020-12-17T09:42:55Z", "message": "EQL: Fix early trimming of in-flight data\n\nRework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point."}, "afterCommit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a633834c4b724ac7714ec76a33e87526d81b230", "committedDate": "2020-12-17T11:52:54Z", "message": "EQL: Fix early trimming of in-flight data\n\nRework trimToLast to take into account an ordinal for last trimming so\ninstead of keeping the last entry in a stage, it keeps the last entry\nbefore the given ordinal.\nThis takes care of the case where a dense stage that requires several\npasses does not discard valid data from a previous sparse stage that go\nbeyond the current stage point."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjEyNTg5", "url": "https://github.com/elastic/elasticsearch/pull/66493#pullrequestreview-554612589", "createdAt": "2020-12-17T13:41:26Z", "commit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo0MToyNlrOIH2H6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xN1QxMzo1MDoyNlrOIH2ggA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTA5NzcwNQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        // to trim unneeded until that occur before it\n          \n          \n            \n                        // to trim the ones before it", "url": "https://github.com/elastic/elasticsearch/pull/66493#discussion_r545097705", "createdAt": "2020-12-17T13:41:26Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/KeyToSequences.java", "diffHunk": "@@ -95,27 +95,30 @@ void remove(int stage, SequenceKey key) {\n     }\n \n     /**\n-     * Remove all matches expect the latest.\n+     * Remove all matches except the latest occurring _before_ the given ordinal.\n      */\n-    void trimToTail() {\n+    void trimToTail(Ordinal ordinal) {\n         for (Iterator<SequenceEntry> it = keyToSequences.values().iterator(); it.hasNext(); ) {\n             SequenceEntry seqs =  it.next();\n-            // first remove the sequences\n-            // and remember the last item from the first\n-            // initialized stage to be used with until\n+            // remember the last item found (will be ascending)\n+            // to trim unneeded until that occur before it", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "originalPosition": 15}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwMDMzMg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * less than the given argument alongside its position in the list.\n          \n          \n            \n                 * less than the given argument's timestamp, alongside its position in the list.", "url": "https://github.com/elastic/elasticsearch/pull/66493#discussion_r545100332", "createdAt": "2020-12-17T13:45:06Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java", "diffHunk": "@@ -52,11 +52,27 @@ void add(E element) {\n      * The element and everything before it is removed.\n      */\n     E trimBefore(Ordinal ordinal) {\n+        return trimBefore(ordinal, true);\n+    }\n+\n+    /**\n+     * Returns the latest element from the group that has its timestamp\n+     * less than the given argument alongside its position in the list.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwMDQ5Ng==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                 * Everything before the element it is removed. The element is kept.\n          \n          \n            \n                 * Everything before this element is removed. The element is kept.", "url": "https://github.com/elastic/elasticsearch/pull/66493#discussion_r545100496", "createdAt": "2020-12-17T13:45:20Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/OrdinalGroup.java", "diffHunk": "@@ -52,11 +52,27 @@ void add(E element) {\n      * The element and everything before it is removed.\n      */\n     E trimBefore(Ordinal ordinal) {\n+        return trimBefore(ordinal, true);\n+    }\n+\n+    /**\n+     * Returns the latest element from the group that has its timestamp\n+     * less than the given argument alongside its position in the list.\n+     * Everything before the element it is removed. The element is kept.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTEwNDAwMA==", "bodyText": "Wondering if @Nullable would be welcome here, as an indicator of null as a branching value?", "url": "https://github.com/elastic/elasticsearch/pull/66493#discussion_r545104000", "createdAt": "2020-12-17T13:50:26Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/SequenceMatcher.java", "diffHunk": "@@ -253,19 +253,15 @@ void until(Iterable<KeyAndOrdinal> markers) {\n      * This allows the matcher to keep only the last match per stage\n      * and adjust insertion positions.\n      */\n-    void trim(boolean everything) {\n+    void trim(Ordinal ordinal) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjM3MDM2", "url": "https://github.com/elastic/elasticsearch/pull/66493#pullrequestreview-554637036", "createdAt": "2020-12-17T14:09:48Z", "commit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU0NjYyMTUz", "url": "https://github.com/elastic/elasticsearch/pull/66493#pullrequestreview-554662153", "createdAt": "2020-12-17T14:36:13Z", "commit": {"oid": "5a633834c4b724ac7714ec76a33e87526d81b230"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4465, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}