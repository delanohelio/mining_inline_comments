{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI4MDEyNTYy", "number": 57692, "title": "Prohibit closing the write index for a data stream", "bodyText": "Relates to #53100", "createdAt": "2020-06-04T18:23:43Z", "url": "https://github.com/elastic/elasticsearch/pull/57692", "merged": true, "mergeCommit": {"oid": "c4334ee0746c6239bbc95c34a0f0f9a38560a21a"}, "closed": true, "closedAt": "2020-06-05T15:00:14Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcoCRy5AH2gAyNDI4MDEyNTYyOmY4NzRiMzRmNzg0MjgzMmM0NjgzOTkwNmY1ZDBlYWFhMmMwYmViNzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcoTXTRAH2gAyNDI4MDEyNTYyOjAxNTc0OTRlMDUyN2I3NDgyOTlmYWI5NGIwOTVmNDdjNWE2MjQ4N2M=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f874b34f7842832c46839906f5d0eaaa2c0beb76", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/f874b34f7842832c46839906f5d0eaaa2c0beb76", "committedDate": "2020-06-04T18:22:18Z", "message": "Prohibit closing the write index for a data stream"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c14629fd7e1c6c31c94247cc05c1a4ec3a7003b2", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c14629fd7e1c6c31c94247cc05c1a4ec3a7003b2", "committedDate": "2020-06-04T18:51:38Z", "message": "Merge branch 'master' into prohibit_closing_write_index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9a17fea1bd515545ad857cfef48ce4877d0bf4fa", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/9a17fea1bd515545ad857cfef48ce4877d0bf4fa", "committedDate": "2020-06-04T19:03:03Z", "message": "Merge branch 'master' into prohibit_closing_write_index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI1MDc4NjMw", "url": "https://github.com/elastic/elasticsearch/pull/57692#pullrequestreview-425078630", "createdAt": "2020-06-05T07:58:48Z", "commit": {"oid": "9a17fea1bd515545ad857cfef48ce4877d0bf4fa"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1ODo0OFrOGfkRSw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wNVQwNzo1ODo0OFrOGfkRSw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNTc1MzI5MQ==", "bodyText": "I think we should change this to:\nia.getParentDataStream().getWriteIndex().getIndex().equals(index))\n\nThe index uuid should be the same.", "url": "https://github.com/elastic/elasticsearch/pull/57692#discussion_r435753291", "createdAt": "2020-06-05T07:58:48Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataIndexStateService.java", "diffHunk": "@@ -137,6 +138,19 @@ public void closeIndices(final CloseIndexClusterStateUpdateRequest request, fina\n         if (concreteIndices == null || concreteIndices.length == 0) {\n             throw new IllegalArgumentException(\"Index name is required\");\n         }\n+        List<String> writeIndices = new ArrayList<>();\n+        SortedMap<String, IndexAbstraction> lookup = clusterService.state().metadata().getIndicesLookup();\n+        for (Index index : concreteIndices) {\n+            IndexAbstraction ia = lookup.get(index.getName());\n+            if (ia != null && ia.getParentDataStream() != null &&\n+                ia.getParentDataStream().getWriteIndex().getIndex().getName().equals(index.getName())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9a17fea1bd515545ad857cfef48ce4877d0bf4fa"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b346a73647bea2d1005d7a985e938a4c610a6e1f", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/b346a73647bea2d1005d7a985e938a4c610a6e1f", "committedDate": "2020-06-05T13:44:56Z", "message": "check for index equality"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0157494e0527b748299fab94b095f47c5a62487c", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/0157494e0527b748299fab94b095f47c5a62487c", "committedDate": "2020-06-05T14:16:42Z", "message": "fix unit test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3906, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}