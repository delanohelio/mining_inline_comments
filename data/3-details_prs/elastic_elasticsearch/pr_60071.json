{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU1MjUyNDA4", "number": 60071, "title": "Replace immediate task creations by using task avoidance api", "bodyText": "One step closer to #56610\nOnly RestIntegTest related tasks and setups are mostly still done eagerly due to limitations in the Task setup\nStill many tasks are created during configuration phase. Tackled in separate steps\n\nBefore: https://gradle-enterprise.elastic.co/s/xmigyzlj4i2bg/performance/configuration#summary-task-created-immediately\nAfter: https://gradle-enterprise.elastic.co/s/kuwh2hpkkzof6/performance/configuration#summary-task-created-immediately", "createdAt": "2020-07-22T17:21:34Z", "url": "https://github.com/elastic/elasticsearch/pull/60071", "merged": true, "mergeCommit": {"oid": "a72760e55befd53c4be049712a8cca9690a34bc2"}, "closed": true, "closedAt": "2020-07-31T09:29:15Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc4-OkUABqjM1ODg5MTExOTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc6PjnXAH2gAyNDU1MjUyNDA4OjViYjNlY2I4Y2FmNThjYmM0MjM0MDNjOTRhY2UzYzQ4NjA4ZGYxMWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "472175160a18ca3ea2d185cc8a51549357851836", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/472175160a18ca3ea2d185cc8a51549357851836", "committedDate": "2020-07-27T07:54:55Z", "message": "Revert Antfixture handling in discovery-ec2"}, "afterCommit": {"oid": "6ff3ee43aa1e13eb5fe2196ff1bbe01826b7f06a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/6ff3ee43aa1e13eb5fe2196ff1bbe01826b7f06a", "committedDate": "2020-07-27T09:12:12Z", "message": "Revert Antfixture handling in discovery-ec2"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU4NTIzNDM3", "url": "https://github.com/elastic/elasticsearch/pull/60071#pullrequestreview-458523437", "createdAt": "2020-07-30T15:39:00Z", "commit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "state": "APPROVED", "comments": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTozOTowMFrOG5or6g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0zMFQxNTo1NDozMlrOG5pWIg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODYxOA==", "bodyText": "TaskProvider", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463088618", "createdAt": "2020-07-30T15:39:00Z", "author": {"login": "mark-vieira"}, "path": "plugins/discovery-azure-classic/build.gradle", "diffHunk": "@@ -72,7 +72,7 @@ String host = InetAddress.getLoopbackAddress().getHostAddress()\n File keystore = new File(project.buildDir, 'keystore/test-node.jks')\n \n // generate the keystore\n-task createKey(type: LoggedExec) {\n+def createKey = tasks.register(\"createKey\", LoggedExec) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4ODk2Ng==", "bodyText": "Should this also be tasks.named(\"test\").configure {?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463088966", "createdAt": "2020-07-30T15:39:32Z", "author": {"login": "mark-vieira"}, "path": "plugins/discovery-ec2/build.gradle", "diffHunk": "@@ -98,7 +98,7 @@ task writeTestJavaPolicy {\n }\n \n test {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA4OTc2Ng==", "bodyText": "Why was this dependency changed?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463089766", "createdAt": "2020-07-30T15:40:35Z", "author": {"login": "mark-vieira"}, "path": "plugins/discovery-gce/qa/gce/build.gradle", "diffHunk": "@@ -39,8 +39,8 @@ restResources {\n }\n \n /** A task to start the GCEFixture which emulates a GCE service **/\n-task gceFixture(type: AntFixture) {\n-  dependsOn project.sourceSets.yamlRestTest.runtimeClasspath\n+tasks.register(\"gceFixture\", AntFixture) {\n+  dependsOn \"compileTestJava\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 7}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDUwOA==", "bodyText": "TaskProvider", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463090508", "createdAt": "2020-07-30T15:41:37Z", "author": {"login": "mark-vieira"}, "path": "qa/full-cluster-restart/build.gradle", "diffHunk": "@@ -77,7 +77,7 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MDgxMg==", "bodyText": "TaskProvider", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463090812", "createdAt": "2020-07-30T15:42:04Z", "author": {"login": "mark-vieira"}, "path": "qa/repository-multi-version/build.gradle", "diffHunk": "@@ -92,7 +92,7 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MTYxMw==", "bodyText": "Can we ditch the .class here?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463091613", "createdAt": "2020-07-30T15:43:12Z", "author": {"login": "mark-vieira"}, "path": "x-pack/build.gradle", "diffHunk": "@@ -31,7 +31,7 @@ subprojects {\n     project.esplugin.noticeFile = xpackRootProject.file('NOTICE.txt')\n   }\n \n-  tasks.withType(LicenseHeadersTask.class) {\n+  tasks.withType(LicenseHeadersTask.class).configureEach {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5MjE0MQ==", "bodyText": "Is this necessary? Shouldn't this be inferred from the copyspec below?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463092141", "createdAt": "2020-07-30T15:44:02Z", "author": {"login": "mark-vieira"}, "path": "x-pack/license-tools/build.gradle", "diffHunk": "@@ -12,7 +12,8 @@ project.forbiddenPatterns {\n \n tasks.named(\"dependencyLicenses\").configure { it.enabled = false }\n \n-task buildZip(type: Zip, dependsOn: jar) {\n+tasks.register(\"buildZip\", Zip) {\n+  dependsOn \"jar\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NjU3Nw==", "bodyText": "should we also do tasks.named(\"testJar\")?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463096577", "createdAt": "2020-07-30T15:50:25Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/ml/build.gradle", "diffHunk": "@@ -69,17 +69,18 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n+\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5NzQzMQ==", "bodyText": "Since lazy task configuration technically defers this until task graph calculation time, could we safely remove the afterEvaluate here?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463097431", "createdAt": "2020-07-30T15:51:40Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/ml/build.gradle", "diffHunk": "@@ -89,23 +90,28 @@ task extractNativeLicenses(type: Copy) {\n }\n project.afterEvaluate {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQxMg==", "bodyText": "Same as above, shouldn't we use a task provider for testJar as well?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098412", "createdAt": "2020-07-30T15:53:00Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/monitoring/build.gradle", "diffHunk": "@@ -28,13 +28,13 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODQ5Nw==", "bodyText": "Taskprovider for testJar?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098497", "createdAt": "2020-07-30T15:53:09Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/ql/build.gradle", "diffHunk": "@@ -21,17 +21,18 @@ configurations {\n   testArtifacts.extendsFrom testImplementation\n }\n \n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n \n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5ODcxMQ==", "bodyText": "Taskprovider for testJar?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463098711", "createdAt": "2020-07-30T15:53:27Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/security/build.gradle", "diffHunk": "@@ -143,13 +143,13 @@ configurations {\n   testArtifacts.extendsFrom testRuntime\n   testArtifacts.extendsFrom testImplementation\n }\n-task testJar(type: Jar) {\n+def testJar = tasks.register(\"testJar\", Jar) {\n   appendix 'test'\n   from sourceSets.test.output\n }\n artifacts {\n   // normal es plugins do not publish the jar but we need to since users need it for extensions\n-  archives jar\n+  archives tasks.named(\"jar\")\n   testArtifacts testJar", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MzA5OTQyNg==", "bodyText": "Should we defer the creation of processTestResources here?", "url": "https://github.com/elastic/elasticsearch/pull/60071#discussion_r463099426", "createdAt": "2020-07-30T15:54:32Z", "author": {"login": "mark-vieira"}, "path": "x-pack/plugin/transform/qa/multi-node-tests/build.gradle", "diffHunk": "@@ -13,17 +13,17 @@ File keystoreDir = new File(project.buildDir, 'keystore')\n File nodeKey = file(\"$keystoreDir/testnode.pem\")\n File nodeCert = file(\"$keystoreDir/testnode.crt\")\n // Add key and certs to test classpath: it expects it there\n-task copyKeyCerts(type: Copy) {\n+tasks.register(\"copyKeyCerts\", Copy) {\n   from(project(':x-pack:plugin:core').file('src/test/resources/org/elasticsearch/xpack/security/transport/ssl/certs/simple/')) {\n     include 'testnode.crt', 'testnode.pem'\n   }\n   into keystoreDir\n }\n // Add keys and cets to test classpath: it expects it there\n sourceSets.test.resources.srcDir(keystoreDir)\n-processTestResources.dependsOn(copyKeyCerts)\n+processTestResources.dependsOn(\"copyKeyCerts\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972"}, "originalPosition": 14}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d4af4a33e53437a73a93046d7ad52adae64f1052", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4af4a33e53437a73a93046d7ad52adae64f1052", "committedDate": "2020-07-30T19:58:34Z", "message": "Replace immediate task creations by using task avoidance api\n\n- One step closer to #56610\n- Still many tasks are created during configuration phase. Tackled in separate steps"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "8517df7ca62489657abe4aea4059a5b5dfb8b972", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/8517df7ca62489657abe4aea4059a5b5dfb8b972", "committedDate": "2020-07-30T11:32:03Z", "message": "Merge branch 'master' into replace-immediate-task-creation"}, "afterCommit": {"oid": "d4af4a33e53437a73a93046d7ad52adae64f1052", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d4af4a33e53437a73a93046d7ad52adae64f1052", "committedDate": "2020-07-30T19:58:34Z", "message": "Replace immediate task creations by using task avoidance api\n\n- One step closer to #56610\n- Still many tasks are created during configuration phase. Tackled in separate steps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5bb3ecb8caf58cbc423403c94ace3c48608df11d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/5bb3ecb8caf58cbc423403c94ace3c48608df11d", "committedDate": "2020-07-31T08:01:10Z", "message": "Apply review feedback and polishing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4061, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}