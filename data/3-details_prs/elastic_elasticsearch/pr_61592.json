{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0MDAxNjA5", "number": 61592, "title": "Avoid packaging / unpacking cycle when using local current distributions", "bodyText": "When test cluster or local distribution setups (e.g. :run or :localDistro) rely on local build distributions we have the overhead of packing and unpacking the distribution archive tars or zips. This PR removes this overhead by registering a directory backed variant of a distribution per distribution type.\nWe introduce a simple DSL for declaring distribution_archives that is used as base for the archive tasks creating zips and tars AND for the explodedDist tasks that only do a simple copy.\nAlong the way common configurations in distribution/archives have been moved into an internal plugin to\n\nimprove test coverage for common configurations\nRemoves build script cluttering\n\nHere are Comparing timelines before and after this change:\n\nbefore: https://gradle-enterprise.elastic.co/s/3b64ptmp4zugg/timeline\nafter: https://gradle-enterprise.elastic.co/s/ezwhjyrl3dnfw/timeline\n\nBenchmarking this change on OSX (relying on ./gradlew :localDistro with a non ABI change in :server) we get an average improvement of 18.5s:", "createdAt": "2020-08-26T15:54:58Z", "url": "https://github.com/elastic/elasticsearch/pull/61592", "merged": true, "mergeCommit": {"oid": "7e5936d58ce0da5284fe95478b7ec4efe89e2180"}, "closed": true, "closedAt": "2020-09-09T12:44:27Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE-loagBqjM3MjA3MDcxNjk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdHIKr2gH2gAyNDc0MDAxNjA5OmMwYWViZjhmMGNkNTllNmZkMGVkYmE5MGQwZDdkNjEzMTdlZTNkOTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "eaa99bfa48a96dd0f4cedde04d012a025fb319e4", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/eaa99bfa48a96dd0f4cedde04d012a025fb319e4", "committedDate": "2020-08-26T15:54:29Z", "message": "Extract distribution archives defaults into plugin\n\nExtracting more stuff from the distribution/archives scripts into a testable plugin\n\n- Added basic test coverage"}, "afterCommit": {"oid": "7b6e5704768ed8282d458230a00ef8940d5156e2", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b6e5704768ed8282d458230a00ef8940d5156e2", "committedDate": "2020-09-02T16:27:41Z", "message": "Setup local distributions faster\n\n- avoid packaging/unpackaging cycle when relying on locally build distributions\n- Move more logic into distribution/archives"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgxNjkxMTcx", "url": "https://github.com/elastic/elasticsearch/pull/61592#pullrequestreview-481691171", "createdAt": "2020-09-03T10:06:30Z", "commit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDowNjozMFrOHMfo-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wM1QxMDowNjozMFrOHMfo-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mjg2MzM1NA==", "bodyText": "didn't find any use of this one", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r482863354", "createdAt": "2020-09-03T10:06:30Z", "author": {"login": "breskeby"}, "path": "distribution/docker/build.gradle", "diffHunk": "@@ -146,8 +155,6 @@ void addCopyDockerContextTask(Architecture architecture, boolean oss, DockerBase\n         from configurations.dockerSource\n       }\n     }\n-\n-    from configurations.dockerPlugins", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyOTkwNDQz", "url": "https://github.com/elastic/elasticsearch/pull/61592#pullrequestreview-482990443", "createdAt": "2020-09-04T22:12:13Z", "commit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "state": "APPROVED", "comments": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMjoxMjoxM1rOHNcvbQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQyMjo1Mzo0MlrOHNdR4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDQyOQ==", "bodyText": "Do we really need this interface? Could we not just use Supplier<CopySpec>?", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483864429", "createdAt": "2020-09-04T22:12:13Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/DistributionArchive.java", "diffHunk": "@@ -0,0 +1,65 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.gradle.api.Named;\n+import org.gradle.api.file.CopySpec;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+\n+public class DistributionArchive implements Named {\n+\n+    private TaskProvider<? extends AbstractArchiveTask> archiveTask;\n+    private TaskProvider<Copy> explodedDistTask;\n+    private final String name;\n+\n+    public DistributionArchive(TaskProvider<? extends AbstractArchiveTask> archiveTask, TaskProvider<Copy> explodedDistTask, String name) {\n+        this.archiveTask = archiveTask;\n+        this.explodedDistTask = explodedDistTask;\n+        this.name = name;\n+    }\n+\n+    public void setArchiveClassifier(String classifier) {\n+        this.archiveTask.configure(abstractArchiveTask -> abstractArchiveTask.getArchiveClassifier().set(classifier));\n+    }\n+\n+    public void content(ContentProvider p) {\n+        this.archiveTask.configure(t -> { t.with(p.provide()); });\n+        this.explodedDistTask.configure(t -> { t.with(p.provide()); });\n+    }\n+\n+    @Override\n+    public String getName() {\n+        return name;\n+    }\n+\n+    public TaskProvider<? extends AbstractArchiveTask> getArchiveTask() {\n+        return archiveTask;\n+    }\n+\n+    public TaskProvider<Copy> getExplodedArchiveTask() {\n+        return explodedDistTask;\n+    }\n+\n+    interface ContentProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 62}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NDc2Mg==", "bodyText": "Having per-distribution sub-projects means we can build them in parallel.", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483864762", "createdAt": "2020-09-04T22:13:51Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg2NTI1Mg==", "bodyText": "I would love for us to either a) make a proper DSL from this or b) use named parameters when calling this method rather than have foo(true, false, null, false) all over the place which is a poor description of what is happening.", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483865252", "createdAt": "2020-09-04T22:15:50Z", "author": {"login": "mark-vieira"}, "path": "distribution/archives/build.gradle", "diffHunk": "@@ -17,39 +17,11 @@\n  * under the License.\n  */\n \n-import org.elasticsearch.gradle.BuildPlugin\n-import org.elasticsearch.gradle.EmptyDirTask\n-import org.elasticsearch.gradle.LoggedExec\n import org.elasticsearch.gradle.MavenFilteringHack\n-import org.elasticsearch.gradle.VersionProperties\n-import org.elasticsearch.gradle.info.BuildParams\n-import org.elasticsearch.gradle.plugin.PluginBuildPlugin\n-import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar\n-import groovy.io.FileType\n import java.nio.file.Files\n import java.nio.file.Path\n \n-// need this so Zip/Tar tasks get basic defaults...\n-apply plugin: 'base'\n-\n-// CopySpec does not make it easy to create an empty directory so we\n-// create the directory that we want, and then point CopySpec to its\n-// parent to copy to the root of the distribution\n-ext.logsDir = new File(buildDir, 'logs-hack/logs')\n-tasks.register('createLogsDir', EmptyDirTask) {\n-  dir = \"${logsDir}\"\n-  dirMode = 0755\n-}\n-ext.pluginsDir = new File(buildDir, 'plugins-hack/plugins')\n-tasks.register('createPluginsDir', EmptyDirTask) {\n-  dir = \"${pluginsDir}\"\n-  dirMode = 0755\n-}\n-ext.jvmOptionsDir = new File(buildDir, 'jvm-options-hack/jvm.options.d')\n-tasks.register('createJvmOptionsDir', EmptyDirTask) {\n-  dir = \"${jvmOptionsDir}\"\n-  dirMode = 0750\n-}\n+apply plugin: 'elasticsearch.internal-distribution-archive-setup'\n \n CopySpec archiveFiles(CopySpec modulesFiles, String distributionType, String platform, String architecture, boolean oss, boolean jdk) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 39}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MDM1MA==", "bodyText": "I'm not sure we need the \"build\" prefix convention here for container entries. The DSL is meant to describe a distribution, the the task that eventually constructs it. The latter is an implementation detail handled by the plugin. I think it makes more sense to create a darwinTar and then the plugin incidentally creates a buildDarwinTar task.", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483870350", "createdAt": "2020-09-04T22:39:12Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));\n+            });\n+        });\n+        project.getExtensions().add(\"distribution_archives\", container);\n+    }\n+\n+    private void configureGeneralTaskDefaults(Project project) {\n+        // common config across all copy / archive tasks\n+        project.getTasks().withType(AbstractCopyTask.class).configureEach(t -> {\n+            t.dependsOn(project.getTasks().withType(EmptyDirTask.class));\n+            t.setIncludeEmptyDirs(true);\n+            t.setDirMode(0755);\n+            t.setFileMode(0644);\n+        });\n+\n+        // common config across all archives\n+        project.getTasks().withType(AbstractArchiveTask.class).configureEach(t -> {\n+            String subdir = buildTaskToSubprojectName(t.getName());\n+            t.getDestinationDirectory().set(project.file(subdir + \"/build/distributions\"));\n+            t.getArchiveBaseName().set(subdir.contains(\"oss\") ? \"elasticsearch-oss\" : \"elasticsearch\");\n+        });\n+    }\n+\n+    private void configureTarDefaults(Project project) {\n+        // common config across all tars\n+        project.getTasks().withType(SymbolicLinkPreservingTar.class).configureEach(t -> {\n+            t.getArchiveExtension().set(\"tar.gz\");\n+            t.setCompression(Compression.GZIP);\n+        });\n+    }\n+\n+    private void registerEmptyDirectoryTasks(Project project) {\n+        // CopySpec does not make it easy to create an empty directory so we\n+        // create the directory that we want, and then point CopySpec to its\n+        // parent to copy to the root of the distribution\n+        File logsDir = new File(project.getBuildDir(), \"logs-hack/logs\");\n+        project.getExtensions().add(\"logsDir\", new File(project.getBuildDir(), \"logs-hack/logs\"));\n+        project.getTasks().register(\"createLogsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(logsDir);\n+            t.setDirMode(0755);\n+        });\n+\n+        File pluginsDir = new File(project.getBuildDir(), \"plugins-hack/plugins\");\n+        project.getExtensions().add(\"pluginsDir\", pluginsDir);\n+        project.getTasks().register(\"createPluginsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(pluginsDir);\n+            t.setDirMode(0755);\n+        });\n+\n+        File jvmOptionsDir = new File(project.getBuildDir(), \"jvm-options-hack/jvm.options.d\");\n+        project.getExtensions().add(\"jvmOptionsDir\", jvmOptionsDir);\n+        project.getTasks().register(\"createJvmOptionsDir\", EmptyDirTask.class, t -> {\n+            t.setDir(jvmOptionsDir);\n+            t.setDirMode(0750);\n+        });\n+    }\n+\n+    private String buildTaskToSubprojectName(String taskName) {\n+        return taskName.substring(\"build\".length()).replaceAll(\"[A-Z]\", \"-$0\").toLowerCase().substring(1);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 149}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTExMQ==", "bodyText": "Is there no public API to accomplish this?", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483871111", "createdAt": "2020-09-04T22:42:46Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 91}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MTYzNw==", "bodyText": "Shouldn't these be extra properties instead of extensions? I assume there's not too much difference but extensions end up get decorated by Gradle at runtime which we probably don't need in this case.", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483871637", "createdAt": "2020-09-04T22:45:28Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/internal/InternalDistributionArchiveSetupPlugin.java", "diffHunk": "@@ -0,0 +1,196 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.gradle.internal;\n+\n+import org.elasticsearch.gradle.EmptyDirTask;\n+import org.elasticsearch.gradle.tar.SymbolicLinkPreservingTar;\n+import org.gradle.api.NamedDomainObjectContainer;\n+import org.gradle.api.Plugin;\n+import org.gradle.api.Project;\n+import org.gradle.api.artifacts.type.ArtifactTypeDefinition;\n+import org.gradle.api.internal.artifacts.ArtifactAttributes;\n+import org.gradle.api.internal.artifacts.ConfigurationVariantInternal;\n+import org.gradle.api.internal.artifacts.publish.AbstractPublishArtifact;\n+import org.gradle.api.plugins.BasePlugin;\n+import org.gradle.api.tasks.AbstractCopyTask;\n+import org.gradle.api.tasks.Copy;\n+import org.gradle.api.tasks.TaskProvider;\n+import org.gradle.api.tasks.bundling.AbstractArchiveTask;\n+import org.gradle.api.tasks.bundling.Compression;\n+import org.gradle.api.tasks.bundling.Zip;\n+\n+import java.io.File;\n+import java.util.Collections;\n+import java.util.Date;\n+\n+/**\n+ * Provides a DSL and common configurations to define different types of\n+ * Elasticsearch distribution archives. See ':distribution:archives'.\n+ *\n+ * This configures the default artifacts for the distribution specific\n+ * subprojects. We have subprojects for two reasons:\n+ * 1. Gradle project substitutions can only bind to the default\n+ *    configuration of a project\n+ * 2. The integ-test-zip and zip distributions have the exact same\n+ *    filename, so they must be placed in different directories.\n+ * 3. We provide a packed and an unpacked variant of the distribution\n+ *    - the unpacked variant is used by consumers like test cluster definitions\n+ */\n+public class InternalDistributionArchiveSetupPlugin implements Plugin<Project> {\n+\n+    private NamedDomainObjectContainer<DistributionArchive> container;\n+\n+    @Override\n+    public void apply(Project project) {\n+        project.getPlugins().apply(BasePlugin.class);\n+        registerAndConfigureDistributionArchivesExtension(project);\n+        registerEmptyDirectoryTasks(project);\n+        configureGeneralTaskDefaults(project);\n+        configureTarDefaults(project);\n+    }\n+\n+    private void registerAndConfigureDistributionArchivesExtension(Project project) {\n+        container = project.container(DistributionArchive.class, name -> {\n+            var subProjectDir = buildTaskToSubprojectName(name);\n+            var copyDistributionTaskName = name.substring(0, name.length() - 3);\n+            var explodedDist = project.getTasks()\n+                .register(copyDistributionTaskName, Copy.class, copy -> copy.into(subProjectDir + \"/build/install/\"));\n+            return name.endsWith(\"Tar\")\n+                ? new DistributionArchive(project.getTasks().register(name, SymbolicLinkPreservingTar.class), explodedDist, name)\n+                : new DistributionArchive(project.getTasks().register(name, Zip.class), explodedDist, name);\n+        });\n+        // Each defined distribution archive is linked to a subproject.\n+        // A distribution archive definition not matching a sub project will result in build failure.\n+        container.whenObjectAdded(distributionArchive -> {\n+            var subProjectName = buildTaskToSubprojectName(distributionArchive.getArchiveTask().getName());\n+            project.project(subProjectName, sub -> {\n+                sub.getPlugins().apply(\"base\");\n+                sub.getArtifacts().add(\"default\", distributionArchive.getArchiveTask());\n+                var explodedArchiveTask = distributionArchive.getExplodedArchiveTask();\n+                var defaultConfiguration = sub.getConfigurations().getByName(\"default\");\n+                var publications = defaultConfiguration.getOutgoing();\n+                var variant = (ConfigurationVariantInternal) publications.getVariants().maybeCreate(\"directory\");\n+                variant.getAttributes().attribute(ArtifactAttributes.ARTIFACT_FORMAT, ArtifactTypeDefinition.DIRECTORY_TYPE);\n+                variant.artifactsProvider(() -> Collections.singletonList(new DirectoryPublishArtifact(explodedArchiveTask)));\n+            });\n+        });\n+        project.getExtensions().add(\"distribution_archives\", container);\n+    }\n+\n+    private void configureGeneralTaskDefaults(Project project) {\n+        // common config across all copy / archive tasks\n+        project.getTasks().withType(AbstractCopyTask.class).configureEach(t -> {\n+            t.dependsOn(project.getTasks().withType(EmptyDirTask.class));\n+            t.setIncludeEmptyDirs(true);\n+            t.setDirMode(0755);\n+            t.setFileMode(0644);\n+        });\n+\n+        // common config across all archives\n+        project.getTasks().withType(AbstractArchiveTask.class).configureEach(t -> {\n+            String subdir = buildTaskToSubprojectName(t.getName());\n+            t.getDestinationDirectory().set(project.file(subdir + \"/build/distributions\"));\n+            t.getArchiveBaseName().set(subdir.contains(\"oss\") ? \"elasticsearch-oss\" : \"elasticsearch\");\n+        });\n+    }\n+\n+    private void configureTarDefaults(Project project) {\n+        // common config across all tars\n+        project.getTasks().withType(SymbolicLinkPreservingTar.class).configureEach(t -> {\n+            t.getArchiveExtension().set(\"tar.gz\");\n+            t.setCompression(Compression.GZIP);\n+        });\n+    }\n+\n+    private void registerEmptyDirectoryTasks(Project project) {\n+        // CopySpec does not make it easy to create an empty directory so we\n+        // create the directory that we want, and then point CopySpec to its\n+        // parent to copy to the root of the distribution\n+        File logsDir = new File(project.getBuildDir(), \"logs-hack/logs\");\n+        project.getExtensions().add(\"logsDir\", new File(project.getBuildDir(), \"logs-hack/logs\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 127}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MjM2Mw==", "bodyText": "I think this should be resolveArchiveFormat.", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483872363", "createdAt": "2020-09-04T22:49:15Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -124,13 +124,22 @@ void setupDistributions(Project project) {\n             dependencies.add(distribution.configuration.getName(), resolvedDependency);\n             // no extraction allowed for rpm, deb or docker\n             if (distribution.getType().shouldExtract()) {\n+                distribution.configuration.getAttributes()\n+                    .attribute(ArtifactAttributes.ARTIFACT_FORMAT, resolveArtifactFormat(distribution));\n                 // The extracted configuration depends on the artifact directly but has\n                 // an artifact transform registered to resolve it as an unpacked folder.\n                 dependencies.add(distribution.getExtracted().getName(), resolvedDependency);\n             }\n         }\n     }\n \n+    private String resolveArtifactFormat(ElasticsearchDistribution distribution) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzg3MzI0OQ==", "bodyText": "Is this strictly required? If we don't add any attributes shouldn't it default to to a particular variant? If not, any way we can avoid having to explicitly determine the archive type here and use something generic for both zip and tar?", "url": "https://github.com/elastic/elasticsearch/pull/61592#discussion_r483873249", "createdAt": "2020-09-04T22:53:42Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/DistributionDownloadPlugin.java", "diffHunk": "@@ -124,13 +124,22 @@ void setupDistributions(Project project) {\n             dependencies.add(distribution.configuration.getName(), resolvedDependency);\n             // no extraction allowed for rpm, deb or docker\n             if (distribution.getType().shouldExtract()) {\n+                distribution.configuration.getAttributes()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e76b07ef39845fadc683321d4dc5431aa72a3119"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bbab2765373ab822f0d93d8cdd735bed9657a73a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/bbab2765373ab822f0d93d8cdd735bed9657a73a", "committedDate": "2020-09-08T13:12:16Z", "message": "Extract distribution archives defaults into plugin\n\nExtracting more stuff from the distribution/archives scripts into a testable plugin\n\n- Added basic test coverage"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7d3390ec1f7b1b85d62ab784373d71fc8890f03a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d3390ec1f7b1b85d62ab784373d71fc8890f03a", "committedDate": "2020-09-08T13:12:16Z", "message": "Setup local distributions faster\n\n- avoid packaging/unpackaging cycle when relying on locally build distributions\n- Move more logic into distribution/archives"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c656c89615b0418c8d2289e53e6488e862095407", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/c656c89615b0418c8d2289e53e6488e862095407", "committedDate": "2020-09-08T13:12:16Z", "message": "Provide DSL for setting up distribution archives\n\n- provide directory variant per distribution archive"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cafe5b8624ad4c4dda9a688973209a0c9611b33b", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/cafe5b8624ad4c4dda9a688973209a0c9611b33b", "committedDate": "2020-09-08T13:12:16Z", "message": "Cleanup archives build script"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1ef9a89de7252c471cff7093562c791a06e264d9", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/1ef9a89de7252c471cff7093562c791a06e264d9", "committedDate": "2020-09-08T13:12:17Z", "message": "Fix consuming dependencies to distribution archives\n\n- polishing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c372dd700281debaaf7eaff19b963f108b8d8b", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3c372dd700281debaaf7eaff19b963f108b8d8b", "committedDate": "2020-09-08T13:12:17Z", "message": "Do not resolve dependencies in toString"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "747fecb0876d0823bb6b8c8cb19affd9a176737a", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/747fecb0876d0823bb6b8c8cb19affd9a176737a", "committedDate": "2020-09-08T13:12:17Z", "message": "Do not rely on toString to resolve file path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "66d893eaa44100800392751253ddf82831ec72c0", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/66d893eaa44100800392751253ddf82831ec72c0", "committedDate": "2020-09-08T13:12:17Z", "message": "Explicitly set dist config artifact format"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56d3599a19b04bd586b0c6dfa3478ee76d875f62", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/56d3599a19b04bd586b0c6dfa3478ee76d875f62", "committedDate": "2020-09-08T13:12:17Z", "message": "Only declare explicit artifact format for extractable distributions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "51fe969d01e9a639eed112f10bf493ba9d6d181f", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/51fe969d01e9a639eed112f10bf493ba9d6d181f", "committedDate": "2020-09-08T13:12:17Z", "message": "Do not rely on toString in DistroPlugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2f31e06a5c866f03aea03528b66de869ab8eba25", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2f31e06a5c866f03aea03528b66de869ab8eba25", "committedDate": "2020-09-08T13:12:18Z", "message": "Apply review feedback\n\n- expose explodedDist in separate configuration\n- redo namings\n- minor renamings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ebe4c020cb1d5082695b3e037adc4dc1707f49e1", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/ebe4c020cb1d5082695b3e037adc4dc1707f49e1", "committedDate": "2020-09-08T13:12:18Z", "message": "Fix docker sources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "370b8108265dd1f263e23ab91f192981ea2bffd9", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/370b8108265dd1f263e23ab91f192981ea2bffd9", "committedDate": "2020-09-08T13:12:18Z", "message": "Fix imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "45380869a84b81807414d7880b94b3ca073c75ab", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/45380869a84b81807414d7880b94b3ca073c75ab", "committedDate": "2020-09-08T13:12:18Z", "message": "Explicitly request default configuratino for docker sources"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7bbd5e6f50ffb6fc705ea736fb03f2f60cf06c71", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7bbd5e6f50ffb6fc705ea736fb03f2f60cf06c71", "committedDate": "2020-09-08T13:04:16Z", "message": "Explicitly request default configuratino for docker sources"}, "afterCommit": {"oid": "45380869a84b81807414d7880b94b3ca073c75ab", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/45380869a84b81807414d7880b94b3ca073c75ab", "committedDate": "2020-09-08T13:12:18Z", "message": "Explicitly request default configuratino for docker sources"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2625ed720a806f7b7bae1fa4e00fe1ada09830cb", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/2625ed720a806f7b7bae1fa4e00fe1ada09830cb", "committedDate": "2020-09-09T08:39:07Z", "message": "Fix resolveAllDependencies\n\nwhen relying on variants and artifacts we must make the requested configuration explicit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c0aebf8f0cd59e6fd0edba90d0d7d61317ee3d93", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/c0aebf8f0cd59e6fd0edba90d0d7d61317ee3d93", "committedDate": "2020-09-09T08:45:37Z", "message": "Minor polishing"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4581, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}