{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0MDUyMjU1", "number": 54255, "title": "Do not fail Evaluate API when the actual and predicted fields' types differ", "bodyText": "Currently, Evaluate API fails when the user uses actual and predicted fields of different types (e.g. long vs boolean) as for some metrics (accuracy, precision) term aggregation tries to parse one type as another.\nThis PR replaces term aggregation with match + lenient: true. This way the Evaluate API does not fail but returns no matches (just as if the sets of actual and predicted classes were disjoint).\nAdditionally, I've took a chance and added a number of new test cases to ClassificationEvaluationIT to increase coverage in case of various actual vs predicted types combinations.\nCloses #54079", "createdAt": "2020-03-26T09:29:37Z", "url": "https://github.com/elastic/elasticsearch/pull/54255", "merged": true, "mergeCommit": {"oid": "f9ab47fbcf6ca439b443d3851a7a7b75305ce49b"}, "closed": true, "closedAt": "2020-03-27T07:36:42Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcRY0EDgH2gAyMzk0MDUyMjU1OmE4NTNlODI5YjI5YmNlM2RhYmMyNWU0NjczYjVkOWY0NzdiYjM0OGE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRd7m8gFqTM4MjEzMjEzMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a853e829b29bce3dabc25e4673b5d9f477bb348a", "committedDate": "2020-03-26T09:37:23Z", "message": "Do not fail Evaluate API when the actual and predicted fields' types differ"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "c64a809409cbe594653f051e2db6b8aff1a0e017", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/c64a809409cbe594653f051e2db6b8aff1a0e017", "committedDate": "2020-03-26T09:26:03Z", "message": "Do not fail Evaluate API when the actual and predicted fields' types differ"}, "afterCommit": {"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/a853e829b29bce3dabc25e4673b5d9f477bb348a", "committedDate": "2020-03-26T09:37:23Z", "message": "Do not fail Evaluate API when the actual and predicted fields' types differ"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTE5OTUw", "url": "https://github.com/elastic/elasticsearch/pull/54255#pullrequestreview-381919950", "createdAt": "2020-03-26T11:30:14Z", "commit": {"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMTozMDoxNFrOF8Ck5g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMTozMDoxNFrOF8Ck5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODUwMTA5NA==", "bodyText": "This will analyze the input string. Which might be ok, but it will mean if we have classNames Foo and foo we will treat them as the same.\nWhich, having two classes only differ by case is pathological and probably SHOULD result in error :)", "url": "https://github.com/elastic/elasticsearch/pull/54255#discussion_r398501094", "createdAt": "2020-03-26T11:30:14Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/dataframe/evaluation/classification/MulticlassConfusionMatrix.java", "diffHunk": "@@ -142,7 +142,7 @@ public int getSize() {\n         if (result.get() == null) {  // These are steps 2, 3, 4 etc.\n             KeyedFilter[] keyedFiltersPredicted =\n                 topActualClassNames.get().stream()\n-                    .map(className -> new KeyedFilter(className, QueryBuilders.termQuery(predictedField, className)))\n+                    .map(className -> new KeyedFilter(className, QueryBuilders.matchQuery(predictedField, className).lenient(true)))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a853e829b29bce3dabc25e4673b5d9f477bb348a"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e5fa51e75a119b8b265319088343bd72a9a04d80", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/e5fa51e75a119b8b265319088343bd72a9a04d80", "committedDate": "2020-03-26T14:44:22Z", "message": "Add a test for case sensivity in case of keyword fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyMTMyMTMy", "url": "https://github.com/elastic/elasticsearch/pull/54255#pullrequestreview-382132132", "createdAt": "2020-03-26T15:35:09Z", "commit": {"oid": "e5fa51e75a119b8b265319088343bd72a9a04d80"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1606, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}