{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4MjIwNjcz", "number": 51568, "title": "SQL: Verify Full-Text Search functions not allowed in SELECT", "bodyText": "Add a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\nFixes: #47446", "createdAt": "2020-01-28T20:44:44Z", "url": "https://github.com/elastic/elasticsearch/pull/51568", "merged": true, "mergeCommit": {"oid": "65ad2699c63fdf9509de3e4ec894037d369ea179"}, "closed": true, "closedAt": "2020-01-30T11:22:04Z", "author": {"login": "matriv"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-3oAzgH2gAyMzY4MjIwNjczOmMxYWJiNjZjMDAyYjlmNWRjZDU4YmE5M2RiOTY5OWQyYjZmODAwYzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_XZy6gH2gAyMzY4MjIwNjczOmRmMDU4MjE0NTFiMWQwOGQyYWZkZGRjNzczZWRlNTJjZDUxYTc0YWI=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "committedDate": "2020-01-28T20:46:43Z", "message": "SQL: Verify Full-Text Search functions not allowed in SELECT\n\nAdd a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\n\nFixes: #47446"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "7d834694303e5b79d51d89042bba7f3bf6a686e0", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7d834694303e5b79d51d89042bba7f3bf6a686e0", "committedDate": "2020-01-28T20:39:14Z", "message": "SQL: Verify Full-Text Search functions not allowed in SELECT\n\nAdd a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\n\nFixes: #47446"}, "afterCommit": {"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/c1abb66c002b9f5dcd58ba93db9699d2b6f800c6", "committedDate": "2020-01-28T20:46:43Z", "message": "SQL: Verify Full-Text Search functions not allowed in SELECT\n\nAdd a verification that full-text search functions are not\nallowed in the SELECT clause, so that a nice error message is\nreturned to the user early instead of an \"ugly\" exception.\n\nFixes: #47446"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df4c9b3ce2272d542c1ae3d74d67cf98eda96584", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/df4c9b3ce2272d542c1ae3d74d67cf98eda96584", "committedDate": "2020-01-28T22:15:50Z", "message": "Fix validation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ5NzQzMzkx", "url": "https://github.com/elastic/elasticsearch/pull/51568#pullrequestreview-349743391", "createdAt": "2020-01-28T22:15:16Z", "commit": {"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjoxNToxN1rOFi2hSg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOFQyMjoxNToxN1rOFi2hSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjA4OTE2Mg==", "bodyText": "The error message I think has several issues: why the capital letters for Full-Text, and why the plural functions?Also, if you look at our docs - https://www.elastic.co/guide/en/elasticsearch/reference/7.x/sql-functions-search.html - full-text search functions include SCORE() as well, but Score is not an instanceof FullTextPredicate so it wouldn't match this condition.\nSo, try to adjust the error message not to partially conflict with the documentation.", "url": "https://github.com/elastic/elasticsearch/pull/51568#discussion_r372089162", "createdAt": "2020-01-28T22:15:17Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -215,8 +216,16 @@ private static Failure fail(Node<?> source, String message, Object... args) {\n         // if there are no (major) unresolved failures, do more in-depth analysis\n \n         if (failures.isEmpty()) {\n+            Set<Failure> localFailures = new LinkedHashSet<>();\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n+            // Full-Text search function are not allowed in the SELECT clause\n+            plan.forEachUp(p -> p.forEachExpressionsUp(e -> {\n+                if (e instanceof FullTextPredicate) {\n+                    localFailures.add(fail(e, \"Cannot use a Full-Text search functions in the SELECT clause\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c1abb66c002b9f5dcd58ba93db9699d2b6f800c6"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7", "committedDate": "2020-01-29T11:04:30Z", "message": "Address comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDM0NzI3", "url": "https://github.com/elastic/elasticsearch/pull/51568#pullrequestreview-350034727", "createdAt": "2020-01-29T11:24:34Z", "commit": {"oid": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwNDQzOTQ1", "url": "https://github.com/elastic/elasticsearch/pull/51568#pullrequestreview-350443945", "createdAt": "2020-01-29T21:41:12Z", "commit": {"oid": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0MToxM1rOFjYfRA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQyMTo0MToxM1rOFjYfRA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjY0NTcwMA==", "bodyText": "Despite being a small snippet, can you please extract it into its own static method - it's easier to reason about its purpose before looking at its details?\nThanks.", "url": "https://github.com/elastic/elasticsearch/pull/51568#discussion_r372645700", "createdAt": "2020-01-29T21:41:13Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/analysis/analyzer/Verifier.java", "diffHunk": "@@ -215,8 +216,19 @@ private static Failure fail(Node<?> source, String message, Object... args) {\n         // if there are no (major) unresolved failures, do more in-depth analysis\n \n         if (failures.isEmpty()) {\n+            Set<Failure> localFailures = new LinkedHashSet<>();\n             final Map<Attribute, Expression> collectRefs = new LinkedHashMap<>();\n \n+            // Full-Text search function are not allowed in the SELECT clause\n+            plan.forEachUp(p -> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "18e0f9ef0c2f70dc7959c1c76c2150b79b174cc7"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "df05821451b1d08d2afdddc773ede52cd51a74ab", "author": {"user": {"login": "matriv", "name": "Marios Trivyzas"}}, "url": "https://github.com/elastic/elasticsearch/commit/df05821451b1d08d2afdddc773ede52cd51a74ab", "committedDate": "2020-01-30T09:48:09Z", "message": "extract method"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3201, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}