{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA4MDk1OTQx", "number": 55688, "title": "Fix (de)serialization of async search failures", "bodyText": "The (de)serialization code of the async search response cannot handle exceptions that extend ElasticsearchException (e.g. ScriptException).\nThis commit fixes this bug by serializing the error with the more generic\nStreamInput#writeException.\nThis change also adds the fetch failures that were missing in the response", "createdAt": "2020-04-23T18:17:33Z", "url": "https://github.com/elastic/elasticsearch/pull/55688", "merged": true, "mergeCommit": {"oid": "f07059059d8d920216f2b57be79183c423ba0309"}, "closed": true, "closedAt": "2020-04-23T21:00:35Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcahBe6AH2gAyNDA4MDk1OTQxOmQ2NjBkM2M5NTA3ZTQyODQxZjdkYWUxMzc2NzJmOGYxODU5MzY1YWY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaigk2AH2gAyNDA4MDk1OTQxOjI0NTE5OTYyNTE4NGE1NmI1OGQzZTA1MjRjY2I1NTk1OGI2YmE0OTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "d660d3c9507e42841f7dae137672f8f1859365af", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d660d3c9507e42841f7dae137672f8f1859365af", "committedDate": "2020-04-23T18:16:36Z", "message": "Fix (de)serialization of async search failures\n\nThe (de)serialization code of the async search response\ncannot handle exceptions that extend ElasticsearchException (e.g. ScriptException).\nThis commit fixes this bug by serializing the error with the more generic\nStreamInput#writeException."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b600aa694e33aea247ce990bfe67a61d9f06bf5", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b600aa694e33aea247ce990bfe67a61d9f06bf5", "committedDate": "2020-04-23T19:10:33Z", "message": "fix fetch shard failures too"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "204c718eabb44fccb3e0e3506b15fc81ebdd0de8", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/204c718eabb44fccb3e0e3506b15fc81ebdd0de8", "committedDate": "2020-04-23T19:16:46Z", "message": "missing change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "081b81e69b912db221f87c91b15c6b5abf96b8ec", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/081b81e69b912db221f87c91b15c6b5abf96b8ec", "committedDate": "2020-04-23T19:22:35Z", "message": "Merge branch 'master' into async_search_failure"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk5NDIyMzU1", "url": "https://github.com/elastic/elasticsearch/pull/55688#pullrequestreview-399422355", "createdAt": "2020-04-23T19:46:11Z", "commit": {"oid": "081b81e69b912db221f87c91b15c6b5abf96b8ec"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTo0NjoxMVrOGK5NPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QxOTo0OTo1OFrOGK5WaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3NjIyMA==", "bodyText": "leftover?", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414076220", "createdAt": "2020-04-23T19:46:11Z", "author": {"login": "jpountz"}, "path": "x-pack/plugin/async-search/src/test/java/org/elasticsearch/xpack/search/AsyncSearchResponseTests.java", "diffHunk": "@@ -95,7 +96,7 @@ protected AsyncSearchResponse copyInstance(AsyncSearchResponse instance, Version\n     }\n \n     static AsyncSearchResponse randomAsyncSearchResponse(String searchId, SearchResponse searchResponse) {\n-        int rand = randomIntBetween(0, 2);\n+        int rand = randomIntBetween(2, 2);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "081b81e69b912db221f87c91b15c6b5abf96b8ec"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNDA3ODU2OQ==", "bodyText": "maybe add a comment explaining why we have this != null?", "url": "https://github.com/elastic/elasticsearch/pull/55688#discussion_r414078569", "createdAt": "2020-04-23T19:49:58Z", "author": {"login": "jpountz"}, "path": "x-pack/plugin/async-search/src/main/java/org/elasticsearch/xpack/search/AsyncSearchTask.java", "diffHunk": "@@ -349,8 +349,10 @@ protected void onQueryFailure(int shardIndex, SearchShardTarget shardTarget, Exc\n         }\n \n         @Override\n-        protected void onFetchFailure(int shardIndex, Exception exc) {\n+        protected void onFetchFailure(int shardIndex, SearchShardTarget shardTarget, Exception exc) {\n             checkCancellation();\n+            searchResponse.get().addShardFailure(shardIndex,\n+                new ShardSearchFailure(exc, shardTarget.getNodeId() != null ? shardTarget : null));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "081b81e69b912db221f87c91b15c6b5abf96b8ec"}, "originalPosition": 8}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "245199625184a56b58d3e0524ccb55958b6ba494", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/245199625184a56b58d3e0524ccb55958b6ba494", "committedDate": "2020-04-23T20:00:28Z", "message": "address review"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 538, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}