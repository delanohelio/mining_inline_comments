{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzYxNjA0ODM3", "number": 50873, "title": "Begin moving date_histogram to offset rounding", "bodyText": "We added a new rounding in #50609 that handles offsets to the start and\nend of the rounding so that we could support offset in the composite\naggregation. This starts moving date_histogram to that new offset.", "createdAt": "2020-01-10T20:12:25Z", "url": "https://github.com/elastic/elasticsearch/pull/50873", "merged": true, "mergeCommit": {"oid": "b3a77289d86ada2d22c963bd5b597b5e960c219b"}, "closed": true, "closedAt": "2020-01-14T14:23:16Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb5EQ2LAH2gAyMzYxNjA0ODM3OmMyNWMwOGM0ZjEwMjY3Mjg0Nzk1YTViNTNjY2JjZmQ2ZGIzM2E1Yjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb6RijkAFqTM0MjU1NjQwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c25c08c4f10267284795a5b53ccbcfd6db33a5b7", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/c25c08c4f10267284795a5b53ccbcfd6db33a5b7", "committedDate": "2020-01-10T20:06:38Z", "message": "Begin moving date_histogram to offset rounding\n\nWe added a new rounding in #50609 that handles offsets to the start and\nend of the rounding so that we could support `offset` in the `composite`\naggregation. This starts moving `date_histogram` to that new offset."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "567b444268264f2fe1490969efda6990c8903419", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/567b444268264f2fe1490969efda6990c8903419", "committedDate": "2020-01-10T21:04:37Z", "message": "Merge branch 'master' into offset_rounding_date_histogram_1"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "748c0905e1cb95c4529030295fea7dedc1e6a4cf", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/748c0905e1cb95c4529030295fea7dedc1e6a4cf", "committedDate": "2020-01-10T21:28:18Z", "message": "wihout offset"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/64955e722b4dacca22294293447c414c5f3f0efd", "committedDate": "2020-01-10T21:36:57Z", "message": "Extra test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyMDIxMTQ0", "url": "https://github.com/elastic/elasticsearch/pull/50873#pullrequestreview-342021144", "createdAt": "2020-01-13T17:43:43Z", "commit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNzo0Mzo0M1rOFc_DAw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xM1QxNzo1NDo0M1rOFc_YKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkzNzQxMQ==", "bodyText": "Excellent formatting choice, much more readable.", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365937411", "createdAt": "2020-01-13T17:43:43Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/ExtendedBounds.java", "diffHunk": "@@ -166,7 +166,11 @@ ExtendedBounds parseAndValidate(String aggName, QueryShardContext queryShardCont\n     }\n \n     ExtendedBounds round(Rounding rounding) {\n-        return new ExtendedBounds(min != null ? rounding.round(min) : null, max != null ? rounding.round(max) : null);\n+        // Extended bounds shouldn't be effected by the offset\n+        Rounding effectiveRounding = rounding.withoutOffset();\n+        return new ExtendedBounds(\n+                min != null ? effectiveRounding.round(min) : null,\n+                max != null ? effectiveRounding.round(max) : null);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "originalPosition": 9}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTkzNzc0Nw==", "bodyText": "Glad to see this getting moved into the rounding itself.  Makes much more sense.", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365937747", "createdAt": "2020-01-13T17:44:21Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateRangeHistogramAggregator.java", "diffHunk": "@@ -153,10 +151,6 @@ public void collect(int doc, long bucket) throws IOException {\n         };\n     }\n \n-    private long offsetAwareRounding(Rounding rounding, long value, long offset) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NTk0MjgyNA==", "bodyText": "What's the plan to migrate away from this? I'm not sure I understand the benefit to adding a deprecated method now that we intend to remove in the next PR, as opposed to just removing the need for it in this PR.", "url": "https://github.com/elastic/elasticsearch/pull/50873#discussion_r365942824", "createdAt": "2020-01-13T17:54:43Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/common/Rounding.java", "diffHunk": "@@ -164,6 +164,19 @@ public void writeTo(StreamOutput out) throws IOException {\n      */\n     public abstract long nextRoundingValue(long value);\n \n+    /**\n+     * How \"offset\" this rounding is from the traditional \"start\" of the period.\n+     * @deprecated We're in the process of abstracting offset *into* Rounding\n+     *             so keep any usage to migratory shims\n+     */\n+    @Deprecated\n+    public abstract long offset();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "originalPosition": 10}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTU1ODUx", "url": "https://github.com/elastic/elasticsearch/pull/50873#pullrequestreview-342555851", "createdAt": "2020-01-14T14:07:54Z", "commit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQyNTU2NDA4", "url": "https://github.com/elastic/elasticsearch/pull/50873#pullrequestreview-342556408", "createdAt": "2020-01-14T14:08:40Z", "commit": {"oid": "64955e722b4dacca22294293447c414c5f3f0efd"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3799, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}