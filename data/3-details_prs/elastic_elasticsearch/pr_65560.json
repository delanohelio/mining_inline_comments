{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI4MTkwNzAw", "number": 65560, "title": "Make runtime fields highlightable", "bodyText": "This commit adds the ability to request highlights for runtime fields.\nThere are two changes included here:\n\nYou can ask QueryShardContext for the index analyzer for a specific\nfield, and provide an optional lambda to be executed if the field is\nunmapped.  This allows us to return the standard Keyword analyzer by\ndefault for fields that have not been configured in the mappings.\nHighlighterUtil.loadValues() now correctly handles values fetched\nfrom a DocValueFetcher as well as a source fetcher, by setting the\nLeafReaderContext from the passed-in HitContext.\n\nThe first change has a number of knock-on effects, notably that\nMoreLikeThisQuery has to stop using its configured analyzer directly\nin equals() and hashcode() checks as the anonymous analyzer\nreturned from QueryShardContext#getIndexAnalyzer() uses object\nidentity for comparisons.", "createdAt": "2020-11-26T16:57:17Z", "url": "https://github.com/elastic/elasticsearch/pull/65560", "merged": true, "mergeCommit": {"oid": "dcd4fadc32b480f2e5243a095b63b3eb23cd2cc0"}, "closed": true, "closedAt": "2020-11-30T09:08:03Z", "author": {"login": "romseygeek"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdR30SHAH2gAyNTI4MTkwNzAwOjQ4YmY0YjY4M2Y3ODZlNjhjODU3NmIyYWJhYTJjZGZhZDA4ZGZlNjg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdgXd2dAH2gAyNTI4MTkwNzAwOjVkMjQ0NDgwNDlkY2NmYzY2M2M2OGZhOGE3M2M1NzJjMzIyMmQ1YjQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "48bf4b683f786e68c8576b2abaa2cdfad08dfe68", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/48bf4b683f786e68c8576b2abaa2cdfad08dfe68", "committedDate": "2020-10-12T17:55:50Z", "message": "Use ValueFetcher when loading text snippets to highlight"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "36469e3966afc9ee9282bd8b974601de03a3bdb3", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/36469e3966afc9ee9282bd8b974601de03a3bdb3", "committedDate": "2020-10-13T07:58:14Z", "message": "Add back stored-fields branch"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "972a635210ce44c8c50bf9fcd0e296e8622063a7", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/972a635210ce44c8c50bf9fcd0e296e8622063a7", "committedDate": "2020-10-13T07:58:29Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b72b8bddcbe09cc6c73a19cba497485090a4e97", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b72b8bddcbe09cc6c73a19cba497485090a4e97", "committedDate": "2020-11-19T14:19:19Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3baf24b5eba540425f2fc0e550339f72b08d49e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3baf24b5eba540425f2fc0e550339f72b08d49e", "committedDate": "2020-11-19T14:27:41Z", "message": "Check for nulls in tokencount"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c28877ca19adbb799d58139d345b4874df27e4b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c28877ca19adbb799d58139d345b4874df27e4b", "committedDate": "2020-11-19T14:50:40Z", "message": "test for copy_to highlighting; check *all* source paths"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2ea506de64a10a5bd3c56c126d4204f166a5d086", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/2ea506de64a10a5bd3c56c126d4204f166a5d086", "committedDate": "2020-11-23T15:16:01Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0b3ecee4c4b47cb4529cbae29df4b89dd9473cff", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/0b3ecee4c4b47cb4529cbae29df4b89dd9473cff", "committedDate": "2020-11-23T15:20:08Z", "message": "Call it forceSource again"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "70e68809a342eb7531852c24c7935d28359965d6", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/70e68809a342eb7531852c24c7935d28359965d6", "committedDate": "2020-11-23T15:41:06Z", "message": "change test expectation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dc7585591e0957937d29929f123b36983d002d10", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/dc7585591e0957937d29929f123b36983d002d10", "committedDate": "2020-11-24T13:48:52Z", "message": "Merge remote-tracking branch 'origin/master' into highlight/fetcher"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "daa4dd1fc618b6ada96c0247a3fec247b15f35e8", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/daa4dd1fc618b6ada96c0247a3fec247b15f35e8", "committedDate": "2020-11-25T10:00:41Z", "message": "Add failing test - still need to fix it"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "07767a7fe4ac2bdd7d8a78c24fbc735d72bd291b", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/07767a7fe4ac2bdd7d8a78c24fbc735d72bd291b", "committedDate": "2020-11-26T13:17:21Z", "message": "Allow configurable unmapped field index analyzer"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "650617a739efca421a9ac55414bdd072fa734d0e", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/650617a739efca421a9ac55414bdd072fa734d0e", "committedDate": "2020-11-26T14:16:31Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/highlights"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28d7f65929d01a59b6e40ec84987fd55b2bc5600", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/28d7f65929d01a59b6e40ec84987fd55b2bc5600", "committedDate": "2020-11-26T14:18:44Z", "message": "Add note re DocValuesFetchers not working"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c40d8069e1be1bc2eabcff2d696db4f33faf7ded", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/c40d8069e1be1bc2eabcff2d696db4f33faf7ded", "committedDate": "2020-11-26T15:43:49Z", "message": "duh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f5c80b9451bf3ba302acf4930c6f74cfc965baa", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f5c80b9451bf3ba302acf4930c6f74cfc965baa", "committedDate": "2020-11-26T15:43:56Z", "message": "Merge remote-tracking branch 'origin/master' into runtime/highlights"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8c88c1bd2030f199621e43dd1e9c58bc6cd6204", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8c88c1bd2030f199621e43dd1e9c58bc6cd6204", "committedDate": "2020-11-26T15:46:49Z", "message": "remove comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3d7a0a60b84c4000a2f13e3d346ea1ea701a6a3", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3d7a0a60b84c4000a2f13e3d346ea1ea701a6a3", "committedDate": "2020-11-26T16:50:58Z", "message": "MLT analyzer equals check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM5NDc2MjUx", "url": "https://github.com/elastic/elasticsearch/pull/65560#pullrequestreview-539476251", "createdAt": "2020-11-26T17:17:52Z", "commit": {"oid": "b3d7a0a60b84c4000a2f13e3d346ea1ea701a6a3"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoxNzo1MlrOH6jSdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNlQxNzoxODoxNFrOH6jS-Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1NzYyMg==", "bodyText": "Maybe rename unmappedFieldAnalyzer into defaultAnalyzer ? That feels wrong to rely on something called unmapped for runtime fields ?", "url": "https://github.com/elastic/elasticsearch/pull/65560#discussion_r531157622", "createdAt": "2020-11-26T17:17:52Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -445,8 +445,19 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unmappedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b3d7a0a60b84c4000a2f13e3d346ea1ea701a6a3"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1Nzc1Mw==", "bodyText": "Can you also add javadoc for the function ?", "url": "https://github.com/elastic/elasticsearch/pull/65560#discussion_r531157753", "createdAt": "2020-11-26T17:18:14Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/MapperService.java", "diffHunk": "@@ -445,8 +445,19 @@ public Analyzer indexAnalyzer() {\n         return this.indexAnalyzer;\n     }\n \n+    public NamedAnalyzer indexAnalyzer(String field, Function<String, NamedAnalyzer> unmappedFieldAnalyzer) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMTE1NzYyMg=="}, "originalCommit": {"oid": "b3d7a0a60b84c4000a2f13e3d346ea1ea701a6a3"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d24448049dccfc663c68fa8a73c572c3222d5b4", "author": {"user": {"login": "romseygeek", "name": "Alan Woodward"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d24448049dccfc663c68fa8a73c572c3222d5b4", "committedDate": "2020-11-26T18:43:14Z", "message": "javadoc; fix test"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4322, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}