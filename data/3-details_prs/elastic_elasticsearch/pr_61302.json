{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY5Nzc1ODUy", "number": 61302, "title": "Add data.path fast path for FilePermission", "bodyText": "The recursive data.path FilePermission check is an extremely hot\ncodepath in Elasticsearch. Unfortunately the FilePermission check in\nJava is extremely allocation heavy. As it iterates through different\nfile permissions, it allocates byte arrays for each Path component that\nmust be compared. This PR improves the situation by adding the recursive\ndata.path FilePermission it its own PermissionsCollection object which\nis checked first.", "createdAt": "2020-08-18T22:21:16Z", "url": "https://github.com/elastic/elasticsearch/pull/61302", "merged": true, "mergeCommit": {"oid": "dabaad71ad287b77faedaac1a9f0d1e6a8826759"}, "closed": true, "closedAt": "2020-08-21T23:38:40Z", "author": {"login": "tbrooks8"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc-Sv7tAH2gAyNDY5Nzc1ODUyOjcwNjg5YzNmYTFkYzgzZjI4OWE1ZTAwNTU5M2RhZDczZjUwYjM4MjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdBMmFSgH2gAyNDY5Nzc1ODUyOjEzODc1ODhjMTI4Zjk1MzRlZmY5MWMxZjliZjNjODAzOTI4OGEwOTg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "70689c3fa1dc83f289a5e005593dad73f50b3824", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/70689c3fa1dc83f289a5e005593dad73f50b3824", "committedDate": "2020-08-12T22:00:02Z", "message": "Changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ad36848f17809f6a008d434aaa6d2e545e24c45", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ad36848f17809f6a008d434aaa6d2e545e24c45", "committedDate": "2020-08-13T16:43:11Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4568abc6441cbe88c2aa888a97df90df5b40fb6a", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/4568abc6441cbe88c2aa888a97df90df5b40fb6a", "committedDate": "2020-08-18T17:44:19Z", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7db7a45f1d16d32689c8597472cdc6bc6514df33", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/7db7a45f1d16d32689c8597472cdc6bc6514df33", "committedDate": "2020-08-18T21:04:42Z", "message": "Changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "87bcaa852ea72bf10ba6dbaa148275c7613f257e", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/87bcaa852ea72bf10ba6dbaa148275c7613f257e", "committedDate": "2020-08-18T22:16:53Z", "message": "Change"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b751a75a845687e7b1f3040f5d3b3efedc2bef", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9b751a75a845687e7b1f3040f5d3b3efedc2bef", "committedDate": "2020-08-18T22:57:51Z", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a07a6ce0b9a418ed52bd1e00e53c81baf32cf054", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/a07a6ce0b9a418ed52bd1e00e53c81baf32cf054", "committedDate": "2020-08-19T13:12:40Z", "message": "Fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3f7aebd4915abe880dc28f09551fc01e9f8215e8", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/3f7aebd4915abe880dc28f09551fc01e9f8215e8", "committedDate": "2020-08-19T13:13:03Z", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/3ce84c096292f9a371cd6dc3206426d9828a6844", "committedDate": "2020-08-19T15:22:09Z", "message": "Changes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwNjY3NDYz", "url": "https://github.com/elastic/elasticsearch/pull/61302#pullrequestreview-470667463", "createdAt": "2020-08-19T16:59:30Z", "commit": {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNjo1OTozMVrOHDQ4rQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xOVQxNzowNTowMFrOHDROXw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NDQyOQ==", "bodyText": "There are only a handful of usages of this ctor, so can we please convert the existing usages so we don't now have 2?", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473184429", "createdAt": "2020-08-19T16:59:31Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/bootstrap/ESPolicy.java", "diffHunk": "@@ -47,10 +47,17 @@\n     final Policy untrusted;\n     final Policy system;\n     final PermissionCollection dynamic;\n+    final PermissionCollection dataPathPermission;\n     final Map<String,Policy> plugins;\n \n     ESPolicy(Map<String, URL> codebases, PermissionCollection dynamic, Map<String,Policy> plugins, boolean filterBadDefaults) {\n+        this(codebases, dynamic, plugins, filterBadDefaults, new Permissions());\n+    }\n+\n+    ESPolicy(Map<String, URL> codebases, PermissionCollection dynamic, Map<String,Policy> plugins, boolean filterBadDefaults,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844"}, "originalPosition": 11}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4NjcwNA==", "bodyText": "similar comment: can we please modify the few places calling the existing method instead of adding another variant?", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473186704", "createdAt": "2020-08-19T17:01:44Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/bootstrap/FilePermissionUtils.java", "diffHunk": "@@ -63,25 +63,45 @@ public static void addSingleFilePath(Permissions policy, Path path, String permi\n      */\n     @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n     public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions) throws IOException {\n+        addDirectoryPath(policy, configurationName, path, permissions, false);\n+    }\n+\n+    /**\n+     * Add access to path with direct and/or recursive access. This also creates the directory if it does not exist.\n+     *\n+     * @param policy            current policy to add permissions to\n+     * @param configurationName the configuration name associated with the path (for error messages only)\n+     * @param path              the path itself\n+     * @param permissions       set of file permissions to grant to the path\n+     * @param recursiveAccessOnly   indicates if the permission should provide recursive access to files underneath\n+     */\n+    @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n+    public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844"}, "originalPosition": 17}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MzE4OTk4Mw==", "bodyText": "Why are we no longer adding the path itself?", "url": "https://github.com/elastic/elasticsearch/pull/61302#discussion_r473189983", "createdAt": "2020-08-19T17:05:00Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/bootstrap/FilePermissionUtils.java", "diffHunk": "@@ -63,25 +63,45 @@ public static void addSingleFilePath(Permissions policy, Path path, String permi\n      */\n     @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n     public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions) throws IOException {\n+        addDirectoryPath(policy, configurationName, path, permissions, false);\n+    }\n+\n+    /**\n+     * Add access to path with direct and/or recursive access. This also creates the directory if it does not exist.\n+     *\n+     * @param policy            current policy to add permissions to\n+     * @param configurationName the configuration name associated with the path (for error messages only)\n+     * @param path              the path itself\n+     * @param permissions       set of file permissions to grant to the path\n+     * @param recursiveAccessOnly   indicates if the permission should provide recursive access to files underneath\n+     */\n+    @SuppressForbidden(reason = \"only place where creating Java-9 compatible FilePermission objects is possible\")\n+    public static void addDirectoryPath(Permissions policy, String configurationName, Path path, String permissions,\n+                                        boolean recursiveAccessOnly) throws IOException {\n         // paths may not exist yet, this also checks accessibility\n         try {\n             Security.ensureDirectoryExists(path);\n         } catch (IOException e) {\n             throw new IllegalStateException(\"Unable to access '\" + configurationName + \"' (\" + path + \")\", e);\n         }\n \n-        // add each path twice: once for itself, again for files underneath it\n-        policy.add(new FilePermission(path.toString(), permissions));\n+        if (recursiveAccessOnly == false) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3ce84c096292f9a371cd6dc3206426d9828a6844"}, "originalPosition": 28}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7c44b309974cfb6121af1169b9ba95cfd46e97c", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7c44b309974cfb6121af1169b9ba95cfd46e97c", "committedDate": "2020-08-19T17:51:20Z", "message": "Review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcyODE1ODM2", "url": "https://github.com/elastic/elasticsearch/pull/61302#pullrequestreview-472815836", "createdAt": "2020-08-21T20:58:40Z", "commit": {"oid": "d7c44b309974cfb6121af1169b9ba95cfd46e97c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "03cd7560b5757e0c0ed2456b187f83c0f7007698", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/03cd7560b5757e0c0ed2456b187f83c0f7007698", "committedDate": "2020-08-21T22:27:12Z", "message": "Add comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1387588c128f9534eff91c1f9bf3c8039288a098", "author": {"user": {"login": "tbrooks8", "name": "Tim Brooks"}}, "url": "https://github.com/elastic/elasticsearch/commit/1387588c128f9534eff91c1f9bf3c8039288a098", "committedDate": "2020-08-21T22:31:37Z", "message": "Merge remote-tracking branch 'upstream/master' into permissions_fast_path"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4751, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}