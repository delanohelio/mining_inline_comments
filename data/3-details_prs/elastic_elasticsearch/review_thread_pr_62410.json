{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3NDgwNTk1", "number": 62410, "reviewThreads": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNTo0MTowNlrOEk0vPw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODo0ODoxMFrOEly4bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDQ4MjU1OnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNTo0MTowNlrOHT-z5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNTo0MTowNlrOHT-z5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcxNDA4NQ==", "bodyText": "nit: unused if the system property is set, so could go inside the else block.", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r490714085", "createdAt": "2020-09-18T05:41:06Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -28,32 +28,59 @@\n import io.netty.channel.ServerChannel;\n import io.netty.channel.socket.nio.NioServerSocketChannel;\n import org.elasticsearch.common.Booleans;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n import org.elasticsearch.monitor.jvm.JvmInfo;\n \n public class NettyAllocator {\n \n     private static final ByteBufAllocator ALLOCATOR;\n+    private static final String DESCRIPTION;\n \n     private static final String USE_UNPOOLED = \"es.use_unpooled_allocator\";\n     private static final String USE_NETTY_DEFAULT = \"es.unsafe.use_netty_default_allocator\";\n+    private static final String USE_NETTY_DEFAULT_CHUNK = \"es.unsafe.use_netty_default_chunk_and_page_size\";\n \n     static {\n+        long g1gcRegionSizeInBytes = JvmInfo.jvmInfo().getG1RegionSize();\n+        long heapSizeInBytes = JvmInfo.jvmInfo().getMem().getHeapMax().getBytes();\n+        ByteSizeValue g1gcRegionSize = new ByteSizeValue(g1gcRegionSizeInBytes);\n+        ByteSizeValue heapSize = new ByteSizeValue(heapSizeInBytes);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfedacfb419c4c700c24ed285dbd983e4fb4300e"}, "originalPosition": 20}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDUwMTYwOnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNTo1MDo1N1rOHT--tA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNTo1MDo1N1rOHT--tA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcxNjg1Mg==", "bodyText": "Maybe add a comment that this corresponds to 1MB.", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r490716852", "createdAt": "2020-09-18T05:50:57Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -28,32 +28,59 @@\n import io.netty.channel.ServerChannel;\n import io.netty.channel.socket.nio.NioServerSocketChannel;\n import org.elasticsearch.common.Booleans;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n import org.elasticsearch.monitor.jvm.JvmInfo;\n \n public class NettyAllocator {\n \n     private static final ByteBufAllocator ALLOCATOR;\n+    private static final String DESCRIPTION;\n \n     private static final String USE_UNPOOLED = \"es.use_unpooled_allocator\";\n     private static final String USE_NETTY_DEFAULT = \"es.unsafe.use_netty_default_allocator\";\n+    private static final String USE_NETTY_DEFAULT_CHUNK = \"es.unsafe.use_netty_default_chunk_and_page_size\";\n \n     static {\n+        long g1gcRegionSizeInBytes = JvmInfo.jvmInfo().getG1RegionSize();\n+        long heapSizeInBytes = JvmInfo.jvmInfo().getMem().getHeapMax().getBytes();\n+        ByteSizeValue g1gcRegionSize = new ByteSizeValue(g1gcRegionSizeInBytes);\n+        ByteSizeValue heapSize = new ByteSizeValue(heapSizeInBytes);\n         if (Booleans.parseBoolean(System.getProperty(USE_NETTY_DEFAULT), false)) {\n             ALLOCATOR = ByteBufAllocator.DEFAULT;\n+            DESCRIPTION = \"[name=netty_default, factors={es.unsafe.use_netty_default_allocator=true}]\";\n         } else {\n             ByteBufAllocator delegate;\n-            if (useUnpooled()) {\n+            if (useUnpooled(heapSizeInBytes, g1gcRegionSizeInBytes)) {\n                 delegate = UnpooledByteBufAllocator.DEFAULT;\n+                DESCRIPTION = \"[name=unpooled, factors={es.unsafe.use_unpooled_allocator=\" + userForcedUnpooled()\n+                    + \", g1gc_region_size=\" + g1gcRegionSize + \", heap_size=\" + heapSize + \"}]\";\n             } else {\n                 int nHeapArena = PooledByteBufAllocator.defaultNumHeapArena();\n-                int pageSize = PooledByteBufAllocator.defaultPageSize();\n-                int maxOrder = PooledByteBufAllocator.defaultMaxOrder();\n+                int pageSize;\n+                if (useDefaultChunkAndPageSize()) {\n+                    pageSize = PooledByteBufAllocator.defaultPageSize();\n+                } else {\n+                    pageSize = 8192;\n+                }\n+                int maxOrder;\n+                if (useDefaultChunkAndPageSize()) {\n+                    maxOrder = PooledByteBufAllocator.defaultMaxOrder();\n+                } else if (g1gcRegionSizeInBytes >= (4 * 1024 * 1024)) {\n+                    maxOrder = 7;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfedacfb419c4c700c24ed285dbd983e4fb4300e"}, "originalPosition": 45}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDUyNTQ3OnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowMjozOFrOHT_MNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowMjozOFrOHT_MNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyMDMwOQ==", "bodyText": "region size cannot be smaller than 1MB, so hopefully this never triggers. I suppose a future JDK could lower the minimum region size so OK to keep the check, but I think we should add a comment about this. It is hard to assert anything meaningful about in a test without spinning up a small separate JVM.\nYou could also change the maxOrder calculation to be something like log2(g1RegionSize / pageSize) and trigger unpooled when smaller than 5. Not necessary though, current code is fine too with a comment.", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r490720309", "createdAt": "2020-09-18T06:02:38Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -79,12 +110,30 @@ public static ByteBufAllocator getAllocator() {\n         }\n     }\n \n-    private static boolean useUnpooled() {\n+    private static boolean useUnpooled(long heapSizeInBytes, long g1RegionSize) {\n+        if (userForcedUnpooled()) {\n+            return true;\n+        } else {\n+            boolean heapIsOneGBOrLess = heapSizeInBytes <= 1 << 30;\n+            boolean g1gcRegionIsLessThan1MB = g1RegionSize < 1 << 20;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfedacfb419c4c700c24ed285dbd983e4fb4300e"}, "originalPosition": 84}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDUyNzE4OnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowMzozN1rOHT_NVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowMzozN1rOHT_NVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyMDU5Nw==", "bodyText": "I think this should be:\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return heapIsOneGBOrLess || (g1gcRegionIsLessThan1MB && unknownRegionSize);\n          \n          \n            \n                        return heapIsOneGBOrLess || (g1gcRegionIsLessThan1MB && unknownRegionSize == false);", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r490720597", "createdAt": "2020-09-18T06:03:37Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -79,12 +110,30 @@ public static ByteBufAllocator getAllocator() {\n         }\n     }\n \n-    private static boolean useUnpooled() {\n+    private static boolean useUnpooled(long heapSizeInBytes, long g1RegionSize) {\n+        if (userForcedUnpooled()) {\n+            return true;\n+        } else {\n+            boolean heapIsOneGBOrLess = heapSizeInBytes <= 1 << 30;\n+            boolean g1gcRegionIsLessThan1MB = g1RegionSize < 1 << 20;\n+            boolean unknownRegionSize = g1RegionSize != -1;\n+            return heapIsOneGBOrLess || (g1gcRegionIsLessThan1MB && unknownRegionSize);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfedacfb419c4c700c24ed285dbd983e4fb4300e"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA3MDUzNzAyOnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowODoyMVrOHT_TAA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xOFQwNjowODoyMVrOHT_TAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDcyMjA0OA==", "bodyText": "I think this should check that we use g1 and if not, use region size -1. The variable in JvmInfo reflects the underlying G1RegionsSize as is and this seems to be 0 if using parallel GC. Safest to assume it \"undefined\" unless we use G1.", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r490722048", "createdAt": "2020-09-18T06:08:21Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -28,32 +28,59 @@\n import io.netty.channel.ServerChannel;\n import io.netty.channel.socket.nio.NioServerSocketChannel;\n import org.elasticsearch.common.Booleans;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n import org.elasticsearch.monitor.jvm.JvmInfo;\n \n public class NettyAllocator {\n \n     private static final ByteBufAllocator ALLOCATOR;\n+    private static final String DESCRIPTION;\n \n     private static final String USE_UNPOOLED = \"es.use_unpooled_allocator\";\n     private static final String USE_NETTY_DEFAULT = \"es.unsafe.use_netty_default_allocator\";\n+    private static final String USE_NETTY_DEFAULT_CHUNK = \"es.unsafe.use_netty_default_chunk_and_page_size\";\n \n     static {\n+        long g1gcRegionSizeInBytes = JvmInfo.jvmInfo().getG1RegionSize();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "cfedacfb419c4c700c24ed285dbd983e4fb4300e"}, "originalPosition": 17}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA4MDY2NDE0OnYy", "diffSide": "RIGHT", "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODo0ODoxMFrOHVeAIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yMVQxODo0ODoxMFrOHVeAIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MjI3MzY5Ng==", "bodyText": "nit: I would prefer to have these in a single if with || to avoid the repetition.", "url": "https://github.com/elastic/elasticsearch/pull/62410#discussion_r492273696", "createdAt": "2020-09-21T18:48:10Z", "author": {"login": "henningandersen"}, "path": "modules/transport-netty4/src/main/java/org/elasticsearch/transport/NettyAllocator.java", "diffHunk": "@@ -28,32 +28,74 @@\n import io.netty.channel.ServerChannel;\n import io.netty.channel.socket.nio.NioServerSocketChannel;\n import org.elasticsearch.common.Booleans;\n+import org.elasticsearch.common.unit.ByteSizeValue;\n import org.elasticsearch.monitor.jvm.JvmInfo;\n \n public class NettyAllocator {\n \n     private static final ByteBufAllocator ALLOCATOR;\n+    private static final String DESCRIPTION;\n \n     private static final String USE_UNPOOLED = \"es.use_unpooled_allocator\";\n     private static final String USE_NETTY_DEFAULT = \"es.unsafe.use_netty_default_allocator\";\n+    private static final String USE_NETTY_DEFAULT_CHUNK = \"es.unsafe.use_netty_default_chunk_and_page_size\";\n \n     static {\n         if (Booleans.parseBoolean(System.getProperty(USE_NETTY_DEFAULT), false)) {\n             ALLOCATOR = ByteBufAllocator.DEFAULT;\n+            DESCRIPTION = \"[name=netty_default, factors={es.unsafe.use_netty_default_allocator=true}]\";\n         } else {\n+            final long heapSizeInBytes = JvmInfo.jvmInfo().getMem().getHeapMax().getBytes();\n+            final boolean g1gcEnabled = Boolean.parseBoolean(JvmInfo.jvmInfo().useG1GC());\n+            final long g1gcRegionSizeInBytes = JvmInfo.jvmInfo().getG1RegionSize();\n+            final boolean g1gcRegionSizeIsKnown = g1gcRegionSizeInBytes != -1;\n+            ByteSizeValue heapSize = new ByteSizeValue(heapSizeInBytes);\n+            ByteSizeValue g1gcRegionSize = new ByteSizeValue(g1gcRegionSizeInBytes);\n+\n             ByteBufAllocator delegate;\n-            if (useUnpooled()) {\n+            if (useUnpooled(heapSizeInBytes, g1gcEnabled, g1gcRegionSizeIsKnown, g1gcRegionSizeInBytes)) {\n                 delegate = UnpooledByteBufAllocator.DEFAULT;\n+                DESCRIPTION = \"[name=unpooled, factors={es.unsafe.use_unpooled_allocator=\" + userForcedUnpooled()\n+                    + \", g1gc_enabled=\" + g1gcEnabled\n+                    + \", g1gc_region_size=\" + g1gcRegionSize\n+                    + \", heap_size=\" + heapSize + \"}]\";\n             } else {\n                 int nHeapArena = PooledByteBufAllocator.defaultNumHeapArena();\n-                int pageSize = PooledByteBufAllocator.defaultPageSize();\n-                int maxOrder = PooledByteBufAllocator.defaultMaxOrder();\n+                int pageSize;\n+                int maxOrder;\n+                if (useDefaultChunkAndPageSize()) {\n+                    pageSize = PooledByteBufAllocator.defaultPageSize();\n+                    maxOrder = PooledByteBufAllocator.defaultMaxOrder();\n+                } else {\n+                    pageSize = 8192;\n+                    if (g1gcEnabled == false) {\n+                        // This combined with a 8192 page size = 1 MB chunk sizes\n+                        maxOrder = 7;\n+                    } else if (g1gcRegionSizeIsKnown == false) {\n+                        // This combined with a 8192 page size = 1 MB chunk sizes\n+                        maxOrder = 7;\n+                    } else if (g1gcRegionSizeInBytes >= (4 * 1024 * 1024)) {\n+                        // This combined with a 8192 page size = 1 MB chunk sizes\n+                        maxOrder = 7;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69cb192dd8420cd700742560036b85065c5e24f2"}, "originalPosition": 55}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1457, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}