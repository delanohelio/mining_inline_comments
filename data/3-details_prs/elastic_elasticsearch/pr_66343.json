{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQwMjcxNjg4", "number": 66343, "title": "[ML] Add log_time to AD data_counts and decide current based on it", "bodyText": "This commit is fixing a potential bug if we support anomaly detection\nresults index rollover in the future.\nIn particular, we determine the current data_counts by sorting on the\nlatest record time. However, this is not correct if the job reverts\nto an older model snapshot. To fix this we add log_time to data_counts\n(similarly to model_size_stats) and sort on log_time to figure\nout the current counts for the job.", "createdAt": "2020-12-15T13:56:33Z", "url": "https://github.com/elastic/elasticsearch/pull/66343", "merged": true, "mergeCommit": {"oid": "3bed6661de986c9e8c1f3c47f492a0f46d18cf47"}, "closed": true, "closedAt": "2020-12-15T17:09:14Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdmarixgH2gAyNTQwMjcxNjg4OjgxMmNiNjBkOTRiMzQzODliNDI0ZWM3MWZjODg0MTlhMjkyZDkzYWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdmce3ogH2gAyNTQwMjcxNjg4OmY5NmUyOWNkMjIwN2QzMTZmMjU2MmYyZGZmMDE3NTI5NjRlZWFmYzc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "812cb60d94b34389b424ec71fc88419a292d93ac", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/812cb60d94b34389b424ec71fc88419a292d93ac", "committedDate": "2020-12-15T13:51:27Z", "message": "[ML] Add log_time to AD data_counts and decide current based on it\n\nThis commit is fixing a potential bug if we support anomaly detection\nresults index rollover in the future.\n\nIn particular, we determine the current `data_counts` by sorting on the\nlatest record time. However, this is not correct if the job reverts\nto an older model snapshot. To fix this we add `log_time` to `data_counts`\n(similarly to `model_size_stats`) and sort on `log_time` to figure\nout the current counts for the job."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "152cabe50ad2b083056c2570b3773ae61811ffdd", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/152cabe50ad2b083056c2570b3773ae61811ffdd", "committedDate": "2020-12-15T14:10:18Z", "message": "Fix job stats monitoring test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTU5ODA1", "url": "https://github.com/elastic/elasticsearch/pull/66343#pullrequestreview-552559805", "createdAt": "2020-12-15T15:10:56Z", "commit": {"oid": "152cabe50ad2b083056c2570b3773ae61811ffdd"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNToxMDo1N1rOIGQTQQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xNVQxNToxNDo1MlrOIGQgYw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQyOTQ0MQ==", "bodyText": "unsure the rounding to epoch ms this is really needed. The only time that users will be using this object with actual data is when it is deserialized from the server.", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543429441", "createdAt": "2020-12-15T15:10:57Z", "author": {"login": "benwtrent"}, "path": "client/rest-high-level/src/main/java/org/elasticsearch/client/ml/job/process/DataCounts.java", "diffHunk": "@@ -138,31 +145,13 @@ public DataCounts(String jobId, long processedRecordCount, long processedFieldCo\n         this.lastDataTimeStamp = lastDataTimeStamp;\n         this.latestEmptyBucketTimeStamp = latestEmptyBucketTimeStamp;\n         this.latestSparseBucketTimeStamp = latestSparseBucketTimeStamp;\n+        this.logTime = logTime == null ? null : Instant.ofEpochMilli(logTime.toEpochMilli());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "152cabe50ad2b083056c2570b3773ae61811ffdd"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0MzQzMjgwMw==", "bodyText": "Do we have to worry about unmapped type errors?", "url": "https://github.com/elastic/elasticsearch/pull/66343#discussion_r543432803", "createdAt": "2020-12-15T15:14:52Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/persistence/JobResultsProvider.java", "diffHunk": "@@ -445,6 +445,10 @@ private SearchRequestBuilder createLatestDataCountsSearch(String indexName, Stri\n                 .setIndicesOptions(IndicesOptions.lenientExpandOpen())\n                 // look for both old and new formats\n                 .setQuery(QueryBuilders.idsQuery().addIds(DataCounts.documentId(jobId), DataCounts.v54DocumentId(jobId)))\n+                // We want to sort on log_time. However, this was added a long time later and before that we used to\n+                // sort on latest_record_time. Thus we handle older data counts where no log_time exists and we fall back\n+                // to the prior behaviour.\n+                .addSort(SortBuilders.fieldSort(DataCounts.LOG_TIME.getPreferredName()).order(SortOrder.DESC).missing(0L))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "152cabe50ad2b083056c2570b3773ae61811ffdd"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f50275b338da264e6471a73768d961073790fc31", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/f50275b338da264e6471a73768d961073790fc31", "committedDate": "2020-12-15T15:29:14Z", "message": "Handle unmapped when sorting on log_time"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTUyNTgyMjgw", "url": "https://github.com/elastic/elasticsearch/pull/66343#pullrequestreview-552582280", "createdAt": "2020-12-15T15:32:05Z", "commit": {"oid": "f50275b338da264e6471a73768d961073790fc31"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f96e29cd2207d316f2562f2dff01752964eeafc7", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/f96e29cd2207d316f2562f2dff01752964eeafc7", "committedDate": "2020-12-15T15:57:25Z", "message": "Merge branch 'master' into current-data-counts-should-be-sorting-on-log-time"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4526, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}