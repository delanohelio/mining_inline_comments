{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk5MzMxOTI0", "number": 63416, "title": "Simplify reroute counting in InternalSnapshotsInfoServiceTests", "bodyText": "A test failure occurs (reported in #63352) because a test is waiting for a given number of snapshot shard sizes to exist and immediately verifies the number of triggered reroutes - but interleaving execution can happen and at the time the number of reroutes is verified all reroutes might not have been executed yet (reroute is triggered outside the synchronize block that updates the snapshot shard sizes). In addition, usage of Mockito's verify() can be trappy with argument catchers and this can be simplified.\nCloses #63352", "createdAt": "2020-10-07T15:21:49Z", "url": "https://github.com/elastic/elasticsearch/pull/63416", "merged": true, "mergeCommit": {"oid": "1fed34affa91adf7b8c12ff854c7425232ac6937"}, "closed": true, "closedAt": "2020-10-08T14:07:16Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdQOhd7gH2gAyNDk5MzMxOTI0OjQyOGUxYWMzNTBlNjY5NzRjNTEwZjhmZjJkZjgxMjg3MjQ0ZGM5ZTI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdQfCfWAH2gAyNDk5MzMxOTI0OjIzZTljM2Q0Yjk4NGZkZDE4MjU1YTkxN2EzYWFlZDU5ZWM2ZjkxZjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "428e1ac350e66974c510f8ff2df81287244dc9e2", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/428e1ac350e66974c510f8ff2df81287244dc9e2", "committedDate": "2020-10-07T15:15:15Z", "message": "Simplify reroute counting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTA0NjAyMDU2", "url": "https://github.com/elastic/elasticsearch/pull/63416#pullrequestreview-504602056", "createdAt": "2020-10-08T09:37:37Z", "commit": {"oid": "428e1ac350e66974c510f8ff2df81287244dc9e2"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTozNzozN1rOHeWMKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wOFQwOTozNzozN1rOHeWMKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMTU4Mjg5MQ==", "bodyText": "I wonder, couldn't we get rid of the busy asserting completely by doing this via a latch (has the slight upside that we verify exact count a little stronger with the assertion on the latch count?)?\ne.g.:\ndiff --git a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\nindex a4483bd5ce2..fdcdcdb013f 100644\n--- a/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n+++ b/server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java\n@@ -120,12 +120,20 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n+\n+        final int numberOfShards = randomIntBetween(1, 50);\n+        final CountDownLatch rerouteLatch = new CountDownLatch(numberOfShards);\n+        final RerouteService rerouteService = (reason, priority, listener) -> {\n+            listener.onResponse(clusterService.state());\n+            assertThat(rerouteLatch.getCount(), greaterThanOrEqualTo(0L));\n+            rerouteLatch.countDown();\n+        };\n+\n         final InternalSnapshotsInfoService snapshotsInfoService =\n             new InternalSnapshotsInfoService(Settings.builder()\n                 .put(INTERNAL_SNAPSHOT_INFO_MAX_CONCURRENT_FETCHES_SETTING.getKey(), maxConcurrentFetches)\n                 .build(), clusterService, () -> repositoriesService, () -> rerouteService);\n \n-        final int numberOfShards = randomIntBetween(1, 50);\n         final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n         final long[] expectedShardSizes = new long[numberOfShards];\n         for (int i = 0; i < expectedShardSizes.length; i++) {\n@@ -163,12 +171,10 @@ public class InternalSnapshotsInfoServiceTests extends ESTestCase {\n \n         latch.countDown();\n \n-        assertBusy(() -> {\n-            assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n-            assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n-            assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n-        });\n-        verify(rerouteService, times(numberOfShards)).reroute(anyString(), any(Priority.class), any());\n+        assertTrue(rerouteLatch.await(10L, TimeUnit.SECONDS));\n+        assertThat(snapshotsInfoService.numberOfKnownSnapshotShardSizes(), equalTo(numberOfShards));\n+        assertThat(snapshotsInfoService.numberOfUnknownSnapshotShardSizes(), equalTo(0));\n+        assertThat(snapshotsInfoService.numberOfFailedSnapshotShardSizes(), equalTo(0));\n         assertThat(getShardSnapshotStatusCount.get(), equalTo(numberOfShards));\n \n         final SnapshotShardSizeInfo snapshotShardSizeInfo = snapshotsInfoService.snapshotShardSizes();\nJust a suggestion :) this approach looks fine as well.", "url": "https://github.com/elastic/elasticsearch/pull/63416#discussion_r501582891", "createdAt": "2020-10-08T09:37:37Z", "author": {"login": "original-brownbear"}, "path": "server/src/test/java/org/elasticsearch/snapshots/InternalSnapshotsInfoServiceTests.java", "diffHunk": "@@ -120,6 +107,13 @@ public void tearDown() throws Exception {\n \n     public void testSnapshotShardSizes() throws Exception {\n         final int maxConcurrentFetches = randomIntBetween(1, 10);\n+\n+        final AtomicInteger rerouteCount = new AtomicInteger(0);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "428e1ac350e66974c510f8ff2df81287244dc9e2"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23e9c3d4b984fdd18255a917a3aaed59ec6f91f8", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/23e9c3d4b984fdd18255a917a3aaed59ec6f91f8", "committedDate": "2020-10-08T10:29:48Z", "message": "Simplify reroute counting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4169, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}