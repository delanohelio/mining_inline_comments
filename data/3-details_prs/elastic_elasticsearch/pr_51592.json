{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY4NDE2NTMx", "number": 51592, "title": "SQL: improve timezone sensitive JDBC tests to account for offset differences", "bodyText": "Original PR: #51290\nBased on the discussion here decision has been made to merge this PR in 6.8 only.\nThis PR addresses CI failures reported in #45035 and #48234, but also other even more rare CI failures looking like\njava.lang.AssertionError: expected: java.sql.Date<\u00ef\u00bf\u00bd033-11-02> but was: java.sql.Date<\u00ef\u00bf\u00bd033-11-02>\n\tat __randomizedtesting.SeedInfo.seed([C0FA1CD0C3242A0C:F993B3EB81DCB7CD]:0)\n\tat org.junit.Assert.fail(Assert.java:88)\n\tat org.junit.Assert.failNotEquals(Assert.java:834)\n\tat org.junit.Assert.assertEquals(Assert.java:118)\n\tat org.junit.Assert.assertEquals(Assert.java:144)\n\tat org.elasticsearch.xpack.sql.qa.jdbc.ResultSetTestCase.lambda$testGettingDateWithoutCalendar$134(ResultSetTestCase.java:886)\n\nWhat basically happens is that the server runs on a java version where a certain timezone has a set of offset rules, while the test itself runs on a java version where the same timezone has changed offset rules (think about a country deciding to use utc+x instead of utc+y).\nThis PR changed several tests to compare only the relevant parts of the conversion failure error message and ignore the actual datetime String from the error message itself (thus, ignoring the value of the datetime itself that's part of the error message).\nAlso, there is another change fixing the second issue mentioned above where a timezone in testGettingDateWithoutCalendar is randomly generated by creating a fixed offset timezone (ie GMT+X or Z instead of Australia/West timezone) so that the offset is always fixed.", "createdAt": "2020-01-29T07:40:34Z", "url": "https://github.com/elastic/elasticsearch/pull/51592", "merged": true, "mergeCommit": {"oid": "fe254a2fcbe312e5ddacda528176647e7cfae381"}, "closed": true, "closedAt": "2020-01-29T14:54:56Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb_A699AH2gAyMzY4NDE2NTMxOjRmNDI0NjA5YWY4MzI3ZjIyODcwYzdiYzUxNzQxMDljOTlhZTFjYjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb_HGK7AFqTM1MDE2MjE4Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4f424609af8327f22870c7bc5174109c99ae1cb4", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f424609af8327f22870c7bc5174109c99ae1cb4", "committedDate": "2020-01-29T07:36:34Z", "message": "* Changed one test to use fixed offsets\n* Changed several tests to compare only the relevant parts of the\nconversion failure error message and ignore the actual datetime String\nfrom the error message itself"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMDIxNDM1", "url": "https://github.com/elastic/elasticsearch/pull/51592#pullrequestreview-350021435", "createdAt": "2020-01-29T11:00:20Z", "commit": {"oid": "4f424609af8327f22870c7bc5174109c99ae1cb4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTowMDoyMFrOFjEbmQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxMTowMDoyMFrOFjEbmQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjMxNzA4MQ==", "bodyText": "Could you please add a comment here, for the 18 (maximum offset)?", "url": "https://github.com/elastic/elasticsearch/pull/51592#discussion_r372317081", "createdAt": "2020-01-29T11:00:20Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/ResultSetTestCase.java", "diffHunk": "@@ -879,10 +887,20 @@ public void testGettingDateWithoutCalendar() throws Exception {\n         Long randomLongDate = randomNonNegativeLong();\n         indexSimpleDocumentWithTrueValues(randomLongDate);\n         \n-        doWithQuery(SELECT_ALL_FIELDS, (results) -> {\n+        // Create simple timezones (in the form of Z/GMT+/-x so that timezones offsets differences between\n+        // Java versions (the one server runs on and the one the test runs on) will not skew the tests' results\n+        int hoursOffset = randomIntBetween(0, 18);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4f424609af8327f22870c7bc5174109c99ae1cb4"}, "originalPosition": 162}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "abd222f3a1807ea36539313c83abaefbd9decd47", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/abd222f3a1807ea36539313c83abaefbd9decd47", "committedDate": "2020-01-29T11:32:16Z", "message": "Address review"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTYyMDM4", "url": "https://github.com/elastic/elasticsearch/pull/51592#pullrequestreview-350162038", "createdAt": "2020-01-29T14:48:03Z", "commit": {"oid": "abd222f3a1807ea36539313c83abaefbd9decd47"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo0ODowM1rOFjLB-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yOVQxNDo0ODowM1rOFjLB-g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MjQyNTIxMA==", "bodyText": "Just a note: while GMT and UTC are identical in this timezones context, my impression is that there is a shift towards using the UTC for references.", "url": "https://github.com/elastic/elasticsearch/pull/51592#discussion_r372425210", "createdAt": "2020-01-29T14:48:03Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/qa/src/main/java/org/elasticsearch/xpack/sql/qa/jdbc/ResultSetTestCase.java", "diffHunk": "@@ -879,10 +887,23 @@ public void testGettingDateWithoutCalendar() throws Exception {\n         Long randomLongDate = randomNonNegativeLong();\n         indexSimpleDocumentWithTrueValues(randomLongDate);\n         \n-        doWithQuery(SELECT_ALL_FIELDS, (results) -> {\n+        /*\n+         * Create simple timezones (in the form of Z/GMT+/-x so that timezones offsets differences between Java versions (the one \n+         * server runs on and the one the test runs on) will not skew the tests' results.\n+         * -18/+18 is the maximum range of offsets accepted by ZoneOffset, even if in reality this range is more like [-12, +14].\n+         */\n+        int hoursOffset = randomIntBetween(0, 18);\n+        int subHours = hoursOffset != 18 ? randomFrom(0, 15, 30, 45) : 0;\n+        int plusMinus = randomBoolean() ? 1 : -1;\n+        int totalSeconds = (hoursOffset * 3600 + subHours * 60) * plusMinus;\n+        \n+        ZoneOffset randomFixedZone = ZoneOffset.ofTotalSeconds(totalSeconds);\n+        String zoneString = (hoursOffset == 0 && subHours == 0) ? \"Z\" : \"GMT\" + randomFixedZone.getId();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "abd222f3a1807ea36539313c83abaefbd9decd47"}, "originalPosition": 171}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUwMTYyMTgy", "url": "https://github.com/elastic/elasticsearch/pull/51592#pullrequestreview-350162182", "createdAt": "2020-01-29T14:48:14Z", "commit": {"oid": "abd222f3a1807ea36539313c83abaefbd9decd47"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3029, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}