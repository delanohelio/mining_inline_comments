{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1NjQwMzE0", "number": 57399, "title": "Ensure type exists for all monitoring configuration", "bodyText": "#47711 and #47246 helped to validate that monitoring settings are\nrejected at time of setting the monitoring settings. Else an invalid\nmonitoring setting can find it's way into the cluster state and result\nin an exception thrown [1] on the cluster state application (there by\ncausing significant issues). Some additional monitoring settings have\nbeen identified that can result in invalid cluster state that also\nresult in exceptions thrown on cluster state application.\nAll settings require a type of either http or local to be\napplicable. When a setting is changed, the exporters are automatically\nupdated with the new settings. However, if the old or new settings lack\nof a type setting an exception will be thrown (since exporters are\nalways of type 'http' or 'local'). Arguably we shouldn't blindly create\nand destroy new exporters on each monitoring setting update, but the\nlifecycle of the exporters is abit out the scope this PR is trying to\naddress.\nThis commit introduces a similar methodology to check for validity as\n#47711 and #47246 but this time for ALL (including non-http) settings.\nMonitoring settings are not useful unless there an exporter with a type\ndefined. The type is used as dependent setting, such that it must\nexist to set the value. This ensures that when any monitoring settings\nchanges that they can only get added to cluster state if the type\nexists. If the type exists (and the other validations pass) then the\nexporters will get re-built and the cluster state remains valid.\nTests have been included to ensure that all dynamic monitoring settings\nhave the type as dependent settings.\n[1]\norg.elasticsearch.common.settings.SettingsException: missing exporter type for [found-user-defined] exporter\nat org.elasticsearch.xpack.monitoring.exporter.Exporters.initExporters(Exporters.java:126) ~[?:?]", "createdAt": "2020-05-31T17:02:56Z", "url": "https://github.com/elastic/elasticsearch/pull/57399", "merged": true, "mergeCommit": {"oid": "7dde9d48e6cb7aa945c63672330d00188b1a8fcd"}, "closed": true, "closedAt": "2020-06-04T21:47:09Z", "author": {"login": "jakelandis"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcmutb-AH2gAyNDI1NjQwMzE0OmJmNWZjNTYwMmE4NmJjNTRlYzQ4ZjY2OGY5MDJlN2Q5NzE1MDQ1MTQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnDw1XgFqTQyMjA0MTQ2Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "bf5fc5602a86bc54ec48f668f902e7d971504514", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/bf5fc5602a86bc54ec48f668f902e7d971504514", "committedDate": "2020-05-31T17:00:28Z", "message": "Ensure type exists for all monitoring configuration"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "25970889337a76356fa563d42523c295fbd0d17a", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/25970889337a76356fa563d42523c295fbd0d17a", "committedDate": "2020-05-31T19:27:40Z", "message": "fix test, can't validate dependent settings across node and dynamic"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "269854dba99c38ed712d725f2bb82732a49bddb1", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/269854dba99c38ed712d725f2bb82732a49bddb1", "committedDate": "2020-05-31T20:21:47Z", "message": "another test setup fix"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfbdc097627fcc1cdbf390f84563b0e565c9be87", "author": {"user": {"login": "jakelandis", "name": "Jake Landis"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfbdc097627fcc1cdbf390f84563b0e565c9be87", "committedDate": "2020-05-31T20:53:26Z", "message": "more test fixes"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTI4MTUz", "url": "https://github.com/elastic/elasticsearch/pull/57399#pullrequestreview-421528153", "createdAt": "2020-05-31T21:12:38Z", "commit": {"oid": "dfbdc097627fcc1cdbf390f84563b0e565c9be87"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQyMToxMjozOFrOGc7S5w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQyMToxMjozOFrOGc7S5w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk4NDgwNw==", "bodyText": "This is necessary since this test (and some others here) set the type via node level setting but the settings validation does not validate across node level vs. dynamic settings (they get merged after independent validation).\nIt also looks like we don't support validation across persistent vs. transient settings either, which makes any of these cross settings dependencies validation a bit terse. This translates to a real change in behavior w.r.t monitoring, but cross level validation is a bigger issue then monitoring. The safety here (imo) outweighs the convenience of cross type setting validation (and already exists for all HTTP type settings).", "url": "https://github.com/elastic/elasticsearch/pull/57399#discussion_r432984807", "createdAt": "2020-05-31T21:12:38Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/monitoring/src/internalClusterTest/java/org/elasticsearch/xpack/monitoring/integration/MonitoringIT.java", "diffHunk": "@@ -364,6 +364,7 @@ public void enableMonitoring() throws Exception {\n \n         final Settings settings = Settings.builder()\n                 .put(\"xpack.monitoring.collection.enabled\", true)\n+                .put(\"xpack.monitoring.exporters._local.type\", \"local\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dfbdc097627fcc1cdbf390f84563b0e565c9be87"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDQxNDYy", "url": "https://github.com/elastic/elasticsearch/pull/57399#pullrequestreview-422041462", "createdAt": "2020-06-01T17:32:11Z", "commit": {"oid": "dfbdc097627fcc1cdbf390f84563b0e565c9be87"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4059, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}