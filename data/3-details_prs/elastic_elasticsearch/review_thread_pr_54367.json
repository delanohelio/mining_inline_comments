{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk0OTc3NzM4", "number": 54367, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMjoxOVrODskNdg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozODozNFrODskWsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDU3MjA2OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMjoxOVrOF9e9OA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQxMzo1Nzo1NVrOF9rDFg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNDY0OA==", "bodyText": "I think we should overlapping v2 templates with the same priority in the same way (but then throw an error) (in another change)", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400014648", "createdAt": "2020-03-30T08:32:19Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -272,6 +280,21 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n         }\n \n+        Map<String, List<String>> overlaps = findConflictingV1Templates(currentState, name, template.indexPatterns());\n+        if (overlaps.size() > 0) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDIxMjc1OA==", "bodyText": "Good idea, I'll add a TODO item to add this validation to the meta issue.", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400212758", "createdAt": "2020-03-30T13:57:55Z", "author": {"login": "dakrone"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -272,6 +280,21 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n         }\n \n+        Map<String, List<String>> overlaps = findConflictingV1Templates(currentState, name, template.indexPatterns());\n+        if (overlaps.size() > 0) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNDY0OA=="}, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDU3NzM1OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMzo0MFrOF9fAaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozMzo0MFrOF9fAaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxNTQ2Nw==", "bodyText": "\ud83d\udc4d This method makes validating overlapping templates really easy for index templates v2 :)", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400015467", "createdAt": "2020-03-30T08:33:40Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -281,6 +304,48 @@ static ClusterState addIndexTemplateV2(final ClusterState currentState, final bo\n             .build();\n     }\n \n+    /**\n+     * Return a map of v1 template names to their index patterns for v1 templates that would overlap\n+     * with the given v2 template's index patterns.\n+     */\n+    static Map<String, List<String>> findConflictingV1Templates(final ClusterState state, final String candidateName,\n+                                                                final List<String> indexPatterns) {\n+        Automaton v2automaton = Regex.simpleMatchToAutomaton(indexPatterns.toArray(Strings.EMPTY_ARRAY));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 77}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ4MDU5NTY4OnYy", "diffSide": "RIGHT", "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMFQwODozODozNFrOF9fLig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0zMVQwNjo0Njo1M1rOF-HdxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA==", "bodyText": "I would have expected that this change was needed in the change that added component templates and not in this change? (not questioning the need for it, but timing)", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400018314", "createdAt": "2020-03-30T08:38:34Z", "author": {"login": "martijnvg"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -549,9 +549,29 @@ private void wipeCluster() throws Exception {\n                         adminClient().performRequest(new Request(\"DELETE\", \"_template/\" + template));\n                     }\n                 }\n+                try {\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_index_template/*\"));\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_component_template/*\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDI2Mjc0NQ==", "bodyText": "So the index and component templates hung around after YAML tests, but because there was never any warnings/errors, and because they aren't actually used for index creation yet, they didn't cause any errors. This is required now because they were hanging around and then the regular template stuff caused errors/warnings.", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400262745", "createdAt": "2020-03-30T15:02:01Z", "author": {"login": "dakrone"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -549,9 +549,29 @@ private void wipeCluster() throws Exception {\n                         adminClient().performRequest(new Request(\"DELETE\", \"_template/\" + template));\n                     }\n                 }\n+                try {\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_index_template/*\"));\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_component_template/*\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA=="}, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 6}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDY3ODM0MA==", "bodyText": "thanks, makes sense.", "url": "https://github.com/elastic/elasticsearch/pull/54367#discussion_r400678340", "createdAt": "2020-03-31T06:46:53Z", "author": {"login": "martijnvg"}, "path": "test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java", "diffHunk": "@@ -549,9 +549,29 @@ private void wipeCluster() throws Exception {\n                         adminClient().performRequest(new Request(\"DELETE\", \"_template/\" + template));\n                     }\n                 }\n+                try {\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_index_template/*\"));\n+                    adminClient().performRequest(new Request(\"DELETE\", \"_component_template/*\"));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMDAxODMxNA=="}, "originalCommit": {"oid": "f2dbda0adf291fd154d81b04dd2b52484c90fb72"}, "originalPosition": 6}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4041, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}