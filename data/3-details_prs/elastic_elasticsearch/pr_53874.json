{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNTYwMTYx", "number": 53874, "title": "Verify that the field is aggregatable before attempting cardinality aggregation", "bodyText": "This PR verifies that the field is aggregatable before attempting a cardinality aggregation on that field.\nDue to that verification, the error message delivered to user is a bit more understandable.\nRelates #53876", "createdAt": "2020-03-20T14:24:54Z", "url": "https://github.com/elastic/elasticsearch/pull/53874", "merged": true, "mergeCommit": {"oid": "f783670464625a4bb6fa2f3c219d46f748773670"}, "closed": true, "closedAt": "2020-03-23T17:37:54Z", "author": {"login": "przemekwitek"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQbHgDABqjMxNTQ0MDE5NjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcQhFqDgFqTM3OTYxMzAwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "89e045a0b5c5d6e2099acf8c3c1c783d5459a777", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/89e045a0b5c5d6e2099acf8c3c1c783d5459a777", "committedDate": "2020-03-20T14:23:24Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "committedDate": "2020-03-23T09:42:29Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/877a98d1d4a7bfef5dc615d0a27a1920cabc572e", "committedDate": "2020-03-23T09:42:29Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "76f4e4046467e410efbc16cbfb2b021d215bf17c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/76f4e4046467e410efbc16cbfb2b021d215bf17c", "committedDate": "2020-03-23T10:29:30Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "76f4e4046467e410efbc16cbfb2b021d215bf17c", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/76f4e4046467e410efbc16cbfb2b021d215bf17c", "committedDate": "2020-03-23T10:29:30Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "committedDate": "2020-03-23T10:33:11Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/15bb4ef5ea648263f3caf69dbbe47e9fef855c93", "committedDate": "2020-03-23T10:33:11Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "2be6e4e784e1d8299c70719c886bb68f369ed07f", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2be6e4e784e1d8299c70719c886bb68f369ed07f", "committedDate": "2020-03-23T10:39:49Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "2be6e4e784e1d8299c70719c886bb68f369ed07f", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/2be6e4e784e1d8299c70719c886bb68f369ed07f", "committedDate": "2020-03-23T10:39:49Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "907fc14c0e5a0471171731eac05d0705ab759196", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/907fc14c0e5a0471171731eac05d0705ab759196", "committedDate": "2020-03-23T10:42:25Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "907fc14c0e5a0471171731eac05d0705ab759196", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/907fc14c0e5a0471171731eac05d0705ab759196", "committedDate": "2020-03-23T10:42:25Z", "message": "Remove \"text\" type from the set of supported categorical types"}, "afterCommit": {"oid": "95cea80717e52d5a9e3abe98e4f2ae974ebd84e0", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/95cea80717e52d5a9e3abe98e4f2ae974ebd84e0", "committedDate": "2020-03-23T12:07:26Z", "message": "Remove \"text\" type from the set of supported categorical types"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "67f37c0ed1bfd559c219803af6ad26cd1e28fe74", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/67f37c0ed1bfd559c219803af6ad26cd1e28fe74", "committedDate": "2020-03-23T13:59:00Z", "message": "Verify that the field is aggregatable before attempting cardinality"}, "afterCommit": {"oid": "58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "committedDate": "2020-03-23T14:34:35Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/58a275e5d4c97642d1d50b2c68e4bcbf4a13ec32", "committedDate": "2020-03-23T14:34:35Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}, "afterCommit": {"oid": "871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "committedDate": "2020-03-23T14:34:57Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a2b3dda100f9078df61b4f3b8c442a679dec758", "committedDate": "2020-03-23T14:38:27Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/871a5c775e6a6e4b6fb9539d42ed5306b4cc01ed", "committedDate": "2020-03-23T14:34:57Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}, "afterCommit": {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758", "author": {"user": {"login": "przemekwitek", "name": "Przemys\u0142aw Witek"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a2b3dda100f9078df61b4f3b8c442a679dec758", "committedDate": "2020-03-23T14:38:27Z", "message": "Verify that the field is aggregatable before attempting cardinality aggregation"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NTE0MTIz", "url": "https://github.com/elastic/elasticsearch/pull/53874#pullrequestreview-379514123", "createdAt": "2020-03-23T15:00:55Z", "commit": {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMDo1NlrOF6JdrQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yM1QxNTowMDo1NlrOF6JdrQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NjUxNjc4MQ==", "bodyText": "\ud83e\udd14\nWhat if this is a multi-field?\nIf the field mapping is\n\"foo\": {\n   \"type\": \"text\",\n   \"keyword\": {\n      \"type\": \"keyword\"\n   }\n}\n\nDo we prefer to use foo.keyword in this instance? I know that analytics chooses a preferred field-mapping but I am not sure that occurs before this call.", "url": "https://github.com/elastic/elasticsearch/pull/53874#discussion_r396516781", "createdAt": "2020-03-23T15:00:56Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/extractor/ExtractedFieldsDetectorFactory.java", "diffHunk": "@@ -111,6 +114,12 @@ private void getCardinalitiesForFieldsWithConstraints(String[] index, DataFrameA\n \n         SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder().size(0).query(config.getSource().getParsedQuery());\n         for (FieldCardinalityConstraint constraint : fieldCardinalityConstraints) {\n+            for (FieldCapabilities fieldCaps : fieldCapabilitiesResponse.getField(constraint.getField()).values()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758"}, "originalPosition": 32}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzc5NjEzMDA4", "url": "https://github.com/elastic/elasticsearch/pull/53874#pullrequestreview-379613008", "createdAt": "2020-03-23T16:41:55Z", "commit": {"oid": "7a2b3dda100f9078df61b4f3b8c442a679dec758"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1906, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}