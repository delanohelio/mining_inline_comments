{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI0OTU2MTg1", "number": 65331, "title": "{S,E}QL: Fix optimization of `NotEquals` in conjunctions", "bodyText": "Fix the CombineBinaryComparisons optimizer rule, so that semantic\nequality taken into account during the optimization of NotEquals\n\nExamples that previously removed the NotEquals expressions (leading\nto incorrect results):\ndouble >= 10 AND integer != 9\n-->\u00a0 double >= 10\n\nkeyword != '2021' AND datetime >= '2020-01-01T00:00:00'\n--> datetime >= '2020-01-01T00:00:00'\n\nWith the fix, expressions like the above will not be touched.\nNotEquals will only be eliminated from the AND expression if the\nleft side of the NotEquals semanticEquals() to the left side\nof the other expressions within the conjunction (comparisons against\nthe same field/expression).\n\nUnit tests and integration tests\n\nClose #65322\nVersions impacted: v7.7.0+. It is a question how far do we want to merge back the bugfix.\nBug was merged into master on Jan 30, 2020: 789724a\nThe bug first appeared in v7.7.0: f1173aa", "createdAt": "2020-11-20T21:18:37Z", "url": "https://github.com/elastic/elasticsearch/pull/65331", "merged": true, "mergeCommit": {"oid": "8b2b7fa80f179d5e7102c05509238cd8166f2ada"}, "closed": true, "closedAt": "2020-11-24T16:40:05Z", "author": {"login": "palesz"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdfTMpjAFqTUzNjM3MjI0Nw==", "endCursor": "Y3Vyc29yOnYyOpPPAAABdfsjqmAFqTUzNzcwNjg0MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM2MzcyMjQ3", "url": "https://github.com/elastic/elasticsearch/pull/65331#pullrequestreview-536372247", "createdAt": "2020-11-23T11:10:24Z", "commit": {"oid": "4629af6732aec5c5e86f3e7d87a34f3dbb86fe9b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMToxMDoyNFrOH4IySw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yM1QxMToxMDoyNFrOH4IySw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyODYyNjI1MQ==", "bodyText": "I'd add a simple numeric test in x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRulesTests.java to replicate and check the fix, as well as more accurately inspect the translation.\nIn that respect, not sure if this particular test would still be needed, but if you decide to keep it, I'd also add a comment on the condition that the value of negatedText fulfils as it's not obvious.\nAlso, the \"Bug\" in the title is not explanatory: either rename the test or add a reference.", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r528626251", "createdAt": "2020-11-23T11:10:24Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/sql/src/test/java/org/elasticsearch/xpack/sql/planner/QueryTranslatorTests.java", "diffHunk": "@@ -2338,4 +2338,12 @@ public void testInInRangeValues() {\n         PhysicalPlan p = testContext.optimizeAndPlan(\"SELECT long FROM test WHERE long IN (1, 2, 3, \" + Long.MAX_VALUE + \", 5, 6, 7)\");\n         assertEquals(EsQueryExec.class, p.getClass());\n     }\n+    \n+    public void testCombineBinaryComparisonsBugKeyword() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4629af6732aec5c5e86f3e7d87a34f3dbb86fe9b"}, "originalPosition": 5}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb92e96d47a7b42939b60481caa794600039bc0f", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb92e96d47a7b42939b60481caa794600039bc0f", "committedDate": "2020-11-24T01:58:57Z", "message": "{S,E}QL: Fix incorrect folding of negations\n\n* Add missing `semanticEquals()` check to the CombineBinaryComparisons optimizer rule\n* Add single unit test that checks the reported bug\n\nMissing so far:\n* Additional tests covering additional types\n* Potentially randomized testing"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "252ef12440898312eb09ece9362e377e3a8f9ba6", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/252ef12440898312eb09ece9362e377e3a8f9ba6", "committedDate": "2020-11-24T14:19:54Z", "message": "Cleanup and additional tests\n\n* Moved the tests cases to OptimizerRulesTests\n* Added additional test cases discovered by randomized tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8", "committedDate": "2020-11-24T14:20:15Z", "message": "Merge remote-tracking branch 'origin/master' into fix/65322"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4629af6732aec5c5e86f3e7d87a34f3dbb86fe9b", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/4629af6732aec5c5e86f3e7d87a34f3dbb86fe9b", "committedDate": "2020-11-20T20:44:01Z", "message": "{S,E}QL: Fix incorrect folding of negations\n\n* Add missing `semanticEquals()` check to the CombineBinaryComparisons optimizer rule\n* Add single unit test that checks the reported bug\n\nMissing so far:\n* Additional tests covering additional types\n* Potentially randomized testing"}, "afterCommit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8", "committedDate": "2020-11-24T14:20:15Z", "message": "Merge remote-tracking branch 'origin/master' into fix/65322"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTQxMzIz", "url": "https://github.com/elastic/elasticsearch/pull/65331#pullrequestreview-537541323", "createdAt": "2020-11-24T14:24:04Z", "commit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoyNDowNFrOH5DLWg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoyNDowNFrOH5DLWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4MjkzOA==", "bodyText": "Use the method in TestUtils.", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r529582938", "createdAt": "2020-11-24T14:24:04Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRulesTests.java", "diffHunk": "@@ -135,7 +137,11 @@ private static FieldAttribute getFieldAttribute() {\n     }\n \n     private static FieldAttribute getFieldAttribute(String name) {\n-        return new FieldAttribute(EMPTY, name, new EsField(name + \"f\", INTEGER, emptyMap(), true));\n+        return getFieldAttribute(name, INTEGER);\n+    }\n+\n+    private static FieldAttribute getFieldAttribute(String name, DataType dataType) {\n+        return new FieldAttribute(EMPTY, name, new EsField(name + \"f\", dataType, emptyMap(), true));\n     }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "originalPosition": 20}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc2f5562a00914cafc64b38a237d117b0042cea8", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc2f5562a00914cafc64b38a237d117b0042cea8", "committedDate": "2020-11-24T14:25:52Z", "message": "Using method in TestUtils"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NTQyNTE4", "url": "https://github.com/elastic/elasticsearch/pull/65331#pullrequestreview-537542518", "createdAt": "2020-11-24T14:25:13Z", "commit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoyNToxM1rOH5DOzA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNDoyNjo1MVrOH5DT6Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4MzgyMA==", "bodyText": "Better naming - doubleOne, doubleTwo - oneDouble, anotherDouble, etc..", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r529583820", "createdAt": "2020-11-24T14:25:13Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRulesTests.java", "diffHunk": "@@ -1015,7 +1021,32 @@ public void testRangesOverlappingNoLowerBoundary() {\n         Expression exp = rule.rule(or);\n         assertEquals(r2, exp);\n     }\n+    \n+    public void testBinaryComparisonAndOutOfRangeNotEqualsDifferentFields() {\n+        FieldAttribute fDouble = getFieldAttribute(\"double\", DOUBLE);\n+        FieldAttribute fDouble2 = getFieldAttribute(\"double2\", DOUBLE);\n+        FieldAttribute fInteger = getFieldAttribute(\"int\", INTEGER);\n+        FieldAttribute fDatetime = getFieldAttribute(\"datetime\", INTEGER);\n+        FieldAttribute fKeyword = getFieldAttribute(\"keyword\", KEYWORD);\n+        FieldAttribute fKeyword2 = getFieldAttribute(\"keyword2\", KEYWORD);\n+        ZoneId zoneId = randomZone();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "originalPosition": 35}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4NDQ1Nw==", "bodyText": "Extract the list outside the for.\nAlso use the methods in TestUtils to increase readability.", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r529584457", "createdAt": "2020-11-24T14:26:01Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRulesTests.java", "diffHunk": "@@ -1015,7 +1021,32 @@ public void testRangesOverlappingNoLowerBoundary() {\n         Expression exp = rule.rule(or);\n         assertEquals(r2, exp);\n     }\n+    \n+    public void testBinaryComparisonAndOutOfRangeNotEqualsDifferentFields() {\n+        FieldAttribute fDouble = getFieldAttribute(\"double\", DOUBLE);\n+        FieldAttribute fDouble2 = getFieldAttribute(\"double2\", DOUBLE);\n+        FieldAttribute fInteger = getFieldAttribute(\"int\", INTEGER);\n+        FieldAttribute fDatetime = getFieldAttribute(\"datetime\", INTEGER);\n+        FieldAttribute fKeyword = getFieldAttribute(\"keyword\", KEYWORD);\n+        FieldAttribute fKeyword2 = getFieldAttribute(\"keyword2\", KEYWORD);\n+        ZoneId zoneId = randomZone();\n \n+        for (And and : Arrays.asList(\n+            // double > 10 AND integer != -10\n+            new And(EMPTY, new GreaterThan(EMPTY, fDouble, L(10), zoneId), new NotEquals(EMPTY, fInteger, L(-10), zoneId)),\n+            // keyword > '5' AND keyword2 != '48'\n+            new And(EMPTY, new GreaterThan(EMPTY, fKeyword, L(\"5\"), zoneId), new NotEquals(EMPTY, fKeyword2, L(\"48\"), zoneId)),\n+            // keyword != '2021' AND datetime <= '2020-12-04T17:48:22.954240Z'\n+            new And(EMPTY, new NotEquals(EMPTY, fKeyword, L(\"2021\"), zoneId), \n+                new LessThanOrEqual(EMPTY, fDatetime, L(\"2020-12-04T17:48:22.954240Z\"), zoneId)),\n+            // double > 10.1 AND double2 != -10.1\n+            new And(EMPTY, new GreaterThan(EMPTY, fDouble, L(10.1d), zoneId), new NotEquals(EMPTY, fDouble2, L(-10.1d), zoneId))\n+        )) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "originalPosition": 47}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTU4NTEyOQ==", "bodyText": "tag is used for documentation purposes. Unless you consume it into the docs, there's no point to add it.", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r529585129", "createdAt": "2020-11-24T14:26:51Z", "author": {"login": "costin"}, "path": "x-pack/plugin/sql/qa/server/src/main/resources/filter.sql-spec", "diffHunk": "@@ -22,6 +22,10 @@ whereFieldAndComparison\n // tag::whereFieldAndComparison\n SELECT last_name l FROM \"test_emp\" WHERE emp_no > 10000 AND emp_no < 10005 ORDER BY emp_no LIMIT 5;\n // end::whereFieldAndComparison\n+whereGreaterThanAndNotEqualityOnDifferentFields\n+// tag::whereGreaterThanAndNotEqualityOnDifferentFields\n+SELECT last_name l FROM \"test_emp\" WHERE salary >= 50000 AND emp_no != 10002 ORDER BY emp_no LIMIT 5;\n+// end::whereGreaterThanAndNotEqualityOnDifferentFields", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7b75a8b0b2926c400e0bfbab3f75d7604f1eb7a8"}, "originalPosition": 7}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7631a28c9d1960955891c0a033a2347fb7a3176a", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/7631a28c9d1960955891c0a033a2347fb7a3176a", "committedDate": "2020-11-24T14:36:35Z", "message": "Cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d6b31bcde88072d1bc3523b4f403f21eca0177c3", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/d6b31bcde88072d1bc3523b4f403f21eca0177c3", "committedDate": "2020-11-24T15:35:21Z", "message": "Merge remote-tracking branch 'origin/master' into fix/65322"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NjQwNDAx", "url": "https://github.com/elastic/elasticsearch/pull/65331#pullrequestreview-537640401", "createdAt": "2020-11-24T15:39:40Z", "commit": {"oid": "d6b31bcde88072d1bc3523b4f403f21eca0177c3"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozOTo0MFrOH5HWnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0yNFQxNTozOTo0MFrOH5HWnQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyOTY1MTM1Nw==", "bodyText": "Use TestUtils.fieldAttribute()", "url": "https://github.com/elastic/elasticsearch/pull/65331#discussion_r529651357", "createdAt": "2020-11-24T15:39:40Z", "author": {"login": "costin"}, "path": "x-pack/plugin/ql/src/test/java/org/elasticsearch/xpack/ql/optimizer/OptimizerRulesTests.java", "diffHunk": "@@ -140,7 +143,11 @@ private static FieldAttribute getFieldAttribute() {\n     }\n \n     private static FieldAttribute getFieldAttribute(String name) {\n-        return new FieldAttribute(EMPTY, name, new EsField(name + \"f\", INTEGER, emptyMap(), true));\n+        return getFieldAttribute(name, INTEGER);\n+    }\n+\n+    private static FieldAttribute getFieldAttribute(String name, DataType dataType) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d6b31bcde88072d1bc3523b4f403f21eca0177c3"}, "originalPosition": 26}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f7bd1b81c31a850c7394e19bc72bcdb2d9b2f332", "author": {"user": {"login": "palesz", "name": "Andras Palinkas"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7bd1b81c31a850c7394e19bc72bcdb2d9b2f332", "committedDate": "2020-11-24T15:45:18Z", "message": "merge fix"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTM3NzA2ODQx", "url": "https://github.com/elastic/elasticsearch/pull/65331#pullrequestreview-537706841", "createdAt": "2020-11-24T16:43:40Z", "commit": {"oid": "f7bd1b81c31a850c7394e19bc72bcdb2d9b2f332"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 927, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}