{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDgyOTA5MjAy", "number": 62173, "title": "Improve Snapshot Abort Efficiency", "bodyText": "There is no need to let snapshots that haven't yet written anything to the repo\nfinalize with FAILED. When we still had the INIT state we would also just remove\nthese snapshots from the state without any further action.\nThis is not just a theoretical optimization. Currently, the situation of having a lot of\nqueued up snapshots is fairly complicated to resolve when all the queued shards move to aborted\nsince it is now necessary to execute tasks on the SNAPSHOT pool (that might be very busy) to\nremove the snapshot from the CS (including a number of redundant CS updates and repo writes\nfor finalizing these snapshots before deleting them right away after).\nDraft because I want to clean up the logic a little still", "createdAt": "2020-09-09T15:01:51Z", "url": "https://github.com/elastic/elasticsearch/pull/62173", "merged": true, "mergeCommit": {"oid": "7bb81be79ae38d1659a61eb17935ab4374f489cb"}, "closed": true, "closedAt": "2020-09-14T12:10:43Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdHNeYFgH2gAyNDgyOTA5MjAyOjJiNGE2YTcwZjA0MGVmMWI5ZTQ0MWFiYWFmYjdkMjBlNmY3N2MwNzU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdIxcKGAH2gAyNDgyOTA5MjAyOjM3MjM5NGMzZTQ3M2E3ODk4ZDQwMjE2NDM5ZDEwY2NmMzBlMDUxYWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b4a6a70f040ef1b9e441abaafb7d20e6f77c075", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b4a6a70f040ef1b9e441abaafb7d20e6f77c075", "committedDate": "2020-09-09T14:56:39Z", "message": "Improve Snapshot Abort Efficiency\n\nThere is no need to let snapshots that haven't yet written anything to the repo\nfinalize with `FAILED`. When we still had the `INIT` state we would also just remove\nthese snapshots from the state without any further action.\n\nThis is not just a theoretical optimization. Currently, the situation of having a lot of\nqueued up snapshots is fairly complicated to resolve when all the queued shards move to aborted\nsince it is now necessary to execute tasks on the `SNAPSHOT` pool (that might be very busy) to\nremove the snapshot from the CS (including a number of redundant CS updates and repo writes\nfor finalizing these snapshots before deleting them right away after)."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "28a82720ad91ff8c22f15ed4c19e2e8b0c17d1de", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/28a82720ad91ff8c22f15ed4c19e2e8b0c17d1de", "committedDate": "2020-09-13T20:55:11Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5eee2692a0dcf0950111cf49661c8cff67208c91", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/5eee2692a0dcf0950111cf49661c8cff67208c91", "committedDate": "2020-09-13T21:43:24Z", "message": "shorter and faster"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "272e4aa73fd32b5b2dd5d090bec1afa6990f0132", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/272e4aa73fd32b5b2dd5d090bec1afa6990f0132", "committedDate": "2020-09-14T08:07:26Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg3NjM4OTc1", "url": "https://github.com/elastic/elasticsearch/pull/62173#pullrequestreview-487638975", "createdAt": "2020-09-14T10:54:39Z", "commit": {"oid": "272e4aa73fd32b5b2dd5d090bec1afa6990f0132"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMDo1NDozOVrOHROZIA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNFQxMDo1NDozOVrOHROZIA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4NzgyMzY0OA==", "bodyText": "typos", "url": "https://github.com/elastic/elasticsearch/pull/62173#discussion_r487823648", "createdAt": "2020-09-14T10:54:39Z", "author": {"login": "tlrx"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1141,7 +1142,13 @@ public void deleteSnapshots(final DeleteSnapshotRequest request, final ActionLis\n \n             private boolean reusedExistingDelete = false;\n \n-            private final Collection<SnapshotsInProgress.Entry> completedSnapshots = new ArrayList<>();\n+            // Snapshots that had all of their shard snapshots in queued state and thus were removed from the\n+            // cluster state right away\n+            private final Collection<Snapshot> completedNoCleanup = new ArrayList<>();\n+\n+            // Snapshots that were aborted and that already wrote data to the repository and now have to be deleted\n+            // from teh repository after the clsuter state update", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "272e4aa73fd32b5b2dd5d090bec1afa6990f0132"}, "originalPosition": 18}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "162adc8b6c51e6866827117b5fc7603d60e588eb", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/162adc8b6c51e6866827117b5fc7603d60e588eb", "committedDate": "2020-09-14T11:23:36Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-completely-empty-snapshots-without-io"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "372394c3e473a7898d40216439d10ccf30e051ad", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/372394c3e473a7898d40216439d10ccf30e051ad", "committedDate": "2020-09-14T11:24:44Z", "message": "CR: typos"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4650, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}