{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5NDQ4NTU4", "number": 65584, "title": "[Transform] use ISO dates in output instead of epoch millis", "bodyText": "Transform writes dates as epoch millis, this does not work for historic data in some cases or is unsupported. Dates should be written as such. With this PR transform starts writing dates in ISO format, but as existing transform might rely on the format it provides backwards compatibility for old jobs as well as a setting to write dates as epoch millis.\nfixes #63787\nExample\nThe following example illustrates the change, we use the following config for pivot (dataset: kibana_sample_data_logs):\n  \"pivot\": {\n    \"group_by\": {\n      \"@timestamp\": {\n        \"date_histogram\": {\n          \"field\": \"@timestamp\",\n          \"calendar_interval\": \"1m\"\n        }\n      }\n    },\n    \"aggregations\": {\n      \"latest_timestamp\": {\n        \"max\": {\n          \"field\": \"@timestamp\"\n        }\n      },\n      \"agent_dc\": {\n        \"cardinality\": {\n          \"field\": \"agent.keyword\"\n        }\n      }\n    }\n\nThe change affects how @timestamp is written in _source (note: dates in the aggs part are already written as ISO string, with the change dates in pivot.group_by and pivot.aggregations behave consistently):\nBefore\n        \"_index\" : \"t3\",\n        \"_id\" : \"ANAnyse5SVpHo-UXL4f8598AAAAAAAAA\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"@timestamp\" : 1606005540000,\n          \"latest_timestamp\" : \"2020-11-22T00:39:02.912Z\",\n          \"agent_dc\" : 1\n        }\n\nAfter\n        \"_index\" : \"t4\",\n        \"_id\" : \"ANAnyse5SVpHo-UXL4f8598AAAAAAAAA\",\n        \"_score\" : 1.0,\n        \"_source\" : {\n          \"@timestamp\" : \"2020-11-22T00:39:00.000Z\",\n          \"latest_timestamp\" : \"2020-11-22T00:39:02.912Z\",\n          \"agent_dc\" : 1\n        }\n\nDoc values do not change, because either way it is parsed as date (but parsing can't fail anymore if dates <1970).\nIn case you rely on the old format (because you use the produced _source in an application), you can get back the old style with:\n  \"settings\": {\n    \"dates_as_epoch_millis\": true\n  }\n\nWhen updating an old transform using _update, this is automatically set. If you want to migrate an old transform to the new style, you can use _update to explicitly set dates_as_epoch_millis to false or null (== default).\nDocs preview for the added parameter: https://elasticsearch_65584.docs-preview.app.elstc.co/diff\nPost PR actions:\n\n document change in \"Breaking changes\" for 7.11\n BWC", "createdAt": "2020-11-30T10:27:18Z", "url": "https://github.com/elastic/elasticsearch/pull/65584", "merged": true, "mergeCommit": {"oid": "9b478891536a8bc30a9e496eba6a2cc8718ddad0"}, "closed": true, "closedAt": "2020-12-07T14:34:29Z", "author": {"login": "hendrikmuhs"}, "timelineItems": {"totalCount": 20, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdhj8w3gH2gAyNTI5NDQ4NTU4OjkwNDg1NGZhYmFiMzhlOGY3MjdhYjk4OTJlYWQ0NDFiMjRlZjE2YWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdj0-B2AH2gAyNTI5NDQ4NTU4OjIzMzAxYmE3YzAyYzcwODQ4ZmI4MThhN2NmOGNkN2I2YTBiNzYzY2I=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "904854fabab38e8f727ab9892ead441b24ef16ad", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/904854fabab38e8f727ab9892ead441b24ef16ad", "committedDate": "2020-11-30T11:49:47Z", "message": "write dates in ISO format, provide backwards compatibility for old jobs and old behavior\n\nfixes #63787"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "56a0ba54d5717dc745eb354290c8a5806e3ffd91", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/56a0ba54d5717dc745eb354290c8a5806e3ffd91", "committedDate": "2020-11-30T11:49:47Z", "message": "adapt rest tests"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4f2f197554b1b8294a0edc9c96c22f93b364021c", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/4f2f197554b1b8294a0edc9c96c22f93b364021c", "committedDate": "2020-11-30T11:20:47Z", "message": "adapt rest tests"}, "afterCommit": {"oid": "56a0ba54d5717dc745eb354290c8a5806e3ffd91", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/56a0ba54d5717dc745eb354290c8a5806e3ffd91", "committedDate": "2020-11-30T11:49:47Z", "message": "adapt rest tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49d683c4213d052785e975274fa3e8259755de3e", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/49d683c4213d052785e975274fa3e8259755de3e", "committedDate": "2020-11-30T14:29:05Z", "message": "improve doc strings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a28309546717427d92822ae35d7ad76666daef28", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/a28309546717427d92822ae35d7ad76666daef28", "committedDate": "2020-11-30T15:19:20Z", "message": "document changes"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4e1ad7f4450bb29ffa502ca102348f09f0127195", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/4e1ad7f4450bb29ffa502ca102348f09f0127195", "committedDate": "2020-12-01T10:26:43Z", "message": "rename parameter to dates_as_epoch_millis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2fd4c51b4cd8f689f32726f40fce19072c01b833", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/2fd4c51b4cd8f689f32726f40fce19072c01b833", "committedDate": "2020-12-01T11:00:42Z", "message": "fix leftover renamings"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a3a7646b652a5514729cf6852d1b4000860e6d65", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/a3a7646b652a5514729cf6852d1b4000860e6d65", "committedDate": "2020-12-01T11:02:48Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3befde0a9a6b981e714d020503cf389b4fa9977", "committedDate": "2020-12-01T11:10:40Z", "message": "fix docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQyNjQxMTQ0", "url": "https://github.com/elastic/elasticsearch/pull/65584#pullrequestreview-542641144", "createdAt": "2020-12-02T09:25:32Z", "commit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "state": "COMMENTED", "comments": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOToyNTozMlrOH9Rrww==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQwOTo0NDo1NVrOH9SgJA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNDkxNQ==", "bodyText": "Shouldn't it be plural here as well?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534014915", "createdAt": "2020-12-02T09:25:32Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -64,6 +65,8 @@\n \n     private static final Map<String, BucketKeyExtractor> BUCKET_KEY_EXTRACTOR_MAP;\n     private static final BucketKeyExtractor DEFAULT_BUCKET_KEY_EXTRACTOR = new DefaultBucketKeyExtractor();\n+    private static final BucketKeyExtractor DATE_AS_EPOCH_BUCKET_KEY_EXTRACTOR = new DateAsEpochBucketKeyExtractor();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxNzA0Ng==", "bodyText": "You use formatMillis here for formatting but in the line above you check that the type is DateFieldMapper.DATE_NANOS_CONTENT_TYPE.\nPlease double-check it works as expected in case of nanos.", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534017046", "createdAt": "2020-12-02T09:28:33Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {\n \n+        @Override\n+        public Object value(Object key, String type) {\n+            if (isNumericType(type) && key instanceof Double) {\n+                return dropFloatingPointComponentIfTypeRequiresIt(type, (Double) key);\n+            } else if ((DateFieldMapper.CONTENT_TYPE.equals(type) || DateFieldMapper.DATE_NANOS_CONTENT_TYPE.equals(type))\n+                && key instanceof Long) {\n+                    return DateFieldMapper.DEFAULT_DATE_TIME_FORMATTER.formatMillis((Long) key);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 60}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxODY2Nw==", "bodyText": "Would this class benefit from unit tests or is the current coverage enough?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534018667", "createdAt": "2020-12-02T09:30:51Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/src/main/java/org/elasticsearch/xpack/transform/transforms/pivot/AggregationResultUtils.java", "diffHunk": "@@ -409,6 +416,22 @@ public Object value(Object key, String type) {\n \n     static class DefaultBucketKeyExtractor implements BucketKeyExtractor {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAxOTY3Mg==", "bodyText": "datesAsEpochMillis?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534019672", "createdAt": "2020-12-02T09:32:20Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMDg5Mw==", "bodyText": "Why is this the only test that does it? Wouldn't it be applicable for example for DateHistogramGroupByOtherTimeFieldIT.java as well?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534020893", "createdAt": "2020-12-02T09:34:11Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/transform/qa/single-node-tests/src/javaRestTest/java/org/elasticsearch/xpack/transform/integration/continuous/DateHistogramGroupByIT.java", "diffHunk": "@@ -43,15 +43,21 @@\n         .format(Instant.ofEpochMilli(42));\n \n     private final boolean missing;\n+    private final boolean dateAsEpochMillis;\n \n     public DateHistogramGroupByIT() {\n         missing = randomBoolean();\n+        dateAsEpochMillis = randomBoolean();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 24}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzY4NQ==", "bodyText": "Do you mean it to stay or was it just for debug?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023685", "createdAt": "2020-12-02T09:38:17Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -111,12 +149,19 @@ public boolean equals(Object other) {\n         }\n \n         SettingsConfig that = (SettingsConfig) other;\n-        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize) && Objects.equals(docsPerSecond, that.docsPerSecond);\n+        return Objects.equals(maxPageSearchSize, that.maxPageSearchSize)\n+            && Objects.equals(docsPerSecond, that.docsPerSecond)\n+            && Objects.equals(datesAsEpochMillis, that.datesAsEpochMillis);\n     }\n \n     @Override\n     public int hashCode() {\n-        return Objects.hash(maxPageSearchSize, docsPerSecond);\n+        return Objects.hash(maxPageSearchSize, docsPerSecond, datesAsEpochMillis);\n+    }\n+\n+    @Override\n+    public String toString() {\n+        return Strings.toString(this, true, true) + \" wdaem: \" + this.datesAsEpochMillis;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 126}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyMzc5Nw==", "bodyText": "plural?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534023797", "createdAt": "2020-12-02T09:38:25Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -126,13 +171,12 @@ public static SettingsConfig fromXContent(final XContentParser parser, boolean l\n     public static class Builder {\n         private Integer maxPageSearchSize;\n         private Float docsPerSecond;\n+        private Integer dateAsEpochMilli;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 134}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNTI4NA==", "bodyText": "Is this deprecation related to handling dates?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534025284", "createdAt": "2020-12-02T09:40:30Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -449,12 +449,17 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n         // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        if (transformConfig.getVersion() != null\n+            && transformConfig.getVersion().onOrAfter(Version.V_8_0_0) // todo: V_7_11_0\n+            && (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 18}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjQ5Mg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026492", "createdAt": "2020-12-02T09:42:16Z", "author": {"login": "przemekwitek"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -77,6 +82,15 @@ public void testExplicitNullOnWriteParser() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = fromString(\"{\\\"dates_as_epoch_millis\\\" : null}\");\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyNjcyNg==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertNull(emptyConfig.getDatesAsEpochMillis());\n          \n          \n            \n                    assertNull(config.getDatesAsEpochMillis());", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534026726", "createdAt": "2020-12-02T09:42:38Z", "author": {"login": "przemekwitek"}, "path": "client/rest-high-level/src/test/java/org/elasticsearch/client/transform/transforms/SettingsConfigTests.java", "diffHunk": "@@ -100,6 +116,16 @@ public void testExplicitNullOnWriteBuilder() throws IOException {\n         settingsAsMap = xContentToMap(config);\n         assertThat(settingsAsMap.getOrDefault(\"max_page_search_size\", \"not_set\"), equalTo(\"not_set\"));\n         assertNull(settingsAsMap.getOrDefault(\"docs_per_second\", \"not_set\"));\n+        assertThat(settingsAsMap.getOrDefault(\"dates_as_epoch_millis\", \"not_set\"), equalTo(\"not_set\"));\n+\n+        config = new SettingsConfig.Builder().setDatesAsEpochMilli(null).build();\n+        // returns null, however it's `null` as in \"use default\"\n+        assertNull(emptyConfig.getDatesAsEpochMillis());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyODA5MQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            Defines if dates in the ouput should be written as ISO formated string (default)\n          \n          \n            \n            Defines if dates in the ouput should be written as ISO formatted string (default)", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534028091", "createdAt": "2020-12-02T09:44:37Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -965,6 +965,13 @@ adjusted to a lower value. The minimum value is `10` and the maximum is `10,000`\n The default value is `500`.\n end::transform-settings-max-page-search-size[]\n \n+tag::transform-settings-dates-as-epoch-milli[]\n+Defines if dates in the ouput should be written as ISO formated string (default)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 20}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDAyODMyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            before version `7.11`. For compatible output set this to true.\n          \n          \n            \n            before version `7.11`. For compatible output set this to `true`.", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r534028324", "createdAt": "2020-12-02T09:44:55Z", "author": {"login": "przemekwitek"}, "path": "docs/reference/rest-api/common-parms.asciidoc", "diffHunk": "@@ -965,6 +965,13 @@ adjusted to a lower value. The minimum value is `10` and the maximum is `10,000`\n The default value is `500`.\n end::transform-settings-max-page-search-size[]\n \n+tag::transform-settings-dates-as-epoch-milli[]\n+Defines if dates in the ouput should be written as ISO formated string (default)\n+or as millis since epoch. `epoch_millis` has been the default for transforms created\n+before version `7.11`. For compatible output set this to true.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c3befde0a9a6b981e714d020503cf389b4fa9977"}, "originalPosition": 22}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f06088fafd308ff4af1ccf5446ed4b3d55c9f754", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/f06088fafd308ff4af1ccf5446ed4b3d55c9f754", "committedDate": "2020-12-04T10:08:32Z", "message": "address review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d59abcda114a2c929a91abc4bdb169d01895e7bf", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/d59abcda114a2c929a91abc4bdb169d01895e7bf", "committedDate": "2020-12-04T11:59:44Z", "message": "add comment about date_nanos"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bc2575780304de3a6440bb968d36c462f4c20d08", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/bc2575780304de3a6440bb968d36c462f4c20d08", "committedDate": "2020-12-04T12:07:06Z", "message": "checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "54024270d67c479471833d116b3ce6f4efca4096", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/54024270d67c479471833d116b3ce6f4efca4096", "committedDate": "2020-12-04T13:44:01Z", "message": "add more tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2dd63bd9661126fc9cbb30a873c65229c2314242", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/2dd63bd9661126fc9cbb30a873c65229c2314242", "committedDate": "2020-12-04T14:13:52Z", "message": "Merge branch 'master' into transform-date-not-epoch"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ1MDE0OTUy", "url": "https://github.com/elastic/elasticsearch/pull/65584#pullrequestreview-545014952", "createdAt": "2020-12-04T14:39:30Z", "commit": {"oid": "2dd63bd9661126fc9cbb30a873c65229c2314242"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee7103a30599baed6505eb0a596f53eadbb10ff8", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee7103a30599baed6505eb0a596f53eadbb10ff8", "committedDate": "2020-12-04T16:23:15Z", "message": "fix order (alphabetical)"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/113db1b1c0e59c67255b9ba1e2013efcb1d2c44c", "committedDate": "2020-12-07T08:30:35Z", "message": "fix parameter name and remove debug code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ2MTA2ODQ5", "url": "https://github.com/elastic/elasticsearch/pull/65584#pullrequestreview-546106849", "createdAt": "2020-12-07T12:36:01Z", "commit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozNjowMVrOIAkt-g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wN1QxMjozOTozMFrOIAk1xQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3MjUwNg==", "bodyText": "nit:  Could this constructor reuse the other one?\nthis(maxPageSearchSize, docsPerSecond, datesAsEpochMillis == null ? null : datesAsEpochMillis ? 1 : 0);\n\n?", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537472506", "createdAt": "2020-12-07T12:36:01Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/SettingsConfig.java", "diffHunk": "@@ -28,33 +31,54 @@\n \n     private static final int DEFAULT_MAX_PAGE_SEARCH_SIZE = -1;\n     private static final float DEFAULT_DOCS_PER_SECOND = -1F;\n+    private static final int DEFAULT_DATES_AS_EPOCH_MILLIS = -1;\n \n     private static ConstructingObjectParser<SettingsConfig, Void> createParser(boolean lenient) {\n         ConstructingObjectParser<SettingsConfig, Void> parser = new ConstructingObjectParser<>(\n             \"transform_config_settings\",\n             lenient,\n-            args -> new SettingsConfig((Integer) args[0], (Float) args[1])\n+            args -> new SettingsConfig((Integer) args[0], (Float) args[1], (Integer) args[2])\n         );\n         parser.declareIntOrNull(optionalConstructorArg(), DEFAULT_MAX_PAGE_SEARCH_SIZE, TransformField.MAX_PAGE_SEARCH_SIZE);\n         parser.declareFloatOrNull(optionalConstructorArg(), DEFAULT_DOCS_PER_SECOND, TransformField.DOCS_PER_SECOND);\n+        // this boolean requires 4 possible values: true, false, not_specified, default, therefore using a custom parser\n+        parser.declareField(\n+            optionalConstructorArg(),\n+            p -> p.currentToken() == XContentParser.Token.VALUE_NULL ? DEFAULT_DATES_AS_EPOCH_MILLIS : p.booleanValue() ? 1 : 0,\n+            TransformField.DATES_AS_EPOCH_MILLIS,\n+            ValueType.BOOLEAN_OR_NULL\n+        );\n         return parser;\n     }\n \n     private final Integer maxPageSearchSize;\n     private final Float docsPerSecond;\n+    private final Integer datesAsEpochMillis;\n \n     public SettingsConfig() {\n-        this(null, null);\n+        this(null, null, (Integer) null);\n     }\n \n-    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond) {\n+    public SettingsConfig(Integer maxPageSearchSize, Float docsPerSecond, Boolean datesAsEpochMillis) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNzQ3NDUwMQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    // quick checks(optimization) if a rewrite is required, if none found just return the original\n          \n          \n            \n                    // quick checks (optimization) if a rewrite is required, if none found just return the original", "url": "https://github.com/elastic/elasticsearch/pull/65584#discussion_r537474501", "createdAt": "2020-12-07T12:39:30Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/transform/transforms/TransformConfig.java", "diffHunk": "@@ -440,37 +440,63 @@ public static TransformConfig fromXContent(final XContentParser parser, @Nullabl\n     }\n \n     /**\n-     * Rewrites the transform config according to the latest format, for example moving deprecated\n-     * settings to its new place.\n+     * Rewrites the transform config according to the latest format.\n+     *\n+     * Operations cover:\n+     *\n+     *  - move deprecated settings to its new place\n+     *  - change configuration options so it stays compatible (given a newer version)\n      *\n      * @param transformConfig original config\n      * @return a rewritten transform config if a rewrite was necessary, otherwise the given transformConfig\n      */\n     public static TransformConfig rewriteForUpdate(final TransformConfig transformConfig) {\n \n-        // quick checks for deprecated features, if none found just return the original\n-        if (transformConfig.getPivotConfig() == null || transformConfig.getPivotConfig().getMaxPageSearchSize() == null) {\n+        // quick checks(optimization) if a rewrite is required, if none found just return the original", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "113db1b1c0e59c67255b9ba1e2013efcb1d2c44c"}, "originalPosition": 31}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "23301ba7c02c70848fb818a7cf8cd7b6a0b763cb", "author": {"user": {"login": "hendrikmuhs", "name": "Hendrik Muhs"}}, "url": "https://github.com/elastic/elasticsearch/commit/23301ba7c02c70848fb818a7cf8cd7b6a0b763cb", "committedDate": "2020-12-07T12:47:24Z", "message": "apply review suggestion"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4344, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}