{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDY0MTIzODky", "number": 60830, "title": "Add boolean values script fields", "bodyText": "This adds boolean values runtime_script fields.", "createdAt": "2020-08-06T16:10:48Z", "url": "https://github.com/elastic/elasticsearch/pull/60830", "merged": true, "mergeCommit": {"oid": "07bfa51ac703341238ca06e03022daa5f01b0c9a"}, "closed": true, "closedAt": "2020-08-17T17:40:27Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc8SJBYgH2gAyNDY0MTIzODkyOmY1ZDExM2E2ZDgzOTU4YjI4ZmUzNDEyYTMxZDQ0NzIyNmU2M2ZhMTA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc_0uTagH2gAyNDY0MTIzODkyOjIxYTgxMGY4NjhhNDFlNDk2Mjc1MDkwNDI5YzA3ZGExMTJmM2U2ZDU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5d113a6d83958b28fe3412a31d447226e63fa10", "committedDate": "2020-08-06T16:09:41Z", "message": "Add boolean values script fields\n\nThis adds `boolean` values `runtime_script` fields."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYyNjY3NjAy", "url": "https://github.com/elastic/elasticsearch/pull/60830#pullrequestreview-462667602", "createdAt": "2020-08-06T16:11:59Z", "commit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoxMTo1OVrOG86e7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNlQxNjoxMTo1OVrOG86e7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNTkzMg==", "bodyText": "I'm trying to mimic what we support in core. It works, so far as I can tell. It is kind of amazing we allow this at all, but we do!", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r466525932", "createdAt": "2020-08-06T16:11:59Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptBooleanMappedFieldType.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.index.mapper.BooleanFieldMapper;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptBooleanFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldTermQuery;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public class ScriptBooleanMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final BooleanScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptBooleanMappedFieldType(String name, Script script, BooleanScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return BooleanFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n+        if (format != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom formats\");\n+        }\n+        if (timeZone != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom time zones\");\n+        }\n+        return DocValueFormat.BOOLEAN;\n+    }\n+\n+    @Override\n+    public ScriptBooleanFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n+        return new ScriptBooleanFieldData.Builder(name(), leafFactory(searchLookup.get()));\n+    }\n+\n+    private BooleanScriptFieldScript.LeafFactory leafFactory(SearchLookup searchLookup) {\n+        return scriptFactory.newFactory(script.getParams(), searchLookup);\n+    }\n+\n+    @Override\n+    public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);\n+        return new BooleanScriptFieldExistsQuery(script, leafFactory(context.lookup()), name());\n+    }\n+\n+    @Override\n+    public Query rangeQuery(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "originalPosition": 74}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDY3NDQ3NTU5", "url": "https://github.com/elastic/elasticsearch/pull/60830#pullrequestreview-467447559", "createdAt": "2020-08-14T09:46:17Z", "commit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwOTo0NjoxN1rOHAuhhg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0xNFQwOTo0ODozNVrOHAulsw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDI5NA==", "bodyText": "I must say that multiple values for booleans look really weird, especially trying to summarize multiple values into one, and re-sorting them. Is this behaviour documented anywhere?", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470524294", "createdAt": "2020-08-14T09:46:17Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptBooleanDocValues.java", "diffHunk": "@@ -0,0 +1,39 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.elasticsearch.index.fielddata.AbstractSortedNumericDocValues;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+\n+import java.io.IOException;\n+\n+public final class ScriptBooleanDocValues extends AbstractSortedNumericDocValues {\n+    private final BooleanScriptFieldScript script;\n+    private int cursor;\n+\n+    ScriptBooleanDocValues(BooleanScriptFieldScript script) {\n+        this.script = script;\n+    }\n+\n+    @Override\n+    public boolean advanceExact(int docId) {\n+        script.runForDoc(docId);\n+        cursor = 0;\n+        return script.trues() > 0 || script.falses() > 0;\n+    }\n+\n+    @Override\n+    public long nextValue() throws IOException {\n+        // Emit all false values before all true values\n+        return cursor++ < script.falses() ? 0 : 1;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNDU4Ng==", "bodyText": "I never realized this either: booleans are double????", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470524586", "createdAt": "2020-08-14T09:46:58Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/fielddata/ScriptBooleanFieldData.java", "diffHunk": "@@ -0,0 +1,99 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.fielddata;\n+\n+import org.apache.lucene.index.LeafReaderContext;\n+import org.apache.lucene.index.SortedNumericDocValues;\n+import org.elasticsearch.ExceptionsHelper;\n+import org.elasticsearch.index.fielddata.IndexFieldData;\n+import org.elasticsearch.index.fielddata.IndexFieldDataCache;\n+import org.elasticsearch.index.fielddata.IndexNumericFieldData;\n+import org.elasticsearch.index.fielddata.plain.LeafLongFieldData;\n+import org.elasticsearch.index.mapper.MapperService;\n+import org.elasticsearch.indices.breaker.CircuitBreakerService;\n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+\n+import java.io.IOException;\n+\n+public final class ScriptBooleanFieldData extends IndexNumericFieldData {\n+\n+    public static class Builder implements IndexFieldData.Builder {\n+        private final String name;\n+        private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+\n+        public Builder(String name, BooleanScriptFieldScript.LeafFactory leafFactory) {\n+            this.name = name;\n+            this.leafFactory = leafFactory;\n+        }\n+\n+        @Override\n+        public ScriptBooleanFieldData build(IndexFieldDataCache cache, CircuitBreakerService breakerService, MapperService mapperService) {\n+            return new ScriptBooleanFieldData(name, leafFactory);\n+        }\n+    }\n+\n+    private final String fieldName;\n+    private final BooleanScriptFieldScript.LeafFactory leafFactory;\n+\n+    private ScriptBooleanFieldData(String fieldName, BooleanScriptFieldScript.LeafFactory leafFactory) {\n+        this.fieldName = fieldName;\n+        this.leafFactory = leafFactory;\n+    }\n+\n+    @Override\n+    public String getFieldName() {\n+        return fieldName;\n+    }\n+\n+    @Override\n+    public ValuesSourceType getValuesSourceType() {\n+        return CoreValuesSourceType.BOOLEAN;\n+    }\n+\n+    @Override\n+    public ScriptBooleanLeafFieldData load(LeafReaderContext context) {\n+        try {\n+            return loadDirect(context);\n+        } catch (Exception e) {\n+            throw ExceptionsHelper.convertToElastic(e);\n+        }\n+    }\n+\n+    @Override\n+    public ScriptBooleanLeafFieldData loadDirect(LeafReaderContext context) throws IOException {\n+        return new ScriptBooleanLeafFieldData(new ScriptBooleanDocValues(leafFactory.newInstance(context)));\n+    }\n+\n+    @Override\n+    public NumericType getNumericType() {\n+        return NumericType.DOUBLE;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "originalPosition": 75}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTE5Nw==", "bodyText": "why do we throw? Shouldn't we borrow the logic from https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/index/mapper/BooleanFieldMapper.java#L157 ?", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470525197", "createdAt": "2020-08-14T09:48:12Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptBooleanMappedFieldType.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.index.mapper.BooleanFieldMapper;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptBooleanFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldTermQuery;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public class ScriptBooleanMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final BooleanScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptBooleanMappedFieldType(String name, Script script, BooleanScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return BooleanFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        throw new UnsupportedOperationException();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "originalPosition": 44}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3MDUyNTM2Mw==", "bodyText": "oh boy :)", "url": "https://github.com/elastic/elasticsearch/pull/60830#discussion_r470525363", "createdAt": "2020-08-14T09:48:35Z", "author": {"login": "javanna"}, "path": "x-pack/plugin/runtime-fields/src/main/java/org/elasticsearch/xpack/runtimefields/mapper/ScriptBooleanMappedFieldType.java", "diffHunk": "@@ -0,0 +1,202 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.runtimefields.mapper;\n+\n+import org.apache.lucene.search.MatchNoDocsQuery;\n+import org.apache.lucene.search.Query;\n+import org.apache.lucene.util.BytesRef;\n+import org.elasticsearch.common.lucene.search.Queries;\n+import org.elasticsearch.common.time.DateMathParser;\n+import org.elasticsearch.index.mapper.BooleanFieldMapper;\n+import org.elasticsearch.index.query.QueryShardContext;\n+import org.elasticsearch.script.Script;\n+import org.elasticsearch.search.DocValueFormat;\n+import org.elasticsearch.search.lookup.SearchLookup;\n+import org.elasticsearch.xpack.runtimefields.BooleanScriptFieldScript;\n+import org.elasticsearch.xpack.runtimefields.fielddata.ScriptBooleanFieldData;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldExistsQuery;\n+import org.elasticsearch.xpack.runtimefields.query.BooleanScriptFieldTermQuery;\n+\n+import java.time.ZoneId;\n+import java.util.List;\n+import java.util.Map;\n+import java.util.function.Supplier;\n+\n+public class ScriptBooleanMappedFieldType extends AbstractScriptMappedFieldType {\n+    private final BooleanScriptFieldScript.Factory scriptFactory;\n+\n+    ScriptBooleanMappedFieldType(String name, Script script, BooleanScriptFieldScript.Factory scriptFactory, Map<String, String> meta) {\n+        super(name, script, meta);\n+        this.scriptFactory = scriptFactory;\n+    }\n+\n+    @Override\n+    protected String runtimeType() {\n+        return BooleanFieldMapper.CONTENT_TYPE;\n+    }\n+\n+    @Override\n+    public Object valueForDisplay(Object value) {\n+        throw new UnsupportedOperationException();\n+    }\n+\n+    @Override\n+    public DocValueFormat docValueFormat(String format, ZoneId timeZone) {\n+        if (format != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom formats\");\n+        }\n+        if (timeZone != null) {\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support custom time zones\");\n+        }\n+        return DocValueFormat.BOOLEAN;\n+    }\n+\n+    @Override\n+    public ScriptBooleanFieldData.Builder fielddataBuilder(String fullyQualifiedIndexName, Supplier<SearchLookup> searchLookup) {\n+        return new ScriptBooleanFieldData.Builder(name(), leafFactory(searchLookup.get()));\n+    }\n+\n+    private BooleanScriptFieldScript.LeafFactory leafFactory(SearchLookup searchLookup) {\n+        return scriptFactory.newFactory(script.getParams(), searchLookup);\n+    }\n+\n+    @Override\n+    public Query existsQuery(QueryShardContext context) {\n+        checkAllowExpensiveQueries(context);\n+        return new BooleanScriptFieldExistsQuery(script, leafFactory(context.lookup()), name());\n+    }\n+\n+    @Override\n+    public Query rangeQuery(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NjUyNTkzMg=="}, "originalCommit": {"oid": "f5d113a6d83958b28fe3412a31d447226e63fa10"}, "originalPosition": 74}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "da4b24f70e7f7b77c0fac81386ebee9135ab63a4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/da4b24f70e7f7b77c0fac81386ebee9135ab63a4", "committedDate": "2020-08-17T14:41:57Z", "message": "Merge branch 'feature/runtime_fields' into script_field_boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97b51fbd42c92394fd599113697e8fbdd59f20d9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/97b51fbd42c92394fd599113697e8fbdd59f20d9", "committedDate": "2020-08-17T14:51:26Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9667b9c41d83845540b1f53a3c54d460915c67cf", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/9667b9c41d83845540b1f53a3c54d460915c67cf", "committedDate": "2020-08-17T14:57:32Z", "message": "Merge branch 'feature/runtime_fields' into script_field_boolean"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ce7b062d116414462c87d0af808b28b96595b73d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/ce7b062d116414462c87d0af808b28b96595b73d", "committedDate": "2020-08-17T14:58:28Z", "message": "Fixup after merge"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7173f5bde110507ba878f02f73766dbbb489e2e1", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7173f5bde110507ba878f02f73766dbbb489e2e1", "committedDate": "2020-08-17T15:10:29Z", "message": "Universal parsing"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "f7c099e087bda7af933c739420fac83385d364a9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/f7c099e087bda7af933c739420fac83385d364a9", "committedDate": "2020-08-17T15:57:36Z", "message": "Dualing queries"}, "afterCommit": {"oid": "21a810f868a41e496275090429c07da112f3e6d5", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/21a810f868a41e496275090429c07da112f3e6d5", "committedDate": "2020-08-17T16:08:57Z", "message": "Dualing queries"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "21a810f868a41e496275090429c07da112f3e6d5", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/21a810f868a41e496275090429c07da112f3e6d5", "committedDate": "2020-08-17T16:08:57Z", "message": "Dualing queries"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3442, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}