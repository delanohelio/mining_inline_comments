{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY0MDg4MjIw", "number": 51146, "title": "[ML] Add audit warning for 1000 categories found early in job", "bodyText": "If 1000 different category definitions are created for a job in\nthe first 100 buckets it processes then an audit warning will now\nbe created.  (This will cause a yellow warning triangle in the\nML UI's jobs list.)\nSuch a large number of categories suggests that the field that\ncategorization is working on is not well suited to the ML\ncategorization functionality.\nRelates #50749", "createdAt": "2020-01-17T11:05:28Z", "url": "https://github.com/elastic/elasticsearch/pull/51146", "merged": true, "mergeCommit": {"oid": "160a21230e96c2f650ed5561b54b9b280725c791"}, "closed": true, "closedAt": "2020-01-17T16:25:06Z", "author": {"login": "droberts195"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb7Mdz6gH2gAyMzY0MDg4MjIwOjhjMGQ4NzBiOGUwZmQ4Mzc2NWIyMzJkMGUxNzk4ZGRkY2Y1MmVlNDI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb7Q5LqAFqTM0NDY3NDU4OQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c0d870b8e0fd83765b232d0e1798dddcf52ee42", "committedDate": "2020-01-17T10:47:53Z", "message": "[ML] Add audit warning for 1000 categories found early in job\n\nIf 1000 different category definitions are created for a job in\nthe first 100 buckets it processes then an audit warning will now\nbe created.  (This will cause a yellow warning triangle in the\nML UI's jobs list.)\n\nSuch a large number of categories suggests that the field that\ncategorization is working on is not well suited to the ML\ncategorization functionality."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0NTMxMjg0", "url": "https://github.com/elastic/elasticsearch/pull/51146#pullrequestreview-344531284", "createdAt": "2020-01-17T11:54:25Z", "commit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMTo1NDoyNVrOFe23Vg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0xN1QxMjoyOToyOVrOFe3mKA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkwMDUwMg==", "bodyText": "We have square brackets about the second number in this message but not the first. Should we make it consistent?", "url": "https://github.com/elastic/elasticsearch/pull/51146#discussion_r367900502", "createdAt": "2020-01-17T11:54:25Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java", "diffHunk": "@@ -135,6 +135,8 @@\n             \"Adjust the analysis_limits.model_memory_limit setting to ensure all data is analyzed\";\n     public static final String JOB_AUDIT_MEMORY_STATUS_HARD_LIMIT_PRE_7_2 = \"Job memory status changed to hard_limit at {0}; adjust the \" +\n         \"analysis_limits.model_memory_limit setting to ensure all data is analyzed\";\n+    public static final String JOB_AUDIT_EXCESSIVE_EARLY_CATEGORIES = \"{0} categories observed in the first [{1}] buckets.\" +", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxMTYzMw==", "bodyText": "should we take this chance and make this a long as well? It seems like something that could hit overflow problems.", "url": "https://github.com/elastic/elasticsearch/pull/51146#discussion_r367911633", "createdAt": "2020-01-17T12:26:58Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -87,7 +90,9 @@\n     private final FlushListener flushListener;\n     private volatile boolean processKilled;\n     private volatile boolean failed;\n-    private int bucketCount; // only used from the process() thread, so doesn't need to be volatile\n+    private long priorRunsBucketCount;\n+    private int currentRunBucketCount; // only used from the process() thread, so doesn't need to be volatile", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxMTg0Ng==", "bodyText": "I was wondering where we'd get this from but it's cool we already pass it in!", "url": "https://github.com/elastic/elasticsearch/pull/51146#discussion_r367911846", "createdAt": "2020-01-17T12:27:36Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -122,6 +127,7 @@ public AutodetectResultProcessor(Client client,\n         this.bulkResultsPersister = persister.bulkPersisterBuilder(jobId, this::isAlive);\n         this.timingStatsReporter = new TimingStatsReporter(timingStats, bulkResultsPersister);\n         this.deleteInterimRequired = true;\n+        this.priorRunsBucketCount = timingStats.getBucketCount();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42"}, "originalPosition": 25}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2NzkxMjQ4OA==", "bodyText": "Now that all this has become more complex than a single call to the persister, I'd be tempted to extract this in a handleCategoryDefinition method.", "url": "https://github.com/elastic/elasticsearch/pull/51146#discussion_r367912488", "createdAt": "2020-01-17T12:29:29Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/output/AutodetectResultProcessor.java", "diffHunk": "@@ -225,6 +231,18 @@ void processResult(AutodetectResult result) {\n         CategoryDefinition categoryDefinition = result.getCategoryDefinition();\n         if (categoryDefinition != null) {\n             persister.persistCategoryDefinition(categoryDefinition, this::isAlive);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8c0d870b8e0fd83765b232d0e1798dddcf52ee42"}, "originalPosition": 68}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "30afa3fda2e7da682cc6b7f346ac7c136142cd54", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/30afa3fda2e7da682cc6b7f346ac7c136142cd54", "committedDate": "2020-01-17T14:44:06Z", "message": "Merge branch 'master' into excessive_categories_audit_message"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "69172d390eef916825eae84816d1665a5d75b984", "author": {"user": {"login": "droberts195", "name": "David Roberts"}}, "url": "https://github.com/elastic/elasticsearch/commit/69172d390eef916825eae84816d1665a5d75b984", "committedDate": "2020-01-17T14:57:51Z", "message": "Address review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ0Njc0NTg5", "url": "https://github.com/elastic/elasticsearch/pull/51146#pullrequestreview-344674589", "createdAt": "2020-01-17T15:57:24Z", "commit": {"oid": "69172d390eef916825eae84816d1665a5d75b984"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2971, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}