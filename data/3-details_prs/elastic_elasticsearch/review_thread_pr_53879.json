{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkxNTk5MDEx", "number": 53879, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0MDoyNlrODp6vOw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjozODoyMlrODp8F9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MjgwNTcxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo0MDoyNlrOF5Y7uQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo1NzoyNVrOF5ZnqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMTY1Nw==", "bodyText": "This class has been extracted from CacheDirectory as is, with the following modification:\n\nlogger moved to the base class (previously at the CacheDirectory level)\nCOPY_BUFFER_SIZE moved within the CacheBufferedIndexInput class (previously at the CacheDirectory level)\nCacheFileReference now explicitely calls directory.createCacheKey() and directory.getCacheFile()", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395721657", "createdAt": "2020-03-20T15:40:26Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjkwNQ==", "bodyText": "Thanks, that's very helpful :)", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395732905", "createdAt": "2020-03-20T15:57:25Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTcyMTY1Nw=="}, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 29}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1Mjg3MDI2OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/BaseSearchableSnapshotIndexInput.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNTo1NjozM1rOF5Zleg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjoyODo1MFrOF5a1Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjM0Ng==", "bodyText": "I would rather use a distinct (private) logger for each class if possible -- makes it that much easier to track down where messages are coming from.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395732346", "createdAt": "2020-03-20T15:56:33Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/BaseSearchableSnapshotIndexInput.java", "diffHunk": "@@ -19,6 +21,8 @@\n \n public abstract class BaseSearchableSnapshotIndexInput extends BufferedIndexInput {\n \n+    protected static final Logger logger = LogManager.getLogger(BaseSearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1MjcxMA==", "bodyText": "Makes sense", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395752710", "createdAt": "2020-03-20T16:28:50Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/BaseSearchableSnapshotIndexInput.java", "diffHunk": "@@ -19,6 +21,8 @@\n \n public abstract class BaseSearchableSnapshotIndexInput extends BufferedIndexInput {\n \n+    protected static final Logger logger = LogManager.getLogger(BaseSearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTczMjM0Ng=="}, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 13}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1Mjk0NTM0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjoxNjozN1rOF5aWVA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjoyOToyM1rOF5a2WA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NDg1Mg==", "bodyText": "Maybe make CacheFileReference a static class (top-level even) and pass the directory to its constructor? That would avoid needing to do this.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395744852", "createdAt": "2020-03-20T16:16:37Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {\n+\n+    private static final int COPY_BUFFER_SIZE = 8192;\n+\n+    private final CacheDirectory directory;\n+    private final long offset;\n+    private final long end;\n+    private final CacheFileReference cacheFileReference;\n+    private final IndexInputStats stats;\n+\n+    // the following are only mutable so they can be adjusted after cloning\n+    private AtomicBoolean closed;\n+    private boolean isClone;\n+\n+    // last read position is kept around in order to detect (non)contiguous reads for stats\n+    private long lastReadPosition;\n+    // last seek position is kept around in order to detect forward/backward seeks for stats\n+    private long lastSeekPosition;\n+\n+    CacheBufferedIndexInput(CacheDirectory directory, FileInfo fileInfo, IOContext context, IndexInputStats stats) {\n+        this(\"CachedBufferedIndexInput(\" + fileInfo.physicalName() + \")\", directory, fileInfo, context, stats, 0L, fileInfo.length(),\n+            false, null);\n+        stats.incrementOpenCount();\n+    }\n+\n+    private CacheBufferedIndexInput(String resourceDesc, CacheDirectory directory, FileInfo fileInfo, IOContext context,\n+                                    IndexInputStats stats, long offset, long length, boolean isClone,\n+                                    @Nullable CacheFileReference cacheFileReference) {\n+        super(resourceDesc, directory.blobContainer(), fileInfo, context);\n+        this.directory = directory;\n+        this.offset = offset;\n+        this.stats = stats;\n+        this.end = offset + length;\n+        this.closed = new AtomicBoolean(false);\n+        this.isClone = isClone;\n+        this.cacheFileReference = Objects.requireNonNullElseGet(cacheFileReference,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 64}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1MzA0OA==", "bodyText": "I must admit I hesitated between the two. I applied your opinion.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395753048", "createdAt": "2020-03-20T16:29:23Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/xpack/searchablesnapshots/cache/CacheBufferedIndexInput.java", "diffHunk": "@@ -0,0 +1,292 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.searchablesnapshots.cache;\n+\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.apache.lucene.store.AlreadyClosedException;\n+import org.apache.lucene.store.IOContext;\n+import org.apache.lucene.store.IndexInput;\n+import org.elasticsearch.common.Nullable;\n+import org.elasticsearch.common.SuppressForbidden;\n+import org.elasticsearch.common.io.Channels;\n+import org.elasticsearch.common.util.concurrent.ReleasableLock;\n+import org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardSnapshot.FileInfo;\n+import org.elasticsearch.index.store.BaseSearchableSnapshotIndexInput;\n+\n+import java.io.EOFException;\n+import java.io.IOException;\n+import java.io.InputStream;\n+import java.nio.ByteBuffer;\n+import java.nio.channels.FileChannel;\n+import java.util.Objects;\n+import java.util.concurrent.atomic.AtomicBoolean;\n+import java.util.concurrent.atomic.AtomicReference;\n+\n+public class CacheBufferedIndexInput extends BaseSearchableSnapshotIndexInput {\n+\n+    private static final int COPY_BUFFER_SIZE = 8192;\n+\n+    private final CacheDirectory directory;\n+    private final long offset;\n+    private final long end;\n+    private final CacheFileReference cacheFileReference;\n+    private final IndexInputStats stats;\n+\n+    // the following are only mutable so they can be adjusted after cloning\n+    private AtomicBoolean closed;\n+    private boolean isClone;\n+\n+    // last read position is kept around in order to detect (non)contiguous reads for stats\n+    private long lastReadPosition;\n+    // last seek position is kept around in order to detect forward/backward seeks for stats\n+    private long lastSeekPosition;\n+\n+    CacheBufferedIndexInput(CacheDirectory directory, FileInfo fileInfo, IOContext context, IndexInputStats stats) {\n+        this(\"CachedBufferedIndexInput(\" + fileInfo.physicalName() + \")\", directory, fileInfo, context, stats, 0L, fileInfo.length(),\n+            false, null);\n+        stats.incrementOpenCount();\n+    }\n+\n+    private CacheBufferedIndexInput(String resourceDesc, CacheDirectory directory, FileInfo fileInfo, IOContext context,\n+                                    IndexInputStats stats, long offset, long length, boolean isClone,\n+                                    @Nullable CacheFileReference cacheFileReference) {\n+        super(resourceDesc, directory.blobContainer(), fileInfo, context);\n+        this.directory = directory;\n+        this.offset = offset;\n+        this.stats = stats;\n+        this.end = offset + length;\n+        this.closed = new AtomicBoolean(false);\n+        this.isClone = isClone;\n+        this.cacheFileReference = Objects.requireNonNullElseGet(cacheFileReference,", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc0NDg1Mg=="}, "originalCommit": {"oid": "9215ccec85e9e0e849bfcf2a6603f26f11cb1b36"}, "originalPosition": 64}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ1MzAyNzc0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjozODoyMlrOF5bLbg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yMFQxNjo0MToyNlrOF5bSZQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODQ0Ng==", "bodyText": "This isn't used? I mean it probably will be in future, but I think I'd prefer to add it when it's needed.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395758446", "createdAt": "2020-03-20T16:38:22Z", "author": {"login": "DaveCTurner"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -48,6 +50,8 @@\n  */\n public class SearchableSnapshotIndexInput extends BaseSearchableSnapshotIndexInput {\n \n+    private static final Logger logger = LogManager.getLogger(SearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9028f8aab9124bbb928669ad65282858f3cb5fee"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc2MDIyOQ==", "bodyText": "\ud83e\udd26\u200d\u2642\ufe0f Thanks, I removed it.", "url": "https://github.com/elastic/elasticsearch/pull/53879#discussion_r395760229", "createdAt": "2020-03-20T16:41:26Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/main/java/org/elasticsearch/index/store/SearchableSnapshotIndexInput.java", "diffHunk": "@@ -48,6 +50,8 @@\n  */\n public class SearchableSnapshotIndexInput extends BaseSearchableSnapshotIndexInput {\n \n+    private static final Logger logger = LogManager.getLogger(SearchableSnapshotIndexInput.class);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NTc1ODQ0Ng=="}, "originalCommit": {"oid": "9028f8aab9124bbb928669ad65282858f3cb5fee"}, "originalPosition": 13}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4277, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}