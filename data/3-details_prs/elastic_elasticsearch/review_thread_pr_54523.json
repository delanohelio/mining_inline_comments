{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk2NDkxOTM0", "number": 54523, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoxMzo0NVrODwvj0w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzo0NDoxMVrODwwChw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNDM3NDU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "isResolved": true, "comments": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzoxMzo0NVrOGD6JKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxNDoyNzoxMlrOGD7_zw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ==", "bodyText": "Isn't this assertion risky? Could it not be the task has advanced state by this point?", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406751531", "createdAt": "2020-04-10T13:13:45Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1NTkyMg==", "bodyText": "You're right. I've removed this assertion and added waitUntilAnalyticsIsStopped instead.\nI'm wondering though what to do with an assertion in line 522. Do you think it is reasonable to expect it to be STARTING?", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406755922", "createdAt": "2020-04-10T13:25:24Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2Mzc5MQ==", "bodyText": "I thought that one made sense because the persistent task exists but it won't be assigned as upgrade mode was enabled. This the reported state should consistently be starting. Am I not reading this right?", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406763791", "createdAt": "2020-04-10T13:45:08Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2NDk4MA==", "bodyText": "I'm wondering if the state could advance between lines 513 (starting job) and 517. (pausing it with upgrade mode)", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406764980", "createdAt": "2020-04-10T13:48:11Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc3MDk4Mw==", "bodyText": "Perhaps you're right. You could manually test this by running a job and setting upgrade mode while it's past the starting state.", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406770983", "createdAt": "2020-04-10T14:01:59Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc4MTkwMw==", "bodyText": "I've just removed that state assertion too. Job state is not that important to verify in this test.\nUpgrade mode should work correctly for any job state, so I think there is no need asserting there.", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406781903", "createdAt": "2020-04-10T14:27:12Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,59 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc1MTUzMQ=="}, "originalCommit": {"oid": "fe0d161160627f9ab0b0233cc1a8fe2b10df4dd2"}, "originalPosition": 51}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjUyNDQ1MzE5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzo0NDoxMVrOGD63mQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xMFQxMzo0NjoxOVrOGD66wQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2MzQxNw==", "bodyText": "I'd say we don't need this assertion at all.", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406763417", "createdAt": "2020-04-10T13:44:11Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,68 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9158f23d693f59b783c03939b073a7b5a5fd8a3b"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2NDIyNQ==", "bodyText": "Done.", "url": "https://github.com/elastic/elasticsearch/pull/54523#discussion_r406764225", "createdAt": "2020-04-10T13:46:19Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/ClassificationIT.java", "diffHunk": "@@ -497,6 +501,68 @@ public void testTwoJobsWithSameRandomizeSeedUseSameTrainingSet() throws Exceptio\n         assertThat(secondRunTrainingRowsIds, equalTo(firstRunTrainingRowsIds));\n     }\n \n+    public void testSetUpgradeMode_ExistingTaskGetsUnassigned() throws Exception {\n+        initialize(\"classification_set_upgrade_mode\");\n+        indexData(sourceIndex, 300, 0, KEYWORD_FIELD);\n+\n+        assertThat(upgradeMode(), is(false));\n+\n+        DataFrameAnalyticsConfig config = buildAnalytics(jobId, sourceIndex, destIndex, null, new Classification(KEYWORD_FIELD));\n+        registerAnalytics(config);\n+        putAnalytics(config);\n+        startAnalytics(jobId);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        setUpgradeModeTo(true);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), is(empty()));\n+\n+        GetDataFrameAnalyticsStatsAction.Response.Stats analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(analyticsStats.getState(), is(equalTo(DataFrameAnalyticsState.STARTING)));\n+        assertThat(analyticsStats.getAssignmentExplanation(), is(equalTo(AWAITING_UPGRADE.getExplanation())));\n+        assertThat(analyticsStats.getNode(), is(nullValue()));\n+\n+        setUpgradeModeTo(false);\n+        assertThat(analyticsTaskList(), hasSize(1));\n+        assertThat(analyticsAssignedTaskList(), hasSize(1));\n+\n+        analyticsStats = getAnalyticsStats(jobId);\n+        assertThat(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwNjc2MzQxNw=="}, "originalCommit": {"oid": "9158f23d693f59b783c03939b073a7b5a5fd8a3b"}, "originalPosition": 51}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4015, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}