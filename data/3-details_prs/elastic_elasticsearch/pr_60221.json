{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3MjI5Nzc0", "number": 60221, "title": "[ML] Improve assertion on regression alias field test", "bodyText": "Previously the test was asserting the prediction on each document\nwas close 10.0 from the expected. It turned out that was not enough\nas we occasionally saw the test failing by little.\nInstead of relaxing that assertion, this commit changes it to\nassert the mean prediction error is less than 10.0. This should\nreduce the chances of the test failing significantly.\nFixes #60212", "createdAt": "2020-07-27T15:15:39Z", "url": "https://github.com/elastic/elasticsearch/pull/60221", "merged": true, "mergeCommit": {"oid": "0ace6ad7f3c06ea3f5cdcebb2d203334892054c2"}, "closed": true, "closedAt": "2020-07-28T08:05:31Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5DWT5gH2gAyNDU3MjI5Nzc0OjM3OGI2MjQyOWIxODg1NjhlODRiODNiNmE2ZTRjMjg4YjVhMGZmY2M=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5RmDdgFqTQ1NjM4NDYyMw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "378b62429b188568e84b83b6a6e4c288b5a0ffcc", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/378b62429b188568e84b83b6a6e4c288b5a0ffcc", "committedDate": "2020-07-27T15:13:51Z", "message": "[ML] Improve assertion on regression alias field test\n\nPreviously the test was asserting the prediction on each document\nwas close 10.0 from the expected. It turned out that was not enough\nas we occasionally saw the test failing by little.\n\nInstead of relaxing that assertion, this commit changes it to\nassert the mean prediction error is less than 10.0. This should\nreduce the chances of the test failing significantly.\n\nFixes #60212"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "84342b1cad1386c3bfa8887019f1ab07e63d892c", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/84342b1cad1386c3bfa8887019f1ab07e63d892c", "committedDate": "2020-07-27T15:33:20Z", "message": "Remove unused import"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2Mzg0NjIz", "url": "https://github.com/elastic/elasticsearch/pull/60221#pullrequestreview-456384623", "createdAt": "2020-07-28T07:49:37Z", "commit": {"oid": "84342b1cad1386c3bfa8887019f1ab07e63d892c"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0OTozN1rOG4AxOQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQwNzo0OTozN1rOG4AxOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTM4NjA0MQ==", "bodyText": "I'm wondering if we could drop the Math.abs here. This would of course increase the chance of the assertion in line 564 to pass but maybe it is not necessary.", "url": "https://github.com/elastic/elasticsearch/pull/60221#discussion_r461386041", "createdAt": "2020-07-28T07:49:37Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/qa/native-multi-node-tests/src/test/java/org/elasticsearch/xpack/ml/integration/RegressionIT.java", "diffHunk": "@@ -544,19 +543,26 @@ public void testAliasFields() throws Exception {\n         startAnalytics(jobId);\n         waitUntilAnalyticsIsStopped(jobId);\n \n+        double predictionErrorSum = 0.0;\n+\n         SearchResponse sourceData = client().prepareSearch(sourceIndex).setSize(totalDocCount).get();\n         for (SearchHit hit : sourceData.getHits()) {\n             Map<String, Object> destDoc = getDestDoc(config, hit);\n             Map<String, Object> resultsObject = getMlResultsObjectFromDestDoc(destDoc);\n \n-            int featureValue = (int) destDoc.get(\"field_1\");\n-            double predictionValue = (double) resultsObject.get(predictionField);\n-            assertThat(predictionValue, closeTo(2 * featureValue, 10.0));\n-\n             assertThat(resultsObject.containsKey(predictionField), is(true));\n             assertThat(resultsObject.containsKey(\"is_training\"), is(true));\n+\n+            int featureValue = (int) destDoc.get(\"field_1\");\n+            double predictionValue = (double) resultsObject.get(predictionField);\n+            predictionErrorSum += Math.abs(predictionValue - 2 * featureValue);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "84342b1cad1386c3bfa8887019f1ab07e63d892c"}, "originalPosition": 43}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4805, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}