{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc0OTM4NjQx", "number": 61658, "title": "Always include the matching node when resolving point in time ", "bodyText": "If shards are relocated to new nodes, then searches with a point in time will fail, although a pit keeps search contexts open. This commit solves this problem by reducing info used by SearchShardIterator and always including the matching nodes when resolving a point in time.\nCloses #61627", "createdAt": "2020-08-27T20:43:09Z", "url": "https://github.com/elastic/elasticsearch/pull/61658", "merged": true, "mergeCommit": {"oid": "294e9cce212e7b701d48745123e2f226500be8f5"}, "closed": true, "closedAt": "2020-09-01T23:12:13Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdDGkjjAH2gAyNDc0OTM4NjQxOjRkNGEwOWJlZTVlZDU5MTliOGVlZWRjM2MxOGIxYTBhZDkzYTUzZTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdEqgQvgH2gAyNDc0OTM4NjQxOjg4MDcyYWM2YmZjNWZiOTg2MzZjNzg5ODBkMzYxOTMzNzhhZjVhMGE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "4d4a09bee5ed5919b8eeedc3c18b1a0ad93a53e6", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d4a09bee5ed5919b8eeedc3c18b1a0ad93a53e6", "committedDate": "2020-08-27T20:38:22Z", "message": "Disable allocation rebalance in point in time test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc4NTg0MDQ4", "url": "https://github.com/elastic/elasticsearch/pull/61658#pullrequestreview-478584048", "createdAt": "2020-08-31T12:49:10Z", "commit": {"oid": "4d4a09bee5ed5919b8eeedc3c18b1a0ad93a53e6"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c72d11371174599b4edfafdb69c4c93d021ad23e", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c72d11371174599b4edfafdb69c4c93d021ad23e", "committedDate": "2020-08-31T19:10:18Z", "message": "Merge branch 'master' into disable-alloc-balance-pit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "279fe909dab68980a48fad558990ed873f32b514", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/279fe909dab68980a48fad558990ed873f32b514", "committedDate": "2020-09-01T03:37:06Z", "message": "Always include target when resolving point in time"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62474f7085f65f167f5ceec628805565986637aa", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/62474f7085f65f167f5ceec628805565986637aa", "committedDate": "2020-09-01T03:49:04Z", "message": "better name"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f70f20482d9a974ef240d060422e29d6f142415b", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/f70f20482d9a974ef240d060422e29d6f142415b", "committedDate": "2020-09-01T13:47:55Z", "message": "ignore when node is no longer in cluster"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc5ODcxODUw", "url": "https://github.com/elastic/elasticsearch/pull/61658#pullrequestreview-479871850", "createdAt": "2020-09-01T15:38:19Z", "commit": {"oid": "f70f20482d9a974ef240d060422e29d6f142415b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTozODoxOVrOHK8b9g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wMVQxNTozODoxOVrOHK8b9g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MTIzODAwNg==", "bodyText": "is it mandatory to check that the node is still in the cluster state ?", "url": "https://github.com/elastic/elasticsearch/pull/61658#discussion_r481238006", "createdAt": "2020-09-01T15:38:19Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/action/search/TransportSearchAction.java", "diffHunk": "@@ -874,23 +873,28 @@ private static RemoteTransportException wrapRemoteClusterFailure(String clusterA\n             .collect(Collectors.toMap(Map.Entry::getKey, e -> new OriginalIndices(e.getValue().toArray(String[]::new), indicesOptions)));\n     }\n \n-    static List<SearchShardIterator> getSearchShardsFromSearchContexts(ClusterState clusterState, OriginalIndices originalIndices,\n+    static List<SearchShardIterator> getSearchShardsFromSearchContexts(ClusterState clusterState,\n+                                                                       OriginalIndices originalIndices,\n                                                                        String localClusterAlias,\n                                                                        SearchContextId searchContext,\n                                                                        TimeValue keepAlive) {\n         final List<SearchShardIterator> iterators = new ArrayList<>(searchContext.shards().size());\n         for (Map.Entry<ShardId, SearchContextIdForNode> entry : searchContext.shards().entrySet()) {\n             final ShardId shardId = entry.getKey();\n             final ShardIterator shards = OperationRouting.getShards(clusterState, shardId);\n-            final List<ShardRouting> matchingNodeFirstRoutings = new ArrayList<>();\n+            final List<String> matchingNodeFirst = new ArrayList<>(shards.size());\n+            final String nodeId = entry.getValue().getNode();\n+            if (clusterState.nodes().get(nodeId) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f70f20482d9a974ef240d060422e29d6f142415b"}, "originalPosition": 41}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "88072ac6bfc5fb98636c78980d36193378af5a0a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/88072ac6bfc5fb98636c78980d36193378af5a0a", "committedDate": "2020-09-01T17:04:11Z", "message": "no need to exclude"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4620, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}