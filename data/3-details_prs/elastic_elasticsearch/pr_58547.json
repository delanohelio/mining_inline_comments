{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQwMDIwMjky", "number": 58547, "title": "Fix two scripted_metric bugs", "bodyText": "Fixes two bugs introduced by #57627:\n\nWe were not properly letting go of memory from the request breaker\nwhen the aggregation finished.\nWe no longer supported totally arbitrary stuff produced by the init\nscript because we assumed that it'd be ok to run the script once\nand clone its results. Sadly, cloning can't clone anything that the\ninit script can make, like String arrays. This runs the init script\nonce for every new bucket so we don't need to clone.", "createdAt": "2020-06-25T13:27:17Z", "url": "https://github.com/elastic/elasticsearch/pull/58547", "merged": true, "mergeCommit": {"oid": "2e85723eeeea8c806109caf75d31f827d0a1e668"}, "closed": true, "closedAt": "2020-06-25T18:05:14Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuuoZEgH2gAyNDQwMDIwMjkyOjAxZmY0NzIwNzY4ZDdmN2FhYjY1NDUxZTc5MmUwODFmZWMwMWYwOTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcuw2wZgH2gAyNDQwMDIwMjkyOmU0ZDkyMTJhNGU3MmFiZDYzOThiOTZjZjBkOGVhZmQ2MjllMjc2NjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "01ff4720768d7f7aab65451e792e081fec01f091", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/01ff4720768d7f7aab65451e792e081fec01f091", "committedDate": "2020-06-25T13:26:21Z", "message": "Fix two scripted_metric bugs\n\nFixes two bugs introduced by #57627:\n1. We were not properly letting go of memory from the request breaker\n   when the aggregation finished.\n2. We no longer supported totally arbitrary stuff produced by the init\n   script because we *assumed* that it'd be ok to run the script once\n   and clone its results. Sadly, cloning can't clone *anything* that the\n   init script can make, like `String` arrays. This runs the init script\n   once for every new bucket so we don't need to clone."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NDk5NjI4", "url": "https://github.com/elastic/elasticsearch/pull/58547#pullrequestreview-437499628", "createdAt": "2020-06-25T13:35:45Z", "commit": {"oid": "01ff4720768d7f7aab65451e792e081fec01f091"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzozNTo0NVrOGo6_mA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yNVQxMzozNzowN1rOGo7DbQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mjc3Ng==", "bodyText": "We could check this for all aggs in the AggregatorTestCase directly ?", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445562776", "createdAt": "2020-06-25T13:35:45Z", "author": {"login": "jimczi"}, "path": "server/src/test/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregatorTests.java", "diffHunk": "@@ -181,6 +200,46 @@ public static void initMockScripts() {\n            state.put(\"selfRef\", state);\n            return state;\n         });\n+        SCRIPTS.put(\"initScriptMakingArray\", params -> {\n+            Map<String, Object> state = (Map<String, Object>) params.get(\"state\");\n+            state.put(\"array\", new String[] {\"foo\", \"bar\"});\n+            state.put(\"collector\", new ArrayList<Integer>());\n+            return state;\n+         });\n+    }\n+\n+    private CircuitBreakerService circuitBreakerService;\n+\n+    @Before\n+    public void mockBreaker() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ff4720768d7f7aab65451e792e081fec01f091"}, "originalPosition": 78}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NTU2Mzc1Nw==", "bodyText": ";)", "url": "https://github.com/elastic/elasticsearch/pull/58547#discussion_r445563757", "createdAt": "2020-06-25T13:37:07Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/metrics/ScriptedMetricAggregator.java", "diffHunk": "@@ -170,7 +180,7 @@ public InternalAggregation buildEmptyAggregation() {\n     }\n \n     @Override\n-    public void close() {\n+    public void doClose() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "01ff4720768d7f7aab65451e792e081fec01f091"}, "originalPosition": 73}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM3NTY3OTcw", "url": "https://github.com/elastic/elasticsearch/pull/58547#pullrequestreview-437567970", "createdAt": "2020-06-25T14:45:06Z", "commit": {"oid": "01ff4720768d7f7aab65451e792e081fec01f091"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "accffa5b01912e13e936802291e83c6abbac6020", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/accffa5b01912e13e936802291e83c6abbac6020", "committedDate": "2020-06-25T15:20:41Z", "message": "Merge branch 'master' into scripted_metric_mem_fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e4d9212a4e72abd6398b96cf0d8eafd629e27666", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e4d9212a4e72abd6398b96cf0d8eafd629e27666", "committedDate": "2020-06-25T16:01:51Z", "message": "Handle mutating params\n\nAdds code to handle when the init script mutates the aggregation\nparameters. I hadn't caught this in my initial testing and it is\n*weird*, but we allow it."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2628, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}