{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg3MTUwODk2", "number": 62358, "title": "Wait for relocations and disk threshold monitor in DiskThresholdDeciderIT", "bodyText": "Sadly I did not manage to reproduce #62326  on any of the computers I have, but the following log lines of the last CI failure makes me think that it is possible that the DiskThresholdMonitor is being processing a reroute (checkInProgress is true) after the last cluster update that detected that the disk has enough free space again to hold shard:\n1> [2020-09-14T10:52:38,949][INFO ][o.e.c.r.a.d.DiskThresholdDeciderIT] [testHighWatermarkNotExceeded] Index [5067] docs async: [false] bulk: [true] partitions [6]\n  1> [2020-09-14T10:52:42,460][INFO ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] skipping monitor as a check is already in progress\n  1> [2020-09-14T10:52:42,462][INFO ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] high disk watermark [10kb] exceeded on [zlTDZ1KWRIOAD_Xs6J1-gA][node_t2][/dev/shm/elastic+elasticsearch+master+multijob+fast+part1/server/build/testrun/internalClusterTest/temp/org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDeciderIT_60A6AF6A936EF834-001/tempDir-003/node-2] free: 0b[0%], shards will be relocated away from this node; currently relocating away shards totalling [75577] bytes; the node is expected to be below the high disk watermark when these relocations are complete\n  1> [2020-09-14T10:52:42,710][INFO ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] skipping monitor as a check is already in progress\n  1> [2020-09-14T10:52:42,906][INFO ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] skipping monitor as a check is already in progress\n  1> [2020-09-14T10:52:43,071][WARN ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] high disk watermark [10kb] exceeded on [zlTDZ1KWRIOAD_Xs6J1-gA][node_t2][/dev/shm/elastic+elasticsearch+master+multijob+fast+part1/server/build/testrun/internalClusterTest/temp/org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDeciderIT_60A6AF6A936EF834-001/tempDir-003/node-2] free: 7.1kb[8.7%], shards will be relocated away from this node; currently relocating away shards totalling [0] bytes; the node is expected to continue to exceed the high disk watermark when these relocations are complete\n  1> [2020-09-14T10:52:43,096][WARN ][o.e.c.r.a.DiskThresholdMonitor] [node_t0] high disk watermark [10kb] exceeded on [zlTDZ1KWRIOAD_Xs6J1-gA][node_t2][/dev/shm/elastic+elasticsearch+master+multijob+fast+part1/server/build/testrun/internalClusterTest/temp/org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDeciderIT_60A6AF6A936EF834-001/tempDir-003/node-2] free: 7.1kb[8.7%], shards will be relocated away from this node; currently relocating away shards totalling [0] bytes; the node is expected to continue to exceed the high disk watermark when these relocations are complete\n  1> [2020-09-14T10:52:43,098][INFO ][o.e.c.r.a.d.DiskThresholdDeciderIT] [testHighWatermarkNotExceeded] [DiskThresholdDeciderIT#testHighWatermarkNotExceeded]: cleaning up after test\n\nThis pull request introduces some assertBusy() so that it gives a bit more time for the shards and the DiskThreshMonitor's reroute to be processed.\nCloses #62326", "createdAt": "2020-09-15T09:07:30Z", "url": "https://github.com/elastic/elasticsearch/pull/62358", "merged": true, "mergeCommit": {"oid": "fd7f936c7ec4a193f44d8aa8eb4a2be103fe5103"}, "closed": true, "closedAt": "2020-09-16T14:14:07Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJD8e-AH2gAyNDg3MTUwODk2OjBmNzc4MjljMGY1ZDgzYzIxOTE1ZGJjNmY2NGE5MDEwYjBiZmU1NWQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdJbnGhAFqTQ4OTU3NDg1MQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "0f77829c0f5d83c21915dbc6f64a9010b0bfe55d", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f77829c0f5d83c21915dbc6f64a9010b0bfe55d", "committedDate": "2020-09-15T08:58:20Z", "message": "Wait for relocations and disk threshold monitor in DiskThresholdDeciderIT"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg4NTk0MjY5", "url": "https://github.com/elastic/elasticsearch/pull/62358#pullrequestreview-488594269", "createdAt": "2020-09-15T11:41:08Z", "commit": {"oid": "0f77829c0f5d83c21915dbc6f64a9010b0bfe55d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMTo0MTowOFrOHR9rsA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNVQxMTo0MTowOFrOHR9rsA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4ODU5ODQ0OA==", "bodyText": "refreshDiskUsage triggers a reroute, shouldn't we have that outside the busy assert and just make sure the the CS application is fully processed by busy asserting on the line below only? That should be all that's needed?", "url": "https://github.com/elastic/elasticsearch/pull/62358#discussion_r488598448", "createdAt": "2020-09-15T11:41:08Z", "author": {"login": "original-brownbear"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/cluster/routing/allocation/decider/DiskThresholdDeciderIT.java", "diffHunk": "@@ -151,13 +150,17 @@ public void testHighWatermarkNotExceeded() throws InterruptedException {\n         // reduce disk size of node 0 so that no shards fit below the high watermark, forcing all shards onto the other data node\n         // (subtract the translog size since the disk threshold decider ignores this and may therefore move the shard back again)\n         fileSystemProvider.getTestFileStore(dataNode0Path).setTotalSpace(minShardSize + WATERMARK_BYTES - 1L);\n-        refreshDiskUsage();\n-        assertThat(getShardRoutings(dataNode0Id), empty());\n+        assertBusy(() -> {\n+            refreshDiskUsage();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0f77829c0f5d83c21915dbc6f64a9010b0bfe55d"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c946582b2f09ab070127f4cc459cbda2d96b7f69", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/c946582b2f09ab070127f4cc459cbda2d96b7f69", "committedDate": "2020-09-16T10:18:22Z", "message": "feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDg5NTc0ODUx", "url": "https://github.com/elastic/elasticsearch/pull/62358#pullrequestreview-489574851", "createdAt": "2020-09-16T12:32:42Z", "commit": {"oid": "c946582b2f09ab070127f4cc459cbda2d96b7f69"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4625, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}