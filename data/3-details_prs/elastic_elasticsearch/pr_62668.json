{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg5NTQyNzcy", "number": 62668, "title": "Add setting to decommission legacy monitoring cluster alerts", "bodyText": "Adds a setting that, when enabled, directs any currently running exporters in monitoring will treat any cluster alert definition as excluded from the list of allowed cluster alert watches. This is the first step to adding a migration path away from using cluster alerts configured by the monitoring plugin and toward those managed by the stack monitoring solutions on the new alerting feature.", "createdAt": "2020-09-18T21:11:16Z", "url": "https://github.com/elastic/elasticsearch/pull/62668", "merged": true, "mergeCommit": {"oid": "16957511e1e46e4de7dab7c0599a036c730c1884"}, "closed": true, "closedAt": "2020-10-29T17:55:17Z", "author": {"login": "jbaiera"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJgjS2AH2gAyNDg5NTQyNzcyOjYyYWE4ZWNhYjUzZGE1ZjgwNmYyODZkNzhkMzZlYzk2MWQxYWI5NDA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdXUiy4AH2gAyNDg5NTQyNzcyOjNhMjgxZjcyMTYzNTU1NjJhMGZhNTUxNzJmODE3NDk0YjVhOWMzMWQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "62aa8ecab53da5f806f286d78d36ec961d1ab940", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/62aa8ecab53da5f806f286d78d36ec961d1ab940", "committedDate": "2020-09-16T18:18:04Z", "message": "WIP"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f3c04deff3d784509bb2a1e790ae4bbce872dcd9", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3c04deff3d784509bb2a1e790ae4bbce872dcd9", "committedDate": "2020-09-17T20:41:01Z", "message": "Actually test creation and updating of watches in local monitoring.\n\nThis will allow us to test if the exporters actually pull the watches back down when they aren't in use."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f5c399dc4f8bc62948e515b759b57f02649c657d", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/f5c399dc4f8bc62948e515b759b57f02649c657d", "committedDate": "2020-09-18T20:57:01Z", "message": "Add test cases that ensure cluster alerts are torn down when decommissioning setting is present."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4beb02959071341b4387174c6b270a41f1f6863", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4beb02959071341b4387174c6b270a41f1f6863", "committedDate": "2020-09-18T21:02:52Z", "message": "Appease the precommit beast"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9b2b37f3b04d805e93c32eec8e7e6b704453c40", "committedDate": "2020-09-22T19:16:00Z", "message": "Merge branch 'master' into monitoring-decommission-watch-setting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1MDEyNzg1", "url": "https://github.com/elastic/elasticsearch/pull/62668#pullrequestreview-495012785", "createdAt": "2020-09-23T20:13:19Z", "commit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDoxMzoxOVrOHW_RGQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yM1QyMDozMjowMlrOHW_3dw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg2NzI4OQ==", "bodyText": "should #getSettings() also return this new setting ? (I think it is only really used for testing, but seems more correct to return all the settings up through the plugin).", "url": "https://github.com/elastic/elasticsearch/pull/62668#discussion_r493867289", "createdAt": "2020-09-23T20:13:19Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/Exporters.java", "diffHunk": "@@ -62,7 +63,9 @@ public Exporters(Settings settings, Map<String, Exporter.Factory> factories,\n \n         final List<Setting.AffixSetting<?>> dynamicSettings =\n             getSettings().stream().filter(Setting::isDynamic).collect(Collectors.toList());\n-        clusterService.getClusterSettings().addSettingsUpdateConsumer(this::setExportersSetting, dynamicSettings);\n+        final List<Setting<?>> updateSettings = new ArrayList<Setting<?>>(dynamicSettings);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "originalPosition": 13}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MzkyMw==", "bodyText": "It feels kinda weird to have this AND xpack.monitoring.exporters.*.cluster_alerts.management.enabled setting.\nI wonder if makes sense to\n\nexpose a POST _monitoring/cluster_alert/disable endpoint (or whatever the name is)\nwhen that is called iterate through all of the current exporters and set xpack.monitoring.exporters.<i>.cluster_alerts.management.enabled=false and set some cluster state to no longer try to install cluster alerts (and reach out to delete the cluster alerts for those exporters)\nIf a new exporter is created, set xpack.monitoring.exporters.<new_exporter>.cluster_alerts.management.enabled=false based on the cluster state.\nexpose a POST _monitoring/cluster_alert/enable\n\nthoughts ?", "url": "https://github.com/elastic/elasticsearch/pull/62668#discussion_r493873923", "createdAt": "2020-09-23T20:25:57Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/Monitoring.java", "diffHunk": "@@ -77,6 +77,9 @@\n     public static final Setting<Boolean> CLEAN_WATCHER_HISTORY = boolSetting(\"xpack.watcher.history.cleaner_service.enabled\",\n         true, Setting.Property.Dynamic, Setting.Property.NodeScope, Setting.Property.Deprecated);\n \n+    public static final Setting<Boolean> MIGRATION_DECOMMISSION_ALERTS = boolSetting(\"xpack.monitoring.migration.decommission_alerts\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3NzExMQ==", "bodyText": "I think this name is bit misleading ? (maybe testDeployClusterAlerts) ?", "url": "https://github.com/elastic/elasticsearch/pull/62668#discussion_r493877111", "createdAt": "2020-09-23T20:32:02Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/monitoring/src/test/java/org/elasticsearch/xpack/monitoring/exporter/http/HttpExporterResourceTests.java", "diffHunk": "@@ -484,6 +488,56 @@ public void testWatchPublishBlocksAfterSuccessfulWatcherCheck() {\n         verifyNoMoreInteractions(client);\n     }\n \n+    public void testWatchRemovalOnDecomissionAlerts() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "originalPosition": 17}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk1NDU2MjQy", "url": "https://github.com/elastic/elasticsearch/pull/62668#pullrequestreview-495456242", "createdAt": "2020-09-24T11:06:30Z", "commit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMTowNjozMFrOHXVMfw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxMToyNDozMVrOHXVxZA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIyNjU1OQ==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    boolean alertsProcessed = !canUseWatcher() || watcherSetup.get();\n          \n          \n            \n                    boolean alertsProcessed = canUseWatcher() == false || watcherSetup.get();", "url": "https://github.com/elastic/elasticsearch/pull/62668#discussion_r494226559", "createdAt": "2020-09-24T11:06:30Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/local/LocalExporter.java", "diffHunk": "@@ -159,8 +162,10 @@ public void licenseStateChanged() {\n     boolean isExporterReady() {\n         // forces the setup to occur if it hasn't already\n         final boolean running = resolveBulk(clusterService.state(), false) != null;\n+        // Report on watcher readiness\n+        boolean alertsProcessed = !canUseWatcher() || watcherSetup.get();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDIzNjAwNA==", "bodyText": "I'd be in favour of less settings but OTOH current flow with this setting seems simpler and less error-prone. And currently you can't enable single exporter back (with xpack.monitoring.exporters.<i>.cluster_alerts.management.enabled=true) which I think is good thing (easier to reason about cluster state).\nWe can still expose _monitoring/cluster_alert/disable endpoint if needed though if we want, it may be easier for the user to just call API than looking up setting to use", "url": "https://github.com/elastic/elasticsearch/pull/62668#discussion_r494236004", "createdAt": "2020-09-24T11:24:31Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/Monitoring.java", "diffHunk": "@@ -77,6 +77,9 @@\n     public static final Setting<Boolean> CLEAN_WATCHER_HISTORY = boolSetting(\"xpack.watcher.history.cleaner_service.enabled\",\n         true, Setting.Property.Dynamic, Setting.Property.NodeScope, Setting.Property.Deprecated);\n \n+    public static final Setting<Boolean> MIGRATION_DECOMMISSION_ALERTS = boolSetting(\"xpack.monitoring.migration.decommission_alerts\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5Mzg3MzkyMw=="}, "originalCommit": {"oid": "b9b2b37f3b04d805e93c32eec8e7e6b704453c40"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2faf8e2e825e25db36dde44545b75c53a3de3934", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/2faf8e2e825e25db36dde44545b75c53a3de3934", "committedDate": "2020-09-24T19:54:43Z", "message": "Update x-pack/plugin/monitoring/src/main/java/org/elasticsearch/xpack/monitoring/exporter/local/LocalExporter.java\n\nCo-authored-by: Przemko Robakowski <przemko.robakowski@elastic.co>"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDk3NzgzMjU0", "url": "https://github.com/elastic/elasticsearch/pull/62668#pullrequestreview-497783254", "createdAt": "2020-09-28T18:17:44Z", "commit": {"oid": "2faf8e2e825e25db36dde44545b75c53a3de3934"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31857157d55e24421d9ab58e870e7ad75d5875dc", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/31857157d55e24421d9ab58e870e7ad75d5875dc", "committedDate": "2020-10-26T20:23:24Z", "message": "Merge branch 'master' into monitoring-decommission-watch-setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3735e1a3cb0e019d6991bf555952ff7a592e132c", "author": {"user": {"login": "jbaiera", "name": "James Baiera"}}, "url": "https://github.com/elastic/elasticsearch/commit/3735e1a3cb0e019d6991bf555952ff7a592e132c", "committedDate": "2020-10-28T18:32:50Z", "message": "addressed feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3a281f7216355562a0fa55172f817494b5a9c31d", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/3a281f7216355562a0fa55172f817494b5a9c31d", "committedDate": "2020-10-29T16:13:36Z", "message": "Merge branch 'master' into monitoring-decommission-watch-setting"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3585, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}