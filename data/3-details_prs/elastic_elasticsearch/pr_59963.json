{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU0NDA2MDU2", "number": 59963, "title": "[ML] Include same fields during test inference as in training", "bodyText": "In #58877, when we switched test inference on java, we just\nuse the doc's _source as features. However, this could be\nmissing out on features that were used during training,\ne.g. alias fields, etc.\nThis commit addresses this by extracting fields to use as\nfeatures during inference the same way they are extracted\nin DataFrameDataExtractor when they are used for training.", "createdAt": "2020-07-21T11:22:29Z", "url": "https://github.com/elastic/elasticsearch/pull/59963", "merged": true, "mergeCommit": {"oid": "f12f57c74732f29879c3a4e08b1ef4fa3d3a883f"}, "closed": true, "closedAt": "2020-07-22T07:25:04Z", "author": {"login": "dimitris-athanasiou"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc3EvLUAFqTQ1MjM2NDUwOQ==", "endCursor": "Y3Vyc29yOnYyOpPPAAABc3In3VAH2gAyNDU0NDA2MDU2OmM1ODBjZTk0MWFjMjA5YTI1M2YwYzEzZWY5MDEwNjdlN2FlNWZmNzk=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzY0NTA5", "url": "https://github.com/elastic/elasticsearch/pull/59963#pullrequestreview-452364509", "createdAt": "2020-07-21T11:29:31Z", "commit": {"oid": "4aec0566eac70fb82b353da1abff6d17193808a7"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToyOTozMlrOG0zvCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yMVQxMToyOTozMlrOG0zvCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1ODAyNjc2MQ==", "bodyText": "I think this method could be turned to stream expression for brevity, sth like:\nreturn extractedFields.getDocValueFields().collect(toMap(ExtractedField::getSearchField, ExtractedField::docValueFormat));", "url": "https://github.com/elastic/elasticsearch/pull/59963#discussion_r458026761", "createdAt": "2020-07-21T11:29:32Z", "author": {"login": "przemekwitek"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/inference/TestDocsIterator.java", "diffHunk": "@@ -18,18 +18,32 @@\n import org.elasticsearch.xpack.core.ClientHelper;\n import org.elasticsearch.xpack.core.ml.dataframe.DataFrameAnalyticsConfig;\n import org.elasticsearch.xpack.ml.dataframe.DestinationIndex;\n+import org.elasticsearch.xpack.ml.extractor.ExtractedField;\n+import org.elasticsearch.xpack.ml.extractor.ExtractedFields;\n import org.elasticsearch.xpack.ml.utils.persistence.SearchAfterDocumentsIterator;\n \n+import java.util.HashMap;\n+import java.util.Map;\n import java.util.Objects;\n \n public class TestDocsIterator extends SearchAfterDocumentsIterator<SearchHit> {\n \n     private final DataFrameAnalyticsConfig config;\n     private String lastDocId;\n+    private final Map<String, String> docValueFieldAndFormatPairs;\n \n-    TestDocsIterator(OriginSettingClient client, DataFrameAnalyticsConfig config) {\n+    TestDocsIterator(OriginSettingClient client, DataFrameAnalyticsConfig config, ExtractedFields extractedFields) {\n         super(client, config.getDest().getIndex(), true);\n         this.config = Objects.requireNonNull(config);\n+        this.docValueFieldAndFormatPairs = buildDocValueFieldAndFormatPairs(extractedFields);\n+    }\n+\n+    private static Map<String, String> buildDocValueFieldAndFormatPairs(ExtractedFields extractedFields) {\n+        Map<String, String> docValueFieldAndFormatPairs = new HashMap<>();\n+        for (ExtractedField docValueField : extractedFields.getDocValueFields()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4aec0566eac70fb82b353da1abff6d17193808a7"}, "originalPosition": 27}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDUyMzc1NzQ0", "url": "https://github.com/elastic/elasticsearch/pull/59963#pullrequestreview-452375744", "createdAt": "2020-07-21T11:47:32Z", "commit": {"oid": "4aec0566eac70fb82b353da1abff6d17193808a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8eea241b26da39e43010bd929c0255df4b143a48", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/8eea241b26da39e43010bd929c0255df4b143a48", "committedDate": "2020-07-21T12:21:47Z", "message": "[ML] Include same fields during test inference as in training\n\nIn #58877, when we switched test inference on java, we just\nuse the doc's `_source` as features. However, this could be\nmissing out on features that were used during training,\ne.g. alias fields, etc.\n\nThis commit addresses this by extracting fields to use as\nfeatures during inference the same way they are extracted\nin `DataFrameDataExtractor` when they are used for training."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "076997c1dc8d83a4fedfa4da0da09137834acb3a", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/076997c1dc8d83a4fedfa4da0da09137834acb3a", "committedDate": "2020-07-21T12:26:15Z", "message": "Use streams to simplify map creation"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4aec0566eac70fb82b353da1abff6d17193808a7", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/4aec0566eac70fb82b353da1abff6d17193808a7", "committedDate": "2020-07-21T10:59:18Z", "message": "[ML] Include same fields during test inference as in training\n\nIn #58877, when we switched test inference on java, we just\nuse the doc's `_source` as features. However, this could be\nmissing out on features that were used during training,\ne.g. alias fields, etc.\n\nThis commit addresses this by extracting fields to use as\nfeatures during inference the same way they are extracted\nin `DataFrameDataExtractor` when they are used for training."}, "afterCommit": {"oid": "076997c1dc8d83a4fedfa4da0da09137834acb3a", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/076997c1dc8d83a4fedfa4da0da09137834acb3a", "committedDate": "2020-07-21T12:26:15Z", "message": "Use streams to simplify map creation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5066697ba8957dad201398eff374716bac87bf25", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/5066697ba8957dad201398eff374716bac87bf25", "committedDate": "2020-07-21T14:08:30Z", "message": "Remove unused imports"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c580ce941ac209a253f0c13ef901067e7ae5ff79", "author": {"user": {"login": "dimitris-athanasiou", "name": "Dimitris Athanasiou"}}, "url": "https://github.com/elastic/elasticsearch/commit/c580ce941ac209a253f0c13ef901067e7ae5ff79", "committedDate": "2020-07-21T16:14:42Z", "message": "Revert \"Use streams to simplify map creation\"\n\nThis reverts commit 076997c1dc8d83a4fedfa4da0da09137834acb3a."}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4166, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}