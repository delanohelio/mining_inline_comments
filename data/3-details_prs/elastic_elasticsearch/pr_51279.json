{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY1NjM1MDM0", "number": 51279, "title": "Exclude nested documents in LuceneChangesSnapshot", "bodyText": "LuceneChangesSnapshot can be slow if nested documents are heavily used. Also, it estimates the number of operations to be recovered in peer recoveries inaccurately. With this change, we prefer excluding the nested non-root documents in a Lucene query instead.\nKudos to @DaveCTurner for finding this issue. See: https://discuss.elastic.co/t/es-7-5-translog-recovery-is-extremely-slow/215505/11.", "createdAt": "2020-01-22T02:40:17Z", "url": "https://github.com/elastic/elasticsearch/pull/51279", "merged": true, "mergeCommit": {"oid": "151148622cb4d9c8a0277d10f715de1b7c7cce59"}, "closed": true, "closedAt": "2020-01-22T17:13:52Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 8, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb8sWvlgH2gAyMzY1NjM1MDM0OjdjZjliMWYzZWRiZjQzYWZjMTkwMjVkYzA2NGYxNDM2OTk3NjQ5MzQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb83t5rAH2gAyMzY1NjM1MDM0OjhjMzdmYjAyODE3ZTA2Yzc4YWRkOWMzYjdkOGNhOGYwZTQ3MmY4MmE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7cf9b1f3edbf43afc19025dc064f143699764934", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/7cf9b1f3edbf43afc19025dc064f143699764934", "committedDate": "2020-01-22T02:31:03Z", "message": "Exclude nested documents in LuceneChangesSnapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDMyMDQ4", "url": "https://github.com/elastic/elasticsearch/pull/51279#pullrequestreview-346432048", "createdAt": "2020-01-22T09:08:03Z", "commit": {"oid": "7cf9b1f3edbf43afc19025dc064f143699764934"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwOTowODowNFrOFgUyqg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQwOTowODowNFrOFgUyqg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQzOTQwMg==", "bodyText": "This comment looks in need of adjustment. Maybe it deserves a Javadoc comment to say it doesn't work with child docs too.", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369439402", "createdAt": "2020-01-22T09:08:04Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/index/engine/CombinedDocValues.java", "diffHunk": "@@ -55,19 +56,18 @@ long docVersion(int segmentDocId) throws IOException {\n     long docSeqNo(int segmentDocId) throws IOException {\n         assert seqNoDV.docID() < segmentDocId;\n         if (seqNoDV.advanceExact(segmentDocId) == false) {\n+            assert false : \"DocValues for field [\" + SeqNoFieldMapper.NAME + \"] is not found\";\n             throw new IllegalStateException(\"DocValues for field [\" + SeqNoFieldMapper.NAME + \"] is not found\");\n         }\n         return seqNoDV.longValue();\n     }\n \n     long docPrimaryTerm(int segmentDocId) throws IOException {\n-        if (primaryTermDV == null) {\n-            return -1L;\n-        }\n         assert primaryTermDV.docID() < segmentDocId;\n         // Use -1 for docs which don't have primary term. The caller considers those docs as nested docs.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cf9b1f3edbf43afc19025dc064f143699764934"}, "originalPosition": 23}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NDg1MTI3", "url": "https://github.com/elastic/elasticsearch/pull/51279#pullrequestreview-346485127", "createdAt": "2020-01-22T10:30:44Z", "commit": {"oid": "7cf9b1f3edbf43afc19025dc064f143699764934"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDozMDo0NFrOFgXU9w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxMDozMDo0NFrOFgXU9w==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTQ4MDk1MQ==", "bodyText": "Can you add a comment saying that this skips nested docs?", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369480951", "createdAt": "2020-01-22T10:30:44Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -2731,7 +2734,11 @@ private boolean assertMaxSeqNoOfUpdatesIsAdvanced(Term id, long seqNo, boolean a\n     private void restoreVersionMapAndCheckpointTracker(DirectoryReader directoryReader) throws IOException {\n         final IndexSearcher searcher = new IndexSearcher(directoryReader);\n         searcher.setQueryCache(null);\n-        final Query query = LongPoint.newRangeQuery(SeqNoFieldMapper.NAME, getPersistedLocalCheckpoint() + 1, Long.MAX_VALUE);\n+        final Query query = new BooleanQuery.Builder()\n+            .add(LongPoint.newRangeQuery(\n+                SeqNoFieldMapper.NAME, getPersistedLocalCheckpoint() + 1, Long.MAX_VALUE), BooleanClause.Occur.MUST)\n+            .add(new DocValuesFieldExistsQuery(SeqNoFieldMapper.PRIMARY_TERM_NAME), BooleanClause.Occur.MUST)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7cf9b1f3edbf43afc19025dc064f143699764934"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08cac5b3348e7b3d102a803a59cc1427c495cdda", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/08cac5b3348e7b3d102a803a59cc1427c495cdda", "committedDate": "2020-01-22T13:57:31Z", "message": "Merge branch 'master' into nested-docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5b7c5b5820b6d2182cc8f3fe0e6838e68e4163ca", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5b7c5b5820b6d2182cc8f3fe0e6838e68e4163ca", "committedDate": "2020-01-22T14:26:20Z", "message": "remove outdated comment"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/bd0771ac782e6eca7953a9fc4b31a869a740755a", "committedDate": "2020-01-22T14:26:34Z", "message": "Use Queries.newNonNestedFilter"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ2NjY5NTIz", "url": "https://github.com/elastic/elasticsearch/pull/51279#pullrequestreview-346669523", "createdAt": "2020-01-22T15:20:14Z", "commit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "state": "APPROVED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNToyMDoxNFrOFgf_kg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yMlQxNTozMjoxMVrOFggduw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyMjkzMA==", "bodyText": "what is the point of doubling the exception with an assertion?", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369622930", "createdAt": "2020-01-22T15:20:14Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/engine/CombinedDocValues.java", "diffHunk": "@@ -47,6 +47,7 @@\n     long docVersion(int segmentDocId) throws IOException {\n         assert versionDV.docID() < segmentDocId;\n         if (versionDV.advanceExact(segmentDocId) == false) {\n+            assert false : \"DocValues for field [\" + VersionFieldMapper.NAME + \"] is not found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyNjA2NA==", "bodyText": "same question here", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369626064", "createdAt": "2020-01-22T15:25:08Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/engine/CombinedDocValues.java", "diffHunk": "@@ -55,19 +56,18 @@ long docVersion(int segmentDocId) throws IOException {\n     long docSeqNo(int segmentDocId) throws IOException {\n         assert seqNoDV.docID() < segmentDocId;\n         if (seqNoDV.advanceExact(segmentDocId) == false) {\n+            assert false : \"DocValues for field [\" + SeqNoFieldMapper.NAME + \"] is not found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyNjQyMw==", "bodyText": "and here", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369626423", "createdAt": "2020-01-22T15:25:41Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/engine/CombinedDocValues.java", "diffHunk": "@@ -55,19 +56,18 @@ long docVersion(int segmentDocId) throws IOException {\n     long docSeqNo(int segmentDocId) throws IOException {\n         assert seqNoDV.docID() < segmentDocId;\n         if (seqNoDV.advanceExact(segmentDocId) == false) {\n+            assert false : \"DocValues for field [\" + SeqNoFieldMapper.NAME + \"] is not found\";\n             throw new IllegalStateException(\"DocValues for field [\" + SeqNoFieldMapper.NAME + \"] is not found\");\n         }\n         return seqNoDV.longValue();\n     }\n \n     long docPrimaryTerm(int segmentDocId) throws IOException {\n-        if (primaryTermDV == null) {\n-            return -1L;\n-        }\n+        // We exclude non-root nested documents when querying changes, every returned document must have primary term.\n         assert primaryTermDV.docID() < segmentDocId;\n-        // Use -1 for docs which don't have primary term. The caller considers those docs as nested docs.\n         if (primaryTermDV.advanceExact(segmentDocId) == false) {\n-            return -1;\n+            assert false : \"DocValues for field [\" + SeqNoFieldMapper.PRIMARY_TERM_NAME + \"] is not found\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYyNzczNw==", "bodyText": "Lucene requires queries to be rewritten before creating a weight. This particular boolean query is fine because it rewrites to itself, but it'd be more future-proof to call rewrite().\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    final Weight weight = searcher.createWeight(query, ScoreMode.COMPLETE_NO_SCORES, 1.0f);\n          \n          \n            \n                     final Query rewrittenQuery = searcher.rewrite(query);\n          \n          \n            \n                     final Weight weight = searcher.createWeight(rewrittenQuery, ScoreMode.COMPLETE_NO_SCORES, 1.0f);", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369627737", "createdAt": "2020-01-22T15:27:41Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -2731,7 +2734,11 @@ private boolean assertMaxSeqNoOfUpdatesIsAdvanced(Term id, long seqNo, boolean a\n     private void restoreVersionMapAndCheckpointTracker(DirectoryReader directoryReader) throws IOException {\n         final IndexSearcher searcher = new IndexSearcher(directoryReader);\n         searcher.setQueryCache(null);\n-        final Query query = LongPoint.newRangeQuery(SeqNoFieldMapper.NAME, getPersistedLocalCheckpoint() + 1, Long.MAX_VALUE);\n+        final Query query = new BooleanQuery.Builder()\n+            .add(LongPoint.newRangeQuery(\n+                    SeqNoFieldMapper.NAME, getPersistedLocalCheckpoint() + 1, Long.MAX_VALUE), BooleanClause.Occur.MUST)\n+            .add(Queries.newNonNestedFilter(), BooleanClause.Occur.MUST) // exclude non-root nested documents\n+            .build();\n         final Weight weight = searcher.createWeight(query, ScoreMode.COMPLETE_NO_SCORES, 1.0f);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "originalPosition": 27}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2OTYzMDY1MQ==", "bodyText": "in case you wonder: no need to explicitly rewrite here, this is implicitly done by searchAfter which is a high-level API of IndexSearcher unlike createWeight", "url": "https://github.com/elastic/elasticsearch/pull/51279#discussion_r369630651", "createdAt": "2020-01-22T15:32:11Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/engine/LuceneChangesSnapshot.java", "diffHunk": "@@ -210,7 +213,10 @@ private void fillParallelArray(ScoreDoc[] scoreDocs, ParallelArray parallelArray\n     }\n \n     private TopDocs searchOperations(ScoreDoc after) throws IOException {\n-        final Query rangeQuery = LongPoint.newRangeQuery(SeqNoFieldMapper.NAME, Math.max(fromSeqNo, lastSeenSeqNo), toSeqNo);\n+        final Query rangeQuery = new BooleanQuery.Builder()\n+            .add(LongPoint.newRangeQuery(SeqNoFieldMapper.NAME, Math.max(fromSeqNo, lastSeenSeqNo), toSeqNo), BooleanClause.Occur.MUST)\n+            .add(Queries.newNonNestedFilter(), BooleanClause.Occur.MUST) // exclude non-root nested documents\n+            .build();\n         final Sort sortedBySeqNo = new Sort(new SortField(SeqNoFieldMapper.NAME, SortField.Type.LONG));\n         return indexSearcher.searchAfter(after, rangeQuery, searchBatchSize, sortedBySeqNo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "bd0771ac782e6eca7953a9fc4b31a869a740755a"}, "originalPosition": 27}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c37fb02817e06c78add9c3b7d8ca8f0e472f82a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c37fb02817e06c78add9c3b7d8ca8f0e472f82a", "committedDate": "2020-01-22T15:45:18Z", "message": "rewrite"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2821, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}