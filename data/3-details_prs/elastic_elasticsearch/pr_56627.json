{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDE2ODgwODk1", "number": 56627, "title": "Improvement usage of gradle task avoidance api", "bodyText": "Use gradle task avoidance everywhere we generate a task.\n\n\npartially addresses #56610\n\n\nMoving from task.create() to tasks.register() means that the linked configuration block is not always executed. That leads to side effects in some parts of the elasticsearch build that require more rework of how certain tasks and plugins are cutted. (e.g. how Rest testing is setup). This is out of scope of this PR.\n\n\nalso not in scope: minimizing task realisation. We should optimise for that once we finished using the api consistently.", "createdAt": "2020-05-12T17:57:39Z", "url": "https://github.com/elastic/elasticsearch/pull/56627", "merged": true, "mergeCommit": {"oid": "731b282c9ff9aa558c21a5cb79b010778d0e13ad"}, "closed": true, "closedAt": "2020-05-19T18:01:50Z", "author": {"login": "breskeby"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcg2WIFABqjMzMzE0MTM4OTg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABci0oDPgFqTQxNDQ1MzkyMA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fee92e57c09041ee07f52f7171b60af358856eab", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fee92e57c09041ee07f52f7171b60af358856eab", "committedDate": "2020-05-13T09:17:58Z", "message": "Fix typos in testkit examples and adjust test assertions"}, "afterCommit": {"oid": "dd497ec6e610323c639ec78d30d66aef30ef2aa3", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd497ec6e610323c639ec78d30d66aef30ef2aa3", "committedDate": "2020-05-13T10:29:39Z", "message": "Use task avoidance api usage in root project and buildSrc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "dd497ec6e610323c639ec78d30d66aef30ef2aa3", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd497ec6e610323c639ec78d30d66aef30ef2aa3", "committedDate": "2020-05-13T10:29:39Z", "message": "Use task avoidance api usage in root project and buildSrc"}, "afterCommit": {"oid": "f3bf3473f6fc4047cada17522cd2d7736cb0b09f", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/f3bf3473f6fc4047cada17522cd2d7736cb0b09f", "committedDate": "2020-05-13T16:32:20Z", "message": "Use task avoidance api usage in root project and buildSrc"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "9b342d29a472ca436bfbf64d41b2d5ebb942afaf", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b342d29a472ca436bfbf64d41b2d5ebb942afaf", "committedDate": "2020-05-14T08:33:14Z", "message": "Use task avoidance api in integTests"}, "afterCommit": {"oid": "4cedb32cbae6f26de326530d616fb57646305689", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cedb32cbae6f26de326530d616fb57646305689", "committedDate": "2020-05-14T10:11:42Z", "message": "Move to task avoidance api in rest tests\n\nrequires revisit later to do some more refactoring to actually avoid creating those tasks"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "4cedb32cbae6f26de326530d616fb57646305689", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/4cedb32cbae6f26de326530d616fb57646305689", "committedDate": "2020-05-14T10:11:42Z", "message": "Move to task avoidance api in rest tests\n\nrequires revisit later to do some more refactoring to actually avoid creating those tasks"}, "afterCommit": {"oid": "3b61b943546b8a647fe7de7a36ec549e7087a4b4", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b61b943546b8a647fe7de7a36ec549e7087a4b4", "committedDate": "2020-05-14T11:23:33Z", "message": "More task avoidance api usage in docs projects"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a8d1c06b75219cc3a7f8cde03e85ceec3de17654", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8d1c06b75219cc3a7f8cde03e85ceec3de17654", "committedDate": "2020-05-14T14:05:29Z", "message": "Fix nullpointer when loading test resources in docs plugin"}, "afterCommit": {"oid": "30d4542889069d54ead5a3b90ac06815d353fb31", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/30d4542889069d54ead5a3b90ac06815d353fb31", "committedDate": "2020-05-13T18:43:32Z", "message": "Simplify ThirdPartyAuditTaskIT test a bit"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "5e6334cbab59495b1177b0fa5ac3f54a31ceb330", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/5e6334cbab59495b1177b0fa5ac3f54a31ceb330", "committedDate": "2020-05-14T15:46:06Z", "message": "More task avoidance api usages"}, "afterCommit": {"oid": "d3112a4c200ce5d712b1408597644f81733acc8e", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/d3112a4c200ce5d712b1408597644f81733acc8e", "committedDate": "2020-05-15T08:39:01Z", "message": "More task avoidance api usages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7891b3ceac4b20cebfbfb7474633f70091b0b014", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/7891b3ceac4b20cebfbfb7474633f70091b0b014", "committedDate": "2020-05-15T13:17:05Z", "message": "Use task avoidance api in testkit samples"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "460b9d82ae4176239a83ba16c879249ad0585dd7", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/460b9d82ae4176239a83ba16c879249ad0585dd7", "committedDate": "2020-05-15T13:17:05Z", "message": "Use task avoidance api usage in root project and buildSrc"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "389e729dfa14cb901a01fe309e50485bd3ef7781", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/389e729dfa14cb901a01fe309e50485bd3ef7781", "committedDate": "2020-05-15T13:17:05Z", "message": "Simplify ThirdPartyAuditTaskIT test a bit"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee40e99c45a01b4e8a3aadb828a3f0ac0d4c2f8e", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee40e99c45a01b4e8a3aadb828a3f0ac0d4c2f8e", "committedDate": "2020-05-15T13:17:05Z", "message": "More task avoidance api usages"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "committedDate": "2020-05-15T13:17:05Z", "message": "Workaround task configuration sideeffect"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "19d2457d022da12f9649648687f1aa153e8b721d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/19d2457d022da12f9649648687f1aa153e8b721d", "committedDate": "2020-05-15T12:06:41Z", "message": "Workaround task configuration sideeffect"}, "afterCommit": {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/85ee4b9d230e98b05bc66f5e8dacbe89330814d0", "committedDate": "2020-05-15T13:17:05Z", "message": "Workaround task configuration sideeffect"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEyNzcyMzk3", "url": "https://github.com/elastic/elasticsearch/pull/56627#pullrequestreview-412772397", "createdAt": "2020-05-15T15:57:13Z", "commit": {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNTo1NzoxM1rOGWKqkA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xNVQxNTo1NzoxM1rOGWKqkA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNTg5NjU5Mg==", "bodyText": "fix deprecation warning on the way", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r425896592", "createdAt": "2020-05-15T15:57:13Z", "author": {"login": "breskeby"}, "path": "buildSrc/reaper/build.gradle", "diffHunk": "@@ -1,5 +1,5 @@\n jar {\n-  archiveName = \"${project.name}.jar\"\n+  archiveFileName = \"${project.name}.jar\"", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85ee4b9d230e98b05bc66f5e8dacbe89330814d0"}, "originalPosition": 3}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fdacb18ad81a905b2dc49855e3a2aca26a7d2478", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fdacb18ad81a905b2dc49855e3a2aca26a7d2478", "committedDate": "2020-05-15T16:04:41Z", "message": "Fix minor formatting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/0e9464182278e486e5aba4c41cfa461eade3e33c", "committedDate": "2020-05-18T08:52:15Z", "message": "Merge branch 'master' into improvement/use-gradle-task-avoidance-api"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDEzOTU2OTQx", "url": "https://github.com/elastic/elasticsearch/pull/56627#pullrequestreview-413956941", "createdAt": "2020-05-18T21:38:33Z", "commit": {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMTozODozM1rOGXIWnA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0xOFQyMTo0MzowMVrOGXIeNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzI5Mg==", "bodyText": "Is this strictly beneficial since this task rule should only run when it finds a task matching this naming convention, right? Granted, it doesn't hurt, just wondering.", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426907292", "createdAt": "2020-05-18T21:38:33Z", "author": {"login": "mark-vieira"}, "path": "build.gradle", "diffHunk": "@@ -485,7 +485,7 @@ allprojects {\n     if (realTask == null) {\n       return\n     }\n-    project.tasks.create(taskName) {\n+    project.tasks.register(taskName) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c"}, "originalPosition": 54}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwNzkyMA==", "bodyText": "nit: missing space stop.configure {", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426907920", "createdAt": "2020-05-18T21:40:02Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/groovy/org/elasticsearch/gradle/test/AntFixture.groovy", "diffHunk": "@@ -222,24 +224,29 @@ class AntFixture extends AntTask implements Fixture {\n     }\n \n     /** Adds a task to kill an elasticsearch node with the given pidfile */\n-    private Task createStopTask() {\n+    private TaskProvider createStopTask() {\n         final AntFixture fixture = this\n         final Object pid = \"${ -> fixture.pid }\"\n-        Exec stop = project.tasks.create(name: \"${name}#stop\", type: LoggedExec)\n-        stop.onlyIf { fixture.pidFile.exists() }\n-        stop.doFirst {\n-            logger.info(\"Shutting down ${fixture.name} with pid ${pid}\")\n-        }\n-        if (Os.isFamily(Os.FAMILY_WINDOWS)) {\n-            stop.executable = 'Taskkill'\n-            stop.args('/PID', pid, '/F')\n-        } else {\n-            stop.executable = 'kill'\n-            stop.args('-9', pid)\n-        }\n-        stop.doLast {\n-            project.delete(fixture.pidFile)\n+        TaskProvider<Exec> stop = project.tasks.register(\"${name}#stop\", LoggedExec)\n+        stop.configure{", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQyNjkwOTIzOA==", "bodyText": "Should we just use create() then? This seems even more confusing.", "url": "https://github.com/elastic/elasticsearch/pull/56627#discussion_r426909238", "createdAt": "2020-05-18T21:43:01Z", "author": {"login": "mark-vieira"}, "path": "plugins/repository-hdfs/build.gradle", "diffHunk": "@@ -134,6 +134,10 @@ for (String fixtureName : ['hdfsFixture', 'haHdfsFixture', 'secureHdfsFixture',\n \n     args miniHDFSArgs.toArray()\n   }\n+\n+  // TODO: The task configuration block has side effects that require it currently to be always executed.\n+  // Otherwise tests start failing. Therefore we enforce the task creation for now.\n+  tsk.get()", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "0e9464182278e486e5aba4c41cfa461eade3e33c"}, "originalPosition": 16}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fc0c73b35b20e585984e41ab29e9d7e54aee9a6d", "author": {"user": {"login": "breskeby", "name": "Rene Groeschke"}}, "url": "https://github.com/elastic/elasticsearch/commit/fc0c73b35b20e585984e41ab29e9d7e54aee9a6d", "committedDate": "2020-05-19T07:50:55Z", "message": "Fix tiny formatting issue"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE0NDUzOTIw", "url": "https://github.com/elastic/elasticsearch/pull/56627#pullrequestreview-414453920", "createdAt": "2020-05-19T13:38:19Z", "commit": {"oid": "fc0c73b35b20e585984e41ab29e9d7e54aee9a6d"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 44, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}