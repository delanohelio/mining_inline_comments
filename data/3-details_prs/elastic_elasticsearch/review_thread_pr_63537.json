{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTAxNDIwODQw", "number": 63537, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzo1OToyNFrOEspQCQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzo1OToyNFrOEspQCQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE1MjQ4NjQ5OnYy", "diffSide": "RIGHT", "path": "server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java", "isResolved": false, "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQxMzo1OToyNFrOHf_9tg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xMlQyMDowNTowOVrOHgLpcw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA==", "bodyText": "Shouldn't we resolve the listener outside the mutex?", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503315894", "createdAt": "2020-10-12T13:59:24Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java", "diffHunk": "@@ -350,30 +393,73 @@ public String executor() {\n                 });\n         }\n \n+        private boolean failIfAlreadyReleased(ActionListener<PublishWithJoinResponse> listener) {\n+            assert Thread.holdsLock(mutex);\n+            if (serializedStatesReleased) {\n+                listener.onFailure(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "284092d403b69a51997032ffb8b2e6acb5970206"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzM0MzQxMg==", "bodyText": "Good catch. I don't think it's terrible not to, it'll only hold up a few generic threads and should be pretty rare, but yeah let's do it right. Shame it messes up the control flow even more, but see f1b9a9e.", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503343412", "createdAt": "2020-10-12T14:41:55Z", "author": {"login": "DaveCTurner"}, "path": "server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java", "diffHunk": "@@ -350,30 +393,73 @@ public String executor() {\n                 });\n         }\n \n+        private boolean failIfAlreadyReleased(ActionListener<PublishWithJoinResponse> listener) {\n+            assert Thread.holdsLock(mutex);\n+            if (serializedStatesReleased) {\n+                listener.onFailure(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA=="}, "originalCommit": {"oid": "284092d403b69a51997032ffb8b2e6acb5970206"}, "originalPosition": 195}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzUwNzMxNQ==", "bodyText": "Yea I was mainly worried about stupid test failures where we leak the listener in some corner case when the generic pool shuts down too quickly and swallows the response handler. We should be good here (and even better with this change) because we shut down the connections first (which should fail the listeners) and then give it 10s for the listener actions to run before we kill the thread-pool :)", "url": "https://github.com/elastic/elasticsearch/pull/63537#discussion_r503507315", "createdAt": "2020-10-12T20:05:09Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/cluster/coordination/PublicationTransportHandler.java", "diffHunk": "@@ -350,30 +393,73 @@ public String executor() {\n                 });\n         }\n \n+        private boolean failIfAlreadyReleased(ActionListener<PublishWithJoinResponse> listener) {\n+            assert Thread.holdsLock(mutex);\n+            if (serializedStatesReleased) {\n+                listener.onFailure(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwMzMxNTg5NA=="}, "originalCommit": {"oid": "284092d403b69a51997032ffb8b2e6acb5970206"}, "originalPosition": 195}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2924, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}