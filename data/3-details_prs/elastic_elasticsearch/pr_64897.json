{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTE4ODA2MzEy", "number": 64897, "title": "Skip optimization if there are few docs", "bodyText": "In #63643 we added an optimization to the range agg that uses\nfilters instead if we believe it'd be faster. It turns out that building\nthe ScorerSupplier for the filters has a fairly high overhead. So if\nwe think the query would match only a couple thousand documents per\nfilter we avoid the optimization alltogether. This keeps aggregations\nthat complete in a couple of milliseconds from wasting 50ms juggling\nfilters.", "createdAt": "2020-11-10T22:38:27Z", "url": "https://github.com/elastic/elasticsearch/pull/64897", "merged": true, "mergeCommit": {"oid": "e735d46bf227c1aede454a2a77b4354bb65fb7c5"}, "closed": true, "closedAt": "2020-11-11T16:45:40Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdbRRASgH2gAyNTE4ODA2MzEyOjQ4MGZhMjg0ZjUwNGEyYzMxYjU4MTQ4OWFjNmRjMzJmZjI4YWY3MGI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdbfcYjgH2gAyNTE4ODA2MzEyOmUzZjExYzkyYmE3NDQxMjE0NjdlNzA2NDRkZWU0YzBlOTAyNzc5ZWE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "480fa284f504a2c31b581489ac6dc32ff28af70b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/480fa284f504a2c31b581489ac6dc32ff28af70b", "committedDate": "2020-11-10T22:40:09Z", "message": "Skip optimization if there are few docs\n\nIn #63643 we added an optimization to the `range` agg that uses\n`filters` if we believe it'd be faster to do. It turns out that building\nthe `ScorerSupplier` for the `filters` has a fairly high overhead. So if\nwe think the query would match only a couple thousand documents per\nfilter we avoid the optimization alltogether. This keeps aggregations\nthat complete in a couple of milliseconds from wasting 50ms juggling\nfilters."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d90f95f5f0eb4508d6151891bb06f767b8e1f9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4d90f95f5f0eb4508d6151891bb06f767b8e1f9", "committedDate": "2020-11-10T22:50:49Z", "message": "Explain number"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI3NjY1ODEx", "url": "https://github.com/elastic/elasticsearch/pull/64897#pullrequestreview-527665811", "createdAt": "2020-11-10T22:39:54Z", "commit": {"oid": "480fa284f504a2c31b581489ac6dc32ff28af70b"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjozOTo1NFrOHwybGg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMFQyMjo0MDo1MlrOHwyc4Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkxOTgzNA==", "bodyText": "I've moved this into the profile integration test. I'm sad to make another integration test but I don't want to make thousands of docs in a yaml test.", "url": "https://github.com/elastic/elasticsearch/pull/64897#discussion_r520919834", "createdAt": "2020-11-10T22:39:54Z", "author": {"login": "nik9000"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search.aggregation/10_histogram.yml", "diffHunk": "@@ -529,61 +529,6 @@ setup:\n   - match: { profile.shards.0.aggregations.0.breakdown.collect_count: 4 }\n   - match: { profile.shards.0.aggregations.0.debug.total_buckets: 3 }\n \n----\n-\"date_histogram run as filters profiler\":", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "480fa284f504a2c31b581489ac6dc32ff28af70b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMDkyMDI4OQ==", "bodyText": "I calculate this universally now so we can always show it for debugging. In this particular location we don't use it for anything other than the debug message.", "url": "https://github.com/elastic/elasticsearch/pull/64897#discussion_r520920289", "createdAt": "2020-11-10T22:40:52Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/range/GeoDistanceRangeAggregatorFactory.java", "diffHunk": "@@ -66,13 +66,15 @@ public static void registerAggregators(ValuesSourceRegistry.Builder builder) {\n                 cardinality,\n                 metadata) -> {\n                 DistanceSource distanceSource = new DistanceSource((ValuesSource.GeoPoint) valuesSource, distanceType, origin, units);\n+                double averageDocsPerRange = ((double) context.searcher().getIndexReader().maxDoc()) / ranges.length;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "480fa284f504a2c31b581489ac6dc32ff28af70b"}, "originalPosition": 4}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTI4MjA4MDM0", "url": "https://github.com/elastic/elasticsearch/pull/64897#pullrequestreview-528208034", "createdAt": "2020-11-11T14:14:43Z", "commit": {"oid": "a4d90f95f5f0eb4508d6151891bb06f767b8e1f9"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxNDo0M1rOHxO5Nw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMVQxNDoxNDo0M1rOHxO5Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMTM4NjI5NQ==", "bodyText": "Comment on what this is intended to test would be nice.", "url": "https://github.com/elastic/elasticsearch/pull/64897#discussion_r521386295", "createdAt": "2020-11-11T14:14:43Z", "author": {"login": "not-napoleon"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/search/profile/aggregation/AggregationProfilerIT.java", "diffHunk": "@@ -562,4 +567,59 @@ public void testNoProfile() {\n         assertThat(profileResults, notNullValue());\n         assertThat(profileResults.size(), equalTo(0));\n     }\n+\n+    public void testFilterByFilter() throws InterruptedException, IOException {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d90f95f5f0eb4508d6151891bb06f767b8e1f9"}, "originalPosition": 23}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "60c9033982764e2be9cade4ab3240990e3b18892", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/60c9033982764e2be9cade4ab3240990e3b18892", "committedDate": "2020-11-11T14:27:31Z", "message": "Explain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3f11c92ba744121467e70644dee4c0e902779ea", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3f11c92ba744121467e70644dee4c0e902779ea", "committedDate": "2020-11-11T15:11:15Z", "message": "Merge branch 'master' into date_histo_as_range_debug"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1182, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}