{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTIzNTY1", "number": 60316, "title": "Remove ScriptClassInfo from Walker", "bodyText": "This change covers two items:\n\nThis removes ScriptClassInfo from Walker so that we can separate semantic checking from user tree building entirely. ScriptClassInfo is added to a PainlessSemanticAnalysisPhase and a PainlessSemanticHeaderPhase which both extend from their respective Default classes. These classes allow for the special casing of the execute method where ScriptClassInfo is used to inject the appropriate parameters for the execute method. This allows us to potentially check and use a script across more than one context which is especially relevant for stored scripts.\nThis removes the BootstrapInjectionPhase and the ScriptInjectionPhase instead moving the code more appropriately to the other phases instead.", "createdAt": "2020-07-28T16:34:55Z", "url": "https://github.com/elastic/elasticsearch/pull/60316", "merged": true, "mergeCommit": {"oid": "9497f66aacef7193d343259ff3c1273b9c07456a"}, "closed": true, "closedAt": "2020-08-05T19:34:01Z", "author": {"login": "jdconrad"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5F4hvAH2gAyNDU3OTIzNTY1OmZlNGY3YmZiNDM4ZjM4ZTg4ZjU5NmIxOWNlMzhhZTRjZDQ5ZWM1YzY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7-ngogH2gAyNDU3OTIzNTY1OmIzZmQ3NjM2MWU3ZTFkMDBkZjBmMGQ0MDcwOTQ5MTMwODQ1ZjYyNzE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe4f7bfb438f38e88f596b19ce38ae4cd49ec5c6", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe4f7bfb438f38e88f596b19ce38ae4cd49ec5c6", "committedDate": "2020-07-27T18:11:02Z", "message": "Move bootstrap injection into the the ir tree builder phase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02b70959c0a4be12ee85565aaf25ee1cae4ebea5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/02b70959c0a4be12ee85565aaf25ee1cae4ebea5", "committedDate": "2020-07-27T18:42:59Z", "message": "move ScriptClassInfo out of walker and remove unncessary injection\nphases"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4d61ba2e61783c5e884a3af0c161dcff2e42cf4", "committedDate": "2020-07-29T17:45:57Z", "message": "Merge branch 'master' into semantic010"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDg1NTY3", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461085567", "createdAt": "2020-08-04T19:00:22Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTowMDoyMlrOG7tcrg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTowMDoyMlrOG7tcrg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2Mzc5MA==", "bodyText": "Does this close #51841?", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465263790", "createdAt": "2020-08-04T19:00:22Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultSemanticAnalysisPhase.java", "diffHunk": "@@ -261,13 +261,6 @@ public void visitFunction(SFunction userFunctionNode, ScriptScope scriptScope) {\n         if (methodEscape) {\n             functionScope.setCondition(userFunctionNode, MethodEscape.class);\n         }\n-\n-        // TODO: do not specialize for execute\n-        // TODO: https://github.com/elastic/elasticsearch/issues/51841", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 6}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDg2NDY2", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461086466", "createdAt": "2020-08-04T19:01:41Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTowMTo0MVrOG7tfbA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOTowMTo0MVrOG7tfbA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2NDQ5Mg==", "bodyText": "Should you mention injectStaticFields here?", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465264492", "createdAt": "2020-08-04T19:01:41Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/DefaultUserTreeToIRTreePhase.java", "diffHunk": "@@ -176,26 +179,187 @@\n import org.elasticsearch.painless.symbol.Decorations.UnaryType;\n import org.elasticsearch.painless.symbol.Decorations.UpcastPainlessCast;\n import org.elasticsearch.painless.symbol.Decorations.ValueType;\n+import org.elasticsearch.painless.symbol.FunctionTable;\n import org.elasticsearch.painless.symbol.FunctionTable.LocalFunction;\n import org.elasticsearch.painless.symbol.ScriptScope;\n import org.elasticsearch.painless.symbol.SemanticScope.Variable;\n+import org.objectweb.asm.Opcodes;\n \n+import java.lang.invoke.CallSite;\n+import java.lang.invoke.MethodHandles.Lookup;\n+import java.lang.invoke.MethodType;\n import java.lang.reflect.Modifier;\n import java.util.Arrays;\n import java.util.Iterator;\n import java.util.List;\n import java.util.regex.Pattern;\n \n-public class DefaultUserTreeToIRTreeVisitor implements UserTreeVisitor<ScriptScope> {\n+public class DefaultUserTreeToIRTreePhase implements UserTreeVisitor<ScriptScope> {\n \n-    private ClassNode irClassNode;\n+    protected ClassNode irClassNode;\n \n-    protected IRNode visit(ANode userNode, ScriptScope scriptScope) {\n-        if (userNode == null) {\n-            return null;\n-        } else {\n-            userNode.visit(this, scriptScope);\n-            return scriptScope.getDecoration(userNode, IRNodeDecoration.class).getIRNode();\n+    /**\n+     * This injects additional ir nodes required for resolving the def type at runtime.\n+     * This includes injection of ir nodes to add a function to call\n+     * {@link DefBootstrap#bootstrap(PainlessLookup, FunctionTable, Lookup, String, MethodType, int, int, Object...)}\n+     * to do the runtime resolution.\n+     */\n+    protected void injectBootstrapMethod(ScriptScope scriptScope) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 54}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDkyNTY2", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461092566", "createdAt": "2020-08-04T19:10:45Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo0NVrOG7tyOA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo0NVrOG7tyOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2OTMwNA==", "bodyText": "remove indent", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465269304", "createdAt": "2020-08-04T19:10:45Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/PainlessUserTreeToIRTreePhase.java", "diffHunk": "@@ -332,11 +388,11 @@ protected static void injectSandboxExceptions(FunctionNode functionNode) {\n             memberCallNode.setLocation(internalLocation);\n             memberCallNode.setExpressionType(ScriptException.class);\n             memberCallNode.setLocalFunction(new LocalFunction(\n-                    \"convertToScriptException\",\n-                    ScriptException.class,\n-                    Arrays.asList(Throwable.class, Map.class),\n-                    true,\n-                    false\n+                            \"convertToScriptException\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 280}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDkyNjI0", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461092624", "createdAt": "2020-08-04T19:10:50Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo1MFrOG7tyYQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo1MFrOG7tyYQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2OTM0NQ==", "bodyText": "remove indent", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465269345", "createdAt": "2020-08-04T19:10:50Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/PainlessUserTreeToIRTreePhase.java", "diffHunk": "@@ -367,15 +423,15 @@ protected static void injectSandboxExceptions(FunctionNode functionNode) {\n             callSubNode.setExpressionType(Map.class);\n             callSubNode.setBox(PainlessExplainError.class);\n             callSubNode.setMethod(new PainlessMethod(\n-                    PainlessExplainError.class.getMethod(\n-                            \"getHeaders\",\n-                            PainlessLookup.class),\n-                    PainlessExplainError.class,\n-                    null,\n-                    Collections.emptyList(),\n-                    null,\n-                    null,\n-                    null\n+                            PainlessExplainError.class.getMethod(\n+                                    \"getHeaders\",\n+                                    PainlessLookup.class),\n+                            PainlessExplainError.class,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 304}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDkyNzE2", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461092716", "createdAt": "2020-08-04T19:10:57Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo1OFrOG7tysA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMDo1OFrOG7tysA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2OTQyNA==", "bodyText": "remove indent", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465269424", "createdAt": "2020-08-04T19:10:58Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/PainlessUserTreeToIRTreePhase.java", "diffHunk": "@@ -418,11 +474,11 @@ protected static void injectSandboxExceptions(FunctionNode functionNode) {\n                 memberCallNode.setLocation(internalLocation);\n                 memberCallNode.setExpressionType(ScriptException.class);\n                 memberCallNode.setLocalFunction(new LocalFunction(\n-                        \"convertToScriptException\",\n-                        ScriptException.class,\n-                        Arrays.asList(Throwable.class, Map.class),\n-                        true,\n-                        false\n+                                \"convertToScriptException\",\n+                                ScriptException.class,\n+                                Arrays.asList(Throwable.class, Map.class),\n+                                true,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 325}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDkyNzYy", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461092762", "createdAt": "2020-08-04T19:11:02Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMTowMlrOG7ty5Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wNFQxOToxMTowMlrOG7ty5Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NTI2OTQ3Nw==", "bodyText": "remove indent", "url": "https://github.com/elastic/elasticsearch/pull/60316#discussion_r465269477", "createdAt": "2020-08-04T19:11:02Z", "author": {"login": "stu-elastic"}, "path": "modules/lang-painless/src/main/java/org/elasticsearch/painless/phase/PainlessUserTreeToIRTreePhase.java", "diffHunk": "@@ -452,13 +508,13 @@ protected static void injectSandboxExceptions(FunctionNode functionNode) {\n                 callSubNode.setExpressionType(Map.class);\n                 callSubNode.setBox(Collections.class);\n                 callSubNode.setMethod(new PainlessMethod(\n-                        Collections.class.getMethod(\"emptyMap\"),\n-                        Collections.class,\n-                        null,\n-                        Collections.emptyList(),\n-                        null,\n-                        null,\n-                        null\n+                                Collections.class.getMethod(\"emptyMap\"),\n+                                Collections.class,\n+                                null,\n+                                Collections.emptyList(),\n+                                null,\n+                                null,\n+                                null", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "originalPosition": 347}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYxMDkzNDY5", "url": "https://github.com/elastic/elasticsearch/pull/60316#pullrequestreview-461093469", "createdAt": "2020-08-04T19:12:09Z", "commit": {"oid": "a4d61ba2e61783c5e884a3af0c161dcff2e42cf4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3fbd0bcdf699ca71db447a21ea00ce18e8aacbd5", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/3fbd0bcdf699ca71db447a21ea00ce18e8aacbd5", "committedDate": "2020-08-05T16:59:29Z", "message": "Merge branch 'master' into semantic010"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b3fd76361e7e1d00df0f0d4070949130845f6271", "author": {"user": {"login": "jdconrad", "name": "Jack Conradson"}}, "url": "https://github.com/elastic/elasticsearch/commit/b3fd76361e7e1d00df0f0d4070949130845f6271", "committedDate": "2020-08-05T17:24:53Z", "message": "response to pr comments"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3713, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}