{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDEwNjQxMzQ5", "number": 55921, "title": "[ML] fix auto-upgrade service so that it runs when indices are available", "bodyText": "MlAutoUpdateService did not take two considerations:\n\nWhat if state is currently being recovered from disk\nWhat if the upgrade processes are able to run given current state?\n\nThis commit fixes these two concerns.\ncloses #55909", "createdAt": "2020-04-29T11:04:28Z", "url": "https://github.com/elastic/elasticsearch/pull/55921", "merged": true, "mergeCommit": {"oid": "a56692b2fb24c5e19e7ae6c046a8c49c83586e29"}, "closed": true, "closedAt": "2020-04-30T11:25:32Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABccWY4ZgH2gAyNDEwNjQxMzQ5OjFjYjhlYjJlMDU5NWE5M2VjMzVhOTM5MjAxZjY3MWExNDdlMDQzOGQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABccob_KAFqTQwMzI4OTg5NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "1cb8eb2e0595a93ec35a939201f671a147e0438d", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/1cb8eb2e0595a93ec35a939201f671a147e0438d", "committedDate": "2020-04-29T11:01:03Z", "message": "[ML] fix auto-upgrade service so that it runs when indices are available"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAyODczMDM4", "url": "https://github.com/elastic/elasticsearch/pull/55921#pullrequestreview-402873038", "createdAt": "2020-04-29T17:13:41Z", "commit": {"oid": "1cb8eb2e0595a93ec35a939201f671a147e0438d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzoxMzo0MVrOGOI2Bg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOVQxNzoxMzo0MVrOGOI2Bg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNzQ3ODE1MA==", "bodyText": "Should we do this after we check for completed or currently_updating actions? Those isAbleToRun checks will be more expensive.", "url": "https://github.com/elastic/elasticsearch/pull/55921#discussion_r417478150", "createdAt": "2020-04-29T17:13:41Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/MlAutoUpdateService.java", "diffHunk": "@@ -42,13 +45,17 @@ public MlAutoUpdateService(ThreadPool threadPool, List<UpdateAction> updateActio\n \n     @Override\n     public void clusterChanged(ClusterChangedEvent event) {\n+        if (event.state().blocks().hasGlobalBlock(GatewayService.STATE_NOT_RECOVERED_BLOCK)) {\n+            return;\n+        }\n         if (event.localNodeMaster() == false) {\n             return;\n         }\n \n         Version minNodeVersion = event.state().getNodes().getMinNodeVersion();\n         final List<UpdateAction> toRun = updateActions.stream()\n             .filter(action -> action.isMinNodeVersionSupported(minNodeVersion))\n+            .filter(action -> action.isAbleToRun(event.state()))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1cb8eb2e0595a93ec35a939201f671a147e0438d"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b8ce88ef4fb6e65f565a2f27e80f9367e05f0d58", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/b8ce88ef4fb6e65f565a2f27e80f9367e05f0d58", "committedDate": "2020-04-29T17:28:31Z", "message": "moving isAbleToRun check to utility thread pool;"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5a48a5cab90bbd8bf1dadff2beda8c6d2c90388d", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/5a48a5cab90bbd8bf1dadff2beda8c6d2c90388d", "committedDate": "2020-04-29T18:36:57Z", "message": "Revert \"moving isAbleToRun check to utility thread pool;\"\n\nThis reverts commit b8ce88ef4fb6e65f565a2f27e80f9367e05f0d58."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f45b709f7be57252f1bf23dbf7ca9d83dbc958a", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f45b709f7be57252f1bf23dbf7ca9d83dbc958a", "committedDate": "2020-04-29T18:37:28Z", "message": "fixing isAbleToRun to be after already ran check"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDAzMjg5ODk1", "url": "https://github.com/elastic/elasticsearch/pull/55921#pullrequestreview-403289895", "createdAt": "2020-04-30T08:02:44Z", "commit": {"oid": "6f45b709f7be57252f1bf23dbf7ca9d83dbc958a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 275, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}