{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyNjg3OTk1", "number": 54039, "title": "Add REST APIs for IndexTemplateV2Metadata CRUD", "bodyText": "This commit adds the get/put/delete APIs for interacting with the now v2 versions of index\ntemplates.\nThese APIs are behind the existing es.itv2_feature_flag_registered system property feature flag.\nRelates to #53101", "createdAt": "2020-03-23T23:13:22Z", "url": "https://github.com/elastic/elasticsearch/pull/54039", "merged": true, "mergeCommit": {"oid": "e89e916738ff132cd2b2be7da06f5dd3a38b14ca"}, "closed": true, "closedAt": "2020-03-27T13:56:29Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQmo8VgH2gAyMzkyNjg3OTk1OjE0MzkzNjQ2ZWZjZGY2ZjQyNjJmYjA4YzhiMzE5OTU2OTRlYjYzYTU=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRsP7egFqTM4MjY1MDkzOQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "14393646efcdf6f4262fb08c8b31995694eb63a5", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/14393646efcdf6f4262fb08c8b31995694eb63a5", "committedDate": "2020-03-23T23:09:59Z", "message": "Add REST APIs for IndexTemplateV2Metadata CRUD\n\nThis commit adds the get/put/delete APIs for interacting with the now v2 versions of index\ntemplates.\n\nThese APIs are behind the existing `es.itv2_feature_flag_registered` system property feature flag.\n\nRelates to #53101"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5487f93fbdf1bd0d3518e40bb068c5e275c98e53", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/5487f93fbdf1bd0d3518e40bb068c5e275c98e53", "committedDate": "2020-03-24T14:08:45Z", "message": "Add exceptions for HLRC tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/2449ae96b4f2bbceaf794e68802313fc50648c23", "committedDate": "2020-03-24T14:09:22Z", "message": "Merge branch 'master' into itv2-add-itv2-rest-apis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjg2NjIy", "url": "https://github.com/elastic/elasticsearch/pull/54039#pullrequestreview-381286622", "createdAt": "2020-03-25T15:52:12Z", "commit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTo1MjoxMlrOF7h4DQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNTo1Njo0MVrOF7iGfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2NTMyNQ==", "bodyText": "maybe all the action names should contain index_template instead of template_v2? In this it would be indices:admin/index_template/delete. When v1 has been removed the v2 name is going to be confusing and changing that isn't fun from a bwc point of view.", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397965325", "createdAt": "2020-03-25T15:52:12Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/template/delete/DeleteIndexTemplateV2Action.java", "diffHunk": "@@ -0,0 +1,90 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.indices.template.delete;\n+\n+import org.elasticsearch.action.ActionRequestValidationException;\n+import org.elasticsearch.action.ActionType;\n+import org.elasticsearch.action.support.master.AcknowledgedResponse;\n+import org.elasticsearch.action.support.master.MasterNodeRequest;\n+import org.elasticsearch.common.io.stream.StreamInput;\n+import org.elasticsearch.common.io.stream.StreamOutput;\n+\n+import java.io.IOException;\n+\n+import static org.elasticsearch.action.ValidateActions.addValidationError;\n+\n+public class DeleteIndexTemplateV2Action extends ActionType<AcknowledgedResponse> {\n+\n+    public static final DeleteIndexTemplateV2Action INSTANCE = new DeleteIndexTemplateV2Action();\n+    public static final String NAME = \"indices:admin/template_v2/delete\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2Nzk1Mg==", "bodyText": "Are tests for this method going to be added later or should the tests be part of this PR?", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397967952", "createdAt": "2020-03-25T15:55:26Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -234,6 +234,103 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n             });\n     }\n \n+    /**\n+     * Add the given component template to the cluster state. If {@code create} is true, an\n+     * exception will be thrown if the component template already exists\n+     */\n+    public void putIndexTemplateV2(final String cause, final boolean create, final String name, final TimeValue masterTimeout,\n+                                   final IndexTemplateV2 template, final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-index-template-v2 [\" + name + \"], cause [\" + cause + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    return addIndexTemplateV2(currentState, create, name, template);\n+                }\n+\n+                @Override\n+                public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {\n+                    listener.onResponse(new AcknowledgedResponse(true));\n+                }\n+            });\n+    }\n+\n+    // Package visible for testing\n+    static ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean create,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2ODI5NA==", "bodyText": "Maybe move the logic of this method also to a static method, so that it can be unit tested?", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397968294", "createdAt": "2020-03-25T15:55:53Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexTemplateService.java", "diffHunk": "@@ -234,6 +234,103 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n             });\n     }\n \n+    /**\n+     * Add the given component template to the cluster state. If {@code create} is true, an\n+     * exception will be thrown if the component template already exists\n+     */\n+    public void putIndexTemplateV2(final String cause, final boolean create, final String name, final TimeValue masterTimeout,\n+                                   final IndexTemplateV2 template, final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"create-index-template-v2 [\" + name + \"], cause [\" + cause + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    return addIndexTemplateV2(currentState, create, name, template);\n+                }\n+\n+                @Override\n+                public void clusterStateProcessed(String source, ClusterState oldState, ClusterState newState) {\n+                    listener.onResponse(new AcknowledgedResponse(true));\n+                }\n+            });\n+    }\n+\n+    // Package visible for testing\n+    static ClusterState addIndexTemplateV2(final ClusterState currentState, final boolean create,\n+                                           final String name, final IndexTemplateV2 template) {\n+        if (create && currentState.metaData().templatesV2().containsKey(name)) {\n+            throw new IllegalArgumentException(\"index template [\" + name + \"] already exists\");\n+        }\n+\n+        // TODO: validation of index template\n+        // validateAndAddTemplate(request, templateBuilder, indicesService, xContentRegistry);\n+\n+        logger.info(\"adding index template [{}]\", name);\n+        return ClusterState.builder(currentState)\n+            .metaData(MetaData.builder(currentState.metaData()).put(name, template))\n+            .build();\n+    }\n+\n+    /**\n+     * Remove the given index template from the cluster state. The index template name\n+     * supports simple regex wildcards for removing multiple index templates at a time.\n+     */\n+    public void removeIndexTemplateV2(final String name, final TimeValue masterTimeout,\n+                                      final ActionListener<AcknowledgedResponse> listener) {\n+        clusterService.submitStateUpdateTask(\"remove-index-template-v2 [\" + name + \"]\",\n+            new ClusterStateUpdateTask(Priority.URGENT) {\n+\n+                @Override\n+                public TimeValue timeout() {\n+                    return masterTimeout;\n+                }\n+\n+                @Override\n+                public void onFailure(String source, Exception e) {\n+                    listener.onFailure(e);\n+                }\n+\n+                @Override\n+                public ClusterState execute(ClusterState currentState) {\n+                    Set<String> templateNames = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23"}, "originalPosition": 72}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5Nzk2OTAyMw==", "bodyText": "Maybe also add unit tests for the request classes?", "url": "https://github.com/elastic/elasticsearch/pull/54039#discussion_r397969023", "createdAt": "2020-03-25T15:56:41Z", "author": {"login": "martijnvg"}, "path": "server/src/test/java/org/elasticsearch/action/admin/indices/template/get/GetIndexTemplateV2ResponseTests.java", "diffHunk": "@@ -0,0 +1,54 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.action.admin.indices.template.get;\n+\n+import org.elasticsearch.cluster.metadata.IndexTemplateV2;\n+import org.elasticsearch.cluster.metadata.IndexTemplateV2Tests;\n+import org.elasticsearch.common.io.stream.Writeable;\n+import org.elasticsearch.test.AbstractWireSerializingTestCase;\n+\n+import java.io.IOException;\n+import java.util.Collections;\n+import java.util.HashMap;\n+import java.util.Map;\n+\n+public class GetIndexTemplateV2ResponseTests extends AbstractWireSerializingTestCase<GetIndexTemplateV2Action.Response> {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2449ae96b4f2bbceaf794e68802313fc50648c23"}, "originalPosition": 32}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "05c3aaf61e04621fb891b6d75740d7b38d34746f", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/05c3aaf61e04621fb891b6d75740d7b38d34746f", "committedDate": "2020-03-25T21:12:25Z", "message": "Add skips for 7.x versions"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "90ac607dc9a09947534fc08da758ec20536664f9", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/90ac607dc9a09947534fc08da758ec20536664f9", "committedDate": "2020-03-25T21:12:25Z", "message": "Use index_template instead of template_v2 in action names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "675ca827547be18568ac2da37c35f374dd16e471", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/675ca827547be18568ac2da37c35f374dd16e471", "committedDate": "2020-03-25T21:12:25Z", "message": "Add test for MetaDataIndexTemplateService.addIndexTemplateV2"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ba355e42134fbcd35faa343891c1b886d6343608", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/ba355e42134fbcd35faa343891c1b886d6343608", "committedDate": "2020-03-25T22:20:58Z", "message": "Merge branch 'master' into itv2-add-itv2-rest-apis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "62370f922c90a58e0119ffc0e6ed780f918db542", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/62370f922c90a58e0119ffc0e6ed780f918db542", "committedDate": "2020-03-25T23:01:12Z", "message": "Move removal to static method and add test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9e54da63c2a18319da59e2961529b6fa2ab6f452", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/9e54da63c2a18319da59e2961529b6fa2ab6f452", "committedDate": "2020-03-26T16:48:38Z", "message": "Add unit tests for request classes (implement hashCode & equals)"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgyNjUwOTM5", "url": "https://github.com/elastic/elasticsearch/pull/54039#pullrequestreview-382650939", "createdAt": "2020-03-27T08:16:01Z", "commit": {"oid": "9e54da63c2a18319da59e2961529b6fa2ab6f452"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1646, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}