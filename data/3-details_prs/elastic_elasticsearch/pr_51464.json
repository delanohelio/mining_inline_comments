{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzY3MjY0MTgy", "number": 51464, "title": "Use Consistent ClusterState throughout Snapshot API Calls", "bodyText": "We shouldn't be using potentially changing versions of the cluster state\nwhen answering a snapshot status API call by calling SnapshotService#currentSnapshots multiple times (each time using ClusterService#state under the hood) but instead pass down the state from the transport action.\nHaving these API behave more in a more deterministic way will make it easier to use them once parallel repository operations\nare introduced.", "createdAt": "2020-01-26T21:38:07Z", "url": "https://github.com/elastic/elasticsearch/pull/51464", "merged": true, "mergeCommit": {"oid": "1e5f77eb1942e77f09d901961f73184ad1294730"}, "closed": true, "closedAt": "2020-01-27T10:58:52Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb-PGqMgH2gAyMzY3MjY0MTgyOmE2OTE0MjRjYzRmYzE2NTdlYjA0MzhhMTNhNTQwYWU0MzgxZjViYjI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb-Z1dRgFqTM0ODU0NzAwMQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a691424cc4fc1657eb0438a13a540ae4381f5bb2", "committedDate": "2020-01-26T21:34:05Z", "message": "Use Consistent ClusterState throughout Snapshot API Calls\n\nWe shouldn't be using potentially changing versions of the cluster state\nwhen answering a snapshot status API call. Having these API behave more\ndeterministically will make it easier to use them once parallel repository operations\nare introduced."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NDA2NTMy", "url": "https://github.com/elastic/elasticsearch/pull/51464#pullrequestreview-348406532", "createdAt": "2020-01-26T21:39:47Z", "commit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMTozOTo0N1rOFh19NA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yNlQyMTozOTo0N1rOFh19NA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTAzMTM0OA==", "bodyText": "Making the fact that we're using a potentially racy CS here, leading to some needless snapshot delete failures, obvious was the main motivation behind this change actually (a bigger change to deletes making use of this cleanup is coming in #51463).", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371031348", "createdAt": "2020-01-26T21:39:47Z", "author": {"login": "original-brownbear"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -1222,7 +1226,8 @@ public void deleteSnapshot(final String repositoryName, final String snapshotNam\n             // if nothing found by the same name, then look in the cluster state for current in progress snapshots\n             long repoGenId = repositoryData.getGenId();\n             if (matchedEntry.isPresent() == false) {\n-                Optional<SnapshotsInProgress.Entry> matchedInProgress = currentSnapshots(repositoryName, Collections.emptyList()).stream()\n+                Optional<SnapshotsInProgress.Entry> matchedInProgress = currentSnapshots(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2"}, "originalPosition": 72}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NDkxMzEy", "url": "https://github.com/elastic/elasticsearch/pull/51464#pullrequestreview-348491312", "createdAt": "2020-01-27T08:19:56Z", "commit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwODoxOTo1NlrOFh6gow==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwODoxOTo1NlrOFh6gow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTEwNTk1NQ==", "bodyText": "Should we just pass down SnapshotsInProgress? Makes it a bit clearer what the dependencies are", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371105955", "createdAt": "2020-01-27T08:19:56Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java", "diffHunk": "@@ -103,14 +103,14 @@ protected void masterOperation(Task task, final GetSnapshotsRequest request, fin\n                                 response ->\n                                         // switch to GENERIC thread pool because it might be long running operation\n                                         threadPool.executor(ThreadPool.Names.GENERIC).execute(\n-                                                () -> getMultipleReposSnapshotInfo(response.repositories(), request.snapshots(),\n+                                                () -> getMultipleReposSnapshotInfo(state, response.repositories(), request.snapshots(),\n                                                         request.ignoreUnavailable(), request.verbose(), listener)),\n                                 listener::onFailure),\n                         GetRepositoriesResponse::new));\n     }\n \n-    private void getMultipleReposSnapshotInfo(List<RepositoryMetaData> repos, String[] snapshots, boolean ignoreUnavailable,\n-                                              boolean verbose, ActionListener<GetSnapshotsResponse> listener) {\n+    private void getMultipleReposSnapshotInfo(ClusterState state, List<RepositoryMetaData> repos, String[] snapshots,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08dfd9bf297aed0412e3ac1960ce12450f5bc877", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/08dfd9bf297aed0412e3ac1960ce12450f5bc877", "committedDate": "2020-01-27T08:37:58Z", "message": "Merge remote-tracking branch 'elastic/master' into consistent-cs-for-snapshot-status-apis"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NTAxMTg1", "url": "https://github.com/elastic/elasticsearch/pull/51464#pullrequestreview-348501185", "createdAt": "2020-01-27T08:42:05Z", "commit": {"oid": "a691424cc4fc1657eb0438a13a540ae4381f5bb2"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f2efe16f149c787e75fae3fe80042c5c303ee63d", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f2efe16f149c787e75fae3fe80042c5c303ee63d", "committedDate": "2020-01-27T08:55:24Z", "message": "CR: pass around SnapshotsInProgress"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NTM4MDYx", "url": "https://github.com/elastic/elasticsearch/pull/51464#pullrequestreview-348538061", "createdAt": "2020-01-27T09:49:49Z", "commit": {"oid": "f2efe16f149c787e75fae3fe80042c5c303ee63d"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwOTo0OTo0OVrOFh8zLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0yN1QwOTo0OTo0OVrOFh8zLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3MTE0MzQ2OQ==", "bodyText": "Can you add @Nullable to the methods that pass SnapshotsInProgress, or alternatively, pass an empty instance?", "url": "https://github.com/elastic/elasticsearch/pull/51464#discussion_r371143469", "createdAt": "2020-01-27T09:49:49Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/action/admin/cluster/snapshots/get/TransportGetSnapshotsAction.java", "diffHunk": "@@ -133,16 +135,16 @@ private void getMultipleReposSnapshotInfo(List<RepositoryMetaData> repos, String\n                     } else {\n                         groupedListener.onFailure(e);\n                     }\n-                }), wrappedListener -> getSingleRepoSnapshotInfo(repoName, snapshots, ignoreUnavailable, verbose,\n+                }), wrappedListener -> getSingleRepoSnapshotInfo(snapshotsInProgress, repoName, snapshots, ignoreUnavailable, verbose,\n                     ActionListener.map(wrappedListener, snInfos -> GetSnapshotsResponse.Response.snapshots(repoName, snInfos)))));\n         }\n     }\n \n-    private void getSingleRepoSnapshotInfo(String repo, String[] snapshots, boolean ignoreUnavailable, boolean verbose,\n-                                           ActionListener<List<SnapshotInfo>> listener) {\n+    private void getSingleRepoSnapshotInfo(SnapshotsInProgress snapshotsInProgress, String repo, String[] snapshots,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f2efe16f149c787e75fae3fe80042c5c303ee63d"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "bb2ded549f018ef8fa324a17b95063085f2f34ba", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/bb2ded549f018ef8fa324a17b95063085f2f34ba", "committedDate": "2020-01-27T09:51:01Z", "message": "Merge remote-tracking branch 'elastic/master' into consistent-cs-for-snapshot-status-apis"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2bfe8f57015164474082adbe8b00d912a65354a7", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/2bfe8f57015164474082adbe8b00d912a65354a7", "committedDate": "2020-01-27T10:02:14Z", "message": "CR: nullables"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzQ4NTQ3MDAx", "url": "https://github.com/elastic/elasticsearch/pull/51464#pullrequestreview-348547001", "createdAt": "2020-01-27T10:04:15Z", "commit": {"oid": "2bfe8f57015164474082adbe8b00d912a65354a7"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2736, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}