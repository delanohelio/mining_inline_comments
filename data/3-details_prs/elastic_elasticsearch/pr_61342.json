{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwMjkyODA2", "number": 61342, "title": "Allocate newly created indices on data_hot tier nodes", "bodyText": "This commit adds the functionality to allocate newly created indices on nodes in the \"hot\" tier by\ndefault when they are created.\nThis does not break existing behavior, as nodes with the data role are considered to be part of\nthe hot tier. Users that separate their deployments by using the data_hot (and data_warm,\ndata_cold, data_frozen) roles will have their data allocated on the hot tier nodes now by\ndefault.\nThis change is a little more complicated than changing the default value for\nindex.routing.allocation.include._tier from null to \"data_hot\". Instead, this adds the ability to\nhave a plugin inject a setting into the builder for a newly created index. This has the benefit of\nallowing this setting to be visible as part of the settings when retrieving the index, for example:\n// Create an index\nPUT /eggplant\n\n// Get an index\nGET /eggplant?flat_settings\n\nReturns the default settings now of:\n{\n  \"eggplant\" : {\n    \"aliases\" : { },\n    \"mappings\" : { },\n    \"settings\" : {\n      \"index.creation_date\" : \"1597855465598\",\n      \"index.number_of_replicas\" : \"1\",\n      \"index.number_of_shards\" : \"1\",\n      \"index.provided_name\" : \"eggplant\",\n      \"index.routing.allocation.include._tier\" : \"data_hot\",\n      \"index.uuid\" : \"6ySG78s9RWGystRipoBFCA\",\n      \"index.version.created\" : \"8000099\"\n    }\n  }\n}\nAfter the initial setting of this setting, it can be treated like any other index level setting.\nThis new setting is not set on a new index if any of the following is true:\n\nThe index is created with an index.routing.allocation.include.<anything> setting\nThe index is created with an index.routing.allocation.exclude.<anything> setting\nThe index is created with an index.routing.allocation.require.<anything> setting\nThe index is created with a null index.routing.allocation.include._tier value\nThe index was created from an existing source metadata (shrink, clone, split, etc)\n\nRelates to #60848", "createdAt": "2020-08-19T16:50:25Z", "url": "https://github.com/elastic/elasticsearch/pull/61342", "merged": true, "mergeCommit": {"oid": "28cec563b1a83622d8dbd9fd8bda7381f1aeefe6"}, "closed": true, "closedAt": "2020-08-27T18:51:13Z", "author": {"login": "dakrone"}, "timelineItems": {"totalCount": 24, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdAeVfwAH2gAyNDcwMjkyODA2OjgzZmM0YTc2YzBmMDEzMTAzZDI5MWRlMGQ1OTBiZjQzMGFhOTFlMzA=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdDEQwkAH2gAyNDcwMjkyODA2OjJhYTdiNGYzNjYxOGM3YTkwNWVjNTU1NWQ4MjhmMWMyY2Y3ZGY0ZTE=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "83fc4a76c0f013103d291de0d590bf430aa91e30", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/83fc4a76c0f013103d291de0d590bf430aa91e30", "committedDate": "2020-08-19T16:37:52Z", "message": "Allocate newly created indices on data_hot tier nodes\n\nThis commit adds the functionality to allocate newly created indices on nodes in the \"hot\" tier by\ndefault when they are created.\n\nThis does not break existing behavior, as nodes with the `data` role are considered to be part of\nthe hot tier. Users that separate their deployments by using the `data_hot` (and `data_warm`,\n`data_cold`, `data_frozen`) roles will have their data allocated on the hot tier nodes now by\ndefault.\n\nThis change is a little more complicated than changing the default value for\n`index.routing.allocation.include._tier` from null to \"data_hot\". Instead, this adds the ability to\nhave a plugin inject a setting into the builder for a newly created index. This has the benefit of\nallowing this setting to be visible as part of the settings when retrieving the index, for example:\n\n```\n// Create an index\nPUT /eggplant\n\n// Get an index\nGET /eggplant?flat_settings\n```\n\nReturns the default settings now of:\n\n```json\n{\n  \"eggplant\" : {\n    \"aliases\" : { },\n    \"mappings\" : { },\n    \"settings\" : {\n      \"index.creation_date\" : \"1597855465598\",\n      \"index.number_of_replicas\" : \"1\",\n      \"index.number_of_shards\" : \"1\",\n      \"index.provided_name\" : \"eggplant\",\n      \"index.routing.allocation.include._tier\" : \"data_hot\",\n      \"index.uuid\" : \"6ySG78s9RWGystRipoBFCA\",\n      \"index.version.created\" : \"8000099\"\n    }\n  }\n}\n```\n\nAfter the initial setting of this setting, it can be treated like any other index level setting.\n\nThis new setting is *not* set on a new index if any of the following is true:\n\n- The index is created with an `index.routing.allocation.include._tier` setting\n- The index is created with an `index.routing.allocation.exclude._tier` setting\n- The index is created with an `index.routing.allocation.require._tier` setting\n- The index is created with a null `index.routing.allocation.include._tier` value\n- The index was created from an existing source metadata (shrink, clone, split, etc)\n\nRelates to #60848"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b60e93cad4a766abf8ace7ffb9c28b0a7818832", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b60e93cad4a766abf8ace7ffb9c28b0a7818832", "committedDate": "2020-08-19T17:57:49Z", "message": "Fix docs"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDcwOTkzOTE0", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-470993914", "createdAt": "2020-08-19T21:57:39Z", "commit": {"oid": "3b60e93cad4a766abf8ace7ffb9c28b0a7818832"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5005a73084d944262ffdfd7d02ee6a0bc03e9402", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/5005a73084d944262ffdfd7d02ee6a0bc03e9402", "committedDate": "2020-08-20T20:04:13Z", "message": "Switch from setting listener to explicit index setting provider"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b4183a78ea66a6305aad02588ea75bb68e1c2161", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/b4183a78ea66a6305aad02588ea75bb68e1c2161", "committedDate": "2020-08-20T21:28:41Z", "message": "Unset tier include for JDBC tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dfe922bc301ae0ce46927978c70975ad0a658c7b", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/dfe922bc301ae0ce46927978c70975ad0a658c7b", "committedDate": "2020-08-24T15:21:07Z", "message": "Use Settings instead of a Map<String, String>"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "08e4ab57bf9a9bf23ab496d398d809fb6118147f", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/08e4ab57bf9a9bf23ab496d398d809fb6118147f", "committedDate": "2020-08-24T21:50:32Z", "message": "Check for all index level allocation settings when putting explicit setting in place"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f1c44a24b556748ec531c56986e565accb03cb7e", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/f1c44a24b556748ec531c56986e565accb03cb7e", "committedDate": "2020-08-24T22:33:31Z", "message": "Fix some tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "53a5ed7ec7fd336ea46342ce0cd471fd9f321edc", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/53a5ed7ec7fd336ea46342ce0cd471fd9f321edc", "committedDate": "2020-08-24T23:13:44Z", "message": "Fix ILM test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48", "committedDate": "2020-08-24T23:14:30Z", "message": "Merge branch 'master' into dt-default-deploy-on-hot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1NzU2ODY2", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-475756866", "createdAt": "2020-08-26T18:39:10Z", "commit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "state": "COMMENTED", "comments": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQxODozOToxMFrOHHYyvQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMDowNzo0MFrOHHb5Lw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUwODI4NQ==", "bodyText": "nit: :s/listener/provider", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477508285", "createdAt": "2020-08-26T18:39:10Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -595,14 +611,65 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n      * @return the aggregated settings for the new index\n      */\n     static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClusterStateUpdateRequest request,\n-                                           Settings templateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n-                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator) {\n-        Settings.Builder indexSettingsBuilder = Settings.builder();\n+                                           Settings combinedTemplateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n+                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator,\n+                                           Set<ExplicitIndexSettingProvider> explicitIndexSettingProviders) {\n+        // Create builders for the template and request settings. We transform these into builders\n+        // because we may want settings to be \"removed\" from these prior to being set on the new\n+        // index (see more comments below)\n+        final Settings.Builder templateSettings = Settings.builder().put(combinedTemplateSettings);\n+        final Settings.Builder requestSettings = Settings.builder().put(request.settings());\n+\n+        final Settings.Builder indexSettingsBuilder = Settings.builder();\n         if (sourceMetadata == null) {\n-            indexSettingsBuilder.put(templateSettings);\n+            final Settings.Builder explicitDefaultSettings = Settings.builder();\n+            final Settings templateAndRequestSettings = Settings.builder()\n+                .put(combinedTemplateSettings)\n+                .put(request.settings())\n+                .build();\n+\n+            // Loop through all the explicit index setting providers, adding them to the\n+            // explicitDefaultSettings map\n+            for (ExplicitIndexSettingProvider listener : explicitIndexSettingProviders) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzMDczMw==", "bodyText": "If we expected exceptions here, we should document it on the interface. However, I don't think we should.\nI think the contract should be that a provider provides all valid settings, or Settings.EMPTY if none can be satisfied. Removing the catch here and any exception thrown by a provider impl would result in a 500 and no index created, which I think is slightly better then settings that should have been applied but were not.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477530733", "createdAt": "2020-08-26T19:13:41Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -595,14 +611,65 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n      * @return the aggregated settings for the new index\n      */\n     static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClusterStateUpdateRequest request,\n-                                           Settings templateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n-                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator) {\n-        Settings.Builder indexSettingsBuilder = Settings.builder();\n+                                           Settings combinedTemplateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n+                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator,\n+                                           Set<ExplicitIndexSettingProvider> explicitIndexSettingProviders) {\n+        // Create builders for the template and request settings. We transform these into builders\n+        // because we may want settings to be \"removed\" from these prior to being set on the new\n+        // index (see more comments below)\n+        final Settings.Builder templateSettings = Settings.builder().put(combinedTemplateSettings);\n+        final Settings.Builder requestSettings = Settings.builder().put(request.settings());\n+\n+        final Settings.Builder indexSettingsBuilder = Settings.builder();\n         if (sourceMetadata == null) {\n-            indexSettingsBuilder.put(templateSettings);\n+            final Settings.Builder explicitDefaultSettings = Settings.builder();\n+            final Settings templateAndRequestSettings = Settings.builder()\n+                .put(combinedTemplateSettings)\n+                .put(request.settings())\n+                .build();\n+\n+            // Loop through all the explicit index setting providers, adding them to the\n+            // explicitDefaultSettings map\n+            for (ExplicitIndexSettingProvider listener : explicitIndexSettingProviders) {\n+                try {\n+                    explicitDefaultSettings.put(listener.getExplicitIndexSettings(request.index(), templateAndRequestSettings));\n+                } catch (Exception e) {\n+                    logger.warn(new ParameterizedMessage(\"failed invoking explicit setting provider for creation of [{}] index\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 102}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzUzOTQxMA==", "bodyText": "nit: this if/elseif/else can be simplified to an if/elseif (just a minor style preference)", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477539410", "createdAt": "2020-08-26T19:30:18Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/DataTier.java", "diffHunk": "@@ -137,4 +142,28 @@ public static boolean isColdNode(DiscoveryNode discoveryNode) {\n     public static boolean isFrozenNode(DiscoveryNode discoveryNode) {\n         return discoveryNode.getRoles().contains(DATA_FROZEN_NODE_ROLE) || discoveryNode.getRoles().contains(DiscoveryNodeRole.DATA_ROLE);\n     }\n+\n+    /**\n+     * This listener injects the setting allocating all newly created indices with\n+     * {@code index.routing.allocation.include._tier: \"data_hot\"} unless the user overrides the\n+     * setting while the index is being created (in a create index request for instance)\n+     */\n+    public static class DefaultHotAllocationSettingProvider implements ExplicitIndexSettingProvider {\n+        @Override\n+        public Settings getExplicitIndexSettings(String indexName, Settings indexSettings) {\n+            Set<String> settings = indexSettings.keySet();\n+            if (settings.contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0MTE3Mg==", "bodyText": "nit: the listener ? not sure i follow what that is in reference to..", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477541172", "createdAt": "2020-08-26T19:33:51Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/DataTier.java", "diffHunk": "@@ -137,4 +142,28 @@ public static boolean isColdNode(DiscoveryNode discoveryNode) {\n     public static boolean isFrozenNode(DiscoveryNode discoveryNode) {\n         return discoveryNode.getRoles().contains(DATA_FROZEN_NODE_ROLE) || discoveryNode.getRoles().contains(DiscoveryNodeRole.DATA_ROLE);\n     }\n+\n+    /**\n+     * This listener injects the setting allocating all newly created indices with", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 22}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU0OTM4Nw==", "bodyText": "probably want to update https://www.elastic.co/guide/en/elasticsearch/reference/7.9/shard-allocation-filtering.html with or soon after this PR. (also https://www.elastic.co/guide/en/elasticsearch/reference/7.9/modules-node.html#data-node could use an update, but is outside the scope of this PR)", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477549387", "createdAt": "2020-08-26T19:49:13Z", "author": {"login": "jakelandis"}, "path": "docs/reference/api-conventions.asciidoc", "diffHunk": "@@ -391,6 +391,7 @@ Returns:\n       \"index.creation_date\": \"1474389951325\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1MDk4OQ==", "bodyText": "outside the scope of this PR, but can you use _tier with the node specification  ?", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477550989", "createdAt": "2020-08-26T19:52:06Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/cluster/node/DiscoveryNodeFilters.java", "diffHunk": "@@ -181,6 +181,9 @@ public boolean match(DiscoveryNode node) {\n                         }\n                     }\n                 }\n+            } else if (\"_tier\".equals(attr)) {\n+                // Always allow _tier as an attribute, will be handled elsewhere", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1MTM1MQ==", "bodyText": "nit: doesn't return a map", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477551351", "createdAt": "2020-08-26T19:52:51Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/index/shard/ExplicitIndexSettingProvider.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.shard;\n+\n+import org.elasticsearch.common.settings.Settings;\n+\n+/**\n+ * An {@link ExplicitIndexSettingProvider} is a provider for index level settings that can be set\n+ * explicitly as a default value (so they show up as \"set\" for newly created indices)\n+ */\n+public interface ExplicitIndexSettingProvider {\n+    /**\n+     * Returns a map of explicitly set default index settings for the given index.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 30}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1MjAyMw==", "bodyText": "a debug message here might be helpful for future troubleshooting.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477552023", "createdAt": "2020-08-26T19:54:09Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/DataTier.java", "diffHunk": "@@ -137,4 +142,28 @@ public static boolean isColdNode(DiscoveryNode discoveryNode) {\n     public static boolean isFrozenNode(DiscoveryNode discoveryNode) {\n         return discoveryNode.getRoles().contains(DATA_FROZEN_NODE_ROLE) || discoveryNode.getRoles().contains(DiscoveryNodeRole.DATA_ROLE);\n     }\n+\n+    /**\n+     * This listener injects the setting allocating all newly created indices with\n+     * {@code index.routing.allocation.include._tier: \"data_hot\"} unless the user overrides the\n+     * setting while the index is being created (in a create index request for instance)\n+     */\n+    public static class DefaultHotAllocationSettingProvider implements ExplicitIndexSettingProvider {\n+        @Override\n+        public Settings getExplicitIndexSettings(String indexName, Settings indexSettings) {\n+            Set<String> settings = indexSettings.keySet();\n+            if (settings.contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE)) {\n+                // It's okay to put it, it will be removed or overridden by the template/request settings\n+                return Settings.builder().put(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE, DATA_HOT).build();\n+            } else if (settings.stream().anyMatch(s -> s.startsWith(IndexMetadata.INDEX_ROUTING_REQUIRE_GROUP_PREFIX + \".\")) ||\n+                settings.stream().anyMatch(s -> s.startsWith(IndexMetadata.INDEX_ROUTING_EXCLUDE_GROUP_PREFIX + \".\")) ||\n+                settings.stream().anyMatch(s -> s.startsWith(IndexMetadata.INDEX_ROUTING_INCLUDE_GROUP_PREFIX + \".\"))) {\n+                // A different index level require, include, or exclude has been specified, so don't put the setting", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 36}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1NjM5Nw==", "bodyText": "maybe switch between \"data\" and \"data_hot\" randomly here ... IIUC they are synonymous in this context ?", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477556397", "createdAt": "2020-08-26T20:02:08Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/cluster/routing/allocation/DataTierIT.java", "diffHunk": "@@ -0,0 +1,219 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+package org.elasticsearch.xpack.cluster.routing.allocation;\n+\n+import org.elasticsearch.action.admin.indices.shrink.ResizeType;\n+import org.elasticsearch.action.admin.indices.template.put.PutComposableIndexTemplateAction;\n+import org.elasticsearch.cluster.health.ClusterHealthStatus;\n+import org.elasticsearch.cluster.metadata.ComposableIndexTemplate;\n+import org.elasticsearch.cluster.metadata.IndexMetadata;\n+import org.elasticsearch.cluster.metadata.Template;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.plugins.Plugin;\n+import org.elasticsearch.test.ESIntegTestCase;\n+import org.elasticsearch.xpack.core.DataTier;\n+import org.elasticsearch.xpack.core.LocalStateCompositeXPackPlugin;\n+\n+import java.util.Arrays;\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+import static org.hamcrest.Matchers.equalTo;\n+\n+@ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST, numDataNodes = 0, numClientNodes = 0)\n+public class DataTierIT extends ESIntegTestCase {\n+    private static final String index = \"myindex\";\n+\n+    @Override\n+    protected Collection<Class<? extends Plugin>> nodePlugins() {\n+        return Collections.singleton(LocalStateCompositeXPackPlugin.class);\n+    }\n+\n+    public void testDefaultAllocateToHot() {\n+        startWarmNode();\n+        startColdNode();\n+        ensureGreen();\n+\n+        client().admin().indices().prepareCreate(index).setWaitForActiveShards(0).get();\n+\n+        Settings idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE_SETTING.get(idxSettings), equalTo(DataTier.DATA_HOT));\n+\n+        // index should be red\n+        assertThat(client().admin().cluster().prepareHealth(index).get().getIndices().get(index).getStatus(),\n+            equalTo(ClusterHealthStatus.RED));\n+\n+        logger.info(\"--> starting hot node\");\n+        startHotNode();\n+\n+        logger.info(\"--> waiting for {} to be yellow\", index);\n+        ensureYellow(index);\n+    }\n+\n+    public void testOverrideDefaultAllocation() {\n+        startWarmNode();\n+        startColdNode();\n+        ensureGreen();\n+\n+        String setting = randomBoolean() ? DataTierAllocationDecider.INDEX_ROUTING_REQUIRE :\n+            DataTierAllocationDecider.INDEX_ROUTING_INCLUDE;\n+\n+        client().admin().indices().prepareCreate(index)\n+            .setWaitForActiveShards(0)\n+            .setSettings(Settings.builder()\n+                .put(setting, DataTier.DATA_WARM))\n+            .get();\n+\n+        Settings idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(idxSettings.get(setting), equalTo(DataTier.DATA_WARM));\n+\n+        // index should be yellow\n+        logger.info(\"--> waiting for {} to be yellow\", index);\n+        ensureYellow(index);\n+    }\n+\n+    public void testRequestSettingOverridesAllocation() {\n+        startWarmNode();\n+        startColdNode();\n+        ensureGreen();\n+\n+        client().admin().indices().prepareCreate(index)\n+            .setWaitForActiveShards(0)\n+            .setSettings(Settings.builder()\n+                .putNull(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE))\n+            .get();\n+\n+        Settings idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE_SETTING.get(idxSettings), equalTo(\"\"));\n+        // Even the key shouldn't exist if it has been nulled out\n+        assertFalse(idxSettings.keySet().toString(), idxSettings.keySet().contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE));\n+\n+        // index should be yellow\n+        logger.info(\"--> waiting for {} to be yellow\", index);\n+        ensureYellow(index);\n+\n+        client().admin().indices().prepareDelete(index).get();\n+\n+        // Now test it overriding the \"require\" setting, in which case the include should be skipped\n+        client().admin().indices().prepareCreate(index)\n+            .setWaitForActiveShards(0)\n+            .setSettings(Settings.builder()\n+                .put(DataTierAllocationDecider.INDEX_ROUTING_REQUIRE, DataTier.DATA_COLD))\n+            .get();\n+\n+        idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE_SETTING.get(idxSettings), equalTo(\"\"));\n+        // The key should not be put in place since it was overridden\n+        assertFalse(idxSettings.keySet().contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE));\n+        assertThat(DataTierAllocationDecider.INDEX_ROUTING_REQUIRE_SETTING.get(idxSettings), equalTo(DataTier.DATA_COLD));\n+\n+        // index should be yellow\n+        logger.info(\"--> waiting for {} to be yellow\", index);\n+        ensureYellow(index);\n+    }\n+\n+    /**\n+     * When a new index is created from source metadata (as during a shrink), the data tier\n+     * default setting should *not* be applied. This test checks that behavior.\n+     */\n+    public void testShrinkStaysOnTier() {\n+        startWarmNode();\n+        startHotNode();\n+\n+        client().admin().indices().prepareCreate(index)\n+            .setWaitForActiveShards(0)\n+            .setSettings(Settings.builder()\n+                .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 2)\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+                .put(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE, \"data_warm\"))\n+            .get();\n+\n+        client().admin().indices().prepareAddBlock(IndexMetadata.APIBlock.READ_ONLY, index).get();\n+        client().admin().indices().prepareResizeIndex(index, index + \"-shrunk\")\n+            .setResizeType(ResizeType.SHRINK)\n+            .setSettings(Settings.builder()\n+                .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, 1)\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+                .build()).get();\n+\n+        ensureGreen(index + \"-shrunk\");\n+\n+        Settings idxSettings = client().admin().indices().prepareGetIndex().addIndices(index + \"-shrunk\")\n+            .get().getSettings().get(index + \"-shrunk\");\n+        // It should inherit the setting of its originator\n+        assertThat(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE_SETTING.get(idxSettings), equalTo(DataTier.DATA_WARM));\n+\n+        // Required or else the test cleanup fails because it can't delete the indices\n+        client().admin().indices().prepareUpdateSettings(index, index + \"-shrunk\")\n+            .setSettings(Settings.builder()\n+                .put(\"index.blocks.read_only\", false))\n+            .get();\n+    }\n+\n+    public void testTemplateOverridesDefaults() {\n+        startWarmNode();\n+\n+        Template t = new Template(Settings.builder()\n+            .put(DataTierAllocationDecider.INDEX_ROUTING_REQUIRE, DataTier.DATA_WARM)\n+            .build(), null, null);\n+        ComposableIndexTemplate ct = new ComposableIndexTemplate(Collections.singletonList(index), t, null, null, null, null, null);\n+        client().execute(PutComposableIndexTemplateAction.INSTANCE,\n+            new PutComposableIndexTemplateAction.Request(\"template\").indexTemplate(ct)).actionGet();\n+\n+        client().admin().indices().prepareCreate(index).setWaitForActiveShards(0).get();\n+\n+        Settings idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(idxSettings.keySet().contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE), equalTo(false));\n+\n+        // index should be yellow\n+        ensureYellow(index);\n+\n+        client().admin().indices().prepareDelete(index).get();\n+\n+        t = new Template(Settings.builder()\n+            .putNull(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE)\n+            .build(), null, null);\n+        ct = new ComposableIndexTemplate(Collections.singletonList(index), t, null, null, null, null, null);\n+        client().execute(PutComposableIndexTemplateAction.INSTANCE,\n+            new PutComposableIndexTemplateAction.Request(\"template\").indexTemplate(ct)).actionGet();\n+\n+        client().admin().indices().prepareCreate(index).setWaitForActiveShards(0).get();\n+\n+        idxSettings = client().admin().indices().prepareGetIndex().addIndices(index).get().getSettings().get(index);\n+        assertThat(idxSettings.keySet().contains(DataTierAllocationDecider.INDEX_ROUTING_INCLUDE), equalTo(false));\n+\n+        ensureYellow(index);\n+    }\n+\n+    public void startHotNode() {\n+        Settings nodeSettings = Settings.builder()\n+            .putList(\"node.roles\", Arrays.asList(\"master\", \"data_hot\", \"ingest\"))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 194}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1OTAwOQ==", "bodyText": "mabye a debug message here to help with future troubleshooting ?", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477559009", "createdAt": "2020-08-26T20:07:32Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -595,14 +611,65 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n      * @return the aggregated settings for the new index\n      */\n     static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClusterStateUpdateRequest request,\n-                                           Settings templateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n-                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator) {\n-        Settings.Builder indexSettingsBuilder = Settings.builder();\n+                                           Settings combinedTemplateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n+                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator,\n+                                           Set<ExplicitIndexSettingProvider> explicitIndexSettingProviders) {\n+        // Create builders for the template and request settings. We transform these into builders\n+        // because we may want settings to be \"removed\" from these prior to being set on the new\n+        // index (see more comments below)\n+        final Settings.Builder templateSettings = Settings.builder().put(combinedTemplateSettings);\n+        final Settings.Builder requestSettings = Settings.builder().put(request.settings());\n+\n+        final Settings.Builder indexSettingsBuilder = Settings.builder();\n         if (sourceMetadata == null) {\n-            indexSettingsBuilder.put(templateSettings);\n+            final Settings.Builder explicitDefaultSettings = Settings.builder();\n+            final Settings templateAndRequestSettings = Settings.builder()\n+                .put(combinedTemplateSettings)\n+                .put(request.settings())\n+                .build();\n+\n+            // Loop through all the explicit index setting providers, adding them to the\n+            // explicitDefaultSettings map\n+            for (ExplicitIndexSettingProvider listener : explicitIndexSettingProviders) {\n+                try {\n+                    explicitDefaultSettings.put(listener.getExplicitIndexSettings(request.index(), templateAndRequestSettings));\n+                } catch (Exception e) {\n+                    logger.warn(new ParameterizedMessage(\"failed invoking explicit setting provider for creation of [{}] index\",\n+                        request.index()), e);\n+                }\n+            }\n+\n+            // For all the explicit settings, we go through the template and request level settings\n+            // and see if either a template or the request has \"cancelled out\" an explicit default\n+            // setting. For example, if a plugin had as an explicit setting:\n+            // \"index.mysetting\": \"blah\n+            // And either a template or create index request had:\n+            // \"index.mysetting\": null\n+            // We want to remove the explicit setting not only from the explicitly set settings, but\n+            // also from the template and request settings, so that from the newly create index's\n+            // perspective it is as though the setting has not been set at all (using the default\n+            // value).\n+            for (String explicitSetting : explicitDefaultSettings.keys()) {\n+                if (templateSettings.keys().contains(explicitSetting) && templateSettings.get(explicitSetting) == null) {\n+                    explicitDefaultSettings.remove(explicitSetting);\n+                    templateSettings.remove(explicitSetting);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU1OTA4Nw==", "bodyText": "mabye a debug message here to help with future troubleshooting ?", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477559087", "createdAt": "2020-08-26T20:07:40Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetadataCreateIndexService.java", "diffHunk": "@@ -595,14 +611,65 @@ private ClusterState applyCreateIndexRequestWithExistingMetadata(final ClusterSt\n      * @return the aggregated settings for the new index\n      */\n     static Settings aggregateIndexSettings(ClusterState currentState, CreateIndexClusterStateUpdateRequest request,\n-                                           Settings templateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n-                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator) {\n-        Settings.Builder indexSettingsBuilder = Settings.builder();\n+                                           Settings combinedTemplateSettings, @Nullable IndexMetadata sourceMetadata, Settings settings,\n+                                           IndexScopedSettings indexScopedSettings, ShardLimitValidator shardLimitValidator,\n+                                           Set<ExplicitIndexSettingProvider> explicitIndexSettingProviders) {\n+        // Create builders for the template and request settings. We transform these into builders\n+        // because we may want settings to be \"removed\" from these prior to being set on the new\n+        // index (see more comments below)\n+        final Settings.Builder templateSettings = Settings.builder().put(combinedTemplateSettings);\n+        final Settings.Builder requestSettings = Settings.builder().put(request.settings());\n+\n+        final Settings.Builder indexSettingsBuilder = Settings.builder();\n         if (sourceMetadata == null) {\n-            indexSettingsBuilder.put(templateSettings);\n+            final Settings.Builder explicitDefaultSettings = Settings.builder();\n+            final Settings templateAndRequestSettings = Settings.builder()\n+                .put(combinedTemplateSettings)\n+                .put(request.settings())\n+                .build();\n+\n+            // Loop through all the explicit index setting providers, adding them to the\n+            // explicitDefaultSettings map\n+            for (ExplicitIndexSettingProvider listener : explicitIndexSettingProviders) {\n+                try {\n+                    explicitDefaultSettings.put(listener.getExplicitIndexSettings(request.index(), templateAndRequestSettings));\n+                } catch (Exception e) {\n+                    logger.warn(new ParameterizedMessage(\"failed invoking explicit setting provider for creation of [{}] index\",\n+                        request.index()), e);\n+                }\n+            }\n+\n+            // For all the explicit settings, we go through the template and request level settings\n+            // and see if either a template or the request has \"cancelled out\" an explicit default\n+            // setting. For example, if a plugin had as an explicit setting:\n+            // \"index.mysetting\": \"blah\n+            // And either a template or create index request had:\n+            // \"index.mysetting\": null\n+            // We want to remove the explicit setting not only from the explicitly set settings, but\n+            // also from the template and request settings, so that from the newly create index's\n+            // perspective it is as though the setting has not been set at all (using the default\n+            // value).\n+            for (String explicitSetting : explicitDefaultSettings.keys()) {\n+                if (templateSettings.keys().contains(explicitSetting) && templateSettings.get(explicitSetting) == null) {\n+                    explicitDefaultSettings.remove(explicitSetting);\n+                    templateSettings.remove(explicitSetting);\n+                }\n+                if (requestSettings.keys().contains(explicitSetting) && requestSettings.get(explicitSetting) == null) {\n+                    explicitDefaultSettings.remove(explicitSetting);\n+                    requestSettings.remove(explicitSetting);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ed6c3dc8adf8d9f7e1f919abf047d400a27f6e48"}, "originalPosition": 124}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7c001cf91b0a8c587c7e4e10913af360bfead684", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/7c001cf91b0a8c587c7e4e10913af360bfead684", "committedDate": "2020-08-26T20:27:22Z", "message": "Merge remote-tracking branch 'origin/master' into dt-default-deploy-on-hot"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5039087aa77a4bfd9f40299131427aae23777d84", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/5039087aa77a4bfd9f40299131427aae23777d84", "committedDate": "2020-08-26T20:29:02Z", "message": "Fix typos and listener -> provider after refactor"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d659748e323f5b78f934c641634fbc3e70dc3471", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/d659748e323f5b78f934c641634fbc3e70dc3471", "committedDate": "2020-08-26T20:29:43Z", "message": "Pass exceptions through, preventing index creation if provider fails"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "055c6420644e60b115630936b1c05709b053d719", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/055c6420644e60b115630936b1c05709b053d719", "committedDate": "2020-08-26T20:32:33Z", "message": "Add debug log message when skipping hot tier allocation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b2982657a44606b715c08535c98a61acab5716e", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b2982657a44606b715c08535c98a61acab5716e", "committedDate": "2020-08-26T20:34:22Z", "message": "Rename node starting helpers in DataTierIT"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a", "committedDate": "2020-08-26T20:36:25Z", "message": "Add debug log for explicit setting cancelled out by template/request"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc1ODU1Mzgz", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-475855383", "createdAt": "2020-08-26T21:00:46Z", "commit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMTowMDo0NlrOHHdjyA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNlQyMTowNzoxMlrOHHdwpQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4NjM3Ng==", "bodyText": "The naming here is a little confusing, because I thought this was about defaults, while \"explicit\" implies to me this is something else.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477586376", "createdAt": "2020-08-26T21:00:46Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/index/shard/ExplicitIndexSettingProvider.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.shard;\n+\n+import org.elasticsearch.common.settings.Settings;\n+\n+/**\n+ * An {@link ExplicitIndexSettingProvider} is a provider for index level settings that can be set\n+ * explicitly as a default value (so they show up as \"set\" for newly created indices)\n+ */\n+public interface ExplicitIndexSettingProvider {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "originalPosition": 28}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4ODYzMQ==", "bodyText": "Can we do without the passed in settings? I had imagined the caller would do the merging/defaulting logic, so it's unclear why we would need the user passed in settings.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477588631", "createdAt": "2020-08-26T21:05:10Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/index/shard/ExplicitIndexSettingProvider.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.shard;\n+\n+import org.elasticsearch.common.settings.Settings;\n+\n+/**\n+ * An {@link ExplicitIndexSettingProvider} is a provider for index level settings that can be set\n+ * explicitly as a default value (so they show up as \"set\" for newly created indices)\n+ */\n+public interface ExplicitIndexSettingProvider {\n+    /**\n+     * Returns explicitly set default index {@link Settings} for the given index.\n+     */\n+    default Settings getExplicitIndexSettings(String indexName, Settings templateAndRequestSettings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzU4OTY2OQ==", "bodyText": "I would put the method on Plugin, where we have the rest of the settings logic. We may want to split that out to eg a SettingsPlugin at some point, but it would be nice to have those related extension points near each other for now.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477589669", "createdAt": "2020-08-26T21:07:12Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/plugins/IndexSettingsProviderPlugin.java", "diffHunk": "@@ -0,0 +1,37 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.plugins;\n+\n+import org.elasticsearch.index.shard.ExplicitIndexSettingProvider;\n+\n+import java.util.Collection;\n+import java.util.Collections;\n+\n+/**\n+ * An {@link IndexSettingsProviderPlugin} is a plugin that allows hooking in to parts of an index\n+ * lifecycle to provide explicit default settings for newly created indices. Rather than changing\n+ * the default values for an index-level setting, these act as though the setting has been set\n+ * explicitly, but still allow the setting to be overridden by a template or creation request body.\n+ */\n+public interface IndexSettingsProviderPlugin {\n+    default Collection<ExplicitIndexSettingProvider> getExplicitSettingProviders() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "originalPosition": 34}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MjU4Nzc3", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-476258777", "createdAt": "2020-08-27T00:55:49Z", "commit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMDo1NTo0OVrOHHsAXg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QwMDo1NTo0OVrOHHsAXg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NzgyMzA3MA==", "bodyText": "minor: might want to instruct consumers that this method should not return null, nor throw exceptions, and if the conditions dictate that are no settings to apply for this index then return Settings.EMPTY.", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r477823070", "createdAt": "2020-08-27T00:55:49Z", "author": {"login": "jakelandis"}, "path": "server/src/main/java/org/elasticsearch/index/shard/ExplicitIndexSettingProvider.java", "diffHunk": "@@ -0,0 +1,35 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *     http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.shard;\n+\n+import org.elasticsearch.common.settings.Settings;\n+\n+/**\n+ * An {@link ExplicitIndexSettingProvider} is a provider for index level settings that can be set\n+ * explicitly as a default value (so they show up as \"set\" for newly created indices)\n+ */\n+public interface ExplicitIndexSettingProvider {\n+    /**\n+     * Returns explicitly set default index {@link Settings} for the given index.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "originalPosition": 30}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2MjYwMTc2", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-476260176", "createdAt": "2020-08-27T00:56:38Z", "commit": {"oid": "7a70b0c01d7b5f259e3699ab7a6af02f26b47a9a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "17bde03ae3406f926016d79ee77aca554296209e", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/17bde03ae3406f926016d79ee77aca554296209e", "committedDate": "2020-08-27T16:05:31Z", "message": "Rename Explicit -> Additional, collapse to Plugin instead of new plugin"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e95e9220a1916034e0f0eab2d3a01f73d3652989", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/e95e9220a1916034e0f0eab2d3a01f73d3652989", "committedDate": "2020-08-27T17:06:22Z", "message": "Merge branch 'master' into dt-default-deploy-on-hot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDc2OTUzMjM4", "url": "https://github.com/elastic/elasticsearch/pull/61342#pullrequestreview-476953238", "createdAt": "2020-08-27T17:53:29Z", "commit": {"oid": "e95e9220a1916034e0f0eab2d3a01f73d3652989"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNzo1MzoyOVrOHIbJZg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yN1QxNzo1MzoyOVrOHIbJZg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3ODU5NTQzMA==", "bodyText": "nit: AdditionalSetting -> AdditionalIndexSetting?", "url": "https://github.com/elastic/elasticsearch/pull/61342#discussion_r478595430", "createdAt": "2020-08-27T17:53:29Z", "author": {"login": "rjernst"}, "path": "server/src/main/java/org/elasticsearch/plugins/Plugin.java", "diffHunk": "@@ -197,4 +198,14 @@ public void onIndexModule(IndexModule indexModule) {}\n     public void close() throws IOException {\n \n     }\n+\n+    /**\n+     * An {@link IndexSettingProvider} allows hooking in to parts of an index\n+     * lifecycle to provide explicit default settings for newly created indices. Rather than changing\n+     * the default values for an index-level setting, these act as though the setting has been set\n+     * explicitly, but still allow the setting to be overridden by a template or creation request body.\n+     */\n+    public Collection<IndexSettingProvider> getAdditionalSettingProviders() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e95e9220a1916034e0f0eab2d3a01f73d3652989"}, "originalPosition": 19}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2aa7b4f36618c7a905ec5555d828f1c2cf7df4e1", "author": {"user": {"login": "dakrone", "name": "Lee Hinman"}}, "url": "https://github.com/elastic/elasticsearch/commit/2aa7b4f36618c7a905ec5555d828f1c2cf7df4e1", "committedDate": "2020-08-27T17:56:56Z", "message": "getAdditionalSettingProviders -> getAdditionalIndexSettingProviders"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4777, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}