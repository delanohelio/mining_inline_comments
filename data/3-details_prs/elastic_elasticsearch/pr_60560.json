{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDYwNjk3NDAz", "number": 60560, "title": "Convert packaging upgrade tests to java", "bodyText": "This commit removes the last of the bats tests, converting the rpm/deb\nupgrade tests to java. It adds a new pattern of tasks, similar in nature\nbut separate from the existing distro tests, named distroUpgradeTest.\nFor each index compatible version, a distroUpgradeTest.VERSION task\nexxists. Each distribution then has a task, named\ndistroUpgradeTest.VERSION.DISTRO.\nOne thing to note is these new tests do not cover no-jdk versions of\nthe rpm/deb packages, since the distribution/bwc project does not\ncurrently build those.\ncloses #59145\ncloses #46005", "createdAt": "2020-08-01T02:06:09Z", "url": "https://github.com/elastic/elasticsearch/pull/60560", "merged": true, "mergeCommit": {"oid": "dfe42e33ebabe8a5507878092319b87bc21940a0"}, "closed": true, "closedAt": "2020-08-03T23:31:32Z", "author": {"login": "rjernst"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc6e5iIgH2gAyNDYwNjk3NDAzOmVjZWU2ZWE2NDRhMWFmMTIzOGFjOWVhMWFjN2NiYWRjODJhNWE4Yzg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc7ZlsqgH2gAyNDYwNjk3NDAzOmEyMzY3MjNkZjExZGJlZTQ0MDQ4OGE5ZDVjNWZiMWZmZjQ5NjRmNDg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "ecee6ea644a1af1238ac9ea1ac7cbadc82a5a8c8", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/ecee6ea644a1af1238ac9ea1ac7cbadc82a5a8c8", "committedDate": "2020-08-01T01:53:41Z", "message": "Convert packaging upgrade tests to java\n\nThis commit removes the last of the bats tests, converting the rpm/deb\nupgrade tests to java. It adds a new pattern of tasks, similar in nature\nbut separate from the existing distro tests, named `distroUpgradeTest`.\nFor each index compatible version, a `distroUpgradeTest.VERSION` task\nexxists. Each distribution then has a task, named\n`distroUpgradeTest.VERSION.DISTRO`.\n\nOne thing to note is these new tests do not cover no-jdk versions of\nthe rpm/deb packages, since the distribution/bwc project does not\ncurrently build those.\n\ncloses #59145\ncloses #46005"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/841871fe4a965811ea7dd3e65b152e2bdc0cc728", "committedDate": "2020-08-01T02:20:15Z", "message": "checkstyle/spotless"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDYwMjY5MDc4", "url": "https://github.com/elastic/elasticsearch/pull/60560#pullrequestreview-460269078", "createdAt": "2020-08-03T19:00:36Z", "commit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QxOTowMDozNlrOG7FNOg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0wM1QyMjowNToyNFrOG7KORA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDYwNDQ3NA==", "bodyText": "Yay!", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464604474", "createdAt": "2020-08-03T19:00:36Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/BatsTestTask.java", "diffHunk": "@@ -1,131 +0,0 @@\n-/*", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 1}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4MzE3Nw==", "bodyText": "I'm now wondering if this intermediary task is striclty necessary. Is there anyreason why the test task can't just depend directly on the distribution, and the VM tasks depend on all distributions?", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464683177", "createdAt": "2020-08-03T21:56:21Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -100,58 +88,101 @@ public void apply(Project project) {\n \n         // TODO: it would be useful to also have the SYSTEM_JAVA_HOME setup in the root project, so that running from GCP only needs\n         // a java for gradle to run, and the tests are self sufficient and consistent with the java they use\n+        NamedDomainObjectContainer<ElasticsearchDistribution> allDistributions = DistributionDownloadPlugin.getContainer(project);\n+        List<ElasticsearchDistribution> testDistributions = configureDistributions(project);\n \n-        Version upgradeVersion = getUpgradeVersion(project);\n-        Provider<Directory> distributionsDir = project.getLayout().getBuildDirectory().dir(\"packaging/distributions\");\n-        Provider<Directory> upgradeDir = project.getLayout().getBuildDirectory().dir(\"packaging/upgrade\");\n-\n-        List<ElasticsearchDistribution> distributions = configureDistributions(project, upgradeVersion);\n-        TaskProvider<Copy> copyDistributionsTask = configureCopyDistributionsTask(project, distributionsDir);\n-        TaskProvider<Copy> copyUpgradeTask = configureCopyUpgradeTask(project, upgradeVersion, upgradeDir);\n-\n-        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecyleTasks = lifecyleTasks(project, \"destructiveDistroTest\");\n+        Map<ElasticsearchDistribution.Type, TaskProvider<?>> lifecycleTasks = lifecycleTasks(project, \"destructiveDistroTest\");\n+        Map<String, TaskProvider<?>> versionTasks = versionTasks(project, \"destructiveDistroUpgradeTest\");\n         TaskProvider<Task> destructiveDistroTest = project.getTasks().register(\"destructiveDistroTest\");\n \n         Configuration examplePlugin = configureExamplePlugin(project);\n \n-        for (ElasticsearchDistribution distribution : distributions) {\n-            TaskProvider<?> destructiveTask = configureDistroTest(project, distribution, dockerSupport, examplePlugin);\n+        List<TaskProvider<Test>> windowsTestTasks = new ArrayList<>();\n+        Map<Type, List<TaskProvider<Test>>> linuxTestTasks = new HashMap<>();\n+        Map<String, List<TaskProvider<Test>>> upgradeTestTasks = new HashMap<>();\n+        Map<String, TaskProvider<?>> depsTasks = new HashMap<>();\n+        for (ElasticsearchDistribution distribution : testDistributions) {\n+            String taskname = destructiveDistroTestTaskName(distribution);\n+            TaskProvider<?> depsTask = project.getTasks().register(taskname + \"#deps\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 101}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2NDY4NjY2MA==", "bodyText": "Why rename this? I think having \"VM\" in the name is helpful. Else let's add a comment.", "url": "https://github.com/elastic/elasticsearch/pull/60560#discussion_r464686660", "createdAt": "2020-08-03T22:05:24Z", "author": {"login": "mark-vieira"}, "path": "buildSrc/src/main/java/org/elasticsearch/gradle/test/DistroTestPlugin.java", "diffHunk": "@@ -323,69 +295,52 @@ private static Configuration configureExamplePlugin(Project project) {\n         return examplePlugin;\n     }\n \n-    private static TaskProvider<GradleDistroTestTask> configureVMWrapperTask(\n+    private static void configureWrapperTasks(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "841871fe4a965811ea7dd3e65b152e2bdc0cc728"}, "originalPosition": 361}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a236723df11dbee440488a9d5c5fb1fff4964f48", "author": {"user": {"login": "rjernst", "name": "Ryan Ernst"}}, "url": "https://github.com/elastic/elasticsearch/commit/a236723df11dbee440488a9d5c5fb1fff4964f48", "committedDate": "2020-08-03T22:16:25Z", "message": "add VM back to wrapper method name"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3600, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}