{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4MTAzODgx", "number": 62486, "reviewThreads": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzo0ODo0N1rOEkKT-Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowNDowNVrOEnHYaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA2MzUzMTQ1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xNlQxNzo0ODo0N1rOHS7v5A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QwODo1ODoyMlrOHTYXQw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYxNTMzMg==", "bodyText": "couldn't this blow up? we need to somehow require that importance here is not null.\nI think the way to do that is to run\n            classImportance.stream().mapToDouble(ClassImportance::getImportance).map(Math::abs).sum()\n\nif it is null. If classImportance is null && importance is null, then maybe just return a 0.0", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r489615332", "createdAt": "2020-09-16T17:48:47Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java", "diffHunk": "@@ -104,22 +109,28 @@ public String getFeatureName() {\n \n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n-        out.writeString(this.featureName);\n-        out.writeDouble(this.importance);\n-        out.writeBoolean(this.classImportance != null);\n-        if (this.classImportance != null) {\n+        out.writeString(featureName);\n+        if (out.getVersion().onOrAfter(Version.V_8_0_0)) {\n+            out.writeOptionalDouble(importance);\n+        } else {\n+            out.writeDouble(importance);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ea18478d525d76b1ba0433eac40da06aacfee06b"}, "originalPosition": 86}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDA4NDE2Mw==", "bodyText": "Indeed!", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r490084163", "createdAt": "2020-09-17T08:58:22Z", "author": {"login": "dimitris-athanasiou"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/FeatureImportance.java", "diffHunk": "@@ -104,22 +109,28 @@ public String getFeatureName() {\n \n     @Override\n     public void writeTo(StreamOutput out) throws IOException {\n-        out.writeString(this.featureName);\n-        out.writeDouble(this.importance);\n-        out.writeBoolean(this.classImportance != null);\n-        if (this.classImportance != null) {\n+        out.writeString(featureName);\n+        if (out.getVersion().onOrAfter(Version.V_8_0_0)) {\n+            out.writeOptionalDouble(importance);\n+        } else {\n+            out.writeDouble(importance);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4OTYxNTMzMg=="}, "originalCommit": {"oid": "ea18478d525d76b1ba0433eac40da06aacfee06b"}, "originalPosition": 86}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NDQ4Mzg4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/ingest/InferenceProcessorTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTo1ODoxN1rOHXhztA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTo1ODoxN1rOHXhztA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzMzIwNA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.classes.0.class_name\", Double.class), equalTo(\"class_a\"));\n          \n          \n            \n                    assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.classes.0.class_name\", String.class), equalTo(\"class_a\"));", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r494433204", "createdAt": "2020-09-24T15:58:17Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/ingest/InferenceProcessorTests.java", "diffHunk": "@@ -153,10 +156,12 @@ public void testMutateDocumentClassificationFeatureInfluence() {\n \n         assertThat(document.getFieldValue(\"ml.my_processor.model_id\", String.class), equalTo(\"classification_model\"));\n         assertThat(document.getFieldValue(\"ml.my_processor.predicted_value\", String.class), equalTo(\"foo\"));\n-        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.importance\", Double.class), equalTo(-42.0));\n         assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.feature_name\", String.class), equalTo(\"feature_2\"));\n-        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.importance\", Double.class), equalTo(1.13));\n+        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.classes.0.class_name\", Double.class), equalTo(\"class_a\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bdb6db72b60b906298f4efd1c6e6cc7269953e2"}, "originalPosition": 33}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NDQ4NDcyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/ingest/InferenceProcessorTests.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTo1ODoyOVrOHXh0Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNTo1ODoyOVrOHXh0Mg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzMzMzMA==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.classes.0.class_name\", Double.class), equalTo(\"class_b\"));\n          \n          \n            \n                    assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.classes.0.class_name\", String.class), equalTo(\"class_b\"));", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r494433330", "createdAt": "2020-09-24T15:58:29Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/inference/ingest/InferenceProcessorTests.java", "diffHunk": "@@ -153,10 +156,12 @@ public void testMutateDocumentClassificationFeatureInfluence() {\n \n         assertThat(document.getFieldValue(\"ml.my_processor.model_id\", String.class), equalTo(\"classification_model\"));\n         assertThat(document.getFieldValue(\"ml.my_processor.predicted_value\", String.class), equalTo(\"foo\"));\n-        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.importance\", Double.class), equalTo(-42.0));\n         assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.feature_name\", String.class), equalTo(\"feature_2\"));\n-        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.importance\", Double.class), equalTo(1.13));\n+        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.classes.0.class_name\", Double.class), equalTo(\"class_a\"));\n+        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.0.classes.0.importance\", Double.class), equalTo(-42.0));\n         assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.feature_name\", String.class), equalTo(\"feature_1\"));\n+        assertThat(document.getFieldValue(\"ml.my_processor.feature_importance.1.classes.0.class_name\", Double.class), equalTo(\"class_b\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bdb6db72b60b906298f4efd1c6e6cc7269953e2"}, "originalPosition": 36}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NDUwNjcwOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationFeatureImportance.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowMzozNFrOHXiCaQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowMzozNFrOHXiCaQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzNjk2OQ==", "bodyText": "I don't think this is nullable.\n\n  \n    \n  \n    \n\n  \n  This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                @Nullable", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r494436969", "createdAt": "2020-09-24T16:03:34Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationFeatureImportance.java", "diffHunk": "@@ -26,157 +26,102 @@\n import static org.elasticsearch.common.xcontent.ConstructingObjectParser.constructorArg;\n import static org.elasticsearch.common.xcontent.ConstructingObjectParser.optionalConstructorArg;\n \n-public class FeatureImportance implements Writeable, ToXContentObject {\n+public class ClassificationFeatureImportance extends AbstractFeatureImportance {\n \n     private final List<ClassImportance> classImportance;\n-    private final double importance;\n     private final String featureName;\n-    static final String IMPORTANCE = \"importance\";\n+\n     static final String FEATURE_NAME = \"feature_name\";\n     static final String CLASSES = \"classes\";\n \n-    public static FeatureImportance forRegression(String featureName, double importance) {\n-        return new FeatureImportance(featureName, importance, null);\n-    }\n-\n-    public static FeatureImportance forBinaryClassification(String featureName, double importance, List<ClassImportance> classImportance) {\n-        return new FeatureImportance(featureName,\n-            importance,\n-            classImportance);\n-    }\n-\n-    public static FeatureImportance forClassification(String featureName, List<ClassImportance> classImportance) {\n-        return new FeatureImportance(featureName,\n-            classImportance.stream().mapToDouble(ClassImportance::getImportance).map(Math::abs).sum(),\n-            classImportance);\n-    }\n-\n     @SuppressWarnings(\"unchecked\")\n-    private static final ConstructingObjectParser<FeatureImportance, Void> PARSER =\n-        new ConstructingObjectParser<>(\"feature_importance\",\n-            a -> new FeatureImportance((String) a[0], (Double) a[1], (List<ClassImportance>) a[2])\n+    private static final ConstructingObjectParser<ClassificationFeatureImportance, Void> PARSER =\n+        new ConstructingObjectParser<>(\"classification_feature_importance\",\n+            a -> new ClassificationFeatureImportance((String) a[0], (List<ClassImportance>) a[1])\n         );\n \n     static {\n-        PARSER.declareString(constructorArg(), new ParseField(FeatureImportance.FEATURE_NAME));\n-        PARSER.declareDouble(constructorArg(), new ParseField(FeatureImportance.IMPORTANCE));\n+        PARSER.declareString(constructorArg(), new ParseField(ClassificationFeatureImportance.FEATURE_NAME));\n         PARSER.declareObjectArray(optionalConstructorArg(),\n             (p, c) -> ClassImportance.fromXContent(p),\n-            new ParseField(FeatureImportance.CLASSES));\n+            new ParseField(ClassificationFeatureImportance.CLASSES));\n     }\n \n-    public static FeatureImportance fromXContent(XContentParser parser) {\n+    public static ClassificationFeatureImportance fromXContent(XContentParser parser) {\n         return PARSER.apply(parser, null);\n     }\n \n-    FeatureImportance(String featureName, double importance, List<ClassImportance> classImportance) {\n+    public ClassificationFeatureImportance(String featureName, List<ClassImportance> classImportance) {\n         this.featureName = Objects.requireNonNull(featureName);\n-        this.importance = importance;\n-        this.classImportance = classImportance == null ? null : Collections.unmodifiableList(classImportance);\n+        this.classImportance = classImportance == null ? Collections.emptyList() : Collections.unmodifiableList(classImportance);\n     }\n \n-    public FeatureImportance(StreamInput in) throws IOException {\n+    public ClassificationFeatureImportance(StreamInput in) throws IOException {\n         this.featureName = in.readString();\n-        this.importance = in.readDouble();\n-        if (in.readBoolean()) {\n-            if (in.getVersion().before(Version.V_7_10_0)) {\n-                Map<String, Double> classImportance = in.readMap(StreamInput::readString, StreamInput::readDouble);\n-                this.classImportance = ClassImportance.fromMap(classImportance);\n-            } else {\n-                this.classImportance = in.readList(ClassImportance::new);\n-            }\n-        } else {\n-            this.classImportance = null;\n-        }\n+        this.classImportance = in.readList(ClassImportance::new);\n     }\n \n+    @Nullable", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bdb6db72b60b906298f4efd1c6e6cc7269953e2"}, "originalPosition": 89}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzA5NDUwODU5OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationFeatureImportance.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowNDowNVrOHXiDtQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0yNFQxNjowNDowNVrOHXiDtQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5NDQzNzMwMQ==", "bodyText": "This file contains bidirectional Unicode text that may be interpreted or compiled differently than what appears below. To review, open the file in an editor that reveals hidden Unicode characters. Learn more about bidirectional Unicode characters\n\n\n  \n\n\n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n            import org.elasticsearch.common.Nullable;", "url": "https://github.com/elastic/elasticsearch/pull/62486#discussion_r494437301", "createdAt": "2020-09-24T16:04:05Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/inference/results/ClassificationFeatureImportance.java", "diffHunk": "@@ -5,7 +5,7 @@\n  */\n package org.elasticsearch.xpack.core.ml.inference.results;\n \n-import org.elasticsearch.Version;\n+import org.elasticsearch.common.Nullable;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8bdb6db72b60b906298f4efd1c6e6cc7269953e2"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1496, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}