{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDI1MjI0MjUz", "number": 57373, "title": "IndexFieldData should hold the ValuesSourceType", "bodyText": "Relates to #42949\nThis PR moves the ValuesSourceType information onto the IndexFieldData object, instead of the MappedFieldType.  During the Values Source Refactor, we moved the ValuesSourceType onto MappedFieldType (previously ValuesSourceConfig had guessed it based on some instanceof checks), but this added a second method that field types needed to implement for aggregation support, and created extra cognitive overhead for developers who had to remember to make two changes in sync.\nNow, the ValuesSourceType gets specified as part of the index field data builder, which needs to be specified for aggregation support anyway.  This means developers looking to add aggregation support to a field only need to override one method on the field type instead of two, and it's the same method that needed to be overridden before the VS refactor.\nSorry for the confusing commit history, I needed to do a rebase.", "createdAt": "2020-05-29T17:09:23Z", "url": "https://github.com/elastic/elasticsearch/pull/57373", "merged": true, "mergeCommit": {"oid": "0a23487e73eb3c0c3a84704e6bd7a5ed077ed5e6"}, "closed": true, "closedAt": "2020-06-02T13:54:54Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABchSHi9gH2gAyNDI1MjI0MjUzOjJlYjQ1YzIzNTAxNTU0ZjkzMTNmNjA1OTZjNzM5ZjdjMDZlZWI0Njg=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcnDNbvgH2gAyNDI1MjI0MjUzOjU4NzQ5MDNjNGQ3ODkxM2VlNmNiN2QyMjM2NTA1YWJmMmEwMDRjYTM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2eb45c23501554f9313f60596c739f7c06eeb468", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/2eb45c23501554f9313f60596c739f7c06eeb468", "committedDate": "2020-05-14T18:52:07Z", "message": "plumb VST through to IndexFieldData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "cc5a8fcd02f55bc8cb197f02fc10dc679726f38f", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/cc5a8fcd02f55bc8cb197f02fc10dc679726f38f", "committedDate": "2020-05-27T17:30:37Z", "message": "Streamline getting the VST for fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "65294a70a083d658c1723c64e158753e846e46a7", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/65294a70a083d658c1723c64e158753e846e46a7", "committedDate": "2020-05-29T15:31:32Z", "message": "get rid of getValuesSourceType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c59d7173f7961df26042801f43d0ea3ffb2fdea7", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c59d7173f7961df26042801f43d0ea3ffb2fdea7", "committedDate": "2020-05-29T16:15:09Z", "message": "plumb VST through to IndexFieldData"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b69cc7510b187cad615fb1afc5b3371f14188432", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b69cc7510b187cad615fb1afc5b3371f14188432", "committedDate": "2020-05-29T16:24:37Z", "message": "Streamline getting the VST for fields"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8d75fedd925ad70a08b3cb2e90ac57b9883dc825", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/8d75fedd925ad70a08b3cb2e90ac57b9883dc825", "committedDate": "2020-05-29T16:34:26Z", "message": "get rid of getValuesSourceType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "19e739e637065a6eb9cf512bd1176d545b03e88a", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/19e739e637065a6eb9cf512bd1176d545b03e88a", "committedDate": "2020-05-29T16:42:53Z", "message": "Merge branch 'vs-refactor-put-vst-on-index-field-data' of github.com:not-napoleon/elasticsearch into vs-refactor-put-vst-on-index-field-data\n\n Conflicts:\n\tserver/src/main/java/org/elasticsearch/index/mapper/TextFieldMapper.java\n\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/DateHistogramAggregatorFactory.java\n\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/histogram/HistogramAggregatorFactory.java\n\tserver/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/SignificantTermsAggregatorFactory.java"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e03d9edb85d0556c816eaf161e09c99f5b22b41e", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/e03d9edb85d0556c816eaf161e09c99f5b22b41e", "committedDate": "2020-06-01T13:15:09Z", "message": "Allow for VSAB aggregations that don't use the registry"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "696481af7ffbd087419401da0e50ba273377ca89", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/696481af7ffbd087419401da0e50ba273377ca89", "committedDate": "2020-06-01T13:39:06Z", "message": "Merge branch 'master' into vs-refactor-put-vst-on-index-field-data\n\n Conflicts:\n\tmodules/mapper-extras/src/main/java/org/elasticsearch/index/mapper/ScaledFloatFieldMapper.java\n\tserver/src/main/java/org/elasticsearch/index/fielddata/IndexNumericFieldData.java\n\tserver/src/main/java/org/elasticsearch/index/fielddata/plain/SortedNumericIndexFieldData.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIxNTMzNzQy", "url": "https://github.com/elastic/elasticsearch/pull/57373#pullrequestreview-421533742", "createdAt": "2020-05-31T22:32:31Z", "commit": {"oid": "19e739e637065a6eb9cf512bd1176d545b03e88a"}, "state": "COMMENTED", "comments": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0zMVQyMjozMjozMVrOGc7r6w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wMVQxNjoxMTo1OVrOGdQ5Xw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5MTIxMQ==", "bodyText": "Interesting thing for later maybe: is it useful to floatingPoint to be a feature of the VauesSourceType?", "url": "https://github.com/elastic/elasticsearch/pull/57373#discussion_r432991211", "createdAt": "2020-05-31T22:32:31Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/IndexNumericFieldData.java", "diffHunk": "@@ -19,30 +19,37 @@\n \n package org.elasticsearch.index.fielddata;\n \n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+\n public interface IndexNumericFieldData extends IndexFieldData<LeafNumericFieldData> {\n \n     enum NumericType {\n-        BOOLEAN(false),\n-        BYTE(false),\n-        SHORT(false),\n-        INT(false),\n-        LONG(false),\n-        DATE(false),\n-        DATE_NANOSECONDS(false),\n-        HALF_FLOAT(true),\n-        FLOAT(true),\n-        DOUBLE(true);\n+        BOOLEAN(false, CoreValuesSourceType.BOOLEAN),\n+        BYTE(false, CoreValuesSourceType.NUMERIC),\n+        SHORT(false, CoreValuesSourceType.NUMERIC),\n+        INT(false, CoreValuesSourceType.NUMERIC),\n+        LONG(false, CoreValuesSourceType.NUMERIC),\n+        DATE(false, CoreValuesSourceType.DATE),\n+        DATE_NANOSECONDS(false, CoreValuesSourceType.DATE),\n+        HALF_FLOAT(true, CoreValuesSourceType.NUMERIC),\n+        FLOAT(true, CoreValuesSourceType.NUMERIC),\n+        DOUBLE(true, CoreValuesSourceType.NUMERIC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "19e739e637065a6eb9cf512bd1176d545b03e88a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5MTMwNw==", "bodyText": "Scratch that. It is already on ValuesSource which is perfect.", "url": "https://github.com/elastic/elasticsearch/pull/57373#discussion_r432991307", "createdAt": "2020-05-31T22:33:54Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/index/fielddata/IndexNumericFieldData.java", "diffHunk": "@@ -19,30 +19,37 @@\n \n package org.elasticsearch.index.fielddata;\n \n+import org.elasticsearch.search.aggregations.support.CoreValuesSourceType;\n+import org.elasticsearch.search.aggregations.support.ValuesSourceType;\n+\n public interface IndexNumericFieldData extends IndexFieldData<LeafNumericFieldData> {\n \n     enum NumericType {\n-        BOOLEAN(false),\n-        BYTE(false),\n-        SHORT(false),\n-        INT(false),\n-        LONG(false),\n-        DATE(false),\n-        DATE_NANOSECONDS(false),\n-        HALF_FLOAT(true),\n-        FLOAT(true),\n-        DOUBLE(true);\n+        BOOLEAN(false, CoreValuesSourceType.BOOLEAN),\n+        BYTE(false, CoreValuesSourceType.NUMERIC),\n+        SHORT(false, CoreValuesSourceType.NUMERIC),\n+        INT(false, CoreValuesSourceType.NUMERIC),\n+        LONG(false, CoreValuesSourceType.NUMERIC),\n+        DATE(false, CoreValuesSourceType.DATE),\n+        DATE_NANOSECONDS(false, CoreValuesSourceType.DATE),\n+        HALF_FLOAT(true, CoreValuesSourceType.NUMERIC),\n+        FLOAT(true, CoreValuesSourceType.NUMERIC),\n+        DOUBLE(true, CoreValuesSourceType.NUMERIC);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMjk5MTIxMQ=="}, "originalCommit": {"oid": "19e739e637065a6eb9cf512bd1176d545b03e88a"}, "originalPosition": 29}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzNjAzNA==", "bodyText": "Left over?", "url": "https://github.com/elastic/elasticsearch/pull/57373#discussion_r433336034", "createdAt": "2020-06-01T16:07:00Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -715,7 +715,8 @@ public void testSupportedFieldTypes() throws IOException {\n                     IndexSearcher indexSearcher = newIndexSearcher(indexReader);\n                     AggregationBuilder aggregationBuilder = createAggBuilderForTypeTest(fieldType, fieldName);\n \n-                    ValuesSourceType vst = fieldType.getValuesSourceType();\n+                    //ValuesSourceType vst = fieldType.getValuesSourceType();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "696481af7ffbd087419401da0e50ba273377ca89"}, "originalPosition": 23}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzNzIxNA==", "bodyText": "Do we still need this change?", "url": "https://github.com/elastic/elasticsearch/pull/57373#discussion_r433337214", "createdAt": "2020-06-01T16:09:11Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -159,6 +159,7 @@\n         CompletionFieldMapper.CONTENT_TYPE, // TODO support completion\n         FieldAliasMapper.CONTENT_TYPE // TODO support alias\n     );\n+    private QueryShardContext queryShardContext;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "696481af7ffbd087419401da0e50ba273377ca89"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMzMzODcxOQ==", "bodyText": "Something about this method smells funky to me. I can see why we have it though. I'd sort of hoped for a cleaner way to get this, but I understand. Might be worth poking at in a follow up.", "url": "https://github.com/elastic/elasticsearch/pull/57373#discussion_r433338719", "createdAt": "2020-06-01T16:11:59Z", "author": {"login": "nik9000"}, "path": "test/framework/src/main/java/org/elasticsearch/search/aggregations/AggregatorTestCase.java", "diffHunk": "@@ -739,6 +740,11 @@ public void testSupportedFieldTypes() throws IOException {\n         }\n     }\n \n+    private ValuesSourceType fieldToVST(MappedFieldType fieldType) {\n+        return fieldType.fielddataBuilder(\"\")\n+                                .build(createIndexSettings(), fieldType, null, null, null).getValuesSourceType();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "696481af7ffbd087419401da0e50ba273377ca89"}, "originalPosition": 35}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "13939ee05ff81a6bb409ae55726c36e60ca1d1f8", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/13939ee05ff81a6bb409ae55726c36e60ca1d1f8", "committedDate": "2020-06-01T16:32:27Z", "message": "Remove some dead code"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIyMDA0Njg1", "url": "https://github.com/elastic/elasticsearch/pull/57373#pullrequestreview-422004685", "createdAt": "2020-06-01T16:39:56Z", "commit": {"oid": "13939ee05ff81a6bb409ae55726c36e60ca1d1f8"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5874903c4d78913ee6cb7d2236505abf2a004ca3", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/5874903c4d78913ee6cb7d2236505abf2a004ca3", "committedDate": "2020-06-01T16:53:31Z", "message": "Checkstyle"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4031, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}