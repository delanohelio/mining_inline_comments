{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzU5MDM0MzEx", "number": 50610, "title": "Run keystore management tests on docker distros", "bodyText": "This PR moves some of the Docker-specific setup and teardown from DockerTests up to PackagingTestCase so that the KeystoreManagement tests will run on Docker. The main thing that needs to happen is setting the testing Shell to be a DockerShell. Previously, the KeystoreManagementTests were mostly \"passing\" on Docker because they ran shell commands on the underlying system and then queried a Docker installation. Now, we can be more confident that the tests are doing the right thing in the Docker case.\nFixes #49469", "createdAt": "2020-01-03T15:53:15Z", "url": "https://github.com/elastic/elasticsearch/pull/50610", "merged": true, "mergeCommit": {"oid": "1284eccf5d49c107e8df99e68910d25f90c42ed7"}, "closed": true, "closedAt": "2020-01-08T14:22:00Z", "author": {"login": "williamrandolph"}, "timelineItems": {"totalCount": 17, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABb2fV-dAH2gAyMzU5MDM0MzExOmZiNzQ1NWUzMmFjOTc2NGM2MmVmZmU0MTA0NGNkNzk3MmE2NjA4NTY=", "endCursor": "Y3Vyc29yOnYyOpPPAAABb4H4omgFqTMzOTUyNzYxNg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fb7455e32ac9764c62effe41044cd7972a660856", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb7455e32ac9764c62effe41044cd7972a660856", "committedDate": "2020-01-02T19:57:54Z", "message": "Add Docker handling to PackagingTestCase\n\nKeystore tests need to be able to run in the Docker case. We can do this\nby using a DockerShell instead of a plain Shell when Docker is running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b3cbd692b416afa9ebe3b04564615ef1f5a8cf2", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b3cbd692b416afa9ebe3b04564615ef1f5a8cf2", "committedDate": "2020-01-02T21:00:28Z", "message": "Merge branch 'feature-pwd-protected-keystore-2' into docker-keystore-tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6a76f2021a73ef2f93ec8373736dab0a6d458359", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/6a76f2021a73ef2f93ec8373736dab0a6d458359", "committedDate": "2020-01-03T15:40:32Z", "message": "Refactor cleanup to parent class"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7366e9776d4444eee7d0d7a9352a7259116dd4", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb7366e9776d4444eee7d0d7a9352a7259116dd4", "committedDate": "2020-01-03T16:26:59Z", "message": "Verify permissions on docker keystore"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f7e79314630d8abe630cb6421946ba244596a6e", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f7e79314630d8abe630cb6421946ba244596a6e", "committedDate": "2020-01-03T17:22:00Z", "message": "Remove redundant docker test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a433e13fa5aa97432f810e885317eaebfc68a878", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/a433e13fa5aa97432f810e885317eaebfc68a878", "committedDate": "2020-01-03T18:42:56Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/d93631ca663b0c0febff3fe79a20a4d74e116aec", "committedDate": "2020-01-03T20:38:16Z", "message": "Wait for keystore path availability for docker"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTU2MzU0", "url": "https://github.com/elastic/elasticsearch/pull/50610#pullrequestreview-338556354", "createdAt": "2020-01-06T10:00:21Z", "commit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMDoyMVrOFaZoWA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMDoyMVrOFaZoWA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyNzIyNA==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n          \n          \n            \n                    assertFalse(\"has-passwd should fail\", r.isSuccess());", "url": "https://github.com/elastic/elasticsearch/pull/50610#discussion_r363227224", "createdAt": "2020-01-06T10:00:21Z", "author": {"login": "pugnascotia"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/KeystoreManagementTests.java", "diffHunk": "@@ -80,9 +83,30 @@ public void test11InstallPackageDistribution() throws Exception {\n         Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n         assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n         assertThat(\"has-passwd should fail\", r.stderr, containsString(\"ERROR: Keystore is not password-protected\"));\n+        Shell.Result r2 = bin.keystoreTool.run(\"list\");\n+        assertThat(r2.stdout, containsString(\"keystore.seed\"));\n+    }\n+\n+    /** Test initial Docker state */\n+    public void test12InstallDockerDistribution() throws Exception {\n+        assumeTrue(distribution().packaging == Distribution.Packaging.DOCKER);\n+\n+        installation = Docker.runContainer(distribution());\n+\n+        try {\n+            waitForPathToExist(installation.config(\"elasticsearch.keystore\"));\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        final Installation.Executables bin = installation.executables();\n+        Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n+        assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec"}, "originalPosition": 57}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTU2NzA5", "url": "https://github.com/elastic/elasticsearch/pull/50610#pullrequestreview-338556709", "createdAt": "2020-01-06T10:01:06Z", "commit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMTowNlrOFaZpXA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMS0wNlQxMDowMTowNlrOFaZpXA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM2MzIyNzQ4NA==", "bodyText": "Since the previous line checked that the command failed, how about changing the message here:\n\n  \n    \n      \n        Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                    assertThat(\"has-passwd should fail\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));\n          \n          \n            \n                    assertThat(\"has-passwd didn't fail with the expected error\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));", "url": "https://github.com/elastic/elasticsearch/pull/50610#discussion_r363227484", "createdAt": "2020-01-06T10:01:06Z", "author": {"login": "pugnascotia"}, "path": "qa/os/src/test/java/org/elasticsearch/packaging/test/KeystoreManagementTests.java", "diffHunk": "@@ -80,9 +83,30 @@ public void test11InstallPackageDistribution() throws Exception {\n         Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n         assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n         assertThat(\"has-passwd should fail\", r.stderr, containsString(\"ERROR: Keystore is not password-protected\"));\n+        Shell.Result r2 = bin.keystoreTool.run(\"list\");\n+        assertThat(r2.stdout, containsString(\"keystore.seed\"));\n+    }\n+\n+    /** Test initial Docker state */\n+    public void test12InstallDockerDistribution() throws Exception {\n+        assumeTrue(distribution().packaging == Distribution.Packaging.DOCKER);\n+\n+        installation = Docker.runContainer(distribution());\n+\n+        try {\n+            waitForPathToExist(installation.config(\"elasticsearch.keystore\"));\n+        } catch (InterruptedException e) {\n+            throw new RuntimeException(e);\n+        }\n+\n+        final Installation.Executables bin = installation.executables();\n+        Shell.Result r = sh.runIgnoreExitCode(bin.keystoreTool.toString() + \" has-passwd\");\n+        assertThat(\"has-passwd should fail\", r.exitCode, not(is(0)));\n+        assertThat(\"has-passwd should fail\", r.stdout, containsString(\"ERROR: Keystore is not password-protected\"));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec"}, "originalPosition": 58}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM4NTU3Mzk5", "url": "https://github.com/elastic/elasticsearch/pull/50610#pullrequestreview-338557399", "createdAt": "2020-01-06T10:02:32Z", "commit": {"oid": "d93631ca663b0c0febff3fe79a20a4d74e116aec"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "792020814f1074991cad275e9d23ec9f5e3b57c6", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/792020814f1074991cad275e9d23ec9f5e3b57c6", "committedDate": "2020-01-06T19:30:04Z", "message": "Add isDocker shortcut method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5cbfe38e1c6aecd2dcebdc8eb99b0f25c342cfb0", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cbfe38e1c6aecd2dcebdc8eb99b0f25c342cfb0", "committedDate": "2020-01-06T19:31:02Z", "message": "Return full command width from docker ps"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d551fce19842ed6bd33b45ee4483bcd31e6e232", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d551fce19842ed6bd33b45ee4483bcd31e6e232", "committedDate": "2020-01-06T19:41:13Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24e5a95f28e7cbbe533f316601847fec7f6fd2b2", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/24e5a95f28e7cbbe533f316601847fec7f6fd2b2", "committedDate": "2020-01-06T20:39:40Z", "message": "Improve ES startup check for docker\n\nPreviously we were checking truncated output for the packaged JDK as\nan indication that Elasticsearch had started. With new preliminary\npassword checks, we might get a false positive from ES keystore\ncommands, so we have to check specifically that the Elasticsearch\nclass from the Bootstrap package is what's running."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9ce885586c50ed84f6fa81cf0f927e37d40b467", "author": {"user": {"login": "williamrandolph", "name": "William Brafford"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9ce885586c50ed84f6fa81cf0f927e37d40b467", "committedDate": "2020-01-06T22:48:34Z", "message": "Respond to PR feedback"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5MTE2ODQ1", "url": "https://github.com/elastic/elasticsearch/pull/50610#pullrequestreview-339116845", "createdAt": "2020-01-07T09:24:35Z", "commit": {"oid": "b9ce885586c50ed84f6fa81cf0f927e37d40b467"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzM5NTI3NjE2", "url": "https://github.com/elastic/elasticsearch/pull/50610#pullrequestreview-339527616", "createdAt": "2020-01-07T21:45:53Z", "commit": {"oid": "b9ce885586c50ed84f6fa81cf0f927e37d40b467"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3980, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}