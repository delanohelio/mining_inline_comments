{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzc3ODk5ODc4", "number": 52586, "title": "SQL: use a calendar interval for histograms over 1 month intervals", "bodyText": "Addresses #51538.", "createdAt": "2020-02-20T18:05:35Z", "url": "https://github.com/elastic/elasticsearch/pull/52586", "merged": true, "mergeCommit": {"oid": "928b11a34ec92d90d082abdf4fa09f7ce1d7c0c4"}, "closed": true, "closedAt": "2020-02-24T16:02:35Z", "author": {"login": "astefan"}, "timelineItems": {"totalCount": 11, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcGPD4zgH2gAyMzc3ODk5ODc4OmZjZTQxYTQ5M2NjM2VhY2M3YjMyZWIzM2VkODU0M2UxODExNDdlMmE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcHbLDsAFqTM2MzI5ODEwOA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fce41a493cc3eacc7b32eb33ed8543e181147e2a", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/fce41a493cc3eacc7b32eb33ed8543e181147e2a", "committedDate": "2020-02-20T18:02:27Z", "message": "Use a calendar interval for histograms on INTERVAL 1 MONTH"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1298d85de6b08bd57fad975ef5c40b0a30b7450e", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1298d85de6b08bd57fad975ef5c40b0a30b7450e", "committedDate": "2020-02-20T18:02:56Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7b1a2547820beba41cd51ae21939bed94d0102cb", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/7b1a2547820beba41cd51ae21939bed94d0102cb", "committedDate": "2020-02-21T01:06:19Z", "message": "Remove unused import"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/72f01a2c85d9d12ab97dfebf4a76cd926a48117a", "committedDate": "2020-02-21T01:11:06Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTAzMjAw", "url": "https://github.com/elastic/elasticsearch/pull/52586#pullrequestreview-362503200", "createdAt": "2020-02-21T09:37:06Z", "commit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwOTozNzowNlrOFsw4HA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwOTozNzowNlrOFsw4HA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4MjQ2MA==", "bodyText": "This is already checked that it's one of the two so mayb an else is enough.", "url": "https://github.com/elastic/elasticsearch/pull/52586#discussion_r382482460", "createdAt": "2020-02-21T09:37:06Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryFolder.java", "diffHunk": "@@ -322,17 +320,30 @@ else if (exp instanceof GroupingFunction) {\n                             // date histogram\n                             if (isDateBased(h.dataType())) {\n                                 Object value = h.interval().value();\n-                                // interval of exactly 1 year\n-                                if (value instanceof IntervalYearMonth\n-                                        && ((IntervalYearMonth) value).interval().equals(Period.ofYears(1))) {\n-                                    String calendarInterval = Year.YEAR_INTERVAL;\n+                                // interval of exactly 1 year or 1 month\n+                                if (value instanceof IntervalYearMonth &&\n+                                        (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) \n+                                        || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))) {\n+                                    Period yearMonth = ((IntervalYearMonth) value).interval();\n+                                    \n+                                    String calendarInterval = null;\n+                                    if (yearMonth.equals(Period.ofYears(1))) {\n+                                        calendarInterval = Histogram.YEAR_INTERVAL;\n+                                    } else if (yearMonth.equals(Period.ofMonths(1))) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a"}, "originalPosition": 33}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTAzOTcx", "url": "https://github.com/elastic/elasticsearch/pull/52586#pullrequestreview-362503971", "createdAt": "2020-02-21T09:38:17Z", "commit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwOTozODoxN1rOFsw6lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0yMVQwOTozODoxN1rOFsw6lQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4MjQ4MzA5Mw==", "bodyText": "Here too, the null check is superfluous as the whole block is guarded by:\n&& (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))", "url": "https://github.com/elastic/elasticsearch/pull/52586#discussion_r382483093", "createdAt": "2020-02-21T09:38:17Z", "author": {"login": "matriv"}, "path": "x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/planner/QueryFolder.java", "diffHunk": "@@ -322,17 +320,30 @@ else if (exp instanceof GroupingFunction) {\n                             // date histogram\n                             if (isDateBased(h.dataType())) {\n                                 Object value = h.interval().value();\n-                                // interval of exactly 1 year\n-                                if (value instanceof IntervalYearMonth\n-                                        && ((IntervalYearMonth) value).interval().equals(Period.ofYears(1))) {\n-                                    String calendarInterval = Year.YEAR_INTERVAL;\n+                                // interval of exactly 1 year or 1 month\n+                                if (value instanceof IntervalYearMonth &&\n+                                        (((IntervalYearMonth) value).interval().equals(Period.ofYears(1)) \n+                                        || ((IntervalYearMonth) value).interval().equals(Period.ofMonths(1)))) {\n+                                    Period yearMonth = ((IntervalYearMonth) value).interval();\n+                                    \n+                                    String calendarInterval = null;\n+                                    if (yearMonth.equals(Period.ofYears(1))) {\n+                                        calendarInterval = Histogram.YEAR_INTERVAL;\n+                                    } else if (yearMonth.equals(Period.ofMonths(1))) {\n+                                        calendarInterval = Histogram.MONTH_INTERVAL;\n+                                    }\n \n-                                    // When the histogram is `INTERVAL '1' YEAR`, the interval used in the ES date_histogram will be\n-                                    // a calendar_interval with value \"1y\". All other intervals will be fixed_intervals expressed in ms.\n-                                    if (field instanceof FieldAttribute) {\n-                                        key = new GroupByDateHistogram(aggId, QueryTranslator.nameOf(field), calendarInterval, h.zoneId());\n-                                    } else if (field instanceof Function) {\n-                                        key = new GroupByDateHistogram(aggId, ((Function) field).asScript(), calendarInterval, h.zoneId());\n+                                    // When the histogram is `INTERVAL '1' YEAR` or `INTERVAL '1' MONTH`, the interval used in \n+                                    // the ES date_histogram will be a calendar_interval with value \"1y\" or \"1M\" respectively.\n+                                    // All other intervals will be fixed_intervals expressed in ms.\n+                                    if (calendarInterval != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a"}, "originalPosition": 46}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYyNTA0MTkw", "url": "https://github.com/elastic/elasticsearch/pull/52586#pullrequestreview-362504190", "createdAt": "2020-02-21T09:38:39Z", "commit": {"oid": "72f01a2c85d9d12ab97dfebf4a76cd926a48117a"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7af8f142c4b7fee4b977aa90bb96cd1b18557279", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/7af8f142c4b7fee4b977aa90bb96cd1b18557279", "committedDate": "2020-02-21T09:51:25Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1b468f5c2b97a92c44ca66c4a7c5b9a36ffaaa54", "author": {"user": {"login": "astefan", "name": "Andrei Stefan"}}, "url": "https://github.com/elastic/elasticsearch/commit/1b468f5c2b97a92c44ca66c4a7c5b9a36ffaaa54", "committedDate": "2020-02-21T09:51:51Z", "message": "Merge branch 'master' of https://github.com/elastic/elasticsearch into 51538_impl"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjU0ODA4", "url": "https://github.com/elastic/elasticsearch/pull/52586#pullrequestreview-363254808", "createdAt": "2020-02-24T09:33:26Z", "commit": {"oid": "1298d85de6b08bd57fad975ef5c40b0a30b7450e"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzYzMjk4MTA4", "url": "https://github.com/elastic/elasticsearch/pull/52586#pullrequestreview-363298108", "createdAt": "2020-02-24T10:43:04Z", "commit": {"oid": "1b468f5c2b97a92c44ca66c4a7c5b9a36ffaaa54"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2245, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}