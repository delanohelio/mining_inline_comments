{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQzOTA4NTg0", "number": 58994, "title": "Fix TODO about Spurious FAILED Snapshots", "bodyText": "There is no point in writing out snapshots that contain no data that can be restored\nwhatsoever. It may have made sense to do so in the past when there was an INIT snapshot\nstep that wrote data to the repository that would've other become unreferenced, but in the\ncurrent day state machine without the INIT step there is no point in doing so.", "createdAt": "2020-07-03T07:50:15Z", "url": "https://github.com/elastic/elasticsearch/pull/58994", "merged": true, "mergeCommit": {"oid": "02539fa52b4309a0e8aa2d35272704e2a79e0152"}, "closed": true, "closedAt": "2020-07-08T11:13:03Z", "author": {"login": "original-brownbear"}, "timelineItems": {"totalCount": 18, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcxOnZ8gH2gAyNDQzOTA4NTg0Ojc0OWI0ZjFjYTg1MWQzNjFlMDM0MmJjMWZmNzMxNWJjN2ZkZjU0YWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcy4dCpAFqTQ0NDY0MDUzNA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "749b4f1ca851d361e0342bc1ff7315bc7fdf54ab", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/749b4f1ca851d361e0342bc1ff7315bc7fdf54ab", "committedDate": "2020-07-03T07:50:05Z", "message": "Fix TODO about Spurious FAILED Snapshots\n\nThere is no point in writing out snapshots that contain no data that can be restored\nwhatsoever. It may have made sense to do so in the past when there was an `INIT` snapshot\nstep that wrote data to the repository that would've other become unreferenced, but in the\ncurrent day state machine without the `INIT` step there is no point in doing so."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "91891437fb2129bc8cbf6532cfc317183a8a09c3", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/91891437fb2129bc8cbf6532cfc317183a8a09c3", "committedDate": "2020-07-03T07:46:33Z", "message": "Fix TODO about Spurious FAILED Snapshots\n\nThere is no point in writing out snapshots that contain no data that can be restored\nwhatsoever. It may have made sense to do so in the past when there was an `INIT` snapshot\nstep that wrote data to the repository that would've other become unreferenced, but in the\ncurrent day state machine without the `INIT` step there is no point in doing so."}, "afterCommit": {"oid": "749b4f1ca851d361e0342bc1ff7315bc7fdf54ab", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/749b4f1ca851d361e0342bc1ff7315bc7fdf54ab", "committedDate": "2020-07-03T07:50:05Z", "message": "Fix TODO about Spurious FAILED Snapshots\n\nThere is no point in writing out snapshots that contain no data that can be restored\nwhatsoever. It may have made sense to do so in the past when there was an `INIT` snapshot\nstep that wrote data to the repository that would've other become unreferenced, but in the\ncurrent day state machine without the `INIT` step there is no point in doing so."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6841b41a6732b4976ae675347b556f113b9e9377", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/6841b41a6732b4976ae675347b556f113b9e9377", "committedDate": "2020-07-03T08:15:29Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-snapshot-spurious-failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "73cb8ecc84367b57b4a10a8e2a064b7444ca2155", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/73cb8ecc84367b57b4a10a8e2a064b7444ca2155", "committedDate": "2020-07-03T08:19:55Z", "message": "fix SLM tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3d84d5eb834daa196acca6300366250d79d84156", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/3d84d5eb834daa196acca6300366250d79d84156", "committedDate": "2020-07-03T09:04:15Z", "message": "fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e604ccffcc9ea911721c2fc8d00dd231e7770cde", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e604ccffcc9ea911721c2fc8d00dd231e7770cde", "committedDate": "2020-07-03T15:21:20Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-snapshot-spurious-failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/67f81a25713d50d71362f02d05faea12713e782c", "committedDate": "2020-07-03T15:29:15Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQyODM1Mzcx", "url": "https://github.com/elastic/elasticsearch/pull/58994#pullrequestreview-442835371", "createdAt": "2020-07-06T07:31:41Z", "commit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c"}, "state": "COMMENTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzozMTo0MVrOGtL6Mg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQwNzo0MDoxMVrOGtMKvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAzNDIyNg==", "bodyText": "space missing.", "url": "https://github.com/elastic/elasticsearch/pull/58994#discussion_r450034226", "createdAt": "2020-07-06T07:31:41Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java", "diffHunk": "@@ -244,21 +244,16 @@ public ClusterState execute(ClusterState currentState) {\n                         }\n                     }\n                     if (missing.isEmpty() == false) {\n-                        // TODO: We should just throw here instead of creating a FAILED and hence useless snapshot in the repository\n-                        newEntry = new SnapshotsInProgress.Entry(\n-                                new Snapshot(repositoryName, snapshotId), request.includeGlobalState(), false,\n-                                State.FAILED, indexIds, dataStreams, threadPool.absoluteTimeInMillis(), repositoryData.getGenId(), shards,\n-                                \"Indices don't have primary shards \" + missing, userMeta, version);\n+                        throw new SnapshotException(\n+                            new Snapshot(repositoryName, snapshotId),\"Indices don't have primary shards \" + missing);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c"}, "originalPosition": 10}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAzNjUwOA==", "bodyText": "While this test used the old behavior to get a failed snapshot, it is still a useful test for listing good and bad snapshots, no?", "url": "https://github.com/elastic/elasticsearch/pull/58994#discussion_r450036508", "createdAt": "2020-07-06T07:36:23Z", "author": {"login": "ywelsch"}, "path": "server/src/internalClusterTest/java/org/elasticsearch/snapshots/SharedClusterSnapshotRestoreIT.java", "diffHunk": "@@ -3346,77 +3342,6 @@ public void testSnapshotSucceedsAfterSnapshotFailure() throws Exception {\n         assertEquals(SnapshotState.SUCCESS, getSnapshotsResponse.getSnapshots(\"test-repo-2\").get(0).state());\n     }\n \n-    public void testSnapshotStatusOnFailedIndex() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAzNzQ2Mg==", "bodyText": "final SnapshotException ... and then assertNotNull() in the next line", "url": "https://github.com/elastic/elasticsearch/pull/58994#discussion_r450037462", "createdAt": "2020-07-06T07:38:12Z", "author": {"login": "ywelsch"}, "path": "server/src/test/java/org/elasticsearch/snapshots/SnapshotResiliencyTests.java", "diffHunk": "@@ -397,9 +401,22 @@ public void testSnapshotWithNodeDisconnects() {\n             } else if (randomBoolean()) {\n                 scheduleNow(() -> testClusterNodes.clearNetworkDisruptions());\n             }\n+        }, e -> {\n+            if (partial == false) {\n+                final Throwable unwrapped =", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c"}, "originalPosition": 52}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDAzODQ2MA==", "bodyText": "should we still test this scenario? Can folks disable partial snapshots on SLM?", "url": "https://github.com/elastic/elasticsearch/pull/58994#discussion_r450038460", "createdAt": "2020-07-06T07:40:11Z", "author": {"login": "ywelsch"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SLMSnapshotBlockingIntegTests.java", "diffHunk": "@@ -257,26 +257,17 @@ public void testRetentionWhileSnapshotInProgress() throws Exception {\n         }\n     }\n \n-    public void testBasicFailureRetention() throws Exception {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "67f81a25713d50d71362f02d05faea12713e782c"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e1c204b09a499c7e1f6b5d3e8cedf139cbe30d49", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/e1c204b09a499c7e1f6b5d3e8cedf139cbe30d49", "committedDate": "2020-07-06T08:19:12Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-snapshot-spurious-failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4936738af6cafb6c2e7d6251fcb99045d898dd15", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/4936738af6cafb6c2e7d6251fcb99045d898dd15", "committedDate": "2020-07-06T08:28:09Z", "message": "CR: small points"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5761b184843f6904f748aa9bc444adfc1b1f2cd", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5761b184843f6904f748aa9bc444adfc1b1f2cd", "committedDate": "2020-07-06T13:11:11Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-snapshot-spurious-failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f4839471e4e8e5359ca38d9afaa1c2efcd40bc6f", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/f4839471e4e8e5359ca38d9afaa1c2efcd40bc6f", "committedDate": "2020-07-06T13:45:32Z", "message": "bring back one test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "43f11ceeee90ada04613836a0192ce3d9bc4e275", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/43f11ceeee90ada04613836a0192ce3d9bc4e275", "committedDate": "2020-07-06T13:51:54Z", "message": "bck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a3162bbc82ead5a61c3f255427e7adf2baec232", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a3162bbc82ead5a61c3f255427e7adf2baec232", "committedDate": "2020-07-08T09:00:02Z", "message": "Merge remote-tracking branch 'elastic/master' into remove-snapshot-spurious-failed"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a1e46118799ff10019110b6e6ece119ce9575257", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/a1e46118799ff10019110b6e6ece119ce9575257", "committedDate": "2020-07-08T09:54:17Z", "message": "test with fake failed snapshot"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NTk3NTUz", "url": "https://github.com/elastic/elasticsearch/pull/58994#pullrequestreview-444597553", "createdAt": "2020-07-08T10:03:51Z", "commit": {"oid": "a1e46118799ff10019110b6e6ece119ce9575257"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDowMzo1MVrOGuhDPA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wOFQxMDowMzo1MVrOGuhDPA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MTQyOTE4MA==", "bodyText": "Faking the FAILED snapshot with the right metadata so that SLM picks it up here now. It's a bit of a corner case since we won't be creating any new FAILED snapshots but probably nice to have this tested to make sure that in rolling upgrade scenarios FAILED snapshots are getting cleaned up eventually.", "url": "https://github.com/elastic/elasticsearch/pull/58994#discussion_r451429180", "createdAt": "2020-07-08T10:03:51Z", "author": {"login": "original-brownbear"}, "path": "x-pack/plugin/ilm/src/test/java/org/elasticsearch/xpack/slm/SLMSnapshotBlockingIntegTests.java", "diffHunk": "@@ -274,27 +274,33 @@ private void testUnsuccessfulSnapshotRetention(boolean partialSuccess) throws Ex\n         // Create a failed snapshot\n         AtomicReference<String> failedSnapshotName = new AtomicReference<>();\n         {\n-            logger.info(\"-->  stopping random data node, which should cause shards to go missing\");\n-            internalCluster().stopRandomDataNode();\n-            assertBusy(() ->\n-                    assertEquals(ClusterHealthStatus.RED, client().admin().cluster().prepareHealth().get().getStatus()),\n-                30, TimeUnit.SECONDS);\n-\n-            final String masterNode = blockMasterFromFinalizingSnapshotOnIndexFile(REPO);\n-\n-            logger.info(\"-->  start snapshot\");\n-            ActionFuture<ExecuteSnapshotLifecycleAction.Response> snapshotFuture = client()\n-                .execute(ExecuteSnapshotLifecycleAction.INSTANCE, new ExecuteSnapshotLifecycleAction.Request(policyId));\n-\n-            logger.info(\"--> waiting for block to kick in on \" + masterNode);\n-            waitForBlock(masterNode, REPO, TimeValue.timeValueSeconds(60));\n-\n-            logger.info(\"-->  stopping master node\");\n-            internalCluster().stopCurrentMasterNode();\n-\n-            logger.info(\"-->  wait until the snapshot is done\");\n-            failedSnapshotName.set(snapshotFuture.get().getSnapshotName());\n-            assertNotNull(failedSnapshotName.get());\n+            if (partialSuccess) {\n+                logger.info(\"-->  stopping random data node, which should cause shards to go missing\");\n+                internalCluster().stopRandomDataNode();\n+                assertBusy(() -> assertEquals(ClusterHealthStatus.RED, client().admin().cluster().prepareHealth().get().getStatus()),\n+                        30, TimeUnit.SECONDS);\n+\n+                final String masterNode = blockMasterFromFinalizingSnapshotOnIndexFile(REPO);\n+\n+                logger.info(\"-->  start snapshot\");\n+                ActionFuture<ExecuteSnapshotLifecycleAction.Response> snapshotFuture = client()\n+                        .execute(ExecuteSnapshotLifecycleAction.INSTANCE, new ExecuteSnapshotLifecycleAction.Request(policyId));\n+\n+                logger.info(\"--> waiting for block to kick in on \" + masterNode);\n+                waitForBlock(masterNode, REPO, TimeValue.timeValueSeconds(60));\n+\n+                logger.info(\"-->  stopping master node\");\n+                internalCluster().stopCurrentMasterNode();\n+\n+                logger.info(\"-->  wait until the snapshot is done\");\n+                failedSnapshotName.set(snapshotFuture.get().getSnapshotName());\n+                assertNotNull(failedSnapshotName.get());\n+            } else {\n+                final String snapshotName = \"failed-snapshot-1\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a1e46118799ff10019110b6e6ece119ce9575257"}, "originalPosition": 47}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "828b5ae33d652c8794e119c91d56133c29044628", "author": {"user": {"login": "original-brownbear", "name": "Armin Braun"}}, "url": "https://github.com/elastic/elasticsearch/commit/828b5ae33d652c8794e119c91d56133c29044628", "committedDate": "2020-07-08T10:04:50Z", "message": "whitespace"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ0NjQwNTM0", "url": "https://github.com/elastic/elasticsearch/pull/58994#pullrequestreview-444640534", "createdAt": "2020-07-08T11:08:42Z", "commit": {"oid": "828b5ae33d652c8794e119c91d56133c29044628"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2425, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}