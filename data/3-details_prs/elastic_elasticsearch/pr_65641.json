{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTI5ODc0MTgw", "number": 65641, "title": "Fix bug where fvh fragments could be loaded from wrong doc", "bodyText": "This PR fixes a regression where fvh fragments could be loaded from the wrong\ndocument _source.\nSome FragmentsBuilder implementations contain a SourceLookup to load from\n_source. The lookup should be positioned to load from the current hit document.\nHowever, since FragmentsBuilder are cached and shared across hits, the lookup\nis never updated to load from the new documents. This means we accidentally\nload _source from a different document.\nThe regression was introduced in #60179, which started storing SourceLookup\non FragmentsBuilder.\nFixes #65533.", "createdAt": "2020-11-30T23:35:23Z", "url": "https://github.com/elastic/elasticsearch/pull/65641", "merged": true, "mergeCommit": {"oid": "ddf1f4cdb819d51369a5f7c32e7aa3183e489fa1"}, "closed": true, "closedAt": "2020-12-09T22:47:12Z", "author": {"login": "jtibshirani"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdht6ZdgH2gAyNTI5ODc0MTgwOjIzZDI4NDAwNDI3ODRiNWFhZWVlZDA2NjY3OWUxNWY2M2VhYzg4Zjc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdi0miYgFqTU0NDgwNDAzNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "23d2840042784b5aaeeed066679e15f63eac88f7", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/23d2840042784b5aaeeed066679e15f63eac88f7", "committedDate": "2020-11-30T23:26:15Z", "message": "Add tests demonstrating bug."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQxMzg0MTUx", "url": "https://github.com/elastic/elasticsearch/pull/65641#pullrequestreview-541384151", "createdAt": "2020-11-30T23:46:42Z", "commit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0Njo0MlrOH8SYeQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0zMFQyMzo0Njo0MlrOH8SYeQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzMjk3Nzc4NQ==", "bodyText": "This is hacky but felt like the best way to fix this right now. FragmentsBuilder is an external (Lucene) interface and there's not a good way to pass in _source to its methods like getFields.", "url": "https://github.com/elastic/elasticsearch/pull/65641#discussion_r532977785", "createdAt": "2020-11-30T23:46:42Z", "author": {"login": "jtibshirani"}, "path": "server/src/main/java/org/elasticsearch/search/fetch/subphase/highlight/FastVectorHighlighter.java", "diffHunk": "@@ -160,8 +160,13 @@ public HighlightField highlight(FieldHighlightContext fieldContext) throws IOExc\n         }\n         cache.fvh.setPhraseLimit(field.fieldOptions().phraseLimit());\n \n-        String[] fragments;\n+        // If the fragments builder requires document _source, pass it the source lookup from the hit context.\n+        if (entry.fragmentsBuilder instanceof SourceBasedFragmentsBuilder) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841"}, "originalPosition": 33}]}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1a59d1594da76b4e3a5991a8c398d237407ce841", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/1a59d1594da76b4e3a5991a8c398d237407ce841", "committedDate": "2020-11-30T23:26:15Z", "message": "Explicitly pass document _source to the fragments builder."}, "afterCommit": {"oid": "fd6311309e4044ab1fb1318463de7c2874c06e39", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd6311309e4044ab1fb1318463de7c2874c06e39", "committedDate": "2020-11-30T23:47:56Z", "message": "Explicitly pass document _source to the fragments builder."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "fd6311309e4044ab1fb1318463de7c2874c06e39", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/fd6311309e4044ab1fb1318463de7c2874c06e39", "committedDate": "2020-11-30T23:47:56Z", "message": "Explicitly pass document _source to the fragments builder."}, "afterCommit": {"oid": "a4b4af48d419de9345afde453ae51fb89df2c40f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4b4af48d419de9345afde453ae51fb89df2c40f", "committedDate": "2020-12-01T00:04:57Z", "message": "Explicitly pass document _source to the fragments builder."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "a4b4af48d419de9345afde453ae51fb89df2c40f", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a4b4af48d419de9345afde453ae51fb89df2c40f", "committedDate": "2020-12-01T00:04:57Z", "message": "Explicitly pass document _source to the fragments builder."}, "afterCommit": {"oid": "ab7abb6699157742f132b2c63370f9823ec9da66", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab7abb6699157742f132b2c63370f9823ec9da66", "committedDate": "2020-12-01T00:46:27Z", "message": "Explicitly pass document _source to the fragments builder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f328a53e7493f91f31744d0e26585d18e0eac295", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f328a53e7493f91f31744d0e26585d18e0eac295", "committedDate": "2020-12-01T01:11:31Z", "message": "Explicitly pass document _source to the fragments builder."}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "ab7abb6699157742f132b2c63370f9823ec9da66", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/ab7abb6699157742f132b2c63370f9823ec9da66", "committedDate": "2020-12-01T00:46:27Z", "message": "Explicitly pass document _source to the fragments builder."}, "afterCommit": {"oid": "f328a53e7493f91f31744d0e26585d18e0eac295", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/f328a53e7493f91f31744d0e26585d18e0eac295", "committedDate": "2020-12-01T01:11:31Z", "message": "Explicitly pass document _source to the fragments builder."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fb7e4521708baa0004c9627fc609a3e4d2a87ea5", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/fb7e4521708baa0004c9627fc609a3e4d2a87ea5", "committedDate": "2020-12-03T22:21:12Z", "message": "Revert \"Explicitly pass document _source to the fragments builder.\"\n\nThis reverts commit f328a53e7493f91f31744d0e26585d18e0eac295."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c36eba8bdfa017f6ec75da60e1cf4d10efdb302", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c36eba8bdfa017f6ec75da60e1cf4d10efdb302", "committedDate": "2020-12-03T22:46:11Z", "message": "Cache a supplier instead of the fragments builder itself."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a0da417ad131a10682f46c4ac6b9270af732e098", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/a0da417ad131a10682f46c4ac6b9270af732e098", "committedDate": "2020-12-03T23:09:49Z", "message": "Merge remote-tracking branch 'upstream/master' into fvh"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "e3686d0f6b5deb5772d619d8d73321d7271b70a3", "author": {"user": {"login": "jtibshirani", "name": "Julie Tibshirani"}}, "url": "https://github.com/elastic/elasticsearch/commit/e3686d0f6b5deb5772d619d8d73321d7271b70a3", "committedDate": "2020-12-03T23:31:57Z", "message": "Skip mixed cluster test cases for now."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0ODA0MDM1", "url": "https://github.com/elastic/elasticsearch/pull/65641#pullrequestreview-544804035", "createdAt": "2020-12-04T09:47:49Z", "commit": {"oid": "e3686d0f6b5deb5772d619d8d73321d7271b70a3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4201, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}