{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzcxMTY0MDY3", "number": 51905, "title": "Use local checkpoint to calculate min translog gen for recovery", "bodyText": "Today we use the translog_generation of the safe commit as the minimum required translog generation for recovery. This approach has a limitation, where we won't be able to clean up translog unless we flush. Reopening an already recovered engine will create a new empty translog, and we leave it there until we force flush.\nThis commit removes the translog_generation commit tag and uses the local checkpoint of the safe commit to calculate the minimum required translog generation for recovery instead.\nCloses #49970", "createdAt": "2020-02-05T03:23:18Z", "url": "https://github.com/elastic/elasticsearch/pull/51905", "merged": true, "mergeCommit": {"oid": "ebc468147321cfdd56a9d011e0b40126677b9e78"}, "closed": true, "closedAt": "2020-02-10T13:26:02Z", "author": {"login": "dnhatn"}, "timelineItems": {"totalCount": 15, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcBNSJyAH2gAyMzcxMTY0MDY3OmZlNjczMzc5MWIzN2M1YWY0Y2E2ZGVkODNlMmViZDBhZTU1NzZjMTk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcC6eGTAFqTM1NTgyMzY4Mw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "fe6733791b37c5af4ca6ded83e2ebd0ae5576c19", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/fe6733791b37c5af4ca6ded83e2ebd0ae5576c19", "committedDate": "2020-02-05T03:08:36Z", "message": "Use local checkpoint to calculate min translog gen for recovery"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "403a8bd93d44ae2c9ca88b723aaa875b475a137c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/403a8bd93d44ae2c9ca88b723aaa875b475a137c", "committedDate": "2020-02-05T14:44:17Z", "message": "Merge branch 'master' into seqno-tlog-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1eb0d5399e72449ff10af0417221394048b838cc", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/1eb0d5399e72449ff10af0417221394048b838cc", "committedDate": "2020-02-05T15:22:34Z", "message": "force flush in translog yaml test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU0NjAxMjQ0", "url": "https://github.com/elastic/elasticsearch/pull/51905#pullrequestreview-354601244", "createdAt": "2020-02-06T16:41:14Z", "commit": {"oid": "1eb0d5399e72449ff10af0417221394048b838cc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNjo0MToxNFrOFmiIgg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNlQxNjo0NDo0OVrOFmiRgQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk0OTQ0Mg==", "bodyText": "assert localCheckpointOfSafeCommit <= localCheckpointOfLastCommit", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r375949442", "createdAt": "2020-02-06T16:41:14Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/engine/CombinedDeletionPolicy.java", "diffHunk": "@@ -121,16 +121,12 @@ private void updateRetentionPolicy() throws IOException {\n         assert Thread.holdsLock(this);\n         logger.debug(\"Safe commit [{}], last commit [{}]\", commitDescription(safeCommit), commitDescription(lastCommit));\n         assert safeCommit.isDeleted() == false : \"The safe commit must not be deleted\";\n-        final long minRequiredGen = Long.parseLong(safeCommit.getUserData().get(Translog.TRANSLOG_GENERATION_KEY));\n         assert lastCommit.isDeleted() == false : \"The last commit must not be deleted\";\n-        final long lastGen = Long.parseLong(lastCommit.getUserData().get(Translog.TRANSLOG_GENERATION_KEY));\n-\n-        assert minRequiredGen <= lastGen : \"minRequiredGen must not be greater than lastGen\";\n-        translogDeletionPolicy.setTranslogGenerationOfLastCommit(lastGen);\n-        translogDeletionPolicy.setMinTranslogGenerationForRecovery(minRequiredGen);\n-\n-        softDeletesPolicy.setLocalCheckpointOfSafeCommit(\n-            Long.parseLong(safeCommit.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY)));\n+        final long localCheckpointOfSafeCommit = Long.parseLong(safeCommit.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));\n+        final long localCheckpointOfLastCommit = Long.parseLong(lastCommit.getUserData().get(SequenceNumbers.LOCAL_CHECKPOINT_KEY));\n+        softDeletesPolicy.setLocalCheckpointOfSafeCommit(localCheckpointOfSafeCommit);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1eb0d5399e72449ff10af0417221394048b838cc"}, "originalPosition": 16}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTk1MTc0NQ==", "bodyText": "this log might still be useful?", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r375951745", "createdAt": "2020-02-06T16:44:49Z", "author": {"login": "ywelsch"}, "path": "server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java", "diffHunk": "@@ -458,23 +458,22 @@ public void skipTranslogRecovery() {\n     }\n \n     private void recoverFromTranslogInternal(TranslogRecoveryRunner translogRecoveryRunner, long recoverUpToSeqNo) throws IOException {\n-        Translog.TranslogGeneration translogGeneration = translog.getGeneration();\n         final int opsRecovered;\n-        final long translogFileGen = Long.parseLong(lastCommittedSegmentInfos.getUserData().get(Translog.TRANSLOG_GENERATION_KEY));\n-        try (Translog.Snapshot snapshot = translog.newSnapshotFromGen(\n-            new Translog.TranslogGeneration(translog.getTranslogUUID(), translogFileGen), recoverUpToSeqNo)) {\n-            opsRecovered = translogRecoveryRunner.run(this, snapshot);\n-        } catch (Exception e) {\n-            throw new EngineException(shardId, \"failed to recover from translog\", e);\n+        final long localCheckpoint = getProcessedLocalCheckpoint();\n+        if (localCheckpoint < recoverUpToSeqNo) {\n+            try (Translog.Snapshot snapshot = translog.newSnapshot(localCheckpoint + 1, recoverUpToSeqNo)) {\n+                opsRecovered = translogRecoveryRunner.run(this, snapshot);\n+            } catch (Exception e) {\n+                throw new EngineException(shardId, \"failed to recover from translog\", e);\n+            }\n+        } else {\n+            opsRecovered = 0;\n         }\n         // flush if we recovered something or if we have references to older translogs\n         // note: if opsRecovered == 0 and we have older translogs it means they are corrupted or 0 length.\n         assert pendingTranslogRecovery.get() : \"translogRecovery is not pending but should be\";\n         pendingTranslogRecovery.set(false); // we are good - now we can commit\n         if (opsRecovered > 0) {\n-            logger.trace(\"flushing post recovery from translog. ops recovered [{}]. committed translog id [{}]. current id [{}]\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1eb0d5399e72449ff10af0417221394048b838cc"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6572ed443f37edbfd4e57c8425ace530c4ec4b5e", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/6572ed443f37edbfd4e57c8425ace530c4ec4b5e", "committedDate": "2020-02-07T13:38:39Z", "message": "Merge branch 'master' into seqno-tlog-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4bcceafc01ddbb745063fe0cfbea246079c5e64", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4bcceafc01ddbb745063fe0cfbea246079c5e64", "committedDate": "2020-02-07T14:19:44Z", "message": "Use local checkpoint of safe commit to calculate committed stats"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2c0b2573dc8ee7aa21c418b0319dad3e276f1c8a", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/2c0b2573dc8ee7aa21c418b0319dad3e276f1c8a", "committedDate": "2020-02-07T14:23:04Z", "message": "restore log"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5ea2cae112c15f1efd2ff13ddd22e2469e9762a3", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/5ea2cae112c15f1efd2ff13ddd22e2469e9762a3", "committedDate": "2020-02-07T16:07:06Z", "message": "fix test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzUzNTQwMTgy", "url": "https://github.com/elastic/elasticsearch/pull/51905#pullrequestreview-353540182", "createdAt": "2020-02-05T08:38:44Z", "commit": {"oid": "fe6733791b37c5af4ca6ded83e2ebd0ae5576c19"}, "state": "APPROVED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wNVQwODozODo0NFrOFlve4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMi0wN1QxNjoxOTozNVrOFnCfmg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NTExOTU4Ng==", "bodyText": "Not sure about why number of uncommitted ops are relevant to trimming?", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r375119586", "createdAt": "2020-02-05T08:38:44Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/index/engine/NoOpEngine.java", "diffHunk": "@@ -137,31 +138,26 @@ public void trimUnreferencedTranslogFiles() {\n         try (ReleasableLock lock = readLock.acquire()) {\n             ensureOpen();\n             final List<IndexCommit> commits = DirectoryReader.listCommits(store.directory());\n-            if (commits.size() == 1) {\n+            if (commits.size() == 1 &&\n+                translogStats.getUncommittedOperations() == 0 &&", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "fe6733791b37c5af4ca6ded83e2ebd0ae5576c19"}, "originalPosition": 14}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ3MDMzOA==", "bodyText": "I wonder why this change is necessary? I find it a bit counter intuitive to update that before sync'ing translog, but I am sure there is a good reason.", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r376470338", "createdAt": "2020-02-07T16:01:57Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/index/engine/InternalEngineTests.java", "diffHunk": "@@ -5664,8 +5647,8 @@ public void testRecoverFromLocalTranslog() throws Exception {\n                 for (Engine.Operation op : operations) {\n                     applyOperation(engine, op);\n                     if (randomBoolean()) {\n+                        globalCheckpoint.set(randomLongBetween(globalCheckpoint.get(), engine.getProcessedLocalCheckpoint()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c0b2573dc8ee7aa21c418b0319dad3e276f1c8a"}, "originalPosition": 161}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ3NDExMg==", "bodyText": "I am guessing that the change in the next line is due to only keeping one generation now? In that case, this comment needs updating I think.", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r376474112", "createdAt": "2020-02-07T16:09:09Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/index/shard/IndexShardIT.java", "diffHunk": "@@ -416,7 +416,7 @@ public void testStressMaybeFlushOrRollTranslogGeneration() throws Exception {\n         final Settings settings;\n         if (flush) {\n             // size of the operation plus two generations of overhead.", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c0b2573dc8ee7aa21c418b0319dad3e276f1c8a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM3NjQ3OTY0Mg==", "bodyText": "Should we check prior to this that we have some operations to trim, except in the case where the last thing done was a flush?", "url": "https://github.com/elastic/elasticsearch/pull/51905#discussion_r376479642", "createdAt": "2020-02-07T16:19:35Z", "author": {"login": "henningandersen"}, "path": "server/src/test/java/org/elasticsearch/index/engine/NoOpEngineTests.java", "diffHunk": "@@ -168,49 +166,28 @@ public void testTrimUnreferencedTranslogFiles() throws Exception {\n         tracker.updateFromMaster(1L, Collections.singleton(allocationId.getId()), table);\n         tracker.activatePrimaryMode(SequenceNumbers.NO_OPS_PERFORMED);\n \n-        boolean softDeleteEnabled = engine.config().getIndexSettings().isSoftDeleteEnabled();\n         final int numDocs = scaledRandomIntBetween(10, 3000);\n         for (int i = 0; i < numDocs; i++) {\n             engine.index(indexForDoc(createParsedDoc(Integer.toString(i), null)));\n             tracker.updateLocalCheckpoint(allocationId.getId(), i);\n             if (rarely()) {\n                 engine.flush();\n             }\n+            if (randomBoolean()) {\n+                engine.rollTranslogGeneration();\n+            }\n         }\n+        // prevent translog from trimming so we can test trimUnreferencedFiles in NoOpEngine.\n+        final Translog.Snapshot snapshot = engine.getTranslog().newSnapshot();\n         engine.flush(true, true);\n-\n-        final String translogUuid = engine.getTranslog().getTranslogUUID();\n-        final long minFileGeneration = engine.getTranslog().getMinFileGeneration();\n-        final long currentFileGeneration = engine.getTranslog().currentFileGeneration();\n         engine.close();\n \n         final NoOpEngine noOpEngine = new NoOpEngine(noOpConfig(INDEX_SETTINGS, store, primaryTranslogDir, tracker));\n-        final Path translogPath = noOpEngine.config().getTranslogConfig().getTranslogPath();\n-\n-        final long lastCommitedTranslogGeneration;\n-        try (Engine.IndexCommitRef indexCommitRef = noOpEngine.acquireLastIndexCommit(false)) {\n-            Map<String, String> lastCommittedUserData = indexCommitRef.getIndexCommit().getUserData();\n-            lastCommitedTranslogGeneration = Long.parseLong(lastCommittedUserData.get(Translog.TRANSLOG_GENERATION_KEY));\n-            assertThat(lastCommitedTranslogGeneration, equalTo(currentFileGeneration));\n-        }\n-\n-        assertThat(Translog.readMinTranslogGeneration(translogPath, translogUuid), equalTo(minFileGeneration));\n-        assertThat(noOpEngine.getTranslogStats().estimatedNumberOfOperations(), equalTo(softDeleteEnabled ? 0 : numDocs));\n-        assertThat(noOpEngine.getTranslogStats().getUncommittedOperations(), equalTo(0));\n-\n         noOpEngine.trimUnreferencedTranslogFiles();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "2c0b2573dc8ee7aa21c418b0319dad3e276f1c8a"}, "originalPosition": 63}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6baaf900c63314c6fa05bec4e8997bda62436c88", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/6baaf900c63314c6fa05bec4e8997bda62436c88", "committedDate": "2020-02-07T20:04:56Z", "message": "Merge branch 'master' into seqno-tlog-policy"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "63c25e2adc5802bd1bc128e3204b844e6a83a7bf", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/63c25e2adc5802bd1bc128e3204b844e6a83a7bf", "committedDate": "2020-02-07T20:06:26Z", "message": "remove uncommitted translog"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "630da78ad629bf1a9fb7af78c9dcee77cb7c2b66", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/630da78ad629bf1a9fb7af78c9dcee77cb7c2b66", "committedDate": "2020-02-07T20:51:22Z", "message": "revert checkpoint sync"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "02103b77d611ab3fc10d0d90299f28c7508b9cd8", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/02103b77d611ab3fc10d0d90299f28c7508b9cd8", "committedDate": "2020-02-07T21:01:02Z", "message": "assert translog ops before trimming"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8c91dcfe43d55bef8c109885527cc7a3584f74a4", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/8c91dcfe43d55bef8c109885527cc7a3584f74a4", "committedDate": "2020-02-07T21:21:35Z", "message": "comment"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzU1ODIzNjgz", "url": "https://github.com/elastic/elasticsearch/pull/51905#pullrequestreview-355823683", "createdAt": "2020-02-10T10:21:18Z", "commit": {"oid": "8c91dcfe43d55bef8c109885527cc7a3584f74a4"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2808, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}