{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDU3OTY3ODU0", "number": 60328, "title": "Allows nanosecond resolution in search_after", "bodyText": "This fixes search_after to properly parse string formatted dates that\nhave nanosecond resolution.\nCloses #52424", "createdAt": "2020-07-28T18:07:53Z", "url": "https://github.com/elastic/elasticsearch/pull/60328", "merged": true, "mergeCommit": {"oid": "944a6c243c2cc2e370cb6a552e18ff3c73d142fb"}, "closed": true, "closedAt": "2020-07-29T18:29:11Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABc5ZntfAH2gAyNDU3OTY3ODU0OjY5MDI1ZDc1MDAzZWRiMmIzYWU3N2MxZDkyODAwNWJmZjU2YjVjMTM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABc5dhksgH2gAyNDU3OTY3ODU0OmIyOTg4MzY2ZTc5ZTdlMTg1OTgxYjIzN2IzMDg1NWQ2Zjk4NTkxNzA=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/69025d75003edb2b3ae77c1d928005bff56b5c13", "committedDate": "2020-07-28T17:10:46Z", "message": "Allows nanosecond resolution in search_after\n\nThis fixes `search_after` to properly parse string formatted dates that\nhave nanosecond resolution.\n\nCloses #52424"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDU2OTA5OTAy", "url": "https://github.com/elastic/elasticsearch/pull/60328#pullrequestreview-456909902", "createdAt": "2020-07-28T18:44:15Z", "commit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NDoxNlrOG4Zu8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0yOFQxODo0NTowOFrOG4Zw5g==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTA1Ng==", "bodyText": "I wonder if we should use the formatted version in the sort output ? We don't allow this format (nanoseconds since epoch) when ingesting or querying a date_nanos field so that's an exception here.", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795056", "createdAt": "2020-07-28T18:44:16Z", "author": {"login": "jimczi"}, "path": "rest-api-spec/src/main/resources/rest-api-spec/test/search/90_search_after.yml", "diffHunk": "@@ -94,3 +91,126 @@ setup:\n \n   - match: {hits.total: 3}\n   - length: {hits.hits: 0 }\n+\n+---\n+\"date\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date\n+                format: yyyy-MM-dd HH:mm:ss.SSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571646604828] }\n+\n+  # search_after with the sort\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [1571646604828]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+  # search_after with the formatted date\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+          search_after: [\"2019-10-21 08:30:04.828\"]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 00:30:04.828\" }\n+  - match: {hits.hits.0.sort: [1571617804828] }\n+\n+---\n+\"date_nanos\":\n+  - do:\n+      indices.create:\n+        index: test\n+        body:\n+          mappings:\n+            properties:\n+              timestamp:\n+                type: date_nanos\n+                format: yyyy-MM-dd HH:mm:ss.SSSSSS\n+  - do:\n+      bulk:\n+        refresh: true\n+        index: test\n+        body: |\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 00:30:04.828740\"}\n+          {\"index\":{}}\n+          {\"timestamp\":\"2019-10-21 08:30:04.828733\"}\n+\n+  - do:\n+      search:\n+        index: test\n+        body:\n+          size: 1\n+          sort: [{ timestamp: desc }]\n+  - match: {hits.total.value: 2 }\n+  - length: {hits.hits: 1 }\n+  - match: {hits.hits.0._index: test }\n+  - match: {hits.hits.0._source.timestamp: \"2019-10-21 08:30:04.828733\" }\n+  - match: {hits.hits.0.sort: [1571646604828733000] }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 113}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ2MTc5NTU1OA==", "bodyText": "nit: because lots of ...", "url": "https://github.com/elastic/elasticsearch/pull/60328#discussion_r461795558", "createdAt": "2020-07-28T18:45:08Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DateFieldMapper.java", "diffHunk": "@@ -440,6 +440,7 @@ public DocValueFormat docValueFormat(@Nullable String format, ZoneId timeZone) {\n             }\n             // the resolution here is always set to milliseconds, as aggregations use this formatter mainly and those are always in\n             // milliseconds. The only special case here is docvalue fields, which are handled somewhere else\n+            // TODO maybe aggs should force millis because lot so of other places want nanos?", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "69025d75003edb2b3ae77c1d928005bff56b5c13"}, "originalPosition": 4}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a8fcba8a187c6ea27b24d852467b990101208a32", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/a8fcba8a187c6ea27b24d852467b990101208a32", "committedDate": "2020-07-28T20:14:40Z", "message": "Merge branch 'master' into allow_nano_resolution_in_search_after"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "81beee7b367e4e9e85313f25cde9d5982a4e98c8", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/81beee7b367e4e9e85313f25cde9d5982a4e98c8", "committedDate": "2020-07-28T20:15:21Z", "message": "Iter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2988366e79e7e185981b237b30855d6f9859170", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2988366e79e7e185981b237b30855d6f9859170", "committedDate": "2020-07-28T21:43:41Z", "message": "Skip"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3723, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}