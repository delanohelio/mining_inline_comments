{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDk2MzYwMDEy", "number": 63134, "title": "[ML] optimize delete expired snapshots", "bodyText": "When deleting expired snapshots, we do an individual delete action per snapshot per job.\nWe should instead gather the expired snapshots and delete them in a single call.\nThis commit achieves this and a side-effect is there is less audit log spam on nightly cleanup\ncloses #62875", "createdAt": "2020-10-01T15:42:52Z", "url": "https://github.com/elastic/elasticsearch/pull/63134", "merged": true, "mergeCommit": {"oid": "4cfb22e6d5a2fabbd4712cbd3719c14327042077"}, "closed": true, "closedAt": "2020-10-02T15:23:22Z", "author": {"login": "benwtrent"}, "timelineItems": {"totalCount": 14, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdOTTsegH2gAyNDk2MzYwMDEyOjVjYzdjNDU0NzM1MTBiNTcxNDAyMzIyOTM5NzdiYTg2Mjg1NjdiZDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdOmmY_AFqTUwMTE2OTg4OA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5cc7c45473510b57140232293977ba8628567bd1", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/5cc7c45473510b57140232293977ba8628567bd1", "committedDate": "2020-10-01T15:41:53Z", "message": "[ML] optimize delete expired snapshots\n\nWhen deleting expired snapshots, we do an individual delete action per snapshot per job.\n\nWe should instead gather the expired snapshots and delete them in a single call.\n\nThis commit achieves this and a side-effect is there is less audit log spam on nightly cleanup\n\ncloses https://github.com/elastic/elasticsearch/issues/62875"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNTA4NTY4", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-500508568", "createdAt": "2020-10-01T16:12:24Z", "commit": {"oid": "5cc7c45473510b57140232293977ba8628567bd1"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoxMjoyNFrOHbRqdQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxNjoyMDoyNlrOHbR9xg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2Mjk5Nw==", "bodyText": "Maybe we could just say {0} expired model snapshots deleted (where {0} is how many).  We could be deleting 24 per day if they've been changed to be every hour, and that would make the message very verbose.  The fact that these are the ones that have expired should be OK for the audit log.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498362997", "createdAt": "2020-10-01T16:12:24Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java", "diffHunk": "@@ -144,6 +144,7 @@\n     public static final String JOB_AUDIT_SNAPSHOT_STORED = \"Job model snapshot with id [{0}] stored\";\n     public static final String JOB_AUDIT_REVERTED = \"Job model snapshot reverted to ''{0}''\";\n     public static final String JOB_AUDIT_SNAPSHOT_DELETED = \"Model snapshot [{0}] with description ''{1}'' deleted\";\n+    public static final String JOB_AUDIT_SNAPSHOTS_DELETED = \"Model snapshots {0} with descriptions {1} deleted\";", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cc7c45473510b57140232293977ba8628567bd1"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODM2Nzk0Mg==", "bodyText": "Even though the audit message can be made less verbose, the debug should continue to list every ID and description, just in case something ever goes wrong with which snapshots are getting deleted.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498367942", "createdAt": "2020-10-01T16:20:26Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemover.java", "diffHunk": "@@ -208,65 +219,53 @@ public void onResponse(SearchResponse searchResponse) {\n                             } while (timestampMs >= nextToKeepMs);\n                             continue;\n                         }\n-                        JobSnapshotId idPair = new JobSnapshotId(\n-                            stringFieldValueOrNull(hit, Job.ID.getPreferredName()),\n-                            stringFieldValueOrNull(hit, ModelSnapshotField.SNAPSHOT_ID.getPreferredName()));\n+                        String jobId = stringFieldValueOrNull(hit, Job.ID.getPreferredName());\n+                        String snapshotId = stringFieldValueOrNull(hit, ModelSnapshotField.SNAPSHOT_ID.getPreferredName());\n \n-                        if (idPair.hasNullValue() == false) {\n-                            snapshotIds.add(idPair);\n+                        if (jobId != null && snapshotId != null) {\n+                            jobResultsProvider.getModelSnapshot(\n+                                jobId,\n+                                snapshotId,\n+                                // We are safe to grab this snapshot as the query is by DOC ID and we already filtered out the\n+                                // currently active snapshot earlier in the call chain\n+                                (shots) -> snapshots.add(shots.result),\n+                                (failure) ->\n+                                    LOGGER.warn(new ParameterizedMessage(\"[{}] failed to find snapshot [{}]\", jobId, snapshotId), failure)\n+                                );\n                         }\n                     }\n-                    deleteModelSnapshots(new VolatileCursorIterator<>(snapshotIds), listener);\n+                    deleteModelSnapshots(snapshots, jobId, listener);\n                 } catch (Exception e) {\n                     onFailure(e);\n                 }\n             }\n \n             @Override\n             public void onFailure(Exception e) {\n-                listener.onFailure(new ElasticsearchException(\"[\" + jobId +  \"] Search for expired snapshots failed\", e));\n+                listener.onFailure(new ElasticsearchException(\"[{}] Search for expired snapshots failed\", e, jobId));\n             }\n         };\n     }\n \n-    private void deleteModelSnapshots(Iterator<JobSnapshotId> modelSnapshotIterator, ActionListener<Boolean> listener) {\n-        if (modelSnapshotIterator.hasNext() == false) {\n+    private void deleteModelSnapshots(List<ModelSnapshot> modelSnapshots, String jobId, ActionListener<Boolean> listener) {\n+        if (modelSnapshots.isEmpty()) {\n             listener.onResponse(true);\n             return;\n         }\n-        JobSnapshotId idPair = modelSnapshotIterator.next();\n-        DeleteModelSnapshotAction.Request deleteSnapshotRequest =\n-            new DeleteModelSnapshotAction.Request(idPair.jobId, idPair.snapshotId);\n-        deleteSnapshotRequest.setParentTask(getParentTaskId());\n-        client.execute(DeleteModelSnapshotAction.INSTANCE, deleteSnapshotRequest, new ActionListener<>() {\n-                @Override\n-                public void onResponse(AcknowledgedResponse response) {\n-                    try {\n-                        deleteModelSnapshots(modelSnapshotIterator, listener);\n-                    } catch (Exception e) {\n-                        onFailure(e);\n-                    }\n-                }\n+        JobDataDeleter deleter = new JobDataDeleter(client, jobId);\n+        deleter.deleteModelSnapshots(modelSnapshots, ActionListener.wrap(\n+            bulkResponse -> {\n+                String msg = Messages.getMessage(\n+                    Messages.JOB_AUDIT_SNAPSHOTS_DELETED,\n+                    modelSnapshots.stream().map(ModelSnapshot::getSnapshotId),\n+                    modelSnapshots.stream().map(ModelSnapshot::getDescription));\n \n-                @Override\n-                public void onFailure(Exception e) {\n-                    listener.onFailure(new ElasticsearchException(\"[\" + idPair.jobId +  \"] Failed to delete snapshot [\"\n-                            + idPair.snapshotId + \"]\", e));\n-                }\n-            });\n+                auditor.info(jobId, msg);\n+                LOGGER.debug(() -> new ParameterizedMessage(\"[{}] {}\", jobId, msg));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5cc7c45473510b57140232293977ba8628567bd1"}, "originalPosition": 156}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "371c61b1821acb06e02fd0d748167b8a38e5f140", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/371c61b1821acb06e02fd0d748167b8a38e5f140", "committedDate": "2020-10-01T16:41:02Z", "message": "addressing pr comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/474670fc65225d9fb2efd4648d763f9b3749030c", "committedDate": "2020-10-01T18:13:28Z", "message": "addressing asynchronicity and reducing number of queries"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjAyNTk5", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-500602599", "createdAt": "2020-10-01T18:14:58Z", "commit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNDo1OFrOHbVz7A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNDo1OFrOHbVz7A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMDk1Ng==", "bodyText": "I am not sure how this test ever passed?\nI think it is meant to test the mixed retention between two jobs, but it appears to give the same job two of the snapshots?\nI adjusted it it for the new format so that this other old snapshot is part of job-2", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498430956", "createdAt": "2020-10-01T18:14:58Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -97,35 +112,44 @@ public void testRemove_GivenJobsWithMixedRetentionPolicies() {\n         Date oneDayAgo = new Date(now.getTime() - TimeValue.timeValueDays(1).getMillis());\n         SearchHit snapshot1_1 = createModelSnapshotQueryHit(\"job-1\", \"fresh-snapshot\", oneDayAgo);\n         searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot1_1)));\n+        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-2\", \"fresh-snapshot\", oneDayAgo);\n+        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n \n         // It needs to be strictly more than 7 days before the most recent snapshot, hence the extra millisecond\n         Date eightDaysAndOneMsAgo = new Date(now.getTime() - TimeValue.timeValueDays(8).getMillis() - 1);\n-        SearchHit snapshotToBeDeleted = createModelSnapshotQueryHit(\"job-1\", \"old-snapshot\", eightDaysAndOneMsAgo);\n-\n-\n-        searchResponses.add(\n-            AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshotToBeDeleted)));\n-\n-        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-1\", \"snapshots-1_1\", eightDaysAndOneMsAgo);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjAzMjI0", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-500603224", "createdAt": "2020-10-01T18:15:51Z", "commit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNTo1MVrOHbV15Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNTo1MVrOHbV15Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMTQ2MQ==", "bodyText": "I was running into async callback hell. But, if we just use the underlying modelSnapshots request from here and then filter out the assigned snapshot later, we reduce the number of calls and it flows more cleanly.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498431461", "createdAt": "2020-10-01T18:15:51Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemover.java", "diffHunk": "@@ -157,116 +163,84 @@ protected void removeDataBefore(\n             listener.onResponse(true);\n             return;\n         }\n-        LOGGER.debug(\"Considering model snapshots of job [{}] that have a timestamp before [{}] for removal\", job.getId(), cutoffEpochMs);\n-\n-        SearchRequest searchRequest = new SearchRequest();\n-        searchRequest.indices(AnomalyDetectorsIndex.jobResultsAliasedName(job.getId()));\n-\n-        QueryBuilder activeSnapshotFilter = QueryBuilders.termQuery(\n-            ModelSnapshotField.SNAPSHOT_ID.getPreferredName(), job.getModelSnapshotId());\n-        QueryBuilder retainFilter = QueryBuilders.termQuery(ModelSnapshot.RETAIN.getPreferredName(), true);\n-        QueryBuilder query = createQuery(job.getId(), cutoffEpochMs)\n-            .filter(QueryBuilders.existsQuery(ModelSnapshot.SNAPSHOT_DOC_COUNT.getPreferredName()))\n-            .mustNot(activeSnapshotFilter)\n-            .mustNot(retainFilter);\n-\n-        SearchSourceBuilder source = new SearchSourceBuilder();\n-        source.query(query);\n-        source.size(MODEL_SNAPSHOT_SEARCH_SIZE);\n-        source.sort(ModelSnapshot.TIMESTAMP.getPreferredName());\n-        source.fetchSource(false);\n-        source.docValueField(Job.ID.getPreferredName(), null);\n-        source.docValueField(ModelSnapshotField.SNAPSHOT_ID.getPreferredName(), null);\n-        source.docValueField(ModelSnapshot.TIMESTAMP.getPreferredName(), \"epoch_millis\");\n-        searchRequest.source(source);\n-        searchRequest.setParentTask(getParentTaskId());\n+        LOGGER.debug(() -> new ParameterizedMessage(\n+            \"Considering model snapshots of job [{}] that have a timestamp before [{}] for removal\",\n+            job.getId(),\n+            cutoffEpochMs));\n \n         long deleteAllBeforeMs = (job.getModelSnapshotRetentionDays() == null)\n             ? 0 : latestTimeMs - TimeValue.timeValueDays(job.getModelSnapshotRetentionDays()).getMillis();\n-        client.execute(SearchAction.INSTANCE, searchRequest, new ThreadedActionListener<>(LOGGER, threadPool,\n-            MachineLearning.UTILITY_THREAD_POOL_NAME, expiredSnapshotsListener(job.getId(), deleteAllBeforeMs, listener), false));\n+        ActionListener<QueryPage<ModelSnapshot>> snapshotsListener = expiredSnapshotsListener(job, deleteAllBeforeMs, listener);\n+        jobResultsProvider.modelSnapshots(job.getId(),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "originalPosition": 98}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwNjAzNDE3", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-500603417", "createdAt": "2020-10-01T18:16:07Z", "commit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNjowOFrOHbV2hA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMVQxODoxNjowOFrOHbV2hA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMTYyMA==", "bodyText": "Since we have to worry about the currently used model snapshot.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498431620", "createdAt": "2020-10-01T18:16:08Z", "author": {"login": "benwtrent"}, "path": "x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemover.java", "diffHunk": "@@ -157,116 +163,84 @@ protected void removeDataBefore(\n             listener.onResponse(true);\n             return;\n         }\n-        LOGGER.debug(\"Considering model snapshots of job [{}] that have a timestamp before [{}] for removal\", job.getId(), cutoffEpochMs);\n-\n-        SearchRequest searchRequest = new SearchRequest();\n-        searchRequest.indices(AnomalyDetectorsIndex.jobResultsAliasedName(job.getId()));\n-\n-        QueryBuilder activeSnapshotFilter = QueryBuilders.termQuery(\n-            ModelSnapshotField.SNAPSHOT_ID.getPreferredName(), job.getModelSnapshotId());\n-        QueryBuilder retainFilter = QueryBuilders.termQuery(ModelSnapshot.RETAIN.getPreferredName(), true);\n-        QueryBuilder query = createQuery(job.getId(), cutoffEpochMs)\n-            .filter(QueryBuilders.existsQuery(ModelSnapshot.SNAPSHOT_DOC_COUNT.getPreferredName()))\n-            .mustNot(activeSnapshotFilter)\n-            .mustNot(retainFilter);\n-\n-        SearchSourceBuilder source = new SearchSourceBuilder();\n-        source.query(query);\n-        source.size(MODEL_SNAPSHOT_SEARCH_SIZE);\n-        source.sort(ModelSnapshot.TIMESTAMP.getPreferredName());\n-        source.fetchSource(false);\n-        source.docValueField(Job.ID.getPreferredName(), null);\n-        source.docValueField(ModelSnapshotField.SNAPSHOT_ID.getPreferredName(), null);\n-        source.docValueField(ModelSnapshot.TIMESTAMP.getPreferredName(), \"epoch_millis\");\n-        searchRequest.source(source);\n-        searchRequest.setParentTask(getParentTaskId());\n+        LOGGER.debug(() -> new ParameterizedMessage(\n+            \"Considering model snapshots of job [{}] that have a timestamp before [{}] for removal\",\n+            job.getId(),\n+            cutoffEpochMs));\n \n         long deleteAllBeforeMs = (job.getModelSnapshotRetentionDays() == null)\n             ? 0 : latestTimeMs - TimeValue.timeValueDays(job.getModelSnapshotRetentionDays()).getMillis();\n-        client.execute(SearchAction.INSTANCE, searchRequest, new ThreadedActionListener<>(LOGGER, threadPool,\n-            MachineLearning.UTILITY_THREAD_POOL_NAME, expiredSnapshotsListener(job.getId(), deleteAllBeforeMs, listener), false));\n+        ActionListener<QueryPage<ModelSnapshot>> snapshotsListener = expiredSnapshotsListener(job, deleteAllBeforeMs, listener);\n+        jobResultsProvider.modelSnapshots(job.getId(),\n+            0,\n+            MODEL_SNAPSHOT_SEARCH_SIZE,\n+            null,\n+            String.valueOf(cutoffEpochMs),\n+            ModelSnapshot.TIMESTAMP.getPreferredName(),\n+            true,\n+            null,\n+            snapshotsListener::onResponse,\n+            snapshotsListener::onFailure);\n     }\n \n-    private ActionListener<SearchResponse> expiredSnapshotsListener(String jobId, long deleteAllBeforeMs,\n-                                                                    ActionListener<Boolean> listener) {\n+    private ActionListener<QueryPage<ModelSnapshot>> expiredSnapshotsListener(Job job,\n+                                                                              long deleteAllBeforeMs,\n+                                                                              ActionListener<Boolean> listener) {\n         return new ActionListener<>() {\n             @Override\n-            public void onResponse(SearchResponse searchResponse) {\n+            public void onResponse(QueryPage<ModelSnapshot> searchResponse) {\n                 long nextToKeepMs = deleteAllBeforeMs;\n                 try {\n-                    List<JobSnapshotId> snapshotIds = new ArrayList<>();\n-                    for (SearchHit hit : searchResponse.getHits()) {\n-                        String timestamp = stringFieldValueOrNull(hit, ModelSnapshot.TIMESTAMP.getPreferredName());\n-                        if (timestamp == null) {\n-                            LOGGER.warn(\"Model snapshot document [{}] has a null timestamp field\", hit.getId());\n+                    List<ModelSnapshot> snapshots = new ArrayList<>();\n+                    for (ModelSnapshot snapshot: searchResponse.results()) {\n+                        if (snapshot.getSnapshotId().equals(job.getModelSnapshotId())) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "originalPosition": 128}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAwOTI0NTU2", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-500924556", "createdAt": "2020-10-02T07:50:11Z", "commit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "49e5ea913b96a603b584809f7f9ef4a61933bd47", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/49e5ea913b96a603b584809f7f9ef4a61933bd47", "committedDate": "2020-10-02T11:41:03Z", "message": "respect retain"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5f7028394ab807f5fe2764f2cd7944e5b85bd02e", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/5f7028394ab807f5fe2764f2cd7944e5b85bd02e", "committedDate": "2020-10-02T12:00:41Z", "message": "fixing sort order"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMDg1Njk2", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-501085696", "createdAt": "2020-10-02T12:20:17Z", "commit": {"oid": "5f7028394ab807f5fe2764f2cd7944e5b85bd02e"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjoyMDoxN1rOHbrf4g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0wMlQxMjozNDo0NFrOHbr5rQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc4NjI3NA==", "bodyText": "It's one of those tests where due to the complexity of the mocking it's very unclear what production code is being tested, and what's really being tested is the test itself.\nThe idea before was that job two had a 17 day retention period, so the search we were doing directly against the results index (without calling the model snapshots endpoint) would return nothing.  This was represented by searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.emptyList())); in the old code.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498786274", "createdAt": "2020-10-02T12:20:17Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -97,35 +112,44 @@ public void testRemove_GivenJobsWithMixedRetentionPolicies() {\n         Date oneDayAgo = new Date(now.getTime() - TimeValue.timeValueDays(1).getMillis());\n         SearchHit snapshot1_1 = createModelSnapshotQueryHit(\"job-1\", \"fresh-snapshot\", oneDayAgo);\n         searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot1_1)));\n+        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-2\", \"fresh-snapshot\", oneDayAgo);\n+        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n \n         // It needs to be strictly more than 7 days before the most recent snapshot, hence the extra millisecond\n         Date eightDaysAndOneMsAgo = new Date(now.getTime() - TimeValue.timeValueDays(8).getMillis() - 1);\n-        SearchHit snapshotToBeDeleted = createModelSnapshotQueryHit(\"job-1\", \"old-snapshot\", eightDaysAndOneMsAgo);\n-\n-\n-        searchResponses.add(\n-            AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshotToBeDeleted)));\n-\n-        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-1\", \"snapshots-1_1\", eightDaysAndOneMsAgo);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODQzMDk1Ng=="}, "originalCommit": {"oid": "474670fc65225d9fb2efd4648d763f9b3749030c"}, "originalPosition": 98}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc5MjY0Mg==", "bodyText": "The model snapshots function shouldn't be returning snapshots from one day ago because the retention period is 7 days and a cutoff was supplied in https://github.com/elastic/elasticsearch/pull/63134/files#diff-496e9b129f2db0ef429636501b6974baR178\nI think it's working because the thinning out functionality is ignoring the extra ones.  But I don't think the code path being tested here is the code path that would get executed in production with the configured settings.", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498792642", "createdAt": "2020-10-02T12:34:14Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -97,35 +112,44 @@ public void testRemove_GivenJobsWithMixedRetentionPolicies() {\n         Date oneDayAgo = new Date(now.getTime() - TimeValue.timeValueDays(1).getMillis());\n         SearchHit snapshot1_1 = createModelSnapshotQueryHit(\"job-1\", \"fresh-snapshot\", oneDayAgo);\n         searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot1_1)));\n+        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-2\", \"fresh-snapshot\", oneDayAgo);\n+        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n \n         // It needs to be strictly more than 7 days before the most recent snapshot, hence the extra millisecond\n         Date eightDaysAndOneMsAgo = new Date(now.getTime() - TimeValue.timeValueDays(8).getMillis() - 1);\n-        SearchHit snapshotToBeDeleted = createModelSnapshotQueryHit(\"job-1\", \"old-snapshot\", eightDaysAndOneMsAgo);\n-\n-\n-        searchResponses.add(\n-            AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshotToBeDeleted)));\n-\n-        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-1\", \"snapshots-1_1\", eightDaysAndOneMsAgo);\n-        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n-        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.emptyList()));\n-\n-        givenClientRequestsSucceed(searchResponses);\n+        Map<String, List<ModelSnapshot>> snapshotResponses = new HashMap<>();\n+        snapshotResponses.put(\"job-1\",\n+            Arrays.asList(\n+                createModelSnapshot(\"job-1\", \"active\", oneDayAgo),\n+                createModelSnapshot(\"job-1\", \"fresh-snapshot\", oneDayAgo),", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7028394ab807f5fe2764f2cd7944e5b85bd02e"}, "originalPosition": 107}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5ODc5Mjg3Nw==", "bodyText": "The model snapshots function shouldn't be returning snapshots from one or eight days ago because the retention period is 17 days and a cutoff was supplied in https://github.com/elastic/elasticsearch/pull/63134/files#diff-496e9b129f2db0ef429636501b6974baR178", "url": "https://github.com/elastic/elasticsearch/pull/63134#discussion_r498792877", "createdAt": "2020-10-02T12:34:44Z", "author": {"login": "droberts195"}, "path": "x-pack/plugin/ml/src/test/java/org/elasticsearch/xpack/ml/job/retention/ExpiredModelSnapshotsRemoverTests.java", "diffHunk": "@@ -97,35 +112,44 @@ public void testRemove_GivenJobsWithMixedRetentionPolicies() {\n         Date oneDayAgo = new Date(now.getTime() - TimeValue.timeValueDays(1).getMillis());\n         SearchHit snapshot1_1 = createModelSnapshotQueryHit(\"job-1\", \"fresh-snapshot\", oneDayAgo);\n         searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot1_1)));\n+        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-2\", \"fresh-snapshot\", oneDayAgo);\n+        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n \n         // It needs to be strictly more than 7 days before the most recent snapshot, hence the extra millisecond\n         Date eightDaysAndOneMsAgo = new Date(now.getTime() - TimeValue.timeValueDays(8).getMillis() - 1);\n-        SearchHit snapshotToBeDeleted = createModelSnapshotQueryHit(\"job-1\", \"old-snapshot\", eightDaysAndOneMsAgo);\n-\n-\n-        searchResponses.add(\n-            AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshotToBeDeleted)));\n-\n-        SearchHit snapshot2_1 = createModelSnapshotQueryHit(\"job-1\", \"snapshots-1_1\", eightDaysAndOneMsAgo);\n-        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.singletonList(snapshot2_1)));\n-        searchResponses.add(AbstractExpiredJobDataRemoverTests.createSearchResponseFromHits(Collections.emptyList()));\n-\n-        givenClientRequestsSucceed(searchResponses);\n+        Map<String, List<ModelSnapshot>> snapshotResponses = new HashMap<>();\n+        snapshotResponses.put(\"job-1\",\n+            Arrays.asList(\n+                createModelSnapshot(\"job-1\", \"active\", oneDayAgo),\n+                createModelSnapshot(\"job-1\", \"fresh-snapshot\", oneDayAgo),\n+                createModelSnapshot(\"job-1\", \"old-snapshot\", eightDaysAndOneMsAgo)\n+                ));\n+        snapshotResponses.put(\"job-2\",\n+            Arrays.asList(\n+                createModelSnapshot(\"job-2\", \"active\", oneDayAgo),\n+                createModelSnapshot(\"job-2\", \"snapshots-1_1\", eightDaysAndOneMsAgo),\n+                createModelSnapshot(\"job-2\", \"fresh-snapshot\", oneDayAgo)", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5f7028394ab807f5fe2764f2cd7944e5b85bd02e"}, "originalPosition": 114}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1bdb6b53d8731b3890add41e0efe8e2cacc24e74", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/1bdb6b53d8731b3890add41e0efe8e2cacc24e74", "committedDate": "2020-10-02T14:02:54Z", "message": "adjusting tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f903c6a46ba7f68e5d3902ab24eba885c50f59a6", "author": {"user": {"login": "benwtrent", "name": "Benjamin Trent"}}, "url": "https://github.com/elastic/elasticsearch/commit/f903c6a46ba7f68e5d3902ab24eba885c50f59a6", "committedDate": "2020-10-02T14:03:07Z", "message": "Merge remote-tracking branch 'upstream/master' into feature/ml-fix-delete-log-spam"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTAxMTY5ODg4", "url": "https://github.com/elastic/elasticsearch/pull/63134#pullrequestreview-501169888", "createdAt": "2020-10-02T14:10:30Z", "commit": {"oid": "f903c6a46ba7f68e5d3902ab24eba885c50f59a6"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4460, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}