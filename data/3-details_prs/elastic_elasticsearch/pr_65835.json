{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxOTM1MTU4", "number": 65835, "title": "Remove more usages of .watches system index.", "bodyText": "Make use of the new query watches api to simply list watches or\nto delete all watches using the delete watch api.\nRelates to #62501", "createdAt": "2020-12-03T17:03:19Z", "url": "https://github.com/elastic/elasticsearch/pull/65835", "merged": true, "mergeCommit": {"oid": "4e7adad4234279a203438803420bf0c4b1889105"}, "closed": true, "closedAt": "2020-12-04T09:36:46Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdilX_SgH2gAyNTMxOTM1MTU4OmU4NjE2YTExYWYwNmMzZjMxMzBmOTU5ODI4ODY5NGVjNjZlODBjY2Y=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdiz558AH2gAyNTMxOTM1MTU4OmM5ZDgyODBmYTMyMWMwNjU2OWQzODdmM2E4ZTI3N2YyNzVmMDJlYjc=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/e8616a11af06c3f3130f9598288694ec66e80ccf", "committedDate": "2020-12-03T16:03:21Z", "message": "Remove more usages of .watches system index.\n\nMake use of the new query watches api to simply list watches or\nto delete all watches using the delete watch api.\n\nRelates to #62501"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQ0NDk4NDk3", "url": "https://github.com/elastic/elasticsearch/pull/65835#pullrequestreview-544498497", "createdAt": "2020-12-03T22:16:23Z", "commit": {"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNjoyM1rOH-3iaA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QyMjoxNjoyM1rOH-3iaA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTY4MzY4OA==", "bodyText": "nit: I assume this would be a programmers error, if so can this just be a Java assert instead of an assertThat to help differentiate between something that is being tested and a self documenting sanity check. Also, why Less ? should be it be not equal ?", "url": "https://github.com/elastic/elasticsearch/pull/65835#discussion_r535683688", "createdAt": "2020-12-03T22:16:23Z", "author": {"login": "jakelandis"}, "path": "x-pack/plugin/watcher/qa/common/src/main/java/org/elasticsearch/xpack/watcher/WatcherRestTestCase.java", "diffHunk": "@@ -70,18 +75,23 @@ public final void stopWatcher() throws Exception {\n                     throw new AssertionError(\"unknown state[\" + state + \"]\");\n             }\n         }, 60, TimeUnit.SECONDS);\n+        deleteAllWatcherData();\n+    }\n+\n+    public static void deleteAllWatcherData() throws IOException {\n+        var queryWatchesRequest = new Request(\"GET\", \"/_watcher/_query/watches\");\n+        var response = ObjectPath.createFromResponse(ESRestTestCase.adminClient().performRequest(queryWatchesRequest));\n \n-        Request deleteWatchesIndexRequest = new Request(\"DELETE\", \".watches\");\n-        deleteWatchesIndexRequest.addParameter(\"ignore_unavailable\", \"true\");\n-        deleteWatchesIndexRequest.setOptions(\n-            expectWarnings(\n-                \"this request accesses system indices: [.watches], but in a future major \"\n-                    + \"version, direct access to system indices will be prevented by default\"\n-            )\n-        );\n-        ESRestTestCase.adminClient().performRequest(deleteWatchesIndexRequest);\n+        int totalCount = response.evaluate(\"count\");\n+        List<Map<?, ?>> watches = response.evaluate(\"watches\");\n+        assertThat(\"Less watches requested than exist in total\", watches.size(), equalTo(totalCount));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "e8616a11af06c3f3130f9598288694ec66e80ccf"}, "originalPosition": 36}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a010cd8af6e4d0523d247ac6928ae0370633a5d9", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a010cd8af6e4d0523d247ac6928ae0370633a5d9", "committedDate": "2020-12-04T08:54:10Z", "message": "Merge remote-tracking branch 'es/master' into remove_more_usages_of_.watches_system_index"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b57906e84c631e2b143e5e9b60aac598333463aa", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/b57906e84c631e2b143e5e9b60aac598333463aa", "committedDate": "2020-12-04T08:54:46Z", "message": "adjust assertion"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c9d8280fa321c06569d387f3a8e277f275f02eb7", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/c9d8280fa321c06569d387f3a8e277f275f02eb7", "committedDate": "2020-12-04T08:59:04Z", "message": "removed unused import"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4164, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}