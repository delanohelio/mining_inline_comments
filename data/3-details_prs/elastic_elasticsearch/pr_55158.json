{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDAzMjE1MDcy", "number": 55158, "title": "Don't expand default_field in query_string before required", "bodyText": "Currently QueryStringQueryParser already checks if the field limit is breached\nat construction time, which e.g. leads to errors if the default field is set to\n\"*\" or the default isn't used and there are more fields than the limit, even if the\nquery itself does not use all these fields.\nThis change moves this check to happen after query parsing. QueryStringQueryParser now\nkeeps track of the fields that are actually resolved while parsing. The size of\nthat set is later used to check against the limit set by the\nindices.query.bool.max_clause_count setting.\nCloses #53789", "createdAt": "2020-04-14T14:21:03Z", "url": "https://github.com/elastic/elasticsearch/pull/55158", "merged": true, "mergeCommit": {"oid": "7b44743ccc2402d79e347882dc74623e04883488"}, "closed": true, "closedAt": "2020-04-23T08:26:25Z", "author": {"login": "cbuescher"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcXj9lWgH2gAyNDAzMjE1MDcyOjc3MTA3NDRkMGQzN2YyMDhkZDAyNDRiYTdhZGRmMTIwYjE4YzhjYmM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcaLMmhAFqTM5ODM4NTMyNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "7710744d0d37f208dd0244ba7addf120b18c8cbc", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/7710744d0d37f208dd0244ba7addf120b18c8cbc", "committedDate": "2020-04-14T14:00:17Z", "message": "Don't expand default_field in query_string before required\n\nCurrently QueryStringQueryParser already checks if the field limit is breached\nat construction time, which e.g. leads to errors if the default field is set to\n\"*\" or the default is used and there are more fields than the limit, even if the\nquery itself does not use all these fields.\nThis change moves this check to happen after query parsing. QueryStringQueryParser now\nkeeps track of the fields that are actually resolved while parsing. The size of\nthat set is later used to check against the limit set by the\n`indices.query.bool.max_clause_count` setting.\n\nCloses #53789"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1MzExMDg2", "url": "https://github.com/elastic/elasticsearch/pull/55158#pullrequestreview-395311086", "createdAt": "2020-04-17T09:42:21Z", "commit": {"oid": "7710744d0d37f208dd0244ba7addf120b18c8cbc"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo0MjoyMVrOGHHRxw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QwOTo0NDo0OFrOGHHWqA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMjQ1NQ==", "bodyText": "I don't think this is needed. We can check the limit in QueryStringQueryParser#extractMultiFields, which is called every time we parse a block.", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410112455", "createdAt": "2020-04-17T09:42:21Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -97,6 +100,9 @@\n     private MultiTermQuery.RewriteMethod fuzzyRewriteMethod;\n     private boolean fuzzyTranspositions = FuzzyQuery.defaultTranspositions;\n \n+    // set of field names this parser targets, used to check limits on expanded field names\n+    private Set<String> queriedFields = new HashSet<>();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7710744d0d37f208dd0244ba7addf120b18c8cbc"}, "originalPosition": 21}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDExMzcwNA==", "bodyText": "This is not enough, we should check every field expansion not just the last one (when extractMultiFields is called).", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410113704", "createdAt": "2020-04-17T09:44:48Z", "author": {"login": "jimczi"}, "path": "server/src/main/java/org/elasticsearch/index/search/QueryStringQueryParser.java", "diffHunk": "@@ -789,6 +798,8 @@ public Query parse(String query) throws ParseException {\n         if (query.trim().isEmpty()) {\n             return Queries.newMatchNoDocsQuery(\"Matching no documents because no terms present\");\n         }\n-        return super.parse(query);\n+        Query result = super.parse(query);\n+        checkForTooManyFields(this.queriedFields.size(), this.context);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7710744d0d37f208dd0244ba7addf120b18c8cbc"}, "originalPosition": 77}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "2086f49b8c6feef30abcb7586cee24a9efeb26c6", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/2086f49b8c6feef30abcb7586cee24a9efeb26c6", "committedDate": "2020-04-17T09:57:59Z", "message": "Merge branch 'master' into fix-53789"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "8606ae4cd0102e5b73d8f2da336162c1541acbb4", "author": {"user": {"login": "cbuescher", "name": "Christoph B\u00fcscher"}}, "url": "https://github.com/elastic/elasticsearch/commit/8606ae4cd0102e5b73d8f2da336162c1541acbb4", "committedDate": "2020-04-17T16:23:03Z", "message": "Check field expansion once per block"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk1NjA5MDI0", "url": "https://github.com/elastic/elasticsearch/pull/55158#pullrequestreview-395609024", "createdAt": "2020-04-17T16:40:27Z", "commit": {"oid": "8606ae4cd0102e5b73d8f2da336162c1541acbb4"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjo0MDoyN1rOGHVP9Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0xN1QxNjo0MDoyN1rOGHVP9Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMDM0MTM2NQ==", "bodyText": "Just out of curiosity: this test shows what to me is a bit counter-intuitive. When we check breaching the limit once per expansion but not in its sum we can easily hit more than indices.query.bool.max_clause_count with a query.", "url": "https://github.com/elastic/elasticsearch/pull/55158#discussion_r410341365", "createdAt": "2020-04-17T16:40:27Z", "author": {"login": "cbuescher"}, "path": "server/src/test/java/org/elasticsearch/search/query/QueryStringIT.java", "diffHunk": "@@ -324,6 +292,74 @@ public void testLimitOnExpandedFieldsButIgnoreUnmappedFields() throws Exception\n         client().prepareSearch(\"ignoreunmappedfields\").setQuery(qb).get();\n     }\n \n+    public void testLimitOnExpandedFields() throws Exception {\n+        XContentBuilder builder = jsonBuilder();\n+        builder.startObject();\n+        {\n+            builder.startObject(\"_doc\");\n+            {\n+                builder.startObject(\"properties\");\n+                {\n+                    for (int i = 0; i < CLUSTER_MAX_CLAUSE_COUNT; i++) {\n+                        builder.startObject(\"field_A\" + i).field(\"type\", \"text\").endObject();\n+                        builder.startObject(\"field_B\" + i).field(\"type\", \"text\").endObject();\n+                    }\n+                    builder.endObject();\n+                }\n+                builder.endObject();\n+            }\n+            builder.endObject();\n+        }\n+\n+        assertAcked(prepareCreate(\"testindex\")\n+                .setSettings(Settings.builder().put(MapperService.INDEX_MAPPING_TOTAL_FIELDS_LIMIT_SETTING.getKey(),\n+                        CLUSTER_MAX_CLAUSE_COUNT + 100))\n+                .setMapping(builder));\n+\n+        client().prepareIndex(\"testindex\").setId(\"1\").setSource(\"field_A0\", \"foo bar baz\").get();\n+        refresh();\n+\n+        // single field shouldn't trigger the limit\n+        doAssertOneHitForQueryString(\"field_A0:foo\");\n+        // expanding to the limit should work\n+        doAssertOneHitForQueryString(\"field_A\\\\*:foo\");\n+        // expanding two blocks to the limit still works\n+        doAssertOneHitForQueryString(\"field_A\\\\*:foo field_B\\\\*:bar\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8606ae4cd0102e5b73d8f2da336162c1541acbb4"}, "originalPosition": 75}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c3f310fe1bee4187a7b06195d01fb5179382d193", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c3f310fe1bee4187a7b06195d01fb5179382d193", "committedDate": "2020-04-17T17:00:51Z", "message": "Merge branch 'master' into fix-53789"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3Mzk4Mzg1MzI1", "url": "https://github.com/elastic/elasticsearch/pull/55158#pullrequestreview-398385325", "createdAt": "2020-04-22T16:50:50Z", "commit": {"oid": "c3f310fe1bee4187a7b06195d01fb5179382d193"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3542, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}