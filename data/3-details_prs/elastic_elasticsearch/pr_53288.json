{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzg1NjQwMjc5", "number": 53288, "title": "Preserve metric types in top_metrics", "bodyText": "This changes the top_metrics aggregation to return metrics in their\noriginal type. Since it only supports numerics, that means that dates,\nlongs, and doubles will come back as stored, with their appropriate\nformatter applied.", "createdAt": "2020-03-09T15:02:13Z", "url": "https://github.com/elastic/elasticsearch/pull/53288", "merged": true, "mergeCommit": {"oid": "8410356c5bf8dec3a9ca3dbcc6a7bbdcad895429"}, "closed": true, "closedAt": "2020-03-11T20:44:09Z", "author": {"login": "nik9000"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcL-tRqgH2gAyMzg1NjQwMjc5OjJiNTZhMDMxNGI4MGFiZGJkN2YyYTU5YTlhYjRiN2Y1NDkxZWQ4Yzk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcMqu6xAH2gAyMzg1NjQwMjc5Ojc0M2E1NTcyOTY3NGJhOTJhODE5Njg3MDBhOGIxYTUwY2E2YjkzOTY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "2b56a0314b80abdbd7f2a59a9ab4b7f5491ed8c9", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/2b56a0314b80abdbd7f2a59a9ab4b7f5491ed8c9", "committedDate": "2020-03-09T14:22:49Z", "message": "Preserve metric types in top_metrics\n\nThis changes the `top_metrics` aggregation to return metrics in their\noriginal type. Since it only supports numerics, that means that dates,\nlongs, and doubles will come back as stored, with their appropriate\nformatter applied."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "5d7d18ff5e1ddbe8ccbdf317e65d69a90cbaff4b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d7d18ff5e1ddbe8ccbdf317e65d69a90cbaff4b", "committedDate": "2020-03-09T15:00:15Z", "message": "Fixup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "371671e676549bf14c08f1cb9288cbac1244ba1d", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/371671e676549bf14c08f1cb9288cbac1244ba1d", "committedDate": "2020-03-09T15:10:45Z", "message": "Doc"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxMjYxMDI1", "url": "https://github.com/elastic/elasticsearch/pull/53288#pullrequestreview-371261025", "createdAt": "2020-03-09T15:02:58Z", "commit": {"oid": "5d7d18ff5e1ddbe8ccbdf317e65d69a90cbaff4b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNTowMjo1OFrOFzsZig==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0wOVQxNTowMjo1OFrOFzsZig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM4OTc0OTEzMA==", "bodyText": "Again, we haven't released this so this break is ok.", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r389749130", "createdAt": "2020-03-09T15:02:58Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/InternalTopMetrics.java", "diffHunk": "@@ -217,14 +218,14 @@ TopMetric topMetric() {\n         TopMetric(StreamInput in) throws IOException {\n             sortFormat = in.readNamedWriteable(DocValueFormat.class);\n             sortValue = in.readNamedWriteable(SortValue.class);\n-            metricValues = in.readDoubleArray();\n+            metricValues = in.readList(s -> s.readOptionalWriteable(MetricValue::new));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d7d18ff5e1ddbe8ccbdf317e65d69a90cbaff4b"}, "originalPosition": 59}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "18dae354904bb17a2cabb7651341e3337b4f2708", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/18dae354904bb17a2cabb7651341e3337b4f2708", "committedDate": "2020-03-09T17:26:18Z", "message": "Merge branch 'master' into top_metrics_preserve_type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a323f8799a8839d4582b8725f4c02e0bff3a87b", "committedDate": "2020-03-09T17:27:51Z", "message": "Checkstyle"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTQ3OTc5", "url": "https://github.com/elastic/elasticsearch/pull/53288#pullrequestreview-371947979", "createdAt": "2020-03-10T13:27:26Z", "commit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzoyNzoyNlrOF0OrRw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxMzoyNzoyNlrOF0OrRw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxMDcyNw==", "bodyText": "I'm aware it is odd to have a \"SortValue\" be part of a MetricValue. It is a very convenient way to send a type-aware thing across the wire though.", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r390310727", "createdAt": "2020-03-10T13:27:26Z", "author": {"login": "nik9000"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/InternalTopMetrics.java", "diffHunk": "@@ -269,17 +274,74 @@ public boolean equals(Object obj) {\n             TopMetric other = (TopMetric) obj;\n             return sortFormat.equals(other.sortFormat)\n                     && sortValue.equals(other.sortValue)\n-                    && Arrays.equals(metricValues, other.metricValues);\n+                    && metricValues.equals(other.metricValues);\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hash(sortFormat, sortValue, Arrays.hashCode(metricValues));\n+            return Objects.hash(sortFormat, sortValue, metricValues);\n         }\n \n         @Override\n         public String toString() {\n-            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + Arrays.toString(metricValues) + \"]\"; \n+            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + metricValues + \"]\"; \n+        }\n+    }\n+\n+    static class MetricValue implements Writeable, ToXContent {\n+        private final DocValueFormat format; \n+        private final SortValue value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "originalPosition": 120}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcxOTc4NDcy", "url": "https://github.com/elastic/elasticsearch/pull/53288#pullrequestreview-371978472", "createdAt": "2020-03-10T14:02:07Z", "commit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDowMjowN1rOF0QICQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNDoyODo1OVrOF0RXIw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzNDQ3Mw==", "bodyText": "I think this would be better as an inline comment than a PR comment.", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r390334473", "createdAt": "2020-03-10T14:02:07Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/InternalTopMetrics.java", "diffHunk": "@@ -269,17 +274,74 @@ public boolean equals(Object obj) {\n             TopMetric other = (TopMetric) obj;\n             return sortFormat.equals(other.sortFormat)\n                     && sortValue.equals(other.sortValue)\n-                    && Arrays.equals(metricValues, other.metricValues);\n+                    && metricValues.equals(other.metricValues);\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hash(sortFormat, sortValue, Arrays.hashCode(metricValues));\n+            return Objects.hash(sortFormat, sortValue, metricValues);\n         }\n \n         @Override\n         public String toString() {\n-            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + Arrays.toString(metricValues) + \"]\"; \n+            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + metricValues + \"]\"; \n+        }\n+    }\n+\n+    static class MetricValue implements Writeable, ToXContent {\n+        private final DocValueFormat format; \n+        private final SortValue value;", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMxMDcyNw=="}, "originalCommit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "originalPosition": 120}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDMzODUyNw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                        return format + \",\" + value;\n          \n          \n            \n                        return \"MetricValue(\" + format + \",\" + value + \")\";\n          \n      \n    \n    \n  \n\nPet peeve of mine, unless we have a good reason not to, we should include the class name in the toString.  I've gotten burned by this a few times trying to write exception messages.", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r390338527", "createdAt": "2020-03-10T14:07:45Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/InternalTopMetrics.java", "diffHunk": "@@ -269,17 +274,74 @@ public boolean equals(Object obj) {\n             TopMetric other = (TopMetric) obj;\n             return sortFormat.equals(other.sortFormat)\n                     && sortValue.equals(other.sortValue)\n-                    && Arrays.equals(metricValues, other.metricValues);\n+                    && metricValues.equals(other.metricValues);\n         }\n \n         @Override\n         public int hashCode() {\n-            return Objects.hash(sortFormat, sortValue, Arrays.hashCode(metricValues));\n+            return Objects.hash(sortFormat, sortValue, metricValues);\n         }\n \n         @Override\n         public String toString() {\n-            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + Arrays.toString(metricValues) + \"]\"; \n+            return \"TopMetric[\" + sortFormat + \",\" + sortValue + \",\" + metricValues + \"]\"; \n+        }\n+    }\n+\n+    static class MetricValue implements Writeable, ToXContent {\n+        private final DocValueFormat format; \n+        private final SortValue value;\n+\n+        MetricValue(DocValueFormat format, SortValue value) {\n+            this.format = format;\n+            this.value = value;\n+        }\n+\n+        DocValueFormat getFormat() {\n+            return format;\n+        }\n+\n+        SortValue getValue() {\n+            return value;\n+        }\n+\n+        MetricValue(StreamInput in) throws IOException {\n+            format = in.readNamedWriteable(DocValueFormat.class);\n+            value = in.readNamedWriteable(SortValue.class);\n+        }\n+\n+        Number numberValue() {\n+            return value.numberValue();\n+        }\n+\n+        @Override\n+        public void writeTo(StreamOutput out) throws IOException {\n+            out.writeNamedWriteable(format);\n+            out.writeNamedWriteable(value);\n+        }\n+\n+        @Override\n+        public XContentBuilder toXContent(XContentBuilder builder, Params params) throws IOException {\n+            return value.toXContent(builder, format);\n+        }\n+\n+        @Override\n+        public String toString() {\n+            return format + \",\" + value;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "originalPosition": 157}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDM1NDcyMw==", "bodyText": "Suggested change\n        \n          \n    \n\n        \n      \n    \n    \n      \n          \n            \n                     * that we can steel from the longs to represent missing that\n          \n          \n            \n                     * that we can steal from the longs to represent missing that", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r390354723", "createdAt": "2020-03-10T14:28:59Z", "author": {"login": "not-napoleon"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/TopMetricsAggregator.java", "diffHunk": "@@ -249,12 +325,93 @@ public void close() {\n             values.close();\n         }\n     }\n-    private static class MissingMetricValues implements MetricValues {\n+\n+    /**\n+     * Loads metrics for whole numbers.\n+     */\n+    static class LongMetricValues extends CollectingMetricValues {\n+        /**\n+         * Tracks \"missing\" values in a {@link BitArray}. Unlike\n+         * {@link DoubleMetricValues}, we there isn't a sentinel value\n+         * that we can steel from the longs to represent missing that", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "7a323f8799a8839d4582b8725f4c02e0bff3a87b"}, "originalPosition": 287}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzcyMTYxMTM0", "url": "https://github.com/elastic/elasticsearch/pull/53288#pullrequestreview-372161134", "createdAt": "2020-03-10T17:17:53Z", "commit": {"oid": "1448e7d0dd991d19862653b60b09ad6aa3f90d8b"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxNzo1NFrOF0Y_BA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0xMFQxNzoxNzo1NFrOF0Y_BA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5MDQ3OTYyMA==", "bodyText": "Should we put an info blurb somewhere in the docs that multi-valued fields will be averaged together?", "url": "https://github.com/elastic/elasticsearch/pull/53288#discussion_r390479620", "createdAt": "2020-03-10T17:17:54Z", "author": {"login": "polyfractal"}, "path": "x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/TopMetricsAggregator.java", "diffHunk": "@@ -234,12 +309,13 @@ public void swap(long lhs, long rhs) {\n         @Override\n         public Loader loader(LeafReaderContext ctx) throws IOException {\n             // TODO allow configuration of value mode", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "1448e7d0dd991d19862653b60b09ad6aa3f90d8b"}, "originalPosition": 261}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "42edcc6515811d835028502b5b21c36b9fb37df4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/42edcc6515811d835028502b5b21c36b9fb37df4", "committedDate": "2020-03-11T17:37:06Z", "message": "Merge branch 'master' into top_metrics_preserve_type"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "1448e7d0dd991d19862653b60b09ad6aa3f90d8b", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/1448e7d0dd991d19862653b60b09ad6aa3f90d8b", "committedDate": "2020-03-10T14:36:15Z", "message": "Update x-pack/plugin/analytics/src/main/java/org/elasticsearch/xpack/analytics/topmetrics/InternalTopMetrics.java\n\nCo-Authored-By: Mark Tozzi <mark.tozzi@gmail.com>"}, "afterCommit": {"oid": "42edcc6515811d835028502b5b21c36b9fb37df4", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/42edcc6515811d835028502b5b21c36b9fb37df4", "committedDate": "2020-03-11T17:37:06Z", "message": "Merge branch 'master' into top_metrics_preserve_type"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "743a55729674ba92a81968700a8b1a50ca6b9396", "author": {"user": {"login": "nik9000", "name": "Nik Everett"}}, "url": "https://github.com/elastic/elasticsearch/commit/743a55729674ba92a81968700a8b1a50ca6b9396", "committedDate": "2020-03-11T17:40:26Z", "message": "Javadoc"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1639, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}