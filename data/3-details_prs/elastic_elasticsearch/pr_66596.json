{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTQyNTUzOTI3", "number": 66596, "title": "EQL: Add key constraints to sequence mechanism", "bodyText": "If possible, improve search by looking for the already determined keys.\nChange field extraction to use exact fields to handle text fields.", "createdAt": "2020-12-18T13:48:22Z", "url": "https://github.com/elastic/elasticsearch/pull/66596", "merged": true, "mergeCommit": {"oid": "afc0c0a9f292e4408dd17be39c40cc7b9abd2352"}, "closed": true, "closedAt": "2020-12-21T16:16:58Z", "author": {"login": "costin"}, "timelineItems": {"totalCount": 7, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdnYZhmgH2gAyNTQyNTUzOTI3OjhmZjBiYjZlNmU4YmI2NzYzOWUyMjZhMWU0MGI1MWM3NTUwMDhhMDE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdoXsDAAH2gAyNTQyNTUzOTI3OmM3MzEzZWMxYjdlZmRlNjIxNzgyM2EzYzZlMzU4NTA4OGY0ZGQwZGU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "8ff0bb6e6e8bb67639e226a1e40b51c755008a01", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/8ff0bb6e6e8bb67639e226a1e40b51c755008a01", "committedDate": "2020-12-18T13:45:53Z", "message": "EQL: Add key constraints to sequence mechanism\n\nIf possible, improve search by looking for the already determined keys.\nChange field extraction to use exact fields"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NDk5MjU4", "url": "https://github.com/elastic/elasticsearch/pull/66596#pullrequestreview-555499258", "createdAt": "2020-12-18T13:50:41Z", "commit": {"oid": "8ff0bb6e6e8bb67639e226a1e40b51c755008a01"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMzo1MDo0MVrOIIjmKQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxMzo1MDo0MVrOIIjmKQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTg0MjcyOQ==", "bodyText": "This is a subtle one that otherwise a lot of things don't work. For example grouping a text field should only occur on a keyword.", "url": "https://github.com/elastic/elasticsearch/pull/66596#discussion_r545842729", "createdAt": "2020-12-18T13:50:41Z", "author": {"login": "costin"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/querydsl/container/FieldExtractorRegistry.java", "diffHunk": "@@ -24,14 +24,14 @@\n public class FieldExtractorRegistry {\n \n     private final Map<String, FieldExtraction> cache = new HashMap<>();\n-    \n+\n     public FieldExtraction fieldExtraction(Expression expression) {\n         return cache.computeIfAbsent(Expressions.id(expression), k -> createFieldExtractionFor(expression));\n     }\n \n     private FieldExtraction createFieldExtractionFor(Expression expression) {\n         if (expression instanceof FieldAttribute) {\n-            FieldAttribute fa = (FieldAttribute) expression;\n+            FieldAttribute fa = ((FieldAttribute) expression).exactAttribute();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff0bb6e6e8bb67639e226a1e40b51c755008a01"}, "originalPosition": 13}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU1NjM2ODk0", "url": "https://github.com/elastic/elasticsearch/pull/66596#pullrequestreview-555636894", "createdAt": "2020-12-18T16:31:20Z", "commit": {"oid": "8ff0bb6e6e8bb67639e226a1e40b51c755008a01"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjozMToyMFrOIIp-Pw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0xOFQxNjozMToyMFrOIIp-Pw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NTk0NzE5OQ==", "bodyText": "if (ql's CollectionUtils.isEmpty(values)) { and same below with keyFilters?", "url": "https://github.com/elastic/elasticsearch/pull/66596#discussion_r545947199", "createdAt": "2020-12-18T16:31:20Z", "author": {"login": "bpintea"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/BoxedQueryRequest.java", "diffHunk": "@@ -70,6 +90,78 @@ public BoxedQueryRequest to(Ordinal end) {\n         return this;\n     }\n \n+    /**\n+     * Sets keys / terms to filter on.\n+     * Accepts the unwrapped SequenceKey as a list of values matching an instance of a given\n+     * event.\n+     * Can be removed through null.\n+     */\n+    public BoxedQueryRequest keys(List<List<Object>> values) {\n+        List<QueryBuilder> newFilters;\n+\n+        if (values == null || values.isEmpty()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8ff0bb6e6e8bb67639e226a1e40b51c755008a01"}, "originalPosition": 65}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "dd152e909f62582191b3f704a1ca1fed74925657", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd152e909f62582191b3f704a1ca1fed74925657", "committedDate": "2020-12-21T12:51:54Z", "message": "Merge branch 'master' into eql/filter-terms"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTU2NDA4Mzc0", "url": "https://github.com/elastic/elasticsearch/pull/66596#pullrequestreview-556408374", "createdAt": "2020-12-21T14:14:27Z", "commit": {"oid": "dd152e909f62582191b3f704a1ca1fed74925657"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoxNDoyN1rOIJZpIg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0yMVQxNDoyMTo1NFrOIJZ4sA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjcyODIyNg==", "bodyText": "The key here is needed further down after the max_terms size check is performed on keyValues size. You could move the key initialization further down after you initialize the query QueryBuilder with null.", "url": "https://github.com/elastic/elasticsearch/pull/66596#discussion_r546728226", "createdAt": "2020-12-21T14:14:27Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/BoxedQueryRequest.java", "diffHunk": "@@ -70,6 +90,78 @@ public BoxedQueryRequest to(Ordinal end) {\n         return this;\n     }\n \n+    /**\n+     * Sets keys / terms to filter on.\n+     * Accepts the unwrapped SequenceKey as a list of values matching an instance of a given\n+     * event.\n+     * Can be removed through null.\n+     */\n+    public BoxedQueryRequest keys(List<List<Object>> values) {\n+        List<QueryBuilder> newFilters;\n+\n+        if (values == null || values.isEmpty()) {\n+            // no keys have been specified and none have been set\n+            if (keyFilters == null || keyFilters.isEmpty()) {\n+                return this;\n+            }\n+            newFilters = emptyList();\n+        }\n+        else {\n+            // iterate on all possible values for a given key\n+            newFilters = new ArrayList<>(values.size());\n+            for (int keyIndex = 0; keyIndex < keys.size(); keyIndex++) {\n+                String key = keys.get(keyIndex);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd152e909f62582191b3f704a1ca1fed74925657"}, "originalPosition": 76}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczMDg4Ng==", "bodyText": "else { should be on the same line as the closing curly bracket from the if statement, no?", "url": "https://github.com/elastic/elasticsearch/pull/66596#discussion_r546730886", "createdAt": "2020-12-21T14:19:12Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/ExecutionManager.java", "diffHunk": "@@ -65,13 +68,30 @@ public Executable assemble(List<List<Attribute>> listOfKeys,\n         for (int i = 0; i < plans.size(); i++) {\n             List<Attribute> keys = listOfKeys.get(i);\n             List<HitExtractor> keyExtractors = hitExtractors(keys, extractorRegistry);\n+            List<String> keyFields = new ArrayList<>(keyExtractors.size());\n+\n+            // extract top-level fields used as keys to optimize query lookups\n+            // this process gets skipped for nested fields\n+            for (HitExtractor extractor : keyExtractors) {\n+                if (extractor instanceof AbstractFieldHitExtractor) {\n+                    AbstractFieldHitExtractor hitExtractor = (AbstractFieldHitExtractor) extractor;\n+                    // no nested fields\n+                    if (hitExtractor.hitName() == null) {\n+                        keyFields.add(hitExtractor.fieldName());\n+                    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd152e909f62582191b3f704a1ca1fed74925657"}, "originalPosition": 31}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDU0NjczMjIwOA==", "bodyText": "Why is this skipped for nested fields? It's because of the complexity added by creating a nested query?", "url": "https://github.com/elastic/elasticsearch/pull/66596#discussion_r546732208", "createdAt": "2020-12-21T14:21:54Z", "author": {"login": "astefan"}, "path": "x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/assembler/ExecutionManager.java", "diffHunk": "@@ -65,13 +68,30 @@ public Executable assemble(List<List<Attribute>> listOfKeys,\n         for (int i = 0; i < plans.size(); i++) {\n             List<Attribute> keys = listOfKeys.get(i);\n             List<HitExtractor> keyExtractors = hitExtractors(keys, extractorRegistry);\n+            List<String> keyFields = new ArrayList<>(keyExtractors.size());\n+\n+            // extract top-level fields used as keys to optimize query lookups\n+            // this process gets skipped for nested fields", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "dd152e909f62582191b3f704a1ca1fed74925657"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "576e5b2c86b1c9b568a1e15e70e3ab127f102edc", "author": {"user": {"login": "costin", "name": "Costin Leau"}}, "url": "https://github.com/elastic/elasticsearch/commit/576e5b2c86b1c9b568a1e15e70e3ab127f102edc", "committedDate": "2020-12-21T15:04:30Z", "message": "Address feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c7313ec1b7efde6217823a3c6e3585088f4dd0de", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/c7313ec1b7efde6217823a3c6e3585088f4dd0de", "committedDate": "2020-12-21T15:30:08Z", "message": "Merge branch 'master' into eql/filter-terms"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4376, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}