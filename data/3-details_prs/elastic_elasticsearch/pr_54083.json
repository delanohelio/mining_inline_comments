{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0MzkyOTc4MTYw", "number": 54083, "title": "Validation for data stream creation", "bodyText": "Prevent name conflicts with existing indices or aliases.\nRelates to #53100", "createdAt": "2020-03-24T13:04:18Z", "url": "https://github.com/elastic/elasticsearch/pull/54083", "merged": true, "mergeCommit": {"oid": "db6aba43de2d825b7987151c2f1ad570113b591d"}, "closed": true, "closedAt": "2020-03-26T23:22:57Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcQyitRAH2gAyMzkyOTc4MTYwOjQzYzUyYTdhNjQyMjkxMTZhNzQ5NzlkZmZmZTM3ZWM0NzhhOWRiMjQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcRj09VgH2gAyMzkyOTc4MTYwOjI0ZDYwM2MwZTQ1NTlhZWU4YWQ2YmE1NTI3ZWM5OGNlN2ZlZDNjNjg=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "43c52a7a64229116a74979dfffe37ec478a9db24", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/43c52a7a64229116a74979dfffe37ec478a9db24", "committedDate": "2020-03-24T13:02:02Z", "message": "data stream names must not conflict with existing indices or aliases"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMjQzNTc0", "url": "https://github.com/elastic/elasticsearch/pull/54083#pullrequestreview-381243574", "createdAt": "2020-03-25T15:10:04Z", "commit": {"oid": "43c52a7a64229116a74979dfffe37ec478a9db24"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToxMDowNVrOF7fykg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNToxMDowNVrOF7fykg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5NzkzMTE1NA==", "bodyText": "I think MetaDataCreateIndexService.validateIndexName() or MetaDataCreateIndexService.validateIndexOrAliasName() could be reused?", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r397931154", "createdAt": "2020-03-25T15:10:05Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -161,15 +165,63 @@ public void clusterStateProcessed(String source, ClusterState oldState, ClusterS\n         }\n \n         static ClusterState createDataStream(ClusterState currentState, Request request) {\n+            List<String> validationErrors = new ArrayList<>();\n             if (currentState.metaData().dataStreams().containsKey(request.name)) {\n-                throw new IllegalArgumentException(\"data_stream [\" + request.name + \"] already exists\");\n+                validationErrors.add(\"data_stream [\" + request.name + \"] already exists\");\n             }\n \n-            MetaData.Builder builder = MetaData.builder(currentState.metaData()).put(\n-                new DataStream(request.name, request.timestampFieldName, Collections.emptyList()));\n+            validationErrors.addAll(validateDataStreamName(request.name));\n \n-            logger.info(\"adding data stream [{}]\", request.name);\n-            return ClusterState.builder(currentState).metaData(builder).build();\n+            if (currentState.metaData().hasIndex(request.name)) {\n+                validationErrors.add(\"data_stream [\" + request.name + \"] conflicts with existing index\");\n+            }\n+\n+            if (currentState.metaData().hasAlias(request.name)) {\n+                validationErrors.add(\"data_stream [\" + request.name + \"] conflicts with existing alias\");\n+            }\n+\n+            final String backingIndexPrefix = (request.name.startsWith(\".\") ? \"\" : \".\") + request.name + \"-\";\n+            for (String indexName : currentState.metaData().getConcreteAllIndices()) {\n+                if (indexName.startsWith(backingIndexPrefix)) {\n+                    validationErrors.add(\n+                        \"data_stream [\" + request.name + \"] could create backing indices that conflict with existing indices\");\n+                    break;\n+                }\n+            }\n+\n+            if (validationErrors.isEmpty()) {\n+                MetaData.Builder builder = MetaData.builder(currentState.metaData()).put(\n+                    new DataStream(request.name, request.timestampFieldName, Collections.emptyList()));\n+                logger.info(\"adding data stream [{}]\", request.name);\n+                return ClusterState.builder(currentState).metaData(builder).build();\n+            } else {\n+                ValidationException ex = new ValidationException();\n+                ex.addValidationErrors(validationErrors);\n+                throw new IllegalArgumentException(ex);\n+            }\n+        }\n+\n+        private static List<String> validateDataStreamName(String name) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "43c52a7a64229116a74979dfffe37ec478a9db24"}, "originalPosition": 64}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b2e4483604386c43d7b19a5b768d65917bec9d19", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/b2e4483604386c43d7b19a5b768d65917bec9d19", "committedDate": "2020-03-25T17:29:21Z", "message": "move validation to MetaData.Builder"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxMzc4MDU5", "url": "https://github.com/elastic/elasticsearch/pull/54083#pullrequestreview-381378059", "createdAt": "2020-03-25T17:31:02Z", "commit": {"oid": "b2e4483604386c43d7b19a5b768d65917bec9d19"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNzozMTowMlrOF7mbQg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQxNzozMTowMlrOF7mbQg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODAzOTg3NA==", "bodyText": "I'm not thrilled with this nested loop that will run in a cluster state update thread, but I think we need to validate against potential backing index conflicts.", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r398039874", "createdAt": "2020-03-25T17:31:02Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java", "diffHunk": "@@ -1315,20 +1315,36 @@ public MetaData build() {\n                 // iterate again and constructs a helpful message\n                 ArrayList<String> duplicates = new ArrayList<>();\n                 for (ObjectCursor<IndexMetaData> cursor : indices.values()) {\n-                    for (String alias: duplicateAliasesIndices) {\n+                    for (String alias : duplicateAliasesIndices) {\n                         if (cursor.value.getAliases().containsKey(alias)) {\n                             duplicates.add(alias + \" (alias of \" + cursor.value.getIndex() + \")\");\n                         }\n                     }\n                 }\n                 assert duplicates.size() > 0;\n                 throw new IllegalStateException(\"index and alias names need to be unique, but the following duplicates were found [\"\n-                    + Strings.collectionToCommaDelimitedString(duplicates)+ \"]\");\n+                    + Strings.collectionToCommaDelimitedString(duplicates) + \"]\");\n \n             }\n \n             SortedMap<String, AliasOrIndex> aliasAndIndexLookup = Collections.unmodifiableSortedMap(buildAliasAndIndexLookup());\n \n+            DataStreamMetadata dsMetadata = (DataStreamMetadata) customs.get(DataStreamMetadata.TYPE);\n+            if (dsMetadata != null) {\n+                for (DataStream ds : dsMetadata.dataStreams().values()) {\n+                    if (aliasAndIndexLookup.containsKey(ds.getName())) {\n+                        throw new IllegalStateException(\"data stream [\" + ds.getName() + \"] conflicts with existing index or alias\");\n+                    }\n+\n+                    final String backingIndexPrefix = (ds.getName().startsWith(\".\") ? \"\" : \".\") + ds.getName() + \"-\";\n+                    for (String indexName : allIndices) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b2e4483604386c43d7b19a5b768d65917bec9d19"}, "originalPosition": 37}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "920708a37d7b74f1479dccf3e6280cdf74712d0b", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/920708a37d7b74f1479dccf3e6280cdf74712d0b", "committedDate": "2020-03-25T17:48:18Z", "message": "Merge branch 'master' into data_streams_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b67088e0a4aafb983045c0a2f1e3048561e712a4", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/b67088e0a4aafb983045c0a2f1e3048561e712a4", "committedDate": "2020-03-25T21:03:10Z", "message": "review comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxNTQ0OTIz", "url": "https://github.com/elastic/elasticsearch/pull/54083#pullrequestreview-381544923", "createdAt": "2020-03-25T21:19:40Z", "commit": {"oid": "b67088e0a4aafb983045c0a2f1e3048561e712a4"}, "state": "APPROVED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMToxOTo0MFrOF7uxPg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNVQyMToxOTo0MFrOF7uxPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODE3NjU3NA==", "bodyText": "nit: a backing index could also conflict with an alias (or data stream in the future)", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r398176574", "createdAt": "2020-03-25T21:19:40Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java", "diffHunk": "@@ -1371,6 +1372,25 @@ public MetaData build() {\n             return aliasAndIndexLookup;\n         }\n \n+        private void validateDataStreams(SortedMap<String, AliasOrIndex> aliasAndIndexLookup) {\n+            DataStreamMetadata dsMetadata = (DataStreamMetadata) customs.get(DataStreamMetadata.TYPE);\n+            if (dsMetadata != null) {\n+                for (DataStream ds : dsMetadata.dataStreams().values()) {\n+                    if (aliasAndIndexLookup.containsKey(ds.getName())) {\n+                        throw new IllegalStateException(\"data stream [\" + ds.getName() + \"] conflicts with existing index or alias\");\n+                    }\n+\n+                    final String backingIndexPrefixFrom = (ds.getName().startsWith(\".\") ? \"\" : \".\") + ds.getName() + \"-\";\n+                    final String backingIndexPrefixTo = (ds.getName().startsWith(\".\") ? \"\" : \".\") + ds.getName() + \".\";\n+                    SortedMap<?, ?> map = aliasAndIndexLookup.subMap(backingIndexPrefixFrom, backingIndexPrefixTo);\n+                    if (map.size() != 0) {\n+                        throw new IllegalStateException(\n+                            \"data stream [\" + ds.getName() + \"] could create backing indices that conflict with existing indices\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "b67088e0a4aafb983045c0a2f1e3048561e712a4"}, "originalPosition": 50}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3b56ebf39343226d2083bd08afe357b8e300f6e4", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/3b56ebf39343226d2083bd08afe357b8e300f6e4", "committedDate": "2020-03-25T21:21:58Z", "message": "remove dot logic"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3MzgxOTEwOTc0", "url": "https://github.com/elastic/elasticsearch/pull/54083#pullrequestreview-381910974", "createdAt": "2020-03-26T11:17:04Z", "commit": {"oid": "3b56ebf39343226d2083bd08afe357b8e300f6e4"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMToxNzowNFrOF8CH1A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wMy0yNlQxMToyNjozNlrOF8Cc_A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ5MzY1Mg==", "bodyText": "Should we include the list of conflicting names in the message or at least the first few?", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r398493652", "createdAt": "2020-03-26T11:17:04Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/cluster/metadata/MetaData.java", "diffHunk": "@@ -1371,6 +1372,23 @@ public MetaData build() {\n             return aliasAndIndexLookup;\n         }\n \n+        private void validateDataStreams(SortedMap<String, AliasOrIndex> aliasAndIndexLookup) {\n+            DataStreamMetadata dsMetadata = (DataStreamMetadata) customs.get(DataStreamMetadata.TYPE);\n+            if (dsMetadata != null) {\n+                for (DataStream ds : dsMetadata.dataStreams().values()) {\n+                    if (aliasAndIndexLookup.containsKey(ds.getName())) {\n+                        throw new IllegalStateException(\"data stream [\" + ds.getName() + \"] conflicts with existing index or alias\");\n+                    }\n+\n+                    SortedMap<?, ?> map = aliasAndIndexLookup.subMap(ds.getName() + \"-\", ds.getName() + \".\"); // '.' is the char after '-'\n+                    if (map.size() != 0) {\n+                        throw new IllegalStateException(\"data stream [\" + ds.getName() +\n+                            \"] could create backing indices that conflict with existing indices or aliases\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b56ebf39343226d2083bd08afe357b8e300f6e4"}, "originalPosition": 48}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ5NDk0NQ==", "bodyText": "Should we rename the method to either \"validateIndexSpaceName\" or \"validateAbstractIndexName\"? Can be done in a follow-up when the naming discussion is clarified.", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r398494945", "createdAt": "2020-03-26T11:19:25Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -165,9 +166,11 @@ static ClusterState createDataStream(ClusterState currentState, Request request)\n                 throw new IllegalArgumentException(\"data_stream [\" + request.name + \"] already exists\");\n             }\n \n+            MetaDataCreateIndexService.validateIndexOrAliasName(request.name,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b56ebf39343226d2083bd08afe357b8e300f6e4"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDM5ODQ5OTA2OA==", "bodyText": "The other usages of validateIndexOrAliasName throw a dedicated exception. I am not entirely sure if IllegalArgumentException results in the same RestStatus and message handling. Could we add this to the rest test suite?", "url": "https://github.com/elastic/elasticsearch/pull/54083#discussion_r398499068", "createdAt": "2020-03-26T11:26:36Z", "author": {"login": "henningandersen"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/CreateDataStreamAction.java", "diffHunk": "@@ -165,9 +166,11 @@ static ClusterState createDataStream(ClusterState currentState, Request request)\n                 throw new IllegalArgumentException(\"data_stream [\" + request.name + \"] already exists\");\n             }\n \n+            MetaDataCreateIndexService.validateIndexOrAliasName(request.name,\n+                (s1, s2) -> new IllegalArgumentException(\"data_stream [\" + s1 + \"] \" + s2));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "3b56ebf39343226d2083bd08afe357b8e300f6e4"}, "originalPosition": 13}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4846c983feaa48cd6a41339030904437be39000d", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/4846c983feaa48cd6a41339030904437be39000d", "committedDate": "2020-03-26T20:31:33Z", "message": "review comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "31e9fd8684123f1d2b177bfc00d81d3f9aff4bb1", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/31e9fd8684123f1d2b177bfc00d81d3f9aff4bb1", "committedDate": "2020-03-26T21:11:58Z", "message": "Merge branch 'master' into data_streams_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "7a6953101fbee2ced4d813ad54ac30a08c2a1b2d", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/7a6953101fbee2ced4d813ad54ac30a08c2a1b2d", "committedDate": "2020-03-26T21:37:45Z", "message": "will add new test in separate PR"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "24d603c0e4559aee8ad6ba5527ec98ce7fed3c68", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/24d603c0e4559aee8ad6ba5527ec98ce7fed3c68", "committedDate": "2020-03-26T22:27:19Z", "message": "Merge branch 'master' into data_streams_validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 1688, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}