{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQ0OTU1MjY4", "number": 59095, "title": "Data stream admin actions are now index-level actions", "bodyText": "The administrative actions for data streams, create, delete, and get, are now index-level actions. In keeping with the decision that privileges should be granted on data streams and indices in the same namespace, the create, delete, and get (aka view metadata) actions have been added to the existing create_index, delete_index, and view_index_metadata privileges, respectively.\nBecause the requests for all index-level actions must implement IndicesRequest, that change was included in this PR. It was minor except for the fact that the get data stream request must accept multiple parameters in order to conform to the IndicesRequest interface.\nRelates to #53100", "createdAt": "2020-07-06T19:16:20Z", "url": "https://github.com/elastic/elasticsearch/pull/59095", "merged": true, "mergeCommit": {"oid": "198b4253d97ed565b3644867f929d769d4510c5f"}, "closed": true, "closedAt": "2020-07-10T17:25:08Z", "author": {"login": "danhermann"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcyaILzAFqTQ0MzQ3NDI4OA==", "endCursor": "Y3Vyc29yOnYyOpPPAAABczmZdKgBqjM1MzQ2Mjk2ODQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNDc0Mjg4", "url": "https://github.com/elastic/elasticsearch/pull/59095#pullrequestreview-443474288", "createdAt": "2020-07-06T23:48:45Z", "commit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzo0ODo0NVrOGtqiKw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wNlQyMzo0ODo0NVrOGtqiKw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzNTk3OQ==", "bodyText": "This is a significant change to the behavior of the delete data stream request when a specified data stream is not present, but without this change, lots of tests running with security enabled fail because security resolves wildcard patterns to individual names including indices and those incorrectly trigger this ResourceNotFoundException error.", "url": "https://github.com/elastic/elasticsearch/pull/59095#discussion_r450535979", "createdAt": "2020-07-06T23:48:45Z", "author": {"login": "danhermann"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/DeleteDataStreamAction.java", "diffHunk": "@@ -176,16 +200,6 @@ static ClusterState removeDataStream(MetadataDeleteIndexService deleteIndexServi\n                 snapshottingDataStreams.addAll(SnapshotsService.snapshottingDataStreams(currentState, dataStreams));\n             }\n \n-            if (dataStreams.isEmpty()) {\n-                // if only a match-all pattern was specified and no data streams were found because none exist, do not\n-                // fail with data stream missing exception\n-                if (request.names.length == 1 && Regex.isMatchAllPattern(request.names[0])) {\n-                    return currentState;\n-                }\n-                throw new ResourceNotFoundException(\"data_streams matching [\" + Strings.arrayToCommaDelimitedString(request.names) +\n-                    \"] not found\");\n-            }\n-", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "originalPosition": 69}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQzNjc1MTM3", "url": "https://github.com/elastic/elasticsearch/pull/59095#pullrequestreview-443675137", "createdAt": "2020-07-07T08:31:24Z", "commit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODozMToyNFrOGt0W6Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wN1QwODo1NzoyOVrOGt1WBw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY5NjkzNw==", "bodyText": "I also don't see a way around this.", "url": "https://github.com/elastic/elasticsearch/pull/59095#discussion_r450696937", "createdAt": "2020-07-07T08:31:24Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/DeleteDataStreamAction.java", "diffHunk": "@@ -176,16 +200,6 @@ static ClusterState removeDataStream(MetadataDeleteIndexService deleteIndexServi\n                 snapshottingDataStreams.addAll(SnapshotsService.snapshottingDataStreams(currentState, dataStreams));\n             }\n \n-            if (dataStreams.isEmpty()) {\n-                // if only a match-all pattern was specified and no data streams were found because none exist, do not\n-                // fail with data stream missing exception\n-                if (request.names.length == 1 && Regex.isMatchAllPattern(request.names[0])) {\n-                    return currentState;\n-                }\n-                throw new ResourceNotFoundException(\"data_streams matching [\" + Strings.arrayToCommaDelimitedString(request.names) +\n-                    \"] not found\");\n-            }\n-", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDUzNTk3OQ=="}, "originalCommit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "originalPosition": 69}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDY5ODAxNA==", "bodyText": "at least this hack is removed :)", "url": "https://github.com/elastic/elasticsearch/pull/59095#discussion_r450698014", "createdAt": "2020-07-07T08:33:05Z", "author": {"login": "martijnvg"}, "path": "x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/privilege/ClusterPrivilegeResolver.java", "diffHunk": "@@ -201,8 +201,6 @@ public static NamedClusterPrivilege resolve(String name) {\n     public static boolean isClusterAction(String actionName) {\n         return actionName.startsWith(\"cluster:\") ||\n             actionName.startsWith(\"indices:admin/template/\") ||\n-            // todo: hack until we implement security of data_streams\n-            actionName.startsWith(\"indices:admin/data_stream/\") ||", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ1MDcxMzA5NQ==", "bodyText": "I think the wildcard logic is incorrect here with security enabled? This test fails: org.elasticsearch.xpack.security.CoreWithSecurityClientYamlTestSuiteIT > test {yaml=indices.data_stream/10_basic/Get data stream}\nIn this case there are no matching resources, so the expression gets rewritten to: *,-*. With this logic here,\nthis means that all data streams get included, because there is no logic that removes data streams if -* is used. We can add this logic (logic that deals with -[something] here, or we can use the index name expressions resolver and filter out anything that isn't a data stream?", "url": "https://github.com/elastic/elasticsearch/pull/59095#discussion_r450713095", "createdAt": "2020-07-07T08:57:29Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/datastream/GetDataStreamAction.java", "diffHunk": "@@ -169,22 +198,31 @@ protected void masterOperation(Task task, Request request, ClusterState state,\n             Map<String, DataStream> dataStreams = clusterState.metadata().dataStreams();\n \n             // return all data streams if no name was specified\n-            final String requestedName = request.name == null ? \"*\" : request.name;\n+            final String[] requestedNames = request.names == null || request.names.length == 0 ? new String[]{\"*\"} : request.names;\n \n-            final List<DataStream> results = new ArrayList<>();\n+            boolean hasWildcard = false;\n+            final Set<DataStream> results = new HashSet<>();\n+            for (String requestedName : requestedNames) {\n                 if (Regex.isSimpleMatchPattern(requestedName)) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "ac9109e256432c35899c37026dcb201aa839f821"}, "originalPosition": 114}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1MzQ4MzQz", "url": "https://github.com/elastic/elasticsearch/pull/59095#pullrequestreview-445348343", "createdAt": "2020-07-09T07:17:58Z", "commit": {"oid": "9ef80bd4ffe3b7b1c1bc135bcd4b488d7b8c2f62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1NjM1MjY2", "url": "https://github.com/elastic/elasticsearch/pull/59095#pullrequestreview-445635266", "createdAt": "2020-07-09T13:50:17Z", "commit": {"oid": "9ef80bd4ffe3b7b1c1bc135bcd4b488d7b8c2f62"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "507fa32458edd314e5c3f01329edf6a88f969e19", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/507fa32458edd314e5c3f01329edf6a88f969e19", "committedDate": "2020-07-10T16:29:24Z", "message": "Data stream admin actions are now index-level actions"}}, {"__typename": "HeadRefForcePushedEvent", "beforeCommit": {"oid": "d7e072ba4acc5ca12cabe412d6fa3ce5cdb66b31", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7e072ba4acc5ca12cabe412d6fa3ce5cdb66b31", "committedDate": "2020-07-09T21:41:16Z", "message": "Merge branch 'master' into data_stream_admin_actions"}, "afterCommit": {"oid": "507fa32458edd314e5c3f01329edf6a88f969e19", "author": {"user": {"login": "danhermann", "name": "Dan Hermann"}}, "url": "https://github.com/elastic/elasticsearch/commit/507fa32458edd314e5c3f01329edf6a88f969e19", "committedDate": "2020-07-10T16:29:24Z", "message": "Data stream admin actions are now index-level actions"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2324, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}