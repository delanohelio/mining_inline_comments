{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDMxMDM5ODAy", "number": 57802, "title": "Default to zero replicas for searchable snapshots", "bodyText": "Today a mounted searchable snapshot defaults to having the same replica\nconfiguration as the index that was snapshotted. This commit changes this\nbehaviour so that we default to zero replicas on these indices, but allow the\nuser to override this in the mount request.\nRelates #50999", "createdAt": "2020-06-08T10:36:55Z", "url": "https://github.com/elastic/elasticsearch/pull/57802", "merged": true, "mergeCommit": {"oid": "57dea5e23bc388590e05d9f265552fc599b2441a"}, "closed": true, "closedAt": "2020-06-16T08:46:58Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 6, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcpN_b_AH2gAyNDMxMDM5ODAyOjQwZDU3ZDBiYzFlNmZlMTY3MjhlZTA5YmNhODRjMGQ1MmI5YzgyMDk=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcrwkwagH2gAyNDMxMDM5ODAyOmZmN2IwNDlkZDYzNzdkOTkwMjgxNDE0YThhZGNlYTlhZDBkNTc5NTQ=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/40d57d0bc1e6fe16728ee09bca84c0d52b9c8209", "committedDate": "2020-06-08T10:35:02Z", "message": "Default to zero replicas for searchable snapshots\n\nToday a mounted searchable snapshot defaults to having the same replica\nconfiguration as the index that was snapshotted. This commit changes this\nbehaviour so that we default to zero replicas on these indices, but allow the\nuser to override this in the mount request.\n\nRelates #50999"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI2OTQwNDA5", "url": "https://github.com/elastic/elasticsearch/pull/57802#pullrequestreview-426940409", "createdAt": "2020-06-09T09:08:46Z", "commit": {"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOTowODo0NlrOGg__8A==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0wOVQwOToxMToyMVrOGhAGMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1NjE3Ng==", "bodyText": "Can we capture the number of replica that it randomly set and checks once the index is mounted that it corresponds?", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437256176", "createdAt": "2020-06-09T09:08:46Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -153,6 +154,9 @@ public void testCreateAndRestoreSearchableSnapshot() throws Exception {\n                 new ByteSizeValue(randomLongBetween(10, 100_000))\n             );\n         }\n+        if (randomBoolean()) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1NjYzOQ==", "bodyText": "The chunk_size can introduces many more writes and files, so maybe we can jut remove for this test?", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437256639", "createdAt": "2020-06-09T09:09:29Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -425,6 +430,156 @@ public void testMaxRestoreBytesPerSecIsUsed() throws Exception {\n         }\n     }\n \n+    public void testMountedSnapshotHasNoReplicasByDefault() throws Exception {\n+        final String fsRepoName = randomAlphaOfLength(10);\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String snapshotName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+\n+        final Path repo = randomRepoPath();\n+        assertAcked(\n+            client().admin()\n+                .cluster()\n+                .preparePutRepository(fsRepoName)\n+                .setType(\"fs\")\n+                .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209"}, "originalPosition": 42}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzNzI1Nzc3OA==", "bodyText": "I think we can use minimumNumberOfReplicas / maximumNumberOfReplicas here?", "url": "https://github.com/elastic/elasticsearch/pull/57802#discussion_r437257778", "createdAt": "2020-06-09T09:11:21Z", "author": {"login": "tlrx"}, "path": "x-pack/plugin/searchable-snapshots/src/test/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -425,6 +430,156 @@ public void testMaxRestoreBytesPerSecIsUsed() throws Exception {\n         }\n     }\n \n+    public void testMountedSnapshotHasNoReplicasByDefault() throws Exception {\n+        final String fsRepoName = randomAlphaOfLength(10);\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String restoredIndexName = randomBoolean() ? indexName : randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final String snapshotName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+\n+        final Path repo = randomRepoPath();\n+        assertAcked(\n+            client().admin()\n+                .cluster()\n+                .preparePutRepository(fsRepoName)\n+                .setType(\"fs\")\n+                .setSettings(Settings.builder().put(\"location\", repo).put(\"chunk_size\", randomIntBetween(100, 1000), ByteSizeUnit.BYTES))\n+        );\n+\n+        final int dataNodesCount = internalCluster().numDataNodes();\n+        final Settings.Builder originalIndexSettings = Settings.builder();\n+        originalIndexSettings.put(INDEX_SOFT_DELETES_SETTING.getKey(), true);\n+        if (randomBoolean()) {\n+            originalIndexSettings.put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, between(0, dataNodesCount - 1));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "40d57d0bc1e6fe16728ee09bca84c0d52b9c8209"}, "originalPosition": 49}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35f257e4ae1f7bfbff3b7bf218b373e4e26c2913", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/35f257e4ae1f7bfbff3b7bf218b373e4e26c2913", "committedDate": "2020-06-16T07:45:13Z", "message": "Merge branch 'master' into 2020-06-08-searchable-snapshot-defaults-to-no-replicas"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f07016925f559c689d2ee86141f4c83af77e7ba2", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/f07016925f559c689d2ee86141f4c83af77e7ba2", "committedDate": "2020-06-16T07:52:09Z", "message": "Use numberOfReplicas()"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "feb8604990318e64e25e7d0e3245d191dba59165", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/feb8604990318e64e25e7d0e3245d191dba59165", "committedDate": "2020-06-16T07:52:30Z", "message": "Use default chunk size"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ff7b049dd6377d990281414a8adcea9ad0d57954", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/ff7b049dd6377d990281414a8adcea9ad0d57954", "committedDate": "2020-06-16T08:00:25Z", "message": "Reformat"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3816, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}