{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA3MTg2NjY4", "number": 55577, "reviewThreads": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNToxMzo1MFrOD1GEjA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNToxMzo1MFrOD1GEjA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjU3MDAwNTg4OnYy", "diffSide": "RIGHT", "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "isResolved": false, "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yM1QwNToxMzo1MFrOGKW6LA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0yOFQwNzo1MjozN1rOGNHXvA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA==", "bodyText": "This is probably a dumb question. This is not possible in FIPS mode because the key is genereated using the PBEKeySpec?", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r413514284", "createdAt": "2020-04-23T05:13:50Z", "author": {"login": "ywangd"}, "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "diffHunk": "@@ -70,6 +70,7 @@ public void testBuildKeyConfigFromPkcs8PemFilesWithoutPassword() throws Exceptio\n     }\n \n     public void testBuildKeyConfigFromPkcs8PemFilesWithPassword() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM, PBE KeySpec is not available\", inFipsJvm());", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "85558facbb00090555955ef5f8ba7c561180cd22"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzgyNjYxNQ==", "bodyText": "This is not a dumb question. I realize that many times in the FIPS journey the comments and documentation I added made sense to me ( and sometimes not for long after the time when I wrote them ) but are not proper explanations.\nTo start with, we are limited to using only the algorithms defined in PKCS#5 1.5 because of a JDK bug ( that will hopefully be solved in JDK15 ) see :#32021.\nWhen not in FIPS mode, javax.crypto.SecretKeyFactory#generateSecret uses com.sun.crypto.provider.PBEKeyFactory#engineGenerateSecret which can happily consume a PBEKeySpec that has no salt because it uses com.sun.crypto.provider.PBEKey which doesn't have a salt ( the salt is used, but later on by the Cipher ) .\nWhen in FIPS mode, javax.crypto.SecretKeyFactory#generateSecret uses org.bouncycastle.jca.jce.provider.ProvPBE$PBKDF1#engineGenerateSecret that asserts that the PBEKeySpec has a salt and fails if not.\nNow we could restructure our PemUtils code to get the PbeParameterSpec with encryptedPrivateKeyInfo.getAlgParameters().getParameterSpec(AlgorithmParameterSpec.class); and then get the salt and iterations from there so that we could initialize a PBEKeySpec with the password, salt and iteration count so that it works in both SunJCE and BouncyCastle FIPS Provides BUT here's the catch:\nBouncyCastle FIPS provider doesn't support the algorithms that are described in PKCS#5 v1.5 encryption . ( PBE-MD2-DES and PBE-MD5-DES ), so it can't parse them to an AlgorithmParameterSpec.\nIn summary PBE KeySpec is not available is an understatement that made sense 2 years ago but in truth should have been described in detail in an issue that we can keep track of this. I will do this now, thanks for asking!", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r413826615", "createdAt": "2020-04-23T14:08:25Z", "author": {"login": "jkakavas"}, "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "diffHunk": "@@ -70,6 +70,7 @@ public void testBuildKeyConfigFromPkcs8PemFilesWithoutPassword() throws Exceptio\n     }\n \n     public void testBuildKeyConfigFromPkcs8PemFilesWithPassword() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM, PBE KeySpec is not available\", inFipsJvm());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}, "originalCommit": {"oid": "85558facbb00090555955ef5f8ba7c561180cd22"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjMwNDg1Mw==", "bodyText": "Shouldn't our FIPS instructions say that PKCS#8 password protected keys are not supported then?\nIronically, this bug was originally reported by someone trying to set up a FIPS 140-2 compliant cluster.", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r416304853", "createdAt": "2020-04-28T03:45:57Z", "author": {"login": "tvernum"}, "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "diffHunk": "@@ -70,6 +70,7 @@ public void testBuildKeyConfigFromPkcs8PemFilesWithoutPassword() throws Exceptio\n     }\n \n     public void testBuildKeyConfigFromPkcs8PemFilesWithPassword() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM, PBE KeySpec is not available\", inFipsJvm());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}, "originalCommit": {"oid": "85558facbb00090555955ef5f8ba7c561180cd22"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxNjQwNTQzNg==", "bodyText": "To be fair, we don't support PKCS#5 v2 encrypted PKCS# encoded PEM keys at all and  we don't support PKCS#5 v1.5 encrypted PKCS# encoded PEM keys in FIPS mode. At that time when we discovered this, the issue seemed to cover this since it affected the encryption that is prefered ( v2 ) irrespective to FIPS but you're right this should be marked as a limitation.", "url": "https://github.com/elastic/elasticsearch/pull/55577#discussion_r416405436", "createdAt": "2020-04-28T07:52:37Z", "author": {"login": "jkakavas"}, "path": "libs/ssl-config/src/test/java/org/elasticsearch/common/ssl/PemKeyConfigTests.java", "diffHunk": "@@ -70,6 +70,7 @@ public void testBuildKeyConfigFromPkcs8PemFilesWithoutPassword() throws Exceptio\n     }\n \n     public void testBuildKeyConfigFromPkcs8PemFilesWithPassword() throws Exception {\n+        assumeFalse(\"Can't run in a FIPS JVM, PBE KeySpec is not available\", inFipsJvm());", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQxMzUxNDI4NA=="}, "originalCommit": {"oid": "85558facbb00090555955ef5f8ba7c561180cd22"}, "originalPosition": 4}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2805, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}