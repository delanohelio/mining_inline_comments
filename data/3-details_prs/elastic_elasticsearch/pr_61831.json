{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDc3NjQwMjI0", "number": 61831, "title": "Ensure validation of the reader context is executed first", "bodyText": "This change makes sure that we validate the reader context (SearchOperationListener#validateReaderContext)\nbefore any other operation. This bug was introduced in #61062 so I marked this PR as a non-issue since it does not appear in any released version.\nRelates #61446\nRelates #61062", "createdAt": "2020-09-02T07:51:14Z", "url": "https://github.com/elastic/elasticsearch/pull/61831", "merged": true, "mergeCommit": {"oid": "38dc926e10212a5a5a03bcd64c0e7bbf780b1807"}, "closed": true, "closedAt": "2020-09-07T08:47:25Z", "author": {"login": "jimczi"}, "timelineItems": {"totalCount": 12, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdE3IC_AH2gAyNDc3NjQwMjI0OmI3M2FmM2E3OWJmZTYyYzdhMWEyYzFkNjQ0YWRlMWRmNzRjZTNjODQ=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdGd74XAH2gAyNDc3NjQwMjI0OjE0YjcwMzUwZDQzNDZmYmZjZjVmOGM0YTU1NDliNWJhY2Q1NmI3ZjY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b73af3a79bfe62c7a1a2c1d644ade1df74ce3c84", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b73af3a79bfe62c7a1a2c1d644ade1df74ce3c84", "committedDate": "2020-09-02T07:46:30Z", "message": "Ensure validation of the reader context is executed first\n\nThis change makes sure that we validate the reader context (`SearchOperationListener#validateReaderContext)\nbefore any other operation.\n\nRelates #61446"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "159b3a5e0f87ab95ecf4f7f2941f44554ccec307", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/159b3a5e0f87ab95ecf4f7f2941f44554ccec307", "committedDate": "2020-09-02T13:04:51Z", "message": "ensure that reader context are released properly on failures"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d5a6162005e81e592ff181499cb8ca14b7eb8fdf", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/d5a6162005e81e592ff181499cb8ca14b7eb8fdf", "committedDate": "2020-09-02T19:15:48Z", "message": "restore the removal of scroll context on failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b9b4c728c870ad59569257cb4738628209f06260", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b9b4c728c870ad59569257cb4738628209f06260", "committedDate": "2020-09-02T19:24:48Z", "message": "Merge branch 'master' into search_op_listener_validation"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a49d06734e5f4614a5a394176b1033eefcc9fcc1", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a49d06734e5f4614a5a394176b1033eefcc9fcc1", "committedDate": "2020-09-02T20:12:02Z", "message": "cleanup"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "00d2b1db8abd778eeef59c48eb2dc0793bd04062", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/00d2b1db8abd778eeef59c48eb2dc0793bd04062", "committedDate": "2020-09-02T21:19:52Z", "message": "don't release PIT on failure"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "f89a0a69f317feabf1745d3b54ea62f9c108bb5b", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/f89a0a69f317feabf1745d3b54ea62f9c108bb5b", "committedDate": "2020-09-02T22:22:25Z", "message": "do not remove scroll context on search rejection"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDgyODE3MjQ0", "url": "https://github.com/elastic/elasticsearch/pull/61831#pullrequestreview-482817244", "createdAt": "2020-09-04T16:58:53Z", "commit": {"oid": "f89a0a69f317feabf1745d3b54ea62f9c108bb5b"}, "state": "APPROVED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNFQxNzowMjoyNlrOHNVtnQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0wNVQwMzoxODowM1rOHNfJ1Q==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4Mzc0OTI3Nw==", "bodyText": "++", "url": "https://github.com/elastic/elasticsearch/pull/61831#discussion_r483749277", "createdAt": "2020-09-04T17:02:26Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/search/internal/LegacyReaderContext.java", "diffHunk": "@@ -61,6 +61,7 @@ public LegacyReaderContext(long id, IndexService indexService, IndexShard indexS\n             if (searcher == null) {\n                 Engine.Searcher delegate = searcherSupplier.acquireSearcher(source);\n                 onClose = delegate::close;\n+                // wrap the searcher so that closing is a noop, the actual closing happens when this context is closed", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f89a0a69f317feabf1745d3b54ea62f9c108bb5b"}, "originalPosition": 4}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkwMzczNg==", "bodyText": "I know processFailure and markAsUsed do not throw exceptions, but can we use Releases.close() to ensure that we always notify the listener?", "url": "https://github.com/elastic/elasticsearch/pull/61831#discussion_r483903736", "createdAt": "2020-09-05T03:14:54Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -861,17 +854,38 @@ private void checkKeepAliveLimit(long keepAlive) {\n         }\n     }\n \n-    private void processFailure(ShardSearchRequest request, ReaderContext context, Exception e) {\n-        if (context.singleSession() || request.scroll() != null) {\n+    private <T> ActionListener<T> wrapFailureListener(ActionListener<T> listener, ReaderContext context, Releasable releasable) {\n+        return new ActionListener<>() {\n+            @Override\n+            public void onResponse(T resp) {\n+                releasable.close();\n+                listener.onResponse(resp);\n+            }\n+\n+            @Override\n+            public void onFailure(Exception exc) {\n+                processFailure(context, exc);\n+                releasable.close();\n+                listener.onFailure(exc);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f89a0a69f317feabf1745d3b54ea62f9c108bb5b"}, "originalPosition": 228}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ4MzkwMzk1Nw==", "bodyText": "Nice!", "url": "https://github.com/elastic/elasticsearch/pull/61831#discussion_r483903957", "createdAt": "2020-09-05T03:18:03Z", "author": {"login": "dnhatn"}, "path": "server/src/main/java/org/elasticsearch/search/SearchService.java", "diffHunk": "@@ -420,17 +421,8 @@ public void onResponse(ShardSearchRequest orig) {\n                 }\n \n                 // fork the execution in the search thread pool\n-                runAsync(getExecutor(shard), () -> {\n-                    try (markAsUsed) {\n-                        return executeQueryPhase(orig, task, readerContext);\n-                    }\n-                }, ActionListener.wrap(listener::onResponse, exc -> {\n-                    try (markAsUsed) {\n-                        listener.onFailure(exc);\n-                    } finally {\n-                        processFailure(request, readerContext, exc);\n-                    }\n-                }));\n+                runAsync(getExecutor(shard), () -> executeQueryPhase(orig, task, readerContext),\n+                    wrapFailureListener(listener, readerContext, markAsUsed));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "f89a0a69f317feabf1745d3b54ea62f9c108bb5b"}, "originalPosition": 48}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0c42f9c0b1740cb75d511118dca90459d9bdc38c", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/0c42f9c0b1740cb75d511118dca90459d9bdc38c", "committedDate": "2020-09-06T23:40:42Z", "message": "Hold searcher in LegacyReaderContext"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a76a767a8341d91162505ad75131a4b6a769ae27", "author": {"user": {"login": "dnhatn", "name": "Nhat Nguyen"}}, "url": "https://github.com/elastic/elasticsearch/commit/a76a767a8341d91162505ad75131a4b6a769ae27", "committedDate": "2020-09-06T23:41:37Z", "message": "stylecheck"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "16ea240ad54ca1a76da955b934cc91066bdaee11", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/16ea240ad54ca1a76da955b934cc91066bdaee11", "committedDate": "2020-09-07T07:26:13Z", "message": "apply review feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "14b70350d4346fbfcf5f8c4a5549b5bacd56b7f6", "author": {"user": {"login": "jimczi", "name": "Jim Ferenczi"}}, "url": "https://github.com/elastic/elasticsearch/commit/14b70350d4346fbfcf5f8c4a5549b5bacd56b7f6", "committedDate": "2020-09-07T07:33:26Z", "message": "Merge branch 'master' into search_op_listener_validation"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4983, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}