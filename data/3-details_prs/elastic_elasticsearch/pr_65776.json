{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTMxMjcxNTA1", "number": 65776, "title": "Store _doc_count field as custom term frequency", "bodyText": "A while back, Lucene introduced the ability to index custom term frequencies, ie. giving users the ability to provide a numeric value that should be indexed as a term frequency rather than letting Lucene compute the term frequency by itself based on the number of occurrences of a term.\nThis PR modifies the _doc_count field so that it is stored as Lucene custom term frequency.\nA benefit of moving to custom term frequencies is that Lucene will automatically compute global term statistics like totalTermFreq which will let us know the sum of the values of the _doc_count field across an entire shard. This could in-turn be useful to generalize optimizations to rollup indices, e.g. buckets aggregations where all documents fall into the same bucket.\nRelates to #64503", "createdAt": "2020-12-02T20:28:34Z", "url": "https://github.com/elastic/elasticsearch/pull/65776", "merged": true, "mergeCommit": {"oid": "b554d5b9084510c9444c0708c25340a72724352a"}, "closed": true, "closedAt": "2020-12-03T14:40:10Z", "author": {"login": "csoulios"}, "timelineItems": {"totalCount": 9, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdiUdssAH2gAyNTMxMjcxNTA1OmRkOThhYmQ4ODJmY2I5YTY5ZGQwMDg1OWRmZDQ3ZjZiNmU0OTFlZWI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdijnFtAFqTU0Mzk3OTI2NQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "dd98abd882fcb9a69dd00859dfd47f6b6e491eeb", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/dd98abd882fcb9a69dd00859dfd47f6b6e491eeb", "committedDate": "2020-12-02T20:21:12Z", "message": "initial commit for doc_count field"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9c42ab9bd000b5ae3ec3d94ae94ed8dadd253e05", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/9c42ab9bd000b5ae3ec3d94ae94ed8dadd253e05", "committedDate": "2020-12-02T20:36:13Z", "message": "Minor change"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzMjkyNjIw", "url": "https://github.com/elastic/elasticsearch/pull/65776#pullrequestreview-543292620", "createdAt": "2020-12-02T22:32:06Z", "commit": {"oid": "9c42ab9bd000b5ae3ec3d94ae94ed8dadd253e05"}, "state": "COMMENTED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjozMjowNlrOH9w5WQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wMlQyMjozMzo0OFrOH9w9Eg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNjI5Nw==", "bodyText": "maybe use the same exception type as termQuery?", "url": "https://github.com/elastic/elasticsearch/pull/65776#discussion_r534526297", "createdAt": "2020-12-02T22:32:06Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocCountFieldMapper.java", "diffHunk": "@@ -55,12 +52,12 @@ public String typeName() {\n \n         @Override\n         public String familyTypeName() {\n-            return NumberFieldMapper.NumberType.LONG.typeName();\n+            return NumberFieldMapper.NumberType.INTEGER.typeName();\n         }\n \n         @Override\n         public Query existsQuery(QueryShardContext context) {\n-            return new DocValuesFieldExistsQuery(NAME);\n+            throw new IllegalArgumentException(\"Field [\" + name() + \"] of type [\" + typeName() + \"] does not support exists queries\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c42ab9bd000b5ae3ec3d94ae94ed8dadd253e05"}, "originalPosition": 34}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNDUyNzI1MA==", "bodyText": "should it be DEFAULT_VALUE since it is a constant?", "url": "https://github.com/elastic/elasticsearch/pull/65776#discussion_r534527250", "createdAt": "2020-12-02T22:33:48Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/bucket/DocCountProvider.java", "diffHunk": "@@ -33,17 +33,25 @@\n  */\n public class DocCountProvider {\n \n-    private NumericDocValues docCountValues;\n+    public static final int defaultValue = DocCountFieldMapper.DocCountFieldType.defaultValue;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9c42ab9bd000b5ae3ec3d94ae94ed8dadd253e05"}, "originalPosition": 17}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3c37312fafe5f716413a0b32ca071bc6579c2736", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/3c37312fafe5f716413a0b32ca071bc6579c2736", "committedDate": "2020-12-02T23:28:40Z", "message": "Minor changes to variable names"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "300e8bc01a7d42801a9ae0ed025997ae36975c73", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/300e8bc01a7d42801a9ae0ed025997ae36975c73", "committedDate": "2020-12-03T10:09:30Z", "message": "Address reviewer comments"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4d77def5b625392cfbb5574f726cffd390cf21f4", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/4d77def5b625392cfbb5574f726cffd390cf21f4", "committedDate": "2020-12-03T11:04:59Z", "message": "Added check to forbid arrays as values of _doc_count field"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTA4NDg5", "url": "https://github.com/elastic/elasticsearch/pull/65776#pullrequestreview-543908489", "createdAt": "2020-12-03T12:34:50Z", "commit": {"oid": "4d77def5b625392cfbb5574f726cffd390cf21f4"}, "state": "APPROVED", "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjozNDo1MFrOH-ZfIQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMi0wM1QxMjo0MDozMFrOH-Zsuw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5MTMyOQ==", "bodyText": "nit: I'd rather drop this constructor and require callers of this class to think about what is the right field name and term they should use", "url": "https://github.com/elastic/elasticsearch/pull/65776#discussion_r535191329", "createdAt": "2020-12-03T12:34:50Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/CustomTermFreqField.java", "diffHunk": "@@ -0,0 +1,107 @@\n+/*\n+ * Licensed to Elasticsearch under one or more contributor\n+ * license agreements. See the NOTICE file distributed with\n+ * this work for additional information regarding copyright\n+ * ownership. Elasticsearch licenses this file to you under\n+ * the Apache License, Version 2.0 (the \"License\"); you may\n+ * not use this file except in compliance with the License.\n+ * You may obtain a copy of the License at\n+ *\n+ *    http://www.apache.org/licenses/LICENSE-2.0\n+ *\n+ * Unless required by applicable law or agreed to in writing,\n+ * software distributed under the License is distributed on an\n+ * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n+ * KIND, either express or implied.  See the License for the\n+ * specific language governing permissions and limitations\n+ * under the License.\n+ */\n+\n+package org.elasticsearch.index.mapper;\n+\n+import org.apache.lucene.analysis.Analyzer;\n+import org.apache.lucene.analysis.TokenStream;\n+import org.apache.lucene.analysis.tokenattributes.CharTermAttribute;\n+import org.apache.lucene.analysis.tokenattributes.TermFrequencyAttribute;\n+import org.apache.lucene.document.Field;\n+import org.apache.lucene.document.FieldType;\n+import org.apache.lucene.index.IndexOptions;\n+\n+/**\n+ * Custom field that allow storing an integer value as a term frequency in lucene.\n+ */\n+public final class CustomTermFreqField extends Field {\n+\n+  private static final FieldType FIELD_TYPE = new FieldType();\n+  static {\n+    FIELD_TYPE.setTokenized(false);\n+    FIELD_TYPE.setOmitNorms(true);\n+    FIELD_TYPE.setIndexOptions(IndexOptions.DOCS_AND_FREQS);\n+  }\n+\n+  private int fieldValue;\n+\n+  public CustomTermFreqField(String fieldName, CharSequence term, int fieldValue) {\n+    super(fieldName, term, FIELD_TYPE);\n+    this.fieldValue = fieldValue;\n+  }\n+\n+  public CustomTermFreqField(String fieldName, int fieldValue) {\n+    this(fieldName, fieldName, fieldValue);\n+  }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d77def5b625392cfbb5574f726cffd390cf21f4"}, "originalPosition": 51}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUzNTE5NDgxMQ==", "bodyText": "This method is a bit trappy as it does a linear scan of the fields of the document. Can you use addWithKey like BinaryFieldMapper does?", "url": "https://github.com/elastic/elasticsearch/pull/65776#discussion_r535194811", "createdAt": "2020-12-03T12:40:30Z", "author": {"login": "jpountz"}, "path": "server/src/main/java/org/elasticsearch/index/mapper/DocCountFieldMapper.java", "diffHunk": "@@ -96,17 +93,19 @@ protected void parseCreateField(ParseContext context) throws IOException {\n         XContentParser parser = context.parser();\n         XContentParserUtils.ensureExpectedToken(XContentParser.Token.VALUE_NUMBER, parser.currentToken(), parser);\n \n-        long value = parser.longValue(false);\n+        // Check that _doc_count is a single value and not an array\n+        if (context.doc().getField(NAME) != null) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d77def5b625392cfbb5574f726cffd390cf21f4"}, "originalPosition": 61}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ffbcea48871c63de4ee1e5a80fdfd3152ff5d876", "author": {"user": {"login": "csoulios", "name": "Christos Soulios"}}, "url": "https://github.com/elastic/elasticsearch/commit/ffbcea48871c63de4ee1e5a80fdfd3152ff5d876", "committedDate": "2020-12-03T13:45:54Z", "message": "Addressed reviewer comments"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NTQzOTc5MjY1", "url": "https://github.com/elastic/elasticsearch/pull/65776#pullrequestreview-543979265", "createdAt": "2020-12-03T14:00:02Z", "commit": {"oid": "ffbcea48871c63de4ee1e5a80fdfd3152ff5d876"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4119, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}