{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTExMTIyNjcy", "number": 64252, "reviewThreads": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMTo1NzozMVrOE2Dv0g==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMjowMTowMFrOE2Dzow==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTE5OTU0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/Watcher.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMTo1NzozMVrOHurTJw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMTozNjoxM1rOHyPRfw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNTk1OQ==", "bodyText": "auto_create_index does not affect the creation of data streams, so it shouldn't be necessary to check for that here.", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r518705959", "createdAt": "2020-11-06T11:57:31Z", "author": {"login": "danhermann"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/Watcher.java", "diffHunk": "@@ -615,14 +615,7 @@ static void validAutoCreateIndex(Settings settings, Logger logger) {\n         indices.add(\".watches\");\n         indices.add(\".triggered_watches\");\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusDays(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(2)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(3)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(4)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(5)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(6)));\n+        indices.add(HistoryStoreField.DATA_STREAM);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35084e8b013266df1de5f4580a2bfdc79196f75a"}, "originalPosition": 12}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MTA4Nw==", "bodyText": "Thanks, I've removed it", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r522441087", "createdAt": "2020-11-12T21:36:13Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/Watcher.java", "diffHunk": "@@ -615,14 +615,7 @@ static void validAutoCreateIndex(Settings settings, Logger logger) {\n         indices.add(\".watches\");\n         indices.add(\".triggered_watches\");\n         ZonedDateTime now = ZonedDateTime.now(ZoneOffset.UTC);\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusDays(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(1)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(2)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(3)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(4)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(5)));\n-        indices.add(HistoryStoreField.getHistoryIndexNameForTime(now.plusMonths(6)));\n+        indices.add(HistoryStoreField.DATA_STREAM);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNTk1OQ=="}, "originalCommit": {"oid": "35084e8b013266df1de5f4580a2bfdc79196f75a"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzI1MTIwOTMxOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/history/HistoryStore.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0wNlQxMjowMTowMFrOHurZSQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMS0xMlQyMTozNzo0MVrOHyPUPg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNzUyOQ==", "bodyText": "Out of curiosity, is this addressing a scenario that's specific to data streams or just a general case where history entries weren't being written?", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r518707529", "createdAt": "2020-11-06T12:01:00Z", "author": {"login": "danhermann"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/history/HistoryStore.java", "diffHunk": "@@ -78,9 +76,12 @@ public void forcePut(WatchRecord watchRecord) {\n      * @return true, if history store is ready to be started\n      */\n     public static boolean validate(ClusterState state) {\n-        String currentIndex = HistoryStoreField.getHistoryIndexNameForTime(ZonedDateTime.now(ZoneOffset.UTC));\n-        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(currentIndex, state.metadata());\n+        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(HistoryStoreField.DATA_STREAM, state.metadata());\n         return indexMetadata == null || (indexMetadata.getState() == IndexMetadata.State.OPEN &&\n             state.routingTable().index(indexMetadata.getIndex()).allPrimaryShardsActive());\n     }\n+\n+    public void flush() {\n+        bulkProcessor.flush();\n+    }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "35084e8b013266df1de5f4580a2bfdc79196f75a"}, "originalPosition": 57}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUyMjQ0MTc5MA==", "bodyText": "Main reason for this is to have clear state after tests. This makes sure that we don't have any pending docs to index so we can do proper cleanup after the test and leave no hanging indices behind", "url": "https://github.com/elastic/elasticsearch/pull/64252#discussion_r522441790", "createdAt": "2020-11-12T21:37:41Z", "author": {"login": "probakowski"}, "path": "x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/history/HistoryStore.java", "diffHunk": "@@ -78,9 +76,12 @@ public void forcePut(WatchRecord watchRecord) {\n      * @return true, if history store is ready to be started\n      */\n     public static boolean validate(ClusterState state) {\n-        String currentIndex = HistoryStoreField.getHistoryIndexNameForTime(ZonedDateTime.now(ZoneOffset.UTC));\n-        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(currentIndex, state.metadata());\n+        IndexMetadata indexMetadata = WatchStoreUtils.getConcreteIndex(HistoryStoreField.DATA_STREAM, state.metadata());\n         return indexMetadata == null || (indexMetadata.getState() == IndexMetadata.State.OPEN &&\n             state.routingTable().index(indexMetadata.getIndex()).allPrimaryShardsActive());\n     }\n+\n+    public void flush() {\n+        bulkProcessor.flush();\n+    }", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUxODcwNzUyOQ=="}, "originalCommit": {"oid": "35084e8b013266df1de5f4580a2bfdc79196f75a"}, "originalPosition": 57}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4237, "cost": 1, "resetAt": "2021-11-12T19:05:54Z"}}}