{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NTA0Mjk3ODkz", "number": 63764, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToxOTo1NVrOEuY_gQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToyMjoyNlrOEuZD-A==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MDc5NDI1OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToxOTo1NVrOHiwpLQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToxOTo1NVrOHiwpLQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMDYwNQ==", "bodyText": "This and the above comment can be removed now", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506210605", "createdAt": "2020-10-16T09:19:55Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "diffHunk": "@@ -190,6 +191,7 @@ protected Clock getClock() {\n         @SuppressWarnings(\"unused\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e30ccbf2033b5116a67320ceac5136ae2c8af14"}, "originalPosition": 9}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MDc5NTI3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToyMDowNFrOHiwpwQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToyMDowNFrOHiwpwQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMDc1Mw==", "bodyText": "This and the above comment can be removed now", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506210753", "createdAt": "2020-10-16T09:20:04Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/ilm/src/main/java/org/elasticsearch/xpack/ilm/IndexLifecycle.java", "diffHunk": "@@ -180,6 +180,7 @@ protected Clock getClock() {\n         @SuppressWarnings(\"unused\")", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e30ccbf2033b5116a67320ceac5136ae2c8af14"}, "originalPosition": 1}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMzE3MDgwNTY4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/stack/src/main/java/org/elasticsearch/xpack/stack/StackTemplateRegistry.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQwOToyMjoyNlrOHiwwUA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0xMC0xNlQxNToxNjo1N1rOHjEaqQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMjQzMg==", "bodyText": "I think this is a bit confusing as to why this happened. Should we also mention that the setting was updated and as a result, the templates will not be installed/reinstalled anymore?", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506212432", "createdAt": "2020-10-16T09:22:26Z", "author": {"login": "andreidan"}, "path": "x-pack/plugin/stack/src/main/java/org/elasticsearch/xpack/stack/StackTemplateRegistry.java", "diffHunk": "@@ -129,7 +142,27 @@ public StackTemplateRegistry(\n         NamedXContentRegistry xContentRegistry\n     ) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        this.stackTemplateEnabled = StackPlugin.STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+        this.clusterService = clusterService;\n+        this.stackTemplateEnabled = STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        super.initialize();\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(STACK_TEMPLATES_ENABLED, this::updateEnabledSetting);\n+    }\n+\n+    private void updateEnabledSetting(boolean newValue) {\n+        if (newValue) {\n+            this.stackTemplateEnabled = true;\n+        } else {\n+            logger.info(\n+                \"stack composable templates [{}] and component templates [{}] will not be installed or reinstalled\",", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "8e30ccbf2033b5116a67320ceac5136ae2c8af14"}, "originalPosition": 61}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjUzNDU2OQ==", "bodyText": "the settings infrastructure already logs a message to that effect, so this looks like:\n[2020-10-16T09:16:27,285][INFO ][o.e.c.s.ClusterSettings  ] [runTask-0] updating [stack.templates.enabled] from [true] to [false]\n[2020-10-16T09:16:27,286][INFO ][o.e.x.s.StackTemplateRegistry] [runTask-0] stack composable templates [logs,metrics,synthetics] and component templates [logs-mappings,logs-settings,metrics-mappings,metrics-settings,synthetics-mappings,synthetics-settings] will not be installed or reinstalled\n\nThat's why I left out any mention that the setting was updated (it happens regardless)", "url": "https://github.com/elastic/elasticsearch/pull/63764#discussion_r506534569", "createdAt": "2020-10-16T15:16:57Z", "author": {"login": "dakrone"}, "path": "x-pack/plugin/stack/src/main/java/org/elasticsearch/xpack/stack/StackTemplateRegistry.java", "diffHunk": "@@ -129,7 +142,27 @@ public StackTemplateRegistry(\n         NamedXContentRegistry xContentRegistry\n     ) {\n         super(nodeSettings, clusterService, threadPool, client, xContentRegistry);\n-        this.stackTemplateEnabled = StackPlugin.STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+        this.clusterService = clusterService;\n+        this.stackTemplateEnabled = STACK_TEMPLATES_ENABLED.get(nodeSettings);\n+    }\n+\n+    @Override\n+    public void initialize() {\n+        super.initialize();\n+        clusterService.getClusterSettings().addSettingsUpdateConsumer(STACK_TEMPLATES_ENABLED, this::updateEnabledSetting);\n+    }\n+\n+    private void updateEnabledSetting(boolean newValue) {\n+        if (newValue) {\n+            this.stackTemplateEnabled = true;\n+        } else {\n+            logger.info(\n+                \"stack composable templates [{}] and component templates [{}] will not be installed or reinstalled\",", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDUwNjIxMjQzMg=="}, "originalCommit": {"oid": "8e30ccbf2033b5116a67320ceac5136ae2c8af14"}, "originalPosition": 61}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2915, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}