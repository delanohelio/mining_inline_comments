{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDM4NDc4MDM1", "number": 58419, "title": "Introduce new put mapping action for dynamic mapping updates.", "bodyText": "Mapping updates that originate from indexing a document with unmapped fields will use this new action instead of the current put mapping action.\nThis way on the security side, authorization logic can easily determine whether a mapping update is automatically generated or a mapping update originates from the put mapping api.", "createdAt": "2020-06-23T10:32:07Z", "url": "https://github.com/elastic/elasticsearch/pull/58419", "merged": true, "mergeCommit": {"oid": "1be135f946f575c829e8f054a01b3d75f1bc1236"}, "closed": true, "closedAt": "2020-06-30T13:09:09Z", "author": {"login": "martijnvg"}, "timelineItems": {"totalCount": 10, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcuC6LIgH2gAyNDM4NDc4MDM1OjliMDU0ZDNiZGZkNTQzMWQ5Y2JhYzVjNDRkMTZiMTkyYzMwNWIwYTE=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcwRjckgH2gAyNDM4NDc4MDM1OmVlMGEwMWE1MDQ1ODU1N2EzYmIzMjA3ZWUyYmE2ZmNmNDRmMTZjOWM=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/9b054d3bdfd5431d9cbac5c44d16b192c305b0a1", "committedDate": "2020-06-23T10:29:57Z", "message": "Introduce new put mapping action for dynamic mapping updates.\n\nMapping updates that originate from indexing a document with unmapped fields will use this new action\ninstead of the current put mapping action. This way on the security side, authorization logic\ncan easily determine whether a mapping update is automatically generated or a mapping update originates\nfrom the put mapping api."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjUzMDQ3", "url": "https://github.com/elastic/elasticsearch/pull/58419#pullrequestreview-435653047", "createdAt": "2020-06-23T10:33:29Z", "commit": {"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMzozMFrOGnjTVQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozMzozMFrOGnjTVQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjAzNw==", "bodyText": "This is a bug fix. Invoking this method directly caused a NPE.", "url": "https://github.com/elastic/elasticsearch/pull/58419#discussion_r444126037", "createdAt": "2020-06-23T10:33:30Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/put/PutMappingRequest.java", "diffHunk": "@@ -129,7 +129,7 @@ public PutMappingRequest indices(String... indices) {\n      * Sets a concrete index for this put mapping request.\n      */\n     public PutMappingRequest setConcreteIndex(Index index) {\n-        Objects.requireNonNull(indices, \"index must not be null\");\n+        Objects.requireNonNull(index, \"index must not be null\");", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1"}, "originalPosition": 5}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM1NjUzNDk1", "url": "https://github.com/elastic/elasticsearch/pull/58419#pullrequestreview-435653495", "createdAt": "2020-06-23T10:34:13Z", "commit": {"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozNDoxNFrOGnjUsQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0yM1QxMDozNDoxNFrOGnjUsQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NDEyNjM4NQ==", "bodyText": "Extracted the common logic that both regular put mapping api calls and a dynamic mapping update reuse.", "url": "https://github.com/elastic/elasticsearch/pull/58419#discussion_r444126385", "createdAt": "2020-06-23T10:34:14Z", "author": {"login": "martijnvg"}, "path": "server/src/main/java/org/elasticsearch/action/admin/indices/mapping/put/TransportPutMappingAction.java", "diffHunk": "@@ -106,29 +106,36 @@ protected void masterOperation(Task task, final PutMappingRequest request, final\n                 listener.onFailure(maybeValidationException.get());\n                 return;\n             }\n-            PutMappingClusterStateUpdateRequest updateRequest = new PutMappingClusterStateUpdateRequest(request.source())\n-                .indices(concreteIndices)\n-                .ackTimeout(request.timeout()).masterNodeTimeout(request.masterNodeTimeout());\n-\n-            metadataMappingService.putMapping(updateRequest, new ActionListener<ClusterStateUpdateResponse>() {\n-\n-                @Override\n-                public void onResponse(ClusterStateUpdateResponse response) {\n-                    listener.onResponse(new AcknowledgedResponse(response.isAcknowledged()));\n-                }\n-\n-                @Override\n-                public void onFailure(Exception t) {\n-                    logger.debug(() -> new ParameterizedMessage(\"failed to put mappings on indices [{}]\",\n-                        Arrays.asList(concreteIndices)), t);\n-                    listener.onFailure(t);\n-                }\n-            });\n+            performMappingUpdate(concreteIndices, request, listener, metadataMappingService);\n         } catch (IndexNotFoundException ex) {\n             logger.debug(() -> new ParameterizedMessage(\"failed to put mappings on indices [{}]\",\n                 Arrays.asList(request.indices())), ex);\n             throw ex;\n         }\n     }\n \n+    static void performMappingUpdate(Index[] concreteIndices,", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "9b054d3bdfd5431d9cbac5c44d16b192c305b0a1"}, "originalPosition": 30}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "3275eea6d2501c1ddd8410094cbdcd86eb371b94", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/3275eea6d2501c1ddd8410094cbdcd86eb371b94", "committedDate": "2020-06-24T14:18:50Z", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "74a32f915f37c0fc695f31b149ebb5764a34d9ab", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/74a32f915f37c0fc695f31b149ebb5764a34d9ab", "committedDate": "2020-06-24T14:39:44Z", "message": "Only use the new auto put mapping action if all nodes are on the version that supports it."}}, {"__typename": "PullRequestCommit", "commit": {"oid": "35b345d2dab57b1583ee2f0b2139b52a27b7a0fb", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/35b345d2dab57b1583ee2f0b2139b52a27b7a0fb", "committedDate": "2020-06-24T15:18:14Z", "message": "added unit test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5MzA2MTg1", "url": "https://github.com/elastic/elasticsearch/pull/58419#pullrequestreview-439306185", "createdAt": "2020-06-29T16:21:51Z", "commit": {"oid": "35b345d2dab57b1583ee2f0b2139b52a27b7a0fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDM5NDgzODM1", "url": "https://github.com/elastic/elasticsearch/pull/58419#pullrequestreview-439483835", "createdAt": "2020-06-29T20:40:36Z", "commit": {"oid": "35b345d2dab57b1583ee2f0b2139b52a27b7a0fb"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "4b281a3b22aefed7c42d3df5bcb2348715733c39", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/4b281a3b22aefed7c42d3df5bcb2348715733c39", "committedDate": "2020-06-30T06:52:53Z", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ee0a01a50458557a3bb3207ee2ba6fcf44f16c9c", "author": {"user": {"login": "martijnvg", "name": "Martijn van Groningen"}}, "url": "https://github.com/elastic/elasticsearch/commit/ee0a01a50458557a3bb3207ee2ba6fcf44f16c9c", "committedDate": "2020-06-30T08:41:33Z", "message": "Merge remote-tracking branch 'es/master' into auto_put_mapping_action"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 351, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}