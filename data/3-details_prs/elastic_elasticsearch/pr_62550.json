{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDg4NjkyMjI5", "number": 62550, "title": "Add test for snapshot incrementality of snapshot-backed indices", "bodyText": "This pull request adds a test that verifies that snapshots incrementality is respected when a snapshot-backed index is snapshotted. This test mounts a snapshot as a snapshot-backed index, creates a new snapshot from it and then verifies that no new data blobs were added to the repository.", "createdAt": "2020-09-17T14:02:08Z", "url": "https://github.com/elastic/elasticsearch/pull/62550", "merged": true, "mergeCommit": {"oid": "dd11f5f96b477c9f57507034fc13513689c7bdba"}, "closed": true, "closedAt": "2020-09-18T15:13:49Z", "author": {"login": "tlrx"}, "timelineItems": {"totalCount": 5, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdJxQ91AH2gAyNDg4NjkyMjI5OmM4NDIxMGNkNzc0OGQ1OWE0MDU1NDQ4MjY0MjFmOThjMzk4ZDVmMGM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdKFVsfAFqTQ5MTQ0ODYyMg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "c84210cd7748d59a405544826421f98c398d5f0c", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/c84210cd7748d59a405544826421f98c398d5f0c", "committedDate": "2020-09-17T13:46:26Z", "message": "Add test"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkwNjQzODQ2", "url": "https://github.com/elastic/elasticsearch/pull/62550#pullrequestreview-490643846", "createdAt": "2020-09-17T14:16:53Z", "commit": {"oid": "c84210cd7748d59a405544826421f98c398d5f0c"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDoxNjo1M1rOHTkgbw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOS0xN1QxNDoxNjo1M1rOHTkgbw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ5MDI4MzExOQ==", "bodyText": "I think you can have this check in a more straight-forward manner and just use the snapshot status API.\nSee for example org.elasticsearch.snapshots.BlobStoreIncrementalityIT#assertTwoIdenticalShardSnapshots. I think I'd prefer that over adding yet another test that manually inspects the exact file structure on disk and has to be adjusted if and when we change the repo format.\nIn a sense this is also more correct since we already store some blobs straight in the shard snapshot metadata where the approach would catch changes while the data files don't change.", "url": "https://github.com/elastic/elasticsearch/pull/62550#discussion_r490283119", "createdAt": "2020-09-17T14:16:53Z", "author": {"login": "original-brownbear"}, "path": "x-pack/plugin/searchable-snapshots/src/internalClusterTest/java/org/elasticsearch/xpack/searchablesnapshots/SearchableSnapshotsIntegTests.java", "diffHunk": "@@ -660,6 +671,52 @@ public void testMountedSnapshotHasNoReplicasByDefault() throws Exception {\n         }\n     }\n \n+    public void testSnapshotMountedIndexLeavesBlobsUntouched() throws Exception {\n+        final String indexName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        createAndPopulateIndex(\n+            indexName,\n+            Settings.builder()\n+                .put(IndexMetadata.SETTING_NUMBER_OF_SHARDS, between(1, 3))\n+                .put(IndexMetadata.SETTING_NUMBER_OF_REPLICAS, 0)\n+                .put(INDEX_SOFT_DELETES_SETTING.getKey(), true)\n+        );\n+        ensureGreen(indexName);\n+        forceMerge();\n+\n+        final String repositoryName = randomAlphaOfLength(10).toLowerCase(Locale.ROOT);\n+        final Path repositoryLocation = randomRepoPath();\n+        createFsRepository(repositoryName, repositoryLocation);\n+\n+        final SnapshotId snapshotOne = createSnapshot(repositoryName, List.of(indexName));\n+        final Set<Tuple<String, Long>> snapshotOneDataBlobs = listDataBlobsInRepository(repositoryLocation);\n+        assertThat(snapshotOneDataBlobs, hasSize(greaterThan(0)));\n+        assertAcked(client().admin().indices().prepareDelete(indexName));\n+\n+        mountSnapshot(repositoryName, snapshotOne.getName(), indexName, indexName, Settings.EMPTY);\n+        ensureGreen(indexName);\n+\n+        createSnapshot(repositoryName, List.of(indexName));\n+        final Set<Tuple<String, Long>> snapshotTwoDataBlobs = listDataBlobsInRepository(repositoryLocation);\n+        assertThat(snapshotTwoDataBlobs.containsAll(snapshotOneDataBlobs), is(true));\n+        assertThat(snapshotTwoDataBlobs, hasSize(snapshotOneDataBlobs.size()));", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c84210cd7748d59a405544826421f98c398d5f0c"}, "originalPosition": 80}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "9dd966ded4f311bfcdc13790d8371323d8297665", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/9dd966ded4f311bfcdc13790d8371323d8297665", "committedDate": "2020-09-18T08:49:38Z", "message": "feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "12972fb157b86718936f395acfd0259e9829f229", "author": {"user": {"login": "tlrx", "name": "Tanguy Leroux"}}, "url": "https://github.com/elastic/elasticsearch/commit/12972fb157b86718936f395acfd0259e9829f229", "committedDate": "2020-09-18T12:06:04Z", "message": "Merge branch 'master' into test-snapshot-of-mounted-index"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDkxNDQ4NjIy", "url": "https://github.com/elastic/elasticsearch/pull/62550#pullrequestreview-491448622", "createdAt": "2020-09-18T13:09:42Z", "commit": {"oid": "12972fb157b86718936f395acfd0259e9829f229"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3645, "cost": 1, "resetAt": "2021-10-28T19:08:13Z"}}}