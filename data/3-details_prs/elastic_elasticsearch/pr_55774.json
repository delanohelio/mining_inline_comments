{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDA5MDc1NTQy", "number": 55774, "title": "Just log 401 stacktraces", "bodyText": "", "createdAt": "2020-04-26T12:30:26Z", "url": "https://github.com/elastic/elasticsearch/pull/55774", "merged": true, "mergeCommit": {"oid": "f232d27375c959a5c0303d4b7e5abb3604ba6f09"}, "closed": true, "closedAt": "2020-06-10T16:04:19Z", "author": {"login": "albertzaharovits"}, "timelineItems": {"totalCount": 21, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcbYmNxAH2gAyNDA5MDc1NTQyOjUwOTYyNWRjZmU2M2I2Y2NhMWFjNDg5NTk4NDlkODA3YjRlMzYxNWM=", "endCursor": "Y3Vyc29yOnYyOpPPAAABcp5g6fgH2gAyNDA5MDc1NTQyOmI2MTJmNjQ2NmRhNGZhMGM1OWQ5NzhlYmY1Yjc5ZTYyMmFkN2Q0OWY=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "509625dcfe63b6cca1ac48959849d807b4e3615c", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/509625dcfe63b6cca1ac48959849d807b4e3615c", "committedDate": "2020-04-26T11:01:30Z", "message": "Checkpoint"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "945b1b039452bd9ac661f7e9510163182992398b", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/945b1b039452bd9ac661f7e9510163182992398b", "committedDate": "2020-04-26T11:11:28Z", "message": "Done"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c48533b194c0da3816d2c9b60d1bc0c3d636eb57", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/c48533b194c0da3816d2c9b60d1bc0c3d636eb57", "committedDate": "2020-04-26T12:33:53Z", "message": "Fix test"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "271c4bfb771fe9b645dde12de1dcfd02f5922d8e", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/271c4bfb771fe9b645dde12de1dcfd02f5922d8e", "committedDate": "2020-04-26T12:46:19Z", "message": "Checkstyle"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "48359a07aa04f29121f4993cfed660b5c8edcd52", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/48359a07aa04f29121f4993cfed660b5c8edcd52", "committedDate": "2020-04-26T16:58:13Z", "message": "SecurityRestFilter"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1c800dd103519cf641290ff06a159490633f78c6", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/1c800dd103519cf641290ff06a159490633f78c6", "committedDate": "2020-04-26T17:27:29Z", "message": "More tests"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "97915ed75b780d3d6efbca2604bf7929f638ef19", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/97915ed75b780d3d6efbca2604bf7929f638ef19", "committedDate": "2020-04-27T09:53:40Z", "message": "Nits"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "ca0f00a0b698eb486efb594f8f7889b85c5f97c4", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/ca0f00a0b698eb486efb594f8f7889b85c5f97c4", "committedDate": "2020-04-27T09:54:27Z", "message": "Merge branch 'master' into hide_security_stacktrace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "508151d32529068fce53650371c68bded7041d42", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/508151d32529068fce53650371c68bded7041d42", "committedDate": "2020-04-27T10:23:06Z", "message": "Docs"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d7cba32a5ad0a929082718328b92a9918ead0634", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/d7cba32a5ad0a929082718328b92a9918ead0634", "committedDate": "2020-04-29T15:47:33Z", "message": "Merge branch 'master' into hide_security_stacktrace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a9585387fcc625baf792f0f028eb6739fb34d3d5", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a9585387fcc625baf792f0f028eb6739fb34d3d5", "committedDate": "2020-04-29T22:41:18Z", "message": "Forgot to register setting"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "efb5e076bda680ac8d56b2039995a23005d7e745", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/efb5e076bda680ac8d56b2039995a23005d7e745", "committedDate": "2020-05-25T16:15:27Z", "message": "Merge branch 'master' into hide_security_stacktrace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/6f45e455bebd4bd8b044519af2b85724cc3aff9c", "committedDate": "2020-05-25T17:23:15Z", "message": "Remove seetting"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDE3OTIyNTM0", "url": "https://github.com/elastic/elasticsearch/pull/55774#pullrequestreview-417922534", "createdAt": "2020-05-26T01:39:20Z", "commit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c"}, "state": "CHANGES_REQUESTED", "comments": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMTozOToyMFrOGaMOGA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNS0yNlQwMzo0MDozNFrOGaNrxA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDExNjM3Ng==", "bodyText": "We could use a test for a failure that has a non-empty cause and ensure the stack trace is not displayed for the cause either.", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430116376", "createdAt": "2020-05-26T01:39:20Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/SecurityRestFilterTests.java", "diffHunk": "@@ -141,21 +146,48 @@ public void testProcessBasicLicense() throws Exception {\n         verifyZeroInteractions(channel, authcService);\n     }\n \n-    public void testProcessAuthenticationError() throws Exception {\n-        RestRequest request = mock(RestRequest.class);\n-        Exception exception = authenticationError(\"failed authc\");\n+    public void testProcessAuthenticationFailedNoTrace() throws Exception {\n+        filter = new SecurityRestFilter(licenseState, threadContext, authcService, secondaryAuthenticator, restHandler, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, false, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, false, false);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEyMzY2OA==", "bodyText": "I am unsure about this statement. It is probably better be removed. My reasonings are:\n\nSemantically it is not necessary as the else branch is the execution path of the default value, i.e. REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT, which is true.\nIn fact, it does not matter what the actual default value is. The intention here, as I understand it, is to proceed as default with no extra intervention. This is unlikely in practice, but might be possible in theory: The caller may choose to set REST_EXCEPTION_SKIP_STACK_TRACE to false and wraps it with either a RestChannel or RestRequest. In this case, the else branch should proceed with the value from caller instead of changing it.", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430123668", "createdAt": "2020-05-26T02:16:08Z", "author": {"login": "ywangd"}, "path": "server/src/main/java/org/elasticsearch/rest/BytesRestResponse.java", "diffHunk": "@@ -117,28 +131,22 @@ public RestStatus status() {\n         return this.status;\n     }\n \n-    private static final Logger SUPPRESSED_ERROR_LOGGER = LogManager.getLogger(\"rest.suppressed\");\n-\n-    private static XContentBuilder build(RestChannel channel, RestStatus status, Exception e) throws IOException {\n-        ToXContent.Params params = channel.request();\n+    protected ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n+        ToXContent.Params params = restRequest;\n         if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)) {\n             params =  new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"false\"), params);\n-        } else if (e != null) {\n-            Supplier<?> messageSupplier = () -> new ParameterizedMessage(\"path: {}, params: {}\",\n-                    channel.request().rawPath(), channel.request().params());\n-\n-            if (status.getStatus() < 500) {\n-                SUPPRESSED_ERROR_LOGGER.debug(messageSupplier, e);\n-            } else {\n-                SUPPRESSED_ERROR_LOGGER.warn(messageSupplier, e);\n-            }\n+        } else {\n+            params =  new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"true\"), params);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c"}, "originalPosition": 63}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDEzNTI5Ng==", "bodyText": "I wonder whether this could just be pulled up into BytesRestResponse itself. I think the intention is probably to not mix security related code with generic Rest code. But the duplication worries me and it is hard to be aware of the additional logic if you just read BytesRestResponse.\nIf pulling this up does not sound right to you, alternatively, we could add an additional method to BytesRestResponse, e.g. allowsStackTrace(), which always returns true and is overridden here to check the restStatus, i.e.:\nFor BytesRestResponse:\nprivate ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n    ToXContent.Params params = restRequest;\n    if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)\n        && allowsStackTrace()) {\n                 ...\n    }\n            ...\n}\n\nprotected boolean allowsStackTrace() { return true; }\nAnd overridden as:\nchannel.sendResponse(new BytesRestResponse(channel, e) {\n    @Override\n    protected boolean allowsStackTrace() { return status() != RestStatus.UNAUTHORIZED; }\n})\nI personally feel the additional method makes it easier to be aware of the possible extra check by just reading the BytesRestResponse class.", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430135296", "createdAt": "2020-05-26T03:13:34Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/rest/SecurityRestFilter.java", "diffHunk": "@@ -82,8 +89,23 @@ public void handleRequest(RestRequest request, RestChannel channel, NodeClient c\n \n     private void handleException(String actionType, RestRequest request, RestChannel channel, Exception e) {\n         logger.debug(new ParameterizedMessage(\"{} failed for REST request [{}]\", actionType, request.uri()), e);\n+        final RestStatus restStatus = ExceptionsHelper.status(e);\n         try {\n-            channel.sendResponse(new BytesRestResponse(channel, e));\n+            channel.sendResponse(new BytesRestResponse(channel, restStatus, e) {\n+\n+                @Override\n+                protected ToXContent.Params paramsFromRequest(RestRequest restRequest) {\n+                    ToXContent.Params params = restRequest;\n+                    if (params.paramAsBoolean(\"error_trace\", !REST_EXCEPTION_SKIP_STACK_TRACE_DEFAULT)\n+                            && restStatus != RestStatus.UNAUTHORIZED) {\n+                        params = new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"false\"), params);\n+                    } else {\n+                        params = new ToXContent.DelegatingMapParams(singletonMap(REST_EXCEPTION_SKIP_STACK_TRACE, \"true\"), params);\n+                    }\n+                    return params;\n+                }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c"}, "originalPosition": 50}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQzMDE0MDM1Ng==", "bodyText": "Nit: we could probably randomize the RestStatus in 4xx and 5xx.", "url": "https://github.com/elastic/elasticsearch/pull/55774#discussion_r430140356", "createdAt": "2020-05-26T03:40:34Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/rest/SecurityRestFilterTests.java", "diffHunk": "@@ -141,21 +146,48 @@ public void testProcessBasicLicense() throws Exception {\n         verifyZeroInteractions(channel, authcService);\n     }\n \n-    public void testProcessAuthenticationError() throws Exception {\n-        RestRequest request = mock(RestRequest.class);\n-        Exception exception = authenticationError(\"failed authc\");\n+    public void testProcessAuthenticationFailedNoTrace() throws Exception {\n+        filter = new SecurityRestFilter(licenseState, threadContext, authcService, secondaryAuthenticator, restHandler, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, true, false, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, true, false);\n+        testProcessAuthenticationFailed(authenticationError(\"failed authn\"), RestStatus.UNAUTHORIZED, false, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, false, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, true, false, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, false, true, false);\n+        testProcessAuthenticationFailed(new ElasticsearchException(\"dummy\"), RestStatus.INTERNAL_SERVER_ERROR, true, true, true);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "6f45e455bebd4bd8b044519af2b85724cc3aff9c"}, "originalPosition": 42}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d05be027e0f22af23e1f6cf5609289fc735ad3b9", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/d05be027e0f22af23e1f6cf5609289fc735ad3b9", "committedDate": "2020-06-02T16:32:18Z", "message": "Merge branch 'master' into hide_security_stacktrace"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a722b53a1187f49c94d3c3ac32046365bc0af7fc", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/a722b53a1187f49c94d3c3ac32046365bc0af7fc", "committedDate": "2020-06-02T18:10:36Z", "message": "Address review"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "1375bed72a4288be295dcbc89c0c7433fe2f42c3", "author": {"user": {"login": "albertzaharovits", "name": "Albert Zaharovits"}}, "url": "https://github.com/elastic/elasticsearch/commit/1375bed72a4288be295dcbc89c0c7433fe2f42c3", "committedDate": "2020-06-02T18:15:39Z", "message": "400 and 500 errors"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMTU1MjIw", "url": "https://github.com/elastic/elasticsearch/pull/55774#pullrequestreview-423155220", "createdAt": "2020-06-03T01:11:29Z", "commit": {"oid": "1375bed72a4288be295dcbc89c0c7433fe2f42c3"}, "state": "COMMENTED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDIzMjQ1ODU0", "url": "https://github.com/elastic/elasticsearch/pull/55774#pullrequestreview-423245854", "createdAt": "2020-06-03T06:15:53Z", "commit": {"oid": "1375bed72a4288be295dcbc89c0c7433fe2f42c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDI4MDM3Njg3", "url": "https://github.com/elastic/elasticsearch/pull/55774#pullrequestreview-428037687", "createdAt": "2020-06-10T13:13:14Z", "commit": {"oid": "1375bed72a4288be295dcbc89c0c7433fe2f42c3"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "b612f6466da4fa0c59d978ebf5b79e622ad7d49f", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/b612f6466da4fa0c59d978ebf5b79e622ad7d49f", "committedDate": "2020-06-10T13:17:31Z", "message": "Merge branch 'master' into hide_security_stacktrace"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 400, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}