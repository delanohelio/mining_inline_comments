{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcwNjgxNjg2", "number": 61355, "reviewThreads": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNTozMDozOFrOEbU-gA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNTozNDoxMVrOEbU_ig==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MDkwNjg4OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateAction.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNTozMDozOFrOHFN53Q==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwMDozOTo0OVrOHFRZSg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMjczMw==", "bodyText": "This is rather verbose but I don't have any good suggestions to do otherwise and we don't seem to have a generic need for a cloneWithChanges method !", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475232733", "createdAt": "2020-08-23T15:30:38Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateAction.java", "diffHunk": "@@ -43,7 +49,32 @@ protected void doExecute(Task task, AuthenticateRequest request, ActionListener<\n         } else if (SystemUser.is(runAsUser) || XPackUser.is(runAsUser)) {\n             listener.onFailure(new IllegalArgumentException(\"user [\" + runAsUser.principal() + \"] is internal\"));\n         } else {\n-            listener.onResponse(new AuthenticateResponse(authentication));\n+            final User user = authentication.getUser();\n+            final boolean shouldAddAnonymousRoleNames = anonymousUser.enabled() && false == anonymousUser.equals(user)\n+                && authentication.getAuthenticationType() != Authentication.AuthenticationType.API_KEY;\n+            if (shouldAddAnonymousRoleNames) {\n+                final String[] allRoleNames = Stream.concat(\n+                    Stream.of(user.roles()), Stream.of(anonymousUser.roles())).toArray(String[]::new);\n+                listener.onResponse(new AuthenticateResponse(\n+                    new Authentication(", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 38}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI4OTkzMA==", "bodyText": "I initially had this logic inside the User class, i.e. User#withRoles with the intention to simply things here. But as you said, there is no generic need for this type of method, which made it seem out of place. So I decided to keep everything in this one class. It is verbose but at least self-contained and hopefully easy to understand.", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475289930", "createdAt": "2020-08-24T00:39:49Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateAction.java", "diffHunk": "@@ -43,7 +49,32 @@ protected void doExecute(Task task, AuthenticateRequest request, ActionListener<\n         } else if (SystemUser.is(runAsUser) || XPackUser.is(runAsUser)) {\n             listener.onFailure(new IllegalArgumentException(\"user [\" + runAsUser.principal() + \"] is internal\"));\n         } else {\n-            listener.onResponse(new AuthenticateResponse(authentication));\n+            final User user = authentication.getUser();\n+            final boolean shouldAddAnonymousRoleNames = anonymousUser.enabled() && false == anonymousUser.equals(user)\n+                && authentication.getAuthenticationType() != Authentication.AuthenticationType.API_KEY;\n+            if (shouldAddAnonymousRoleNames) {\n+                final String[] allRoleNames = Stream.concat(\n+                    Stream.of(user.roles()), Stream.of(anonymousUser.roles())).toArray(String[]::new);\n+                listener.onResponse(new AuthenticateResponse(\n+                    new Authentication(", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMjczMw=="}, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 38}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MDkwODM0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/qa/basic-enable-security/src/test/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNTozMjozM1rOHFN6lQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwMDozNDo0M1rOHFRWlw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMjkxNw==", "bodyText": "nit: add a hint that anonymous user is enabled maybe so the test makes more sense when you look at it ?", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475232917", "createdAt": "2020-08-23T15:32:33Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/qa/basic-enable-security/src/test/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -132,7 +132,7 @@ private void checkAuthentication() throws IOException {\n         final Map<String, Object> auth = getAsMap(\"/_security/_authenticate\");\n         // From file realm, configured in build.gradle", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 2}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI4OTIzOQ==", "bodyText": "Add a comment about anonymous access is configured in build.gradle", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475289239", "createdAt": "2020-08-24T00:34:43Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/qa/basic-enable-security/src/test/java/org/elasticsearch/xpack/security/EnableSecurityOnBasicLicenseIT.java", "diffHunk": "@@ -132,7 +132,7 @@ private void checkAuthentication() throws IOException {\n         final Map<String, Object> auth = getAsMap(\"/_security/_authenticate\");\n         // From file realm, configured in build.gradle", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMjkxNw=="}, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 2}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjk3MDkwOTU0OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateActionTests.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yM1QxNTozNDoxMVrOHFN7JA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwMDozNDo1MlrOHFRWqw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMzA2MA==", "bodyText": "nit: this only makes sense in the if branch right?", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475233060", "createdAt": "2020-08-23T15:34:11Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateActionTests.java", "diffHunk": "@@ -118,7 +122,33 @@ public void onFailure(Exception e) {\n         });\n \n         assertThat(responseRef.get(), notNullValue());\n-        assertThat(responseRef.get().authentication(), sameInstance(authentication));\n+        if (anonymousUser.enabled()) {\n+            final Authentication auth = responseRef.get().authentication();\n+            final User authUser = auth.getUser();\n+            List.of(authUser.roles()).containsAll(List.of(authentication.getUser().roles()));\n+            List.of(authUser.roles()).containsAll(List.of(anonymousUser.roles()));\n+            assertThat(authUser.authenticatedUser(), sameInstance(user.authenticatedUser()));\n+            assertThat(auth.getAuthenticatedBy(), sameInstance(auth.getAuthenticatedBy()));\n+            assertThat(auth.getLookedUpBy(), sameInstance(auth.getLookedUpBy()));\n+            assertThat(auth.getVersion(), sameInstance(auth.getVersion()));\n+            assertThat(auth.getAuthenticationType(), sameInstance(auth.getAuthenticationType()));\n+            assertThat(auth.getMetadata(), sameInstance(auth.getMetadata()));\n+        } else {\n+            assertThat(responseRef.get().authentication(), sameInstance(authentication));\n+        }\n         assertThat(throwableRef.get(), nullValue());\n     }\n+\n+    private AnonymousUser prepareAnonymousUser() {\n+        final AnonymousUser anonymousUser = mock(AnonymousUser.class);\n+        if (randomBoolean()) {\n+            when(anonymousUser.enabled()).thenReturn(true);\n+        } else {\n+            when(anonymousUser.enabled()).thenReturn(false);\n+        }\n+        final String[] roleNames = randomList(1, 4, () -> randomAlphaOfLengthBetween(4, 12)).toArray(new String[0]);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 77}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTI4OTI1OQ==", "bodyText": "You right. Thanks", "url": "https://github.com/elastic/elasticsearch/pull/61355#discussion_r475289259", "createdAt": "2020-08-24T00:34:52Z", "author": {"login": "ywangd"}, "path": "x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/action/user/TransportAuthenticateActionTests.java", "diffHunk": "@@ -118,7 +122,33 @@ public void onFailure(Exception e) {\n         });\n \n         assertThat(responseRef.get(), notNullValue());\n-        assertThat(responseRef.get().authentication(), sameInstance(authentication));\n+        if (anonymousUser.enabled()) {\n+            final Authentication auth = responseRef.get().authentication();\n+            final User authUser = auth.getUser();\n+            List.of(authUser.roles()).containsAll(List.of(authentication.getUser().roles()));\n+            List.of(authUser.roles()).containsAll(List.of(anonymousUser.roles()));\n+            assertThat(authUser.authenticatedUser(), sameInstance(user.authenticatedUser()));\n+            assertThat(auth.getAuthenticatedBy(), sameInstance(auth.getAuthenticatedBy()));\n+            assertThat(auth.getLookedUpBy(), sameInstance(auth.getLookedUpBy()));\n+            assertThat(auth.getVersion(), sameInstance(auth.getVersion()));\n+            assertThat(auth.getAuthenticationType(), sameInstance(auth.getAuthenticationType()));\n+            assertThat(auth.getMetadata(), sameInstance(auth.getMetadata()));\n+        } else {\n+            assertThat(responseRef.get().authentication(), sameInstance(authentication));\n+        }\n         assertThat(throwableRef.get(), nullValue());\n     }\n+\n+    private AnonymousUser prepareAnonymousUser() {\n+        final AnonymousUser anonymousUser = mock(AnonymousUser.class);\n+        if (randomBoolean()) {\n+            when(anonymousUser.enabled()).thenReturn(true);\n+        } else {\n+            when(anonymousUser.enabled()).thenReturn(false);\n+        }\n+        final String[] roleNames = randomList(1, 4, () -> randomAlphaOfLengthBetween(4, 12)).toArray(new String[0]);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTIzMzA2MA=="}, "originalCommit": {"oid": "4d2fd93ce6f713f2432c7ee87d3287f81eb3fbcf"}, "originalPosition": 77}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 867, "cost": 1, "resetAt": "2021-11-12T11:57:46Z"}}}