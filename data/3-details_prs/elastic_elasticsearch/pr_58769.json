{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDQyMTk5NTQ3", "number": 58769, "title": "Move getPointReaderOrNull into AggregatorBase", "bodyText": "This is a pretty straight forward refactoring to move the point reader optimization that min and max use up to the aggregator base, and move the values source config related logic into values source config.  Hopefully that makes it easier to reuse, and also puts the check for if it can be applied in a more visible place.\nCloses #55552", "createdAt": "2020-06-30T17:47:28Z", "url": "https://github.com/elastic/elasticsearch/pull/58769", "merged": true, "mergeCommit": {"oid": "dc91a3007007f16d7cd6d7045222ed545bee4f50"}, "closed": true, "closedAt": "2020-07-13T18:20:37Z", "author": {"login": "not-napoleon"}, "timelineItems": {"totalCount": 13, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABcue-oxAH2gAyNDQyMTk5NTQ3OmI0MzVjZDBlMTI1ODVhYTE3YzUxMDhjNTFmNWZmOTUxZWJiNTYxODc=", "endCursor": "Y3Vyc29yOnYyOpPPAAABczUnwqgFqTQ0NTkyNTY1Nw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "b435cd0e12585aa17c5108c51f5ff951ebb56187", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/b435cd0e12585aa17c5108c51f5ff951ebb56187", "committedDate": "2020-06-24T19:12:10Z", "message": "Pull getPointReader up to AggregatorBase"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4f79ed84da874f803818e1687f49b82447a6d91", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4f79ed84da874f803818e1687f49b82447a6d91", "committedDate": "2020-06-24T19:28:20Z", "message": "Make getPointReader instance method"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "0f1dc77dd0dd50f93d6d75cbb0090fa74d144d0f", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/0f1dc77dd0dd50f93d6d75cbb0090fa74d144d0f", "committedDate": "2020-06-30T17:42:05Z", "message": "pull getPointReaderOrNull up to the aggregator base"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7", "committedDate": "2020-06-30T18:44:04Z", "message": "Merge branch 'master' into vs-config-raw-data-flag"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwMzM1MTIw", "url": "https://github.com/elastic/elasticsearch/pull/58769#pullrequestreview-440335120", "createdAt": "2020-06-30T19:49:36Z", "commit": {"oid": "c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7"}, "state": "COMMENTED", "comments": {"totalCount": 3, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTo0OTozNlrOGrMBwg==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNi0zMFQxOTo1MjoyOFrOGrMHdg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkzOTAxMA==", "bodyText": "Do you think now'd be a good time to change the name? I always thought something like pointReaderIfSafe or something is a little more clear about why you might get null back.\nAnd it isn't so much \"if early termination is applicable\" as \"if there are no filters and the underlying index is in the same order as the values produced by the config\"", "url": "https://github.com/elastic/elasticsearch/pull/58769#discussion_r447939010", "createdAt": "2020-06-30T19:49:36Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java", "diffHunk": "@@ -105,6 +108,22 @@ public ScoreMode scoreMode() {\n         addRequestCircuitBreakerBytes(DEFAULT_WEIGHT);\n     }\n \n+    /**\n+     * Returns a converter for point values if early termination is applicable to\n+     * the context or <code>null</code> otherwise.\n+     *\n+     * @param config The config for the values source metric.\n+     */\n+    public Function<byte[], Number> getPointReaderOrNull(ValuesSourceConfig config) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkzOTg4Nw==", "bodyText": "Could you make the method final?", "url": "https://github.com/elastic/elasticsearch/pull/58769#discussion_r447939887", "createdAt": "2020-06-30T19:51:24Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/AggregatorBase.java", "diffHunk": "@@ -105,6 +108,22 @@ public ScoreMode scoreMode() {\n         addRequestCircuitBreakerBytes(DEFAULT_WEIGHT);\n     }\n \n+    /**\n+     * Returns a converter for point values if early termination is applicable to\n+     * the context or <code>null</code> otherwise.\n+     *\n+     * @param config The config for the values source metric.\n+     */\n+    public Function<byte[], Number> getPointReaderOrNull(ValuesSourceConfig config) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0NzkzOTAxMA=="}, "originalCommit": {"oid": "c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7"}, "originalPosition": 32}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0Nzk0MDQ3MA==", "bodyText": "It's probably worth some javadoc on this one too.", "url": "https://github.com/elastic/elasticsearch/pull/58769#discussion_r447940470", "createdAt": "2020-06-30T19:52:28Z", "author": {"login": "nik9000"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java", "diffHunk": "@@ -371,4 +374,24 @@ public ValuesSource getValuesSource() {\n     public boolean hasGlobalOrdinals() {\n         return valuesSource.hasGlobalOrdinals();\n     }\n+\n+    @Nullable\n+    public Function<byte[], Number> getPointReaderOrNull() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "c4eedfa7a48ffd92c502bd7dd74fa5255685c1a7"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "fcd9704d36ee6d7490fc203ce9d789c7f0fff5af", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/fcd9704d36ee6d7490fc203ce9d789c7f0fff5af", "committedDate": "2020-07-01T13:42:59Z", "message": "response to PR feedback"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "37aa3694a0b0dddc2cdfa693ad0423286bb282a9", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/37aa3694a0b0dddc2cdfa693ad0423286bb282a9", "committedDate": "2020-07-01T15:17:38Z", "message": "Add extension point for point reader lookup"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQwOTg1OTQw", "url": "https://github.com/elastic/elasticsearch/pull/58769#pullrequestreview-440985940", "createdAt": "2020-07-01T15:39:01Z", "commit": {"oid": "37aa3694a0b0dddc2cdfa693ad0423286bb282a9"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozOTowMVrOGrrQNQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNy0wMVQxNTozOTowMVrOGrrQNQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ0ODQ1MDYxMw==", "bodyText": "I'm not convinced this is the right place to add extensibility here.  The other option I'm considering, we could make parsePoint a method on MappedFieldType (or, maybe a method that returns a reference to parsePoint or null, depending on if it's implemented for that field).  That would let us get rid of the instance type checking, and provide a way for plugins that add fields which use CoreVSTs to add custom point readers.", "url": "https://github.com/elastic/elasticsearch/pull/58769#discussion_r448450613", "createdAt": "2020-07-01T15:39:01Z", "author": {"login": "not-napoleon"}, "path": "server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceType.java", "diffHunk": "@@ -85,6 +87,15 @@\n     ValuesSource replaceMissing(ValuesSource valuesSource, Object rawMissing, DocValueFormat docValueFormat,\n                                 LongSupplier nowSupplier);\n \n+    /**\n+     * Attempts to return a reader function for the indexed data of this field.  Some aggregations are able to use this as an optimization\n+     * instead of relying on doc values, when the index sort order matches that of the aggregation.\n+     *\n+     * @param fieldType The field type we want to get a reader for\n+     * @return null if we can't get a reader (e.g. because the field is the wrong type), otherwise a point reader function.\n+     */\n+    default Function<byte[], Number> getPointReader(MappedFieldType fieldType) { return null; }", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "37aa3694a0b0dddc2cdfa693ad0423286bb282a9"}, "originalPosition": 24}]}}, {"__typename": "PullRequestCommit", "commit": {"oid": "a5c82c4d5af43bdc882b052f5ac36d8bfb0bceea", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/a5c82c4d5af43bdc882b052f5ac36d8bfb0bceea", "committedDate": "2020-07-01T21:22:36Z", "message": "move point reader creation onto MappedFieldType"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "c429c77ec87e2a58ba87e6a7e92436d2a5138b25", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/c429c77ec87e2a58ba87e6a7e92436d2a5138b25", "committedDate": "2020-07-02T14:06:22Z", "message": "Merge branch 'master' into vs-config-raw-data-flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "d1cd163401a3df5a8ea80f60bfe78a41e0d86df1", "author": {"user": {"login": "elasticmachine", "name": "Elastic Machine"}}, "url": "https://github.com/elastic/elasticsearch/commit/d1cd163401a3df5a8ea80f60bfe78a41e0d86df1", "committedDate": "2020-07-06T15:56:41Z", "message": "Merge branch 'master' into vs-config-raw-data-flag"}}, {"__typename": "PullRequestCommit", "commit": {"oid": "573c19d0f415be85abec0efecf1aa0b0b59b8662", "author": {"user": {"login": "not-napoleon", "name": "Mark Tozzi"}}, "url": "https://github.com/elastic/elasticsearch/commit/573c19d0f415be85abec0efecf1aa0b0b59b8662", "committedDate": "2020-07-09T19:55:14Z", "message": "Merge branch 'master' into vs-config-raw-data-flag\n\n Conflicts:\n\tserver/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java"}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDQ1OTI1NjU3", "url": "https://github.com/elastic/elasticsearch/pull/58769#pullrequestreview-445925657", "createdAt": "2020-07-09T19:57:45Z", "commit": {"oid": "573c19d0f415be85abec0efecf1aa0b0b59b8662"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}]}}}, "rateLimit": {"limit": 5000, "remaining": 2432, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}