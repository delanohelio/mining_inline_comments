{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0Mzk1NzQxMTA5", "number": 54440, "reviewThreads": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNToyMjozNFrODtzKGw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNTozNzo1NFrODtzUyQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzUwNjgzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/ApplicationActionsResolver.java", "isResolved": false, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNToyMjozNVrOF_bq4w==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNjoxNjozM1rOF_cqWg==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1Nzk1NQ==", "bodyText": "Can you explain why we preload this cache? I think it's because\n\nwe know we should be getting many requests for the default application but\nwe don't want to statically resolve the actions in here as these are configurable ( even if they probably won't change often ) and\nwe don't want to be making GetPrivilege related searches to the security index too often.\n\nWould this behavior change when we add a cache for Application Privileges and if so, should we add a TODO or note here ?", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402057955", "createdAt": "2020-04-02T05:22:35Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/ApplicationActionsResolver.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+/*\n+ * ELASTICSEARCH CONFIDENTIAL\n+ * __________________\n+ *\n+ *  [2020] Elasticsearch Incorporated. All Rights Reserved.\n+ *\n+ * NOTICE:  All information contained herein is, and remains\n+ * the property of Elasticsearch Incorporated and its suppliers,\n+ * if any.  The intellectual and technical concepts contained\n+ * herein are proprietary to Elasticsearch Incorporated\n+ * and its suppliers and may be covered by U.S. and Foreign Patents,\n+ * patents in process, and are protected by trade secret or copyright law.\n+ * Dissemination of this information or reproduction of this material\n+ * is strictly forbidden unless prior written permission is obtained\n+ * from Elasticsearch Incorporated.\n+ */\n+\n+package org.elasticsearch.xpack.idp.privileges;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.component.AbstractLifecycleComponent;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.security.action.privilege.GetPrivilegesAction;\n+import org.elasticsearch.xpack.core.security.action.privilege.GetPrivilegesRequest;\n+import org.elasticsearch.xpack.idp.saml.sp.ServiceProviderDefaults;\n+\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class ApplicationActionsResolver extends AbstractLifecycleComponent {\n+\n+    private static final int CACHE_SIZE_DEFAULT = 100;\n+    private static final TimeValue CACHE_TTL_DEFAULT = TimeValue.timeValueMinutes(90);\n+\n+    public static final Setting<Integer> CACHE_SIZE\n+        = Setting.intSetting(\"xpack.idp.privileges.cache.size\", CACHE_SIZE_DEFAULT, Setting.Property.NodeScope);\n+    public static final Setting<TimeValue> CACHE_TTL\n+        = Setting.timeSetting(\"xpack.idp.privileges.cache.ttl\", CACHE_TTL_DEFAULT, Setting.Property.NodeScope);\n+\n+    private final Logger logger = LogManager.getLogger();\n+\n+    private final ServiceProviderDefaults defaults;\n+    private final Client client;\n+    private final Cache<String, Set<String>> cache;\n+\n+    public ApplicationActionsResolver(Settings settings, ServiceProviderDefaults defaults, Client client) {\n+        this.defaults = defaults;\n+        this.client = new OriginSettingClient(client, ClientHelper.IDP_ORIGIN);\n+\n+        final TimeValue cacheTtl = CACHE_TTL.get(settings);\n+        this.cache = CacheBuilder.<String, Set<String>>builder()\n+            .setMaximumWeight(CACHE_SIZE.get(settings))\n+            .setExpireAfterWrite(cacheTtl)\n+            .build();\n+\n+        // Preload the cache at 2/3 of its expiry time (TTL). This means that we should never have an empty cache, but if for some reason\n+        // the preload thread stops running, we will still automatically refresh the cache on access.\n+        final TimeValue preloadInterval = TimeValue.timeValueMillis(cacheTtl.millis() * 2 / 3);\n+        client.threadPool().scheduleWithFixedDelay(this::loadPrivilegesForDefaultApplication, preloadInterval, ThreadPool.Names.GENERIC);", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 79}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3NDIwMg==", "bodyText": "Realistically we should only have 1 application that we're loading privileges for.\nExcept that code doesn't currently enforce that from top-to-bottom, so we were left with a weird situation where an \"application\" string gets passed down when we resolve the privileges. I could have put in a check that application.equals(defaults.applicationName), but decide to just accept that multiple application could be a thing.\nBecause all (or even most) of the requests are going to be for the same application, when the cache expires we would be likely to have a flood of threads all trying to reload the same data at the same time.\nBy pre-loading it we can enforce that we have a single request to load the privileges which is going to make a big difference for the load on the security cluster.\nBut we definitely don't want to cache forever, because adding a new action is a reasonable thing to do, and we don't want to require an IdP restart when it does.\nI don't think I would change this with caching on the privileges API - a flood of requests to that action would still be unnecesary and potentially exhaust threadpools etc.", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402074202", "createdAt": "2020-04-02T06:16:33Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/ApplicationActionsResolver.java", "diffHunk": "@@ -0,0 +1,130 @@\n+/*\n+ * Copyright Elasticsearch B.V. and/or licensed to Elasticsearch B.V. under one\n+ * or more contributor license agreements. Licensed under the Elastic License;\n+ * you may not use this file except in compliance with the Elastic License.\n+ */\n+\n+/*\n+ * ELASTICSEARCH CONFIDENTIAL\n+ * __________________\n+ *\n+ *  [2020] Elasticsearch Incorporated. All Rights Reserved.\n+ *\n+ * NOTICE:  All information contained herein is, and remains\n+ * the property of Elasticsearch Incorporated and its suppliers,\n+ * if any.  The intellectual and technical concepts contained\n+ * herein are proprietary to Elasticsearch Incorporated\n+ * and its suppliers and may be covered by U.S. and Foreign Patents,\n+ * patents in process, and are protected by trade secret or copyright law.\n+ * Dissemination of this information or reproduction of this material\n+ * is strictly forbidden unless prior written permission is obtained\n+ * from Elasticsearch Incorporated.\n+ */\n+\n+package org.elasticsearch.xpack.idp.privileges;\n+\n+import org.apache.logging.log4j.LogManager;\n+import org.apache.logging.log4j.Logger;\n+import org.apache.logging.log4j.message.ParameterizedMessage;\n+import org.elasticsearch.action.ActionListener;\n+import org.elasticsearch.client.Client;\n+import org.elasticsearch.client.OriginSettingClient;\n+import org.elasticsearch.common.cache.Cache;\n+import org.elasticsearch.common.cache.CacheBuilder;\n+import org.elasticsearch.common.component.AbstractLifecycleComponent;\n+import org.elasticsearch.common.settings.Setting;\n+import org.elasticsearch.common.settings.Settings;\n+import org.elasticsearch.common.unit.TimeValue;\n+import org.elasticsearch.threadpool.ThreadPool;\n+import org.elasticsearch.xpack.core.ClientHelper;\n+import org.elasticsearch.xpack.core.security.action.privilege.GetPrivilegesAction;\n+import org.elasticsearch.xpack.core.security.action.privilege.GetPrivilegesRequest;\n+import org.elasticsearch.xpack.idp.saml.sp.ServiceProviderDefaults;\n+\n+import java.io.IOException;\n+import java.util.Collection;\n+import java.util.Set;\n+import java.util.stream.Collectors;\n+import java.util.stream.Stream;\n+\n+public class ApplicationActionsResolver extends AbstractLifecycleComponent {\n+\n+    private static final int CACHE_SIZE_DEFAULT = 100;\n+    private static final TimeValue CACHE_TTL_DEFAULT = TimeValue.timeValueMinutes(90);\n+\n+    public static final Setting<Integer> CACHE_SIZE\n+        = Setting.intSetting(\"xpack.idp.privileges.cache.size\", CACHE_SIZE_DEFAULT, Setting.Property.NodeScope);\n+    public static final Setting<TimeValue> CACHE_TTL\n+        = Setting.timeSetting(\"xpack.idp.privileges.cache.ttl\", CACHE_TTL_DEFAULT, Setting.Property.NodeScope);\n+\n+    private final Logger logger = LogManager.getLogger();\n+\n+    private final ServiceProviderDefaults defaults;\n+    private final Client client;\n+    private final Cache<String, Set<String>> cache;\n+\n+    public ApplicationActionsResolver(Settings settings, ServiceProviderDefaults defaults, Client client) {\n+        this.defaults = defaults;\n+        this.client = new OriginSettingClient(client, ClientHelper.IDP_ORIGIN);\n+\n+        final TimeValue cacheTtl = CACHE_TTL.get(settings);\n+        this.cache = CacheBuilder.<String, Set<String>>builder()\n+            .setMaximumWeight(CACHE_SIZE.get(settings))\n+            .setExpireAfterWrite(cacheTtl)\n+            .build();\n+\n+        // Preload the cache at 2/3 of its expiry time (TTL). This means that we should never have an empty cache, but if for some reason\n+        // the preload thread stops running, we will still automatically refresh the cache on access.\n+        final TimeValue preloadInterval = TimeValue.timeValueMillis(cacheTtl.millis() * 2 / 3);\n+        client.threadPool().scheduleWithFixedDelay(this::loadPrivilegesForDefaultApplication, preloadInterval, ThreadPool.Names.GENERIC);", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1Nzk1NQ=="}, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 79}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzUxNjYyOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/UserPrivilegeResolver.java", "isResolved": true, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNToyNzo1MFrOF_bwng==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNToyNzo1MFrOF_bwng==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA1OTQyMg==", "bodyText": "nit but saw it above in line 39\nthrow new IllegalArgumentException(\"a user without access ([\" + hasAccess + \"]) may not have roles ([\" + roles + \"])\");\n\nto ->\nthrow new IllegalArgumentException(\"a user without access may not have roles ([\" + roles + \"])\");", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402059422", "createdAt": "2020-04-02T05:27:50Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/UserPrivilegeResolver.java", "diffHunk": "@@ -66,62 +65,79 @@ public static UserPrivileges noAccess(String principal) {\n     private final Logger logger = LogManager.getLogger();\n     private final Client client;\n     private final SecurityContext securityContext;\n+    private final ApplicationActionsResolver actionsResolver;", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 12}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzUyNDMzOnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/UserPrivilegeResolver.java", "isResolved": false, "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNTozMjoyOFrOF_b1QQ==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNTozMjoyOFrOF_b1QQ==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MDYwOQ==", "bodyText": "remove this line", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402060609", "createdAt": "2020-04-02T05:32:28Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/privileges/UserPrivilegeResolver.java", "diffHunk": "@@ -66,62 +65,79 @@ public static UserPrivileges noAccess(String principal) {\n     private final Logger logger = LogManager.getLogger();\n     private final Client client;\n     private final SecurityContext securityContext;\n+    private final ApplicationActionsResolver actionsResolver;\n \n-    public UserPrivilegeResolver(Client client, SecurityContext securityContext) {\n+    public UserPrivilegeResolver(Client client, SecurityContext securityContext, ApplicationActionsResolver actionsResolver) {\n         this.client = client;\n         this.securityContext = securityContext;\n+        this.actionsResolver = actionsResolver;\n     }\n \n     /**\n      * Resolves the user's privileges for the specified service.\n      * Requires that the active user is set in the {@link org.elasticsearch.xpack.core.security.SecurityContext}.\n      */\n     public void resolve(ServiceProviderPrivileges service, ActionListener<UserPrivileges> listener) {\n-        HasPrivilegesRequest request = new HasPrivilegesRequest();\n-        final String username = securityContext.requireUser().principal();\n-        request.username(username);\n-        request.applicationPrivileges(buildResourcePrivilege(service));\n-        request.clusterPrivileges(Strings.EMPTY_ARRAY);\n-        request.indexPrivileges(new RoleDescriptor.IndicesPrivileges[0]);\n-        client.execute(HasPrivilegesAction.INSTANCE, request, ActionListener.wrap(\n-            response -> {\n-                logger.debug(\"Checking access for user [{}] to application [{}] resource [{}]\",\n-                    username, service.getApplicationName(), service.getResource());\n-                UserPrivileges privileges = buildResult(response, service);\n-                logger.debug(\"Resolved service privileges [{}]\", privileges);\n-                listener.onResponse(privileges);\n-            },\n-            listener::onFailure\n-        ));\n+        buildResourcePrivilege(service, ActionListener.wrap(resourcePrivilege -> {\n+            final String username = securityContext.requireUser().principal();\n+            if (resourcePrivilege == null) {\n+                listener.onResponse(UserPrivileges.noAccess(username));\n+                return;\n+            }\n+            HasPrivilegesRequest request = new HasPrivilegesRequest();\n+            request.username(username);\n+            request.applicationPrivileges();", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 50}]}}, {"id": "MDIzOlB1bGxSZXF1ZXN0UmV2aWV3VGhyZWFkMjQ5MzUzNDE3OnYy", "diffSide": "RIGHT", "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/ServiceProviderCacheSettings.java", "isResolved": true, "comments": {"totalCount": 2, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNTozNzo1NFrOF_b7TA==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wNC0wMlQwNjowNjo0NVrOF_cdAA==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjE1Ng==", "bodyText": "why?", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402062156", "createdAt": "2020-04-02T05:37:54Z", "author": {"login": "jkakavas"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/ServiceProviderCacheSettings.java", "diffHunk": "@@ -26,7 +26,7 @@\n     public static final Setting<TimeValue> CACHE_TTL\n         = Setting.timeSetting(\"xpack.idp.sp.cache.ttl\", CACHE_TTL_DEFAULT, Setting.Property.NodeScope);\n \n-    static <K, V> Cache<K, V> buildCache(Settings settings) {\n+    public static <K, V> Cache<K, V> buildCache(Settings settings) {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 5}, {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA3MDc4NA==", "bodyText": "I was going to re-use this for the application privileges cache, but decided against it.", "url": "https://github.com/elastic/elasticsearch/pull/54440#discussion_r402070784", "createdAt": "2020-04-02T06:06:45Z", "author": {"login": "tvernum"}, "path": "x-pack/plugin/identity-provider/src/main/java/org/elasticsearch/xpack/idp/saml/sp/ServiceProviderCacheSettings.java", "diffHunk": "@@ -26,7 +26,7 @@\n     public static final Setting<TimeValue> CACHE_TTL\n         = Setting.timeSetting(\"xpack.idp.sp.cache.ttl\", CACHE_TTL_DEFAULT, Setting.Property.NodeScope);\n \n-    static <K, V> Cache<K, V> buildCache(Settings settings) {\n+    public static <K, V> Cache<K, V> buildCache(Settings settings) {", "state": "SUBMITTED", "replyTo": {"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQwMjA2MjE1Ng=="}, "originalCommit": {"oid": "a4af21f26c271cd5a616c9145a538ccea7f5681b"}, "originalPosition": 5}]}}]}}}, "rateLimit": {"limit": 5000, "remaining": 3985, "cost": 1, "resetAt": "2021-11-12T13:16:51Z"}}}