{"data": {"repository": {"pullRequest": {"id": "MDExOlB1bGxSZXF1ZXN0NDcyMzE3OTE4", "number": 61455, "title": "Allow background cluster state update in tests", "bodyText": "Today the CoordinatorTests run the publication process as a single\natomic action; however in production it appears possible that another\nmaster may be elected, publish its state, then fail, then we win another\nelection, all in between the time we sampled our previous cluster state\nand started to publish the one we first thought of.\nThis violates the assertClusterStateConsistency() assertion that\nverifies the cluster state update event matches the states we actually\npublished and applied.\nThis commit adjusts the tests to run the publication process more\nasynchronously so as to allow time for this behaviour to occur. This\nshould eventually result in a reproduction of the failure in #61437 that\nwill let us analyse what's really going on there and help us fix it.", "createdAt": "2020-08-24T07:16:24Z", "url": "https://github.com/elastic/elasticsearch/pull/61455", "merged": true, "mergeCommit": {"oid": "6e74dcc5a9ace1a131cf73037742d4e09e5250ef"}, "closed": true, "closedAt": "2020-08-27T10:11:33Z", "author": {"login": "DaveCTurner"}, "timelineItems": {"totalCount": 4, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpPPAAABdB9GJcgH2gAyNDcyMzE3OTE4OjVkOTBhMzEzNDcxNDEwMDVjMjQzMTIzNzU3Zjk4NGU0MDNiZmZlMmI=", "endCursor": "Y3Vyc29yOnYyOpPPAAABdB-cKVAH2gAyNDcyMzE3OTE4OmFjYTcwNWNmYmRkMjE4YjZhYmI3NTMxY2Q4ZmQ0NzE4MjhhNjU5NWU=", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"__typename": "PullRequestCommit", "commit": {"oid": "5d90a31347141005c243123757f984e403bffe2b", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/5d90a31347141005c243123757f984e403bffe2b", "committedDate": "2020-08-24T07:02:05Z", "message": "Allow background cluster state update in tests\n\nToday the `CoordinatorTests` run the publication process as a single\natomic action; however in production it appears possible that another\nmaster may be elected, publish its state, then fail, then we win another\nelection, all in between the time we sampled our previous cluster state\nand started to publish the one we first thought of.\n\nThis violates the `assertClusterStateConsistency()` assertion that\nverifies the cluster state update event matches the states we actually\npublished and applied.\n\nThis commit adjusts the tests to run the publication process more\nasynchronously so as to allow time for this behaviour to occur. This\nshould eventually result in a reproduction of the failure in #61437 that\nwill let us analyse what's really going on there and help us fix it."}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTc0ODI2", "url": "https://github.com/elastic/elasticsearch/pull/61455#pullrequestreview-473174826", "createdAt": "2020-08-24T07:17:01Z", "commit": {"oid": "5d90a31347141005c243123757f984e403bffe2b"}, "state": "COMMENTED", "comments": {"totalCount": 1, "pageInfo": {"startCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNzoxNzowMVrOHFXZaw==", "endCursor": "Y3Vyc29yOnYyOpK0MjAyMC0wOC0yNFQwNzoxNzowMVrOHFXZaw==", "hasNextPage": false, "hasPreviousPage": false}, "nodes": [{"id": "MDI0OlB1bGxSZXF1ZXN0UmV2aWV3Q29tbWVudDQ3NTM4ODI2Nw==", "bodyText": "NB not really the generic threadpool, we're using the DeterministicTaskQueue to run on a single thread here.", "url": "https://github.com/elastic/elasticsearch/pull/61455#discussion_r475388267", "createdAt": "2020-08-24T07:17:01Z", "author": {"login": "DaveCTurner"}, "path": "test/framework/src/main/java/org/elasticsearch/cluster/service/FakeThreadPoolMasterService.java", "diffHunk": "@@ -157,7 +157,20 @@ public void onFailure(Exception e) {\n                     scheduleNextTaskIfNecessary();\n                 }\n             }\n-        }, wrapAckListener(ackListener));\n+        };\n+        threadPool.generic().execute(threadPool.getThreadContext().preserveContext(new Runnable() {", "state": "SUBMITTED", "replyTo": null, "originalCommit": {"oid": "5d90a31347141005c243123757f984e403bffe2b"}, "originalPosition": 15}]}}, {"__typename": "PullRequestReview", "id": "MDE3OlB1bGxSZXF1ZXN0UmV2aWV3NDczMTg2NDE3", "url": "https://github.com/elastic/elasticsearch/pull/61455#pullrequestreview-473186417", "createdAt": "2020-08-24T07:35:59Z", "commit": {"oid": "5d90a31347141005c243123757f984e403bffe2b"}, "state": "APPROVED", "comments": {"totalCount": 0, "pageInfo": {"startCursor": null, "endCursor": null, "hasNextPage": false, "hasPreviousPage": false}, "nodes": []}}, {"__typename": "PullRequestCommit", "commit": {"oid": "aca705cfbdd218b6abb7531cd8fd471828a6595e", "author": {"user": {"login": "DaveCTurner", "name": "David Turner"}}, "url": "https://github.com/elastic/elasticsearch/commit/aca705cfbdd218b6abb7531cd8fd471828a6595e", "committedDate": "2020-08-24T08:36:02Z", "message": "Run both tasks in unit tests"}}]}}}, "rateLimit": {"limit": 5000, "remaining": 4667, "cost": 1, "resetAt": "2021-10-28T18:54:27Z"}}}